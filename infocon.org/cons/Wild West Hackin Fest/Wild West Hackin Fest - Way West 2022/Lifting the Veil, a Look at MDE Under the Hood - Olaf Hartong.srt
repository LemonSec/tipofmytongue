1
00:00:02,240 --> 00:00:04,000
welcome back

2
00:00:04,000 --> 00:00:07,359
after lunch i hope you all had a very

3
00:00:07,359 --> 00:00:09,920
big carb load and you managed to stay

4
00:00:09,920 --> 00:00:10,800
awake

5
00:00:10,800 --> 00:00:12,880
during this exciting talk

6
00:00:12,880 --> 00:00:15,519
by olaf hartong who's going to talk to

7
00:00:15,519 --> 00:00:17,840
us about mde

8
00:00:17,840 --> 00:00:19,600
under the hood

9
00:00:19,600 --> 00:00:21,840
take it away thanks man

10
00:00:21,840 --> 00:00:24,560
that's loud all right hey everybody

11
00:00:24,560 --> 00:00:26,880
thanks for being here i hope indeed you

12
00:00:26,880 --> 00:00:29,599
will stay awake because it's after lunch

13
00:00:29,599 --> 00:00:31,119
which was great

14
00:00:31,119 --> 00:00:34,719
so just briefly i'll introduce myself um

15
00:00:34,719 --> 00:00:37,520
i'm olivartong i'm a dutch guy from

16
00:00:37,520 --> 00:00:39,360
falconforce which i'm one of the

17
00:00:39,360 --> 00:00:42,559
founders of i'm a microsoft mvp for the

18
00:00:42,559 --> 00:00:44,399
people that don't know it i can say a

19
00:00:44,399 --> 00:00:46,559
lot of about microsoft and not get

20
00:00:46,559 --> 00:00:47,680
offended

21
00:00:47,680 --> 00:00:48,480
um

22
00:00:48,480 --> 00:00:50,559
now with jokes aside right i can be

23
00:00:50,559 --> 00:00:52,640
critical and i should be

24
00:00:52,640 --> 00:00:55,199
apart from that i am security researcher

25
00:00:55,199 --> 00:00:57,840
i do a lot of threat detections i build

26
00:00:57,840 --> 00:00:59,680
a lot of detections that's one of the

27
00:00:59,680 --> 00:01:01,600
things that we do

28
00:01:01,600 --> 00:01:04,000
i used to be a documentary photographer

29
00:01:04,000 --> 00:01:06,720
i have two boys who i really adore and

30
00:01:06,720 --> 00:01:08,799
who miss me very much

31
00:01:08,799 --> 00:01:10,640
and apart from that i like warm hogs of

32
00:01:10,640 --> 00:01:12,720
course so um

33
00:01:12,720 --> 00:01:14,720
just moving on so what can you expect to

34
00:01:14,720 --> 00:01:16,640
be here right so i i don't want to bore

35
00:01:16,640 --> 00:01:17,759
you too much

36
00:01:17,759 --> 00:01:19,040
i want to talk a little bit about

37
00:01:19,040 --> 00:01:20,799
defender for endpoint what it can do

38
00:01:20,799 --> 00:01:23,040
what the capabilities are what

39
00:01:23,040 --> 00:01:25,520
and and it's it's a short talk it's only

40
00:01:25,520 --> 00:01:27,040
five or five minutes so i can't talk

41
00:01:27,040 --> 00:01:29,439
about everything what kind of telemetry

42
00:01:29,439 --> 00:01:31,280
can you expect to gain from it as a

43
00:01:31,280 --> 00:01:32,560
defender

44
00:01:32,560 --> 00:01:34,960
but also where does it actually get its

45
00:01:34,960 --> 00:01:36,640
information because it's it's nice that

46
00:01:36,640 --> 00:01:38,560
you get it into a portal but where does

47
00:01:38,560 --> 00:01:39,920
it come from because this is where

48
00:01:39,920 --> 00:01:41,600
attackers can actually start fiddling

49
00:01:41,600 --> 00:01:42,640
with it

50
00:01:42,640 --> 00:01:44,640
or you might have some blind spots which

51
00:01:44,640 --> 00:01:46,000
you need to augment

52
00:01:46,000 --> 00:01:46,799
so

53
00:01:46,799 --> 00:01:48,640
of course every tool has a configuration

54
00:01:48,640 --> 00:01:51,520
so we figured out a way to read it so

55
00:01:51,520 --> 00:01:53,439
i'll talk a little bit about it

56
00:01:53,439 --> 00:01:55,280
and i'll compare it to sysmon which is

57
00:01:55,280 --> 00:01:56,399
probably

58
00:01:56,399 --> 00:01:58,320
known to most people i want to introduce

59
00:01:58,320 --> 00:01:59,600
it but it's an awesome tool that's

60
00:01:59,600 --> 00:02:01,600
freely available as well where you can

61
00:02:01,600 --> 00:02:03,040
maybe augment

62
00:02:03,040 --> 00:02:04,560
what you're missing

63
00:02:04,560 --> 00:02:06,240
so first of all a little bit of

64
00:02:06,240 --> 00:02:08,399
capability outline i stated

65
00:02:08,399 --> 00:02:09,919
try to stay in the theme so all the

66
00:02:09,919 --> 00:02:11,760
pictures that you might see are actually

67
00:02:11,760 --> 00:02:13,599
pictures that i created myself on a navy

68
00:02:13,599 --> 00:02:15,360
ship in the netherlands

69
00:02:15,360 --> 00:02:17,680
not very interesting but just a byline

70
00:02:17,680 --> 00:02:19,200
so technically defender for endpoint is

71
00:02:19,200 --> 00:02:20,720
a huge tool right it's commercial

72
00:02:20,720 --> 00:02:23,280
product from microsoft it's um

73
00:02:23,280 --> 00:02:25,920
basically the the the pro version of uh

74
00:02:25,920 --> 00:02:27,920
defender just the windows defender av

75
00:02:27,920 --> 00:02:30,239
engine which is still part of it

76
00:02:30,239 --> 00:02:31,760
but it also contains a tech server

77
00:02:31,760 --> 00:02:33,840
production which is a configurable tool

78
00:02:33,840 --> 00:02:36,400
it has exploit guard and exploit

79
00:02:36,400 --> 00:02:38,160
application control

80
00:02:38,160 --> 00:02:39,599
which is a sort of application white

81
00:02:39,599 --> 00:02:41,200
listing service and then of course

82
00:02:41,200 --> 00:02:43,120
there's the edr telemetry which probably

83
00:02:43,120 --> 00:02:45,920
will take most of the talk there's some

84
00:02:45,920 --> 00:02:47,440
incident response capabilities where you

85
00:02:47,440 --> 00:02:48,480
can

86
00:02:48,480 --> 00:02:50,400
stop processes isolate machines these

87
00:02:50,400 --> 00:02:52,000
kind of things what you would expect

88
00:02:52,000 --> 00:02:53,440
from an edr

89
00:02:53,440 --> 00:02:54,560
on top of that they have some

90
00:02:54,560 --> 00:02:56,480
vulnerability management capability so

91
00:02:56,480 --> 00:02:58,480
they can scan like a i don't know

92
00:02:58,480 --> 00:03:00,000
vulnerability management tool but

93
00:03:00,000 --> 00:03:01,440
slightly less

94
00:03:01,440 --> 00:03:02,959
mature maybe

95
00:03:02,959 --> 00:03:04,560
there's a network sensor so it actually

96
00:03:04,560 --> 00:03:06,400
looks around the network as well sees if

97
00:03:06,400 --> 00:03:08,239
it finds a weird host that it doesn't

98
00:03:08,239 --> 00:03:10,400
recognize and there's some dlp

99
00:03:10,400 --> 00:03:12,239
capabilities

100
00:03:12,239 --> 00:03:14,000
and not everything on this list is is

101
00:03:14,000 --> 00:03:15,519
actually something you pay for right of

102
00:03:15,519 --> 00:03:17,120
course the av is just on your windows

103
00:03:17,120 --> 00:03:19,440
box when you install it

104
00:03:19,440 --> 00:03:22,080
and even asr and application control are

105
00:03:22,080 --> 00:03:25,519
just are just there so first of all av

106
00:03:25,519 --> 00:03:28,080
everybody has it or uses it up to a

107
00:03:28,080 --> 00:03:29,280
certain point

108
00:03:29,280 --> 00:03:31,120
it's easily bypassed of course it's just

109
00:03:31,120 --> 00:03:33,040
signature based

110
00:03:33,040 --> 00:03:36,400
so but still yeah why not why not use it

111
00:03:36,400 --> 00:03:37,680
there's some great research on the

112
00:03:37,680 --> 00:03:40,239
signature database by camille

113
00:03:40,239 --> 00:03:42,879
mogee sorry if i mispronounced that

114
00:03:42,879 --> 00:03:44,319
french researcher really really

115
00:03:44,319 --> 00:03:45,760
interesting stuff so you decompile the

116
00:03:45,760 --> 00:03:47,920
whole database basically you can figure

117
00:03:47,920 --> 00:03:49,920
out where what it's triggering on you

118
00:03:49,920 --> 00:03:52,080
can configure a bit of it so you can

119
00:03:52,080 --> 00:03:53,360
tell it hey

120
00:03:53,360 --> 00:03:55,599
i don't want to see a

121
00:03:55,599 --> 00:03:57,920
certain events or i trust this directory

122
00:03:57,920 --> 00:03:59,200
and there's a couple of things which you

123
00:03:59,200 --> 00:04:00,959
need to

124
00:04:00,959 --> 00:04:02,560
be aware of because attackers will

125
00:04:02,560 --> 00:04:05,120
probably if they land on a box try to

126
00:04:05,120 --> 00:04:06,879
exclude their own binary first and

127
00:04:06,879 --> 00:04:08,000
foremost

128
00:04:08,000 --> 00:04:09,040
and the weird thing is so there's a

129
00:04:09,040 --> 00:04:10,400
couple of things to keep in mind so if

130
00:04:10,400 --> 00:04:12,799
you exclude a process which a lot of

131
00:04:12,799 --> 00:04:14,159
attackers actually if i look at my

132
00:04:14,159 --> 00:04:16,320
sandbox telemetry fail at they try to

133
00:04:16,320 --> 00:04:18,959
whitelist their own binary but the only

134
00:04:18,959 --> 00:04:20,720
thing that it does is by is basically

135
00:04:20,720 --> 00:04:22,880
whitelist the stuff that it spawns

136
00:04:22,880 --> 00:04:25,759
so it still gets detected but um and and

137
00:04:25,759 --> 00:04:27,199
the other thing is to keep in mind so if

138
00:04:27,199 --> 00:04:29,680
you apply an exclusion to the defender

139
00:04:29,680 --> 00:04:31,360
av agent still all of the other

140
00:04:31,360 --> 00:04:33,600
capabilities are working so edr

141
00:04:33,600 --> 00:04:35,520
telemetry is still being generated for

142
00:04:35,520 --> 00:04:37,199
it which is nice

143
00:04:37,199 --> 00:04:39,120
and also asr which i'll get to in a

144
00:04:39,120 --> 00:04:41,680
second will still be active so still

145
00:04:41,680 --> 00:04:43,440
there are a lot of protections in place

146
00:04:43,440 --> 00:04:46,080
so if you want actually use it for a

147
00:04:46,080 --> 00:04:47,919
legitimate binary in your organization

148
00:04:47,919 --> 00:04:50,240
you have to have multiple exclusions

149
00:04:50,240 --> 00:04:53,520
because they're basically it's a sort of

150
00:04:53,520 --> 00:04:55,440
algorithm of all kinds of tools so the

151
00:04:55,440 --> 00:04:57,759
av is a different team then asr has a

152
00:04:57,759 --> 00:04:59,759
different team and they said

153
00:04:59,759 --> 00:05:01,120
they work for the same company but they

154
00:05:01,120 --> 00:05:03,120
all don't always work together not as

155
00:05:03,120 --> 00:05:04,320
effectively

156
00:05:04,320 --> 00:05:05,840
and there might be some benefits as well

157
00:05:05,840 --> 00:05:07,759
in having having these kind of things so

158
00:05:07,759 --> 00:05:09,039
if you want to learn a little bit more

159
00:05:09,039 --> 00:05:10,720
about the av engine there's there's a

160
00:05:10,720 --> 00:05:12,479
couple of great tools one of which is

161
00:05:12,479 --> 00:05:14,639
defender check which actually also gets

162
00:05:14,639 --> 00:05:17,360
flagged as a as a malicious tool

163
00:05:17,360 --> 00:05:18,720
so i checked defender check with

164
00:05:18,720 --> 00:05:21,039
defender check against the fender

165
00:05:21,039 --> 00:05:22,639
and you basically can see what the cool

166
00:05:22,639 --> 00:05:24,080
thing about the tool is is there is also

167
00:05:24,080 --> 00:05:25,840
a python version built by somebody else

168
00:05:25,840 --> 00:05:27,360
but basically what you can see is what

169
00:05:27,360 --> 00:05:29,680
it would trigger on so this is great if

170
00:05:29,680 --> 00:05:31,039
you're if you're more of a malware

171
00:05:31,039 --> 00:05:32,560
developer because then you can see hey

172
00:05:32,560 --> 00:05:34,160
why is it triggering what should i

173
00:05:34,160 --> 00:05:35,919
change usually it's just a string in the

174
00:05:35,919 --> 00:05:38,880
code like this one it's just a standard

175
00:05:38,880 --> 00:05:41,520
out string if you remove that it will

176
00:05:41,520 --> 00:05:43,199
actually work again

177
00:05:43,199 --> 00:05:45,440
but that's av right everybody knows that

178
00:05:45,440 --> 00:05:47,759
so slightly more interesting is the

179
00:05:47,759 --> 00:05:49,680
attack service reduction rule so this is

180
00:05:49,680 --> 00:05:51,840
a component that's also available on

181
00:05:51,840 --> 00:05:53,440
every windows box

182
00:05:53,440 --> 00:05:55,039
and there are 16 rules that you can

183
00:05:55,039 --> 00:05:56,880
configure basically through a register

184
00:05:56,880 --> 00:05:59,440
your group policy which allow you

185
00:05:59,440 --> 00:06:01,759
or allows the engine to block certain

186
00:06:01,759 --> 00:06:04,240
activity for instance an office process

187
00:06:04,240 --> 00:06:07,120
starting uh powershell or command.xc

188
00:06:07,120 --> 00:06:09,280
something like that definitely useful

189
00:06:09,280 --> 00:06:11,759
you can by default it's off so nothing

190
00:06:11,759 --> 00:06:13,600
happens but you can configure it to be

191
00:06:13,600 --> 00:06:15,840
blocking stuff or

192
00:06:15,840 --> 00:06:17,919
even only auditing it so you can just

193
00:06:17,919 --> 00:06:20,000
see what it would do and and that by

194
00:06:20,000 --> 00:06:22,240
itself is super valuable already

195
00:06:22,240 --> 00:06:24,000
and then all the telemetry if you have

196
00:06:24,000 --> 00:06:25,680
the defender for endpoint component will

197
00:06:25,680 --> 00:06:27,680
get locked to the central storage so you

198
00:06:27,680 --> 00:06:29,280
can actually see what happened

199
00:06:29,280 --> 00:06:31,039
on those boxes

200
00:06:31,039 --> 00:06:33,600
what it would have done so yeah one one

201
00:06:33,600 --> 00:06:35,520
of the things to reiterate if you run

202
00:06:35,520 --> 00:06:37,280
this if you run windows boxes and you

203
00:06:37,280 --> 00:06:39,600
have this running definitely enable it

204
00:06:39,600 --> 00:06:41,199
even in audit mode it's super valuable

205
00:06:41,199 --> 00:06:42,800
you can at least see what would have

206
00:06:42,800 --> 00:06:45,039
happened right so it's a good indicator

207
00:06:45,039 --> 00:06:46,560
that somebody's fiddling with it or

208
00:06:46,560 --> 00:06:48,880
teams is just being annoying

209
00:06:48,880 --> 00:06:49,599
but

210
00:06:49,599 --> 00:06:50,960
there's a lot of things going on on your

211
00:06:50,960 --> 00:06:52,720
windows box that might hit it as well so

212
00:06:52,720 --> 00:06:55,199
so back to that previous slide just to

213
00:06:55,199 --> 00:06:57,520
to to explain the graph that i didn't do

214
00:06:57,520 --> 00:06:59,680
this is research done by palantir who's

215
00:06:59,680 --> 00:07:01,919
done a lot of great work together with

216
00:07:01,919 --> 00:07:04,720
matt graber on attack service reduction

217
00:07:04,720 --> 00:07:06,240
and some of the other defender

218
00:07:06,240 --> 00:07:07,520
components

219
00:07:07,520 --> 00:07:09,199
and basically they made a graph of what

220
00:07:09,199 --> 00:07:11,120
should be safe what might need some

221
00:07:11,120 --> 00:07:13,759
additional reviewing and and what is

222
00:07:13,759 --> 00:07:16,000
very problematic in most organizations

223
00:07:16,000 --> 00:07:17,840
to enable so not everything can work so

224
00:07:17,840 --> 00:07:19,759
definitely do audit mode on the right

225
00:07:19,759 --> 00:07:21,919
side of the graph on the left you should

226
00:07:21,919 --> 00:07:23,360
be mostly fine

227
00:07:23,360 --> 00:07:25,039
depending on your organization i've seen

228
00:07:25,039 --> 00:07:27,199
weird stuff in in some companies as well

229
00:07:27,199 --> 00:07:29,680
that broke everything so these these

230
00:07:29,680 --> 00:07:30,400
rules

231
00:07:30,400 --> 00:07:32,479
are again rules

232
00:07:32,479 --> 00:07:34,479
and they're written in lua the same

233
00:07:34,479 --> 00:07:36,560
camille reversed those as well he

234
00:07:36,560 --> 00:07:38,080
decompiled them

235
00:07:38,080 --> 00:07:39,120
and

236
00:07:39,120 --> 00:07:41,280
and basically looking at them it's it's

237
00:07:41,280 --> 00:07:43,840
again a sort of signature like i hope

238
00:07:43,840 --> 00:07:45,599
you can read this actually but it's a

239
00:07:45,599 --> 00:07:48,000
snippet of it so the rules are basically

240
00:07:48,000 --> 00:07:51,199
reg axes that look for paths or

241
00:07:51,199 --> 00:07:54,639
files or command lines so basic stuff

242
00:07:54,639 --> 00:07:55,840
still

243
00:07:55,840 --> 00:07:58,000
as i mentioned it's super annoying for

244
00:07:58,000 --> 00:08:01,360
an attacker if it gets blocked with the

245
00:08:01,360 --> 00:08:04,000
initial execution sorry so

246
00:08:04,000 --> 00:08:06,400
still valuable to use and and on top of

247
00:08:06,400 --> 00:08:07,520
that you can build your own custom

248
00:08:07,520 --> 00:08:09,360
detection rules to see what

249
00:08:09,360 --> 00:08:12,160
was actually going on if it would bypass

250
00:08:12,160 --> 00:08:12,879
it

251
00:08:12,879 --> 00:08:14,319
because you can still detect that it's

252
00:08:14,319 --> 00:08:16,319
recorded right because it's a process

253
00:08:16,319 --> 00:08:18,240
that this started another another

254
00:08:18,240 --> 00:08:19,680
component which i won't get into that

255
00:08:19,680 --> 00:08:21,280
much is exploit guard that used to be

256
00:08:21,280 --> 00:08:22,400
emat

257
00:08:22,400 --> 00:08:25,440
for the people that are as old as i am

258
00:08:25,440 --> 00:08:27,039
it's it's a nice feature as well where

259
00:08:27,039 --> 00:08:28,879
you can block some weird arbitrary codes

260
00:08:28,879 --> 00:08:31,280
and process injection things

261
00:08:31,280 --> 00:08:32,799
and some weird

262
00:08:32,799 --> 00:08:34,719
child process creation events it's it's

263
00:08:34,719 --> 00:08:36,719
it's relatively limited it can block

264
00:08:36,719 --> 00:08:39,440
some some known cves these kind but

265
00:08:39,440 --> 00:08:41,200
probably if you want to go deeper you

266
00:08:41,200 --> 00:08:44,000
want to enable the vendor for the

267
00:08:44,000 --> 00:08:46,880
application control which is really nice

268
00:08:46,880 --> 00:08:48,800
it's really powerful it's also very

269
00:08:48,800 --> 00:08:50,240
complicated

270
00:08:50,240 --> 00:08:52,320
they created some some nice wizards now

271
00:08:52,320 --> 00:08:54,399
to generate some of the some of the

272
00:08:54,399 --> 00:08:55,440
ruling

273
00:08:55,440 --> 00:08:58,080
which will help you quite a lot

274
00:08:58,080 --> 00:09:00,959
but this is a very delicate process you

275
00:09:00,959 --> 00:09:03,600
want to test and re-evaluate quite

276
00:09:03,600 --> 00:09:04,880
constantly

277
00:09:04,880 --> 00:09:07,279
because you can break boxes

278
00:09:07,279 --> 00:09:09,600
or have people in your company

279
00:09:09,600 --> 00:09:11,519
prohibited from working but you can do

280
00:09:11,519 --> 00:09:13,680
some fun stuff with it though

281
00:09:13,680 --> 00:09:15,760
you can use this very maliciously which

282
00:09:15,760 --> 00:09:18,240
i won't think go into now i found some

283
00:09:18,240 --> 00:09:20,320
weird stuff that you can do which

284
00:09:20,320 --> 00:09:24,000
basically disables any kind of um

285
00:09:24,000 --> 00:09:25,839
blue team blue team help

286
00:09:25,839 --> 00:09:27,600
so that matters so you can kill edrs and

287
00:09:27,600 --> 00:09:30,240
these kind of things

288
00:09:30,320 --> 00:09:32,480
but again yeah it's i i'm on the

289
00:09:32,480 --> 00:09:35,279
defensive side so i don't say how figure

290
00:09:35,279 --> 00:09:37,839
it out yourself

291
00:09:38,000 --> 00:09:39,600
but basically you can use this for good

292
00:09:39,600 --> 00:09:41,040
right you can block all kinds of

293
00:09:41,040 --> 00:09:42,959
malicious known drivers you can do it on

294
00:09:42,959 --> 00:09:44,959
signature based you can do it on

295
00:09:44,959 --> 00:09:47,680
process chains it's it's very powerful

296
00:09:47,680 --> 00:09:50,080
again matt graber did amazing research

297
00:09:50,080 --> 00:09:52,000
on it he has a whole series on youtube

298
00:09:52,000 --> 00:09:53,360
that you should follow if you're into

299
00:09:53,360 --> 00:09:54,480
that

300
00:09:54,480 --> 00:09:56,160
but let's move a little bit more towards

301
00:09:56,160 --> 00:09:58,000
the edr component because this is where

302
00:09:58,000 --> 00:09:59,760
it gets useful

303
00:09:59,760 --> 00:10:02,000
even though it's a it is an edr right

304
00:10:02,000 --> 00:10:04,959
that's never a single source solution so

305
00:10:04,959 --> 00:10:07,279
it's nice it's pretty good i think it's

306
00:10:07,279 --> 00:10:08,959
one of the better ones actually to be

307
00:10:08,959 --> 00:10:10,000
honest

308
00:10:10,000 --> 00:10:12,160
um i play with a lot of them

309
00:10:12,160 --> 00:10:15,279
and the one of the nice bits is it has

310
00:10:15,279 --> 00:10:17,760
quite a rich set of telemetry so even

311
00:10:17,760 --> 00:10:19,920
though it doesn't alert on a lot

312
00:10:19,920 --> 00:10:21,920
like all of them do because there's a

313
00:10:21,920 --> 00:10:24,240
billion ways to execute an attack

314
00:10:24,240 --> 00:10:26,160
you at least get the telemetry to build

315
00:10:26,160 --> 00:10:28,079
your own detections for this

316
00:10:28,079 --> 00:10:30,160
and this is where it starts to get nice

317
00:10:30,160 --> 00:10:33,360
but also i start to get curious because

318
00:10:33,360 --> 00:10:35,680
where does it get it what do i get and

319
00:10:35,680 --> 00:10:37,760
how how good is that telemetry uh

320
00:10:37,760 --> 00:10:39,360
especially because it's

321
00:10:39,360 --> 00:10:40,560
yeah it's a sort of single source

322
00:10:40,560 --> 00:10:42,959
solution you pay x amount of money per

323
00:10:42,959 --> 00:10:45,680
endpoints and you get unlimited storage

324
00:10:45,680 --> 00:10:48,720
or not so you don't really know but yeah

325
00:10:48,720 --> 00:10:51,360
it's quite broad so it can it can the

326
00:10:51,360 --> 00:10:53,040
only thing that you have to keep in mind

327
00:10:53,040 --> 00:10:55,200
like it's a it's a solution that you pay

328
00:10:55,200 --> 00:10:58,000
for so they control everything

329
00:10:58,000 --> 00:11:00,399
they basically determine what type of

330
00:11:00,399 --> 00:11:02,079
events you will get so there's no

331
00:11:02,079 --> 00:11:04,240
configurability in terms of how noisy

332
00:11:04,240 --> 00:11:06,640
you want it or these kind of things

333
00:11:06,640 --> 00:11:08,399
for the alert side maybe right you can

334
00:11:08,399 --> 00:11:09,760
you can threshold some stuff but

335
00:11:09,760 --> 00:11:11,600
telemetry wise it's just whatever

336
00:11:11,600 --> 00:11:13,440
microsoft themes fit for you

337
00:11:13,440 --> 00:11:15,040
is what you get

338
00:11:15,040 --> 00:11:16,399
and we'll get into that a little bit

339
00:11:16,399 --> 00:11:18,079
more so some of the events also

340
00:11:18,079 --> 00:11:20,240
therefore are supremely or heavily

341
00:11:20,240 --> 00:11:22,320
sampled

342
00:11:22,320 --> 00:11:24,320
because yeah

343
00:11:24,320 --> 00:11:27,279
you pay five bucks a month which is not

344
00:11:27,279 --> 00:11:29,839
that much at scale

345
00:11:29,839 --> 00:11:31,279
and if they have to store all of your

346
00:11:31,279 --> 00:11:32,720
network connections for instance that's

347
00:11:32,720 --> 00:11:35,120
going to cost them a lot of money impact

348
00:11:35,120 --> 00:11:36,800
performance will be slow everybody's

349
00:11:36,800 --> 00:11:38,079
complaining

350
00:11:38,079 --> 00:11:40,640
so nobody's happy there so these are

351
00:11:40,640 --> 00:11:42,880
heavily sampled and some of the other

352
00:11:42,880 --> 00:11:44,160
ones are

353
00:11:44,160 --> 00:11:45,920
even worse

354
00:11:45,920 --> 00:11:48,560
and they try to tap into a lot of data

355
00:11:48,560 --> 00:11:50,240
sources just to have a sort of full

356
00:11:50,240 --> 00:11:52,720
picture on your on your machine so

357
00:11:52,720 --> 00:11:54,240
the event racing for windows is

358
00:11:54,240 --> 00:11:56,880
supremely supremely used is very heavily

359
00:11:56,880 --> 00:11:59,360
used as the 65 different providers that

360
00:11:59,360 --> 00:12:00,720
it's querying

361
00:12:00,720 --> 00:12:02,560
or getting data from

362
00:12:02,560 --> 00:12:04,240
and this includes all kinds of private

363
00:12:04,240 --> 00:12:05,760
ones that they instantiate when you

364
00:12:05,760 --> 00:12:07,920
install it as well

365
00:12:07,920 --> 00:12:10,079
and one of the ones is now in windows 10

366
00:12:10,079 --> 00:12:12,880
that's called the threat intelligence

367
00:12:12,880 --> 00:12:14,720
provider which i'll show you a little

368
00:12:14,720 --> 00:12:17,279
bit more about in a second

369
00:12:17,279 --> 00:12:18,800
and these can only be

370
00:12:18,800 --> 00:12:21,200
accessed through microsoft's

371
00:12:21,200 --> 00:12:24,560
allows i think a v fender so it's uh

372
00:12:24,560 --> 00:12:26,160
yeah you can you can still access it and

373
00:12:26,160 --> 00:12:27,920
i'll show you that as well but it's a

374
00:12:27,920 --> 00:12:29,600
little bit more work

375
00:12:29,600 --> 00:12:31,680
so as i mentioned everything goes into

376
00:12:31,680 --> 00:12:32,880
the cloud

377
00:12:32,880 --> 00:12:35,440
you get all kinds of nice visualizations

378
00:12:35,440 --> 00:12:37,040
and tools around it

379
00:12:37,040 --> 00:12:39,040
the detailed information like the full

380
00:12:39,040 --> 00:12:40,720
telemetry is only stored there for 30

381
00:12:40,720 --> 00:12:42,800
days you can't extend that

382
00:12:42,800 --> 00:12:44,480
then you need to export it which is

383
00:12:44,480 --> 00:12:45,839
relatively easy

384
00:12:45,839 --> 00:12:48,079
they make it accessible to you

385
00:12:48,079 --> 00:12:49,760
but this is what you get within the

386
00:12:49,760 --> 00:12:51,519
price that you get and there's a sort of

387
00:12:51,519 --> 00:12:53,920
timeline overview which is a condensed

388
00:12:53,920 --> 00:12:55,279
data set

389
00:12:55,279 --> 00:12:56,800
which isn't really nice to go through

390
00:12:56,800 --> 00:12:58,720
but it's a sort of better visualization

391
00:12:58,720 --> 00:13:01,200
if you're want to go quick and dirty but

392
00:13:01,200 --> 00:13:02,959
if you want to go further then yeah

393
00:13:02,959 --> 00:13:04,720
probably get it into sentinel splunk

394
00:13:04,720 --> 00:13:07,040
whatever whatever you're using

395
00:13:07,040 --> 00:13:08,560
on average i think

396
00:13:08,560 --> 00:13:10,320
what we've seen so far for most of our

397
00:13:10,320 --> 00:13:11,839
clients is like 20 megabytes per

398
00:13:11,839 --> 00:13:13,600
endpoint per day so it's not

399
00:13:13,600 --> 00:13:15,040
a lot of data

400
00:13:15,040 --> 00:13:17,360
still very valuable so

401
00:13:17,360 --> 00:13:19,120
what can you expect so if you if you

402
00:13:19,120 --> 00:13:20,880
just open up the portal there you get a

403
00:13:20,880 --> 00:13:22,800
nice overview of all the tables so it's

404
00:13:22,800 --> 00:13:25,440
a sort of yeah it's a table structure

405
00:13:25,440 --> 00:13:26,880
and within the table there's all kinds

406
00:13:26,880 --> 00:13:29,360
of fields that you can query

407
00:13:29,360 --> 00:13:30,880
and there's all kinds of ways to

408
00:13:30,880 --> 00:13:32,399
basically see what you can do you can

409
00:13:32,399 --> 00:13:34,399
just visually click through it

410
00:13:34,399 --> 00:13:36,000
you can also requested it through the

411
00:13:36,000 --> 00:13:37,760
query language just show me the schema

412
00:13:37,760 --> 00:13:39,040
and then you get all the fields that you

413
00:13:39,040 --> 00:13:40,880
can expect and if you want to go a

414
00:13:40,880 --> 00:13:43,040
little bit deeper then then within some

415
00:13:43,040 --> 00:13:46,160
of those fields are actually subfields

416
00:13:46,160 --> 00:13:48,560
so it's very confusing

417
00:13:48,560 --> 00:13:50,320
and especially on the device events

418
00:13:50,320 --> 00:13:53,600
there is a table called um um addition

419
00:13:53,600 --> 00:13:55,279
of action type

420
00:13:55,279 --> 00:13:56,560
and then if you look into the action

421
00:13:56,560 --> 00:13:59,680
type there are actually 180 plus

422
00:13:59,680 --> 00:14:01,440
different actions that it talks so one

423
00:14:01,440 --> 00:14:02,880
of which is the

424
00:14:02,880 --> 00:14:05,040
the the asr events

425
00:14:05,040 --> 00:14:06,320
but there's all kinds of other things

426
00:14:06,320 --> 00:14:09,760
like name pipes and usb connections and

427
00:14:09,760 --> 00:14:12,079
everything that you would want basically

428
00:14:12,079 --> 00:14:14,880
it's super rich they actually have good

429
00:14:14,880 --> 00:14:17,360
documentation within the tool on it not

430
00:14:17,360 --> 00:14:19,920
on the website weirdly enough and the

431
00:14:19,920 --> 00:14:22,240
only thing that that is sort of annoying

432
00:14:22,240 --> 00:14:24,639
they they are so agile in their

433
00:14:24,639 --> 00:14:26,480
development that they release the

434
00:14:26,480 --> 00:14:29,360
documentation often before the actual

435
00:14:29,360 --> 00:14:31,120
implementation is there which is kind of

436
00:14:31,120 --> 00:14:32,000
nice

437
00:14:32,000 --> 00:14:33,440
uh usually

438
00:14:33,440 --> 00:14:36,160
for everyone or it's an afterthought

439
00:14:36,160 --> 00:14:38,079
right nobody likes a document but at

440
00:14:38,079 --> 00:14:39,680
least somebody at microsoft does so

441
00:14:39,680 --> 00:14:41,199
thanks for that

442
00:14:41,199 --> 00:14:43,279
but they also don't do real change logs

443
00:14:43,279 --> 00:14:45,120
so how do you know if there's a new

444
00:14:45,120 --> 00:14:46,720
feature there might be new telemetry

445
00:14:46,720 --> 00:14:49,120
that you can actually start utilizing

446
00:14:49,120 --> 00:14:50,720
but yeah maybe you have to scroll

447
00:14:50,720 --> 00:14:52,240
through it every day so what we started

448
00:14:52,240 --> 00:14:54,560
fiddling with is of course if you go

449
00:14:54,560 --> 00:14:56,480
open the hacker view of your browser and

450
00:14:56,480 --> 00:14:58,800
you get nice json output you can

451
00:14:58,800 --> 00:15:00,800
actually start utilizing this so you can

452
00:15:00,800 --> 00:15:03,199
with the azure command line tool can you

453
00:15:03,199 --> 00:15:05,920
can basically generate a barrier token

454
00:15:05,920 --> 00:15:08,240
and talk to this api which isn't

455
00:15:08,240 --> 00:15:10,240
documented it's basically part of the

456
00:15:10,240 --> 00:15:12,240
the portal and then you can just extract

457
00:15:12,240 --> 00:15:14,000
all of that information

458
00:15:14,000 --> 00:15:15,760
and maybe if you want to go really anal

459
00:15:15,760 --> 00:15:17,920
like we do is we build a pipeline around

460
00:15:17,920 --> 00:15:19,839
it and we do a diff every every four

461
00:15:19,839 --> 00:15:20,959
hours and see if there's new

462
00:15:20,959 --> 00:15:23,279
functionality coming out

463
00:15:23,279 --> 00:15:25,199
so that that might help you right it's

464
00:15:25,199 --> 00:15:27,279
it's a bit over engineering and i would

465
00:15:27,279 --> 00:15:28,959
love microsoft to just have a sort of

466
00:15:28,959 --> 00:15:31,440
release log where they just expose what

467
00:15:31,440 --> 00:15:32,800
they have

468
00:15:32,800 --> 00:15:34,320
but this is what it is

469
00:15:34,320 --> 00:15:35,040
so

470
00:15:35,040 --> 00:15:37,199
yeah do you need custom detection so

471
00:15:37,199 --> 00:15:38,959
maybe some people saw adams talk this

472
00:15:38,959 --> 00:15:41,040
morning i was talking about coverage and

473
00:15:41,040 --> 00:15:42,800
breath

474
00:15:42,800 --> 00:15:44,880
according to the atomic red team so what

475
00:15:44,880 --> 00:15:47,120
i did is i basically ran most of the

476
00:15:47,120 --> 00:15:48,720
windows scripts

477
00:15:48,720 --> 00:15:52,160
which is about 600 maybe and some of

478
00:15:52,160 --> 00:15:53,759
it's failed because it wasn't domain

479
00:15:53,759 --> 00:15:55,199
control it was the main joint and

480
00:15:55,199 --> 00:15:58,079
everything like it but i only got 177

481
00:15:58,079 --> 00:16:00,480
alerts which isn't very scientific i

482
00:16:00,480 --> 00:16:02,800
know it's just spraying a lot of at

483
00:16:02,800 --> 00:16:05,040
it and maybe it's fired

484
00:16:05,040 --> 00:16:06,800
but

485
00:16:06,800 --> 00:16:08,720
i mean there is something to do right

486
00:16:08,720 --> 00:16:10,720
even if only half of those scripts were

487
00:16:10,720 --> 00:16:12,000
successful

488
00:16:12,000 --> 00:16:14,079
uh which there were more

489
00:16:14,079 --> 00:16:17,839
but then there's only 177 detections out

490
00:16:17,839 --> 00:16:19,440
of which

491
00:16:19,440 --> 00:16:21,600
10 less were mapped to minor attack so

492
00:16:21,600 --> 00:16:23,120
there's there's some stuff that we

493
00:16:23,120 --> 00:16:25,120
probably need to do ourselves if we find

494
00:16:25,120 --> 00:16:26,959
it interesting to detect that

495
00:16:26,959 --> 00:16:29,199
this slide is old deliberately again

496
00:16:29,199 --> 00:16:31,680
because i don't want to help all the

497
00:16:31,680 --> 00:16:33,519
adversaries here but basically what we

498
00:16:33,519 --> 00:16:35,440
did is we looked at all of our clients

499
00:16:35,440 --> 00:16:37,600
what type of detections are actually

500
00:16:37,600 --> 00:16:39,759
triggering an action environment plus we

501
00:16:39,759 --> 00:16:40,959
hammered

502
00:16:40,959 --> 00:16:42,880
it with all kinds of badness that we did

503
00:16:42,880 --> 00:16:45,360
ourselves and basically we got a sort of

504
00:16:45,360 --> 00:16:47,040
overview the darker the color in this

505
00:16:47,040 --> 00:16:49,920
image is basically the diversity of

506
00:16:49,920 --> 00:16:52,320
attack scenarios that were detected

507
00:16:52,320 --> 00:16:54,320
so there's there's still some gaps and

508
00:16:54,320 --> 00:16:56,320
that's fine it's it's an endpoint tool

509
00:16:56,320 --> 00:16:58,880
it's one tool you can't cover everything

510
00:16:58,880 --> 00:17:00,320
but there's also some room for

511
00:17:00,320 --> 00:17:01,360
improvement if you want to start

512
00:17:01,360 --> 00:17:02,720
building your own detections on top of

513
00:17:02,720 --> 00:17:03,519
this

514
00:17:03,519 --> 00:17:05,280
next what i wanted to look at is

515
00:17:05,280 --> 00:17:07,599
basically how

516
00:17:07,599 --> 00:17:09,280
so what kind of dilemmas you can expect

517
00:17:09,280 --> 00:17:10,720
and this is the theoretical bit so

518
00:17:10,720 --> 00:17:12,480
basically what we did i worked together

519
00:17:12,480 --> 00:17:14,559
with the rodriguez brothers

520
00:17:14,559 --> 00:17:17,199
they have the osam project which maps

521
00:17:17,199 --> 00:17:19,439
all of the coverage and then connects it

522
00:17:19,439 --> 00:17:21,439
back to mitre attack and the cool thing

523
00:17:21,439 --> 00:17:23,359
that we can do then is basically we have

524
00:17:23,359 --> 00:17:26,640
all kinds of actor groups who do tactics

525
00:17:26,640 --> 00:17:28,559
they execute techniques

526
00:17:28,559 --> 00:17:31,200
and there's data components and there's

527
00:17:31,200 --> 00:17:32,720
data sources and data components in

528
00:17:32,720 --> 00:17:35,039
microattack but what we can do then is

529
00:17:35,039 --> 00:17:37,679
basically map it to events what type of

530
00:17:37,679 --> 00:17:38,880
data is it

531
00:17:38,880 --> 00:17:40,720
and even to the provider and what you

532
00:17:40,720 --> 00:17:42,320
can then do basically is start

533
00:17:42,320 --> 00:17:44,320
generating these kind of fancy heat maps

534
00:17:44,320 --> 00:17:45,679
where you can show

535
00:17:45,679 --> 00:17:48,160
what kind of data can i expect from it

536
00:17:48,160 --> 00:17:49,600
and this is theoretical right so it's

537
00:17:49,600 --> 00:17:51,760
not necessarily said that everything

538
00:17:51,760 --> 00:17:53,600
that is now colored

539
00:17:53,600 --> 00:17:55,600
will be generated because there's

540
00:17:55,600 --> 00:17:58,160
filters and sampling as i mentioned

541
00:17:58,160 --> 00:18:00,000
basically you can already see if i want

542
00:18:00,000 --> 00:18:01,760
to cover this technique

543
00:18:01,760 --> 00:18:03,679
with the custom detection where should i

544
00:18:03,679 --> 00:18:05,840
start looking which is kind of helpful

545
00:18:05,840 --> 00:18:07,600
and of course i like the bloodhound tool

546
00:18:07,600 --> 00:18:09,600
so i also started graphing it

547
00:18:09,600 --> 00:18:12,000
not necessarily very legible yet but

548
00:18:12,000 --> 00:18:13,600
there's a lot of data potential here

549
00:18:13,600 --> 00:18:15,360
right and if you start zooming in a

550
00:18:15,360 --> 00:18:17,360
little bit more hopefully it's legible

551
00:18:17,360 --> 00:18:19,600
again so if i only want to see what what

552
00:18:19,600 --> 00:18:22,000
kind of registry based detections can i

553
00:18:22,000 --> 00:18:23,520
potentially build

554
00:18:23,520 --> 00:18:25,360
this is already slightly more useful

555
00:18:25,360 --> 00:18:26,960
which fields do i need to look at and

556
00:18:26,960 --> 00:18:29,600
these kind of things so then we're at

557
00:18:29,600 --> 00:18:31,600
the point so we have a lot of data but

558
00:18:31,600 --> 00:18:33,679
where does it come from

559
00:18:33,679 --> 00:18:35,200
and this is as i mentioned in the

560
00:18:35,200 --> 00:18:36,799
beginning it's important to understand

561
00:18:36,799 --> 00:18:38,320
basically how your tool works if you

562
00:18:38,320 --> 00:18:40,960
want to be able to rely on it and maybe

563
00:18:40,960 --> 00:18:43,360
supply some additional telemetry next to

564
00:18:43,360 --> 00:18:44,080
it

565
00:18:44,080 --> 00:18:45,280
so there's a couple of things that it

566
00:18:45,280 --> 00:18:46,080
does

567
00:18:46,080 --> 00:18:49,360
so defender for endpoint or that uses

568
00:18:49,360 --> 00:18:50,720
one of the things that they do is they

569
00:18:50,720 --> 00:18:52,640
use a device driver

570
00:18:52,640 --> 00:18:55,120
which sets a bunch of kernel callbacks

571
00:18:55,120 --> 00:18:57,280
and basically what they are is they tell

572
00:18:57,280 --> 00:18:59,440
the kernel hey if a new process being

573
00:18:59,440 --> 00:19:01,280
created tell me

574
00:19:01,280 --> 00:19:02,960
and then you get the full the full

575
00:19:02,960 --> 00:19:04,160
details

576
00:19:04,160 --> 00:19:05,600
the same goes for

577
00:19:05,600 --> 00:19:07,280
registry keys for

578
00:19:07,280 --> 00:19:09,200
image loads or driver loads as you as

579
00:19:09,200 --> 00:19:10,480
you will

580
00:19:10,480 --> 00:19:12,559
name pipes and a bunch of other ones

581
00:19:12,559 --> 00:19:15,440
so one of the interesting things here um

582
00:19:15,440 --> 00:19:17,440
is that it only basically what you're

583
00:19:17,440 --> 00:19:19,120
looking at is mimikatz because it was

584
00:19:19,120 --> 00:19:21,120
easy tool and and you can query all

585
00:19:21,120 --> 00:19:22,799
these these kernel callbacks that are

586
00:19:22,799 --> 00:19:24,960
registered this was the easiest way for

587
00:19:24,960 --> 00:19:26,880
me to visualize it and basically what

588
00:19:26,880 --> 00:19:28,480
you see is that there's a pre-operation

589
00:19:28,480 --> 00:19:30,880
and post operation and the difference is

590
00:19:30,880 --> 00:19:32,720
as you might expect for a process so the

591
00:19:32,720 --> 00:19:34,400
pre-operation is when the process is

592
00:19:34,400 --> 00:19:35,840
started

593
00:19:35,840 --> 00:19:37,280
and the post operation is when it's

594
00:19:37,280 --> 00:19:39,200
terminated and you see that there's only

595
00:19:39,200 --> 00:19:41,840
a callback for a defender

596
00:19:41,840 --> 00:19:44,320
and for the edr components so these have

597
00:19:44,320 --> 00:19:45,919
different drivers

598
00:19:45,919 --> 00:19:48,000
and not for the process termination so

599
00:19:48,000 --> 00:19:49,440
this is already something that you could

600
00:19:49,440 --> 00:19:50,880
have also learned from your telemetry

601
00:19:50,880 --> 00:19:52,400
but now you at least know

602
00:19:52,400 --> 00:19:54,880
that it actually doesn't even look at it

603
00:19:54,880 --> 00:19:57,039
not even underwater because there is a

604
00:19:57,039 --> 00:19:58,799
difference between what you see in the

605
00:19:58,799 --> 00:20:00,480
portal in terms of telemetry and what

606
00:20:00,480 --> 00:20:02,640
they actually record that's way more and

607
00:20:02,640 --> 00:20:04,480
if you look a little bit below for

608
00:20:04,480 --> 00:20:06,159
people that know of cesman that actually

609
00:20:06,159 --> 00:20:07,360
does both

610
00:20:07,360 --> 00:20:08,960
that's the only distinction on kernel

611
00:20:08,960 --> 00:20:10,799
callbacks that i could find between the

612
00:20:10,799 --> 00:20:11,600
two

613
00:20:11,600 --> 00:20:13,679
and then again i figured hey let's let's

614
00:20:13,679 --> 00:20:15,520
visualize this because it might be

615
00:20:15,520 --> 00:20:17,200
useful later

616
00:20:17,200 --> 00:20:19,120
and basically i mapped all the kernel

617
00:20:19,120 --> 00:20:21,200
callbacks that you could set to the data

618
00:20:21,200 --> 00:20:22,799
components in miter

619
00:20:22,799 --> 00:20:24,720
and then i could also map it back to

620
00:20:24,720 --> 00:20:26,960
which fields can i expect the data to be

621
00:20:26,960 --> 00:20:27,600
in

622
00:20:27,600 --> 00:20:28,320
in

623
00:20:28,320 --> 00:20:30,400
defender for endpoints again a lot of

624
00:20:30,400 --> 00:20:32,720
eye candy but can be useful in some ways

625
00:20:32,720 --> 00:20:34,559
because then you can also start querying

626
00:20:34,559 --> 00:20:36,159
detections and then

627
00:20:36,159 --> 00:20:38,320
or or techniques and see what you can

628
00:20:38,320 --> 00:20:40,159
actually start querying it's a quicker

629
00:20:40,159 --> 00:20:42,559
way that i like to use a lot

630
00:20:42,559 --> 00:20:44,480
as i mentioned before

631
00:20:44,480 --> 00:20:46,320
it also heavily relies on event tracing

632
00:20:46,320 --> 00:20:48,720
for windows which is sort of built into

633
00:20:48,720 --> 00:20:50,559
the kernel it's the underlying messaging

634
00:20:50,559 --> 00:20:52,320
structure for all

635
00:20:52,320 --> 00:20:54,960
telemetry basically or most telemetry

636
00:20:54,960 --> 00:20:56,159
and there's some interesting things so

637
00:20:56,159 --> 00:20:59,360
that basically is set up in three layers

638
00:20:59,360 --> 00:21:02,559
you have providers you have consumers

639
00:21:02,559 --> 00:21:04,240
which kind of make sense right they're

640
00:21:04,240 --> 00:21:05,280
friends

641
00:21:05,280 --> 00:21:06,880
you you show something somebody else

642
00:21:06,880 --> 00:21:08,720
takes it and then there's tracing

643
00:21:08,720 --> 00:21:10,000
sessions which is a sort of a

644
00:21:10,000 --> 00:21:11,360
consumer-like

645
00:21:11,360 --> 00:21:13,360
object but it works in a slightly

646
00:21:13,360 --> 00:21:15,120
different way it's a different different

647
00:21:15,120 --> 00:21:17,360
way of looking to that data again matt

648
00:21:17,360 --> 00:21:19,600
graber did a ton of great research

649
00:21:19,600 --> 00:21:21,840
on this so if you want to learn more

650
00:21:21,840 --> 00:21:24,960
definitely read these two blogs

651
00:21:24,960 --> 00:21:26,640
because i don't have the time to explain

652
00:21:26,640 --> 00:21:28,000
everything now

653
00:21:28,000 --> 00:21:29,120
so

654
00:21:29,120 --> 00:21:30,799
the weird thing is that the vendor for

655
00:21:30,799 --> 00:21:33,520
endpoint uses uh some of their own

656
00:21:33,520 --> 00:21:35,760
proprietary etw providers which

657
00:21:35,760 --> 00:21:38,880
basically uses sort of aggregation point

658
00:21:38,880 --> 00:21:40,799
so they stand up their own their own

659
00:21:40,799 --> 00:21:43,360
infrastructure so to say where they use

660
00:21:43,360 --> 00:21:45,600
a lot of

661
00:21:45,600 --> 00:21:48,080
their own messaging providers that they

662
00:21:48,080 --> 00:21:50,640
hook to and then ship it off

663
00:21:50,640 --> 00:21:52,480
which was already kind of interesting at

664
00:21:52,480 --> 00:21:54,640
least and matt graber built the tool i

665
00:21:54,640 --> 00:21:57,039
met greg again i love the guy

666
00:21:57,039 --> 00:21:59,280
to basically see which of the ones are

667
00:21:59,280 --> 00:22:00,799
actually built into the code so you can

668
00:22:00,799 --> 00:22:02,400
relatively

669
00:22:02,400 --> 00:22:05,039
rely on on the truth of that

670
00:22:05,039 --> 00:22:07,039
and then what i started doing is

671
00:22:07,039 --> 00:22:08,799
basically looking okay where where does

672
00:22:08,799 --> 00:22:11,039
that get data go because usually you

673
00:22:11,039 --> 00:22:13,120
don't get live stream data from the

674
00:22:13,120 --> 00:22:15,120
vendor into the portal so it's stored

675
00:22:15,120 --> 00:22:17,600
first locally and then at a certain

676
00:22:17,600 --> 00:22:20,960
point either time or volume it gets

677
00:22:20,960 --> 00:22:22,720
shipped off

678
00:22:22,720 --> 00:22:24,720
and then the database locally is flushed

679
00:22:24,720 --> 00:22:26,400
and and it starts really

680
00:22:26,400 --> 00:22:28,480
uh buffering up again

681
00:22:28,480 --> 00:22:30,320
so this is um

682
00:22:30,320 --> 00:22:31,840
uh it's kind of interesting i started

683
00:22:31,840 --> 00:22:33,120
fiddling with it a little bit you can't

684
00:22:33,120 --> 00:22:34,559
access it directly so you need to be a

685
00:22:34,559 --> 00:22:35,919
system at least

686
00:22:35,919 --> 00:22:39,360
to uh to uh copy the data and then

687
00:22:39,360 --> 00:22:41,120
yeah it's locked so you can't really

688
00:22:41,120 --> 00:22:43,120
tamper with it that well it's probably

689
00:22:43,120 --> 00:22:44,880
possible but

690
00:22:44,880 --> 00:22:46,240
yeah it's quite a lot of work and

691
00:22:46,240 --> 00:22:49,120
there's easier ways to to nuke it so i

692
00:22:49,120 --> 00:22:52,080
don't see any attack potential there

693
00:22:52,080 --> 00:22:53,679
and the fun thing is if i look in in

694
00:22:53,679 --> 00:22:55,840
that database it it's called asimov

695
00:22:55,840 --> 00:22:56,960
events

696
00:22:56,960 --> 00:22:59,360
and asimov is a sort of halo reference

697
00:22:59,360 --> 00:23:02,880
that from 2014 is very old

698
00:23:02,880 --> 00:23:04,400
and they used to be the unified

699
00:23:04,400 --> 00:23:06,960
telemetry client which is now

700
00:23:06,960 --> 00:23:08,720
direct track agent

701
00:23:08,720 --> 00:23:10,960
and why is that significant well we'll

702
00:23:10,960 --> 00:23:12,240
see in a bit but it's kind of

703
00:23:12,240 --> 00:23:15,600
interesting that they have a sort of

704
00:23:15,600 --> 00:23:17,520
very old reference in there even though

705
00:23:17,520 --> 00:23:19,679
the product doesn't exist for that long

706
00:23:19,679 --> 00:23:22,400
so i started playing with c lighter

707
00:23:22,400 --> 00:23:24,159
which is an open source tool

708
00:23:24,159 --> 00:23:27,039
available on github which is very useful

709
00:23:27,039 --> 00:23:29,360
to to basically subscribe to all these

710
00:23:29,360 --> 00:23:31,200
etw events to see

711
00:23:31,200 --> 00:23:32,720
what's being locked it's highly

712
00:23:32,720 --> 00:23:34,320
configurable you can tell it which you

713
00:23:34,320 --> 00:23:36,799
want i used to very basic approaches i

714
00:23:36,799 --> 00:23:39,200
just mentioned the etw guides that i

715
00:23:39,200 --> 00:23:40,080
needed

716
00:23:40,080 --> 00:23:42,000
and started ingesting that a little bit

717
00:23:42,000 --> 00:23:44,080
so some of those providers are actually

718
00:23:44,080 --> 00:23:46,159
protected so you need to have protect

719
00:23:46,159 --> 00:23:49,039
process flag to your tracing process

720
00:23:49,039 --> 00:23:50,240
otherwise you can't access that

721
00:23:50,240 --> 00:23:52,960
telemetry that's kind of nice because

722
00:23:52,960 --> 00:23:56,080
that at least uh protects also a little

723
00:23:56,080 --> 00:23:58,400
bit from tampering or listening in and

724
00:23:58,400 --> 00:24:00,320
there's some proprietary information in

725
00:24:00,320 --> 00:24:01,840
there that you might not want to expose

726
00:24:01,840 --> 00:24:03,520
to your competitors even though it's

727
00:24:03,520 --> 00:24:05,679
super simple to get into so there's a

728
00:24:05,679 --> 00:24:07,600
couple of tools that you can use ppl

729
00:24:07,600 --> 00:24:09,039
runner is a really nice one where you

730
00:24:09,039 --> 00:24:10,640
can elevate your own process with a

731
00:24:10,640 --> 00:24:12,480
vulnerable driver

732
00:24:12,480 --> 00:24:14,320
and basically get still access to that

733
00:24:14,320 --> 00:24:17,039
same telemetry it's also funny that

734
00:24:17,039 --> 00:24:19,279
while playing around with with those

735
00:24:19,279 --> 00:24:21,360
protected processors you can also attach

736
00:24:21,360 --> 00:24:23,840
a debugger with some magic that my

737
00:24:23,840 --> 00:24:24,880
colleague

738
00:24:24,880 --> 00:24:25,840
found

739
00:24:25,840 --> 00:24:26,960
and you can basically start live

740
00:24:26,960 --> 00:24:29,120
debugging the defender engine and he

741
00:24:29,120 --> 00:24:30,720
found a vulnerability where you could

742
00:24:30,720 --> 00:24:33,200
spoof all the telemetry to uh to the

743
00:24:33,200 --> 00:24:35,919
microsoft portal which was just accepted

744
00:24:35,919 --> 00:24:37,840
so you could generate fake alerts you

745
00:24:37,840 --> 00:24:39,840
could generate fake telemetry and have

746
00:24:39,840 --> 00:24:41,520
all kinds of fun as an attacker

747
00:24:41,520 --> 00:24:43,200
fortunately that's patched and it's gone

748
00:24:43,200 --> 00:24:44,400
now

749
00:24:44,400 --> 00:24:46,640
almost not possible anymore to uh to

750
00:24:46,640 --> 00:24:47,760
spoof it

751
00:24:47,760 --> 00:24:49,360
and now it's at the skill that it

752
00:24:49,360 --> 00:24:52,400
doesn't really impact any agent

753
00:24:52,400 --> 00:24:54,640
so back to those traces so

754
00:24:54,640 --> 00:24:56,320
if you start tracing it you get all

755
00:24:56,320 --> 00:24:58,720
kinds of fancy json objects and within

756
00:24:58,720 --> 00:25:00,480
those json objects there were these

757
00:25:00,480 --> 00:25:01,840
fields that looked a little bit like

758
00:25:01,840 --> 00:25:03,200
base64

759
00:25:03,200 --> 00:25:06,240
so i just copied one and decoded it and

760
00:25:06,240 --> 00:25:08,159
then i saw indeed hey there's some plain

761
00:25:08,159 --> 00:25:10,400
text in there and this

762
00:25:10,400 --> 00:25:12,720
for the people that work with windows

763
00:25:12,720 --> 00:25:14,480
this is this looks like an event id to

764
00:25:14,480 --> 00:25:16,240
me like this is a simple powershell

765
00:25:16,240 --> 00:25:17,679
event log

766
00:25:17,679 --> 00:25:19,679
but it's even the same ugly structure so

767
00:25:19,679 --> 00:25:21,200
it was kind of interesting and then

768
00:25:21,200 --> 00:25:23,120
there was all kinds of gibberish around

769
00:25:23,120 --> 00:25:23,919
it

770
00:25:23,919 --> 00:25:25,919
which turns out to be

771
00:25:25,919 --> 00:25:27,440
serialized

772
00:25:27,440 --> 00:25:30,559
data so microsoft uses bonds which is a

773
00:25:30,559 --> 00:25:32,159
product that they built it's an open

774
00:25:32,159 --> 00:25:33,200
source tool

775
00:25:33,200 --> 00:25:34,880
that can based on a certain schema

776
00:25:34,880 --> 00:25:36,880
serialize it and then it's just more

777
00:25:36,880 --> 00:25:39,600
efficient for them to to transport it

778
00:25:39,600 --> 00:25:41,600
and parse it later

779
00:25:41,600 --> 00:25:42,720
i tried

780
00:25:42,720 --> 00:25:45,360
finding the schemas in the code but yeah

781
00:25:45,360 --> 00:25:47,760
i'm a horrible debugger

782
00:25:47,760 --> 00:25:49,440
and even worse at reverse engineering so

783
00:25:49,440 --> 00:25:50,960
i haven't found those yet but they're

784
00:25:50,960 --> 00:25:52,559
probably in there because it needs to

785
00:25:52,559 --> 00:25:54,640
know how to serialize it so that might

786
00:25:54,640 --> 00:25:56,799
be a nice exercise for somebody else to

787
00:25:56,799 --> 00:25:57,679
do

788
00:25:57,679 --> 00:25:59,520
and then the other thing that was

789
00:25:59,520 --> 00:26:01,279
interesting is is

790
00:26:01,279 --> 00:26:03,520
i saw that powershell data

791
00:26:03,520 --> 00:26:05,600
but i don't see if i look at which

792
00:26:05,600 --> 00:26:07,840
subscriptions are there i couldn't see

793
00:26:07,840 --> 00:26:10,320
it so that that sort of peaked my

794
00:26:10,320 --> 00:26:12,000
interest a little bit

795
00:26:12,000 --> 00:26:14,240
and also it was an event log so

796
00:26:14,240 --> 00:26:15,840
apparently

797
00:26:15,840 --> 00:26:18,320
and the e makes use of event logs

798
00:26:18,320 --> 00:26:20,799
so i started looking a little bit more

799
00:26:20,799 --> 00:26:23,279
and i i remember so i saw that dire

800
00:26:23,279 --> 00:26:25,120
track thing as well so i started looking

801
00:26:25,120 --> 00:26:27,919
into that which is an old service that

802
00:26:27,919 --> 00:26:30,400
does all kinds of telemetry recording

803
00:26:30,400 --> 00:26:33,039
but somehow they're tied to to defender

804
00:26:33,039 --> 00:26:34,960
and they actually had the subscriptions

805
00:26:34,960 --> 00:26:37,200
to all those event ids that i was

806
00:26:37,200 --> 00:26:38,720
looking at before so also the powershell

807
00:26:38,720 --> 00:26:39,600
one

808
00:26:39,600 --> 00:26:41,760
the directrack service

809
00:26:41,760 --> 00:26:43,440
logs those

810
00:26:43,440 --> 00:26:44,640
interestingly

811
00:26:44,640 --> 00:26:47,440
you can also just disable that service

812
00:26:47,440 --> 00:26:49,440
and then everything is gone

813
00:26:49,440 --> 00:26:50,559
so

814
00:26:50,559 --> 00:26:53,279
it's kind of weird that they rely on a

815
00:26:53,279 --> 00:26:55,279
standard witness component for such

816
00:26:55,279 --> 00:26:56,320
important

817
00:26:56,320 --> 00:26:58,159
information and it's unprotected so i

818
00:26:58,159 --> 00:26:59,919
started looking at the protections as a

819
00:26:59,919 --> 00:27:01,279
local admin

820
00:27:01,279 --> 00:27:02,960
i can just stop the service and there's

821
00:27:02,960 --> 00:27:04,799
no telemetry anymore

822
00:27:04,799 --> 00:27:07,760
interestingly uh later i i learned that

823
00:27:07,760 --> 00:27:10,880
at in 2017 there was also a talk around

824
00:27:10,880 --> 00:27:14,480
the early stages of this this tool

825
00:27:14,480 --> 00:27:15,760
and back then

826
00:27:15,760 --> 00:27:17,200
the the same

827
00:27:17,200 --> 00:27:18,559
the researchers found that also that

828
00:27:18,559 --> 00:27:20,000
service wasn't protected they talked to

829
00:27:20,000 --> 00:27:21,760
microsoft one batch level later it was

830
00:27:21,760 --> 00:27:22,960
fixed

831
00:27:22,960 --> 00:27:25,840
yet on a new windows box it's not so

832
00:27:25,840 --> 00:27:27,600
somebody forgot a regression check or

833
00:27:27,600 --> 00:27:29,360
something like it

834
00:27:29,360 --> 00:27:30,960
and nobody sees it right because it's

835
00:27:30,960 --> 00:27:32,559
yeah most of the time it's not that

836
00:27:32,559 --> 00:27:34,080
important but for an edr you kind of

837
00:27:34,080 --> 00:27:35,120
want to have

838
00:27:35,120 --> 00:27:37,600
a reliable way of delivering some stuff

839
00:27:37,600 --> 00:27:39,440
so this is one of the few things as an

840
00:27:39,440 --> 00:27:40,720
attacker you might want to actually

841
00:27:40,720 --> 00:27:42,399
utilize

842
00:27:42,399 --> 00:27:44,960
and the rest is up to you to find out

843
00:27:44,960 --> 00:27:47,360
especially this one so the configuration

844
00:27:47,360 --> 00:27:49,440
every product needs to be configured

845
00:27:49,440 --> 00:27:50,640
because otherwise it doesn't know what

846
00:27:50,640 --> 00:27:51,679
to do

847
00:27:51,679 --> 00:27:54,080
as i mentioned microsoft maintains this

848
00:27:54,080 --> 00:27:56,559
so they make sure that you get

849
00:27:56,559 --> 00:27:59,360
registry keys these kind of things so

850
00:27:59,360 --> 00:28:01,120
there's all kinds of things and it's

851
00:28:01,120 --> 00:28:03,039
downloaded every couple of hours or

852
00:28:03,039 --> 00:28:04,399
every time they make a change which is

853
00:28:04,399 --> 00:28:06,480
quite a lot actually sundays they're

854
00:28:06,480 --> 00:28:08,559
they're fun day they do a lot of

855
00:28:08,559 --> 00:28:09,919
releases then

856
00:28:09,919 --> 00:28:11,360
because most of the team is based in

857
00:28:11,360 --> 00:28:14,000
israel that's a monday for them so

858
00:28:14,000 --> 00:28:16,159
there's a lot of new stuff every week

859
00:28:16,159 --> 00:28:18,960
basically that gets added tweaked uh all

860
00:28:18,960 --> 00:28:20,640
kinds of updates

861
00:28:20,640 --> 00:28:22,720
and basically it's it's a it's a it's

862
00:28:22,720 --> 00:28:25,039
quite a large config it's stored locally

863
00:28:25,039 --> 00:28:27,919
in the box again i won't tell you how

864
00:28:27,919 --> 00:28:29,840
because there's also a lot of people

865
00:28:29,840 --> 00:28:31,840
watching on the stream that might have

866
00:28:31,840 --> 00:28:33,919
different kinds of uh interest and the

867
00:28:33,919 --> 00:28:35,360
people that want to defend the company

868
00:28:35,360 --> 00:28:36,559
so

869
00:28:36,559 --> 00:28:37,760
go nuts

870
00:28:37,760 --> 00:28:39,440
have fun it's not the easiest one to

871
00:28:39,440 --> 00:28:42,000
find but yeah basically

872
00:28:42,000 --> 00:28:43,520
what what does it have so what's in

873
00:28:43,520 --> 00:28:45,679
there so all kinds of telemetry sources

874
00:28:45,679 --> 00:28:48,159
so the kernel objects but also

875
00:28:48,159 --> 00:28:51,120
etw providers register keys file paths

876
00:28:51,120 --> 00:28:52,880
where it might look for file creation

877
00:28:52,880 --> 00:28:55,520
events so a lot of interesting stuff to

878
00:28:55,520 --> 00:28:57,440
know as a defender but also as a

879
00:28:57,440 --> 00:28:58,960
attacker because then you know where you

880
00:28:58,960 --> 00:29:01,279
can have your bypasses

881
00:29:01,279 --> 00:29:03,039
because all kinds of stuff is include

882
00:29:03,039 --> 00:29:05,120
excluded as well because of noise or

883
00:29:05,120 --> 00:29:07,440
trust or all kinds of things

884
00:29:07,440 --> 00:29:08,480
so

885
00:29:08,480 --> 00:29:10,480
very interesting

886
00:29:10,480 --> 00:29:13,120
and and another is where where we

887
00:29:13,120 --> 00:29:14,720
already noticed that there was sampling

888
00:29:14,720 --> 00:29:16,240
and gapping involved that's also

889
00:29:16,240 --> 00:29:18,640
configured so some of the ones you can

890
00:29:18,640 --> 00:29:21,679
just see okay why do i only see one dll

891
00:29:21,679 --> 00:29:23,520
load for this process so it's actually

892
00:29:23,520 --> 00:29:25,840
because there's a limit to it otherwise

893
00:29:25,840 --> 00:29:27,760
you get flooded

894
00:29:27,760 --> 00:29:29,279
and there's also all kinds of dynamic

895
00:29:29,279 --> 00:29:30,799
data collections so they run a lot of

896
00:29:30,799 --> 00:29:32,880
signed powershell scripts

897
00:29:32,880 --> 00:29:34,399
which they mostly exclude in that

898
00:29:34,399 --> 00:29:36,960
convict to be visible in your telemetry

899
00:29:36,960 --> 00:29:38,080
because that's

900
00:29:38,080 --> 00:29:40,720
they're quite noisy and ugly

901
00:29:40,720 --> 00:29:41,520
but

902
00:29:41,520 --> 00:29:43,120
they gather all kinds of local

903
00:29:43,120 --> 00:29:44,640
information from a box that they can't

904
00:29:44,640 --> 00:29:46,320
gather from the logs which you do want

905
00:29:46,320 --> 00:29:48,720
to know in some cases

906
00:29:48,720 --> 00:29:51,039
and also the agent configuration so how

907
00:29:51,039 --> 00:29:53,120
long should it retain its data what is

908
00:29:53,120 --> 00:29:55,200
the buffer size all kinds of just normal

909
00:29:55,200 --> 00:29:56,240
stuff

910
00:29:56,240 --> 00:29:57,760
so it's quite a it's quite a lot so it's

911
00:29:57,760 --> 00:30:00,640
like 70 000 lines of json code

912
00:30:00,640 --> 00:30:02,480
or code but text

913
00:30:02,480 --> 00:30:06,480
and there's the those 65 edw providers

914
00:30:06,480 --> 00:30:07,440
there's

915
00:30:07,440 --> 00:30:10,320
about 500 registry paths that are being

916
00:30:10,320 --> 00:30:11,679
monitored

917
00:30:11,679 --> 00:30:13,760
and and about 60 of those commands that

918
00:30:13,760 --> 00:30:15,679
are being executed frequently and all

919
00:30:15,679 --> 00:30:17,600
kinds of settings for even if they

920
00:30:17,600 --> 00:30:19,200
detect

921
00:30:19,200 --> 00:30:20,799
that that you're in a high latency

922
00:30:20,799 --> 00:30:22,960
environment then it starts

923
00:30:22,960 --> 00:30:24,880
changing the gaps and some of the other

924
00:30:24,880 --> 00:30:26,320
things so that there's just limited

925
00:30:26,320 --> 00:30:28,240
amount of but more important information

926
00:30:28,240 --> 00:30:31,039
going out and then all kinds of yeah

927
00:30:31,039 --> 00:30:32,720
child processes that are trusted from

928
00:30:32,720 --> 00:30:35,039
certain parties or not so powershell for

929
00:30:35,039 --> 00:30:36,480
instance of course

930
00:30:36,480 --> 00:30:38,960
has a lot of child processes so there's

931
00:30:38,960 --> 00:30:40,880
a local limit that is changed for that

932
00:30:40,880 --> 00:30:42,720
one for instance so all kinds of things

933
00:30:42,720 --> 00:30:44,720
like that and then there's that list of

934
00:30:44,720 --> 00:30:46,960
etw providers so this is a very small

935
00:30:46,960 --> 00:30:48,320
snippet of it

936
00:30:48,320 --> 00:30:50,000
this is a very interesting one which is

937
00:30:50,000 --> 00:30:53,200
only available for edrs and avs

938
00:30:53,200 --> 00:30:55,520
that's the one we just looked at so from

939
00:30:55,520 --> 00:30:57,519
a sample so it was interesting but i

940
00:30:57,519 --> 00:30:59,519
also saw that one the security w which

941
00:30:59,519 --> 00:31:01,120
sounds already interesting of course

942
00:31:01,120 --> 00:31:02,240
because we're looking at a security

943
00:31:02,240 --> 00:31:05,120
product but first at that threat

944
00:31:05,120 --> 00:31:06,640
intelligence one

945
00:31:06,640 --> 00:31:09,600
good on time it's basically a a baked in

946
00:31:09,600 --> 00:31:12,640
windows one and if you're a validated av

947
00:31:12,640 --> 00:31:14,480
you can access it and there's all kinds

948
00:31:14,480 --> 00:31:16,799
of api calls that it logs so

949
00:31:16,799 --> 00:31:19,440
process suspension process injection all

950
00:31:19,440 --> 00:31:21,840
kinds of apis that are heavily used by

951
00:31:21,840 --> 00:31:23,760
attackers

952
00:31:23,760 --> 00:31:26,080
and and also some of the native windows

953
00:31:26,080 --> 00:31:27,200
tools

954
00:31:27,200 --> 00:31:29,679
but you'll at least get that telemetry

955
00:31:29,679 --> 00:31:31,919
there so it can basically subscribe to

956
00:31:31,919 --> 00:31:34,080
it log it and these kind of things

957
00:31:34,080 --> 00:31:36,720
it's quite fun and if you use etw

958
00:31:36,720 --> 00:31:38,720
explorer from um

959
00:31:38,720 --> 00:31:39,679
bevel

960
00:31:39,679 --> 00:31:41,440
you can basically just go through the to

961
00:31:41,440 --> 00:31:43,279
the manifest and you can see what kind

962
00:31:43,279 --> 00:31:45,120
of data you can expect

963
00:31:45,120 --> 00:31:47,840
you can also start

964
00:31:47,919 --> 00:31:50,240
listening to it but you need to have an

965
00:31:50,240 --> 00:31:52,320
elevated process as i mentioned before

966
00:31:52,320 --> 00:31:54,960
so back to that security w i was very

967
00:31:54,960 --> 00:31:56,480
interested in that one so i basically

968
00:31:56,480 --> 00:31:58,640
started looking at the guide

969
00:31:58,640 --> 00:32:01,360
to see what it's actually doing or what

970
00:32:01,360 --> 00:32:04,000
what what does it say and then i quickly

971
00:32:04,000 --> 00:32:05,600
learned it's just the security auditing

972
00:32:05,600 --> 00:32:08,399
tool so apparently it actually uses it

973
00:32:08,399 --> 00:32:09,519
right so

974
00:32:09,519 --> 00:32:11,120
i started i started digging through the

975
00:32:11,120 --> 00:32:13,840
config and then you can basically see

976
00:32:13,840 --> 00:32:15,760
every event type that it looks at so

977
00:32:15,760 --> 00:32:17,600
this is a simple one where it just looks

978
00:32:17,600 --> 00:32:19,519
on i think this is a logo on events

979
00:32:19,519 --> 00:32:21,360
right yes so it's a four six two four

980
00:32:21,360 --> 00:32:23,120
which for most people that ever worked

981
00:32:23,120 --> 00:32:25,039
in a sock is quite familiar it's just

982
00:32:25,039 --> 00:32:27,039
device logo on events so somebody logs

983
00:32:27,039 --> 00:32:29,120
on the box on windows

984
00:32:29,120 --> 00:32:31,200
this is generated

985
00:32:31,200 --> 00:32:33,600
and then you can even see

986
00:32:33,600 --> 00:32:36,640
like on top there's a global cap i think

987
00:32:36,640 --> 00:32:38,559
yeah so there's there's a thousand per

988
00:32:38,559 --> 00:32:41,440
24 hours of logon events that are locked

989
00:32:41,440 --> 00:32:43,360
which in most machines

990
00:32:43,360 --> 00:32:45,679
especially endpoints is quite fine

991
00:32:45,679 --> 00:32:47,360
and then you can also see which which

992
00:32:47,360 --> 00:32:49,840
for which fields that holds so that it's

993
00:32:49,840 --> 00:32:51,760
a subset of fields in this case it's the

994
00:32:51,760 --> 00:32:54,080
the the target username

995
00:32:54,080 --> 00:32:56,000
and then the logon type the ip address

996
00:32:56,000 --> 00:32:58,159
so it's already restricted so if you

997
00:32:58,159 --> 00:33:00,640
have a thousand logon events from that

998
00:33:00,640 --> 00:33:03,519
specific set of fields

999
00:33:03,519 --> 00:33:05,600
the the thousands m1 doesn't get

1000
00:33:05,600 --> 00:33:06,720
recorded

1001
00:33:06,720 --> 00:33:08,799
but if it comes from a different ip for

1002
00:33:08,799 --> 00:33:10,720
instance you'll you'll get it again so

1003
00:33:10,720 --> 00:33:12,399
again they try to rate limit it a little

1004
00:33:12,399 --> 00:33:13,360
bit

1005
00:33:13,360 --> 00:33:14,559
so as you do

1006
00:33:14,559 --> 00:33:15,840
and then and then you can see basically

1007
00:33:15,840 --> 00:33:17,519
configuration for all the fields and

1008
00:33:17,519 --> 00:33:19,840
everything and how it's being filtered

1009
00:33:19,840 --> 00:33:21,679
quite quite useful

1010
00:33:21,679 --> 00:33:24,240
i started looking at okay if it uses the

1011
00:33:24,240 --> 00:33:25,840
security events

1012
00:33:25,840 --> 00:33:27,679
which if event ids doesn't actually look

1013
00:33:27,679 --> 00:33:30,080
for so this is that list not very

1014
00:33:30,080 --> 00:33:31,200
lengthy

1015
00:33:31,200 --> 00:33:33,279
but then i was interested in hey

1016
00:33:33,279 --> 00:33:35,679
what kind of audit categories are tied

1017
00:33:35,679 --> 00:33:38,320
to those because not everything is

1018
00:33:38,320 --> 00:33:40,320
locked by default on windows

1019
00:33:40,320 --> 00:33:42,720
and basically there's four settings that

1020
00:33:42,720 --> 00:33:44,480
you can do so you can set no auditing

1021
00:33:44,480 --> 00:33:45,760
that's basically another setting but

1022
00:33:45,760 --> 00:33:47,519
then it's a zero

1023
00:33:47,519 --> 00:33:49,120
and if you only want to log the

1024
00:33:49,120 --> 00:33:50,320
successes

1025
00:33:50,320 --> 00:33:53,440
you get a one and so forth so then i

1026
00:33:53,440 --> 00:33:55,039
started looking okay

1027
00:33:55,039 --> 00:33:57,519
what settings do i need to have

1028
00:33:57,519 --> 00:34:00,880
on my box to get those events generated

1029
00:34:00,880 --> 00:34:03,120
so i started configuring or i started

1030
00:34:03,120 --> 00:34:04,960
doing nothing actually i just installed

1031
00:34:04,960 --> 00:34:06,480
a new windows box

1032
00:34:06,480 --> 00:34:09,040
and looked at what's there by default

1033
00:34:09,040 --> 00:34:11,760
and what do i need basically and then

1034
00:34:11,760 --> 00:34:13,520
all the ones you still can read are the

1035
00:34:13,520 --> 00:34:15,119
ones that are not set properly by

1036
00:34:15,119 --> 00:34:17,119
default on a default out of the box

1037
00:34:17,119 --> 00:34:18,960
windows installation

1038
00:34:18,960 --> 00:34:20,159
and there's all kinds of reasons because

1039
00:34:20,159 --> 00:34:22,399
some of them are hyper noisy especially

1040
00:34:22,399 --> 00:34:24,239
like the the firewall stuff

1041
00:34:24,239 --> 00:34:26,239
just gives you a lot of logs

1042
00:34:26,239 --> 00:34:27,119
so

1043
00:34:27,119 --> 00:34:28,800
defender

1044
00:34:28,800 --> 00:34:30,079
so so we have some blind spots there

1045
00:34:30,079 --> 00:34:31,440
right so and then

1046
00:34:31,440 --> 00:34:33,440
the defender team already tries to help

1047
00:34:33,440 --> 00:34:35,119
you a little bit because they also

1048
00:34:35,119 --> 00:34:37,520
recognize that problem and they enable

1049
00:34:37,520 --> 00:34:39,040
some of those

1050
00:34:39,040 --> 00:34:40,960
audit settings

1051
00:34:40,960 --> 00:34:42,320
to at least give you some more

1052
00:34:42,320 --> 00:34:44,800
visibility but they still keep quite a

1053
00:34:44,800 --> 00:34:47,280
bunch off because of for your metric and

1054
00:34:47,280 --> 00:34:49,599
these kind of things reasons because

1055
00:34:49,599 --> 00:34:52,159
yeah it also runs on a server generally

1056
00:34:52,159 --> 00:34:54,000
most people ingest all the logs from a

1057
00:34:54,000 --> 00:34:56,480
server and then it might triple or

1058
00:34:56,480 --> 00:34:58,400
quadruple just because they installed

1059
00:34:58,400 --> 00:35:00,880
defender and nobody likes having that so

1060
00:35:00,880 --> 00:35:02,880
they want to give you that same

1061
00:35:02,880 --> 00:35:06,079
option the only sad part is that they

1062
00:35:06,079 --> 00:35:08,800
didn't document this part so

1063
00:35:08,800 --> 00:35:10,800
i'm probably not the first to find it

1064
00:35:10,800 --> 00:35:11,839
but

1065
00:35:11,839 --> 00:35:13,440
yeah at least

1066
00:35:13,440 --> 00:35:16,640
now you can benefit from it as well so

1067
00:35:16,640 --> 00:35:18,079
yeah there's some things that you need

1068
00:35:18,079 --> 00:35:20,480
to do make sure to check your gpos

1069
00:35:20,480 --> 00:35:22,880
because even though microsoft in their

1070
00:35:22,880 --> 00:35:25,359
wisdom changes it locally you might have

1071
00:35:25,359 --> 00:35:27,119
a group policy that overrides it and

1072
00:35:27,119 --> 00:35:29,040
then it's still gone

1073
00:35:29,040 --> 00:35:30,800
but also you want to make sure that you

1074
00:35:30,800 --> 00:35:33,599
actually look at that list and see hey

1075
00:35:33,599 --> 00:35:35,200
there's a couple that i actually am

1076
00:35:35,200 --> 00:35:37,119
interested in because you're losing edr

1077
00:35:37,119 --> 00:35:40,000
features if you don't ingest the boxes

1078
00:35:40,000 --> 00:35:42,560
alerts or the the logs from those boxes

1079
00:35:42,560 --> 00:35:44,720
directly then there's no harm in

1080
00:35:44,720 --> 00:35:46,160
enabling those

1081
00:35:46,160 --> 00:35:48,000
so yeah basically you should go through

1082
00:35:48,000 --> 00:35:49,680
that because otherwise you miss you miss

1083
00:35:49,680 --> 00:35:50,480
five

1084
00:35:50,480 --> 00:35:52,480
valuable detections so basically what i

1085
00:35:52,480 --> 00:35:54,320
did is i created the ugly powershell

1086
00:35:54,320 --> 00:35:55,440
script

1087
00:35:55,440 --> 00:35:57,520
that goes through

1088
00:35:57,520 --> 00:35:59,280
all of your group policies and checks

1089
00:35:59,280 --> 00:36:00,720
whether the settings are actually there

1090
00:36:00,720 --> 00:36:02,480
or not code is horrible because i'm not

1091
00:36:02,480 --> 00:36:04,880
a programmer but it works so that that's

1092
00:36:04,880 --> 00:36:06,480
good enough for me

1093
00:36:06,480 --> 00:36:08,720
you can you can find it over there

1094
00:36:08,720 --> 00:36:11,280
you do need to have the the rsap tools

1095
00:36:11,280 --> 00:36:14,640
installed so preferably on an admin box

1096
00:36:14,640 --> 00:36:16,480
i promise you there's no no beacons in

1097
00:36:16,480 --> 00:36:18,960
there but but

1098
00:36:18,960 --> 00:36:21,280
really yeah

1099
00:36:21,280 --> 00:36:22,560
so

1100
00:36:22,560 --> 00:36:24,640
there's some gaps so you can you can

1101
00:36:24,640 --> 00:36:26,400
hopefully fill a bit with

1102
00:36:26,400 --> 00:36:27,760
enabling the audit settings but you

1103
00:36:27,760 --> 00:36:30,079
could also augment it if you're a

1104
00:36:30,079 --> 00:36:32,960
capable team which is sizable

1105
00:36:32,960 --> 00:36:34,320
then you can start looking at maybe

1106
00:36:34,320 --> 00:36:36,880
another tool to enrich the data

1107
00:36:36,880 --> 00:36:38,960
i'd still recommend most people to first

1108
00:36:38,960 --> 00:36:41,200
look at all the capabilities of your

1109
00:36:41,200 --> 00:36:42,960
first tool before you install a second

1110
00:36:42,960 --> 00:36:45,200
one unless you have a very immediate use

1111
00:36:45,200 --> 00:36:46,480
case for it

1112
00:36:46,480 --> 00:36:48,560
but basically i compared it to sysmon

1113
00:36:48,560 --> 00:36:49,760
because i did a lot of research in the

1114
00:36:49,760 --> 00:36:52,400
past on that and still use it actively

1115
00:36:52,400 --> 00:36:53,920
so there's a couple of benefits and a

1116
00:36:53,920 --> 00:36:55,119
couple of

1117
00:36:55,119 --> 00:36:58,320
less good things or differences at least

1118
00:36:58,320 --> 00:37:01,280
so sysmon first of all is is very simple

1119
00:37:01,280 --> 00:37:03,280
and you have to configure it

1120
00:37:03,280 --> 00:37:05,359
so that enables you to have full control

1121
00:37:05,359 --> 00:37:07,520
over it downside is of course you have

1122
00:37:07,520 --> 00:37:10,160
to maintain it so it's up to you

1123
00:37:10,160 --> 00:37:11,040
um

1124
00:37:11,040 --> 00:37:12,880
but again yeah that's uh if you have the

1125
00:37:12,880 --> 00:37:14,800
the team in the space and the

1126
00:37:14,800 --> 00:37:18,400
time for it definitely go for that

1127
00:37:18,400 --> 00:37:21,200
one of the other downsides is it it's a

1128
00:37:21,200 --> 00:37:23,359
it only larks right so it will tell you

1129
00:37:23,359 --> 00:37:24,880
something happens it won't do anything

1130
00:37:24,880 --> 00:37:26,160
about it

1131
00:37:26,160 --> 00:37:28,960
you need to build that yourself as well

1132
00:37:28,960 --> 00:37:30,640
and as i mentioned it's best applied

1133
00:37:30,640 --> 00:37:33,200
probably to augment the vendor or

1134
00:37:33,200 --> 00:37:36,079
maybe have a full parallel setup which

1135
00:37:36,079 --> 00:37:38,640
is even more work to maintain so again

1136
00:37:38,640 --> 00:37:40,800
you need to take care of that and then

1137
00:37:40,800 --> 00:37:43,520
on the flip side mde is fully maintained

1138
00:37:43,520 --> 00:37:45,520
which has also the downside that you

1139
00:37:45,520 --> 00:37:47,760
can't influence it really you can ask

1140
00:37:47,760 --> 00:37:49,920
microsoft to add it and if they agree

1141
00:37:49,920 --> 00:37:50,880
they

1142
00:37:50,880 --> 00:37:52,480
might do it or sometimes probably will

1143
00:37:52,480 --> 00:37:54,800
do it depending on how useful it is the

1144
00:37:54,800 --> 00:37:56,800
the telemetry set is actually a lot

1145
00:37:56,800 --> 00:37:58,880
richer and it has a response capability

1146
00:37:58,880 --> 00:38:00,320
so you can also tell it to kill

1147
00:38:00,320 --> 00:38:01,200
something

1148
00:38:01,200 --> 00:38:02,839
or at least isolate a

1149
00:38:02,839 --> 00:38:05,280
box downside probably the biggest one

1150
00:38:05,280 --> 00:38:07,680
for me is that the telemetry is sampled

1151
00:38:07,680 --> 00:38:09,440
so a lot of it you can't do you can't do

1152
00:38:09,440 --> 00:38:10,960
beaconing detection for instance if you

1153
00:38:10,960 --> 00:38:13,440
would want to do it on your endpoints

1154
00:38:13,440 --> 00:38:15,119
for now they're working on something

1155
00:38:15,119 --> 00:38:16,320
else but

1156
00:38:16,320 --> 00:38:18,720
for now it's not there and basically

1157
00:38:18,720 --> 00:38:20,320
what i did is i also put them head to

1158
00:38:20,320 --> 00:38:22,079
head so so most of the telemetry is the

1159
00:38:22,079 --> 00:38:23,680
same as you already saw they both do the

1160
00:38:23,680 --> 00:38:26,720
kernel callbacks and and some of it is

1161
00:38:26,720 --> 00:38:28,079
different because they do have

1162
00:38:28,079 --> 00:38:30,160
resampling or

1163
00:38:30,160 --> 00:38:32,079
capping the only one that's super

1164
00:38:32,079 --> 00:38:34,000
annoying is the image loads or the

1165
00:38:34,000 --> 00:38:35,440
driver loads

1166
00:38:35,440 --> 00:38:36,720
because that's

1167
00:38:36,720 --> 00:38:38,320
the sort of yolo

1168
00:38:38,320 --> 00:38:40,720
there's no real explanation also not in

1169
00:38:40,720 --> 00:38:42,880
the configuration how it logs you can

1170
00:38:42,880 --> 00:38:45,280
have 10 the same boxes they will have

1171
00:38:45,280 --> 00:38:48,079
different uh image load telemetry that's

1172
00:38:48,079 --> 00:38:49,520
the only one that that really stood out

1173
00:38:49,520 --> 00:38:51,280
to me i can't explain

1174
00:38:51,280 --> 00:38:53,680
and then sysmon has some unique features

1175
00:38:53,680 --> 00:38:55,680
like the clipboard contents that you

1176
00:38:55,680 --> 00:38:57,359
might be able to use during an incident

1177
00:38:57,359 --> 00:38:59,599
response engagement and it can retain

1178
00:38:59,599 --> 00:39:02,000
deleted files which is pretty useful

1179
00:39:02,000 --> 00:39:03,599
again if you know that your box is

1180
00:39:03,599 --> 00:39:04,880
compromised

1181
00:39:04,880 --> 00:39:06,640
it can also flood your box so be careful

1182
00:39:06,640 --> 00:39:07,680
with it

1183
00:39:07,680 --> 00:39:09,599
because this space is still something

1184
00:39:09,599 --> 00:39:11,440
that can run out

1185
00:39:11,440 --> 00:39:13,359
and then on the defender side there's

1186
00:39:13,359 --> 00:39:15,760
there's some additional logs that the

1187
00:39:15,760 --> 00:39:17,599
rest of the slide basically so there's

1188
00:39:17,599 --> 00:39:19,440
there's a lot of different telemetry

1189
00:39:19,440 --> 00:39:20,800
there as well

1190
00:39:20,800 --> 00:39:22,240
and basically if you if you start

1191
00:39:22,240 --> 00:39:24,880
mapping the visual the visual again then

1192
00:39:24,880 --> 00:39:27,599
yeah there is some overlap there is some

1193
00:39:27,599 --> 00:39:29,599
differences

1194
00:39:29,599 --> 00:39:31,520
so there are some gaps to be filled on

1195
00:39:31,520 --> 00:39:33,680
both ends uh depending on which one you

1196
00:39:33,680 --> 00:39:35,280
rely

1197
00:39:35,280 --> 00:39:37,920
so oh we're actually good on time

1198
00:39:37,920 --> 00:39:40,560
so basically as a sort of wrap up or a

1199
00:39:40,560 --> 00:39:42,880
conclusion is is try to figure out what

1200
00:39:42,880 --> 00:39:44,640
your tool is actually doing

1201
00:39:44,640 --> 00:39:47,040
how how reliable is it and how complete

1202
00:39:47,040 --> 00:39:48,000
is it

1203
00:39:48,000 --> 00:39:50,560
because those gaps are usually the ones

1204
00:39:50,560 --> 00:39:52,160
that hurt you in the end if you don't

1205
00:39:52,160 --> 00:39:53,760
know about them if you know about them

1206
00:39:53,760 --> 00:39:56,480
you can even yeah maybe or you accept it

1207
00:39:56,480 --> 00:39:59,520
or you do something else with it

1208
00:39:59,520 --> 00:40:01,280
and also understand try to understand

1209
00:40:01,280 --> 00:40:03,040
how they are actually detecting stuff so

1210
00:40:03,040 --> 00:40:04,720
it's like we saw in the asr rules

1211
00:40:04,720 --> 00:40:05,920
examples

1212
00:40:05,920 --> 00:40:07,839
sometimes it's very stupid

1213
00:40:07,839 --> 00:40:10,880
um it it's not bad that it's stupid

1214
00:40:10,880 --> 00:40:12,560
but maybe you need to do something on

1215
00:40:12,560 --> 00:40:14,640
top of it or next to it something like

1216
00:40:14,640 --> 00:40:16,319
it but as long as you know what is

1217
00:40:16,319 --> 00:40:17,680
actually going on that will help you

1218
00:40:17,680 --> 00:40:19,119
already because then you can take

1219
00:40:19,119 --> 00:40:21,119
alternate measures and one of the things

1220
00:40:21,119 --> 00:40:22,960
that we try to do is continuously

1221
00:40:22,960 --> 00:40:24,720
reassess this because

1222
00:40:24,720 --> 00:40:26,560
they make a lot of changes

1223
00:40:26,560 --> 00:40:29,040
and usually there are improvements

1224
00:40:29,040 --> 00:40:30,000
so

1225
00:40:30,000 --> 00:40:31,680
knowing that there's new capabilities

1226
00:40:31,680 --> 00:40:34,240
knowing that there's new visual visual

1227
00:40:34,240 --> 00:40:37,200
stuff or new logs new fields in logs is

1228
00:40:37,200 --> 00:40:38,880
actually very nice because then you can

1229
00:40:38,880 --> 00:40:40,480
improve your detections

1230
00:40:40,480 --> 00:40:42,160
and maybe cover stuff that you didn't do

1231
00:40:42,160 --> 00:40:44,560
before

1232
00:40:45,200 --> 00:40:48,480
and definitely go to henry's talk in

1233
00:40:48,480 --> 00:40:50,720
interact 2 at 3 because he's basically

1234
00:40:50,720 --> 00:40:52,160
showing you the red team perspective

1235
00:40:52,160 --> 00:40:54,079
from this site

1236
00:40:54,079 --> 00:40:57,599
so that will be that w fun

1237
00:40:57,599 --> 00:40:59,359
and as yet about it

1238
00:40:59,359 --> 00:41:01,599
i'm out of time so if there's questions

1239
00:41:01,599 --> 00:41:04,000
i'm happy to help you

1240
00:41:04,000 --> 00:41:05,440
if not

1241
00:41:05,440 --> 00:41:07,850
thank you for attending

1242
00:41:07,850 --> 00:41:13,639
[Applause]

1243
00:41:14,960 --> 00:41:16,480
thanks olaf we do have time for

1244
00:41:16,480 --> 00:41:18,720
questions any in the room that you

1245
00:41:18,720 --> 00:41:21,359
haven't already asked

1246
00:41:21,359 --> 00:41:22,480
well

1247
00:41:22,480 --> 00:41:23,599
both

1248
00:41:23,599 --> 00:41:26,000
yeah you know i'll stick with i'll stick

1249
00:41:26,000 --> 00:41:27,760
still with defender because it's it's

1250
00:41:27,760 --> 00:41:30,160
very easy to deploy sure you have to pay

1251
00:41:30,160 --> 00:41:31,760
for it but it's so rich and you have

1252
00:41:31,760 --> 00:41:32,560
that

1253
00:41:32,560 --> 00:41:34,960
blocking capability you don't have

1254
00:41:34,960 --> 00:41:36,319
on

1255
00:41:36,319 --> 00:41:38,000
on on assessment tool for instance which

1256
00:41:38,000 --> 00:41:40,319
is a lot more work you have to set up

1257
00:41:40,319 --> 00:41:44,240
ejection of the logs for every endpoint

1258
00:41:44,240 --> 00:41:46,400
there's a cost to it as well so it's way

1259
00:41:46,400 --> 00:41:47,760
more complicated you have to build all

1260
00:41:47,760 --> 00:41:49,440
of your detection rules instead of where

1261
00:41:49,440 --> 00:41:50,560
you get

1262
00:41:50,560 --> 00:41:52,640
quite some good stuff out of the box

1263
00:41:52,640 --> 00:41:54,800
um we actually have a service without

1264
00:41:54,800 --> 00:41:57,119
being very commercial but we we sell

1265
00:41:57,119 --> 00:41:58,880
detection content basically as part of

1266
00:41:58,880 --> 00:42:00,960
our research work

1267
00:42:00,960 --> 00:42:02,480
and we still have hundreds of detections

1268
00:42:02,480 --> 00:42:03,920
that you can use on top of it but it

1269
00:42:03,920 --> 00:42:06,079
depends a little bit on the maturity of

1270
00:42:06,079 --> 00:42:08,240
the company right we even had a question

1271
00:42:08,240 --> 00:42:10,319
from a client that is like it is a great

1272
00:42:10,319 --> 00:42:11,520
detection

1273
00:42:11,520 --> 00:42:13,599
but what do i tell my sock to do with it

1274
00:42:13,599 --> 00:42:16,480
because sometimes it's very hkc

1275
00:42:16,480 --> 00:42:18,079
to investigate

1276
00:42:18,079 --> 00:42:21,200
so this is also why all those edrs are

1277
00:42:21,200 --> 00:42:23,119
yeah always butchered by red team is

1278
00:42:23,119 --> 00:42:25,440
that it's easy to bypass or or

1279
00:42:25,440 --> 00:42:28,640
whatever definitely some are but it's

1280
00:42:28,640 --> 00:42:31,599
also they have to cater to a very big

1281
00:42:31,599 --> 00:42:33,680
audience so there's all people picky

1282
00:42:33,680 --> 00:42:35,680
enough that you need to augment this

1283
00:42:35,680 --> 00:42:37,440
which is fine right that keeps our job

1284
00:42:37,440 --> 00:42:40,079
fun so yeah

1285
00:42:40,079 --> 00:42:41,839
for people on the stream i'll try to

1286
00:42:41,839 --> 00:42:44,160
recap it quickly but the question was if

1287
00:42:44,160 --> 00:42:46,960
you enable the firewall events

1288
00:42:46,960 --> 00:42:49,280
locally does it collect it for all three

1289
00:42:49,280 --> 00:42:52,400
settings so that's public domain and

1290
00:42:52,400 --> 00:42:54,319
the other one

1291
00:42:54,319 --> 00:42:55,119
and

1292
00:42:55,119 --> 00:42:57,520
if you do that doesn't it flood the logs

1293
00:42:57,520 --> 00:42:58,800
quickly

1294
00:42:58,800 --> 00:43:00,960
so

1295
00:43:00,960 --> 00:43:02,640
the event lock system itself has a

1296
00:43:02,640 --> 00:43:04,880
rotating feature so that that if it's

1297
00:43:04,880 --> 00:43:07,200
set up normally

1298
00:43:07,200 --> 00:43:09,040
then it won't it won't fill up because

1299
00:43:09,040 --> 00:43:11,760
it's just rotating and it's recycling

1300
00:43:11,760 --> 00:43:14,000
and the defender component looks at all

1301
00:43:14,000 --> 00:43:16,160
three it just looks at what what's

1302
00:43:16,160 --> 00:43:18,400
coming into the event log and it will

1303
00:43:18,400 --> 00:43:22,079
again uh sample the out of it so if

1304
00:43:22,079 --> 00:43:24,160
you will get the important stuff if it's

1305
00:43:24,160 --> 00:43:26,079
new you'll see it if it's repetitively

1306
00:43:26,079 --> 00:43:27,119
doing it

1307
00:43:27,119 --> 00:43:28,640
it will ignore

1308
00:43:28,640 --> 00:43:30,960
it after a certain threshold so it no it

1309
00:43:30,960 --> 00:43:32,560
won't fill up you will have the

1310
00:43:32,560 --> 00:43:34,800
visibility but then in defender that

1311
00:43:34,800 --> 00:43:36,240
that's sort of taken care of by the

1312
00:43:36,240 --> 00:43:38,000
agent if you do it

1313
00:43:38,000 --> 00:43:40,560
with your own agent next to it splunk

1314
00:43:40,560 --> 00:43:43,599
whatever whatever whatever you have um

1315
00:43:43,599 --> 00:43:45,200
then then you have a problem so that's

1316
00:43:45,200 --> 00:43:46,240
why it's not

1317
00:43:46,240 --> 00:43:48,240
this is enabled by default because then

1318
00:43:48,240 --> 00:43:50,240
it might give you terabytes of data

1319
00:43:50,240 --> 00:43:51,680
extra every day

1320
00:43:51,680 --> 00:43:53,520
um that you also need to do something

1321
00:43:53,520 --> 00:43:54,560
with so

1322
00:43:54,560 --> 00:43:56,240
so the question is can you can you

1323
00:43:56,240 --> 00:43:58,800
enrich or make it more for both and can

1324
00:43:58,800 --> 00:44:01,200
you customize the logging that mde shows

1325
00:44:01,200 --> 00:44:04,560
you uh answers sadly no

1326
00:44:04,560 --> 00:44:06,800
i've had several talks with microsoft

1327
00:44:06,800 --> 00:44:09,760
about this they they might consider

1328
00:44:09,760 --> 00:44:13,280
doing it in very minute changes so

1329
00:44:13,280 --> 00:44:15,599
but the problem for them is that they

1330
00:44:15,599 --> 00:44:18,319
need to stay in control of the flow of

1331
00:44:18,319 --> 00:44:20,160
data coming to them

1332
00:44:20,160 --> 00:44:22,480
because if you make an error

1333
00:44:22,480 --> 00:44:23,920
which could happen

1334
00:44:23,920 --> 00:44:26,720
uh you might yeah flood it is a shared

1335
00:44:26,720 --> 00:44:28,160
service right so you have a you have

1336
00:44:28,160 --> 00:44:30,240
your own bucket of data but there's a

1337
00:44:30,240 --> 00:44:33,040
search head cluster or search cluster

1338
00:44:33,040 --> 00:44:35,680
that that is basically shared resource

1339
00:44:35,680 --> 00:44:38,480
so if you if you over feed it then then

1340
00:44:38,480 --> 00:44:40,400
other people get impacted by it plus

1341
00:44:40,400 --> 00:44:42,000
microsoft has to pay

1342
00:44:42,000 --> 00:44:44,160
your storage bill

1343
00:44:44,160 --> 00:44:46,240
which is nice but they don't want to do

1344
00:44:46,240 --> 00:44:47,440
that so

1345
00:44:47,440 --> 00:44:49,280
i don't think that will change

1346
00:44:49,280 --> 00:44:51,280
on the on the large scale

1347
00:44:51,280 --> 00:44:52,319
there are

1348
00:44:52,319 --> 00:44:55,760
vendors so so as i mentioned they do uh

1349
00:44:55,760 --> 00:44:58,960
ingest more data than they expose to you

1350
00:44:58,960 --> 00:45:00,240
and this is something that i've been

1351
00:45:00,240 --> 00:45:02,480
talking to them as well which i i'm

1352
00:45:02,480 --> 00:45:05,359
probably not the common user right i

1353
00:45:05,359 --> 00:45:07,040
acknowledge that that's fine

1354
00:45:07,040 --> 00:45:10,079
but who cares if if the common user

1355
00:45:10,079 --> 00:45:11,920
doesn't even look at the telemetry in

1356
00:45:11,920 --> 00:45:13,440
the first place then they can just show

1357
00:45:13,440 --> 00:45:15,200
me everything that they have right so

1358
00:45:15,200 --> 00:45:17,359
that's something that they might

1359
00:45:17,359 --> 00:45:19,040
change in the future

1360
00:45:19,040 --> 00:45:20,880
i do know that there are some mdr

1361
00:45:20,880 --> 00:45:22,319
vendors

1362
00:45:22,319 --> 00:45:24,160
who have a direct feed and they

1363
00:45:24,160 --> 00:45:26,319
sometimes get a little bit more so if

1364
00:45:26,319 --> 00:45:27,680
you also have

1365
00:45:27,680 --> 00:45:31,040
if you're demanding clients

1366
00:45:31,040 --> 00:45:33,280
you might be able to

1367
00:45:33,280 --> 00:45:35,119
coerce microsoft in being a little bit

1368
00:45:35,119 --> 00:45:37,520
more for both as well they do it but

1369
00:45:37,520 --> 00:45:40,319
it's super rare

1370
00:45:41,599 --> 00:45:43,200
and mind you this is a huge surface

1371
00:45:43,200 --> 00:45:45,040
right so they have they have billions of

1372
00:45:45,040 --> 00:45:47,359
endpoints going with their telemetry to

1373
00:45:47,359 --> 00:45:48,400
it so it's

1374
00:45:48,400 --> 00:45:50,160
at scale it's still performance which is

1375
00:45:50,160 --> 00:45:51,760
impressive to me

1376
00:45:51,760 --> 00:45:53,359
yeah so the question is if you want to

1377
00:45:53,359 --> 00:45:55,280
use this one next to it should i use the

1378
00:45:55,280 --> 00:45:57,599
log and ledger agent um

1379
00:45:57,599 --> 00:45:59,359
if you want to use sentinel yeah you

1380
00:45:59,359 --> 00:46:01,200
need to because you need to ingest the

1381
00:46:01,200 --> 00:46:02,800
telemetry somehow

1382
00:46:02,800 --> 00:46:05,359
uh logarithmic agent would be nice

1383
00:46:05,359 --> 00:46:07,599
another method might be witness event

1384
00:46:07,599 --> 00:46:08,960
collectors

1385
00:46:08,960 --> 00:46:10,480
the only downside of that is that you

1386
00:46:10,480 --> 00:46:12,560
also might need a vpn or whatever if

1387
00:46:12,560 --> 00:46:14,800
your people aren't on site

1388
00:46:14,800 --> 00:46:17,119
so probably yeah an age an additional

1389
00:46:17,119 --> 00:46:18,640
agent is something you would need yeah

1390
00:46:18,640 --> 00:46:21,279
regardless of

1391
00:46:21,359 --> 00:46:22,800
yeah yeah but that's a conflict on the

1392
00:46:22,800 --> 00:46:24,640
system side so if you if you want to

1393
00:46:24,640 --> 00:46:26,000
fill in the gaps

1394
00:46:26,000 --> 00:46:27,440
then you first need to understand the

1395
00:46:27,440 --> 00:46:29,359
gaps and then you can augment them uh

1396
00:46:29,359 --> 00:46:31,440
with your sysmon config and tell it to

1397
00:46:31,440 --> 00:46:33,040
only log certain stuff that you're

1398
00:46:33,040 --> 00:46:34,720
actually caring about

1399
00:46:34,720 --> 00:46:37,200
um and ship that off to uh that gets

1400
00:46:37,200 --> 00:46:38,560
shifted to the event log and then you

1401
00:46:38,560 --> 00:46:42,359
need to ingest that somehow

1402
00:46:42,480 --> 00:46:44,560
yeah and and microsoft dao is a new

1403
00:46:44,560 --> 00:46:46,400
agent for for the azure monitor agents

1404
00:46:46,400 --> 00:46:48,800
you can even do um xpath filters so you

1405
00:46:48,800 --> 00:46:50,160
could still have a full sysmon

1406
00:46:50,160 --> 00:46:52,480
configuration use the monitor agent to

1407
00:46:52,480 --> 00:46:54,480
only look at the stuff that you want to

1408
00:46:54,480 --> 00:46:55,920
get that to the cloud and have the full

1409
00:46:55,920 --> 00:46:59,680
system telemetry local for ir or

1410
00:46:59,680 --> 00:47:01,440
exactly yeah yeah ideally you don't want

1411
00:47:01,440 --> 00:47:02,800
to do that because that's just costing

1412
00:47:02,800 --> 00:47:04,319
you additional money

1413
00:47:04,319 --> 00:47:06,000
where you won't be building detection

1414
00:47:06,000 --> 00:47:10,359
rules on top of in first place

1415
00:47:17,760 --> 00:47:20,640
the question from discord is from dre

1416
00:47:20,640 --> 00:47:22,880
question and discord from dre who is

1417
00:47:22,880 --> 00:47:25,200
obviously the intern drain it's not dr

1418
00:47:25,200 --> 00:47:26,880
dry well you know

1419
00:47:26,880 --> 00:47:29,839
so he's wondering how olaf would detect

1420
00:47:29,839 --> 00:47:32,880
screen connect altera agent zoho remote

1421
00:47:32,880 --> 00:47:35,359
access splashtop

1422
00:47:35,359 --> 00:47:37,119
any desk

1423
00:47:37,119 --> 00:47:39,280
those kinds of things if that's being

1424
00:47:39,280 --> 00:47:40,559
logged

1425
00:47:40,559 --> 00:47:42,480
is that the question uh how you would

1426
00:47:42,480 --> 00:47:44,880
detect it oh how you would detect it

1427
00:47:44,880 --> 00:47:46,319
well yeah that's

1428
00:47:46,319 --> 00:47:48,079
that's difficult because inbound

1429
00:47:48,079 --> 00:47:50,400
connections are are sampled so you won't

1430
00:47:50,400 --> 00:47:52,960
always see it you do see when the

1431
00:47:52,960 --> 00:47:54,800
process is being created so if you see

1432
00:47:54,800 --> 00:47:56,240
any desk and you don't use it in your

1433
00:47:56,240 --> 00:47:57,440
organization

1434
00:47:57,440 --> 00:47:59,200
that's not sample so cross creation logs

1435
00:47:59,200 --> 00:48:00,559
are are there

1436
00:48:00,559 --> 00:48:02,319
so that's probably your first indicator

1437
00:48:02,319 --> 00:48:04,240
that's the price process creation but

1438
00:48:04,240 --> 00:48:07,440
not the actual it once it's created yeah

1439
00:48:07,440 --> 00:48:09,280
so if it's running and it receives a

1440
00:48:09,280 --> 00:48:11,040
connection that

1441
00:48:11,040 --> 00:48:13,359
might get locked because that's sampled

1442
00:48:13,359 --> 00:48:15,040
so you don't know for sure that it

1443
00:48:15,040 --> 00:48:16,000
happened

1444
00:48:16,000 --> 00:48:18,079
uh not always so

1445
00:48:18,079 --> 00:48:20,480
if you have that yeah then you need to

1446
00:48:20,480 --> 00:48:22,880
augment that probably with your proxy

1447
00:48:22,880 --> 00:48:25,200
log or something like that

1448
00:48:25,200 --> 00:48:26,640
and henry wants to say about something

1449
00:48:26,640 --> 00:48:29,279
about it as well

1450
00:48:30,480 --> 00:48:33,040
for those on the on the stream

1451
00:48:33,040 --> 00:48:34,720
inside the room there's a suggestion

1452
00:48:34,720 --> 00:48:38,640
that all of those use the screenshot api

1453
00:48:38,640 --> 00:48:40,720
some of them do sorry so you could look

1454
00:48:40,720 --> 00:48:44,319
at the screenshot api activity

1455
00:48:44,319 --> 00:48:45,599
right did i say that right okay thank

1456
00:48:45,599 --> 00:48:47,599
you

1457
00:48:47,599 --> 00:48:49,520
thanks for the question dre good for

1458
00:48:49,520 --> 00:48:53,040
good for the interns yep

1459
00:48:53,359 --> 00:48:54,640
all right

1460
00:48:54,640 --> 00:48:56,880
so thank you all for for coming if there

1461
00:48:56,880 --> 00:48:58,960
are no questions you will want to be

1462
00:48:58,960 --> 00:49:01,200
back here for tony sager

1463
00:49:01,200 --> 00:49:03,280
he's the next speaker

1464
00:49:03,280 --> 00:49:04,960
i mean you wanted to be here for all of

1465
00:49:04,960 --> 00:49:06,559
this one too

1466
00:49:06,559 --> 00:49:08,980
so thank you speaker

1467
00:49:08,980 --> 00:49:14,369
[Applause]

