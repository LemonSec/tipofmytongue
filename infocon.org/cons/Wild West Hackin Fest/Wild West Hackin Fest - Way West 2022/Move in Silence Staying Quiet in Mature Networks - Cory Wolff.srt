1
00:00:02,879 --> 00:00:06,240
all right welcome to 5 p.m in track two

2
00:00:06,240 --> 00:00:09,540
with Corey wolf move in silence staying

3
00:00:09,540 --> 00:00:12,540
quiet in mature networks uh Corey's a

4
00:00:12,540 --> 00:00:13,799
red team leader and a hacker with

5
00:00:13,799 --> 00:00:16,199
Decades of experience in I.T though you

6
00:00:16,199 --> 00:00:17,520
wouldn't know it by looking at the Young

7
00:00:17,520 --> 00:00:20,220
fella and and development as well he's

8
00:00:20,220 --> 00:00:21,600
been building and breaking all the

9
00:00:21,600 --> 00:00:24,359
things since his first computer in 1988

10
00:00:24,359 --> 00:00:26,039
and is probably still reading the

11
00:00:26,039 --> 00:00:28,320
hackers Manifesto he holds the offensive

12
00:00:28,320 --> 00:00:30,539
security certified professional the oscp

13
00:00:30,539 --> 00:00:33,780
and a cissp certification and can be

14
00:00:33,780 --> 00:00:36,420
found tending to his farm when he's not

15
00:00:36,420 --> 00:00:38,880
wired in a good another good example of

16
00:00:38,880 --> 00:00:41,300
hobbies that don't involve a keyboard

17
00:00:41,300 --> 00:00:44,760
yeah it's good to have those it's good

18
00:00:44,760 --> 00:00:46,260
to have those thanks for the intro yeah

19
00:00:46,260 --> 00:00:49,800
so I like I like that you say that I

20
00:00:49,800 --> 00:00:51,660
look young makes me feel good because

21
00:00:51,660 --> 00:00:53,520
every day I feel like I'm getting older

22
00:00:53,520 --> 00:00:55,739
but the Decades of experience does come

23
00:00:55,739 --> 00:00:57,180
from

24
00:00:57,180 --> 00:00:59,160
um like we mentioned there I got my

25
00:00:59,160 --> 00:01:01,680
first computer when I was pretty young

26
00:01:01,680 --> 00:01:03,120
um I don't want to spend too much time

27
00:01:03,120 --> 00:01:04,140
on myself

28
00:01:04,140 --> 00:01:07,080
uh but just a quick overview uh BB gave

29
00:01:07,080 --> 00:01:10,020
me a great intro there uh first computer

30
00:01:10,020 --> 00:01:12,720
in 88 when I was four years old my old

31
00:01:12,720 --> 00:01:14,880
man had foresight to know the PC was

32
00:01:14,880 --> 00:01:16,920
going to be big I guess our first

33
00:01:16,920 --> 00:01:17,820
computer

34
00:01:17,820 --> 00:01:21,420
back when I was four uh been involved

35
00:01:21,420 --> 00:01:23,340
ever since worked I've been a developer

36
00:01:23,340 --> 00:01:26,340
worked in security built mobile apps all

37
00:01:26,340 --> 00:01:27,840
that good stuff

38
00:01:27,840 --> 00:01:29,100
um I am the practice manager of

39
00:01:29,100 --> 00:01:30,299
offensive security at a company called

40
00:01:30,299 --> 00:01:31,799
Larry security we're based in

41
00:01:31,799 --> 00:01:33,659
Philadelphia

42
00:01:33,659 --> 00:01:36,240
um and there's some links for you so if

43
00:01:36,240 --> 00:01:37,619
you have any questions about me or want

44
00:01:37,619 --> 00:01:40,200
to know more uh feel free to to do that

45
00:01:40,200 --> 00:01:43,200
to visit those links

46
00:01:43,200 --> 00:01:44,340
oh

47
00:01:44,340 --> 00:01:46,619
all right so I just want to set some

48
00:01:46,619 --> 00:01:49,979
expectations for today uh so you know

49
00:01:49,979 --> 00:01:52,500
the title you know moving in silence is

50
00:01:52,500 --> 00:01:56,280
actually I think it's Nas uh is uh

51
00:01:56,280 --> 00:01:58,079
really just about

52
00:01:58,079 --> 00:01:59,100
um what we're going to talk about today

53
00:01:59,100 --> 00:02:01,140
is not

54
00:02:01,140 --> 00:02:04,020
fancy EDR techniques we're not going to

55
00:02:04,020 --> 00:02:08,098
talk about bypassing EDR with c-sharp

56
00:02:08,098 --> 00:02:10,560
and re-hooking dlls or doing anything

57
00:02:10,560 --> 00:02:13,200
crazy like that it's really not that

58
00:02:13,200 --> 00:02:15,060
exciting unfortunately what we're going

59
00:02:15,060 --> 00:02:17,340
to talk about today

60
00:02:17,340 --> 00:02:18,720
um

61
00:02:18,720 --> 00:02:23,720
is really getting back to basics right

62
00:02:23,720 --> 00:02:25,920
we're going to talk about methodology

63
00:02:25,920 --> 00:02:28,800
that I use and my team uses on

64
00:02:28,800 --> 00:02:31,280
every engagement

65
00:02:31,280 --> 00:02:34,760
that can be used to fly under the radar

66
00:02:34,760 --> 00:02:37,739
and essentially stay quiet innovate

67
00:02:37,739 --> 00:02:39,780
detection we're really going to talk

68
00:02:39,780 --> 00:02:41,160
about doing basic things in a quiet

69
00:02:41,160 --> 00:02:43,379
manner some of these things you're going

70
00:02:43,379 --> 00:02:45,599
to say yeah of course I can do that why

71
00:02:45,599 --> 00:02:47,879
would I want to do that but the fact of

72
00:02:47,879 --> 00:02:50,160
the matter is that throughout all the

73
00:02:50,160 --> 00:02:51,360
next

74
00:02:51,360 --> 00:02:54,959
48 minutes or so uh the point is is to

75
00:02:54,959 --> 00:02:56,280
remain quiet so we don't want to use

76
00:02:56,280 --> 00:02:58,200
that map we don't want to use things

77
00:02:58,200 --> 00:03:00,599
like Rumble we don't want to just start

78
00:03:00,599 --> 00:03:02,519
banging away at the network right

79
00:03:02,519 --> 00:03:04,080
because what we're talking about here

80
00:03:04,080 --> 00:03:06,660
today is

81
00:03:06,660 --> 00:03:07,200
um

82
00:03:07,200 --> 00:03:10,620
operating immature environments so we're

83
00:03:10,620 --> 00:03:12,720
talking about environments that have

84
00:03:12,720 --> 00:03:14,940
already gone through

85
00:03:14,940 --> 00:03:17,099
thousands of pen tests we're talking

86
00:03:17,099 --> 00:03:19,080
about environments that have IR teams

87
00:03:19,080 --> 00:03:20,760
we're talking about environments that

88
00:03:20,760 --> 00:03:23,940
have socks have Sims and we simply just

89
00:03:23,940 --> 00:03:25,860
can't go in there and just start

90
00:03:25,860 --> 00:03:28,140
hammering away right

91
00:03:28,140 --> 00:03:31,440
so this isn't the the flashy stuff of

92
00:03:31,440 --> 00:03:35,099
you know unhooking EDR and and doing all

93
00:03:35,099 --> 00:03:37,140
this crazy stuff with c-sharp and you

94
00:03:37,140 --> 00:03:38,280
know talking about the common language

95
00:03:38,280 --> 00:03:40,500
runtime and all these other things that

96
00:03:40,500 --> 00:03:41,819
that happened today which have their

97
00:03:41,819 --> 00:03:46,440
place uh and I enjoy it thoroughly uh

98
00:03:46,440 --> 00:03:47,760
but what we're really talking about

99
00:03:47,760 --> 00:03:50,700
today uh is is working in a mature

100
00:03:50,700 --> 00:03:52,319
environment

101
00:03:52,319 --> 00:03:55,920
uh this is pretty much everything that I

102
00:03:55,920 --> 00:03:58,680
just said uh one thing I would notice

103
00:03:58,680 --> 00:04:01,200
I'm always interested in hearing other

104
00:04:01,200 --> 00:04:04,920
ways uh to you know

105
00:04:04,920 --> 00:04:08,220
um remain quiet and in alternative ways

106
00:04:08,220 --> 00:04:10,379
to do things

107
00:04:10,379 --> 00:04:12,060
um

108
00:04:12,060 --> 00:04:15,480
again everything we talk about today is

109
00:04:15,480 --> 00:04:18,060
getting back to basics using the tools

110
00:04:18,060 --> 00:04:22,320
at our disposal using uh logins to

111
00:04:22,320 --> 00:04:24,000
accomplish the same tasks that we would

112
00:04:24,000 --> 00:04:26,880
use nmap for or some kind of

113
00:04:26,880 --> 00:04:29,340
vulnerability scanner Rumble whatever it

114
00:04:29,340 --> 00:04:30,900
might be

115
00:04:30,900 --> 00:04:32,520
um that's what

116
00:04:32,520 --> 00:04:35,659
that's what we're going to talk about

117
00:04:37,740 --> 00:04:40,460
so

118
00:04:40,800 --> 00:04:42,900
and then a little bit you'll see I'm

119
00:04:42,900 --> 00:04:44,100
going to share kind of a methodology

120
00:04:44,100 --> 00:04:47,100
methodology that I use and my team uses

121
00:04:47,100 --> 00:04:49,380
uh but when we go into one of these

122
00:04:49,380 --> 00:04:51,900
these penetration tests there's

123
00:04:51,900 --> 00:04:53,639
essentially a couple of questions that

124
00:04:53,639 --> 00:04:55,919
we want to start off with right so we

125
00:04:55,919 --> 00:04:58,259
want to know where is ADC you know when

126
00:04:58,259 --> 00:04:59,580
we're talking about large environments

127
00:04:59,580 --> 00:05:00,720
of course there could be more than one

128
00:05:00,720 --> 00:05:03,180
right but we want to find at least one

129
00:05:03,180 --> 00:05:05,460
uh domain controller

130
00:05:05,460 --> 00:05:07,800
uh we want to look in footprint the

131
00:05:07,800 --> 00:05:09,240
network and say

132
00:05:09,240 --> 00:05:10,680
okay

133
00:05:10,680 --> 00:05:13,320
where's the server VLAN or where's the

134
00:05:13,320 --> 00:05:16,500
server subnet how can we find this right

135
00:05:16,500 --> 00:05:19,919
uh we also want to look and see are

136
00:05:19,919 --> 00:05:21,600
there other important subnets for

137
00:05:21,600 --> 00:05:23,759
example is there a management VLAN uh

138
00:05:23,759 --> 00:05:25,620
are there situ or switches sitting

139
00:05:25,620 --> 00:05:28,380
somewhere uh where's the firewall you

140
00:05:28,380 --> 00:05:29,699
know we want to know these things we

141
00:05:29,699 --> 00:05:32,520
want to figure these things out

142
00:05:32,520 --> 00:05:35,300
um and then one of the other big ones is

143
00:05:35,300 --> 00:05:40,560
where are most of the clients located so

144
00:05:40,560 --> 00:05:42,240
in mature environments in big Enterprise

145
00:05:42,240 --> 00:05:44,520
environments

146
00:05:44,520 --> 00:05:47,460
well in mature environments everything's

147
00:05:47,460 --> 00:05:50,220
segmented right uh so they have a

148
00:05:50,220 --> 00:05:52,199
certain VLAN just for clients they have

149
00:05:52,199 --> 00:05:54,960
a certain VLAN just for VPN

150
00:05:54,960 --> 00:05:57,600
um they have it all segmented

151
00:05:57,600 --> 00:05:59,580
um appropriately which is good Network

152
00:05:59,580 --> 00:06:01,919
architecture really

153
00:06:01,919 --> 00:06:04,860
um and it's good security architecture

154
00:06:04,860 --> 00:06:06,660
uh one of the other things that we like

155
00:06:06,660 --> 00:06:08,940
to look at and and kind of find out is

156
00:06:08,940 --> 00:06:11,039
is active directory certificate services

157
00:06:11,039 --> 00:06:12,720
in use

158
00:06:12,720 --> 00:06:15,259
so

159
00:06:16,259 --> 00:06:18,600
we like to look at that because there's

160
00:06:18,600 --> 00:06:19,919
been a lot of work done and I can't

161
00:06:19,919 --> 00:06:21,720
remember their names right now but in

162
00:06:21,720 --> 00:06:22,979
the past year or so there's been a lot

163
00:06:22,979 --> 00:06:24,660
of work done about active directory

164
00:06:24,660 --> 00:06:27,060
certificate Services uh how to exploit

165
00:06:27,060 --> 00:06:29,220
it there's one particular exploit where

166
00:06:29,220 --> 00:06:32,520
it puts together a petite podum to

167
00:06:32,520 --> 00:06:35,639
queries of DC then you use ntlm relay X

168
00:06:35,639 --> 00:06:37,280
to then

169
00:06:37,280 --> 00:06:41,699
relay to uh the domain controller grab a

170
00:06:41,699 --> 00:06:43,919
certificate but the point is is that

171
00:06:43,919 --> 00:06:45,240
that's one of the primary questions that

172
00:06:45,240 --> 00:06:46,620
we want to ask because there's a lot of

173
00:06:46,620 --> 00:06:48,060
stuff that you can do with with

174
00:06:48,060 --> 00:06:51,900
certificate Services a lot of ways to

175
00:06:51,900 --> 00:06:54,539
potentially exploit it so those are one

176
00:06:54,539 --> 00:06:57,000
of the big uh those are really the big

177
00:06:57,000 --> 00:06:59,960
questions that we're asking

178
00:07:01,139 --> 00:07:04,259
so here's a common workflow

179
00:07:04,259 --> 00:07:08,280
uh so whenever we start an engagement

180
00:07:08,280 --> 00:07:10,259
uh we look and we say well

181
00:07:10,259 --> 00:07:13,979
where am I right what's around me what

182
00:07:13,979 --> 00:07:15,900
can I see

183
00:07:15,900 --> 00:07:19,979
um am I again am I on a client VLAN am I

184
00:07:19,979 --> 00:07:23,580
on a server subnet where am I

185
00:07:23,580 --> 00:07:25,680
next question we want to ask is where is

186
00:07:25,680 --> 00:07:27,660
the domain controller or a domain

187
00:07:27,660 --> 00:07:30,240
controller again in large environments

188
00:07:30,240 --> 00:07:33,000
there's usually more than one

189
00:07:33,000 --> 00:07:34,979
the next big question we want to ask is

190
00:07:34,979 --> 00:07:37,680
where are the member servers so where

191
00:07:37,680 --> 00:07:41,280
are the MS SQL servers where the file

192
00:07:41,280 --> 00:07:45,000
servers where are the internet hosts

193
00:07:45,000 --> 00:07:46,620
where are these things

194
00:07:46,620 --> 00:07:47,940
and we want to gather all this

195
00:07:47,940 --> 00:07:50,099
information and then actually formulate

196
00:07:50,099 --> 00:07:51,720
our attacks

197
00:07:51,720 --> 00:07:53,840
so that's our stealthy submarine there

198
00:07:53,840 --> 00:07:56,099
we're in San Diego and we're talking

199
00:07:56,099 --> 00:07:58,919
about being quiet I thought the stealthy

200
00:07:58,919 --> 00:08:01,800
submarine was uh appropriate

201
00:08:01,800 --> 00:08:02,400
um

202
00:08:02,400 --> 00:08:04,020
so

203
00:08:04,020 --> 00:08:05,639
you know these are the three questions

204
00:08:05,639 --> 00:08:07,979
right so we start off we say Where am I

205
00:08:07,979 --> 00:08:10,800
and we Recon the subnet

206
00:08:10,800 --> 00:08:13,319
we locate the DC

207
00:08:13,319 --> 00:08:16,440
we Recon that subnet so once we finally

208
00:08:16,440 --> 00:08:18,720
DC we do the same thing we do on the

209
00:08:18,720 --> 00:08:20,099
subnet that we're currently on but we do

210
00:08:20,099 --> 00:08:21,900
it for the DC subnet

211
00:08:21,900 --> 00:08:23,879
uh and then essentially the same thing

212
00:08:23,879 --> 00:08:25,440
with

213
00:08:25,440 --> 00:08:27,419
um the different servers the member

214
00:08:27,419 --> 00:08:28,919
servers and the different hosts that we

215
00:08:28,919 --> 00:08:30,360
find

216
00:08:30,360 --> 00:08:32,099
so this is just

217
00:08:32,099 --> 00:08:34,080
really the methodology behind being

218
00:08:34,080 --> 00:08:35,580
quiet

219
00:08:35,580 --> 00:08:36,120
um

220
00:08:36,120 --> 00:08:38,940
these are the things that we can we can

221
00:08:38,940 --> 00:08:41,339
locate and the things that we can gather

222
00:08:41,339 --> 00:08:43,860
information on to then formulate our

223
00:08:43,860 --> 00:08:45,779
further attacks right so at this stage

224
00:08:45,779 --> 00:08:47,820
in the game we're not saying Hey I want

225
00:08:47,820 --> 00:08:51,660
to do uh SMB relay or hey I want to run

226
00:08:51,660 --> 00:08:53,640
responder or hey I want to do this hey I

227
00:08:53,640 --> 00:08:55,920
want to do that we're just simply doing

228
00:08:55,920 --> 00:08:57,899
our Recon we're finding out where we are

229
00:08:57,899 --> 00:08:59,940
where the DC is and where the member

230
00:08:59,940 --> 00:09:02,420
servers are

231
00:09:05,279 --> 00:09:07,500
so there's lots of different ways to do

232
00:09:07,500 --> 00:09:10,920
this uh these are the common ones that I

233
00:09:10,920 --> 00:09:12,420
do

234
00:09:12,420 --> 00:09:14,399
um the first thing I always do is I use

235
00:09:14,399 --> 00:09:15,180
our

236
00:09:15,180 --> 00:09:17,220
all right do ARP scan I find out where

237
00:09:17,220 --> 00:09:19,500
am I so you know let me ask you this how

238
00:09:19,500 --> 00:09:22,380
many people here are new to infosec or

239
00:09:22,380 --> 00:09:23,820
offensive security

240
00:09:23,820 --> 00:09:26,580
anybody one two

241
00:09:26,580 --> 00:09:28,260
couple nice

242
00:09:28,260 --> 00:09:32,160
how many have been doing it over a year

243
00:09:32,160 --> 00:09:33,360
okay

244
00:09:33,360 --> 00:09:35,459
so everybody knows what ARP is right if

245
00:09:35,459 --> 00:09:37,980
I look at ARP I can say all right well

246
00:09:37,980 --> 00:09:40,560
here I am here's some other computers

247
00:09:40,560 --> 00:09:45,180
here's some other hosts uh what are they

248
00:09:45,180 --> 00:09:47,399
the other thing I like to do is Ping the

249
00:09:47,399 --> 00:09:49,920
broadcast address

250
00:09:49,920 --> 00:09:52,500
so this should not in a properly

251
00:09:52,500 --> 00:09:54,660
configured Network this should not yield

252
00:09:54,660 --> 00:09:57,959
any results this simply shouldn't work

253
00:09:57,959 --> 00:09:59,820
but I still do it

254
00:09:59,820 --> 00:10:03,180
uh primarily one maybe the firewalls was

255
00:10:03,180 --> 00:10:05,339
configured or maybe the devices are

256
00:10:05,339 --> 00:10:07,200
misconfigured right who knows maybe

257
00:10:07,200 --> 00:10:08,899
it'll work maybe something will respond

258
00:10:08,899 --> 00:10:13,320
if not maybe I can get

259
00:10:13,320 --> 00:10:14,040
um

260
00:10:14,040 --> 00:10:16,380
maybe I could get the firewall IP

261
00:10:16,380 --> 00:10:18,360
because a lot of times if you do certain

262
00:10:18,360 --> 00:10:20,040
things like that in the network the

263
00:10:20,040 --> 00:10:21,360
firewall is the one that pings back

264
00:10:21,360 --> 00:10:23,700
right but the point is that I always

265
00:10:23,700 --> 00:10:25,140
think it's it's fruitful and it's

266
00:10:25,140 --> 00:10:27,060
helpful to do this because what it could

267
00:10:27,060 --> 00:10:28,800
do it could help you find Legacy or

268
00:10:28,800 --> 00:10:31,080
misconfigured hosts right so if you get

269
00:10:31,080 --> 00:10:32,880
a if you get a host of pings back from

270
00:10:32,880 --> 00:10:35,339
broadcast well to me that's a red flag

271
00:10:35,339 --> 00:10:37,920
so what is this thing this is this

272
00:10:37,920 --> 00:10:39,000
something that's been sitting on the

273
00:10:39,000 --> 00:10:40,860
network for 10 years that they forgot

274
00:10:40,860 --> 00:10:41,580
about

275
00:10:41,580 --> 00:10:43,500
or is it something new that wasn't

276
00:10:43,500 --> 00:10:45,660
properly configured it's a good way to

277
00:10:45,660 --> 00:10:48,899
find it's it's a good

278
00:10:48,899 --> 00:10:50,579
it's just a good tactic to throw at the

279
00:10:50,579 --> 00:10:52,140
wall and see what sticks because you

280
00:10:52,140 --> 00:10:53,700
might get something good back right and

281
00:10:53,700 --> 00:10:56,040
why not do it while you're there

282
00:10:56,040 --> 00:10:58,560
uh some classic things if anybody's

283
00:10:58,560 --> 00:11:03,779
taken oscp uh or has the oscp they wanna

284
00:11:03,779 --> 00:11:05,339
well I don't know if they do it in a new

285
00:11:05,339 --> 00:11:08,579
one but when I took the oscp they were

286
00:11:08,579 --> 00:11:12,120
really big on using the command line to

287
00:11:12,120 --> 00:11:13,440
you know

288
00:11:13,440 --> 00:11:13,980
um

289
00:11:13,980 --> 00:11:18,480
uh do loops or do pink sweeps do TCP

290
00:11:18,480 --> 00:11:20,579
sweeps with netcat or whatever else

291
00:11:20,579 --> 00:11:22,800
right uh

292
00:11:22,800 --> 00:11:24,480
and I've been doing this for a little

293
00:11:24,480 --> 00:11:26,760
bit now and I still

294
00:11:26,760 --> 00:11:29,760
use the same technique that I did when I

295
00:11:29,760 --> 00:11:32,100
was going for my oscp

296
00:11:32,100 --> 00:11:34,800
so I will literally just do a Bash one

297
00:11:34,800 --> 00:11:37,920
liner you know with pink and loop

298
00:11:37,920 --> 00:11:40,200
through right uh you can do the same

299
00:11:40,200 --> 00:11:44,120
thing in Powershell Powershell has tests

300
00:11:44,120 --> 00:11:47,160
connection right yeah uh so you can do

301
00:11:47,160 --> 00:11:49,200
the same thing in Powershell but the

302
00:11:49,200 --> 00:11:53,820
point is that if you do this foreign

303
00:11:54,079 --> 00:11:56,880
it's not as easy as just kicking off end

304
00:11:56,880 --> 00:12:00,060
map or Rumble right to be to be quiet

305
00:12:00,060 --> 00:12:02,339
you need to have patience and you need

306
00:12:02,339 --> 00:12:04,620
to be smart in the actions that you take

307
00:12:04,620 --> 00:12:07,860
and so a lot of times when I say use the

308
00:12:07,860 --> 00:12:09,240
one liner to do a pink Suite people are

309
00:12:09,240 --> 00:12:11,040
like oh well why don't you just do one

310
00:12:11,040 --> 00:12:12,779
map why don't you just you know do SN

311
00:12:12,779 --> 00:12:15,060
turn off post-discovery do this do this

312
00:12:15,060 --> 00:12:17,519
do this right the point is that when we

313
00:12:17,519 --> 00:12:18,959
want to stay quiet we want to stay

314
00:12:18,959 --> 00:12:19,980
simple

315
00:12:19,980 --> 00:12:22,320
right we don't want to do

316
00:12:22,320 --> 00:12:24,839
anything that's excessive

317
00:12:24,839 --> 00:12:29,160
um and so I still do those to this day

318
00:12:29,160 --> 00:12:31,860
um and it continues to work

319
00:12:31,860 --> 00:12:35,700
the last one is if if you're able to

320
00:12:35,700 --> 00:12:36,420
um

321
00:12:36,420 --> 00:12:38,100
if you're able to grab a packet capture

322
00:12:38,100 --> 00:12:39,899
I think this is something we forget

323
00:12:39,899 --> 00:12:42,779
about often uh that we can do packet

324
00:12:42,779 --> 00:12:45,779
captures we can filter by service right

325
00:12:45,779 --> 00:12:47,459
or even if we're not filtering by

326
00:12:47,459 --> 00:12:49,800
service we can filter by Port filter by

327
00:12:49,800 --> 00:12:52,560
TCP UDP we can see where DNS is we can

328
00:12:52,560 --> 00:12:55,620
see where s b is going we can see HD

329
00:12:55,620 --> 00:12:57,899
HTTP traffic we can do all these things

330
00:12:57,899 --> 00:13:00,899
so that I think that's a a common one

331
00:13:00,899 --> 00:13:04,320
that we forget often

332
00:13:04,620 --> 00:13:07,440
so this is really just the first one if

333
00:13:07,440 --> 00:13:09,839
we go back

334
00:13:09,839 --> 00:13:11,459
if we go back to where am I these are

335
00:13:11,459 --> 00:13:13,019
really just things that

336
00:13:13,019 --> 00:13:15,360
uh I'm doing on each subnet when I do

337
00:13:15,360 --> 00:13:17,040
one of these and I'm trying to stay stay

338
00:13:17,040 --> 00:13:19,760
quiet like this

339
00:13:21,720 --> 00:13:22,920
so the next thing I want to know is

340
00:13:22,920 --> 00:13:25,260
locate the domain controller

341
00:13:25,260 --> 00:13:26,820
real simple

342
00:13:26,820 --> 00:13:29,700
uh nine times out of ten the first thing

343
00:13:29,700 --> 00:13:33,060
I do is I look at the DHCP assigned DNS

344
00:13:33,060 --> 00:13:34,139
server

345
00:13:34,139 --> 00:13:35,639
when you're in an active directory

346
00:13:35,639 --> 00:13:37,740
environment it's almost always the

347
00:13:37,740 --> 00:13:39,920
domain controller it's not always true

348
00:13:39,920 --> 00:13:43,440
sure but it's almost always the domain

349
00:13:43,440 --> 00:13:44,519
controller

350
00:13:44,519 --> 00:13:48,300
so simply looking at the dhcps sign uh

351
00:13:48,300 --> 00:13:50,160
DNS server

352
00:13:50,160 --> 00:13:51,899
most the time that's how I figure out

353
00:13:51,899 --> 00:13:54,300
where DC is

354
00:13:54,300 --> 00:13:56,339
um that's the big one the other one is

355
00:13:56,339 --> 00:13:58,260
use environment variables so if you're

356
00:13:58,260 --> 00:14:00,000
on a Windows machine you can Echo log on

357
00:14:00,000 --> 00:14:02,459
server uh the other reason I say Echo

358
00:14:02,459 --> 00:14:04,680
logon server

359
00:14:04,680 --> 00:14:07,079
and why I say to use

360
00:14:07,079 --> 00:14:09,360
um so for example

361
00:14:09,360 --> 00:14:11,399
instead of who am I if you're on a

362
00:14:11,399 --> 00:14:13,500
Windows machine Echo the variable right

363
00:14:13,500 --> 00:14:15,899
so Echo computer name right whatever

364
00:14:15,899 --> 00:14:17,639
you're trying to get because if you run

365
00:14:17,639 --> 00:14:19,980
who am I in a Powershell or command line

366
00:14:19,980 --> 00:14:21,180
session

367
00:14:21,180 --> 00:14:22,980
PDR is going to see that

368
00:14:22,980 --> 00:14:24,660
plain and simple every single time you

369
00:14:24,660 --> 00:14:27,899
do it you know Carbon black crowdstrike

370
00:14:27,899 --> 00:14:29,700
they're all going to do it and again

371
00:14:29,700 --> 00:14:31,440
remember we're talking about mature

372
00:14:31,440 --> 00:14:33,540
networks we're talking about mature

373
00:14:33,540 --> 00:14:36,779
Security Programs if they see you know

374
00:14:36,779 --> 00:14:39,899
Bob from accounting is running who am I

375
00:14:39,899 --> 00:14:42,480
well they're gonna know something's you

376
00:14:42,480 --> 00:14:45,420
know they might not you know go crazy

377
00:14:45,420 --> 00:14:46,860
but they're always going to investigate

378
00:14:46,860 --> 00:14:49,380
what's going on right so environment

379
00:14:49,380 --> 00:14:51,079
variables are your friend I use them

380
00:14:51,079 --> 00:14:53,699
often uh to kind of see where I'm at

381
00:14:53,699 --> 00:14:55,620
depending on if I land on a Windows

382
00:14:55,620 --> 00:14:58,680
machine or if I'm on a Linux box it

383
00:14:58,680 --> 00:15:00,660
depends but I always look at environment

384
00:15:00,660 --> 00:15:01,920
variables

385
00:15:01,920 --> 00:15:04,920
uh and again if you have a POS if you

386
00:15:04,920 --> 00:15:07,320
have the option uh to do a packet

387
00:15:07,320 --> 00:15:08,399
capture

388
00:15:08,399 --> 00:15:11,699
I would highly recommend it

389
00:15:11,699 --> 00:15:14,220
so this is more about performing a

390
00:15:14,220 --> 00:15:15,959
reconnaissance

391
00:15:15,959 --> 00:15:16,860
um

392
00:15:16,860 --> 00:15:18,899
and just locating the domain controller

393
00:15:18,899 --> 00:15:20,220
so at this point we should have a pretty

394
00:15:20,220 --> 00:15:22,740
good idea of what subnet we're on just

395
00:15:22,740 --> 00:15:25,380
from the things that we do previously

396
00:15:25,380 --> 00:15:27,060
right we should have a pretty good idea

397
00:15:27,060 --> 00:15:29,579
of what subnet we're on what else is

398
00:15:29,579 --> 00:15:30,779
around us

399
00:15:30,779 --> 00:15:32,459
what type of devices are on the subnet

400
00:15:32,459 --> 00:15:35,220
we're on we should know where the domain

401
00:15:35,220 --> 00:15:36,839
controller is

402
00:15:36,839 --> 00:15:38,100
right

403
00:15:38,100 --> 00:15:39,779
and now really what we want to start to

404
00:15:39,779 --> 00:15:41,820
look at is

405
00:15:41,820 --> 00:15:44,820
um really starting to look into active

406
00:15:44,820 --> 00:15:46,560
directory

407
00:15:46,560 --> 00:15:50,360
so once we find the domain controller

408
00:15:50,360 --> 00:15:53,100
you know so everybody knows what else

409
00:15:53,100 --> 00:15:56,540
what's what ldap stand for

410
00:15:59,300 --> 00:16:01,199
it's all right I have to look it up

411
00:16:01,199 --> 00:16:03,420
because I always forget the a it's uh

412
00:16:03,420 --> 00:16:06,600
yeah lightweight directory

413
00:16:06,600 --> 00:16:10,680
access protocol there we go ldap right

414
00:16:10,680 --> 00:16:13,079
Windows Active Directory

415
00:16:13,079 --> 00:16:15,959
Windows is built on ldap we often forget

416
00:16:15,959 --> 00:16:17,160
this

417
00:16:17,160 --> 00:16:20,160
and by its very nature ldap provides

418
00:16:20,160 --> 00:16:21,660
certain information

419
00:16:21,660 --> 00:16:23,519
this is how Bloodhound works but well

420
00:16:23,519 --> 00:16:24,839
Bloodhound does a lot more other stuff

421
00:16:24,839 --> 00:16:27,300
but his core Bloodhound is pulling out

422
00:16:27,300 --> 00:16:29,399
app information from the domain

423
00:16:29,399 --> 00:16:30,660
controller

424
00:16:30,660 --> 00:16:32,760
and we can do this ourselves right

425
00:16:32,760 --> 00:16:36,839
there's uh there's ldap search

426
00:16:36,839 --> 00:16:39,660
um which you know if if Anonymous login

427
00:16:39,660 --> 00:16:41,759
is

428
00:16:41,759 --> 00:16:43,980
um enabled on the DC you can literally

429
00:16:43,980 --> 00:16:47,519
dump all of ldap the whole thing right

430
00:16:47,519 --> 00:16:49,680
you'd be surprised how often that's

431
00:16:49,680 --> 00:16:51,360
enabled

432
00:16:51,360 --> 00:16:53,759
happens all the time in mature

433
00:16:53,759 --> 00:16:54,899
environments

434
00:16:54,899 --> 00:16:56,579
right

435
00:16:56,579 --> 00:16:59,040
um Anonymous login is enabled so you can

436
00:16:59,040 --> 00:17:01,320
literally dump all of ldap and in a

437
00:17:01,320 --> 00:17:05,099
minute I'll show you uh one of them

438
00:17:05,099 --> 00:17:08,520
but just as the second thing I do right

439
00:17:08,520 --> 00:17:10,679
so I find the domain controller can I

440
00:17:10,679 --> 00:17:13,140
dump ldap and I do that

441
00:17:13,140 --> 00:17:14,459
remember now

442
00:17:14,459 --> 00:17:17,040
ldap has

443
00:17:17,040 --> 00:17:18,540
computer names

444
00:17:18,540 --> 00:17:22,260
usernames groups all this stuff by the

445
00:17:22,260 --> 00:17:24,839
very nature of how ldap Works everything

446
00:17:24,839 --> 00:17:26,939
is an object

447
00:17:26,939 --> 00:17:31,380
in ldap so if you can dump all of ldap

448
00:17:31,380 --> 00:17:34,580
you're in a pretty good spot

449
00:17:34,860 --> 00:17:35,580
um

450
00:17:35,580 --> 00:17:37,260
sometimes I'll run Bloodhound depending

451
00:17:37,260 --> 00:17:40,559
on the situation

452
00:17:40,559 --> 00:17:42,059
um

453
00:17:42,059 --> 00:17:44,520
I love Bloodhounds gives me nice little

454
00:17:44,520 --> 00:17:46,679
graphs to take screenshots of to show

455
00:17:46,679 --> 00:17:50,220
clients this is what we did uh you know

456
00:17:50,220 --> 00:17:52,320
so I I do love Bloodhound and I use it

457
00:17:52,320 --> 00:17:55,799
often however if I'm trying to to stay

458
00:17:55,799 --> 00:17:58,260
quiet I usually stay away from it I was

459
00:17:58,260 --> 00:17:59,940
actually at the um

460
00:17:59,940 --> 00:18:03,960
uh the tool Chev where uh they were they

461
00:18:03,960 --> 00:18:06,360
were doing a demo of it

462
00:18:06,360 --> 00:18:08,460
um and even he said you know even if

463
00:18:08,460 --> 00:18:10,080
you're using stealth with Bloodhound

464
00:18:10,080 --> 00:18:11,760
it's still calling out to each

465
00:18:11,760 --> 00:18:15,000
individual computer to get uh

466
00:18:15,000 --> 00:18:17,340
I think it's local group policies

467
00:18:17,340 --> 00:18:19,860
African local groups I think so it's

468
00:18:19,860 --> 00:18:22,140
still calling out to each individual

469
00:18:22,140 --> 00:18:23,160
host

470
00:18:23,160 --> 00:18:26,760
right that might not be like a ton of

471
00:18:26,760 --> 00:18:30,059
traffic but for me it's more than I want

472
00:18:30,059 --> 00:18:32,700
to take the risk of of creating

473
00:18:32,700 --> 00:18:34,980
so again if I'm trying to stay quiet I

474
00:18:34,980 --> 00:18:37,020
usually stay away from Bloodhounds and

475
00:18:37,020 --> 00:18:40,460
just do my best to dump ldap

476
00:18:42,539 --> 00:18:45,140
so

477
00:18:45,660 --> 00:18:47,280
yeah

478
00:18:47,280 --> 00:18:50,460
so here's an example of dumping ldap

479
00:18:50,460 --> 00:18:52,580
um

480
00:18:53,400 --> 00:18:56,820
using ldap search ldap search was

481
00:18:56,820 --> 00:18:58,320
I don't know

482
00:18:58,320 --> 00:19:02,280
probably made in 1953 who knows it's old

483
00:19:02,280 --> 00:19:05,760
uh it's been around forever

484
00:19:05,760 --> 00:19:07,919
um but uh here's an example of doing

485
00:19:07,919 --> 00:19:10,799
that so if the domain name was contoso

486
00:19:10,799 --> 00:19:15,299
uh this is what we would run to dump all

487
00:19:15,299 --> 00:19:18,299
of it uh and then I just gave a couple

488
00:19:18,299 --> 00:19:21,720
screenshots but this file is

489
00:19:21,720 --> 00:19:23,760
thousands yeah I mean it's thousands of

490
00:19:23,760 --> 00:19:25,919
lines right I just grabbed some to show

491
00:19:25,919 --> 00:19:28,500
you the header and then show you uh a

492
00:19:28,500 --> 00:19:31,200
group right so and remember now if we

493
00:19:31,200 --> 00:19:34,380
dump ldap that's one call

494
00:19:34,380 --> 00:19:37,260
one call for all of ldap

495
00:19:37,260 --> 00:19:39,120
so from a network monitoring perspective

496
00:19:39,120 --> 00:19:41,400
all you're seeing is that one

497
00:19:41,400 --> 00:19:44,520
call that's it whereas with bloodhound

498
00:19:44,520 --> 00:19:46,380
you're seeing a call from me to this

499
00:19:46,380 --> 00:19:48,360
computer me to this host me to this

500
00:19:48,360 --> 00:19:49,700
house

501
00:19:49,700 --> 00:19:52,500
with this we get everything in one call

502
00:19:52,500 --> 00:19:55,260
which is why I prefer to do it

503
00:19:55,260 --> 00:19:57,960
uh and this this provides lots of

504
00:19:57,960 --> 00:19:59,460
valuable information

505
00:19:59,460 --> 00:20:01,260
it is very core again that you're going

506
00:20:01,260 --> 00:20:02,520
to get computer names you're going to

507
00:20:02,520 --> 00:20:04,020
get groups you're going to get users

508
00:20:04,020 --> 00:20:06,900
you're going to get all that stuff uh in

509
00:20:06,900 --> 00:20:08,700
a best case scenario

510
00:20:08,700 --> 00:20:11,100
there might even be a managed service

511
00:20:11,100 --> 00:20:14,880
account passwords there uh if you

512
00:20:14,880 --> 00:20:18,720
uh if you follow ipsec uh he has some

513
00:20:18,720 --> 00:20:20,700
pretty good videos on actually dumping

514
00:20:20,700 --> 00:20:23,100
this and finding passwords and things

515
00:20:23,100 --> 00:20:24,419
like that but this is a very valuable

516
00:20:24,419 --> 00:20:26,760
real resource I think it's penetration

517
00:20:26,760 --> 00:20:28,679
testers we almost forget about

518
00:20:28,679 --> 00:20:31,380
right we almost forget because we say

519
00:20:31,380 --> 00:20:33,240
all right let's hop in let's let's run

520
00:20:33,240 --> 00:20:35,700
Bloodhound throw it in there we keep the

521
00:20:35,700 --> 00:20:38,039
nice graphs run our searches which is

522
00:20:38,039 --> 00:20:39,799
great and has value don't get me wrong

523
00:20:39,799 --> 00:20:43,080
but I think we forget that active

524
00:20:43,080 --> 00:20:46,679
directory is built on ldap

525
00:20:46,679 --> 00:20:50,340
we forgot and and there's so much

526
00:20:50,340 --> 00:20:51,660
valuable information that could come

527
00:20:51,660 --> 00:20:52,559
from this

528
00:20:52,559 --> 00:20:54,660
uh so this is almost always one of those

529
00:20:54,660 --> 00:20:57,320
things that I do

530
00:20:57,840 --> 00:21:00,960
so if we dump ldap

531
00:21:00,960 --> 00:21:03,240
remember we get we get a

532
00:21:03,240 --> 00:21:05,580
uh machine names and host names

533
00:21:05,580 --> 00:21:07,200
well what's stopping us from taking

534
00:21:07,200 --> 00:21:08,940
those host names and performing an NS

535
00:21:08,940 --> 00:21:11,160
lookup

536
00:21:11,160 --> 00:21:13,380
right

537
00:21:13,380 --> 00:21:14,940
um I was about to build a tool and then

538
00:21:14,940 --> 00:21:16,679
I realized of course someone did that

539
00:21:16,679 --> 00:21:17,520
already

540
00:21:17,520 --> 00:21:21,179
uh and so uh this is a tool called ldap

541
00:21:21,179 --> 00:21:23,280
domain dump the Link's there by the way

542
00:21:23,280 --> 00:21:26,820
the these slides uh will be well thrown

543
00:21:26,820 --> 00:21:30,360
in the Discord so you can uh see all the

544
00:21:30,360 --> 00:21:32,820
links and everything uh but essentially

545
00:21:32,820 --> 00:21:34,440
what this tool is doing is it's dumping

546
00:21:34,440 --> 00:21:36,059
ldap it's grabbing the host names it's

547
00:21:36,059 --> 00:21:39,240
performing an nslookup right

548
00:21:39,240 --> 00:21:41,159
um and so what you can do is you could

549
00:21:41,159 --> 00:21:43,140
have an IP list of all the machines at

550
00:21:43,140 --> 00:21:45,059
least in the active directory network of

551
00:21:45,059 --> 00:21:47,280
course there's going to be others uh but

552
00:21:47,280 --> 00:21:49,559
you can get a IP of all the machines

553
00:21:49,559 --> 00:21:52,280
right

554
00:21:52,799 --> 00:21:54,600
some other random things that I do when

555
00:21:54,600 --> 00:21:57,000
I'm performing Recon on active directory

556
00:21:57,000 --> 00:22:00,539
netview wall should give you a list of

557
00:22:00,539 --> 00:22:03,240
machine names may or may not work

558
00:22:03,240 --> 00:22:05,520
uh depending on

559
00:22:05,520 --> 00:22:08,280
um access controls and group policies

560
00:22:08,280 --> 00:22:10,860
and stuff like that uh one big thing

561
00:22:10,860 --> 00:22:12,360
that I like to do is look at SSL

562
00:22:12,360 --> 00:22:13,679
certificates

563
00:22:13,679 --> 00:22:16,740
so if you if you notice that there's web

564
00:22:16,740 --> 00:22:18,120
hosts

565
00:22:18,120 --> 00:22:19,020
um

566
00:22:19,020 --> 00:22:21,960
what I almost always do I I personally

567
00:22:21,960 --> 00:22:24,120
think SSL self-signed SSL certificates

568
00:22:24,120 --> 00:22:27,059
are an overlooked uh part of our our

569
00:22:27,059 --> 00:22:29,340
day-to-day they can provide a lot of

570
00:22:29,340 --> 00:22:31,140
information for you if you think about

571
00:22:31,140 --> 00:22:34,620
it right especially a self-signed so if

572
00:22:34,620 --> 00:22:36,360
you find a self-signed SSL certificate

573
00:22:36,360 --> 00:22:37,799
on an internal Network

574
00:22:37,799 --> 00:22:39,240
there's lots of things that could tell

575
00:22:39,240 --> 00:22:41,640
you one if you check the issuer

576
00:22:41,640 --> 00:22:43,500
who's the issuer

577
00:22:43,500 --> 00:22:47,039
is it some other machine in the ad

578
00:22:47,039 --> 00:22:50,220
is it local what is it right

579
00:22:50,220 --> 00:22:51,480
um

580
00:22:51,480 --> 00:22:55,080
is it using an IP address does that IP

581
00:22:55,080 --> 00:22:56,400
address match up with the host that

582
00:22:56,400 --> 00:22:58,799
you're on or is that IP address some

583
00:22:58,799 --> 00:23:00,659
other machine that they they have

584
00:23:00,659 --> 00:23:02,820
somewhere else on the network

585
00:23:02,820 --> 00:23:03,900
um

586
00:23:03,900 --> 00:23:06,360
but the big thing is if you check the

587
00:23:06,360 --> 00:23:08,820
issuer that self-science uh of that

588
00:23:08,820 --> 00:23:09,960
certificate

589
00:23:09,960 --> 00:23:15,679
and you see well it's uh 80 uh adcs Dash

590
00:23:15,679 --> 00:23:18,780
contoso.com well that means it

591
00:23:18,780 --> 00:23:21,179
certificate Services most likely

592
00:23:21,179 --> 00:23:23,400
this doesn't confirm it but it means

593
00:23:23,400 --> 00:23:26,880
that most likely this is a this uh

594
00:23:26,880 --> 00:23:28,799
internal Network this active directory

595
00:23:28,799 --> 00:23:30,059
environment

596
00:23:30,059 --> 00:23:31,919
stood up their own certificate Authority

597
00:23:31,919 --> 00:23:34,380
and they issue the certificates to their

598
00:23:34,380 --> 00:23:35,940
their machines

599
00:23:35,940 --> 00:23:38,760
which indicates that they're using

600
00:23:38,760 --> 00:23:41,580
active directory certificate services

601
00:23:41,580 --> 00:23:42,780
um

602
00:23:42,780 --> 00:23:45,480
so that's just one way to uh

603
00:23:45,480 --> 00:23:48,539
to Recon active directory it may not

604
00:23:48,539 --> 00:23:50,159
show you that they're using certificate

605
00:23:50,159 --> 00:23:52,140
Services it might show you

606
00:23:52,140 --> 00:23:55,200
it might show you what the device is so

607
00:23:55,200 --> 00:23:56,880
a Cisco self-signed certificate well

608
00:23:56,880 --> 00:23:59,159
this is a Cisco device well does it say

609
00:23:59,159 --> 00:24:01,860
what kind of Cisco device it is in it

610
00:24:01,860 --> 00:24:02,760
um

611
00:24:02,760 --> 00:24:04,320
cell signed certificates and

612
00:24:04,320 --> 00:24:07,740
certificates in general are a great uh

613
00:24:07,740 --> 00:24:10,880
great place to gather information for us

614
00:24:10,880 --> 00:24:13,860
during our reconnaissance and I think

615
00:24:13,860 --> 00:24:16,799
it's overlooked often I do it all the

616
00:24:16,799 --> 00:24:18,480
time and it provides me lots of great

617
00:24:18,480 --> 00:24:20,580
Intel

618
00:24:20,580 --> 00:24:23,400
uh the other thing and and I included

619
00:24:23,400 --> 00:24:25,740
this because

620
00:24:25,740 --> 00:24:28,140
looking at that last bullet point you

621
00:24:28,140 --> 00:24:30,059
know what do you guys think is my number

622
00:24:30,059 --> 00:24:32,280
one way of popping a shell in an active

623
00:24:32,280 --> 00:24:33,600
director environment

624
00:24:33,600 --> 00:24:36,000
just just going off that last bullet

625
00:24:36,000 --> 00:24:38,120
point

626
00:24:38,460 --> 00:24:39,960
yeah

627
00:24:39,960 --> 00:24:41,340
all the time

628
00:24:41,340 --> 00:24:42,900
constantly

629
00:24:42,900 --> 00:24:45,179
constantly

630
00:24:45,179 --> 00:24:46,559
um

631
00:24:46,559 --> 00:24:48,720
using ntlm relay X that's like the

632
00:24:48,720 --> 00:24:50,700
number one way I get a show in an active

633
00:24:50,700 --> 00:24:51,960
director environment

634
00:24:51,960 --> 00:24:54,659
uh so I'm always interested to see

635
00:24:54,659 --> 00:24:57,960
which hosts uh have SMB signing enabled

636
00:24:57,960 --> 00:24:59,220
and which don't

637
00:24:59,220 --> 00:25:00,720
uh so

638
00:25:00,720 --> 00:25:03,360
which hosts have SMB signing required in

639
00:25:03,360 --> 00:25:04,980
which don't so SMB signing could be

640
00:25:04,980 --> 00:25:07,320
enabled but not required it could be

641
00:25:07,320 --> 00:25:09,539
required

642
00:25:09,539 --> 00:25:10,919
Etc

643
00:25:10,919 --> 00:25:11,700
um

644
00:25:11,700 --> 00:25:14,280
domain controllers

645
00:25:14,280 --> 00:25:17,460
I think all member servers

646
00:25:17,460 --> 00:25:20,179
after

647
00:25:20,280 --> 00:25:23,039
I want to say 2012

648
00:25:23,039 --> 00:25:26,520
have SMB signing required so you're

649
00:25:26,520 --> 00:25:28,260
never going to pop shell on like a DC or

650
00:25:28,260 --> 00:25:30,480
a member server using this uh but you

651
00:25:30,480 --> 00:25:32,460
are able to you are going to be able to

652
00:25:32,460 --> 00:25:34,559
you know hit other hosts on the

653
00:25:34,559 --> 00:25:36,419
environment so this is one of the this

654
00:25:36,419 --> 00:25:37,620
is

655
00:25:37,620 --> 00:25:39,720
I do this all the time because I can

656
00:25:39,720 --> 00:25:42,799
almost always pop a show

657
00:25:47,240 --> 00:25:49,620
more than you would think

658
00:25:49,620 --> 00:25:50,820
because

659
00:25:50,820 --> 00:25:52,679
it depends on the group policy right so

660
00:25:52,679 --> 00:25:54,440
you think about like these CIS admins

661
00:25:54,440 --> 00:25:57,299
they have five million ways to do the

662
00:25:57,299 --> 00:25:59,580
same thing right

663
00:25:59,580 --> 00:26:00,200
um

664
00:26:00,200 --> 00:26:01,820
and

665
00:26:01,820 --> 00:26:04,440
actually the same thing happens with SSL

666
00:26:04,440 --> 00:26:06,720
certificates so as part of a pen test

667
00:26:06,720 --> 00:26:09,360
when we're done we run nasus we do a

668
00:26:09,360 --> 00:26:11,640
long scan whatever right

669
00:26:11,640 --> 00:26:14,039
um and and uh like those Cypher Suite

670
00:26:14,039 --> 00:26:16,320
issues always come up like Suite 32 and

671
00:26:16,320 --> 00:26:18,299
whatever right and I'm like well wait a

672
00:26:18,299 --> 00:26:20,820
second I fixed that through group policy

673
00:26:20,820 --> 00:26:22,380
um

674
00:26:22,380 --> 00:26:25,200
because the way that's implemented

675
00:26:25,200 --> 00:26:26,880
sometimes

676
00:26:26,880 --> 00:26:29,460
it's a challenge for them to

677
00:26:29,460 --> 00:26:32,100
uh fully execute that group policy so

678
00:26:32,100 --> 00:26:33,659
they think that they did it but they

679
00:26:33,659 --> 00:26:36,059
either didn't have an ACL right or this

680
00:26:36,059 --> 00:26:38,220
one little thing wrong I'm gonna go back

681
00:26:38,220 --> 00:26:40,080
to uh the Bloodhound demo today because

682
00:26:40,080 --> 00:26:41,940
he showed the the permissions and the

683
00:26:41,940 --> 00:26:45,419
ACL lists in in active directory you

684
00:26:45,419 --> 00:26:47,159
know and you can see why it's not a

685
00:26:47,159 --> 00:26:49,200
surprise right

686
00:26:49,200 --> 00:26:51,299
um but it yeah

687
00:26:51,299 --> 00:26:52,559
yeah

688
00:26:52,559 --> 00:26:55,460
unfortunately

689
00:26:57,900 --> 00:27:00,240
uh so again this is just the third part

690
00:27:00,240 --> 00:27:03,120
of that methodology methodology that I

691
00:27:03,120 --> 00:27:05,220
uh shared before locating member servers

692
00:27:05,220 --> 00:27:07,320
some basic ways to locate these if we

693
00:27:07,320 --> 00:27:09,480
dump the ldap look at the ous

694
00:27:09,480 --> 00:27:12,900
the organizational units uh they usually

695
00:27:12,900 --> 00:27:16,260
give you a lot of information uh

696
00:27:16,260 --> 00:27:18,779
CIS fall if you're not looking through

697
00:27:18,779 --> 00:27:22,080
CIS fall you should

698
00:27:22,080 --> 00:27:24,059
um you know back in the day it used to

699
00:27:24,059 --> 00:27:25,919
be real easy to get a c password from

700
00:27:25,919 --> 00:27:28,679
some XML file instead small uh and I

701
00:27:28,679 --> 00:27:30,000
guess maybe that's what kind of

702
00:27:30,000 --> 00:27:31,980
ingrained this this process into me

703
00:27:31,980 --> 00:27:34,200
because I used to always find C

704
00:27:34,200 --> 00:27:35,700
passwords

705
00:27:35,700 --> 00:27:37,980
um but I like to look in the scripts

706
00:27:37,980 --> 00:27:40,500
folder uh and see what network drives

707
00:27:40,500 --> 00:27:42,360
are being mapped and that'll give you a

708
00:27:42,360 --> 00:27:44,279
lot of Intel into the file servers that

709
00:27:44,279 --> 00:27:45,720
they're using

710
00:27:45,720 --> 00:27:48,840
um in anything uh related to it the

711
00:27:48,840 --> 00:27:50,580
other one is I like to look at the GPO

712
00:27:50,580 --> 00:27:53,340
that sets the web bookmarks

713
00:27:53,340 --> 00:27:54,299
um

714
00:27:54,299 --> 00:27:56,039
because this will of course show you

715
00:27:56,039 --> 00:27:59,039
internet websites uh you know other

716
00:27:59,039 --> 00:28:01,020
hosts of interest

717
00:28:01,020 --> 00:28:03,720
um but just by doing the things that

718
00:28:03,720 --> 00:28:05,400
we've done so far we should have a

719
00:28:05,400 --> 00:28:07,760
pretty good

720
00:28:08,100 --> 00:28:11,220
um we have a pretty good idea of of what

721
00:28:11,220 --> 00:28:13,260
we can do and what sort of attacks we

722
00:28:13,260 --> 00:28:16,100
can we can perform

723
00:28:17,700 --> 00:28:20,039
a little bit quick on lateral movement

724
00:28:20,039 --> 00:28:21,720
of course I don't think I have to say it

725
00:28:21,720 --> 00:28:25,440
avoid Mimi cats but I said it anyways uh

726
00:28:25,440 --> 00:28:28,020
the common thing I do is use proc dump

727
00:28:28,020 --> 00:28:29,640
to uh

728
00:28:29,640 --> 00:28:32,340
actually dump lsas

729
00:28:32,340 --> 00:28:34,980
this could become a challenge depending

730
00:28:34,980 --> 00:28:37,380
on protected memory depending on the EDR

731
00:28:37,380 --> 00:28:38,640
that they're using

732
00:28:38,640 --> 00:28:41,520
you know this might be easier said than

733
00:28:41,520 --> 00:28:43,919
done in certain situations

734
00:28:43,919 --> 00:28:47,159
um but uh the point I'm trying to make

735
00:28:47,159 --> 00:28:49,260
there is stay away from the tool and do

736
00:28:49,260 --> 00:28:51,179
the process instead

737
00:28:51,179 --> 00:28:52,860
uh the other big thing I like to look

738
00:28:52,860 --> 00:28:55,020
for is group managed service accounts so

739
00:28:55,020 --> 00:28:56,940
if you're able to locate those by Nature

740
00:28:56,940 --> 00:29:00,140
active directory provides those to you

741
00:29:00,140 --> 00:29:03,360
if you're in the group and this is

742
00:29:03,360 --> 00:29:04,799
something that might not necessarily

743
00:29:04,799 --> 00:29:07,919
raise red flags from an EDR or network

744
00:29:07,919 --> 00:29:09,419
monitoring perspective because you're

745
00:29:09,419 --> 00:29:12,480
doing legitimate actions as far as

746
00:29:12,480 --> 00:29:14,640
active director is concerned and then

747
00:29:14,640 --> 00:29:17,700
just one quick uh low Bend to throw in

748
00:29:17,700 --> 00:29:21,240
there one that I like to use is RPC ping

749
00:29:21,240 --> 00:29:22,679
um so if you pop the shell on a Windows

750
00:29:22,679 --> 00:29:25,620
machine you don't know the password uh

751
00:29:25,620 --> 00:29:29,399
you can actually use RPC ping to

752
00:29:29,399 --> 00:29:30,360
um

753
00:29:30,360 --> 00:29:32,640
to send a request to your attacking

754
00:29:32,640 --> 00:29:35,100
machine and in that request if you just

755
00:29:35,100 --> 00:29:36,419
open up netcat and wait for the

756
00:29:36,419 --> 00:29:38,279
connection to come in you'll actually

757
00:29:38,279 --> 00:29:41,520
see the ntlm V2 hash so it's a good way

758
00:29:41,520 --> 00:29:43,740
to grab an ntl on V2 hash if you're not

759
00:29:43,740 --> 00:29:45,419
sure where you are

760
00:29:45,419 --> 00:29:47,340
um

761
00:29:47,340 --> 00:29:50,039
some basic stuff about

762
00:29:50,039 --> 00:29:53,760
working with c2s

763
00:29:53,760 --> 00:29:57,620
and these are typically what we do

764
00:29:57,620 --> 00:30:02,159
we if at all possible use mtls on 443

765
00:30:02,159 --> 00:30:05,820
uh so uh sliver is is one of the big

766
00:30:05,820 --> 00:30:08,520
ones that we like to use uh and that's

767
00:30:08,520 --> 00:30:10,620
kind of the de facto standard with

768
00:30:10,620 --> 00:30:12,899
slivers mtls

769
00:30:12,899 --> 00:30:14,220
um the other one that I like to talk

770
00:30:14,220 --> 00:30:18,600
about is SSL tunnel or S Tonneau so you

771
00:30:18,600 --> 00:30:21,179
can actually create your own SSL tunnels

772
00:30:21,179 --> 00:30:23,460
right I did a talk for red team Village

773
00:30:23,460 --> 00:30:24,899
a couple months back where I talked

774
00:30:24,899 --> 00:30:27,679
about routing

775
00:30:27,679 --> 00:30:31,679
SSH traffic through an SSL Tunnel right

776
00:30:31,679 --> 00:30:34,320
and so the reason for this is

777
00:30:34,320 --> 00:30:37,740
I'm probably gonna get this wrong uh SSH

778
00:30:37,740 --> 00:30:41,640
has encrypt then Mac cryptography

779
00:30:41,640 --> 00:30:43,799
which means that from a deep packet

780
00:30:43,799 --> 00:30:45,779
inspection perspective they can still

781
00:30:45,779 --> 00:30:48,360
see well this is SSH right

782
00:30:48,360 --> 00:30:51,779
whereas SSL is Mac then encrypt

783
00:30:51,779 --> 00:30:53,640
where they can't do the DPAC inspection

784
00:30:53,640 --> 00:30:56,399
and they can't see that it's

785
00:30:56,399 --> 00:30:58,559
um from from their perspective from a

786
00:30:58,559 --> 00:30:59,760
network monitoring perspective it just

787
00:30:59,760 --> 00:31:01,440
looks like SSL traffic

788
00:31:01,440 --> 00:31:03,600
uh but they can actually tell when it's

789
00:31:03,600 --> 00:31:04,980
SSH versus

790
00:31:04,980 --> 00:31:06,960
SSL right

791
00:31:06,960 --> 00:31:08,700
um and so

792
00:31:08,700 --> 00:31:10,320
you know depending on the framework that

793
00:31:10,320 --> 00:31:13,620
we're using again sliver has mtls we

794
00:31:13,620 --> 00:31:16,140
like to use Powershell Empire a lot uh

795
00:31:16,140 --> 00:31:17,220
simply

796
00:31:17,220 --> 00:31:19,559
um because I love those guys they do a

797
00:31:19,559 --> 00:31:21,240
lot of good work they got BC security

798
00:31:21,240 --> 00:31:22,500
does a lot of good work on Empire

799
00:31:22,500 --> 00:31:24,779
they're always improving it uh so we do

800
00:31:24,779 --> 00:31:28,640
like to use uh Empire

801
00:31:28,700 --> 00:31:32,340
you know has HTTP listeners which you

802
00:31:32,340 --> 00:31:35,220
could use certificates with uh but you

803
00:31:35,220 --> 00:31:37,200
can't use Mutual TLS so like in the case

804
00:31:37,200 --> 00:31:39,419
of an Empire payload if at all possible

805
00:31:39,419 --> 00:31:40,980
depending on the machine depending on

806
00:31:40,980 --> 00:31:43,380
where we are post exploitation you know

807
00:31:43,380 --> 00:31:46,020
if we are even able to set up a NS

808
00:31:46,020 --> 00:31:47,279
tunnel

809
00:31:47,279 --> 00:31:50,220
um if if possible that's what we'll do

810
00:31:50,220 --> 00:31:52,980
so S Tunnel literally just says like

811
00:31:52,980 --> 00:31:57,059
much like socat uh if you're on the uh

812
00:31:57,059 --> 00:31:58,679
the client with S Tunnel so there's

813
00:31:58,679 --> 00:32:01,260
client server and on the client you say

814
00:32:01,260 --> 00:32:03,120
listen on

815
00:32:03,120 --> 00:32:08,640
8 000 and Route it to this IP on 443

816
00:32:08,640 --> 00:32:11,880
through an SSL tunnel and then a server

817
00:32:11,880 --> 00:32:15,240
says 443 incoming and then you direct it

818
00:32:15,240 --> 00:32:16,799
wherever you want

819
00:32:16,799 --> 00:32:18,120
um but the point is that you can create

820
00:32:18,120 --> 00:32:21,659
a an SSL tunnel which we do often

821
00:32:21,659 --> 00:32:24,360
uh the other one DNS over https but a

822
00:32:24,360 --> 00:32:25,980
lot of times you know you see

823
00:32:25,980 --> 00:32:28,080
organizations and Enterprises disabling

824
00:32:28,080 --> 00:32:31,919
this uh but if it's there uh it's I've

825
00:32:31,919 --> 00:32:34,080
had some really great success I have one

826
00:32:34,080 --> 00:32:37,020
I uh uh client server architecture that

827
00:32:37,020 --> 00:32:40,559
uses DNS over https that I wrote and go

828
00:32:40,559 --> 00:32:43,500
and I've never been detected using that

829
00:32:43,500 --> 00:32:45,000
never

830
00:32:45,000 --> 00:32:47,159
because you know if you think about DNS

831
00:32:47,159 --> 00:32:49,620
over https what is it it's really just

832
00:32:49,620 --> 00:32:52,500
API calls that's it

833
00:32:52,500 --> 00:32:54,659
so from a network monitoring perspective

834
00:32:54,659 --> 00:32:57,440
all they see is okay this host

835
00:32:57,440 --> 00:33:01,919
uh Googled or I'm sorry accessed Google

836
00:33:01,919 --> 00:33:06,539
DNS on this port that's it right by the

837
00:33:06,539 --> 00:33:09,000
very nature of DNS or https if at all

838
00:33:09,000 --> 00:33:10,740
possible

839
00:33:10,740 --> 00:33:12,480
um you should use it because it's

840
00:33:12,480 --> 00:33:15,179
literally just HTTP calls it's API calls

841
00:33:15,179 --> 00:33:16,380
that's all it is

842
00:33:16,380 --> 00:33:19,860
the DNS client does an API call to the

843
00:33:19,860 --> 00:33:22,260
DNS over https server

844
00:33:22,260 --> 00:33:27,000
and gets an API HTTP response back

845
00:33:27,000 --> 00:33:30,720
uh so again that client in server

846
00:33:30,720 --> 00:33:32,880
architecture that I built

847
00:33:32,880 --> 00:33:33,600
um

848
00:33:33,600 --> 00:33:36,840
never been detected and I threw IPv6 in

849
00:33:36,840 --> 00:33:38,220
there simply because no one knows how it

850
00:33:38,220 --> 00:33:39,779
really works even if they tell you

851
00:33:39,779 --> 00:33:43,080
they're lying uh firewalls are slow to

852
00:33:43,080 --> 00:33:44,039
catch up

853
00:33:44,039 --> 00:33:46,019
uh even though the vendors might tell

854
00:33:46,019 --> 00:33:49,140
you they handle it uh the fact of the

855
00:33:49,140 --> 00:33:51,960
matter is that detection with IPv6 isn't

856
00:33:51,960 --> 00:33:55,019
nearly as good as with ipv ipv4 that's

857
00:33:55,019 --> 00:33:58,200
more of a joke more than anything uh but

858
00:33:58,200 --> 00:34:00,720
you know it's it's a good way to

859
00:34:00,720 --> 00:34:03,960
to bypass restrictions it's a good way

860
00:34:03,960 --> 00:34:05,039
to

861
00:34:05,039 --> 00:34:06,120
um

862
00:34:06,120 --> 00:34:09,060
attempt to hide your traffic from from

863
00:34:09,060 --> 00:34:10,918
network monitoring because they really

864
00:34:10,918 --> 00:34:12,300
don't

865
00:34:12,300 --> 00:34:14,699
they're again we're getting better but

866
00:34:14,699 --> 00:34:17,040
it's not that good

867
00:34:17,040 --> 00:34:19,260
so here's just uh an example attack I

868
00:34:19,260 --> 00:34:21,000
think pretty much

869
00:34:21,000 --> 00:34:23,639
um we talked about a lot of this so you

870
00:34:23,639 --> 00:34:26,219
know an example of tech here is

871
00:34:26,219 --> 00:34:27,899
you know regardless of how we landed on

872
00:34:27,899 --> 00:34:29,760
a network

873
00:34:29,760 --> 00:34:30,719
um

874
00:34:30,719 --> 00:34:33,119
first thing we did was run an ARP scan

875
00:34:33,119 --> 00:34:36,119
investigated our table right look where

876
00:34:36,119 --> 00:34:37,020
we were

877
00:34:37,020 --> 00:34:39,119
uh determined that we were on a client

878
00:34:39,119 --> 00:34:41,159
VLAN

879
00:34:41,159 --> 00:34:44,339
um which is typical and what we would

880
00:34:44,339 --> 00:34:46,619
expect to see uh then we checked the

881
00:34:46,619 --> 00:34:48,599
primary DNS server which is you know

882
00:34:48,599 --> 00:34:50,659
something we we uh talked about before

883
00:34:50,659 --> 00:34:54,359
uh we did a quick netcat on 88 for

884
00:34:54,359 --> 00:34:57,599
Kerberos to see uh if Kerberos was

885
00:34:57,599 --> 00:34:59,339
running on this particular DNS server it

886
00:34:59,339 --> 00:35:01,880
was we said okay this is probably DC

887
00:35:01,880 --> 00:35:05,700
uh did a quick ping sweep uh on that

888
00:35:05,700 --> 00:35:07,940
subnet quite often the way Network

889
00:35:07,940 --> 00:35:11,040
networks are architected if there's a DC

890
00:35:11,040 --> 00:35:12,900
there's most likely a file server or an

891
00:35:12,900 --> 00:35:15,180
SQL Server there's other member servers

892
00:35:15,180 --> 00:35:17,460
typically in the same subnet uh so

893
00:35:17,460 --> 00:35:20,520
knowing that the DC was on that 1001 we

894
00:35:20,520 --> 00:35:22,560
just did a quick pink sweep

895
00:35:22,560 --> 00:35:25,859
um and discover some other hosts dumped

896
00:35:25,859 --> 00:35:29,579
ldap uh did ntlm SMB relay with ntlm

897
00:35:29,579 --> 00:35:33,359
relay pop the shell and just got domain

898
00:35:33,359 --> 00:35:39,140
cruds with uh proc dump by dumping LSS

899
00:35:41,400 --> 00:35:43,260
so some things to avoid I touched on who

900
00:35:43,260 --> 00:35:45,300
am I before Mimi cats and I shouldn't

901
00:35:45,300 --> 00:35:48,300
have said uh Powershell Powershell used

902
00:35:48,300 --> 00:35:49,380
to

903
00:35:49,380 --> 00:35:51,359
I mean Powershell Empire was basically

904
00:35:51,359 --> 00:35:54,359
built from well it was a power View and

905
00:35:54,359 --> 00:35:57,060
then Empire when it originally was built

906
00:35:57,060 --> 00:35:59,820
because there was very little detection

907
00:35:59,820 --> 00:36:01,980
capabilities for Powershell back when it

908
00:36:01,980 --> 00:36:04,680
was created back when Powershell Empire

909
00:36:04,680 --> 00:36:06,060
was created

910
00:36:06,060 --> 00:36:09,240
uh however I mean they can pretty much

911
00:36:09,240 --> 00:36:11,160
monitor everything you're doing if you

912
00:36:11,160 --> 00:36:12,660
think about Powershell so the thing

913
00:36:12,660 --> 00:36:14,760
about Powershell and C sharp is they run

914
00:36:14,760 --> 00:36:18,780
on CLR CLR the Commerce language wow

915
00:36:18,780 --> 00:36:22,200
common language run time right uh which

916
00:36:22,200 --> 00:36:25,160
is just an intermediary so whenever you

917
00:36:25,160 --> 00:36:27,480
whenever you compile a c-sharp

918
00:36:27,480 --> 00:36:30,300
application you're not creating a a real

919
00:36:30,300 --> 00:36:32,220
portable executable you're not creating

920
00:36:32,220 --> 00:36:35,700
a real exe it says exe but it's not it's

921
00:36:35,700 --> 00:36:37,140
an assembly it's what they call an

922
00:36:37,140 --> 00:36:39,480
assembly and it's basically just a group

923
00:36:39,480 --> 00:36:41,880
of instructions that is interpreted by

924
00:36:41,880 --> 00:36:44,040
the CLR which is included on Windows 10

925
00:36:44,040 --> 00:36:46,500
you know any every major Windows version

926
00:36:46,500 --> 00:36:50,700
uh it's just interpreted by the CLR and

927
00:36:50,700 --> 00:36:52,560
then the CLR is the one that's actually

928
00:36:52,560 --> 00:36:54,420
running the machine code

929
00:36:54,420 --> 00:36:57,180
um so because of that it's relatively

930
00:36:57,180 --> 00:37:00,300
easy for EDR and basic monitoring to to

931
00:37:00,300 --> 00:37:02,220
monitor Powershell so anything that

932
00:37:02,220 --> 00:37:05,160
you're doing in there if vdr is enabled

933
00:37:05,160 --> 00:37:07,920
you're probably going to get caught uh

934
00:37:07,920 --> 00:37:10,619
one thing I would say is you know do

935
00:37:10,619 --> 00:37:13,020
your your recon to see so if you end up

936
00:37:13,020 --> 00:37:15,240
on a machine look and see where you are

937
00:37:15,240 --> 00:37:17,940
meaning are you on

938
00:37:17,940 --> 00:37:21,480
John from accounting are you on Corey

939
00:37:21,480 --> 00:37:24,599
from it are you on John strand from

940
00:37:24,599 --> 00:37:27,960
security who are you because edrs

941
00:37:27,960 --> 00:37:29,940
nowadays also have behavioral analysis

942
00:37:29,940 --> 00:37:32,460
so if they see a certain person who

943
00:37:32,460 --> 00:37:35,099
never runs Powershell run Powershell of

944
00:37:35,099 --> 00:37:36,180
course you know they're going to pick

945
00:37:36,180 --> 00:37:39,240
that up right so

946
00:37:39,240 --> 00:37:42,119
um you know it's really just about

947
00:37:42,119 --> 00:37:43,680
um

948
00:37:43,680 --> 00:37:47,280
realizing where you are uh and and being

949
00:37:47,280 --> 00:37:51,020
patient and sticking to the basics

950
00:37:51,780 --> 00:37:54,500
so

951
00:37:54,500 --> 00:37:58,260
I can't kind of uh ran through that very

952
00:37:58,260 --> 00:38:00,060
quickly

953
00:38:00,060 --> 00:38:02,040
but the point is that if you just answer

954
00:38:02,040 --> 00:38:04,079
these three questions where am I where's

955
00:38:04,079 --> 00:38:05,760
the DC where are the member servers

956
00:38:05,760 --> 00:38:08,400
you'll be in a very good position to

957
00:38:08,400 --> 00:38:10,020
formulate an attack

958
00:38:10,020 --> 00:38:11,400
which

959
00:38:11,400 --> 00:38:13,140
for me as I mentioned is almost always

960
00:38:13,140 --> 00:38:16,140
SMB relay but uh you'll be in a very

961
00:38:16,140 --> 00:38:17,880
good position to formulate your own

962
00:38:17,880 --> 00:38:18,680
attack

963
00:38:18,680 --> 00:38:22,500
you'll be able to see what different

964
00:38:22,500 --> 00:38:26,579
services are running where

965
00:38:26,579 --> 00:38:29,940
um and you'll have a much better idea of

966
00:38:29,940 --> 00:38:31,560
the active directory environment

967
00:38:31,560 --> 00:38:35,099
remember too if you if you dump out the

968
00:38:35,099 --> 00:38:36,359
app and you use that tool that we

969
00:38:36,359 --> 00:38:40,260
mentioned before you'll have a basically

970
00:38:40,260 --> 00:38:43,079
90 of the network right that you got

971
00:38:43,079 --> 00:38:45,180
without running nmap that you got

972
00:38:45,180 --> 00:38:47,220
without running a scanner just by that

973
00:38:47,220 --> 00:38:49,160
one action alone

974
00:38:49,160 --> 00:38:54,780
you're you know leaps ahead of of where

975
00:38:54,780 --> 00:38:57,060
you would normally be by making much

976
00:38:57,060 --> 00:38:59,460
more noise right

977
00:38:59,460 --> 00:39:01,320
so I really thought this was going to

978
00:39:01,320 --> 00:39:04,940
take me a lot longer it didn't

979
00:39:05,400 --> 00:39:07,460
um

980
00:39:07,619 --> 00:39:09,420
but I think that's it any questions

981
00:39:09,420 --> 00:39:11,160
thoughts

982
00:39:11,160 --> 00:39:12,839
concerns

983
00:39:12,839 --> 00:39:16,339
Yeah you mentioned this check for dmsas

984
00:39:16,339 --> 00:39:18,660
accounts what are you looking for in

985
00:39:18,660 --> 00:39:20,339
that regards just to keep to mind for

986
00:39:20,339 --> 00:39:22,800
when you brought up to the Target or

987
00:39:22,800 --> 00:39:25,200
what so by the very nature of group

988
00:39:25,200 --> 00:39:26,820
managed service accounts they are

989
00:39:26,820 --> 00:39:29,339
managed by a group right so if you're if

990
00:39:29,339 --> 00:39:31,260
you pop a show and you have that user is

991
00:39:31,260 --> 00:39:32,940
a part of that group that manages that

992
00:39:32,940 --> 00:39:36,119
service account the

993
00:39:36,119 --> 00:39:38,579
G group managed service account password

994
00:39:38,579 --> 00:39:40,619
is available to you

995
00:39:40,619 --> 00:39:41,880
right and you can grab it through

996
00:39:41,880 --> 00:39:43,260
Powershell there's a couple different

997
00:39:43,260 --> 00:39:45,420
ways you can do it the the most common

998
00:39:45,420 --> 00:39:47,760
way you see is uh

999
00:39:47,760 --> 00:39:50,640
I think it's MSDS

1000
00:39:50,640 --> 00:39:52,619
I don't remember what it is but you can

1001
00:39:52,619 --> 00:39:56,040
actually grab that that password uh and

1002
00:39:56,040 --> 00:39:57,960
use it for further attacks right so you

1003
00:39:57,960 --> 00:39:59,640
can grab that password you store it as a

1004
00:39:59,640 --> 00:40:01,920
secure blob in a Powershell variable and

1005
00:40:01,920 --> 00:40:03,960
you create a new Powershell session

1006
00:40:03,960 --> 00:40:08,339
uh using that account name and the group

1007
00:40:08,339 --> 00:40:09,839
managed service account password that

1008
00:40:09,839 --> 00:40:11,880
you just grabbed and you can essentially

1009
00:40:11,880 --> 00:40:14,099
Elevate privileges that way and become

1010
00:40:14,099 --> 00:40:15,900
whatever that account is

1011
00:40:15,900 --> 00:40:17,280
okay

1012
00:40:17,280 --> 00:40:19,980
so a lot of this really depends on the

1013
00:40:19,980 --> 00:40:22,980
property using ad how much of this

1014
00:40:22,980 --> 00:40:26,099
translates into like

1015
00:40:26,099 --> 00:40:28,680
majority

1016
00:40:28,680 --> 00:40:30,599
Azure ID is just Microsoft's computer

1017
00:40:30,599 --> 00:40:32,700
instead of theirs I mean sure there's

1018
00:40:32,700 --> 00:40:34,619
more there's there's different things

1019
00:40:34,619 --> 00:40:36,960
like uh impersonating Privileges and

1020
00:40:36,960 --> 00:40:39,180
things like that but Azure ID is really

1021
00:40:39,180 --> 00:40:42,300
just a D in the cloud I mean I'm

1022
00:40:42,300 --> 00:40:44,460
oversimplifying it but from an internal

1023
00:40:44,460 --> 00:40:47,640
penetration testing perspective it's all

1024
00:40:47,640 --> 00:40:49,260
pretty much the same there's different

1025
00:40:49,260 --> 00:40:50,940
Powershell things that you can do in

1026
00:40:50,940 --> 00:40:51,720
different

1027
00:40:51,720 --> 00:40:52,380
um

1028
00:40:52,380 --> 00:40:54,000
different properties that you can grab

1029
00:40:54,000 --> 00:40:55,920
right so

1030
00:40:55,920 --> 00:40:58,980
it's you could potentially Elevate from

1031
00:40:58,980 --> 00:41:01,140
the internal Network to their Azure

1032
00:41:01,140 --> 00:41:03,960
admin right depending on

1033
00:41:03,960 --> 00:41:05,760
how they have credentials and things

1034
00:41:05,760 --> 00:41:07,079
like that there's certain things that

1035
00:41:07,079 --> 00:41:08,760
you can do to elevate to Azure but

1036
00:41:08,760 --> 00:41:10,859
generally speaking it's just active

1037
00:41:10,859 --> 00:41:13,320
directory in the cloud for the most part

1038
00:41:13,320 --> 00:41:15,180
from it from an internal pen testing

1039
00:41:15,180 --> 00:41:17,598
perspective

1040
00:41:21,300 --> 00:41:23,760
why wouldn't it well yeah I guess so

1041
00:41:23,760 --> 00:41:26,460
sure but essentially you got to realize

1042
00:41:26,460 --> 00:41:28,619
at least nowadays even mature

1043
00:41:28,619 --> 00:41:29,940
environments

1044
00:41:29,940 --> 00:41:32,339
it's half and half you know I mean

1045
00:41:32,339 --> 00:41:34,500
they're not fully as your ad they're

1046
00:41:34,500 --> 00:41:36,780
literally just using active directory in

1047
00:41:36,780 --> 00:41:40,339
the cloud so they don't have to stand up

1048
00:41:40,440 --> 00:41:42,420
yeah pretty much

1049
00:41:42,420 --> 00:41:44,420
yeah

1050
00:41:47,960 --> 00:41:50,520
what are you looking for also that

1051
00:41:50,520 --> 00:41:54,320
relation to the ABCs

1052
00:41:54,320 --> 00:41:56,579
all right what are you looking for

1053
00:41:56,579 --> 00:41:59,880
exactly for self-site sure I just think

1054
00:41:59,880 --> 00:42:01,200
they're a valuable tool to gain

1055
00:42:01,200 --> 00:42:03,720
information about the network or I

1056
00:42:03,720 --> 00:42:05,160
should say I think they're a valuable

1057
00:42:05,160 --> 00:42:07,740
tool to gain information about the host

1058
00:42:07,740 --> 00:42:10,020
uh because if you look at if it's a

1059
00:42:10,020 --> 00:42:11,760
self-signed certificate if you're just

1060
00:42:11,760 --> 00:42:14,339
looking at an IP that that's that has a

1061
00:42:14,339 --> 00:42:16,160
web server running on 443 or something

1062
00:42:16,160 --> 00:42:18,180
initially you don't really know what

1063
00:42:18,180 --> 00:42:19,980
that is right

1064
00:42:19,980 --> 00:42:23,160
um but if you grab that SSL certificate

1065
00:42:23,160 --> 00:42:25,260
and it's self-signed say for example by

1066
00:42:25,260 --> 00:42:28,800
Cisco and it says Cisco ASA blah blah

1067
00:42:28,800 --> 00:42:31,140
blah blah self-signed certificate well

1068
00:42:31,140 --> 00:42:33,000
now you just figure you just

1069
00:42:33,000 --> 00:42:36,000
fingerprinted that that host just by an

1070
00:42:36,000 --> 00:42:39,540
SSL certificate right and then as far as

1071
00:42:39,540 --> 00:42:42,260
80 active director certificate services

1072
00:42:42,260 --> 00:42:46,619
so when a Enterprise Network

1073
00:42:46,619 --> 00:42:47,520
um

1074
00:42:47,520 --> 00:42:49,380
stands up their own certificate

1075
00:42:49,380 --> 00:42:51,780
Authority internally they use active

1076
00:42:51,780 --> 00:42:54,420
directory certificate Services right and

1077
00:42:54,420 --> 00:42:55,920
so what happens is that certificate

1078
00:42:55,920 --> 00:42:58,619
Authority for each host they that the

1079
00:42:58,619 --> 00:43:01,140
the Enterprise chooses to create a

1080
00:43:01,140 --> 00:43:05,220
certificate for that CA now becomes the

1081
00:43:05,220 --> 00:43:08,099
issuer to that certificate on that host

1082
00:43:08,099 --> 00:43:09,720
so if I'm looking at that certificate on

1083
00:43:09,720 --> 00:43:11,460
the host and I see it's some other

1084
00:43:11,460 --> 00:43:15,060
internal machine well that that's the

1085
00:43:15,060 --> 00:43:16,920
issue of the issuer of that certificate

1086
00:43:16,920 --> 00:43:18,540
well then in my head I'm thinking all

1087
00:43:18,540 --> 00:43:19,980
right they probably stood up in internal

1088
00:43:19,980 --> 00:43:24,180
CA are they using certificate services

1089
00:43:24,180 --> 00:43:25,859
okay

1090
00:43:25,859 --> 00:43:28,339
sure

1091
00:43:29,480 --> 00:43:32,780
basically this is

1092
00:43:32,880 --> 00:43:37,200
yeah so that's probably so usually I

1093
00:43:37,200 --> 00:43:39,000
just have a Powershell or not Powershell

1094
00:43:39,000 --> 00:43:41,400
python

1095
00:43:41,400 --> 00:43:43,260
ldap

1096
00:43:43,260 --> 00:43:47,099
what was it uh l-def ldap interchange

1097
00:43:47,099 --> 00:43:49,319
format I think it stands for so it has a

1098
00:43:49,319 --> 00:43:51,300
particular formatting like yaml or

1099
00:43:51,300 --> 00:43:52,800
whatever else

1100
00:43:52,800 --> 00:43:55,680
it's a pain in the ass to work with yeah

1101
00:43:55,680 --> 00:43:58,079
uh so like there's there's a python

1102
00:43:58,079 --> 00:44:01,020
packages that you can use that'll help

1103
00:44:01,020 --> 00:44:04,079
you ldap parse there's ldap3 there's

1104
00:44:04,079 --> 00:44:05,520
there's a couple of them but you can

1105
00:44:05,520 --> 00:44:06,780
basically pull it you can basically

1106
00:44:06,780 --> 00:44:08,339
create any python script using that

1107
00:44:08,339 --> 00:44:10,560
package just open the file and then

1108
00:44:10,560 --> 00:44:13,520
parse it and it basically gives you a

1109
00:44:13,520 --> 00:44:18,000
dictionary of the ldap so then you can

1110
00:44:18,000 --> 00:44:19,980
like search the OU or whatever you're

1111
00:44:19,980 --> 00:44:22,800
looking for okay

1112
00:44:22,800 --> 00:44:26,640
gonna reverse BNS like or being forcing

1113
00:44:26,640 --> 00:44:28,700
quiet or not because

1114
00:44:28,700 --> 00:44:29,960
[Music]

1115
00:44:29,960 --> 00:44:32,940
so yeah so what one of the things I do

1116
00:44:32,940 --> 00:44:36,420
to find the host on the domain

1117
00:44:36,420 --> 00:44:38,400
I I'll do a like Guinness proposing

1118
00:44:38,400 --> 00:44:40,859
against the word list and then I do like

1119
00:44:40,859 --> 00:44:43,800
Risk finesse from our students and then

1120
00:44:43,800 --> 00:44:45,780
you know

1121
00:44:45,780 --> 00:44:49,020
yeah they tend not to be monitored but I

1122
00:44:49,020 --> 00:44:52,339
just want to see what the experience was

1123
00:44:52,500 --> 00:44:56,940
it wasn't funny yeah so I usually if I'm

1124
00:44:56,940 --> 00:44:58,200
doing

1125
00:44:58,200 --> 00:45:01,140
DNS brute forcing most of the time I'm

1126
00:45:01,140 --> 00:45:02,579
looking for subdomains is that what

1127
00:45:02,579 --> 00:45:03,720
you're looking for

1128
00:45:03,720 --> 00:45:06,540
well it doesn't matter yeah yeah uh I

1129
00:45:06,540 --> 00:45:08,579
use fuzz faster I don't know if you ever

1130
00:45:08,579 --> 00:45:11,940
use that ffuf plus faster plus faster

1131
00:45:11,940 --> 00:45:15,300
you fool is what it's called Uh no well

1132
00:45:15,300 --> 00:45:18,480
I guess it depends because

1133
00:45:18,480 --> 00:45:22,319
it depends on where that host is

1134
00:45:22,319 --> 00:45:24,780
um so the common way to I'm not sure if

1135
00:45:24,780 --> 00:45:26,160
that's how you do it but the common way

1136
00:45:26,160 --> 00:45:29,579
to brute force subdomains is to change

1137
00:45:29,579 --> 00:45:32,760
the host header when you're sending it

1138
00:45:32,760 --> 00:45:35,339
to that that host right so you're

1139
00:45:35,339 --> 00:45:37,319
sending it to google.com but the host

1140
00:45:37,319 --> 00:45:40,079
header says subdomain.google.com and you

1141
00:45:40,079 --> 00:45:42,359
just run through it right so depending

1142
00:45:42,359 --> 00:45:43,740
on where that host is located and if

1143
00:45:43,740 --> 00:45:45,480
it's monitored I'm sure they probably

1144
00:45:45,480 --> 00:45:47,099
would

1145
00:45:47,099 --> 00:45:48,960
see it

1146
00:45:48,960 --> 00:45:50,160
um I guess it depends on how big the

1147
00:45:50,160 --> 00:45:51,480
list is like if you're doing like a

1148
00:45:51,480 --> 00:45:53,460
million well

1149
00:45:53,460 --> 00:45:55,680
yeah but if you're doing like a thousand

1150
00:45:55,680 --> 00:45:57,420
or so I don't think I don't think so

1151
00:45:57,420 --> 00:45:59,040
I've never gotten

1152
00:45:59,040 --> 00:46:00,420
busted

1153
00:46:00,420 --> 00:46:02,099
so you'd probably get I bet you get

1154
00:46:02,099 --> 00:46:05,180
failed a band before anything

1155
00:46:06,660 --> 00:46:07,800
no really

1156
00:46:07,800 --> 00:46:09,720
you know

1157
00:46:09,720 --> 00:46:11,940
good question from online are you

1158
00:46:11,940 --> 00:46:13,980
familiar with pink castle and if so

1159
00:46:13,980 --> 00:46:15,960
would you say that's quiet does that fit

1160
00:46:15,960 --> 00:46:18,240
in these categories here I am not I'm

1161
00:46:18,240 --> 00:46:21,359
not I'm not sure what pink castle pink

1162
00:46:21,359 --> 00:46:23,579
castle Yeah I believe it's an uh ad

1163
00:46:23,579 --> 00:46:25,560
scanner on the same category as

1164
00:46:25,560 --> 00:46:29,099
Bloodhound oh yes uh

1165
00:46:29,099 --> 00:46:31,380
I've only messed with it once or twice

1166
00:46:31,380 --> 00:46:33,720
so I wouldn't really

1167
00:46:33,720 --> 00:46:35,760
say yes or no what I would say is keep

1168
00:46:35,760 --> 00:46:37,819
in mind when you're doing any of those

1169
00:46:37,819 --> 00:46:40,020
types of reconnaissance like blood

1170
00:46:40,020 --> 00:46:42,660
Bloodhound or similar

1171
00:46:42,660 --> 00:46:45,119
it's still calling out so specifically

1172
00:46:45,119 --> 00:46:46,920
for the local group policies it's still

1173
00:46:46,920 --> 00:46:48,480
calling out to each individual machine

1174
00:46:48,480 --> 00:46:50,940
so what I would say is anything that's

1175
00:46:50,940 --> 00:46:52,380
still looking for the local group

1176
00:46:52,380 --> 00:46:55,319
policies or has to query each individual

1177
00:46:55,319 --> 00:46:58,500
machine I would say probably is not

1178
00:46:58,500 --> 00:47:00,660
quiet

1179
00:47:00,660 --> 00:47:04,920
yeah I mean I've seen it I maybe that's

1180
00:47:04,920 --> 00:47:08,720
why I didn't keep looking at it because

1181
00:47:11,400 --> 00:47:13,260
yeah like in place of like uh Bloodhound

1182
00:47:13,260 --> 00:47:15,480
Enterprise or something like are they

1183
00:47:15,480 --> 00:47:18,140
mapping it out

1184
00:47:29,880 --> 00:47:31,740
yeah I mean I remember seeing it but

1185
00:47:31,740 --> 00:47:33,240
honestly I've never looked into it and

1186
00:47:33,240 --> 00:47:36,799
maybe that was why I don't know

1187
00:47:41,099 --> 00:47:42,180
yeah

1188
00:47:42,180 --> 00:47:44,839
makes sense

1189
00:47:50,480 --> 00:47:54,180
client to like look at this wall

1190
00:47:54,180 --> 00:47:56,880
so yeah it depends where honestly most

1191
00:47:56,880 --> 00:47:58,800
time I just Mount sysfall five creds

1192
00:47:58,800 --> 00:48:00,540
domain credits I'll usually just mount

1193
00:48:00,540 --> 00:48:01,920
it

1194
00:48:01,920 --> 00:48:05,579
um and just poke around do you find I

1195
00:48:05,579 --> 00:48:07,440
still look for C passwords because it's

1196
00:48:07,440 --> 00:48:11,760
1998 I guess uh but uh I just my I

1197
00:48:11,760 --> 00:48:13,680
literally mount it if I'm if I'm if I'm

1198
00:48:13,680 --> 00:48:16,020
on a Linux machine that's not domain

1199
00:48:16,020 --> 00:48:17,700
joined I'll just mount it and look

1200
00:48:17,700 --> 00:48:20,040
through if I'm on a domain joined one I

1201
00:48:20,040 --> 00:48:21,720
will literally

1202
00:48:21,720 --> 00:48:23,880
go to Windows Explorer and just click

1203
00:48:23,880 --> 00:48:26,700
around because I'm afraid and I've been

1204
00:48:26,700 --> 00:48:29,280
caught by running a find in the command

1205
00:48:29,280 --> 00:48:31,740
line by EDR carbon black and Crosstrek

1206
00:48:31,740 --> 00:48:35,040
are pain in the ass right and so anytime

1207
00:48:35,040 --> 00:48:36,599
I can do something manually I'm going to

1208
00:48:36,599 --> 00:48:39,619
do it that way

1209
00:48:45,180 --> 00:48:47,760
security controls that might frustrate

1210
00:48:47,760 --> 00:48:50,420
your pathology

1211
00:48:53,099 --> 00:48:57,660
firewalls for one yeah

1212
00:48:58,140 --> 00:49:00,540
um well remember so at least what I

1213
00:49:00,540 --> 00:49:02,280
talked about today a lot of it relied on

1214
00:49:02,280 --> 00:49:04,440
pink sweep so what if they turn off icmp

1215
00:49:04,440 --> 00:49:06,359
right well then it gets a little bit

1216
00:49:06,359 --> 00:49:08,520
more complicated right

1217
00:49:08,520 --> 00:49:11,220
um so then I would think well

1218
00:49:11,220 --> 00:49:13,140
what's the common Port that should be

1219
00:49:13,140 --> 00:49:15,480
open so instead of a pink sweep I'll

1220
00:49:15,480 --> 00:49:20,099
literally do just a quick netcat on Port

1221
00:49:20,099 --> 00:49:22,680
um like SMB or something something that

1222
00:49:22,680 --> 00:49:25,380
I think would almost always be open on

1223
00:49:25,380 --> 00:49:28,319
that particular host or

1224
00:49:28,319 --> 00:49:30,660
and host an active directory if there's

1225
00:49:30,660 --> 00:49:32,640
a port that I know will most likely be

1226
00:49:32,640 --> 00:49:34,800
open instead of doing a pink sweep I'll

1227
00:49:34,800 --> 00:49:36,540
just sweep each host for that port to

1228
00:49:36,540 --> 00:49:38,339
see if it's open usually just using

1229
00:49:38,339 --> 00:49:40,740
netcat or something somewhere but that's

1230
00:49:40,740 --> 00:49:42,119
usually the biggest one and then the

1231
00:49:42,119 --> 00:49:44,720
firewalls Cisco ASAS

1232
00:49:44,720 --> 00:49:47,760
seem to always

1233
00:49:47,760 --> 00:49:48,599
um

1234
00:49:48,599 --> 00:49:50,220
cause a lot of issues with stuff like

1235
00:49:50,220 --> 00:49:52,760
that because the Asa

1236
00:49:52,760 --> 00:49:56,040
is almost always there's always

1237
00:49:56,040 --> 00:49:58,260
I've come across a lot of ASAS that I

1238
00:49:58,260 --> 00:50:00,839
did not like and not necessarily because

1239
00:50:00,839 --> 00:50:04,020
they were stopping what I was doing

1240
00:50:04,020 --> 00:50:07,560
but because what they they weren't doing

1241
00:50:07,560 --> 00:50:09,540
what they're supposed to do well

1242
00:50:09,540 --> 00:50:12,359
right so meaning if I did like a

1243
00:50:12,359 --> 00:50:14,160
broadcast I shouldn't either I should

1244
00:50:14,160 --> 00:50:15,000
either

1245
00:50:15,000 --> 00:50:18,060
get like a couple pings back from the

1246
00:50:18,060 --> 00:50:19,260
firewall

1247
00:50:19,260 --> 00:50:22,560
or nothing or if there's a vulnerable

1248
00:50:22,560 --> 00:50:24,300
host that would ping back too but the

1249
00:50:24,300 --> 00:50:25,980
point is that Cisco just keeps coming

1250
00:50:25,980 --> 00:50:27,780
and keeps coming and keeps sending them

1251
00:50:27,780 --> 00:50:29,520
send them some of them and it never

1252
00:50:29,520 --> 00:50:31,440
stops so like even if you did like slash

1253
00:50:31,440 --> 00:50:34,020
24 it just keeps flooding you because

1254
00:50:34,020 --> 00:50:35,460
it's

1255
00:50:35,460 --> 00:50:38,520
it doesn't know like it's not

1256
00:50:38,520 --> 00:50:40,440
I don't know what else to say it's not

1257
00:50:40,440 --> 00:50:43,800
it's not engineered well and so it

1258
00:50:43,800 --> 00:50:45,420
doesn't realize okay I need to stop

1259
00:50:45,420 --> 00:50:46,920
doing this and just keeps doing it

1260
00:50:46,920 --> 00:50:49,380
actually there's been a number of times

1261
00:50:49,380 --> 00:50:52,200
where we've had to make sure that we did

1262
00:50:52,200 --> 00:50:56,400
full TCP scans not syn scans full TCP

1263
00:50:56,400 --> 00:50:58,859
scans unlike a vulnerability assessment

1264
00:50:58,859 --> 00:51:02,520
before because the ASA couldn't handle

1265
00:51:02,520 --> 00:51:04,920
the half open connections right we're

1266
00:51:04,920 --> 00:51:06,480
talking about firewalls and security

1267
00:51:06,480 --> 00:51:08,280
appliances that are

1268
00:51:08,280 --> 00:51:10,200
you know they're not old I mean there's

1269
00:51:10,200 --> 00:51:11,880
some that are old but they should be

1270
00:51:11,880 --> 00:51:13,440
able to handle a synth scan no problem

1271
00:51:13,440 --> 00:51:15,300
but they don't

1272
00:51:15,300 --> 00:51:18,599
um and so really the the only time I've

1273
00:51:18,599 --> 00:51:20,940
gotten angry or frustrated was usually

1274
00:51:20,940 --> 00:51:23,339
when there's an essay there

1275
00:51:23,339 --> 00:51:24,839
it's because misconfigured or it just

1276
00:51:24,839 --> 00:51:27,500
doesn't work right

1277
00:51:32,280 --> 00:51:34,700
cool

1278
00:51:35,400 --> 00:51:37,670
good I think that's it thanks

1279
00:51:37,670 --> 00:51:40,769
[Applause]

