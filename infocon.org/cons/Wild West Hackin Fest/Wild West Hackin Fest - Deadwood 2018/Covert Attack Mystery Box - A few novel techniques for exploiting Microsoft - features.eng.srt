1
00:00:00,100 --> 00:00:08,480
[Music]

2
00:00:08,660 --> 00:00:15,299
hello everyone welcome<font color="#CCCCCC"> to</font><font color="#E5E5E5"> the covert</font>

3
00:00:13,650 --> 00:00:16,890
attack mystery box talk I hope that's

4
00:00:15,299 --> 00:00:19,140
the<font color="#CCCCCC"> one you expect it to</font><font color="#E5E5E5"> be</font><font color="#CCCCCC"> in</font><font color="#E5E5E5"> because</font>

5
00:00:16,890 --> 00:00:22,020
that's<font color="#E5E5E5"> where you're at so Mike and I</font>

6
00:00:19,140 --> 00:00:23,460
started<font color="#E5E5E5"> working on this talk</font><font color="#CCCCCC"> I don't</font>

7
00:00:22,020 --> 00:00:24,660
know maybe half a year<font color="#CCCCCC"> ago and it</font>

8
00:00:23,460 --> 00:00:26,039
started<font color="#CCCCCC"> out as a completely</font><font color="#E5E5E5"> different</font>

9
00:00:24,660 --> 00:00:27,599
<font color="#E5E5E5">idea we were trying to go with</font><font color="#CCCCCC"> a mining</font>

10
00:00:26,039 --> 00:00:29,609
theme and so we started<font color="#E5E5E5"> out with like a</font>

11
00:00:27,599 --> 00:00:30,539
<font color="#CCCCCC">cryptocurrency</font><font color="#E5E5E5"> kind of thing but then we</font>

12
00:00:29,609 --> 00:00:31,500
decided<font color="#E5E5E5"> that we wanted work on some</font>

13
00:00:30,539 --> 00:00:34,559
other<font color="#CCCCCC"> stuff when we</font><font color="#E5E5E5"> came</font><font color="#CCCCCC"> up with</font><font color="#E5E5E5"> a bunch</font>

14
00:00:31,500 --> 00:00:37,800
<font color="#E5E5E5">of other really kind of novel techniques</font>

15
00:00:34,559 --> 00:00:39,480
that we kind of<font color="#E5E5E5"> threw</font><font color="#CCCCCC"> together and so I</font>

16
00:00:37,800 --> 00:00:41,339
was like hey<font color="#CCCCCC"> I've never liked a</font>

17
00:00:39,480 --> 00:00:42,629
subscription box<font color="#E5E5E5"> like these like loot</font>

18
00:00:41,340 --> 00:00:44,399
crate's you know never heard of<font color="#E5E5E5"> them</font>

19
00:00:42,629 --> 00:00:46,440
like what if we threw<font color="#E5E5E5"> together like a</font>

20
00:00:44,399 --> 00:00:49,829
loot<font color="#E5E5E5"> creative sorts of Microsoft</font>

21
00:00:46,440 --> 00:00:52,649
exploits so I had to look<font color="#E5E5E5"> up</font><font color="#CCCCCC"> what loot</font>

22
00:00:49,829 --> 00:00:54,270
crate was I had<font color="#CCCCCC"> no idea</font><font color="#E5E5E5"> and and I was</font>

23
00:00:52,649 --> 00:00:55,680
fascinated<font color="#CCCCCC"> with it and so we decided</font><font color="#E5E5E5"> to</font>

24
00:00:54,270 --> 00:00:57,360
<font color="#E5E5E5">go</font><font color="#CCCCCC"> with that so</font><font color="#E5E5E5"> that's kind of this is</font>

25
00:00:55,680 --> 00:00:59,340
it's a mystery box<font color="#CCCCCC"> you're at the live</font>

26
00:00:57,360 --> 00:01:01,170
unboxing<font color="#E5E5E5"> of our little mystery box we're</font>

27
00:00:59,340 --> 00:01:02,280
gonna we're gonna show<font color="#E5E5E5"> you a bunch of</font>

28
00:01:01,170 --> 00:01:04,439
stuff we've been<font color="#E5E5E5"> working</font><font color="#CCCCCC"> on</font><font color="#E5E5E5"> over the</font>

29
00:01:02,280 --> 00:01:08,540
last<font color="#E5E5E5"> few years and</font><font color="#CCCCCC"> why mainly</font><font color="#E5E5E5"> last year</font>

30
00:01:04,438 --> 00:01:13,189
<font color="#E5E5E5">last couple weeks even so who are we</font>

31
00:01:08,540 --> 00:01:18,119
<font color="#E5E5E5">Mike felch you stay already on Twitter</font>

32
00:01:13,189 --> 00:01:22,919
<font color="#CCCCCC">some</font><font color="#E5E5E5"> of pentester red teamer with with</font>

33
00:01:18,119 --> 00:01:24,990
<font color="#E5E5E5">Black Hills closer and yeah so I was</font>

34
00:01:22,920 --> 00:01:27,330
<font color="#E5E5E5">involved with a wasp Orlando for a while</font>

35
00:01:24,990 --> 00:01:31,619
and<font color="#CCCCCC"> still</font><font color="#E5E5E5"> technically involved with my</font>

36
00:01:27,330 --> 00:01:33,658
friends from besides Orlando<font color="#CCCCCC"> and with Bo</font>

37
00:01:31,619 --> 00:01:34,979
we do<font color="#CCCCCC"> trade craft security or actually</font>

38
00:01:33,659 --> 00:01:36,810
he does trade craft security weekly I

39
00:01:34,979 --> 00:01:39,658
just kind<font color="#E5E5E5"> of piggyback it</font><font color="#CCCCCC"> whatever kind</font>

40
00:01:36,810 --> 00:01:40,860
of<font color="#E5E5E5"> cool</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> then we both are co-hosts of</font>

41
00:01:39,659 --> 00:01:42,720
<font color="#E5E5E5">coin</font><font color="#CCCCCC"> sec podcast which is a</font>

42
00:01:40,860 --> 00:01:45,360
cryptocurrency<font color="#E5E5E5"> we just</font><font color="#CCCCCC"> talked about</font><font color="#E5E5E5"> the</font>

43
00:01:42,720 --> 00:01:47,700
<font color="#E5E5E5">security implications of it and whatever</font>

44
00:01:45,360 --> 00:01:50,399
so yep and I'm Bo Bullock

45
00:01:47,700 --> 00:01:51,720
<font color="#E5E5E5">Daft tack on Twitter</font><font color="#CCCCCC"> also pentester red</font>

46
00:01:50,399 --> 00:01:53,549
<font color="#E5E5E5">teamer at Black Hills information</font>

47
00:01:51,720 --> 00:01:55,350
security and like I said<font color="#CCCCCC"> we do</font><font color="#E5E5E5"> a few</font>

48
00:01:53,549 --> 00:01:57,750
<font color="#CCCCCC">podcasts and I'm Anna I always include</font>

49
00:01:55,350 --> 00:02:00,030
this avid<font color="#CCCCCC"> OA enthusiast in my profile</font>

50
00:01:57,750 --> 00:02:02,729
<font color="#CCCCCC">because that's</font><font color="#E5E5E5"> just what I like to focus</font>

51
00:02:00,030 --> 00:02:04,110
<font color="#E5E5E5">on it's fun fun stuff so what are we</font>

52
00:02:02,729 --> 00:02:05,369
covering today so like I<font color="#CCCCCC"> said it's gonna</font>

53
00:02:04,110 --> 00:02:07,829
be a mystery box of sorts we're gonna

54
00:02:05,369 --> 00:02:08,610
have a<font color="#E5E5E5"> bunch of items</font><font color="#CCCCCC"> that I'm not gonna</font>

55
00:02:07,829 --> 00:02:10,410
<font color="#E5E5E5">tell you what they are right now I'll</font>

56
00:02:08,610 --> 00:02:12,000
tell<font color="#CCCCCC"> you</font><font color="#E5E5E5"> like I'll give you this</font><font color="#CCCCCC"> there's</font>

57
00:02:10,410 --> 00:02:12,910
one that's got to<font color="#CCCCCC"> do</font><font color="#E5E5E5"> with attribution</font>

58
00:02:12,000 --> 00:02:14,890
there's one that

59
00:02:12,910 --> 00:02:16,150
to do<font color="#E5E5E5"> with recon there's some</font>

60
00:02:14,890 --> 00:02:17,829
persistence which actually that third

61
00:02:16,150 --> 00:02:20,410
one is more like a persistent<font color="#E5E5E5"> slash</font>

62
00:02:17,830 --> 00:02:22,390
exploitation method and then the<font color="#CCCCCC"> fourth</font>

63
00:02:20,410 --> 00:02:25,090
<font color="#CCCCCC">one is</font><font color="#E5E5E5"> I think it's like the candy</font><font color="#CCCCCC"> of</font>

64
00:02:22,390 --> 00:02:29,049
all this it's like<font color="#E5E5E5"> that the gym that's</font>

65
00:02:25,090 --> 00:02:31,240
<font color="#E5E5E5">pretty cool yeah</font><font color="#CCCCCC"> so and I don't know if</font>

66
00:02:29,050 --> 00:02:33,970
we're gonna<font color="#E5E5E5"> have time for questions</font><font color="#CCCCCC"> so I</font>

67
00:02:31,240 --> 00:02:35,500
think<font color="#E5E5E5"> if you want to write</font><font color="#CCCCCC"> down a note</font>

68
00:02:33,970 --> 00:02:37,840
<font color="#CCCCCC">and find us afterwards we're</font><font color="#E5E5E5"> gonna cover</font>

69
00:02:35,500 --> 00:02:40,600
a lot<font color="#E5E5E5"> of stuff in this talk and it's</font>

70
00:02:37,840 --> 00:02:42,070
gonna be<font color="#E5E5E5"> very content filled so we're</font>

71
00:02:40,600 --> 00:02:43,480
gonna try<font color="#CCCCCC"> to</font><font color="#E5E5E5"> get through it as quick as</font>

72
00:02:42,070 --> 00:02:46,150
we<font color="#E5E5E5"> can so hopefully we'll have some time</font>

73
00:02:43,480 --> 00:02:46,540
for questions<font color="#CCCCCC"> but just yeah</font><font color="#E5E5E5"> write them</font>

74
00:02:46,150 --> 00:02:49,360
<font color="#E5E5E5">down</font>

75
00:02:46,540 --> 00:02:51,880
find us later<font color="#CCCCCC"> we'll</font><font color="#E5E5E5"> be around okay so</font>

76
00:02:49,360 --> 00:02:54,660
mystery box item number one<font color="#E5E5E5"> the curious</font>

77
00:02:51,880 --> 00:02:57,850
case of event logs with no attribution

78
00:02:54,660 --> 00:02:59,579
okay so at Black Hills we work with a

79
00:02:57,850 --> 00:03:02,590
lot of<font color="#E5E5E5"> different</font><font color="#CCCCCC"> customers with very</font>

80
00:02:59,580 --> 00:03:03,880
extremely<font color="#E5E5E5"> vast different ways that they</font>

81
00:03:02,590 --> 00:03:05,860
go<font color="#E5E5E5"> about logging things we work with</font>

82
00:03:03,880 --> 00:03:07,510
some customers who do basically<font color="#E5E5E5"> no</font>

83
00:03:05,860 --> 00:03:08,980
logging<font color="#E5E5E5"> at all they don't have</font><font color="#CCCCCC"> any</font>

84
00:03:07,510 --> 00:03:10,359
visibility<font color="#E5E5E5"> into what's</font><font color="#CCCCCC"> happening on</font>

85
00:03:08,980 --> 00:03:12,369
their<font color="#E5E5E5"> endpoints</font><font color="#CCCCCC"> what's happening on</font>

86
00:03:10,360 --> 00:03:13,600
<font color="#E5E5E5">their domain</font><font color="#CCCCCC"> and then we work with the</font>

87
00:03:12,370 --> 00:03:14,440
extreme<font color="#E5E5E5"> other side of things</font><font color="#CCCCCC"> where we</font>

88
00:03:13,600 --> 00:03:16,480
<font color="#CCCCCC">have customers that</font><font color="#E5E5E5"> are logging</font>

89
00:03:14,440 --> 00:03:18,640
literally every single<font color="#CCCCCC"> thing you</font><font color="#E5E5E5"> could</font>

90
00:03:16,480 --> 00:03:19,959
<font color="#CCCCCC">have</font><font color="#E5E5E5"> possibly</font><font color="#CCCCCC"> imagined</font><font color="#E5E5E5"> on on their</font>

91
00:03:18,640 --> 00:03:22,570
systems and<font color="#E5E5E5"> on their network and they're</font>

92
00:03:19,959 --> 00:03:24,250
alerting on all kinds of<font color="#E5E5E5"> stuff</font><font color="#CCCCCC"> so one of</font>

93
00:03:22,570 --> 00:03:25,959
<font color="#E5E5E5">the things that we do on pretty much</font>

94
00:03:24,250 --> 00:03:27,010
every<font color="#CCCCCC"> pin test is password</font><font color="#E5E5E5"> spraying</font>

95
00:03:25,959 --> 00:03:29,260
attacks you've probably heard us talk

96
00:03:27,010 --> 00:03:30,549
<font color="#CCCCCC">about it in</font><font color="#E5E5E5"> every single</font><font color="#CCCCCC"> webcast every</font>

97
00:03:29,260 --> 00:03:32,109
single talk we've ever done<font color="#CCCCCC"> because it's</font>

98
00:03:30,550 --> 00:03:34,000
just it's so successful<font color="#CCCCCC"> for us it's</font>

99
00:03:32,110 --> 00:03:34,959
<font color="#CCCCCC">something we do all the time if you</font>

100
00:03:34,000 --> 00:03:37,990
haven't<font color="#CCCCCC"> heard to talk about it the</font>

101
00:03:34,959 --> 00:03:40,540
<font color="#E5E5E5">concept is</font><font color="#CCCCCC"> basically we run one password</font>

102
00:03:37,990 --> 00:03:42,100
attempt per user<font color="#E5E5E5"> for</font><font color="#CCCCCC"> every</font><font color="#E5E5E5"> single user</font>

103
00:03:40,540 --> 00:03:44,350
so the idea would<font color="#CCCCCC"> be like I'll take the</font>

104
00:03:42,100 --> 00:03:45,850
password winter 2018 and<font color="#E5E5E5"> I'll try it</font>

105
00:03:44,350 --> 00:03:47,680
<font color="#E5E5E5">against every user in</font><font color="#CCCCCC"> your domain and</font>

106
00:03:45,850 --> 00:03:49,450
<font color="#E5E5E5">that way I'm not gonna lock anyone out</font>

107
00:03:47,680 --> 00:03:50,680
<font color="#E5E5E5">but it gives me a greater chance of</font>

108
00:03:49,450 --> 00:03:52,390
<font color="#E5E5E5">finding somebody who has that</font><font color="#CCCCCC"> weak</font>

109
00:03:50,680 --> 00:03:54,040
password and potentially I'll be able<font color="#E5E5E5"> to</font>

110
00:03:52,390 --> 00:03:56,619
<font color="#E5E5E5">use</font><font color="#CCCCCC"> that</font><font color="#E5E5E5"> account for</font><font color="#CCCCCC"> other things on</font>

111
00:03:54,040 --> 00:03:58,239
your<font color="#E5E5E5"> domain</font><font color="#CCCCCC"> so one of</font><font color="#E5E5E5"> the tools that I</font>

112
00:03:56,620 --> 00:03:59,650
wrote it's<font color="#CCCCCC"> pass</font><font color="#E5E5E5"> for a password spraying</font>

113
00:03:58,239 --> 00:04:01,870
tool<font color="#E5E5E5"> in PowerShell called domain</font>

114
00:03:59,650 --> 00:04:03,220
passwords<font color="#CCCCCC"> breath so this script is</font>

115
00:04:01,870 --> 00:04:05,650
something that<font color="#CCCCCC"> basically just hits your</font>

116
00:04:03,220 --> 00:04:07,570
DC and we<font color="#CCCCCC"> had a customer that</font><font color="#E5E5E5"> alerted on</font>

117
00:04:05,650 --> 00:04:10,989
this a very awesome<font color="#E5E5E5"> customer who</font>

118
00:04:07,570 --> 00:04:13,329
<font color="#CCCCCC">actually is here and</font><font color="#E5E5E5"> they say they</font>

119
00:04:10,989 --> 00:04:15,190
alerted<font color="#E5E5E5"> on this and we started looking</font>

120
00:04:13,330 --> 00:04:17,650
<font color="#E5E5E5">at the events they were generating</font><font color="#CCCCCC"> and</font>

121
00:04:15,190 --> 00:04:19,510
trying to just I don't<font color="#E5E5E5"> know maybe try to</font>

122
00:04:17,649 --> 00:04:21,640
get around that somehow like<font color="#E5E5E5"> we tried to</font>

123
00:04:19,510 --> 00:04:24,880
work<font color="#E5E5E5"> we were on a purple team and we're</font>

124
00:04:21,640 --> 00:04:25,860
trying to find ways<font color="#E5E5E5"> to evade that</font>

125
00:04:24,880 --> 00:04:27,840
detection like

126
00:04:25,860 --> 00:04:29,789
what's another way we could<font color="#CCCCCC"> perform the</font>

127
00:04:27,840 --> 00:04:33,659
same type of<font color="#E5E5E5"> activity</font><font color="#CCCCCC"> like password</font>

128
00:04:29,789 --> 00:04:35,849
spraying and<font color="#CCCCCC"> a nugget cot</font><font color="#E5E5E5"> so what are</font>

129
00:04:33,659 --> 00:04:37,319
some other protocols<font color="#CCCCCC"> on your network</font>

130
00:04:35,849 --> 00:04:39,659
<font color="#CCCCCC">that are using Active Directory</font>

131
00:04:37,319 --> 00:04:41,129
authentication<font color="#E5E5E5"> that we could try to hit</font>

132
00:04:39,659 --> 00:04:43,710
so one of the ones that first came to

133
00:04:41,129 --> 00:04:46,409
mind was<font color="#E5E5E5"> a</font><font color="#CCCCCC"> oh uh yeah well I'm an avid</font>

134
00:04:43,710 --> 00:04:48,840
enthusiast so what about<font color="#E5E5E5"> it</font><font color="#CCCCCC"> so Outlook</font>

135
00:04:46,409 --> 00:04:50,669
Web Access actually<font color="#E5E5E5"> logs at</font><font color="#CCCCCC"> iis and not</font>

136
00:04:48,840 --> 00:04:51,599
in the<font color="#CCCCCC"> windows</font><font color="#E5E5E5"> security logs where a lot</font>

137
00:04:50,669 --> 00:04:53,250
of<font color="#E5E5E5"> people</font><font color="#CCCCCC"> are looking a lot</font><font color="#E5E5E5"> of</font>

138
00:04:51,599 --> 00:04:54,389
<font color="#E5E5E5">organizations</font><font color="#CCCCCC"> are just looking</font><font color="#E5E5E5"> at</font><font color="#CCCCCC"> the</font>

139
00:04:53,250 --> 00:04:58,229
<font color="#E5E5E5">windows security event logs for failed</font>

140
00:04:54,389 --> 00:04:59,819
logins<font color="#E5E5E5"> and it's so you know that's one</font>

141
00:04:58,229 --> 00:05:01,650
<font color="#E5E5E5">of those things that's like that works</font>

142
00:04:59,819 --> 00:05:04,409
to get<font color="#E5E5E5"> around if you're just</font><font color="#CCCCCC"> looking at</font>

143
00:05:01,650 --> 00:05:05,758
the<font color="#CCCCCC"> Windows security vent logs</font><font color="#E5E5E5"> but like</font>

144
00:05:04,409 --> 00:05:07,349
all of you<font color="#E5E5E5"> there here we have a lot</font><font color="#CCCCCC"> of</font>

145
00:05:05,759 --> 00:05:08,580
customers who come to our talks and see

146
00:05:07,349 --> 00:05:10,590
us talk about<font color="#E5E5E5"> things like nail sniper</font>

147
00:05:08,580 --> 00:05:12,659
and other<font color="#E5E5E5"> tools that we've written and</font>

148
00:05:10,590 --> 00:05:13,739
<font color="#CCCCCC">we've can't come</font><font color="#E5E5E5"> up</font><font color="#CCCCCC"> with people or we've</font>

149
00:05:12,659 --> 00:05:16,289
<font color="#CCCCCC">had organizations</font><font color="#E5E5E5"> that detect this</font>

150
00:05:13,740 --> 00:05:17,930
<font color="#E5E5E5">already and so</font><font color="#CCCCCC"> we're</font><font color="#E5E5E5"> like</font><font color="#CCCCCC"> okay well</font>

151
00:05:16,289 --> 00:05:20,520
where else<font color="#E5E5E5"> could we try authenticating</font>

152
00:05:17,930 --> 00:05:21,960
what<font color="#E5E5E5"> about RDP you know like what does</font>

153
00:05:20,520 --> 00:05:25,830
RDP look like if you<font color="#E5E5E5"> try to pass through</font>

154
00:05:21,960 --> 00:05:27,719
<font color="#CCCCCC">sorry RDP so we tested with ex-free RDP</font>

155
00:05:25,830 --> 00:05:29,669
<font color="#CCCCCC">which is a Linux tool against against</font>

156
00:05:27,719 --> 00:05:30,930
<font color="#E5E5E5">the against the RDP server and we</font>

157
00:05:29,669 --> 00:05:33,539
<font color="#E5E5E5">started looking at</font><font color="#CCCCCC"> some</font><font color="#E5E5E5"> of the logs and</font>

158
00:05:30,930 --> 00:05:36,690
to our surprise<font color="#E5E5E5"> there was</font><font color="#CCCCCC"> no IP address</font>

159
00:05:33,539 --> 00:05:39,089
of this source<font color="#E5E5E5"> of the attacker</font><font color="#CCCCCC"> in the</font>

160
00:05:36,690 --> 00:05:41,490
end the logs and the event logs okay

161
00:05:39,089 --> 00:05:43,409
that's kind of<font color="#E5E5E5"> weird the host name was</font>

162
00:05:41,490 --> 00:05:45,270
there and in the event log<font color="#E5E5E5"> is as a</font>

163
00:05:43,409 --> 00:05:47,129
failed login<font color="#E5E5E5"> but there was no IP address</font>

164
00:05:45,270 --> 00:05:49,049
<font color="#E5E5E5">and so I started looking at</font><font color="#CCCCCC"> some of</font><font color="#E5E5E5"> the</font>

165
00:05:47,129 --> 00:05:50,610
<font color="#CCCCCC">options 4x4 ITP</font><font color="#E5E5E5"> and there's actually an</font>

166
00:05:49,050 --> 00:05:54,240
option<font color="#E5E5E5"> in there to set the client</font>

167
00:05:50,610 --> 00:05:56,009
<font color="#E5E5E5">hostname</font><font color="#CCCCCC"> too so not</font><font color="#E5E5E5"> only can I not have</font>

168
00:05:54,240 --> 00:05:57,389
<font color="#E5E5E5">my IP analogs but I can set my</font><font color="#CCCCCC"> hostname</font>

169
00:05:56,009 --> 00:05:59,310
to whatever I want it to<font color="#E5E5E5"> be okay</font>

170
00:05:57,389 --> 00:06:01,139
so<font color="#E5E5E5"> we started</font><font color="#CCCCCC"> looking at how could we</font>

171
00:05:59,310 --> 00:06:03,689
password spray<font color="#E5E5E5"> using that kind</font><font color="#CCCCCC"> of method</font>

172
00:06:01,139 --> 00:06:05,490
<font color="#CCCCCC">and in doing</font><font color="#E5E5E5"> some more research</font><font color="#CCCCCC"> I</font>

173
00:06:03,689 --> 00:06:08,129
learned<font color="#E5E5E5"> more about in</font><font color="#CCCCCC"> L a network layer</font>

174
00:06:05,490 --> 00:06:09,740
authentication<font color="#E5E5E5"> so RDP servers that</font>

175
00:06:08,129 --> 00:06:12,330
utilize network layer authentication

176
00:06:09,740 --> 00:06:14,789
<font color="#CCCCCC">don't actually log IP address and</font>

177
00:06:12,330 --> 00:06:16,680
there's a reason for<font color="#E5E5E5"> this so</font><font color="#CCCCCC"> NLA does</font>

178
00:06:14,789 --> 00:06:18,300
this<font color="#E5E5E5"> pre authentication prior to</font>

179
00:06:16,680 --> 00:06:20,699
actually giving you that<font color="#CCCCCC"> GUI access to</font>

180
00:06:18,300 --> 00:06:21,689
RDP<font color="#E5E5E5"> so if you ever go to like RDP do</font>

181
00:06:20,699 --> 00:06:23,339
system and you get<font color="#CCCCCC"> that credential</font>

182
00:06:21,689 --> 00:06:26,039
prompt where it's<font color="#E5E5E5"> not like the actual</font>

183
00:06:23,339 --> 00:06:28,139
<font color="#E5E5E5">GUI like window with with your like</font>

184
00:06:26,039 --> 00:06:29,310
Microsoft logon that's in<font color="#CCCCCC"> la working for</font>

185
00:06:28,139 --> 00:06:30,539
<font color="#E5E5E5">it's pre authenticating you it's</font>

186
00:06:29,310 --> 00:06:32,490
supposed to be<font color="#E5E5E5"> more secure like you're</font>

187
00:06:30,539 --> 00:06:34,469
you're<font color="#E5E5E5"> not actually hitting the GUI so</font>

188
00:06:32,490 --> 00:06:37,840
anyways when it does<font color="#CCCCCC"> that it generates</font>

189
00:06:34,469 --> 00:06:39,700
<font color="#CCCCCC">an applications and services log</font>

190
00:06:37,840 --> 00:06:41,138
not us not<font color="#CCCCCC"> a Windows security event</font><font color="#E5E5E5"> log</font>

191
00:06:39,700 --> 00:06:42,669
<font color="#CCCCCC">so this is allegedly where it's supposed</font>

192
00:06:41,139 --> 00:06:43,990
<font color="#E5E5E5">to be like so you know doing some</font>

193
00:06:42,669 --> 00:06:45,190
research like<font color="#CCCCCC"> okay the IP is not</font><font color="#E5E5E5"> here</font>

194
00:06:43,990 --> 00:06:46,960
where's it<font color="#E5E5E5"> at</font>

195
00:06:45,190 --> 00:06:48,700
<font color="#E5E5E5">okay so what about this applications and</font>

196
00:06:46,960 --> 00:06:51,849
services<font color="#E5E5E5"> log so we started and looking</font>

197
00:06:48,700 --> 00:06:55,870
at that so this<font color="#CCCCCC"> is what it should look</font>

198
00:06:51,850 --> 00:06:59,860
like so<font color="#CCCCCC"> it's an event ID 144 a failed</font><font color="#E5E5E5"> in</font>

199
00:06:55,870 --> 00:07:02,169
<font color="#E5E5E5">LA authentication via RDP now this is a</font>

200
00:06:59,860 --> 00:07:03,850
very very misleading log so if you read

201
00:07:02,169 --> 00:07:05,740
the actual<font color="#E5E5E5"> content of this</font><font color="#CCCCCC"> August says a</font>

202
00:07:03,850 --> 00:07:07,990
connection from<font color="#E5E5E5"> the client computer with</font>

203
00:07:05,740 --> 00:07:10,330
an IP<font color="#CCCCCC"> address of da-da-da-da-da failed</font>

204
00:07:07,990 --> 00:07:10,810
because the username or password is not

205
00:07:10,330 --> 00:07:14,020
correct

206
00:07:10,810 --> 00:07:16,360
<font color="#E5E5E5">so in testing this out</font><font color="#CCCCCC"> this</font><font color="#E5E5E5"> is extremely</font>

207
00:07:14,020 --> 00:07:18,370
misleading<font color="#CCCCCC"> in testing this</font><font color="#E5E5E5"> out it turns</font>

208
00:07:16,360 --> 00:07:22,540
out that it only<font color="#E5E5E5"> logs this if the</font>

209
00:07:18,370 --> 00:07:25,090
username<font color="#CCCCCC"> is invalid</font><font color="#E5E5E5"> so if you submit a</font>

210
00:07:22,540 --> 00:07:28,479
valid<font color="#E5E5E5"> username and an invalid password</font>

211
00:07:25,090 --> 00:07:30,070
<font color="#E5E5E5">this log does not get generated so as</font>

212
00:07:28,479 --> 00:07:32,590
long<font color="#E5E5E5"> as</font><font color="#CCCCCC"> I have your domain user list</font>

213
00:07:30,070 --> 00:07:36,370
there<font color="#E5E5E5"> is no failed event log that you</font>

214
00:07:32,590 --> 00:07:38,919
<font color="#E5E5E5">can find with my IP</font><font color="#CCCCCC"> address in it if I</font>

215
00:07:36,370 --> 00:07:41,820
try authenticate via RDP within a lab so

216
00:07:38,919 --> 00:07:41,820
I have a demo<font color="#CCCCCC"> of this</font>

217
00:07:46,900 --> 00:07:51,948
okay so<font color="#E5E5E5"> our attackers IP is one point</font>

218
00:07:50,750 --> 00:07:54,340
two<font color="#E5E5E5"> one six eight eighty eight two four</font>

219
00:07:51,949 --> 00:07:56,840
<font color="#E5E5E5">five and I'm going</font><font color="#CCCCCC"> to show how a typical</font>

220
00:07:54,340 --> 00:07:58,969
<font color="#E5E5E5">Remote Desktop</font><font color="#CCCCCC"> Event log should look</font>

221
00:07:56,840 --> 00:08:00,979
using<font color="#E5E5E5"> just our desktop so our desktop</font>

222
00:07:58,970 --> 00:08:06,560
doesn't<font color="#CCCCCC"> actually utilize</font><font color="#E5E5E5"> NLA by default</font>

223
00:08:00,979 --> 00:08:07,900
uses TLS so we create a failed login now

224
00:08:06,560 --> 00:08:12,710
let's go<font color="#E5E5E5"> check out the event log</font>

225
00:08:07,900 --> 00:08:15,979
so<font color="#E5E5E5"> we'll refresh and the console and</font>

226
00:08:12,710 --> 00:08:18,020
then go to the log and<font color="#E5E5E5"> scroll</font><font color="#CCCCCC"> down and</font>

227
00:08:15,979 --> 00:08:18,380
you<font color="#CCCCCC"> should see</font><font color="#E5E5E5"> our IP</font><font color="#CCCCCC"> address of the</font>

228
00:08:18,020 --> 00:08:20,750
attacker

229
00:08:18,380 --> 00:08:23,060
so yeah you see the<font color="#CCCCCC"> username unknown or</font>

230
00:08:20,750 --> 00:08:24,740
<font color="#CCCCCC">a</font><font color="#E5E5E5"> username or bad password and then the</font>

231
00:08:23,060 --> 00:08:25,849
IP address of the the attacker this is

232
00:08:24,740 --> 00:08:27,020
like what you typically<font color="#CCCCCC"> expect when</font>

233
00:08:25,849 --> 00:08:28,550
somebody does a<font color="#CCCCCC"> field logon on</font><font color="#E5E5E5"> your</font>

234
00:08:27,020 --> 00:08:30,530
networks right I mean you would hope

235
00:08:28,550 --> 00:08:33,469
that<font color="#E5E5E5"> like you get their IP address okay</font>

236
00:08:30,530 --> 00:08:36,199
so now let's<font color="#E5E5E5"> go do and an RDP</font><font color="#CCCCCC"> logon with</font>

237
00:08:33,469 --> 00:08:39,229
a tool I wrote<font color="#CCCCCC"> well it's a it's a script</font>

238
00:08:36,200 --> 00:08:40,789
that<font color="#E5E5E5"> I'm gonna show you how we can</font>

239
00:08:39,229 --> 00:08:42,709
change<font color="#CCCCCC"> or we</font><font color="#E5E5E5"> can set how</font><font color="#CCCCCC"> its</font><font color="#E5E5E5"> names</font><font color="#CCCCCC"> too</font>

240
00:08:40,789 --> 00:08:44,480
so this is a list of fake host names

241
00:08:42,708 --> 00:08:46,279
we're gonna send to<font color="#E5E5E5"> the server and then</font>

242
00:08:44,480 --> 00:08:48,560
<font color="#E5E5E5">I'm</font><font color="#CCCCCC"> gonna</font><font color="#E5E5E5"> show you my</font><font color="#CCCCCC"> domain username</font>

243
00:08:46,279 --> 00:08:49,910
list as well<font color="#E5E5E5"> so this is</font><font color="#CCCCCC"> just a quick</font>

244
00:08:48,560 --> 00:08:52,489
little<font color="#E5E5E5"> proof-of-concept to kind of show</font>

245
00:08:49,910 --> 00:08:56,360
how<font color="#E5E5E5"> this works basically what I did is I</font>

246
00:08:52,490 --> 00:08:57,770
<font color="#E5E5E5">took the the the tool</font><font color="#CCCCCC"> hostname CTL +</font><font color="#E5E5E5"> X</font>

247
00:08:56,360 --> 00:09:00,440
free RDP and I just wrapped them in

248
00:08:57,770 --> 00:09:03,319
<font color="#E5E5E5">Python and I'm gonna just run through</font>

249
00:09:00,440 --> 00:09:05,240
password spraying<font color="#E5E5E5"> against RDP where I'm</font>

250
00:09:03,320 --> 00:09:07,970
using<font color="#E5E5E5"> hostname CTL to change the</font>

251
00:09:05,240 --> 00:09:09,860
<font color="#CCCCCC">hostname on every single</font><font color="#E5E5E5"> RDP attempts</font>

252
00:09:07,970 --> 00:09:11,570
and you can see here like<font color="#CCCCCC"> read probably</font>

253
00:09:09,860 --> 00:09:13,339
<font color="#E5E5E5">valid but not allowed to RDP the reason</font>

254
00:09:11,570 --> 00:09:15,350
I put not a lot<font color="#CCCCCC"> of RDP there's because</font>

255
00:09:13,339 --> 00:09:16,730
these<font color="#CCCCCC"> these credentials</font><font color="#E5E5E5"> were successful</font>

256
00:09:15,350 --> 00:09:19,250
but they don't actually have access to

257
00:09:16,730 --> 00:09:21,079
RDP to that system<font color="#E5E5E5"> so we</font><font color="#CCCCCC"> can tell if a</font>

258
00:09:19,250 --> 00:09:23,660
user name<font color="#E5E5E5"> and password was valid on the</font>

259
00:09:21,079 --> 00:09:26,569
domain but here check us out so now

260
00:09:23,660 --> 00:09:28,790
we're going<font color="#E5E5E5"> at the logs and we see</font>

261
00:09:26,570 --> 00:09:33,380
workstation<font color="#E5E5E5"> name share five source</font>

262
00:09:28,790 --> 00:09:37,310
network address<font color="#E5E5E5"> nothing okay what about</font>

263
00:09:33,380 --> 00:09:42,189
the next<font color="#E5E5E5"> one</font><font color="#CCCCCC"> host name</font><font color="#E5E5E5"> or workstation</font>

264
00:09:37,310 --> 00:09:44,209
name share one<font color="#CCCCCC"> know network address and</font>

265
00:09:42,190 --> 00:09:47,209
<font color="#CCCCCC">just for good measure</font><font color="#E5E5E5"> let's do a third</font>

266
00:09:44,209 --> 00:09:48,739
<font color="#CCCCCC">one workstation name don't</font><font color="#E5E5E5"> look here</font>

267
00:09:47,209 --> 00:09:50,149
<font color="#CCCCCC">surface network out there's nothing so</font>

268
00:09:48,740 --> 00:09:53,420
<font color="#E5E5E5">you get the</font><font color="#CCCCCC"> picture I mean it's it's</font>

269
00:09:50,149 --> 00:09:54,860
we're password<font color="#E5E5E5"> spraying and I mean what</font>

270
00:09:53,420 --> 00:09:56,910
<font color="#E5E5E5">are you gonna do I mean</font><font color="#CCCCCC"> we got</font><font color="#E5E5E5"> where's</font>

271
00:09:54,860 --> 00:09:59,460
it coming from

272
00:09:56,910 --> 00:10:00,780
so we go look at<font color="#E5E5E5"> the the</font><font color="#CCCCCC"> application</font><font color="#E5E5E5"> and</font>

273
00:09:59,460 --> 00:10:02,730
services logs and I'll show you<font color="#E5E5E5"> here</font>

274
00:10:00,780 --> 00:10:11,880
<font color="#CCCCCC">that there's no than</font><font color="#E5E5E5"> ID</font><font color="#CCCCCC"> 140s either</font>

275
00:10:02,730 --> 00:10:17,060
because we're using<font color="#E5E5E5"> valid user names all</font>

276
00:10:11,880 --> 00:10:17,060
right back<font color="#CCCCCC"> to the presentation</font>

277
00:10:19,580 --> 00:10:23,240
<font color="#E5E5E5">okay so what's</font><font color="#CCCCCC"> next</font><font color="#E5E5E5"> so what</font><font color="#CCCCCC"> I</font><font color="#E5E5E5"> would like</font>

278
00:10:21,980 --> 00:10:24,500
<font color="#E5E5E5">to do like I</font><font color="#CCCCCC"> said that was just a quick</font>

279
00:10:23,240 --> 00:10:25,550
little<font color="#CCCCCC"> proof-of-concept to kind of</font><font color="#E5E5E5"> show</font>

280
00:10:24,500 --> 00:10:26,750
how<font color="#E5E5E5"> that would work</font>

281
00:10:25,550 --> 00:10:29,510
I want to actually<font color="#E5E5E5"> build a standalone</font>

282
00:10:26,750 --> 00:10:31,940
tool that works in<font color="#CCCCCC"> Windows from either</font>

283
00:10:29,510 --> 00:10:34,939
PowerShell or c-sharp<font color="#E5E5E5"> and add</font><font color="#CCCCCC"> additional</font>

284
00:10:31,940 --> 00:10:37,310
<font color="#CCCCCC">functionality to find</font><font color="#E5E5E5"> in</font><font color="#CCCCCC"> la enabled</font><font color="#E5E5E5"> RDP</font>

285
00:10:34,940 --> 00:10:39,410
because the other thing is is how do you

286
00:10:37,310 --> 00:10:42,290
<font color="#E5E5E5">detect this or stop this</font><font color="#CCCCCC"> so Windows</font>

287
00:10:39,410 --> 00:10:44,060
Server 2016<font color="#CCCCCC"> actually</font><font color="#E5E5E5"> does log the source</font>

288
00:10:42,290 --> 00:10:45,920
IP so this is this<font color="#E5E5E5"> is the recommendation</font>

289
00:10:44,060 --> 00:10:48,500
<font color="#E5E5E5">here</font><font color="#CCCCCC"> make sure you're</font><font color="#E5E5E5"> on Server 2016</font>

290
00:10:45,920 --> 00:10:51,439
<font color="#E5E5E5">Server 2012 r2 and back you're gonna</font>

291
00:10:48,500 --> 00:10:53,329
have a bad day<font color="#E5E5E5"> but you can do a little</font>

292
00:10:51,440 --> 00:10:55,070
<font color="#E5E5E5">bit</font><font color="#CCCCCC"> of correlation between applications</font>

293
00:10:53,329 --> 00:10:58,189
and<font color="#E5E5E5"> services logs that actually show</font>

294
00:10:55,070 --> 00:11:00,019
where a user connected that in that

295
00:10:58,190 --> 00:11:00,980
<font color="#CCCCCC">application services log but it doesn't</font>

296
00:11:00,019 --> 00:11:01,910
<font color="#CCCCCC">actually tell you that</font><font color="#E5E5E5"> the username and</font>

297
00:11:00,980 --> 00:11:03,829
<font color="#E5E5E5">password</font><font color="#CCCCCC"> isn't out so</font><font color="#E5E5E5"> you have to</font>

298
00:11:01,910 --> 00:11:07,250
<font color="#E5E5E5">correlate</font><font color="#CCCCCC"> that with one</font><font color="#E5E5E5"> of those failed</font>

299
00:11:03,829 --> 00:11:08,359
logon events with the fake<font color="#E5E5E5"> host names</font><font color="#CCCCCC"> so</font>

300
00:11:07,250 --> 00:11:11,660
it might<font color="#E5E5E5"> be were looking worth looking</font>

301
00:11:08,360 --> 00:11:21,290
<font color="#E5E5E5">at them like firewall logs</font><font color="#CCCCCC"> - and now</font>

302
00:11:11,660 --> 00:11:24,020
<font color="#CCCCCC">onto</font><font color="#E5E5E5"> mystery box item number</font><font color="#CCCCCC"> two</font><font color="#E5E5E5"> all</font>

303
00:11:21,290 --> 00:11:26,300
<font color="#E5E5E5">right cool the other thing that I like</font>

304
00:11:24,020 --> 00:11:28,040
<font color="#CCCCCC">about that is</font><font color="#E5E5E5"> you could find servers on</font>

305
00:11:26,300 --> 00:11:29,779
<font color="#E5E5E5">their on their network and then just act</font>

306
00:11:28,040 --> 00:11:31,339
like you're<font color="#CCCCCC"> already peeing from their</font>

307
00:11:29,779 --> 00:11:33,560
server<font color="#CCCCCC"> I think that's a cool little</font>

308
00:11:31,339 --> 00:11:36,740
trick<font color="#E5E5E5"> make the triage team kind of run</font>

309
00:11:33,560 --> 00:11:38,810
to the wrong server<font color="#CCCCCC"> ok so cool so we're</font>

310
00:11:36,740 --> 00:11:40,130
going<font color="#E5E5E5"> to talk about the mysterious</font><font color="#CCCCCC"> Azure</font>

311
00:11:38,810 --> 00:11:41,810
<font color="#CCCCCC">Active Directory saying some</font><font color="#E5E5E5"> of you</font>

312
00:11:40,130 --> 00:11:44,089
might have seen the blog post so<font color="#CCCCCC"> we put</font>

313
00:11:41,810 --> 00:11:45,589
out<font color="#E5E5E5"> recently on this</font><font color="#CCCCCC"> a lot of</font><font color="#E5E5E5"> people</font>

314
00:11:44,089 --> 00:11:46,670
aren't<font color="#E5E5E5"> really</font><font color="#CCCCCC"> aware of</font><font color="#E5E5E5"> this is a reason</font>

315
00:11:45,589 --> 00:11:49,760
why I<font color="#CCCCCC"> think we should probably talk</font>

316
00:11:46,670 --> 00:11:51,110
about<font color="#E5E5E5"> this a lot more and so the first</font>

317
00:11:49,760 --> 00:11:53,510
<font color="#E5E5E5">thing</font><font color="#CCCCCC"> that I</font><font color="#E5E5E5"> really wanted to talk</font><font color="#CCCCCC"> about</font>

318
00:11:51,110 --> 00:11:57,110
is you know external Active Directory

319
00:11:53,510 --> 00:12:00,079
being able<font color="#E5E5E5"> to query Active Directory for</font>

320
00:11:57,110 --> 00:12:01,850
information<font color="#CCCCCC"> within an</font><font color="#E5E5E5"> organization so</font>

321
00:12:00,079 --> 00:12:03,680
<font color="#CCCCCC">you could identify everybody in the</font>

322
00:12:01,850 --> 00:12:05,480
<font color="#CCCCCC">organization you could identify all of</font>

323
00:12:03,680 --> 00:12:07,969
<font color="#E5E5E5">the groups</font><font color="#CCCCCC"> all</font><font color="#E5E5E5"> of the group memberships</font>

324
00:12:05,480 --> 00:12:09,110
<font color="#CCCCCC">you could create guest accounts and</font>

325
00:12:07,970 --> 00:12:10,640
<font color="#E5E5E5">that's really just what we're gonna dig</font>

326
00:12:09,110 --> 00:12:13,070
into this a little<font color="#E5E5E5"> bit and you could do</font>

327
00:12:10,640 --> 00:12:15,350
this with all with like a low level set

328
00:12:13,070 --> 00:12:16,820
<font color="#CCCCCC">of credentials</font><font color="#E5E5E5"> and you could do it</font>

329
00:12:15,350 --> 00:12:18,380
externally<font color="#CCCCCC"> so you don't actually have</font><font color="#E5E5E5"> to</font>

330
00:12:16,820 --> 00:12:20,019
<font color="#E5E5E5">be</font><font color="#CCCCCC"> on the internal network in order to</font>

331
00:12:18,380 --> 00:12:23,750
<font color="#E5E5E5">hit Active Directory which i think is</font>

332
00:12:20,019 --> 00:12:25,760
pretty<font color="#CCCCCC"> awesome</font><font color="#E5E5E5"> and and so just</font><font color="#CCCCCC"> a quick</font>

333
00:12:23,750 --> 00:12:27,260
<font color="#E5E5E5">glimpse the way that this works is if</font>

334
00:12:25,760 --> 00:12:28,550
you're familiar with<font color="#E5E5E5"> the der sync on</font>

335
00:12:27,260 --> 00:12:30,439
Active Directory this is kind of like

336
00:12:28,550 --> 00:12:33,199
<font color="#E5E5E5">the traditional way of syncing active</font>

337
00:12:30,440 --> 00:12:34,610
directories using the domain controllers

338
00:12:33,200 --> 00:12:37,730
<font color="#CCCCCC">and they move to</font><font color="#E5E5E5"> this thing called</font><font color="#CCCCCC"> Azure</font>

339
00:12:34,610 --> 00:12:39,260
<font color="#E5E5E5">Active Directory sync and then that just</font>

340
00:12:37,730 --> 00:12:41,720
<font color="#E5E5E5">gave it so that you could expose your</font>

341
00:12:39,260 --> 00:12:42,439
Active Directory<font color="#CCCCCC"> users externally</font><font color="#E5E5E5"> in the</font>

342
00:12:41,720 --> 00:12:44,570
<font color="#E5E5E5">azure</font>

343
00:12:42,440 --> 00:12:46,450
you know kind<font color="#E5E5E5"> of cloud atmosphere or</font>

344
00:12:44,570 --> 00:12:49,280
environment<font color="#E5E5E5"> and in order</font><font color="#CCCCCC"> to kind of</font>

345
00:12:46,450 --> 00:12:50,870
allow self-service for applications or

346
00:12:49,280 --> 00:12:53,390
<font color="#E5E5E5">third-party tools to use single sign-on</font>

347
00:12:50,870 --> 00:12:55,880
<font color="#CCCCCC">and so and then you might also know</font>

348
00:12:53,390 --> 00:12:57,260
<font color="#CCCCCC">forefront Identity Manager and which is</font>

349
00:12:55,880 --> 00:12:59,900
more<font color="#E5E5E5"> of</font><font color="#CCCCCC"> just like the Identity and</font>

350
00:12:57,260 --> 00:13:01,910
Access Management for Azure<font color="#E5E5E5"> and so what</font>

351
00:12:59,900 --> 00:13:04,040
Microsoft done is combined all<font color="#CCCCCC"> of these</font>

352
00:13:01,910 --> 00:13:06,410
<font color="#E5E5E5">to this new idea called as your ad</font>

353
00:13:04,040 --> 00:13:07,670
<font color="#CCCCCC">connect</font><font color="#E5E5E5"> and like I</font><font color="#CCCCCC"> said it just gives</font>

354
00:13:06,410 --> 00:13:10,069
<font color="#E5E5E5">you the</font><font color="#CCCCCC"> ability to have single sign-on</font>

355
00:13:07,670 --> 00:13:12,620
Federation<font color="#CCCCCC"> kind</font><font color="#E5E5E5"> of with all your office</font>

356
00:13:10,070 --> 00:13:14,240
<font color="#CCCCCC">365 or your</font><font color="#E5E5E5"> Exchange Online or any of</font>

357
00:13:12,620 --> 00:13:16,430
the services<font color="#E5E5E5"> that you would use</font><font color="#CCCCCC"> that</font>

358
00:13:14,240 --> 00:13:17,600
you're trying to expose your Active

359
00:13:16,430 --> 00:13:20,359
Directory users<font color="#CCCCCC"> so</font><font color="#E5E5E5"> you could still</font>

360
00:13:17,600 --> 00:13:21,860
manage them on Prem<font color="#E5E5E5"> but not have the</font>

361
00:13:20,360 --> 00:13:24,230
risks of being<font color="#CCCCCC"> on the internal network</font>

362
00:13:21,860 --> 00:13:26,630
which sounds<font color="#CCCCCC"> great</font><font color="#E5E5E5"> right</font><font color="#CCCCCC"> the way that</font>

363
00:13:24,230 --> 00:13:29,840
this works is on<font color="#E5E5E5"> Prem uses this idea</font>

364
00:13:26,630 --> 00:13:31,820
that it's it's the azure ad<font color="#CCCCCC"> connect sync</font>

365
00:13:29,840 --> 00:13:33,350
<font color="#E5E5E5">engine and that</font><font color="#CCCCCC"> sync engine</font><font color="#E5E5E5"> does some</font>

366
00:13:31,820 --> 00:13:35,930
stuff<font color="#CCCCCC"> and</font><font color="#E5E5E5"> then it syncs with the service</font>

367
00:13:33,350 --> 00:13:37,670
which is actually sitting in Azure<font color="#CCCCCC"> and</font>

368
00:13:35,930 --> 00:13:40,130
so the way that<font color="#E5E5E5"> it does</font><font color="#CCCCCC"> this is it uses</font>

369
00:13:37,670 --> 00:13:41,360
this as your<font color="#E5E5E5"> password hashing and so the</font>

370
00:13:40,130 --> 00:13:44,030
concept is<font color="#E5E5E5"> pretty simple</font><font color="#CCCCCC"> straightforward</font>

371
00:13:41,360 --> 00:13:46,640
it takes the MD<font color="#E5E5E5"> for hash of the users</font>

372
00:13:44,030 --> 00:13:48,439
password<font color="#E5E5E5"> it has a salt and then it</font>

373
00:13:46,640 --> 00:13:50,240
<font color="#CCCCCC">sha-256 is that hash and</font><font color="#E5E5E5"> then it</font>

374
00:13:48,440 --> 00:13:51,470
synchronizes it with the domain

375
00:13:50,240 --> 00:13:53,750
controller<font color="#E5E5E5"> sends it to the azure</font>

376
00:13:51,470 --> 00:13:55,670
environment<font color="#CCCCCC"> and the reason why it does</font>

377
00:13:53,750 --> 00:13:58,670
the hash<font color="#E5E5E5"> of a hash is that way we could</font>

378
00:13:55,670 --> 00:14:00,140
prevent like<font color="#E5E5E5"> pass the</font><font color="#CCCCCC"> hash</font><font color="#E5E5E5"> and so it's</font>

379
00:13:58,670 --> 00:14:02,750
pretty straightforward<font color="#E5E5E5"> the envelope gets</font>

380
00:14:00,140 --> 00:14:06,020
decrypted<font color="#CCCCCC"> with the salt and then it</font>

381
00:14:02,750 --> 00:14:07,490
stores<font color="#CCCCCC"> that hash</font><font color="#E5E5E5"> internally within Azure</font>

382
00:14:06,020 --> 00:14:11,210
that way it's<font color="#E5E5E5"> not actually communicating</font>

383
00:14:07,490 --> 00:14:12,410
<font color="#CCCCCC">with</font><font color="#E5E5E5"> your on on Prem immediately and it</font>

384
00:14:11,210 --> 00:14:13,760
does<font color="#E5E5E5"> require like a second</font>

385
00:14:12,410 --> 00:14:16,339
<font color="#E5E5E5">authentication if you're logging</font><font color="#CCCCCC"> into</font>

386
00:14:13,760 --> 00:14:17,930
like your webmail portal or if you're

387
00:14:16,340 --> 00:14:20,180
logging into<font color="#E5E5E5"> Azure portal which</font><font color="#CCCCCC"> is what</font>

388
00:14:17,930 --> 00:14:22,579
we're<font color="#E5E5E5"> going to show it basically takes</font>

389
00:14:20,180 --> 00:14:24,979
<font color="#E5E5E5">that md4 takes a user supplied password</font>

390
00:14:22,580 --> 00:14:27,680
<font color="#CCCCCC">it takes the salt it sends it to like</font><font color="#E5E5E5"> an</font>

391
00:14:24,980 --> 00:14:31,070
H<font color="#CCCCCC"> Mac sha-256</font><font color="#E5E5E5"> and then it compares the</font>

392
00:14:27,680 --> 00:14:34,010
<font color="#E5E5E5">stored hash with the user supplied hash</font>

393
00:14:31,070 --> 00:14:35,630
<font color="#E5E5E5">that was or that</font><font color="#CCCCCC"> was synched earlier</font><font color="#E5E5E5"> by</font>

394
00:14:34,010 --> 00:14:36,770
<font color="#E5E5E5">the domain controller and then it</font>

395
00:14:35,630 --> 00:14:39,020
creates<font color="#CCCCCC"> a session and that's pretty</font><font color="#E5E5E5"> much</font>

396
00:14:36,770 --> 00:14:41,060
<font color="#E5E5E5">the</font><font color="#CCCCCC"> lifecycle</font><font color="#E5E5E5"> so what does this mean</font>

397
00:14:39,020 --> 00:14:42,439
it actually means with a single set<font color="#CCCCCC"> of</font>

398
00:14:41,060 --> 00:14:44,180
credentials<font color="#E5E5E5"> that we've either sprayed</font>

399
00:14:42,440 --> 00:14:46,880
like<font color="#CCCCCC"> I was talking about earlier or that</font>

400
00:14:44,180 --> 00:14:48,739
we fished with<font color="#E5E5E5"> a tool like</font><font color="#CCCCCC"> red sniper</font>

401
00:14:46,880 --> 00:14:50,720
<font color="#E5E5E5">you could actually identify all the</font>

402
00:14:48,740 --> 00:14:51,980
users<font color="#CCCCCC"> and read the permissions the same</font>

403
00:14:50,720 --> 00:14:53,930
way that you<font color="#E5E5E5"> would if you were</font><font color="#CCCCCC"> sitting</font>

404
00:14:51,980 --> 00:14:55,790
<font color="#E5E5E5">on the active directory so sometimes</font>

405
00:14:53,930 --> 00:14:56,930
you'll see<font color="#E5E5E5"> help desk will store notes</font>

406
00:14:55,790 --> 00:14:59,540
<font color="#E5E5E5">within Active Directory</font>

407
00:14:56,930 --> 00:15:01,489
<font color="#E5E5E5">for user accounts</font><font color="#CCCCCC"> we found passwords I</font>

408
00:14:59,540 --> 00:15:02,750
think Sally<font color="#E5E5E5"> brought this up</font><font color="#CCCCCC"> to my</font>

409
00:15:01,490 --> 00:15:04,700
<font color="#E5E5E5">attention a while back at Black Hills</font>

410
00:15:02,750 --> 00:15:07,280
<font color="#E5E5E5">like you could look at Active Directory</font>

411
00:15:04,700 --> 00:15:09,200
properties on users<font color="#CCCCCC"> and find</font><font color="#E5E5E5"> you know</font>

412
00:15:07,280 --> 00:15:10,850
gems of<font color="#CCCCCC"> information you could</font><font color="#E5E5E5"> also</font>

413
00:15:09,200 --> 00:15:13,460
identify security<font color="#E5E5E5"> groups this is where I</font>

414
00:15:10,850 --> 00:15:15,520
usually<font color="#E5E5E5"> go so if I could fish or</font>

415
00:15:13,460 --> 00:15:17,930
password spray<font color="#E5E5E5"> a standard user</font><font color="#CCCCCC"> I</font>

416
00:15:15,520 --> 00:15:20,180
immediately go<font color="#CCCCCC"> to Azure because now my</font>

417
00:15:17,930 --> 00:15:22,130
reconnaissance incorporates identifying

418
00:15:20,180 --> 00:15:24,260
target groups because I love the target

419
00:15:22,130 --> 00:15:26,150
<font color="#CCCCCC">back-end engineers</font><font color="#E5E5E5"> senior developers</font>

420
00:15:24,260 --> 00:15:27,740
most people<font color="#E5E5E5"> don't like that because</font>

421
00:15:26,150 --> 00:15:29,360
they're you know<font color="#CCCCCC"> you'd have this we're</font>

422
00:15:27,740 --> 00:15:31,730
all tech savvy so we tend<font color="#CCCCCC"> to</font><font color="#E5E5E5"> have this</font>

423
00:15:29,360 --> 00:15:32,840
heightened security in<font color="#CCCCCC"> our</font><font color="#E5E5E5"> mind but it's</font>

424
00:15:31,730 --> 00:15:34,910
really<font color="#E5E5E5"> not</font><font color="#CCCCCC"> the case</font>

425
00:15:32,840 --> 00:15:36,800
when<font color="#E5E5E5"> you when you walk into a really</font>

426
00:15:34,910 --> 00:15:38,240
well put fish and so I could<font color="#E5E5E5"> identify</font>

427
00:15:36,800 --> 00:15:39,740
the groups<font color="#CCCCCC"> that they're a</font><font color="#E5E5E5"> part of that</font>

428
00:15:38,240 --> 00:15:41,120
ones that I want to<font color="#E5E5E5"> target because back</font>

429
00:15:39,740 --> 00:15:43,070
in engineers and developers are gonna

430
00:15:41,120 --> 00:15:45,650
have more<font color="#E5E5E5"> access than standard users and</font>

431
00:15:43,070 --> 00:15:47,630
in a lot of<font color="#E5E5E5"> the senior level depending</font>

432
00:15:45,650 --> 00:15:49,819
on<font color="#E5E5E5"> the corporation culture are more than</font>

433
00:15:47,630 --> 00:15:51,920
<font color="#E5E5E5">willing</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> help other employees which is</font>

434
00:15:49,820 --> 00:15:54,080
I think fascinating<font color="#CCCCCC"> because I</font><font color="#E5E5E5"> leverage</font>

435
00:15:51,920 --> 00:15:55,579
that<font color="#E5E5E5"> in order</font><font color="#CCCCCC"> to further pivot into the</font>

436
00:15:54,080 --> 00:15:57,980
organization<font color="#CCCCCC"> you could</font><font color="#E5E5E5"> also identify</font>

437
00:15:55,580 --> 00:16:00,350
other attack surfaces<font color="#E5E5E5"> so within Azure</font>

438
00:15:57,980 --> 00:16:02,000
you can register applications and these

439
00:16:00,350 --> 00:16:04,130
might be internal applications or they

440
00:16:02,000 --> 00:16:05,900
might be<font color="#E5E5E5"> third parties but the idea is</font>

441
00:16:04,130 --> 00:16:07,640
that<font color="#E5E5E5"> we're allowing these</font><font color="#CCCCCC"> third party</font>

442
00:16:05,900 --> 00:16:09,709
services to communicate with our<font color="#E5E5E5"> Active</font>

443
00:16:07,640 --> 00:16:10,819
<font color="#E5E5E5">Directory as your instance for our</font>

444
00:16:09,710 --> 00:16:12,350
single<font color="#CCCCCC"> sign-on because our employees</font>

445
00:16:10,820 --> 00:16:15,830
<font color="#CCCCCC">need to</font><font color="#E5E5E5"> be able</font><font color="#CCCCCC"> to do that</font><font color="#E5E5E5"> you might</font>

446
00:16:12,350 --> 00:16:17,570
find<font color="#E5E5E5"> sales forces there and now you know</font>

447
00:16:15,830 --> 00:16:18,950
that<font color="#CCCCCC"> use third party services</font><font color="#E5E5E5"> sometimes</font>

448
00:16:17,570 --> 00:16:20,480
you don't<font color="#E5E5E5"> have to go internal to</font><font color="#CCCCCC"> the</font>

449
00:16:18,950 --> 00:16:21,380
network ever<font color="#E5E5E5"> we've been in on</font>

450
00:16:20,480 --> 00:16:22,790
engagements where we've actually

451
00:16:21,380 --> 00:16:25,610
compromised an entire<font color="#E5E5E5"> organization</font>

452
00:16:22,790 --> 00:16:26,890
<font color="#E5E5E5">externally just by pivoting around into</font>

453
00:16:25,610 --> 00:16:29,360
their third party<font color="#E5E5E5"> services and</font>

454
00:16:26,890 --> 00:16:30,470
situations like this<font color="#E5E5E5"> I'm the other cool</font>

455
00:16:29,360 --> 00:16:32,210
thing that<font color="#E5E5E5"> I like about it is</font><font color="#CCCCCC"> you can</font>

456
00:16:30,470 --> 00:16:34,460
see the devices that<font color="#E5E5E5"> all the employees</font>

457
00:16:32,210 --> 00:16:36,290
<font color="#CCCCCC">are using which means you can</font><font color="#E5E5E5"> also see</font>

458
00:16:34,460 --> 00:16:38,060
the Windows installation<font color="#E5E5E5"> version</font><font color="#CCCCCC"> 18:06</font>

459
00:16:36,290 --> 00:16:39,770
<font color="#E5E5E5">or if it's back you'll know that that</font>

460
00:16:38,060 --> 00:16:42,349
<font color="#CCCCCC">installation on that</font><font color="#E5E5E5"> device is running</font>

461
00:16:39,770 --> 00:16:43,400
<font color="#E5E5E5">an unpatched version of Windows which is</font>

462
00:16:42,350 --> 00:16:45,080
really<font color="#E5E5E5"> cool or you can see that they're</font>

463
00:16:43,400 --> 00:16:46,819
<font color="#E5E5E5">you sinking their phones with the portal</font>

464
00:16:45,080 --> 00:16:49,040
<font color="#E5E5E5">and they're running Android and it's an</font>

465
00:16:46,820 --> 00:16:50,090
older<font color="#CCCCCC"> version of</font><font color="#E5E5E5"> Android</font><font color="#CCCCCC"> but there's a</font>

466
00:16:49,040 --> 00:16:51,079
bunch of that<font color="#CCCCCC"> stuff that you</font><font color="#E5E5E5"> could do</font>

467
00:16:50,090 --> 00:16:52,550
there the other thing<font color="#CCCCCC"> that you could do</font>

468
00:16:51,080 --> 00:16:54,140
is you could<font color="#CCCCCC"> look at the other domains</font>

469
00:16:52,550 --> 00:16:55,099
that are associated<font color="#E5E5E5"> with it you know a</font>

470
00:16:54,140 --> 00:16:56,600
lot of<font color="#E5E5E5"> times we're looking at the</font>

471
00:16:55,100 --> 00:16:58,060
corporate<font color="#CCCCCC"> domain but the developers</font>

472
00:16:56,600 --> 00:16:59,920
might have stood<font color="#E5E5E5"> up</font><font color="#CCCCCC"> their own</font>

473
00:16:58,060 --> 00:17:01,209
<font color="#CCCCCC">their own development domain where</font>

474
00:16:59,920 --> 00:17:03,160
<font color="#E5E5E5">they're sinking their gitlab or their</font>

475
00:17:01,210 --> 00:17:04,930
github<font color="#CCCCCC"> to that that developer domain and</font>

476
00:17:03,160 --> 00:17:06,579
you can see other<font color="#E5E5E5"> attack surfaces as</font>

477
00:17:04,930 --> 00:17:07,840
well<font color="#CCCCCC"> as the</font><font color="#E5E5E5"> roles and scopes because</font>

478
00:17:06,579 --> 00:17:08,889
once you're looking at the<font color="#E5E5E5"> groups not</font>

479
00:17:07,839 --> 00:17:11,020
<font color="#CCCCCC">only do you know the groups</font><font color="#E5E5E5"> you could</font>

480
00:17:08,890 --> 00:17:13,990
<font color="#E5E5E5">also look at the roles of the members of</font>

481
00:17:11,020 --> 00:17:16,119
<font color="#E5E5E5">that group</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> so</font><font color="#CCCCCC"> in that</font><font color="#E5E5E5"> remember we're</font>

482
00:17:13,990 --> 00:17:17,950
doing<font color="#E5E5E5"> all this from a limited access</font>

483
00:17:16,119 --> 00:17:19,359
account or if we had an account we could

484
00:17:17,950 --> 00:17:22,030
create<font color="#E5E5E5"> a guest account</font><font color="#CCCCCC"> and just login</font>

485
00:17:19,359 --> 00:17:23,229
with our<font color="#CCCCCC"> own</font><font color="#E5E5E5"> and</font><font color="#CCCCCC"> so that's</font><font color="#E5E5E5"> really kind</font>

486
00:17:22,030 --> 00:17:24,940
<font color="#CCCCCC">of</font><font color="#E5E5E5"> the idea behind this the other thing</font>

487
00:17:23,230 --> 00:17:26,290
you<font color="#E5E5E5"> could do is you could create a guest</font>

488
00:17:24,940 --> 00:17:28,360
<font color="#CCCCCC">account and then add a multi-factor</font>

489
00:17:26,290 --> 00:17:30,250
device if they have to factor<font color="#E5E5E5"> so if you</font>

490
00:17:28,359 --> 00:17:31,570
invite a<font color="#E5E5E5"> user and just depending on</font><font color="#CCCCCC"> how</font>

491
00:17:30,250 --> 00:17:34,750
the<font color="#CCCCCC"> configuration set up we could</font>

492
00:17:31,570 --> 00:17:36,189
actually VPN<font color="#CCCCCC"> in if it's part of</font><font color="#E5E5E5"> if all</font>

493
00:17:34,750 --> 00:17:39,340
the users and<font color="#E5E5E5"> guest accounts get created</font>

494
00:17:36,190 --> 00:17:40,540
<font color="#E5E5E5">in a VPN group which we've seen and so</font>

495
00:17:39,340 --> 00:17:42,189
let's do<font color="#E5E5E5"> it so there's three different</font>

496
00:17:40,540 --> 00:17:43,810
<font color="#E5E5E5">ways</font><font color="#CCCCCC"> that we could connect</font><font color="#E5E5E5"> to this the</font>

497
00:17:42,190 --> 00:17:45,490
first one that I that I originally<font color="#CCCCCC"> found</font>

498
00:17:43,810 --> 00:17:46,899
this on was<font color="#CCCCCC"> just connecting to</font><font color="#E5E5E5"> the azure</font>

499
00:17:45,490 --> 00:17:48,940
portal<font color="#E5E5E5"> I was trying to find out what</font>

500
00:17:46,900 --> 00:17:50,860
services<font color="#E5E5E5"> the user had access</font><font color="#CCCCCC"> to and it</font>

501
00:17:48,940 --> 00:17:53,020
turns out<font color="#CCCCCC"> that they have</font><font color="#E5E5E5"> access to be</font>

502
00:17:50,860 --> 00:17:55,629
able<font color="#CCCCCC"> to</font><font color="#E5E5E5"> just pivot into Azure which</font>

503
00:17:53,020 --> 00:17:57,040
going to portal Dodger<font color="#CCCCCC"> com</font><font color="#E5E5E5"> logging in</font>

504
00:17:55,630 --> 00:17:58,360
with those<font color="#E5E5E5"> low level creds and then</font>

505
00:17:57,040 --> 00:18:00,670
going straight<font color="#CCCCCC"> to Azure</font><font color="#E5E5E5"> Active Directory</font>

506
00:17:58,360 --> 00:18:01,990
and<font color="#E5E5E5"> you see everything I was having a</font>

507
00:18:00,670 --> 00:18:03,550
<font color="#E5E5E5">really difficult time trying</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> get that</font>

508
00:18:01,990 --> 00:18:04,960
<font color="#E5E5E5">data</font><font color="#CCCCCC"> out especially on organizations</font>

509
00:18:03,550 --> 00:18:06,820
that have<font color="#CCCCCC"> twenty thousand employees</font><font color="#E5E5E5"> and</font>

510
00:18:04,960 --> 00:18:09,280
so the way<font color="#CCCCCC"> that we did it was I found</font>

511
00:18:06,820 --> 00:18:12,220
<font color="#E5E5E5">this as your CLI very similar to the AWS</font>

512
00:18:09,280 --> 00:18:15,399
CLI<font color="#CCCCCC"> but you</font><font color="#E5E5E5"> just do a Z login it pumps a</font>

513
00:18:12,220 --> 00:18:16,390
bra it prompts a browser open you<font color="#CCCCCC"> log in</font>

514
00:18:15,400 --> 00:18:18,820
with<font color="#E5E5E5"> your credentials and then it</font>

515
00:18:16,390 --> 00:18:20,650
<font color="#E5E5E5">authorizes that CLI instance with a</font>

516
00:18:18,820 --> 00:18:22,389
valid session and you could kind of just

517
00:18:20,650 --> 00:18:24,460
<font color="#E5E5E5">query from there there is if</font><font color="#CCCCCC"> your</font>

518
00:18:22,390 --> 00:18:27,520
<font color="#E5E5E5">PowerShell fanatic</font><font color="#CCCCCC"> you could use as your</font>

519
00:18:24,460 --> 00:18:28,930
RM and do the exact<font color="#CCCCCC"> same thing</font><font color="#E5E5E5"> I found</font>

520
00:18:27,520 --> 00:18:31,150
<font color="#CCCCCC">that</font><font color="#E5E5E5"> the azure CLI is a little bit</font>

521
00:18:28,930 --> 00:18:33,790
sketchy<font color="#CCCCCC"> at times whenever</font><font color="#E5E5E5"> you're trying</font>

522
00:18:31,150 --> 00:18:36,160
<font color="#E5E5E5">to</font><font color="#CCCCCC"> filter down</font><font color="#E5E5E5"> it's not super developed</font>

523
00:18:33,790 --> 00:18:38,649
yet but that's<font color="#CCCCCC"> pretty much</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> nature of</font>

524
00:18:36,160 --> 00:18:40,870
<font color="#E5E5E5">how you can connect to it</font><font color="#CCCCCC"> and so I do</font>

525
00:18:38,650 --> 00:18:45,010
have<font color="#E5E5E5"> a little demo</font><font color="#CCCCCC"> here let me</font><font color="#E5E5E5"> see if I</font>

526
00:18:40,870 --> 00:18:48,280
can pull this<font color="#CCCCCC"> up real quick it's a</font>

527
00:18:45,010 --> 00:18:49,660
pretty<font color="#E5E5E5"> it's a</font><font color="#CCCCCC"> pretty quick one so the</font>

528
00:18:48,280 --> 00:18:51,280
idea is I'm just logging in now<font color="#CCCCCC"> I'm</font>

529
00:18:49,660 --> 00:18:53,950
using allow no subscriptions<font color="#E5E5E5"> and use</font>

530
00:18:51,280 --> 00:18:56,379
device code<font color="#E5E5E5"> use</font><font color="#CCCCCC"> device code you take</font>

531
00:18:53,950 --> 00:18:58,570
that code<font color="#CCCCCC"> and</font><font color="#E5E5E5"> you actually log in with</font>

532
00:18:56,380 --> 00:19:01,450
the link<font color="#E5E5E5"> that's there so</font><font color="#CCCCCC"> it'll</font><font color="#E5E5E5"> open up</font>

533
00:18:58,570 --> 00:19:03,939
and the<font color="#E5E5E5"> the authentication will bring</font>

534
00:19:01,450 --> 00:19:05,260
you to a page you<font color="#CCCCCC"> just push that see I'm</font>

535
00:19:03,940 --> 00:19:08,410
<font color="#E5E5E5">already logged</font><font color="#CCCCCC"> into the</font><font color="#E5E5E5"> session you see</font>

536
00:19:05,260 --> 00:19:10,050
the the<font color="#E5E5E5"> outlook on office</font><font color="#CCCCCC"> 365 on the</font>

537
00:19:08,410 --> 00:19:13,110
background but<font color="#CCCCCC"> you</font><font color="#E5E5E5"> take that code</font>

538
00:19:10,050 --> 00:19:15,750
<font color="#E5E5E5">you put it into the azure</font><font color="#CCCCCC"> prompt and</font>

539
00:19:13,110 --> 00:19:19,439
then it grants<font color="#E5E5E5"> the access</font><font color="#CCCCCC"> you select the</font>

540
00:19:15,750 --> 00:19:23,550
account<font color="#CCCCCC"> both stood up</font><font color="#E5E5E5"> a nice domain for</font>

541
00:19:19,440 --> 00:19:24,930
us we've authenticated<font color="#CCCCCC"> ASBO now and</font><font color="#E5E5E5"> and</font>

542
00:19:23,550 --> 00:19:26,610
so then it's<font color="#E5E5E5"> gonna authorize it and so</font>

543
00:19:24,930 --> 00:19:28,500
you see here<font color="#CCCCCC"> now</font><font color="#E5E5E5"> we're gonna run a list</font>

544
00:19:26,610 --> 00:19:31,409
of all the logins or all the users that

545
00:19:28,500 --> 00:19:32,640
are<font color="#E5E5E5"> a part of this Active Directory and</font>

546
00:19:31,410 --> 00:19:34,590
so it's<font color="#CCCCCC"> gonna kind of give you all the</font>

547
00:19:32,640 --> 00:19:35,760
<font color="#E5E5E5">details you</font><font color="#CCCCCC"> could output</font><font color="#E5E5E5"> it in JSON if</font>

548
00:19:34,590 --> 00:19:37,500
you're developing a tool which is really

549
00:19:35,760 --> 00:19:39,270
<font color="#E5E5E5">handy or you could dump it</font><font color="#CCCCCC"> to a table</font>

550
00:19:37,500 --> 00:19:40,500
<font color="#CCCCCC">but you see all of</font><font color="#E5E5E5"> the permissions that</font>

551
00:19:39,270 --> 00:19:42,840
from Active Directory you see the phone

552
00:19:40,500 --> 00:19:44,760
numbers the addresses<font color="#CCCCCC"> we see pretty much</font>

553
00:19:42,840 --> 00:19:46,169
everything the user principal name we

554
00:19:44,760 --> 00:19:48,330
see<font color="#CCCCCC"> there all</font><font color="#E5E5E5"> this stuff they have</font>

555
00:19:46,170 --> 00:19:49,440
access<font color="#CCCCCC"> to their shut their</font><font color="#E5E5E5"> sign in name</font>

556
00:19:48,330 --> 00:19:51,000
<font color="#E5E5E5">so pretty much everything</font><font color="#CCCCCC"> that</font><font color="#E5E5E5"> you</font><font color="#CCCCCC"> would</font>

557
00:19:49,440 --> 00:19:54,000
<font color="#CCCCCC">expect</font><font color="#E5E5E5"> to</font><font color="#CCCCCC"> see if you're using</font><font color="#E5E5E5"> like</font><font color="#CCCCCC"> 80</font>

558
00:19:51,000 --> 00:19:55,740
<font color="#E5E5E5">explorer on the internal network</font><font color="#CCCCCC"> and so</font>

559
00:19:54,000 --> 00:19:57,480
using<font color="#E5E5E5"> that now we can look at the group</font>

560
00:19:55,740 --> 00:19:59,280
of lists<font color="#E5E5E5"> this is usually what I do like</font>

561
00:19:57,480 --> 00:20:01,110
<font color="#E5E5E5">these are the first things that I do and</font>

562
00:19:59,280 --> 00:20:03,180
then I find all<font color="#E5E5E5"> the groups and I'm</font>

563
00:20:01,110 --> 00:20:04,409
obviously<font color="#E5E5E5"> looking for admin I want to</font>

564
00:20:03,180 --> 00:20:06,270
find the admin<font color="#E5E5E5"> group because I want to</font>

565
00:20:04,410 --> 00:20:07,560
<font color="#E5E5E5">find the members of that admin group so</font>

566
00:20:06,270 --> 00:20:09,270
we see<font color="#E5E5E5"> that group nope not that one</font>

567
00:20:07,560 --> 00:20:10,409
<font color="#E5E5E5">there we go</font><font color="#CCCCCC"> vole Matmos this is</font>

568
00:20:09,270 --> 00:20:13,530
interesting

569
00:20:10,410 --> 00:20:15,570
so I take<font color="#CCCCCC"> that object ID I just copy it</font>

570
00:20:13,530 --> 00:20:19,470
<font color="#CCCCCC">and then what I'm gonna do next is I'm</font>

571
00:20:15,570 --> 00:20:21,899
<font color="#E5E5E5">gonna do a Z</font><font color="#CCCCCC"> ad group members list and</font>

572
00:20:19,470 --> 00:20:23,370
then pass it that group ID<font color="#E5E5E5"> and it's</font>

573
00:20:21,900 --> 00:20:24,390
gonna give<font color="#CCCCCC"> me all of the members</font><font color="#E5E5E5"> within</font>

574
00:20:23,370 --> 00:20:26,879
Active Directory

575
00:20:24,390 --> 00:20:28,380
where they<font color="#CCCCCC"> were a part of that group</font><font color="#E5E5E5"> and</font>

576
00:20:26,880 --> 00:20:31,410
you'll see we<font color="#CCCCCC"> have a domain</font><font color="#E5E5E5"> admin that's</font>

577
00:20:28,380 --> 00:20:33,810
there and<font color="#E5E5E5"> then oh by the way we looks</font>

578
00:20:31,410 --> 00:20:36,390
like we have<font color="#E5E5E5"> beau in the list as well</font>

579
00:20:33,810 --> 00:20:38,250
<font color="#CCCCCC">somewhere</font><font color="#E5E5E5"> up here</font><font color="#CCCCCC"> and so that's</font><font color="#E5E5E5"> pretty</font>

580
00:20:36,390 --> 00:20:42,000
<font color="#CCCCCC">much</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> nature of</font><font color="#E5E5E5"> how we could leverage</font>

581
00:20:38,250 --> 00:20:44,340
this to kind of pivot into an

582
00:20:42,000 --> 00:20:45,810
environment<font color="#E5E5E5"> I'm just gonna cut that</font><font color="#CCCCCC"> know</font>

583
00:20:44,340 --> 00:20:54,780
<font color="#E5E5E5">cuz when I get through the rest of this</font>

584
00:20:45,810 --> 00:20:57,169
stuff and so<font color="#CCCCCC"> I</font><font color="#E5E5E5"> just screwed up</font><font color="#CCCCCC"> how did I</font>

585
00:20:54,780 --> 00:20:57,170
<font color="#E5E5E5">get back there</font>

586
00:20:58,380 --> 00:21:04,060
you<font color="#E5E5E5"> take it I can't do it</font><font color="#CCCCCC"> my</font><font color="#E5E5E5"> right hand</font>

587
00:21:01,110 --> 00:21:05,530
and<font color="#E5E5E5"> then</font><font color="#CCCCCC"> go into presenter so the</font>

588
00:21:04,060 --> 00:21:08,980
problem with<font color="#E5E5E5"> this was we were</font><font color="#CCCCCC"> trying to</font>

589
00:21:05,530 --> 00:21:10,120
find what do you do<font color="#CCCCCC"> about this</font><font color="#E5E5E5"> right so</font>

590
00:21:08,980 --> 00:21:10,840
that we had some talks when we put the

591
00:21:10,120 --> 00:21:14,169
blog out<font color="#CCCCCC"> there</font>

592
00:21:10,840 --> 00:21:16,120
it looks<font color="#E5E5E5"> like</font><font color="#CCCCCC"> an azure portal you could</font>

593
00:21:14,170 --> 00:21:17,710
<font color="#E5E5E5">turn off portal access by going</font><font color="#CCCCCC"> into</font><font color="#E5E5E5"> the</font>

594
00:21:16,120 --> 00:21:19,570
<font color="#CCCCCC">configuration as admin and just</font>

595
00:21:17,710 --> 00:21:21,310
disabling it<font color="#E5E5E5"> the problem with</font><font color="#CCCCCC"> that is if</font>

596
00:21:19,570 --> 00:21:24,040
you look at the top right it<font color="#E5E5E5"> doesn't</font>

597
00:21:21,310 --> 00:21:25,360
work for CLI or the<font color="#CCCCCC"> powershell and so we</font>

598
00:21:24,040 --> 00:21:26,800
were<font color="#CCCCCC"> like well what are</font><font color="#E5E5E5"> we gonna do well</font>

599
00:21:25,360 --> 00:21:28,959
the way that you have to<font color="#E5E5E5"> do this is you</font>

600
00:21:26,800 --> 00:21:30,879
have<font color="#CCCCCC"> to</font><font color="#E5E5E5"> set</font><font color="#CCCCCC"> up a Z conditional access</font>

601
00:21:28,960 --> 00:21:33,400
<font color="#E5E5E5">rules in order to disable somebody from</font>

602
00:21:30,880 --> 00:21:35,920
<font color="#E5E5E5">logging in from CLI</font><font color="#CCCCCC"> the problem that we</font>

603
00:21:33,400 --> 00:21:38,830
<font color="#E5E5E5">ran into though is that you have to</font>

604
00:21:35,920 --> 00:21:39,970
<font color="#CCCCCC">upgrade so it's if you look down</font><font color="#E5E5E5"> there</font>

605
00:21:38,830 --> 00:21:42,399
at the<font color="#E5E5E5"> bottom</font><font color="#CCCCCC"> it says that you</font><font color="#E5E5E5"> have to</font>

606
00:21:39,970 --> 00:21:44,920
<font color="#E5E5E5">have as your ad premium which is</font><font color="#CCCCCC"> an</font>

607
00:21:42,400 --> 00:21:46,480
upgrade<font color="#CCCCCC"> so we brought it back</font><font color="#E5E5E5"> to the</font>

608
00:21:44,920 --> 00:21:48,910
<font color="#CCCCCC">company and</font><font color="#E5E5E5"> we were like our internal</font>

609
00:21:46,480 --> 00:21:51,160
<font color="#CCCCCC">because we used office</font><font color="#E5E5E5"> 365 and we were</font>

610
00:21:48,910 --> 00:21:53,290
trying to<font color="#E5E5E5"> find how</font><font color="#CCCCCC"> to fix this problem</font>

611
00:21:51,160 --> 00:21:55,930
<font color="#CCCCCC">and it turns out</font><font color="#E5E5E5"> Derek Roush was able</font><font color="#CCCCCC"> to</font>

612
00:21:53,290 --> 00:21:58,450
find a backup<font color="#E5E5E5"> shortcut which was really</font>

613
00:21:55,930 --> 00:22:01,360
<font color="#E5E5E5">helpful for us</font><font color="#CCCCCC"> to be able to disable</font><font color="#E5E5E5"> the</font>

614
00:21:58,450 --> 00:22:02,880
ability<font color="#CCCCCC"> to have users</font><font color="#E5E5E5"> read other users</font>

615
00:22:01,360 --> 00:22:04,840
data it<font color="#E5E5E5"> doesn't stop all the other</font>

616
00:22:02,880 --> 00:22:06,100
<font color="#E5E5E5">information you can still see groups and</font>

617
00:22:04,840 --> 00:22:08,590
you<font color="#E5E5E5"> can see applications and domains and</font>

618
00:22:06,100 --> 00:22:10,090
stuff but that's<font color="#E5E5E5"> pretty</font><font color="#CCCCCC"> much</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> nature</font>

619
00:22:08,590 --> 00:22:14,520
of<font color="#E5E5E5"> how you have to fix it if you're not</font>

620
00:22:10,090 --> 00:22:16,540
<font color="#CCCCCC">gonna</font><font color="#E5E5E5"> upgrade and</font><font color="#CCCCCC"> alright alright so</font>

621
00:22:14,520 --> 00:22:19,570
here's mystery box item number<font color="#E5E5E5"> three</font>

622
00:22:16,540 --> 00:22:21,190
<font color="#E5E5E5">what are</font><font color="#CCCCCC"> you pulling out now so this one</font>

623
00:22:19,570 --> 00:22:25,450
is<font color="#E5E5E5"> called the force fed Microsoft</font>

624
00:22:21,190 --> 00:22:27,070
Outlook hook<font color="#E5E5E5"> alright so oh three</font>

625
00:22:25,450 --> 00:22:28,780
<font color="#E5E5E5">sixty-five creds now</font><font color="#CCCCCC"> web so let's say we</font>

626
00:22:27,070 --> 00:22:30,399
again back to<font color="#CCCCCC"> Pastor spring this is</font>

627
00:22:28,780 --> 00:22:31,899
<font color="#E5E5E5">you're gonna see this recurring theme</font>

628
00:22:30,400 --> 00:22:33,430
through a lot of<font color="#E5E5E5"> what we do so</font><font color="#CCCCCC"> let's say</font>

629
00:22:31,900 --> 00:22:36,310
we<font color="#E5E5E5"> got a cred somehow password spring</font>

630
00:22:33,430 --> 00:22:37,300
<font color="#E5E5E5">maybe we fished a cred</font><font color="#CCCCCC"> we have access to</font>

631
00:22:36,310 --> 00:22:40,149
somebody's credential<font color="#E5E5E5"> at your</font>

632
00:22:37,300 --> 00:22:42,610
organization and<font color="#CCCCCC"> your know 365 shot</font><font color="#E5E5E5"> so</font>

633
00:22:40,150 --> 00:22:43,840
from the<font color="#E5E5E5"> external side I</font><font color="#CCCCCC"> mean Oh 365 is</font>

634
00:22:42,610 --> 00:22:44,949
pretty vast I mean there's a lot<font color="#CCCCCC"> of</font>

635
00:22:43,840 --> 00:22:46,810
stuff you<font color="#E5E5E5"> can go look through</font><font color="#CCCCCC"> SharePoint</font>

636
00:22:44,950 --> 00:22:47,920
you can look through you know<font color="#E5E5E5"> you're</font>

637
00:22:46,810 --> 00:22:49,720
like you just<font color="#E5E5E5"> mentioned like find the</font>

638
00:22:47,920 --> 00:22:51,670
groups<font color="#E5E5E5"> and there's a lot of enumeration</font>

639
00:22:49,720 --> 00:22:53,530
you could do there<font color="#CCCCCC"> one of the things</font>

640
00:22:51,670 --> 00:22:55,420
<font color="#CCCCCC">that we used to</font><font color="#E5E5E5"> do but it's since been</font>

641
00:22:53,530 --> 00:22:56,980
<font color="#CCCCCC">patched is the</font><font color="#E5E5E5"> quote unquote ruler</font>

642
00:22:55,420 --> 00:22:59,440
attack<font color="#CCCCCC"> it which is where you</font><font color="#E5E5E5"> basically</font>

643
00:22:56,980 --> 00:23:01,990
install your own<font color="#E5E5E5"> outlook client and then</font>

644
00:22:59,440 --> 00:23:04,390
add<font color="#CCCCCC"> your own malicious rules in and they</font>

645
00:23:01,990 --> 00:23:07,450
sync across<font color="#E5E5E5"> the Internet to your victims</font>

646
00:23:04,390 --> 00:23:08,530
<font color="#E5E5E5">outlook client and so like that's not a</font>

647
00:23:07,450 --> 00:23:09,840
thing<font color="#E5E5E5"> anymore so let's</font><font color="#CCCCCC"> talk</font><font color="#E5E5E5"> about</font>

648
00:23:08,530 --> 00:23:13,350
<font color="#E5E5E5">something kind of new</font>

649
00:23:09,840 --> 00:23:17,340
kind of<font color="#E5E5E5"> similar</font><font color="#CCCCCC"> so if anyone heard of</font>

650
00:23:13,350 --> 00:23:18,179
<font color="#E5E5E5">Microsoft add-ins</font><font color="#CCCCCC"> no nobody okay well</font>

651
00:23:17,340 --> 00:23:21,320
then you're about to learn a lot about

652
00:23:18,180 --> 00:23:23,310
<font color="#CCCCCC">this</font><font color="#E5E5E5"> ok so Microsoft ad ons are</font>

653
00:23:21,320 --> 00:23:25,139
essentially what it sounds like<font color="#E5E5E5"> they</font>

654
00:23:23,310 --> 00:23:26,879
<font color="#CCCCCC">they're additional functionality that</font>

655
00:23:25,140 --> 00:23:28,200
<font color="#E5E5E5">you can</font><font color="#CCCCCC"> add to</font><font color="#E5E5E5"> various Microsoft</font>

656
00:23:26,880 --> 00:23:30,270
<font color="#E5E5E5">products and it's not just Outlook you</font>

657
00:23:28,200 --> 00:23:32,550
can<font color="#E5E5E5"> add them to word sharing to all</font>

658
00:23:30,270 --> 00:23:34,230
kinds of<font color="#E5E5E5"> different services so there are</font>

659
00:23:32,550 --> 00:23:36,899
<font color="#E5E5E5">two types of different outlook add-ins</font>

660
00:23:34,230 --> 00:23:39,420
there's the<font color="#E5E5E5"> traditional or a legacy com</font>

661
00:23:36,900 --> 00:23:40,740
style or<font color="#CCCCCC"> VST o atoms which</font><font color="#E5E5E5"> are basically</font>

662
00:23:39,420 --> 00:23:42,030
ones you would<font color="#E5E5E5"> install on your desktop</font>

663
00:23:40,740 --> 00:23:43,380
so<font color="#CCCCCC"> if you have like</font><font color="#E5E5E5"> the desktop outlook</font>

664
00:23:42,030 --> 00:23:45,240
client you would<font color="#E5E5E5"> install one of these</font>

665
00:23:43,380 --> 00:23:48,510
<font color="#E5E5E5">add-ins and it literally installs code</font>

666
00:23:45,240 --> 00:23:51,180
on<font color="#CCCCCC"> your on your system or the newer ones</font>

667
00:23:48,510 --> 00:23:52,830
are<font color="#E5E5E5"> these web add-ons and so the web ad</font>

668
00:23:51,180 --> 00:23:54,540
ends<font color="#CCCCCC"> there's no code that's actually</font>

669
00:23:52,830 --> 00:23:56,129
<font color="#E5E5E5">installed on your client you added n via</font>

670
00:23:54,540 --> 00:23:58,379
the browser<font color="#E5E5E5"> so you log</font><font color="#CCCCCC"> into at the</font>

671
00:23:56,130 --> 00:23:59,520
<font color="#E5E5E5">Outlook Web client and you go to install</font>

672
00:23:58,380 --> 00:24:02,010
<font color="#E5E5E5">the add-on which I'll show here in a</font>

673
00:23:59,520 --> 00:24:03,510
second<font color="#CCCCCC"> and it literally points to a file</font>

674
00:24:02,010 --> 00:24:06,240
<font color="#CCCCCC">on the internet</font><font color="#E5E5E5"> you upload this manifest</font>

675
00:24:03,510 --> 00:24:10,350
<font color="#E5E5E5">XML file that</font><font color="#CCCCCC"> has this pointer to a web</font>

676
00:24:06,240 --> 00:24:12,720
server where<font color="#CCCCCC"> you host your</font><font color="#E5E5E5"> code so</font><font color="#CCCCCC"> the</font>

677
00:24:10,350 --> 00:24:15,179
web<font color="#CCCCCC"> add ins</font><font color="#E5E5E5"> sync across</font><font color="#CCCCCC"> sessions not</font>

678
00:24:12,720 --> 00:24:17,190
<font color="#E5E5E5">only to the web clients but</font><font color="#CCCCCC"> to the</font>

679
00:24:15,180 --> 00:24:19,740
<font color="#E5E5E5">desktop clients too so if I get access</font>

680
00:24:17,190 --> 00:24:23,990
<font color="#CCCCCC">to</font><font color="#E5E5E5"> a credential and I add my</font><font color="#CCCCCC"> own atom</font><font color="#E5E5E5"> it</font>

681
00:24:19,740 --> 00:24:26,670
syncs everywhere<font color="#CCCCCC"> I'll give you a second</font>

682
00:24:23,990 --> 00:24:28,560
<font color="#CCCCCC">alright so here's the attack math right</font>

683
00:24:26,670 --> 00:24:31,530
<font color="#CCCCCC">alright an attacker gets</font><font color="#E5E5E5"> a cred we add</font>

684
00:24:28,560 --> 00:24:33,659
in our malicious atom and it's gonna

685
00:24:31,530 --> 00:24:36,270
sink<font color="#CCCCCC"> to</font><font color="#E5E5E5"> your browser to your desktop</font>

686
00:24:33,660 --> 00:24:37,350
client and let's see what kind of<font color="#E5E5E5"> look</font>

687
00:24:36,270 --> 00:24:38,790
what can we do with that

688
00:24:37,350 --> 00:24:40,530
so there's first<font color="#E5E5E5"> of all there's some</font>

689
00:24:38,790 --> 00:24:43,470
hurdles<font color="#E5E5E5"> to jump does the user have</font><font color="#CCCCCC"> to</font>

690
00:24:40,530 --> 00:24:45,330
click something<font color="#E5E5E5"> no they don't which is</font>

691
00:24:43,470 --> 00:24:46,680
even<font color="#CCCCCC"> more fun so when you install</font><font color="#E5E5E5"> an</font>

692
00:24:45,330 --> 00:24:48,330
add-in it shows up as like<font color="#E5E5E5"> this little</font>

693
00:24:46,680 --> 00:24:50,400
icon like kind of when you open up<font color="#E5E5E5"> an</font>

694
00:24:48,330 --> 00:24:51,600
email typically that the traditional<font color="#E5E5E5"> way</font>

695
00:24:50,400 --> 00:24:53,550
is<font color="#E5E5E5"> it kind of creates you this little</font>

696
00:24:51,600 --> 00:24:55,199
<font color="#CCCCCC">icon that you can change</font><font color="#E5E5E5"> to whatever you</font>

697
00:24:53,550 --> 00:24:57,629
<font color="#E5E5E5">want and</font><font color="#CCCCCC"> you click it and then it runs</font>

698
00:24:55,200 --> 00:25:00,240
<font color="#E5E5E5">your</font><font color="#CCCCCC"> add-in so typically the user would</font>

699
00:24:57,630 --> 00:25:02,310
have<font color="#CCCCCC"> to</font><font color="#E5E5E5"> click that but think thankfully</font>

700
00:25:00,240 --> 00:25:04,500
to Microsoft they gave us pinnable task

701
00:25:02,310 --> 00:25:07,320
panes<font color="#E5E5E5"> so we can now</font><font color="#CCCCCC"> just pin that</font>

702
00:25:04,500 --> 00:25:09,000
<font color="#E5E5E5">straight to our email and it just runs</font>

703
00:25:07,320 --> 00:25:11,639
<font color="#E5E5E5">like so you open</font><font color="#CCCCCC"> up an</font><font color="#E5E5E5"> email and it</font>

704
00:25:09,000 --> 00:25:13,650
<font color="#E5E5E5">literally just runs the add-on and the</font>

705
00:25:11,640 --> 00:25:17,190
other thing the dependable task<font color="#CCCCCC"> panes</font>

706
00:25:13,650 --> 00:25:20,610
<font color="#E5E5E5">sync across web browsers</font><font color="#CCCCCC"> - so all I have</font>

707
00:25:17,190 --> 00:25:23,400
to<font color="#E5E5E5"> do now as as an attacker is points</font>

708
00:25:20,610 --> 00:25:23,820
<font color="#E5E5E5">point the point the manifest file that I</font>

709
00:25:23,400 --> 00:25:26,700
<font color="#CCCCCC">uploaded</font>

710
00:25:23,820 --> 00:25:28,739
<font color="#E5E5E5">-</font><font color="#CCCCCC"> -</font><font color="#E5E5E5"> Mike my code on the</font><font color="#CCCCCC"> internet</font><font color="#E5E5E5"> which</font>

711
00:25:26,700 --> 00:25:31,739
is<font color="#CCCCCC"> it's hosting web server</font><font color="#E5E5E5"> and that</font><font color="#CCCCCC"> can</font>

712
00:25:28,739 --> 00:25:34,529
be<font color="#E5E5E5"> HTML Javascript whatever you want</font><font color="#CCCCCC"> and</font>

713
00:25:31,739 --> 00:25:36,179
the<font color="#CCCCCC"> outlook desktop client</font><font color="#E5E5E5"> or well yeah</font>

714
00:25:34,529 --> 00:25:37,859
so<font color="#CCCCCC"> that I</font><font color="#E5E5E5"> would note here is that the</font>

715
00:25:36,179 --> 00:25:40,590
<font color="#CCCCCC">outlook desktop client uses</font><font color="#E5E5E5"> edge so like</font>

716
00:25:37,859 --> 00:25:42,658
<font color="#E5E5E5">we use the outlook desktop client</font><font color="#CCCCCC"> the</font>

717
00:25:40,590 --> 00:25:44,879
actual browser is<font color="#E5E5E5"> the underlying is</font>

718
00:25:42,659 --> 00:25:46,409
using edge so let's walk through a<font color="#CCCCCC"> few</font>

719
00:25:44,879 --> 00:25:48,238
<font color="#E5E5E5">examples</font><font color="#CCCCCC"> here so how do you install an</font>

720
00:25:46,409 --> 00:25:51,419
add-in<font color="#CCCCCC"> so first you go to</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> settings</font>

721
00:25:48,239 --> 00:25:53,669
<font color="#E5E5E5">in Outlook you click manage ad ends then</font>

722
00:25:51,419 --> 00:25:55,229
<font color="#CCCCCC">you go</font><font color="#E5E5E5"> over to this the custom add-ins</font>

723
00:25:53,669 --> 00:25:56,999
<font color="#E5E5E5">spot down</font><font color="#CCCCCC"> there where you see the</font><font color="#E5E5E5"> plus</font>

724
00:25:55,229 --> 00:25:59,129
sign out<font color="#E5E5E5"> of custom</font><font color="#CCCCCC"> add-in and then you</font>

725
00:25:56,999 --> 00:26:00,659
add from file<font color="#E5E5E5"> and with with that</font><font color="#CCCCCC"> file</font>

726
00:25:59,129 --> 00:26:03,029
you're essentially<font color="#E5E5E5"> just uploading your</font>

727
00:26:00,659 --> 00:26:05,340
manifest XML file which<font color="#E5E5E5"> you can</font><font color="#CCCCCC"> generate</font>

728
00:26:03,029 --> 00:26:07,649
<font color="#CCCCCC">with Visual Studio</font><font color="#E5E5E5"> so visual studio</font>

729
00:26:05,340 --> 00:26:09,779
already<font color="#E5E5E5"> has the template for</font><font color="#CCCCCC"> it</font><font color="#E5E5E5"> for</font>

730
00:26:07,649 --> 00:26:11,908
<font color="#E5E5E5">creating an</font><font color="#CCCCCC"> outlook web Adam you</font><font color="#E5E5E5"> can go</font>

731
00:26:09,779 --> 00:26:14,009
in a visual<font color="#E5E5E5"> studio pop out a quick out</font>

732
00:26:11,909 --> 00:26:15,389
<font color="#CCCCCC">Mike outlook web ad n which includes</font>

733
00:26:14,009 --> 00:26:17,759
your<font color="#E5E5E5"> manifest it'll include the HTML</font>

734
00:26:15,389 --> 00:26:20,580
files for creating a very basic<font color="#E5E5E5"> add-in</font>

735
00:26:17,759 --> 00:26:23,129
<font color="#E5E5E5">and you host the HTML files on your web</font>

736
00:26:20,580 --> 00:26:24,989
<font color="#E5E5E5">server you point the domain and stuff</font>

737
00:26:23,129 --> 00:26:27,748
for<font color="#E5E5E5"> in the end the manifest file at your</font>

738
00:26:24,989 --> 00:26:29,460
your server<font color="#CCCCCC"> and it does require HTTP</font>

739
00:26:27,749 --> 00:26:31,409
Microsoft's trying to be secure so<font color="#CCCCCC"> you</font>

740
00:26:29,460 --> 00:26:35,639
can't just host<font color="#E5E5E5"> it on an HTTP site so</font>

741
00:26:31,409 --> 00:26:38,249
there's yeah there's<font color="#CCCCCC"> a Microsoft so</font>

742
00:26:35,639 --> 00:26:40,379
here's here's<font color="#E5E5E5"> an idea</font><font color="#CCCCCC"> this is this one</font>

743
00:26:38,249 --> 00:26:41,820
is<font color="#CCCCCC"> Mike so</font><font color="#E5E5E5"> Mike actually showed</font><font color="#CCCCCC"> me this</font>

744
00:26:40,379 --> 00:26:44,219
to begin<font color="#E5E5E5"> with like this whole idea of</font>

745
00:26:41,820 --> 00:26:46,799
<font color="#CCCCCC">doing a dense</font><font color="#E5E5E5"> and his idea was what if</font>

746
00:26:44,220 --> 00:26:49,320
we just backdoor their email like what

747
00:26:46,799 --> 00:26:51,029
if we just created an<font color="#E5E5E5"> add-in that just</font>

748
00:26:49,320 --> 00:26:53,279
sent us the content of every<font color="#E5E5E5"> single</font>

749
00:26:51,029 --> 00:26:55,169
<font color="#E5E5E5">email that they got I got</font><font color="#CCCCCC"> some quick and</font>

750
00:26:53,279 --> 00:26:56,549
easy backdoor<font color="#CCCCCC"> you know like you know you</font>

751
00:26:55,169 --> 00:26:57,869
lose<font color="#CCCCCC"> access like let's say they change</font>

752
00:26:56,549 --> 00:26:59,340
their password but that<font color="#E5E5E5"> add-in keeps</font>

753
00:26:57,869 --> 00:27:02,249
sending you their email<font color="#E5E5E5"> that's that's</font>

754
00:26:59,340 --> 00:27:05,070
pretty<font color="#CCCCCC"> nice</font><font color="#E5E5E5"> so we have we have some</font>

755
00:27:02,249 --> 00:27:06,869
proof<font color="#E5E5E5"> of concept code to share later on</font>

756
00:27:05,070 --> 00:27:08,879
<font color="#E5E5E5">that does this on the desktop client</font>

757
00:27:06,869 --> 00:27:10,859
very<font color="#E5E5E5"> easily we're on the desktop client</font>

758
00:27:08,879 --> 00:27:12,059
it literally<font color="#E5E5E5"> just forwards emails as</font>

759
00:27:10,859 --> 00:27:13,439
they come in<font color="#E5E5E5"> your inbox like you don't</font>

760
00:27:12,059 --> 00:27:18,779
<font color="#E5E5E5">have to have them open</font><font color="#CCCCCC"> like</font><font color="#E5E5E5"> they just it</font>

761
00:27:13,440 --> 00:27:19,859
pops<font color="#E5E5E5"> in</font><font color="#CCCCCC"> inbox</font><font color="#E5E5E5"> comes to me so I started</font>

762
00:27:18,779 --> 00:27:21,960
<font color="#CCCCCC">looking a little further what</font><font color="#E5E5E5"> else could</font>

763
00:27:19,859 --> 00:27:28,019
<font color="#E5E5E5">we do what if we could hook their</font>

764
00:27:21,960 --> 00:27:30,599
browser with beef it works so get this<font color="#E5E5E5"> I</font>

765
00:27:28,019 --> 00:27:33,029
I create an<font color="#E5E5E5"> add-in that literally just</font>

766
00:27:30,599 --> 00:27:34,289
<font color="#E5E5E5">points to my my beef hook it syncs</font>

767
00:27:33,029 --> 00:27:36,149
across the<font color="#E5E5E5"> internet to my</font><font color="#CCCCCC"> victims</font>

768
00:27:34,289 --> 00:27:37,860
<font color="#E5E5E5">browser they log in for work for the day</font>

769
00:27:36,149 --> 00:27:42,659
<font color="#E5E5E5">open up the next email BAM</font>

770
00:27:37,860 --> 00:27:44,729
<font color="#E5E5E5">be yeah yeah it's uh good stuff</font>

771
00:27:42,660 --> 00:27:46,770
so with beef beef has a lot<font color="#CCCCCC"> of</font><font color="#E5E5E5"> different</font>

772
00:27:44,730 --> 00:27:49,140
plugins so a number<font color="#CCCCCC"> of</font><font color="#E5E5E5"> different things</font>

773
00:27:46,770 --> 00:27:50,549
<font color="#E5E5E5">there are already part of beef and this</font>

774
00:27:49,140 --> 00:27:53,640
<font color="#E5E5E5">is this</font><font color="#CCCCCC"> is a great example of how</font><font color="#E5E5E5"> you</font>

775
00:27:50,549 --> 00:27:55,350
<font color="#E5E5E5">could literally get code execution in a</font>

776
00:27:53,640 --> 00:27:57,150
browser<font color="#E5E5E5"> across the internet I mean</font><font color="#CCCCCC"> like</font>

777
00:27:55,350 --> 00:28:00,389
doing things<font color="#E5E5E5"> like</font><font color="#CCCCCC"> enumerated the</font>

778
00:27:57,150 --> 00:28:01,799
political system you can you can

779
00:28:00,390 --> 00:28:04,410
actually<font color="#CCCCCC"> have them browse</font><font color="#E5E5E5"> to whatever</font>

780
00:28:01,799 --> 00:28:06,750
link<font color="#E5E5E5"> you want you can have them</font><font color="#CCCCCC"> you</font><font color="#E5E5E5"> can</font>

781
00:28:04,410 --> 00:28:08,549
start doing<font color="#E5E5E5"> some local Leon enumeration</font>

782
00:28:06,750 --> 00:28:10,380
you can serve up more file it's like

783
00:28:08,549 --> 00:28:12,629
what if I<font color="#E5E5E5"> just</font><font color="#CCCCCC"> served</font><font color="#E5E5E5"> up</font><font color="#CCCCCC"> HT a is through</font>

784
00:28:10,380 --> 00:28:16,429
beef<font color="#E5E5E5"> like I can just make it pop up in</font>

785
00:28:12,630 --> 00:28:19,679
<font color="#CCCCCC">your</font><font color="#E5E5E5"> and your and</font><font color="#CCCCCC"> your client it's great</font>

786
00:28:16,429 --> 00:28:22,020
<font color="#CCCCCC">so this this is something we literally</font>

787
00:28:19,679 --> 00:28:23,870
just<font color="#E5E5E5"> did last week so we need more</font>

788
00:28:22,020 --> 00:28:25,590
<font color="#E5E5E5">research</font><font color="#CCCCCC"> time to</font><font color="#E5E5E5"> figure out like what</font>

789
00:28:23,870 --> 00:28:28,770
implications what<font color="#E5E5E5"> else we can do</font><font color="#CCCCCC"> with</font>

790
00:28:25,590 --> 00:28:30,570
this<font color="#E5E5E5"> but yeah that's the one thing right</font>

791
00:28:28,770 --> 00:28:34,020
my favorite<font color="#CCCCCC"> is to just just start mining</font>

792
00:28:30,570 --> 00:28:36,178
cryptocurrency<font color="#E5E5E5"> and the browser</font><font color="#CCCCCC"> so coin</font>

793
00:28:34,020 --> 00:28:38,610
<font color="#CCCCCC">hive is</font><font color="#E5E5E5"> JavaScript</font><font color="#CCCCCC"> rate space miner or</font>

794
00:28:36,179 --> 00:28:43,169
in the outlook or in the<font color="#CCCCCC"> app like</font>

795
00:28:38,610 --> 00:28:45,389
<font color="#CCCCCC">desktop</font><font color="#E5E5E5"> client so what about deploying</font>

796
00:28:43,169 --> 00:28:47,940
<font color="#E5E5E5">it across everyone so as a know 365</font>

797
00:28:45,390 --> 00:28:50,580
admin you<font color="#E5E5E5"> can create these add-ins</font><font color="#CCCCCC"> in</font>

798
00:28:47,940 --> 00:28:52,740
the admin portal and deploy it<font color="#CCCCCC"> to every</font>

799
00:28:50,580 --> 00:28:54,240
employee of<font color="#E5E5E5"> the organization</font><font color="#CCCCCC"> and make it</font>

800
00:28:52,740 --> 00:28:59,100
mandatory so they can't<font color="#CCCCCC"> even uninstall</font>

801
00:28:54,240 --> 00:29:00,900
it so anyway so use your<font color="#E5E5E5"> imagination</font><font color="#CCCCCC"> how</font>

802
00:28:59,100 --> 00:29:03,110
<font color="#E5E5E5">about that could be so let me show you</font><font color="#CCCCCC"> a</font>

803
00:29:00,900 --> 00:29:03,110
demo

804
00:29:07,380 --> 00:29:11,760
<font color="#CCCCCC">all right so pretend we're</font><font color="#E5E5E5"> the attacker</font>

805
00:29:09,450 --> 00:29:15,030
<font color="#E5E5E5">we fish to cred we're about to login</font><font color="#CCCCCC"> to</font>

806
00:29:11,760 --> 00:29:17,490
<font color="#CCCCCC">our outlook portal we fished beau at</font>

807
00:29:15,030 --> 00:29:21,570
<font color="#E5E5E5">blue team dot</font><font color="#CCCCCC"> lols</font><font color="#E5E5E5"> email and is in his</font>

808
00:29:17,490 --> 00:29:27,559
<font color="#CCCCCC">password</font><font color="#E5E5E5"> so we're gonna log in on</font><font color="#CCCCCC"> the</font>

809
00:29:21,570 --> 00:29:31,350
attacker side<font color="#CCCCCC"> all right</font>

810
00:29:27,559 --> 00:29:33,780
Ogden now look and now let's go ahead

811
00:29:31,350 --> 00:29:38,039
<font color="#E5E5E5">and create</font><font color="#CCCCCC"> our or add in so we go</font><font color="#E5E5E5"> to</font>

812
00:29:33,780 --> 00:29:40,399
<font color="#E5E5E5">settings and</font><font color="#CCCCCC"> we're gonna</font><font color="#E5E5E5"> manage our</font>

813
00:29:38,039 --> 00:29:40,400
<font color="#E5E5E5">add-ins</font>

814
00:29:46,240 --> 00:29:51,640
and then click<font color="#E5E5E5"> on my Eddins and then</font>

815
00:29:49,270 --> 00:29:54,670
down at the<font color="#E5E5E5"> bottom</font><font color="#CCCCCC"> you'll see add custom</font>

816
00:29:51,640 --> 00:29:59,860
add-ins<font color="#E5E5E5"> out of custom add-in so we click</font>

817
00:29:54,670 --> 00:30:02,650
that<font color="#CCCCCC"> ad from file</font><font color="#E5E5E5"> and</font><font color="#CCCCCC"> we're gonna upload</font>

818
00:29:59,860 --> 00:30:03,879
<font color="#E5E5E5">our manifest that XML file</font><font color="#CCCCCC"> I remember</font>

819
00:30:02,650 --> 00:30:06,310
this is all<font color="#CCCCCC"> in these hacker side so this</font>

820
00:30:03,880 --> 00:30:08,740
<font color="#E5E5E5">is installing the add-in in my browser</font>

821
00:30:06,310 --> 00:30:12,280
<font color="#E5E5E5">right so it's currently installed well</font>

822
00:30:08,740 --> 00:30:16,090
it's<font color="#CCCCCC"> it's installed for the user and if</font>

823
00:30:12,280 --> 00:30:17,290
we go open<font color="#E5E5E5"> up an email you'll see a</font>

824
00:30:16,090 --> 00:30:18,970
little icon now so we got this<font color="#E5E5E5"> little</font>

825
00:30:17,290 --> 00:30:22,060
<font color="#E5E5E5">icon that's the add-on right so if I</font>

826
00:30:18,970 --> 00:30:23,680
click that<font color="#E5E5E5"> it runs my addict and you'll</font>

827
00:30:22,060 --> 00:30:26,470
see<font color="#E5E5E5"> kind of in the background here in a</font>

828
00:30:23,680 --> 00:30:28,210
second<font color="#CCCCCC"> over to the</font><font color="#E5E5E5"> left</font><font color="#CCCCCC"> see the see the</font>

829
00:30:26,470 --> 00:30:30,040
the the thing that<font color="#CCCCCC"> you popped over</font><font color="#E5E5E5"> the</font>

830
00:30:28,210 --> 00:30:32,650
left there to the right that's um<font color="#CCCCCC"> that's</font>

831
00:30:30,040 --> 00:30:34,510
<font color="#CCCCCC">beef hooking my browser right</font><font color="#E5E5E5"> now</font>

832
00:30:32,650 --> 00:30:36,970
<font color="#E5E5E5">currently so that's just showing like</font>

833
00:30:34,510 --> 00:30:40,900
<font color="#CCCCCC">okay I added my add-on</font><font color="#E5E5E5"> it works</font><font color="#CCCCCC"> I'm now</font>

834
00:30:36,970 --> 00:30:42,700
<font color="#E5E5E5">be</font><font color="#CCCCCC"> pokes</font><font color="#E5E5E5"> myself okay so let's let's go</font>

835
00:30:40,900 --> 00:30:43,150
ahead and see yep<font color="#E5E5E5"> beef beef hook the</font>

836
00:30:42,700 --> 00:30:49,110
browser

837
00:30:43,150 --> 00:30:51,280
so now let's pin it<font color="#E5E5E5"> and go over</font><font color="#CCCCCC"> to the</font>

838
00:30:49,110 --> 00:30:53,260
<font color="#CCCCCC">the victim side so this</font><font color="#E5E5E5"> would be the</font>

839
00:30:51,280 --> 00:30:55,540
victim<font color="#E5E5E5"> logging into outlook for the day</font>

840
00:30:53,260 --> 00:30:58,000
they're gonna<font color="#CCCCCC"> log in for work</font><font color="#E5E5E5"> check</font>

841
00:30:55,540 --> 00:31:00,879
check<font color="#CCCCCC"> some email see if they got any</font>

842
00:30:58,000 --> 00:31:02,740
sweet memes<font color="#E5E5E5"> any cat pics you could you</font>

843
00:31:00,880 --> 00:31:04,060
<font color="#E5E5E5">can make that panel</font><font color="#CCCCCC"> to there's some work</font>

844
00:31:02,740 --> 00:31:05,800
<font color="#E5E5E5">that you could do to make that panel so</font>

845
00:31:04,060 --> 00:31:07,450
it's<font color="#E5E5E5"> hidden</font><font color="#CCCCCC"> yes yeah so there's that</font>

846
00:31:05,800 --> 00:31:08,470
yeah that's<font color="#E5E5E5"> the</font><font color="#CCCCCC"> other thing we should</font>

847
00:31:07,450 --> 00:31:10,570
definitely<font color="#CCCCCC"> mention is that</font><font color="#E5E5E5"> this is</font>

848
00:31:08,470 --> 00:31:13,170
mostly a<font color="#E5E5E5"> demo just to show how this</font><font color="#CCCCCC"> is</font>

849
00:31:10,570 --> 00:31:15,580
working<font color="#CCCCCC"> you can hide that</font><font color="#E5E5E5"> panel</font>

850
00:31:13,170 --> 00:31:16,960
so you'll see whenever<font color="#E5E5E5"> they just click</font>

851
00:31:15,580 --> 00:31:23,139
an email<font color="#E5E5E5"> that's all I did click an email</font>

852
00:31:16,960 --> 00:31:28,240
open an email<font color="#E5E5E5"> hands-off add-in pops</font><font color="#CCCCCC"> in</font>

853
00:31:23,140 --> 00:31:30,130
now<font color="#CCCCCC"> now there it is</font><font color="#E5E5E5"> so Adam pops so that</font>

854
00:31:28,240 --> 00:31:31,710
syncs across all<font color="#CCCCCC"> their</font><font color="#E5E5E5"> all the browser</font>

855
00:31:30,130 --> 00:31:34,810
sessions<font color="#CCCCCC"> anytime they'll go</font><font color="#E5E5E5"> to</font><font color="#CCCCCC"> log in</font>

856
00:31:31,710 --> 00:31:37,120
<font color="#E5E5E5">there's a new session and hey beef hook</font>

857
00:31:34,810 --> 00:31:41,700
to their browser across the<font color="#CCCCCC"> internet</font>

858
00:31:37,120 --> 00:31:41,699
that's that's awesome<font color="#CCCCCC"> thanks Microsoft</font>

859
00:31:42,390 --> 00:31:47,320
<font color="#E5E5E5">okay so let's just</font><font color="#CCCCCC"> show</font><font color="#E5E5E5"> some quick</font>

860
00:31:45,430 --> 00:31:48,850
examples<font color="#CCCCCC"> of what you</font><font color="#E5E5E5"> could do with a</font>

861
00:31:47,320 --> 00:31:50,020
<font color="#CCCCCC">beef oak like this there's a</font><font color="#E5E5E5"> lot of</font>

862
00:31:48,850 --> 00:31:51,070
things you can do with beef this<font color="#E5E5E5"> is just</font>

863
00:31:50,020 --> 00:31:54,400
a quick<font color="#CCCCCC"> example just to</font><font color="#E5E5E5"> show it's</font>

864
00:31:51,070 --> 00:31:57,520
actually working<font color="#E5E5E5"> in the</font><font color="#CCCCCC"> browser so let's</font>

865
00:31:54,400 --> 00:31:59,620
send a very generic<font color="#E5E5E5"> credential prompt so</font>

866
00:31:57,520 --> 00:32:01,570
this is like your standard<font color="#CCCCCC"> windows</font>

867
00:31:59,620 --> 00:32:03,429
<font color="#CCCCCC">credential hey you you know you've been</font>

868
00:32:01,570 --> 00:32:04,689
logged out of<font color="#E5E5E5"> the network login and you</font>

869
00:32:03,430 --> 00:32:09,550
can see<font color="#E5E5E5"> over here</font><font color="#CCCCCC"> we got</font><font color="#E5E5E5"> the credential</font>

870
00:32:04,690 --> 00:32:12,400
prompt<font color="#E5E5E5"> so give me your creds</font><font color="#CCCCCC"> and I just</font>

871
00:32:09,550 --> 00:32:14,320
type like<font color="#E5E5E5"> user test user pass and it</font>

872
00:32:12,400 --> 00:32:15,910
should get sent over or test user test

873
00:32:14,320 --> 00:32:20,230
passing should get sent over<font color="#E5E5E5"> to the</font>

874
00:32:15,910 --> 00:32:24,100
<font color="#CCCCCC">server side so beef is working nothing</font>

875
00:32:20,230 --> 00:32:29,680
<font color="#CCCCCC">to see here</font><font color="#E5E5E5"> go back over check the</font><font color="#CCCCCC"> log</font>

876
00:32:24,100 --> 00:32:32,260
<font color="#E5E5E5">and username and password are there</font><font color="#CCCCCC"> okay</font>

877
00:32:29,680 --> 00:32:34,630
<font color="#E5E5E5">so let's have</font><font color="#CCCCCC"> some</font><font color="#E5E5E5"> more</font><font color="#CCCCCC"> fun</font><font color="#E5E5E5"> like I said</font>

878
00:32:32,260 --> 00:32:37,540
like we have we have a podcast<font color="#CCCCCC"> about</font>

879
00:32:34,630 --> 00:32:40,179
cryptocurrency security so why don't we

880
00:32:37,540 --> 00:32:40,990
<font color="#CCCCCC">mined some cryptocurrency I mean it</font>

881
00:32:40,179 --> 00:32:43,140
seems<font color="#E5E5E5"> to be the hot thing these days</font>

882
00:32:40,990 --> 00:32:46,540
<font color="#CCCCCC">right it's like</font><font color="#E5E5E5"> the latest it's the most</font>

883
00:32:43,140 --> 00:32:49,240
most like I guess notorious malware out

884
00:32:46,540 --> 00:32:51,580
<font color="#CCCCCC">there coin I've at this point</font><font color="#E5E5E5"> so what</font>

885
00:32:49,240 --> 00:32:52,780
I'm doing<font color="#CCCCCC"> is</font><font color="#E5E5E5"> I'm actually using</font><font color="#CCCCCC"> what I</font>

886
00:32:51,580 --> 00:32:54,309
<font color="#E5E5E5">just did there</font><font color="#CCCCCC"> is I stopped Apache I</font>

887
00:32:52,780 --> 00:32:56,950
started<font color="#E5E5E5"> nginx because I'm actually going</font>

888
00:32:54,309 --> 00:32:58,690
<font color="#E5E5E5">to</font><font color="#CCCCCC"> use it</font><font color="#E5E5E5"> reverse proxy through nginx to</font>

889
00:32:56,950 --> 00:33:00,460
the coin hive mining pools<font color="#E5E5E5"> and the</font>

890
00:32:58,690 --> 00:33:03,460
reason I do that is because of cross

891
00:33:00,460 --> 00:33:05,559
domain<font color="#E5E5E5"> policy so anything</font><font color="#CCCCCC"> that I need to</font>

892
00:33:03,460 --> 00:33:07,809
serve up to<font color="#E5E5E5"> that victim has</font><font color="#CCCCCC"> to come to</font>

893
00:33:05,559 --> 00:33:10,540
my domain<font color="#E5E5E5"> that I've already hooked so</font>

894
00:33:07,809 --> 00:33:12,550
I'm sending<font color="#E5E5E5"> them back</font><font color="#CCCCCC"> to my my my web</font>

895
00:33:10,540 --> 00:33:14,260
hook<font color="#E5E5E5"> that I'm</font><font color="#CCCCCC"> hosting which has coin</font>

896
00:33:12,550 --> 00:33:16,240
I've so in order<font color="#CCCCCC"> to see a</font><font color="#E5E5E5"> coin I was</font>

897
00:33:14,260 --> 00:33:18,400
working<font color="#E5E5E5"> let's go to the developer tools</font>

898
00:33:16,240 --> 00:33:21,130
console so<font color="#E5E5E5"> that if you open</font><font color="#CCCCCC"> up developer</font>

899
00:33:18,400 --> 00:33:23,020
tools console you<font color="#E5E5E5"> can actually see hey</font>

900
00:33:21,130 --> 00:33:28,050
Khoi knives working in the browser we're

901
00:33:23,020 --> 00:33:28,050
mining cryptocurrency<font color="#E5E5E5"> when</font><font color="#CCCCCC"> lambo</font>

902
00:33:32,890 --> 00:33:36,769
[Applause]

903
00:33:39,600 --> 00:33:47,760
<font color="#E5E5E5">all right so thanks for the nightmares</font>

904
00:33:42,400 --> 00:33:51,730
<font color="#CCCCCC">what now well so this girl comes back</font><font color="#E5E5E5"> to</font>

905
00:33:47,760 --> 00:33:53,350
credentials<font color="#E5E5E5"> to be honest and it's it's</font>

906
00:33:51,730 --> 00:33:56,289
<font color="#E5E5E5">honestly we spent a good amount of time</font>

907
00:33:53,350 --> 00:33:57,760
<font color="#E5E5E5">trying</font><font color="#CCCCCC"> to think what what's the</font><font color="#E5E5E5"> best way</font>

908
00:33:56,289 --> 00:33:59,860
to fix this<font color="#E5E5E5"> how do we fix it where do we</font>

909
00:33:57,760 --> 00:34:01,330
find<font color="#CCCCCC"> the information to fix it</font><font color="#E5E5E5"> so</font>

910
00:33:59,860 --> 00:34:03,100
looking around in<font color="#CCCCCC"> the</font><font color="#E5E5E5"> admin portal</font><font color="#CCCCCC"> I</font>

911
00:34:01,330 --> 00:34:06,129
don't actually see<font color="#CCCCCC"> away I mean</font><font color="#E5E5E5"> if</font>

912
00:34:03,100 --> 00:34:07,389
somebody<font color="#E5E5E5"> knows how to do this</font><font color="#CCCCCC"> in 365</font>

913
00:34:06,130 --> 00:34:09,399
portal please come up<font color="#CCCCCC"> and tell me cuz</font>

914
00:34:07,390 --> 00:34:11,740
I'm really<font color="#E5E5E5"> curious</font><font color="#CCCCCC"> I could not find a</font>

915
00:34:09,399 --> 00:34:15,399
<font color="#CCCCCC">way that you can prevent or remove an</font>

916
00:34:11,739 --> 00:34:19,330
add-in<font color="#E5E5E5"> from one of your</font><font color="#CCCCCC"> users clients</font>

917
00:34:15,399 --> 00:34:26,109
like I<font color="#E5E5E5"> don't see a way</font><font color="#CCCCCC"> to do it so</font><font color="#E5E5E5"> that</font>

918
00:34:19,330 --> 00:34:27,730
<font color="#CCCCCC">the weights you actually so John</font><font color="#E5E5E5"> says is</font>

919
00:34:26,109 --> 00:34:29,739
there a way<font color="#CCCCCC"> to query what's installed I</font>

920
00:34:27,730 --> 00:34:33,040
don't see that<font color="#E5E5E5"> either</font><font color="#CCCCCC"> I don't I</font><font color="#E5E5E5"> mean</font>

921
00:34:29,739 --> 00:34:35,888
that's yeah so for<font color="#CCCCCC"> us right now like the</font>

922
00:34:33,040 --> 00:34:38,859
<font color="#E5E5E5">best fix I say I have is</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> FA and have</font>

923
00:34:35,889 --> 00:34:40,510
a strong password policy and hope<font color="#E5E5E5"> your</font>

924
00:34:38,859 --> 00:34:45,899
users aren't installing coin I<font color="#E5E5E5"> have</font><font color="#CCCCCC"> in</font>

925
00:34:40,510 --> 00:34:45,899
the browser<font color="#CCCCCC"> all</font><font color="#E5E5E5"> right all right cool</font><font color="#CCCCCC"> I</font>

926
00:34:49,409 --> 00:34:55,090
think this one<font color="#CCCCCC"> is like I</font><font color="#E5E5E5"> don't know the</font>

927
00:34:52,060 --> 00:34:59,500
icing<font color="#CCCCCC"> on the cake of all these so this</font>

928
00:34:55,090 --> 00:35:01,440
one was<font color="#E5E5E5"> fun</font><font color="#CCCCCC"> so we ended up I went to</font>

929
00:34:59,500 --> 00:35:05,109
<font color="#CCCCCC">blackhat and if anybody went</font><font color="#E5E5E5"> a black hat</font>

930
00:35:01,440 --> 00:35:08,290
there was a talk by Alex<font color="#E5E5E5"> I on skew and</font>

931
00:35:05,109 --> 00:35:09,850
<font color="#CCCCCC">Gabriela viola</font><font color="#E5E5E5"> on on like kind of an</font>

932
00:35:08,290 --> 00:35:12,220
untapped attack surface<font color="#E5E5E5"> kind of within</font>

933
00:35:09,850 --> 00:35:14,950
<font color="#E5E5E5">the core kernel of Microsoft Windows and</font>

934
00:35:12,220 --> 00:35:16,480
and they went over<font color="#CCCCCC"> the data structures</font>

935
00:35:14,950 --> 00:35:17,890
and they went<font color="#CCCCCC"> over the</font><font color="#E5E5E5"> kind of concepts</font>

936
00:35:16,480 --> 00:35:19,720
of how to interact with<font color="#E5E5E5"> it</font><font color="#CCCCCC"> and what it's</font>

937
00:35:17,890 --> 00:35:22,150
<font color="#CCCCCC">capable of doing and they really did a</font>

938
00:35:19,720 --> 00:35:23,560
really great job of<font color="#CCCCCC"> that</font><font color="#E5E5E5"> I wouldn't be</font>

939
00:35:22,150 --> 00:35:27,190
able<font color="#E5E5E5"> to</font><font color="#CCCCCC"> have research</font><font color="#E5E5E5"> this if it wasn't</font>

940
00:35:23,560 --> 00:35:28,869
<font color="#CCCCCC">for seeing their talk and and them you</font>

941
00:35:27,190 --> 00:35:29,800
know sharing their<font color="#CCCCCC"> information and so</font>

942
00:35:28,869 --> 00:35:32,590
some of<font color="#E5E5E5"> the stuff</font><font color="#CCCCCC"> that we're going to</font>

943
00:35:29,800 --> 00:35:34,090
<font color="#E5E5E5">talk about here is it's not patched by</font>

944
00:35:32,590 --> 00:35:35,590
<font color="#CCCCCC">Windows there's a lot of vulnerabilities</font>

945
00:35:34,090 --> 00:35:37,960
here we're<font color="#E5E5E5"> not gonna get into a lot of</font>

946
00:35:35,590 --> 00:35:39,790
the vulnerabilities<font color="#E5E5E5"> that that are</font>

947
00:35:37,960 --> 00:35:42,250
actually affecting<font color="#CCCCCC"> the kernel or the</font>

948
00:35:39,790 --> 00:35:44,200
<font color="#E5E5E5">services of Windows</font><font color="#CCCCCC"> um I just</font>

949
00:35:42,250 --> 00:35:45,190
<font color="#CCCCCC">I'm weaponizing some of the theories</font>

950
00:35:44,200 --> 00:35:47,618
that<font color="#E5E5E5"> they brought</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> the table that</font>

951
00:35:45,190 --> 00:35:48,430
<font color="#CCCCCC">could</font><font color="#E5E5E5"> be used for this and once I saw it</font>

952
00:35:47,619 --> 00:35:49,510
<font color="#E5E5E5">it was inspiring</font>

953
00:35:48,430 --> 00:35:50,919
so that's really what we're gonna kind

954
00:35:49,510 --> 00:35:53,560
of step through<font color="#CCCCCC"> a little bit</font><font color="#E5E5E5"> we're gonna</font>

955
00:35:50,920 --> 00:35:54,730
talk<font color="#CCCCCC"> about</font><font color="#E5E5E5"> Windows low-level kernel but</font>

956
00:35:53,560 --> 00:35:55,960
we're not gonna get into<font color="#E5E5E5"> the details</font>

957
00:35:54,730 --> 00:35:57,730
like we're just<font color="#CCCCCC"> gonna</font><font color="#E5E5E5"> kind</font><font color="#CCCCCC"> of do it from</font>

958
00:35:55,960 --> 00:35:59,200
a summary<font color="#CCCCCC"> I don't want to</font><font color="#E5E5E5"> make this or a</font>

959
00:35:57,730 --> 00:36:01,510
super technical<font color="#E5E5E5"> I wanna make this more</font>

960
00:35:59,200 --> 00:36:03,100
<font color="#CCCCCC">of applicable</font><font color="#E5E5E5"> and so the first</font><font color="#CCCCCC"> thing</font>

961
00:36:01,510 --> 00:36:05,110
that<font color="#E5E5E5"> we're</font><font color="#CCCCCC"> gonna talk about is what is</font>

962
00:36:03,100 --> 00:36:06,790
this<font color="#E5E5E5"> thing</font><font color="#CCCCCC"> that</font><font color="#E5E5E5"> I'm talking about is w</font>

963
00:36:05,110 --> 00:36:08,980
<font color="#E5E5E5">NF it's the Windows notification</font>

964
00:36:06,790 --> 00:36:11,590
facility<font color="#CCCCCC"> and the idea behind this is</font>

965
00:36:08,980 --> 00:36:15,040
<font color="#E5E5E5">it's a publish and subscribe subsystem</font>

966
00:36:11,590 --> 00:36:17,770
of Windows<font color="#CCCCCC"> at a really low</font><font color="#E5E5E5"> level in the</font>

967
00:36:15,040 --> 00:36:21,130
ntdll<font color="#E5E5E5"> the idea behind it is it allows</font>

968
00:36:17,770 --> 00:36:24,640
<font color="#CCCCCC">for dispatching</font><font color="#E5E5E5"> of data and events to</font>

969
00:36:21,130 --> 00:36:27,220
<font color="#CCCCCC">Windows processes and it's a cross user</font>

970
00:36:24,640 --> 00:36:29,379
mode and<font color="#E5E5E5"> kernel mode and so you have the</font>

971
00:36:27,220 --> 00:36:31,990
<font color="#E5E5E5">ability to</font><font color="#CCCCCC"> subscribe and get notified</font>

972
00:36:29,380 --> 00:36:34,210
when an event changes within the<font color="#E5E5E5"> Windows</font>

973
00:36:31,990 --> 00:36:35,500
kernel<font color="#CCCCCC"> I think it started</font><font color="#E5E5E5"> as</font><font color="#CCCCCC"> Clippy like</font>

974
00:36:34,210 --> 00:36:37,030
way back<font color="#E5E5E5"> in the day and then they just</font>

975
00:36:35,500 --> 00:36:39,370
said<font color="#CCCCCC"> it</font><font color="#E5E5E5"> was such an</font><font color="#CCCCCC"> awesome idea</font><font color="#E5E5E5"> let's</font>

976
00:36:37,030 --> 00:36:41,710
like make<font color="#CCCCCC"> this forever so they made it</font><font color="#E5E5E5"> a</font>

977
00:36:39,370 --> 00:36:42,940
part<font color="#E5E5E5"> of the kernel</font><font color="#CCCCCC"> and it's</font><font color="#E5E5E5"> super</font>

978
00:36:41,710 --> 00:36:45,910
undocumented you're not gonna find

979
00:36:42,940 --> 00:36:47,800
anything any documentation on<font color="#CCCCCC"> WN F and</font>

980
00:36:45,910 --> 00:36:50,259
if you do<font color="#E5E5E5"> like you're gonna find it on a</font>

981
00:36:47,800 --> 00:36:53,500
blog or some other information<font color="#E5E5E5"> kind of</font>

982
00:36:50,260 --> 00:36:55,450
about<font color="#CCCCCC"> WN F and so the idea behind</font><font color="#E5E5E5"> it is</font>

983
00:36:53,500 --> 00:36:58,030
you could<font color="#CCCCCC"> subscribe to events within</font>

984
00:36:55,450 --> 00:37:00,069
<font color="#E5E5E5">Windows and you don't ever have</font><font color="#CCCCCC"> to have</font>

985
00:36:58,030 --> 00:37:01,810
anything pub<font color="#E5E5E5"> before right so you could</font>

986
00:37:00,070 --> 00:37:03,370
<font color="#E5E5E5">you could just subscribe and then wait</font>

987
00:37:01,810 --> 00:37:05,980
so if you're waiting<font color="#CCCCCC"> on some</font><font color="#E5E5E5"> hardware to</font>

988
00:37:03,370 --> 00:37:07,720
load<font color="#CCCCCC"> when</font><font color="#E5E5E5"> that</font><font color="#CCCCCC"> Hardware loads it</font>

989
00:37:05,980 --> 00:37:10,240
notifies<font color="#E5E5E5"> the Windows kernel the Windows</font>

990
00:37:07,720 --> 00:37:12,580
kernel<font color="#E5E5E5"> says hey who's all subscribed to</font>

991
00:37:10,240 --> 00:37:14,950
this event<font color="#E5E5E5"> and let me call back the</font><font color="#CCCCCC"> the</font>

992
00:37:12,580 --> 00:37:16,600
callback functions<font color="#E5E5E5"> in the context of</font>

993
00:37:14,950 --> 00:37:18,250
<font color="#E5E5E5">those</font><font color="#CCCCCC"> processes so that</font><font color="#E5E5E5"> they can</font>

994
00:37:16,600 --> 00:37:21,580
continue<font color="#E5E5E5"> doing their job</font><font color="#CCCCCC"> and that's kind</font>

995
00:37:18,250 --> 00:37:23,320
of the<font color="#E5E5E5"> nature</font><font color="#CCCCCC"> of what wmf is WMNF is and</font>

996
00:37:21,580 --> 00:37:24,910
so it uses<font color="#E5E5E5"> these things</font><font color="#CCCCCC"> called state</font>

997
00:37:23,320 --> 00:37:27,310
names and these state names are stored

998
00:37:24,910 --> 00:37:29,259
in the<font color="#E5E5E5"> registry and what they do is</font>

999
00:37:27,310 --> 00:37:31,710
they're they're<font color="#E5E5E5"> basically the way that</font>

1000
00:37:29,260 --> 00:37:33,730
<font color="#CCCCCC">you could subscribe</font><font color="#E5E5E5"> to a certain event</font>

1001
00:37:31,710 --> 00:37:35,170
<font color="#CCCCCC">so the</font><font color="#E5E5E5"> with the event that you're</font>

1002
00:37:33,730 --> 00:37:39,430
subscribing<font color="#E5E5E5"> to is</font><font color="#CCCCCC"> actually the state</font>

1003
00:37:35,170 --> 00:37:41,590
name<font color="#E5E5E5"> and so the state name is a it's a</font>

1004
00:37:39,430 --> 00:37:43,240
grid but it's an encoded<font color="#CCCCCC"> data structure</font>

1005
00:37:41,590 --> 00:37:45,460
<font color="#E5E5E5">and that encoded data structure outlines</font>

1006
00:37:43,240 --> 00:37:46,779
a few different things so it's a<font color="#E5E5E5"> 64-bit</font>

1007
00:37:45,460 --> 00:37:49,000
grid structure that's<font color="#E5E5E5"> stored in the</font>

1008
00:37:46,780 --> 00:37:52,030
registry<font color="#E5E5E5"> and it contains the the</font>

1009
00:37:49,000 --> 00:37:53,740
lifetime of<font color="#E5E5E5"> that state that event and so</font>

1010
00:37:52,030 --> 00:37:54,640
that life<font color="#E5E5E5"> the main one is</font><font color="#CCCCCC"> well known</font>

1011
00:37:53,740 --> 00:37:56,259
ones that they're called<font color="#E5E5E5"> they're</font>

1012
00:37:54,640 --> 00:37:58,000
technically<font color="#E5E5E5"> called</font><font color="#CCCCCC"> well-known and these</font>

1013
00:37:56,260 --> 00:38:00,700
<font color="#E5E5E5">well-known states are reserved by</font>

1014
00:37:58,000 --> 00:38:01,809
<font color="#CCCCCC">Windows for</font><font color="#E5E5E5"> Windows</font><font color="#CCCCCC"> and so you can't</font>

1015
00:38:00,700 --> 00:38:03,038
register<font color="#E5E5E5"> them</font>

1016
00:38:01,809 --> 00:38:05,559
they're already pre-registered with

1017
00:38:03,039 --> 00:38:07,930
<font color="#CCCCCC">windows</font><font color="#E5E5E5"> and they come depending on on</font>

1018
00:38:05,559 --> 00:38:10,209
the build and then there's there's

1019
00:38:07,930 --> 00:38:12,759
<font color="#CCCCCC">permanent ones and these ones</font><font color="#E5E5E5"> stay kind</font>

1020
00:38:10,209 --> 00:38:14,019
<font color="#E5E5E5">of across the</font><font color="#CCCCCC"> bound of</font><font color="#E5E5E5"> a reboot right so</font>

1021
00:38:12,759 --> 00:38:15,430
in the event<font color="#E5E5E5"> where the machine</font><font color="#CCCCCC"> is</font>

1022
00:38:14,019 --> 00:38:18,189
rebooted that state name stays

1023
00:38:15,430 --> 00:38:19,569
persisting within<font color="#E5E5E5"> Windows and then</font>

1024
00:38:18,189 --> 00:38:20,949
there's the volatile ones which are

1025
00:38:19,569 --> 00:38:22,630
<font color="#E5E5E5">they're bound to the reboot of the</font>

1026
00:38:20,949 --> 00:38:24,339
<font color="#CCCCCC">machine</font><font color="#E5E5E5"> so once it's rebooted that state</font>

1027
00:38:22,630 --> 00:38:25,689
name disappears and then<font color="#E5E5E5"> there's</font>

1028
00:38:24,339 --> 00:38:27,279
temporary ones and these<font color="#E5E5E5"> are ones like</font>

1029
00:38:25,689 --> 00:38:29,589
<font color="#E5E5E5">you could create or I could create and</font>

1030
00:38:27,279 --> 00:38:32,799
the idea is<font color="#CCCCCC"> that I could have a process</font>

1031
00:38:29,589 --> 00:38:34,779
<font color="#CCCCCC">that runs within</font><font color="#E5E5E5"> Windows create a state</font>

1032
00:38:32,799 --> 00:38:35,259
name that's that's temporary<font color="#E5E5E5"> that nobody</font>

1033
00:38:34,779 --> 00:38:37,809
knows about

1034
00:38:35,259 --> 00:38:39,249
<font color="#CCCCCC">and and I</font><font color="#E5E5E5"> could set the</font><font color="#CCCCCC"> scope of it</font>

1035
00:38:37,809 --> 00:38:41,229
which is another<font color="#E5E5E5"> part of the state name</font>

1036
00:38:39,249 --> 00:38:43,419
<font color="#E5E5E5">the state name talks about like whether</font>

1037
00:38:41,229 --> 00:38:45,160
it's over the user user boundary<font color="#E5E5E5"> the</font>

1038
00:38:43,420 --> 00:38:46,269
process boundary the session boundary or

1039
00:38:45,160 --> 00:38:48,459
whether it's just<font color="#CCCCCC"> global for the whole</font>

1040
00:38:46,269 --> 00:38:50,410
machine and and they do come with

1041
00:38:48,459 --> 00:38:51,939
<font color="#E5E5E5">security descriptors but what you're</font>

1042
00:38:50,410 --> 00:38:53,739
gonna see they're not used<font color="#E5E5E5"> I mean some</font>

1043
00:38:51,939 --> 00:38:54,939
of them<font color="#CCCCCC"> are used</font><font color="#E5E5E5"> but most of security</font>

1044
00:38:53,739 --> 00:38:57,579
descriptors if you're familiar with<font color="#CCCCCC"> like</font>

1045
00:38:54,939 --> 00:38:59,469
dackel<font color="#CCCCCC"> so access control</font><font color="#E5E5E5"> lists for</font>

1046
00:38:57,579 --> 00:39:00,939
certain functionality of Windows like

1047
00:38:59,469 --> 00:39:03,549
they have<font color="#CCCCCC"> that ability so they're really</font>

1048
00:39:00,939 --> 00:39:05,288
<font color="#E5E5E5">powerful</font><font color="#CCCCCC"> but most</font><font color="#E5E5E5"> most of them aren't</font>

1049
00:39:03,549 --> 00:39:07,269
using<font color="#E5E5E5"> and so what we're going to be</font>

1050
00:39:05,289 --> 00:39:09,910
<font color="#E5E5E5">doing is is kind of stepping through</font>

1051
00:39:07,269 --> 00:39:12,819
these so these grid structures are<font color="#E5E5E5"> Zord</font>

1052
00:39:09,910 --> 00:39:14,279
<font color="#CCCCCC">with a with a state key I</font><font color="#E5E5E5"> don't have the</font>

1053
00:39:12,819 --> 00:39:17,019
key in<font color="#CCCCCC"> here but you</font><font color="#E5E5E5"> don't really need it</font>

1054
00:39:14,279 --> 00:39:18,729
it's<font color="#E5E5E5"> there but it's public</font><font color="#CCCCCC"> information</font>

1055
00:39:17,019 --> 00:39:20,049
and<font color="#E5E5E5"> so there's some other information</font>

1056
00:39:18,729 --> 00:39:22,899
<font color="#CCCCCC">about these state names that are there</font>

1057
00:39:20,049 --> 00:39:24,130
to like version information<font color="#CCCCCC"> this scope</font>

1058
00:39:22,900 --> 00:39:25,809
with the data which<font color="#E5E5E5"> we just talked about</font>

1059
00:39:24,130 --> 00:39:27,459
<font color="#E5E5E5">but then there's a permanent</font><font color="#CCCCCC"> flag of</font>

1060
00:39:25,809 --> 00:39:29,709
whether it's like well-known or you know

1061
00:39:27,459 --> 00:39:31,538
volatile<font color="#E5E5E5"> and then and then there's like</font>

1062
00:39:29,709 --> 00:39:33,549
<font color="#E5E5E5">a unique identifier which basically so</font>

1063
00:39:31,539 --> 00:39:35,949
<font color="#E5E5E5">you could have you know multiple ones I</font>

1064
00:39:33,549 --> 00:39:37,929
guess<font color="#E5E5E5"> whatever and so then the idea</font>

1065
00:39:35,949 --> 00:39:41,289
<font color="#CCCCCC">behind this is that the</font><font color="#E5E5E5"> kernel itself</font>

1066
00:39:37,929 --> 00:39:45,729
<font color="#E5E5E5">the Windows kernel at a low level</font><font color="#CCCCCC"> uses</font>

1067
00:39:41,289 --> 00:39:48,789
<font color="#E5E5E5">the the</font><font color="#CCCCCC"> zlw api function calls within</font>

1068
00:39:45,729 --> 00:39:50,229
the native API<font color="#E5E5E5"> and so the ntdll</font>

1069
00:39:48,789 --> 00:39:51,579
subscribes to<font color="#E5E5E5"> the events because</font>

1070
00:39:50,229 --> 00:39:54,308
<font color="#CCCCCC">technically you're only</font><font color="#E5E5E5"> supposed to</font><font color="#CCCCCC"> have</font>

1071
00:39:51,579 --> 00:39:56,380
<font color="#E5E5E5">like one process per state</font><font color="#CCCCCC"> subscribing</font>

1072
00:39:54,309 --> 00:39:58,689
and<font color="#E5E5E5"> then what</font><font color="#CCCCCC"> mt DLL</font><font color="#E5E5E5"> is is it exposes</font>

1073
00:39:56,380 --> 00:40:01,269
<font color="#E5E5E5">the API wrapper at a higher level</font><font color="#CCCCCC"> like</font>

1074
00:39:58,689 --> 00:40:04,689
the RTL<font color="#CCCCCC"> and the e^x functions within the</font>

1075
00:40:01,269 --> 00:40:06,758
ntdll<font color="#E5E5E5"> so that users can</font><font color="#CCCCCC"> create</font><font color="#E5E5E5"> processes</font>

1076
00:40:04,689 --> 00:40:08,140
that that subscribe<font color="#CCCCCC"> to them and then</font>

1077
00:40:06,759 --> 00:40:10,689
what happens is basically<font color="#E5E5E5"> whenever that</font>

1078
00:40:08,140 --> 00:40:13,269
event gets triggered ntdll is notified

1079
00:40:10,689 --> 00:40:15,578
<font color="#E5E5E5">in an ntdll kind of like multiplexes to</font>

1080
00:40:13,269 --> 00:40:17,618
all the<font color="#CCCCCC"> subscribers kind of across</font>

1081
00:40:15,579 --> 00:40:20,049
<font color="#CCCCCC">bored the cool thing</font><font color="#E5E5E5"> with this</font><font color="#CCCCCC"> is the</font>

1082
00:40:17,619 --> 00:40:21,880
Windows kernel actually<font color="#E5E5E5"> goes to that</font>

1083
00:40:20,049 --> 00:40:24,160
<font color="#CCCCCC">process</font><font color="#E5E5E5"> and it maintains a list of these</font>

1084
00:40:21,880 --> 00:40:26,019
callbacks<font color="#E5E5E5"> in the contexts it switches</font>

1085
00:40:24,160 --> 00:40:27,940
context and<font color="#E5E5E5"> it executes the callback</font>

1086
00:40:26,019 --> 00:40:30,788
functions<font color="#E5E5E5"> so you can imagine</font><font color="#CCCCCC"> like</font><font color="#E5E5E5"> having</font>

1087
00:40:27,940 --> 00:40:33,969
a process<font color="#E5E5E5"> delegating like a function</font>

1088
00:40:30,789 --> 00:40:37,479
<font color="#CCCCCC">that</font><font color="#E5E5E5"> you want calling the</font><font color="#CCCCCC"> low-level or</font>

1089
00:40:33,969 --> 00:40:39,249
calling the API in<font color="#E5E5E5"> ntdll telling the</font>

1090
00:40:37,479 --> 00:40:42,339
kernel hey when<font color="#E5E5E5"> this event triggers call</font>

1091
00:40:39,249 --> 00:40:44,348
this code in<font color="#CCCCCC"> my code and so then you get</font>

1092
00:40:42,339 --> 00:40:46,029
code execution<font color="#CCCCCC"> now the idea behind this</font>

1093
00:40:44,349 --> 00:40:47,979
<font color="#E5E5E5">because the MT DLL exposes a</font>

1094
00:40:46,029 --> 00:40:50,829
<font color="#CCCCCC">higher-level wrapper</font><font color="#E5E5E5"> what it does is it</font>

1095
00:40:47,979 --> 00:40:51,819
<font color="#CCCCCC">actually can track on the event logs</font><font color="#E5E5E5"> so</font>

1096
00:40:50,829 --> 00:40:53,650
what we're trying<font color="#E5E5E5"> to do is we're trying</font>

1097
00:40:51,819 --> 00:40:55,150
<font color="#E5E5E5">to say a little</font><font color="#CCCCCC"> bit lower</font><font color="#E5E5E5"> in the kernel</font>

1098
00:40:53,650 --> 00:40:57,369
<font color="#CCCCCC">so that we're not actually in the</font><font color="#E5E5E5"> event</font>

1099
00:40:55,150 --> 00:41:00,279
<font color="#CCCCCC">lobs at all which makes</font><font color="#E5E5E5"> if you're any if</font>

1100
00:40:57,369 --> 00:41:01,749
<font color="#E5E5E5">your</font><font color="#CCCCCC"> end point</font><font color="#E5E5E5"> like a EDR provider you</font>

1101
00:41:00,279 --> 00:41:03,789
know this is scary<font color="#CCCCCC"> right</font><font color="#E5E5E5"> because now</font>

1102
00:41:01,749 --> 00:41:05,799
what do you<font color="#E5E5E5"> do because now we have a way</font>

1103
00:41:03,789 --> 00:41:08,440
to create like an IPC mechanism<font color="#E5E5E5"> an inner</font>

1104
00:41:05,799 --> 00:41:10,869
<font color="#CCCCCC">process call across</font><font color="#E5E5E5"> processes across</font>

1105
00:41:08,440 --> 00:41:12,729
user boundaries and<font color="#E5E5E5"> kernel boundaries</font>

1106
00:41:10,869 --> 00:41:15,009
<font color="#E5E5E5">and we could hide data we can hide</font>

1107
00:41:12,729 --> 00:41:16,899
binaries<font color="#E5E5E5"> and other files we can inject</font>

1108
00:41:15,009 --> 00:41:19,059
code and processes if we could<font color="#CCCCCC"> hijack</font>

1109
00:41:16,900 --> 00:41:20,529
<font color="#E5E5E5">their like</font><font color="#CCCCCC"> their vtable for</font><font color="#E5E5E5"> instance and</font>

1110
00:41:19,059 --> 00:41:22,719
we can find the<font color="#E5E5E5"> v table entry for</font><font color="#CCCCCC"> that</font>

1111
00:41:20,529 --> 00:41:24,489
callback context in<font color="#CCCCCC"> that process</font><font color="#E5E5E5"> from a</font>

1112
00:41:22,719 --> 00:41:27,069
user land process that's persistent<font color="#E5E5E5"> like</font>

1113
00:41:24,489 --> 00:41:28,569
maybe<font color="#CCCCCC"> I don't</font><font color="#E5E5E5"> know</font><font color="#CCCCCC"> think pad you</font><font color="#E5E5E5"> know</font>

1114
00:41:27,069 --> 00:41:30,999
startup<font color="#E5E5E5"> process or something because we</font>

1115
00:41:28,569 --> 00:41:33,009
know those<font color="#CCCCCC"> are</font><font color="#E5E5E5"> like dotnet files so if</font>

1116
00:41:30,999 --> 00:41:35,589
you can<font color="#E5E5E5"> find the</font><font color="#CCCCCC"> V table entry for the</font>

1117
00:41:33,009 --> 00:41:37,959
callback function<font color="#CCCCCC"> when the windows</font><font color="#E5E5E5"> API</font>

1118
00:41:35,589 --> 00:41:38,949
kernel calls<font color="#E5E5E5"> that callback function</font>

1119
00:41:37,959 --> 00:41:40,359
you're actually<font color="#E5E5E5"> redirecting code</font>

1120
00:41:38,949 --> 00:41:43,299
execution<font color="#E5E5E5"> it's a known vulnerability</font><font color="#CCCCCC"> and</font>

1121
00:41:40,359 --> 00:41:44,499
most like<font color="#CCCCCC"> V table hijacks but the idea</font>

1122
00:41:43,299 --> 00:41:45,699
<font color="#E5E5E5">is that you could redirect</font><font color="#CCCCCC"> a code to</font>

1123
00:41:44,499 --> 00:41:47,049
yours and<font color="#CCCCCC"> so you</font><font color="#E5E5E5"> don't even have to</font>

1124
00:41:45,699 --> 00:41:48,690
worry<font color="#CCCCCC"> about like writing to disk which</font>

1125
00:41:47,049 --> 00:41:50,650
is<font color="#E5E5E5"> what I'm gonna do the demo this but</font>

1126
00:41:48,690 --> 00:41:52,119
you could there's other there's other

1127
00:41:50,650 --> 00:41:53,199
research here that's that hasn't<font color="#CCCCCC"> been</font>

1128
00:41:52,119 --> 00:41:55,569
tapped yet is<font color="#E5E5E5"> basically where I'm</font>

1129
00:41:53,199 --> 00:41:57,279
<font color="#CCCCCC">getting to and so now we were able</font><font color="#E5E5E5"> to</font>

1130
00:41:55,569 --> 00:41:59,259
push code and you know<font color="#E5E5E5"> obviously that's</font>

1131
00:41:57,279 --> 00:42:01,749
what malware likes to do so how do we do

1132
00:41:59,259 --> 00:42:03,190
this so<font color="#E5E5E5"> within the kernel</font><font color="#CCCCCC"> I'm gonna look</font>

1133
00:42:01,749 --> 00:42:05,078
at<font color="#E5E5E5"> some of the low-level API calls</font>

1134
00:42:03,190 --> 00:42:06,999
here's four of them right<font color="#CCCCCC"> here the first</font>

1135
00:42:05,079 --> 00:42:09,369
<font color="#CCCCCC">one is query</font><font color="#E5E5E5"> so whenever you're wanting</font>

1136
00:42:06,999 --> 00:42:11,229
<font color="#CCCCCC">to consume data and remember these state</font>

1137
00:42:09,369 --> 00:42:12,759
IDs these state names actually<font color="#E5E5E5"> have data</font>

1138
00:42:11,229 --> 00:42:14,709
payloads that<font color="#E5E5E5"> are associated with them</font>

1139
00:42:12,759 --> 00:42:16,390
because<font color="#E5E5E5"> it's not</font><font color="#CCCCCC"> just hey this event was</font>

1140
00:42:14,709 --> 00:42:18,098
triggered<font color="#CCCCCC"> it's hey this event was</font>

1141
00:42:16,390 --> 00:42:20,440
<font color="#CCCCCC">triggered</font><font color="#E5E5E5"> and I don't know here's the</font>

1142
00:42:18,099 --> 00:42:22,479
pointer<font color="#E5E5E5"> or here's the data</font><font color="#CCCCCC"> payload for</font>

1143
00:42:20,440 --> 00:42:24,819
the<font color="#CCCCCC"> configuration or you know here's</font><font color="#E5E5E5"> the</font>

1144
00:42:22,479 --> 00:42:26,379
last<font color="#E5E5E5"> host that was browsed an edge or</font>

1145
00:42:24,819 --> 00:42:28,390
it's<font color="#E5E5E5"> across the board depending on the</font>

1146
00:42:26,380 --> 00:42:29,740
events<font color="#E5E5E5"> that you're looking at and so the</font>

1147
00:42:28,390 --> 00:42:33,609
<font color="#E5E5E5">cool thing with this is</font><font color="#CCCCCC"> you can</font>

1148
00:42:29,740 --> 00:42:36,399
consume<font color="#CCCCCC"> those data payloads from States</font>

1149
00:42:33,610 --> 00:42:38,560
without<font color="#E5E5E5"> ever subscribing and if we don't</font>

1150
00:42:36,400 --> 00:42:40,480
use the RTL<font color="#E5E5E5"> functions that we use a Z W</font>

1151
00:42:38,560 --> 00:42:42,490
query function it's<font color="#E5E5E5"> not gonna be picked</font>

1152
00:42:40,480 --> 00:42:44,020
up by<font color="#E5E5E5"> windows and so what do you do</font>

1153
00:42:42,490 --> 00:42:46,270
<font color="#CCCCCC">about that</font><font color="#E5E5E5"> like wow that's crazy you can</font>

1154
00:42:44,020 --> 00:42:48,910
actually<font color="#E5E5E5"> get data out of we can</font><font color="#CCCCCC"> access</font>

1155
00:42:46,270 --> 00:42:50,410
the<font color="#E5E5E5"> kernel to get us the data and and</font>

1156
00:42:48,910 --> 00:42:52,660
then it sends<font color="#CCCCCC"> that payload back to us</font><font color="#E5E5E5"> if</font>

1157
00:42:50,410 --> 00:42:54,549
you want you<font color="#E5E5E5"> could</font><font color="#CCCCCC"> also update those</font>

1158
00:42:52,660 --> 00:42:56,649
state names<font color="#E5E5E5"> now think about that</font><font color="#CCCCCC"> for a</font>

1159
00:42:54,550 --> 00:42:58,869
second<font color="#CCCCCC"> a state name</font><font color="#E5E5E5"> if the</font><font color="#CCCCCC"> decals</font><font color="#E5E5E5"> not</font>

1160
00:42:56,650 --> 00:43:00,640
correct<font color="#E5E5E5"> and it has everyone on that's</font>

1161
00:42:58,869 --> 00:43:02,170
allowed which most of<font color="#E5E5E5"> them are you'll</font>

1162
00:43:00,640 --> 00:43:04,839
see<font color="#E5E5E5"> even</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> well-known</font><font color="#CCCCCC"> ones that a</font>

1163
00:43:02,170 --> 00:43:06,550
reserved by<font color="#E5E5E5"> the</font><font color="#CCCCCC"> Windows kernel</font><font color="#E5E5E5"> allow you</font>

1164
00:43:04,840 --> 00:43:08,050
to update<font color="#E5E5E5"> those state names and what</font>

1165
00:43:06,550 --> 00:43:10,510
you're<font color="#E5E5E5"> basically</font><font color="#CCCCCC"> saying is hey I'm</font>

1166
00:43:08,050 --> 00:43:13,060
updating<font color="#E5E5E5"> the data</font><font color="#CCCCCC"> payload of this state</font>

1167
00:43:10,510 --> 00:43:14,560
name so<font color="#E5E5E5"> that any of the</font><font color="#CCCCCC"> windows services</font>

1168
00:43:13,060 --> 00:43:16,540
I don't know<font color="#E5E5E5"> like the ones that</font><font color="#CCCCCC"> are</font>

1169
00:43:14,560 --> 00:43:18,040
<font color="#CCCCCC">running</font><font color="#E5E5E5"> kind of with Windows when they</font>

1170
00:43:16,540 --> 00:43:19,900
<font color="#E5E5E5">consume that event and they look at that</font>

1171
00:43:18,040 --> 00:43:21,640
payload<font color="#E5E5E5"> it actually gets</font><font color="#CCCCCC"> code you know</font>

1172
00:43:19,900 --> 00:43:23,170
you get<font color="#E5E5E5"> code or in you're injecting data</font>

1173
00:43:21,640 --> 00:43:24,640
into that<font color="#E5E5E5"> process</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> this is an</font>

1174
00:43:23,170 --> 00:43:25,900
untapped attack surface there's no

1175
00:43:24,640 --> 00:43:27,430
fuzzers that are out there<font color="#E5E5E5"> really for</font>

1176
00:43:25,900 --> 00:43:29,020
this yet<font color="#E5E5E5"> and so if you're</font><font color="#CCCCCC"> starting to</font>

1177
00:43:27,430 --> 00:43:30,129
hook if you do like any<font color="#E5E5E5"> kernel debugging</font>

1178
00:43:29,020 --> 00:43:32,860
and<font color="#E5E5E5"> you want to hook the Windows kernel</font>

1179
00:43:30,130 --> 00:43:34,240
and then you know subscribe to<font color="#E5E5E5"> these we</font>

1180
00:43:32,860 --> 00:43:36,190
<font color="#E5E5E5">just I just subscribe to all of the</font>

1181
00:43:34,240 --> 00:43:37,750
<font color="#E5E5E5">different</font><font color="#CCCCCC"> events</font><font color="#E5E5E5"> and then when I win</font>

1182
00:43:36,190 --> 00:43:39,250
<font color="#E5E5E5">over you're doing the research</font><font color="#CCCCCC"> to try</font><font color="#E5E5E5"> to</font>

1183
00:43:37,750 --> 00:43:40,090
figure<font color="#E5E5E5"> out like where things were flaky</font>

1184
00:43:39,250 --> 00:43:42,250
and what we're bringing

1185
00:43:40,090 --> 00:43:43,750
<font color="#E5E5E5">you're gonna break stuff immediately</font><font color="#CCCCCC"> if</font>

1186
00:43:42,250 --> 00:43:45,790
you just<font color="#E5E5E5"> query all</font><font color="#CCCCCC"> of them you're gonna</font>

1187
00:43:43,750 --> 00:43:48,100
see<font color="#CCCCCC"> like potentially information</font>

1188
00:43:45,790 --> 00:43:49,540
disclosure<font color="#E5E5E5"> like process</font><font color="#CCCCCC"> information</font>

1189
00:43:48,100 --> 00:43:51,069
across boundaries<font color="#E5E5E5"> that you shouldn't see</font>

1190
00:43:49,540 --> 00:43:52,930
and these are the ones that<font color="#E5E5E5"> windows are</font>

1191
00:43:51,070 --> 00:43:54,700
trying to actively fix I know Alex and

1192
00:43:52,930 --> 00:43:56,560
<font color="#CCCCCC">Gabriella reported a lot of these</font>

1193
00:43:54,700 --> 00:43:58,509
<font color="#E5E5E5">vulnerabilities so what you're gonna see</font>

1194
00:43:56,560 --> 00:44:00,850
<font color="#CCCCCC">is</font><font color="#E5E5E5"> um they didn't release any code yet</font>

1195
00:43:58,510 --> 00:44:03,150
because it's<font color="#E5E5E5"> still such a volatile area</font>

1196
00:44:00,850 --> 00:44:05,529
<font color="#CCCCCC">of research that that's kind of scary</font>

1197
00:44:03,150 --> 00:44:07,390
<font color="#CCCCCC">and then you</font><font color="#E5E5E5"> could also create new state</font>

1198
00:44:05,530 --> 00:44:09,609
<font color="#E5E5E5">name so you can call</font><font color="#CCCCCC"> zlw create w8f</font>

1199
00:44:07,390 --> 00:44:10,509
state names<font color="#E5E5E5"> and create your own this is</font>

1200
00:44:09,609 --> 00:44:12,819
where it<font color="#E5E5E5"> gets really cool because you</font>

1201
00:44:10,510 --> 00:44:13,840
<font color="#CCCCCC">can create your own and no there's</font>

1202
00:44:12,820 --> 00:44:15,280
nothing to monitor like what do you

1203
00:44:13,840 --> 00:44:16,780
monitor nobody knows about<font color="#E5E5E5"> it you have</font>

1204
00:44:15,280 --> 00:44:18,880
to<font color="#E5E5E5"> like brute force the state names to</font>

1205
00:44:16,780 --> 00:44:20,140
find them<font color="#CCCCCC"> and</font><font color="#E5E5E5"> then you could delete them</font>

1206
00:44:18,880 --> 00:44:21,220
so<font color="#CCCCCC"> whenever you're done so like</font><font color="#E5E5E5"> I don't</font>

1207
00:44:20,140 --> 00:44:23,350
<font color="#E5E5E5">know if you hooked</font><font color="#CCCCCC"> like a</font><font color="#E5E5E5"> shutdown</font>

1208
00:44:21,220 --> 00:44:25,029
process<font color="#E5E5E5"> and then you know created your</font>

1209
00:44:23,350 --> 00:44:26,560
state<font color="#E5E5E5"> and made it volatile then whenever</font>

1210
00:44:25,030 --> 00:44:28,420
<font color="#E5E5E5">the</font><font color="#CCCCCC"> machine started you hooked the</font>

1211
00:44:26,560 --> 00:44:31,330
<font color="#CCCCCC">startup</font><font color="#E5E5E5"> process and then deleted the</font>

1212
00:44:28,420 --> 00:44:33,910
delete state lehigh d'ang behind the

1213
00:44:31,330 --> 00:44:35,230
scenes it's kind of<font color="#E5E5E5"> the idea so what I</font>

1214
00:44:33,910 --> 00:44:36,430
did<font color="#E5E5E5"> rule you know when we started this</font>

1215
00:44:35,230 --> 00:44:39,460
<font color="#E5E5E5">was I didn't have anything to go off of</font>

1216
00:44:36,430 --> 00:44:41,680
<font color="#E5E5E5">besides their black hat</font><font color="#CCCCCC"> presentation and</font>

1217
00:44:39,460 --> 00:44:43,380
then I found<font color="#CCCCCC"> like a blog on red plate</font>

1218
00:44:41,680 --> 00:44:45,569
<font color="#E5E5E5">some red plate blog that was kind</font>

1219
00:44:43,380 --> 00:44:47,309
random somebody user posted<font color="#CCCCCC"> a</font><font color="#E5E5E5"> bunch of</font>

1220
00:44:45,569 --> 00:44:48,839
<font color="#E5E5E5">information so what</font><font color="#CCCCCC"> I wanted to</font><font color="#E5E5E5"> do is</font>

1221
00:44:47,309 --> 00:44:50,880
<font color="#E5E5E5">kind of give you like at least a</font>

1222
00:44:48,839 --> 00:44:52,710
starting point<font color="#CCCCCC"> so if you wanted to look</font>

1223
00:44:50,880 --> 00:44:53,970
<font color="#E5E5E5">more into this you could this is I</font><font color="#CCCCCC"> think</font>

1224
00:44:52,710 --> 00:44:56,069
if you have this<font color="#CCCCCC"> screenshot if</font><font color="#E5E5E5"> you want</font>

1225
00:44:53,970 --> 00:44:57,720
<font color="#E5E5E5">take a picture</font><font color="#CCCCCC"> of it real quick you can</font>

1226
00:44:56,069 --> 00:45:00,900
<font color="#E5E5E5">find all the state names in the registry</font>

1227
00:44:57,720 --> 00:45:02,279
so<font color="#E5E5E5"> so in the notifications and then</font>

1228
00:45:00,900 --> 00:45:03,630
you'll see<font color="#CCCCCC"> that</font><font color="#E5E5E5"> the very bottom one like</font>

1229
00:45:02,279 --> 00:45:04,980
the volatile notifications are the ones

1230
00:45:03,630 --> 00:45:07,109
<font color="#E5E5E5">that are like volatile</font><font color="#CCCCCC"> that they're</font>

1231
00:45:04,980 --> 00:45:09,150
deleted<font color="#CCCCCC"> and then you have the</font><font color="#E5E5E5"> internal</font>

1232
00:45:07,109 --> 00:45:10,680
state name so if you're looking<font color="#CCCCCC"> for the</font>

1233
00:45:09,150 --> 00:45:13,160
internal state names and bear in mind<font color="#CCCCCC"> is</font>

1234
00:45:10,680 --> 00:45:15,480
<font color="#CCCCCC">really like</font><font color="#E5E5E5"> you long 64 you know IDs</font>

1235
00:45:13,160 --> 00:45:16,920
<font color="#CCCCCC">it's</font><font color="#E5E5E5"> really hard to differentiate</font>

1236
00:45:15,480 --> 00:45:19,380
between what<font color="#CCCCCC"> state is doing what and</font>

1237
00:45:16,920 --> 00:45:21,319
<font color="#CCCCCC">what event is</font><font color="#E5E5E5"> being triggered so if you</font>

1238
00:45:19,380 --> 00:45:24,109
look<font color="#E5E5E5"> at Microsoft's</font><font color="#CCCCCC"> ADK which</font><font color="#E5E5E5"> is like</font>

1239
00:45:21,319 --> 00:45:26,759
it's it's a way<font color="#E5E5E5"> to analyze the entire</font>

1240
00:45:24,109 --> 00:45:28,380
processing of the<font color="#E5E5E5"> Windows machine</font><font color="#CCCCCC"> at any</font>

1241
00:45:26,759 --> 00:45:30,210
given time there's a<font color="#CCCCCC"> dll file in there</font>

1242
00:45:28,380 --> 00:45:33,630
called perf underscore antique

1243
00:45:30,210 --> 00:45:35,759
underscore<font color="#E5E5E5"> C DLL and it has all of the</font>

1244
00:45:33,630 --> 00:45:37,170
internal Microsoft like friendly names

1245
00:45:35,759 --> 00:45:39,359
so you can see like oh this is a

1246
00:45:37,170 --> 00:45:41,430
shutdown<font color="#CCCCCC"> state but it also gives</font><font color="#E5E5E5"> you a</font>

1247
00:45:39,359 --> 00:45:43,348
really cool description<font color="#E5E5E5"> associated with</font>

1248
00:45:41,430 --> 00:45:44,460
it there's some other ones<font color="#CCCCCC"> too</font><font color="#E5E5E5"> that I</font>

1249
00:45:43,349 --> 00:45:46,769
didn't put in here that<font color="#CCCCCC"> got</font><font color="#E5E5E5"> released</font>

1250
00:45:44,460 --> 00:45:49,230
yesterday actually Gabrielle made a blog

1251
00:45:46,769 --> 00:45:51,569
post yesterday on more<font color="#E5E5E5"> in-depth W&F</font>

1252
00:45:49,230 --> 00:45:53,519
functions on how to research from the

1253
00:45:51,569 --> 00:45:54,869
kernel side<font color="#E5E5E5"> so that's really cool</font>

1254
00:45:53,519 --> 00:45:56,308
<font color="#E5E5E5">definitely recommend</font><font color="#CCCCCC"> checking that</font><font color="#E5E5E5"> out</font>

1255
00:45:54,869 --> 00:45:58,289
and then the other<font color="#E5E5E5"> thing that you could</font>

1256
00:45:56,309 --> 00:46:00,029
<font color="#E5E5E5">do is I was looking for the signatures</font>

1257
00:45:58,289 --> 00:46:02,700
the native API calls signatures within

1258
00:46:00,029 --> 00:46:04,019
<font color="#CCCCCC">the kernel and</font><font color="#E5E5E5"> so if you go to process</font>

1259
00:46:02,700 --> 00:46:07,890
hacker<font color="#CCCCCC"> SourceForge</font>

1260
00:46:04,019 --> 00:46:09,058
you can go to the<font color="#CCCCCC"> mtz w api</font><font color="#E5E5E5"> and what it</font>

1261
00:46:07,890 --> 00:46:10,500
does is it actually<font color="#E5E5E5"> breaks</font><font color="#CCCCCC"> down all the</font>

1262
00:46:09,059 --> 00:46:11,910
<font color="#CCCCCC">signatures for</font><font color="#E5E5E5"> you so if you just search</font>

1263
00:46:10,500 --> 00:46:14,279
<font color="#CCCCCC">for like W and F you could see all the</font>

1264
00:46:11,910 --> 00:46:15,538
internal<font color="#CCCCCC"> print the input parameters the</font>

1265
00:46:14,279 --> 00:46:17,130
output parameters because what you're

1266
00:46:15,539 --> 00:46:19,589
gonna want<font color="#E5E5E5"> to do like if you're gonna do</font>

1267
00:46:17,130 --> 00:46:20,819
<font color="#E5E5E5">like me you can see like C++</font><font color="#CCCCCC"> I tried</font>

1268
00:46:19,589 --> 00:46:21,900
that<font color="#E5E5E5"> first but it was</font><font color="#CCCCCC"> really</font><font color="#E5E5E5"> hard</font><font color="#CCCCCC"> to get</font>

1269
00:46:20,819 --> 00:46:24,410
<font color="#E5E5E5">some of the other functionality that</font><font color="#CCCCCC"> I</font>

1270
00:46:21,900 --> 00:46:26,549
wanted so i ported my code<font color="#CCCCCC"> to c-sharp</font>

1271
00:46:24,410 --> 00:46:29,578
<font color="#CCCCCC">and then I</font><font color="#E5E5E5"> just used I created some</font>

1272
00:46:26,549 --> 00:46:31,740
functions<font color="#CCCCCC"> that imported from</font><font color="#E5E5E5"> the ntdll</font>

1273
00:46:29,579 --> 00:46:33,720
and so I<font color="#E5E5E5"> needed those signatures so that</font>

1274
00:46:31,740 --> 00:46:35,758
<font color="#CCCCCC">I could find the right</font><font color="#E5E5E5"> data types in a</font>

1275
00:46:33,720 --> 00:46:38,069
c-sharp<font color="#E5E5E5"> and so I put together this tool</font>

1276
00:46:35,759 --> 00:46:40,079
<font color="#CCCCCC">Bo and I this is</font><font color="#E5E5E5"> what Bo and I used for</font>

1277
00:46:38,069 --> 00:46:42,150
<font color="#E5E5E5">research because</font><font color="#CCCCCC"> there</font><font color="#E5E5E5"> was no code put</font>

1278
00:46:40,079 --> 00:46:43,589
out by<font color="#E5E5E5"> Alex now he has a tool that's</font>

1279
00:46:42,150 --> 00:46:46,559
<font color="#E5E5E5">gonna be dumping or there's gonna be</font>

1280
00:46:43,589 --> 00:46:49,019
released called<font color="#E5E5E5"> WN f dump and he's gonna</font>

1281
00:46:46,559 --> 00:46:50,549
be releasing<font color="#CCCCCC"> it after</font><font color="#E5E5E5"> Windows patches so</font>

1282
00:46:49,019 --> 00:46:51,589
out<font color="#CCCCCC"> of respect for</font><font color="#E5E5E5"> his research since</font>

1283
00:46:50,549 --> 00:46:54,180
we're really standing on their shoulders

1284
00:46:51,589 --> 00:46:55,500
<font color="#CCCCCC">I'm not gonna release</font><font color="#E5E5E5"> Kasper until after</font>

1285
00:46:54,180 --> 00:46:57,359
they released<font color="#E5E5E5"> theirs</font>

1286
00:46:55,500 --> 00:46:58,590
<font color="#E5E5E5">just out of respect because I want</font>

1287
00:46:57,360 --> 00:47:00,570
Microsoft to have time to patch it as

1288
00:46:58,590 --> 00:47:01,830
well<font color="#CCCCCC"> but</font><font color="#E5E5E5"> this tool right here is what we</font>

1289
00:47:00,570 --> 00:47:06,330
use<font color="#E5E5E5"> to kind of do it so you see the</font>

1290
00:47:01,830 --> 00:47:07,890
friendly names<font color="#CCCCCC"> over on the</font><font color="#E5E5E5"> far left</font><font color="#CCCCCC"> then</font>

1291
00:47:06,330 --> 00:47:10,590
the registry names<font color="#E5E5E5"> is stored in the</font>

1292
00:47:07,890 --> 00:47:11,910
registry<font color="#E5E5E5"> in that way but if</font><font color="#CCCCCC"> you look at</font>

1293
00:47:10,590 --> 00:47:14,040
the<font color="#CCCCCC"> decoded name you'll see it there</font>

1294
00:47:11,910 --> 00:47:15,870
<font color="#E5E5E5">you'll see</font><font color="#CCCCCC"> the lifetime of it whether</font>

1295
00:47:14,040 --> 00:47:17,130
<font color="#CCCCCC">there's subscribers for it already</font><font color="#E5E5E5"> the</font>

1296
00:47:15,870 --> 00:47:18,750
data linked and<font color="#E5E5E5"> if you look over here</font>

1297
00:47:17,130 --> 00:47:20,730
this<font color="#E5E5E5"> is actually the last known payload</font>

1298
00:47:18,750 --> 00:47:23,340
<font color="#E5E5E5">for these state names and so it gets it</font>

1299
00:47:20,730 --> 00:47:25,670
gets<font color="#E5E5E5"> pretty</font><font color="#CCCCCC"> crazy so outwardly since I</font>

1300
00:47:23,340 --> 00:47:27,840
have it<font color="#CCCCCC"> I have it on SourceForge already</font>

1301
00:47:25,670 --> 00:47:30,690
<font color="#CCCCCC">they're not SourceForge github sorry</font>

1302
00:47:27,840 --> 00:47:31,560
<font color="#E5E5E5">yeah see</font><font color="#CCCCCC"> that so so basically what we're</font>

1303
00:47:30,690 --> 00:47:33,000
<font color="#CCCCCC">going to do is we're</font><font color="#E5E5E5"> going</font><font color="#CCCCCC"> to create</font><font color="#E5E5E5"> a</font>

1304
00:47:31,560 --> 00:47:34,830
side<font color="#CCCCCC"> channel data persistence</font><font color="#E5E5E5"> so we're</font>

1305
00:47:33,000 --> 00:47:36,780
gonna<font color="#CCCCCC"> get a code execution</font><font color="#E5E5E5"> our stage</font><font color="#CCCCCC"> one</font>

1306
00:47:34,830 --> 00:47:38,730
<font color="#CCCCCC">payload</font><font color="#E5E5E5"> is just gonna be a dropper it's</font>

1307
00:47:36,780 --> 00:47:40,500
going to basically<font color="#CCCCCC"> check to see if the</font>

1308
00:47:38,730 --> 00:47:41,610
stage<font color="#E5E5E5"> two payload is already stored in</font>

1309
00:47:40,500 --> 00:47:42,870
another<font color="#E5E5E5"> state name so what we're gonna</font>

1310
00:47:41,610 --> 00:47:45,240
do is we're gonna take<font color="#CCCCCC"> our actual</font>

1311
00:47:42,870 --> 00:47:47,400
malware and store it in and have<font color="#E5E5E5"> the</font>

1312
00:47:45,240 --> 00:47:48,660
<font color="#CCCCCC">Windows kernel store it for us and then</font>

1313
00:47:47,400 --> 00:47:50,190
if it's there we're gonna run it if it's

1314
00:47:48,660 --> 00:47:51,779
not we're gonna<font color="#E5E5E5"> get we're gonna fetch it</font>

1315
00:47:50,190 --> 00:47:53,100
from<font color="#CCCCCC"> situ and then we're gonna store it</font>

1316
00:47:51,780 --> 00:47:55,260
and then<font color="#E5E5E5"> we're gonna run it we're gonna</font>

1317
00:47:53,100 --> 00:47:58,890
also<font color="#E5E5E5"> we can subscribe to the shutdown</font>

1318
00:47:55,260 --> 00:48:00,480
<font color="#CCCCCC">and user presence</font><font color="#E5E5E5"> events so win the MIT</font>

1319
00:47:58,890 --> 00:48:02,490
when the machine shuts down<font color="#E5E5E5"> we'll write</font>

1320
00:48:00,480 --> 00:48:04,530
it to disk<font color="#E5E5E5"> when it starts up</font><font color="#CCCCCC"> we'll we'll</font>

1321
00:48:02,490 --> 00:48:06,029
delete<font color="#E5E5E5"> it off disk that way because it's</font>

1322
00:48:04,530 --> 00:48:08,100
such an early<font color="#E5E5E5"> and late</font>

1323
00:48:06,030 --> 00:48:10,800
event call within<font color="#E5E5E5"> Windows kernel</font><font color="#CCCCCC"> we'll</font>

1324
00:48:08,100 --> 00:48:12,930
be able<font color="#E5E5E5"> to leverage that in order to to</font>

1325
00:48:10,800 --> 00:48:14,190
keep you know malware<font color="#CCCCCC"> analysts off the</font>

1326
00:48:12,930 --> 00:48:15,120
machine they're gonna have<font color="#E5E5E5"> to find</font>

1327
00:48:14,190 --> 00:48:16,530
<font color="#CCCCCC">another</font><font color="#E5E5E5"> way to do it they had</font><font color="#CCCCCC"> they're</font>

1328
00:48:15,120 --> 00:48:18,480
<font color="#E5E5E5">great at it I suck at</font><font color="#CCCCCC"> it so doesn't</font>

1329
00:48:16,530 --> 00:48:20,430
<font color="#E5E5E5">matter and then we're also gonna monitor</font>

1330
00:48:18,480 --> 00:48:22,050
I'm the user presence<font color="#E5E5E5"> right so the user</font>

1331
00:48:20,430 --> 00:48:23,970
presence is going to tell us<font color="#E5E5E5"> when the</font>

1332
00:48:22,050 --> 00:48:27,120
user is there Microsoft uses<font color="#E5E5E5"> AI to</font>

1333
00:48:23,970 --> 00:48:29,040
determine whether<font color="#CCCCCC"> or not the</font><font color="#E5E5E5"> the user is</font>

1334
00:48:27,120 --> 00:48:31,109
sitting<font color="#E5E5E5"> at the machine so when they're</font>

1335
00:48:29,040 --> 00:48:32,940
there<font color="#E5E5E5"> we're going</font><font color="#CCCCCC"> to change the jitter</font>

1336
00:48:31,110 --> 00:48:34,080
<font color="#E5E5E5">or we're</font><font color="#CCCCCC"> do we're just gonna nuke the</font>

1337
00:48:32,940 --> 00:48:37,140
box or something<font color="#CCCCCC"> because there's some</font>

1338
00:48:34,080 --> 00:48:38,370
vulnerabilities within<font color="#E5E5E5"> Windows or we if</font>

1339
00:48:37,140 --> 00:48:40,020
they're<font color="#E5E5E5"> not there we could do something</font>

1340
00:48:38,370 --> 00:48:41,400
<font color="#CCCCCC">like we could increase</font><font color="#E5E5E5"> the jitter we can</font>

1341
00:48:40,020 --> 00:48:43,200
get our<font color="#E5E5E5"> seats you channel going and</font>

1342
00:48:41,400 --> 00:48:43,950
whatnot<font color="#E5E5E5"> so this is</font><font color="#CCCCCC"> just an overview of</font>

1343
00:48:43,200 --> 00:48:45,660
what I just<font color="#CCCCCC"> said</font>

1344
00:48:43,950 --> 00:48:47,220
here are the shutdown<font color="#CCCCCC"> state the user</font>

1345
00:48:45,660 --> 00:48:49,649
present state in the nuke the Box<font color="#CCCCCC"> state</font>

1346
00:48:47,220 --> 00:48:51,180
that's just basically kind<font color="#E5E5E5"> of what we're</font>

1347
00:48:49,650 --> 00:48:53,340
<font color="#E5E5E5">gonna do and then I'm just gonna demo it</font>

1348
00:48:51,180 --> 00:48:55,859
<font color="#E5E5E5">real quick this is pretty much this</font>

1349
00:48:53,340 --> 00:48:57,600
right here it's the stage<font color="#CCCCCC"> one C two</font>

1350
00:48:55,860 --> 00:49:01,100
<font color="#E5E5E5">storing it</font><font color="#CCCCCC"> in the we're having the</font>

1351
00:48:57,600 --> 00:49:01,100
<font color="#CCCCCC">Windows kernel do all this</font><font color="#E5E5E5"> for</font><font color="#CCCCCC"> us right</font>

1352
00:49:03,670 --> 00:49:06,819
<font color="#E5E5E5">all right so this</font><font color="#CCCCCC"> is probably gonna be</font>

1353
00:49:05,349 --> 00:49:08,890
pretty<font color="#E5E5E5"> short</font><font color="#CCCCCC"> this is our</font><font color="#E5E5E5"> Windows machine</font>

1354
00:49:06,819 --> 00:49:10,270
I'm gonna run the dropper<font color="#CCCCCC"> you see the</font>

1355
00:49:08,890 --> 00:49:12,700
dropper is querying the<font color="#E5E5E5"> Windows kernel</font>

1356
00:49:10,270 --> 00:49:14,380
<font color="#E5E5E5">it's saying hey we found malware here</font>

1357
00:49:12,700 --> 00:49:16,210
<font color="#CCCCCC">it's decompressing</font><font color="#E5E5E5"> it it's actually</font>

1358
00:49:14,380 --> 00:49:17,619
<font color="#CCCCCC">putting</font><font color="#E5E5E5"> it together and then it's</font>

1359
00:49:16,210 --> 00:49:19,869
subscribing to the user<font color="#E5E5E5"> event so the</font>

1360
00:49:17,619 --> 00:49:21,819
user just went to<font color="#E5E5E5"> sleep</font><font color="#CCCCCC"> right the user</font>

1361
00:49:19,869 --> 00:49:23,829
woke back up and now what happens<font color="#CCCCCC"> is we</font>

1362
00:49:21,819 --> 00:49:26,500
just we just nuked<font color="#CCCCCC"> Windows</font><font color="#E5E5E5"> from user</font>

1363
00:49:23,829 --> 00:49:28,089
land<font color="#E5E5E5"> by writing</font><font color="#CCCCCC"> zero byte payloads to</font>

1364
00:49:26,500 --> 00:49:30,369
<font color="#E5E5E5">the Windows kernel and we just</font><font color="#CCCCCC"> updated</font>

1365
00:49:28,089 --> 00:49:32,078
all of the state names with a<font color="#E5E5E5"> zero byte</font>

1366
00:49:30,369 --> 00:49:34,270
payload and we just basically<font color="#E5E5E5"> nuked the</font>

1367
00:49:32,079 --> 00:49:36,160
entire box from user land<font color="#CCCCCC"> the</font><font color="#E5E5E5"> only way</font>

1368
00:49:34,270 --> 00:49:38,410
to get this back is if you literally

1369
00:49:36,160 --> 00:49:40,299
<font color="#E5E5E5">take the registry and copy it back over</font>

1370
00:49:38,410 --> 00:49:42,250
and<font color="#E5E5E5"> rewrite it so it's pretty bad so</font>

1371
00:49:40,299 --> 00:49:50,619
<font color="#E5E5E5">yeah destroying a Windows</font><font color="#CCCCCC"> system from</font>

1372
00:49:42,250 --> 00:49:53,319
user land<font color="#E5E5E5"> without being an admin so the</font>

1373
00:49:50,619 --> 00:49:55,630
<font color="#E5E5E5">TLDR is we're screwed endpoint solutions</font>

1374
00:49:53,319 --> 00:49:57,099
<font color="#E5E5E5">can't really do anything</font><font color="#CCCCCC"> about this</font><font color="#E5E5E5"> you</font>

1375
00:49:55,630 --> 00:49:58,630
could you<font color="#E5E5E5"> could do some research on it</font>

1376
00:49:57,099 --> 00:50:00,160
if you want to<font color="#E5E5E5"> check like check event</font>

1377
00:49:58,630 --> 00:50:01,660
tracing and you could<font color="#E5E5E5"> hook you know</font>

1378
00:50:00,160 --> 00:50:03,640
kernels<font color="#E5E5E5"> so you're trying to</font><font color="#CCCCCC"> actually</font>

1379
00:50:01,660 --> 00:50:04,779
identify what's<font color="#E5E5E5"> what's there but if</font>

1380
00:50:03,640 --> 00:50:05,770
<font color="#E5E5E5">you're an endpoint solution I don't</font>

1381
00:50:04,780 --> 00:50:07,240
think it's a really good<font color="#E5E5E5"> idea to hook</font>

1382
00:50:05,770 --> 00:50:08,859
ntdll like I think<font color="#CCCCCC"> that's just a bad</font>

1383
00:50:07,240 --> 00:50:10,240
<font color="#CCCCCC">idea unless you're writing malware then</font>

1384
00:50:08,859 --> 00:50:12,250
it's like a great idea

1385
00:50:10,240 --> 00:50:13,479
<font color="#CCCCCC">put</font><font color="#E5E5E5"> then</font><font color="#CCCCCC"> and then the only thing other</font>

1386
00:50:12,250 --> 00:50:14,890
thing that we can<font color="#CCCCCC"> really try to do is</font>

1387
00:50:13,480 --> 00:50:16,540
monitor<font color="#E5E5E5"> reads and writes but you</font><font color="#CCCCCC"> got to</font>

1388
00:50:14,890 --> 00:50:17,828
remember it's gonna be from<font color="#E5E5E5"> the service</font>

1389
00:50:16,540 --> 00:50:19,690
level account so it's gonna be super

1390
00:50:17,829 --> 00:50:20,530
<font color="#E5E5E5">loud you have to filter on certain</font>

1391
00:50:19,690 --> 00:50:21,790
entries<font color="#E5E5E5"> I don't know I don't</font><font color="#CCCCCC"> have a</font>

1392
00:50:20,530 --> 00:50:23,680
<font color="#CCCCCC">solution like</font><font color="#E5E5E5"> I</font><font color="#CCCCCC"> just have a problem</font>

1393
00:50:21,790 --> 00:50:25,270
<font color="#CCCCCC">normally I try</font><font color="#E5E5E5"> to bring a</font><font color="#CCCCCC"> solution with</font>

1394
00:50:23,680 --> 00:50:27,069
the problem but that<font color="#CCCCCC"> was like</font><font color="#E5E5E5"> not</font><font color="#CCCCCC"> really</font>

1395
00:50:25,270 --> 00:50:29,890
in our<font color="#E5E5E5"> wheelhouse today so hopefully</font>

1396
00:50:27,069 --> 00:50:30,819
Microsoft can do this<font color="#E5E5E5"> soon and so just</font>

1397
00:50:29,890 --> 00:50:32,920
finishing up<font color="#E5E5E5"> these are just some</font>

1398
00:50:30,819 --> 00:50:34,270
requests that<font color="#E5E5E5"> I think we had for</font>

1399
00:50:32,920 --> 00:50:37,869
Microsoft this is kind of like<font color="#E5E5E5"> the last</font>

1400
00:50:34,270 --> 00:50:39,280
<font color="#E5E5E5">of it</font><font color="#CCCCCC"> w</font><font color="#E5E5E5"> NF documentation can we get some</font>

1401
00:50:37,869 --> 00:50:41,290
can we<font color="#E5E5E5"> get some</font><font color="#CCCCCC"> w and</font><font color="#E5E5E5"> Evan we don't know</font>

1402
00:50:39,280 --> 00:50:42,760
what this<font color="#CCCCCC"> is doing</font><font color="#E5E5E5"> we want some native</font>

1403
00:50:41,290 --> 00:50:44,049
API logging or something I<font color="#E5E5E5"> don't know I</font>

1404
00:50:42,760 --> 00:50:46,720
don't<font color="#E5E5E5"> know what else we</font><font color="#CCCCCC"> can do</font><font color="#E5E5E5"> like</font>

1405
00:50:44,049 --> 00:50:49,299
we're calling native API<font color="#CCCCCC"> can we have the</font>

1406
00:50:46,720 --> 00:50:51,569
azure portal<font color="#CCCCCC"> lock down by default and</font>

1407
00:50:49,299 --> 00:50:53,349
then let's let's<font color="#E5E5E5"> have additional</font>

1408
00:50:51,569 --> 00:50:54,400
<font color="#E5E5E5">conditional access</font><font color="#CCCCCC"> within Active</font>

1409
00:50:53,349 --> 00:50:56,290
<font color="#CCCCCC">Directory without having to have</font><font color="#E5E5E5"> the</font>

1410
00:50:54,400 --> 00:50:57,880
upgrade cost<font color="#E5E5E5"> that's kind of like it</font>

1411
00:50:56,290 --> 00:51:00,400
seems pretty<font color="#CCCCCC"> straightforward like I</font>

1412
00:50:57,880 --> 00:51:02,440
<font color="#CCCCCC">don't know</font><font color="#E5E5E5"> and then fix the phantom host</font>

1413
00:51:00,400 --> 00:51:04,720
info<font color="#E5E5E5"> with the RDP</font><font color="#CCCCCC"> NLA I</font><font color="#E5E5E5"> think they did</font>

1414
00:51:02,440 --> 00:51:08,020
<font color="#CCCCCC">that in 2016</font><font color="#E5E5E5"> but can we maybe get a back</font>

1415
00:51:04,720 --> 00:51:10,899
port of that fix<font color="#E5E5E5"> and then make it</font><font color="#CCCCCC"> easy</font>

1416
00:51:08,020 --> 00:51:14,970
for oh three<font color="#CCCCCC"> 65 admins</font><font color="#E5E5E5"> to find the rogue</font>

1417
00:51:10,900 --> 00:51:14,970
admins and yep

1418
00:51:17,740 --> 00:51:22,549
yeah we so we could bypass<font color="#E5E5E5"> the event</font>

1419
00:51:20,300 --> 00:51:25,370
<font color="#CCCCCC">lobs</font><font color="#E5E5E5"> anything within the Windows</font>

1420
00:51:22,550 --> 00:51:29,180
environment<font color="#CCCCCC"> if we're</font><font color="#E5E5E5"> dealing with the CW</font>

1421
00:51:25,370 --> 00:51:32,450
the<font color="#CCCCCC"> low-level</font><font color="#E5E5E5"> API calls yeah</font>

1422
00:51:29,180 --> 00:51:34,160
event<font color="#E5E5E5"> lobs an</font><font color="#CCCCCC"> sis mine yeah and</font><font color="#E5E5E5"> without</font>

1423
00:51:32,450 --> 00:51:35,569
we're out of time<font color="#E5E5E5"> guys so if you want to</font>

1424
00:51:34,160 --> 00:51:36,210
ask<font color="#E5E5E5"> questions can find us afterwards</font>

1425
00:51:35,570 --> 00:51:49,989
<font color="#E5E5E5">thank you so much</font>

1426
00:51:36,210 --> 00:51:49,989
[Music]

