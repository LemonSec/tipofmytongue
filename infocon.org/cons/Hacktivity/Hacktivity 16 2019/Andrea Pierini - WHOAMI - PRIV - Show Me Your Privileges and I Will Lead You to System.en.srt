1
00:00:00,030 --> 00:00:07,020
hello and welcome back to activity 2019

2
00:00:03,680 --> 00:00:09,540
we have a few announcements first if you

3
00:00:07,020 --> 00:00:11,219
have a budge and a VIP band

4
00:00:09,540 --> 00:00:14,219
please remember to pick up your hoodie

5
00:00:11,219 --> 00:00:17,820
and your t-shirt from downstairs if you

6
00:00:14,219 --> 00:00:21,600
have an electronic badge please update

7
00:00:17,820 --> 00:00:23,369
the firmware on your badge be sure to

8
00:00:21,600 --> 00:00:26,880
have a look at the hacker rank game in

9
00:00:23,369 --> 00:00:29,189
the Morgan Stanley booth and the black

10
00:00:26,880 --> 00:00:35,239
cell booth is very interesting with a

11
00:00:29,189 --> 00:00:35,239
display on vulnerabilities of security

12
00:00:36,380 --> 00:00:42,570
please could you welcome Andrea peony to

13
00:00:41,190 --> 00:00:45,570
talk about Who am I

14
00:00:42,570 --> 00:00:52,760
privy show me your privileges and I will

15
00:00:45,570 --> 00:00:55,860
lead you to system hello to everyone

16
00:00:52,760 --> 00:00:59,099
hope it continued to work in finger

17
00:00:55,860 --> 00:01:01,800
crossed you can see it okay so first of

18
00:00:59,100 --> 00:01:04,530
all it's a real pleasure for me to be

19
00:01:01,800 --> 00:01:06,390
here for this amazing event and I would

20
00:01:04,530 --> 00:01:09,590
like to thank the organization for

21
00:01:06,390 --> 00:01:13,740
giving me this great opportunity just

22
00:01:09,590 --> 00:01:16,740
towards about me before starting among

23
00:01:13,740 --> 00:01:19,080
the other things I work like an idea

24
00:01:16,740 --> 00:01:22,369
architect and security manager for an

25
00:01:19,080 --> 00:01:25,200
Italian company I come from Italy and

26
00:01:22,369 --> 00:01:28,290
security has always been a special

27
00:01:25,200 --> 00:01:32,000
interest for me since the early 19th so

28
00:01:28,290 --> 00:01:34,920
I'm little bit old to be honest

29
00:01:32,000 --> 00:01:38,070
offensive security is much more an hobby

30
00:01:34,920 --> 00:01:41,100
for me and during my spare time when I'm

31
00:01:38,070 --> 00:01:44,939
not cycling or diving I like to

32
00:01:41,100 --> 00:01:47,850
understand and sometimes discover some

33
00:01:44,939 --> 00:01:51,059
security issues in Windows and Linux and

34
00:01:47,850 --> 00:01:53,240
environments these are my contacts and I

35
00:01:51,060 --> 00:01:56,240
am a proud member of these two

36
00:01:53,240 --> 00:01:56,240
organizations

37
00:01:59,159 --> 00:02:04,359
first of all why this talk because my

38
00:02:02,049 --> 00:02:06,159
talk is about windows privileges I don't

39
00:02:04,359 --> 00:02:08,829
know how many of you know about Windows

40
00:02:06,159 --> 00:02:13,230
privileges I think it's a well-known

41
00:02:08,830 --> 00:02:17,080
argument but we will introduce it

42
00:02:13,230 --> 00:02:18,518
because I started my research not so

43
00:02:17,080 --> 00:02:22,269
much research but to understand better

44
00:02:18,519 --> 00:02:24,519
privileges privileges because I saw

45
00:02:22,269 --> 00:02:27,519
these techniques I found that they were

46
00:02:24,519 --> 00:02:30,340
not so much exploited not much taken in

47
00:02:27,519 --> 00:02:31,150
consideration when it comes to privilege

48
00:02:30,340 --> 00:02:34,780
escalation

49
00:02:31,150 --> 00:02:38,019
so some techniques of manipulation are

50
00:02:34,780 --> 00:02:40,569
not well documented and I decided to dig

51
00:02:38,019 --> 00:02:44,099
deeper one day I ran in this fantastic

52
00:02:40,569 --> 00:02:47,530
article with such a perfect resume of

53
00:02:44,099 --> 00:02:49,569
privileges and I shared useful

54
00:02:47,530 --> 00:02:57,790
informations with the authors of this

55
00:02:49,569 --> 00:02:59,950
paper the agenda after a small in a very

56
00:02:57,790 --> 00:03:02,230
short introduction we will see in more

57
00:02:59,950 --> 00:03:04,810
detail some very interesting privileges

58
00:03:02,230 --> 00:03:07,899
some powerful privileges which which are

59
00:03:04,810 --> 00:03:12,389
called God privileges and then how to

60
00:03:07,900 --> 00:03:16,480
use them and then some final thoughts

61
00:03:12,389 --> 00:03:18,609
sorry for my bad english I hope you

62
00:03:16,480 --> 00:03:20,470
understand me but as Italian I always

63
00:03:18,609 --> 00:03:24,780
speak my with my hands and maybe this

64
00:03:20,470 --> 00:03:24,780
can help you to understand me better I

65
00:03:25,139 --> 00:03:30,970
don't want to bore you with privileges

66
00:03:27,970 --> 00:03:32,859
and theories so first of I spend just

67
00:03:30,970 --> 00:03:37,049
two words about it - what are privileges

68
00:03:32,859 --> 00:03:43,230
privileges as Microsoft says are special

69
00:03:37,049 --> 00:03:46,269
rights granted to users to perform some

70
00:03:43,230 --> 00:03:49,268
high privilege the operations on the

71
00:03:46,269 --> 00:03:51,730
operating system such as shutting down

72
00:03:49,269 --> 00:03:56,290
the system changing the system time and

73
00:03:51,730 --> 00:03:59,260
so on in Windows and environments some

74
00:03:56,290 --> 00:04:01,298
users and groups have already predefined

75
00:03:59,260 --> 00:04:03,340
privileges obviously administrator

76
00:04:01,299 --> 00:04:06,340
system has all privileges not all

77
00:04:03,340 --> 00:04:10,239
privileges but most of them some users

78
00:04:06,340 --> 00:04:12,720
have special privileges they can be

79
00:04:10,239 --> 00:04:15,940
assigned or managed via the

80
00:04:12,720 --> 00:04:19,750
security added the console of the GP

81
00:04:15,940 --> 00:04:21,850
edit for Microsoft but you can also play

82
00:04:19,750 --> 00:04:25,780
with privileges using directly the

83
00:04:21,850 --> 00:04:28,150
native our AP is another interesting two

84
00:04:25,780 --> 00:04:31,030
thing to mention is that some privileges

85
00:04:28,150 --> 00:04:32,950
totally overwrite the permission which I

86
00:04:31,030 --> 00:04:35,679
set on to an object and this is very

87
00:04:32,950 --> 00:04:39,219
very cool

88
00:04:35,680 --> 00:04:41,440
another thing is that the most god

89
00:04:39,220 --> 00:04:44,470
privileges are only available in high

90
00:04:41,440 --> 00:04:46,780
integrity level process in a high shell

91
00:04:44,470 --> 00:04:48,400
process otherwise you won't see these

92
00:04:46,780 --> 00:04:51,700
privileges this is the first thing that

93
00:04:48,400 --> 00:04:54,219
we should do try to spawn an high

94
00:04:51,700 --> 00:04:57,099
integrity level process like the CMD

95
00:04:54,220 --> 00:04:59,380
shell and if if you are able to spawn it

96
00:04:57,100 --> 00:05:02,020
probably we have some privileges how do

97
00:04:59,380 --> 00:05:08,560
we discover our privileges simply with

98
00:05:02,020 --> 00:05:10,690
who am i / premium windows access tokens

99
00:05:08,560 --> 00:05:12,450
why I speak about windows access token

100
00:05:10,690 --> 00:05:14,740
because they are closely linked

101
00:05:12,450 --> 00:05:18,550
privileges and tokens big bill because

102
00:05:14,740 --> 00:05:20,650
privileges are assigned to the token

103
00:05:18,550 --> 00:05:22,900
when I log on to the system because when

104
00:05:20,650 --> 00:05:25,320
I log on to the system a special token

105
00:05:22,900 --> 00:05:28,419
will be assigned to me and each time I

106
00:05:25,320 --> 00:05:32,110
spawn a process or a thread a copy of

107
00:05:28,419 --> 00:05:36,690
this token will be made what does this

108
00:05:32,110 --> 00:05:36,690
token contain a lot of information

109
00:05:36,810 --> 00:05:44,820
members group memberships and so on

110
00:05:40,290 --> 00:05:47,470
interesting is that in the token is

111
00:05:44,820 --> 00:05:49,630
included the list of privileges which

112
00:05:47,470 --> 00:05:52,510
are granted to me so when I have a token

113
00:05:49,630 --> 00:05:54,070
with elevated privileges I can if I can

114
00:05:52,510 --> 00:05:55,570
impersonate this token I will

115
00:05:54,070 --> 00:06:00,520
automatically have all these privileges

116
00:05:55,570 --> 00:06:02,800
a token can be of different types again

117
00:06:00,520 --> 00:06:04,960
I don't want to bore you primarily

118
00:06:02,800 --> 00:06:07,630
impersonation token a primary process in

119
00:06:04,960 --> 00:06:09,580
primary token is mainly used for

120
00:06:07,630 --> 00:06:13,000
supporting processes and impersonation

121
00:06:09,580 --> 00:06:17,039
token for spawning threads it's a little

122
00:06:13,000 --> 00:06:20,500
bit more complicated but keep it simple

123
00:06:17,040 --> 00:06:22,210
the only useful type of token for us are

124
00:06:20,500 --> 00:06:24,160
the last one security impatient

125
00:06:22,210 --> 00:06:25,930
impersonation or security delegation

126
00:06:24,160 --> 00:06:28,330
token these are the only two types

127
00:06:25,930 --> 00:06:31,060
of tokens we can abuse from the other

128
00:06:28,330 --> 00:06:34,740
tokens are very beautiful have a lot of

129
00:06:31,060 --> 00:06:34,740
privileges but we cannot use them

130
00:06:34,919 --> 00:06:42,430
important thing is that once a token has

131
00:06:37,810 --> 00:06:44,620
been generated from the logon process it

132
00:06:42,430 --> 00:06:47,080
the primary token frozen bit will be set

133
00:06:44,620 --> 00:06:49,690
this mean that I cannot add other

134
00:06:47,080 --> 00:06:51,430
privileges to make token otherwise it

135
00:06:49,690 --> 00:06:54,969
would be too simple to elevate my

136
00:06:51,430 --> 00:06:57,100
privileges now but I can change the

137
00:06:54,970 --> 00:07:00,539
token I can duplicate the token and for

138
00:06:57,100 --> 00:07:02,650
example from a primary token create a

139
00:07:00,539 --> 00:07:08,860
impersonation token in order to

140
00:07:02,650 --> 00:07:11,669
impersonate the trade for example ok

141
00:07:08,860 --> 00:07:17,710
that's it everything is clear up to now

142
00:07:11,669 --> 00:07:19,930
yeah ok good which account have special

143
00:07:17,710 --> 00:07:22,960
privileges as I told you before

144
00:07:19,930 --> 00:07:24,910
obviously administrator local system

145
00:07:22,960 --> 00:07:27,940
they have got privileges they are the

146
00:07:24,910 --> 00:07:30,729
god on the machine some built-in users

147
00:07:27,940 --> 00:07:33,580
group for example backup operators have

148
00:07:30,729 --> 00:07:36,460
impaired backup and restore privilege

149
00:07:33,580 --> 00:07:39,880
printer operators have the low driver

150
00:07:36,460 --> 00:07:43,000
privilege on a domain controller local

151
00:07:39,880 --> 00:07:46,240
and network service accounts they have

152
00:07:43,000 --> 00:07:47,919
always impersonate and sometime assign

153
00:07:46,240 --> 00:07:51,909
primary privileges and we will see that

154
00:07:47,919 --> 00:07:53,740
this is very very interesting one also

155
00:07:51,909 --> 00:07:56,440
managed service and neutral accounts

156
00:07:53,740 --> 00:07:58,419
third party application users because in

157
00:07:56,440 --> 00:08:01,570
order to use install some applications

158
00:07:58,419 --> 00:08:03,430
the software renders ask us to grant to

159
00:08:01,570 --> 00:08:04,659
the user which will impersonate this

160
00:08:03,430 --> 00:08:07,960
application to grant him special

161
00:08:04,659 --> 00:08:11,229
privileges or sometimes and it really

162
00:08:07,960 --> 00:08:13,299
happens I I you can believe me some

163
00:08:11,229 --> 00:08:15,789
misconfigured users which have been

164
00:08:13,300 --> 00:08:18,460
granted unnecessary privileges so if you

165
00:08:15,789 --> 00:08:20,469
are able to compromise an account of

166
00:08:18,460 --> 00:08:25,539
such misconfigured users you have done

167
00:08:20,470 --> 00:08:28,229
it without compromising that min account

168
00:08:25,539 --> 00:08:28,229
for example

169
00:08:30,320 --> 00:08:34,669
I for example the this Becca program

170
00:08:33,860 --> 00:08:37,669
Backup Exec

171
00:08:34,669 --> 00:08:40,100
requires for the user who launches the

172
00:08:37,669 --> 00:08:42,679
program obviously backup and restore

173
00:08:40,100 --> 00:08:45,560
privilege because it's his task but also

174
00:08:42,679 --> 00:08:48,020
the act as part of operating system the

175
00:08:45,560 --> 00:08:51,109
TCB privilege granting these privileges

176
00:08:48,020 --> 00:08:54,380
means granting to this user the complete

177
00:08:51,110 --> 00:08:57,710
control over the system so ok we have to

178
00:08:54,380 --> 00:09:00,910
separate the the risk the duties we have

179
00:08:57,710 --> 00:09:03,890
to grant only to the users the right

180
00:09:00,910 --> 00:09:06,740
privileges to perform the task but even

181
00:09:03,890 --> 00:09:08,270
to a user this privilege is like telling

182
00:09:06,740 --> 00:09:11,710
him he had the key the keys of the

183
00:09:08,270 --> 00:09:11,710
kingdom do whatever you want

184
00:09:13,570 --> 00:09:19,700
how can we round this privileged

185
00:09:17,270 --> 00:09:21,439
accounts well there are so many

186
00:09:19,700 --> 00:09:24,710
techniques and I don't want to speak

187
00:09:21,440 --> 00:09:27,730
about it but simply miss misconfigured

188
00:09:24,710 --> 00:09:31,910
service which I can impersonate or

189
00:09:27,730 --> 00:09:36,890
simple remote code execution via an CMD

190
00:09:31,910 --> 00:09:40,819
shell on a server or a command execution

191
00:09:36,890 --> 00:09:43,100
VRMs SQL and so on intercepting

192
00:09:40,820 --> 00:09:46,280
man-in-the-middle attacks so ntlm

193
00:09:43,100 --> 00:09:52,520
authentication or stealing credentials

194
00:09:46,280 --> 00:09:57,079
Kerberos ting etcetera etc another

195
00:09:52,520 --> 00:10:00,590
important thing to get these privileges

196
00:09:57,080 --> 00:10:02,570
is to abuse from exploits in the past

197
00:10:00,590 --> 00:10:06,230
have been many exploits which

198
00:10:02,570 --> 00:10:08,480
manipulates tokens and especially that

199
00:10:06,230 --> 00:10:10,370
last two one techniques partial right

200
00:10:08,480 --> 00:10:13,190
and arbitrary words are very very

201
00:10:10,370 --> 00:10:15,680
interesting because they permit as a

202
00:10:13,190 --> 00:10:17,930
normal user from the userland to

203
00:10:15,680 --> 00:10:22,099
overwrite the a process structure in

204
00:10:17,930 --> 00:10:24,560
kernel mode okay and to grant to add to

205
00:10:22,100 --> 00:10:26,390
himself other privileges and these

206
00:10:24,560 --> 00:10:30,109
techniques are successfully being

207
00:10:26,390 --> 00:10:32,060
demonstrated like the first one and the

208
00:10:30,110 --> 00:10:34,840
other one we will I show you is the load

209
00:10:32,060 --> 00:10:34,839
driver privilege

210
00:10:37,220 --> 00:10:41,780
okay let's start with the privileges the

211
00:10:39,410 --> 00:10:44,839
first one and probably the most common

212
00:10:41,780 --> 00:10:47,120
and most well known is the debug

213
00:10:44,840 --> 00:10:49,580
privilege and debug privilege simply

214
00:10:47,120 --> 00:10:51,710
grants you to attach your debugger to

215
00:10:49,580 --> 00:10:53,810
any process when I say any process any

216
00:10:51,710 --> 00:10:56,360
process also administrator system

217
00:10:53,810 --> 00:10:59,239
process obviously this is the simplest

218
00:10:56,360 --> 00:11:01,940
way to elevate to make privilege

219
00:10:59,240 --> 00:11:04,430
escalation debug processes the the

220
00:11:01,940 --> 00:11:08,020
privilege of debug normally should be

221
00:11:04,430 --> 00:11:11,989
granted to developers okay but sometimes

222
00:11:08,020 --> 00:11:13,460
this is not always the case and if you

223
00:11:11,990 --> 00:11:15,830
have this privilege

224
00:11:13,460 --> 00:11:19,490
you can attach and you can write code

225
00:11:15,830 --> 00:11:21,680
your own shy code for example in a

226
00:11:19,490 --> 00:11:24,400
process which is running with a high

227
00:11:21,680 --> 00:11:27,709
privilege there are so many techniques

228
00:11:24,400 --> 00:11:30,970
from write process create remote read

229
00:11:27,710 --> 00:11:33,830
and so on these are well documented so

230
00:11:30,970 --> 00:11:36,500
it's only important to say that with

231
00:11:33,830 --> 00:11:39,290
with these debug privileges as written

232
00:11:36,500 --> 00:11:41,810
here guy from Microsoft modded 10 years

233
00:11:39,290 --> 00:11:43,910
ago said if you grant somebody that

234
00:11:41,810 --> 00:11:47,329
debug privilege you gave away the farm

235
00:11:43,910 --> 00:11:56,660
because you grant him all privileges he

236
00:11:47,330 --> 00:11:59,660
is the system on this machine another

237
00:11:56,660 --> 00:12:02,900
interesting way to exploit the debug

238
00:11:59,660 --> 00:12:06,589
privilege without making it too complex

239
00:12:02,900 --> 00:12:08,750
with creating remote Reds etc etc it's

240
00:12:06,590 --> 00:12:10,610
simply setting the parent process

241
00:12:08,750 --> 00:12:13,310
creating a process and setting the

242
00:12:10,610 --> 00:12:16,390
parent process of my process privilege

243
00:12:13,310 --> 00:12:21,170
process and in this manner I will

244
00:12:16,390 --> 00:12:23,600
impersonate the user who is the owner of

245
00:12:21,170 --> 00:12:27,229
the parent bill there are many ways to

246
00:12:23,600 --> 00:12:30,110
do it to do it the simple API calls I

247
00:12:27,230 --> 00:12:31,750
have wrote some time ago a PowerShell

248
00:12:30,110 --> 00:12:35,210
script you can find it on my github

249
00:12:31,750 --> 00:12:38,420
which does this exactly which spawns

250
00:12:35,210 --> 00:12:41,030
which sets the parent process privilege

251
00:12:38,420 --> 00:12:43,579
process you can choose which is the pit

252
00:12:41,030 --> 00:12:45,800
you want to set as parent process as as

253
00:12:43,580 --> 00:12:48,770
and as you can see in the screenshot a

254
00:12:45,800 --> 00:12:51,740
simple user becomes

255
00:12:48,770 --> 00:12:55,760
system and he owned he also can become

256
00:12:51,740 --> 00:12:58,160
trusted installer because if I take the

257
00:12:55,760 --> 00:13:00,230
pit of the trust then trusted installer

258
00:12:58,160 --> 00:13:08,660
I can impersonate trusted installer

259
00:13:00,230 --> 00:13:12,350
which is very very dangerous the rest or

260
00:13:08,660 --> 00:13:14,390
privilege we are performing backup so we

261
00:13:12,350 --> 00:13:17,570
need to backup and restore and we need

262
00:13:14,390 --> 00:13:19,339
special privileges in order to overwrite

263
00:13:17,570 --> 00:13:21,830
overrides claw sorry

264
00:13:19,339 --> 00:13:26,350
in order to override the permission sets

265
00:13:21,830 --> 00:13:28,940
we just had an object if a file is

266
00:13:26,350 --> 00:13:31,459
accessible only by a special group or

267
00:13:28,940 --> 00:13:35,630
administrator a backup operator could

268
00:13:31,459 --> 00:13:38,949
not access this file okay but if he has

269
00:13:35,630 --> 00:13:43,760
restored Beca privilege he can override

270
00:13:38,950 --> 00:13:46,970
these security settings so there are two

271
00:13:43,760 --> 00:13:48,589
API calls which I can use as with these

272
00:13:46,970 --> 00:13:52,010
privileges in order to perform these

273
00:13:48,589 --> 00:13:54,709
nasty things the first one is create

274
00:13:52,010 --> 00:13:57,050
file and I only have to specify a

275
00:13:54,709 --> 00:13:59,569
special flag with this file flag backup

276
00:13:57,050 --> 00:14:02,899
semantics so if I'm doing some

277
00:13:59,570 --> 00:14:04,250
operations windows checks if the flag if

278
00:14:02,899 --> 00:14:05,829
I'm doing some operation I want to

279
00:14:04,250 --> 00:14:08,480
access a file which I could not access

280
00:14:05,829 --> 00:14:11,300
windows checks if I have this flag

281
00:14:08,480 --> 00:14:14,000
active and I have the right privilege

282
00:14:11,300 --> 00:14:16,729
please go on I won't I won't stop you

283
00:14:14,000 --> 00:14:19,130
okay and the same thing I can do it on

284
00:14:16,730 --> 00:14:23,120
the registry keys so I can override

285
00:14:19,130 --> 00:14:26,510
registry keys ok so I can write files

286
00:14:23,120 --> 00:14:29,270
everywhere even in system 32 even files

287
00:14:26,510 --> 00:14:31,160
owned from trusted installer and as you

288
00:14:29,270 --> 00:14:33,589
can imagine there are countless

289
00:14:31,160 --> 00:14:37,069
possibilities so the rest are privileges

290
00:14:33,589 --> 00:14:40,310
from if I have restor privilege gaining

291
00:14:37,070 --> 00:14:44,950
system rights is just as drinking a

292
00:14:40,310 --> 00:14:44,949
bottle of good Italian wine ok

293
00:14:47,730 --> 00:14:55,650
I have just an example but just of one

294
00:14:52,710 --> 00:14:58,680
of the many examples to show you how to

295
00:14:55,650 --> 00:15:02,400
perform this task for example I will

296
00:14:58,680 --> 00:15:04,739
modify a service configuration and in

297
00:15:02,400 --> 00:15:06,900
this case is the WAP Push message

298
00:15:04,740 --> 00:15:09,540
routing service which is present on all

299
00:15:06,900 --> 00:15:13,050
on each Windows installation starting

300
00:15:09,540 --> 00:15:16,290
from 2016 if I don't

301
00:15:13,050 --> 00:15:18,359
yes 2016 this service is interesting

302
00:15:16,290 --> 00:15:20,480
because because a standard user can

303
00:15:18,360 --> 00:15:23,940
start the service ok because obviously

304
00:15:20,480 --> 00:15:25,740
even if even if I have all the rights on

305
00:15:23,940 --> 00:15:28,710
the service I can write overwrite the

306
00:15:25,740 --> 00:15:34,790
service but if I cannot launch it I'm I

307
00:15:28,710 --> 00:15:34,790
have no possibilities so what's the idea

308
00:15:36,500 --> 00:15:41,910
first of all I create a simple service

309
00:15:39,090 --> 00:15:44,160
DLL which will run the batch file and

310
00:15:41,910 --> 00:15:49,410
these bad files I will spawn a reverse

311
00:15:44,160 --> 00:15:51,240
shell okay and then I will overwrite the

312
00:15:49,410 --> 00:15:54,180
service configuration telling him that

313
00:15:51,240 --> 00:15:57,240
the service DLL is not the service that

314
00:15:54,180 --> 00:16:00,170
the original service DLL but the service

315
00:15:57,240 --> 00:16:04,530
DLL which I quit copying systems and 32

316
00:16:00,170 --> 00:16:08,130
directory this is possible because I use

317
00:16:04,530 --> 00:16:13,319
the backup Symantec flag the restore

318
00:16:08,130 --> 00:16:16,800
flag in this case after that I copy the

319
00:16:13,320 --> 00:16:19,650
DLL I could even overwrite the original

320
00:16:16,800 --> 00:16:21,719
DLL because it even if it's owned by a

321
00:16:19,650 --> 00:16:24,270
trust and installer I am performing a

322
00:16:21,720 --> 00:16:26,820
backup operation and I can overwrite

323
00:16:24,270 --> 00:16:32,460
everywhere I have also a short video

324
00:16:26,820 --> 00:16:34,610
about this I hope it will work I have a

325
00:16:32,460 --> 00:16:36,870
restore privilege I created a simple

326
00:16:34,610 --> 00:16:38,730
executable by kudos superior script in

327
00:16:36,870 --> 00:16:41,160
which I will modify a registry key and

328
00:16:38,730 --> 00:16:44,900
will overwrite a fly the file and then

329
00:16:41,160 --> 00:16:44,900
launch my service

330
00:16:51,080 --> 00:16:57,330
and I get the rest the vest back shell

331
00:16:55,230 --> 00:17:15,060
and as you can see I am system so it's

332
00:16:57,330 --> 00:17:16,980
very very easy to do to implement the

333
00:17:15,060 --> 00:17:19,530
backup privilege is very similar it's

334
00:17:16,980 --> 00:17:21,660
the opposite but it's very similar I can

335
00:17:19,530 --> 00:17:24,329
perform backup operation this means that

336
00:17:21,660 --> 00:17:28,160
I can access file for a backup purpose

337
00:17:24,329 --> 00:17:28,159
which could normally I could not access

338
00:17:28,220 --> 00:17:33,870
one interesting thing is obviously to

339
00:17:30,870 --> 00:17:37,260
hash to dump the hash of the local and

340
00:17:33,870 --> 00:17:41,689
@lm database I can do it in many ways in

341
00:17:37,260 --> 00:17:44,990
this in this way I am doing it now with

342
00:17:41,690 --> 00:17:48,210
simply operating system commands the Reg

343
00:17:44,990 --> 00:17:51,780
utility which can allows me to perform a

344
00:17:48,210 --> 00:17:55,080
backup if I have backup privileges so I

345
00:17:51,780 --> 00:17:58,200
will simply backup copy the system hive

346
00:17:55,080 --> 00:18:00,510
and then with one of the tools in X this

347
00:17:58,200 --> 00:18:02,190
example mimic adds I will dump the

348
00:18:00,510 --> 00:18:10,620
hashes and obtain the hash of

349
00:18:02,190 --> 00:18:13,620
administrator for example I can read

350
00:18:10,620 --> 00:18:16,199
files everywhere in this case I can read

351
00:18:13,620 --> 00:18:21,750
the file which only administrator can

352
00:18:16,200 --> 00:18:25,370
access always with the special flag and

353
00:18:21,750 --> 00:18:25,370
then obviously copy it elsewhere

354
00:18:26,470 --> 00:18:33,580
members of Beck apparatus can access the

355
00:18:30,399 --> 00:18:37,500
domain controller to perform backups so

356
00:18:33,580 --> 00:18:40,720
I as in backup operator without other

357
00:18:37,500 --> 00:18:44,409
privileges or other groups I can start a

358
00:18:40,720 --> 00:18:48,399
backup operation damn the NTDs database

359
00:18:44,409 --> 00:18:51,490
and then obtain the hashes in this first

360
00:18:48,399 --> 00:18:53,258
example I use vs admin which is an

361
00:18:51,490 --> 00:18:56,200
utility with Windows but you have to

362
00:18:53,259 --> 00:18:59,169
install it okay and then with one of the

363
00:18:56,200 --> 00:19:01,629
tools available in this case I am using

364
00:18:59,169 --> 00:19:03,669
yes internals I get the boot key and

365
00:19:01,629 --> 00:19:05,980
then obtain the hashes from

366
00:19:03,669 --> 00:19:13,269
administrator dumping the database and

367
00:19:05,980 --> 00:19:15,490
tdst the Active Directory database or I

368
00:19:13,269 --> 00:19:19,750
can do it I don't know how many of you

369
00:19:15,490 --> 00:19:20,289
you know this utility is this shadow the

370
00:19:19,750 --> 00:19:23,860
shadow

371
00:19:20,289 --> 00:19:26,230
unlike VSS permits to perform operations

372
00:19:23,860 --> 00:19:29,529
even if you are not administrator so I

373
00:19:26,230 --> 00:19:31,750
can make a backup of the entity SD tab

374
00:19:29,529 --> 00:19:34,509
database with the shadow copied in

375
00:19:31,750 --> 00:19:37,620
another location and then perform the

376
00:19:34,509 --> 00:19:37,620
dump of the hashes

377
00:19:43,470 --> 00:19:48,640
if you have backup and restore

378
00:19:45,580 --> 00:19:50,139
privileges you are member by the of the

379
00:19:48,640 --> 00:19:52,750
backup of latest group there is another

380
00:19:50,140 --> 00:19:56,080
interesting opportunity because you can

381
00:19:52,750 --> 00:19:58,960
set permission on each object even if

382
00:19:56,080 --> 00:20:02,020
you can't do it okay and this is very

383
00:19:58,960 --> 00:20:06,909
cool and as you can see here via

384
00:20:02,020 --> 00:20:09,250
PowerShell I have this folder which only

385
00:20:06,909 --> 00:20:12,370
admin has full control and no one else

386
00:20:09,250 --> 00:20:14,799
has other access as a backup operator I

387
00:20:12,370 --> 00:20:17,260
can change the permission and add myself

388
00:20:14,799 --> 00:20:21,760
full count grant to myself full control

389
00:20:17,260 --> 00:20:24,010
to this directory this is what I call a

390
00:20:21,760 --> 00:20:29,470
very special bonus given to the backup

391
00:20:24,010 --> 00:20:31,658
operators very similar is this one the

392
00:20:29,470 --> 00:20:34,900
take ownership privilege what does this

393
00:20:31,659 --> 00:20:37,630
privilege says these privileges grants

394
00:20:34,900 --> 00:20:40,630
you the possibility to take ownership of

395
00:20:37,630 --> 00:20:44,950
file renewals you see it also in the GUI

396
00:20:40,630 --> 00:20:47,710
interface of the Explorer of Windows you

397
00:20:44,950 --> 00:20:51,039
can take ownership of a file this is

398
00:20:47,710 --> 00:20:56,200
what user with this special privilege

399
00:20:51,039 --> 00:20:59,200
can do okay again two simple API calls

400
00:20:56,200 --> 00:21:00,850
set security info or set name security

401
00:20:59,200 --> 00:21:03,610
info in the first one I will pass him

402
00:21:00,850 --> 00:21:06,490
the handle of the object I want to take

403
00:21:03,610 --> 00:21:09,789
ownership in the second case the name of

404
00:21:06,490 --> 00:21:14,289
the object object can be of any type not

405
00:21:09,789 --> 00:21:18,490
only file but of any type how could we

406
00:21:14,289 --> 00:21:20,230
use this for privilege escalation the

407
00:21:18,490 --> 00:21:22,690
concept is the same like the rest or

408
00:21:20,230 --> 00:21:25,390
privilege but first of all I have to

409
00:21:22,690 --> 00:21:28,240
take ownership of the registry key of

410
00:21:25,390 --> 00:21:30,190
the service I wish to modify one I took

411
00:21:28,240 --> 00:21:32,380
ownership of this register key I will

412
00:21:30,190 --> 00:21:35,200
grant to myself or for the sake of

413
00:21:32,380 --> 00:21:38,409
simply nice to everyone full control on

414
00:21:35,200 --> 00:21:42,580
this register key and then I will alter

415
00:21:38,409 --> 00:21:45,039
the for example the bin the executable

416
00:21:42,580 --> 00:21:47,590
part of the service in this case the MSI

417
00:21:45,039 --> 00:21:49,720
service I will let him launch another

418
00:21:47,590 --> 00:21:52,418
executable which can contain my

419
00:21:49,720 --> 00:21:57,230
malicious code them

420
00:21:52,419 --> 00:22:00,649
should be here okay I take the ownership

421
00:21:57,230 --> 00:22:03,399
with the owners this flag owners owners

422
00:22:00,649 --> 00:22:06,408
security information obviously I have to

423
00:22:03,399 --> 00:22:11,479
the right privilege and then once I took

424
00:22:06,409 --> 00:22:13,370
the ownership using some API calls I

425
00:22:11,480 --> 00:22:15,679
will set the permissions on this key

426
00:22:13,370 --> 00:22:17,779
grant to everyone the full permission on

427
00:22:15,679 --> 00:22:19,370
its key and then change the

428
00:22:17,779 --> 00:22:20,269
configuration of the service start the

429
00:22:19,370 --> 00:22:22,309
service Ebola

430
00:22:20,269 --> 00:22:24,620
I'm the Navigant system because ability

431
00:22:22,309 --> 00:22:28,428
disservice I have to choose a service

432
00:22:24,620 --> 00:22:36,860
which runs with a high privilege system

433
00:22:28,429 --> 00:22:39,590
administrator and so now okay this one

434
00:22:36,860 --> 00:22:42,709
as I mentioned before is a special

435
00:22:39,590 --> 00:22:45,139
special privilege normally a minstrel

436
00:22:42,710 --> 00:22:47,899
doesn't have this one you have to grant

437
00:22:45,139 --> 00:22:52,340
him this special privilege these

438
00:22:47,899 --> 00:22:55,340
privileges microsoft says act as not act

439
00:22:52,340 --> 00:22:57,080
as operating system what this mean okay

440
00:22:55,340 --> 00:23:00,379
but what does this mean exactly well

441
00:22:57,080 --> 00:23:02,720
with these privileges a user is ultra

442
00:23:00,380 --> 00:23:06,880
authorized to act as another user

443
00:23:02,720 --> 00:23:10,639
without specifying credential and to

444
00:23:06,880 --> 00:23:13,039
grant to this user other special

445
00:23:10,639 --> 00:23:15,918
privileges or group memberships so

446
00:23:13,039 --> 00:23:19,340
imagine if I have this privilege I can

447
00:23:15,919 --> 00:23:21,889
log on as another user or as myself and

448
00:23:19,340 --> 00:23:24,740
tell to this function Allah say Logan

449
00:23:21,889 --> 00:23:26,689
field user function using the as for you

450
00:23:24,740 --> 00:23:28,730
logon service tell to this function hey

451
00:23:26,690 --> 00:23:31,100
put me in the administrator group and

452
00:23:28,730 --> 00:23:34,490
grant me the debug privilege and this is

453
00:23:31,100 --> 00:23:37,719
possible because I have this special

454
00:23:34,490 --> 00:23:37,720
privilege okay

455
00:23:40,820 --> 00:23:47,689
so and a let's say logon few the user

456
00:23:44,360 --> 00:23:51,770
gives me back my precious token my am

457
00:23:47,690 --> 00:23:54,350
token my very powerful token but we have

458
00:23:51,770 --> 00:23:56,810
a problem because I have this code token

459
00:23:54,350 --> 00:23:59,389
so I would like to spawn a process or a

460
00:23:56,810 --> 00:24:01,310
thread using this token otherwise what

461
00:23:59,390 --> 00:24:03,080
should I do is this token we have a

462
00:24:01,310 --> 00:24:05,389
problem in order to impersonate the

463
00:24:03,080 --> 00:24:08,120
thread I have I need a special privilege

464
00:24:05,390 --> 00:24:11,330
which is the impersonal privilege but if

465
00:24:08,120 --> 00:24:13,159
I only have TCB privilege in theory I

466
00:24:11,330 --> 00:24:15,710
could not impersonate the thread so I

467
00:24:13,160 --> 00:24:19,850
have this token and I can do anything

468
00:24:15,710 --> 00:24:21,590
with it but there is good news that is

469
00:24:19,850 --> 00:24:25,850
these statements which say which says

470
00:24:21,590 --> 00:24:28,879
that impersonal privileges is not needed

471
00:24:25,850 --> 00:24:31,810
as long as the token is for you the user

472
00:24:28,880 --> 00:24:34,520
and the owner of the token is myself and

473
00:24:31,810 --> 00:24:37,310
the integrity level of the process at

474
00:24:34,520 --> 00:24:40,820
which I will or the thread I want to

475
00:24:37,310 --> 00:24:44,510
spawn is less or equal as my integrity

476
00:24:40,820 --> 00:24:48,889
level as the parent process okay this is

477
00:24:44,510 --> 00:24:59,150
what we need but Microsoft starting from

478
00:24:48,890 --> 00:25:04,910
Windows 10 added more constraints really

479
00:24:59,150 --> 00:25:10,670
really in this case I just need to

480
00:25:04,910 --> 00:25:15,530
respect the original constraint and as

481
00:25:10,670 --> 00:25:20,530
you can see I created a token for my

482
00:25:15,530 --> 00:25:24,440
user with the back with two powerful

483
00:25:20,530 --> 00:25:32,680
memberships which are the audio where

484
00:25:24,440 --> 00:25:34,430
are they the backup operators okay and

485
00:25:32,680 --> 00:25:39,200
what I did

486
00:25:34,430 --> 00:25:44,150
what is this possible because as long as

487
00:25:39,200 --> 00:25:47,600
the authentication ID of the originating

488
00:25:44,150 --> 00:25:50,930
of the writing token equals as for you

489
00:25:47,600 --> 00:25:54,110
token origin ID all other checks will be

490
00:25:50,930 --> 00:25:54,500
bypassed and when I create a token with

491
00:25:54,110 --> 00:25:57,199
the

492
00:25:54,500 --> 00:25:59,870
we privilege these two conditions always

493
00:25:57,200 --> 00:26:02,540
match so even if Microsoft adds other

494
00:25:59,870 --> 00:26:04,879
constraints what wins is this one and

495
00:26:02,540 --> 00:26:07,730
with the TCP privilege I can impersonate

496
00:26:04,880 --> 00:26:15,620
the thread without problems this is what

497
00:26:07,730 --> 00:26:17,840
I want it to say okay I will show you

498
00:26:15,620 --> 00:26:22,070
just some examples on how to abuse from

499
00:26:17,840 --> 00:26:24,550
these privileges in the first one we

500
00:26:22,070 --> 00:26:26,090
will use the Kerberos authentication

501
00:26:24,550 --> 00:26:29,300
domain okay

502
00:26:26,090 --> 00:26:31,520
and with this privilege I will

503
00:26:29,300 --> 00:26:33,980
impersonate domain admin in the other

504
00:26:31,520 --> 00:26:37,460
two I will use an TLM authentication

505
00:26:33,980 --> 00:26:40,220
okay and in the first one I will create

506
00:26:37,460 --> 00:26:42,590
a token for myself and add myself the

507
00:26:40,220 --> 00:26:44,720
debug privilege in the other example I

508
00:26:42,590 --> 00:26:47,840
will create a token for administrator

509
00:26:44,720 --> 00:26:53,030
and then act myself in local

510
00:26:47,840 --> 00:26:55,220
administrator group using G sharp and

511
00:26:53,030 --> 00:26:57,320
Kerberos authentication is very very

512
00:26:55,220 --> 00:27:00,050
easy as you can see only to write two

513
00:26:57,320 --> 00:27:02,840
lines of code and I'm able to write in a

514
00:27:00,050 --> 00:27:05,120
protected directory as the user which is

515
00:27:02,840 --> 00:27:08,810
not that mean but as the TCP privilege

516
00:27:05,120 --> 00:27:15,739
because I assume the identity of domain

517
00:27:08,810 --> 00:27:18,409
admin very very easy in the other one I

518
00:27:15,740 --> 00:27:20,960
can alter using until an authentication

519
00:27:18,410 --> 00:27:24,230
I can alter the username parameter

520
00:27:20,960 --> 00:27:27,860
myself or administrator put me in extra

521
00:27:24,230 --> 00:27:31,220
groups for example in an administrator

522
00:27:27,860 --> 00:27:38,379
group call my function my API call and

523
00:27:31,220 --> 00:27:43,820
the resulting token h4u token will have

524
00:27:38,380 --> 00:27:47,450
all the privileges to do what I wanted

525
00:27:43,820 --> 00:27:50,679
to for example in the left side adding

526
00:27:47,450 --> 00:27:54,980
me as a supplementary privilege or

527
00:27:50,680 --> 00:27:58,820
adding me directly to the local

528
00:27:54,980 --> 00:28:02,180
administrator group I have also a video

529
00:27:58,820 --> 00:28:04,419
about this because maybe I was not so

530
00:28:02,180 --> 00:28:04,420
clear

531
00:28:04,450 --> 00:28:09,890
but I would like to show you another

532
00:28:08,060 --> 00:28:11,270
with video because this is more a joke I

533
00:28:09,890 --> 00:28:15,380
made with my system in colleagues

534
00:28:11,270 --> 00:28:17,540
because we made the bet and I told them

535
00:28:15,380 --> 00:28:20,300
I logged on as a local administrator on

536
00:28:17,540 --> 00:28:23,180
a machine honest window server act as a

537
00:28:20,300 --> 00:28:26,210
guest account to impersonate a guest

538
00:28:23,180 --> 00:28:28,580
account and act as the domain admin they

539
00:28:26,210 --> 00:28:30,980
told me you are crazy so possible we

540
00:28:28,580 --> 00:28:34,040
make a bet of a good Italian bottle of

541
00:28:30,980 --> 00:28:38,900
wine and when I showed them that it was

542
00:28:34,040 --> 00:28:41,090
possible the day after I was drunk so

543
00:28:38,900 --> 00:28:43,700
the guest account is disabled I'm lock

544
00:28:41,090 --> 00:28:48,110
administrator now I learn lounge my

545
00:28:43,700 --> 00:28:52,880
magic program silly program ok and now I

546
00:28:48,110 --> 00:28:56,479
am guest but the cool thing is that if I

547
00:28:52,880 --> 00:28:59,120
make a where meislish groups I belong to

548
00:28:56,480 --> 00:29:01,880
the domain admin group is this true what

549
00:28:59,120 --> 00:29:04,820
is it just a joke because they didn't

550
00:29:01,880 --> 00:29:06,380
believe me ok I will read the file well

551
00:29:04,820 --> 00:29:09,250
unlock administrators have the

552
00:29:06,380 --> 00:29:09,250
possibility to read

553
00:29:17,510 --> 00:29:22,910
as you can see only administrator can

554
00:29:19,610 --> 00:29:25,129
access this file and if I can act as

555
00:29:22,910 --> 00:29:28,880
administrator I can see the contents of

556
00:29:25,130 --> 00:29:31,040
this file okay it was more a joke but

557
00:29:28,880 --> 00:29:35,500
just to show you what sort of nasty

558
00:29:31,040 --> 00:29:35,500
things you can do with this privilege

559
00:29:46,820 --> 00:29:51,860
alors we were here

560
00:29:56,990 --> 00:30:01,010
the create token privilege is also

561
00:29:59,090 --> 00:30:02,658
considered a God privilege because as

562
00:30:01,010 --> 00:30:04,730
the word says with if I have this

563
00:30:02,659 --> 00:30:08,059
privilege I can create a token I can

564
00:30:04,730 --> 00:30:10,549
create a token and I can a token like a

565
00:30:08,059 --> 00:30:12,950
wand with all the memberships the

566
00:30:10,549 --> 00:30:15,379
privileges I want to have this is very

567
00:30:12,950 --> 00:30:20,029
very pure useful and powerful as you can

568
00:30:15,380 --> 00:30:21,919
imagine but again here we have a problem

569
00:30:20,029 --> 00:30:24,470
because even if I create this token I

570
00:30:21,919 --> 00:30:31,820
cannot impersonate it because I don't

571
00:30:24,470 --> 00:30:35,090
have the rights to impersonate but as I

572
00:30:31,820 --> 00:30:37,158
told you before if the integrity level

573
00:30:35,090 --> 00:30:39,500
of the process is less or equal etcetera

574
00:30:37,159 --> 00:30:43,220
etcetera I can impersonate it but this

575
00:30:39,500 --> 00:30:47,200
is not more true because starting from

576
00:30:43,220 --> 00:30:50,510
Windows 1809 and Windows Server 2019

577
00:30:47,200 --> 00:30:55,059
extra controls when may were took made

578
00:30:50,510 --> 00:30:58,789
in place which blocks this possibility

579
00:30:55,059 --> 00:31:01,250
and as you can see I have this powerful

580
00:30:58,789 --> 00:31:04,340
token with membership of trusted

581
00:31:01,250 --> 00:31:07,340
installer ok so it's a very very

582
00:31:04,340 --> 00:31:09,500
powerful token but if I want if I try to

583
00:31:07,340 --> 00:31:13,730
for example write a file in system32

584
00:31:09,500 --> 00:31:16,340
directory I get an access denied exactly

585
00:31:13,730 --> 00:31:21,220
the impersonation level is invalid what

586
00:31:16,340 --> 00:31:21,220
does this mean that probably windows

587
00:31:22,059 --> 00:31:33,260
checks what you are wanting to do and if

588
00:31:26,950 --> 00:31:35,419
you are trying to impersonate a token

589
00:31:33,260 --> 00:31:37,669
even if you don't have impersonation

590
00:31:35,419 --> 00:31:40,580
privileges and this token is considered

591
00:31:37,669 --> 00:31:42,559
a go to a God token and is in this case

592
00:31:40,580 --> 00:31:45,770
yes because it has the membership of

593
00:31:42,559 --> 00:31:48,320
trusted installers it will demote token

594
00:31:45,770 --> 00:31:50,539
to an identification token with a very

595
00:31:48,320 --> 00:31:51,740
beautiful token but it's useless I can

596
00:31:50,539 --> 00:31:57,860
do anything with it

597
00:31:51,740 --> 00:32:01,669
so came over not exactly because if you

598
00:31:57,860 --> 00:32:04,668
do this third dirty trick you said the

599
00:32:01,669 --> 00:32:07,490
login ID to anonymous and not to system

600
00:32:04,669 --> 00:32:08,800
and with the create token API you can

601
00:32:07,490 --> 00:32:12,130
set the

602
00:32:08,800 --> 00:32:15,010
authentication ID of the token you said

603
00:32:12,130 --> 00:32:17,860
it no no miss Addie magically it works

604
00:32:15,010 --> 00:32:20,170
not all API call words but some worse

605
00:32:17,860 --> 00:32:22,780
and it's sufficient for us to make

606
00:32:20,170 --> 00:32:26,470
privilege escalation why this because

607
00:32:22,780 --> 00:32:29,770
probably the checks which when the

608
00:32:26,470 --> 00:32:32,170
windows made are too late if windows see

609
00:32:29,770 --> 00:32:34,059
that the token is anonymous probably

610
00:32:32,170 --> 00:32:34,780
thinks oh it's an annoyance token it's

611
00:32:34,059 --> 00:32:37,178
harmless

612
00:32:34,780 --> 00:32:40,928
let's go on no because this token has

613
00:32:37,179 --> 00:32:43,510
full as powerful memberships and so it's

614
00:32:40,929 --> 00:32:47,559
possible to it I noticed this to

615
00:32:43,510 --> 00:32:50,590
Microsoft and they say oh yeah that you

616
00:32:47,559 --> 00:32:52,240
are you are right that's true but we are

617
00:32:50,590 --> 00:32:53,020
not going to fix it in this equivalently

618
00:32:52,240 --> 00:33:10,059
it already is

619
00:32:53,020 --> 00:33:13,660
so enjoy ok this is the API call I can

620
00:33:10,059 --> 00:33:16,660
go on very shortly the load driver

621
00:33:13,660 --> 00:33:18,970
privilege load arrival is also a special

622
00:33:16,660 --> 00:33:22,000
privilege which is granted to load

623
00:33:18,970 --> 00:33:23,470
drivers and normally printed operators

624
00:33:22,000 --> 00:33:26,800
on the domain controller have this

625
00:33:23,470 --> 00:33:28,990
powerful privilege what can we do with

626
00:33:26,800 --> 00:33:31,389
this privilege load driver assigned

627
00:33:28,990 --> 00:33:34,540
driver obviously but to add some bugs

628
00:33:31,390 --> 00:33:39,460
and then exploit this bug in order to

629
00:33:34,540 --> 00:33:42,670
gain a system shell for example you have

630
00:33:39,460 --> 00:33:44,140
to trick the driver the Windows kernel

631
00:33:42,670 --> 00:33:47,410
to load the driver from a different

632
00:33:44,140 --> 00:33:50,380
location known from the system hive

633
00:33:47,410 --> 00:33:52,000
because as a printer operator even if I

634
00:33:50,380 --> 00:33:54,250
have the load driver privilege I cannot

635
00:33:52,000 --> 00:33:56,110
write in the system hive so I will

636
00:33:54,250 --> 00:33:59,020
create the configuration of this law of

637
00:33:56,110 --> 00:34:03,969
this device under mad my Accokeek

638
00:33:59,020 --> 00:34:06,610
current user hive and then told to the

639
00:34:03,970 --> 00:34:09,399
load driver API that he has to load it

640
00:34:06,610 --> 00:34:14,589
from my hive and this works and I am

641
00:34:09,399 --> 00:34:16,540
able to load the driver for example here

642
00:34:14,590 --> 00:34:19,000
I loaded successfully this driver this

643
00:34:16,540 --> 00:34:22,149
is a vulnerable driver of the stopzilla

644
00:34:19,000 --> 00:34:22,870
stopzilla is an anti-malware utility we

645
00:34:22,149 --> 00:34:26,859
Ted which

646
00:34:22,870 --> 00:34:28,389
the serious bug and using this bug and a

647
00:34:26,860 --> 00:34:32,340
modified version of the bow of the

648
00:34:28,389 --> 00:34:35,560
exploit I was able to load the driver

649
00:34:32,340 --> 00:34:39,280
grant me the create token privilege okay

650
00:34:35,560 --> 00:34:43,330
and then add myself to the administrator

651
00:34:39,280 --> 00:34:45,370
group just for example the last two one

652
00:34:43,330 --> 00:34:47,440
impersonation and assign primary

653
00:34:45,370 --> 00:34:49,750
privileges these are very very powerful

654
00:34:47,440 --> 00:34:51,790
because they are more easier to obtain

655
00:34:49,750 --> 00:34:53,409
because if you compromise the service

656
00:34:51,790 --> 00:34:55,779
account you have these privileges

657
00:34:53,409 --> 00:34:57,399
impersonate and assign primary what can

658
00:34:55,780 --> 00:35:00,550
you do with these privileges a lot of

659
00:34:57,400 --> 00:35:03,940
things you have to obtain a talk and a

660
00:35:00,550 --> 00:35:08,530
powerful token and then impersonate this

661
00:35:03,940 --> 00:35:11,860
token is that dangerous of impersonate

662
00:35:08,530 --> 00:35:16,420
and assign primary privileges how can we

663
00:35:11,860 --> 00:35:18,190
obtain this token for example forcing a

664
00:35:16,420 --> 00:35:21,250
privileged process to write into a nine

665
00:35:18,190 --> 00:35:23,500
pipe under my control impersonate name

666
00:35:21,250 --> 00:35:27,640
pipe and then have the token impersonate

667
00:35:23,500 --> 00:35:29,740
it and I am system for example or via a

668
00:35:27,640 --> 00:35:32,049
security context in a Nutella note

669
00:35:29,740 --> 00:35:34,569
integration we will see it later or via

670
00:35:32,050 --> 00:35:37,150
the command PC callbacks Co impersonate

671
00:35:34,570 --> 00:35:40,060
client rpcm personal client ok

672
00:35:37,150 --> 00:35:42,550
the killer exploit for this privilege

673
00:35:40,060 --> 00:35:44,440
assists rotten potato Explorer you know

674
00:35:42,550 --> 00:35:49,000
it everybody knows it never heard about

675
00:35:44,440 --> 00:35:52,510
it ok in short it's a little bit

676
00:35:49,000 --> 00:35:55,000
complicated if you in initializing a

677
00:35:52,510 --> 00:35:59,410
tecum object running and as an out of

678
00:35:55,000 --> 00:36:03,610
process server like bits for example if

679
00:35:59,410 --> 00:36:06,819
you needed this object via a stick a

680
00:36:03,610 --> 00:36:10,330
fake storage object and you can tell him

681
00:36:06,820 --> 00:36:12,610
that the old oxid resolving has to be

682
00:36:10,330 --> 00:36:16,029
done under an end point under your

683
00:36:12,610 --> 00:36:18,550
control so when the object has been

684
00:36:16,030 --> 00:36:21,310
initialized it will contact the oxytocin

685
00:36:18,550 --> 00:36:24,790
resolver which not it's not new normal

686
00:36:21,310 --> 00:36:27,759
running on port 135 but on a listener

687
00:36:24,790 --> 00:36:30,100
under my control intercept the local and

688
00:36:27,760 --> 00:36:33,640
@lm identification this whites called

689
00:36:30,100 --> 00:36:36,150
ntlm reflection alter it get the token

690
00:36:33,640 --> 00:36:38,069
in person at the token and

691
00:36:36,150 --> 00:36:43,230
out of process come service running a

692
00:36:38,069 --> 00:36:44,730
system you are system there are some

693
00:36:43,230 --> 00:36:47,309
variants because the original exploit

694
00:36:44,730 --> 00:36:49,380
worked only with metasploit or incognito

695
00:36:47,309 --> 00:36:51,029
me too I wrote two variants two

696
00:36:49,380 --> 00:36:55,049
standalone variants but we had a problem

697
00:36:51,029 --> 00:36:57,779
because it was fixed at the port 666 was

698
00:36:55,049 --> 00:37:01,319
fixed the object bits was fixed and so

699
00:36:57,779 --> 00:37:03,750
it had if and it happened if you disable

700
00:37:01,319 --> 00:37:06,359
the service or you firewall support this

701
00:37:03,750 --> 00:37:09,480
exploit wouldn't work so with my friend

702
00:37:06,359 --> 00:37:11,819
we try to weaponize this product this

703
00:37:09,480 --> 00:37:16,829
exploit and we produced what we call

704
00:37:11,819 --> 00:37:21,029
juicy potato juicy potato is allows you

705
00:37:16,829 --> 00:37:23,490
to configure everything so you can

706
00:37:21,029 --> 00:37:26,490
choose the clsid of the out of process

707
00:37:23,490 --> 00:37:27,299
come server you want to use the port

708
00:37:26,490 --> 00:37:30,149
listener

709
00:37:27,299 --> 00:37:32,009
there are pc port for example if you

710
00:37:30,150 --> 00:37:32,700
have a Windows machine under your

711
00:37:32,010 --> 00:37:34,799
control

712
00:37:32,700 --> 00:37:37,890
you can reflect the authentication on

713
00:37:34,799 --> 00:37:39,960
your PC server and in the even viewer

714
00:37:37,890 --> 00:37:42,839
you want nothing about authentication

715
00:37:39,960 --> 00:37:45,510
very very stealth and so on other

716
00:37:42,839 --> 00:37:47,670
interesting sleep reduce the list of

717
00:37:45,510 --> 00:37:49,799
very very interesting CLS IDs for each

718
00:37:47,670 --> 00:37:51,450
operating system some of them are very

719
00:37:49,799 --> 00:37:53,339
interesting because they impersonate the

720
00:37:51,450 --> 00:37:55,078
user logged on on the first session if

721
00:37:53,339 --> 00:37:58,920
domain yumminess logged on I can

722
00:37:55,079 --> 00:38:01,049
impersonate domain admin these are the

723
00:37:58,920 --> 00:38:04,740
settings an ideal service should have

724
00:38:01,049 --> 00:38:08,038
for exploiting it ok and this is our

725
00:38:04,740 --> 00:38:11,160
tool you can download it here and there

726
00:38:08,039 --> 00:38:15,230
is also a variant of Metasploit it has

727
00:38:11,160 --> 00:38:15,230
been ported also as a Metasploit module

728
00:38:16,460 --> 00:38:29,490
disease are there are some examples of

729
00:38:19,349 --> 00:38:30,809
CLS IDs ok video but I will skip it you

730
00:38:29,490 --> 00:38:35,000
believe it you trust in what I'm saying

731
00:38:30,809 --> 00:38:35,000
a video about exploiting this ok

732
00:38:38,530 --> 00:38:44,570
so how can we stop this

733
00:38:41,990 --> 00:38:47,569
I asked Microsoft more than one year ago

734
00:38:44,570 --> 00:38:49,340
and Microsoft has sponsored in the

735
00:38:47,570 --> 00:38:51,770
current implementation model we are not

736
00:38:49,340 --> 00:38:58,280
able to stop this this is very very bad

737
00:38:51,770 --> 00:39:00,050
ok so it it continues work can we do

738
00:38:58,280 --> 00:39:02,330
something not so much

739
00:39:00,050 --> 00:39:04,460
obviously protect sensitive accounts

740
00:39:02,330 --> 00:39:08,060
that is the best and disable unnecessary

741
00:39:04,460 --> 00:39:09,910
services but for the defense side there

742
00:39:08,060 --> 00:39:14,119
is good news but because finally

743
00:39:09,910 --> 00:39:14,899
Microsoft decided was able to fix it in

744
00:39:14,119 --> 00:39:18,710
version

745
00:39:14,900 --> 00:39:22,369
18:09 of Windows 10 and inverse and 2019

746
00:39:18,710 --> 00:39:26,290
of Windows Server so but if you have

747
00:39:22,369 --> 00:39:31,640
Windows 2016 server or Windows version

748
00:39:26,290 --> 00:39:34,759
meaner than 1809 this exploit works so

749
00:39:31,640 --> 00:39:36,890
if you have this privilege you are

750
00:39:34,760 --> 00:39:44,630
automatically system and that is very

751
00:39:36,890 --> 00:39:48,410
very bad final thought obviously never

752
00:39:44,630 --> 00:39:51,470
underestimate these privileges this is

753
00:39:48,410 --> 00:39:53,118
what I told you this patch works only on

754
00:39:51,470 --> 00:39:55,430
newer versions older version and there

755
00:39:53,119 --> 00:39:57,770
are plenty of Windows 2016 service it

756
00:39:55,430 --> 00:40:00,020
continues to work maybe there are other

757
00:39:57,770 --> 00:40:02,270
privileges not so well known we can

758
00:40:00,020 --> 00:40:04,430
abuse from and as a side note it has

759
00:40:02,270 --> 00:40:05,869
nothing to do with privileges I know

760
00:40:04,430 --> 00:40:08,868
don't know how many of you knew that

761
00:40:05,869 --> 00:40:11,600
that for more than one year that there

762
00:40:08,869 --> 00:40:13,880
was a service which was misconfigured

763
00:40:11,600 --> 00:40:16,759
trusting from certain Windows versions

764
00:40:13,880 --> 00:40:22,490
which grant full control to a service

765
00:40:16,760 --> 00:40:25,010
account so as you can see if you

766
00:40:22,490 --> 00:40:28,189
compromised a service account using the

767
00:40:25,010 --> 00:40:30,500
orchestrator service it was possible to

768
00:40:28,190 --> 00:40:33,500
gain system access and this lasted for

769
00:40:30,500 --> 00:40:36,650
more than one year we notified it with

770
00:40:33,500 --> 00:40:39,260
my team to Microsoft and finally in the

771
00:40:36,650 --> 00:40:45,260
September Patch Tuesday update they fix

772
00:40:39,260 --> 00:40:48,740
it ok ok that's all I hope you enjoyed

773
00:40:45,260 --> 00:40:50,770
my enjoyed my talk and sorry for not

774
00:40:48,740 --> 00:40:50,770
having

775
00:40:50,790 --> 00:41:00,810
but time was stealin okay any questions

776
00:40:55,830 --> 00:41:00,810
everything's clear what thank you again

