1
00:00:10,890 --> 00:00:15,490
thank you thank you hello everyone thank

2
00:00:14,139 --> 00:00:18,880
you for having me here good afternoon

3
00:00:15,490 --> 00:00:21,090
this is my third time speaking at the

4
00:00:18,880 --> 00:00:24,759
long con previously I talked about

5
00:00:21,090 --> 00:00:26,439
passwords and ntlm relaying so I'm going

6
00:00:24,760 --> 00:00:30,850
to talk about my other weird obsession

7
00:00:26,440 --> 00:00:32,410
which is evading antivirus for those who

8
00:00:30,850 --> 00:00:34,960
don't know me I am

9
00:00:32,409 --> 00:00:37,360
Travis freezer as my contact information

10
00:00:34,960 --> 00:00:39,250
and since my last time speaking I've

11
00:00:37,360 --> 00:00:41,140
added a little bit to my alphabet soup

12
00:00:39,250 --> 00:00:44,019
because as we all know he who dies with

13
00:00:41,140 --> 00:00:47,800
the most certifications wins so I'm well

14
00:00:44,019 --> 00:00:50,289
on my way to total victory I figure I'm

15
00:00:47,800 --> 00:00:53,498
actually here in two capacities first I

16
00:00:50,289 --> 00:00:56,980
am the chief IT security consultant for

17
00:00:53,499 --> 00:00:58,960
Merlin Merlin is the the chief internet

18
00:00:56,980 --> 00:01:01,209
and Internet services provider for

19
00:00:58,960 --> 00:01:03,850
education in Manitoba and in that rule I

20
00:01:01,210 --> 00:01:06,460
wear pretty much every single InfoSec

21
00:01:03,850 --> 00:01:08,290
hat imaginable I do forensics

22
00:01:06,460 --> 00:01:12,250
penetration testing incident response

23
00:01:08,290 --> 00:01:14,259
policy you name it but I'm also here as

24
00:01:12,250 --> 00:01:17,159
the co-founder of Flying Fortress IT

25
00:01:14,259 --> 00:01:20,320
it's a it's a small firm I founded with

26
00:01:17,159 --> 00:01:22,360
with my Kimbo where's my keys back

27
00:01:20,320 --> 00:01:24,548
there's that guy back there and together

28
00:01:22,360 --> 00:01:26,469
we try to offer a cloud and InfoSec

29
00:01:24,549 --> 00:01:28,840
expertise to small and medium-sized

30
00:01:26,469 --> 00:01:30,189
businesses generally you know the sort

31
00:01:28,840 --> 00:01:33,070
of organizations that could really

32
00:01:30,189 --> 00:01:34,600
benefit from having such a professional

33
00:01:33,070 --> 00:01:36,490
available but obviously can't justify

34
00:01:34,600 --> 00:01:38,469
having a full time professional on staff

35
00:01:36,490 --> 00:01:40,960
so if that sounds like you or somebody

36
00:01:38,469 --> 00:01:42,280
you know come give us give us a call and

37
00:01:40,960 --> 00:01:43,449
send us an email come talk to us and

38
00:01:42,280 --> 00:01:45,969
we'll see we can do to help you out

39
00:01:43,450 --> 00:01:52,299
speaking of mic I could use it a beer

40
00:01:45,969 --> 00:01:58,380
might give me give you a 1919 awesome so

41
00:01:52,299 --> 00:02:01,119
anyway no not for you

42
00:01:58,380 --> 00:02:03,609
now one more obligatory slide before I

43
00:02:01,119 --> 00:02:06,310
get into it and this this should go

44
00:02:03,609 --> 00:02:07,749
without saying but sadly it does not the

45
00:02:06,310 --> 00:02:09,550
things I'm going to talk about here are

46
00:02:07,749 --> 00:02:10,990
starting starting to veer a little bit

47
00:02:09,550 --> 00:02:12,610
into some of the dark arts right I'm

48
00:02:10,990 --> 00:02:15,060
gonna be talking about generating

49
00:02:12,610 --> 00:02:18,129
malware and bypassing antivirus and

50
00:02:15,060 --> 00:02:20,470
tries to say please please please use

51
00:02:18,129 --> 00:02:21,190
this knowledge for good not for evil

52
00:02:20,470 --> 00:02:23,140
and if you

53
00:02:21,190 --> 00:02:27,690
do use it for evil you you didn't yeah

54
00:02:23,140 --> 00:02:31,869
Packard that if you do use it for evil

55
00:02:27,690 --> 00:02:35,320
don't blame it on me okay now this may

56
00:02:31,870 --> 00:02:37,480
this may immediately raise the question

57
00:02:35,320 --> 00:02:39,700
if this can be used for evil is it

58
00:02:37,480 --> 00:02:43,119
ethical for me to be sharing this

59
00:02:39,700 --> 00:02:45,540
information and to that I say yes yes it

60
00:02:43,120 --> 00:02:47,740
is and it's not because I have no ethics

61
00:02:45,540 --> 00:02:49,480
it's because the sort of things I'm

62
00:02:47,740 --> 00:02:50,860
telling you are sadly not particularly

63
00:02:49,480 --> 00:02:52,720
revolutionary and it's everything I'm

64
00:02:50,860 --> 00:02:54,340
saying is stuff that the bad guys are

65
00:02:52,720 --> 00:02:55,780
already are already well aware of and

66
00:02:54,340 --> 00:02:57,520
are using and are using much more

67
00:02:55,780 --> 00:02:59,920
advanced techniques now the point of my

68
00:02:57,520 --> 00:03:01,150
talk is more about them as much as I

69
00:02:59,920 --> 00:03:03,070
hate the phrase it's about raising

70
00:03:01,150 --> 00:03:06,670
awareness of the limitations of

71
00:03:03,070 --> 00:03:11,079
antivirus and in relying on it as part

72
00:03:06,670 --> 00:03:11,559
of your network defense okay onto the

73
00:03:11,080 --> 00:03:13,300
meat

74
00:03:11,560 --> 00:03:15,670
I'll just over the background on the

75
00:03:13,300 --> 00:03:16,200
various antivirus techniques and how it

76
00:03:15,670 --> 00:03:19,570
works

77
00:03:16,200 --> 00:03:21,429
so antivirus Jim Willie uses two kind of

78
00:03:19,570 --> 00:03:23,859
categories of techniques uses kind of

79
00:03:21,430 --> 00:03:25,840
more static analysis and dynamic

80
00:03:23,860 --> 00:03:28,060
analysis so starting with the more

81
00:03:25,840 --> 00:03:30,520
static analysis the more the most basic

82
00:03:28,060 --> 00:03:33,100
way of detecting viruses involves

83
00:03:30,520 --> 00:03:35,290
signature based detection now this can

84
00:03:33,100 --> 00:03:37,799
be as simple as simply identifying a

85
00:03:35,290 --> 00:03:40,030
malicious piece of the malware and

86
00:03:37,800 --> 00:03:42,550
generating a signature for it like like

87
00:03:40,030 --> 00:03:44,500
taking the md5 sum of the entire entire

88
00:03:42,550 --> 00:03:46,120
file sharing that amongst all your

89
00:03:44,500 --> 00:03:48,700
endpoints and if you see that particular

90
00:03:46,120 --> 00:03:50,560
file hash you know it's malware flag it

91
00:03:48,700 --> 00:03:52,390
block it won't allow it you know

92
00:03:50,560 --> 00:03:54,220
obviously that's very easy to bypass you

93
00:03:52,390 --> 00:03:55,899
know just tack some no bytes on the end

94
00:03:54,220 --> 00:03:57,910
or or change the byte in the file and

95
00:03:55,900 --> 00:03:59,320
you have a brand new hash but the

96
00:03:57,910 --> 00:04:01,390
reality is this is still a very

97
00:03:59,320 --> 00:04:03,880
effective way of detecting viruses and

98
00:04:01,390 --> 00:04:05,859
probably you know more than 90% well

99
00:04:03,880 --> 00:04:15,250
thank you that didn't take forever but

100
00:04:05,860 --> 00:04:17,410
don't know what service anyway yeah so

101
00:04:15,250 --> 00:04:19,298
we the most basic is yeah just hashing

102
00:04:17,410 --> 00:04:21,130
an entire file but you can also generate

103
00:04:19,298 --> 00:04:22,599
signatures and thumb prints for

104
00:04:21,130 --> 00:04:24,850
individual parts of the file the various

105
00:04:22,600 --> 00:04:26,980
sections or strings or even individual

106
00:04:24,850 --> 00:04:29,169
functions and coal blocks in the file

107
00:04:26,980 --> 00:04:33,310
can be fingerprinted and signatures can

108
00:04:29,169 --> 00:04:34,510
be generated for that starting to get a

109
00:04:33,310 --> 00:04:37,120
little bit more dynamic code we start

110
00:04:34,510 --> 00:04:39,010
looking at various heuristics so in this

111
00:04:37,120 --> 00:04:40,900
case what we're doing is we're analyzing

112
00:04:39,010 --> 00:04:42,880
the file and determining how much weird

113
00:04:40,900 --> 00:04:44,770
 is in it and if there's enough

114
00:04:42,880 --> 00:04:47,050
weird is in it the past a certain

115
00:04:44,770 --> 00:04:49,810
threshold we flag the file and say hey

116
00:04:47,050 --> 00:04:51,760
this is probably malicious now it can be

117
00:04:49,810 --> 00:04:53,620
things like if you see a lot of knobs in

118
00:04:51,760 --> 00:04:55,750
a file a lot of weird strings uncommon

119
00:04:53,620 --> 00:04:58,660
library calls or even if it looks like

120
00:04:55,750 --> 00:05:00,460
the binary was generated by an uncommon

121
00:04:58,660 --> 00:05:01,750
or a rare compiler supposed to you know

122
00:05:00,460 --> 00:05:04,210
something like other than Visual Studio

123
00:05:01,750 --> 00:05:06,100
for example that could mean the file is

124
00:05:04,210 --> 00:05:07,630
itself somewhat suspicious now obviously

125
00:05:06,100 --> 00:05:09,430
tuning these scores could be very

126
00:05:07,630 --> 00:05:11,650
challenging but I'll put that threshold

127
00:05:09,430 --> 00:05:13,360
too high and you start missing malware

128
00:05:11,650 --> 00:05:14,950
put it's too low and you start

129
00:05:13,360 --> 00:05:17,110
generating a lot of false positives

130
00:05:14,950 --> 00:05:20,039
which are almost as bad as letting bad

131
00:05:17,110 --> 00:05:22,510
stuff through in the first place right

132
00:05:20,039 --> 00:05:24,130
next to in the word the more dynamic

133
00:05:22,510 --> 00:05:26,050
sort of thing we can start doing

134
00:05:24,130 --> 00:05:28,180
behavioral analysis on the malware this

135
00:05:26,050 --> 00:05:30,700
is basically asking what does the

136
00:05:28,180 --> 00:05:32,620
program do when it's being run what what

137
00:05:30,700 --> 00:05:34,180
kind of weird stuff is going on so if

138
00:05:32,620 --> 00:05:36,760
you see suspicious activity like a lot

139
00:05:34,180 --> 00:05:37,240
of weird DNS queries or other network

140
00:05:36,760 --> 00:05:39,669
traffic

141
00:05:37,240 --> 00:05:42,099
certain library calls if it starts

142
00:05:39,669 --> 00:05:44,140
reading and writing to files in you know

143
00:05:42,099 --> 00:05:45,070
census locations like sequel and Windows

144
00:05:44,140 --> 00:05:46,810
I mean that's weird

145
00:05:45,070 --> 00:05:49,060
flying that stuff it's and something

146
00:05:46,810 --> 00:05:51,370
something weird is happening or or even

147
00:05:49,060 --> 00:05:53,800
things like if it starts modifying its

148
00:05:51,370 --> 00:05:55,930
own its own executable code the old

149
00:05:53,800 --> 00:05:57,340
instructions that's where it's

150
00:05:55,930 --> 00:05:58,780
monitoring keystrokes it's pretty much

151
00:05:57,340 --> 00:06:00,760
guaranteed that if your program is

152
00:05:58,780 --> 00:06:03,489
monitoring your keystrokes it's probably

153
00:06:00,760 --> 00:06:05,050
malware and should be stopped now one of

154
00:06:03,490 --> 00:06:06,940
the downsides of course to behavioral

155
00:06:05,050 --> 00:06:09,220
analysis is that it requires that the

156
00:06:06,940 --> 00:06:10,599
malware be run before you can do any of

157
00:06:09,220 --> 00:06:12,729
this analysis right so at that point

158
00:06:10,599 --> 00:06:14,440
your computer's already infected it's

159
00:06:12,729 --> 00:06:16,719
kind of too little too late in some

160
00:06:14,440 --> 00:06:20,919
regards and that's where the next kind

161
00:06:16,720 --> 00:06:22,300
of technique sandboxing comes in and and

162
00:06:20,919 --> 00:06:23,500
this is kind of doing the behavioral

163
00:06:22,300 --> 00:06:26,770
analysis in kind of a

164
00:06:23,500 --> 00:06:29,290
trolled environment before the binaries

165
00:06:26,770 --> 00:06:30,969
actually run on the host and this can be

166
00:06:29,290 --> 00:06:33,100
done sometimes locally on the host or

167
00:06:30,970 --> 00:06:37,780
the big you know hotness right now is of

168
00:06:33,100 --> 00:06:39,280
course running it in the cloud okay so

169
00:06:37,780 --> 00:06:41,979
enough about that on to some of the

170
00:06:39,280 --> 00:06:43,960
tools for generating malware and

171
00:06:41,980 --> 00:06:44,830
bypassing antivirus so basically I'm

172
00:06:43,960 --> 00:06:46,989
just going to talk about some of the

173
00:06:44,830 --> 00:06:48,310
popular tools I demonstrate how to use

174
00:06:46,990 --> 00:06:50,710
them how to actually generate this

175
00:06:48,310 --> 00:06:52,330
malware and then I'm going to tell the

176
00:06:50,710 --> 00:06:53,289
samples that I generate and upload them

177
00:06:52,330 --> 00:06:55,030
to virustotal

178
00:06:53,290 --> 00:06:58,000
to see how they do it by passing

179
00:06:55,030 --> 00:07:00,400
antivirus now virustotal a big asterisk

180
00:06:58,000 --> 00:07:02,800
here virustotal not particularly a

181
00:07:00,400 --> 00:07:04,630
real-world application so just because

182
00:07:02,800 --> 00:07:06,040
i'm getting past something on virustotal

183
00:07:04,630 --> 00:07:08,169
or not getting past the thing i

184
00:07:06,040 --> 00:07:09,100
virustotal doesn't necessarily mean

185
00:07:08,169 --> 00:07:11,409
that's what's going to happen in the

186
00:07:09,100 --> 00:07:12,940
real world but it is convenient and I

187
00:07:11,410 --> 00:07:14,470
don't have a lot of you know time or

188
00:07:12,940 --> 00:07:16,600
energy to do all that so I'm just

189
00:07:14,470 --> 00:07:18,940
going to use virustotal and with one

190
00:07:16,600 --> 00:07:20,800
more caveat if you are you know trying

191
00:07:18,940 --> 00:07:22,360
to create your own malware and bypass

192
00:07:20,800 --> 00:07:24,610
antivirus cuz you know you're on the red

193
00:07:22,360 --> 00:07:26,230
team engagement or or whatever don't do

194
00:07:24,610 --> 00:07:28,330
that don't upload it to virustotal

195
00:07:26,230 --> 00:07:30,390
virustotal is notorious for sharing

196
00:07:28,330 --> 00:07:33,250
signatures amongst the different vendors

197
00:07:30,390 --> 00:07:35,500
and you know what you woods by passing

198
00:07:33,250 --> 00:07:37,479
antivirus today i'll blow dis virus toad

199
00:07:35,500 --> 00:07:40,930
well tomorrow now it's being caught so

200
00:07:37,479 --> 00:07:43,930
so don't do that anyway onto the tools

201
00:07:40,930 --> 00:07:46,270
also to start with MSM venom MSM venom

202
00:07:43,930 --> 00:07:48,070
is the payload and malware generator

203
00:07:46,270 --> 00:07:50,169
that comes packaged with the Metasploit

204
00:07:48,070 --> 00:07:51,450
framework now a Matthew in the last

205
00:07:50,169 --> 00:07:53,640
presentation talked a bit about

206
00:07:51,450 --> 00:07:56,140
Metasploit and some of its limitations

207
00:07:53,640 --> 00:07:58,300
it's not as sophisticated as some of the

208
00:07:56,140 --> 00:07:59,890
commercial Suites out there but it has

209
00:07:58,300 --> 00:08:02,530
the advantage of being open source and

210
00:07:59,890 --> 00:08:07,479
therefore free and I am a cheap-ass so I

211
00:08:02,530 --> 00:08:09,640
like it anyway here's the basic usage it

212
00:08:07,479 --> 00:08:12,460
is a command line tool so you're running

213
00:08:09,640 --> 00:08:13,810
a MSF denim and then I specify list

214
00:08:12,460 --> 00:08:16,989
payloads right and this gives me a list

215
00:08:13,810 --> 00:08:18,910
of all of the payloads that MSF enim can

216
00:08:16,990 --> 00:08:21,460
generate there's something like I think

217
00:08:18,910 --> 00:08:24,130
there's 350 different payloads some of

218
00:08:21,460 --> 00:08:24,849
the more interesting than others but I'm

219
00:08:24,130 --> 00:08:28,409
not going to go through each and every

220
00:08:24,850 --> 00:08:30,790
one of them so once you sorry

221
00:08:28,410 --> 00:08:32,979
MSF venom also supports a number of

222
00:08:30,790 --> 00:08:35,500
output formats these are the actual

223
00:08:32,979 --> 00:08:36,700
binaries that it generates when you use

224
00:08:35,500 --> 00:08:37,240
the tool and you can see them by

225
00:08:36,700 --> 00:08:39,099
specified

226
00:08:37,240 --> 00:08:41,560
your list formats here so you can see

227
00:08:39,099 --> 00:08:44,800
various binaries you can do dll's a

228
00:08:41,559 --> 00:08:48,880
laughs exe is of course another binary

229
00:08:44,800 --> 00:08:52,810
formats it also has something called

230
00:08:48,880 --> 00:08:55,089
transform formats so in this in this

231
00:08:52,810 --> 00:08:57,670
mode when run it doesn't generate a

232
00:08:55,089 --> 00:08:58,990
binary instead it outputs the payload in

233
00:08:57,670 --> 00:09:01,599
a format that you can then integrate

234
00:08:58,990 --> 00:09:03,370
into say a C program or C sharp or bash

235
00:09:01,600 --> 00:09:05,830
where you can either do you know

236
00:09:03,370 --> 00:09:08,529
additional transformations on or you can

237
00:09:05,830 --> 00:09:12,390
incorporate it into you know a larger

238
00:09:08,529 --> 00:09:15,610
exploit or malware suite if you want

239
00:09:12,390 --> 00:09:17,560
okay so once you've selected the payload

240
00:09:15,610 --> 00:09:19,839
and here I've selected just literally

241
00:09:17,560 --> 00:09:22,719
the most basic payload you can possibly

242
00:09:19,839 --> 00:09:24,370
imagine uh reverse a TCP shell of for

243
00:09:22,720 --> 00:09:26,589
Windows right it connects back to the

244
00:09:24,370 --> 00:09:28,209
attacking computer I get a command shell

245
00:09:26,589 --> 00:09:31,060
I can run basically you know cmd.exe

246
00:09:28,209 --> 00:09:33,399
sort of sort of stuff and then just see

247
00:09:31,060 --> 00:09:35,890
what options it supports as I tossed the

248
00:09:33,399 --> 00:09:37,830
list options on the end there and this

249
00:09:35,890 --> 00:09:39,790
tells me the options I have available

250
00:09:37,830 --> 00:09:41,620
exit func you don't need to usually

251
00:09:39,790 --> 00:09:44,260
worry about that too much but I have to

252
00:09:41,620 --> 00:09:45,970
specify the local host the the IP

253
00:09:44,260 --> 00:09:49,800
address that I'm connecting back to you

254
00:09:45,970 --> 00:09:49,800
as well as the port that I want to use

255
00:09:49,860 --> 00:09:54,579
so here I've actually this one's a

256
00:09:51,940 --> 00:09:56,709
little bit small I apologize here I've

257
00:09:54,579 --> 00:09:59,949
actually run the command so MSF venom -

258
00:09:56,709 --> 00:10:02,649
key there's my payload the the host I'm

259
00:09:59,950 --> 00:10:03,910
just going to use 1.1.1 for example

260
00:10:02,649 --> 00:10:07,779
purposes that I'm connecting back to

261
00:10:03,910 --> 00:10:10,810
port 9999 for the port to use and then I

262
00:10:07,779 --> 00:10:13,870
specify - F the format is an exe file

263
00:10:10,810 --> 00:10:15,699
and then noteworthy here is that MSF

264
00:10:13,870 --> 00:10:17,320
venom creates its output to the

265
00:10:15,700 --> 00:10:18,670
standardout so if you actually want to

266
00:10:17,320 --> 00:10:21,130
capture the file and not screw up your

267
00:10:18,670 --> 00:10:23,079
terminal I need to I need to pass it

268
00:10:21,130 --> 00:10:26,470
into an actual file at the end there

269
00:10:23,079 --> 00:10:29,709
I've just called a payload Exe so how do

270
00:10:26,470 --> 00:10:32,589
we do well not so great this very very

271
00:10:29,709 --> 00:10:35,890
basic payload was caught by 53 out of 68

272
00:10:32,589 --> 00:10:38,470
different AV suites that virustotal

273
00:10:35,890 --> 00:10:40,149
uses so from the you know red teamers

274
00:10:38,470 --> 00:10:41,560
perspective you know that's not very

275
00:10:40,149 --> 00:10:43,750
good we're not getting past very many

276
00:10:41,560 --> 00:10:45,609
but at the same time when you think of

277
00:10:43,750 --> 00:10:48,160
this from a blue team is perspective we

278
00:10:45,610 --> 00:10:51,000
are using literally the most basic

279
00:10:48,160 --> 00:10:53,280
payload that msi venom can generate and

280
00:10:51,000 --> 00:10:56,130
fifteen antivirus Suites didn't actually

281
00:10:53,280 --> 00:10:58,650
detect that yeah so let's see were there

282
00:10:56,130 --> 00:11:00,360
any notable ones in there a few I don't

283
00:10:58,650 --> 00:11:01,980
know if anybody uses malwarebytes just

284
00:11:00,360 --> 00:11:04,320
may have heard of it but it did not

285
00:11:01,980 --> 00:11:06,930
detect our payload there's a few caveats

286
00:11:04,320 --> 00:11:08,160
here I've asked mobile for instance

287
00:11:06,930 --> 00:11:10,140
you've probably heard of avast

288
00:11:08,160 --> 00:11:12,780
but their mobile antivirus is probably

289
00:11:10,140 --> 00:11:14,580
tuned for looking at like AP AP KS and

290
00:11:12,780 --> 00:11:16,470
that sort of thing so you just have to

291
00:11:14,580 --> 00:11:17,790
understand some of the context here same

292
00:11:16,470 --> 00:11:19,440
with the Symantec mobile insight it

293
00:11:17,790 --> 00:11:20,579
didn't even analyze the file right

294
00:11:19,440 --> 00:11:22,020
because it's looking for mobile

295
00:11:20,580 --> 00:11:26,400
applications as opposed to Windows

296
00:11:22,020 --> 00:11:27,740
executables okay so MSF venom also has

297
00:11:26,400 --> 00:11:31,650
the ability to use what are called

298
00:11:27,740 --> 00:11:33,810
encoders now encoders are not really

299
00:11:31,650 --> 00:11:36,060
intended to be used for antivirus

300
00:11:33,810 --> 00:11:37,890
evasions they're more about you know if

301
00:11:36,060 --> 00:11:39,390
if you want to create an exploit and you

302
00:11:37,890 --> 00:11:41,730
can't use any null bytes or new lines

303
00:11:39,390 --> 00:11:44,910
for whatever reason the encoders that

304
00:11:41,730 --> 00:11:46,620
you help you kind of get around that by

305
00:11:44,910 --> 00:11:48,420
substituting by it's using you know xor

306
00:11:46,620 --> 00:11:49,440
encoding and that sort of thing so here

307
00:11:48,420 --> 00:11:51,870
are some of the encoders that it

308
00:11:49,440 --> 00:11:53,460
supports you know that's blocks or

309
00:11:51,870 --> 00:11:55,230
countdown all sorts of interesting stuff

310
00:11:53,460 --> 00:11:57,450
I would draw your attention to the

311
00:11:55,230 --> 00:11:59,430
Cadogan I write it at the bottom there

312
00:11:57,450 --> 00:12:01,110
that's a very popular one it has an

313
00:11:59,430 --> 00:12:03,479
excellent rating for a very good reason

314
00:12:01,110 --> 00:12:05,460
it is quite effective

315
00:12:03,480 --> 00:12:07,440
I think it's Stan I think it's Japanese

316
00:12:05,460 --> 00:12:08,610
for something like like I don't care or

317
00:12:07,440 --> 00:12:12,720
it doesn't matter or something like that

318
00:12:08,610 --> 00:12:15,000
it's your name but anyway let's go ahead

319
00:12:12,720 --> 00:12:17,790
and use it same sort of format MSF venom

320
00:12:15,000 --> 00:12:19,650
is my payload I'll host l port Exe but

321
00:12:17,790 --> 00:12:21,300
then I'm specified with a dash e option

322
00:12:19,650 --> 00:12:23,550
that I'm going to use the Chicago gain I

323
00:12:21,300 --> 00:12:27,569
encoder and then again dump my payload

324
00:12:23,550 --> 00:12:28,260
to a file so how does that do well not a

325
00:12:27,570 --> 00:12:31,110
whole lot better

326
00:12:28,260 --> 00:12:33,180
we've gone from 53 to 52 we're making

327
00:12:31,110 --> 00:12:34,860
progress but it's pretty slow so who

328
00:12:33,180 --> 00:12:37,620
else did we catch if we've got an

329
00:12:34,860 --> 00:12:39,089
additional bypass EGH ambit I know if

330
00:12:37,620 --> 00:12:41,490
anybody's heard of Egan but I sure

331
00:12:39,089 --> 00:12:44,490
haven't so I'm not consider that

332
00:12:41,490 --> 00:12:46,500
substantial process progress I'm so in

333
00:12:44,490 --> 00:12:49,050
addition to this MSF venom you can

334
00:12:46,500 --> 00:12:50,880
choose a bunch of different encoders and

335
00:12:49,050 --> 00:12:53,430
actually chain them together do multiple

336
00:12:50,880 --> 00:12:56,130
iterations but in general encoders while

337
00:12:53,430 --> 00:12:59,370
they were once effective at getting past

338
00:12:56,130 --> 00:13:01,530
antivirus they're less effective today

339
00:12:59,370 --> 00:13:02,670
the antivirus suites are kind of onto it

340
00:13:01,530 --> 00:13:04,260
and they're not really intended for

341
00:13:02,670 --> 00:13:04,800
getting past antivirus right they're

342
00:13:04,260 --> 00:13:06,959
about

343
00:13:04,800 --> 00:13:08,459
you know changing your payload up so to

344
00:13:06,959 --> 00:13:08,849
avoid certain bites and that sort of

345
00:13:08,459 --> 00:13:10,349
thing

346
00:13:08,850 --> 00:13:13,740
so it's not really an effective method

347
00:13:10,350 --> 00:13:14,810
anymore unfortunately okay on to the

348
00:13:13,740 --> 00:13:17,850
next tool I'm going to talk about

349
00:13:14,810 --> 00:13:21,329
packers for in specifically I'm going to

350
00:13:17,850 --> 00:13:24,690
talk about upx so Packers are a utility

351
00:13:21,329 --> 00:13:26,910
that you use to to take an existing

352
00:13:24,690 --> 00:13:28,709
executable and try to get it down to a

353
00:13:26,910 --> 00:13:30,779
small size as possible it does this by

354
00:13:28,709 --> 00:13:33,359
stripping out as much metadata it

355
00:13:30,779 --> 00:13:34,769
compresses it as necessary and

356
00:13:33,360 --> 00:13:36,300
what-have-you and the goal is to get a

357
00:13:34,769 --> 00:13:38,190
small executable like if you're if

358
00:13:36,300 --> 00:13:39,930
you're serving up an executable on your

359
00:13:38,190 --> 00:13:41,310
website you want to minimize the amount

360
00:13:39,930 --> 00:13:42,810
of bandwidth used or maybe you want to

361
00:13:41,310 --> 00:13:44,939
fit your executable and like a you know

362
00:13:42,810 --> 00:13:47,670
three and a half inch floppy disk right

363
00:13:44,940 --> 00:13:50,820
it's why you do that but you px can help

364
00:13:47,670 --> 00:13:52,740
you if you need to do that now because

365
00:13:50,820 --> 00:13:54,540
but during this process of stripping out

366
00:13:52,740 --> 00:13:56,540
the metadata and compressing down the

367
00:13:54,540 --> 00:13:59,939
file it has the side effect of

368
00:13:56,540 --> 00:14:02,579
obfuscating the actual payload that's in

369
00:13:59,940 --> 00:14:04,620
the executable so how do we use it it's

370
00:14:02,579 --> 00:14:06,660
pretty straightforward you px - oh

371
00:14:04,620 --> 00:14:08,850
there's my payload output name payload

372
00:14:06,660 --> 00:14:12,149
input name packed it no problem

373
00:14:08,850 --> 00:14:15,390
how does it do Oh better we're down to

374
00:14:12,149 --> 00:14:17,370
we're down to uh 46 right that's we're

375
00:14:15,390 --> 00:14:19,709
making progress here it's uh I think

376
00:14:17,370 --> 00:14:22,490
that's better than it was last time so

377
00:14:19,709 --> 00:14:25,649
well did we get past now any big names

378
00:14:22,490 --> 00:14:26,910
no big names stuff that I haven't heard

379
00:14:25,649 --> 00:14:29,640
of before where there's there's max

380
00:14:26,910 --> 00:14:32,850
secure or secure age or or my personal

381
00:14:29,640 --> 00:14:35,279
favorite superantispyware has now been

382
00:14:32,850 --> 00:14:36,690
bypassed so I so if you're using super

383
00:14:35,279 --> 00:14:39,890
antivirus that you need an additional

384
00:14:36,690 --> 00:14:42,329
reason to not use it there you go

385
00:14:39,890 --> 00:14:44,160
but anyway it was the end X that came

386
00:14:42,329 --> 00:14:48,300
who started talking with Yandex earlier

387
00:14:44,160 --> 00:14:49,949
that's ones on there okay so that's GPX

388
00:14:48,300 --> 00:14:50,939
let's go back to MSF venom and it

389
00:14:49,949 --> 00:14:53,550
specifically I want to talk about

390
00:14:50,940 --> 00:14:55,500
templates so when you're generating an

391
00:14:53,550 --> 00:14:57,719
executable file with MSF Denham

392
00:14:55,500 --> 00:14:59,730
it has a built in default template of

393
00:14:57,720 --> 00:15:01,589
what an executable file should look like

394
00:14:59,730 --> 00:15:03,480
all the you know header information and

395
00:15:01,589 --> 00:15:05,010
better day than all that that it

396
00:15:03,480 --> 00:15:07,500
uses now because this is the default

397
00:15:05,010 --> 00:15:09,569
template that ships with MSF Denham most

398
00:15:07,500 --> 00:15:11,430
antivirus vendors have become fairly

399
00:15:09,570 --> 00:15:14,040
well tuned to that they know where to

400
00:15:11,430 --> 00:15:15,899
watch for it and it's less effective if

401
00:15:14,040 --> 00:15:17,699
you're using the default template so if

402
00:15:15,899 --> 00:15:18,270
you specify your own template of what

403
00:15:17,699 --> 00:15:20,189
next

404
00:15:18,270 --> 00:15:23,850
we'll look like you can often improve

405
00:15:20,190 --> 00:15:25,770
your bypass rate that's what I've done

406
00:15:23,850 --> 00:15:27,360
here same-same jazz at first you know

407
00:15:25,770 --> 00:15:29,279
miss fnm there's my payload I'll host

408
00:15:27,360 --> 00:15:32,339
teleport and all that jazz but now I've

409
00:15:29,279 --> 00:15:34,350
specified - acts for a template oh it's

410
00:15:32,339 --> 00:15:38,610
an ax and I've grabbed a vanilla version

411
00:15:34,350 --> 00:15:41,040
of putty Exe from the internet and we're

412
00:15:38,610 --> 00:15:44,700
telling it to use that as the template

413
00:15:41,040 --> 00:15:47,490
for my for my payload I've also added

414
00:15:44,700 --> 00:15:50,550
another option there a - K that stands

415
00:15:47,490 --> 00:15:52,890
for keep the original functionality of

416
00:15:50,550 --> 00:15:55,020
the template so this is a really useful

417
00:15:52,890 --> 00:15:57,390
feature for OPSEC because what it's

418
00:15:55,020 --> 00:15:59,760
doing is that in a means the resulting

419
00:15:57,390 --> 00:16:02,760
payload payload v dot exe will still

420
00:15:59,760 --> 00:16:05,010
behave exactly like it's still putty but

421
00:16:02,760 --> 00:16:06,930
it will include my my malicious code I

422
00:16:05,010 --> 00:16:09,149
was essentially backdoored this

423
00:16:06,930 --> 00:16:12,209
particular executable and this like I

424
00:16:09,149 --> 00:16:14,459
said is really useful for OPSEC you know

425
00:16:12,209 --> 00:16:15,479
if somebody clicks on putty Exe and

426
00:16:14,459 --> 00:16:17,099
nothing happens

427
00:16:15,480 --> 00:16:19,170
party doesn't come up that's a bit of a

428
00:16:17,100 --> 00:16:20,760
red flag right and and sometimes the

429
00:16:19,170 --> 00:16:22,949
most effective form of antivirus out

430
00:16:20,760 --> 00:16:24,750
there are the users themselves you know

431
00:16:22,950 --> 00:16:26,279
sometimes the least effective form of

432
00:16:24,750 --> 00:16:27,540
antivirus is also used for themselves

433
00:16:26,279 --> 00:16:30,450
but if you're dealing with a

434
00:16:27,540 --> 00:16:31,740
particularly a technical target this can

435
00:16:30,450 --> 00:16:34,640
go a long way to helping you at least

436
00:16:31,740 --> 00:16:37,620
get past that level of human interaction

437
00:16:34,640 --> 00:16:38,579
so anyway how does it do when we do that

438
00:16:37,620 --> 00:16:41,310
actually that's a pretty substantial

439
00:16:38,579 --> 00:16:43,649
improvement we're down to 41 out of 67

440
00:16:41,310 --> 00:16:45,869
are there any big names in there let's

441
00:16:43,649 --> 00:16:47,730
see yeah we're starting to land some big

442
00:16:45,870 --> 00:16:50,010
fish we got we got McAfee who has

443
00:16:47,730 --> 00:16:52,920
probably heard of McAfee and Trend Micro

444
00:16:50,010 --> 00:16:56,370
are now being successfully evaded using

445
00:16:52,920 --> 00:16:59,550
the technique of using a different

446
00:16:56,370 --> 00:17:01,440
template now remember you px that we can

447
00:16:59,550 --> 00:17:04,230
often use you px to to kind of chain

448
00:17:01,440 --> 00:17:06,360
techniques and and improve our bypass

449
00:17:04,230 --> 00:17:09,240
rate but unfortunately when I try to use

450
00:17:06,359 --> 00:17:11,188
you px with this new payload payload 5my

451
00:17:09,240 --> 00:17:12,599
I get an error it can't can't pack it so

452
00:17:11,189 --> 00:17:14,429
there's a bit of a limitation sometimes

453
00:17:12,599 --> 00:17:15,839
with these tools they don't always work

454
00:17:14,429 --> 00:17:19,740
nicely together it's nice when they do

455
00:17:15,839 --> 00:17:22,020
but you can't always rely on that so

456
00:17:19,740 --> 00:17:23,809
anyway on to the next tool the next one

457
00:17:22,020 --> 00:17:31,679
we talk about is called a veil evasion

458
00:17:23,809 --> 00:17:33,809
mmm-hmm pardon me there we go

459
00:17:31,679 --> 00:17:36,840
so validation there's another popular

460
00:17:33,809 --> 00:17:38,789
open-source tool it was used to be a

461
00:17:36,840 --> 00:17:40,559
real big name and antivirus evasion a

462
00:17:38,789 --> 00:17:42,230
couple of years ago the author was

463
00:17:40,559 --> 00:17:44,309
regularly putting out new updates

464
00:17:42,230 --> 00:17:45,720
usually about once a month and every

465
00:17:44,309 --> 00:17:47,280
month they'd be these new evasion

466
00:17:45,720 --> 00:17:48,660
techniques and the antivirus vendors

467
00:17:47,280 --> 00:17:50,370
would have to scramble just come up with

468
00:17:48,660 --> 00:17:52,770
ways of detecting these new these new

469
00:17:50,370 --> 00:17:54,149
evasion techniques now unfortunately I

470
00:17:52,770 --> 00:17:56,309
don't know if the author just doesn't

471
00:17:54,150 --> 00:17:58,650
time or lost interest there haven't been

472
00:17:56,309 --> 00:18:01,200
any significant updates to veil evasion

473
00:17:58,650 --> 00:18:02,370
in a couple of years so it's kind of

474
00:18:01,200 --> 00:18:05,549
fallen by the wayside it's not as

475
00:18:02,370 --> 00:18:06,809
effective as it once was but let's just

476
00:18:05,549 --> 00:18:12,418
try it out anyway it's still a useful

477
00:18:06,809 --> 00:18:14,129
tool come on Ariel so when you run it it

478
00:18:12,419 --> 00:18:16,049
actually has it has a command line

479
00:18:14,130 --> 00:18:17,730
interface as well but it also has this

480
00:18:16,049 --> 00:18:19,500
nice kind of menu driven interface which

481
00:18:17,730 --> 00:18:21,240
couldn't kind of help you help guide you

482
00:18:19,500 --> 00:18:24,720
through the process of generating now

483
00:18:21,240 --> 00:18:27,539
we're using a veil evasion so here's the

484
00:18:24,720 --> 00:18:28,740
main menu my type of list in my payloads

485
00:18:27,539 --> 00:18:32,309
here are some of the payloads there's

486
00:18:28,740 --> 00:18:33,750
about 30 40 different payloads here's

487
00:18:32,309 --> 00:18:34,740
just a selection I'm gonna use this one

488
00:18:33,750 --> 00:18:36,690
down here

489
00:18:34,740 --> 00:18:38,850
the c-sharp hazard CS downs vertices

490
00:18:36,690 --> 00:18:41,070
sharp based meterpreter shell using a

491
00:18:38,850 --> 00:18:42,408
reverse TCP connection meterpreter if

492
00:18:41,070 --> 00:18:46,350
you're not familiar it's kind of an

493
00:18:42,409 --> 00:18:48,270
advanced type of shell that's enjoyed by

494
00:18:46,350 --> 00:18:49,980
red teamers because it has is a little

495
00:18:48,270 --> 00:18:52,679
functionality that's useful for anyone

496
00:18:49,980 --> 00:18:53,580
doing a penetration test and similar to

497
00:18:52,679 --> 00:18:56,669
a shell but it's a litte bit more

498
00:18:53,580 --> 00:19:00,000
advanced so anyway once you select your

499
00:18:56,669 --> 00:19:02,159
payload that it gives you a whole bunch

500
00:19:00,000 --> 00:19:03,840
of different options that you have this

501
00:19:02,159 --> 00:19:06,360
is your typical ones you know L host L

502
00:19:03,840 --> 00:19:08,370
port and Jack Shea method a compile to

503
00:19:06,360 --> 00:19:09,899
exe is nice but I want to draw your

504
00:19:08,370 --> 00:19:13,979
attention to a couple of other ones here

505
00:19:09,900 --> 00:19:15,720
including like say domain username and

506
00:19:13,980 --> 00:19:17,760
then that sort of thing so these these

507
00:19:15,720 --> 00:19:20,340
options are very useful for helping to

508
00:19:17,760 --> 00:19:23,070
avoid sandbox analysis because when you

509
00:19:20,340 --> 00:19:25,020
specify these options it will cause the

510
00:19:23,070 --> 00:19:27,510
payload to only execute when it sees

511
00:19:25,020 --> 00:19:29,460
that the domain being used by the host

512
00:19:27,510 --> 00:19:32,610
matches what you specified in the

513
00:19:29,460 --> 00:19:35,490
malware so if you specify like my domain

514
00:19:32,610 --> 00:19:37,678
or my user the payload only executes if

515
00:19:35,490 --> 00:19:39,650
it sees that the user is my user on my

516
00:19:37,679 --> 00:19:41,730
domain

517
00:19:39,650 --> 00:19:44,610
so that's what I've done here I started

518
00:19:41,730 --> 00:19:45,419
a set a bunch of basic options my domain

519
00:19:44,610 --> 00:19:47,549
my

520
00:19:45,419 --> 00:19:48,929
I threw in asleep so it waits five

521
00:19:47,549 --> 00:19:50,429
seconds before executing the payload

522
00:19:48,929 --> 00:19:53,009
that's another way of getting past

523
00:19:50,429 --> 00:19:54,299
sandboxing sometimes and use the Aria

524
00:19:53,009 --> 00:19:56,820
encrypter that's just another thing to

525
00:19:54,299 --> 00:19:57,299
kind of help a bypass so I generate the

526
00:19:56,820 --> 00:20:00,570
payload

527
00:19:57,299 --> 00:20:02,970
I call it payload seven how does it do

528
00:20:00,570 --> 00:20:05,820
pretty good actually we're down to we're

529
00:20:02,970 --> 00:20:07,620
on to 25 are those 69 antivirus suites

530
00:20:05,820 --> 00:20:09,678
detecting our malware we're past the

531
00:20:07,620 --> 00:20:13,408
halfway point yet we're better than 50%

532
00:20:09,679 --> 00:20:14,879
bypassed so rather than go through that

533
00:20:13,409 --> 00:20:17,129
the screen shot again I've just kind of

534
00:20:14,879 --> 00:20:19,168
highlighted a few of the big names that

535
00:20:17,129 --> 00:20:21,860
we've now successfully evaded with this

536
00:20:19,169 --> 00:20:24,389
particular payload obviously Avast AVG

537
00:20:21,860 --> 00:20:26,100
BitDefender clam baby and for the net

538
00:20:24,389 --> 00:20:28,879
these webs are probably ones probably

539
00:20:26,100 --> 00:20:31,199
names that everybody here will recognize

540
00:20:28,879 --> 00:20:34,110
notable ones that we have yet to evade

541
00:20:31,200 --> 00:20:36,529
from that list include Kaspersky zone

542
00:20:34,110 --> 00:20:38,668
alarm nod32 and everyone's favorite

543
00:20:36,529 --> 00:20:41,419
Windows Defender we still have not

544
00:20:38,669 --> 00:20:43,799
bypassed these these particular Suites

545
00:20:41,419 --> 00:20:46,080
so what else could media well let's

546
00:20:43,799 --> 00:20:48,539
bring back upx try to pack this one

547
00:20:46,080 --> 00:20:50,428
unfortunately upx doesn't support dotnet

548
00:20:48,539 --> 00:20:53,549
files which is when you're using the

549
00:20:50,429 --> 00:20:55,440
c-sharp c-sharp payloads they come in

550
00:20:53,549 --> 00:20:57,418
the down that format and you px can't

551
00:20:55,440 --> 00:21:00,090
really do anything with them well that's

552
00:20:57,419 --> 00:21:01,860
unfortunate however what happens if we

553
00:21:00,090 --> 00:21:03,899
change up the specific payloads

554
00:21:01,860 --> 00:21:06,209
sometimes just using a different payload

555
00:21:03,899 --> 00:21:08,219
from a particular tool can give us

556
00:21:06,210 --> 00:21:10,139
better or at least different results

557
00:21:08,220 --> 00:21:12,029
it's not always important to have a

558
00:21:10,139 --> 00:21:14,668
better results so long as we're

559
00:21:12,029 --> 00:21:16,559
bypassing additional antivirus Suites

560
00:21:14,669 --> 00:21:17,639
that we weren't bypassing before right

561
00:21:16,559 --> 00:21:21,029
it's important that we have a way of

562
00:21:17,639 --> 00:21:24,209
getting past any particular antivirus

563
00:21:21,029 --> 00:21:26,700
suite so anyway I've chosen one that's

564
00:21:24,210 --> 00:21:29,639
based on Python rather than in c-sharp

565
00:21:26,700 --> 00:21:31,649
and this supports a compile to exe

566
00:21:29,639 --> 00:21:34,498
format for Python it makes use of PI

567
00:21:31,649 --> 00:21:37,439
installer to change the raw pay the raw

568
00:21:34,499 --> 00:21:39,659
Python payload who into an actual

569
00:21:37,440 --> 00:21:41,070
executable that's obviously very useful

570
00:21:39,659 --> 00:21:42,990
if you're attacking hosts that don't

571
00:21:41,070 --> 00:21:46,408
have the Python runtime environment

572
00:21:42,990 --> 00:21:48,929
installed so same sort of thing I set a

573
00:21:46,409 --> 00:21:51,629
few useful you know domain username

574
00:21:48,929 --> 00:21:54,570
generate all that jazz and how does it

575
00:21:51,629 --> 00:21:57,480
do 26 it's a boats about the same a

576
00:21:54,570 --> 00:21:58,918
little bit a little bit worse but do we

577
00:21:57,480 --> 00:22:00,539
get past any new

578
00:21:58,919 --> 00:22:03,239
antivirus Suites that we weren't getting

579
00:22:00,539 --> 00:22:06,989
past before that's the key question and

580
00:22:03,239 --> 00:22:09,269
yeah we got a couple on there so far all

581
00:22:06,989 --> 00:22:11,429
getting past that and nod32 it's a

582
00:22:09,269 --> 00:22:13,919
rather popular one that we're again now

583
00:22:11,429 --> 00:22:15,840
successfully bypassing so even crossing

584
00:22:13,919 --> 00:22:17,609
nod32 off our list we still not getting

585
00:22:15,840 --> 00:22:21,899
past Kaspersky zone alarm or Windows

586
00:22:17,609 --> 00:22:25,559
Defender well let's bring it right now

587
00:22:21,899 --> 00:22:27,029
I'm going to talk about shelter shelter

588
00:22:25,559 --> 00:22:28,859
is another popular tool it's not open

589
00:22:27,029 --> 00:22:30,359
source but it does have a free version

590
00:22:28,859 --> 00:22:32,029
as well as a paid version the paid

591
00:22:30,359 --> 00:22:35,279
version has additional features like

592
00:22:32,029 --> 00:22:36,450
doing using dll's and that sort of thing

593
00:22:35,279 --> 00:22:38,669
but the free version is also pretty

594
00:22:36,450 --> 00:22:41,369
effective it is limited to 32 bits

595
00:22:38,669 --> 00:22:44,450
binaries but you know that's okay you

596
00:22:41,369 --> 00:22:47,908
can still make use of it so shelter is a

597
00:22:44,450 --> 00:22:50,549
dynamic shell code injection tool and

598
00:22:47,909 --> 00:22:53,999
the idea is it injects shell codes into

599
00:22:50,549 --> 00:22:56,399
existing 32-bit Windows executable it's

600
00:22:53,999 --> 00:22:58,440
kind of similar in in principle to when

601
00:22:56,399 --> 00:23:00,600
I when I specified party dot exe as a

602
00:22:58,440 --> 00:23:02,639
template for MSF denim it's kind of the

603
00:23:00,600 --> 00:23:05,730
same idea but it's doing it in a

604
00:23:02,639 --> 00:23:08,100
different fashion with some very

605
00:23:05,730 --> 00:23:10,830
important differences so shelter makes

606
00:23:08,100 --> 00:23:12,330
use of the existing binaries structure

607
00:23:10,830 --> 00:23:14,158
it doesn't you know add additional code

608
00:23:12,330 --> 00:23:16,168
segments it doesn't you know allocate

609
00:23:14,159 --> 00:23:17,730
additional executable memory or anything

610
00:23:16,169 --> 00:23:20,039
like that and says what it typically

611
00:23:17,730 --> 00:23:22,759
does is it scans through the binary and

612
00:23:20,039 --> 00:23:25,049
tries to find what are called code caves

613
00:23:22,759 --> 00:23:26,970
places in between functions and code

614
00:23:25,049 --> 00:23:29,129
blocks whether it's like kind of dead

615
00:23:26,970 --> 00:23:31,409
space and puts the shell code in there

616
00:23:29,129 --> 00:23:33,238
so it leverages the existing executable

617
00:23:31,409 --> 00:23:35,309
code segment without having to make

618
00:23:33,239 --> 00:23:37,470
additional function calls and those

619
00:23:35,309 --> 00:23:38,428
things are often out to trigger a B if

620
00:23:37,470 --> 00:23:40,470
you're if you're allocating additional

621
00:23:38,429 --> 00:23:42,419
executable memory or changing execute

622
00:23:40,470 --> 00:23:44,960
permissions will often throw up a red

623
00:23:42,419 --> 00:23:48,239
flag so it gets around that

624
00:23:44,960 --> 00:23:49,259
okay so shelter um again you can run it

625
00:23:48,239 --> 00:23:51,389
from the command line as a command line

626
00:23:49,259 --> 00:23:53,700
interface but like veil evasion it has a

627
00:23:51,389 --> 00:23:55,559
lovely little menu driven interface

628
00:23:53,700 --> 00:23:57,509
which will help walk you through the

629
00:23:55,559 --> 00:23:59,549
process of creating creating your own

630
00:23:57,509 --> 00:24:00,899
malware but I'm gonna run it straight

631
00:23:59,549 --> 00:24:02,519
from the command line with the options

632
00:24:00,899 --> 00:24:05,340
because you don't need to see all that

633
00:24:02,519 --> 00:24:08,820
other jazz you know I specified a basic

634
00:24:05,340 --> 00:24:11,488
reverse TCP shell ill host import I

635
00:24:08,820 --> 00:24:12,510
specified the - - stealth functionality

636
00:24:11,489 --> 00:24:15,210
and that's similar to the

637
00:24:12,510 --> 00:24:17,340
- k option for MSF then I'm where I'm

638
00:24:15,210 --> 00:24:19,740
telling shelter to keep the original

639
00:24:17,340 --> 00:24:21,990
functionality of the original binary you

640
00:24:19,740 --> 00:24:24,900
know for OPSEC purposes and I'm going to

641
00:24:21,990 --> 00:24:29,280
use putty dot exe again so it runs

642
00:24:24,900 --> 00:24:31,500
through 33 out of 69 not bad taking a

643
00:24:29,280 --> 00:24:33,480
bit of a step backwards but again the

644
00:24:31,500 --> 00:24:35,070
question now are we getting past any

645
00:24:33,480 --> 00:24:37,919
additional antivirus Suites

646
00:24:35,070 --> 00:24:38,850
we weren't I didn't I needed to slide in

647
00:24:37,919 --> 00:24:40,080
there apparently but no we weren't

648
00:24:38,850 --> 00:24:42,540
getting past any new ones that weren't

649
00:24:40,080 --> 00:24:45,570
getting past before but bring back her

650
00:24:42,540 --> 00:24:47,580
old friend upx take the the output the

651
00:24:45,570 --> 00:24:50,700
putty Exe and create a new putty - dot

652
00:24:47,580 --> 00:24:53,280
exe and let's see how that does yeah

653
00:24:50,700 --> 00:24:56,070
we're down to 23 that's not bad look the

654
00:24:53,280 --> 00:24:58,799
same as before but were there any new

655
00:24:56,070 --> 00:25:00,629
Suites were bypassing and yeah we got a

656
00:24:58,799 --> 00:25:03,299
couple we fact we've nailed some of the

657
00:25:00,630 --> 00:25:05,220
big names we're now bypassing Microsoft

658
00:25:03,299 --> 00:25:09,000
we're bypassing Kaspersky and we're

659
00:25:05,220 --> 00:25:10,410
bypassing zone alarm so at this point

660
00:25:09,000 --> 00:25:12,720
I've kind of knocked out a lot of the

661
00:25:10,410 --> 00:25:15,090
big names that I had targeted before and

662
00:25:12,720 --> 00:25:17,429
we're especially real to get past pretty

663
00:25:15,090 --> 00:25:19,530
much any big name antivirus vendor just

664
00:25:17,429 --> 00:25:24,840
by varying what tool and what payload

665
00:25:19,530 --> 00:25:26,820
the belief we've chosen so one other

666
00:25:24,840 --> 00:25:30,059
thing you can do differently I was using

667
00:25:26,820 --> 00:25:31,889
putty Exe for my you know seed

668
00:25:30,059 --> 00:25:34,168
information but that's my original

669
00:25:31,890 --> 00:25:36,360
binary but suffice it to say I'm not the

670
00:25:34,169 --> 00:25:38,220
first jackass who use putty dot exe and

671
00:25:36,360 --> 00:25:39,629
and been throwing a payload in there and

672
00:25:38,220 --> 00:25:42,030
uploaded it to virustotal

673
00:25:39,630 --> 00:25:45,450
and because putty is a very common

674
00:25:42,030 --> 00:25:46,678
binary to use for those purposes a lot

675
00:25:45,450 --> 00:25:47,970
of antivirus vendors have kind of become

676
00:25:46,679 --> 00:25:49,620
wise to that and they have a lot of

677
00:25:47,970 --> 00:25:52,200
signatures and stuff that they've tuned

678
00:25:49,620 --> 00:25:53,668
specifically to catch putty right so

679
00:25:52,200 --> 00:25:55,260
what I went you probably can't see that

680
00:25:53,669 --> 00:25:57,270
but what I went out and I found pretty

681
00:25:55,260 --> 00:26:00,480
much the most obscure binary I possibly

682
00:25:57,270 --> 00:26:03,450
could it's some like random custom calc

683
00:26:00,480 --> 00:26:05,910
allocation for Windows 90 Windows XP or

684
00:26:03,450 --> 00:26:08,610
whatever and I used that with with

685
00:26:05,910 --> 00:26:10,950
shelter and by using that instead of

686
00:26:08,610 --> 00:26:13,229
putty XE I was able to get my detection

687
00:26:10,950 --> 00:26:20,610
rate down even further to just 19 out of

688
00:26:13,230 --> 00:26:24,059
68 1900 68 antivirus tools okay dr. Emma

689
00:26:20,610 --> 00:26:26,370
says Emma in version 5 SF venom released

690
00:26:24,059 --> 00:26:29,750
the included the ability to increase

691
00:26:26,370 --> 00:26:35,219
your payload and you can use AES RC for

692
00:26:29,750 --> 00:26:37,650
XOR or base64 encryption to to basically

693
00:26:35,220 --> 00:26:38,250
obfuscate your payload no the idea is

694
00:26:37,650 --> 00:26:40,409
pretty simple

695
00:26:38,250 --> 00:26:41,970
encrypt your payload and then write a

696
00:26:40,409 --> 00:26:43,770
routine that decrypt your payload and

697
00:26:41,970 --> 00:26:45,240
then officially runs your payload and

698
00:26:43,770 --> 00:26:47,158
this is good against some static

699
00:26:45,240 --> 00:26:48,539
analysis but obviously this is going to

700
00:26:47,159 --> 00:26:50,580
help you very much against any sort of

701
00:26:48,539 --> 00:26:53,270
behavioral analysis because even change

702
00:26:50,580 --> 00:26:56,549
the behavior of the program very much

703
00:26:53,270 --> 00:26:58,590
unfortunately while the MSF venom will

704
00:26:56,549 --> 00:27:00,779
encrypt the payload for you you have to

705
00:26:58,590 --> 00:27:01,740
write your own decryption routines I'll

706
00:27:00,779 --> 00:27:05,010
kind of show you what that looks like

707
00:27:01,740 --> 00:27:08,159
real quick basic formats the same MSF

708
00:27:05,010 --> 00:27:09,840
venom there's my payload l host l port

709
00:27:08,159 --> 00:27:12,450
I throw should Cadogan I in there

710
00:27:09,840 --> 00:27:14,250
because why the hell not I've chosen RC

711
00:27:12,450 --> 00:27:17,299
for for my encryption routine and

712
00:27:14,250 --> 00:27:19,620
specified a key my key very creative RIA

713
00:27:17,299 --> 00:27:21,149
and I've actually told this time to

714
00:27:19,620 --> 00:27:22,709
output it in the C format because I

715
00:27:21,149 --> 00:27:25,049
meant as I mentioned you have to write

716
00:27:22,710 --> 00:27:27,090
your own decryption routine so I need to

717
00:27:25,049 --> 00:27:28,889
actually take this code put it in my own

718
00:27:27,090 --> 00:27:30,928
program to decrypt it before I can

719
00:27:28,890 --> 00:27:32,340
actually run it so that looks kind of

720
00:27:30,929 --> 00:27:35,390
like this there's that's the payload at

721
00:27:32,340 --> 00:27:38,610
the top there there's my key main void

722
00:27:35,390 --> 00:27:40,470
allocate the memory and decrypt it and

723
00:27:38,610 --> 00:27:44,459
then do some function pointer magic to

724
00:27:40,470 --> 00:27:47,039
actually call the code directly how does

725
00:27:44,460 --> 00:27:50,070
it do on its own not great

726
00:27:47,039 --> 00:27:53,100
thirty-six out of 69 it's not terrible

727
00:27:50,070 --> 00:27:55,350
but it could be better now again this is

728
00:27:53,100 --> 00:27:57,570
this is kind of a simple application of

729
00:27:55,350 --> 00:27:58,649
using encryption you can combine it with

730
00:27:57,570 --> 00:28:00,120
some of the other methods I've talked

731
00:27:58,649 --> 00:28:04,110
about and you can probably get a better

732
00:28:00,120 --> 00:28:06,000
result than this so anyway this is just

733
00:28:04,110 --> 00:28:08,039
a small sample of the tools that are

734
00:28:06,000 --> 00:28:09,450
available I've I've not touched on

735
00:28:08,039 --> 00:28:12,870
theirs there's tons out there

736
00:28:09,450 --> 00:28:14,940
sharpshooter puppy and X crypt all sorts

737
00:28:12,870 --> 00:28:17,189
of different tools my sure cobalt strike

738
00:28:14,940 --> 00:28:19,380
has something I'm sure you know Matthew

739
00:28:17,190 --> 00:28:20,610
or or Tim could tell you about some

740
00:28:19,380 --> 00:28:22,770
tools that they know about that I'm not

741
00:28:20,610 --> 00:28:26,330
even aware of for obfuscating payloads

742
00:28:22,770 --> 00:28:28,559
helping them to bypass bypass antivirus

743
00:28:26,330 --> 00:28:29,970
yeah it feels like every five or six

744
00:28:28,559 --> 00:28:33,510
months somebody comes up with some new

745
00:28:29,970 --> 00:28:35,280
hotness new tool for for bypassing

746
00:28:33,510 --> 00:28:36,870
antivirus and then another couple of

747
00:28:35,280 --> 00:28:38,220
months go by and the antivirus vendors

748
00:28:36,870 --> 00:28:39,659
catch up and you know the cat-and-mouse

749
00:28:38,220 --> 00:28:43,830
cycle continues

750
00:28:39,660 --> 00:28:44,880
and continues just briefly I'm going to

751
00:28:43,830 --> 00:28:46,740
talk about some of the advanced

752
00:28:44,880 --> 00:28:47,730
techniques I'm not gonna demonstrate

753
00:28:46,740 --> 00:28:49,440
them because sometimes they're just a

754
00:28:47,730 --> 00:28:51,840
pain in the ass to do but they're there

755
00:28:49,440 --> 00:28:54,270
and one of them is just using really

756
00:28:51,840 --> 00:28:56,280
really big files now this used to be

757
00:28:54,270 --> 00:28:58,740
much more effective you know ten years

758
00:28:56,280 --> 00:29:00,750
ago or so whereas a lot of antivirus if

759
00:28:58,740 --> 00:29:02,250
it's all like a like a 500 megabyte file

760
00:29:00,750 --> 00:29:02,640
or something like that it just wouldn't

761
00:29:02,250 --> 00:29:05,160
touch it

762
00:29:02,640 --> 00:29:06,480
right and that sounds ridiculous but it

763
00:29:05,160 --> 00:29:08,070
kind of makes sense when you stop and

764
00:29:06,480 --> 00:29:10,110
think about it right because if it had

765
00:29:08,070 --> 00:29:12,389
if you had to scan the file from start

766
00:29:10,110 --> 00:29:13,679
to end a whole gigabyte file that's

767
00:29:12,390 --> 00:29:15,660
going to take forever and if there's one

768
00:29:13,680 --> 00:29:17,040
thing users love complaining about its

769
00:29:15,660 --> 00:29:18,450
how their antivirus is slowing down

770
00:29:17,040 --> 00:29:20,879
their desktop right so they can't they

771
00:29:18,450 --> 00:29:22,400
can't have that and but even nowadays

772
00:29:20,880 --> 00:29:25,560
even though it's more sophisticated

773
00:29:22,400 --> 00:29:27,510
there's a lot of an anti-virus might not

774
00:29:25,560 --> 00:29:30,179
scan it from tip to tail but it might

775
00:29:27,510 --> 00:29:33,570
disable some of the some of the more

776
00:29:30,180 --> 00:29:35,550
time-intensive scanning techniques even

777
00:29:33,570 --> 00:29:37,169
virustotal tops out of five hundred

778
00:29:35,550 --> 00:29:39,270
fifty megabytes you can't upload a file

779
00:29:37,170 --> 00:29:42,840
larger than that to virustotal and when

780
00:29:39,270 --> 00:29:45,000
i uploaded one 470 megabytes a 12 of the

781
00:29:42,840 --> 00:29:46,649
antivirus vendors just said yeah we

782
00:29:45,000 --> 00:29:48,870
can't process this this is this is too

783
00:29:46,650 --> 00:29:51,630
big it actually generated a false

784
00:29:48,870 --> 00:29:53,070
positive that way on a bond the binary

785
00:29:51,630 --> 00:29:55,620
that I knew was clean so that was that

786
00:29:53,070 --> 00:29:56,669
was a little weird but anyway like I

787
00:29:55,620 --> 00:29:58,889
said this is used to be much more

788
00:29:56,670 --> 00:30:03,180
effective in you olden days nowadays

789
00:29:58,890 --> 00:30:05,760
less so the other technique you can use

790
00:30:03,180 --> 00:30:08,400
is called separation and the idea is

791
00:30:05,760 --> 00:30:11,820
that your payload is in exists in one

792
00:30:08,400 --> 00:30:13,380
file like say a DLL and then that code

793
00:30:11,820 --> 00:30:15,120
is then called from another file from

794
00:30:13,380 --> 00:30:17,420
say like an executable file that loads

795
00:30:15,120 --> 00:30:20,310
that DLL that you package it together

796
00:30:17,420 --> 00:30:21,510
traditionally antivirus pays less

797
00:30:20,310 --> 00:30:23,250
attention to dll's

798
00:30:21,510 --> 00:30:25,230
again not as much the case as it used to

799
00:30:23,250 --> 00:30:27,540
be they're getting they're getting wise

800
00:30:25,230 --> 00:30:29,940
to this trick as well and it's also more

801
00:30:27,540 --> 00:30:31,260
challenging for a red teamer or malware

802
00:30:29,940 --> 00:30:33,330
author to deliver because now you don't

803
00:30:31,260 --> 00:30:37,770
need to just get one file to the users

804
00:30:33,330 --> 00:30:40,320
you have to somehow get get to code

805
00:30:37,770 --> 00:30:42,690
signing abusing code signing many

806
00:30:40,320 --> 00:30:44,189
antivirus suites aren't as rigorous with

807
00:30:42,690 --> 00:30:46,200
signed binaries if they see that the

808
00:30:44,190 --> 00:30:48,000
binary is appropriately signed you know

809
00:30:46,200 --> 00:30:49,170
they they kind of wait they're

810
00:30:48,000 --> 00:30:50,160
heuristics core is a little bit

811
00:30:49,170 --> 00:30:53,169
differently and you can sometimes

812
00:30:50,160 --> 00:30:55,210
exploit that to sneak your pillow

813
00:30:53,169 --> 00:30:56,380
passed antivirus it doesn't even

814
00:30:55,210 --> 00:30:58,960
necessarily need to be a valid

815
00:30:56,380 --> 00:31:00,549
certificate or signature on the file

816
00:30:58,960 --> 00:31:02,260
just the fact that it has it can

817
00:31:00,549 --> 00:31:04,658
sometimes cause antivirus to kind of

818
00:31:02,260 --> 00:31:06,039
slacken their response a little bit and

819
00:31:04,659 --> 00:31:07,299
it is easy enough of course obtain your

820
00:31:06,039 --> 00:31:09,580
own code signing certificate and then

821
00:31:07,299 --> 00:31:10,779
just get it signed beware though if

822
00:31:09,580 --> 00:31:12,730
you're not using a valid server

823
00:31:10,779 --> 00:31:14,620
signature the user of course will get a

824
00:31:12,730 --> 00:31:16,029
warning on Windows and that comes back

825
00:31:14,620 --> 00:31:18,070
to what I was saying about users being

826
00:31:16,029 --> 00:31:19,750
sometimes the most effective and also

827
00:31:18,070 --> 00:31:23,649
the least effective form with antivirus

828
00:31:19,750 --> 00:31:25,600
out there okay so the takeaway is that I

829
00:31:23,649 --> 00:31:28,360
have for you from this talk couple

830
00:31:25,600 --> 00:31:30,158
number one just about any antivirus

831
00:31:28,360 --> 00:31:32,500
suite can be bypassed given enough

832
00:31:30,159 --> 00:31:34,450
effort and time now the techniques I've

833
00:31:32,500 --> 00:31:36,490
demonstrated here are not super

834
00:31:34,450 --> 00:31:37,419
sophisticated the bad guys the guys

835
00:31:36,490 --> 00:31:39,279
you're trying to get into your network

836
00:31:37,419 --> 00:31:40,630
they know all sorts of advanced

837
00:31:39,279 --> 00:31:43,059
techniques that I haven't I haven't even

838
00:31:40,630 --> 00:31:46,029
talked about here and the point just

839
00:31:43,059 --> 00:31:48,309
being you know don't rely on antivirus

840
00:31:46,029 --> 00:31:50,620
as the sole line of defense in your

841
00:31:48,309 --> 00:31:52,178
network it's not you know it has some

842
00:31:50,620 --> 00:31:54,129
value but if that's all you got going

843
00:31:52,179 --> 00:31:54,549
for you you're gonna be in serious

844
00:31:54,130 --> 00:31:56,799
trouble

845
00:31:54,549 --> 00:31:58,210
don't anybody takes any notice of your

846
00:31:56,799 --> 00:32:02,168
network and wants to put any time or

847
00:31:58,210 --> 00:32:04,440
effort into into getting in point

848
00:32:02,169 --> 00:32:07,529
takeaway number two for the red team's

849
00:32:04,440 --> 00:32:10,870
Rickon and research are keys to success

850
00:32:07,529 --> 00:32:12,850
knowing what antivirus suite you're your

851
00:32:10,870 --> 00:32:14,520
target is using is extremely important

852
00:32:12,850 --> 00:32:17,529
because then you can target your

853
00:32:14,520 --> 00:32:19,809
resulting binary against that antivirus

854
00:32:17,529 --> 00:32:21,789
suite for helping you get past it right

855
00:32:19,809 --> 00:32:24,220
you're not wasting time trying to get

856
00:32:21,789 --> 00:32:25,870
past all antivirus Suites which can you

857
00:32:24,220 --> 00:32:26,919
know time is money and that's what

858
00:32:25,870 --> 00:32:29,529
you're billing your clients and they

859
00:32:26,919 --> 00:32:31,659
don't want that so it helps you focus

860
00:32:29,529 --> 00:32:36,159
your efforts a lot and not waste time

861
00:32:31,659 --> 00:32:39,250
and resources the the third takeaway is

862
00:32:36,159 --> 00:32:40,809
to don't not use antivirus even though I

863
00:32:39,250 --> 00:32:42,820
just spent the last half hour talking

864
00:32:40,809 --> 00:32:45,220
about how any antivirus suite can be

865
00:32:42,820 --> 00:32:46,899
bypassed enough time and effort it's

866
00:32:45,220 --> 00:32:48,820
still it's still really still very

867
00:32:46,899 --> 00:32:50,559
valuable it's still something that you

868
00:32:48,820 --> 00:32:52,350
should have on your network and now

869
00:32:50,559 --> 00:32:55,029
there is an argument especially recently

870
00:32:52,350 --> 00:32:57,189
that having antivirus running on your

871
00:32:55,029 --> 00:32:59,230
system actually increases your attack

872
00:32:57,190 --> 00:33:01,179
space right there's the antivirus has to

873
00:32:59,230 --> 00:33:03,520
run in an elevated position in order to

874
00:33:01,179 --> 00:33:04,899
do what it does and I don't wonder what

875
00:33:03,520 --> 00:33:06,379
the suite it was me it was malwarebytes

876
00:33:04,899 --> 00:33:09,289
I don't remember

877
00:33:06,380 --> 00:33:11,870
had a critical vulnerability which

878
00:33:09,289 --> 00:33:14,600
allowed an attacker to to leverage of

879
00:33:11,870 --> 00:33:15,830
the antivirus suite to gain system level

880
00:33:14,600 --> 00:33:18,799
privileges

881
00:33:15,830 --> 00:33:19,908
it was Symantec okay I'll take your word

882
00:33:18,799 --> 00:33:23,179
for it

883
00:33:19,909 --> 00:33:24,409
but yeah but even with that in mind it's

884
00:33:23,179 --> 00:33:26,840
still better than nothing and the

885
00:33:24,409 --> 00:33:30,020
reality is antivirus is great at

886
00:33:26,840 --> 00:33:33,500
catching that you know 90% 95% or or

887
00:33:30,020 --> 00:33:35,629
higher of the generic you know malware

888
00:33:33,500 --> 00:33:38,480
that we see every day right all that

889
00:33:35,630 --> 00:33:40,279
 that gets mailed out to a billion

890
00:33:38,480 --> 00:33:42,110
different email addresses antivirus is

891
00:33:40,279 --> 00:33:44,539
great for that right and catching that

892
00:33:42,110 --> 00:33:49,129
stuff is important too so don't not use

893
00:33:44,539 --> 00:33:51,320
antivirus last last point I want a less

894
00:33:49,130 --> 00:33:53,090
takeaway I have is websites like

895
00:33:51,320 --> 00:33:54,649
av-comparatives yeah they're a total

896
00:33:53,090 --> 00:33:56,779
joke I don't know if you're familiar

897
00:33:54,649 --> 00:33:59,299
with them but it's like a it's a website

898
00:33:56,779 --> 00:34:01,039
and there are others like it I see you

899
00:33:59,299 --> 00:34:03,230
there Jay looking very good today by the

900
00:34:01,039 --> 00:34:06,470
way yeah yeah that's super worth a

901
00:34:03,230 --> 00:34:07,610
couple extra minutes I figure right okay

902
00:34:06,470 --> 00:34:09,830
all right

903
00:34:07,610 --> 00:34:11,359
AV comparatives is a joke yeah it's a

904
00:34:09,830 --> 00:34:13,429
website for comparing different AV

905
00:34:11,359 --> 00:34:15,199
Suites and trying to evaluate how they

906
00:34:13,429 --> 00:34:17,119
do which ones better at detecting now

907
00:34:15,199 --> 00:34:18,710
where and all that and they're just

908
00:34:17,119 --> 00:34:21,320
a total joke like for instance according

909
00:34:18,710 --> 00:34:22,490
to AV comparatives Avast has a ninety

910
00:34:21,320 --> 00:34:24,679
nine point three percent online

911
00:34:22,489 --> 00:34:26,839
detection rate there's September 2019

912
00:34:24,679 --> 00:34:28,849
test but we all saw how long it took me

913
00:34:26,839 --> 00:34:30,980
to come up with malware that's still the

914
00:34:28,849 --> 00:34:32,480
right past Avast or avj right so it's

915
00:34:30,980 --> 00:34:33,980
kind of like what are they what are they

916
00:34:32,480 --> 00:34:36,469
really evaluating you know these numbers

917
00:34:33,980 --> 00:34:37,909
are largely meaningless right and and

918
00:34:36,469 --> 00:34:40,428
the look and the approach that they're

919
00:34:37,909 --> 00:34:42,320
taking of taking a suite of known bad

920
00:34:40,429 --> 00:34:44,330
malware and seeing you know which

921
00:34:42,320 --> 00:34:46,700
antivirus captures which it's just it's

922
00:34:44,330 --> 00:34:50,509
really the wrong approach for evaluating

923
00:34:46,699 --> 00:34:53,888
your antivirus so that is everything I

924
00:34:50,510 --> 00:34:53,889
had to say apparently I got five minutes

