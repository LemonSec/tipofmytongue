1
00:00:09,550 --> 00:00:18,369
[Applause]

2
00:00:15,520 --> 00:00:21,020
good morning security nerds

3
00:00:18,369 --> 00:00:25,490
congratulations on being out before noon

4
00:00:21,020 --> 00:00:26,210
on a Saturday no it's tough for most of

5
00:00:25,490 --> 00:00:28,220
you

6
00:00:26,210 --> 00:00:31,520
my name is Catherine's Krupa I have a

7
00:00:28,220 --> 00:00:35,120
network technology CCNA I also got my

8
00:00:31,520 --> 00:00:37,910
GHG seed LUN which is Windows stuff from

9
00:00:35,120 --> 00:00:39,709
sans a couple years ago and I'm thank

10
00:00:37,910 --> 00:00:44,239
you for allowing me to present and I'm

11
00:00:39,710 --> 00:00:47,030
happy to tell you about WMI as for the

12
00:00:44,239 --> 00:00:48,559
title apologies to Neil Gaiman and Terry

13
00:00:47,030 --> 00:00:51,740
Pratchett that's where that comes from

14
00:00:48,560 --> 00:00:54,620
I've got a quote at the end to finish up

15
00:00:51,740 --> 00:01:01,760
the presentation but yeah we're gonna

16
00:00:54,620 --> 00:01:03,078
talk about WMI and see I am today so I'm

17
00:01:01,760 --> 00:01:05,030
not going to tell you anything and

18
00:01:03,079 --> 00:01:07,250
everything you would ever need to know

19
00:01:05,030 --> 00:01:09,890
about W mine see I see I am I'm gonna

20
00:01:07,250 --> 00:01:11,899
tell you about just get you to a point

21
00:01:09,890 --> 00:01:13,939
where you feel comfortable with

22
00:01:11,899 --> 00:01:19,790
experimenting it and using it for your

23
00:01:13,939 --> 00:01:23,419
own purposes there's if you're more

24
00:01:19,790 --> 00:01:24,920
curious about the red team's side of

25
00:01:23,420 --> 00:01:29,479
things there's a really good talk by

26
00:01:24,920 --> 00:01:32,630
Matt Graber hash that his username is

27
00:01:29,479 --> 00:01:36,440
manifestation on Twitter gave a talk at

28
00:01:32,630 --> 00:01:38,990
black on about our black hat about about

29
00:01:36,440 --> 00:01:42,670
the Red Hat site Red Hat side of things

30
00:01:38,990 --> 00:01:45,979
so he's a good guy to look up and follow

31
00:01:42,670 --> 00:01:47,240
I think that yeah the name news talk was

32
00:01:45,979 --> 00:01:54,590
abusing windows management

33
00:01:47,240 --> 00:01:57,589
instrumentation so if you've especially

34
00:01:54,590 --> 00:01:59,180
delved around on Windows with this type

35
00:01:57,590 --> 00:02:01,130
of stuff there's a heck of a lot of

36
00:01:59,180 --> 00:02:03,530
acronyms and it's not clear which is

37
00:02:01,130 --> 00:02:04,908
which so I'm going to go through some of

38
00:02:03,530 --> 00:02:11,629
that housekeeping and explain that to

39
00:02:04,909 --> 00:02:14,360
you you may have seen something called

40
00:02:11,629 --> 00:02:17,390
DM TF distributed management task force

41
00:02:14,360 --> 00:02:20,120
that's headed up by Microsoft IBM Cisco

42
00:02:17,390 --> 00:02:23,540
and others so they've come together and

43
00:02:20,120 --> 00:02:26,040
decided we need this task force to have

44
00:02:23,540 --> 00:02:27,780
a standard for

45
00:02:26,040 --> 00:02:30,359
accessing a whole bunch of information

46
00:02:27,780 --> 00:02:33,110
on a variety of platforms so that's why

47
00:02:30,360 --> 00:02:39,060
they've come together and done this so

48
00:02:33,110 --> 00:02:41,280
yes they are working together and the

49
00:02:39,060 --> 00:02:50,310
modeling that they came up before is

50
00:02:41,280 --> 00:02:53,880
come up with is called sim CI m so this

51
00:02:50,310 --> 00:02:56,819
is more or less how sim and WMI are

52
00:02:53,880 --> 00:02:59,730
related wmf is something a little

53
00:02:56,819 --> 00:03:03,420
different yet common information

54
00:02:59,730 --> 00:03:06,319
modeling is the standard of core in

55
00:03:03,420 --> 00:03:09,599
common constructs that they want to be

56
00:03:06,319 --> 00:03:12,298
used across different platforms so it's

57
00:03:09,599 --> 00:03:14,399
OS agnostic on purpose yeah the point is

58
00:03:12,299 --> 00:03:17,310
you can take that code and run it or

59
00:03:14,400 --> 00:03:19,829
queries and run it on anything windows

60
00:03:17,310 --> 00:03:22,260
management instrumentation is something

61
00:03:19,829 --> 00:03:25,440
that extends sim so it's Microsoft

62
00:03:22,260 --> 00:03:29,160
specific implementation of sim if you

63
00:03:25,440 --> 00:03:30,630
look at sim objects you can actually see

64
00:03:29,160 --> 00:03:32,069
where they were derived from from the

65
00:03:30,630 --> 00:03:35,400
sim standard if you know where to look

66
00:03:32,069 --> 00:03:40,679
I'll show you that in a bit can everyone

67
00:03:35,400 --> 00:03:42,480
hear me okay yeah yeah windows

68
00:03:40,680 --> 00:03:45,989
management framework is a Windows

69
00:03:42,480 --> 00:03:49,440
specific framework one of the services

70
00:03:45,989 --> 00:03:54,090
it provides is methods to access sim and

71
00:03:49,440 --> 00:03:57,690
WMI the extended version it also is the

72
00:03:54,090 --> 00:04:00,269
thing that gives you provides you

73
00:03:57,690 --> 00:04:04,049
PowerShell things like that so it's a

74
00:04:00,269 --> 00:04:07,519
whole management framework WM is

75
00:04:04,049 --> 00:04:09,840
actually been around since nt4 days

76
00:04:07,519 --> 00:04:11,849
mid 90s so it's actually been around

77
00:04:09,840 --> 00:04:18,720
quite a while as a separate install but

78
00:04:11,849 --> 00:04:21,930
it was available and you've probably

79
00:04:18,720 --> 00:04:23,729
seen these acronyms to have got a nicer

80
00:04:21,930 --> 00:04:26,070
chart on the next screen if this is too

81
00:04:23,729 --> 00:04:30,770
much text on a Saturday morning to be

82
00:04:26,070 --> 00:04:33,390
thrown at you got WebM dumped west man

83
00:04:30,770 --> 00:04:37,140
it sounds a little rude then when you

84
00:04:33,390 --> 00:04:38,370
see it that way W West man and win RM so

85
00:04:37,140 --> 00:04:41,539
the

86
00:04:38,370 --> 00:04:45,330
common information modeling the sim and

87
00:04:41,540 --> 00:04:48,419
WMI is the data essentially that's

88
00:04:45,330 --> 00:04:50,820
accessible a little more complex than

89
00:04:48,419 --> 00:04:56,219
that but you can think of it that way

90
00:04:50,820 --> 00:04:59,460
WebM describes how to access so it is

91
00:04:56,220 --> 00:05:05,160
also OS agnostic it's based on open

92
00:04:59,460 --> 00:05:13,460
standards already starting to lose my

93
00:05:05,160 --> 00:05:17,010
voice so it defines a specification for

94
00:05:13,460 --> 00:05:23,039
protocols mappings discovery and query

95
00:05:17,010 --> 00:05:29,550
languages WS man is a protocol used for

96
00:05:23,039 --> 00:05:32,669
WebM it is also s agnostic but when RM

97
00:05:29,550 --> 00:05:35,370
is essentially Microsoft's version of

98
00:05:32,669 --> 00:05:37,349
that I think a lot of these Ackerman's

99
00:05:35,370 --> 00:05:39,570
as soon as you see W in front of it you

100
00:05:37,350 --> 00:05:42,599
tend to assume oh this is a Windows

101
00:05:39,570 --> 00:05:47,010
thing and in this space that's it's not

102
00:05:42,599 --> 00:05:53,599
necessarily the case when RM is Windows

103
00:05:47,010 --> 00:05:55,650
based but the other stuff isn't oh and

104
00:05:53,599 --> 00:06:00,479
if you're curious about the

105
00:05:55,650 --> 00:06:06,060
underpinnings WebM is rest-based dense

106
00:06:00,479 --> 00:06:08,190
little chair and ws man is soap based so

107
00:06:06,060 --> 00:06:10,139
if you're doing some sort of packet

108
00:06:08,190 --> 00:06:12,240
inspection with Wireshark or playing

109
00:06:10,139 --> 00:06:19,979
around with proc Mon or something like

110
00:06:12,240 --> 00:06:22,020
that that's what you're looking for and

111
00:06:19,979 --> 00:06:25,800
this might solidify what I was just

112
00:06:22,020 --> 00:06:27,870
saying you've got WebM which has the

113
00:06:25,800 --> 00:06:29,550
mappings protocol discovery query

114
00:06:27,870 --> 00:06:32,550
languages obviously this is not a

115
00:06:29,550 --> 00:06:35,550
complete chart but for our purposes yeah

116
00:06:32,550 --> 00:06:38,669
WS man is one of the protocols and when

117
00:06:35,550 --> 00:06:42,660
RM is Microsoft specific implementation

118
00:06:38,669 --> 00:06:47,580
of that depending on what you're calling

119
00:06:42,660 --> 00:06:51,060
for sim or WMI there's another protocol

120
00:06:47,580 --> 00:06:52,289
called decom RPC and that's kind of the

121
00:06:51,060 --> 00:06:55,590
older school

122
00:06:52,290 --> 00:06:58,110
type tends to be it is the one that WMI

123
00:06:55,590 --> 00:07:10,380
itself uses if you're explicitly calling

124
00:06:58,110 --> 00:07:13,170
w mine so w MF at this point currently

125
00:07:10,380 --> 00:07:24,780
supports sim version to schemas from the

126
00:07:13,170 --> 00:07:30,420
DMT F sim can either use WMS map WS man

127
00:07:24,780 --> 00:07:34,229
or decom RPC but the WMI is decom RPC

128
00:07:30,420 --> 00:07:36,660
only recommend to make things

129
00:07:34,230 --> 00:07:39,810
standardized try to use sim curries

130
00:07:36,660 --> 00:07:43,140
where you can sometimes they do

131
00:07:39,810 --> 00:07:45,810
sometimes they don't usually frankly we

132
00:07:43,140 --> 00:07:47,729
have a problem to solve we just freaking

133
00:07:45,810 --> 00:07:49,530
google it online and you use whatever

134
00:07:47,730 --> 00:07:51,000
someone else might have already come up

135
00:07:49,530 --> 00:07:54,750
with to try to understand what it is

136
00:07:51,000 --> 00:07:56,790
right so you use what works for you

137
00:07:54,750 --> 00:07:58,890
especially while you're learning but if

138
00:07:56,790 --> 00:08:04,170
you want to standardize it move towards

139
00:07:58,890 --> 00:08:05,909
using sim so in Windows 7 which is what

140
00:08:04,170 --> 00:08:10,110
this talk is going to be concentrating

141
00:08:05,910 --> 00:08:12,090
on people you'll see online especially

142
00:08:10,110 --> 00:08:14,360
if you've still got Windows 7 boxes

143
00:08:12,090 --> 00:08:17,729
running around they'll say oh well

144
00:08:14,360 --> 00:08:19,620
Windows 7 it's only PowerShell 2 and you

145
00:08:17,730 --> 00:08:21,330
don't have the all of this stuff from

146
00:08:19,620 --> 00:08:23,070
that windows management framework you

147
00:08:21,330 --> 00:08:25,229
want to run stuff that's PowerShell 5

148
00:08:23,070 --> 00:08:27,510
you should you know you're gonna have to

149
00:08:25,230 --> 00:08:32,010
move to Windows 10 that's actually not

150
00:08:27,510 --> 00:08:35,490
true what is true is you can install the

151
00:08:32,010 --> 00:08:39,990
windows management framework 5.1 on a

152
00:08:35,490 --> 00:08:42,080
Windows 7 machine probably Six's well I

153
00:08:39,990 --> 00:08:44,910
guess which came out a little while ago

154
00:08:42,080 --> 00:08:46,080
and you can run PowerShell 5 on a

155
00:08:44,910 --> 00:08:50,310
Windows 7 box

156
00:08:46,080 --> 00:08:52,170
I mean Windows 7 is ending support in

157
00:08:50,310 --> 00:08:55,530
January so you should get off of there

158
00:08:52,170 --> 00:08:58,500
like really if you can but if you have

159
00:08:55,530 --> 00:09:00,089
to do for some reason you can absolutely

160
00:08:58,500 --> 00:09:02,610
install the new winners management

161
00:09:00,090 --> 00:09:05,910
windows management framework it's a

162
00:09:02,610 --> 00:09:12,270
whole 64 megabyte download so

163
00:09:05,910 --> 00:09:16,860
it's yeah it's totally doable yeah

164
00:09:12,270 --> 00:09:20,010
talking about I'm not gonna make this a

165
00:09:16,860 --> 00:09:22,880
PowerShell talk per se that's the most

166
00:09:20,010 --> 00:09:27,420
common way you do want to use to

167
00:09:22,880 --> 00:09:29,280
interact with this interface but just if

168
00:09:27,420 --> 00:09:32,250
you're not familiar with this whole

169
00:09:29,280 --> 00:09:35,310
ecosystem just be aware you've got

170
00:09:32,250 --> 00:09:40,350
something called PowerShell PowerShell

171
00:09:35,310 --> 00:09:44,849
core and dotnet are kind of all really

172
00:09:40,350 --> 00:09:48,240
they are tightly integrated so you're

173
00:09:44,850 --> 00:09:51,930
kind of using variants of more or less

174
00:09:48,240 --> 00:09:54,660
the same thing so if you're gonna delve

175
00:09:51,930 --> 00:09:58,819
into that just be aware that those

176
00:09:54,660 --> 00:10:01,680
technologies are all related in Windows

177
00:09:58,820 --> 00:10:05,970
it's a little harder to find information

178
00:10:01,680 --> 00:10:08,910
for this on Linux Linux is old-school

179
00:10:05,970 --> 00:10:13,110
its file based files happy files for

180
00:10:08,910 --> 00:10:15,449
everything right so Linux kind of

181
00:10:13,110 --> 00:10:18,140
doesn't give a damn about Windows stuff

182
00:10:15,450 --> 00:10:20,400
but as you've seen like some really

183
00:10:18,140 --> 00:10:22,920
interesting changes especially as

184
00:10:20,400 --> 00:10:24,930
Microsoft and last well all of those

185
00:10:22,920 --> 00:10:26,280
vendors are starting to work together in

186
00:10:24,930 --> 00:10:30,000
ways that we haven't seen before

187
00:10:26,280 --> 00:10:33,709
I mean Microsoft bought github right who

188
00:10:30,000 --> 00:10:33,710
would have seen that coming 15 years ago

189
00:10:39,960 --> 00:10:46,260
so on Mac some information I could find

190
00:10:43,610 --> 00:10:48,029
there you there are some people using

191
00:10:46,260 --> 00:10:50,970
open management infrastructure on there

192
00:10:48,029 --> 00:10:53,100
it's basically the free version of this

193
00:10:50,970 --> 00:10:56,600
and it's available on github there's

194
00:10:53,100 --> 00:11:00,750
actually quite a few tools available

195
00:10:56,600 --> 00:11:03,930
WMI based on on github for good or

196
00:11:00,750 --> 00:11:06,000
nefarious purposes so if you start

197
00:11:03,930 --> 00:11:09,149
looking into the stuff that's that's

198
00:11:06,000 --> 00:11:12,510
where you're gonna end up Linux Ubuntu

199
00:11:09,149 --> 00:11:14,730
has a lightweight version of it they

200
00:11:12,510 --> 00:11:19,170
called see mom but you can play around

201
00:11:14,730 --> 00:11:22,500
with or sublime is the other one

202
00:11:19,170 --> 00:11:25,649
Red Hat has open Vegas to be honest not

203
00:11:22,500 --> 00:11:27,540
really familiar with that and yeah this

204
00:11:25,649 --> 00:11:29,190
open management framework is an option

205
00:11:27,540 --> 00:11:31,709
on other under their women Linux

206
00:11:29,190 --> 00:11:38,190
machines so it is possible to play

207
00:11:31,709 --> 00:11:41,300
around with this on other systems so how

208
00:11:38,190 --> 00:11:43,860
do we play with it

209
00:11:41,300 --> 00:11:47,000
PowerShell directly is the recommended

210
00:11:43,860 --> 00:11:50,700
method so if you're not familiar as that

211
00:11:47,000 --> 00:11:52,200
get used to it you can with if you're

212
00:11:50,700 --> 00:11:55,920
not familiar as PowerShell you can do

213
00:11:52,200 --> 00:11:58,820
local targeting or in a lot of the

214
00:11:55,920 --> 00:12:01,050
commands you can do - computer name and

215
00:11:58,820 --> 00:12:05,490
access other computers from your own

216
00:12:01,050 --> 00:12:08,400
machine the.net system management name

217
00:12:05,490 --> 00:12:10,440
space because PowerShell and dotnet are

218
00:12:08,400 --> 00:12:16,110
so tight you can actually explicitly

219
00:12:10,440 --> 00:12:18,750
call dotnet things in PowerShell or if

220
00:12:16,110 --> 00:12:24,540
your dotnet programmer you can call it

221
00:12:18,750 --> 00:12:25,970
from dotnet obviously and you'll see a

222
00:12:24,540 --> 00:12:29,219
lot of examples

223
00:12:25,970 --> 00:12:32,430
historical examples of wmic which is the

224
00:12:29,220 --> 00:12:34,680
old kind of first version of this this

225
00:12:32,430 --> 00:12:37,589
stuff it's old-school

226
00:12:34,680 --> 00:12:39,660
it's unwieldly it can do unexpected

227
00:12:37,589 --> 00:12:43,649
things especially if you make

228
00:12:39,660 --> 00:12:47,430
assumptions so it might be okay for you

229
00:12:43,649 --> 00:12:48,720
but please try not to use it if you can

230
00:12:47,430 --> 00:12:51,060
help it

231
00:12:48,720 --> 00:12:53,160
one of the funny things I saw in their

232
00:12:51,060 --> 00:12:53,849
own environment is someone else had used

233
00:12:53,160 --> 00:12:58,290
it for

234
00:12:53,850 --> 00:13:01,410
uninstalling MSI packages and you can't

235
00:12:58,290 --> 00:13:03,810
really control you can't say no reboot

236
00:13:01,410 --> 00:13:05,250
if that happens so if the package

237
00:13:03,810 --> 00:13:06,989
figured it was gonna reboot then they

238
00:13:05,250 --> 00:13:10,949
would just go ahead and do that without

239
00:13:06,990 --> 00:13:12,360
any warning so as with anything else you

240
00:13:10,949 --> 00:13:20,569
probably want to use the newer tools if

241
00:13:12,360 --> 00:13:24,120
you can query methods and discovery so

242
00:13:20,569 --> 00:13:27,180
you got web and tests and available

243
00:13:24,120 --> 00:13:29,399
right on windows itself it's clunky but

244
00:13:27,180 --> 00:13:32,310
it's good if you want to test an actual

245
00:13:29,399 --> 00:13:36,449
query it's the queries for this are very

246
00:13:32,310 --> 00:13:40,518
sequel like MMC kind of sucks for

247
00:13:36,449 --> 00:13:44,519
browsing but it does have a use for

248
00:13:40,519 --> 00:13:47,990
especially figuring out security and

249
00:13:44,519 --> 00:13:50,180
groups and who has access to do what

250
00:13:47,990 --> 00:13:54,569
they said before

251
00:13:50,180 --> 00:13:56,008
jfg i just google it you are gonna find

252
00:13:54,569 --> 00:13:57,800
out if you have a problem to solve

253
00:13:56,009 --> 00:14:01,740
you're gonna find a lot of examples on

254
00:13:57,800 --> 00:14:03,779
Stack Exchange or github same with the

255
00:14:01,740 --> 00:14:12,209
hey scripting guy website and PowerShell

256
00:14:03,779 --> 00:14:14,189
org third-party tools WMI Explorer this

257
00:14:12,209 --> 00:14:19,349
is one I actually use a lot when I'm

258
00:14:14,189 --> 00:14:21,930
trying to get a sense of what else the

259
00:14:19,350 --> 00:14:25,649
capabilities are and just the breadth of

260
00:14:21,930 --> 00:14:28,019
what you can do with it it's very much

261
00:14:25,649 --> 00:14:31,199
like Windows Explorer and you can just

262
00:14:28,019 --> 00:14:35,910
open up the structure and go through and

263
00:14:31,199 --> 00:14:38,939
you can search in there if you find

264
00:14:35,910 --> 00:14:40,620
something in particular a class that

265
00:14:38,939 --> 00:14:42,779
you're interested in or a property of

266
00:14:40,620 --> 00:14:45,810
the class double click on it it'll

267
00:14:42,779 --> 00:14:47,339
actually generate the WL query for you

268
00:14:45,810 --> 00:14:50,160
which is pretty cool because then you

269
00:14:47,339 --> 00:14:52,829
can take that and use it in PowerShell

270
00:14:50,160 --> 00:14:56,639
or if you're doing something like a GPO

271
00:14:52,829 --> 00:14:59,399
you can slap it right in there sim

272
00:14:56,639 --> 00:15:02,370
studio used to be a thing but even

273
00:14:59,399 --> 00:15:03,720
though exists on TechNet the actual

274
00:15:02,370 --> 00:15:06,839
download for it seems to have

275
00:15:03,720 --> 00:15:07,740
disappeared recently so not sure what's

276
00:15:06,839 --> 00:15:11,640
going on with that

277
00:15:07,740 --> 00:15:18,870
but it was similar in some ways to W my

278
00:15:11,640 --> 00:15:20,819
Explorer here's some of the other

279
00:15:18,870 --> 00:15:24,450
goodies on github I was talking about

280
00:15:20,820 --> 00:15:26,490
there's an open asset logger in packet W

281
00:15:24,450 --> 00:15:29,780
my shell one of those is a proof of

282
00:15:26,490 --> 00:15:31,920
concept for accessing things from Linux

283
00:15:29,780 --> 00:15:33,360
and they've got a link there if you want

284
00:15:31,920 --> 00:15:35,520
to download the slides later I've got

285
00:15:33,360 --> 00:15:37,620
several links in here that are even in

286
00:15:35,520 --> 00:15:39,030
the speaker notes to help you on your

287
00:15:37,620 --> 00:15:45,240
way if you want to play around with this

288
00:15:39,030 --> 00:15:49,980
stuff so the structure itself what time

289
00:15:45,240 --> 00:15:51,930
do I have here guys you know the

290
00:15:49,980 --> 00:15:55,280
structure itself it's kind of like the

291
00:15:51,930 --> 00:15:58,050
twisted love child of a construct of

292
00:15:55,280 --> 00:16:02,370
object-oriented programming and a

293
00:15:58,050 --> 00:16:04,469
database don't get pedantic I mean I

294
00:16:02,370 --> 00:16:06,720
know we're all good at our jobs because

295
00:16:04,470 --> 00:16:10,350
we are pedantic it's not exactly a

296
00:16:06,720 --> 00:16:12,540
database yeah I know but if you think

297
00:16:10,350 --> 00:16:16,890
about it that way it's easier to grasp

298
00:16:12,540 --> 00:16:19,260
this being powershell net type of stuff

299
00:16:16,890 --> 00:16:24,270
any objects you're going to get back are

300
00:16:19,260 --> 00:16:27,390
all object oriented types so even if you

301
00:16:24,270 --> 00:16:28,829
get text back it's actually an object so

302
00:16:27,390 --> 00:16:30,330
keep that in mind when you're playing

303
00:16:28,830 --> 00:16:34,860
with it especially if you're coming from

304
00:16:30,330 --> 00:16:36,210
the UNIX world so you'll have a sim

305
00:16:34,860 --> 00:16:38,460
provider

306
00:16:36,210 --> 00:16:40,500
there's several sim providers but

307
00:16:38,460 --> 00:16:41,850
there's basically one you're essentially

308
00:16:40,500 --> 00:16:47,760
going to use for pretty much everything

309
00:16:41,850 --> 00:16:50,340
and they're divvied up into classes and

310
00:16:47,760 --> 00:16:51,810
then underneath that you have the

311
00:16:50,340 --> 00:16:54,450
instance of the class they have

312
00:16:51,810 --> 00:16:57,599
properties they have methods and they're

313
00:16:54,450 --> 00:17:03,600
in some in some cases they were

314
00:16:57,600 --> 00:17:06,810
extensible such as W my classes and W my

315
00:17:03,600 --> 00:17:09,720
query language sim query language filter

316
00:17:06,810 --> 00:17:12,210
filter query language are all ways you

317
00:17:09,720 --> 00:17:16,260
can use to query query this stuff I am

318
00:17:12,210 --> 00:17:17,819
going to show you examples oh hey

319
00:17:16,260 --> 00:17:19,740
there's a timer on my speaker notes that

320
00:17:17,819 --> 00:17:26,039
I never noticed before

321
00:17:19,740 --> 00:17:29,289
good so if you're wondering what all the

322
00:17:26,039 --> 00:17:31,330
W my list objects were you can do that

323
00:17:29,289 --> 00:17:34,899
you can grab them in the command line

324
00:17:31,330 --> 00:17:36,668
just with get W my object - list that's

325
00:17:34,899 --> 00:17:37,510
more or less a representation of what

326
00:17:36,669 --> 00:17:45,519
you get back

327
00:17:37,510 --> 00:17:48,010
how readable is that yeah so it'll give

328
00:17:45,519 --> 00:17:49,299
you instead of browsing in W my Explorer

329
00:17:48,010 --> 00:17:51,639
you it'll give you a list of these

330
00:17:49,299 --> 00:17:53,500
classes and being in PowerShell you can

331
00:17:51,639 --> 00:17:57,149
filter if you're looking for a specific

332
00:17:53,500 --> 00:17:57,149
name you can you can grab that two

333
00:17:57,419 --> 00:18:04,029
routes slash sim v2 is basically the

334
00:18:02,380 --> 00:18:07,210
namespace you're gonna see for stuff

335
00:18:04,029 --> 00:18:08,559
there's like 30 others but that's where

336
00:18:07,210 --> 00:18:10,210
you're gonna be a living most most of

337
00:18:08,559 --> 00:18:13,178
the time you can specify other

338
00:18:10,210 --> 00:18:19,299
namespaces but you're gonna be using

339
00:18:13,179 --> 00:18:22,330
this one so you can list the instance of

340
00:18:19,299 --> 00:18:25,019
a computer system with get W my I've

341
00:18:22,330 --> 00:18:26,590
just assigned it to a variable here

342
00:18:25,019 --> 00:18:29,769
funny thing

343
00:18:26,590 --> 00:18:32,620
PowerShell in particular assumes oh if

344
00:18:29,769 --> 00:18:34,809
you assigned a variable to something and

345
00:18:32,620 --> 00:18:37,178
then you go blah you know just give me

346
00:18:34,809 --> 00:18:41,080
that variable it'll show you like four

347
00:18:37,179 --> 00:18:43,120
things there's actually so it assumes oh

348
00:18:41,080 --> 00:18:46,210
this is probably just the stuff you want

349
00:18:43,120 --> 00:18:48,070
it's not gonna show you everything so if

350
00:18:46,210 --> 00:18:50,470
you actually do literally want to know

351
00:18:48,070 --> 00:18:53,049
everything that object holds you need to

352
00:18:50,470 --> 00:18:56,350
do something like pipe into format list

353
00:18:53,049 --> 00:18:58,330
star to give you everything so this is

354
00:18:56,350 --> 00:19:00,100
not an exact representation but this

355
00:18:58,330 --> 00:19:06,490
gives you the idea of what's in that

356
00:19:00,100 --> 00:19:09,158
type of variable so anything that DM TF

357
00:19:06,490 --> 00:19:13,120
is basically figured well in this case

358
00:19:09,159 --> 00:19:14,799
it's WMI so DMT DMT F and Microsoft have

359
00:19:13,120 --> 00:19:18,010
figured should belong to a computer

360
00:19:14,799 --> 00:19:20,799
workstation you know as the manufacturer

361
00:19:18,010 --> 00:19:24,580
the host name timezone they figure it is

362
00:19:20,799 --> 00:19:27,210
in there and that's that's how you can

363
00:19:24,580 --> 00:19:27,210
get that stuff

364
00:19:29,779 --> 00:19:35,369
and I was I saying earlier if you're

365
00:19:32,579 --> 00:19:38,940
going well wait this is a WMI thing what

366
00:19:35,369 --> 00:19:41,129
about sim well that's that's how you can

367
00:19:38,940 --> 00:19:43,709
get an idea of what sim object it

368
00:19:41,129 --> 00:19:49,199
inherits from so if you look at the

369
00:19:43,709 --> 00:19:53,399
derivation very property in the in the

370
00:19:49,200 --> 00:19:55,440
variable you can get list of what it's

371
00:19:53,399 --> 00:19:58,049
derived from and that way you would know

372
00:19:55,440 --> 00:20:03,359
if you want to make a similar query from

373
00:19:58,049 --> 00:20:04,799
sim you can do that you can also expand

374
00:20:03,359 --> 00:20:07,859
in PowerShell you can expand that

375
00:20:04,799 --> 00:20:11,700
property just piping it to select object

376
00:20:07,859 --> 00:20:13,799
- expand property derivation and it'll

377
00:20:11,700 --> 00:20:15,389
give you all those there's a lot more

378
00:20:13,799 --> 00:20:21,839
there in those brackets and then it

379
00:20:15,389 --> 00:20:24,508
appears another example sim with wpl

380
00:20:21,839 --> 00:20:26,428
query so if you're very used to sequel

381
00:20:24,509 --> 00:20:29,999
take queries and you want to live off of

382
00:20:26,429 --> 00:20:32,009
that this is how you can do it so you

383
00:20:29,999 --> 00:20:34,589
can go is to get sim instance - query

384
00:20:32,009 --> 00:20:37,589
and then just literally a sequel Lake

385
00:20:34,589 --> 00:20:39,479
sate statement and there's also another

386
00:20:37,589 --> 00:20:41,129
command below it in grey that would give

387
00:20:39,479 --> 00:20:49,349
you the exact same thing is what you see

388
00:20:41,129 --> 00:20:51,359
in blue there at the bottom last our

389
00:20:49,349 --> 00:20:54,089
minim may be that we're gonna deal with

390
00:20:51,359 --> 00:20:57,269
is you might have seen some MOF files

391
00:20:54,089 --> 00:20:59,729
floating around on systems that is

392
00:20:57,269 --> 00:21:03,509
related to sim it's basically a

393
00:20:59,729 --> 00:21:06,719
description of the structure of sim

394
00:21:03,509 --> 00:21:08,309
you'll also see it if you do any desired

395
00:21:06,719 --> 00:21:11,369
state configuration with PowerShell

396
00:21:08,309 --> 00:21:16,200
which seems to be the way PowerShell and

397
00:21:11,369 --> 00:21:19,439
everything is going it party that's DSC

398
00:21:16,200 --> 00:21:25,109
is Microsoft's version of automating

399
00:21:19,440 --> 00:21:27,769
automation so it's really this is 26

400
00:21:25,109 --> 00:21:27,769
minutes on here

401
00:21:29,299 --> 00:21:38,819
so yeah chef ansible puppet I'm gonna go

402
00:21:33,599 --> 00:21:41,218
faster so story time here - playing

403
00:21:38,819 --> 00:21:43,409
wallpaper - your org what resolutions do

404
00:21:41,219 --> 00:21:46,670
you need

405
00:21:43,410 --> 00:21:49,800
and yeah you can get that out of W mine

406
00:21:46,670 --> 00:21:52,260
so use W my Explorer I found an example

407
00:21:49,800 --> 00:21:54,480
online that wasn't quite the right thing

408
00:21:52,260 --> 00:21:59,700
but is able to browse just something

409
00:21:54,480 --> 00:22:01,620
that's similar there and then with that

410
00:21:59,700 --> 00:22:07,950
I was able to generates the crease for

411
00:22:01,620 --> 00:22:14,899
the W my objects and and values for the

412
00:22:07,950 --> 00:22:22,920
video controller wrote a script results

413
00:22:14,900 --> 00:22:24,810
my code solve the problem another thing

414
00:22:22,920 --> 00:22:26,490
to make note of is you'll find solutions

415
00:22:24,810 --> 00:22:28,050
online people say hey you need to use

416
00:22:26,490 --> 00:22:30,420
this query but in your own environment

417
00:22:28,050 --> 00:22:31,680
made it be different so if you want more

418
00:22:30,420 --> 00:22:40,490
details on that check out this slide

419
00:22:31,680 --> 00:22:59,640
later so let me say it again yep what

420
00:22:40,490 --> 00:23:03,030
you jerk have five minutes left okay yes

421
00:22:59,640 --> 00:23:05,220
so this is w my Explorer you can browse

422
00:23:03,030 --> 00:23:07,440
through here it's actually quite fun to

423
00:23:05,220 --> 00:23:11,280
play in here especially that second call

424
00:23:07,440 --> 00:23:13,200
where you see the green it is dog slow

425
00:23:11,280 --> 00:23:16,560
and when you run queries it tends to be

426
00:23:13,200 --> 00:23:17,970
dog slow - the only reason they could

427
00:23:16,560 --> 00:23:22,260
find online which I don't fully

428
00:23:17,970 --> 00:23:26,610
understand it's because of the RPC calls

429
00:23:22,260 --> 00:23:29,129
and it does marshalling for giving stuff

430
00:23:26,610 --> 00:23:33,120
back so to numerate everything takes a

431
00:23:29,130 --> 00:23:36,450
long time but that's kind of a good case

432
00:23:33,120 --> 00:23:38,729
for a practice of making sure that if

433
00:23:36,450 --> 00:23:41,040
you do a query on something get the

434
00:23:38,730 --> 00:23:42,780
minimum amount of data you need first

435
00:23:41,040 --> 00:23:44,280
and then filter from there if you have

436
00:23:42,780 --> 00:23:47,250
to is your query you don't want to like

437
00:23:44,280 --> 00:23:49,139
grab a huge object of something and then

438
00:23:47,250 --> 00:23:56,210
go from there cuz because that would be

439
00:23:49,140 --> 00:23:56,210
a lot longer we already went over this

440
00:23:56,930 --> 00:24:03,060
so yeah that's win32 video controller

441
00:24:01,080 --> 00:24:05,909
that had some pretty cool properties to

442
00:24:03,060 --> 00:24:08,159
browse in there it tells you if you had

443
00:24:05,910 --> 00:24:10,200
an inventory system your inventory

444
00:24:08,160 --> 00:24:11,940
probably tells you the make and model of

445
00:24:10,200 --> 00:24:14,010
your monitor or you know maybe some

446
00:24:11,940 --> 00:24:16,290
other stuff but it probably doesn't tell

447
00:24:14,010 --> 00:24:17,879
you how many monitors someone has

448
00:24:16,290 --> 00:24:19,770
attached in what resolution they're

449
00:24:17,880 --> 00:24:21,570
using so if you had something like

450
00:24:19,770 --> 00:24:24,120
wallpaper you'd want to deploy you want

451
00:24:21,570 --> 00:24:26,250
to go well what resolution are people

452
00:24:24,120 --> 00:24:28,830
using and that can give you valuable

453
00:24:26,250 --> 00:24:43,710
information and insight to other things

454
00:24:28,830 --> 00:24:45,600
going in in your org no yeah so this is

455
00:24:43,710 --> 00:24:50,400
basically the results of my script which

456
00:24:45,600 --> 00:24:52,050
I put in here if you get data like this

457
00:24:50,400 --> 00:24:54,960
if you think about your organ this way

458
00:24:52,050 --> 00:24:57,750
you can go well why does this guy have

459
00:24:54,960 --> 00:24:59,550
like five monitors is he poaching stuff

460
00:24:57,750 --> 00:25:02,190
from somewhere or is he using multiple

461
00:24:59,550 --> 00:25:03,300
computers is he being naughty the other

462
00:25:02,190 --> 00:25:09,030
thing this might give you an indication

463
00:25:03,300 --> 00:25:12,360
is how many users like some of us over

464
00:25:09,030 --> 00:25:13,590
40 might have a hard time seeing certain

465
00:25:12,360 --> 00:25:16,050
screens they use a lower resolution

466
00:25:13,590 --> 00:25:19,020
maybe either a group you should target

467
00:25:16,050 --> 00:25:24,060
for telling about ctrl + + - and web

468
00:25:19,020 --> 00:25:27,350
browsers so there's other ways to to use

469
00:25:24,060 --> 00:25:27,350
this data you might not have thought of

470
00:25:31,220 --> 00:25:35,640
this is for your use later I do not

471
00:25:33,750 --> 00:25:37,440
expect you to read this but this is my

472
00:25:35,640 --> 00:25:44,820
entire script of grabbing all the

473
00:25:37,440 --> 00:25:48,930
monitor resolutions in our org this we

474
00:25:44,820 --> 00:25:52,230
already went over now we get to the fun

475
00:25:48,930 --> 00:25:54,960
stuff so you need to think about this

476
00:25:52,230 --> 00:25:57,210
again like before I said WMI is

477
00:25:54,960 --> 00:25:59,400
essentially collection of anything and

478
00:25:57,210 --> 00:26:01,680
everything attached to or associated

479
00:25:59,400 --> 00:26:06,500
with your computer and give it another

480
00:26:01,680 --> 00:26:09,509
thought it's a collection of everything

481
00:26:06,500 --> 00:26:12,509
so in the wrong hand

482
00:26:09,509 --> 00:26:14,759
it can do you know it definitely for

483
00:26:12,509 --> 00:26:17,730
recon it's giving you everything if you

484
00:26:14,759 --> 00:26:23,240
have access to it not only that a lot of

485
00:26:17,730 --> 00:26:24,630
the objects and WMI and sim they have

486
00:26:23,240 --> 00:26:31,250
methods

487
00:26:24,630 --> 00:26:34,259
- such as dot delete or dot create so

488
00:26:31,250 --> 00:26:36,450
considering think of anything on your

489
00:26:34,259 --> 00:26:40,919
machine where evil could happen if you

490
00:26:36,450 --> 00:26:43,409
created something or deleted it yeah

491
00:26:40,919 --> 00:26:53,100
that's that that might be a little

492
00:26:43,409 --> 00:26:58,440
touchy hackers love fo WI you do recon

493
00:26:53,100 --> 00:27:00,719
for services processes so you can filter

494
00:26:58,440 --> 00:27:07,889
that get the owners of the process you

495
00:27:00,720 --> 00:27:12,529
can see who they're running as all your

496
00:27:07,889 --> 00:27:17,928
startup commands all your network shares

497
00:27:12,529 --> 00:27:24,029
stuff in your computer system and

498
00:27:17,929 --> 00:27:26,070
because you can call other you can query

499
00:27:24,029 --> 00:27:30,169
other workstations other than a one yarn

500
00:27:26,070 --> 00:27:34,549
are on directly that's a method of

501
00:27:30,169 --> 00:27:34,549
leveraging one system to access another

502
00:27:37,100 --> 00:27:44,360
outright execution so you can create

503
00:27:40,190 --> 00:27:47,309
whatever and invoke - sim method and

504
00:27:44,360 --> 00:27:54,408
call basically whatever the account

505
00:27:47,309 --> 00:27:57,629
you're running ass has access to so yeah

506
00:27:54,409 --> 00:28:02,629
especially you know remotely you have

507
00:27:57,629 --> 00:28:02,629
lateral movement here so that's naughty

508
00:28:04,610 --> 00:28:09,719
another way of creating a process

509
00:28:06,960 --> 00:28:11,159
actually I came upon this when I was

510
00:28:09,720 --> 00:28:17,100
researching this I'm not familiar with

511
00:28:11,159 --> 00:28:19,080
this type of calling but you know it's

512
00:28:17,100 --> 00:28:20,879
it's a huge thing you can really do

513
00:28:19,080 --> 00:28:23,899
unexpected things and things you've

514
00:28:20,879 --> 00:28:23,899
never seen before with it

515
00:28:24,269 --> 00:28:32,409
next slides my favorite tweekaz cpu fan

516
00:28:29,860 --> 00:28:36,428
there is a class if your motherboard is

517
00:28:32,409 --> 00:28:38,919
capable of WMI and sim stuff there's a

518
00:28:36,429 --> 00:28:41,200
win32 fan class and you can set the

519
00:28:38,919 --> 00:28:46,720
desired speed what would happen if you

520
00:28:41,200 --> 00:28:49,779
set the desired speed to zero yeah so

521
00:28:46,720 --> 00:28:57,789
you can do a lot of evil with this that

522
00:28:49,779 --> 00:29:00,730
would be unfortunate so that's nice now

523
00:28:57,789 --> 00:29:09,100
what how do we protect about this

524
00:29:00,730 --> 00:29:11,230
protect against this right you do want

525
00:29:09,100 --> 00:29:13,178
to use PowerShell remoting where you can

526
00:29:11,230 --> 00:29:18,730
especially if you can with certificates

527
00:29:13,179 --> 00:29:21,490
if your IT crew does thing does things

528
00:29:18,730 --> 00:29:24,509
in a specified expected way as securely

529
00:29:21,490 --> 00:29:26,980
as possible then you know any sort of

530
00:29:24,509 --> 00:29:28,539
instant and event monitoring you know to

531
00:29:26,980 --> 00:29:31,289
look for the other stuff and you know

532
00:29:28,539 --> 00:29:34,690
that stuff that you guys aren't doing or

533
00:29:31,289 --> 00:29:36,690
you know maybe you are doing and you

534
00:29:34,690 --> 00:29:40,740
need to yell at one of your teammates

535
00:29:36,690 --> 00:29:43,659
nicely of course take care with your

536
00:29:40,740 --> 00:29:47,249
username and authentication avoid using

537
00:29:43,659 --> 00:29:52,299
them in scripts use the credential

538
00:29:47,249 --> 00:29:55,179
option when you when you do stuff so use

539
00:29:52,299 --> 00:29:56,799
credentialed dollar sign creds it'll pop

540
00:29:55,179 --> 00:30:01,720
open a window for you to enter in your

541
00:29:56,799 --> 00:30:04,869
credentials securely it's secure ish

542
00:30:01,720 --> 00:30:08,350
there's technically ways to grab these

543
00:30:04,869 --> 00:30:11,139
credentials with dotnet runtime calls so

544
00:30:08,350 --> 00:30:12,998
write in the runtime you can call

545
00:30:11,139 --> 00:30:15,998
something with dotnet and grab these

546
00:30:12,999 --> 00:30:20,830
values but it's better than the

547
00:30:15,999 --> 00:30:24,190
alternative we're gonna assume and we

548
00:30:20,830 --> 00:30:26,710
should be assuming that you're using if

549
00:30:24,190 --> 00:30:28,330
you want to do to do this as an

550
00:30:26,710 --> 00:30:31,330
administrator you want to use a local

551
00:30:28,330 --> 00:30:34,509
admin account not a global one where

552
00:30:31,330 --> 00:30:35,919
possible and those accounts should have

553
00:30:34,509 --> 00:30:38,290
different passwords you

554
00:30:35,920 --> 00:30:41,530
have the same local administrator

555
00:30:38,290 --> 00:30:43,960
password for every machine so use laps

556
00:30:41,530 --> 00:30:46,149
and set that up in your or gif you take

557
00:30:43,960 --> 00:30:51,400
nothing else away from this this talk

558
00:30:46,150 --> 00:30:54,250
today just please use laps if you do use

559
00:30:51,400 --> 00:30:56,170
the credential a variable you should

560
00:30:54,250 --> 00:30:59,410
destroy it as soon as you don't need it

561
00:30:56,170 --> 00:31:02,350
so get rid of it remove the variables

562
00:30:59,410 --> 00:31:07,260
set it to null standard good programming

563
00:31:02,350 --> 00:31:07,260
practice right for anything sensitive

564
00:31:09,090 --> 00:31:18,399
Ascenta Kate with Kerberos you can set

565
00:31:13,720 --> 00:31:22,570
on specific accounts for the account use

566
00:31:18,400 --> 00:31:25,680
Kerberos AES of some value encryption

567
00:31:22,570 --> 00:31:28,270
and you should do that where you can

568
00:31:25,680 --> 00:31:31,480
think it doesn't work with windows vista

569
00:31:28,270 --> 00:31:35,290
and earlier hopefully you're beyond that

570
00:31:31,480 --> 00:31:37,090
but just be aware to set some of this

571
00:31:35,290 --> 00:31:40,230
stuff up you're going to need to do some

572
00:31:37,090 --> 00:31:42,429
legwork this is not a comprehensive

573
00:31:40,230 --> 00:31:44,080
step-by-step of what you need to do

574
00:31:42,430 --> 00:31:45,960
right I'm just giving you guys ideas

575
00:31:44,080 --> 00:31:54,939
that you folks you people you ladies

576
00:31:45,960 --> 00:31:58,770
sorry you CSS so when connecting with WS

577
00:31:54,940 --> 00:32:01,240
men so there's this SSL option and

578
00:31:58,770 --> 00:32:05,139
that's how you set up so I've got the

579
00:32:01,240 --> 00:32:07,810
example there yeah you you set a

580
00:32:05,140 --> 00:32:11,280
variable to nuisance assets in session

581
00:32:07,810 --> 00:32:13,750
they use SSL and in the new sim session

582
00:32:11,280 --> 00:32:18,040
one of the tags you put on it is your

583
00:32:13,750 --> 00:32:20,800
session option when you're using decom

584
00:32:18,040 --> 00:32:23,740
RPC instead so when you're using W my

585
00:32:20,800 --> 00:32:27,580
queries are P is C is encrypted by

586
00:32:23,740 --> 00:32:29,530
default but if you explicitly explicitly

587
00:32:27,580 --> 00:32:32,520
want to make sure it is you should use -

588
00:32:29,530 --> 00:32:32,520
packet privacy

589
00:32:36,220 --> 00:32:40,509
so that MMC console that's available in

590
00:32:39,700 --> 00:32:44,049
Windows

591
00:32:40,509 --> 00:32:46,059
there's WMI provider in there and that's

592
00:32:44,049 --> 00:32:50,379
where you can set up other security

593
00:32:46,059 --> 00:32:51,100
values you can see the guides at that

594
00:32:50,379 --> 00:32:53,860
length there

595
00:32:51,100 --> 00:32:56,230
Microsoft has gotten pretty good making

596
00:32:53,860 --> 00:32:59,408
good use of github so a lot of their

597
00:32:56,230 --> 00:33:03,149
stuff we had only see with Java when it

598
00:32:59,409 --> 00:33:03,149
came out where they'd give away their

599
00:33:03,450 --> 00:33:12,309
what's the word infrastructure API

600
00:33:09,519 --> 00:33:14,769
basically for free Microsoft is doing

601
00:33:12,309 --> 00:33:18,668
that so they're getting pretty good at

602
00:33:14,769 --> 00:33:20,350
detailing these things and you want to

603
00:33:18,669 --> 00:33:22,720
verify that the correct your users and

604
00:33:20,350 --> 00:33:30,250
groups have access so that's what you

605
00:33:22,720 --> 00:33:33,460
can use that MMC console for and again

606
00:33:30,250 --> 00:33:36,970
apologies to the writers of Good Omens

607
00:33:33,460 --> 00:33:39,340
and you can think of WMI as from the

608
00:33:36,970 --> 00:33:43,389
book an angel who did so much as fall as

609
00:33:39,340 --> 00:33:46,149
santur vaguely downwards so that's w my

610
00:33:43,389 --> 00:33:48,879
for you sim and i hope i've given you

611
00:33:46,149 --> 00:33:50,850
guys you folks some takeaways to play

612
00:33:48,879 --> 00:33:54,000
around with and get comfortable with and

613
00:33:50,850 --> 00:34:01,429
that's it for today

614
00:33:54,000 --> 00:34:01,430
[Applause]

