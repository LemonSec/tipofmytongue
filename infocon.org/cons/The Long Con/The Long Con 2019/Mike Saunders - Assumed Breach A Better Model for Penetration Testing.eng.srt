1
00:00:08,710 --> 00:00:16,010
thank you yes it's been I think this is

2
00:00:13,460 --> 00:00:18,980
my fourth b-sides and long con so I'm

3
00:00:16,010 --> 00:00:23,230
pretty happy to be here as you mentioned

4
00:00:18,980 --> 00:00:26,300
I'm Mike Saunders I work for red siege I

5
00:00:23,230 --> 00:00:30,410
guess I do represent my employer while

6
00:00:26,300 --> 00:00:32,509
I'm here so whatever I was too lazy to

7
00:00:30,410 --> 00:00:34,489
make a slide back in Tim had these

8
00:00:32,509 --> 00:00:37,430
wonderful templates so I just used his

9
00:00:34,489 --> 00:00:39,860
so it says red seeds everywhere speaking

10
00:00:37,430 --> 00:00:42,890
of that if you want the slides get away

11
00:00:39,860 --> 00:00:46,190
from the speaker ready right here red

12
00:00:42,890 --> 00:00:48,530
siege comm slash ABM you can download a

13
00:00:46,190 --> 00:00:50,809
copy of the slides red siege comm slash

14
00:00:48,530 --> 00:00:52,579
ABM I will put the URL up at the end of

15
00:00:50,810 --> 00:00:55,730
the talk I will tweet it out afterwards

16
00:00:52,579 --> 00:00:59,149
I'm hard water hacker and you can get a

17
00:00:55,730 --> 00:01:00,860
copy of the slides so I'm principal

18
00:00:59,149 --> 00:01:02,680
consultant at red siege I've been around

19
00:01:00,860 --> 00:01:06,799
a while I do some stuff I have fun

20
00:01:02,680 --> 00:01:09,170
enough about me why am I here I wanted

21
00:01:06,799 --> 00:01:10,790
to tell you that as a pen tester I think

22
00:01:09,170 --> 00:01:12,890
pan testing is broken what we do as a

23
00:01:10,790 --> 00:01:15,020
traditional internal pen test is just

24
00:01:12,890 --> 00:01:19,220
it's broken it doesn't work what do we

25
00:01:15,020 --> 00:01:21,560
do we take an SS scanner that we have on

26
00:01:19,220 --> 00:01:23,060
probably's Dropbox with Kali or

27
00:01:21,560 --> 00:01:24,710
something on it and we drop it into

28
00:01:23,060 --> 00:01:26,659
customers Network we plug it into their

29
00:01:24,710 --> 00:01:28,669
network we've run necess we have all

30
00:01:26,659 --> 00:01:30,140
these noisy scans then we fir Metasploit

31
00:01:28,670 --> 00:01:31,640
and we start lobbing exploits across

32
00:01:30,140 --> 00:01:33,830
network and catching these shells and

33
00:01:31,640 --> 00:01:35,479
it's great and don't get me wrong I'm

34
00:01:33,830 --> 00:01:37,280
not saying there's not value in doing

35
00:01:35,479 --> 00:01:42,049
that there is definitely value in doing

36
00:01:37,280 --> 00:01:44,180
that however real-world attackers are

37
00:01:42,049 --> 00:01:46,490
not coming into your organization in

38
00:01:44,180 --> 00:01:48,159
most organizations like that is in some

39
00:01:46,490 --> 00:01:50,420
people's threat models but in most

40
00:01:48,159 --> 00:01:52,250
people aren't coming and dropping a box

41
00:01:50,420 --> 00:01:54,290
on the network and if they are they

42
00:01:52,250 --> 00:01:58,189
certainly aren't running necess cans and

43
00:01:54,290 --> 00:01:59,360
things like that right so so we're we're

44
00:01:58,189 --> 00:02:00,470
helping our customers fix

45
00:01:59,360 --> 00:02:01,909
vulnerabilities but we're not

46
00:02:00,470 --> 00:02:03,920
necessarily doing a good job of

47
00:02:01,909 --> 00:02:08,119
preparing them for attacks that they're

48
00:02:03,920 --> 00:02:09,709
likely to face out in the real world on

49
00:02:08,119 --> 00:02:12,140
the flip side of the coin from the

50
00:02:09,709 --> 00:02:14,540
internal internal pentest we have the

51
00:02:12,140 --> 00:02:17,000
red team how many people have had their

52
00:02:14,540 --> 00:02:18,709
their seaso or some management type

53
00:02:17,000 --> 00:02:21,590
person like I want to get a red two

54
00:02:18,709 --> 00:02:23,840
anyone yeah yeah they don't want a red

55
00:02:21,590 --> 00:02:27,079
team because like if be a little

56
00:02:23,840 --> 00:02:29,150
pedantic but a real red team is team

57
00:02:27,079 --> 00:02:30,920
it's not like one person like it's a

58
00:02:29,150 --> 00:02:33,920
it's a team of a bunch of people that

59
00:02:30,920 --> 00:02:36,409
have different disciplines they have

60
00:02:33,920 --> 00:02:38,388
different skill sets and you've got a

61
00:02:36,409 --> 00:02:40,310
shell Sherpa and you have your initial

62
00:02:38,389 --> 00:02:42,019
access person and you have person that's

63
00:02:40,310 --> 00:02:43,040
really good than this thing the person

64
00:02:42,019 --> 00:02:45,409
is really good in this thing and they

65
00:02:43,040 --> 00:02:47,929
work together they have redundant skill

66
00:02:45,409 --> 00:02:49,569
sets and they analyze the target for a

67
00:02:47,930 --> 00:02:53,299
long period of time and then figure out

68
00:02:49,569 --> 00:02:57,048
the appropriate way to gain access to

69
00:02:53,299 --> 00:02:58,939
that target based on that target combine

70
00:02:57,049 --> 00:03:01,519
that with what we're doing asking the

71
00:02:58,939 --> 00:03:03,260
customer like analyzing the customers

72
00:03:01,519 --> 00:03:06,980
environments saying what's in their

73
00:03:03,260 --> 00:03:08,989
threat model and sometimes the easiest

74
00:03:06,980 --> 00:03:11,060
thing to do in a red team is to throw a

75
00:03:08,989 --> 00:03:12,709
brick through the window and get in

76
00:03:11,060 --> 00:03:14,269
right and then you ask the customer like

77
00:03:12,709 --> 00:03:15,139
okay well it's a red team can I throw a

78
00:03:14,269 --> 00:03:18,139
brick through your window and they're

79
00:03:15,139 --> 00:03:21,560
like no okay can I take the door off the

80
00:03:18,139 --> 00:03:23,659
hinges like no no like yeah we expect

81
00:03:21,560 --> 00:03:26,540
you to fish you know and then you'll get

82
00:03:23,659 --> 00:03:29,418
in that way it was like oh okay so you

83
00:03:26,540 --> 00:03:31,340
just want like an external pen test or a

84
00:03:29,419 --> 00:03:34,280
fishing engagement you know that's not a

85
00:03:31,340 --> 00:03:37,069
red team right so red team's take a long

86
00:03:34,280 --> 00:03:39,319
time they're expensive because they take

87
00:03:37,069 --> 00:03:43,159
a long time and it takes a lot of

88
00:03:39,319 --> 00:03:45,198
analysis and then you go low and slow

89
00:03:43,159 --> 00:03:47,780
you're trying to not get caught most of

90
00:03:45,199 --> 00:03:49,549
the time as a consultant most of us

91
00:03:47,780 --> 00:03:51,829
don't have the luxury of having a

92
00:03:49,549 --> 00:03:53,780
limited amount of time we're like okay

93
00:03:51,829 --> 00:03:56,239
we got two weeks to do this red team's

94
00:03:53,780 --> 00:03:58,970
so that means we have to have a fast

95
00:03:56,239 --> 00:04:01,699
pace we're noisier we're more likely to

96
00:03:58,970 --> 00:04:03,139
get caught so it's expensive and it's

97
00:04:01,699 --> 00:04:08,870
it's probably not the way the customer

98
00:04:03,139 --> 00:04:11,720
wants to go assumed watch assumed what

99
00:04:08,870 --> 00:04:13,340
so the topic is assumed breach a better

100
00:04:11,720 --> 00:04:16,279
model for temp and testing how many have

101
00:04:13,340 --> 00:04:17,780
heard of the term assumed breech we got

102
00:04:16,279 --> 00:04:19,638
a couple people so for the people who

103
00:04:17,779 --> 00:04:21,918
didn't raise your hands what we're

104
00:04:19,639 --> 00:04:24,050
talking about is the assumption that an

105
00:04:21,918 --> 00:04:27,169
organization has already been breached

106
00:04:24,050 --> 00:04:28,909
assume that they've been breached so

107
00:04:27,169 --> 00:04:31,430
it's kind of like doing a red team

108
00:04:28,909 --> 00:04:32,280
except we are just going to accept the

109
00:04:31,430 --> 00:04:34,870
fact

110
00:04:32,280 --> 00:04:36,818
we already got in let's forget about the

111
00:04:34,870 --> 00:04:39,430
initial access factor Wow

112
00:04:36,819 --> 00:04:41,860
whether that is phishing or whatever it

113
00:04:39,430 --> 00:04:45,159
is let's forget about that let's start

114
00:04:41,860 --> 00:04:48,400
inside the organization with a

115
00:04:45,159 --> 00:04:50,229
representative computer which I'll talk

116
00:04:48,400 --> 00:04:52,359
about here in a minute but let's start

117
00:04:50,229 --> 00:04:55,479
inside the organization and see where we

118
00:04:52,360 --> 00:04:58,360
can go with that access but we won't

119
00:04:55,479 --> 00:04:59,830
operate like a regular Network pentest

120
00:04:58,360 --> 00:05:01,360
because we're not doing scans and

121
00:04:59,830 --> 00:05:03,159
launching exploits for the most part and

122
00:05:01,360 --> 00:05:06,550
I will talk about through this talk what

123
00:05:03,159 --> 00:05:08,830
we're doing we have two models that we

124
00:05:06,550 --> 00:05:11,110
use two ish because there's a lot of

125
00:05:08,830 --> 00:05:13,030
variants but we have the malicious user

126
00:05:11,110 --> 00:05:15,819
model someone who is an employee of the

127
00:05:13,030 --> 00:05:17,500
company and wants to cause damage for

128
00:05:15,819 --> 00:05:19,180
instance a network administrator for the

129
00:05:17,500 --> 00:05:20,590
city of San Francisco that found out his

130
00:05:19,180 --> 00:05:22,599
jobs going away and he changed the

131
00:05:20,590 --> 00:05:24,429
passwords to all the Cisco devices in

132
00:05:22,599 --> 00:05:26,650
the network and then locked the city out

133
00:05:24,430 --> 00:05:29,380
of the network that is a malicious user

134
00:05:26,650 --> 00:05:31,960
model then we have the compromised user

135
00:05:29,380 --> 00:05:34,060
that's something that we test more often

136
00:05:31,960 --> 00:05:36,280
and that is the user who has clicked on

137
00:05:34,060 --> 00:05:39,159
a link and either given up their

138
00:05:36,280 --> 00:05:42,669
credentials or have executed a payload

139
00:05:39,159 --> 00:05:44,229
and both of these models we want a

140
00:05:42,669 --> 00:05:46,180
representative workstation with a

141
00:05:44,229 --> 00:05:49,210
representative users used for the test

142
00:05:46,180 --> 00:05:51,190
and what do I mean by that so I've got a

143
00:05:49,210 --> 00:05:53,469
Lenovo laptop here how many know about

144
00:05:51,190 --> 00:05:55,599
the local privilege escalation in lenovo

145
00:05:53,469 --> 00:05:58,060
laptops anyone there's a couple people

146
00:05:55,599 --> 00:06:01,300
all right so and for those of you don't

147
00:05:58,060 --> 00:06:03,789
know Lenovo think Vantage software has

148
00:06:01,300 --> 00:06:06,130
this vulnerability that if you drop a

149
00:06:03,789 --> 00:06:09,520
certain file in a certain location ten

150
00:06:06,130 --> 00:06:11,650
minutes after the system boots Lenovo

151
00:06:09,520 --> 00:06:13,750
does some magic moving some files around

152
00:06:11,650 --> 00:06:15,789
and it does that as system so you now

153
00:06:13,750 --> 00:06:18,520
have privilege escalation on the machine

154
00:06:15,789 --> 00:06:20,919
so if every one of the organization has

155
00:06:18,520 --> 00:06:22,599
one of these Lenovo's and by the way the

156
00:06:20,919 --> 00:06:24,068
lenovo is helpful fix for that the way

157
00:06:22,599 --> 00:06:27,039
they actually got rid of that

158
00:06:24,069 --> 00:06:28,569
vulnerability was to retroactively Lee

159
00:06:27,039 --> 00:06:29,889
announced the end-of-life they came out

160
00:06:28,569 --> 00:06:31,840
with announcement that said the software

161
00:06:29,889 --> 00:06:32,880
was end-of-life six months ago so that

162
00:06:31,840 --> 00:06:36,429
was their fix

163
00:06:32,880 --> 00:06:37,960
so if users every user in the company

164
00:06:36,430 --> 00:06:41,740
has one of these machines and you give

165
00:06:37,960 --> 00:06:43,388
me a VM to do the test on I can I won't

166
00:06:41,740 --> 00:06:44,990
have the same environment I won't be

167
00:06:43,389 --> 00:06:47,030
able to demonstrate that imp

168
00:06:44,990 --> 00:06:50,810
I may still get you no privilege

169
00:06:47,030 --> 00:06:52,880
escalation but I may not have that same

170
00:06:50,810 --> 00:06:55,580
thing with representative user if I'm

171
00:06:52,880 --> 00:06:58,610
supposed to be simulating what happens

172
00:06:55,580 --> 00:07:00,940
when Jane in accounting executes the

173
00:06:58,610 --> 00:07:03,979
payload or submits her credentials I

174
00:07:00,940 --> 00:07:05,719
need to have the same kind of access

175
00:07:03,979 --> 00:07:08,780
that Jane has so I need to be in the

176
00:07:05,720 --> 00:07:10,699
same groups on her machine I need to

177
00:07:08,780 --> 00:07:12,590
have the same software because there may

178
00:07:10,699 --> 00:07:14,270
be information disclosures in that

179
00:07:12,590 --> 00:07:16,638
software configuration that give me

180
00:07:14,270 --> 00:07:19,520
credentials allow lateral movement or

181
00:07:16,639 --> 00:07:22,130
something else i may have privilege

182
00:07:19,520 --> 00:07:24,409
escalation opportunities so i need to

183
00:07:22,130 --> 00:07:27,680
have the same level of access and the

184
00:07:24,410 --> 00:07:29,330
same kind of from an ad perspective and

185
00:07:27,680 --> 00:07:31,280
the same kind of machine that a normal

186
00:07:29,330 --> 00:07:34,849
user will have so otherwise it's going

187
00:07:31,280 --> 00:07:37,638
to impact my test this is completely

188
00:07:34,849 --> 00:07:40,490
unrelated but during our test domain

189
00:07:37,639 --> 00:07:42,470
admin is not the goal it's just a tool

190
00:07:40,490 --> 00:07:44,870
we don't plant our flag there and say we

191
00:07:42,470 --> 00:07:46,280
won and walk away that's just a tool to

192
00:07:44,870 --> 00:07:48,949
get where we're going and I'll talk

193
00:07:46,280 --> 00:07:51,409
about that more you know in the

194
00:07:48,949 --> 00:07:52,699
compromised use your model we're

195
00:07:51,409 --> 00:07:54,289
simulating what happens when a user

196
00:07:52,699 --> 00:07:56,289
clicks on a payload most of the time

197
00:07:54,289 --> 00:07:58,039
sometimes we also do it with what gives

198
00:07:56,289 --> 00:08:00,919
credentials and I'll talk about how that

199
00:07:58,039 --> 00:08:02,539
works in a little bit normally we're

200
00:08:00,919 --> 00:08:04,130
having the user execute some kind of

201
00:08:02,539 --> 00:08:06,800
custom payload for us where that's

202
00:08:04,130 --> 00:08:09,889
cobalt strike or some other c2 type of

203
00:08:06,800 --> 00:08:12,320
framework and once we have that access

204
00:08:09,889 --> 00:08:17,000
all of our testing takes place over that

205
00:08:12,320 --> 00:08:19,759
c2 framework and we will pivot to remote

206
00:08:17,000 --> 00:08:22,820
access through through like VPN for

207
00:08:19,759 --> 00:08:24,740
instance if it suits our needs no

208
00:08:22,820 --> 00:08:27,020
another way of doing this same thing is

209
00:08:24,740 --> 00:08:29,479
shipping have a customer giving you a

210
00:08:27,020 --> 00:08:31,729
laptop that you can use actually one of

211
00:08:29,479 --> 00:08:33,319
their laptops and you start and it's

212
00:08:31,729 --> 00:08:35,088
just a slightly different starting point

213
00:08:33,320 --> 00:08:40,610
we can do both of those and we do both

214
00:08:35,089 --> 00:08:42,380
of those as I said earlier the goal of

215
00:08:40,610 --> 00:08:45,290
this is to demonstrate what happens when

216
00:08:42,380 --> 00:08:48,350
a user gets compromised so we start on

217
00:08:45,290 --> 00:08:50,839
their machine we've got that laptop or

218
00:08:48,350 --> 00:08:54,589
VPN an RDP to a workstation or they

219
00:08:50,839 --> 00:08:57,660
execute a payload for us and we want to

220
00:08:54,589 --> 00:09:00,090
see where can we go with that

221
00:08:57,660 --> 00:09:01,829
access if we're doing the model where

222
00:09:00,090 --> 00:09:03,690
we're not doing c2 as a start we're

223
00:09:01,830 --> 00:09:05,100
actually starting with a machine we're

224
00:09:03,690 --> 00:09:07,020
starting with whatever tools are

225
00:09:05,100 --> 00:09:09,650
available or what can be loaded we are

226
00:09:07,020 --> 00:09:11,939
not asking the customer to like give us

227
00:09:09,650 --> 00:09:13,380
local admin access and make sure that

228
00:09:11,940 --> 00:09:15,390
PowerShell is enabled and we have all

229
00:09:13,380 --> 00:09:17,280
these tools we will have whatever

230
00:09:15,390 --> 00:09:20,550
chaining accounting has on our machine

231
00:09:17,280 --> 00:09:23,010
at our disposal and then we can initiate

232
00:09:20,550 --> 00:09:27,990
c2 from that point if we think that it

233
00:09:23,010 --> 00:09:32,580
helps us so one question we have

234
00:09:27,990 --> 00:09:34,890
frequently is about a V or EDR should it

235
00:09:32,580 --> 00:09:38,000
be disabled on the initial access

236
00:09:34,890 --> 00:09:41,400
workstation or should it not be disabled

237
00:09:38,000 --> 00:09:43,860
how many think you should be enabled how

238
00:09:41,400 --> 00:09:45,329
many things should be disabled how many

239
00:09:43,860 --> 00:09:47,600
think you should talk to the client find

240
00:09:45,330 --> 00:09:50,070
out what their goals are for the test

241
00:09:47,600 --> 00:09:53,910
because they're they're separate things

242
00:09:50,070 --> 00:09:56,580
right like I can start with a V and E D

243
00:09:53,910 --> 00:09:59,069
are enabled but I may not have a working

244
00:09:56,580 --> 00:10:01,350
bypass for AV and EDR when I start the

245
00:09:59,070 --> 00:10:05,550
test so now I'm spending customer

246
00:10:01,350 --> 00:10:07,620
dollars in in my time to try to figure

247
00:10:05,550 --> 00:10:10,740
out how to get past that AV or

248
00:10:07,620 --> 00:10:12,990
EDR so then how long do I do that do I

249
00:10:10,740 --> 00:10:15,120
have do I spend as long as it takes or

250
00:10:12,990 --> 00:10:17,520
do we say we'll spend a day doing it or

251
00:10:15,120 --> 00:10:18,990
we'll spend four hours doing it we

252
00:10:17,520 --> 00:10:21,030
talked to the customer find out what's

253
00:10:18,990 --> 00:10:23,430
important to them and they'll say

254
00:10:21,030 --> 00:10:25,230
sometimes I say we know that AV and EDR

255
00:10:23,430 --> 00:10:28,109
can be bypassed eventually so we will

256
00:10:25,230 --> 00:10:30,840
just whitelist it whitelist your payload

257
00:10:28,110 --> 00:10:32,850
on the first host in the first host only

258
00:10:30,840 --> 00:10:35,340
just so we can get the test started and

259
00:10:32,850 --> 00:10:38,010
any other machine we go to after that we

260
00:10:35,340 --> 00:10:39,960
have to contend with AV & EDR sometimes

261
00:10:38,010 --> 00:10:41,730
we start with it enabled and then we

262
00:10:39,960 --> 00:10:43,110
disable it after a period of time but we

263
00:10:41,730 --> 00:10:44,750
have those discussions with the client

264
00:10:43,110 --> 00:10:47,640
to figure that out

265
00:10:44,750 --> 00:10:50,130
now in the malicious user model it's

266
00:10:47,640 --> 00:10:53,420
pretty similar to what we're doing with

267
00:10:50,130 --> 00:10:55,740
a compromised user having a workstation

268
00:10:53,420 --> 00:10:57,660
we've got a workstation that we access

269
00:10:55,740 --> 00:11:00,300
either physically they ship it to us we

270
00:10:57,660 --> 00:11:01,920
already pee into it and the testing

271
00:11:00,300 --> 00:11:03,449
starts with whatever tooling is

272
00:11:01,920 --> 00:11:05,250
available on that workstation so if they

273
00:11:03,450 --> 00:11:06,900
have PowerShell we use PowerShell if

274
00:11:05,250 --> 00:11:08,610
they don't have PowerShell we figure out

275
00:11:06,900 --> 00:11:10,370
how to get PowerShell or some other kind

276
00:11:08,610 --> 00:11:12,890
of code execution working on the machine

277
00:11:10,370 --> 00:11:14,600
where can we go from there and AV and

278
00:11:12,890 --> 00:11:16,310
EDR will always be enabled in that

279
00:11:14,600 --> 00:11:18,910
scenario because the user probably

280
00:11:16,310 --> 00:11:22,400
doesn't have the ability to bypass it

281
00:11:18,910 --> 00:11:27,140
now I did mention real-world tactics in

282
00:11:22,400 --> 00:11:30,290
air air quotes a couple of times so what

283
00:11:27,140 --> 00:11:31,790
do I mean by real-world tactics well if

284
00:11:30,290 --> 00:11:33,380
we think about threat actors and I

285
00:11:31,790 --> 00:11:35,089
haven't lived in the space a long time

286
00:11:33,380 --> 00:11:36,950
so I'm sorry for those of you that do

287
00:11:35,089 --> 00:11:39,710
and can talk more intelligently about

288
00:11:36,950 --> 00:11:42,230
this than I can but you've got these

289
00:11:39,710 --> 00:11:43,940
threat actors right got bad guys bad

290
00:11:42,230 --> 00:11:46,339
people that want to do bad things to

291
00:11:43,940 --> 00:11:49,070
your organization and they have varying

292
00:11:46,339 --> 00:11:51,170
levels of sophistication and they may be

293
00:11:49,070 --> 00:11:53,360
very sophisticated and they want to

294
00:11:51,170 --> 00:11:56,360
attack you but they're not gonna burn

295
00:11:53,360 --> 00:11:58,580
custom tradecraft custom tooling to

296
00:11:56,360 --> 00:12:01,190
attack you if they can put password in

297
00:11:58,580 --> 00:12:04,520
the password field so that that's the

298
00:12:01,190 --> 00:12:07,070
point of this like we were simulating we

299
00:12:04,520 --> 00:12:09,319
can dial up our test to simulate more

300
00:12:07,070 --> 00:12:11,330
sophisticated adversaries but that

301
00:12:09,320 --> 00:12:13,640
doesn't mean we're gonna use totally

302
00:12:11,330 --> 00:12:15,170
sophisticated techniques because if I

303
00:12:13,640 --> 00:12:17,839
can use this and not have to burn any

304
00:12:15,170 --> 00:12:21,500
tradecraft I'm going to use this every

305
00:12:17,839 --> 00:12:23,870
time so when I was researching for this

306
00:12:21,500 --> 00:12:27,800
talk originally I came across this blog

307
00:12:23,870 --> 00:12:30,260
that's up here it's by the mandiant red

308
00:12:27,800 --> 00:12:33,319
team and it's a good read

309
00:12:30,260 --> 00:12:34,670
and it's it talks about a lot of the

310
00:12:33,320 --> 00:12:37,250
techniques that I'm gonna talk about

311
00:12:34,670 --> 00:12:38,779
during my talk here so what they did is

312
00:12:37,250 --> 00:12:41,270
they out of customer it said we want to

313
00:12:38,779 --> 00:12:43,100
do a red team and they set up certain

314
00:12:41,270 --> 00:12:45,410
goals they said we want you to get to

315
00:12:43,100 --> 00:12:47,360
this certain Network segment we want you

316
00:12:45,410 --> 00:12:48,740
to get into this particular database and

317
00:12:47,360 --> 00:12:50,180
we want you to do something else so

318
00:12:48,740 --> 00:12:53,330
those were the goals that they were set

319
00:12:50,180 --> 00:12:55,579
up to do and they started with phishing

320
00:12:53,330 --> 00:12:57,290
the difference in what we do in an

321
00:12:55,580 --> 00:12:59,990
assumed breach test is we assume that

322
00:12:57,290 --> 00:13:02,150
the fish was already successful in this

323
00:12:59,990 --> 00:13:04,760
case they started with phishing they got

324
00:13:02,150 --> 00:13:08,300
credentials they mapped the customers

325
00:13:04,760 --> 00:13:10,640
perimeter they found a mobile VPN

326
00:13:08,300 --> 00:13:13,490
solution that did not require two-factor

327
00:13:10,640 --> 00:13:15,470
and so they ended up VPN ting in through

328
00:13:13,490 --> 00:13:17,990
this phone for the entire test once they

329
00:13:15,470 --> 00:13:21,290
got in they did targeted Kerberos ting

330
00:13:17,990 --> 00:13:23,000
so that they could find credentials and

331
00:13:21,290 --> 00:13:23,930
I'll talk about that in a bit here but

332
00:13:23,000 --> 00:13:26,810
they did target

333
00:13:23,930 --> 00:13:28,520
kerberos ting they got accounts that

334
00:13:26,810 --> 00:13:30,410
they get Kerberos they cracked those

335
00:13:28,520 --> 00:13:31,970
passwords they use those passwords to

336
00:13:30,410 --> 00:13:33,680
start pivoting through the network

337
00:13:31,970 --> 00:13:35,930
towards high-value targets and

338
00:13:33,680 --> 00:13:37,819
high-value data and that's what we're

339
00:13:35,930 --> 00:13:39,829
trying to do on an assumed breach pen

340
00:13:37,820 --> 00:13:43,160
test we're not launching exploits like

341
00:13:39,830 --> 00:13:44,899
sometimes we do that but we're not doing

342
00:13:43,160 --> 00:13:49,730
exploiting like we would do in a normal

343
00:13:44,899 --> 00:13:51,800
pen test so the rest of what I'm gonna

344
00:13:49,730 --> 00:13:53,750
talk about the most of us

345
00:13:51,800 --> 00:13:58,240
you know if you're someone that's in

346
00:13:53,750 --> 00:14:00,529
depending or red teaming and you want to

347
00:13:58,240 --> 00:14:02,420
start doing assume breach testing you

348
00:14:00,529 --> 00:14:05,779
can use this as a way to start doing

349
00:14:02,420 --> 00:14:08,599
that testing but if you are a system at

350
00:14:05,779 --> 00:14:10,040
sysadmin Blue team whatever you want to

351
00:14:08,600 --> 00:14:12,800
call it you can use these same

352
00:14:10,040 --> 00:14:15,380
techniques to test your organization to

353
00:14:12,800 --> 00:14:18,709
make my job harder and Robert was here

354
00:14:15,380 --> 00:14:20,000
much more enthusiastically before me top

355
00:14:18,709 --> 00:14:21,619
telling you how to defend your

356
00:14:20,000 --> 00:14:23,330
organization in a kind of gate made me

357
00:14:21,620 --> 00:14:25,220
sad because all the things he was saying

358
00:14:23,330 --> 00:14:27,050
I was like yep that would work and that

359
00:14:25,220 --> 00:14:27,620
would work that would be a pain in my

360
00:14:27,050 --> 00:14:31,069
ass

361
00:14:27,620 --> 00:14:33,200
so it absolutely I'm use these

362
00:14:31,070 --> 00:14:35,900
techniques to make my life harder so

363
00:14:33,200 --> 00:14:37,250
that I have more fun it's really

364
00:14:35,900 --> 00:14:41,569
frustrating but it's more fun when I

365
00:14:37,250 --> 00:14:43,370
have to work harder so again we're

366
00:14:41,570 --> 00:14:45,290
simulating what happens we're searching

367
00:14:43,370 --> 00:14:47,180
out high-value targets we usually do a

368
00:14:45,290 --> 00:14:48,890
kerberos sting we crack passwords that

369
00:14:47,180 --> 00:14:52,339
usually gets us some kind of elevation

370
00:14:48,890 --> 00:14:54,199
privilege we start pivoting towards the

371
00:14:52,339 --> 00:14:55,880
data and we're gathering credentials

372
00:14:54,200 --> 00:14:59,120
along the way and we're getting to

373
00:14:55,880 --> 00:15:02,870
whatever the goal is whatever high-value

374
00:14:59,120 --> 00:15:05,209
targets high-value data is along the way

375
00:15:02,870 --> 00:15:06,980
if we get domain admin that's great we

376
00:15:05,209 --> 00:15:09,560
will use that to our advantage but it is

377
00:15:06,980 --> 00:15:11,900
not the destination so I've said

378
00:15:09,560 --> 00:15:13,790
pivoting towards high-value targets and

379
00:15:11,900 --> 00:15:16,300
high-value data and things like that how

380
00:15:13,790 --> 00:15:18,529
do I know what that is

381
00:15:16,300 --> 00:15:20,060
you have to talk to the customer I know

382
00:15:18,529 --> 00:15:22,490
it's painful but you have to talk to the

383
00:15:20,060 --> 00:15:23,779
customer so we have scoping calls and

384
00:15:22,490 --> 00:15:26,180
one of the questions we ask is what

385
00:15:23,779 --> 00:15:28,399
keeps you up at night what about your

386
00:15:26,180 --> 00:15:31,880
organization if it was targeted and if

387
00:15:28,399 --> 00:15:33,620
it was breached or destroyed like would

388
00:15:31,880 --> 00:15:36,050
have the most impact they're like oh

389
00:15:33,620 --> 00:15:37,070
that's definitely this database tell me

390
00:15:36,050 --> 00:15:38,150
more

391
00:15:37,070 --> 00:15:39,560
then we'll find out some more

392
00:15:38,150 --> 00:15:41,630
information about that that might be

393
00:15:39,560 --> 00:15:43,069
where we're trying to go and if I need

394
00:15:41,630 --> 00:15:44,930
to use domain admin to get there that's

395
00:15:43,070 --> 00:15:46,670
all do it but if I can do it is just

396
00:15:44,930 --> 00:15:49,069
Jane and accounting and never have to

397
00:15:46,670 --> 00:15:53,000
escalate privileges that's a pretty good

398
00:15:49,070 --> 00:15:55,130
demonstration of impact know when we're

399
00:15:53,000 --> 00:15:56,810
doing C to type communications we need

400
00:15:55,130 --> 00:15:58,340
to do something we need to route our

401
00:15:56,810 --> 00:15:59,780
traffic through some work so we don't

402
00:15:58,340 --> 00:16:02,420
want people to know directly where our

403
00:15:59,780 --> 00:16:04,640
c2 servers are we want to hide them and

404
00:16:02,420 --> 00:16:06,589
that's domain fronting now traditionally

405
00:16:04,640 --> 00:16:08,240
domain fronting you would route traffic

406
00:16:06,590 --> 00:16:11,060
through someone else's domain for

407
00:16:08,240 --> 00:16:13,040
instance cisco has a bunch of stuff

408
00:16:11,060 --> 00:16:15,560
hosted in the Amazon infrastructure

409
00:16:13,040 --> 00:16:18,620
through cloud front and whitelist

410
00:16:15,560 --> 00:16:20,599
cisco.com was a front able domain so I

411
00:16:18,620 --> 00:16:22,690
could route traffic I could profile my

412
00:16:20,600 --> 00:16:25,370
customer find out they're a Cisco shop

413
00:16:22,690 --> 00:16:28,340
they're probably having some Cisco type

414
00:16:25,370 --> 00:16:31,580
traffic so I can domain front which is

415
00:16:28,340 --> 00:16:32,870
requesting the the on the URL if we were

416
00:16:31,580 --> 00:16:35,780
thinking about a web browser would be

417
00:16:32,870 --> 00:16:38,930
whitelist domain.com but the host header

418
00:16:35,780 --> 00:16:40,970
that is being sent would be a cloud

419
00:16:38,930 --> 00:16:42,859
front instance that I control that

420
00:16:40,970 --> 00:16:44,930
routes the traffic back to me so an

421
00:16:42,860 --> 00:16:47,690
instant responder looking at it on the

422
00:16:44,930 --> 00:16:49,729
surface they see whitelist not cisco.com

423
00:16:47,690 --> 00:16:52,190
yeah we're a Cisco shop that seems

424
00:16:49,730 --> 00:16:54,380
normal but then if they start looking

425
00:16:52,190 --> 00:16:56,480
into it very quickly you're like that's

426
00:16:54,380 --> 00:16:57,920
cobalt striker that's Metasploit or

427
00:16:56,480 --> 00:17:00,920
that's whatever if you actually look at

428
00:16:57,920 --> 00:17:03,860
the app the payload that's going so then

429
00:17:00,920 --> 00:17:05,839
we need to make our traffic look like

430
00:17:03,860 --> 00:17:07,760
something else and that's a malleable c2

431
00:17:05,839 --> 00:17:10,609
profile if you're in the cobalt strike

432
00:17:07,760 --> 00:17:12,470
world if you're not there's other ways

433
00:17:10,609 --> 00:17:14,750
of doing it but in cobalt strikes called

434
00:17:12,470 --> 00:17:16,790
malleable c2 if you have to work with

435
00:17:14,750 --> 00:17:18,920
cobalt strike and malleable c2 blue

436
00:17:16,790 --> 00:17:22,550
screen of Jeff Jeff Dimmick from Specter

437
00:17:18,920 --> 00:17:25,010
Ops is the master at writing malleable

438
00:17:22,550 --> 00:17:28,339
c2 profiles so much good information at

439
00:17:25,010 --> 00:17:30,650
Jeff's github one of them malleable c2

440
00:17:28,339 --> 00:17:32,899
randomizer it'll actually just you run

441
00:17:30,650 --> 00:17:35,390
it and it will spit out a randomized c2

442
00:17:32,900 --> 00:17:37,010
profile for you that's great but you

443
00:17:35,390 --> 00:17:39,650
usually probably want to customize it

444
00:17:37,010 --> 00:17:41,990
more for your specific target and he has

445
00:17:39,650 --> 00:17:44,200
a lot of resources that will help you

446
00:17:41,990 --> 00:17:47,180
understand how to do that

447
00:17:44,200 --> 00:17:49,970
the initial access vector how many

448
00:17:47,180 --> 00:17:53,000
people block HTA's in

449
00:17:49,970 --> 00:17:55,130
email I got some people block' she has

450
00:17:53,000 --> 00:17:56,870
an email how many people black HTA is if

451
00:17:55,130 --> 00:18:02,630
people try to download them from a web

452
00:17:56,870 --> 00:18:04,309
page not a lot hea s are still effective

453
00:18:02,630 --> 00:18:05,780
they don't run automatically now you

454
00:18:04,309 --> 00:18:07,220
actually have to like click it but

455
00:18:05,780 --> 00:18:09,080
that's where the phishing email says

456
00:18:07,220 --> 00:18:11,240
like go here and then click on this

457
00:18:09,080 --> 00:18:13,668
thing

458
00:18:11,240 --> 00:18:15,909
hjs are still effective and you can make

459
00:18:13,669 --> 00:18:18,950
them more effective you can take an hea

460
00:18:15,909 --> 00:18:21,919
for instance take a powershell payload

461
00:18:18,950 --> 00:18:24,470
out of Metasploit or out of cobalt

462
00:18:21,919 --> 00:18:27,740
strike you can use trusted sexy unicorn

463
00:18:24,470 --> 00:18:29,090
to make that more obfuscated if you do

464
00:18:27,740 --> 00:18:32,419
some research you'll find that you can

465
00:18:29,090 --> 00:18:34,730
then take that obfuscated script pull it

466
00:18:32,419 --> 00:18:37,250
apart there is a portion of that script

467
00:18:34,730 --> 00:18:39,140
that you then feed to invoke obfuscation

468
00:18:37,250 --> 00:18:42,140
from Daniel Bohannon which makes it even

469
00:18:39,140 --> 00:18:44,510
more crazily obfuscated and then you can

470
00:18:42,140 --> 00:18:46,880
use nish hangs out HTA to create a

471
00:18:44,510 --> 00:18:50,960
completely new HEA that is very

472
00:18:46,880 --> 00:18:53,000
obfuscated doesn't act like the native

473
00:18:50,960 --> 00:18:56,870
cobol strike or Metasploit HTA's and

474
00:18:53,000 --> 00:18:59,179
gets past a lot more avian edr deme guys

475
00:18:56,870 --> 00:19:02,928
deme guys is another tool it uses

476
00:18:59,179 --> 00:19:04,220
environmental keying to execute your to

477
00:19:02,929 --> 00:19:07,309
make a determination whether it should

478
00:19:04,220 --> 00:19:09,230
execute your HT a payload so if you

479
00:19:07,309 --> 00:19:10,850
looked at the page you would see Java

480
00:19:09,230 --> 00:19:12,710
Script and you'd see an encrypted blob

481
00:19:10,850 --> 00:19:13,908
in the Java Script is looking at your

482
00:19:12,710 --> 00:19:16,640
machine to determine what's your

483
00:19:13,909 --> 00:19:18,890
hostname what is your IP address what is

484
00:19:16,640 --> 00:19:21,049
your internal domain name whatever

485
00:19:18,890 --> 00:19:23,600
environment environmental keying factors

486
00:19:21,049 --> 00:19:26,450
like that that you set up and you say

487
00:19:23,600 --> 00:19:30,260
only executes if the internal domain

488
00:19:26,450 --> 00:19:31,880
name is XYZ comm and if it's XYZ comm

489
00:19:30,260 --> 00:19:34,610
it'll decrypt the payload and execute it

490
00:19:31,880 --> 00:19:36,679
in memory if it's not XYZ comm it'll

491
00:19:34,610 --> 00:19:38,830
never decrypt and execute meaning you

492
00:19:36,679 --> 00:19:41,539
didn't hit the right target environment

493
00:19:38,830 --> 00:19:44,960
maybe they opened it up at home for

494
00:19:41,539 --> 00:19:47,210
instance but it also means that it's not

495
00:19:44,960 --> 00:19:49,039
being seen on the wire because it's only

496
00:19:47,210 --> 00:19:52,669
getting decrypted in memory so it's a

497
00:19:49,039 --> 00:19:55,010
useful tool macros still work click once

498
00:19:52,669 --> 00:19:57,679
executables work you can read all about

499
00:19:55,010 --> 00:20:00,559
it here from this net spy Mets net spy

500
00:19:57,679 --> 00:20:02,090
blog and these are not the only only

501
00:20:00,559 --> 00:20:03,580
ways of doing it there are so many more

502
00:20:02,090 --> 00:20:07,600
ways of generating in

503
00:20:03,580 --> 00:20:10,449
access this is just some of it now we

504
00:20:07,600 --> 00:20:12,219
also need user accounts how do we get

505
00:20:10,450 --> 00:20:14,169
user accounts and this is useful whether

506
00:20:12,220 --> 00:20:17,460
it's external pen test or sumn breach or

507
00:20:14,169 --> 00:20:22,179
other kinds of tests we can use o 1 o

508
00:20:17,460 --> 00:20:27,149
365 for password spraying even if you do

509
00:20:22,179 --> 00:20:30,309
not host your email and 365 we can use

510
00:20:27,149 --> 00:20:31,600
daft ax mail swipe mail snipers as Bo

511
00:20:30,309 --> 00:20:33,309
bullet from Black Hills information

512
00:20:31,600 --> 00:20:36,908
security you can spray against OA

513
00:20:33,309 --> 00:20:39,668
servers or o 365 servers give it a list

514
00:20:36,909 --> 00:20:42,460
of user names and give it a list of

515
00:20:39,669 --> 00:20:45,999
passwords and it will spray against oro

516
00:20:42,460 --> 00:20:47,470
365 and tell you whether or not those

517
00:20:45,999 --> 00:20:52,210
passwords are correct which you can now

518
00:20:47,470 --> 00:20:54,009
use to get into LR yearo 365 email but I

519
00:20:52,210 --> 00:20:56,200
will be having a blog article coming out

520
00:20:54,009 --> 00:20:59,049
soon talking about how you can do user

521
00:20:56,200 --> 00:21:01,629
enumeration or no 365 even if you don't

522
00:20:59,049 --> 00:21:04,749
have office 365 email but if your

523
00:21:01,629 --> 00:21:08,189
company has Skype for instance or if

524
00:21:04,749 --> 00:21:10,659
your company uses row 365 SharePoint

525
00:21:08,190 --> 00:21:12,820
even if you host your email internally

526
00:21:10,659 --> 00:21:15,609
there is an interface within the office

527
00:21:12,820 --> 00:21:17,739
365 infrastructure that we can use to

528
00:21:15,609 --> 00:21:21,460
enumerate users and passwords Spray to

529
00:21:17,739 --> 00:21:25,109
figure out are those correct if you're

530
00:21:21,460 --> 00:21:28,269
internally you can also do domain spring

531
00:21:25,109 --> 00:21:30,668
internally password spraying with Bo's

532
00:21:28,269 --> 00:21:33,159
domain password spray and that has a

533
00:21:30,669 --> 00:21:35,230
really nice feature that it goes out and

534
00:21:33,159 --> 00:21:37,600
you can give it a list of usernames and

535
00:21:35,230 --> 00:21:39,820
passwords that's one way but another way

536
00:21:37,600 --> 00:21:41,019
it'll go out and grab all the users from

537
00:21:39,820 --> 00:21:43,149
Active Directory look at your

538
00:21:41,019 --> 00:21:45,399
fine-grained password policy figure out

539
00:21:43,149 --> 00:21:47,229
what the the lockout threshold is and

540
00:21:45,399 --> 00:21:49,418
then find all the users that are within

541
00:21:47,230 --> 00:21:52,539
one failed guess of their lockout policy

542
00:21:49,419 --> 00:21:57,070
and won't run them so you don't lock

543
00:21:52,539 --> 00:22:01,090
everyone out warning if you give it a

544
00:21:57,070 --> 00:22:03,428
list of usernames and they send just a

545
00:22:01,090 --> 00:22:06,820
password you actually say spray these

546
00:22:03,429 --> 00:22:09,970
users with this password it does not do

547
00:22:06,820 --> 00:22:11,859
the safety checks and it may lock out

548
00:22:09,970 --> 00:22:15,059
everyone in the organization and give

549
00:22:11,859 --> 00:22:15,059
you a really bad day

550
00:22:15,879 --> 00:22:20,289
not saying I experienced that but trust

551
00:22:19,179 --> 00:22:22,749
me

552
00:22:20,289 --> 00:22:24,699
so Kerberos thing how many know what

553
00:22:22,749 --> 00:22:25,929
Kerberos thing is for instance okay

554
00:22:24,699 --> 00:22:29,909
that's good there's a good number hands

555
00:22:25,929 --> 00:22:31,959
for those of you that don't know magic F

556
00:22:29,909 --> 00:22:34,049
that's pretty much how it works it's

557
00:22:31,959 --> 00:22:34,049
magic

558
00:22:34,109 --> 00:22:41,198
so Kerberos ting is an abuse of the wig

559
00:22:37,479 --> 00:22:42,969
Active Directory works you can set up

560
00:22:41,199 --> 00:22:46,239
what's called a service principle name

561
00:22:42,969 --> 00:22:48,849
attached to a user account that is used

562
00:22:46,239 --> 00:22:51,249
to run services and there's some magic

563
00:22:48,849 --> 00:22:53,879
happening with Kerberos tickets being

564
00:22:51,249 --> 00:22:57,369
signed with the service account users

565
00:22:53,879 --> 00:22:58,928
password hash and then that hash is

566
00:22:57,369 --> 00:23:01,269
transmitted to you and then you give

567
00:22:58,929 --> 00:23:02,829
that bet in a form of a ticket and then

568
00:23:01,269 --> 00:23:04,149
you give that ticket to the service that

569
00:23:02,829 --> 00:23:06,489
you want to connect to and it's like all

570
00:23:04,149 --> 00:23:08,258
right you're allowed in that's really a

571
00:23:06,489 --> 00:23:11,199
ghetto-fabulous way of explaining it's

572
00:23:08,259 --> 00:23:13,209
horrible but essentially what happens is

573
00:23:11,199 --> 00:23:15,519
user says I want to connect to this

574
00:23:13,209 --> 00:23:17,109
sequel server and they receive a

575
00:23:15,519 --> 00:23:18,819
Kerberos ticket which allows them to

576
00:23:17,109 --> 00:23:20,739
communicate with the sequel server in a

577
00:23:18,819 --> 00:23:22,299
while later they want to communicate to

578
00:23:20,739 --> 00:23:24,549
this other server over here and they

579
00:23:22,299 --> 00:23:26,440
pull a ticket and they connect to that

580
00:23:24,549 --> 00:23:30,369
server that is normal

581
00:23:26,440 --> 00:23:32,109
Kerberos behavior in Kerberos tting we

582
00:23:30,369 --> 00:23:34,149
look at all the users that have service

583
00:23:32,109 --> 00:23:36,579
principle names and we pull all the

584
00:23:34,149 --> 00:23:39,158
tickets at once and then we try cracking

585
00:23:36,579 --> 00:23:40,779
those tickets because if we crack them

586
00:23:39,159 --> 00:23:43,089
we have the password associated with

587
00:23:40,779 --> 00:23:45,669
that service account that is not normal

588
00:23:43,089 --> 00:23:47,859
because you're seeing one source pull a

589
00:23:45,669 --> 00:23:50,949
bunch of service principal names all at

590
00:23:47,859 --> 00:23:53,978
once normally it's one here one there so

591
00:23:50,949 --> 00:23:55,839
if you look for event ID 4769 on your

592
00:23:53,979 --> 00:23:58,839
domain controllers and you see one user

593
00:23:55,839 --> 00:24:00,729
pull 30 of them at once someone is

594
00:23:58,839 --> 00:24:04,149
Kerberos ting in your organization

595
00:24:00,729 --> 00:24:05,529
that's a dead giveaway so you can use

596
00:24:04,149 --> 00:24:07,988
the normal tools and they work like that

597
00:24:05,529 --> 00:24:12,339
and they still work whether it's Power

598
00:24:07,989 --> 00:24:15,549
View timber Dean's original tools this

599
00:24:12,339 --> 00:24:17,879
one invoke auto Kerberos they all work

600
00:24:15,549 --> 00:24:20,949
great but they will give you a way

601
00:24:17,879 --> 00:24:22,478
because of how they work so I talked

602
00:24:20,949 --> 00:24:26,049
about that targeted Kerberos thing that

603
00:24:22,479 --> 00:24:28,419
that mandiant did the ideal way to do it

604
00:24:26,049 --> 00:24:29,560
is to grab one wait a period of time

605
00:24:28,419 --> 00:24:31,540
some ran

606
00:24:29,560 --> 00:24:33,250
period of time and grab another one and

607
00:24:31,540 --> 00:24:35,290
then wait some random period of time and

608
00:24:33,250 --> 00:24:39,250
grab another one how do you know what to

609
00:24:35,290 --> 00:24:42,190
grab well if you can use power view if

610
00:24:39,250 --> 00:24:45,190
you read this blog by Will Schrader harm

611
00:24:42,190 --> 00:24:46,480
Joy you can find out how to Kerberos

612
00:24:45,190 --> 00:24:48,610
with out

613
00:24:46,480 --> 00:24:50,980
Mimi Katz because Mimi Katz also does

614
00:24:48,610 --> 00:24:53,709
Kerberos ting essentially these two

615
00:24:50,980 --> 00:24:56,170
functions get domain user - SPN will

616
00:24:53,710 --> 00:24:58,270
give you all the users that have SPNs

617
00:24:56,170 --> 00:25:02,170
service principal names and then this

618
00:24:58,270 --> 00:25:03,730
will grab all the tickets if you have it

619
00:25:02,170 --> 00:25:06,400
do all of them or he can give it one

620
00:25:03,730 --> 00:25:08,080
specific user and what mandiant did was

621
00:25:06,400 --> 00:25:11,350
they queried for users that were in a

622
00:25:08,080 --> 00:25:12,939
group like admin there's admin or sequel

623
00:25:11,350 --> 00:25:16,149
because we very final ease associated

624
00:25:12,940 --> 00:25:17,980
with sequel very commonly and then they

625
00:25:16,150 --> 00:25:19,480
pulled only those tickets and they did

626
00:25:17,980 --> 00:25:21,210
in a low and slow approach to avoid

627
00:25:19,480 --> 00:25:25,930
setting off any alarms

628
00:25:21,210 --> 00:25:28,090
Sean Metcalfe pyrotech his 80s security

629
00:25:25,930 --> 00:25:29,230
org site if you haven't if you're not

630
00:25:28,090 --> 00:25:32,889
familiar with that and you have to work

631
00:25:29,230 --> 00:25:35,890
with Active Directory go study the Bible

632
00:25:32,890 --> 00:25:38,680
because he has a it's an amazing amazing

633
00:25:35,890 --> 00:25:41,080
Active Directory resource but we also

634
00:25:38,680 --> 00:25:43,480
mine Active Directory for information we

635
00:25:41,080 --> 00:25:45,040
use bloodhound and if you're in cobalt

636
00:25:43,480 --> 00:25:47,290
strike you can use char pound and

637
00:25:45,040 --> 00:25:49,870
execute it in memory it never touches

638
00:25:47,290 --> 00:25:51,340
disk it's magic you are going to need to

639
00:25:49,870 --> 00:25:53,500
save the output somewhere and that goes

640
00:25:51,340 --> 00:25:56,439
on disk and this is where no save cache

641
00:25:53,500 --> 00:25:58,930
is your friend because if you don't it

642
00:25:56,440 --> 00:26:03,180
drops a file called bloodhound dot bin

643
00:25:58,930 --> 00:26:07,350
on disk and then you have a bad day so

644
00:26:03,180 --> 00:26:10,900
don't forget that ever again Mike so

645
00:26:07,350 --> 00:26:13,060
bloodhound is good and it's a but it is

646
00:26:10,900 --> 00:26:16,120
noisy you can make it stealthier but it

647
00:26:13,060 --> 00:26:19,990
is noisy how many have ever used AD

648
00:26:16,120 --> 00:26:21,850
Explorer yeah couple hands it's magic

649
00:26:19,990 --> 00:26:24,550
and Robert alluded to this he's like oh

650
00:26:21,850 --> 00:26:26,740
we're gonna put a honey account with the

651
00:26:24,550 --> 00:26:30,490
username or with the password in the

652
00:26:26,740 --> 00:26:32,860
description field I laugh because that

653
00:26:30,490 --> 00:26:34,540
actually happens in not for honey token

654
00:26:32,860 --> 00:26:36,790
accounts some people don't realize that

655
00:26:34,540 --> 00:26:38,590
Active Directory schema attributes are

656
00:26:36,790 --> 00:26:41,950
visible by anyone who can talk to Active

657
00:26:38,590 --> 00:26:44,620
Directory they think that's hidden

658
00:26:41,950 --> 00:26:46,299
or maybe they just don't realize the

659
00:26:44,620 --> 00:26:48,428
implications of what's happening in

660
00:26:46,299 --> 00:26:51,010
large organizations we see very

661
00:26:48,429 --> 00:26:55,270
frequently left frequently but probably

662
00:26:51,010 --> 00:26:58,510
10 15 percent of the time there's a

663
00:26:55,270 --> 00:27:01,120
password in the description field or in

664
00:26:58,510 --> 00:27:03,129
the comment field or the MS fu 30

665
00:27:01,120 --> 00:27:05,620
password which is Microsoft's services

666
00:27:03,130 --> 00:27:06,850
for UNIX password field the UNIX user

667
00:27:05,620 --> 00:27:09,070
password field there are other

668
00:27:06,850 --> 00:27:11,379
attributes where you will find password

669
00:27:09,070 --> 00:27:12,790
information either the password itself

670
00:27:11,380 --> 00:27:15,429
or information that will get you the

671
00:27:12,790 --> 00:27:17,980
password our friends at Black Hills have

672
00:27:15,429 --> 00:27:19,720
a great blog about this ad explorer is

673
00:27:17,980 --> 00:27:21,760
wonderful if you're on the machine you

674
00:27:19,720 --> 00:27:24,460
can use it in a GUI window it's kind of

675
00:27:21,760 --> 00:27:27,250
like a DS query window and if you're

676
00:27:24,460 --> 00:27:29,070
doing it like remotely through c2 you

677
00:27:27,250 --> 00:27:31,330
just execute this command and it will

678
00:27:29,070 --> 00:27:33,639
harvest all that information out of

679
00:27:31,330 --> 00:27:35,290
active active directory into a snapshot

680
00:27:33,640 --> 00:27:39,760
file which you can download and then use

681
00:27:35,290 --> 00:27:42,460
offline GPP creds Group Policy

682
00:27:39,760 --> 00:27:44,140
preference files these have been an

683
00:27:42,460 --> 00:27:49,000
issue for a long time and Microsoft

684
00:27:44,140 --> 00:27:52,540
fixed the issue like 2014 so you can no

685
00:27:49,000 --> 00:27:54,669
longer create these active directory are

686
00:27:52,540 --> 00:27:56,260
not active directory but group policy

687
00:27:54,669 --> 00:27:58,480
preference files that have credentials

688
00:27:56,260 --> 00:28:02,530
that are stored in your domain

689
00:27:58,480 --> 00:28:05,470
controllers sysvol these files are

690
00:28:02,530 --> 00:28:08,139
usually used to create a local admin

691
00:28:05,470 --> 00:28:10,690
account to map a drive or a printer or

692
00:28:08,140 --> 00:28:14,080
something on a workstation and they get

693
00:28:10,690 --> 00:28:16,210
executed when a user logs in Microsoft

694
00:28:14,080 --> 00:28:17,770
they it is encrypted it's an encrypted

695
00:28:16,210 --> 00:28:20,200
password but Microsoft helpfully

696
00:28:17,770 --> 00:28:22,809
published the AES key so we can decrypt

697
00:28:20,200 --> 00:28:24,580
the password and so we look for those

698
00:28:22,809 --> 00:28:27,780
and that's if you're looking for honey

699
00:28:24,580 --> 00:28:30,490
token accounts this is another great way

700
00:28:27,780 --> 00:28:32,290
because I'm gonna search this fall I'm

701
00:28:30,490 --> 00:28:34,480
gonna do it either with power swipe get

702
00:28:32,290 --> 00:28:38,409
GPP password or I'm just gonna do fine

703
00:28:34,480 --> 00:28:39,940
strings slash whatever C password insist

704
00:28:38,410 --> 00:28:44,230
wall I'm gonna find any file that has

705
00:28:39,940 --> 00:28:46,150
that string in it but if I don't look at

706
00:28:44,230 --> 00:28:49,150
the date on the file because I know that

707
00:28:46,150 --> 00:28:51,730
after a certain date in 2014 like stuff

708
00:28:49,150 --> 00:28:53,240
patched this so sometime after that it's

709
00:28:51,730 --> 00:28:56,570
been patched

710
00:28:53,240 --> 00:28:58,070
there should be no more Group Policy

711
00:28:56,570 --> 00:29:00,799
preference files stored in the sysvol

712
00:28:58,070 --> 00:29:05,029
but if I'm lazy and I don't look at the

713
00:29:00,799 --> 00:29:07,250
dates you can plant creds in one of

714
00:29:05,029 --> 00:29:08,750
these files I'm gonna find it I'm

715
00:29:07,250 --> 00:29:10,490
probably gonna use it if I don't look at

716
00:29:08,750 --> 00:29:13,549
the dates and if you're really devious

717
00:29:10,490 --> 00:29:15,799
you could do max dumping and change the

718
00:29:13,549 --> 00:29:17,389
time on the file to sometime in the past

719
00:29:15,799 --> 00:29:20,090
I'm gonna have to work really hard to

720
00:29:17,390 --> 00:29:22,340
figure out if that's legit I'm lazy I'm

721
00:29:20,090 --> 00:29:23,899
probably not gonna do that and you see

722
00:29:22,340 --> 00:29:26,059
those creds being used you know I'm

723
00:29:23,899 --> 00:29:28,549
there right like that is a way that you

724
00:29:26,059 --> 00:29:29,918
can catch your pen testers and people

725
00:29:28,549 --> 00:29:33,230
doing bad things

726
00:29:29,919 --> 00:29:35,870
lateral movement so I don't want to just

727
00:29:33,230 --> 00:29:37,610
work on the machine that I'm on unless

728
00:29:35,870 --> 00:29:40,850
that gets me to the goal and sometimes

729
00:29:37,610 --> 00:29:45,770
it does but I need to get elsewhere in

730
00:29:40,850 --> 00:29:50,029
the network can I do that by getting

731
00:29:45,770 --> 00:29:51,289
credentials and I get those credentials

732
00:29:50,029 --> 00:29:55,669
and then I can use something like Power

733
00:29:51,289 --> 00:29:57,919
View and I can use test admin access -

734
00:29:55,669 --> 00:29:59,919
computer name and that'll test if I have

735
00:29:57,919 --> 00:30:01,909
local admin access to just one machine

736
00:29:59,919 --> 00:30:04,159
or I can do this

737
00:30:01,909 --> 00:30:07,070
an old test if I have local admin access

738
00:30:04,159 --> 00:30:09,429
to every machine in the domain and I can

739
00:30:07,070 --> 00:30:12,860
figure out where I can move and this is

740
00:30:09,429 --> 00:30:15,260
very noisy and surprisingly does not get

741
00:30:12,860 --> 00:30:17,149
caught so many times like why are you

742
00:30:15,260 --> 00:30:20,059
not alerting that someone tried to login

743
00:30:17,149 --> 00:30:23,270
to every machine on the network at once

744
00:30:20,059 --> 00:30:24,980
like that should give me away but it

745
00:30:23,270 --> 00:30:26,029
doesn't like look for those kinds of

746
00:30:24,980 --> 00:30:29,450
things but we don't have to use

747
00:30:26,029 --> 00:30:30,890
PowerShell we can use PS exec and I

748
00:30:29,450 --> 00:30:32,029
think it was cat maybe it was her name

749
00:30:30,890 --> 00:30:34,970
this morning that's talking about don't

750
00:30:32,029 --> 00:30:36,380
use if you're a pen tester definitely

751
00:30:34,970 --> 00:30:41,270
use this this is great for lateral

752
00:30:36,380 --> 00:30:42,679
movement I love it it's so easy but

753
00:30:41,270 --> 00:30:44,929
there's other ways to do it this is not

754
00:30:42,679 --> 00:30:47,779
the only way to do lateral movement it's

755
00:30:44,929 --> 00:30:49,640
just some ideas but this is my favorite

756
00:30:47,779 --> 00:30:51,590
this is my absolute favorite way of

757
00:30:49,640 --> 00:30:54,649
establishing lateral movement in winning

758
00:30:51,590 --> 00:30:58,070
on every pen test and that's opening

759
00:30:54,649 --> 00:30:59,600
File Explorer I'm serious that's

760
00:30:58,070 --> 00:31:02,990
actually how it works most of the time

761
00:30:59,600 --> 00:31:04,428
is people think that pen testing is like

762
00:31:02,990 --> 00:31:06,040
it was really awesome you're some type

763
00:31:04,429 --> 00:31:08,320
of code ninja or you're

764
00:31:06,040 --> 00:31:12,280
li tax or and it's like no mostly I'm a

765
00:31:08,320 --> 00:31:14,530
file archivist like I'm just I'm digging

766
00:31:12,280 --> 00:31:17,680
through file shares because someone put

767
00:31:14,530 --> 00:31:19,389
a password in a file somewhere on the

768
00:31:17,680 --> 00:31:22,090
network I guarantee you it's somewhere

769
00:31:19,390 --> 00:31:26,380
and I just have to find it so I'm an

770
00:31:22,090 --> 00:31:28,030
archaeologist I can do this and I find

771
00:31:26,380 --> 00:31:30,330
elevated credentials whether it's domain

772
00:31:28,030 --> 00:31:33,520
admin or sequel si or some other

773
00:31:30,330 --> 00:31:35,590
elevated credentials I find them in

774
00:31:33,520 --> 00:31:38,379
files I also find the data that I need

775
00:31:35,590 --> 00:31:41,760
to win the in files unencrypted PA PII

776
00:31:38,380 --> 00:31:43,770
pH I credit card numbers source code

777
00:31:41,760 --> 00:31:46,870
this is a fun one

778
00:31:43,770 --> 00:31:49,120
PS red line logs so I was talking about

779
00:31:46,870 --> 00:31:50,800
you know using the credential object to

780
00:31:49,120 --> 00:31:53,320
pass around there's two ways you can get

781
00:31:50,800 --> 00:31:55,389
a credential object one you can say get

782
00:31:53,320 --> 00:31:57,639
credential and then it pops up a box and

783
00:31:55,390 --> 00:31:59,680
you put in your username and password

784
00:31:57,640 --> 00:32:02,740
and that is the right way to do it the

785
00:31:59,680 --> 00:32:06,670
wrong way to do it is to just dollar

786
00:32:02,740 --> 00:32:10,450
sign user equals whack you know Bob

787
00:32:06,670 --> 00:32:13,270
slash Alice and then dollar sign

788
00:32:10,450 --> 00:32:15,150
password equals password and then you

789
00:32:13,270 --> 00:32:19,480
make a credential object using those two

790
00:32:15,150 --> 00:32:22,300
if you have PowerShell read line turned

791
00:32:19,480 --> 00:32:25,390
on which is basically the bash history

792
00:32:22,300 --> 00:32:26,980
of power PowerShell if you do that on

793
00:32:25,390 --> 00:32:28,210
the command line this is a transcript of

794
00:32:26,980 --> 00:32:30,640
everything you did on the command line

795
00:32:28,210 --> 00:32:32,110
including your typos and that password

796
00:32:30,640 --> 00:32:35,200
that you typed on the command line will

797
00:32:32,110 --> 00:32:39,550
be in there that file is gold look for

798
00:32:35,200 --> 00:32:43,060
that it's gonna be in your user profile

799
00:32:39,550 --> 00:32:46,780
and like the app data roaming Microsoft

800
00:32:43,060 --> 00:32:48,879
Windows PowerShell folder I think I

801
00:32:46,780 --> 00:32:51,550
think that's where it's at look for that

802
00:32:48,880 --> 00:32:53,080
file though console host host history we

803
00:32:51,550 --> 00:32:54,820
also look for source code and sensitive

804
00:32:53,080 --> 00:33:01,270
data whether it's its credentials

805
00:32:54,820 --> 00:33:03,040
whether it is PII source code whatever

806
00:33:01,270 --> 00:33:04,840
it is that's the company cares about

807
00:33:03,040 --> 00:33:07,000
sometimes it's just stored unencrypted

808
00:33:04,840 --> 00:33:10,959
in files and we find that the other

809
00:33:07,000 --> 00:33:13,330
thing that I really like is web config

810
00:33:10,960 --> 00:33:15,610
files for some baffling reason system

811
00:33:13,330 --> 00:33:17,169
administrators maybe it's not sis admins

812
00:33:15,610 --> 00:33:19,540
maybe I don't know it's a nefarious

813
00:33:17,170 --> 00:33:19,940
developer I don't know but they share

814
00:33:19,540 --> 00:33:22,279
out

815
00:33:19,940 --> 00:33:24,440
Webroot of an is web server and if that

816
00:33:22,279 --> 00:33:25,940
web server needs credentials to

817
00:33:24,440 --> 00:33:28,100
communicate with something else the

818
00:33:25,940 --> 00:33:29,629
credentials are stored in web config so

819
00:33:28,100 --> 00:33:31,580
if you share that share out and let

820
00:33:29,629 --> 00:33:35,330
everyone read it the credentials to do

821
00:33:31,580 --> 00:33:37,820
that are in that file oh my god and it

822
00:33:35,330 --> 00:33:39,199
happens all the time all the time and

823
00:33:37,820 --> 00:33:40,908
they're like oh why is that out there I

824
00:33:39,200 --> 00:33:43,129
was like I don't know dude I'm I found

825
00:33:40,909 --> 00:33:46,279
it I'm not your test like you tell me

826
00:33:43,129 --> 00:33:48,529
why it's there it shouldn't be we can

827
00:33:46,279 --> 00:33:50,299
use Power View to do this automatically

828
00:33:48,529 --> 00:33:52,879
we can use invokes share finder with

829
00:33:50,299 --> 00:33:54,889
check access and it will look across

830
00:33:52,879 --> 00:33:56,959
every share in the domain that the user

831
00:33:54,889 --> 00:33:58,758
I am currently executing as that's the

832
00:33:56,960 --> 00:34:01,789
important thing the user I am currently

833
00:33:58,759 --> 00:34:04,039
executing is does it have permission to

834
00:34:01,789 --> 00:34:07,340
check that file or check that share on

835
00:34:04,039 --> 00:34:09,469
the network you should see this you

836
00:34:07,340 --> 00:34:13,098
should see me connecting to the system

837
00:34:09,469 --> 00:34:15,199
and be like yes I have access no I don't

838
00:34:13,099 --> 00:34:17,419
have access if you are collecting these

839
00:34:15,199 --> 00:34:19,098
events from all your endpoints then

840
00:34:17,418 --> 00:34:21,770
doing some correlation and you see one

841
00:34:19,099 --> 00:34:24,800
person strobe every file server in the

842
00:34:21,770 --> 00:34:27,409
network at once to try to see if they

843
00:34:24,800 --> 00:34:29,960
have access it's not normal behavior

844
00:34:27,409 --> 00:34:32,359
most people aren't doing that so look

845
00:34:29,960 --> 00:34:34,819
for that you will find people that are

846
00:34:32,359 --> 00:34:36,889
doing it programmatically we can also

847
00:34:34,819 --> 00:34:38,839
use find interesting domain share file

848
00:34:36,889 --> 00:34:41,240
which will search through every share in

849
00:34:38,839 --> 00:34:43,190
the domain for certain files files that

850
00:34:41,239 --> 00:34:46,848
have the word password in the name or

851
00:34:43,190 --> 00:34:48,290
cred or admin or other interesting names

852
00:34:46,849 --> 00:34:50,810
there's a few defaults that it looks for

853
00:34:48,290 --> 00:34:53,589
and returns that list so Roberts talked

854
00:34:50,810 --> 00:34:55,969
about having a honey file passwords like

855
00:34:53,589 --> 00:34:58,040
that's gonna be interesting to me and

856
00:34:55,969 --> 00:34:59,509
I'm not gonna know that it's not legit

857
00:34:58,040 --> 00:35:01,460
until I open it

858
00:34:59,510 --> 00:35:05,770
at which point if you're auditing access

859
00:35:01,460 --> 00:35:08,480
to that file you know I'm there exactly

860
00:35:05,770 --> 00:35:09,650
but if if people did that all the time

861
00:35:08,480 --> 00:35:11,680
and I had to start using other

862
00:35:09,650 --> 00:35:16,040
techniques that would be awesome

863
00:35:11,680 --> 00:35:19,730
so hunting sessions session files things

864
00:35:16,040 --> 00:35:20,540
like RDP RDP files that have creds bound

865
00:35:19,730 --> 00:35:25,060
to them

866
00:35:20,540 --> 00:35:27,230
SSH private keys FileZilla and winscp

867
00:35:25,060 --> 00:35:29,569
configuration files and have passwords

868
00:35:27,230 --> 00:35:31,550
in them you can look for those manually

869
00:35:29,569 --> 00:35:33,150
while you're out trawling for gold or

870
00:35:31,550 --> 00:35:35,310
you can use session go

871
00:35:33,150 --> 00:35:37,410
to search either the local system a

872
00:35:35,310 --> 00:35:41,040
remote system or every machine in the

873
00:35:37,410 --> 00:35:43,859
domain again that you have access to if

874
00:35:41,040 --> 00:35:45,690
you're doing the malicious user model or

875
00:35:43,860 --> 00:35:48,030
you're doing the model where you start

876
00:35:45,690 --> 00:35:50,130
with a workstation and outsi to like

877
00:35:48,030 --> 00:35:51,990
cobalt strike you can execute unmanaged

878
00:35:50,130 --> 00:35:54,330
PowerShell in memory so even if

879
00:35:51,990 --> 00:35:56,700
PowerShell is disabled on the box I can

880
00:35:54,330 --> 00:35:58,560
still execute power shell if I want to

881
00:35:56,700 --> 00:36:00,870
execute power shell on a machine that

882
00:35:58,560 --> 00:36:06,420
doesn't have it there's two ways there's

883
00:36:00,870 --> 00:36:07,650
there's D is C so the is C I believe

884
00:36:06,420 --> 00:36:10,140
it's the integrated scripting

885
00:36:07,650 --> 00:36:11,850
environment for PowerShell and it's a

886
00:36:10,140 --> 00:36:15,990
script pane and then your normal power

887
00:36:11,850 --> 00:36:19,170
shell prompt at the bottom if you paste

888
00:36:15,990 --> 00:36:21,839
a PowerShell script into the script pane

889
00:36:19,170 --> 00:36:26,700
and press the play button is that a

890
00:36:21,840 --> 00:36:30,390
script no no it is not a script it's

891
00:36:26,700 --> 00:36:33,660
just data that gets run it's basically

892
00:36:30,390 --> 00:36:36,359
runtime PowerShell so even if a script

893
00:36:33,660 --> 00:36:38,580
execution is disabled the the I forget

894
00:36:36,360 --> 00:36:41,760
the interactive interpreter says alright

895
00:36:38,580 --> 00:36:43,980
you can run this in the ISE so I can use

896
00:36:41,760 --> 00:36:47,580
the ISE script execution is disabled I

897
00:36:43,980 --> 00:36:50,730
can still execute power shell if that is

898
00:36:47,580 --> 00:36:53,580
taken away from me caveat with this you

899
00:36:50,730 --> 00:36:57,270
cannot save the file because if you save

900
00:36:53,580 --> 00:36:59,100
the file it becomes a script and now the

901
00:36:57,270 --> 00:37:01,440
ISE will say I can't execute that

902
00:36:59,100 --> 00:37:03,839
because it's a script and we have script

903
00:37:01,440 --> 00:37:06,330
execution disabled so do not save it

904
00:37:03,840 --> 00:37:09,210
just paste it in another great tool

905
00:37:06,330 --> 00:37:11,610
Brian Furman from Black Hills fullmetal

906
00:37:09,210 --> 00:37:13,410
cache has this tool called power line

907
00:37:11,610 --> 00:37:17,610
power line is a self-contained

908
00:37:13,410 --> 00:37:19,200
PowerShell environment that you give it

909
00:37:17,610 --> 00:37:21,300
a configuration file it says these are

910
00:37:19,200 --> 00:37:25,529
all the awesome power shell things that

911
00:37:21,300 --> 00:37:28,590
I want to include in my and executable

912
00:37:25,530 --> 00:37:31,770
and I want me me cats and I want I want

913
00:37:28,590 --> 00:37:32,760
all the Power View goodness and all the

914
00:37:31,770 --> 00:37:33,780
other things that you want to do with

915
00:37:32,760 --> 00:37:36,060
PowerShell that you can't because

916
00:37:33,780 --> 00:37:38,310
PowerShell is disabled you run the build

917
00:37:36,060 --> 00:37:40,560
script it will pull down all those

918
00:37:38,310 --> 00:37:44,880
scripts consume them and build them into

919
00:37:40,560 --> 00:37:46,500
a executable that now you can execute

920
00:37:44,880 --> 00:37:48,600
you can drop on box and exit

921
00:37:46,500 --> 00:37:51,990
Yul's powershell scripts from that

922
00:37:48,600 --> 00:37:54,660
executable AV will see it from time to

923
00:37:51,990 --> 00:37:56,250
time and it will get you caught so you

924
00:37:54,660 --> 00:37:59,190
have to deal with that you know you have

925
00:37:56,250 --> 00:38:02,160
to take care of that problem but the

926
00:37:59,190 --> 00:38:05,310
user the sysadmin will be blind to the

927
00:38:02,160 --> 00:38:08,640
execution they'll see system management

928
00:38:05,310 --> 00:38:11,060
our system dot automation management DLL

929
00:38:08,640 --> 00:38:14,640
gets loaded but I don't believe the most

930
00:38:11,060 --> 00:38:18,690
recent PowerShell older PowerShell they

931
00:38:14,640 --> 00:38:21,150
won't see the PowerShell actually being

932
00:38:18,690 --> 00:38:26,760
the commands with script lock enabled

933
00:38:21,150 --> 00:38:34,320
doing this so pros and cons of a sim

934
00:38:26,760 --> 00:38:35,820
breech testing the whole reason I think

935
00:38:34,320 --> 00:38:38,610
this is a better way of doing testing is

936
00:38:35,820 --> 00:38:39,990
it gives our customers a good

937
00:38:38,610 --> 00:38:42,840
understanding of their strengths and

938
00:38:39,990 --> 00:38:44,759
weaknesses as they pertain to more quote

939
00:38:42,840 --> 00:38:49,170
unquote real world as hackers then it

940
00:38:44,760 --> 00:38:52,020
then a network pen test does we can

941
00:38:49,170 --> 00:38:53,640
model our test using real-world tactics

942
00:38:52,020 --> 00:38:55,440
techniques and procedures so we can be

943
00:38:53,640 --> 00:38:58,650
as sophisticated as we want if we want

944
00:38:55,440 --> 00:39:00,000
to be apt 29 we'll be apt 29 will study

945
00:38:58,650 --> 00:39:02,730
their tactics and we'll use those

946
00:39:00,000 --> 00:39:05,760
tactics if we want to be some other ABT

947
00:39:02,730 --> 00:39:08,340
will do that or if we just kind of want

948
00:39:05,760 --> 00:39:10,920
to just run the test let's not model any

949
00:39:08,340 --> 00:39:15,120
adversary let's just do this test and

950
00:39:10,920 --> 00:39:18,480
see where we go we can do that too those

951
00:39:15,120 --> 00:39:20,759
are those are pros on the con side as a

952
00:39:18,480 --> 00:39:22,590
con is a consultant I have a limited

953
00:39:20,760 --> 00:39:24,540
amount of time I'm bounded by week

954
00:39:22,590 --> 00:39:26,820
timeframes most the time client wants a

955
00:39:24,540 --> 00:39:29,460
week long assume breach pen test an

956
00:39:26,820 --> 00:39:31,140
attacker has however long they want to

957
00:39:29,460 --> 00:39:33,900
compromise your organization so they can

958
00:39:31,140 --> 00:39:35,940
be really slow they can spend time and

959
00:39:33,900 --> 00:39:38,100
do something and then go back to sleep

960
00:39:35,940 --> 00:39:39,630
and hide themselves for a long time and

961
00:39:38,100 --> 00:39:41,250
then come back and do more things we

962
00:39:39,630 --> 00:39:43,290
don't have that luxury so we have to be

963
00:39:41,250 --> 00:39:47,000
noisier which means we might get caught

964
00:39:43,290 --> 00:39:50,850
so if we're doing a zero knowledge test

965
00:39:47,000 --> 00:39:52,620
we either get caught or we make less

966
00:39:50,850 --> 00:39:54,810
progress in the time we have possibly

967
00:39:52,620 --> 00:39:57,600
because we have to be slower so that's a

968
00:39:54,810 --> 00:39:59,700
con you have to be aware of we are not

969
00:39:57,600 --> 00:40:00,120
focused on vulnerabilities mention have

970
00:39:59,700 --> 00:40:03,299
to begin

971
00:40:00,120 --> 00:40:08,370
so if your environment is full of MS

972
00:40:03,300 --> 00:40:09,840
17:10 unless I'm pulling patch manifests

973
00:40:08,370 --> 00:40:12,540
from the local machine

974
00:40:09,840 --> 00:40:14,220
I won't I won't know that you're missing

975
00:40:12,540 --> 00:40:15,870
that patch because a lot of the times in

976
00:40:14,220 --> 00:40:18,689
these tests were not using exploits

977
00:40:15,870 --> 00:40:22,440
we're just abusing the system the way it

978
00:40:18,690 --> 00:40:24,840
works to get the data so we may not know

979
00:40:22,440 --> 00:40:26,550
that's there so we will not report on

980
00:40:24,840 --> 00:40:28,340
the vulnerabilities I report on

981
00:40:26,550 --> 00:40:31,530
vulnerabilities when I use a local

982
00:40:28,340 --> 00:40:33,180
privilege s exploit to escalate

983
00:40:31,530 --> 00:40:35,910
privileges on a workstation I will you

984
00:40:33,180 --> 00:40:37,049
report that there but I don't have

985
00:40:35,910 --> 00:40:38,790
knowledge of what's going on in the

986
00:40:37,050 --> 00:40:42,560
network so the customer doesn't know and

987
00:40:38,790 --> 00:40:46,140
if we don't tell them does it exist

988
00:40:42,560 --> 00:40:47,730
depends on the environment talked about

989
00:40:46,140 --> 00:40:49,529
the importance of representative

990
00:40:47,730 --> 00:40:52,740
accounts and workstations because again

991
00:40:49,530 --> 00:40:55,110
if I don't have a this Lenovo laptop and

992
00:40:52,740 --> 00:40:56,819
everyone in the organization has one I

993
00:40:55,110 --> 00:41:00,060
don't have that privilege escalation

994
00:40:56,820 --> 00:41:02,880
vector if I don't have the right domain

995
00:41:00,060 --> 00:41:04,890
groups for instance I was doing one of

996
00:41:02,880 --> 00:41:07,950
these tests recently and I was a member

997
00:41:04,890 --> 00:41:08,910
of the domain users group in the VPN

998
00:41:07,950 --> 00:41:11,069
users group

999
00:41:08,910 --> 00:41:14,339
I had no group membership I had no

1000
00:41:11,070 --> 00:41:17,310
access to anything fortunately this

1001
00:41:14,340 --> 00:41:20,850
organization had a Kerberos suitable

1002
00:41:17,310 --> 00:41:22,560
enterprise admin account service service

1003
00:41:20,850 --> 00:41:24,060
principal name with a really weak

1004
00:41:22,560 --> 00:41:25,620
password that I was able to craft and I

1005
00:41:24,060 --> 00:41:28,110
was able to get dough man domain admin

1006
00:41:25,620 --> 00:41:30,690
that way or Enterprise admin the other

1007
00:41:28,110 --> 00:41:32,580
wonderful thing they did for me is they

1008
00:41:30,690 --> 00:41:34,350
dropped me on the same box that the guy

1009
00:41:32,580 --> 00:41:38,100
that managed the enterprise password

1010
00:41:34,350 --> 00:41:40,950
manager used and he had just deployed

1011
00:41:38,100 --> 00:41:43,020
that a previous month and that previous

1012
00:41:40,950 --> 00:41:45,509
month that he just deployed it he had

1013
00:41:43,020 --> 00:41:47,670
guess what spreadsheets full of

1014
00:41:45,510 --> 00:41:49,680
passwords all over the network and so

1015
00:41:47,670 --> 00:41:52,890
that's the Box they put me on in that

1016
00:41:49,680 --> 00:41:55,529
folder was viewable so as like guys guys

1017
00:41:52,890 --> 00:41:56,790
like that's one of those things where

1018
00:41:55,530 --> 00:42:00,300
you look at it as a pen tester and you

1019
00:41:56,790 --> 00:42:02,880
looking to go just where's the camera

1020
00:42:00,300 --> 00:42:04,230
like this this can't be real Ajith you

1021
00:42:02,880 --> 00:42:05,640
don't want to use the creds she's like

1022
00:42:04,230 --> 00:42:06,930
there's no way if there's no way they

1023
00:42:05,640 --> 00:42:09,270
did this and you sit there for long

1024
00:42:06,930 --> 00:42:10,770
enough and you're like oh man the

1025
00:42:09,270 --> 00:42:13,029
password on that particular account

1026
00:42:10,770 --> 00:42:14,619
hasn't been changed in seven years like

1027
00:42:13,029 --> 00:42:16,209
I think this is legit let's try it

1028
00:42:14,619 --> 00:42:19,890
you're like you were now Enterprise to

1029
00:42:16,209 --> 00:42:23,229
Evan you're like wow day 1 hour 30

1030
00:42:19,890 --> 00:42:27,189
minutes into the test I got bad news

1031
00:42:23,229 --> 00:42:29,229
guys so this is a better way to prepare

1032
00:42:27,189 --> 00:42:34,149
our clients for the attacks that they're

1033
00:42:29,229 --> 00:42:35,739
likely to face out in the real world all

1034
00:42:34,150 --> 00:42:37,779
right right on time

1035
00:42:35,739 --> 00:42:39,279
this does require some maturity and

1036
00:42:37,779 --> 00:42:41,109
client processes though because if you

1037
00:42:39,279 --> 00:42:43,209
have a client that has never had a pen

1038
00:42:41,109 --> 00:42:45,759
test I have had those I did one this

1039
00:42:43,209 --> 00:42:48,788
year they're not ready most of the time

1040
00:42:45,759 --> 00:42:50,919
for these kinds of tests they need some

1041
00:42:48,789 --> 00:42:53,890
level of maturity they need some level

1042
00:42:50,919 --> 00:42:56,890
of hardening because otherwise it's such

1043
00:42:53,890 --> 00:42:57,848
a mess how do we even begin so let's do

1044
00:42:56,890 --> 00:43:00,400
some pen tests

1045
00:42:57,849 --> 00:43:03,009
let's fix let's let's turn off null

1046
00:43:00,400 --> 00:43:05,619
sessions let's disable SMB v1 you know

1047
00:43:03,009 --> 00:43:07,119
let's like not have 4 character

1048
00:43:05,619 --> 00:43:09,369
passwords let's start making the

1049
00:43:07,119 --> 00:43:10,989
organization more mature because you

1050
00:43:09,369 --> 00:43:12,939
have to be able to crawl before you can

1051
00:43:10,989 --> 00:43:15,219
walk before you can run and before you

1052
00:43:12,939 --> 00:43:17,199
can fight right and this is more like a

1053
00:43:15,219 --> 00:43:19,150
boxing match with with an infant if

1054
00:43:17,199 --> 00:43:21,519
they've never had a pen test before

1055
00:43:19,150 --> 00:43:23,380
sometimes they get lucky right like got

1056
00:43:21,519 --> 00:43:27,459
little fingers you know but most of the

1057
00:43:23,380 --> 00:43:29,890
time so we do those pen test cycles

1058
00:43:27,459 --> 00:43:32,019
before we do these and then we say let's

1059
00:43:29,890 --> 00:43:34,868
do this test in three years and this is

1060
00:43:32,019 --> 00:43:36,158
how we get ready for that we need to

1061
00:43:34,869 --> 00:43:37,779
work with the client to get good

1062
00:43:36,159 --> 00:43:39,819
accounts and workstations like we need

1063
00:43:37,779 --> 00:43:43,150
to help them understand tell them the

1064
00:43:39,819 --> 00:43:45,880
importance why we need these because it

1065
00:43:43,150 --> 00:43:48,969
not only hampers my test it's wasting

1066
00:43:45,880 --> 00:43:51,369
their dollars like like if they're not

1067
00:43:48,969 --> 00:43:52,779
getting the value I can't tell you what

1068
00:43:51,369 --> 00:43:54,819
would happen if our regular user gets

1069
00:43:52,779 --> 00:43:57,309
compromised because I don't know I never

1070
00:43:54,819 --> 00:43:59,919
saw that picture so it's a waste of

1071
00:43:57,309 --> 00:44:01,630
their money for me to not have that

1072
00:43:59,919 --> 00:44:04,179
access so it's important to explain that

1073
00:44:01,630 --> 00:44:06,759
and I've mentioned PowerShell and cobalt

1074
00:44:04,179 --> 00:44:08,529
strike here a bunch but these are not

1075
00:44:06,759 --> 00:44:13,229
the only things that you can use right

1076
00:44:08,529 --> 00:44:16,659
we've got Merlyn and faction c2 and

1077
00:44:13,229 --> 00:44:18,489
silent Trinity I think covenant

1078
00:44:16,659 --> 00:44:20,739
covenants another one covenants another

1079
00:44:18,489 --> 00:44:22,209
c2 that's that's up-and-coming there's a

1080
00:44:20,739 --> 00:44:24,069
lot of different c2 frameworks that are

1081
00:44:22,209 --> 00:44:25,538
out there that we can use we don't have

1082
00:44:24,069 --> 00:44:26,850
to use PowerShell

1083
00:44:25,539 --> 00:44:29,070
we could use iron

1084
00:44:26,850 --> 00:44:30,960
thought we could use boo Liang how many

1085
00:44:29,070 --> 00:44:34,260
no marchello from Black Hills white

1086
00:44:30,960 --> 00:44:36,360
bleeder his stuff you need you need to

1087
00:44:34,260 --> 00:44:38,250
chia well you need to check out

1088
00:44:36,360 --> 00:44:42,270
Marcello's stuff because he's doing this

1089
00:44:38,250 --> 00:44:44,820
some mind-blowing stuff like these

1090
00:44:42,270 --> 00:44:49,100
dotnet languages like boo lang so you

1091
00:44:44,820 --> 00:44:54,180
can take boo lang embedded in ironpython

1092
00:44:49,100 --> 00:44:57,630
embedded in powershell and then you can

1093
00:44:54,180 --> 00:44:58,980
run JavaScript from inside boo lang for

1094
00:44:57,630 --> 00:45:00,870
your like your payload like it's like

1095
00:44:58,980 --> 00:45:02,160
payload inception things are nested or

1096
00:45:00,870 --> 00:45:03,630
nested and nested and there's no

1097
00:45:02,160 --> 00:45:07,859
visibility for most of this out there

1098
00:45:03,630 --> 00:45:09,710
powershell you can see but boo lang and

1099
00:45:07,860 --> 00:45:11,610
ironpython most people don't have

1100
00:45:09,710 --> 00:45:13,590
instrumentation to see what's happening

1101
00:45:11,610 --> 00:45:17,490
there they're like system top management

1102
00:45:13,590 --> 00:45:19,290
automation DLL got loaded awesome but

1103
00:45:17,490 --> 00:45:20,700
they can't see anything else because it

1104
00:45:19,290 --> 00:45:22,500
doesn't do the script lock locking the

1105
00:45:20,700 --> 00:45:25,230
PowerShell does so that's a great weight

1106
00:45:22,500 --> 00:45:27,810
if you're a blue team can you see that

1107
00:45:25,230 --> 00:45:30,930
if if someone builds that on your

1108
00:45:27,810 --> 00:45:34,290
network will you see will you know you

1109
00:45:30,930 --> 00:45:35,970
should probably try so those are just

1110
00:45:34,290 --> 00:45:37,490
some examples don't think that I'm

1111
00:45:35,970 --> 00:45:40,700
saying these are the only way to operate

1112
00:45:37,490 --> 00:45:42,540
just examples to get you started so

1113
00:45:40,700 --> 00:45:44,879
that's me

1114
00:45:42,540 --> 00:45:46,680
this is me my cat red sitcom hard water

1115
00:45:44,880 --> 00:45:48,810
hacker on Twitter you can follow red

1116
00:45:46,680 --> 00:45:50,879
seas you InfoSec to get information

1117
00:45:48,810 --> 00:45:51,870
about our blogs and our web cast that

1118
00:45:50,880 --> 00:45:53,850
we're doing where we're gonna be

1119
00:45:51,870 --> 00:45:58,520
speaking things like that where you can

1120
00:45:53,850 --> 00:46:00,569
get the next great new t-shirt not here

1121
00:45:58,520 --> 00:46:01,710
because I didn't bring them not saying

1122
00:46:00,570 --> 00:46:04,170
that there's aren't you just can't get

1123
00:46:01,710 --> 00:46:07,800
the Red Sea t-shirt and again the slides

1124
00:46:04,170 --> 00:46:09,870
are at Red Sea's comm slash ABM so if

1125
00:46:07,800 --> 00:46:11,430
you want them feel free to download them

1126
00:46:09,870 --> 00:46:13,740
if you have questions afterwards hit me

1127
00:46:11,430 --> 00:46:15,390
up on Twitter hit me up on email if you

1128
00:46:13,740 --> 00:46:21,500
want stickers there's some on the table

1129
00:46:15,390 --> 00:46:21,500
out there with that any questions yes

1130
00:46:41,089 --> 00:46:45,930
so the question was what I'm talking to

1131
00:46:43,829 --> 00:46:47,609
the clients about their goals and and

1132
00:46:45,930 --> 00:46:49,308
trying to figure out what are the things

1133
00:46:47,609 --> 00:46:51,750
we should attack what should we target

1134
00:46:49,309 --> 00:46:53,579
am I trying to get an understanding of

1135
00:46:51,750 --> 00:46:55,319
their maturity and that is absolutely

1136
00:46:53,579 --> 00:46:57,210
true I'm trying to understand how much

1137
00:46:55,319 --> 00:47:00,140
here they are we asked them before like

1138
00:46:57,210 --> 00:47:02,579
though we want an assumed breech test

1139
00:47:00,140 --> 00:47:04,288
okay tell me about what you've done for

1140
00:47:02,579 --> 00:47:06,240
pen testing in the past tell me a little

1141
00:47:04,289 --> 00:47:08,369
bit about what your controls are that

1142
00:47:06,240 --> 00:47:11,759
are in place so we make sure that this

1143
00:47:08,369 --> 00:47:13,650
is value for you because we don't it's

1144
00:47:11,760 --> 00:47:15,150
just no fun to just go into an

1145
00:47:13,650 --> 00:47:17,609
organization that's not prepared for you

1146
00:47:15,150 --> 00:47:19,529
essentially there's better there's more

1147
00:47:17,609 --> 00:47:43,049
value that I could have doing other

1148
00:47:19,529 --> 00:47:44,849
tests for them more questions yes so the

1149
00:47:43,049 --> 00:47:47,880
question is at what level is the

1150
00:47:44,849 --> 00:47:51,450
customer we don't have a target vertical

1151
00:47:47,880 --> 00:47:53,190
or a target organization like some

1152
00:47:51,450 --> 00:47:55,078
companies like how we're focused on

1153
00:47:53,190 --> 00:47:55,589
healthcare we're focused on whoever pays

1154
00:47:55,079 --> 00:48:00,509
the bill

1155
00:47:55,589 --> 00:48:02,430
so I've done tests for very small the

1156
00:48:00,509 --> 00:48:05,369
hardest test I've ever done is for a

1157
00:48:02,430 --> 00:48:07,288
very very very small bank network in

1158
00:48:05,369 --> 00:48:11,609
South Dakota and that was in nightmare

1159
00:48:07,289 --> 00:48:13,950
that guys network is a monster like it's

1160
00:48:11,609 --> 00:48:18,750
terrifying how good as security controls

1161
00:48:13,950 --> 00:48:21,029
are we've done tests for large hospitals

1162
00:48:18,750 --> 00:48:23,130
in large financial institutions and

1163
00:48:21,029 --> 00:48:26,190
everything in between and sometimes

1164
00:48:23,130 --> 00:48:28,289
they're very technical people sometimes

1165
00:48:26,190 --> 00:48:30,420
it's a it's some type of contractually

1166
00:48:28,289 --> 00:48:33,660
obligated pen test and so we're talking

1167
00:48:30,420 --> 00:48:37,390
to compliance and you know whoever and

1168
00:48:33,660 --> 00:48:40,899
they're less technical however

1169
00:48:37,390 --> 00:48:43,270
we we try to adapt the conversation to

1170
00:48:40,900 --> 00:48:44,880
them so that making sure that they're

1171
00:48:43,270 --> 00:48:46,570
understanding what we're saying and

1172
00:48:44,880 --> 00:48:48,850
understanding the importance of the

1173
00:48:46,570 --> 00:48:51,640
things we're saying and our tests are

1174
00:48:48,850 --> 00:48:53,830
written in such a matter that the

1175
00:48:51,640 --> 00:48:55,990
reports should be understandable to

1176
00:48:53,830 --> 00:48:59,319
anyone that has a level of technical

1177
00:48:55,990 --> 00:49:01,060
proficiency and then we can always

1178
00:48:59,320 --> 00:49:06,060
consult if if they need if they have

1179
00:49:01,060 --> 00:49:06,060
questions any other questions

1180
00:49:06,660 --> 00:49:12,770
can't tell I don't I don't see any so

1181
00:49:09,880 --> 00:49:16,860
with that that's all I have yes yes

1182
00:49:12,770 --> 00:49:16,860
[Applause]

