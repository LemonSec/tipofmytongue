1
00:00:08,010 --> 00:00:17,770
Hey so this talk will be somewhat

2
00:00:15,160 --> 00:00:19,540
technical but I'm trying to explain this

3
00:00:17,770 --> 00:00:20,770
in the simplest way that I can and I

4
00:00:19,540 --> 00:00:25,270
think it should be pretty simple to

5
00:00:20,770 --> 00:00:27,790
follow me my name is Ron I've been

6
00:00:25,270 --> 00:00:29,680
helping with besides / long con forever

7
00:00:27,790 --> 00:00:31,210
this year I didn't really do the

8
00:00:29,680 --> 00:00:34,210
organizing beforehand I'm just here on

9
00:00:31,210 --> 00:00:36,940
site I work for a company called counter

10
00:00:34,210 --> 00:00:37,750
hack we make CTF challenges and other

11
00:00:36,940 --> 00:00:40,570
online stuff

12
00:00:37,750 --> 00:00:43,210
we every year we do a big CTF called

13
00:00:40,570 --> 00:00:45,820
Holly hack challenge which is it's a

14
00:00:43,210 --> 00:00:46,810
free online CTF this year particular

15
00:00:45,820 --> 00:00:49,390
we're doing Kringle con

16
00:00:46,810 --> 00:00:51,970
so every year Santa Claus is attacked by

17
00:00:49,390 --> 00:00:53,500
some super villain this year Santa's

18
00:00:51,970 --> 00:00:55,060
gathering all the hackers together at

19
00:00:53,500 --> 00:00:59,110
his virtual conference at the virtual

20
00:00:55,060 --> 00:01:01,690
North Pole to stop this once and for all

21
00:00:59,110 --> 00:01:03,460
so right as of now we have some parts of

22
00:01:01,690 --> 00:01:07,630
a open to play there's some Easter eggs

23
00:01:03,460 --> 00:01:09,430
some maps some things to see so check it

24
00:01:07,630 --> 00:01:14,408
out cool calm calm I've been charged of

25
00:01:09,430 --> 00:01:16,450
evangelizing so this talk in general

26
00:01:14,409 --> 00:01:18,700
will be my bio analysis and I wasn't

27
00:01:16,450 --> 00:01:20,950
kind of in the big picture I want to

28
00:01:18,700 --> 00:01:22,390
talk about my analysis more because I've

29
00:01:20,950 --> 00:01:23,740
been doing pen testing for my year and

30
00:01:22,390 --> 00:01:26,829
then every pen test I've done which is

31
00:01:23,740 --> 00:01:28,929
about five binary analysis in some form

32
00:01:26,829 --> 00:01:31,449
has gotten us a big victory this will be

33
00:01:28,929 --> 00:01:33,039
a very specific one however about web

34
00:01:31,450 --> 00:01:34,630
exec which is a vulnerability we found

35
00:01:33,039 --> 00:01:37,450
in the WebEx client that we disclosed

36
00:01:34,630 --> 00:01:39,068
about two weeks ago if you're curious to

37
00:01:37,450 --> 00:01:40,590
see all the information for these slides

38
00:01:39,069 --> 00:01:44,950
are all in WebEx ecto org as well

39
00:01:40,590 --> 00:01:46,329
presented differently so the problem

40
00:01:44,950 --> 00:01:47,950
with pen testing for me is I don't

41
00:01:46,329 --> 00:01:50,499
really know Windows that well or domains

42
00:01:47,950 --> 00:01:51,459
that I know how to break programs so the

43
00:01:50,499 --> 00:01:53,829
only tool you have is a Hammer Every

44
00:01:51,459 --> 00:01:55,090
Problem was like a nail right so every

45
00:01:53,829 --> 00:01:57,038
pen test you know we want you to look at

46
00:01:55,090 --> 00:01:59,259
this I know things advice oh look

47
00:01:57,039 --> 00:02:01,840
there's firmware I'm gonna find a JSON

48
00:01:59,259 --> 00:02:03,279
it can you look at this network oh look

49
00:02:01,840 --> 00:02:04,689
an exe file that updates to me

50
00:02:03,279 --> 00:02:07,689
financials like there's always something

51
00:02:04,689 --> 00:02:09,489
that I find that involves involves

52
00:02:07,689 --> 00:02:13,630
binary analysis and I think it's a

53
00:02:09,490 --> 00:02:14,200
really valuable skill to have so it can

54
00:02:13,630 --> 00:02:16,390
be daunting

55
00:02:14,200 --> 00:02:18,010
like what's this exe file do or what's

56
00:02:16,390 --> 00:02:21,730
this dot iso file in Linux do

57
00:02:18,010 --> 00:02:23,109
or whatever it's it's not always easy

58
00:02:21,730 --> 00:02:25,030
but there's some really simple

59
00:02:23,110 --> 00:02:27,970
techniques that can help you find what

60
00:02:25,030 --> 00:02:32,260
to actually look at and what is is worth

61
00:02:27,970 --> 00:02:33,849
your time here's some of them so for

62
00:02:32,260 --> 00:02:35,980
what's worth this talks mostly demos I

63
00:02:33,849 --> 00:02:38,109
saw a few slides - keV introduces the

64
00:02:35,980 --> 00:02:41,260
topics and then we'll just look at how

65
00:02:38,110 --> 00:02:42,400
we broke this so a few examples of

66
00:02:41,260 --> 00:02:43,870
things that we've done I've had tests

67
00:02:42,400 --> 00:02:45,359
which we have alluded to fuzzing

68
00:02:43,870 --> 00:02:47,170
firmware images JSON interface

69
00:02:45,359 --> 00:02:48,939
decrypting passwords for a password

70
00:02:47,170 --> 00:02:50,200
management app escalating the system

71
00:02:48,939 --> 00:02:52,209
privileges are locked down image which

72
00:02:50,200 --> 00:02:54,010
is what this was okay no main credit

73
00:02:52,209 --> 00:02:55,329
credits from a self-service to main tool

74
00:02:54,010 --> 00:02:58,269
like there's lots of things you can do

75
00:02:55,329 --> 00:02:59,470
with with binaries especially we just

76
00:02:58,269 --> 00:03:00,370
talked the last talks of a billion

77
00:02:59,470 --> 00:03:01,209
things this is about breaking those

78
00:03:00,370 --> 00:03:03,579
things that somebody else built

79
00:03:01,209 --> 00:03:05,500
companies have a lot of cruft we've run

80
00:03:03,579 --> 00:03:07,599
into exe files of every computer startup

81
00:03:05,500 --> 00:03:10,329
that was written in 2007 and vb6

82
00:03:07,599 --> 00:03:12,190
i shared to install I had to run vb6

83
00:03:10,329 --> 00:03:15,930
code to get this to work which involves

84
00:03:12,190 --> 00:03:15,930
a macro in office it was really fun

85
00:03:16,170 --> 00:03:20,920
so things I do and like I've literally

86
00:03:18,879 --> 00:03:22,629
just do these three or four things every

87
00:03:20,920 --> 00:03:25,000
time and if anything interesting comes

88
00:03:22,629 --> 00:03:27,578
up I dig deeper if I just move on

89
00:03:25,000 --> 00:03:28,959
run strings on things and strings - al

90
00:03:27,579 --> 00:03:31,150
that's the unicode version of strings

91
00:03:28,959 --> 00:03:33,849
I'll show you that soon they'll double

92
00:03:31,150 --> 00:03:35,230
all kinds of things look at the imports

93
00:03:33,849 --> 00:03:36,760
so what import is not a binary is

94
00:03:35,230 --> 00:03:39,638
functions it uses from the operating

95
00:03:36,760 --> 00:03:40,929
system or from other libraries look at

96
00:03:39,639 --> 00:03:43,900
this this calls that makes I look at the

97
00:03:40,930 --> 00:03:45,790
logs we'll see all those shortly but

98
00:03:43,900 --> 00:03:47,079
more often not everything you know can

99
00:03:45,790 --> 00:03:48,608
be done from these things and I'll

100
00:03:47,079 --> 00:03:50,019
basically show you how you can write

101
00:03:48,609 --> 00:03:52,260
both let's exploit just looking at log

102
00:03:50,019 --> 00:03:52,260
files

103
00:03:55,209 --> 00:03:59,109
so the specific scenario we do was

104
00:03:57,459 --> 00:04:00,760
assume an employee laptop was

105
00:03:59,109 --> 00:04:02,920
compromised fishing and stuff will work

106
00:04:00,760 --> 00:04:04,239
we'll get a laptop doesn't matter so the

107
00:04:02,920 --> 00:04:06,939
company's chips it's a laptop with a

108
00:04:04,239 --> 00:04:08,230
lockdown image the image was a user

109
00:04:06,939 --> 00:04:10,480
account on the laptop had the main

110
00:04:08,230 --> 00:04:13,238
account and pretty much nothing else no

111
00:04:10,480 --> 00:04:14,888
special permissions no software nothing

112
00:04:13,239 --> 00:04:16,298
that was a starting point really except

113
00:04:14,889 --> 00:04:21,100
for what's in the default image the gold

114
00:04:16,298 --> 00:04:22,270
image for this company so the cool was

115
00:04:21,100 --> 00:04:23,949
what kind of access can you get on the

116
00:04:22,270 --> 00:04:24,820
network or documents or whatever and

117
00:04:23,949 --> 00:04:26,199
there's lots you can do on the network

118
00:04:24,820 --> 00:04:28,659
level but like I said I don't know how

119
00:04:26,199 --> 00:04:31,330
to network stuff so I looked at the

120
00:04:28,660 --> 00:04:32,440
binaries are installed our first problem

121
00:04:31,330 --> 00:04:33,609
was being have us we didn't have an

122
00:04:32,440 --> 00:04:35,320
administrator account on the local

123
00:04:33,610 --> 00:04:36,910
machine and we didn't have an easy way

124
00:04:35,320 --> 00:04:38,860
to escalate encrypted hard drive so you

125
00:04:36,910 --> 00:04:41,949
can't do that and how do we actually get

126
00:04:38,860 --> 00:04:43,690
a privileged account so let's look at

127
00:04:41,949 --> 00:05:00,729
the easy way that did not work but that

128
00:04:43,690 --> 00:05:02,409
can work it's hard to target so this

129
00:05:00,729 --> 00:05:03,580
target I stalled WebEx on it's pretty

130
00:05:02,409 --> 00:05:09,250
much a base Windows operating system

131
00:05:03,580 --> 00:05:09,639
besides having WebEx so that'll be our

132
00:05:09,250 --> 00:05:14,370
target

133
00:05:09,639 --> 00:05:17,580
hi I'm ash plate here ready to go maybe

134
00:05:14,370 --> 00:05:17,580
maybe not

135
00:05:20,200 --> 00:05:30,550
oh

136
00:05:26,080 --> 00:05:33,330
screenshot not smart Eric I have the

137
00:05:30,550 --> 00:05:33,330
console for that VM

138
00:05:39,270 --> 00:05:42,750
good demo was

139
00:05:45,540 --> 00:05:50,360
this parts not as important so if this

140
00:05:47,400 --> 00:05:50,359
doesn't work I'll just skip this

141
00:05:56,719 --> 00:06:01,610
alright there's a tool called MSI venom

142
00:06:00,349 --> 00:06:02,959
first of all I'm just going to the

143
00:06:01,610 --> 00:06:03,830
simplest possible thing I'll make a back

144
00:06:02,959 --> 00:06:06,379
door and then run that by

145
00:06:03,830 --> 00:06:07,818
double-clicking on it so Metasploit

146
00:06:06,379 --> 00:06:09,499
framework of the tool chymosin venom to

147
00:06:07,819 --> 00:06:11,599
generate those back doors with arbitrary

148
00:06:09,499 --> 00:06:14,749
payload all I'm going to do is take

149
00:06:11,599 --> 00:06:16,519
their their example and just change IP

150
00:06:14,749 --> 00:06:28,579
address so when you write my surrender

151
00:06:16,519 --> 00:06:29,809
give an example change localhost so

152
00:06:28,579 --> 00:06:31,459
let's just earnest the exe file that way

153
00:06:29,809 --> 00:06:34,069
it runs it will open a back door and

154
00:06:31,459 --> 00:06:39,079
I'll just dump that to slash mount so I

155
00:06:34,069 --> 00:06:44,439
shared slash backdoor that exe this

156
00:06:39,079 --> 00:06:44,439
takes a few seconds to run water

157
00:06:54,160 --> 00:06:57,560
so this this shirt folder is just work

158
00:06:56,360 --> 00:07:03,550
copy to to so we'll show up here

159
00:06:57,560 --> 00:07:05,480
whenever it's ready there it goes

160
00:07:03,550 --> 00:07:07,580
alright so I this back door

161
00:07:05,480 --> 00:07:08,990
now I'll start listing they're running

162
00:07:07,580 --> 00:07:25,789
teepees nice plate this will be very

163
00:07:08,990 --> 00:07:26,600
familiar stuff use handlers payload so

164
00:07:25,790 --> 00:07:28,310
this will listen for the back door

165
00:07:26,600 --> 00:07:29,600
connection and this is all really simple

166
00:07:28,310 --> 00:07:31,880
stuff there's no firewalls dozen I had

167
00:07:29,600 --> 00:07:36,170
to worry about I run it it warns me I

168
00:07:31,880 --> 00:07:37,400
run anyway that's employee would know

169
00:07:36,170 --> 00:07:39,200
what use he is I'll get connection from

170
00:07:37,400 --> 00:07:41,030
the box if I look at my user ID

171
00:07:39,200 --> 00:07:43,370
I'm test user which is unprivileged user

172
00:07:41,030 --> 00:07:49,489
if I do something I think this would be

173
00:07:43,370 --> 00:07:53,140
my nope if I run post gather windows

174
00:07:49,490 --> 00:07:53,140
they're smart hash dump

175
00:07:53,170 --> 00:07:57,350
I'll get permissions error so I can't

176
00:07:55,700 --> 00:07:59,150
dump hashes I can't do anything fun like

177
00:07:57,350 --> 00:08:00,620
that I'm just a normal user that's

178
00:07:59,150 --> 00:08:03,950
really boring that's the actions that we

179
00:08:00,620 --> 00:08:05,210
had originally so now we were located

180
00:08:03,950 --> 00:08:09,010
different software installed and

181
00:08:05,210 --> 00:08:13,789
something that came that came up was

182
00:08:09,010 --> 00:08:15,590
program there it is so WebEx is

183
00:08:13,790 --> 00:08:19,180
installed as a service so there's the

184
00:08:15,590 --> 00:08:22,640
service file if you're run services.msc

185
00:08:19,180 --> 00:08:24,920
you'll see it in here as well cisco

186
00:08:22,640 --> 00:08:32,330
webex service keeps your software

187
00:08:24,920 --> 00:08:34,070
up-to-date and secure LOL so as is i'm

188
00:08:32,330 --> 00:08:36,470
privileged user I can start the service

189
00:08:34,070 --> 00:08:38,240
it's gonna fail but I can start it so

190
00:08:36,470 --> 00:08:39,940
like instantly like I have permission to

191
00:08:38,240 --> 00:08:44,390
start this that's not good

192
00:08:39,940 --> 00:08:47,450
the second piece of this is this folder

193
00:08:44,390 --> 00:08:51,080
as a unpublish user I can change it I

194
00:08:47,450 --> 00:08:56,150
can move sit another bit oops so if I

195
00:08:51,080 --> 00:08:58,010
just take this back door whoops let's

196
00:08:56,150 --> 00:09:01,790
get this in the right place

197
00:08:58,010 --> 00:09:05,770
I move the backdoor into here on the

198
00:09:01,790 --> 00:09:13,689
program it copy it over here

199
00:09:05,770 --> 00:09:21,740
rename it to web X service and then

200
00:09:13,690 --> 00:09:24,680
let's start this listener again do do

201
00:09:21,740 --> 00:09:28,430
start the service and look I get

202
00:09:24,680 --> 00:09:38,209
connection as system so now I have full

203
00:09:28,430 --> 00:09:39,739
privileges and I can as my favor

204
00:09:38,210 --> 00:09:49,220
examples because look school is dumped

205
00:09:39,740 --> 00:09:52,670
with the hashes you'll see the password

206
00:09:49,220 --> 00:09:54,230
next demo anyway so this is gonna fail

207
00:09:52,670 --> 00:09:55,969
it'll kill in three seconds

208
00:09:54,230 --> 00:09:58,850
that's fine you can make a real service

209
00:09:55,970 --> 00:10:01,550
if you want so this seemed really good

210
00:09:58,850 --> 00:10:03,860
and we tried that this company used

211
00:10:01,550 --> 00:10:05,209
application whitelisting so we couldn't

212
00:10:03,860 --> 00:10:08,030
just replace the service with our file

213
00:10:05,210 --> 00:10:11,510
we tried all kinds of things to bypass

214
00:10:08,030 --> 00:10:13,880
whitelisting nothing worked but we did

215
00:10:11,510 --> 00:10:16,580
learn is a WebEx service what's the

216
00:10:13,880 --> 00:10:17,990
wrong one what did we learn a service in

217
00:10:16,580 --> 00:10:20,150
a readable writable folder is a huge

218
00:10:17,990 --> 00:10:21,500
risk even if we couldn't start the

219
00:10:20,150 --> 00:10:22,670
service ourselves we could replace it

220
00:10:21,500 --> 00:10:24,610
then wait for somebody else to started

221
00:10:22,670 --> 00:10:27,050
or reboot the machine like that was

222
00:10:24,610 --> 00:10:27,980
might be a big win if the customer

223
00:10:27,050 --> 00:10:32,540
didn't use the application whitelisting

224
00:10:27,980 --> 00:10:33,830
which completely wrecked it so so yeah

225
00:10:32,540 --> 00:10:35,990
we spent the better part of day try

226
00:10:33,830 --> 00:10:37,760
figure this out eventually I'm like what

227
00:10:35,990 --> 00:10:39,230
does this way back surface actually do

228
00:10:37,760 --> 00:10:43,400
and this is what the binary analysis

229
00:10:39,230 --> 00:10:45,190
part starts so I have that load of my

230
00:10:43,400 --> 00:10:47,600
analysis machine

231
00:10:45,190 --> 00:10:49,400
so we'll just we use Ida you can use

232
00:10:47,600 --> 00:10:50,570
various tools like strings and stuff for

233
00:10:49,400 --> 00:10:52,790
most of what we're doing but

234
00:10:50,570 --> 00:10:55,220
realistically I that will do everything

235
00:10:52,790 --> 00:10:57,170
I need so two things I mention earlier

236
00:10:55,220 --> 00:10:59,240
strings imports let's take a look at

237
00:10:57,170 --> 00:11:00,439
those so I don't know the font on this

238
00:10:59,240 --> 00:11:02,390
is kind of small so I'm not gonna dwell

239
00:11:00,440 --> 00:11:03,980
on this slide too much or this screen

240
00:11:02,390 --> 00:11:06,800
too much there i couldnt find a way to

241
00:11:03,980 --> 00:11:07,850
make this font bigger but if you look

242
00:11:06,800 --> 00:11:10,310
through this you'll see lots of service

243
00:11:07,850 --> 00:11:11,390
stuff update service description create

244
00:11:10,310 --> 00:11:15,140
service look up

245
00:11:11,390 --> 00:11:16,760
account log version these are all

246
00:11:15,140 --> 00:11:18,319
different permissions SC debug privilege

247
00:11:16,760 --> 00:11:20,120
sq token these are all like service

248
00:11:18,320 --> 00:11:21,680
things which is not super interesting

249
00:11:20,120 --> 00:11:23,660
that's probably just for creating itself

250
00:11:21,680 --> 00:11:24,920
creating a service or whatever then we

251
00:11:23,660 --> 00:11:26,449
see other things that are more

252
00:11:24,920 --> 00:11:29,360
interesting like software update and

253
00:11:26,450 --> 00:11:30,980
wait for a command executed and and the

254
00:11:29,360 --> 00:11:32,360
service was in or uninstalled the

255
00:11:30,980 --> 00:11:33,560
service was installed successfully all

256
00:11:32,360 --> 00:11:40,370
these things sound kind of interesting

257
00:11:33,560 --> 00:11:44,030
so what does it actually do so what does

258
00:11:40,370 --> 00:11:46,970
this actually do one of the things oh

259
00:11:44,030 --> 00:11:48,560
yeah the other piece is imports so the

260
00:11:46,970 --> 00:11:50,480
import of the function that calls from

261
00:11:48,560 --> 00:11:52,910
in this case is from Windows kernel 32

262
00:11:50,480 --> 00:11:53,900
system stuff doesn't matter the thing

263
00:11:52,910 --> 00:11:55,520
that came that thing that I saw

264
00:11:53,900 --> 00:11:58,430
innocently was this one create process

265
00:11:55,520 --> 00:12:00,650
as user this service in some way can

266
00:11:58,430 --> 00:12:02,900
start another process if we can make a

267
00:12:00,650 --> 00:12:04,459
start the process that we wanted to then

268
00:12:02,900 --> 00:12:07,640
we have a process ring a system and then

269
00:12:04,460 --> 00:12:10,850
we're finished so how can we do that

270
00:12:07,640 --> 00:12:12,470
well you know I had a good feeling when

271
00:12:10,850 --> 00:12:15,020
I saw this and it's a pretty short

272
00:12:12,470 --> 00:12:16,730
program otherwise so I'm like okay let's

273
00:12:15,020 --> 00:12:19,340
dig into this a little bit

274
00:12:16,730 --> 00:12:21,460
we're on customer time oh this is being

275
00:12:19,340 --> 00:12:21,460
recorded

276
00:12:22,930 --> 00:12:26,569
so if you google tree process user

277
00:12:25,670 --> 00:12:28,550
you'll see it takes a bunch of

278
00:12:26,570 --> 00:12:30,620
parameters all the parameters are right

279
00:12:28,550 --> 00:12:32,689
here the application name the

280
00:12:30,620 --> 00:12:34,340
command-line token blah blah what we

281
00:12:32,690 --> 00:12:36,110
really care about if you read the API

282
00:12:34,340 --> 00:12:38,090
description you'll see the token the

283
00:12:36,110 --> 00:12:39,980
command-line matter the token means what

284
00:12:38,090 --> 00:12:42,500
user runs as the command-line means what

285
00:12:39,980 --> 00:12:43,880
it actually runs so if we I'll go really

286
00:12:42,500 --> 00:12:45,650
really really quickly to this function

287
00:12:43,880 --> 00:12:47,990
because it's a lot of gobbledygook if

288
00:12:45,650 --> 00:12:49,340
you've never seen assembly but we what

289
00:12:47,990 --> 00:12:51,710
we want to look at is the API calls

290
00:12:49,340 --> 00:12:53,180
create tool helps 32 snapshot is a

291
00:12:51,710 --> 00:12:54,680
Windows API if you google it you'll find

292
00:12:53,180 --> 00:12:56,180
all the information for getting a list

293
00:12:54,680 --> 00:12:59,030
of all the processes from there running

294
00:12:56,180 --> 00:13:01,420
currently then process 32 first and

295
00:12:59,030 --> 00:13:03,709
process 32 next go to each process

296
00:13:01,420 --> 00:13:05,750
basically this finds a process that

297
00:13:03,710 --> 00:13:08,360
wants to open a handle to know this is a

298
00:13:05,750 --> 00:13:09,650
little matter it's just this process of

299
00:13:08,360 --> 00:13:12,020
looking at what's happening is really

300
00:13:09,650 --> 00:13:14,750
really really important open process

301
00:13:12,020 --> 00:13:17,270
token duplicate token close close

302
00:13:14,750 --> 00:13:19,280
process then clay processes user this

303
00:13:17,270 --> 00:13:22,010
students of calls is extremely extremely

304
00:13:19,280 --> 00:13:24,020
common to create a process with a

305
00:13:22,010 --> 00:13:24,980
privilege of another process if you take

306
00:13:24,020 --> 00:13:25,260
two or three of these and google them

307
00:13:24,980 --> 00:13:27,810
you'll

308
00:13:25,260 --> 00:13:29,010
find a bunch of commands doing that so

309
00:13:27,810 --> 00:13:30,359
you can figure exactly is happening it's

310
00:13:29,010 --> 00:13:33,200
functioning without ever looking at the

311
00:13:30,360 --> 00:13:36,390
assembly really just what's being called

312
00:13:33,200 --> 00:13:38,700
so the process is creating things under

313
00:13:36,390 --> 00:13:40,040
is win logon when log it also runs our

314
00:13:38,700 --> 00:13:42,030
system so that's a really good sign

315
00:13:40,040 --> 00:13:44,370
basically what this function is doing

316
00:13:42,030 --> 00:13:46,620
it's getting a handle to win login when

317
00:13:44,370 --> 00:13:50,250
log on to exe and open another process

318
00:13:46,620 --> 00:13:51,750
as that user which a system it's ok we

319
00:13:50,250 --> 00:13:53,580
want this function to happen how do we

320
00:13:51,750 --> 00:13:56,370
make this function happen that's the big

321
00:13:53,580 --> 00:13:59,910
question here so if you look around this

322
00:13:56,370 --> 00:14:02,520
program you'll see lots of lots of lots

323
00:13:59,910 --> 00:14:03,900
of everything what I care about is

324
00:14:02,520 --> 00:14:08,699
there's a bunch of error messages that

325
00:14:03,900 --> 00:14:11,699
are used throughout if I go jumping this

326
00:14:08,700 --> 00:14:13,170
fast error messages and log messages xq

327
00:14:11,700 --> 00:14:15,600
service command command not recognized

328
00:14:13,170 --> 00:14:17,699
stuff like that where do those get

329
00:14:15,600 --> 00:14:19,140
printed if that's a log file I can start

330
00:14:17,700 --> 00:14:21,810
using those error messages to build my

331
00:14:19,140 --> 00:14:24,720
payload if it's the Windows Windows

332
00:14:21,810 --> 00:14:25,739
Event log same thing and if you look in

333
00:14:24,720 --> 00:14:28,260
this function this one is the event log

334
00:14:25,740 --> 00:14:30,360
register event source and report event

335
00:14:28,260 --> 00:14:33,000
okay so it's reporting all this stuff is

336
00:14:30,360 --> 00:14:35,100
doing to Windows Event log let's see

337
00:14:33,000 --> 00:14:40,080
what that looks like and that's gonna be

338
00:14:35,100 --> 00:14:41,780
assembly part basically alright even

339
00:14:40,080 --> 00:14:45,840
fewer I need to run this as

340
00:14:41,780 --> 00:14:47,939
administrator obviously we didn't do all

341
00:14:45,840 --> 00:14:49,590
this on the machine from the customer we

342
00:14:47,940 --> 00:14:56,360
did this in our on our own machine the

343
00:14:49,590 --> 00:14:59,250
analysis so it's a bad password I know

344
00:14:56,360 --> 00:15:02,100
so I mentioned earlier I don't I don't

345
00:14:59,250 --> 00:15:05,280
Windows so I just make a log that

346
00:15:02,100 --> 00:15:07,650
contains everything and windows logs is

347
00:15:05,280 --> 00:15:08,790
where the services are okay Jake usually

348
00:15:07,650 --> 00:15:11,579
arrows saying there's too many log files

349
00:15:08,790 --> 00:15:12,900
I just pissed okay people who actually

350
00:15:11,580 --> 00:15:15,350
do this from are laughing at me but

351
00:15:12,900 --> 00:15:15,350
that's ok

352
00:15:16,010 --> 00:15:20,819
alright so here's the logs from stuff

353
00:15:19,110 --> 00:15:22,560
happening then I'm going to open a

354
00:15:20,820 --> 00:15:24,960
command shell again this is a complete

355
00:15:22,560 --> 00:15:32,609
unprivileged user I should make this

356
00:15:24,960 --> 00:15:35,680
bigger properties font

357
00:15:32,610 --> 00:15:40,090
that's the biggest okay good talk

358
00:15:35,680 --> 00:15:41,469
there we go oh yeah okay so let's just

359
00:15:40,090 --> 00:15:43,150
start a service Oh

360
00:15:41,470 --> 00:15:51,130
let's start let's fix the service then

361
00:15:43,150 --> 00:15:52,410
start it so delete the evil one what I

362
00:15:51,130 --> 00:15:57,130
just do

363
00:15:52,410 --> 00:16:02,319
delete the evil one replace it with the

364
00:15:57,130 --> 00:16:04,750
real one I hope and then try starting it

365
00:16:02,320 --> 00:16:07,090
it's gonna start and immediately stop

366
00:16:04,750 --> 00:16:08,020
that's just how the service works I can

367
00:16:07,090 --> 00:16:10,900
start over and over again and it just

368
00:16:08,020 --> 00:16:14,350
starts and stops okay what to do in the

369
00:16:10,900 --> 00:16:16,090
event log WebEx service runs with a

370
00:16:14,350 --> 00:16:17,770
warning it has an information that

371
00:16:16,090 --> 00:16:20,800
warning each time the invasion says

372
00:16:17,770 --> 00:16:23,439
you're running version black okay the

373
00:16:20,800 --> 00:16:26,229
warning says not enough command-line

374
00:16:23,440 --> 00:16:27,940
parameters oh okay let's have some

375
00:16:26,230 --> 00:16:28,650
family of parameters then how many do

376
00:16:27,940 --> 00:16:33,420
you want

377
00:16:28,650 --> 00:16:37,420
ABCD alphabet okay whatever

378
00:16:33,420 --> 00:16:41,709
run it again it starts at stops what's

379
00:16:37,420 --> 00:16:45,339
the event log the event log says service

380
00:16:41,710 --> 00:16:52,060
command not recognized be okay what else

381
00:16:45,340 --> 00:16:53,530
do you have service command then this

382
00:16:52,060 --> 00:16:56,680
says service command not recognized

383
00:16:53,530 --> 00:16:58,689
service can end okay what what did it

384
00:16:56,680 --> 00:17:01,709
want we're good look at assembly again

385
00:16:58,690 --> 00:17:06,060
just for a second we're gonna look up on

386
00:17:01,710 --> 00:17:10,510
what's service planned not recognized

387
00:17:06,060 --> 00:17:13,240
service service in America I still look

388
00:17:10,510 --> 00:17:15,520
at that what triggers this let's look up

389
00:17:13,240 --> 00:17:18,459
a bit the string software update is

390
00:17:15,520 --> 00:17:21,220
there that sounds like a string let's

391
00:17:18,459 --> 00:17:23,670
try that this is don't tell my boss this

392
00:17:21,220 --> 00:17:23,670
is how I work

393
00:17:25,780 --> 00:17:30,260
yeah

394
00:17:27,169 --> 00:17:33,260
software update that what's new error

395
00:17:30,260 --> 00:17:36,580
message application error the program

396
00:17:33,260 --> 00:17:41,240
crashed at oh now I've broken something

397
00:17:36,580 --> 00:17:43,610
so this this jump right now is what took

398
00:17:41,240 --> 00:17:45,740
me most of a day to figure out because I

399
00:17:43,610 --> 00:17:47,418
totally missed the very obvious thing so

400
00:17:45,740 --> 00:17:49,309
the application crashed every time I

401
00:17:47,419 --> 00:17:51,950
tried anything with the error code at

402
00:17:49,309 --> 00:17:54,139
four zero zero zero zero one five which

403
00:17:51,950 --> 00:17:55,370
is if you look it up isn't abort so

404
00:17:54,140 --> 00:17:56,510
something went wrong in the program I

405
00:17:55,370 --> 00:17:58,780
bought it and just bailed out and said I

406
00:17:56,510 --> 00:18:04,879
can't handle this

407
00:17:58,780 --> 00:18:06,710
what is it so um this is ID bog I had to

408
00:18:04,880 --> 00:18:08,480
like take a bunch of stuff if I just

409
00:18:06,710 --> 00:18:10,250
went into the function that's called and

410
00:18:08,480 --> 00:18:13,640
looked a bit the first thing it does

411
00:18:10,250 --> 00:18:18,470
really is do a bunch of math stuff xmm

412
00:18:13,640 --> 00:18:20,030
zero and all that and WC s tod that's a

413
00:18:18,470 --> 00:18:22,760
function again just Google as function

414
00:18:20,030 --> 00:18:25,340
it converts a number to a number string

415
00:18:22,760 --> 00:18:28,610
to a number so the string 1 2 3 2 the

416
00:18:25,340 --> 00:18:30,740
number 1 2 3 and then if it fails a

417
00:18:28,610 --> 00:18:32,120
bunch of errors error out of range error

418
00:18:30,740 --> 00:18:33,919
there's error that it just wants a

419
00:18:32,120 --> 00:18:37,250
number instead of a lighter that's all

420
00:18:33,919 --> 00:18:40,700
at once so we're gonna that took me a

421
00:18:37,250 --> 00:18:43,820
way too much time so I'll go change C to

422
00:18:40,700 --> 00:18:49,370
1 that's a good number we run it we

423
00:18:43,820 --> 00:18:55,270
check the error log and it gets really

424
00:18:49,370 --> 00:18:55,270
slow that shouldn't happen how I saw it

425
00:19:00,710 --> 00:19:04,049
remember kids and everyone knows okay

426
00:19:02,639 --> 00:19:09,149
that was the opposite order but it's

427
00:19:04,049 --> 00:19:12,418
okay we're almost done in this our new

428
00:19:09,149 --> 00:19:14,908
warning is start update process create

429
00:19:12,419 --> 00:19:17,909
process as user with parameters des oh

430
00:19:14,909 --> 00:19:24,990
hey that's what we wanted what if we

431
00:19:17,909 --> 00:19:30,330
change d EF to calc hey look

432
00:19:24,990 --> 00:19:32,009
calc is running now so we just used we

433
00:19:30,330 --> 00:19:33,928
just use WebEx itself to run our own

434
00:19:32,009 --> 00:19:35,700
program and if we can run things like

435
00:19:33,929 --> 00:19:42,799
CMD those are assigned so we can run

436
00:19:35,700 --> 00:19:49,789
those just fine if you run this this

437
00:19:42,799 --> 00:19:49,789
that calc is running a system yay

438
00:19:50,450 --> 00:19:56,490
so that was really cool

439
00:19:52,950 --> 00:19:58,799
then we ran CMD and nothing happened and

440
00:19:56,490 --> 00:20:01,139
I still don't know why nothing happens

441
00:19:58,799 --> 00:20:02,759
it's a mystery me but we figured after

442
00:20:01,139 --> 00:20:04,649
how do you start programs there's like

443
00:20:02,759 --> 00:20:08,279
many ways to start programs so I used

444
00:20:04,649 --> 00:20:10,469
yes Mac I know and yeah guys so I don't

445
00:20:08,279 --> 00:20:15,480
know why just beats me why but double I

446
00:20:10,470 --> 00:20:19,200
see process call create CMD does work I

447
00:20:15,480 --> 00:20:20,730
don't know why but it runs a system so

448
00:20:19,200 --> 00:20:23,070
yeah now we had a way to escalate to a

449
00:20:20,730 --> 00:20:29,190
system command prompt on the image that

450
00:20:23,070 --> 00:20:31,490
was locked down all right so I have five

451
00:20:29,190 --> 00:20:31,490
minutes left

452
00:20:35,300 --> 00:20:39,030
all right so we learned that WebEx

453
00:20:37,740 --> 00:20:42,690
service is basically sure though but

454
00:20:39,030 --> 00:20:44,100
with no password it's great so we so we

455
00:20:42,690 --> 00:20:46,110
use this the customer is happy we were

456
00:20:44,100 --> 00:20:48,060
happy well that week later we're gonna

457
00:20:46,110 --> 00:20:50,580
be reporting this - what - Cisco and and

458
00:20:48,060 --> 00:20:55,290
my corner says can she services remotely

459
00:20:50,580 --> 00:21:02,000
I thought oh crap you can so let's do a

460
00:20:55,290 --> 00:21:04,889
demo so from the analysis box

461
00:21:02,000 --> 00:21:07,280
this requires little bit of window Xing

462
00:21:04,890 --> 00:21:09,590
I gonna make this fun big again

463
00:21:07,280 --> 00:21:18,870
properties I know I do it this time

464
00:21:09,590 --> 00:21:19,980
font another one there alright so first

465
00:21:18,870 --> 00:21:21,209
of all you to start a session against

466
00:21:19,980 --> 00:21:23,160
the other machine using the account that

467
00:21:21,210 --> 00:21:25,230
we have you need account this can be

468
00:21:23,160 --> 00:21:27,660
done honestly but it does need to be a

469
00:21:25,230 --> 00:21:30,000
good account just any domain account so

470
00:21:27,660 --> 00:21:32,670
we're gonna do not use slash you test

471
00:21:30,000 --> 00:21:36,900
user is account are using I don't it one

472
00:21:32,670 --> 00:21:38,630
six 850 6.10 that one's a session I get

473
00:21:36,900 --> 00:21:42,440
in my password which is also test user

474
00:21:38,630 --> 00:21:48,090
and then we run SC one two Monday's 8.50

475
00:21:42,440 --> 00:21:49,920
610 start we're back service a software

476
00:21:48,090 --> 00:21:55,350
update one calc

477
00:21:49,920 --> 00:21:56,910
I miss the TN start I'm just gonna go to

478
00:21:55,350 --> 00:22:02,969
this and close everything so you can see

479
00:21:56,910 --> 00:22:05,250
that this is real and then start it and

480
00:22:02,970 --> 00:22:10,800
calc starts so now we've a remote pond

481
00:22:05,250 --> 00:22:14,130
ability so we might miss a module

482
00:22:10,800 --> 00:22:18,659
cuz that's what you do so find this

483
00:22:14,130 --> 00:22:23,370
point again we're gonna use exploit /

484
00:22:18,660 --> 00:22:28,430
windows / sm b / web exec we're gonna

485
00:22:23,370 --> 00:22:32,280
set our host to our target the 6.10

486
00:22:28,430 --> 00:22:39,200
we're gonna set our payload to payload

487
00:22:32,280 --> 00:22:39,200
to windows meterpreter close

488
00:22:39,380 --> 00:22:47,820
and exploit oh oh I had to get an

489
00:22:44,940 --> 00:22:53,190
account that's we user test users set

490
00:22:47,820 --> 00:22:55,260
SMB pass test user so it's gonna upload

491
00:22:53,190 --> 00:22:58,830
the payload by having the maximum length

492
00:22:55,260 --> 00:23:00,960
about 200 300 upload each one as a VBS

493
00:22:58,830 --> 00:23:06,439
script in base64 then decode the whole

494
00:23:00,960 --> 00:23:10,559
thing run it and we have a shell yay

495
00:23:06,440 --> 00:23:21,210
system using a low privileged account so

496
00:23:10,559 --> 00:23:23,158
that is that's why pic sec good next

497
00:23:21,210 --> 00:23:24,299
demo i probably this demo yeah i forgot

498
00:23:23,159 --> 00:23:26,940
what i was practicing so i put that

499
00:23:24,299 --> 00:23:28,168
slide in so once we found this we told

500
00:23:26,940 --> 00:23:29,880
cisco about it and they were really cool

501
00:23:28,169 --> 00:23:31,289
they helped that they went back and

502
00:23:29,880 --> 00:23:33,000
forth a lot to take our advice on

503
00:23:31,289 --> 00:23:34,559
patches i think their patch might be

504
00:23:33,000 --> 00:23:35,549
insufficient if you wanna do some

505
00:23:34,559 --> 00:23:37,649
research you could probably find a

506
00:23:35,549 --> 00:23:39,059
bypasses inner patch but they patched it

507
00:23:37,649 --> 00:23:40,799
last month and now we can talk about it

508
00:23:39,059 --> 00:23:43,020
which is really nice

509
00:23:40,799 --> 00:23:43,950
WebEx dr. org is my site we talked about

510
00:23:43,020 --> 00:23:45,690
the patches we talked about the

511
00:23:43,950 --> 00:23:49,289
vulnerability the whole talk the step by

512
00:23:45,690 --> 00:23:51,029
step is all on that site and yeah that's

513
00:23:49,289 --> 00:23:53,100
all my defense I've got a friend I know

514
00:23:51,029 --> 00:23:54,510
if he's here rich might be around but

515
00:23:53,100 --> 00:23:56,399
whenever I tell my house co new

516
00:23:54,510 --> 00:23:57,990
volunteer they always says how do I fix

517
00:23:56,399 --> 00:24:00,689
it I go oh yeah

518
00:23:57,990 --> 00:24:01,380
so I always put a defense light at the

519
00:24:00,690 --> 00:24:04,440
end in his honor

520
00:24:01,380 --> 00:24:07,049
even ones really bad yeah anyway that's

521
00:24:04,440 --> 00:24:09,090
a very quick intro and reversing just

522
00:24:07,049 --> 00:24:11,700
using error messages logs and strings to

523
00:24:09,090 --> 00:24:14,220
figure out what's going on so I think

524
00:24:11,700 --> 00:24:21,419
Mac's give him a good graph the state

525
00:24:14,220 --> 00:24:23,070
yep time's up is lunch ready okay they

526
00:24:21,419 --> 00:24:24,570
are setting up lunch so while they're

527
00:24:23,070 --> 00:24:28,158
doing that I can take some questions and

528
00:24:24,570 --> 00:24:32,399
then we'll break for lunch and restart

529
00:24:28,159 --> 00:24:34,020
winter so I need questions I know I was

530
00:24:32,399 --> 00:24:38,580
really fast but all that were

531
00:24:34,020 --> 00:24:41,520
informations on my website yes Eric do I

532
00:24:38,580 --> 00:24:44,820
have any hints on the patch so the way

533
00:24:41,520 --> 00:24:46,770
the patch works is it makes sure that

534
00:24:44,820 --> 00:24:48,600
everything that WebEx runs is signed by

535
00:24:46,770 --> 00:24:52,139
WebEx so won't just run the arbitrary

536
00:24:48,600 --> 00:24:55,350
program like CMV or calc ill instead

537
00:24:52,140 --> 00:24:57,990
only Cisco sign stuff if there's a

538
00:24:55,350 --> 00:25:07,219
problem other Cisco sign stuff that's

539
00:24:57,990 --> 00:25:17,100
not my nothing I can talk about it so um

540
00:25:07,220 --> 00:25:19,230
think that's Oh Emile I mean this whole

541
00:25:17,100 --> 00:25:20,520
talk was about WebEx update Exe so I

542
00:25:19,230 --> 00:25:24,960
think there's an update err I don't

543
00:25:20,520 --> 00:25:26,549
really how it works I there on the on

544
00:25:24,960 --> 00:25:27,929
the website on Cisco's advisory they

545
00:25:26,549 --> 00:25:30,030
give instructions for both corporate and

546
00:25:27,929 --> 00:25:31,320
for individuals I know for individuals

547
00:25:30,030 --> 00:25:32,790
is to go click in the corner and press

548
00:25:31,320 --> 00:25:34,439
check for update and just automatic

549
00:25:32,790 --> 00:25:40,830
installs it for corporate I'm not really

550
00:25:34,440 --> 00:25:42,090
sure but there's instructions yeah yeah

551
00:25:40,830 --> 00:25:44,750
there's a monthly update and it was part

552
00:25:42,090 --> 00:25:44,750
of that monthly update

