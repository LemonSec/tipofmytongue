1
00:00:00,240 --> 00:00:04,720
hello and welcome to from on pram to the

2
00:00:02,639 --> 00:00:06,720
cloud session my name is siri and i will

3
00:00:04,720 --> 00:00:07,600
be presenter dude during the next 45

4
00:00:06,720 --> 00:00:09,679
minutes

5
00:00:07,600 --> 00:00:12,719
uh what this session is all about in

6
00:00:09,679 --> 00:00:16,720
this session i'm gonna show you how

7
00:00:12,719 --> 00:00:18,480
you may get access to the cloud id

8
00:00:16,720 --> 00:00:20,720
microsoft cloud id

9
00:00:18,480 --> 00:00:23,039
when you have some sort of access some

10
00:00:20,720 --> 00:00:24,640
level of access on premises

11
00:00:23,039 --> 00:00:28,080
so that's going to be the path from

12
00:00:24,640 --> 00:00:29,519
on-prem id to the cloud id

13
00:00:28,080 --> 00:00:31,199
and this session will be based on live

14
00:00:29,519 --> 00:00:33,200
demos so you will not see a lot of

15
00:00:31,199 --> 00:00:34,800
slides here most of the time i'm gonna

16
00:00:33,200 --> 00:00:36,640
show you how to do it

17
00:00:34,800 --> 00:00:37,520
um

18
00:00:36,640 --> 00:00:39,680
live

19
00:00:37,520 --> 00:00:41,600
uh before i start to show you this let

20
00:00:39,680 --> 00:00:45,280
me say a few words about myself my name

21
00:00:41,600 --> 00:00:48,000
is sergey once again um i am a fantastic

22
00:00:45,280 --> 00:00:49,760
instructor conference speaker so i speak

23
00:00:48,000 --> 00:00:51,440
at different conferences like

24
00:00:49,760 --> 00:00:53,280
conferences from

25
00:00:51,440 --> 00:00:55,840
microsoft headquarter

26
00:00:53,280 --> 00:00:59,120
globalizer security b sites wild west

27
00:00:55,840 --> 00:01:01,440
hack and fast here and adversary village

28
00:00:59,120 --> 00:01:04,159
and so on

29
00:01:01,440 --> 00:01:05,920
and if you want to contact me

30
00:01:04,159 --> 00:01:08,240
after this session you want to ask me

31
00:01:05,920 --> 00:01:10,240
something or you want to see what other

32
00:01:08,240 --> 00:01:11,280
sessions i have and you want to watch

33
00:01:10,240 --> 00:01:12,560
them

34
00:01:11,280 --> 00:01:15,119
here's the link here's the link to

35
00:01:12,560 --> 00:01:17,040
usually i announce my other my other

36
00:01:15,119 --> 00:01:19,280
talks i have number of certifications

37
00:01:17,040 --> 00:01:21,680
and awards you can see some of them

38
00:01:19,280 --> 00:01:24,960
listed but i hope that's not your goal

39
00:01:21,680 --> 00:01:27,759
to listen about me the whole session

40
00:01:24,960 --> 00:01:30,000
and so let me jump to agenda and let's

41
00:01:27,759 --> 00:01:31,439
start our content

42
00:01:30,000 --> 00:01:32,640
all right so what we're going to cover

43
00:01:31,439 --> 00:01:33,840
here

44
00:01:32,640 --> 00:01:36,159
in this session i'm going to show you

45
00:01:33,840 --> 00:01:39,680
first um

46
00:01:36,159 --> 00:01:42,079
what is azure edit connect and how and

47
00:01:39,680 --> 00:01:43,600
how it may be compromised so

48
00:01:42,079 --> 00:01:45,439
like this

49
00:01:43,600 --> 00:01:47,680
that's a classic way to integrate

50
00:01:45,439 --> 00:01:49,920
on-prem id with to the cloud id azure id

51
00:01:47,680 --> 00:01:52,240
connect and how to maybe compromise what

52
00:01:49,920 --> 00:01:54,079
what may be the bad configuration

53
00:01:52,240 --> 00:01:56,560
then i'm gonna show you new offering

54
00:01:54,079 --> 00:01:58,159
from microsoft which is azure ad connect

55
00:01:56,560 --> 00:02:01,119
cloud sync

56
00:01:58,159 --> 00:02:02,799
um and we can we will see how that may

57
00:02:01,119 --> 00:02:05,200
be compromised as well

58
00:02:02,799 --> 00:02:07,040
then we will bypass uh mfa and

59
00:02:05,200 --> 00:02:08,959
authentication prompt

60
00:02:07,040 --> 00:02:11,360
and start to enumerate the cloud but for

61
00:02:08,959 --> 00:02:13,520
enumeration i might i must also bypass

62
00:02:11,360 --> 00:02:16,720
mz or msi

63
00:02:13,520 --> 00:02:19,440
and finally we're gonna quickly talk uh

64
00:02:16,720 --> 00:02:20,640
what should we do to mitigate those

65
00:02:19,440 --> 00:02:22,400
problems

66
00:02:20,640 --> 00:02:24,080
all right as i mentioned before

67
00:02:22,400 --> 00:02:26,720
um this session will be based on live

68
00:02:24,080 --> 00:02:28,400
demos so i'm going to switch to demo and

69
00:02:26,720 --> 00:02:31,280
let's get started so first i want to

70
00:02:28,400 --> 00:02:32,640
show you what uh azure ad connect is

71
00:02:31,280 --> 00:02:33,920
just in case if you if you haven't

72
00:02:32,640 --> 00:02:36,560
worked with that before

73
00:02:33,920 --> 00:02:39,040
so azure id connect that's that's this

74
00:02:36,560 --> 00:02:41,360
that's the tool from microsoft free tool

75
00:02:39,040 --> 00:02:44,239
of course uh and this tool may be used

76
00:02:41,360 --> 00:02:46,319
to synchronize your on-premise cd uh to

77
00:02:44,239 --> 00:02:48,400
the cloud id

78
00:02:46,319 --> 00:02:50,239
um and when you can configure this tool

79
00:02:48,400 --> 00:02:53,680
one of the things that you must do you

80
00:02:50,239 --> 00:02:55,120
must connect to your on-prem id here

81
00:02:53,680 --> 00:02:57,680
so um

82
00:02:55,120 --> 00:02:59,360
like you will type uh enterprise admin

83
00:02:57,680 --> 00:03:00,800
username and password

84
00:02:59,360 --> 00:03:03,200
and

85
00:03:00,800 --> 00:03:04,400
ad connect will create an account that

86
00:03:03,200 --> 00:03:06,400
will be used

87
00:03:04,400 --> 00:03:08,640
for synchronization

88
00:03:06,400 --> 00:03:10,480
so let me show you this

89
00:03:08,640 --> 00:03:12,959
because i already have i already have

90
00:03:10,480 --> 00:03:16,560
that configured if i go to the main

91
00:03:12,959 --> 00:03:18,959
controller and go to users so here is an

92
00:03:16,560 --> 00:03:21,519
account msrl underscores something

93
00:03:18,959 --> 00:03:24,080
something and that just

94
00:03:21,519 --> 00:03:26,879
just a regular user if i go to to to

95
00:03:24,080 --> 00:03:29,840
member off just just the main user so

96
00:03:26,879 --> 00:03:30,840
nothing special with this account

97
00:03:29,840 --> 00:03:33,599
uh

98
00:03:30,840 --> 00:03:35,040
but but

99
00:03:33,599 --> 00:03:36,720
uh that account

100
00:03:35,040 --> 00:03:37,840
may um

101
00:03:36,720 --> 00:03:39,840
that account

102
00:03:37,840 --> 00:03:41,200
may have number of permissions extra

103
00:03:39,840 --> 00:03:44,159
permissions

104
00:03:41,200 --> 00:03:46,319
if you enable some features one the

105
00:03:44,159 --> 00:03:49,440
feature one the features which is very

106
00:03:46,319 --> 00:03:51,680
popular called password hash sync if you

107
00:03:49,440 --> 00:03:54,159
turn this feature on

108
00:03:51,680 --> 00:03:57,599
account for synchronization let's this

109
00:03:54,159 --> 00:03:57,599
adds connector account

110
00:03:57,760 --> 00:04:03,519
will have extra permission it will have

111
00:04:00,159 --> 00:04:05,200
permission to replicate active directory

112
00:04:03,519 --> 00:04:06,720
so those permissions replicate directory

113
00:04:05,200 --> 00:04:07,680
changes and replica directory changes

114
00:04:06,720 --> 00:04:09,760
all

115
00:04:07,680 --> 00:04:10,879
now let me let me show you where they

116
00:04:09,760 --> 00:04:11,760
are

117
00:04:10,879 --> 00:04:13,680
so

118
00:04:11,760 --> 00:04:15,439
in my ad connect i enable password

119
00:04:13,680 --> 00:04:17,759
hashing and by the way it's very

120
00:04:15,439 --> 00:04:19,519
recommended option so most most

121
00:04:17,759 --> 00:04:21,840
companies they enable password hash

122
00:04:19,519 --> 00:04:23,600
settings so passwords uh password hash

123
00:04:21,840 --> 00:04:25,759
of course synchronized from on prem to

124
00:04:23,600 --> 00:04:27,520
the cloud as well uh we use that for

125
00:04:25,759 --> 00:04:29,280
resiliency

126
00:04:27,520 --> 00:04:31,440
and so that that's enabled for many

127
00:04:29,280 --> 00:04:32,560
companies if i go to properties of my

128
00:04:31,440 --> 00:04:34,000
domain

129
00:04:32,560 --> 00:04:37,600
go to security

130
00:04:34,000 --> 00:04:37,600
and find this msrl

131
00:04:38,000 --> 00:04:42,600
so

132
00:04:38,960 --> 00:04:42,600
here are

133
00:04:42,639 --> 00:04:47,199
those permissions they are delegated

134
00:04:45,520 --> 00:04:49,759
so

135
00:04:47,199 --> 00:04:53,280
that's just just a normal typical

136
00:04:49,759 --> 00:04:55,840
configuration of ad connect now where

137
00:04:53,280 --> 00:05:00,080
we may have the problem the problem is

138
00:04:55,840 --> 00:05:02,880
if someone can own this account

139
00:05:00,080 --> 00:05:05,680
an attacker if if he or she owns the

140
00:05:02,880 --> 00:05:07,039
account will have those permissions that

141
00:05:05,680 --> 00:05:08,160
and those permissions are quite

142
00:05:07,039 --> 00:05:10,479
privileged

143
00:05:08,160 --> 00:05:12,720
are quite high so let me show you how i

144
00:05:10,479 --> 00:05:13,840
can own this account first

145
00:05:12,720 --> 00:05:16,000
and then what they can do with those

146
00:05:13,840 --> 00:05:17,680
privileges this account

147
00:05:16,000 --> 00:05:18,720
we don't know the password of this

148
00:05:17,680 --> 00:05:21,440
account

149
00:05:18,720 --> 00:05:23,680
so we must find the password first

150
00:05:21,440 --> 00:05:27,280
let me jump back to adconnect now let me

151
00:05:23,680 --> 00:05:29,280
show you how we can get that password

152
00:05:27,280 --> 00:05:31,680
uh let me cancel that

153
00:05:29,280 --> 00:05:33,039
so to get the pass this password is

154
00:05:31,680 --> 00:05:36,479
stored in

155
00:05:33,039 --> 00:05:39,840
adconnect database if i open this table

156
00:05:36,479 --> 00:05:39,840
management agent

157
00:05:40,800 --> 00:05:47,280
and

158
00:05:42,639 --> 00:05:47,280
let me remove those columns i don't need

159
00:05:47,360 --> 00:05:52,960
and let me just keep a few of them and

160
00:05:50,240 --> 00:05:54,240
run that

161
00:05:52,960 --> 00:05:55,600
now if i

162
00:05:54,240 --> 00:05:58,160
look for

163
00:05:55,600 --> 00:06:00,160
credentials look at this so it says

164
00:05:58,160 --> 00:06:02,240
username is here msrl underscore

165
00:06:00,160 --> 00:06:04,840
something something and password also

166
00:06:02,240 --> 00:06:07,199
here but password is

167
00:06:04,840 --> 00:06:08,960
encrypted not that simple so you will

168
00:06:07,199 --> 00:06:10,319
not be able to just take password in a

169
00:06:08,960 --> 00:06:11,840
plain text

170
00:06:10,319 --> 00:06:13,600
all right but there's another way how

171
00:06:11,840 --> 00:06:15,840
can we do how can we get password we

172
00:06:13,600 --> 00:06:17,039
must we must decrypt that to the grid

173
00:06:15,840 --> 00:06:19,520
password

174
00:06:17,039 --> 00:06:22,000
what do we what we must do we must

175
00:06:19,520 --> 00:06:24,560
become the main no sorry not i mean we

176
00:06:22,000 --> 00:06:26,479
must become local administrator on this

177
00:06:24,560 --> 00:06:29,919
ad connect server so at connect

178
00:06:26,479 --> 00:06:33,440
administrator can decrypt this password

179
00:06:29,919 --> 00:06:35,680
decryption process is quite tedious if

180
00:06:33,440 --> 00:06:37,120
you do it manually but

181
00:06:35,680 --> 00:06:39,919
luckily we have

182
00:06:37,120 --> 00:06:41,919
we have people we have good researchers

183
00:06:39,919 --> 00:06:44,479
and they and they

184
00:06:41,919 --> 00:06:46,160
give us tools and on the tool called ad

185
00:06:44,479 --> 00:06:49,120
connect dump

186
00:06:46,160 --> 00:06:50,240
um so if you just run edit connect dump

187
00:06:49,120 --> 00:06:54,240
look at this

188
00:06:50,240 --> 00:06:55,280
i have a password

189
00:06:54,240 --> 00:06:57,440
from

190
00:06:55,280 --> 00:06:59,039
the sql database

191
00:06:57,440 --> 00:07:01,520
and decrypt it

192
00:06:59,039 --> 00:07:03,520
uh so and by the way on um so you can

193
00:07:01,520 --> 00:07:06,000
find this tool on github and you will

194
00:07:03,520 --> 00:07:08,240
also find the article from author of

195
00:07:06,000 --> 00:07:09,680
this tool and he explains how to do all

196
00:07:08,240 --> 00:07:10,720
of this manually if you want to do it

197
00:07:09,680 --> 00:07:13,520
manually

198
00:07:10,720 --> 00:07:15,680
but manual process will take a while so

199
00:07:13,520 --> 00:07:18,160
i will not be able to fit into my my

200
00:07:15,680 --> 00:07:20,800
session all right let me copy this

201
00:07:18,160 --> 00:07:23,120
password

202
00:07:20,800 --> 00:07:25,039
um and now what i can do so now i have

203
00:07:23,120 --> 00:07:27,120
now i own user

204
00:07:25,039 --> 00:07:28,639
now what i can do with this

205
00:07:27,120 --> 00:07:30,400
credentials let me

206
00:07:28,639 --> 00:07:32,800
open first command prompt on a different

207
00:07:30,400 --> 00:07:32,800
machine

208
00:07:35,759 --> 00:07:39,680
at the same time

209
00:07:37,440 --> 00:07:42,000
i'm going to

210
00:07:39,680 --> 00:07:44,400
run this different user

211
00:07:42,000 --> 00:07:45,759
let's type a mass style user and click

212
00:07:44,400 --> 00:07:48,000
ok

213
00:07:45,759 --> 00:07:50,720
uh it will take some time before command

214
00:07:48,000 --> 00:07:52,560
prompt will appear so let me first check

215
00:07:50,720 --> 00:07:54,319
who am i

216
00:07:52,560 --> 00:07:56,319
here

217
00:07:54,319 --> 00:07:58,720
i'm i'm using your data let's take a

218
00:07:56,319 --> 00:08:01,120
look if i have permissions to enumerate

219
00:07:58,720 --> 00:08:04,319
a c drive from the main controller

220
00:08:01,120 --> 00:08:06,560
no access denies so i'm just a regular

221
00:08:04,319 --> 00:08:08,400
maybe i'm a local admin but i'm not the

222
00:08:06,560 --> 00:08:09,919
administrator on the main controller so

223
00:08:08,400 --> 00:08:11,759
i don't have to maintain admin

224
00:08:09,919 --> 00:08:13,599
permissions all right let's try

225
00:08:11,759 --> 00:08:14,479
something else let's let's type who am i

226
00:08:13,599 --> 00:08:16,639
here

227
00:08:14,479 --> 00:08:18,639
and this user this command prompt from

228
00:08:16,639 --> 00:08:20,479
ms oil user let's try to enumerate

229
00:08:18,639 --> 00:08:23,440
domain controller as well access the

230
00:08:20,479 --> 00:08:25,599
knight again so no luck

231
00:08:23,440 --> 00:08:27,199
but we don't really need that at this

232
00:08:25,599 --> 00:08:29,520
moment because

233
00:08:27,199 --> 00:08:31,680
now we have permission to replicate

234
00:08:29,520 --> 00:08:34,399
directory changes

235
00:08:31,680 --> 00:08:37,440
with this permission i can i can

236
00:08:34,399 --> 00:08:41,039
synchronize i can replicate information

237
00:08:37,440 --> 00:08:42,320
and and password hashes of any user in

238
00:08:41,039 --> 00:08:43,919
the in the

239
00:08:42,320 --> 00:08:45,600
in the company in this network in this

240
00:08:43,919 --> 00:08:47,920
domain so

241
00:08:45,600 --> 00:08:50,560
let me go to see

242
00:08:47,920 --> 00:08:50,560
tools

243
00:08:50,720 --> 00:08:54,880
oh

244
00:08:52,000 --> 00:08:57,120
mimi cats and let me run very well known

245
00:08:54,880 --> 00:08:59,040
tool called mini cats

246
00:08:57,120 --> 00:09:02,240
now in mimikatz what i want to do i want

247
00:08:59,040 --> 00:09:04,480
to i want to say dc uh

248
00:09:02,240 --> 00:09:06,320
lsa dump dc sync and i want to

249
00:09:04,480 --> 00:09:08,399
synchronize information about trainer

250
00:09:06,320 --> 00:09:12,240
and trainer he is

251
00:09:08,399 --> 00:09:14,640
he or she is the main administrator

252
00:09:12,240 --> 00:09:16,800
so let's see that

253
00:09:14,640 --> 00:09:19,519
now i can see hash

254
00:09:16,800 --> 00:09:20,480
password hash of this user now let's go

255
00:09:19,519 --> 00:09:23,120
to

256
00:09:20,480 --> 00:09:25,040
let's open mimikat again

257
00:09:23,120 --> 00:09:27,680
uh let's run mimics here

258
00:09:25,040 --> 00:09:30,000
and let's say privileged debug

259
00:09:27,680 --> 00:09:32,399
and i want to run command which is very

260
00:09:30,000 --> 00:09:36,000
well known called pass the hash i will

261
00:09:32,399 --> 00:09:37,920
copy this ntlm and paste here

262
00:09:36,000 --> 00:09:40,880
and now i have another command prompt

263
00:09:37,920 --> 00:09:42,560
let's try to dr dc

264
00:09:40,880 --> 00:09:43,839
fingers crossed

265
00:09:42,560 --> 00:09:45,040
yay

266
00:09:43,839 --> 00:09:48,880
now i have

267
00:09:45,040 --> 00:09:51,360
access to the main controller that means

268
00:09:48,880 --> 00:09:54,320
i became the main administrator

269
00:09:51,360 --> 00:09:56,160
so um when you when we have

270
00:09:54,320 --> 00:09:59,040
when we have

271
00:09:56,160 --> 00:09:59,920
uh at connect when we have ad connect

272
00:09:59,040 --> 00:10:01,839
uh

273
00:09:59,920 --> 00:10:03,360
and password hash sync is enabled which

274
00:10:01,839 --> 00:10:04,480
is quite common

275
00:10:03,360 --> 00:10:06,399
uh

276
00:10:04,480 --> 00:10:09,760
what what what may happen

277
00:10:06,399 --> 00:10:11,839
uh this account first for hds account

278
00:10:09,760 --> 00:10:14,000
will have quite a lot of quite a lot of

279
00:10:11,839 --> 00:10:15,680
permissions and so you must be very

280
00:10:14,000 --> 00:10:16,720
careful uh

281
00:10:15,680 --> 00:10:18,800
who

282
00:10:16,720 --> 00:10:20,880
when you delegate permissions who is who

283
00:10:18,800 --> 00:10:23,760
is ad connect administrator

284
00:10:20,880 --> 00:10:25,360
so please be careful with 80 connect

285
00:10:23,760 --> 00:10:26,959
administrators don't provide this

286
00:10:25,360 --> 00:10:28,720
permissions to

287
00:10:26,959 --> 00:10:30,720
like middle level administrators because

288
00:10:28,720 --> 00:10:31,680
they can become the main admins quite

289
00:10:30,720 --> 00:10:33,519
easily

290
00:10:31,680 --> 00:10:35,519
all right so that's that's that's the

291
00:10:33,519 --> 00:10:37,839
first thing that's that's the classic

292
00:10:35,519 --> 00:10:40,240
configuration ad connect when we install

293
00:10:37,839 --> 00:10:42,560
the whole server inside of our network

294
00:10:40,240 --> 00:10:44,640
um and so we have it uh we can

295
00:10:42,560 --> 00:10:46,480
compromise like this there's a num

296
00:10:44,640 --> 00:10:49,600
there's there's a there are some other

297
00:10:46,480 --> 00:10:51,200
ways how can we achieve this result um

298
00:10:49,600 --> 00:10:53,600
because if you google a lot you will

299
00:10:51,200 --> 00:10:55,279
find some other ways if you have like a

300
00:10:53,600 --> 00:10:57,760
past pass through authentication and

301
00:10:55,279 --> 00:10:59,760
some other ways to authenticate and id

302
00:10:57,760 --> 00:11:01,680
connect um how they may also be

303
00:10:59,760 --> 00:11:02,800
compromised so i'm not going to show you

304
00:11:01,680 --> 00:11:04,560
all of those

305
00:11:02,800 --> 00:11:06,240
all of all of those ways to compromise

306
00:11:04,560 --> 00:11:10,320
it connect uh

307
00:11:06,240 --> 00:11:12,079
just check this one and make sure

308
00:11:10,320 --> 00:11:15,600
on the domain administrators can i can

309
00:11:12,079 --> 00:11:18,480
manage ad connect all right so uh we

310
00:11:15,600 --> 00:11:21,760
discussed the ad connect ad connect uh

311
00:11:18,480 --> 00:11:21,760
how it may be used to

312
00:11:22,320 --> 00:11:26,800
synchronize accounts and then the more

313
00:11:24,720 --> 00:11:28,480
important how we can compromise that and

314
00:11:26,800 --> 00:11:29,600
what misconfigurations what should you

315
00:11:28,480 --> 00:11:32,240
not do

316
00:11:29,600 --> 00:11:35,680
um let's take a look on another option

317
00:11:32,240 --> 00:11:37,839
which is azure ad cloud sync azure id

318
00:11:35,680 --> 00:11:41,040
connect cloud sync cloud sync that's

319
00:11:37,839 --> 00:11:43,600
when we don't have the full

320
00:11:41,040 --> 00:11:45,360
engine on premises so we don't install

321
00:11:43,600 --> 00:11:49,680
the full server

322
00:11:45,360 --> 00:11:52,480
the actual engine will be in the cloud

323
00:11:49,680 --> 00:11:56,079
but on pram we just going to install

324
00:11:52,480 --> 00:11:59,279
agent so let's take a look here

325
00:11:56,079 --> 00:12:03,120
here lightweight agent installation mode

326
00:11:59,279 --> 00:12:03,120
so we just install agent on premises

327
00:12:03,440 --> 00:12:08,160
so that this configuration doesn't

328
00:12:05,920 --> 00:12:11,279
support all the features of ad connect

329
00:12:08,160 --> 00:12:12,560
so nowadays not that popular

330
00:12:11,279 --> 00:12:14,639
but

331
00:12:12,560 --> 00:12:16,639
i guess because that's the new offering

332
00:12:14,639 --> 00:12:18,480
from microsoft it will have more and

333
00:12:16,639 --> 00:12:20,480
more features later on

334
00:12:18,480 --> 00:12:22,959
so what if you decide to switch to cloud

335
00:12:20,480 --> 00:12:25,680
scene um

336
00:12:22,959 --> 00:12:27,920
how it will look like let me just go to

337
00:12:25,680 --> 00:12:27,920
um

338
00:12:28,480 --> 00:12:33,440
to

339
00:12:29,440 --> 00:12:35,680
the cloud and if i go to azure id

340
00:12:33,440 --> 00:12:38,720
so here we can uh in azure

341
00:12:35,680 --> 00:12:40,079
active directory we can find azure 80

342
00:12:38,720 --> 00:12:43,040
connect blade

343
00:12:40,079 --> 00:12:46,000
and and under that there is a manage

344
00:12:43,040 --> 00:12:47,760
azure 80 cloud sync click here

345
00:12:46,000 --> 00:12:50,160
and so what i must do first i must

346
00:12:47,760 --> 00:12:51,600
download agent and install to one of the

347
00:12:50,160 --> 00:12:54,000
servers

348
00:12:51,600 --> 00:12:56,000
if i switch to that server look at this

349
00:12:54,000 --> 00:12:57,360
so i have a server where i have this ad

350
00:12:56,000 --> 00:12:59,200
connect installed

351
00:12:57,360 --> 00:13:01,440
and what how can you find this ad

352
00:12:59,200 --> 00:13:04,160
connect presence if you go to

353
00:13:01,440 --> 00:13:04,160
services

354
00:13:05,519 --> 00:13:11,760
um find microsoft

355
00:13:09,120 --> 00:13:12,959
ad connect provision agent so this agent

356
00:13:11,760 --> 00:13:14,880
is installed

357
00:13:12,959 --> 00:13:17,040
uh and so what you can do here by the

358
00:13:14,880 --> 00:13:17,920
way don't worry about degradation that

359
00:13:17,040 --> 00:13:19,360
that

360
00:13:17,920 --> 00:13:21,279
it's because my demo environment was

361
00:13:19,360 --> 00:13:23,680
turned off for a long time

362
00:13:21,279 --> 00:13:25,839
so if i go to configuration

363
00:13:23,680 --> 00:13:27,440
here in the cloud

364
00:13:25,839 --> 00:13:28,720
i can

365
00:13:27,440 --> 00:13:30,720
configure

366
00:13:28,720 --> 00:13:33,440
my sync also by the way i can

367
00:13:30,720 --> 00:13:36,160
synchronize password hashes as well

368
00:13:33,440 --> 00:13:40,160
and if we stick on as password hashes so

369
00:13:36,160 --> 00:13:43,120
we may uh face the same issue that the

370
00:13:40,160 --> 00:13:44,079
passports may be uh replicated by the

371
00:13:43,120 --> 00:13:45,760
account

372
00:13:44,079 --> 00:13:47,920
but the problem here with with this

373
00:13:45,760 --> 00:13:49,360
cloud sync not a problem that's that

374
00:13:47,920 --> 00:13:51,920
like

375
00:13:49,360 --> 00:13:54,320
like like like a difference between uh

376
00:13:51,920 --> 00:13:58,399
ad connect and cloud sync in case of

377
00:13:54,320 --> 00:14:00,320
cloud sync we don't have server we don't

378
00:13:58,399 --> 00:14:02,480
have uh like a

379
00:14:00,320 --> 00:14:04,160
user account we don't don't have sql

380
00:14:02,480 --> 00:14:06,399
database where where this account is

381
00:14:04,160 --> 00:14:10,079
stored so that's a bit different let's

382
00:14:06,399 --> 00:14:12,160
take a look um how it will be will be

383
00:14:10,079 --> 00:14:15,440
configured in case of ad connect cloud

384
00:14:12,160 --> 00:14:17,199
sync if i click on the agent i can find

385
00:14:15,440 --> 00:14:20,160
that the agent

386
00:14:17,199 --> 00:14:24,079
is work on behalf of a group managed

387
00:14:20,160 --> 00:14:25,440
service account or gmsa

388
00:14:24,079 --> 00:14:26,800
and

389
00:14:25,440 --> 00:14:29,760
so

390
00:14:26,800 --> 00:14:31,839
in case of gmsa there is no password

391
00:14:29,760 --> 00:14:33,680
which is stored locally

392
00:14:31,839 --> 00:14:36,480
so that's an account in uh in active

393
00:14:33,680 --> 00:14:39,680
directory on primary directory and some

394
00:14:36,480 --> 00:14:41,440
sort of servers may retrieve password of

395
00:14:39,680 --> 00:14:43,199
this account from id

396
00:14:41,440 --> 00:14:44,560
let me show you this if i go to the main

397
00:14:43,199 --> 00:14:48,720
controller

398
00:14:44,560 --> 00:14:52,880
here is a group manager's account

399
00:14:48,720 --> 00:14:55,440
uh nothing here if i go to properties

400
00:14:52,880 --> 00:14:58,320
so if you go to attribute editor you may

401
00:14:55,440 --> 00:15:00,160
find here like information about pass

402
00:14:58,320 --> 00:15:02,240
for password id

403
00:15:00,160 --> 00:15:05,279
password interval because this password

404
00:15:02,240 --> 00:15:08,000
will be changed by the series account

405
00:15:05,279 --> 00:15:11,040
all right so now i can see that this

406
00:15:08,000 --> 00:15:14,240
account is not typical

407
00:15:11,040 --> 00:15:15,199
um but how we can uh take this account

408
00:15:14,240 --> 00:15:19,279
over

409
00:15:15,199 --> 00:15:22,639
um let me go back to my server

410
00:15:19,279 --> 00:15:24,320
i'm going to to to

411
00:15:22,639 --> 00:15:26,639
open powershell

412
00:15:24,320 --> 00:15:28,480
let me type one command let me just type

413
00:15:26,639 --> 00:15:29,759
this

414
00:15:28,480 --> 00:15:31,440
now it says

415
00:15:29,759 --> 00:15:32,959
uh that this

416
00:15:31,440 --> 00:15:35,680
this account

417
00:15:32,959 --> 00:15:37,839
um there's a principle that allowed to

418
00:15:35,680 --> 00:15:41,279
retrieve manage path manage password and

419
00:15:37,839 --> 00:15:42,959
this principle is uh agent so the name

420
00:15:41,279 --> 00:15:43,759
of this principle is agent let's take a

421
00:15:42,959 --> 00:15:44,800
look

422
00:15:43,759 --> 00:15:46,590
who

423
00:15:44,800 --> 00:15:47,680
hostname not where my hostname

424
00:15:46,590 --> 00:15:49,440
[Music]

425
00:15:47,680 --> 00:15:51,440
and i can see the agent that's the

426
00:15:49,440 --> 00:15:54,480
current server so if i'm an

427
00:15:51,440 --> 00:15:56,639
administrator on this server which is

428
00:15:54,480 --> 00:15:59,440
agent server

429
00:15:56,639 --> 00:16:01,279
i can achieve literally the same so let

430
00:15:59,440 --> 00:16:02,560
me show you a few ways how can we do it

431
00:16:01,279 --> 00:16:05,040
the first way

432
00:16:02,560 --> 00:16:06,800
i can open command prompt but let me do

433
00:16:05,040 --> 00:16:08,880
it as an administrator because i must be

434
00:16:06,800 --> 00:16:10,720
a local administrator

435
00:16:08,880 --> 00:16:11,920
i'm going to go to see

436
00:16:10,720 --> 00:16:15,040
tools

437
00:16:11,920 --> 00:16:18,720
and here i'm going to run ps exact and

438
00:16:15,040 --> 00:16:19,759
in my ps exact i'm going to open cmd as

439
00:16:18,720 --> 00:16:21,920
this

440
00:16:19,759 --> 00:16:24,560
agent account i don't need to know any

441
00:16:21,920 --> 00:16:26,959
passwords because this

442
00:16:24,560 --> 00:16:29,120
specific server may retrieve this

443
00:16:26,959 --> 00:16:34,639
password from id

444
00:16:29,120 --> 00:16:34,639
um all right now if i open mimikatz

445
00:16:34,839 --> 00:16:40,880
mimikatz and around this lsa um lsa

446
00:16:39,440 --> 00:16:43,680
dc sync

447
00:16:40,880 --> 00:16:45,680
yes i i was able to

448
00:16:43,680 --> 00:16:47,040
replicate information about

449
00:16:45,680 --> 00:16:49,120
hashes

450
00:16:47,040 --> 00:16:51,360
all right that's that's that's the most

451
00:16:49,120 --> 00:16:54,560
simple way to do it if you get if you

452
00:16:51,360 --> 00:16:56,639
can just locally uh run that um and

453
00:16:54,560 --> 00:16:58,160
execute mimikatz on this on this machine

454
00:16:56,639 --> 00:17:00,480
but maybe that's not the case maybe you

455
00:16:58,160 --> 00:17:02,160
cannot run mimikatz here

456
00:17:00,480 --> 00:17:03,360
and we need to do it in a different

457
00:17:02,160 --> 00:17:05,360
manner

458
00:17:03,360 --> 00:17:07,520
so let me clear the screen

459
00:17:05,360 --> 00:17:11,039
i also i also need command prompt as an

460
00:17:07,520 --> 00:17:11,919
administrator and let me

461
00:17:11,039 --> 00:17:14,640
open

462
00:17:11,919 --> 00:17:18,000
powershell as a local system so let's

463
00:17:14,640 --> 00:17:19,679
say who am i i'm local system so we know

464
00:17:18,000 --> 00:17:21,919
that agent

465
00:17:19,679 --> 00:17:24,400
can retrieve passport password

466
00:17:21,919 --> 00:17:27,520
um so if i become the machine local

467
00:17:24,400 --> 00:17:28,799
system it means um i'm an agent now i'm

468
00:17:27,520 --> 00:17:30,559
a local machine

469
00:17:28,799 --> 00:17:32,720
and so i can try to retrieve password

470
00:17:30,559 --> 00:17:34,960
from active directory let me do it like

471
00:17:32,720 --> 00:17:36,559
this

472
00:17:34,960 --> 00:17:38,000
not the password itself by the way it

473
00:17:36,559 --> 00:17:40,640
will be hash

474
00:17:38,000 --> 00:17:43,120
and so now i extract password hash what

475
00:17:40,640 --> 00:17:46,000
can i what can i do next

476
00:17:43,120 --> 00:17:48,000
yes pass the hash

477
00:17:46,000 --> 00:17:49,120
and so

478
00:17:48,000 --> 00:17:51,760
that

479
00:17:49,120 --> 00:17:53,600
account will allow me to run elevate

480
00:17:51,760 --> 00:17:55,840
permissions how to do pass the hash he

481
00:17:53,600 --> 00:17:56,799
already saw before i don't think i need

482
00:17:55,840 --> 00:17:58,720
to

483
00:17:56,799 --> 00:18:01,520
show to you again

484
00:17:58,720 --> 00:18:04,640
um all right so uh that's that's two

485
00:18:01,520 --> 00:18:05,520
ways how we can

486
00:18:04,640 --> 00:18:06,880
um

487
00:18:05,520 --> 00:18:07,840
extract

488
00:18:06,880 --> 00:18:11,039
um

489
00:18:07,840 --> 00:18:12,160
how we can extract credentials

490
00:18:11,039 --> 00:18:14,080
um

491
00:18:12,160 --> 00:18:16,080
and with those credentials we can get

492
00:18:14,080 --> 00:18:19,039
access to the main to them to the

493
00:18:16,080 --> 00:18:20,559
administrator to the main administrator

494
00:18:19,039 --> 00:18:22,480
uh permissions

495
00:18:20,559 --> 00:18:25,679
but wait but you may say wait a second

496
00:18:22,480 --> 00:18:28,880
this session is called uh from on-prem

497
00:18:25,679 --> 00:18:31,360
to the cloud and yes you use something

498
00:18:28,880 --> 00:18:33,840
cloud-based like ad connect but you did

499
00:18:31,360 --> 00:18:36,240
not show us how to become a cloud

500
00:18:33,840 --> 00:18:38,160
administrator you just said you just you

501
00:18:36,240 --> 00:18:39,679
just showed how to become local admin i

502
00:18:38,160 --> 00:18:41,600
mean the main admin

503
00:18:39,679 --> 00:18:44,960
based on the ad connect installation or

504
00:18:41,600 --> 00:18:47,440
edit connect cloud scene but not how to

505
00:18:44,960 --> 00:18:48,480
elevate in the cloud

506
00:18:47,440 --> 00:18:49,919
yes

507
00:18:48,480 --> 00:18:50,640
let me show you this

508
00:18:49,919 --> 00:18:53,360
so

509
00:18:50,640 --> 00:18:55,520
if you are the main administrator that

510
00:18:53,360 --> 00:18:58,240
means that you can connect to literally

511
00:18:55,520 --> 00:19:00,400
any workstation or server

512
00:18:58,240 --> 00:19:01,520
in your network right

513
00:19:00,400 --> 00:19:02,720
probably yes

514
00:19:01,520 --> 00:19:05,760
so

515
00:19:02,720 --> 00:19:07,679
and let me jump to demo again and let me

516
00:19:05,760 --> 00:19:09,360
show you one interesting thing

517
00:19:07,679 --> 00:19:11,520
when you have

518
00:19:09,360 --> 00:19:14,559
your cloud environment you probably have

519
00:19:11,520 --> 00:19:16,320
i.t professionals developers and they

520
00:19:14,559 --> 00:19:19,440
use their

521
00:19:16,320 --> 00:19:22,160
tool called azcli let me just type it

522
00:19:19,440 --> 00:19:26,960
let's say a z account

523
00:19:22,160 --> 00:19:28,640
list and let's output as a table

524
00:19:26,960 --> 00:19:30,400
and look at this so it shows my

525
00:19:28,640 --> 00:19:31,600
subscriptions

526
00:19:30,400 --> 00:19:33,039
all right

527
00:19:31,600 --> 00:19:35,440
now let's do the same on the different

528
00:19:33,039 --> 00:19:35,440
machine

529
00:19:36,000 --> 00:19:40,080
let me open cmd

530
00:19:37,679 --> 00:19:42,320
and let me just let me even copy and

531
00:19:40,080 --> 00:19:42,320
paste

532
00:19:42,559 --> 00:19:46,320
copy

533
00:19:44,080 --> 00:19:48,720
and paste

534
00:19:46,320 --> 00:19:50,880
fingers crossed it should fail

535
00:19:48,720 --> 00:19:54,240
please fail

536
00:19:50,880 --> 00:19:57,120
yeah so it says you must login to azure

537
00:19:54,240 --> 00:19:58,240
first but why when i opened command

538
00:19:57,120 --> 00:20:00,320
prompt here

539
00:19:58,240 --> 00:20:02,080
it didn't tell me anything it just

540
00:20:00,320 --> 00:20:04,159
execute the command

541
00:20:02,080 --> 00:20:06,400
uh the reason is i already logged in

542
00:20:04,159 --> 00:20:08,240
here and the token

543
00:20:06,400 --> 00:20:10,080
was cached

544
00:20:08,240 --> 00:20:11,120
and token will be cached

545
00:20:10,080 --> 00:20:13,760
here

546
00:20:11,120 --> 00:20:15,840
if you go to your user profile there's a

547
00:20:13,760 --> 00:20:18,000
folder called that azure

548
00:20:15,840 --> 00:20:19,840
subfolder called that azure so if you go

549
00:20:18,000 --> 00:20:21,440
there

550
00:20:19,840 --> 00:20:23,520
if you take all of those files you may

551
00:20:21,440 --> 00:20:26,400
take few on the few of them but

552
00:20:23,520 --> 00:20:28,880
let me take all of them except config

553
00:20:26,400 --> 00:20:30,240
and let's say i want to add that to

554
00:20:28,880 --> 00:20:33,440
archive

555
00:20:30,240 --> 00:20:36,559
let's skip 7-zip that's fine

556
00:20:33,440 --> 00:20:37,520
and so here is 7zip archive let me copy

557
00:20:36,559 --> 00:20:38,240
this

558
00:20:37,520 --> 00:20:41,280
to

559
00:20:38,240 --> 00:20:41,280
this workstation

560
00:20:47,120 --> 00:20:49,840
extract that

561
00:20:51,360 --> 00:20:56,159
fingers crossed

562
00:20:53,679 --> 00:20:58,080
come on

563
00:20:56,159 --> 00:21:00,480
come on

564
00:20:58,080 --> 00:21:03,679
yeah so now i can see

565
00:21:00,480 --> 00:21:05,280
list of subscriptions did i have any

566
00:21:03,679 --> 00:21:07,120
mfa prompts

567
00:21:05,280 --> 00:21:09,760
no

568
00:21:07,120 --> 00:21:10,559
any password prompts no

569
00:21:09,760 --> 00:21:13,039
so

570
00:21:10,559 --> 00:21:15,840
um but this account the

571
00:21:13,039 --> 00:21:17,200
account has mfa enabled and of course it

572
00:21:15,840 --> 00:21:19,679
has password

573
00:21:17,200 --> 00:21:21,039
but because we use cache token we don't

574
00:21:19,679 --> 00:21:22,240
need to present all of this we can just

575
00:21:21,039 --> 00:21:23,679
still token

576
00:21:22,240 --> 00:21:25,600
import that to the

577
00:21:23,679 --> 00:21:28,080
different to the different machine like

578
00:21:25,600 --> 00:21:31,039
just copy and paste and you're all set

579
00:21:28,080 --> 00:21:32,720
and you are in the cloud uh and so now

580
00:21:31,039 --> 00:21:34,400
depends on my permissions

581
00:21:32,720 --> 00:21:35,919
um i can

582
00:21:34,400 --> 00:21:36,720
do something

583
00:21:35,919 --> 00:21:39,280
so

584
00:21:36,720 --> 00:21:40,640
uh let's do let's try to do this

585
00:21:39,280 --> 00:21:43,600
let's try to

586
00:21:40,640 --> 00:21:46,880
do something let's say

587
00:21:43,600 --> 00:21:48,320
i want to i want to

588
00:21:46,880 --> 00:21:50,240
uh create

589
00:21:48,320 --> 00:21:51,360
new user

590
00:21:50,240 --> 00:21:53,760
which is called

591
00:21:51,360 --> 00:21:56,400
uh we'll i'll call this user azure hound

592
00:21:53,760 --> 00:21:59,440
let's create that

593
00:21:56,400 --> 00:22:01,760
and the password will be quite strong

594
00:21:59,440 --> 00:22:04,080
don't worry i'm going to remove this the

595
00:22:01,760 --> 00:22:06,960
user later on so you will not be

596
00:22:04,080 --> 00:22:10,240
able to use this pass this this user um

597
00:22:06,960 --> 00:22:13,400
and also let me assign permissions uh

598
00:22:10,240 --> 00:22:13,400
or either

599
00:22:16,960 --> 00:22:23,679
all right so now i have user with reader

600
00:22:21,039 --> 00:22:25,840
permissions on the subscription level

601
00:22:23,679 --> 00:22:29,200
so what i can do with this user i want

602
00:22:25,840 --> 00:22:32,960
to enumerate subscription and i will use

603
00:22:29,200 --> 00:22:37,039
quite well known tool called azure hound

604
00:22:32,960 --> 00:22:37,039
so have you heard about this azure

605
00:22:39,120 --> 00:22:44,880
azure hound so you probably probably

606
00:22:42,720 --> 00:22:47,679
heard about bloodhound which is like you

607
00:22:44,880 --> 00:22:50,640
know from premises azure hound that's

608
00:22:47,679 --> 00:22:52,880
the cloud version of bloodhound

609
00:22:50,640 --> 00:22:54,240
all right so what i can do with this

610
00:22:52,880 --> 00:22:55,679
azure hound

611
00:22:54,240 --> 00:22:59,200
um

612
00:22:55,679 --> 00:23:02,000
i can i can enumerate um uh this time i

613
00:22:59,200 --> 00:23:04,320
can enumerate azure in the same manner i

614
00:23:02,000 --> 00:23:06,080
did that um in a primary g with

615
00:23:04,320 --> 00:23:09,600
bloodhound i can do this i can do

616
00:23:06,080 --> 00:23:11,840
something similar in case of azure hound

617
00:23:09,600 --> 00:23:14,880
let me show you this pretty quickly

618
00:23:11,840 --> 00:23:17,840
i'm going to to to

619
00:23:14,880 --> 00:23:20,080
find my azure hound locally let me copy

620
00:23:17,840 --> 00:23:20,080
this

621
00:23:20,799 --> 00:23:26,559
and let me

622
00:23:23,200 --> 00:23:28,880
let me paste that to desktop

623
00:23:26,559 --> 00:23:30,480
oh i even have a folder here

624
00:23:28,880 --> 00:23:33,679
oh it's already there

625
00:23:30,480 --> 00:23:34,640
um so i should hold this easier now what

626
00:23:33,679 --> 00:23:37,840
i want to do

627
00:23:34,640 --> 00:23:39,600
i want to navigate

628
00:23:37,840 --> 00:23:42,320
to it

629
00:23:39,600 --> 00:23:43,760
and let's say import

630
00:23:42,320 --> 00:23:44,960
import module

631
00:23:43,760 --> 00:23:46,880
azure

632
00:23:44,960 --> 00:23:48,840
and

633
00:23:46,880 --> 00:23:51,360
come

634
00:23:48,840 --> 00:23:54,000
on azure hound

635
00:23:51,360 --> 00:23:58,000
and look at this it says that was

636
00:23:54,000 --> 00:24:01,120
blocked by your antivirus software

637
00:23:58,000 --> 00:24:03,279
so i want to enumerate but i cannot do

638
00:24:01,120 --> 00:24:05,600
it because

639
00:24:03,279 --> 00:24:06,960
something some antivirus doesn't allow

640
00:24:05,600 --> 00:24:10,080
me to do it

641
00:24:06,960 --> 00:24:13,600
so what is that that's called amsi or mz

642
00:24:10,080 --> 00:24:15,919
shortly um and so it's trying to test uh

643
00:24:13,600 --> 00:24:17,279
the powershell commands and powershell

644
00:24:15,919 --> 00:24:20,080
modules

645
00:24:17,279 --> 00:24:21,360
i'm trying to run from powershell or not

646
00:24:20,080 --> 00:24:22,480
only partial by the way but it's time

647
00:24:21,360 --> 00:24:24,720
powershell

648
00:24:22,480 --> 00:24:27,600
um so what i'm going to do now i want to

649
00:24:24,720 --> 00:24:29,600
bypass mz how can we do it

650
00:24:27,600 --> 00:24:31,200
um let me show you real quick i will not

651
00:24:29,600 --> 00:24:32,880
give you all the details about that

652
00:24:31,200 --> 00:24:33,840
because that's not the goal of the

653
00:24:32,880 --> 00:24:35,440
session

654
00:24:33,840 --> 00:24:37,360
um

655
00:24:35,440 --> 00:24:39,039
but let me try to show it to you really

656
00:24:37,360 --> 00:24:41,600
quickly so i'm gonna i'm gonna open

657
00:24:39,039 --> 00:24:41,600
powershell

658
00:24:41,840 --> 00:24:47,200
open powershell and let me run a tool

659
00:24:45,520 --> 00:24:49,440
called fade the trace

660
00:24:47,200 --> 00:24:51,120
and what i need to do i must tell to

661
00:24:49,440 --> 00:24:54,799
frida

662
00:24:51,120 --> 00:25:00,480
press process id of my powershell

663
00:24:54,799 --> 00:25:03,679
window so it's 400 nice

664
00:25:00,480 --> 00:25:03,679
let's say 400

665
00:25:05,360 --> 00:25:11,919
all right now if i type command like get

666
00:25:09,440 --> 00:25:11,919
service

667
00:25:12,559 --> 00:25:17,200
sell that was uh that that that brown

668
00:25:15,200 --> 00:25:21,039
that works fine and here i can see

669
00:25:17,200 --> 00:25:24,240
output from mz i mean i mean

670
00:25:21,039 --> 00:25:28,400
um msi output and every time i can see

671
00:25:24,240 --> 00:25:30,159
this msi context hmm

672
00:25:28,400 --> 00:25:31,279
so what this context is all about let me

673
00:25:30,159 --> 00:25:34,720
copy this

674
00:25:31,279 --> 00:25:37,279
and this time i want to open win debug

675
00:25:34,720 --> 00:25:37,279
debugger

676
00:25:39,039 --> 00:25:43,840
all right and i'm going to attach

677
00:25:41,440 --> 00:25:43,840
powershell

678
00:25:44,000 --> 00:25:48,480
and so let me just

679
00:25:46,159 --> 00:25:51,120
dc into

680
00:25:48,480 --> 00:25:51,120
this address

681
00:25:51,200 --> 00:25:55,760
and look at this so it says

682
00:25:54,480 --> 00:25:57,840
here i can see

683
00:25:55,760 --> 00:26:02,799
something with title

684
00:25:57,840 --> 00:26:04,320
uh msi like a header a header msi header

685
00:26:02,799 --> 00:26:05,600
so

686
00:26:04,320 --> 00:26:08,720
if i

687
00:26:05,600 --> 00:26:10,720
if i i remove this header

688
00:26:08,720 --> 00:26:13,200
msi will stop the work

689
00:26:10,720 --> 00:26:15,840
how can we remove this header

690
00:26:13,200 --> 00:26:17,200
let me detach that

691
00:26:15,840 --> 00:26:19,120
how can i remove this header i can do it

692
00:26:17,200 --> 00:26:21,039
through debugger or i can even do it

693
00:26:19,120 --> 00:26:22,840
from powershell let me just

694
00:26:21,039 --> 00:26:27,200
type something like

695
00:26:22,840 --> 00:26:29,120
this um and now if i try to

696
00:26:27,200 --> 00:26:30,640
do something like invoke

697
00:26:29,120 --> 00:26:32,720
mimikatz

698
00:26:30,640 --> 00:26:34,320
mimic ads

699
00:26:32,720 --> 00:26:36,400
uh it will fail because i don't have

700
00:26:34,320 --> 00:26:39,200
this module but but antivirus will not

701
00:26:36,400 --> 00:26:43,240
block it yeah antivirus did not block it

702
00:26:39,200 --> 00:26:44,320
all right let me try to use this bypass

703
00:26:43,240 --> 00:26:46,640
[Music]

704
00:26:44,320 --> 00:26:46,640
here

705
00:26:48,240 --> 00:26:52,480
all right and let's try to import that

706
00:26:51,039 --> 00:26:55,279
again

707
00:26:52,480 --> 00:26:58,799
yay that's working that's working and so

708
00:26:55,279 --> 00:26:58,799
now i just need to run

709
00:26:58,960 --> 00:27:02,240
um

710
00:26:59,919 --> 00:27:04,559
something like invoke azure hound oh

711
00:27:02,240 --> 00:27:06,400
sorry um

712
00:27:04,559 --> 00:27:08,640
but uh to do it

713
00:27:06,400 --> 00:27:12,000
i must first connect to azure id so let

714
00:27:08,640 --> 00:27:12,000
me say connect azure id

715
00:27:15,679 --> 00:27:21,240
azure hound

716
00:27:17,600 --> 00:27:21,240
and password

717
00:27:21,679 --> 00:27:25,520
um so let's keep that first

718
00:27:25,600 --> 00:27:28,880
now

719
00:27:26,480 --> 00:27:31,840
what i can do i can say invoke

720
00:27:28,880 --> 00:27:34,240
azure hound

721
00:27:31,840 --> 00:27:35,760
and now it will start to collect

722
00:27:34,240 --> 00:27:39,279
information from

723
00:27:35,760 --> 00:27:41,840
my azure id not only azure id from azure

724
00:27:39,279 --> 00:27:43,360
in general including azure ad of course

725
00:27:41,840 --> 00:27:45,120
it depends on my permissions but because

726
00:27:43,360 --> 00:27:47,360
i delegate permissions to read

727
00:27:45,120 --> 00:27:50,720
everything so it may collect a lot of

728
00:27:47,360 --> 00:27:53,120
information and so the output will be

729
00:27:50,720 --> 00:27:55,760
soon here in this folder

730
00:27:53,120 --> 00:27:57,520
so for the second time let me jump to my

731
00:27:55,760 --> 00:28:00,000
bloodhound gui

732
00:27:57,520 --> 00:28:02,480
i already pre-create the azure hound

733
00:28:00,000 --> 00:28:04,640
file so let me just say

734
00:28:02,480 --> 00:28:08,480
upload data

735
00:28:04,640 --> 00:28:08,480
and here is azure hound collection

736
00:28:13,679 --> 00:28:17,679
and now

737
00:28:14,880 --> 00:28:20,399
oh not

738
00:28:17,679 --> 00:28:22,880
so statistics here is not

739
00:28:20,399 --> 00:28:25,760
not very nice if i just close that

740
00:28:22,880 --> 00:28:25,760
and around again

741
00:28:29,760 --> 00:28:35,440
let's see

742
00:28:32,000 --> 00:28:38,000
yay we have look at this az applications

743
00:28:35,440 --> 00:28:41,840
ac devices ac groups

744
00:28:38,000 --> 00:28:43,200
uh users tenants subscriptions so we

745
00:28:41,840 --> 00:28:45,760
learn a lot

746
00:28:43,200 --> 00:28:48,799
unfortunately or maybe fortunately we

747
00:28:45,760 --> 00:28:51,039
don't have pre-built queries for azure

748
00:28:48,799 --> 00:28:52,960
so we must run our custom

749
00:28:51,039 --> 00:28:55,200
queries

750
00:28:52,960 --> 00:28:59,080
we must run our custom query so let me

751
00:28:55,200 --> 00:28:59,080
run a custom query

752
00:28:59,360 --> 00:29:05,919
oh damn it let me just first

753
00:29:03,200 --> 00:29:05,919
copy here

754
00:29:07,120 --> 00:29:12,559
paste here

755
00:29:08,559 --> 00:29:14,399
um and now i can see um like accounts i

756
00:29:12,559 --> 00:29:17,600
have

757
00:29:14,399 --> 00:29:19,120
in my environment and those accounts

758
00:29:17,600 --> 00:29:23,919
and you may say wait a second what the

759
00:29:19,120 --> 00:29:23,919
hell is that um because um

760
00:29:24,559 --> 00:29:30,120
quite hard to understand yes

761
00:29:26,320 --> 00:29:32,399
unfortunately currently that is not

762
00:29:30,120 --> 00:29:33,600
super friendly

763
00:29:32,399 --> 00:29:35,360
uh but

764
00:29:33,600 --> 00:29:38,000
at least i can build a graph in the

765
00:29:35,360 --> 00:29:40,320
similar manner like bloodhound um

766
00:29:38,000 --> 00:29:41,760
there's a very nice article you may find

767
00:29:40,320 --> 00:29:44,960
here

768
00:29:41,760 --> 00:29:46,480
um azure hound cipher cheat sheet and

769
00:29:44,960 --> 00:29:48,399
here's a number of those queries that

770
00:29:46,480 --> 00:29:50,720
you may try to

771
00:29:48,399 --> 00:29:52,320
and it will return some data

772
00:29:50,720 --> 00:29:53,600
that you want

773
00:29:52,320 --> 00:29:55,279
um

774
00:29:53,600 --> 00:29:57,679
all right

775
00:29:55,279 --> 00:29:58,720
all right

776
00:29:57,679 --> 00:30:01,919
um

777
00:29:58,720 --> 00:30:04,799
i hope uh that that

778
00:30:01,919 --> 00:30:06,720
um that demo convinced you a lot to that

779
00:30:04,799 --> 00:30:08,559
you should protect your ad connect

780
00:30:06,720 --> 00:30:11,360
server or if you if you prefer to use

781
00:30:08,559 --> 00:30:13,120
cloud sync you must protect agent

782
00:30:11,360 --> 00:30:15,200
and you should not

783
00:30:13,120 --> 00:30:17,279
provide permissions even to middle level

784
00:30:15,200 --> 00:30:19,840
administrators to manage those servers

785
00:30:17,279 --> 00:30:21,760
because they may easily escalate to the

786
00:30:19,840 --> 00:30:25,360
main administrators and from the main

787
00:30:21,760 --> 00:30:26,320
administrators to cloud administrators

788
00:30:25,360 --> 00:30:28,080
um

789
00:30:26,320 --> 00:30:30,159
there's a number of ways to achieve that

790
00:30:28,080 --> 00:30:31,760
like if you have if you are cloud

791
00:30:30,159 --> 00:30:33,279
administrator you may

792
00:30:31,760 --> 00:30:36,000
use an intune you may become the main

793
00:30:33,279 --> 00:30:37,919
administrator so when you have hybrid id

794
00:30:36,000 --> 00:30:39,520
you must protect both environments

795
00:30:37,919 --> 00:30:41,600
pretty well because from one environment

796
00:30:39,520 --> 00:30:43,520
you may get get access to another

797
00:30:41,600 --> 00:30:44,880
another and vice versa

798
00:30:43,520 --> 00:30:46,480
so um

799
00:30:44,880 --> 00:30:48,960
the last slide here

800
00:30:46,480 --> 00:30:50,960
and it will be slide so what you can do

801
00:30:48,960 --> 00:30:52,960
to protect your

802
00:30:50,960 --> 00:30:56,080
to protect your environment better

803
00:30:52,960 --> 00:30:58,240
so if you want to avoid compromising um

804
00:30:56,080 --> 00:31:01,679
a deforest account first of all keep in

805
00:30:58,240 --> 00:31:04,399
mind so ad connect or cloud sync the

806
00:31:01,679 --> 00:31:05,279
agent they are tier zero

807
00:31:04,399 --> 00:31:07,600
so

808
00:31:05,279 --> 00:31:11,440
it means that you should not allow like

809
00:31:07,600 --> 00:31:13,760
a regular administrators um management

810
00:31:11,440 --> 00:31:15,279
ad connect management do not allow

811
00:31:13,760 --> 00:31:17,679
administrator

812
00:31:15,279 --> 00:31:20,399
server administrator to manage agent or

813
00:31:17,679 --> 00:31:22,320
ad connect server because they may have

814
00:31:20,399 --> 00:31:23,600
they may become the main admins quite

815
00:31:22,320 --> 00:31:24,480
easily

816
00:31:23,600 --> 00:31:25,279
um

817
00:31:24,480 --> 00:31:27,760
so

818
00:31:25,279 --> 00:31:29,440
please use principles privileges

819
00:31:27,760 --> 00:31:31,760
also by the way if you use azure id

820
00:31:29,440 --> 00:31:32,480
connect cloud sync

821
00:31:31,760 --> 00:31:35,279
it

822
00:31:32,480 --> 00:31:36,640
may be considered more secure because uh

823
00:31:35,279 --> 00:31:38,720
configuration may be not done in the

824
00:31:36,640 --> 00:31:41,279
cloud on premise you have only agent but

825
00:31:38,720 --> 00:31:42,799
keep in mind uh you should not allow

826
00:31:41,279 --> 00:31:45,360
access to

827
00:31:42,799 --> 00:31:47,519
this server and access this server to

828
00:31:45,360 --> 00:31:49,679
middle level administrators

829
00:31:47,519 --> 00:31:52,000
when we we're talking about credentials

830
00:31:49,679 --> 00:31:55,039
when i can steal credentials

831
00:31:52,000 --> 00:31:57,360
here good idea will be use

832
00:31:55,039 --> 00:32:00,399
privileged access workstation and around

833
00:31:57,360 --> 00:32:01,600
administration and administer or run

834
00:32:00,399 --> 00:32:03,919
development from the separate

835
00:32:01,600 --> 00:32:05,919
workstation which is not part of those

836
00:32:03,919 --> 00:32:06,720
your your infrastructure

837
00:32:05,919 --> 00:32:09,519
um

838
00:32:06,720 --> 00:32:10,880
so it means it will have multiple layers

839
00:32:09,519 --> 00:32:13,279
of protection

840
00:32:10,880 --> 00:32:15,360
uh mz bypass

841
00:32:13,279 --> 00:32:17,519
here you may audit partial commands and

842
00:32:15,360 --> 00:32:19,120
also use powershell constraint language

843
00:32:17,519 --> 00:32:21,919
of course it's possible to bypass this

844
00:32:19,120 --> 00:32:23,679
language as well but uh the more you

845
00:32:21,919 --> 00:32:25,279
have then better

846
00:32:23,679 --> 00:32:27,360
the more secure you are

847
00:32:25,279 --> 00:32:29,360
and communication with azure hound in

848
00:32:27,360 --> 00:32:32,000
this case principal is privileges that's

849
00:32:29,360 --> 00:32:34,720
the best thing you can do because um to

850
00:32:32,000 --> 00:32:36,880
enumerate to get information from igd

851
00:32:34,720 --> 00:32:38,880
you must run

852
00:32:36,880 --> 00:32:40,840
that command with some sort of

853
00:32:38,880 --> 00:32:43,279
permissions so if you don't have those

854
00:32:40,840 --> 00:32:44,559
permissions you will not be able to run

855
00:32:43,279 --> 00:32:48,000
it

856
00:32:44,559 --> 00:32:49,039
all right so that is about mitigations

857
00:32:48,000 --> 00:32:50,559
so

858
00:32:49,039 --> 00:32:52,480
please keep in mind

859
00:32:50,559 --> 00:32:55,039
um

860
00:32:52,480 --> 00:32:56,799
the configuration ad connect or even

861
00:32:55,039 --> 00:33:00,399
any connect nowadays that's quite

862
00:32:56,799 --> 00:33:04,640
typical quite typical and um password

863
00:33:00,399 --> 00:33:06,159
hashing also enabled so make sure

864
00:33:04,640 --> 00:33:08,240
um

865
00:33:06,159 --> 00:33:09,200
you will not become the

866
00:33:08,240 --> 00:33:12,159
victim

867
00:33:09,200 --> 00:33:14,159
uh even even your ins even your users

868
00:33:12,159 --> 00:33:16,159
inside the company they may do something

869
00:33:14,159 --> 00:33:18,159
like this maybe they are not malicious

870
00:33:16,159 --> 00:33:20,399
maybe they are not going to you know

871
00:33:18,159 --> 00:33:22,399
steal data from the company but at least

872
00:33:20,399 --> 00:33:24,880
maybe they want to have more permissions

873
00:33:22,399 --> 00:33:27,360
like middle level admin want to have

874
00:33:24,880 --> 00:33:28,799
like just in case to have the main

875
00:33:27,360 --> 00:33:31,519
permissions as well

876
00:33:28,799 --> 00:33:33,840
um so make sure that

877
00:33:31,519 --> 00:33:35,279
you control access to ad connect server

878
00:33:33,840 --> 00:33:36,880
or maybe cloud sync if you're going to

879
00:33:35,279 --> 00:33:38,720
use that in the future

880
00:33:36,880 --> 00:33:42,000
make sure you connect you

881
00:33:38,720 --> 00:33:44,640
you configure permissions correctly

882
00:33:42,000 --> 00:33:46,399
all right so i hope that session was

883
00:33:44,640 --> 00:33:48,799
informative

884
00:33:46,399 --> 00:33:50,799
and if you have any questions it's time

885
00:33:48,799 --> 00:33:53,519
to ask those questions of course you may

886
00:33:50,799 --> 00:33:56,960
ask questions during the session as well

887
00:33:53,519 --> 00:34:00,000
but now because i'm finishing

888
00:33:56,960 --> 00:34:01,440
go ahead and ask them now if you have

889
00:34:00,000 --> 00:34:04,880
if not

890
00:34:01,440 --> 00:34:07,200
thank you anyway um and

891
00:34:04,880 --> 00:34:08,879
the best thing i can recommend you is to

892
00:34:07,200 --> 00:34:11,599
check your own environment and make sure

893
00:34:08,879 --> 00:34:13,040
you don't have those

894
00:34:11,599 --> 00:34:14,240
not

895
00:34:13,040 --> 00:34:16,960
the best

896
00:34:14,240 --> 00:34:19,359
not the most optimal configurations

897
00:34:16,960 --> 00:34:22,560
all right thank you very much

898
00:34:19,359 --> 00:34:22,560
enjoy the conference

