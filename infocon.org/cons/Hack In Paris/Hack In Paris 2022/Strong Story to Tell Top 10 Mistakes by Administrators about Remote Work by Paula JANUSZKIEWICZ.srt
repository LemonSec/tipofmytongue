1
00:00:00,690 --> 00:00:02,910
[Applause]

2
00:00:04,720 --> 00:00:07,440
absolutely fantastic to see you guys and

3
00:00:07,440 --> 00:00:09,840
we're gonna have an intense 45 minutes

4
00:00:09,840 --> 00:00:12,480
to wake us up a little bit uh after the

5
00:00:12,480 --> 00:00:14,480
yesterday's party

6
00:00:14,480 --> 00:00:17,920
so as you can see uh paula jay uh paul i

7
00:00:17,920 --> 00:00:20,800
understand it's a very long last name

8
00:00:20,800 --> 00:00:23,439
but uh technically i'm from poland but

9
00:00:23,439 --> 00:00:24,960
let me tell you of course couple of

10
00:00:24,960 --> 00:00:27,439
words about uh myself about what i'm

11
00:00:27,439 --> 00:00:30,160
doing very briefly and then we get into

12
00:00:30,160 --> 00:00:32,079
their presentation so as you can see on

13
00:00:32,079 --> 00:00:34,640
the slide i'm the ceo of secure that is

14
00:00:34,640 --> 00:00:37,040
the company that i have established

15
00:00:37,040 --> 00:00:39,440
actually 14 years ago so quite a long

16
00:00:39,440 --> 00:00:42,000
time ago and we are placed right now in

17
00:00:42,000 --> 00:00:44,320
four locations so uh new york dubai

18
00:00:44,320 --> 00:00:47,280
switzerland and poland and uh what we do

19
00:00:47,280 --> 00:00:49,120
purely and this is what i've been doing

20
00:00:49,120 --> 00:00:51,199
pretty much for my whole life

21
00:00:51,199 --> 00:00:53,440
is pen testing all together with the

22
00:00:53,440 --> 00:00:56,399
incident response and forensics and with

23
00:00:56,399 --> 00:00:58,800
my team being almost 50 people right now

24
00:00:58,800 --> 00:01:00,640
so since last time we saw each other

25
00:01:00,640 --> 00:01:02,399
things changed a little bit uh

26
00:01:02,399 --> 00:01:04,159
apparently cyber security becomes more

27
00:01:04,159 --> 00:01:06,880
and more important subject uh we are of

28
00:01:06,880 --> 00:01:08,880
course dealing with different aspects of

29
00:01:08,880 --> 00:01:11,200
cyber security so not only appenders

30
00:01:11,200 --> 00:01:12,720
think we are writing the tools as well

31
00:01:12,720 --> 00:01:16,560
of course but also uh the consultancy uh

32
00:01:16,560 --> 00:01:18,720
in the cyber security field also in the

33
00:01:18,720 --> 00:01:21,200
csu sphere so

34
00:01:21,200 --> 00:01:23,520
it's not a new role as we know but

35
00:01:23,520 --> 00:01:25,520
eventually they also need support

36
00:01:25,520 --> 00:01:28,159
especially in times of covet where they

37
00:01:28,159 --> 00:01:30,560
had to simply take bunch of decisions in

38
00:01:30,560 --> 00:01:34,000
order to switch to to the remote so i'm

39
00:01:34,000 --> 00:01:35,920
also micros original director it's a

40
00:01:35,920 --> 00:01:37,439
kind of a funky role i will tell you

41
00:01:37,439 --> 00:01:39,680
because um

42
00:01:39,680 --> 00:01:41,520
i'm not working for microsoft just to

43
00:01:41,520 --> 00:01:44,240
make it super clear i'm not a director

44
00:01:44,240 --> 00:01:46,399
and definitely i'm not original so

45
00:01:46,399 --> 00:01:48,560
what's what's this so this is actually

46
00:01:48,560 --> 00:01:51,520
the a very like uh honorable role that

47
00:01:51,520 --> 00:01:53,600
microsoft gave me some time ago for

48
00:01:53,600 --> 00:01:56,159
being innovative into technologies

49
00:01:56,159 --> 00:01:58,159
and this is something that really helps

50
00:01:58,159 --> 00:01:59,280
out to

51
00:01:59,280 --> 00:02:01,360
grow in in cyber security as well

52
00:02:01,360 --> 00:02:04,399
because uh every year we try to meet up

53
00:02:04,399 --> 00:02:06,799
in redmond in order to comment on

54
00:02:06,799 --> 00:02:08,560
security of different solutions and so

55
00:02:08,560 --> 00:02:10,878
on so that's pretty much where the role

56
00:02:10,878 --> 00:02:13,280
comes from absolutely nice to see you

57
00:02:13,280 --> 00:02:16,080
back and also after our presentation i'm

58
00:02:16,080 --> 00:02:18,480
gonna give you the link to tools where

59
00:02:18,480 --> 00:02:19,920
you can download everything that i'm

60
00:02:19,920 --> 00:02:22,480
gonna be doing on the presentation uh

61
00:02:22,480 --> 00:02:25,200
identity of crispy at the events we

62
00:02:25,200 --> 00:02:27,120
always share at the event some tools and

63
00:02:27,120 --> 00:02:28,480
so on so this is pretty much what you

64
00:02:28,480 --> 00:02:31,120
can expect and that is what we're gonna

65
00:02:31,120 --> 00:02:32,800
do this time

66
00:02:32,800 --> 00:02:35,360
so this time basically we as well uh

67
00:02:35,360 --> 00:02:38,239
talk about this strong story to tell and

68
00:02:38,239 --> 00:02:40,239
that strong story to tell about the 10

69
00:02:40,239 --> 00:02:42,640
mistakes of administrators about the

70
00:02:42,640 --> 00:02:45,120
remote work it's about all the

71
00:02:45,120 --> 00:02:47,440
interesting places situations

72
00:02:47,440 --> 00:02:50,480
misconfigurations that administrators do

73
00:02:50,480 --> 00:02:52,959
why top 10 why not obviously there is

74
00:02:52,959 --> 00:02:55,360
more than 10. but i would love to share

75
00:02:55,360 --> 00:02:58,080
with you a bunch of stories where um our

76
00:02:58,080 --> 00:03:00,319
job is going to be to conclude basically

77
00:03:00,319 --> 00:03:02,560
what can we do to be better in the

78
00:03:02,560 --> 00:03:05,360
cybersecurity field but before we start

79
00:03:05,360 --> 00:03:07,040
just one more thing of course to share

80
00:03:07,040 --> 00:03:08,720
with you if you would like to get this

81
00:03:08,720 --> 00:03:10,239
presentation as well

82
00:03:10,239 --> 00:03:12,159
i'm sharing with you the qr code because

83
00:03:12,159 --> 00:03:14,800
loads of people are asking uh do we get

84
00:03:14,800 --> 00:03:17,120
a presentation yes you do it's there

85
00:03:17,120 --> 00:03:18,879
yeah so we don't need to ask that

86
00:03:18,879 --> 00:03:20,319
question anymore so make sure that

87
00:03:20,319 --> 00:03:22,000
you're going to download it it's there

88
00:03:22,000 --> 00:03:23,920
there's a link and there's also by the

89
00:03:23,920 --> 00:03:26,799
way a link to the tools so now we can

90
00:03:26,799 --> 00:03:30,560
start and focus on the pleasant stuff

91
00:03:30,560 --> 00:03:33,360
so during the pandemic when we were

92
00:03:33,360 --> 00:03:34,720
simply

93
00:03:34,720 --> 00:03:37,200
not allowed to travel uh we could

94
00:03:37,200 --> 00:03:39,040
actually travel a little bit depending

95
00:03:39,040 --> 00:03:41,680
on the background uh so we were actually

96
00:03:41,680 --> 00:03:43,280
in a situation

97
00:03:43,280 --> 00:03:46,000
where our customer it's like a series of

98
00:03:46,000 --> 00:03:48,319
factories so they were placed in china

99
00:03:48,319 --> 00:03:50,879
and us plenty of factories in europe and

100
00:03:50,879 --> 00:03:53,920
so on they got completely smashed by the

101
00:03:53,920 --> 00:03:56,560
ransomware and of course interesting i

102
00:03:56,560 --> 00:03:57,920
think is that

103
00:03:57,920 --> 00:04:00,640
they actually

104
00:04:00,799 --> 00:04:03,680
hired a negotiation company just imagine

105
00:04:03,680 --> 00:04:06,000
in order to negotiate the ransom

106
00:04:06,000 --> 00:04:07,840
and uh that was funny because they were

107
00:04:07,840 --> 00:04:10,000
they were contacting the hackers help

108
00:04:10,000 --> 00:04:11,920
desk because this is to the point where

109
00:04:11,920 --> 00:04:13,599
there's actually helped us that you are

110
00:04:13,599 --> 00:04:16,000
calling to in order to fix your case and

111
00:04:16,000 --> 00:04:18,000
they managed to negotiate the ransom to

112
00:04:18,000 --> 00:04:21,199
pay which was half a million euros so

113
00:04:21,199 --> 00:04:22,720
quite a lot

114
00:04:22,720 --> 00:04:25,199
so what they got for it was actually a

115
00:04:25,199 --> 00:04:27,440
decrypter because that's what everybody

116
00:04:27,440 --> 00:04:28,720
would expect

117
00:04:28,720 --> 00:04:32,720
that unfortunately was not working

118
00:04:32,720 --> 00:04:35,600
and the problem was so okay so we paid

119
00:04:35,600 --> 00:04:37,919
money now there is this group decrypter

120
00:04:37,919 --> 00:04:39,680
it doesn't work so what do we what do we

121
00:04:39,680 --> 00:04:41,680
do next so they actually called us and

122
00:04:41,680 --> 00:04:43,199
they said okay you guys need to come

123
00:04:43,199 --> 00:04:44,720
over and

124
00:04:44,720 --> 00:04:46,639
let's figure it out like wow can we

125
00:04:46,639 --> 00:04:48,960
recover our infrastructure they did not

126
00:04:48,960 --> 00:04:50,960
have the freshest backup as you can

127
00:04:50,960 --> 00:04:52,160
imagine that's why they were paying the

128
00:04:52,160 --> 00:04:55,440
ransom and at the same time uh they were

129
00:04:55,440 --> 00:04:57,120
like hoping that maybe that the crypto

130
00:04:57,120 --> 00:04:59,440
is gonna work but maybe they are doing

131
00:04:59,440 --> 00:05:01,840
something wrong and that is exactly what

132
00:05:01,840 --> 00:05:03,680
appeared because when we work at the

133
00:05:03,680 --> 00:05:04,800
decrypter

134
00:05:04,800 --> 00:05:06,880
to be fair i'm not a developer but when

135
00:05:06,880 --> 00:05:09,120
you open the code it looks like a

136
00:05:09,120 --> 00:05:12,639
medieval age or kindergarten programming

137
00:05:12,639 --> 00:05:13,759
level

138
00:05:13,759 --> 00:05:15,919
and that decrypter was just super easy

139
00:05:15,919 --> 00:05:17,919
to be analyzed well maybe not super easy

140
00:05:17,919 --> 00:05:19,199
but just easy

141
00:05:19,199 --> 00:05:21,600
and when you take the data that was

142
00:05:21,600 --> 00:05:23,120
encrypted and this was one of the

143
00:05:23,120 --> 00:05:24,720
interesting lessons that we learned

144
00:05:24,720 --> 00:05:26,080
during this project

145
00:05:26,080 --> 00:05:27,680
i was working with like an almost one

146
00:05:27,680 --> 00:05:31,120
terabyte file like a database simply

147
00:05:31,120 --> 00:05:33,840
the first eight megabytes seems to be

148
00:05:33,840 --> 00:05:35,039
encrypted

149
00:05:35,039 --> 00:05:36,479
only eight megabytes so it's like a

150
00:05:36,479 --> 00:05:39,199
small junk and then at the end of the

151
00:05:39,199 --> 00:05:42,800
file they were adding 512 byte key

152
00:05:42,800 --> 00:05:45,440
that it's supposed to be used in a way

153
00:05:45,440 --> 00:05:47,440
that the crypter tells you so the

154
00:05:47,440 --> 00:05:49,039
decrypter was that really the key it was

155
00:05:49,039 --> 00:05:50,479
a method right

156
00:05:50,479 --> 00:05:52,960
so when i look into different files they

157
00:05:52,960 --> 00:05:54,400
had like kind of like the similar

158
00:05:54,400 --> 00:05:57,120
pattern up to eight megabytes chop clear

159
00:05:57,120 --> 00:06:00,960
text data 512 byte key but for some of

160
00:06:00,960 --> 00:06:02,880
the files actually i mean we're talking

161
00:06:02,880 --> 00:06:04,560
infrastructure here yeah so it's

162
00:06:04,560 --> 00:06:07,039
thousands of files being encrypted in a

163
00:06:07,039 --> 00:06:09,120
different way so for some of the files

164
00:06:09,120 --> 00:06:11,039
we could see that there's like a copies

165
00:06:11,039 --> 00:06:15,360
of 512 and we are all in id 512 it's not

166
00:06:15,360 --> 00:06:17,280
there by accident right so if you can

167
00:06:17,280 --> 00:06:19,600
multiply it twice three times and so on

168
00:06:19,600 --> 00:06:21,120
and then they would just stick to the

169
00:06:21,120 --> 00:06:23,919
end of the file so i said okay so maybe

170
00:06:23,919 --> 00:06:25,759
it is that these files are encrypted a

171
00:06:25,759 --> 00:06:28,000
couple of times so that eight megabytes

172
00:06:28,000 --> 00:06:30,560
is just couple of times answer is no so

173
00:06:30,560 --> 00:06:33,440
what happened after some analysis is

174
00:06:33,440 --> 00:06:35,919
that that first eight megabytes was

175
00:06:35,919 --> 00:06:38,080
indeed stuff that hackers were

176
00:06:38,080 --> 00:06:40,240
encrypting but

177
00:06:40,240 --> 00:06:43,440
because of the data that was in use

178
00:06:43,440 --> 00:06:45,680
unfortunately the encrypter was coming

179
00:06:45,680 --> 00:06:48,080
in and it was crushing coming in and

180
00:06:48,080 --> 00:06:49,599
crashing so

181
00:06:49,599 --> 00:06:51,599
finally it managed to encrypt this eight

182
00:06:51,599 --> 00:06:54,080
megabytes that was the goal but before

183
00:06:54,080 --> 00:06:56,080
that the data was randomly to this

184
00:06:56,080 --> 00:06:58,319
random points encrypted so we had to

185
00:06:58,319 --> 00:07:00,560
work out where is this cut line where we

186
00:07:00,560 --> 00:07:03,759
use this 512 again and again and again

187
00:07:03,759 --> 00:07:05,759
in order to get into this eight

188
00:07:05,759 --> 00:07:06,960
megabytes

189
00:07:06,960 --> 00:07:10,479
so that kind of experience shows that

190
00:07:10,479 --> 00:07:13,039
through laziness because we cannot call

191
00:07:13,039 --> 00:07:15,360
it differently for not encrypting the

192
00:07:15,360 --> 00:07:17,360
whole set of files it's just encrypting

193
00:07:17,360 --> 00:07:18,880
the eight megabytes so it's like

194
00:07:18,880 --> 00:07:20,800
hacker's a little bit lazy over there

195
00:07:20,800 --> 00:07:22,720
there is some effectiveness which

196
00:07:22,720 --> 00:07:25,440
technically is focused on encrypting as

197
00:07:25,440 --> 00:07:28,000
many files as we can

198
00:07:28,000 --> 00:07:30,479
so at the end we are dealing with

199
00:07:30,479 --> 00:07:32,240
someone that is maybe not even that

200
00:07:32,240 --> 00:07:34,560
experienced but just has a little bit of

201
00:07:34,560 --> 00:07:38,400
money pays um for that for the kid in

202
00:07:38,400 --> 00:07:40,880
some kind of a whatever affiliate model

203
00:07:40,880 --> 00:07:43,280
and then basically encrypts the data of

204
00:07:43,280 --> 00:07:45,759
the corporation and in this particular

205
00:07:45,759 --> 00:07:47,360
customer you might be wondering how

206
00:07:47,360 --> 00:07:49,759
hackers actually managed to get in and

207
00:07:49,759 --> 00:07:52,000
that was fun because they actually get

208
00:07:52,000 --> 00:07:53,840
into the vendor

209
00:07:53,840 --> 00:07:55,759
so it's not that user you know click on

210
00:07:55,759 --> 00:07:57,440
the link or something happens someone

211
00:07:57,440 --> 00:08:00,160
brought a usb device and so on no no no

212
00:08:00,160 --> 00:08:02,400
it was actually a vendor that was

213
00:08:02,400 --> 00:08:04,879
attacked that vendor was managing their

214
00:08:04,879 --> 00:08:05,919
domain

215
00:08:05,919 --> 00:08:08,400
and someone managed to learn that lesson

216
00:08:08,400 --> 00:08:09,919
so it's a little bit of a kind of an

217
00:08:09,919 --> 00:08:12,000
espionage and then they were sitting in

218
00:08:12,000 --> 00:08:13,840
their infrastructure for approximately

219
00:08:13,840 --> 00:08:16,479
three weeks in order to learn what is

220
00:08:16,479 --> 00:08:18,560
the most sensitive how things work out

221
00:08:18,560 --> 00:08:21,520
and so on and then they um

222
00:08:21,520 --> 00:08:24,080
hit them by of course encrypting a big

223
00:08:24,080 --> 00:08:26,639
part of their infrastructure so the

224
00:08:26,639 --> 00:08:28,240
reason why i'm saying this story is

225
00:08:28,240 --> 00:08:30,639
because when we look into the statistics

226
00:08:30,639 --> 00:08:33,839
of the 2021 we have the summary of the

227
00:08:33,839 --> 00:08:36,679
year that says that there is a 1

228
00:08:36,679 --> 00:08:38,240
318

229
00:08:38,240 --> 00:08:39,760
of an increase

230
00:08:39,760 --> 00:08:42,320
in ransomware attacks in the first half

231
00:08:42,320 --> 00:08:46,480
of a 2021. that's crazy so eventually

232
00:08:46,480 --> 00:08:48,320
when we look into other details then

233
00:08:48,320 --> 00:08:50,640
we've got 77 percent of organizations do

234
00:08:50,640 --> 00:08:52,560
not have a cybersecurity incident

235
00:08:52,560 --> 00:08:55,360
response plan so how we are supposed to

236
00:08:55,360 --> 00:08:58,480
respond well to these easy things while

237
00:08:58,480 --> 00:09:01,360
of course we are not prepared and at the

238
00:09:01,360 --> 00:09:03,680
same time the statistic here says that

239
00:09:03,680 --> 00:09:08,080
94 of malware is actually delivered by

240
00:09:08,080 --> 00:09:10,640
email so this is also quite interesting

241
00:09:10,640 --> 00:09:13,920
because again 85 percent of attacks they

242
00:09:13,920 --> 00:09:16,160
actually involve a human element so when

243
00:09:16,160 --> 00:09:18,880
we do connect the dots we can see that

244
00:09:18,880 --> 00:09:21,120
security of the end point it's

245
00:09:21,120 --> 00:09:24,000
definitely trending right now and the

246
00:09:24,000 --> 00:09:26,800
education of a user that works as a very

247
00:09:26,800 --> 00:09:29,120
good backup for technology in order to

248
00:09:29,120 --> 00:09:32,320
prevent of course all these attacks and

249
00:09:32,320 --> 00:09:33,160
that

250
00:09:33,160 --> 00:09:35,920
360 days this is also quite an

251
00:09:35,920 --> 00:09:38,720
interesting number because this is a

252
00:09:38,720 --> 00:09:41,200
number of days to contain uh the breach

253
00:09:41,200 --> 00:09:43,760
to lock it and contain the breach so

254
00:09:43,760 --> 00:09:45,120
there are different sources for that yes

255
00:09:45,120 --> 00:09:46,959
some people say it's like around 200

256
00:09:46,959 --> 00:09:50,160
some people say it's like 316 as you see

257
00:09:50,160 --> 00:09:51,839
but in general like when we are talking

258
00:09:51,839 --> 00:09:54,080
hundreds over there it's a quite a sad

259
00:09:54,080 --> 00:09:56,560
statistic showing us that maybe our

260
00:09:56,560 --> 00:10:00,240
monitoring systems are not in place yet

261
00:10:00,240 --> 00:10:03,120
following up with like what fbi said

262
00:10:03,120 --> 00:10:05,760
these guys said that since kovitch there

263
00:10:05,760 --> 00:10:07,920
is a 300 percent increase in the

264
00:10:07,920 --> 00:10:09,680
reported cyber crimes so we might be

265
00:10:09,680 --> 00:10:12,160
wondering why is that is it because of

266
00:10:12,160 --> 00:10:14,959
the user is it because of the like uh

267
00:10:14,959 --> 00:10:17,440
technology that we are using and i would

268
00:10:17,440 --> 00:10:19,760
say both but definitely phishing is

269
00:10:19,760 --> 00:10:21,040
still a number one mean of

270
00:10:21,040 --> 00:10:24,640
transportation for um for uh malware

271
00:10:24,640 --> 00:10:25,839
therefore

272
00:10:25,839 --> 00:10:28,720
when we summarize 2022

273
00:10:28,720 --> 00:10:30,399
or we need kind of like look into the

274
00:10:30,399 --> 00:10:32,480
future maybe a little bit we should i

275
00:10:32,480 --> 00:10:35,440
think call 2022 as a year of a

276
00:10:35,440 --> 00:10:38,880
well-written were established and tested

277
00:10:38,880 --> 00:10:41,120
incident response plan and to be fair a

278
00:10:41,120 --> 00:10:43,200
little bit of suggestion i think that

279
00:10:43,200 --> 00:10:45,120
incident response

280
00:10:45,120 --> 00:10:47,920
sounds like a order in a restaurant

281
00:10:47,920 --> 00:10:50,480
yeah so it's more like you order some

282
00:10:50,480 --> 00:10:51,920
i don't know french fries and then

283
00:10:51,920 --> 00:10:53,839
basically they're gonna be like oh what

284
00:10:53,839 --> 00:10:56,160
do you want to have and then you respond

285
00:10:56,160 --> 00:10:58,399
it's like so polite who's gonna pay for

286
00:10:58,399 --> 00:11:00,800
that yeah so we are renaming it right

287
00:11:00,800 --> 00:11:04,079
now to the crisis management yes so

288
00:11:04,079 --> 00:11:06,320
cyber crisis management plan because if

289
00:11:06,320 --> 00:11:07,839
executives hear that they're gonna be

290
00:11:07,839 --> 00:11:09,360
like oh we don't wanna have a cyber

291
00:11:09,360 --> 00:11:11,360
crisis and the first thing they do they

292
00:11:11,360 --> 00:11:13,040
turn to id

293
00:11:13,040 --> 00:11:15,360
so we need to kind of convince them in

294
00:11:15,360 --> 00:11:18,079
order to actually step into the process

295
00:11:18,079 --> 00:11:20,160
to be obviously addressing their

296
00:11:20,160 --> 00:11:23,360
business risk now when we think about

297
00:11:23,360 --> 00:11:25,040
all these top 10 mistakes by

298
00:11:25,040 --> 00:11:27,519
administrator that are done about the

299
00:11:27,519 --> 00:11:29,440
remote work just to give you also a

300
00:11:29,440 --> 00:11:31,839
little bit of flavor and then we start

301
00:11:31,839 --> 00:11:33,839
when we look into the statistics from

302
00:11:33,839 --> 00:11:35,120
asset

303
00:11:35,120 --> 00:11:36,880
i really like them because they're very

304
00:11:36,880 --> 00:11:39,279
relevant we can see that 81 percent of

305
00:11:39,279 --> 00:11:41,760
people they actually use an a personal

306
00:11:41,760 --> 00:11:43,680
electronic device for work related

307
00:11:43,680 --> 00:11:46,399
functions okay so we give it to kids for

308
00:11:46,399 --> 00:11:48,800
example this is the last statistic 46

309
00:11:48,800 --> 00:11:51,120
percent and then the kids does something

310
00:11:51,120 --> 00:11:53,040
and then introduces a threat to our

311
00:11:53,040 --> 00:11:55,040
organization we know the drill but just

312
00:11:55,040 --> 00:11:57,519
wanted to mention it that this is also a

313
00:11:57,519 --> 00:11:59,680
bit of a case so when we look at this

314
00:11:59,680 --> 00:12:02,720
top 10 mistakes what are they first of

315
00:12:02,720 --> 00:12:03,680
all

316
00:12:03,680 --> 00:12:05,639
i think we should start with the

317
00:12:05,639 --> 00:12:08,800
misconfiguration of the end point and

318
00:12:08,800 --> 00:12:10,880
when we think about the misconfiguration

319
00:12:10,880 --> 00:12:13,120
of the endpoint question is okay what do

320
00:12:13,120 --> 00:12:15,040
we set up on the endpoint to be

321
00:12:15,040 --> 00:12:17,920
resistant to the current threats and one

322
00:12:17,920 --> 00:12:20,000
of the things of course should be

323
00:12:20,000 --> 00:12:22,560
firewall it could be antivirus based on

324
00:12:22,560 --> 00:12:24,720
machine learning anti-exploitation

325
00:12:24,720 --> 00:12:27,279
solution and all that stuff fine

326
00:12:27,279 --> 00:12:29,839
but do we design it well according to

327
00:12:29,839 --> 00:12:31,200
what is actually the current threat

328
00:12:31,200 --> 00:12:33,040
because for example if we do have a

329
00:12:33,040 --> 00:12:35,200
power shell can powershell communicate

330
00:12:35,200 --> 00:12:36,639
over the network

331
00:12:36,639 --> 00:12:39,440
normally yes why we are doing this so

332
00:12:39,440 --> 00:12:41,360
what kind of processes are supposed to

333
00:12:41,360 --> 00:12:43,440
communicate over the network yeah let's

334
00:12:43,440 --> 00:12:45,200
technically blacklist everything and why

335
00:12:45,200 --> 00:12:47,519
at least what can communicate and this

336
00:12:47,519 --> 00:12:49,440
is simply a setting of a firewall so

337
00:12:49,440 --> 00:12:51,200
what i'm trying to say is that firewall

338
00:12:51,200 --> 00:12:53,360
nowadays it's becoming more of a

339
00:12:53,360 --> 00:12:56,320
application related firewall so on the

340
00:12:56,320 --> 00:12:58,560
endpoint so we've got a powershell we've

341
00:12:58,560 --> 00:13:01,120
got a c script we've got all the

342
00:13:01,120 --> 00:13:03,440
scripting languages and different low

343
00:13:03,440 --> 00:13:05,440
bus load bins capabilities in windows

344
00:13:05,440 --> 00:13:07,279
for example that are able to communicate

345
00:13:07,279 --> 00:13:09,839
over network that can do the harm but

346
00:13:09,839 --> 00:13:12,000
eventually we should focus more on white

347
00:13:12,000 --> 00:13:15,120
listing only what outlook edge

348
00:13:15,120 --> 00:13:17,680
firefox chrome name it yeah maybe 10

349
00:13:17,680 --> 00:13:19,839
more business apps but that's it excel

350
00:13:19,839 --> 00:13:22,160
is not supposed to do it and therefore i

351
00:13:22,160 --> 00:13:24,079
would have to show you a demo with an

352
00:13:24,079 --> 00:13:26,000
interesting perspective

353
00:13:26,000 --> 00:13:29,360
on excel actually so it's a very much a

354
00:13:29,360 --> 00:13:31,200
pretty simple demo where we do have a

355
00:13:31,200 --> 00:13:33,680
net cut setup on a hacker side and then

356
00:13:33,680 --> 00:13:36,399
basically we've got the machine that is

357
00:13:36,399 --> 00:13:37,680
the user's

358
00:13:37,680 --> 00:13:39,760
user receives an email that's apparently

359
00:13:39,760 --> 00:13:41,279
phishing you can see that this is a

360
00:13:41,279 --> 00:13:43,120
macro obviously you will never click on

361
00:13:43,120 --> 00:13:45,839
that but user will it has the context

362
00:13:45,839 --> 00:13:48,480
yes so user could open it but that's not

363
00:13:48,480 --> 00:13:50,160
really my point my point is to show you

364
00:13:50,160 --> 00:13:51,839
what happens next

365
00:13:51,839 --> 00:13:54,639
so we've got excel and eventually user

366
00:13:54,639 --> 00:13:56,959
of course gonna just click on any

367
00:13:56,959 --> 00:13:59,600
editing classic stuff and then enable

368
00:13:59,600 --> 00:14:01,199
content in order to be able to run the

369
00:14:01,199 --> 00:14:03,760
macro pick we've got that there is a

370
00:14:03,760 --> 00:14:06,399
connection made by who by some kind of

371
00:14:06,399 --> 00:14:09,360
an executable can we technically run an

372
00:14:09,360 --> 00:14:11,199
executable maybe from the even windows

373
00:14:11,199 --> 00:14:12,720
folder and so on

374
00:14:12,720 --> 00:14:15,360
okay that's a question here when we look

375
00:14:15,360 --> 00:14:17,360
inside the macro you can see of course

376
00:14:17,360 --> 00:14:19,360
that that's just like one big button and

377
00:14:19,360 --> 00:14:20,639
then there is a resource the

378
00:14:20,639 --> 00:14:22,959
secureacademy.com we are downloading the

379
00:14:22,959 --> 00:14:25,519
txt file and then by using the search

380
00:14:25,519 --> 00:14:27,440
util we are not downloading but use your

381
00:14:27,440 --> 00:14:30,320
search util but just the coding and then

382
00:14:30,320 --> 00:14:31,920
we are creating the process otherwise it

383
00:14:31,920 --> 00:14:33,519
will be found by antivirus solutions

384
00:14:33,519 --> 00:14:34,720
right

385
00:14:34,720 --> 00:14:37,040
so when we get that connection here of

386
00:14:37,040 --> 00:14:38,959
course we can do who am i

387
00:14:38,959 --> 00:14:40,720
and then the next stage is that we can

388
00:14:40,720 --> 00:14:42,720
see that we are just a regular user so

389
00:14:42,720 --> 00:14:45,120
this is the set of privileges for users

390
00:14:45,120 --> 00:14:47,440
so we are secure paula here we go and

391
00:14:47,440 --> 00:14:48,880
then the next part is that we're going

392
00:14:48,880 --> 00:14:51,839
to download an execution

393
00:14:51,839 --> 00:14:54,160
library to search for potential

394
00:14:54,160 --> 00:14:55,920
privilege escalations so we're going to

395
00:14:55,920 --> 00:14:58,639
do curl and then we've got a 10-10 and

396
00:14:58,639 --> 00:15:01,279
250 let's download some from payload

397
00:15:01,279 --> 00:15:03,600
privilege escalation powershell script

398
00:15:03,600 --> 00:15:05,839
so long story short we do output

399
00:15:05,839 --> 00:15:08,639
privilege escalation ps1 perfect and

400
00:15:08,639 --> 00:15:11,680
while a regular user you can see it here

401
00:15:11,680 --> 00:15:13,680
cannot change the execution policy

402
00:15:13,680 --> 00:15:15,440
within the powershell the regular user

403
00:15:15,440 --> 00:15:18,160
can actually bypass it yeah so we can

404
00:15:18,160 --> 00:15:20,240
either actually there's over 20 ways of

405
00:15:20,240 --> 00:15:21,920
doing it but we're going to do it in

406
00:15:21,920 --> 00:15:24,959
process so asset execution policy bypass

407
00:15:24,959 --> 00:15:27,360
scope process that's what the user can

408
00:15:27,360 --> 00:15:29,440
do and then basically the next part is

409
00:15:29,440 --> 00:15:31,440
going to be just to run that privilege

410
00:15:31,440 --> 00:15:33,839
escalation script so we are doing it

411
00:15:33,839 --> 00:15:37,120
enter awesome and that searches us for

412
00:15:37,120 --> 00:15:38,079
the

413
00:15:38,079 --> 00:15:40,240
libraries that are allowing us to do

414
00:15:40,240 --> 00:15:42,560
some hijacking now for example like what

415
00:15:42,560 --> 00:15:45,040
is this about here there's a dll that

416
00:15:45,040 --> 00:15:48,000
dll is actually loaded as you can even

417
00:15:48,000 --> 00:15:50,560
see here by the task scheduler upon

418
00:15:50,560 --> 00:15:53,519
certificate startup okay so how what

419
00:15:53,519 --> 00:15:55,519
kind of identity we're gonna gain and

420
00:15:55,519 --> 00:15:57,839
also it runs from the modifiable path

421
00:15:57,839 --> 00:16:00,480
python 27. so long story short we're

422
00:16:00,480 --> 00:16:02,720
gonna do curl and then turn 10 and then

423
00:16:02,720 --> 00:16:04,800
250 and then we're going to do payloads

424
00:16:04,800 --> 00:16:05,920
and then we're going to download the

425
00:16:05,920 --> 00:16:10,079
reverse dll in place of the wpts

426
00:16:10,079 --> 00:16:13,839
extensions dll in python 27 folder so

427
00:16:13,839 --> 00:16:15,519
let's do that

428
00:16:15,519 --> 00:16:18,800
and of course that dll is replaced so

429
00:16:18,800 --> 00:16:21,040
easy stuff and then we're going to do

430
00:16:21,040 --> 00:16:23,360
there just to be sure that we got that

431
00:16:23,360 --> 00:16:25,360
yeah so we've got that dll of course

432
00:16:25,360 --> 00:16:27,040
it's still there yeah so that's that

433
00:16:27,040 --> 00:16:29,759
that's the setup okay so the next part

434
00:16:29,759 --> 00:16:31,279
it's going to be related with just

435
00:16:31,279 --> 00:16:33,920
shutting down the client in order to

436
00:16:33,920 --> 00:16:37,279
load a library upon the schedule task so

437
00:16:37,279 --> 00:16:40,720
shutdown rt1 here we go we are just here

438
00:16:40,720 --> 00:16:43,040
restarting we've got a net cut that we

439
00:16:43,040 --> 00:16:44,880
set up for the listening and of course

440
00:16:44,880 --> 00:16:47,279
as you can imagine there's a dll loaded

441
00:16:47,279 --> 00:16:50,399
by the scheduled task to start scheduler

442
00:16:50,399 --> 00:16:52,639
and eventually it will connect back to

443
00:16:52,639 --> 00:16:55,839
the uh to the hacker now question is in

444
00:16:55,839 --> 00:16:57,680
how many systems that you know that

445
00:16:57,680 --> 00:16:59,040
would be possible that you've got some

446
00:16:59,040 --> 00:17:01,680
kind of a dll running by the uh

447
00:17:01,680 --> 00:17:04,000
scheduled tasks and then at the end you

448
00:17:04,000 --> 00:17:05,839
will see that it actually can connect

449
00:17:05,839 --> 00:17:08,640
out yeah and if you do who am i you can

450
00:17:08,640 --> 00:17:11,039
see that we are here anti-authority

451
00:17:11,039 --> 00:17:13,359
system yeah so this is quite an easy

452
00:17:13,359 --> 00:17:16,839
scenario but demonstrating us how

453
00:17:16,839 --> 00:17:18,799
important that

454
00:17:18,799 --> 00:17:21,919
application treatment becomes in terms

455
00:17:21,919 --> 00:17:24,799
of network communication on the endpoint

456
00:17:24,799 --> 00:17:27,039
just one of their mistakes

457
00:17:27,039 --> 00:17:29,039
now overly simple passwords and security

458
00:17:29,039 --> 00:17:30,960
questions uh yeah what do we mean by

459
00:17:30,960 --> 00:17:34,320
this i mean one thing like of course mfa

460
00:17:34,320 --> 00:17:35,520
it's

461
00:17:35,520 --> 00:17:37,120
we can we're not supposed to even call

462
00:17:37,120 --> 00:17:39,760
it a trend it's a must yeah

463
00:17:39,760 --> 00:17:41,760
so uh not to make a comment really about

464
00:17:41,760 --> 00:17:43,440
it because we all know what it is but

465
00:17:43,440 --> 00:17:44,720
what i want to say is that

466
00:17:44,720 --> 00:17:47,760
administrators when they turn on mfa

467
00:17:47,760 --> 00:17:49,360
they kind of think that oh that's the

468
00:17:49,360 --> 00:17:51,600
way to protect us from the passwords

469
00:17:51,600 --> 00:17:53,520
leaking for the from the identity

470
00:17:53,520 --> 00:17:56,799
leaking uh not exactly it's just one of

471
00:17:56,799 --> 00:17:59,679
the ways to protect us from this but if

472
00:17:59,679 --> 00:18:01,840
we do have an access for example to the

473
00:18:01,840 --> 00:18:03,679
user's workstation because of the

474
00:18:03,679 --> 00:18:05,600
phishing activity then it's a different

475
00:18:05,600 --> 00:18:08,960
story mfa can be bypassed and this is

476
00:18:08,960 --> 00:18:10,960
what i wanted to show you as one of the

477
00:18:10,960 --> 00:18:14,559
misconceptions actually around mfa

478
00:18:14,559 --> 00:18:16,880
so for this we're going to use the evil

479
00:18:16,880 --> 00:18:18,000
jinx

480
00:18:18,000 --> 00:18:19,919
so let's dig in so we've got the evil

481
00:18:19,919 --> 00:18:21,760
jinx and within the evil jinx we're

482
00:18:21,760 --> 00:18:22,960
going to generate the link so we've got

483
00:18:22,960 --> 00:18:26,640
alluris and then get url for teams yeah

484
00:18:26,640 --> 00:18:28,799
so this is the one that we got login

485
00:18:28,799 --> 00:18:31,840
teams microsoft online dot com dot what

486
00:18:31,840 --> 00:18:33,120
dot co

487
00:18:33,120 --> 00:18:35,200
co it's not a microsoft domain it's

488
00:18:35,200 --> 00:18:36,799
actually our domain we bought it we

489
00:18:36,799 --> 00:18:39,440
bought a certificate so it's all good

490
00:18:39,440 --> 00:18:41,840
now it looks almost the same user will

491
00:18:41,840 --> 00:18:44,400
not notice so user gets this link so

492
00:18:44,400 --> 00:18:47,200
login teams microsoft online.com.co

493
00:18:47,200 --> 00:18:48,880
let's actually have a quick look so you

494
00:18:48,880 --> 00:18:51,200
can see its certificate it's all trusted

495
00:18:51,200 --> 00:18:53,520
all valid and so on so it's a little bit

496
00:18:53,520 --> 00:18:56,400
of a passe to check only the certificate

497
00:18:56,400 --> 00:18:59,120
we put in the username abby secure ninja

498
00:18:59,120 --> 00:19:00,880
and then we put the password and then we

499
00:19:00,880 --> 00:19:03,840
just do sign in in order to

500
00:19:03,840 --> 00:19:06,000
sign in and then we approve the sign in

501
00:19:06,000 --> 00:19:08,880
request okay user is doing this so this

502
00:19:08,880 --> 00:19:11,600
is the multi-factor authentication part

503
00:19:11,600 --> 00:19:14,160
great stay sign in yes no doesn't matter

504
00:19:14,160 --> 00:19:15,679
because we're going to be redirected to

505
00:19:15,679 --> 00:19:18,400
login microsoft online.com

506
00:19:18,400 --> 00:19:21,039
now of course getting the passwords like

507
00:19:21,039 --> 00:19:23,440
with this attack it's uh like attack

508
00:19:23,440 --> 00:19:25,600
from 80s so now we're gonna do a little

509
00:19:25,600 --> 00:19:27,600
bit different stuff so all authorization

510
00:19:27,600 --> 00:19:29,919
tokens intercepted so here we go

511
00:19:29,919 --> 00:19:32,559
sessions just to check we got this and

512
00:19:32,559 --> 00:19:35,039
we're gonna display our authorization

513
00:19:35,039 --> 00:19:36,960
token and that is something that we're

514
00:19:36,960 --> 00:19:39,280
going to be submitting into the browser

515
00:19:39,280 --> 00:19:42,160
in order to log in as a user yeah so

516
00:19:42,160 --> 00:19:43,760
let's do that so we're going to go to

517
00:19:43,760 --> 00:19:44,919
the original

518
00:19:44,919 --> 00:19:46,640
portaloffice.com

519
00:19:46,640 --> 00:19:48,720
so now it's all good

520
00:19:48,720 --> 00:19:50,559
and we're going to just do what like

521
00:19:50,559 --> 00:19:52,720
should we put the username no because we

522
00:19:52,720 --> 00:19:55,440
have all the details in the token itself

523
00:19:55,440 --> 00:19:57,360
so we're gonna get that and we're gonna

524
00:19:57,360 --> 00:19:59,919
submit it into the current session in

525
00:19:59,919 --> 00:20:02,480
order of course to be

526
00:20:02,480 --> 00:20:04,080
able to be that user so we go to the

527
00:20:04,080 --> 00:20:06,960
cookies and then here we go we can just

528
00:20:06,960 --> 00:20:08,640
do art and first we're going to of

529
00:20:08,640 --> 00:20:10,880
course delete everything so that it's a

530
00:20:10,880 --> 00:20:13,280
clean situation and then we are

531
00:20:13,280 --> 00:20:14,400
importing

532
00:20:14,400 --> 00:20:16,960
that particular token and then check

533
00:20:16,960 --> 00:20:18,880
here we go and then the next thing that

534
00:20:18,880 --> 00:20:21,440
we only have to do is just to restart

535
00:20:21,440 --> 00:20:23,679
because office.com is available right

536
00:20:23,679 --> 00:20:26,480
now for us based on that particular

537
00:20:26,480 --> 00:20:29,280
authorization cookie as this user so

538
00:20:29,280 --> 00:20:31,440
quite an interesting perspective showing

539
00:20:31,440 --> 00:20:33,760
us that endpoint security once again

540
00:20:33,760 --> 00:20:35,440
it's an important thing

541
00:20:35,440 --> 00:20:36,320
now

542
00:20:36,320 --> 00:20:38,080
of course when we do connect to the

543
00:20:38,080 --> 00:20:40,799
network using the vpn access

544
00:20:40,799 --> 00:20:42,880
then we should be

545
00:20:42,880 --> 00:20:45,440
accessing only certain repositories

546
00:20:45,440 --> 00:20:48,720
that's all clear just to make a like a

547
00:20:48,720 --> 00:20:50,880
point about it because when the hacker

548
00:20:50,880 --> 00:20:52,480
is already connected on the user's

549
00:20:52,480 --> 00:20:55,039
network yet then on the user's computer

550
00:20:55,039 --> 00:20:56,880
then we are able to use this machine as

551
00:20:56,880 --> 00:20:59,120
a proxy so here is the network

552
00:20:59,120 --> 00:21:01,440
segmentation that comes to place but

553
00:21:01,440 --> 00:21:03,440
when we think about being connected to

554
00:21:03,440 --> 00:21:05,679
the network and being literally nobody

555
00:21:05,679 --> 00:21:08,080
in that network what comes to place as

556
00:21:08,080 --> 00:21:09,280
next

557
00:21:09,280 --> 00:21:12,240
is actually lack of smb signing

558
00:21:12,240 --> 00:21:13,600
and this is to be fair one of my

559
00:21:13,600 --> 00:21:16,159
favorite attacks because it just pretty

560
00:21:16,159 --> 00:21:18,799
much always works and the lack of smb

561
00:21:18,799 --> 00:21:21,360
signing means that it's not really that

562
00:21:21,360 --> 00:21:23,840
that is just a problem lack of smb

563
00:21:23,840 --> 00:21:26,080
signing when you combine it all together

564
00:21:26,080 --> 00:21:28,640
with ntlam version 2 that is what is a

565
00:21:28,640 --> 00:21:29,679
problem

566
00:21:29,679 --> 00:21:32,720
so long story short ntlm being uh ntl

567
00:21:32,720 --> 00:21:34,880
version 2 being a response challenge

568
00:21:34,880 --> 00:21:37,360
response protocol allows us to take a

569
00:21:37,360 --> 00:21:39,760
response and relay it to the target

570
00:21:39,760 --> 00:21:41,440
that's why of course we call it an smb

571
00:21:41,440 --> 00:21:43,039
relay it's one of the simplest attacks

572
00:21:43,039 --> 00:21:45,520
but at the same time the most official

573
00:21:45,520 --> 00:21:48,080
efficient so let me basically get into

574
00:21:48,080 --> 00:21:50,480
this so that you can see how easy it is

575
00:21:50,480 --> 00:21:51,919
and then of course

576
00:21:51,919 --> 00:21:54,159
we will discuss the further steps around

577
00:21:54,159 --> 00:21:57,120
the attack as well so here's the setup

578
00:21:57,120 --> 00:21:59,600
so i've got simply the kali over here

579
00:21:59,600 --> 00:22:01,679
set up uh whatever you can also do it in

580
00:22:01,679 --> 00:22:04,159
powershell by using invade relay also

581
00:22:04,159 --> 00:22:06,000
another option so we're going to do here

582
00:22:06,000 --> 00:22:08,400
i use exploit multihandler and then set

583
00:22:08,400 --> 00:22:10,960
payload windows meta pretty reverse tcp

584
00:22:10,960 --> 00:22:12,480
let me just make it even a little bit

585
00:22:12,480 --> 00:22:14,159
bigger and then you can see that i'm

586
00:22:14,159 --> 00:22:17,360
setting up the l host to the current

587
00:22:17,360 --> 00:22:19,919
attackers ip and then the only thing

588
00:22:19,919 --> 00:22:22,159
i'll need to do is to do exploit and

589
00:22:22,159 --> 00:22:24,960
over there i'm doing the smb relay xpy

590
00:22:24,960 --> 00:22:26,880
so there are many ways of doing it and

591
00:22:26,880 --> 00:22:28,960
upon execution i'm running that

592
00:22:28,960 --> 00:22:31,919
executable secushel 104

593
00:22:31,919 --> 00:22:34,640
a dot exe now this is just a simply

594
00:22:34,640 --> 00:22:37,200
generated reverse shell by using our

595
00:22:37,200 --> 00:22:39,520
toolkit now what i'm going to do on my

596
00:22:39,520 --> 00:22:42,159
side i would just simply uh query the

597
00:22:42,159 --> 00:22:45,200
backslash backslash ip and backslash

598
00:22:45,200 --> 00:22:47,679
backslash ip triggers antenna version 2

599
00:22:47,679 --> 00:22:49,440
authentication so

600
00:22:49,440 --> 00:22:51,120
how probable is that someone's going to

601
00:22:51,120 --> 00:22:53,280
hit backstage backslash ip or backstage

602
00:22:53,280 --> 00:22:55,440
backslash short name very probable and

603
00:22:55,440 --> 00:22:57,520
that's what we're going to do enter

604
00:22:57,520 --> 00:23:00,080
so right now we've got a session opened

605
00:23:00,080 --> 00:23:02,320
just like that it's not a vulnerability

606
00:23:02,320 --> 00:23:04,559
it's a misconfiguration based on using

607
00:23:04,559 --> 00:23:08,400
antenna version 2 and smb not signed 668

608
00:23:08,400 --> 00:23:09,679
migrate

609
00:23:09,679 --> 00:23:11,360
668.

610
00:23:11,360 --> 00:23:13,440
so we are doing right now as in

611
00:23:13,440 --> 00:23:15,919
metasploit we call it migration

612
00:23:15,919 --> 00:23:18,720
migration is such a romantic word uh you

613
00:23:18,720 --> 00:23:20,480
are migrating

614
00:23:20,480 --> 00:23:22,880
yeah but truly what migration is is

615
00:23:22,880 --> 00:23:24,720
basically just injecting the code into

616
00:23:24,720 --> 00:23:27,360
the memory on one of the processes and

617
00:23:27,360 --> 00:23:30,480
uh simply allowing us to

618
00:23:30,480 --> 00:23:32,960
become someone within the instance of

619
00:23:32,960 --> 00:23:35,360
that process so long story short right

620
00:23:35,360 --> 00:23:40,080
now i am in 668 so in svc host and just

621
00:23:40,080 --> 00:23:42,240
having a code written in the memory

622
00:23:42,240 --> 00:23:45,679
address of svc host is that fixable yes

623
00:23:45,679 --> 00:23:47,279
we have to have a well configured

624
00:23:47,279 --> 00:23:49,120
exploit guard or any agreementy

625
00:23:49,120 --> 00:23:52,159
exploitation solution that again takes

626
00:23:52,159 --> 00:23:54,880
us to the endpoint protection yeah

627
00:23:54,880 --> 00:23:57,200
so again in order to fix this problem we

628
00:23:57,200 --> 00:23:59,679
have to sign an smv if we got a

629
00:23:59,679 --> 00:24:02,400
possibility try to avoid using antelope

630
00:24:02,400 --> 00:24:04,159
version 2 you can always use the fully

631
00:24:04,159 --> 00:24:06,400
qualified domain names plus of course

632
00:24:06,400 --> 00:24:08,320
whitelisting comes to place because we

633
00:24:08,320 --> 00:24:10,480
were able to execute the code that's

634
00:24:10,480 --> 00:24:12,880
technically we did not know so this is

635
00:24:12,880 --> 00:24:14,720
also one of the mistakes that we could

636
00:24:14,720 --> 00:24:18,880
summarize upon upon this situation okay

637
00:24:18,880 --> 00:24:21,200
so another part it's simply allowing an

638
00:24:21,200 --> 00:24:24,000
unusual code to execute so one thing was

639
00:24:24,000 --> 00:24:26,480
an executables whitelisting and so on

640
00:24:26,480 --> 00:24:28,880
but we also allow for example things

641
00:24:28,880 --> 00:24:29,679
like

642
00:24:29,679 --> 00:24:32,720
macros to run are macros even like

643
00:24:32,720 --> 00:24:34,720
supposed to run at all

644
00:24:34,720 --> 00:24:37,120
and that takes us actually to one of the

645
00:24:37,120 --> 00:24:39,360
demos that i wanted to show you related

646
00:24:39,360 --> 00:24:41,360
with the attack service reduction rules

647
00:24:41,360 --> 00:24:43,840
one of the funniest nicest risk

648
00:24:43,840 --> 00:24:46,960
accessories risk minimizers uh right now

649
00:24:46,960 --> 00:24:48,799
so if you're gonna go to the microsoft

650
00:24:48,799 --> 00:24:50,960
defender antivirus within the group

651
00:24:50,960 --> 00:24:53,200
policy and then we go to that defender

652
00:24:53,200 --> 00:24:55,520
exploit guard attack surface reduction

653
00:24:55,520 --> 00:24:56,880
this is the rule that we are talking

654
00:24:56,880 --> 00:24:59,520
about so eventually we can just enable

655
00:24:59,520 --> 00:25:02,320
it it's not uh really exciting because

656
00:25:02,320 --> 00:25:04,159
the only thing you need to do over there

657
00:25:04,159 --> 00:25:07,200
is to drop an id of a rule that you

658
00:25:07,200 --> 00:25:08,799
would like to assure

659
00:25:08,799 --> 00:25:10,400
so that is pretty cool because if you

660
00:25:10,400 --> 00:25:13,039
look into that website over there from

661
00:25:13,039 --> 00:25:14,559
dogs you've got the attack surface

662
00:25:14,559 --> 00:25:16,080
reduction rules and please have a look

663
00:25:16,080 --> 00:25:18,320
at the rule names we've got a blog abuse

664
00:25:18,320 --> 00:25:20,559
of exploited vulnerable sign drivers but

665
00:25:20,559 --> 00:25:22,159
also we've got to block all office

666
00:25:22,159 --> 00:25:23,760
applications from creating child

667
00:25:23,760 --> 00:25:24,960
processes

668
00:25:24,960 --> 00:25:28,320
that is purely macros we've got also

669
00:25:28,320 --> 00:25:30,480
blocking for example the process

670
00:25:30,480 --> 00:25:33,039
creations like you see originating from

671
00:25:33,039 --> 00:25:36,240
wmi or psx so we can take that rule and

672
00:25:36,240 --> 00:25:38,480
of course this works in a very easy way

673
00:25:38,480 --> 00:25:40,880
so we just like paste it yeah so right

674
00:25:40,880 --> 00:25:43,440
now anything ps exec related even though

675
00:25:43,440 --> 00:25:45,360
you might have a blocker or anything

676
00:25:45,360 --> 00:25:47,440
else really will just not be allowed to

677
00:25:47,440 --> 00:25:49,679
run so here you're just enabling the

678
00:25:49,679 --> 00:25:52,799
protection against scenarios

679
00:25:52,799 --> 00:25:54,480
and there's also more like for example

680
00:25:54,480 --> 00:25:57,039
they're blocking the win32 cores from

681
00:25:57,039 --> 00:25:59,440
office macros and that is awesome

682
00:25:59,440 --> 00:26:01,919
because we in 32 api calls it's actually

683
00:26:01,919 --> 00:26:04,240
a pretty advanced type of a macro

684
00:26:04,240 --> 00:26:05,760
because you're gonna execute the code

685
00:26:05,760 --> 00:26:07,679
inside excel

686
00:26:07,679 --> 00:26:09,600
so long story short it would be lovely

687
00:26:09,600 --> 00:26:12,480
to test it um so let's see uh what we

688
00:26:12,480 --> 00:26:14,880
what we got so here we've got our abbey

689
00:26:14,880 --> 00:26:17,279
abbey user let's just do gp update slash

690
00:26:17,279 --> 00:26:18,480
force

691
00:26:18,480 --> 00:26:20,720
and then the next part uh it's going to

692
00:26:20,720 --> 00:26:23,520
be to verify whether our policy works

693
00:26:23,520 --> 00:26:25,440
and it's just an extension of a of a

694
00:26:25,440 --> 00:26:27,440
defender yeah so here we go and by the

695
00:26:27,440 --> 00:26:29,919
way it just works by default in in

696
00:26:29,919 --> 00:26:32,080
system if you are using the classic

697
00:26:32,080 --> 00:26:34,159
defender so here we go there is a little

698
00:26:34,159 --> 00:26:36,640
bit of a macro we knew from the previous

699
00:26:36,640 --> 00:26:39,360
demo and eventually here we've got like

700
00:26:39,360 --> 00:26:41,840
a button to click so here we go enable

701
00:26:41,840 --> 00:26:44,080
content and user is like what is this

702
00:26:44,080 --> 00:26:45,279
and then you can see that that

703
00:26:45,279 --> 00:26:46,880
particular thing has been blocked

704
00:26:46,880 --> 00:26:50,880
because there is a win32 api um that is

705
00:26:50,880 --> 00:26:53,360
that is happening yeah and that is

706
00:26:53,360 --> 00:26:55,840
something that we can also uh reflect in

707
00:26:55,840 --> 00:26:57,679
the log and we are able to see that one

708
00:26:57,679 --> 00:26:59,200
in a virus and threat protection for

709
00:26:59,200 --> 00:27:01,039
example so if you go to the protection

710
00:27:01,039 --> 00:27:03,279
history not only it's in a even log but

711
00:27:03,279 --> 00:27:05,039
of course here you're able to quickly

712
00:27:05,039 --> 00:27:06,960
see that there is actually an

713
00:27:06,960 --> 00:27:09,440
administrator that blocked this action

714
00:27:09,440 --> 00:27:11,679
and you can see that there is a we infer

715
00:27:11,679 --> 00:27:13,919
to api calls from office macro scenario

716
00:27:13,919 --> 00:27:14,960
that worked

717
00:27:14,960 --> 00:27:17,279
so quite an easy setup uh one of the

718
00:27:17,279 --> 00:27:20,000
best in my opinion solutions that are

719
00:27:20,000 --> 00:27:20,960
out there

720
00:27:20,960 --> 00:27:23,360
all protocols and their default settings

721
00:27:23,360 --> 00:27:26,080
exactly so one of the mistakes

722
00:27:26,080 --> 00:27:28,559
essentially is not to perform the

723
00:27:28,559 --> 00:27:30,240
regular reviews

724
00:27:30,240 --> 00:27:33,200
on the legacy stuff what has changed in

725
00:27:33,200 --> 00:27:35,760
the legacy environment so what kind of

726
00:27:35,760 --> 00:27:37,279
what kind of

727
00:27:37,279 --> 00:27:39,919
unfortunately a technology depth that we

728
00:27:39,919 --> 00:27:40,720
got

729
00:27:40,720 --> 00:27:42,559
that that is there that is actually a

730
00:27:42,559 --> 00:27:44,399
pain for us that we have to

731
00:27:44,399 --> 00:27:46,720
solve and one of these technology depths

732
00:27:46,720 --> 00:27:50,159
i would say it's actually a tds so the

733
00:27:50,159 --> 00:27:52,399
tabular data stream protocol that is

734
00:27:52,399 --> 00:27:54,159
used by the sql server

735
00:27:54,159 --> 00:27:54,880
now

736
00:27:54,880 --> 00:27:57,360
however as challenging that sounds guys

737
00:27:57,360 --> 00:27:59,679
i've never seen a sql server that is

738
00:27:59,679 --> 00:28:02,159
configured well like from the scratch so

739
00:28:02,159 --> 00:28:03,919
there's a bunch of consultants that come

740
00:28:03,919 --> 00:28:06,480
over they install a database

741
00:28:06,480 --> 00:28:08,399
that's it to provide a database

742
00:28:08,399 --> 00:28:10,799
functionality and that's kind of what we

743
00:28:10,799 --> 00:28:13,200
end up with so long story short it's by

744
00:28:13,200 --> 00:28:15,120
default wrong

745
00:28:15,120 --> 00:28:17,120
why is it wrong i would love to show you

746
00:28:17,120 --> 00:28:20,320
this so in general badly configured sql

747
00:28:20,320 --> 00:28:21,279
server

748
00:28:21,279 --> 00:28:22,480
allows us

749
00:28:22,480 --> 00:28:23,360
to

750
00:28:23,360 --> 00:28:25,840
well spoof traffic

751
00:28:25,840 --> 00:28:28,399
to the application or slash database

752
00:28:28,399 --> 00:28:30,799
just because the tds itself it's

753
00:28:30,799 --> 00:28:33,520
actually in a clear text so let's dig in

754
00:28:33,520 --> 00:28:35,200
let's let's see what we got over there

755
00:28:35,200 --> 00:28:37,840
so we've got a query so select customer

756
00:28:37,840 --> 00:28:40,480
id company name contact name address

757
00:28:40,480 --> 00:28:43,279
city from customers and so on okay so

758
00:28:43,279 --> 00:28:45,760
simple query if we execute it you guys

759
00:28:45,760 --> 00:28:47,840
can see that we are getting a result so

760
00:28:47,840 --> 00:28:51,200
this is a classic query to the database

761
00:28:51,200 --> 00:28:53,360
now we're gonna refresh the logins

762
00:28:53,360 --> 00:28:55,200
because as we can guess something's

763
00:28:55,200 --> 00:28:57,440
gonna happen here we've got a bob secure

764
00:28:57,440 --> 00:29:00,399
administrator sa and so on so that's it

765
00:29:00,399 --> 00:29:03,039
yeah not much nothing wrong over there

766
00:29:03,039 --> 00:29:04,240
but

767
00:29:04,240 --> 00:29:07,039
that particular query once of course we

768
00:29:07,039 --> 00:29:10,080
do set it up in the network it can be

769
00:29:10,080 --> 00:29:13,120
captured and it could be also spoofed

770
00:29:13,120 --> 00:29:15,200
and that is what we're gonna do so let's

771
00:29:15,200 --> 00:29:17,039
go to the other side of

772
00:29:17,039 --> 00:29:19,120
a story over here and we're gonna be

773
00:29:19,120 --> 00:29:21,360
simply running maybe a wireshark in

774
00:29:21,360 --> 00:29:23,520
order to capture that particular

775
00:29:23,520 --> 00:29:26,720
aquarium so let's just um get into into

776
00:29:26,720 --> 00:29:29,279
the wireshark uh yeah let's just around

777
00:29:29,279 --> 00:29:31,279
it maybe from the icon here we go

778
00:29:31,279 --> 00:29:34,480
and uh our job it's gonna be to uh use

779
00:29:34,480 --> 00:29:37,679
the tds filter in order to capture that

780
00:29:37,679 --> 00:29:39,120
traffic let's wait for the moment till

781
00:29:39,120 --> 00:29:41,840
it runs and here we go we've got a tds

782
00:29:41,840 --> 00:29:44,000
filter that is already preset and the

783
00:29:44,000 --> 00:29:46,320
next step it's going to be go to

784
00:29:46,320 --> 00:29:49,279
of course uh here just to simply capture

785
00:29:49,279 --> 00:29:51,919
on all of the interfaces that's it and

786
00:29:51,919 --> 00:29:55,200
then we are monitoring that connectivity

787
00:29:55,200 --> 00:29:57,120
now the only thing we're gonna do is

788
00:29:57,120 --> 00:29:59,679
just to use this query here we go and

789
00:29:59,679 --> 00:30:02,559
execute and look at this part here we

790
00:30:02,559 --> 00:30:05,200
are capturing it in the clear text so

791
00:30:05,200 --> 00:30:07,200
there's already like some select process

792
00:30:07,200 --> 00:30:09,520
id some some stuff and if you go like

793
00:30:09,520 --> 00:30:12,720
down down down down down here we go then

794
00:30:12,720 --> 00:30:14,559
you can see that there's a select

795
00:30:14,559 --> 00:30:17,440
customer id company name contact name

796
00:30:17,440 --> 00:30:20,480
and so on in the clear text awesome so

797
00:30:20,480 --> 00:30:22,640
let's replace it

798
00:30:22,640 --> 00:30:24,159
why not let's see whether that would

799
00:30:24,159 --> 00:30:26,960
work out or not so the tds is also one

800
00:30:26,960 --> 00:30:29,200
of my favorites because again it's quite

801
00:30:29,200 --> 00:30:31,279
ignored forgotten

802
00:30:31,279 --> 00:30:34,480
so if we do have noted that particular

803
00:30:34,480 --> 00:30:36,799
query the next thing we can do we can

804
00:30:36,799 --> 00:30:39,279
just replace it on the fly by leveraging

805
00:30:39,279 --> 00:30:41,600
a little bit of an rp poisoning

806
00:30:41,600 --> 00:30:43,200
so for that we're going to use the

807
00:30:43,200 --> 00:30:45,120
ethercup or whatever you guys going to

808
00:30:45,120 --> 00:30:47,760
use but what is important is to

809
00:30:47,760 --> 00:30:49,919
smartly change that query so for this

810
00:30:49,919 --> 00:30:51,679
we're going to use the sql inject as

811
00:30:51,679 --> 00:30:54,080
well and within the sql inject i've

812
00:30:54,080 --> 00:30:56,240
already predefined the query select

813
00:30:56,240 --> 00:30:59,519
customer id company name contact name as

814
00:30:59,519 --> 00:31:01,519
you can see and that's the address cd

815
00:31:01,519 --> 00:31:04,159
from customers so exactly how it was and

816
00:31:04,159 --> 00:31:06,720
then here we got instead of that put

817
00:31:06,720 --> 00:31:09,600
create login hacker with password

818
00:31:09,600 --> 00:31:12,320
password one yeah and then the next part

819
00:31:12,320 --> 00:31:15,200
is of course uh the specification in

820
00:31:15,200 --> 00:31:17,600
between which kind of host it runs so

821
00:31:17,600 --> 00:31:20,240
we've got our our ether cup over there

822
00:31:20,240 --> 00:31:22,880
as well so lovely yeah that is running

823
00:31:22,880 --> 00:31:23,919
over there

824
00:31:23,919 --> 00:31:26,320
and the next part is of course we're

825
00:31:26,320 --> 00:31:28,320
going to go to the sql server do the

826
00:31:28,320 --> 00:31:31,440
query let's do it and then you guys can

827
00:31:31,440 --> 00:31:33,600
see that it says actually commands

828
00:31:33,600 --> 00:31:35,440
completed successfully so it's a

829
00:31:35,440 --> 00:31:36,960
different stuff

830
00:31:36,960 --> 00:31:40,960
but it says so because we did indeed put

831
00:31:40,960 --> 00:31:43,919
on the commands to create a hacker user

832
00:31:43,919 --> 00:31:46,000
as you can see found our strength and

833
00:31:46,000 --> 00:31:47,440
replaced it

834
00:31:47,440 --> 00:31:49,440
and then the next part of course we have

835
00:31:49,440 --> 00:31:52,080
to do is to go to the logins over there

836
00:31:52,080 --> 00:31:54,640
and then we can just refresh it and then

837
00:31:54,640 --> 00:31:56,640
we're gonna see if we got some

838
00:31:56,640 --> 00:31:59,200
additional user over there hanging out

839
00:31:59,200 --> 00:32:01,679
just because this isn't a clear text and

840
00:32:01,679 --> 00:32:04,559
as you can see there is indeed a user

841
00:32:04,559 --> 00:32:07,279
hacker created so this is tds tabular

842
00:32:07,279 --> 00:32:08,399
data stream

843
00:32:08,399 --> 00:32:10,960
by default configured like that a vast

844
00:32:10,960 --> 00:32:13,120
majority of these organizations

845
00:32:13,120 --> 00:32:15,440
now how can we protect this simply in

846
00:32:15,440 --> 00:32:17,519
the sql server

847
00:32:17,519 --> 00:32:19,919
management console you go to the network

848
00:32:19,919 --> 00:32:22,159
properties and you set up a certificate

849
00:32:22,159 --> 00:32:23,919
for the server for the communication

850
00:32:23,919 --> 00:32:25,600
it's that simple you just need to get a

851
00:32:25,600 --> 00:32:28,399
certificate for that for the server

852
00:32:28,399 --> 00:32:30,320
authentication so here we go so that we

853
00:32:30,320 --> 00:32:32,320
are able to uh actually use it to

854
00:32:32,320 --> 00:32:34,640
protect that connection so long story

855
00:32:34,640 --> 00:32:37,919
short that is quite uh quite a big big

856
00:32:37,919 --> 00:32:39,760
issue that we are dealing with now

857
00:32:39,760 --> 00:32:41,600
trusting solutions without knowing how

858
00:32:41,600 --> 00:32:44,399
to break them that's another mistake for

859
00:32:44,399 --> 00:32:46,720
example we use an antivirus solution how

860
00:32:46,720 --> 00:32:48,640
do we stop it we use a monitoring

861
00:32:48,640 --> 00:32:51,360
solution how do we stop it for example

862
00:32:51,360 --> 00:32:54,240
you for like for example we use sysmon

863
00:32:54,240 --> 00:32:56,080
this one is amazing don't get me wrong

864
00:32:56,080 --> 00:32:59,120
but sysmon itself is a mini filter

865
00:32:59,120 --> 00:33:01,440
driver and if we do have sysmon like

866
00:33:01,440 --> 00:33:04,559
this we are able to actually disable it

867
00:33:04,559 --> 00:33:06,240
and the tool that we are using for that

868
00:33:06,240 --> 00:33:08,159
and let me show you this one

869
00:33:08,159 --> 00:33:12,399
uh here is actually related with the um

870
00:33:12,399 --> 00:33:14,880
unloading the minifilter driver so we go

871
00:33:14,880 --> 00:33:17,440
to the flt mc it's a building windows

872
00:33:17,440 --> 00:33:19,519
tool there is a sysmon driver yeah so

873
00:33:19,519 --> 00:33:22,159
here we go and if you go to the flgmc

874
00:33:22,159 --> 00:33:24,080
and then you've got here the possibility

875
00:33:24,080 --> 00:33:26,720
to load a filter driver or unload the

876
00:33:26,720 --> 00:33:28,559
filter driver or you can attach it

877
00:33:28,559 --> 00:33:30,320
detach it from the volume yeah so

878
00:33:30,320 --> 00:33:33,120
eventually we can do that here unload

879
00:33:33,120 --> 00:33:35,120
and then we are specifying assessment

880
00:33:35,120 --> 00:33:37,840
driver enter like not very talkative

881
00:33:37,840 --> 00:33:41,760
tool um fltmc shows you that we have no

882
00:33:41,760 --> 00:33:43,760
gnosis one anymore and this is how you

883
00:33:43,760 --> 00:33:45,279
offload this mode and system doesn't

884
00:33:45,279 --> 00:33:47,840
work anymore so if you are using sysmon

885
00:33:47,840 --> 00:33:50,559
as a feeder for cm systems which don't

886
00:33:50,559 --> 00:33:53,360
get wrong it's amazing though this it's

887
00:33:53,360 --> 00:33:54,799
hard to notice

888
00:33:54,799 --> 00:33:56,720
because if we do sc

889
00:33:56,720 --> 00:33:58,480
sc

890
00:33:58,480 --> 00:33:59,760
query

891
00:33:59,760 --> 00:34:02,000
system driver bring it on then it

892
00:34:02,000 --> 00:34:04,559
actually says it's running

893
00:34:04,559 --> 00:34:06,399
yeah so you just uploaded it from the

894
00:34:06,399 --> 00:34:09,199
field from the filtering solution but

895
00:34:09,199 --> 00:34:11,040
it's it says it's running it's not

896
00:34:11,040 --> 00:34:13,918
running anymore it's not doing anything

897
00:34:13,918 --> 00:34:16,000
so it's like a fake sense of security so

898
00:34:16,000 --> 00:34:17,599
all your bulbs that you have over there

899
00:34:17,599 --> 00:34:19,199
it's going to be green because it's

900
00:34:19,199 --> 00:34:21,359
running not really yeah

901
00:34:21,359 --> 00:34:23,359
so of course we could be like oh this is

902
00:34:23,359 --> 00:34:26,000
so bad this one is bad of course not

903
00:34:26,000 --> 00:34:27,918
what is bad over there it's having too

904
00:34:27,918 --> 00:34:30,320
many privileges and privilege that is

905
00:34:30,320 --> 00:34:32,079
needed for that it's called load and

906
00:34:32,079 --> 00:34:34,879
unload filter drivers and eventually a

907
00:34:34,879 --> 00:34:37,760
device drivers yeah and eventually that

908
00:34:37,760 --> 00:34:40,079
is assigned for the administrator so we

909
00:34:40,079 --> 00:34:41,839
could be like ah well then it's okay

910
00:34:41,839 --> 00:34:43,839
because our users are not admins then

911
00:34:43,839 --> 00:34:45,918
it's of course okay because that is what

912
00:34:45,918 --> 00:34:47,280
we want

913
00:34:47,280 --> 00:34:49,440
now whenever we are thinking about these

914
00:34:49,440 --> 00:34:51,040
trusting solutions without knowing how

915
00:34:51,040 --> 00:34:52,960
to break them there are so many aspects

916
00:34:52,960 --> 00:34:55,199
that came out to place during the

917
00:34:55,199 --> 00:34:59,119
pandemic for example solar winds

918
00:34:59,119 --> 00:35:01,520
as we know of course their code was in

919
00:35:01,520 --> 00:35:03,440
short words poisoned and it was

920
00:35:03,440 --> 00:35:05,920
distributed to many networks in this

921
00:35:05,920 --> 00:35:08,079
world now what do we do with this

922
00:35:08,079 --> 00:35:10,160
obviously it's a third party supply

923
00:35:10,160 --> 00:35:12,640
chain vendor related attack

924
00:35:12,640 --> 00:35:15,680
so is it is it really something that we

925
00:35:15,680 --> 00:35:17,839
can we can actually do about it and here

926
00:35:17,839 --> 00:35:20,480
comes the place uh for word that i'm a

927
00:35:20,480 --> 00:35:22,320
little bit ironic about that's called

928
00:35:22,320 --> 00:35:25,280
zero trust you guys know the theory

929
00:35:25,280 --> 00:35:26,240
uh

930
00:35:26,240 --> 00:35:28,640
while at the same time we have to trust

931
00:35:28,640 --> 00:35:30,400
solutions that we are using in some kind

932
00:35:30,400 --> 00:35:32,400
of a way there is no in my opinion such

933
00:35:32,400 --> 00:35:34,079
a thing like a zero trust

934
00:35:34,079 --> 00:35:37,599
so we could get into the ideology but

935
00:35:37,599 --> 00:35:40,160
you always have to trust someone and the

936
00:35:40,160 --> 00:35:42,640
point is that if you cannot control the

937
00:35:42,640 --> 00:35:43,920
software that you are running in the

938
00:35:43,920 --> 00:35:45,520
infrastructure for example solutions

939
00:35:45,520 --> 00:35:47,359
like solarwinds nothing against them but

940
00:35:47,359 --> 00:35:50,160
you know the drill then what we have to

941
00:35:50,160 --> 00:35:52,640
monitor it's an identity

942
00:35:52,640 --> 00:35:55,359
so what every attack is always related

943
00:35:55,359 --> 00:35:56,960
with an identity so what kind of

944
00:35:56,960 --> 00:35:58,480
identity

945
00:35:58,480 --> 00:36:01,680
can this thing this software leverage in

946
00:36:01,680 --> 00:36:04,400
order to attack us do we know that so if

947
00:36:04,400 --> 00:36:06,240
we do have like different services

948
00:36:06,240 --> 00:36:08,000
running different antivirus solutions

949
00:36:08,000 --> 00:36:09,680
and so on if they are stopped if they're

950
00:36:09,680 --> 00:36:12,000
overtaken like what can happen so that

951
00:36:12,000 --> 00:36:14,160
kind of a platform analysis would be

952
00:36:14,160 --> 00:36:15,839
great to do because that was going to

953
00:36:15,839 --> 00:36:18,079
give us a flavor of what's going on in

954
00:36:18,079 --> 00:36:19,920
our infrastructure what is even possible

955
00:36:19,920 --> 00:36:21,520
maybe this will never happen but who

956
00:36:21,520 --> 00:36:22,320
knows

957
00:36:22,320 --> 00:36:24,000
therefore i would like to bring one of

958
00:36:24,000 --> 00:36:25,359
them over them

959
00:36:25,359 --> 00:36:28,480
and that demo is related also with one

960
00:36:28,480 --> 00:36:30,560
of my favorite subjects to be fair

961
00:36:30,560 --> 00:36:33,920
because this subject is related with

962
00:36:33,920 --> 00:36:35,920
of course solutions that we use on

963
00:36:35,920 --> 00:36:38,079
everyday basis so let's say you use

964
00:36:38,079 --> 00:36:40,400
7-zip you use for example

965
00:36:40,400 --> 00:36:43,119
some custom apps and so on uh we've got

966
00:36:43,119 --> 00:36:46,000
a case of a log4j so different libraries

967
00:36:46,000 --> 00:36:48,800
and and so you know again the drill

968
00:36:48,800 --> 00:36:49,680
but

969
00:36:49,680 --> 00:36:52,240
a question is who is actually writing

970
00:36:52,240 --> 00:36:55,119
that code do we do a proper search about

971
00:36:55,119 --> 00:36:56,800
that sometimes it's not possible and i'm

972
00:36:56,800 --> 00:36:58,800
trying to be very reasonable here but

973
00:36:58,800 --> 00:37:00,240
what i would love to show you is just

974
00:37:00,240 --> 00:37:01,520
one thing here

975
00:37:01,520 --> 00:37:03,440
uh here we've got a user yeah that's

976
00:37:03,440 --> 00:37:05,680
just his name is freddy actually freddy

977
00:37:05,680 --> 00:37:07,520
krueger so here we go

978
00:37:07,520 --> 00:37:09,280
and if we're going to lock this guy if

979
00:37:09,280 --> 00:37:11,599
we're going to log in uh so freddy

980
00:37:11,599 --> 00:37:13,520
krueger logs in with password password

981
00:37:13,520 --> 00:37:15,040
yeah as you can see on the screen

982
00:37:15,040 --> 00:37:17,839
regular microsoft password and freddie

983
00:37:17,839 --> 00:37:19,599
itself is a domain user so nothing

984
00:37:19,599 --> 00:37:22,079
special about him besides the fact that

985
00:37:22,079 --> 00:37:24,000
he actually stores passwords in the

986
00:37:24,000 --> 00:37:25,359
google chrome

987
00:37:25,359 --> 00:37:28,079
so this is a typical user activity yeah

988
00:37:28,079 --> 00:37:30,480
so to say price users that are using the

989
00:37:30,480 --> 00:37:32,160
keepass or anything like this then

990
00:37:32,160 --> 00:37:34,480
you're very lucky but uh long story

991
00:37:34,480 --> 00:37:36,720
short it's all matter of education and

992
00:37:36,720 --> 00:37:38,720
and here we go so freddie did that he

993
00:37:38,720 --> 00:37:41,200
stored a password now

994
00:37:41,200 --> 00:37:43,520
this is chrome pass it's not chrome why

995
00:37:43,520 --> 00:37:46,000
chrompas it's accessing

996
00:37:46,000 --> 00:37:48,079
uh passwords in chrome

997
00:37:48,079 --> 00:37:50,160
because it's a rule of attempt that

998
00:37:50,160 --> 00:37:53,200
every app that you run as yourself has

999
00:37:53,200 --> 00:37:56,240
access to every other secret managed by

1000
00:37:56,240 --> 00:37:57,920
every other app

1001
00:37:57,920 --> 00:38:00,880
in other words if you run chrome pass it

1002
00:38:00,880 --> 00:38:02,720
not only can have access to the password

1003
00:38:02,720 --> 00:38:04,880
in a google chrome but to any other

1004
00:38:04,880 --> 00:38:07,680
password that you potentially store

1005
00:38:07,680 --> 00:38:09,920
this is of course the case of a dp api

1006
00:38:09,920 --> 00:38:12,880
now my team and myself we did a reverse

1007
00:38:12,880 --> 00:38:14,800
engineering of a full cryptographic

1008
00:38:14,800 --> 00:38:16,240
platform in windows

1009
00:38:16,240 --> 00:38:17,760
we are decrypting pretty much everything

1010
00:38:17,760 --> 00:38:19,359
that moves so if you guys would have any

1011
00:38:19,359 --> 00:38:21,760
deeper questions like you were totally

1012
00:38:21,760 --> 00:38:24,000
concerned about something come over

1013
00:38:24,000 --> 00:38:25,839
after the presentation i'm happy to

1014
00:38:25,839 --> 00:38:27,680
provide more details but what i would

1015
00:38:27,680 --> 00:38:30,079
love to show you today is under which

1016
00:38:30,079 --> 00:38:34,079
conditions we are able to extract these

1017
00:38:34,079 --> 00:38:37,119
users data first of all if hacker is

1018
00:38:37,119 --> 00:38:38,720
going to run phishing

1019
00:38:38,720 --> 00:38:40,720
and then the user is going to run some

1020
00:38:40,720 --> 00:38:43,040
code then of course you get access to

1021
00:38:43,040 --> 00:38:44,480
all of the user's password and there are

1022
00:38:44,480 --> 00:38:46,560
many other hacking tools for that like

1023
00:38:46,560 --> 00:38:49,200
lazan and so on yeah this is easy

1024
00:38:49,200 --> 00:38:50,640
because you run it in the context of the

1025
00:38:50,640 --> 00:38:53,359
user but when it gets difficult is to

1026
00:38:53,359 --> 00:38:54,880
ask the question

1027
00:38:54,880 --> 00:38:56,800
can for example some other person from

1028
00:38:56,800 --> 00:38:58,720
the outside of that workstation decrypt

1029
00:38:58,720 --> 00:39:00,960
this password and of course i'm not

1030
00:39:00,960 --> 00:39:02,880
going to spoil it let's see but

1031
00:39:02,880 --> 00:39:05,599
obviously i bring only bad news today so

1032
00:39:05,599 --> 00:39:08,000
you can probably say yes already um

1033
00:39:08,000 --> 00:39:10,079
anyway let's move forward

1034
00:39:10,079 --> 00:39:11,440
what we're gonna do

1035
00:39:11,440 --> 00:39:12,880
i would love to show you this one in the

1036
00:39:12,880 --> 00:39:15,040
scenario yeah so

1037
00:39:15,040 --> 00:39:16,720
one thing and this is a little bit of a

1038
00:39:16,720 --> 00:39:18,480
theory that i have to mention

1039
00:39:18,480 --> 00:39:21,040
is that user

1040
00:39:21,040 --> 00:39:24,560
user secret are truly dependent

1041
00:39:24,560 --> 00:39:27,440
on the user's passwords hash

1042
00:39:27,440 --> 00:39:30,000
so for the domain users particularly our

1043
00:39:30,000 --> 00:39:33,280
secrets are dependent on md4 of the

1044
00:39:33,280 --> 00:39:35,119
user's password and for the local users

1045
00:39:35,119 --> 00:39:37,440
it's actually schwa1 yeah so that

1046
00:39:37,440 --> 00:39:39,200
people don't get the md4 from the sound

1047
00:39:39,200 --> 00:39:41,280
database yeah so it's very logical but

1048
00:39:41,280 --> 00:39:44,480
for the domain users it's md4 now

1049
00:39:44,480 --> 00:39:46,400
this is the rule of the dump that

1050
00:39:46,400 --> 00:39:49,359
eventually there is another entity that

1051
00:39:49,359 --> 00:39:51,440
is able to get access to our passwords

1052
00:39:51,440 --> 00:39:53,440
but first let me break this scenario to

1053
00:39:53,440 --> 00:39:55,119
show you that when i change the password

1054
00:39:55,119 --> 00:39:57,359
of the user in an illegal way

1055
00:39:57,359 --> 00:39:59,119
user will not be able to get access to

1056
00:39:59,119 --> 00:40:01,280
the secret which proves the point that

1057
00:40:01,280 --> 00:40:04,240
the secrets are dependent on md4 so

1058
00:40:04,240 --> 00:40:05,359
let's begin

1059
00:40:05,359 --> 00:40:06,720
i'm going to do it by the way just to

1060
00:40:06,720 --> 00:40:09,359
explain myself offline

1061
00:40:09,359 --> 00:40:10,720
but of course we could say well

1062
00:40:10,720 --> 00:40:13,040
bitlocker will prevent i totally know

1063
00:40:13,040 --> 00:40:14,079
and agree

1064
00:40:14,079 --> 00:40:16,720
but you can also do it online the reason

1065
00:40:16,720 --> 00:40:18,480
why i would do it offline because it's

1066
00:40:18,480 --> 00:40:20,560
more linear in a demo so it's a little

1067
00:40:20,560 --> 00:40:22,960
bit easier to explain what is happening

1068
00:40:22,960 --> 00:40:25,200
step by step so let's dig in so we're

1069
00:40:25,200 --> 00:40:27,760
gonna do next repair your computer

1070
00:40:27,760 --> 00:40:29,920
and then we're gonna do troubleshoot

1071
00:40:29,920 --> 00:40:32,720
advanced options command prompt and here

1072
00:40:32,720 --> 00:40:35,680
we're gonna just increase the font so

1073
00:40:35,680 --> 00:40:38,400
let's do it and of course

1074
00:40:38,400 --> 00:40:40,640
we're going to get into the tools so

1075
00:40:40,640 --> 00:40:43,440
let's go to the dcq tools and in this

1076
00:40:43,440 --> 00:40:45,040
case we're going to go to that known by

1077
00:40:45,040 --> 00:40:48,160
you mimics secure edition but this is

1078
00:40:48,160 --> 00:40:51,680
basically our module to extract the

1079
00:40:51,680 --> 00:40:54,720
cache logon data so let's say dump

1080
00:40:54,720 --> 00:40:57,119
and we're going to do here

1081
00:40:57,119 --> 00:40:58,160
cache

1082
00:40:58,160 --> 00:41:00,079
and then we're going to go into windows

1083
00:41:00,079 --> 00:41:01,040
i have to

1084
00:41:01,040 --> 00:41:04,880
write the path so system32 config and

1085
00:41:04,880 --> 00:41:07,280
system and then d

1086
00:41:07,280 --> 00:41:08,480
windows

1087
00:41:08,480 --> 00:41:09,960
windows

1088
00:41:09,960 --> 00:41:11,520
system32

1089
00:41:11,520 --> 00:41:13,200
config

1090
00:41:13,200 --> 00:41:14,000
and

1091
00:41:14,000 --> 00:41:17,119
security here we go

1092
00:41:17,119 --> 00:41:18,640
why this through

1093
00:41:18,640 --> 00:41:20,560
because um

1094
00:41:20,560 --> 00:41:23,520
system contains the boot key that

1095
00:41:23,520 --> 00:41:26,240
encrypts the crypt's cash logon data

1096
00:41:26,240 --> 00:41:28,319
that are in security some people call it

1097
00:41:28,319 --> 00:41:30,960
cash credentials don't do that

1098
00:41:30,960 --> 00:41:32,880
please if these are not credentials they

1099
00:41:32,880 --> 00:41:34,480
have nothing to do with being

1100
00:41:34,480 --> 00:41:36,079
credentials you cannot look gone with

1101
00:41:36,079 --> 00:41:38,560
this you can only compare with it these

1102
00:41:38,560 --> 00:41:39,920
are not credentials

1103
00:41:39,920 --> 00:41:42,319
but that's just a like language thing

1104
00:41:42,319 --> 00:41:43,760
yeah and of course i'm going to prove it

1105
00:41:43,760 --> 00:41:46,400
to you in a moment but we have already

1106
00:41:46,400 --> 00:41:49,440
overwritten cash log on data

1107
00:41:49,440 --> 00:41:51,839
so that we can log on with the

1108
00:41:51,839 --> 00:41:54,240
empty with the different password to the

1109
00:41:54,240 --> 00:41:55,920
freddy krueger's account

1110
00:41:55,920 --> 00:41:58,160
but of course in order to do it i have

1111
00:41:58,160 --> 00:42:01,280
to just simply

1112
00:42:01,280 --> 00:42:02,640
disconnect this computer from the

1113
00:42:02,640 --> 00:42:05,040
network and using this opportunity let

1114
00:42:05,040 --> 00:42:07,680
me explain what the cache logon data is

1115
00:42:07,680 --> 00:42:09,760
so cache logon data stored in registry

1116
00:42:09,760 --> 00:42:13,359
in security hive this is called ms

1117
00:42:13,359 --> 00:42:15,200
dcc2

1118
00:42:15,200 --> 00:42:17,599
and msdcc2 it's a result of a function

1119
00:42:17,599 --> 00:42:18,880
pbk

1120
00:42:18,880 --> 00:42:22,640
df2 used by azure keyword by keypass

1121
00:42:22,640 --> 00:42:24,240
lastpass and so on it's like industry

1122
00:42:24,240 --> 00:42:26,319
standard and over there we've got

1123
00:42:26,319 --> 00:42:28,480
username as one of the parameters we've

1124
00:42:28,480 --> 00:42:31,839
got a dcc one which i will explain

1125
00:42:31,839 --> 00:42:34,960
and then we've got as well hmac

1126
00:42:34,960 --> 00:42:40,319
schwa 1 10 240 iterations on 16 blocks

1127
00:42:40,319 --> 00:42:42,880
so it's a pretty cool value taking into

1128
00:42:42,880 --> 00:42:46,240
consideration ms the dcc one which is

1129
00:42:46,240 --> 00:42:48,319
nothing but the md4

1130
00:42:48,319 --> 00:42:50,400
on the top of the username

1131
00:42:50,400 --> 00:42:52,079
and joined

1132
00:42:52,079 --> 00:42:55,200
on on the joint with the md4 on the top

1133
00:42:55,200 --> 00:42:56,960
of the user's password

1134
00:42:56,960 --> 00:42:59,920
so so mdcc1 by the way was actually used

1135
00:42:59,920 --> 00:43:02,560
in windows xp including and in windows

1136
00:43:02,560 --> 00:43:04,240
vista from now on we are using the

1137
00:43:04,240 --> 00:43:07,839
msdcc2 it's okay to store cache logon

1138
00:43:07,839 --> 00:43:09,839
data credentials not really credentials

1139
00:43:09,839 --> 00:43:11,680
yeah so you can see that with this value

1140
00:43:11,680 --> 00:43:13,920
we are not able to submit it and log in

1141
00:43:13,920 --> 00:43:16,880
there is no like pastic plastic cache

1142
00:43:16,880 --> 00:43:18,800
credentials attack there is no such a

1143
00:43:18,800 --> 00:43:20,560
thing because nobody would say yes to

1144
00:43:20,560 --> 00:43:21,359
this

1145
00:43:21,359 --> 00:43:24,880
also very romantic so anyway uh let's go

1146
00:43:24,880 --> 00:43:29,119
to uh dom safe and freddie so here we go

1147
00:43:29,119 --> 00:43:30,880
let's verify what we got so freddy

1148
00:43:30,880 --> 00:43:33,920
krueger password password enter doesn't

1149
00:43:33,920 --> 00:43:34,800
work

1150
00:43:34,800 --> 00:43:37,200
so maybe something else so one that we

1151
00:43:37,200 --> 00:43:38,960
are comparing with the registry in this

1152
00:43:38,960 --> 00:43:42,240
case it's going to be mimikat why not

1153
00:43:42,240 --> 00:43:43,599
so we log in

1154
00:43:43,599 --> 00:43:45,680
and as you will see

1155
00:43:45,680 --> 00:43:48,000
let's go to the secutors and over there

1156
00:43:48,000 --> 00:43:49,920
in the chrome bus you guys will see that

1157
00:43:49,920 --> 00:43:51,680
chromeboss itself

1158
00:43:51,680 --> 00:43:54,000
really works hard on getting access that

1159
00:43:54,000 --> 00:43:56,319
secret and that doesn't work

1160
00:43:56,319 --> 00:43:58,720
okay why it doesn't work because my

1161
00:43:58,720 --> 00:44:00,960
current passwords hash on the top of the

1162
00:44:00,960 --> 00:44:04,319
mimikat so md4 is not capable to decrypt

1163
00:44:04,319 --> 00:44:07,280
that as we call it using master keys

1164
00:44:07,280 --> 00:44:09,680
that are in the user's profile so here

1165
00:44:09,680 --> 00:44:12,240
we go let me get in to the user's

1166
00:44:12,240 --> 00:44:14,640
profile then percent update the percent

1167
00:44:14,640 --> 00:44:16,800
where the master keys thread the update

1168
00:44:16,800 --> 00:44:20,720
are roaming microsoft protect sid quite

1169
00:44:20,720 --> 00:44:22,800
a long path and then these are these

1170
00:44:22,800 --> 00:44:25,520
guys these files we call the master key

1171
00:44:25,520 --> 00:44:26,720
containers

1172
00:44:26,720 --> 00:44:29,760
here we go and all of these they contain

1173
00:44:29,760 --> 00:44:32,400
two keys the same ones they are like the

1174
00:44:32,400 --> 00:44:35,280
same one is encrypted with our passwords

1175
00:44:35,280 --> 00:44:38,240
hash so md4 but another one

1176
00:44:38,240 --> 00:44:40,640
question mark it's encrypted with what

1177
00:44:40,640 --> 00:44:43,359
actually i'll show you

1178
00:44:43,359 --> 00:44:45,839
with this key here bk

1179
00:44:45,839 --> 00:44:46,960
backup

1180
00:44:46,960 --> 00:44:48,880
it's called bk secure because of the

1181
00:44:48,880 --> 00:44:50,880
secure domain but it's back up your

1182
00:44:50,880 --> 00:44:52,960
domain name this is the public key of

1183
00:44:52,960 --> 00:44:55,359
the domain what if i told you that this

1184
00:44:55,359 --> 00:44:57,680
is just one key for every single user

1185
00:44:57,680 --> 00:44:59,440
for every single secret in the whole

1186
00:44:59,440 --> 00:45:00,960
domain

1187
00:45:00,960 --> 00:45:02,319
that's how it is

1188
00:45:02,319 --> 00:45:05,280
so here we go let's extract it from the

1189
00:45:05,280 --> 00:45:07,920
domain controller in order to learn

1190
00:45:07,920 --> 00:45:10,640
what kind of threats we are in while of

1191
00:45:10,640 --> 00:45:13,680
course our domain is potentially

1192
00:45:13,680 --> 00:45:15,280
compromised yeah

1193
00:45:15,280 --> 00:45:16,319
here we go

1194
00:45:16,319 --> 00:45:17,680
it's not my dog by the way if you

1195
00:45:17,680 --> 00:45:20,640
wondered i wish i would be really cute

1196
00:45:20,640 --> 00:45:22,400
okay so here we go

1197
00:45:22,400 --> 00:45:23,280
um

1198
00:45:23,280 --> 00:45:25,280
so what we're gonna do here this is the

1199
00:45:25,280 --> 00:45:27,760
domain controller now

1200
00:45:27,760 --> 00:45:29,359
let's go to tools

1201
00:45:29,359 --> 00:45:31,119
and over there

1202
00:45:31,119 --> 00:45:34,640
we've got the cq our tools so cql's

1203
00:45:34,640 --> 00:45:36,960
secrets number this is one of our tools

1204
00:45:36,960 --> 00:45:40,800
file exported pfx so if our data is

1205
00:45:40,800 --> 00:45:43,040
encrypted with the public key we have to

1206
00:45:43,040 --> 00:45:45,680
decrypt it with the private key and that

1207
00:45:45,680 --> 00:45:47,520
private key we store on the domain

1208
00:45:47,520 --> 00:45:49,280
controller you cannot get it in the

1209
00:45:49,280 --> 00:45:51,280
certificate manager or whatever it's

1210
00:45:51,280 --> 00:45:53,760
actually maintained as a simple blob of

1211
00:45:53,760 --> 00:45:56,480
data like blob like this in the entities

1212
00:45:56,480 --> 00:45:57,680
that did

1213
00:45:57,680 --> 00:45:59,520
and it's really like hard to identify

1214
00:45:59,520 --> 00:46:01,040
it's just like a piece of text that

1215
00:46:01,040 --> 00:46:03,520
appears to be a pfx

1216
00:46:03,520 --> 00:46:04,880
so

1217
00:46:04,880 --> 00:46:07,440
next part is that we have to import it

1218
00:46:07,440 --> 00:46:09,839
so let's just do next next literally a

1219
00:46:09,839 --> 00:46:12,240
password secure next next next and

1220
00:46:12,240 --> 00:46:13,280
that's it

1221
00:46:13,280 --> 00:46:16,560
and let's go to the assert mgr msc to

1222
00:46:16,560 --> 00:46:19,200
learn like what is it and here we are

1223
00:46:19,200 --> 00:46:21,599
learning that that certificate

1224
00:46:21,599 --> 00:46:25,119
is actually issued to nobody and issued

1225
00:46:25,119 --> 00:46:28,640
by nobody it's like a ghost now hey it

1226
00:46:28,640 --> 00:46:32,640
expired it was created in 2012

1227
00:46:32,640 --> 00:46:34,960
and it expires after one year so i bet

1228
00:46:34,960 --> 00:46:37,119
you might be wondering now like okay but

1229
00:46:37,119 --> 00:46:39,440
can we renew it no

1230
00:46:39,440 --> 00:46:41,839
you might be wondering okay what if we

1231
00:46:41,839 --> 00:46:43,680
like rise a functional level of the

1232
00:46:43,680 --> 00:46:46,240
domain no so let me simplify that for

1233
00:46:46,240 --> 00:46:47,920
you a little bit whatever the question

1234
00:46:47,920 --> 00:46:50,720
you ask answer is no

1235
00:46:50,720 --> 00:46:53,359
can i fix it no including this one

1236
00:46:53,359 --> 00:46:54,880
so there's nothing you can do now think

1237
00:46:54,880 --> 00:46:56,560
about it if it leaks

1238
00:46:56,560 --> 00:46:58,640
you have a really big issue because

1239
00:46:58,640 --> 00:47:01,440
while you can reset that kirby tgt

1240
00:47:01,440 --> 00:47:04,560
password password twice whatever you can

1241
00:47:04,560 --> 00:47:06,880
like do the kds root keys reset like all

1242
00:47:06,880 --> 00:47:08,400
this stuff while you can do this after

1243
00:47:08,400 --> 00:47:10,400
domain is under attack this one you

1244
00:47:10,400 --> 00:47:12,400
cannot fix

1245
00:47:12,400 --> 00:47:14,160
it's not a good news you know

1246
00:47:14,160 --> 00:47:16,720
so long story short um

1247
00:47:16,720 --> 00:47:18,480
what about admins that were there they

1248
00:47:18,480 --> 00:47:19,920
are no longer there

1249
00:47:19,920 --> 00:47:21,839
totally i always like to think about the

1250
00:47:21,839 --> 00:47:24,079
domain as if it is already compromised

1251
00:47:24,079 --> 00:47:26,240
your privacy is already compromised

1252
00:47:26,240 --> 00:47:28,240
because we were living in times where we

1253
00:47:28,240 --> 00:47:29,520
were not having privileged access

1254
00:47:29,520 --> 00:47:32,640
management domain admins were humans

1255
00:47:32,640 --> 00:47:34,400
and they were accessing this so let's

1256
00:47:34,400 --> 00:47:37,680
use this and now we uh we got it

1257
00:47:37,680 --> 00:47:39,920
so we use it in a very simple way while

1258
00:47:39,920 --> 00:47:42,240
we are in freddie's computer

1259
00:47:42,240 --> 00:47:44,319
uh let's just get in

1260
00:47:44,319 --> 00:47:46,319
to the tools we're gonna over there

1261
00:47:46,319 --> 00:47:49,760
within the dp api generate cq

1262
00:47:49,760 --> 00:47:52,160
calc for the mimi mimikats

1263
00:47:52,160 --> 00:47:55,119
one so in order to re-encrypt our

1264
00:47:55,119 --> 00:47:57,599
secrets with this password hash so the

1265
00:47:57,599 --> 00:48:01,119
next part is to use the cq

1266
00:48:01,119 --> 00:48:04,800
dp api blob searcher in order to go to

1267
00:48:04,800 --> 00:48:07,359
the directory it's a very nice tool to

1268
00:48:07,359 --> 00:48:09,599
search for the secrets in general so i

1269
00:48:09,599 --> 00:48:12,800
use it for forensic in my normal job

1270
00:48:12,800 --> 00:48:16,480
and so we've got a local google chrome

1271
00:48:16,480 --> 00:48:19,599
and then recursive search output to c cq

1272
00:48:19,599 --> 00:48:22,319
tools and let's be nice tp api txt

1273
00:48:22,319 --> 00:48:23,359
because there's going to be a lot of

1274
00:48:23,359 --> 00:48:26,079
text so that takes like maybe 10 seconds

1275
00:48:26,079 --> 00:48:27,760
up to 20 seconds

1276
00:48:27,760 --> 00:48:30,480
and then dp api txt we're learning and

1277
00:48:30,480 --> 00:48:32,160
that's interesting that within the

1278
00:48:32,160 --> 00:48:35,280
google chrome google chrome stores

1279
00:48:35,280 --> 00:48:38,160
actually secrets that is protecting them

1280
00:48:38,160 --> 00:48:40,640
by using schwa and triple des not that

1281
00:48:40,640 --> 00:48:41,920
cool right

1282
00:48:41,920 --> 00:48:44,319
but anyway uh this is the master key

1283
00:48:44,319 --> 00:48:46,079
name that's used for the google chrome

1284
00:48:46,079 --> 00:48:50,160
okay so let's go there b55 that's this

1285
00:48:50,160 --> 00:48:52,400
guy here shift right click

1286
00:48:52,400 --> 00:48:54,800
copy as path and then we are super ready

1287
00:48:54,800 --> 00:48:58,000
to build up the command so cq master key

1288
00:48:58,000 --> 00:48:59,280
id

1289
00:48:59,280 --> 00:49:01,760
file we are decrypting this guy with the

1290
00:49:01,760 --> 00:49:04,960
pfx from the domain with the private key

1291
00:49:04,960 --> 00:49:08,160
a new hash encrypting it back again by

1292
00:49:08,160 --> 00:49:10,720
using our current password hash

1293
00:49:10,720 --> 00:49:13,920
boom enter okay that's done the only

1294
00:49:13,920 --> 00:49:16,240
thing we have to do now is to rename

1295
00:49:16,240 --> 00:49:19,440
this guy so let's do it rename it to

1296
00:49:19,440 --> 00:49:20,800
whatever

1297
00:49:20,800 --> 00:49:24,079
and uh we've got 80 modified

1298
00:49:24,079 --> 00:49:27,119
then basically i'm just replacing

1299
00:49:27,119 --> 00:49:29,440
okay and then one more thing

1300
00:49:29,440 --> 00:49:31,760
is an ad trip and we have to set it an

1301
00:49:31,760 --> 00:49:34,559
attribute of a system and hidden done

1302
00:49:34,559 --> 00:49:37,200
so here basically if it doesn't work i

1303
00:49:37,200 --> 00:49:39,200
can go and sell coconuts let's check on

1304
00:49:39,200 --> 00:49:41,680
this oh it works yeah

1305
00:49:41,680 --> 00:49:44,079
so what happened is we managed to get

1306
00:49:44,079 --> 00:49:46,880
access to the password of a user

1307
00:49:46,880 --> 00:49:48,400
just because of the pfx that we

1308
00:49:48,400 --> 00:49:50,960
extracted from the domain now this

1309
00:49:50,960 --> 00:49:52,720
certificate you can use against every

1310
00:49:52,720 --> 00:49:54,640
user and against any secret in the

1311
00:49:54,640 --> 00:49:57,440
domain so what we have to do and i

1312
00:49:57,440 --> 00:49:59,040
consider that one as a quite a big

1313
00:49:59,040 --> 00:50:00,240
mistake

1314
00:50:00,240 --> 00:50:03,280
is to set up a really nice

1315
00:50:03,280 --> 00:50:05,359
setup for the privileged access

1316
00:50:05,359 --> 00:50:07,520
management make sure that we are not

1317
00:50:07,520 --> 00:50:09,440
using the tools that we don't know

1318
00:50:09,440 --> 00:50:11,200
obviously where they come from obvious

1319
00:50:11,200 --> 00:50:14,000
advice but still in infrastructure just

1320
00:50:14,000 --> 00:50:16,160
pay better attention to this and at the

1321
00:50:16,160 --> 00:50:18,400
same time giving contractors too much

1322
00:50:18,400 --> 00:50:20,960
access is one of the huge mistakes and

1323
00:50:20,960 --> 00:50:23,040
privilege access management not in place

1324
00:50:23,040 --> 00:50:25,520
it's also a mistake because

1325
00:50:25,520 --> 00:50:28,480
these vendors they become domain admins

1326
00:50:28,480 --> 00:50:30,880
they usually get that or hiring pen

1327
00:50:30,880 --> 00:50:33,359
testers that we don't trust

1328
00:50:33,359 --> 00:50:35,359
again zero trust is a thing i don't

1329
00:50:35,359 --> 00:50:37,200
think so because they are testing our

1330
00:50:37,200 --> 00:50:39,440
infrastructure and they are eventually

1331
00:50:39,440 --> 00:50:41,200
having a domain admin as a goal they

1332
00:50:41,200 --> 00:50:43,920
want to do it so do you allow people in

1333
00:50:43,920 --> 00:50:46,960
your infrastructure to be like getting

1334
00:50:46,960 --> 00:50:48,880
domain admin in terms of what we just

1335
00:50:48,880 --> 00:50:50,160
said

1336
00:50:50,160 --> 00:50:52,720
it's kind of painful so therefore all

1337
00:50:52,720 --> 00:50:54,480
the actions at least supposed to be

1338
00:50:54,480 --> 00:50:56,720
monitored so that you know what happened

1339
00:50:56,720 --> 00:51:00,319
and you can assess the risk properly so

1340
00:51:00,319 --> 00:51:01,920
eventually when we were talking about

1341
00:51:01,920 --> 00:51:04,240
these 10 mistakes we talked about

1342
00:51:04,240 --> 00:51:06,559
misconfigured endpoint and the network

1343
00:51:06,559 --> 00:51:09,119
settings on the endpoint we talked about

1344
00:51:09,119 --> 00:51:11,520
mfa's concepts so we are trusting it too

1345
00:51:11,520 --> 00:51:13,119
much so we need to understand the

1346
00:51:13,119 --> 00:51:15,280
background that it can be also bypassed

1347
00:51:15,280 --> 00:51:17,040
if we have access to the authorization

1348
00:51:17,040 --> 00:51:20,079
cookie we played with um that lack of

1349
00:51:20,079 --> 00:51:22,720
the smb signing so the smb rely all

1350
00:51:22,720 --> 00:51:24,000
together of course with network

1351
00:51:24,000 --> 00:51:26,079
segmentation that allowed us to see more

1352
00:51:26,079 --> 00:51:28,000
in the network we played with no white

1353
00:51:28,000 --> 00:51:30,400
listing on board saying that of course

1354
00:51:30,400 --> 00:51:33,040
in case of also allowing usual unusual

1355
00:51:33,040 --> 00:51:35,280
code execution we've got attack services

1356
00:51:35,280 --> 00:51:37,040
reduction rules which we can simply

1357
00:51:37,040 --> 00:51:39,280
implement to address different scenarios

1358
00:51:39,280 --> 00:51:42,000
old protocols with an example of a

1359
00:51:42,000 --> 00:51:45,119
tabular data stream also playing with

1360
00:51:45,119 --> 00:51:47,119
solutions without really knowing how to

1361
00:51:47,119 --> 00:51:49,599
break them it's just another aspect and

1362
00:51:49,599 --> 00:51:50,559
also

1363
00:51:50,559 --> 00:51:52,559
falling for evil tools that are simply

1364
00:51:52,559 --> 00:51:55,680
allowing in context of users or in

1365
00:51:55,680 --> 00:51:56,960
context of

1366
00:51:56,960 --> 00:51:59,520
vendors in this case access a little bit

1367
00:51:59,520 --> 00:52:02,480
too much if it's about our safety within

1368
00:52:02,480 --> 00:52:04,720
the infrastructure of course i give you

1369
00:52:04,720 --> 00:52:08,640
the qr code but don't forget to

1370
00:52:17,119 --> 00:52:19,760
around downl do it we do it for for

1371
00:52:19,760 --> 00:52:21,760
education of course make sure that you

1372
00:52:21,760 --> 00:52:24,000
guys gonna check out also our blog where

1373
00:52:24,000 --> 00:52:26,480
we describe what is happening in hawking

1374
00:52:26,480 --> 00:52:29,040
paris and of course as always thank you

1375
00:52:29,040 --> 00:52:31,760
so much for attending hopefully it was

1376
00:52:31,760 --> 00:52:33,440
worth your time and it was an

1377
00:52:33,440 --> 00:52:37,640
interesting session thanks a lot

1378
00:52:43,860 --> 00:52:47,159
[Applause]

1379
00:52:49,839 --> 00:52:53,640
do you guys have some questions

1380
00:53:01,280 --> 00:53:03,760
here we go

1381
00:53:04,000 --> 00:53:06,480
something comes to your mind or maybe i

1382
00:53:06,480 --> 00:53:09,920
should explain something more

1383
00:53:12,319 --> 00:53:14,720
all cool it's all clear

1384
00:53:14,720 --> 00:53:17,359
okay awesome did you enjoy it

1385
00:53:17,359 --> 00:53:19,599
okay awesome that's good

1386
00:53:19,599 --> 00:53:21,119
thank you

1387
00:53:21,119 --> 00:53:23,839
i saw a hand go up

1388
00:53:23,839 --> 00:53:26,720
question question yeah

1389
00:53:26,720 --> 00:53:29,720
um

1390
00:53:33,839 --> 00:53:36,720
yeah uh i have a small question uh how

1391
00:53:36,720 --> 00:53:39,280
did you extract the

1392
00:53:39,280 --> 00:53:42,800
the the key from the the domain control

1393
00:53:42,800 --> 00:53:45,680
got it the domain controller right right

1394
00:53:45,680 --> 00:53:47,440
uh so how did we

1395
00:53:47,440 --> 00:53:49,440
did it uh we did this this took us

1396
00:53:49,440 --> 00:53:51,040
actually over two years we are doing the

1397
00:53:51,040 --> 00:53:52,720
reverse engineering of in general the

1398
00:53:52,720 --> 00:53:54,720
cryptographic platform of windows and

1399
00:53:54,720 --> 00:53:56,800
we're wondering what is this beak i

1400
00:53:56,800 --> 00:53:58,880
think yeah and this is how we got to the

1401
00:53:58,880 --> 00:54:01,839
point that there is actually a value in

1402
00:54:01,839 --> 00:54:04,000
the ntds.did

1403
00:54:04,000 --> 00:54:06,800
that is um that looks in a kind of a

1404
00:54:06,800 --> 00:54:08,400
characteristic way

1405
00:54:08,400 --> 00:54:10,400
well to us later yeah now like when we

1406
00:54:10,400 --> 00:54:11,680
just look at it it's just a piece of

1407
00:54:11,680 --> 00:54:12,800
text yeah

1408
00:54:12,800 --> 00:54:15,200
and we learned that that is a pfx so

1409
00:54:15,200 --> 00:54:17,280
it's just a matter of trying being

1410
00:54:17,280 --> 00:54:20,000
mistaken trying being mistaken and so on

1411
00:54:20,000 --> 00:54:21,599
so that's that that's the setup if you

1412
00:54:21,599 --> 00:54:24,880
are particularly interested um like what

1413
00:54:24,880 --> 00:54:26,640
is it and so on

1414
00:54:26,640 --> 00:54:30,160
uh i got actually uh of course like way

1415
00:54:30,160 --> 00:54:32,000
way detailed uh information about the

1416
00:54:32,000 --> 00:54:34,720
particular extraction actually of that

1417
00:54:34,720 --> 00:54:38,720
uh so um that it's actually from the

1418
00:54:38,720 --> 00:54:41,760
presentation i was here we go doing all

1419
00:54:41,760 --> 00:54:44,640
together with uh mike so if you don't

1420
00:54:44,640 --> 00:54:46,640
mind uh switching to my screen that

1421
00:54:46,640 --> 00:54:47,920
would be great i'll show you for the

1422
00:54:47,920 --> 00:54:48,880
moment

1423
00:54:48,880 --> 00:54:51,839
uh so uh this is basically uh here we go

1424
00:54:51,839 --> 00:54:53,920
this this is how that value look like so

1425
00:54:53,920 --> 00:54:56,880
we look into uh through the hex editor

1426
00:54:56,880 --> 00:54:57,599
uh

1427
00:54:57,599 --> 00:54:59,920
on ntds that did and we were looking for

1428
00:54:59,920 --> 00:55:01,920
some patterns we're trying to identify

1429
00:55:01,920 --> 00:55:04,559
every single section that's there and on

1430
00:55:04,559 --> 00:55:05,839
left side maybe it's not very

1431
00:55:05,839 --> 00:55:07,680
interesting but right side and we

1432
00:55:07,680 --> 00:55:09,119
actually found

1433
00:55:09,119 --> 00:55:11,200
a 256

1434
00:55:11,200 --> 00:55:12,480
uh by

1435
00:55:12,480 --> 00:55:14,480
length secret and we're like okay maybe

1436
00:55:14,480 --> 00:55:17,440
this is like an rsa or something yeah so

1437
00:55:17,440 --> 00:55:19,440
we started to interpret it and then it

1438
00:55:19,440 --> 00:55:20,720
appeared to be

1439
00:55:20,720 --> 00:55:23,520
that pfx

1440
00:55:29,839 --> 00:55:32,160
so this i've only got the first part and

1441
00:55:32,160 --> 00:55:34,240
so if you could just say the second part

1442
00:55:34,240 --> 00:55:36,160
so in the sense like in order to

1443
00:55:36,160 --> 00:55:38,799
generate the pfx file you have to

1444
00:55:38,799 --> 00:55:40,480
already compromise the domain or can you

1445
00:55:40,480 --> 00:55:42,640
do it remotely or how can you ah good

1446
00:55:42,640 --> 00:55:44,559
question can you do it remotely yes you

1447
00:55:44,559 --> 00:55:47,040
can actually do it remotely so it's like

1448
00:55:47,040 --> 00:55:49,359
you guys know the dc sync attack

1449
00:55:49,359 --> 00:55:51,200
some of you right so dc sync attack is

1450
00:55:51,200 --> 00:55:53,200
basically based on

1451
00:55:53,200 --> 00:55:55,040
and let me uh show you a quick thing

1452
00:55:55,040 --> 00:55:57,359
here uh based on the permissions that we

1453
00:55:57,359 --> 00:55:59,359
got within the domain and just to be

1454
00:55:59,359 --> 00:56:01,920
completely not romantic yeah it thinks

1455
00:56:01,920 --> 00:56:03,359
they have to have a reason they have to

1456
00:56:03,359 --> 00:56:05,680
happen so um either you need to be a

1457
00:56:05,680 --> 00:56:07,760
dominant man or local admin on the main

1458
00:56:07,760 --> 00:56:09,520
controller or

1459
00:56:09,520 --> 00:56:10,880
you don't have to be malicious you can

1460
00:56:10,880 --> 00:56:14,000
be working in this company yeah but if

1461
00:56:14,000 --> 00:56:15,839
you want to do it remotely

1462
00:56:15,839 --> 00:56:18,160
the minimum you need to have

1463
00:56:18,160 --> 00:56:21,520
is these particular permissions on the

1464
00:56:21,520 --> 00:56:23,440
top of the domain the replicating

1465
00:56:23,440 --> 00:56:26,240
directory changes let me enlarge it and

1466
00:56:26,240 --> 00:56:29,040
not or and replicating directory changes

1467
00:56:29,040 --> 00:56:32,319
all and at all it's a mistake by the way

1468
00:56:32,319 --> 00:56:34,480
yet another one that was made by

1469
00:56:34,480 --> 00:56:35,760
administrator while they were

1470
00:56:35,760 --> 00:56:38,160
implementing sharepoint because in the

1471
00:56:38,160 --> 00:56:40,160
microsoft documentation in the past

1472
00:56:40,160 --> 00:56:42,000
there was a little mistake saying that

1473
00:56:42,000 --> 00:56:44,559
if you want to set up a user account for

1474
00:56:44,559 --> 00:56:46,640
profile replication this profile

1475
00:56:46,640 --> 00:56:48,240
replication account has to have these

1476
00:56:48,240 --> 00:56:50,559
two check boxes but that's mistake the

1477
00:56:50,559 --> 00:56:52,640
last checkbox is super dangerous because

1478
00:56:52,640 --> 00:56:55,200
you are pulling out the whole ntds.did

1479
00:56:55,200 --> 00:56:57,599
so doing it remotely absolutely possible

1480
00:56:57,599 --> 00:56:59,520
if you got these two check boxes on your

1481
00:56:59,520 --> 00:57:01,520
account

1482
00:57:01,520 --> 00:57:03,280
thank you ah you got a question yes so

1483
00:57:03,280 --> 00:57:05,200
it's over here

1484
00:57:05,200 --> 00:57:07,520
thank you

1485
00:57:08,880 --> 00:57:11,440
so this is also quite an interesting um

1486
00:57:11,440 --> 00:57:14,079
yeah perspective on the domain and uh as

1487
00:57:14,079 --> 00:57:15,440
i mentioned this is something that you

1488
00:57:15,440 --> 00:57:17,839
simply cannot fix

1489
00:57:17,839 --> 00:57:19,760
thank you great presentation just wanted

1490
00:57:19,760 --> 00:57:21,839
to let you know that

1491
00:57:21,839 --> 00:57:23,200
many of the things that you showed

1492
00:57:23,200 --> 00:57:25,119
including remotely extracting private

1493
00:57:25,119 --> 00:57:27,920
key is shown in the workshop later on

1494
00:57:27,920 --> 00:57:30,079
in about an hour where i open sourced

1495
00:57:30,079 --> 00:57:32,160
many of these things so extracting

1496
00:57:32,160 --> 00:57:34,799
private key pvk file to extract local

1497
00:57:34,799 --> 00:57:37,359
passwords on domain members

1498
00:57:37,359 --> 00:57:41,440
also on dba pa g stuff and so on api and

1499
00:57:41,440 --> 00:57:43,200
g absolutely so that's another part that

1500
00:57:43,200 --> 00:57:45,760
we worked in yes yes yes but for the api

1501
00:57:45,760 --> 00:57:47,599
and even though the name is similar it's

1502
00:57:47,599 --> 00:57:49,680
completely different right true true yes

1503
00:57:49,680 --> 00:57:51,599
it's an evolution

1504
00:57:51,599 --> 00:57:52,480
awesome

1505
00:57:52,480 --> 00:57:55,839
thank you thank you thank you

1506
00:57:56,880 --> 00:57:58,799
dp api ng is just a little comment of

1507
00:57:58,799 --> 00:58:01,760
course it relies on the kds root key

1508
00:58:01,760 --> 00:58:04,400
that is within the within the domain and

1509
00:58:04,400 --> 00:58:07,680
you can extract it in ntds.did as well

1510
00:58:07,680 --> 00:58:08,400
so

1511
00:58:08,400 --> 00:58:09,680
this is also what you find in the

1512
00:58:09,680 --> 00:58:12,160
properties of the domain and in the

1513
00:58:12,160 --> 00:58:14,240
larger infrastructure like several

1514
00:58:14,240 --> 00:58:16,960
thousand computers you've got like uh

1515
00:58:16,960 --> 00:58:19,359
three or four of these keys and they are

1516
00:58:19,359 --> 00:58:21,680
not rolling over so if there's an attack

1517
00:58:21,680 --> 00:58:22,960
this is one of the things that you have

1518
00:58:22,960 --> 00:58:24,240
to reset

1519
00:58:24,240 --> 00:58:26,640
but not of course this one single thing

1520
00:58:26,640 --> 00:58:28,960
out there

1521
00:58:30,480 --> 00:58:33,200
more questions

1522
00:58:33,359 --> 00:58:36,180
offline paul okay okay

1523
00:58:36,180 --> 00:58:38,559
[Music]

1524
00:58:38,559 --> 00:58:40,160
thank you so much again lovely to see

1525
00:58:40,160 --> 00:58:43,640
you thanks a lot

