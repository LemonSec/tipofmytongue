1
00:00:01,199 --> 00:00:02,240
all right

2
00:00:02,240 --> 00:00:05,920
so uh a bit about myself um

3
00:00:05,920 --> 00:00:08,320
i'm essentially a hacker

4
00:00:08,320 --> 00:00:10,800
modem hacker from the 80s i grew up with

5
00:00:10,800 --> 00:00:12,000
a keyboard

6
00:00:12,000 --> 00:00:14,080
in my mouth between my teeth instead of

7
00:00:14,080 --> 00:00:15,360
a knife

8
00:00:15,360 --> 00:00:17,119
growing up in a rough neighborhood

9
00:00:17,119 --> 00:00:19,600
namely israel israel is all about the

10
00:00:19,600 --> 00:00:21,920
security mindset from an early age so

11
00:00:21,920 --> 00:00:24,000
doesn't matter if you apply it wherever

12
00:00:24,000 --> 00:00:26,960
you do it's everywhere you are

13
00:00:26,960 --> 00:00:28,320
handling it

14
00:00:28,320 --> 00:00:32,320
i'm also a part of a group called

15
00:00:32,320 --> 00:00:33,760
tenrout

16
00:00:33,760 --> 00:00:36,239
which is a cyber security company

17
00:00:36,239 --> 00:00:39,920
services company based in israel

18
00:00:39,920 --> 00:00:41,920
i'm having a lot of fun with technology

19
00:00:41,920 --> 00:00:44,879
for a bit over 30 years

20
00:00:44,879 --> 00:00:47,440
with code with iv security with the

21
00:00:47,440 --> 00:00:49,440
different types of systems from

22
00:00:49,440 --> 00:00:53,600
vms openvms mainframes that we mentioned

23
00:00:53,600 --> 00:00:54,879
and of course obviously through

24
00:00:54,879 --> 00:00:56,800
microsoft in the last two and a half

25
00:00:56,800 --> 00:00:59,359
decades almost

26
00:00:59,359 --> 00:01:00,719
and the the thing i'm going to talk

27
00:01:00,719 --> 00:01:03,600
about today active directory or active

28
00:01:03,600 --> 00:01:05,600
directory as i like to call it it's

29
00:01:05,600 --> 00:01:07,840
actually active directory is a phrase i

30
00:01:07,840 --> 00:01:08,799
coined

31
00:01:08,799 --> 00:01:12,080
back when i was part of javelin networks

32
00:01:12,080 --> 00:01:14,560
javelin networks is a startup

33
00:01:14,560 --> 00:01:15,439
that

34
00:01:15,439 --> 00:01:17,759
was founded by israel air force and

35
00:01:17,759 --> 00:01:19,520
intelligence corps

36
00:01:19,520 --> 00:01:21,920
officers that we sold to symantec it's a

37
00:01:21,920 --> 00:01:24,400
deception solution for active directory

38
00:01:24,400 --> 00:01:27,759
we sold it to them in 2018

39
00:01:27,759 --> 00:01:29,360
but that's a technology i feel very

40
00:01:29,360 --> 00:01:31,119
comfortable about

41
00:01:31,119 --> 00:01:33,439
and today i'm going to talk uh quite a

42
00:01:33,439 --> 00:01:35,759
lot about active directory other than

43
00:01:35,759 --> 00:01:37,360
that i love to enjoy other things in

44
00:01:37,360 --> 00:01:40,320
life like flying planes volunteering to

45
00:01:40,320 --> 00:01:43,680
all kinds of uh populations and playing

46
00:01:43,680 --> 00:01:46,159
music i actually played here in hellfest

47
00:01:46,159 --> 00:01:47,759
if there are any metal fans here i

48
00:01:47,759 --> 00:01:49,840
played in hellfest few times yeah i

49
00:01:49,840 --> 00:01:52,079
played i know very well gojira and all

50
00:01:52,079 --> 00:01:54,479
the other guys

51
00:01:54,479 --> 00:01:57,360
so a lot of respect for friends not only

52
00:01:57,360 --> 00:01:59,439
in hacking excellent talent but also in

53
00:01:59,439 --> 00:02:00,399
music

54
00:02:00,399 --> 00:02:03,040
so we'll talk about hacktive directory

55
00:02:03,040 --> 00:02:04,880
uh why it's so hackable why is the

56
00:02:04,880 --> 00:02:06,719
active directory making

57
00:02:06,719 --> 00:02:09,520
so much noise and problems in its third

58
00:02:09,520 --> 00:02:12,400
decades of decade of life we'll speak

59
00:02:12,400 --> 00:02:15,200
about how we investigate uh

60
00:02:15,200 --> 00:02:17,440
incidents in active directory even if we

61
00:02:17,440 --> 00:02:19,760
have no logs we don't have any auditing

62
00:02:19,760 --> 00:02:21,120
no sim

63
00:02:21,120 --> 00:02:23,040
all the domain controller was wiped or

64
00:02:23,040 --> 00:02:25,120
encrypted how we can understand who did

65
00:02:25,120 --> 00:02:26,239
what

66
00:02:26,239 --> 00:02:28,480
using very specific

67
00:02:28,480 --> 00:02:29,520
files

68
00:02:29,520 --> 00:02:31,599
and finally i'm going to release today

69
00:02:31,599 --> 00:02:34,319
officially announce a tool to detect

70
00:02:34,319 --> 00:02:36,160
pass the hash and golden tickets on end

71
00:02:36,160 --> 00:02:38,720
points uh on github

72
00:02:38,720 --> 00:02:40,959
so active directory for those of you

73
00:02:40,959 --> 00:02:43,519
that are not too familiar about it

74
00:02:43,519 --> 00:02:45,280
who who here has

75
00:02:45,280 --> 00:02:47,120
runs active directory or is logging into

76
00:02:47,120 --> 00:02:49,200
an active directory every morning

77
00:02:49,200 --> 00:02:50,800
obviously

78
00:02:50,800 --> 00:02:52,640
almost the entire audience i think apart

79
00:02:52,640 --> 00:02:56,239
from the saw or it's all f

80
00:02:56,239 --> 00:02:59,840
fortune 500 except one company it's 95

81
00:02:59,840 --> 00:03:01,440
of the organizations in the world run

82
00:03:01,440 --> 00:03:03,680
active directory i think it worked to

83
00:03:03,680 --> 00:03:06,080
microsoft more than they planned it's a

84
00:03:06,080 --> 00:03:08,640
very popular centralized management

85
00:03:08,640 --> 00:03:11,920
identity uh repository all the users

86
00:03:11,920 --> 00:03:14,239
passwords computers access control etc

87
00:03:14,239 --> 00:03:16,239
are there but there is a population that

88
00:03:16,239 --> 00:03:17,840
really loves active directory more than

89
00:03:17,840 --> 00:03:20,720
sis admins and this is hackers active

90
00:03:20,720 --> 00:03:24,640
directory is a pivotal part in every uh

91
00:03:24,640 --> 00:03:27,680
hack major hack that is done and like i

92
00:03:27,680 --> 00:03:30,400
said even in its third decade

93
00:03:30,400 --> 00:03:32,159
it's still trending it's in the top

94
00:03:32,159 --> 00:03:36,080
trending for uh identity and uh all

95
00:03:36,080 --> 00:03:39,760
kinds of uh um uh apt groups use it all

96
00:03:39,760 --> 00:03:41,680
the time nation state level attackers

97
00:03:41,680 --> 00:03:43,840
are targeting negative directory

98
00:03:43,840 --> 00:03:46,319
and this really makes begs the question

99
00:03:46,319 --> 00:03:49,120
why is active directory so hackable

100
00:03:49,120 --> 00:03:52,640
for me it is a bit like tcp

101
00:03:52,640 --> 00:03:55,439
you see tcpap is a great success very

102
00:03:55,439 --> 00:03:57,280
popular but it was never

103
00:03:57,280 --> 00:03:59,519
meant or designed to do anything close

104
00:03:59,519 --> 00:04:01,360
to what we do with it today

105
00:04:01,360 --> 00:04:03,360
it's a sort of all the packet switching

106
00:04:03,360 --> 00:04:05,920
thing was or sort of an experiment but

107
00:04:05,920 --> 00:04:07,680
back in the days uh

108
00:04:07,680 --> 00:04:09,680
spoofing non-repudiation all the things

109
00:04:09,680 --> 00:04:11,280
that we fight today

110
00:04:11,280 --> 00:04:12,239
with

111
00:04:12,239 --> 00:04:14,879
as patches on tcp as an architecture and

112
00:04:14,879 --> 00:04:16,320
as a solution

113
00:04:16,320 --> 00:04:18,079
they were never in the design goals in

114
00:04:18,079 --> 00:04:20,160
the mindset of the

115
00:04:20,160 --> 00:04:22,240
designers of the ip suite and the the

116
00:04:22,240 --> 00:04:24,320
protocols the same is with active

117
00:04:24,320 --> 00:04:26,080
directory when active directory was

118
00:04:26,080 --> 00:04:28,880
planned and designed in the early 90s

119
00:04:28,880 --> 00:04:31,120
uh of course they put mit version 5

120
00:04:31,120 --> 00:04:33,840
kerberos and dns and other technologies

121
00:04:33,840 --> 00:04:37,440
but there was no uh storage emc netapp

122
00:04:37,440 --> 00:04:38,800
the things that we know today no

123
00:04:38,800 --> 00:04:41,360
virtualization vmware was still not

124
00:04:41,360 --> 00:04:46,160
around not to mention cloud saml

125
00:04:46,160 --> 00:04:48,400
web services json

126
00:04:48,400 --> 00:04:51,440
all these were things in the future

127
00:04:51,440 --> 00:04:53,759
and not to mention uh all types of

128
00:04:53,759 --> 00:04:55,120
attacks that we see today that's why

129
00:04:55,120 --> 00:04:57,440
it's involved in every huge breach and

130
00:04:57,440 --> 00:04:59,280
it's not going anyway

131
00:04:59,280 --> 00:05:01,280
so people think because of the cloud and

132
00:05:01,280 --> 00:05:03,600
azure that active directory will

133
00:05:03,600 --> 00:05:06,400
disappear it's happening very gradually

134
00:05:06,400 --> 00:05:08,880
that the workloads are transferring to

135
00:05:08,880 --> 00:05:10,560
the cloud but most organizations will

136
00:05:10,560 --> 00:05:13,120
stay hybrid for many many more years to

137
00:05:13,120 --> 00:05:14,880
come and many organizations will have

138
00:05:14,880 --> 00:05:17,840
workloads never leaving the on-prem ad

139
00:05:17,840 --> 00:05:19,600
and compromising your active directory

140
00:05:19,600 --> 00:05:22,720
means game over and why is active

141
00:05:22,720 --> 00:05:25,680
directory so hard to defend

142
00:05:25,680 --> 00:05:27,919
well one of the main issues is the lack

143
00:05:27,919 --> 00:05:29,440
of knowledge

144
00:05:29,440 --> 00:05:32,160
and in-depth uh skills when it comes to

145
00:05:32,160 --> 00:05:34,400
how active directory really works and

146
00:05:34,400 --> 00:05:36,639
i've outlined here a number of things

147
00:05:36,639 --> 00:05:39,120
that if you really want to get your

148
00:05:39,120 --> 00:05:41,440
grasp well around active directory you

149
00:05:41,440 --> 00:05:43,600
should really feel very comfortable

150
00:05:43,600 --> 00:05:45,919
about all of these concepts

151
00:05:45,919 --> 00:05:47,919
meaning uh not to mention i'll go very

152
00:05:47,919 --> 00:05:50,080
briefly but authentication protocols

153
00:05:50,080 --> 00:05:52,160
many people kind of miss out that active

154
00:05:52,160 --> 00:05:54,639
directory can authenticate in three

155
00:05:54,639 --> 00:05:56,800
different protocols including ldap and

156
00:05:56,800 --> 00:05:58,000
ldap s

157
00:05:58,000 --> 00:06:01,600
meaning ldap over tls uh by default ldap

158
00:06:01,600 --> 00:06:03,440
is an authentication protocol which is

159
00:06:03,440 --> 00:06:05,919
unencrypted in your network and you can

160
00:06:05,919 --> 00:06:07,919
see secrets there people miss out that

161
00:06:07,919 --> 00:06:10,400
certificate authentication is part of id

162
00:06:10,400 --> 00:06:13,120
and certificate enrollment is vulnerable

163
00:06:13,120 --> 00:06:14,880
people miss out sometimes the fact that

164
00:06:14,880 --> 00:06:17,360
security principles essentially objects

165
00:06:17,360 --> 00:06:19,840
that have security identifiers seed are

166
00:06:19,840 --> 00:06:22,240
not only users and computers and groups

167
00:06:22,240 --> 00:06:24,720
but also computers which are accounts

168
00:06:24,720 --> 00:06:27,680
computers can log in and perform actions

169
00:06:27,680 --> 00:06:29,759
just like users they're they're really

170
00:06:29,759 --> 00:06:30,800
users

171
00:06:30,800 --> 00:06:33,199
to any means in a name also in terms of

172
00:06:33,199 --> 00:06:34,800
authorization

173
00:06:34,800 --> 00:06:36,639
when we speak about access control lists

174
00:06:36,639 --> 00:06:39,440
and security descriptors that's really

175
00:06:39,440 --> 00:06:41,919
what should be in your mind rather than

176
00:06:41,919 --> 00:06:44,560
group membership and of course all the

177
00:06:44,560 --> 00:06:46,160
things that you normally call windows

178
00:06:46,160 --> 00:06:48,960
internals i really encourage people that

179
00:06:48,960 --> 00:06:52,080
even if you do sysadmin or or sekop's

180
00:06:52,080 --> 00:06:54,800
work to really know how processes work

181
00:06:54,800 --> 00:06:56,960
and behave in windows i'll give you two

182
00:06:56,960 --> 00:06:59,599
very brief examples why it's hard for

183
00:06:59,599 --> 00:07:01,599
people to get their grasp around 80

184
00:07:01,599 --> 00:07:04,000
security and why hackers win why they

185
00:07:04,000 --> 00:07:06,319
hack you all the time so successfully

186
00:07:06,319 --> 00:07:09,680
for example in this very basic uh

187
00:07:09,680 --> 00:07:12,319
video that i recorded there is a user

188
00:07:12,319 --> 00:07:14,639
called laura as you saw in the gui in

189
00:07:14,639 --> 00:07:16,639
the ui and i will also show you here in

190
00:07:16,639 --> 00:07:19,440
the built-in command line

191
00:07:19,440 --> 00:07:21,840
it only is a member only of two groups

192
00:07:21,840 --> 00:07:24,319
right domain users which is the default

193
00:07:24,319 --> 00:07:26,800
group the primary group and marketing is

194
00:07:26,800 --> 00:07:28,160
it really

195
00:07:28,160 --> 00:07:29,919
once you log into the domain what do you

196
00:07:29,919 --> 00:07:32,319
think will be her uh

197
00:07:32,319 --> 00:07:35,120
effective token the group membership

198
00:07:35,120 --> 00:07:38,720
that will really uh be part of our token

199
00:07:38,720 --> 00:07:40,720
so here is a script i wrote it's up on

200
00:07:40,720 --> 00:07:42,880
my github you can download it now very

201
00:07:42,880 --> 00:07:45,199
simple implementation of enumerating the

202
00:07:45,199 --> 00:07:46,400
kerberos

203
00:07:46,400 --> 00:07:48,960
token group and you can see that when

204
00:07:48,960 --> 00:07:51,120
she will log on to the domain

205
00:07:51,120 --> 00:07:53,039
she will have also managers and

206
00:07:53,039 --> 00:07:54,240
development

207
00:07:54,240 --> 00:07:56,400
two more groups that will be part of the

208
00:07:56,400 --> 00:07:58,560
token that she will present

209
00:07:58,560 --> 00:08:01,199
to the network and to permissions

210
00:08:01,199 --> 00:08:03,120
and when you look at it so

211
00:08:03,120 --> 00:08:05,680
you don't see any evidence directly

212
00:08:05,680 --> 00:08:08,960
but the thing is those come from

213
00:08:08,960 --> 00:08:12,240
cumulative nested groups so when we look

214
00:08:12,240 --> 00:08:15,039
on the member of attributes when we will

215
00:08:15,039 --> 00:08:16,960
just you know double click on on one of

216
00:08:16,960 --> 00:08:17,759
them

217
00:08:17,759 --> 00:08:20,160
uh you will see that at some level in

218
00:08:20,160 --> 00:08:24,000
the tree she has also other groups uh in

219
00:08:24,000 --> 00:08:26,080
her token that's how they got here and

220
00:08:26,080 --> 00:08:28,319
and you can actually do this enumeration

221
00:08:28,319 --> 00:08:30,800
to any user including your administrator

222
00:08:30,800 --> 00:08:33,120
anyone can do it in the organization

223
00:08:33,120 --> 00:08:35,599
another example for back dooring active

224
00:08:35,599 --> 00:08:37,599
directory to have a backdoor

225
00:08:37,599 --> 00:08:40,479
is administered holder look at this user

226
00:08:40,479 --> 00:08:43,120
simple user named kai and you will see

227
00:08:43,120 --> 00:08:45,279
is not a member of any group

228
00:08:45,279 --> 00:08:46,320
right

229
00:08:46,320 --> 00:08:48,240
so essentially just the domain users

230
00:08:48,240 --> 00:08:50,800
this is the default user that everyone

231
00:08:50,800 --> 00:08:52,160
log is

232
00:08:52,160 --> 00:08:54,480
belongs to by default uh the domain

233
00:08:54,480 --> 00:08:57,200
controller in this case is lone dc one

234
00:08:57,200 --> 00:08:59,920
obviously i cannot access the

235
00:08:59,920 --> 00:09:02,160
c dollar drive over the dc because i'm a

236
00:09:02,160 --> 00:09:04,800
very simple user right the simple that

237
00:09:04,800 --> 00:09:07,760
you can get uh very very far from being

238
00:09:07,760 --> 00:09:09,839
privileged but still you can see that

239
00:09:09,839 --> 00:09:12,480
with this logged on user kai

240
00:09:12,480 --> 00:09:14,720
i will now go to uh for example

241
00:09:14,720 --> 00:09:16,320
enterprise admin

242
00:09:16,320 --> 00:09:18,480
enterprise admin as you know the forced

243
00:09:18,480 --> 00:09:20,399
administrators it's a very

244
00:09:20,399 --> 00:09:22,480
high privileged group in the entire

245
00:09:22,480 --> 00:09:24,720
forest not only in your domain it can

246
00:09:24,720 --> 00:09:26,080
have effect

247
00:09:26,080 --> 00:09:27,120
and

248
00:09:27,120 --> 00:09:29,040
administrator is the only member of it

249
00:09:29,040 --> 00:09:30,959
at the moment and i'm going to add

250
00:09:30,959 --> 00:09:32,720
arbitrarily

251
00:09:32,720 --> 00:09:35,120
whoever i want i'm going to add ashley

252
00:09:35,120 --> 00:09:38,080
just a simple user named ashley

253
00:09:38,080 --> 00:09:40,160
and it works

254
00:09:40,160 --> 00:09:41,920
so i don't have any permission in the

255
00:09:41,920 --> 00:09:44,080
network and i am not a member of any

256
00:09:44,080 --> 00:09:46,399
group and i was able to somehow

257
00:09:46,399 --> 00:09:47,279
add

258
00:09:47,279 --> 00:09:49,680
any user i want to any group i want in

259
00:09:49,680 --> 00:09:51,040
the domain

260
00:09:51,040 --> 00:09:53,040
so the trick here if you will go and see

261
00:09:53,040 --> 00:09:54,800
the permissions on enterprise admins and

262
00:09:54,800 --> 00:09:56,160
you will remove it

263
00:09:56,160 --> 00:09:58,560
in less than one hour it will come back

264
00:09:58,560 --> 00:10:00,320
because there is a very simple mechanism

265
00:10:00,320 --> 00:10:01,519
called administ holder the

266
00:10:01,519 --> 00:10:04,000
administrative security descriptor a

267
00:10:04,000 --> 00:10:06,800
holder or placeholder of permissions

268
00:10:06,800 --> 00:10:09,200
that get propagated again and again on

269
00:10:09,200 --> 00:10:11,440
privileged objects and if you will not

270
00:10:11,440 --> 00:10:13,600
check for this and and if you are a

271
00:10:13,600 --> 00:10:15,760
member of a blue team or you have a sock

272
00:10:15,760 --> 00:10:17,040
or whatever

273
00:10:17,040 --> 00:10:19,600
i bet you're not checking this right now

274
00:10:19,600 --> 00:10:21,360
is anyone checking admin as the holder

275
00:10:21,360 --> 00:10:24,240
permissions on their on their ad

276
00:10:24,240 --> 00:10:25,360
this is a

277
00:10:25,360 --> 00:10:27,279
okay there are a few that's very well

278
00:10:27,279 --> 00:10:30,399
for you but most people don't most

279
00:10:30,399 --> 00:10:32,720
products don't and that's a mindset

280
00:10:32,720 --> 00:10:34,640
thing that's one example out of hundreds

281
00:10:34,640 --> 00:10:37,200
that you should look for in ad so active

282
00:10:37,200 --> 00:10:40,640
directory is uh exposed by design not

283
00:10:40,640 --> 00:10:42,800
only every endpoint trusts it any

284
00:10:42,800 --> 00:10:44,959
authenticated user but also trust it's

285
00:10:44,959 --> 00:10:48,320
in dozens of protocols and apis ldap

286
00:10:48,320 --> 00:10:53,680
kerbos dns wmi rpc dcom oledb adsi

287
00:10:53,680 --> 00:10:56,640
system directory services adweb services

288
00:10:56,640 --> 00:10:58,959
and if you look at uh

289
00:10:58,959 --> 00:11:01,040
at even the ports

290
00:11:01,040 --> 00:11:04,000
on an active directory

291
00:11:04,000 --> 00:11:06,320
uh as keep in mind there is no single

292
00:11:06,320 --> 00:11:07,600
port for active directory you have to

293
00:11:07,600 --> 00:11:09,920
protect all those ports especially the

294
00:11:09,920 --> 00:11:11,519
yellow one which are

295
00:11:11,519 --> 00:11:14,720
mandatory uh obviously also the blue one

296
00:11:14,720 --> 00:11:16,800
at least for from certain workstations

297
00:11:16,800 --> 00:11:18,880
the active directory powershell module

298
00:11:18,880 --> 00:11:21,120
works with the ad web services and all

299
00:11:21,120 --> 00:11:23,680
the ephemeral ports high ports for the

300
00:11:23,680 --> 00:11:24,880
rpc

301
00:11:24,880 --> 00:11:28,160
communication dcom wmi etc to add on top

302
00:11:28,160 --> 00:11:30,800
of that microsoft has made it meant very

303
00:11:30,800 --> 00:11:32,480
uh confusing

304
00:11:32,480 --> 00:11:35,920
to design your ad infrastructure

305
00:11:35,920 --> 00:11:37,920
securely

306
00:11:37,920 --> 00:11:39,360
i know i've been have worked for

307
00:11:39,360 --> 00:11:41,519
microsoft for nearly a decade from late

308
00:11:41,519 --> 00:11:44,079
90s to 2007

309
00:11:44,079 --> 00:11:46,160
being feeling like the only security guy

310
00:11:46,160 --> 00:11:47,440
back then

311
00:11:47,440 --> 00:11:48,880
it's really amazing what this company

312
00:11:48,880 --> 00:11:51,120
has done in the security push but the

313
00:11:51,120 --> 00:11:52,959
recommendations change every two three

314
00:11:52,959 --> 00:11:55,360
years so in the last 20 years microsoft

315
00:11:55,360 --> 00:11:57,440
recommendation has changed like five

316
00:11:57,440 --> 00:11:58,480
times

317
00:11:58,480 --> 00:12:01,360
from consolidating domains to making

318
00:12:01,360 --> 00:12:03,440
sure you understand that domain is not a

319
00:12:03,440 --> 00:12:05,920
security boundary and then

320
00:12:05,920 --> 00:12:07,360
giving you the

321
00:12:07,360 --> 00:12:09,760
red forest model which doesn't play well

322
00:12:09,760 --> 00:12:11,760
with the cloud and then giving you the

323
00:12:11,760 --> 00:12:14,160
admin tier model which kind of survived

324
00:12:14,160 --> 00:12:16,480
quite well until today and today

325
00:12:16,480 --> 00:12:18,480
speaking about privileged access

326
00:12:18,480 --> 00:12:21,040
obviously organizations cannot

327
00:12:21,040 --> 00:12:22,480
restructure

328
00:12:22,480 --> 00:12:25,680
the entire i.t infrastructure every two

329
00:12:25,680 --> 00:12:27,839
three years and it's nice that the

330
00:12:27,839 --> 00:12:29,920
recommendations change but that's also

331
00:12:29,920 --> 00:12:32,399
confusing and the final piece of the

332
00:12:32,399 --> 00:12:34,560
puzzle is the users of course users are

333
00:12:34,560 --> 00:12:36,399
behaving like addicts

334
00:12:36,399 --> 00:12:38,079
you can speak to them until tomorrow

335
00:12:38,079 --> 00:12:40,079
about really good secure options in the

336
00:12:40,079 --> 00:12:43,279
platform uh but then they will go uh

337
00:12:43,279 --> 00:12:47,839
to the uh normal uh less secure options

338
00:12:47,839 --> 00:12:49,600
so that's about active directory in

339
00:12:49,600 --> 00:12:52,560
general and now we're going to step into

340
00:12:52,560 --> 00:12:54,240
the forensic part of things because

341
00:12:54,240 --> 00:12:56,800
there are many forensic tools and talks

342
00:12:56,800 --> 00:12:58,720
and concepts and and

343
00:12:58,720 --> 00:13:00,560
skills going around with memory

344
00:13:00,560 --> 00:13:02,079
acquisition

345
00:13:02,079 --> 00:13:04,639
memory dumps images things to do with

346
00:13:04,639 --> 00:13:07,120
the disk et cetera but less about active

347
00:13:07,120 --> 00:13:09,279
directory an active directory like we

348
00:13:09,279 --> 00:13:12,160
said it's a very crucial pivotal

349
00:13:12,160 --> 00:13:14,639
element of every breach in your

350
00:13:14,639 --> 00:13:16,000
organization very hard to do

351
00:13:16,000 --> 00:13:17,600
reconnaissance lateral movement

352
00:13:17,600 --> 00:13:20,079
privilege escalation 280 as a platform

353
00:13:20,079 --> 00:13:22,160
and what can you do when active

354
00:13:22,160 --> 00:13:23,440
directory

355
00:13:23,440 --> 00:13:26,000
gets hit in a ransom or any other type

356
00:13:26,000 --> 00:13:27,680
of wiper

357
00:13:27,680 --> 00:13:30,399
malware etc so the possible scenario we

358
00:13:30,399 --> 00:13:32,399
look at hand and i was

359
00:13:32,399 --> 00:13:35,839
like unluckily or luckily to testify

360
00:13:35,839 --> 00:13:37,600
in dozens of those

361
00:13:37,600 --> 00:13:39,920
those type of events

362
00:13:39,920 --> 00:13:41,600
sometimes you'll have no logs either

363
00:13:41,600 --> 00:13:43,360
they're not collected not audited or

364
00:13:43,360 --> 00:13:45,920
they were wiped totally the dc's are

365
00:13:45,920 --> 00:13:48,399
totally encrypted offline maybe you get

366
00:13:48,399 --> 00:13:50,800
a good backup like a recent backup quite

367
00:13:50,800 --> 00:13:52,880
close to when the event happened

368
00:13:52,880 --> 00:13:55,360
but still you want to build a timeline

369
00:13:55,360 --> 00:13:57,600
who did what and when in your

370
00:13:57,600 --> 00:14:00,160
organization and of course you can go to

371
00:14:00,160 --> 00:14:02,639
the source of truth in active directory

372
00:14:02,639 --> 00:14:04,800
directory which splits to three

373
00:14:04,800 --> 00:14:06,399
different parts

374
00:14:06,399 --> 00:14:08,000
as a bunch of files

375
00:14:08,000 --> 00:14:10,000
sysvol is namely one of the most common

376
00:14:10,000 --> 00:14:12,560
of them but not the only one the event

377
00:14:12,560 --> 00:14:14,480
tracing for windows essentially the

378
00:14:14,480 --> 00:14:17,440
event logs but as you very well know

379
00:14:17,440 --> 00:14:20,160
there are a few types of attacks that

380
00:14:20,160 --> 00:14:22,800
can bypass the event logs of windows dc

381
00:14:22,800 --> 00:14:25,199
sync dc shadow to name a few and of

382
00:14:25,199 --> 00:14:27,199
course event logs can be tampered with

383
00:14:27,199 --> 00:14:31,120
or deleted wiped encrypted and pickups

384
00:14:31,120 --> 00:14:33,760
but to to use a sensor that runs a

385
00:14:33,760 --> 00:14:36,959
pickup and responds in real time to

386
00:14:36,959 --> 00:14:39,519
every type of traffic that's that's

387
00:14:39,519 --> 00:14:41,279
something quite challenging

388
00:14:41,279 --> 00:14:45,279
uh so we are left with a file ntdsdit

389
00:14:45,279 --> 00:14:46,639
the directory information tree

390
00:14:46,639 --> 00:14:49,519
essentially it's the database of active

391
00:14:49,519 --> 00:14:52,000
directory and inside that database we

392
00:14:52,000 --> 00:14:53,680
have this thing called the replication

393
00:14:53,680 --> 00:14:55,920
property metadata

394
00:14:55,920 --> 00:14:58,880
so what can we do uh with that file so

395
00:14:58,880 --> 00:15:00,720
the database file of active directory it

396
00:15:00,720 --> 00:15:03,360
works in a very specific way it's a jet

397
00:15:03,360 --> 00:15:06,079
blue database and an esc extensible

398
00:15:06,079 --> 00:15:09,519
storage engine quite like exchange wins

399
00:15:09,519 --> 00:15:11,040
and all other

400
00:15:11,040 --> 00:15:13,120
it's a sort of in the original it's like

401
00:15:13,120 --> 00:15:15,760
the database of access microsoft access

402
00:15:15,760 --> 00:15:18,959
access is the argument your father of uh

403
00:15:18,959 --> 00:15:22,000
active directory database from the 90s

404
00:15:22,000 --> 00:15:24,839
and it is normally managed by

405
00:15:24,839 --> 00:15:27,199
ntdsutil a bunch of tools but this is

406
00:15:27,199 --> 00:15:30,800
the major one to take a snapshot

407
00:15:30,800 --> 00:15:33,839
or install a file from media option

408
00:15:33,839 --> 00:15:35,600
this is the utility you can use to get a

409
00:15:35,600 --> 00:15:38,160
copy of it and inside the database you

410
00:15:38,160 --> 00:15:39,920
have all the objects all the attributes

411
00:15:39,920 --> 00:15:42,720
the properties the class the schema and

412
00:15:42,720 --> 00:15:45,839
on every every property you have every

413
00:15:45,839 --> 00:15:47,680
time there is a change

414
00:15:47,680 --> 00:15:50,880
and a replication is triggered to

415
00:15:50,880 --> 00:15:52,800
duplicate those changes between domain

416
00:15:52,800 --> 00:15:55,759
controllers it is written to a property

417
00:15:55,759 --> 00:15:58,800
called msds replication either attribute

418
00:15:58,800 --> 00:16:03,199
metadata or apple value data metadata

419
00:16:03,199 --> 00:16:05,440
it depends if the attribute is single or

420
00:16:05,440 --> 00:16:07,600
multi-valued so group membership

421
00:16:07,600 --> 00:16:10,480
obviously is a vector it's multi-valued

422
00:16:10,480 --> 00:16:13,839
other properties can can be in the msds

423
00:16:13,839 --> 00:16:15,920
attribute method data but you would ask

424
00:16:15,920 --> 00:16:17,920
yourself where is this

425
00:16:17,920 --> 00:16:19,920
attribute sitting so we can use the

426
00:16:19,920 --> 00:16:22,560
built-in partial commands

427
00:16:22,560 --> 00:16:25,040
and look for this msds whatever and as

428
00:16:25,040 --> 00:16:27,360
you will see it's not part of the

429
00:16:27,360 --> 00:16:30,160
properties that get returned and i asked

430
00:16:30,160 --> 00:16:33,040
for all the properties right asterix

431
00:16:33,040 --> 00:16:35,519
and but if you will look you will ask

432
00:16:35,519 --> 00:16:37,120
specifically

433
00:16:37,120 --> 00:16:38,959
you will tell

434
00:16:38,959 --> 00:16:40,959
the service to bring you specifically

435
00:16:40,959 --> 00:16:42,959
grapple property metadata you will get

436
00:16:42,959 --> 00:16:43,920
bytes

437
00:16:43,920 --> 00:16:46,000
okay so we'll see this property actually

438
00:16:46,000 --> 00:16:47,199
is

439
00:16:47,199 --> 00:16:49,600
in the database right we're not playing

440
00:16:49,600 --> 00:16:51,440
games here and if i will ask

441
00:16:51,440 --> 00:16:54,480
specifically msds repel attribute

442
00:16:54,480 --> 00:16:58,399
metadata ef voila now you will see xml

443
00:16:58,399 --> 00:17:01,120
for xml and all json

444
00:17:01,120 --> 00:17:03,199
json did not exist

445
00:17:03,199 --> 00:17:06,000
when active directory was invented xml

446
00:17:06,000 --> 00:17:08,160
is not the prettiest thing but wouldn't

447
00:17:08,160 --> 00:17:09,760
it be nice

448
00:17:09,760 --> 00:17:12,079
if we had a tool that you can run and

449
00:17:12,079 --> 00:17:14,160
would bring you all the changes that

450
00:17:14,160 --> 00:17:16,079
your active directory had

451
00:17:16,079 --> 00:17:17,760
since the beginning of time since the

452
00:17:17,760 --> 00:17:19,919
domain was born even before your time

453
00:17:19,919 --> 00:17:21,679
that you came to the company

454
00:17:21,679 --> 00:17:23,839
all the adding removing of groups and

455
00:17:23,839 --> 00:17:26,559
maybe all the changes in general even if

456
00:17:26,559 --> 00:17:30,240
you got all the data wiped or whatever

457
00:17:30,240 --> 00:17:31,919
so that's the idea so we're going to see

458
00:17:31,919 --> 00:17:34,400
a short scenario i'm going to first

459
00:17:34,400 --> 00:17:36,640
search for interesting strings in your

460
00:17:36,640 --> 00:17:38,720
active directory some ip addresses

461
00:17:38,720 --> 00:17:40,880
passwords if i find any basic

462
00:17:40,880 --> 00:17:43,039
reconnaissance then we're going to find

463
00:17:43,039 --> 00:17:44,799
some renamed accounts that will help us

464
00:17:44,799 --> 00:17:46,480
in this investigation

465
00:17:46,480 --> 00:17:48,480
then discover that we have no logs we

466
00:17:48,480 --> 00:17:50,000
have everything wiped and we're not

467
00:17:50,000 --> 00:17:52,160
collecting anything and then

468
00:17:52,160 --> 00:17:54,640
ad replication will come to the rescue

469
00:17:54,640 --> 00:17:56,960
so we have a scenario in which we are

470
00:17:56,960 --> 00:18:00,320
investigating that a user named annette

471
00:18:00,320 --> 00:18:02,640
performed some malicious activity we got

472
00:18:02,640 --> 00:18:04,480
an alert from the edr and we want to

473
00:18:04,480 --> 00:18:06,880
investigate it but we cannot find a

474
00:18:06,880 --> 00:18:08,480
username on it

475
00:18:08,480 --> 00:18:11,039
first thing to check is maybe there was

476
00:18:11,039 --> 00:18:13,440
a user it was deleted for that you have

477
00:18:13,440 --> 00:18:14,640
to enable

478
00:18:14,640 --> 00:18:17,360
in advance the ad optional feature of

479
00:18:17,360 --> 00:18:19,520
recycle bin right so in active directory

480
00:18:19,520 --> 00:18:21,600
of a recycle bin and you can search for

481
00:18:21,600 --> 00:18:23,200
deleted objects there

482
00:18:23,200 --> 00:18:25,200
but the first string a script i want to

483
00:18:25,200 --> 00:18:26,960
show you all these scripts are are

484
00:18:26,960 --> 00:18:29,760
available

485
00:18:29,760 --> 00:18:32,400
on my github page you can actually look

486
00:18:32,400 --> 00:18:34,880
for very specific string in this case i

487
00:18:34,880 --> 00:18:36,480
search for

488
00:18:36,480 --> 00:18:39,480
902190210

489
00:18:39,919 --> 00:18:42,559
and i find this match uh it's actually a

490
00:18:42,559 --> 00:18:46,559
file a timestamp a file format signature

491
00:18:46,559 --> 00:18:47,600
of the

492
00:18:47,600 --> 00:18:49,600
password last set of some attributes so

493
00:18:49,600 --> 00:18:51,840
not really helpful if i will search for

494
00:18:51,840 --> 00:18:53,280
the

495
00:18:53,280 --> 00:18:55,280
string annette

496
00:18:55,280 --> 00:18:57,760
and i will ask to see the match details

497
00:18:57,760 --> 00:18:59,679
so you see i found actually her name

498
00:18:59,679 --> 00:19:02,160
somewhere so at one property so

499
00:19:02,160 --> 00:19:04,480
obviously a user named annette

500
00:19:04,480 --> 00:19:05,280
was

501
00:19:05,280 --> 00:19:08,320
a member of that domain now i'm going to

502
00:19:08,320 --> 00:19:11,919
look for renamed accounts renamed users

503
00:19:11,919 --> 00:19:14,240
and in this case because i when we have

504
00:19:14,240 --> 00:19:16,160
events 4781

505
00:19:16,160 --> 00:19:18,559
on the domain controllers we can see

506
00:19:18,559 --> 00:19:20,720
when there are account renaming

507
00:19:20,720 --> 00:19:22,320
happening to the same account name to

508
00:19:22,320 --> 00:19:24,240
the login name and we can actually see

509
00:19:24,240 --> 00:19:26,400
that annette was renamed somehow for

510
00:19:26,400 --> 00:19:27,600
some reason

511
00:19:27,600 --> 00:19:30,640
today jane d this jane doe

512
00:19:30,640 --> 00:19:33,120
so now uh this is also how it will look

513
00:19:33,120 --> 00:19:35,679
like in the gui if you uh if you are not

514
00:19:35,679 --> 00:19:37,440
using the the scripts the code the

515
00:19:37,440 --> 00:19:39,440
automated approach

516
00:19:39,440 --> 00:19:41,440
so you will see this event occurring

517
00:19:41,440 --> 00:19:44,559
this four seven eight one uh event

518
00:19:44,559 --> 00:19:46,000
so now we know that we have in our

519
00:19:46,000 --> 00:19:48,080
investigation to focus on a different

520
00:19:48,080 --> 00:19:51,280
user named jane d

521
00:19:51,280 --> 00:19:53,760
and the next script is the replication

522
00:19:53,760 --> 00:19:56,240
metadata history this actually

523
00:19:56,240 --> 00:19:59,120
will it works also offline and online so

524
00:19:59,120 --> 00:20:00,799
you can also work with an online domain

525
00:20:00,799 --> 00:20:02,559
controller and an offline backup it will

526
00:20:02,559 --> 00:20:04,559
show you all the changes

527
00:20:04,559 --> 00:20:07,600
for any object in the domain since the

528
00:20:07,600 --> 00:20:10,000
the time it was created so you can see

529
00:20:10,000 --> 00:20:13,440
this uh user annette now called jd was

530
00:20:13,440 --> 00:20:17,039
created somewhere in october 2016.

531
00:20:17,039 --> 00:20:20,240
you can see it was created from a

532
00:20:20,240 --> 00:20:21,440
sort of

533
00:20:21,440 --> 00:20:23,120
automated process because many

534
00:20:23,120 --> 00:20:24,880
attributes were populated at the same

535
00:20:24,880 --> 00:20:26,880
minute the same time including the

536
00:20:26,880 --> 00:20:28,480
company etc

537
00:20:28,480 --> 00:20:30,400
and also interesting is that

538
00:20:30,400 --> 00:20:32,720
if you can notice the admin count

539
00:20:32,720 --> 00:20:35,360
attribute value was changed somewhere in

540
00:20:35,360 --> 00:20:38,960
2020 july 2020 to one and as you

541
00:20:38,960 --> 00:20:41,200
perfectly know admin count equals one

542
00:20:41,200 --> 00:20:43,760
means that it was a member or still is a

543
00:20:43,760 --> 00:20:46,799
member of a privileged group

544
00:20:46,799 --> 00:20:49,039
and more interestingly the most

545
00:20:49,039 --> 00:20:50,880
interesting uh evidence here is seed

546
00:20:50,880 --> 00:20:54,000
history seed history was populated last

547
00:20:54,000 --> 00:20:57,280
march in march 21 to a seed

548
00:20:57,280 --> 00:21:00,720
that ends with a relative id of 500 500

549
00:21:00,720 --> 00:21:04,640
obviously is the administrator the

550
00:21:04,640 --> 00:21:07,200
privileged user in any domain and this

551
00:21:07,200 --> 00:21:09,120
really gives us the feeling that there's

552
00:21:09,120 --> 00:21:11,120
something wrong with this user that it

553
00:21:11,120 --> 00:21:13,039
was used to backdoor from a migrated

554
00:21:13,039 --> 00:21:15,360
domain now we're going to run

555
00:21:15,360 --> 00:21:18,400
the next tool which is get ad group

556
00:21:18,400 --> 00:21:19,360
changes

557
00:21:19,360 --> 00:21:21,360
yet another open source powershell tool

558
00:21:21,360 --> 00:21:24,000
that you can download and use and this

559
00:21:24,000 --> 00:21:27,280
tool you can query specific user any

560
00:21:27,280 --> 00:21:29,760
specific group or any group now this

561
00:21:29,760 --> 00:21:31,520
tool will show us very easily and

562
00:21:31,520 --> 00:21:34,240
quickly without messing with xmls that

563
00:21:34,240 --> 00:21:35,440
annette

564
00:21:35,440 --> 00:21:39,039
jnd was actually added and removed from

565
00:21:39,039 --> 00:21:41,200
the backup operators

566
00:21:41,200 --> 00:21:43,600
group the last action was removed this

567
00:21:43,600 --> 00:21:46,240
changed happened when i shoot this video

568
00:21:46,240 --> 00:21:49,919
was nine days uh ago

569
00:21:49,919 --> 00:21:52,320
and we begin to understand what we are

570
00:21:52,320 --> 00:21:54,799
facing here and keep in mind this will

571
00:21:54,799 --> 00:21:56,480
all those tools will work even if we

572
00:21:56,480 --> 00:21:58,240
don't have any

573
00:21:58,240 --> 00:22:00,080
active domain controller i will show you

574
00:22:00,080 --> 00:22:03,120
soon with an offline version now i asked

575
00:22:03,120 --> 00:22:05,120
using the same script get ad group

576
00:22:05,120 --> 00:22:06,480
changes

577
00:22:06,480 --> 00:22:09,600
using the same free tool i asked for

578
00:22:09,600 --> 00:22:11,200
all the changes in

579
00:22:11,200 --> 00:22:15,679
domain admins right quite a common group

580
00:22:15,679 --> 00:22:17,520
and in this group i can see that there

581
00:22:17,520 --> 00:22:19,679
is a user called terry

582
00:22:19,679 --> 00:22:22,000
he was removed the last action was that

583
00:22:22,000 --> 00:22:24,240
he was removed from domain admins we can

584
00:22:24,240 --> 00:22:26,400
see the date it was removed the date it

585
00:22:26,400 --> 00:22:28,799
was added and the days since the last

586
00:22:28,799 --> 00:22:29,760
change

587
00:22:29,760 --> 00:22:31,440
and we can also see interestingly enough

588
00:22:31,440 --> 00:22:33,520
that the member admin count

589
00:22:33,520 --> 00:22:35,440
was cleared

590
00:22:35,440 --> 00:22:37,120
now this means that either the system

591
00:22:37,120 --> 00:22:39,760
administrator like

592
00:22:39,760 --> 00:22:41,840
in a good intention removed this

593
00:22:41,840 --> 00:22:43,919
attribute after uh

594
00:22:43,919 --> 00:22:46,000
something happened or maybe it's an

595
00:22:46,000 --> 00:22:47,360
attacker

596
00:22:47,360 --> 00:22:49,360
that after he added himself to a group

597
00:22:49,360 --> 00:22:51,760
he uh took it himself out of the group

598
00:22:51,760 --> 00:22:52,480
and

599
00:22:52,480 --> 00:22:54,720
actually uh

600
00:22:54,720 --> 00:22:57,919
deleted this member of uh admin count

601
00:22:57,919 --> 00:23:00,000
equals one and we could also obviously

602
00:23:00,000 --> 00:23:03,360
look uh at this uh these changes on a

603
00:23:03,360 --> 00:23:04,960
user specific

604
00:23:04,960 --> 00:23:07,840
uh view so here i query all the changes

605
00:23:07,840 --> 00:23:10,159
just for terry and i see he's a member

606
00:23:10,159 --> 00:23:13,280
of development team so all he did in uh

607
00:23:13,280 --> 00:23:15,760
in his life cycle is just being a member

608
00:23:15,760 --> 00:23:17,760
of a development team and then suddenly

609
00:23:17,760 --> 00:23:20,720
he was a domain admin for uh

610
00:23:20,720 --> 00:23:23,360
maybe a few a couple of hours or

611
00:23:23,360 --> 00:23:25,360
something like that

612
00:23:25,360 --> 00:23:27,520
now i'm going to leave my uh

613
00:23:27,520 --> 00:23:30,000
my vm here you see there is an active

614
00:23:30,000 --> 00:23:33,200
domain and i work directly with ldap

615
00:23:33,200 --> 00:23:34,559
protocol

616
00:23:34,559 --> 00:23:36,880
using those tools but now i'm going

617
00:23:36,880 --> 00:23:38,799
outside to a workstation outside of the

618
00:23:38,799 --> 00:23:41,120
domain i'm working totally offline you

619
00:23:41,120 --> 00:23:42,960
can see that my host is not connected to

620
00:23:42,960 --> 00:23:46,400
a domain and i have an offline file that

621
00:23:46,400 --> 00:23:48,880
i want to use so i have here an offline

622
00:23:48,880 --> 00:23:51,120
snapshot essentially a

623
00:23:51,120 --> 00:23:52,080
backup

624
00:23:52,080 --> 00:23:54,720
of the ntds did

625
00:23:54,720 --> 00:23:56,320
the directory information tree the

626
00:23:56,320 --> 00:23:58,400
database of active directory i don't

627
00:23:58,400 --> 00:24:00,480
need the registry i need a registry just

628
00:24:00,480 --> 00:24:02,320
for the

629
00:24:02,320 --> 00:24:05,200
decryption of ntlm hashes etc but for

630
00:24:05,200 --> 00:24:07,600
this tool i just need the ntdsd

631
00:24:07,600 --> 00:24:10,159
in a shutdown successfully mode that it

632
00:24:10,159 --> 00:24:12,240
had it had a clean shutdown

633
00:24:12,240 --> 00:24:15,520
so uh make sure you get that

634
00:24:15,520 --> 00:24:17,440
so now i'm going to run the tool with an

635
00:24:17,440 --> 00:24:19,840
offline database backup

636
00:24:19,840 --> 00:24:21,440
right so first of all i'm going to look

637
00:24:21,440 --> 00:24:23,840
for a specific user named adam i'm going

638
00:24:23,840 --> 00:24:26,080
to use the offline database backup

639
00:24:26,080 --> 00:24:28,960
option give it a pass to a database and

640
00:24:28,960 --> 00:24:30,799
what this tool does is on your

641
00:24:30,799 --> 00:24:33,520
workstation it will actually load

642
00:24:33,520 --> 00:24:34,960
the database

643
00:24:34,960 --> 00:24:37,279
in memory essentially

644
00:24:37,279 --> 00:24:41,039
create a ad hoc in memory ldap server

645
00:24:41,039 --> 00:24:43,279
that you can query your

646
00:24:43,279 --> 00:24:46,159
backup instance live for forensic

647
00:24:46,159 --> 00:24:49,520
information as if it was your domain

648
00:24:49,520 --> 00:24:50,799
controller

649
00:24:50,799 --> 00:24:53,919
and you can actually use these options

650
00:24:53,919 --> 00:24:56,640
this option also in the previous script

651
00:24:56,640 --> 00:24:59,520
you saw earlier in this video

652
00:24:59,520 --> 00:25:01,279
of all the changes the replication

653
00:25:01,279 --> 00:25:03,520
metadata in full not only the group

654
00:25:03,520 --> 00:25:04,720
changes

655
00:25:04,720 --> 00:25:08,000
so we continue to use now i this i chose

656
00:25:08,000 --> 00:25:09,600
the option to keep

657
00:25:09,600 --> 00:25:10,320
the

658
00:25:10,320 --> 00:25:12,559
database instance running so i'm going

659
00:25:12,559 --> 00:25:14,880
to use the existing offline database

660
00:25:14,880 --> 00:25:16,799
instance in memory just to save a few

661
00:25:16,799 --> 00:25:17,760
seconds

662
00:25:17,760 --> 00:25:20,159
and now i'm dumping dumping directly

663
00:25:20,159 --> 00:25:21,440
from memory

664
00:25:21,440 --> 00:25:22,720
offline

665
00:25:22,720 --> 00:25:25,840
using this offline database all the

666
00:25:25,840 --> 00:25:28,640
group changes since the beginning of

667
00:25:28,640 --> 00:25:30,640
this domain and

668
00:25:30,640 --> 00:25:33,520
you see there is options to export this

669
00:25:33,520 --> 00:25:36,320
to a csv obviously or to a

670
00:25:36,320 --> 00:25:38,080
easy grid that you can work with with

671
00:25:38,080 --> 00:25:40,320
powershell and this grid is filtered so

672
00:25:40,320 --> 00:25:41,919
now we can see all the changes that

673
00:25:41,919 --> 00:25:44,320
happened since the inception of of the

674
00:25:44,320 --> 00:25:46,320
domain

675
00:25:46,320 --> 00:25:48,400
very easy to work with that

676
00:25:48,400 --> 00:25:51,200
uh before this tool there was a quite a

677
00:25:51,200 --> 00:25:54,240
nice tool actually french tool

678
00:25:54,240 --> 00:25:56,480
called ad timeline there still is that

679
00:25:56,480 --> 00:25:58,559
really makes also a nice work on getting

680
00:25:58,559 --> 00:26:01,279
all those changes but this really has a

681
00:26:01,279 --> 00:26:04,720
very uh specific uh

682
00:26:04,720 --> 00:26:07,200
visibility and extract all these is a

683
00:26:07,200 --> 00:26:08,799
very similar

684
00:26:08,799 --> 00:26:11,279
a very useful way that you can actually

685
00:26:11,279 --> 00:26:13,440
investigate so the forensic scripts for

686
00:26:13,440 --> 00:26:15,600
active directory get id changes

687
00:26:15,600 --> 00:26:17,840
replication meta et cetera you can get

688
00:26:17,840 --> 00:26:19,520
them now from github they're there for a

689
00:26:19,520 --> 00:26:20,559
while

690
00:26:20,559 --> 00:26:22,320
no special permissions

691
00:26:22,320 --> 00:26:24,880
anyone can run them unfortunately anyone

692
00:26:24,880 --> 00:26:27,440
can run them so anyone can do it in your

693
00:26:27,440 --> 00:26:29,760
organization even now as we are speaking

694
00:26:29,760 --> 00:26:32,400
no agent it doesn't install anything

695
00:26:32,400 --> 00:26:34,720
uh and there are no dependencies right

696
00:26:34,720 --> 00:26:38,159
no external modules etc

697
00:26:38,159 --> 00:26:41,120
let's move to speak about uh some of the

698
00:26:41,120 --> 00:26:43,600
major problems in active directory which

699
00:26:43,600 --> 00:26:46,480
are the persistence uh

700
00:26:46,480 --> 00:26:49,440
with the high privileged user compromise

701
00:26:49,440 --> 00:26:52,400
in active directory namely past the hash

702
00:26:52,400 --> 00:26:55,039
and most effectively golden tickets

703
00:26:55,039 --> 00:26:57,279
probably many of you heard the term

704
00:26:57,279 --> 00:26:59,600
golden ticket it's quite

705
00:26:59,600 --> 00:27:01,600
scary because we all know that when an

706
00:27:01,600 --> 00:27:03,919
attacker has a golden ticket it has

707
00:27:03,919 --> 00:27:05,679
a very strong

708
00:27:05,679 --> 00:27:08,000
persistent uh

709
00:27:08,000 --> 00:27:10,080
hold of your domain so it can

710
00:27:10,080 --> 00:27:12,240
impersonate any user without knowing its

711
00:27:12,240 --> 00:27:15,440
password for any period length of time

712
00:27:15,440 --> 00:27:17,600
until you

713
00:27:17,600 --> 00:27:19,600
do a password

714
00:27:19,600 --> 00:27:21,120
enrollment until you receive the

715
00:27:21,120 --> 00:27:23,919
password of kirti gt the master kerbos

716
00:27:23,919 --> 00:27:26,559
password so when uh you have golden

717
00:27:26,559 --> 00:27:28,080
ticket

718
00:27:28,080 --> 00:27:30,880
you uh using the kerpg tgt hash of

719
00:27:30,880 --> 00:27:32,080
course

720
00:27:32,080 --> 00:27:34,080
so this can be obtained in multiple ways

721
00:27:34,080 --> 00:27:37,200
right the kelp gth either dc sync etc

722
00:27:37,200 --> 00:27:38,880
unauthorized ad replication with

723
00:27:38,880 --> 00:27:40,720
mimikets and other tools

724
00:27:40,720 --> 00:27:44,399
either by a copy of the ad database many

725
00:27:44,399 --> 00:27:46,080
times you might be surprised but in the

726
00:27:46,080 --> 00:27:47,919
pen tests the retimes that we have we

727
00:27:47,919 --> 00:27:50,000
find it in all kind of dollar hidden

728
00:27:50,000 --> 00:27:52,640
shells backup shares in the network etc

729
00:27:52,640 --> 00:27:54,720
or it can also be stolen from memory

730
00:27:54,720 --> 00:27:56,080
less efficient

731
00:27:56,080 --> 00:27:57,600
in read write domain controllers but

732
00:27:57,600 --> 00:27:58,799
still when you get to the domain

733
00:27:58,799 --> 00:28:01,039
controller it's a game over but you can

734
00:28:01,039 --> 00:28:04,159
actually also extract the curb tgt most

735
00:28:04,159 --> 00:28:06,320
known one is the unauthorized

736
00:28:06,320 --> 00:28:09,440
ad application that you can target

737
00:28:09,440 --> 00:28:12,559
all kinds of service accounts compute

738
00:28:12,559 --> 00:28:15,840
connector accounts adfs sharepoint azure

739
00:28:15,840 --> 00:28:20,240
id connect etc and and use

740
00:28:21,120 --> 00:28:22,960
configurations that misconfigurations

741
00:28:22,960 --> 00:28:24,480
with excessive permissions to get to

742
00:28:24,480 --> 00:28:26,720
them but this attack can happen in

743
00:28:26,720 --> 00:28:29,520
multiple ways they can happen with rc4

744
00:28:29,520 --> 00:28:31,840
and for a long period of time that can

745
00:28:31,840 --> 00:28:35,360
happen with aes 256-bit encryption uh in

746
00:28:35,360 --> 00:28:36,399
the hash

747
00:28:36,399 --> 00:28:39,120
and they can look like a duck walk like

748
00:28:39,120 --> 00:28:41,120
a duck behave like a duck so they look

749
00:28:41,120 --> 00:28:44,559
very convincing but still

750
00:28:44,559 --> 00:28:47,200
there are unsimilarities when you really

751
00:28:47,200 --> 00:28:50,640
look into those tickets in uh in depth

752
00:28:50,640 --> 00:28:52,960
in the memory of the end point so to

753
00:28:52,960 --> 00:28:55,120
discover a golden ticket

754
00:28:55,120 --> 00:28:56,960
attack from the domain controller

755
00:28:56,960 --> 00:28:59,360
centrally you need to have very specific

756
00:28:59,360 --> 00:29:01,600
products commercial and you have to

757
00:29:01,600 --> 00:29:03,440
collect all the you have to know all the

758
00:29:03,440 --> 00:29:05,279
tgts that the domain controller has

759
00:29:05,279 --> 00:29:06,399
generated

760
00:29:06,399 --> 00:29:09,679
but today i'm announcing a goldfinger

761
00:29:09,679 --> 00:29:10,399
it's

762
00:29:10,399 --> 00:29:12,880
essentially yet another open source tool

763
00:29:12,880 --> 00:29:14,720
uh that i just released released to

764
00:29:14,720 --> 00:29:17,360
github what this tool does it goes out

765
00:29:17,360 --> 00:29:20,000
and collects analyze and hunts for

766
00:29:20,000 --> 00:29:22,559
suspicious tdts so it looks for golden

767
00:29:22,559 --> 00:29:24,559
ticket and pass the hash

768
00:29:24,559 --> 00:29:27,440
proactively in real time in all the

769
00:29:27,440 --> 00:29:28,880
domain joined

770
00:29:28,880 --> 00:29:32,159
endpoints so it doesn't need any agents

771
00:29:32,159 --> 00:29:34,799
it's uh it works with either winram when

772
00:29:34,799 --> 00:29:37,360
it's enabled powershell remoting or smb

773
00:29:37,360 --> 00:29:40,880
it uses behind the scenes pa exec the

774
00:29:40,880 --> 00:29:43,279
open and on commercial version of ps

775
00:29:43,279 --> 00:29:45,440
exec with the admin dollar share

776
00:29:45,440 --> 00:29:48,000
it has no dependency or external modules

777
00:29:48,000 --> 00:29:49,360
it's just a

778
00:29:49,360 --> 00:29:51,440
text file two text files that you copy

779
00:29:51,440 --> 00:29:53,760
and run there was a lot of research done

780
00:29:53,760 --> 00:29:57,360
to uh detect multiple anomalies with the

781
00:29:57,360 --> 00:29:59,520
low to high suspicious to any uh

782
00:29:59,520 --> 00:30:01,120
detection there

783
00:30:01,120 --> 00:30:04,159
it does require however uh to be a local

784
00:30:04,159 --> 00:30:06,320
admin at the endpoints unlike unlike the

785
00:30:06,320 --> 00:30:09,679
forensic tools that i spoke about

786
00:30:09,679 --> 00:30:13,440
earlier this tool has to enumerate uh

787
00:30:13,440 --> 00:30:16,000
with the system uh token

788
00:30:16,000 --> 00:30:18,799
all the kerberos sessions essentially it

789
00:30:18,799 --> 00:30:21,840
runs k-list sessions and enumerates and

790
00:30:21,840 --> 00:30:24,240
analyzes passes all the kerbals tickets

791
00:30:24,240 --> 00:30:26,480
in all the end points in the domain

792
00:30:26,480 --> 00:30:28,559
so it supports by the way running on

793
00:30:28,559 --> 00:30:30,799
different domains also other domains not

794
00:30:30,799 --> 00:30:32,720
only the currently logged on one it

795
00:30:32,720 --> 00:30:34,000
supports running

796
00:30:34,000 --> 00:30:36,480
on all computers or just workstations or

797
00:30:36,480 --> 00:30:39,360
a specific computer or computers or you

798
00:30:39,360 --> 00:30:41,600
can exclude specific computers can

799
00:30:41,600 --> 00:30:44,320
optionally enable winram on the way if i

800
00:30:44,320 --> 00:30:46,799
discover a machine has a clock skew you

801
00:30:46,799 --> 00:30:48,640
know in kerbos if you have more than

802
00:30:48,640 --> 00:30:51,039
five minutes uh clock difference with

803
00:30:51,039 --> 00:30:52,960
domain controller you get rpc not

804
00:30:52,960 --> 00:30:55,039
available and all kinds of connectivity

805
00:30:55,039 --> 00:30:57,200
issues so i fix it on the way if i

806
00:30:57,200 --> 00:30:59,600
encounter that on the script and more

807
00:30:59,600 --> 00:31:01,760
obviously we are all on the shoulder of

808
00:31:01,760 --> 00:31:04,480
giants and as a community so the

809
00:31:04,480 --> 00:31:07,120
collector part i heavily used previous

810
00:31:07,120 --> 00:31:09,200
work by jared atkinson and matthew

811
00:31:09,200 --> 00:31:10,880
graber two

812
00:31:10,880 --> 00:31:13,200
very cool and amazing colleagues that

813
00:31:13,200 --> 00:31:14,960
have done a great job there so i don't

814
00:31:14,960 --> 00:31:16,960
have to reinvent the wheel on the k-list

815
00:31:16,960 --> 00:31:18,960
session kind of thing

816
00:31:18,960 --> 00:31:21,600
so let's see that in action

817
00:31:21,600 --> 00:31:24,080
so in this sample

818
00:31:24,080 --> 00:31:27,039
domain i have three vms vms virtual

819
00:31:27,039 --> 00:31:28,799
machines going to work with the domain

820
00:31:28,799 --> 00:31:31,120
controller and another two i'm going

821
00:31:31,120 --> 00:31:33,200
first of all to just run the tool

822
00:31:33,200 --> 00:31:36,880
uh with the default options just not to

823
00:31:36,880 --> 00:31:39,200
put any parameters so as you can see

824
00:31:39,200 --> 00:31:40,960
gold fingers run

825
00:31:40,960 --> 00:31:42,559
it found three potential computer

826
00:31:42,559 --> 00:31:44,399
accounts enabled computer accounts but

827
00:31:44,399 --> 00:31:47,279
only two machines were available

828
00:31:47,279 --> 00:31:49,200
in terms of connectivity in winrar and

829
00:31:49,200 --> 00:31:50,559
it collected

830
00:31:50,559 --> 00:31:53,760
10 uh tgts 10 ticket granting ticket

831
00:31:53,760 --> 00:31:56,000
kerberos authentication tickets

832
00:31:56,000 --> 00:31:58,240
but it didn't found any anomalies so

833
00:31:58,240 --> 00:32:00,559
first thing to notice about goldfinger

834
00:32:00,559 --> 00:32:02,880
about this tool it's essentially a tgt

835
00:32:02,880 --> 00:32:03,919
collector

836
00:32:03,919 --> 00:32:06,640
right so you can also use it even if on

837
00:32:06,640 --> 00:32:08,240
the day to day not in an incident

838
00:32:08,240 --> 00:32:10,640
response or if you have an investigation

839
00:32:10,640 --> 00:32:12,159
if you just want to know

840
00:32:12,159 --> 00:32:15,760
who uh authenticated from where and and

841
00:32:15,760 --> 00:32:18,480
when essentially so you can just collect

842
00:32:18,480 --> 00:32:21,200
kerbals tickets from the end points and

843
00:32:21,200 --> 00:32:22,559
you will get all the endpoints and you

844
00:32:22,559 --> 00:32:24,320
will see all the kerberos

845
00:32:24,320 --> 00:32:26,720
active authentication kerbal sessions

846
00:32:26,720 --> 00:32:28,720
from all the machines but that's not

847
00:32:28,720 --> 00:32:31,039
what we want from that tool right let's

848
00:32:31,039 --> 00:32:33,200
let's try to hunt for a real uh

849
00:32:33,200 --> 00:32:35,360
potentially malicious activity past the

850
00:32:35,360 --> 00:32:38,000
hash now pass the hash

851
00:32:38,000 --> 00:32:39,919
we're going to one of the machines here

852
00:32:39,919 --> 00:32:42,720
the lone cl1 this windows 10 machine

853
00:32:42,720 --> 00:32:45,120
and we're going to run mimikatz

854
00:32:45,120 --> 00:32:48,559
obviously uh big proud pride yeah french

855
00:32:48,559 --> 00:32:50,559
pride benjamin and vincent le tu and all

856
00:32:50,559 --> 00:32:52,320
the great folks

857
00:32:52,320 --> 00:32:54,240
french is very good in computer hacking

858
00:32:54,240 --> 00:32:56,320
huh

859
00:32:56,320 --> 00:32:59,519
and i'm going to uh pre-prepare this

860
00:32:59,519 --> 00:33:00,640
command

861
00:33:00,640 --> 00:33:02,720
and as you can see this is past the hash

862
00:33:02,720 --> 00:33:04,559
so past this essentially i'm running the

863
00:33:04,559 --> 00:33:06,640
process with user adam this is the

864
00:33:06,640 --> 00:33:09,120
primary token the process owner but when

865
00:33:09,120 --> 00:33:09,760
i

866
00:33:09,760 --> 00:33:11,200
go to the network i'm using the

867
00:33:11,200 --> 00:33:13,360
impersonation token so in the

868
00:33:13,360 --> 00:33:15,840
impersonation token i am administrator

869
00:33:15,840 --> 00:33:18,080
but in the primary process token i am a

870
00:33:18,080 --> 00:33:19,360
different user

871
00:33:19,360 --> 00:33:21,279
this is essentially

872
00:33:21,279 --> 00:33:23,519
what it means to have a pass the hash

873
00:33:23,519 --> 00:33:24,960
the call

874
00:33:24,960 --> 00:33:27,360
very simple so now i could also

875
00:33:27,360 --> 00:33:28,799
impersonate it in other ways but i

876
00:33:28,799 --> 00:33:31,039
wanted to have a real pass the hash now

877
00:33:31,039 --> 00:33:32,640
i'm going to run

878
00:33:32,640 --> 00:33:34,720
the script again with the same options

879
00:33:34,720 --> 00:33:37,360
but now you will see the tree will light

880
00:33:37,360 --> 00:33:38,480
in the house

881
00:33:38,480 --> 00:33:41,200
so now we have tatata we have a warning

882
00:33:41,200 --> 00:33:44,080
uh you can see that we found uh

883
00:33:44,080 --> 00:33:45,919
suspicious cable tickets with high

884
00:33:45,919 --> 00:33:47,279
suspicion

885
00:33:47,279 --> 00:33:49,840
uh you see all the

886
00:33:49,840 --> 00:33:52,640
parameters the properties of that ticket

887
00:33:52,640 --> 00:33:55,120
and you can also see in the beginning

888
00:33:55,120 --> 00:33:57,840
if you saw the anomaly that it

889
00:33:57,840 --> 00:33:59,360
detected why

890
00:33:59,360 --> 00:34:00,480
it was

891
00:34:00,480 --> 00:34:02,480
flagged as a suspicious ticket in the

892
00:34:02,480 --> 00:34:06,080
domain you obviously get the name of the

893
00:34:06,080 --> 00:34:07,760
uh the workstation

894
00:34:07,760 --> 00:34:10,399
and you get the csv so you you can uh

895
00:34:10,399 --> 00:34:11,839
you have a separate csv for the

896
00:34:11,839 --> 00:34:13,679
suspicious tickets and a separate csv

897
00:34:13,679 --> 00:34:14,639
for

898
00:34:14,639 --> 00:34:17,839
two tickets that uh you you picked up

899
00:34:17,839 --> 00:34:20,639
uh now we're going to uh try a golden

900
00:34:20,639 --> 00:34:22,800
ticket uh

901
00:34:22,800 --> 00:34:25,040
on on uh on this scenario so we're going

902
00:34:25,040 --> 00:34:28,560
to back to the same machine uh lawncl1

903
00:34:28,560 --> 00:34:31,199
and on that machine uh i'll actually

904
00:34:31,199 --> 00:34:33,359
also pre-prepared

905
00:34:33,359 --> 00:34:35,199
the default

906
00:34:35,199 --> 00:34:38,320
and useful syntax for golden tickets

907
00:34:38,320 --> 00:34:39,199
this

908
00:34:39,199 --> 00:34:41,918
this syntax creates

909
00:34:41,918 --> 00:34:45,839
the default golden ticket i also added

910
00:34:45,839 --> 00:34:48,320
other special groups but essentially

911
00:34:48,320 --> 00:34:50,960
made the golden ticket right now right

912
00:34:50,960 --> 00:34:52,960
and i used the ptt option past the

913
00:34:52,960 --> 00:34:56,239
ticket so it injects the administrator

914
00:34:56,239 --> 00:34:58,880
ticket directly in memory

915
00:34:58,880 --> 00:35:01,280
hello now we have a golden ticket in

916
00:35:01,280 --> 00:35:02,960
memory on

917
00:35:02,960 --> 00:35:04,960
on this machine

918
00:35:04,960 --> 00:35:06,480
this time we're going to run the script

919
00:35:06,480 --> 00:35:09,040
again but just to have some

920
00:35:09,040 --> 00:35:10,240
sense we're going to run it with the

921
00:35:10,240 --> 00:35:12,560
collection method of smb

922
00:35:12,560 --> 00:35:14,640
the smb collection method is a bit

923
00:35:14,640 --> 00:35:15,760
slower

924
00:35:15,760 --> 00:35:18,560
because essentially it is slower to

925
00:35:18,560 --> 00:35:20,560
initiate an smb session rather than an

926
00:35:20,560 --> 00:35:23,200
http winram session

927
00:35:23,200 --> 00:35:25,839
but you will see once it's finishing we

928
00:35:25,839 --> 00:35:28,160
have a second ticket this one has

929
00:35:28,160 --> 00:35:30,480
different anomalies you will see that

930
00:35:30,480 --> 00:35:33,680
this ticket also has a high suspicion

931
00:35:33,680 --> 00:35:36,240
but when you will look at the report or

932
00:35:36,240 --> 00:35:38,400
the grid that popped up

933
00:35:38,400 --> 00:35:40,800
you will see that this ticket has

934
00:35:40,800 --> 00:35:42,320
much more

935
00:35:42,320 --> 00:35:44,880
multiple anomalies so the default uh

936
00:35:44,880 --> 00:35:46,720
syntax of mimikats that you see on the

937
00:35:46,720 --> 00:35:48,960
internet that people use in the kali

938
00:35:48,960 --> 00:35:51,920
linux or metasploit etc that's what it

939
00:35:51,920 --> 00:35:53,359
will give you in the minute that you

940
00:35:53,359 --> 00:35:54,880
will run this tool you will see all

941
00:35:54,880 --> 00:35:56,640
these anomalies the time difference in

942
00:35:56,640 --> 00:36:00,480
hours the token size the kerbos

943
00:36:00,480 --> 00:36:02,800
ticket age ticket renewal time you will

944
00:36:02,800 --> 00:36:05,520
have a bunch of anomalies but sometimes

945
00:36:05,520 --> 00:36:07,839
attackers are clever

946
00:36:07,839 --> 00:36:09,920
for example in our

947
00:36:09,920 --> 00:36:12,720
retime assessments when we do use golden

948
00:36:12,720 --> 00:36:14,240
tickets we don't always use that you

949
00:36:14,240 --> 00:36:16,240
have to make some judgments because

950
00:36:16,240 --> 00:36:18,160
hacker is first a mindset and then

951
00:36:18,160 --> 00:36:19,599
everything else

952
00:36:19,599 --> 00:36:21,280
then the skill sets the concepts and

953
00:36:21,280 --> 00:36:23,920
only the last is the tools but now we're

954
00:36:23,920 --> 00:36:26,640
gonna hunt for an advanced golden ticket

955
00:36:26,640 --> 00:36:28,160
how do you create an advanced golden

956
00:36:28,160 --> 00:36:29,119
ticket

957
00:36:29,119 --> 00:36:31,440
well you use all

958
00:36:31,440 --> 00:36:33,680
the options that make kit

959
00:36:33,680 --> 00:36:36,240
appear as it as if it is a very

960
00:36:36,240 --> 00:36:38,640
legitimate authentication session

961
00:36:38,640 --> 00:36:40,400
and in our case

962
00:36:40,400 --> 00:36:44,000
yeah i'm also making the fonts bigger

963
00:36:44,000 --> 00:36:45,920
live during the recording

964
00:36:45,920 --> 00:36:48,960
so in our case i'm going to create a

965
00:36:48,960 --> 00:36:51,119
ticket of the administrator user but

966
00:36:51,119 --> 00:36:54,720
it's going to use the aes 250 bits

967
00:36:54,720 --> 00:36:58,480
encryption hash no rc4 and it's going

968
00:36:58,480 --> 00:37:00,320
also to use

969
00:37:00,320 --> 00:37:02,880
the domain default domain uh

970
00:37:02,880 --> 00:37:04,000
renewal

971
00:37:04,000 --> 00:37:07,760
for 10 hours uh for 10 hours for the tgt

972
00:37:07,760 --> 00:37:10,640
i'm also going to make it look

973
00:37:10,640 --> 00:37:12,079
exactly like

974
00:37:12,079 --> 00:37:13,760
an authentication station of the

975
00:37:13,760 --> 00:37:15,599
administrator account

976
00:37:15,599 --> 00:37:17,760
so now in this this other machine if you

977
00:37:17,760 --> 00:37:21,440
saw this is win 8 pc

978
00:37:21,440 --> 00:37:23,599
and it looks perfectly normal

979
00:37:23,599 --> 00:37:27,520
right so it looks quite okay

980
00:37:27,520 --> 00:37:29,440
for many tools it will look quite okay

981
00:37:29,440 --> 00:37:32,000
especially dr kind of tools and now

982
00:37:32,000 --> 00:37:33,280
we're going to run it with some other

983
00:37:33,280 --> 00:37:35,119
options so you can see there are other

984
00:37:35,119 --> 00:37:37,520
parameters but we're going to run it on

985
00:37:37,520 --> 00:37:39,520
workstations only

986
00:37:39,520 --> 00:37:41,680
and use the verbose option

987
00:37:41,680 --> 00:37:44,640
and get some more logging

988
00:37:44,640 --> 00:37:46,400
to the screen

989
00:37:46,400 --> 00:37:48,839
and now you will see we have

990
00:37:48,839 --> 00:37:51,760
three suspicious tickets detected and

991
00:37:51,760 --> 00:37:54,400
obviously the one in the middle

992
00:37:54,400 --> 00:37:56,320
the win 8

993
00:37:56,320 --> 00:37:58,480
pc that's the one with the session

994
00:37:58,480 --> 00:38:00,320
client mismatch session username doesn't

995
00:38:00,320 --> 00:38:02,079
match the client

996
00:38:02,079 --> 00:38:04,960
you see that other than that it looks

997
00:38:04,960 --> 00:38:07,440
perfectly normal it has the logon domain

998
00:38:07,440 --> 00:38:10,400
controller time difference is perfect

999
00:38:10,400 --> 00:38:13,280
the uh the ticket flags are perfect

1000
00:38:13,280 --> 00:38:14,880
everything is perfect

1001
00:38:14,880 --> 00:38:16,640
just the client name on the ticket

1002
00:38:16,640 --> 00:38:19,119
doesn't match uh the session username

1003
00:38:19,119 --> 00:38:20,960
this is enough to understand that either

1004
00:38:20,960 --> 00:38:22,960
it's a management application that did

1005
00:38:22,960 --> 00:38:26,400
something very specific here or and this

1006
00:38:26,400 --> 00:38:28,400
could be a potential false positive it's

1007
00:38:28,400 --> 00:38:31,119
if it's a management uh one

1008
00:38:31,119 --> 00:38:31,920
but

1009
00:38:31,920 --> 00:38:34,240
obviously in this case not

1010
00:38:34,240 --> 00:38:36,320
this is how a

1011
00:38:36,320 --> 00:38:38,079
full logging

1012
00:38:38,079 --> 00:38:40,079
of the run of the two looks like it's

1013
00:38:40,079 --> 00:38:41,760
quite useful when you use smb

1014
00:38:41,760 --> 00:38:42,880
essentially

1015
00:38:42,880 --> 00:38:44,880
so you will see uh

1016
00:38:44,880 --> 00:38:46,880
it's the credentials you're running the

1017
00:38:46,880 --> 00:38:50,000
context uh how many potential computers

1018
00:38:50,000 --> 00:38:52,480
it it found and then it will try to see

1019
00:38:52,480 --> 00:38:54,480
if it can access them whether in winram

1020
00:38:54,480 --> 00:38:56,720
or smb before actually running the

1021
00:38:56,720 --> 00:38:59,200
script uh then it will collect the

1022
00:38:59,200 --> 00:39:01,200
script and analyze them you will see how

1023
00:39:01,200 --> 00:39:02,880
many tickets it found for each machine

1024
00:39:02,880 --> 00:39:04,960
or if it failed if you see failed

1025
00:39:04,960 --> 00:39:07,839
attempts they will also be here

1026
00:39:07,839 --> 00:39:09,599
these are all the tickets it detects by

1027
00:39:09,599 --> 00:39:12,560
default we exclude the

1028
00:39:12,560 --> 00:39:14,800
computer tgts

1029
00:39:14,800 --> 00:39:16,400
but you can also include them as a

1030
00:39:16,400 --> 00:39:18,560
parameter as a flag that you can mention

1031
00:39:18,560 --> 00:39:21,440
as a switch and the total ones

1032
00:39:21,440 --> 00:39:24,160
discovered

1033
00:39:24,480 --> 00:39:26,320
you can also exclude computers like i

1034
00:39:26,320 --> 00:39:28,800
told you you you can see it also in the

1035
00:39:28,800 --> 00:39:31,040
help of the tool and you can also check

1036
00:39:31,040 --> 00:39:34,079
for other domains uh keep in mind that

1037
00:39:34,079 --> 00:39:35,599
there are still

1038
00:39:35,599 --> 00:39:38,240
potential false positives right because

1039
00:39:38,240 --> 00:39:40,880
past the hash essentially uh

1040
00:39:40,880 --> 00:39:42,800
it's just a

1041
00:39:42,800 --> 00:39:44,800
like secondary logon

1042
00:39:44,800 --> 00:39:46,720
many applications all kinds of

1043
00:39:46,720 --> 00:39:49,440
management applications etc

1044
00:39:49,440 --> 00:39:53,119
use this type especially from system

1045
00:39:53,119 --> 00:39:55,520
spanning system process system shells

1046
00:39:55,520 --> 00:39:56,960
and then

1047
00:39:56,960 --> 00:39:58,320
having the

1048
00:39:58,320 --> 00:39:59,680
session user

1049
00:39:59,680 --> 00:40:01,760
being system but the client's name is

1050
00:40:01,760 --> 00:40:03,920
the active directory user because system

1051
00:40:03,920 --> 00:40:06,640
has full permissions on the machine

1052
00:40:06,640 --> 00:40:08,960
but it needs permissions on the domain

1053
00:40:08,960 --> 00:40:11,200
so this will generate an alert but a low

1054
00:40:11,200 --> 00:40:13,280
suspicious alert now on the tool and we

1055
00:40:13,280 --> 00:40:15,920
fix that in the beta another issue to be

1056
00:40:15,920 --> 00:40:19,119
aware of is because we are enumerating

1057
00:40:19,119 --> 00:40:21,520
all the kerbal tickets in the endpoints

1058
00:40:21,520 --> 00:40:22,800
this type of

1059
00:40:22,800 --> 00:40:25,359
activity can look

1060
00:40:25,359 --> 00:40:27,760
a bit malicious to some tools some tools

1061
00:40:27,760 --> 00:40:30,480
can detect that many instances of

1062
00:40:30,480 --> 00:40:32,160
winrarem are running

1063
00:40:32,160 --> 00:40:35,680
so be aware and you have to

1064
00:40:35,839 --> 00:40:38,480
whitelist that in in advance or

1065
00:40:38,480 --> 00:40:40,640
sometimes even

1066
00:40:40,640 --> 00:40:43,040
a antivirus can detect that as a power

1067
00:40:43,040 --> 00:40:44,800
view or whatever

1068
00:40:44,800 --> 00:40:47,440
in this case because amsi discovered

1069
00:40:47,440 --> 00:40:50,960
matthew grebel's functions inside the

1070
00:40:50,960 --> 00:40:53,200
the collector the one that runs

1071
00:40:53,200 --> 00:40:55,280
physically on the end point so you have

1072
00:40:55,280 --> 00:40:57,200
to exclude that in advance in order for

1073
00:40:57,200 --> 00:40:58,240
that to run

1074
00:40:58,240 --> 00:40:59,760
uh

1075
00:40:59,760 --> 00:41:02,560
obviously i could bypass this alert and

1076
00:41:02,560 --> 00:41:04,560
do an amsi bypass before i run the tool

1077
00:41:04,560 --> 00:41:07,200
but i i'm not here in this case i'm not

1078
00:41:07,200 --> 00:41:09,359
here in the head of a red

1079
00:41:09,359 --> 00:41:11,599
pen tester i don't want

1080
00:41:11,599 --> 00:41:13,440
a tool that is used to protect you to

1081
00:41:13,440 --> 00:41:15,280
bypass your

1082
00:41:15,280 --> 00:41:17,200
defenses but that's how it will look

1083
00:41:17,200 --> 00:41:19,119
like in the log

1084
00:41:19,119 --> 00:41:20,960
you will really see

1085
00:41:20,960 --> 00:41:23,119
this alert that your script was blocked

1086
00:41:23,119 --> 00:41:25,280
by antivirus software because i i take

1087
00:41:25,280 --> 00:41:28,560
out all the std out and stdl

1088
00:41:28,560 --> 00:41:29,680
and and

1089
00:41:29,680 --> 00:41:31,920
i can analyze that in real time all

1090
00:41:31,920 --> 00:41:33,760
those scripts are up available on the

1091
00:41:33,760 --> 00:41:35,839
internet now you can download them so

1092
00:41:35,839 --> 00:41:38,240
key takeaways hopefully

1093
00:41:38,240 --> 00:41:40,319
you were able to see some really nice

1094
00:41:40,319 --> 00:41:43,280
forensic artifacts in active directory

1095
00:41:43,280 --> 00:41:46,480
many of them are not that obvious to

1096
00:41:46,480 --> 00:41:47,200
see

1097
00:41:47,200 --> 00:41:48,640
and to collect

1098
00:41:48,640 --> 00:41:50,480
but you have a bunch of tools that you

1099
00:41:50,480 --> 00:41:51,200
can

1100
00:41:51,200 --> 00:41:53,040
certainly use i really encourage you to

1101
00:41:53,040 --> 00:41:54,560
get the right knowledge

1102
00:41:54,560 --> 00:41:58,240
the journey of active directory security

1103
00:41:58,240 --> 00:42:00,480
is really all around

1104
00:42:00,480 --> 00:42:02,400
a lot of knowledge and understanding

1105
00:42:02,400 --> 00:42:04,079
many concepts

1106
00:42:04,079 --> 00:42:06,560
just don't go there directly after the

1107
00:42:06,560 --> 00:42:08,960
tools understand in depth

1108
00:42:08,960 --> 00:42:11,200
how this technology works because even

1109
00:42:11,200 --> 00:42:12,319
today

1110
00:42:12,319 --> 00:42:14,720
like i said after 25 years still i

1111
00:42:14,720 --> 00:42:16,480
encounter many people

1112
00:42:16,480 --> 00:42:18,400
that don't really understand in deep how

1113
00:42:18,400 --> 00:42:20,079
active directory works

1114
00:42:20,079 --> 00:42:22,880
uh of course ad

1115
00:42:22,880 --> 00:42:25,359
forensic is part of a wider picture

1116
00:42:25,359 --> 00:42:26,880
uh the

1117
00:42:26,880 --> 00:42:30,079
if you have other sources you have to

1118
00:42:30,079 --> 00:42:31,839
tie them with the ad forensic

1119
00:42:31,839 --> 00:42:33,280
information

1120
00:42:33,280 --> 00:42:35,200
and check out just the

1121
00:42:35,200 --> 00:42:37,839
either active directory com or github

1122
00:42:37,839 --> 00:42:40,800
mypage for the code and scripts

1123
00:42:40,800 --> 00:42:43,200
and with that said i think we have

1124
00:42:43,200 --> 00:42:46,560
some time for questions right

1125
00:42:46,560 --> 00:42:47,599
perfect

1126
00:42:47,599 --> 00:42:51,119
two two minutes for question the call

1127
00:42:51,119 --> 00:42:52,720
so

1128
00:42:52,720 --> 00:42:57,359
any questions about what we discussed

1129
00:42:57,359 --> 00:43:00,640
or you are all in shock

1130
00:43:01,040 --> 00:43:02,960
yes it's true active directory is very

1131
00:43:02,960 --> 00:43:06,480
hackable if that causes you a shock uh

1132
00:43:06,480 --> 00:43:09,440
hello v

1133
00:43:10,319 --> 00:43:11,520
well

1134
00:43:11,520 --> 00:43:12,720
um

1135
00:43:12,720 --> 00:43:14,160
any questions

1136
00:43:14,160 --> 00:43:16,799
yes please

1137
00:43:18,870 --> 00:43:21,949
[Music]

1138
00:43:22,000 --> 00:43:23,440
hello betty

1139
00:43:23,440 --> 00:43:24,720
nice talk

1140
00:43:24,720 --> 00:43:26,720
if you have a full history of whatever

1141
00:43:26,720 --> 00:43:28,480
happened at active directory level you

1142
00:43:28,480 --> 00:43:30,160
could probably use it for red teaming as

1143
00:43:30,160 --> 00:43:33,200
well password changes things like that

1144
00:43:33,200 --> 00:43:35,599
yeah so uh the question was if if we

1145
00:43:35,599 --> 00:43:37,680
have all the history and in a free tool

1146
00:43:37,680 --> 00:43:39,920
open source anyone can use it because

1147
00:43:39,920 --> 00:43:41,920
there are no special permissions

1148
00:43:41,920 --> 00:43:44,480
definitely anyone you have a knife you

1149
00:43:44,480 --> 00:43:46,640
can cut a salad

1150
00:43:46,640 --> 00:43:47,760
you can

1151
00:43:47,760 --> 00:43:51,280
stab a person a technology it's a tool

1152
00:43:51,280 --> 00:43:53,359
you know we never know how others will

1153
00:43:53,359 --> 00:43:55,520
use it so obviously this is the flip

1154
00:43:55,520 --> 00:43:57,440
coin of technology you can use it for

1155
00:43:57,440 --> 00:44:00,319
bad and worse this part is up to you

1156
00:44:00,319 --> 00:44:02,319
for me my parents raised me in a way

1157
00:44:02,319 --> 00:44:03,839
that i'm standing here talking to you

1158
00:44:03,839 --> 00:44:05,280
and i pay taxes

1159
00:44:05,280 --> 00:44:06,880
maybe if i had a different childhood i

1160
00:44:06,880 --> 00:44:08,480
will never be talking to you i will make

1161
00:44:08,480 --> 00:44:10,640
much more money and i will be totally

1162
00:44:10,640 --> 00:44:13,759
anonymous but

1163
00:44:14,000 --> 00:44:15,839
it's all about the person using the tool

1164
00:44:15,839 --> 00:44:18,400
but yeah

1165
00:44:18,560 --> 00:44:21,520
it's about who uses the tool

1166
00:44:21,520 --> 00:44:23,680
any other question

1167
00:44:23,680 --> 00:44:26,680
yep

1168
00:44:36,400 --> 00:44:39,119
hey here you have the microphone

1169
00:44:39,119 --> 00:44:41,280
maybe it would be better yeah uh i was

1170
00:44:41,280 --> 00:44:43,680
thinking about uh the advanced golden

1171
00:44:43,680 --> 00:44:46,640
ticket uh you know uh the only thing

1172
00:44:46,640 --> 00:44:49,119
that make it suspect is a name

1173
00:44:49,119 --> 00:44:52,079
can we produce one that matches the

1174
00:44:52,079 --> 00:44:54,400
other two

1175
00:44:54,400 --> 00:44:56,319
so uh the question was about the

1176
00:44:56,319 --> 00:44:58,400
advanced golden ticket and the only

1177
00:44:58,400 --> 00:45:00,319
anomaly that really stands out there is

1178
00:45:00,319 --> 00:45:02,720
that the client name doesn't match the

1179
00:45:02,720 --> 00:45:04,400
session username

1180
00:45:04,400 --> 00:45:07,200
luckily for us kerbos is very vulnerable

1181
00:45:07,200 --> 00:45:09,119
in multiple ways it has been like that

1182
00:45:09,119 --> 00:45:11,760
it's a mit protocol from the 80s right

1183
00:45:11,760 --> 00:45:13,440
early 90s it was

1184
00:45:13,440 --> 00:45:15,839
and microsoft version luckily for us

1185
00:45:15,839 --> 00:45:18,319
still there are some basic limits so for

1186
00:45:18,319 --> 00:45:21,440
the ticket to be in full integrity

1187
00:45:21,440 --> 00:45:24,160
the client name and the session username

1188
00:45:24,160 --> 00:45:26,640
they come from two different places

1189
00:45:26,640 --> 00:45:29,040
so you will have to

1190
00:45:29,040 --> 00:45:30,160
spoof

1191
00:45:30,160 --> 00:45:31,200
the

1192
00:45:31,200 --> 00:45:32,560
the process

1193
00:45:32,560 --> 00:45:34,960
paid the primary process

1194
00:45:34,960 --> 00:45:37,359
holds the session name and the client

1195
00:45:37,359 --> 00:45:39,920
name is the ad part so they come from

1196
00:45:39,920 --> 00:45:41,280
different parts this comes from the

1197
00:45:41,280 --> 00:45:42,480
local

1198
00:45:42,480 --> 00:45:44,640
authentication security authority and

1199
00:45:44,640 --> 00:45:46,800
the ticket is essentially working with

1200
00:45:46,800 --> 00:45:47,599
the

1201
00:45:47,599 --> 00:45:49,440
kerbals entities because

1202
00:45:49,440 --> 00:45:51,760
even if you will try to do that once you

1203
00:45:51,760 --> 00:45:54,079
will use the tgt because tgt at the end

1204
00:45:54,079 --> 00:45:56,800
of the day is just an invitation to

1205
00:45:56,800 --> 00:45:58,640
create tgs

1206
00:45:58,640 --> 00:46:01,599
the call so when you will use the tgs

1207
00:46:01,599 --> 00:46:03,280
ticket granting service and you will try

1208
00:46:03,280 --> 00:46:05,839
to access a resource uh the integrity

1209
00:46:05,839 --> 00:46:07,200
will fail

1210
00:46:07,200 --> 00:46:09,920
so uh that's why uh we can still count

1211
00:46:09,920 --> 00:46:11,920
on this uh

1212
00:46:11,920 --> 00:46:13,119
uh

1213
00:46:13,119 --> 00:46:15,359
and then detect that

1214
00:46:15,359 --> 00:46:17,920
hello with that said merci beaucoup and

1215
00:46:17,920 --> 00:46:19,200
enjoy the rest of this wonderful

1216
00:46:19,200 --> 00:46:22,200
conference

1217
00:46:25,660 --> 00:46:28,910
[Applause]

