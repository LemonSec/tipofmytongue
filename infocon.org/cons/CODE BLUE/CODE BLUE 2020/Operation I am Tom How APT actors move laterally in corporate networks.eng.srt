1
00:00:32,960 --> 00:00:34,399
our next session is

2
00:00:34,399 --> 00:00:38,000
operation i am tom how apt actors move

3
00:00:38,000 --> 00:00:41,120
laterally in corporate networks please

4
00:00:41,120 --> 00:00:42,879
welcome our speakers

5
00:00:42,879 --> 00:00:45,839
argonne

6
00:00:49,920 --> 00:00:52,719
hello everyone uh this is team device

7
00:00:52,719 --> 00:00:54,160
talk in kobolu

8
00:00:54,160 --> 00:00:57,280
uh the topic today is how apd actors

9
00:00:57,280 --> 00:00:59,120
move laterally in carbon

10
00:00:59,120 --> 00:01:02,000
corporate network it's related to a

11
00:01:02,000 --> 00:01:03,440
operation we called

12
00:01:03,440 --> 00:01:06,960
anton the agenda of the day the first

13
00:01:06,960 --> 00:01:07,360
part

14
00:01:07,360 --> 00:01:09,920
introduction the second part we will

15
00:01:09,920 --> 00:01:10,880
introduce you

16
00:01:10,880 --> 00:01:12,880
some interesting idea function

17
00:01:12,880 --> 00:01:14,640
penetration techniques

18
00:01:14,640 --> 00:01:17,759
the third part is our discoveries

19
00:01:17,759 --> 00:01:20,960
in this operation related to web shield

20
00:01:20,960 --> 00:01:21,920
abuse

21
00:01:21,920 --> 00:01:24,840
the last part is some miscellaneous

22
00:01:24,840 --> 00:01:26,640
techniques

23
00:01:26,640 --> 00:01:30,159
and uh i'm charles lee the cto as well

24
00:01:30,159 --> 00:01:30,720
as

25
00:01:30,720 --> 00:01:34,000
chief analyst of team t5 and i'm erwin

26
00:01:34,000 --> 00:01:34,320
zhen

27
00:01:34,320 --> 00:01:38,559
i'm a moral researcher at tnt5

28
00:01:38,880 --> 00:01:41,360
so before start of this talk i would

29
00:01:41,360 --> 00:01:42,399
like you to

30
00:01:42,399 --> 00:01:45,680
know why we call it uh operation anton

31
00:01:45,680 --> 00:01:48,560
so it was uh in an incident response

32
00:01:48,560 --> 00:01:50,799
cases a few months ago

33
00:01:50,799 --> 00:01:54,000
tom is a incident response people

34
00:01:54,000 --> 00:01:57,360
in team t5 he was fighting hard with bad

35
00:01:57,360 --> 00:01:57,920
guys

36
00:01:57,920 --> 00:02:01,680
in one of our client network uh for

37
00:02:01,680 --> 00:02:05,439
months of uh fighting he discovered

38
00:02:05,439 --> 00:02:08,959
some message left by the thread actor

39
00:02:08,959 --> 00:02:12,920
in a txt file and the file name is

40
00:02:12,920 --> 00:02:15,599
iamtom.txt

41
00:02:15,599 --> 00:02:18,720
yeah that's the most interesting part of

42
00:02:18,720 --> 00:02:22,000
fighting with apt actors

43
00:02:22,000 --> 00:02:25,520
most apt attacks are done by humans

44
00:02:25,520 --> 00:02:28,319
so whenever they discovered your

45
00:02:28,319 --> 00:02:29,599
investigation

46
00:02:29,599 --> 00:02:32,959
your analysis actions they will try to

47
00:02:32,959 --> 00:02:33,920
find a way

48
00:02:33,920 --> 00:02:38,239
to bypass or hinder your analysis

49
00:02:38,239 --> 00:02:41,760
in the corpus of months of

50
00:02:41,760 --> 00:02:45,280
fighting with bad guys they tried

51
00:02:45,280 --> 00:02:48,480
various means to stop

52
00:02:48,480 --> 00:02:51,360
our investigation as we show in the

53
00:02:51,360 --> 00:02:52,319
photo

54
00:02:52,319 --> 00:02:56,000
we stop their activity and uh finally

55
00:02:56,000 --> 00:02:59,519
we get them rid of our

56
00:02:59,519 --> 00:03:02,959
clients network after that

57
00:03:02,959 --> 00:03:06,159
we decided to compile all the techniques

58
00:03:06,159 --> 00:03:07,040
they used

59
00:03:07,040 --> 00:03:09,040
in this attack and they become the

60
00:03:09,040 --> 00:03:12,400
materials of this attack

61
00:03:12,400 --> 00:03:14,959
so this talk will cover some post

62
00:03:14,959 --> 00:03:16,480
exploitation techniques

63
00:03:16,480 --> 00:03:19,360
used in corporate network their purpose

64
00:03:19,360 --> 00:03:19,680
is

65
00:03:19,680 --> 00:03:23,280
either doing lateral movement or bypass

66
00:03:23,280 --> 00:03:24,720
detection or throughout

67
00:03:24,720 --> 00:03:27,760
analysis they are mostly observed in

68
00:03:27,760 --> 00:03:30,000
real incident response cases

69
00:03:30,000 --> 00:03:33,040
which is a operation i'm tom and they

70
00:03:33,040 --> 00:03:33,840
are leveraged

71
00:03:33,840 --> 00:03:36,720
by various chinese trade actors and they

72
00:03:36,720 --> 00:03:38,159
are widely discussed

73
00:03:38,159 --> 00:03:41,200
in some chinese forums

74
00:03:41,200 --> 00:03:44,080
so in the next session i'm going to

75
00:03:44,080 --> 00:03:45,120
introduce you

76
00:03:45,120 --> 00:03:47,840
several techniques that is popular in

77
00:03:47,840 --> 00:03:49,280
advance

78
00:03:49,280 --> 00:03:53,599
penetration before diving into each

79
00:03:53,599 --> 00:03:54,319
technique

80
00:03:54,319 --> 00:03:58,159
let's have an overview of windows 80

81
00:03:58,159 --> 00:04:01,040
authentication mechanism the left top

82
00:04:01,040 --> 00:04:02,239
the left part

83
00:04:02,239 --> 00:04:06,159
llsa stands for local security authority

84
00:04:06,159 --> 00:04:09,760
is the core component of this mechanism

85
00:04:09,760 --> 00:04:13,519
on top of it there are several protocols

86
00:04:13,519 --> 00:04:17,120
such as ntl and ssp kerberos

87
00:04:17,120 --> 00:04:21,199
etc microsoft prepared different

88
00:04:21,199 --> 00:04:24,720
library for each of them all of them

89
00:04:24,720 --> 00:04:28,160
follow the sspi which stands for

90
00:04:28,160 --> 00:04:31,600
security support provider interface

91
00:04:31,600 --> 00:04:35,040
if you follow the interface you can

92
00:04:35,040 --> 00:04:37,600
have your application to communicate

93
00:04:37,600 --> 00:04:39,680
with underlying protocol

94
00:04:39,680 --> 00:04:42,400
here i would like to introduce you

95
00:04:42,400 --> 00:04:43,120
another

96
00:04:43,120 --> 00:04:47,199
um great tool as the name is mimikatz

97
00:04:47,199 --> 00:04:50,160
i believe most of you have heard of it

98
00:04:50,160 --> 00:04:51,120
it's a

99
00:04:51,120 --> 00:04:55,120
it has a library called mimi live

100
00:04:55,120 --> 00:04:59,680
which has most of the presidential dump

101
00:04:59,680 --> 00:05:02,560
techniques implemented inside and most

102
00:05:02,560 --> 00:05:03,759
of

103
00:05:03,759 --> 00:05:06,240
the techniques in this chapter is

104
00:05:06,240 --> 00:05:08,840
implemented

105
00:05:08,840 --> 00:05:12,320
inside mimi live itself can be used to

106
00:05:12,320 --> 00:05:16,160
dunk uh credential in order to do that

107
00:05:16,160 --> 00:05:17,520
the action is simple

108
00:05:17,520 --> 00:05:20,479
just copy mini live idea to windows

109
00:05:20,479 --> 00:05:22,320
system directory

110
00:05:22,320 --> 00:05:25,120
and you just modify the following

111
00:05:25,120 --> 00:05:26,800
registry key

112
00:05:26,800 --> 00:05:29,520
after that you just reboot your computer

113
00:05:29,520 --> 00:05:30,400
and log in

114
00:05:30,400 --> 00:05:34,000
you will find a file kiwi ssp.log being

115
00:05:34,000 --> 00:05:38,320
generated in the system directory

116
00:05:38,320 --> 00:05:41,039
in the uh locked file you will find the

117
00:05:41,039 --> 00:05:42,960
locked credential

118
00:05:42,960 --> 00:05:45,600
in order to detect if you are an

119
00:05:45,600 --> 00:05:47,600
incident response people and you want to

120
00:05:47,600 --> 00:05:48,479
detect this

121
00:05:48,479 --> 00:05:51,680
attack you can check the above mentioned

122
00:05:51,680 --> 00:05:52,639
registry

123
00:05:52,639 --> 00:05:55,120
key to check if there is some suspicious

124
00:05:55,120 --> 00:05:56,960
library being added

125
00:05:56,960 --> 00:05:59,520
or you can also check the process memory

126
00:05:59,520 --> 00:06:01,840
of lsas.exe

127
00:06:01,840 --> 00:06:04,560
to see if there is some suspicious

128
00:06:04,560 --> 00:06:08,319
library being loaded inside

129
00:06:08,319 --> 00:06:11,039
mimi live also supports another kind of

130
00:06:11,039 --> 00:06:12,240
attack

131
00:06:12,240 --> 00:06:16,400
the name is memory ssp it's an

132
00:06:16,400 --> 00:06:20,080
memory injection technique to do that

133
00:06:20,080 --> 00:06:22,400
you just run mimiket and type the

134
00:06:22,400 --> 00:06:23,919
following command

135
00:06:23,919 --> 00:06:26,479
and minicats will inject a geocode into

136
00:06:26,479 --> 00:06:29,000
the process memory of

137
00:06:29,000 --> 00:06:31,840
llsass.exe after that

138
00:06:31,840 --> 00:06:34,960
once someone log in you will find a log

139
00:06:34,960 --> 00:06:35,600
file

140
00:06:35,600 --> 00:06:39,120
mimi lsa unlock being generated in

141
00:06:39,120 --> 00:06:43,120
system directory in the log file you

142
00:06:43,120 --> 00:06:44,240
will find a

143
00:06:44,240 --> 00:06:48,319
locked credential as shown in the photo

144
00:06:48,319 --> 00:06:51,360
if you further address the memory status

145
00:06:51,360 --> 00:06:54,720
before and after the patch you will find

146
00:06:54,720 --> 00:06:55,759
that

147
00:06:55,759 --> 00:06:59,840
mimi catch try to hijack the workflow

148
00:06:59,840 --> 00:07:05,520
to redirect it to the injected geocode

149
00:07:06,479 --> 00:07:08,880
if you want to detect this attack you

150
00:07:08,880 --> 00:07:10,800
can try to

151
00:07:10,800 --> 00:07:16,080
check the process memory of lsas.exe

152
00:07:16,080 --> 00:07:19,919
will find some memory block with rewrite

153
00:07:19,919 --> 00:07:23,120
executable block that has a string

154
00:07:23,120 --> 00:07:26,720
of mimikats inside

155
00:07:27,039 --> 00:07:29,840
the third technique is called skeleton

156
00:07:29,840 --> 00:07:31,120
key attack

157
00:07:31,120 --> 00:07:34,400
this technique was first uncovered by

158
00:07:34,400 --> 00:07:37,919
uh dell secure works in 2015

159
00:07:37,919 --> 00:07:40,720
and it's supposed from windows server

160
00:07:40,720 --> 00:07:45,120
2003 to windows server 2012.

161
00:07:45,120 --> 00:07:48,080
this attack will inject some shell code

162
00:07:48,080 --> 00:07:50,960
into the process memory of lsa

163
00:07:50,960 --> 00:07:56,720
exe to change its uh authentication flow

164
00:07:56,720 --> 00:08:00,319
after this attack uh all the

165
00:08:00,319 --> 00:08:04,000
uh domain user account can be logged in

166
00:08:04,000 --> 00:08:08,319
with an inserted master password

167
00:08:08,319 --> 00:08:11,919
to log into the edit domain at the same

168
00:08:11,919 --> 00:08:12,879
time

169
00:08:12,879 --> 00:08:16,639
all users original credentials can still

170
00:08:16,639 --> 00:08:18,160
work

171
00:08:18,160 --> 00:08:22,000
unfair note that because this attack

172
00:08:22,000 --> 00:08:25,919
rely on memory patch it will fail after

173
00:08:25,919 --> 00:08:27,919
system reboot

174
00:08:27,919 --> 00:08:30,240
if you want to try this attack you can

175
00:08:30,240 --> 00:08:31,919
just wrongly catch and

176
00:08:31,919 --> 00:08:35,760
type the command after that

177
00:08:35,760 --> 00:08:38,080
some geocode will be injected into the

178
00:08:38,080 --> 00:08:39,799
process memory of

179
00:08:39,799 --> 00:08:42,799
lsass.exe and

180
00:08:42,799 --> 00:08:45,839
if the action succeeds you can just use

181
00:08:45,839 --> 00:08:49,200
the password minicats

182
00:08:49,200 --> 00:08:52,320
with any existing 80

183
00:08:52,320 --> 00:08:56,000
accounts to to log in

184
00:08:56,000 --> 00:08:58,240
the photo shows the effect of this

185
00:08:58,240 --> 00:08:59,040
attack

186
00:08:59,040 --> 00:09:02,240
the left photo before this attack

187
00:09:02,240 --> 00:09:05,920
uh if you don't know the uh

188
00:09:05,920 --> 00:09:09,440
accounts password you cannot log into

189
00:09:09,440 --> 00:09:12,720
this id however after this attack

190
00:09:12,720 --> 00:09:15,920
uh you can use the password

191
00:09:15,920 --> 00:09:19,040
mimi catch combined with any existing

192
00:09:19,040 --> 00:09:23,440
ad account to to log in

193
00:09:23,440 --> 00:09:26,160
if you further trust the injection show

194
00:09:26,160 --> 00:09:26,560
code

195
00:09:26,560 --> 00:09:29,600
you will find a block that

196
00:09:29,600 --> 00:09:33,120
concatenates some hash value

197
00:09:33,120 --> 00:09:36,399
the hash value is just the ntlm hash

198
00:09:36,399 --> 00:09:40,320
of the string mimi cats

199
00:09:40,399 --> 00:09:43,200
if you want to detect this type of

200
00:09:43,200 --> 00:09:43,839
attack

201
00:09:43,839 --> 00:09:46,240
first you can still check the process

202
00:09:46,240 --> 00:09:49,040
memory of los access.exe

203
00:09:49,040 --> 00:09:51,680
since it still relies on memory

204
00:09:51,680 --> 00:09:53,040
injection

205
00:09:53,040 --> 00:09:57,360
or you can also check windows event log

206
00:09:57,360 --> 00:10:00,640
as i mentioned the this attack

207
00:10:00,640 --> 00:10:03,760
failed after system reboot so the

208
00:10:03,760 --> 00:10:07,120
related malware usually registers itself

209
00:10:07,120 --> 00:10:07,440
as

210
00:10:07,440 --> 00:10:11,440
a system system service so the following

211
00:10:11,440 --> 00:10:15,279
system uh log a combination

212
00:10:15,279 --> 00:10:19,120
is related some uh secure privilege

213
00:10:19,120 --> 00:10:22,160
service being executed then you can

214
00:10:22,160 --> 00:10:22,560
check

215
00:10:22,560 --> 00:10:27,199
to find a related attack

216
00:10:27,760 --> 00:10:30,839
the next uh technique is called w

217
00:10:30,839 --> 00:10:33,920
digest w digest is a

218
00:10:33,920 --> 00:10:37,040
windows authentication mechanism uh

219
00:10:37,040 --> 00:10:40,320
it cases a clear text password

220
00:10:40,320 --> 00:10:43,440
in memory for later authentication

221
00:10:43,440 --> 00:10:47,040
actions this feature was abused by

222
00:10:47,040 --> 00:10:48,880
various trade actors

223
00:10:48,880 --> 00:10:52,959
to uh dump clear text passwords on

224
00:10:52,959 --> 00:10:55,600
memory directory in the past

225
00:10:55,600 --> 00:10:58,640
microsoft noticed this issue so they

226
00:10:58,640 --> 00:11:03,399
issued the security page

227
00:11:03,399 --> 00:11:05,040
kb2871997

228
00:11:05,040 --> 00:11:08,240
to disable this feature after

229
00:11:08,240 --> 00:11:11,120
the security patch you can set the

230
00:11:11,120 --> 00:11:12,959
following registry key

231
00:11:12,959 --> 00:11:16,000
to disable this feature the following

232
00:11:16,000 --> 00:11:16,560
photo

233
00:11:16,560 --> 00:11:19,680
shows the effect of

234
00:11:19,680 --> 00:11:22,800
this registry key in different windows

235
00:11:22,800 --> 00:11:25,360
platform

236
00:11:25,360 --> 00:11:27,760
the photo shows the effects of this

237
00:11:27,760 --> 00:11:28,640
attack

238
00:11:28,640 --> 00:11:31,760
the left photo before applying

239
00:11:31,760 --> 00:11:35,040
this security page you can see clear

240
00:11:35,040 --> 00:11:38,720
text credential in memory

241
00:11:38,720 --> 00:11:40,880
after applying the security patch you

242
00:11:40,880 --> 00:11:42,320
can no longer see the

243
00:11:42,320 --> 00:11:47,279
uh locked cached creature anymore

244
00:11:47,440 --> 00:11:50,240
in the operation i'm term the actor

245
00:11:50,240 --> 00:11:52,240
relied this attack

246
00:11:52,240 --> 00:11:55,279
several times and we detect and block

247
00:11:55,279 --> 00:11:56,560
their actions

248
00:11:56,560 --> 00:12:00,240
in the end the actors got angry so they

249
00:12:00,240 --> 00:12:03,600
use some good policy to disable

250
00:12:03,600 --> 00:12:07,839
us from uh access the

251
00:12:07,839 --> 00:12:10,639
above mentioned registry key in an

252
00:12:10,639 --> 00:12:11,519
attempt to

253
00:12:11,519 --> 00:12:16,399
stop us from disabling this feature

254
00:12:17,360 --> 00:12:20,320
if you want to detect this attack you

255
00:12:20,320 --> 00:12:20,720
can

256
00:12:20,720 --> 00:12:25,680
check the following event log id

257
00:12:25,680 --> 00:12:28,720
for in a domain controller you can check

258
00:12:28,720 --> 00:12:31,680
event id 4776

259
00:12:31,680 --> 00:12:34,880
that is related to a w digest

260
00:12:34,880 --> 00:12:36,720
authentication package

261
00:12:36,720 --> 00:12:40,399
or in every server in

262
00:12:40,399 --> 00:12:43,000
this ad document you can check event id

263
00:12:43,000 --> 00:12:44,720
4624

264
00:12:44,720 --> 00:12:49,360
that is related to w digest

265
00:12:49,760 --> 00:12:51,680
in the operation i'm term the three

266
00:12:51,680 --> 00:12:52,800
actors use

267
00:12:52,800 --> 00:12:56,320
mimikats a lot and got detected by us

268
00:12:56,320 --> 00:12:59,279
so they try different means to bypass

269
00:12:59,279 --> 00:13:00,160
the detection

270
00:13:00,160 --> 00:13:03,680
for example they uh apply some vm

271
00:13:03,680 --> 00:13:06,560
protect packer or sort it as a

272
00:13:06,560 --> 00:13:12,320
some security scanner product

273
00:13:12,320 --> 00:13:14,639
in the end we realized that all the

274
00:13:14,639 --> 00:13:15,519
techniques they

275
00:13:15,519 --> 00:13:20,800
utilized was discussed widely in some

276
00:13:20,800 --> 00:13:24,079
chinese hacking forwards

277
00:13:24,079 --> 00:13:27,200
the last attack is called ntds.dit

278
00:13:27,200 --> 00:13:30,399
in and stand along window host the

279
00:13:30,399 --> 00:13:32,880
windows password is stored in after

280
00:13:32,880 --> 00:13:34,079
hatching

281
00:13:34,079 --> 00:13:37,120
in the following registry keys

282
00:13:37,120 --> 00:13:40,240
in the 80 domain case password is stored

283
00:13:40,240 --> 00:13:43,000
in the assistant directory

284
00:13:43,000 --> 00:13:47,760
ntds.dit file and hklm system registry

285
00:13:47,760 --> 00:13:50,880
if you want to dump the hash value

286
00:13:50,880 --> 00:13:54,079
you can take a snapshot of the file by

287
00:13:54,079 --> 00:13:55,279
using ntds

288
00:13:55,279 --> 00:13:58,320
utility and after that you can copy the

289
00:13:58,320 --> 00:14:01,360
tds dit file and

290
00:14:01,360 --> 00:14:05,040
registry key hklm system after that

291
00:14:05,040 --> 00:14:08,320
you can use ntds thumb ex tool to get

292
00:14:08,320 --> 00:14:12,000
all users password hashes

293
00:14:12,000 --> 00:14:14,399
if you want to detect this attack you

294
00:14:14,399 --> 00:14:15,040
can check

295
00:14:15,040 --> 00:14:18,160
the following windows event lock because

296
00:14:18,160 --> 00:14:22,240
dunk pin the taking snapshot

297
00:14:22,240 --> 00:14:25,440
is will cause a

298
00:14:25,440 --> 00:14:29,040
volume shadow copy service and

299
00:14:29,040 --> 00:14:31,680
following event lock is related to this

300
00:14:31,680 --> 00:14:33,199
service

301
00:14:33,199 --> 00:14:36,880
so to summarize this section remember to

302
00:14:36,880 --> 00:14:40,000
remove our limit access to windows share

303
00:14:40,000 --> 00:14:43,600
also disable the remote registry service

304
00:14:43,600 --> 00:14:47,519
and since most attacks is

305
00:14:47,519 --> 00:14:50,800
abusing zero injection remember to

306
00:14:50,800 --> 00:14:53,839
limit your uh user account to have the

307
00:14:53,839 --> 00:14:56,000
se debug privilege

308
00:14:56,000 --> 00:14:59,519
and protect the alloys as memory process

309
00:14:59,519 --> 00:15:03,839
well let's in protect user group

310
00:15:03,839 --> 00:15:06,959
if ntlm is not used remember to use

311
00:15:06,959 --> 00:15:10,000
kerberos or third-party ssp and have

312
00:15:10,000 --> 00:15:10,480
your

313
00:15:10,480 --> 00:15:13,279
kerberos ticket have a shorter lifespan

314
00:15:13,279 --> 00:15:14,480
as possible

315
00:15:14,480 --> 00:15:19,760
last don't cache your windows digest

316
00:15:19,839 --> 00:15:22,480
and next part will go to application

317
00:15:22,480 --> 00:15:23,839
level host

318
00:15:23,839 --> 00:15:26,880
in application level host actor usually

319
00:15:26,880 --> 00:15:27,199
use

320
00:15:27,199 --> 00:15:30,320
web show to conduct the

321
00:15:30,320 --> 00:15:33,440
natural movement first

322
00:15:33,440 --> 00:15:36,800
i will introduce the is module

323
00:15:36,800 --> 00:15:40,639
a native is module is a windows dl file

324
00:15:40,639 --> 00:15:44,959
that can extend the is

325
00:15:44,959 --> 00:15:48,480
and for some desired functionalities

326
00:15:48,480 --> 00:15:51,839
the first is module of use was found

327
00:15:51,839 --> 00:15:56,000
in 2018 uh is module vector

328
00:15:56,000 --> 00:15:59,279
rjdoll called uh ajidor

329
00:15:59,279 --> 00:16:02,959
uh used by apt34 and we saw

330
00:16:02,959 --> 00:16:06,639
uh many actors abused this is module

331
00:16:06,639 --> 00:16:11,759
uh to conduct a

332
00:16:14,000 --> 00:16:17,519
particular function of then

333
00:16:17,519 --> 00:16:20,560
and the is module process is

334
00:16:20,560 --> 00:16:24,160
under the w3wp.exe

335
00:16:24,160 --> 00:16:27,279
and there is an open source plc project

336
00:16:27,279 --> 00:16:28,320
of the is

337
00:16:28,320 --> 00:16:32,240
vector called is raid it can be

338
00:16:32,240 --> 00:16:36,320
easy to install via abb c and d

339
00:16:36,320 --> 00:16:39,360
is right can not only execute command

340
00:16:39,360 --> 00:16:42,480
but also can inject shellcode or

341
00:16:42,480 --> 00:16:46,160
extra password from the web

342
00:16:46,160 --> 00:16:48,959
and if you install the is rate you can

343
00:16:48,959 --> 00:16:51,279
use apbc and d in command line

344
00:16:51,279 --> 00:16:54,480
or use ies manager in gi mode

345
00:16:54,480 --> 00:16:58,959
to list as module in your server

346
00:16:58,959 --> 00:17:02,399
and if you use the ih is manager

347
00:17:02,399 --> 00:17:05,520
you can see of the suit paste in

348
00:17:05,520 --> 00:17:10,720
the gui mode of the dl file

349
00:17:10,799 --> 00:17:15,199
and if you uh run some system command

350
00:17:15,199 --> 00:17:18,880
by the ice raid you can

351
00:17:18,880 --> 00:17:22,959
see your command in the traffic

352
00:17:22,959 --> 00:17:26,079
in extron x chrome variations and you

353
00:17:26,079 --> 00:17:27,839
can see your x

354
00:17:27,839 --> 00:17:30,880
password in x password section

355
00:17:30,880 --> 00:17:34,000
we also see some actors use back 64

356
00:17:34,000 --> 00:17:38,880
to encode their command in the traffic

357
00:17:39,280 --> 00:17:42,160
and here is some precautions for is

358
00:17:42,160 --> 00:17:43,679
module attack

359
00:17:43,679 --> 00:17:46,080
first you can use apbc and d command

360
00:17:46,080 --> 00:17:46,880
line tool

361
00:17:46,880 --> 00:17:49,919
and also use is manager to list

362
00:17:49,919 --> 00:17:52,960
your module in your i server and second

363
00:17:52,960 --> 00:17:55,760
you can search for the existing of x

364
00:17:55,760 --> 00:17:56,720
password or

365
00:17:56,720 --> 00:17:58,840
x chrome variations headers in your

366
00:17:58,840 --> 00:18:01,280
traffic

367
00:18:01,280 --> 00:18:03,520
and here is the scene that everyone

368
00:18:03,520 --> 00:18:05,440
often ignores

369
00:18:05,440 --> 00:18:08,880
the default privilege in exchange server

370
00:18:08,880 --> 00:18:12,000
is local system is local system

371
00:18:12,000 --> 00:18:16,000
so if the actor can access your

372
00:18:16,000 --> 00:18:19,600
exchange server they can do everything

373
00:18:19,600 --> 00:18:24,400
and they want and from this picture

374
00:18:24,400 --> 00:18:27,360
we can see that the default permission

375
00:18:27,360 --> 00:18:28,320
in is

376
00:18:28,320 --> 00:18:31,840
is the fpb pool and in exchange server

377
00:18:31,840 --> 00:18:34,880
is system so if the web shop

378
00:18:34,880 --> 00:18:37,360
or the malware is located in the

379
00:18:37,360 --> 00:18:39,760
exchange server

380
00:18:39,760 --> 00:18:43,280
uh an actor can use them

381
00:18:43,280 --> 00:18:46,320
very uh smoothly and can make their

382
00:18:46,320 --> 00:18:49,360
attack more easily

383
00:18:49,440 --> 00:18:51,840
and here we want to share a modified

384
00:18:51,840 --> 00:18:53,440
source called web show attack

385
00:18:53,440 --> 00:18:57,200
uh target on the exchange system

386
00:18:57,200 --> 00:19:00,799
from one of our clients the exchange

387
00:19:00,799 --> 00:19:03,919
system is for single scion

388
00:19:03,919 --> 00:19:06,720
and the actor didn't put any malware or

389
00:19:06,720 --> 00:19:08,799
web show in the server

390
00:19:08,799 --> 00:19:12,080
they just modify some existing files

391
00:19:12,080 --> 00:19:13,120
source code

392
00:19:13,120 --> 00:19:16,000
to concatenate them to achieve the

393
00:19:16,000 --> 00:19:18,880
function of the web shell

394
00:19:18,880 --> 00:19:21,440
and the picture of the website is the

395
00:19:21,440 --> 00:19:24,600
source code of the javascript of the

396
00:19:24,600 --> 00:19:28,320
logan.spx and the picture on the right

397
00:19:28,320 --> 00:19:31,440
is the modify code now we can see

398
00:19:31,440 --> 00:19:35,120
the code can log username and

399
00:19:35,120 --> 00:19:38,640
password and post then to

400
00:19:38,640 --> 00:19:44,640
uh one http server and arrow fv.spx

401
00:19:44,640 --> 00:19:47,039
and the picture on the left side is the

402
00:19:47,039 --> 00:19:47,919
arrow

403
00:19:47,919 --> 00:19:51,679
so call of the arrow fe spx and the

404
00:19:51,679 --> 00:19:54,720
right side is the modified code

405
00:19:54,720 --> 00:19:58,000
the modify code is the hyper shell

406
00:19:58,000 --> 00:20:02,320
the hype shield uh no no no

407
00:20:02,320 --> 00:20:06,400
the modify code is to uh load

408
00:20:06,400 --> 00:20:09,760
log log username and password to

409
00:20:09,760 --> 00:20:14,240
save them to the debug directory

410
00:20:15,120 --> 00:20:18,960
and uh actually can log most users

411
00:20:18,960 --> 00:20:22,080
password and username

412
00:20:22,080 --> 00:20:25,360
in plain text and then they can use the

413
00:20:25,360 --> 00:20:28,480
password to look on the organization's

414
00:20:28,480 --> 00:20:29,280
vpn

415
00:20:29,280 --> 00:20:34,000
and they can use their internal system

416
00:20:34,000 --> 00:20:36,320
and in this part we are going to

417
00:20:36,320 --> 00:20:37,679
introduce the hyper shell

418
00:20:37,679 --> 00:20:40,159
hypershow is also a modified source

419
00:20:40,159 --> 00:20:41,520
called show code

420
00:20:41,520 --> 00:20:45,360
it add the malicious code into

421
00:20:45,360 --> 00:20:48,640
expire password.spx which is

422
00:20:48,640 --> 00:20:50,880
resetting the password in exchange

423
00:20:50,880 --> 00:20:52,559
system

424
00:20:52,559 --> 00:20:55,720
and this tool uh was first used by apd

425
00:20:55,720 --> 00:20:58,720
34 but it leaked on telegram

426
00:20:58,720 --> 00:21:02,799
on 2018

427
00:21:02,799 --> 00:21:05,280
and the picture on the left side is the

428
00:21:05,280 --> 00:21:08,000
source code of the expired password.spx

429
00:21:08,000 --> 00:21:11,280
and the right side is the hypershell

430
00:21:11,280 --> 00:21:14,159
the hamstring is a complete function web

431
00:21:14,159 --> 00:21:14,880
show

432
00:21:14,880 --> 00:21:18,159
and you can just use

433
00:21:18,159 --> 00:21:21,360
curl and username and password

434
00:21:21,360 --> 00:21:24,320
and connect it

435
00:21:24,400 --> 00:21:27,600
and here is some precautions for the

436
00:21:27,600 --> 00:21:30,640
modified source attack first

437
00:21:30,640 --> 00:21:34,159
you can modify the directory permissions

438
00:21:34,159 --> 00:21:37,200
or you can use some file check technique

439
00:21:37,200 --> 00:21:41,760
like some file numbers or file h

440
00:21:41,760 --> 00:21:44,640
microsoft also have a tool called file

441
00:21:44,640 --> 00:21:45,200
checksum

442
00:21:45,200 --> 00:21:48,240
integrity verifier it can help us to

443
00:21:48,240 --> 00:21:48,799
check

444
00:21:48,799 --> 00:21:52,159
uh the md file of all files in

445
00:21:52,159 --> 00:21:55,200
one folder to check if there any

446
00:21:55,200 --> 00:21:58,799
files have been modified

447
00:21:58,799 --> 00:22:01,919
and there is a mechanism that can

448
00:22:01,919 --> 00:22:04,559
help for insulin response with the web

449
00:22:04,559 --> 00:22:05,679
show

450
00:22:05,679 --> 00:22:09,919
and when xpx file was first accessed

451
00:22:09,919 --> 00:22:12,799
the cxc.exe will compile it and will

452
00:22:12,799 --> 00:22:15,280
generate a compile dlch file

453
00:22:15,280 --> 00:22:18,559
in the hambury folder

454
00:22:18,559 --> 00:22:22,480
so if we want to know uh when is the web

455
00:22:22,480 --> 00:22:23,120
show

456
00:22:23,120 --> 00:22:26,159
first the access and we can see the file

457
00:22:26,159 --> 00:22:28,320
create time of the compiled in our cache

458
00:22:28,320 --> 00:22:30,480
file

459
00:22:30,480 --> 00:22:34,080
and along with the is log

460
00:22:34,080 --> 00:22:38,840
we may figure out how actually put the

461
00:22:38,840 --> 00:22:40,000
webshop

462
00:22:40,000 --> 00:22:43,679
and microsoft uh have some anti-virus

463
00:22:43,679 --> 00:22:44,240
widely

464
00:22:44,240 --> 00:22:47,280
suggest an exchange server and you can

465
00:22:47,280 --> 00:22:48,320
see the core list

466
00:22:48,320 --> 00:22:51,919
on their website the

467
00:22:51,919 --> 00:22:55,120
actor can take advantage of these

468
00:22:55,120 --> 00:22:57,520
suggestions suggestions and make their

469
00:22:57,520 --> 00:22:59,919
attack easier

470
00:22:59,919 --> 00:23:02,640
the wireless include mailbox servers

471
00:23:02,640 --> 00:23:06,640
client asset server like web components

472
00:23:06,640 --> 00:23:10,080
within the actor knew it so we

473
00:23:10,080 --> 00:23:13,520
found they often put their web show

474
00:23:13,520 --> 00:23:16,080
on malware in this white list

475
00:23:16,080 --> 00:23:18,799
directories

476
00:23:18,880 --> 00:23:22,320
so we suggest that you can check

477
00:23:22,320 --> 00:23:25,360
the this wireless folder

478
00:23:25,360 --> 00:23:29,678
first during the insert response

479
00:23:29,919 --> 00:23:33,760
so this is the register for the

480
00:23:33,760 --> 00:23:37,120
anti-virus wireless setting and we can

481
00:23:37,120 --> 00:23:37,520
see

482
00:23:37,520 --> 00:23:40,000
the no scan directory include web

483
00:23:40,000 --> 00:23:42,559
components

484
00:23:44,960 --> 00:23:48,080
the desiration attack was a trump card

485
00:23:48,080 --> 00:23:51,200
for ft groups in this year

486
00:23:51,200 --> 00:23:55,600
uh as long as cbe 2020 0

487
00:23:55,600 --> 00:23:59,200
688 there are many uh deceleration

488
00:23:59,200 --> 00:24:00,159
attacks

489
00:24:00,159 --> 00:24:04,320
on it can be used

490
00:24:04,320 --> 00:24:07,039
and today we are going to share the

491
00:24:07,039 --> 00:24:08,400
desiration of tech

492
00:24:08,400 --> 00:24:11,679
and donate view state the navy state is

493
00:24:11,679 --> 00:24:13,279
an object uh

494
00:24:13,279 --> 00:24:15,520
placed between client servers that store

495
00:24:15,520 --> 00:24:18,880
both user submit and application info

496
00:24:18,880 --> 00:24:21,440
it is protected by hmac and is

497
00:24:21,440 --> 00:24:23,279
serialized by loss formatted and

498
00:24:23,279 --> 00:24:26,640
deserialized by object formatter

499
00:24:26,640 --> 00:24:28,720
open source to a white source serial.net

500
00:24:28,720 --> 00:24:32,400
supports object state momentum

501
00:24:32,400 --> 00:24:34,960
a machine key is a key component for the

502
00:24:34,960 --> 00:24:37,039
build stick

503
00:24:37,039 --> 00:24:39,279
and in low balance environment

504
00:24:39,279 --> 00:24:41,600
environment

505
00:24:41,600 --> 00:24:45,760
the machine key may be auto generated

506
00:24:45,760 --> 00:24:50,080
and hardcoded in is approved

507
00:24:50,080 --> 00:24:52,080
and the machine key is stored in the

508
00:24:52,080 --> 00:24:53,679
file web.config

509
00:24:53,679 --> 00:24:57,679
file so

510
00:24:58,240 --> 00:25:02,159
in some consequences

511
00:25:02,159 --> 00:25:05,440
if you got a web config file

512
00:25:05,440 --> 00:25:09,919
in the world like some uh outsource

513
00:25:09,919 --> 00:25:13,039
software vendor can accidentally

514
00:25:13,039 --> 00:25:15,840
put their framework on github an actor

515
00:25:15,840 --> 00:25:16,320
can

516
00:25:16,320 --> 00:25:18,240
use this web config to generate a

517
00:25:18,240 --> 00:25:19,840
malicious payload

518
00:25:19,840 --> 00:25:23,440
and here's the exploration page

519
00:25:23,440 --> 00:25:26,720
first you must get a machine key and

520
00:25:26,720 --> 00:25:29,520
you can use visual serial.net to

521
00:25:29,520 --> 00:25:31,520
generate a monitor's payload

522
00:25:31,520 --> 00:25:33,840
and submit parallel as a real state and

523
00:25:33,840 --> 00:25:34,880
server will

524
00:25:34,880 --> 00:25:38,080
already actually make and destroy

525
00:25:38,080 --> 00:25:41,840
deserialize the malicious payload

526
00:25:41,840 --> 00:25:45,760
the picture on the uh upside you can see

527
00:25:45,760 --> 00:25:49,440
the digitization attack in the bus suite

528
00:25:49,440 --> 00:25:53,120
it will uh generate a post request

529
00:25:53,120 --> 00:25:55,679
and the payload will send us a view

530
00:25:55,679 --> 00:25:56,799
state

531
00:25:56,799 --> 00:26:02,000
and the picture below is the is log

532
00:26:02,000 --> 00:26:05,760
from one victim host and you can see

533
00:26:05,760 --> 00:26:08,880
it will adjust a post with a slash

534
00:26:08,880 --> 00:26:12,320
it cannot give us more

535
00:26:12,320 --> 00:26:15,679
information so i spent

536
00:26:15,679 --> 00:26:19,039
two about two hours to identify these

537
00:26:19,039 --> 00:26:22,840
visual examination attacks in the first

538
00:26:22,840 --> 00:26:24,320
incident

539
00:26:24,320 --> 00:26:26,880
and here's the precautions of the

540
00:26:26,880 --> 00:26:27,679
israelite

541
00:26:27,679 --> 00:26:30,480
attack please review your open source

542
00:26:30,480 --> 00:26:32,159
projects for default keys

543
00:26:32,159 --> 00:26:33,919
and if your web server is ever

544
00:26:33,919 --> 00:26:35,760
compromised or has a thyroid and

545
00:26:35,760 --> 00:26:36,799
satellite flow

546
00:26:36,799 --> 00:26:39,200
please regenerate your keys to say to

547
00:26:39,200 --> 00:26:40,880
auto generate

548
00:26:40,880 --> 00:26:44,880
or if possible encrypt the machine key

549
00:26:44,880 --> 00:26:48,720
and last we will introduce a web-based

550
00:26:48,720 --> 00:26:51,919
mobile called tv show tv show is a

551
00:26:51,919 --> 00:26:54,240
backdoor based on http api

552
00:26:54,240 --> 00:26:56,960
after it is executed it will use windows

553
00:26:56,960 --> 00:26:57,600
http

554
00:26:57,600 --> 00:27:00,159
server api to open an http server

555
00:27:00,159 --> 00:27:01,600
service and register

556
00:27:01,600 --> 00:27:04,880
specific ui for extern to control

557
00:27:04,880 --> 00:27:07,120
it is a backdoor for less and poor and

558
00:27:07,120 --> 00:27:09,279
complete function

559
00:27:09,279 --> 00:27:11,440
tv show often used via hydraulic

560
00:27:11,440 --> 00:27:13,360
technique and enjoy process

561
00:27:13,360 --> 00:27:16,159
inject the payload process and register

562
00:27:16,159 --> 00:27:18,720
a specific url for

563
00:27:18,720 --> 00:27:21,440
actors actor to access the tv show

564
00:27:21,440 --> 00:27:22,399
controller

565
00:27:22,399 --> 00:27:25,760
victim host tv show is constantly

566
00:27:25,760 --> 00:27:27,200
evolving

567
00:27:27,200 --> 00:27:31,200
now recently we observed tv show 3.0

568
00:27:31,200 --> 00:27:34,399
version and thus part we will share some

569
00:27:34,399 --> 00:27:38,159
miscellaneous techniques by the action

570
00:27:38,159 --> 00:27:40,960
in natural movement there is a a trivial

571
00:27:40,960 --> 00:27:43,120
but effective technique

572
00:27:43,120 --> 00:27:47,439
is called sticky bacteria

573
00:27:47,600 --> 00:27:50,559
uh it can be triggered by our press the

574
00:27:50,559 --> 00:27:51,200
ship

575
00:27:51,200 --> 00:27:54,960
five times in operation i'm done

576
00:27:54,960 --> 00:27:58,000
we find the sticky back door on

577
00:27:58,000 --> 00:28:01,520
almost windows host because the vector

578
00:28:01,520 --> 00:28:02,000
is not

579
00:28:02,000 --> 00:28:05,919
a real malware so the antivirus software

580
00:28:05,919 --> 00:28:09,200
may not be alert by this attack

581
00:28:09,200 --> 00:28:11,840
and here we want to share a kaiser trap

582
00:28:11,840 --> 00:28:14,559
by the actor

583
00:28:15,200 --> 00:28:17,600
in absolution and time we can see actual

584
00:28:17,600 --> 00:28:19,279
access web in the web show

585
00:28:19,279 --> 00:28:21,200
and we can see the delete record of the

586
00:28:21,200 --> 00:28:23,360
web show in the event log

587
00:28:23,360 --> 00:28:25,919
and the routine latest two or three

588
00:28:25,919 --> 00:28:26,399
times

589
00:28:26,399 --> 00:28:29,760
but one day we can see we can only see

590
00:28:29,760 --> 00:28:30,559
our x

591
00:28:30,559 --> 00:28:32,799
actor access the web show but we can see

592
00:28:32,799 --> 00:28:36,639
the delete record in the event log

593
00:28:36,720 --> 00:28:39,039
at first we think the web show may be

594
00:28:39,039 --> 00:28:40,159
deleted

595
00:28:40,159 --> 00:28:43,120
but we still feel strange so we conduct

596
00:28:43,120 --> 00:28:43,600
a

597
00:28:43,600 --> 00:28:46,559
more in-depth investigation and that's

598
00:28:46,559 --> 00:28:49,120
we found the kaizo chat

599
00:28:49,120 --> 00:28:51,520
the actor used the rookie called the

600
00:28:51,520 --> 00:28:54,159
easy file locker to hide the

601
00:28:54,159 --> 00:28:57,360
uh the folder of the web show so we can

602
00:28:57,360 --> 00:29:02,559
see any file in the under this folder

603
00:29:02,559 --> 00:29:05,120
uh the picture on the left and up is the

604
00:29:05,120 --> 00:29:06,880
component of the easy file log

605
00:29:06,880 --> 00:29:08,799
and the picture on the right is the

606
00:29:08,799 --> 00:29:10,799
driver of the

607
00:29:10,799 --> 00:29:14,320
easy file locker in registry

608
00:29:14,320 --> 00:29:16,880
the easy file lock is a nice scroll to

609
00:29:16,880 --> 00:29:17,679
generate

610
00:29:17,679 --> 00:29:20,960
folders and uh files

611
00:29:20,960 --> 00:29:23,919
uh if it is used properly and it only

612
00:29:23,919 --> 00:29:24,240
have

613
00:29:24,240 --> 00:29:26,559
one detection rate in virus total so it

614
00:29:26,559 --> 00:29:28,240
is hard to detect

615
00:29:28,240 --> 00:29:31,120
and finally we want to share a mechanism

616
00:29:31,120 --> 00:29:31,600
that

617
00:29:31,600 --> 00:29:34,960
actor will take advantage of

618
00:29:34,960 --> 00:29:38,159
if you use fpvcnd to save virtual

619
00:29:38,159 --> 00:29:38,960
directory

620
00:29:38,960 --> 00:29:42,640
and you can access the file just

621
00:29:42,640 --> 00:29:45,279
use the file path as a ui in your

622
00:29:45,279 --> 00:29:46,080
browser

623
00:29:46,080 --> 00:29:49,600
so in this tech attack actually

624
00:29:49,600 --> 00:29:52,640
do not need to install any

625
00:29:52,640 --> 00:29:56,640
mower or hacking tools he can

626
00:29:56,640 --> 00:29:59,760
access the files just use

627
00:29:59,760 --> 00:30:02,960
this technique and here's our

628
00:30:02,960 --> 00:30:06,080
our conclusions active directory attack

629
00:30:06,080 --> 00:30:06,480
is an

630
00:30:06,480 --> 00:30:08,880
indispensable part of lecture movement

631
00:30:08,880 --> 00:30:11,039
we must pay attention to preventing

632
00:30:11,039 --> 00:30:14,000
adron's attack in natural movement

633
00:30:14,000 --> 00:30:15,520
actually use less mower

634
00:30:15,520 --> 00:30:17,840
they begin to use some legal tools or

635
00:30:17,840 --> 00:30:19,200
abuse the

636
00:30:19,200 --> 00:30:21,360
original windows mechanism to achieve

637
00:30:21,360 --> 00:30:22,640
their goals

638
00:30:22,640 --> 00:30:25,919
and here is our our talk today

639
00:30:25,919 --> 00:30:29,360
thank you everyone

