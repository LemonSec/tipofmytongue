1
00:00:02,320 --> 00:00:04,160
okay so hey guys thanks for watching the

2
00:00:04,160 --> 00:00:05,040
meeting

3
00:00:05,040 --> 00:00:08,240
this presentation is cool that's my

4
00:00:08,240 --> 00:00:10,559
first testing experience so let's get

5
00:00:10,559 --> 00:00:11,920
started

6
00:00:11,920 --> 00:00:13,679
okay before the talk there's a

7
00:00:13,679 --> 00:00:15,360
disclaimer on and everything in the

8
00:00:15,360 --> 00:00:16,800
following slides were responsibly

9
00:00:16,800 --> 00:00:18,640
disclosed to the concerned authorities

10
00:00:18,640 --> 00:00:19,920
and they have fixed the network for the

11
00:00:19,920 --> 00:00:20,800
same

12
00:00:20,800 --> 00:00:22,640
the speaker intends know-how to any kind

13
00:00:22,640 --> 00:00:24,960
of individual or organization in the

14
00:00:24,960 --> 00:00:26,480
following course of action

15
00:00:26,480 --> 00:00:28,080
the following course of action could be

16
00:00:28,080 --> 00:00:30,400
could land into jail unless you reported

17
00:00:30,400 --> 00:00:31,840
it responsibility to the concerned

18
00:00:31,840 --> 00:00:33,040
authorities

19
00:00:33,040 --> 00:00:34,559
the speaker is strictly against any

20
00:00:34,559 --> 00:00:37,200
illegal hack and if they if they did not

21
00:00:37,200 --> 00:00:38,960
pass this figure then they would never

22
00:00:38,960 --> 00:00:40,239
disclose a public

23
00:00:40,239 --> 00:00:42,239
intercourse at all

24
00:00:42,239 --> 00:00:45,039
who am i i'm avenix a second-year pc

25
00:00:45,039 --> 00:00:46,399
undergraduate student

26
00:00:46,399 --> 00:00:48,079
i'm 20 years old and i have around two

27
00:00:48,079 --> 00:00:50,079
to three experience in this industry

28
00:00:50,079 --> 00:00:52,000
i mostly do lab environments like hack

29
00:00:52,000 --> 00:00:54,160
the box try hacking etc in my free

30
00:00:54,160 --> 00:00:55,680
training and sometimes participate in

31
00:00:55,680 --> 00:00:57,199
ctas

32
00:00:57,199 --> 00:00:58,559
currently the coordinator of the cyber

33
00:00:58,559 --> 00:01:00,800
security club of our college

34
00:01:00,800 --> 00:01:03,120
and also the chapter foundation

35
00:01:03,120 --> 00:01:04,479
chapter is the same

36
00:01:04,479 --> 00:01:06,640
and in this talk we'll be dealing with

37
00:01:06,640 --> 00:01:08,159
some of the internal testing of the

38
00:01:08,159 --> 00:01:10,080
network

39
00:01:10,080 --> 00:01:10,799
so

40
00:01:10,799 --> 00:01:12,240
what's the motivation for the mental

41
00:01:12,240 --> 00:01:14,159
test now when the idea of an internal

42
00:01:14,159 --> 00:01:16,320
test came to my mind i knew it would be

43
00:01:16,320 --> 00:01:18,159
rather low impact

44
00:01:18,159 --> 00:01:20,960
and i was wondering about the use cases

45
00:01:20,960 --> 00:01:22,720
but then an idea

46
00:01:22,720 --> 00:01:25,280
what if an internal stuff goes wrong and

47
00:01:25,280 --> 00:01:27,600
apparently this just had happened quite

48
00:01:27,600 --> 00:01:29,520
a lot in this industry and one such

49
00:01:29,520 --> 00:01:31,119
example is right here

50
00:01:31,119 --> 00:01:33,200
this is the screenshot from the leftist

51
00:01:33,200 --> 00:01:35,920
dollar runs on the group telegram now in

52
00:01:35,920 --> 00:01:38,640
this the leftist dollar johnson group is

53
00:01:38,640 --> 00:01:40,799
demanding to recruit employees slash

54
00:01:40,799 --> 00:01:43,200
insiders in the following companies

55
00:01:43,200 --> 00:01:44,720
the note is that they are not looking

56
00:01:44,720 --> 00:01:46,240
for data or

57
00:01:46,240 --> 00:01:48,159
or any kind of employee they just need

58
00:01:48,159 --> 00:01:50,720
some kind of vpn or citric access now

59
00:01:50,720 --> 00:01:52,479
this is one of the examples

60
00:01:52,479 --> 00:01:54,960
when a internal staff tend to grow

61
00:01:54,960 --> 00:01:56,159
and that's the motivation for the

62
00:01:56,159 --> 00:01:57,680
internal test

63
00:01:57,680 --> 00:02:00,000
now universities now they are a pretty

64
00:02:00,000 --> 00:02:01,280
big relationship right and they're

65
00:02:01,280 --> 00:02:03,600
pretty tough to have as a whole

66
00:02:03,600 --> 00:02:06,320
now let's consider our universities

67
00:02:06,320 --> 00:02:08,318
they had two domains say domain a and

68
00:02:08,318 --> 00:02:09,520
domain b

69
00:02:09,520 --> 00:02:11,360
most of the public facing stuff like the

70
00:02:11,360 --> 00:02:13,760
website the mail servers

71
00:02:13,760 --> 00:02:14,640
the

72
00:02:14,640 --> 00:02:16,800
uh various other kind of servers but in

73
00:02:16,800 --> 00:02:19,280
domain 8 and most internet facing stuff

74
00:02:19,280 --> 00:02:21,760
like the student laptops the faculty

75
00:02:21,760 --> 00:02:24,800
computers the app computers etc this vpn

76
00:02:24,800 --> 00:02:27,200
servers we're all in domain b

77
00:02:27,200 --> 00:02:28,080
okay

78
00:02:28,080 --> 00:02:30,000
and on college or we have obviously has

79
00:02:30,000 --> 00:02:31,760
like multiple ships right

80
00:02:31,760 --> 00:02:34,000
now our college had around six eight

81
00:02:34,000 --> 00:02:35,920
three five users and one zero two three

82
00:02:35,920 --> 00:02:38,239
computers in domain b

83
00:02:38,239 --> 00:02:39,760
they could be more in domain a but

84
00:02:39,760 --> 00:02:42,959
that's only for domain b

85
00:02:43,040 --> 00:02:44,959
now how exactly does enterprise keep

86
00:02:44,959 --> 00:02:46,959
track of this many machines and accounts

87
00:02:46,959 --> 00:02:48,959
now since we have like thousand around

88
00:02:48,959 --> 00:02:50,239
thousand computers and around seven

89
00:02:50,239 --> 00:02:51,519
thousand

90
00:02:51,519 --> 00:02:52,560
obviously

91
00:02:52,560 --> 00:02:53,360
though

92
00:02:53,360 --> 00:02:54,720
there has to be some kind of service

93
00:02:54,720 --> 00:02:56,640
right to

94
00:02:56,640 --> 00:02:58,640
keep track of this many accounts and for

95
00:02:58,640 --> 00:03:00,640
that microsoft has built a directory

96
00:03:00,640 --> 00:03:02,560
service provided such a large number of

97
00:03:02,560 --> 00:03:04,959
objects called active directory

98
00:03:04,959 --> 00:03:06,800
now one thing to note is that in an

99
00:03:06,800 --> 00:03:08,400
active directory everything starting

100
00:03:08,400 --> 00:03:10,959
from your user accounts machine accounts

101
00:03:10,959 --> 00:03:13,120
and say service accounts everything is

102
00:03:13,120 --> 00:03:15,760
an object you can basically think of an

103
00:03:15,760 --> 00:03:17,760
active directory as an object oriented

104
00:03:17,760 --> 00:03:19,280
programmer

105
00:03:19,280 --> 00:03:20,080
like

106
00:03:20,080 --> 00:03:21,599
in an object connected programming the

107
00:03:21,599 --> 00:03:24,159
objects have attributes like data types

108
00:03:24,159 --> 00:03:26,080
functions etcetera etcetera just like

109
00:03:26,080 --> 00:03:27,840
that objects in ad

110
00:03:27,840 --> 00:03:30,080
or active directory have attributes like

111
00:03:30,080 --> 00:03:31,840
service principle names access control

112
00:03:31,840 --> 00:03:34,239
lists etc etc

113
00:03:34,239 --> 00:03:36,400
okay so what exactly is active directory

114
00:03:36,400 --> 00:03:37,519
you asked

115
00:03:37,519 --> 00:03:39,840
basically as we said active directory is

116
00:03:39,840 --> 00:03:42,560
a directory service built by microsoft

117
00:03:42,560 --> 00:03:44,799
and says every service needs a protocol

118
00:03:44,799 --> 00:03:46,799
to communicate with hence the active

119
00:03:46,799 --> 00:03:48,640
directory is built upon ldap or the

120
00:03:48,640 --> 00:03:50,640
lightweight directory access protocol

121
00:03:50,640 --> 00:03:53,280
which talks on port 389

122
00:03:53,280 --> 00:03:54,959
okay cool we now know that there's a

123
00:03:54,959 --> 00:03:57,200
service there's a protocol but how does

124
00:03:57,200 --> 00:04:00,959
authentication protocol works

125
00:04:00,959 --> 00:04:02,640
basically how objects automatically

126
00:04:02,640 --> 00:04:04,080
conducted directly

127
00:04:04,080 --> 00:04:06,400
is through the kerberos service which

128
00:04:06,400 --> 00:04:08,879
runs on converse protocol or port 88 as

129
00:04:08,879 --> 00:04:11,519
we can see in the screenshot

130
00:04:11,519 --> 00:04:12,319
okay

131
00:04:12,319 --> 00:04:13,680
so now we know that the authentication

132
00:04:13,680 --> 00:04:15,519
works with kerberos but how exactly does

133
00:04:15,519 --> 00:04:17,199
the growth service

134
00:04:17,199 --> 00:04:19,120
now in this protocol there is a server

135
00:04:19,120 --> 00:04:21,279
which is a database of all the users the

136
00:04:21,279 --> 00:04:23,440
credentials the usernames passwords

137
00:04:23,440 --> 00:04:26,960
their groups nebraskans etc etc

138
00:04:26,960 --> 00:04:29,199
and this server is called the kdc or the

139
00:04:29,199 --> 00:04:31,680
kerberos distribution center

140
00:04:31,680 --> 00:04:33,840
usually the the machine hosting all

141
00:04:33,840 --> 00:04:37,199
these services including ldap kerberos

142
00:04:37,199 --> 00:04:39,199
and various other services is commonly

143
00:04:39,199 --> 00:04:41,840
known as the domain controller or the dc

144
00:04:41,840 --> 00:04:44,000
more on that later

145
00:04:44,000 --> 00:04:45,520
now in the kerberos protocol there are

146
00:04:45,520 --> 00:04:47,199
four way handshakes between the client

147
00:04:47,199 --> 00:04:49,520
and the kdc of the server let's start

148
00:04:49,520 --> 00:04:51,600
the ktc as a server

149
00:04:51,600 --> 00:04:53,360
before the client can access its target

150
00:04:53,360 --> 00:04:54,400
resource

151
00:04:54,400 --> 00:04:56,160
and one important thing to note in the

152
00:04:56,160 --> 00:04:58,560
kerberos handshakes is that

153
00:04:58,560 --> 00:05:01,120
the stuff happens in stuff called

154
00:05:01,120 --> 00:05:04,639
tickets like packets and tcp connections

155
00:05:04,639 --> 00:05:07,120
okay so there's the four-way handshake

156
00:05:07,120 --> 00:05:10,400
between the user and server the kdc

157
00:05:10,400 --> 00:05:13,039
before the the user account can access

158
00:05:13,039 --> 00:05:15,199
the requested service

159
00:05:15,199 --> 00:05:16,479
but the first step for the four-way

160
00:05:16,479 --> 00:05:19,600
handshake is the user asks the kdc for

161
00:05:19,600 --> 00:05:21,759
for access the resource using a dgs

162
00:05:21,759 --> 00:05:23,520
ticket or the ticket ranking service

163
00:05:23,520 --> 00:05:25,280
ticket

164
00:05:25,280 --> 00:05:26,639
after that the

165
00:05:26,639 --> 00:05:29,120
after the after this is over receives

166
00:05:29,120 --> 00:05:31,440
the tgs ticket it checks the user's

167
00:05:31,440 --> 00:05:33,680
access rights and runs

168
00:05:33,680 --> 00:05:36,160
the so the tgp or the ticket grant

169
00:05:36,160 --> 00:05:38,639
ticket and a session encrypted with the

170
00:05:38,639 --> 00:05:41,440
requested user's password hash now since

171
00:05:41,440 --> 00:05:43,520
we are already told that the kdc has a

172
00:05:43,520 --> 00:05:45,600
database which contains the password

173
00:05:45,600 --> 00:05:47,840
hashes of all the users hence for

174
00:05:47,840 --> 00:05:49,600
security reasons the

175
00:05:49,600 --> 00:05:51,840
kdc encrypts the session key using the

176
00:05:51,840 --> 00:05:53,440
requested users or the target user's

177
00:05:53,440 --> 00:05:55,120
password hash

178
00:05:55,120 --> 00:05:55,840
now

179
00:05:55,840 --> 00:05:58,000
now the step one and step two step

180
00:05:58,000 --> 00:06:00,400
in the step three upon receiving the tgt

181
00:06:00,400 --> 00:06:02,880
the user decrypts the session using its

182
00:06:02,880 --> 00:06:05,120
own password hash and then

183
00:06:05,120 --> 00:06:07,919
the decrypted key to the ktc again with

184
00:06:07,919 --> 00:06:10,000
some descriptors like its username its

185
00:06:10,000 --> 00:06:14,240
ip address other net addresses etc etc

186
00:06:14,240 --> 00:06:17,120
now the server or the jdc again decrypts

187
00:06:17,120 --> 00:06:19,199
that tgt verify set for the database and

188
00:06:19,199 --> 00:06:21,039
then gives the actual ticket which can

189
00:06:21,039 --> 00:06:22,800
be used to access the target resource

190
00:06:22,800 --> 00:06:24,080
the target request could be anything

191
00:06:24,080 --> 00:06:28,800
like http smb ftp etc

192
00:06:28,800 --> 00:06:30,639
okay so now we know that the how the

193
00:06:30,639 --> 00:06:34,080
kerberos thing works but and now let's

194
00:06:34,080 --> 00:06:37,199
look at how active directory looks like

195
00:06:37,199 --> 00:06:39,440
in active directory the main structure

196
00:06:39,440 --> 00:06:41,600
is called the forest in the forest there

197
00:06:41,600 --> 00:06:44,560
are other substructures like trees

198
00:06:44,560 --> 00:06:47,680
domains ous or the organizational units

199
00:06:47,680 --> 00:06:49,199
inside these organizational units there

200
00:06:49,199 --> 00:06:51,440
are workstations users

201
00:06:51,440 --> 00:06:54,880
groups printers shares

202
00:06:54,880 --> 00:06:56,080
these are all accounts there is a

203
00:06:56,080 --> 00:06:58,080
computer account the user account group

204
00:06:58,080 --> 00:07:01,680
objects basically these are all options

205
00:07:01,680 --> 00:07:04,479
okay so now we know how the

206
00:07:04,479 --> 00:07:06,240
active directory authentication works

207
00:07:06,240 --> 00:07:09,120
how it looks like so how exactly do we

208
00:07:09,120 --> 00:07:10,880
open a domain and what exactly do we

209
00:07:10,880 --> 00:07:12,479
have to do

210
00:07:12,479 --> 00:07:14,000
you get access to an account which has

211
00:07:14,000 --> 00:07:15,599
any type of admin rights which belongs

212
00:07:15,599 --> 00:07:18,160
to administrators group is the way on

213
00:07:18,160 --> 00:07:19,840
how we open a domain

214
00:07:19,840 --> 00:07:21,680
and the list of administrators which are

215
00:07:21,680 --> 00:07:24,160
part of administrators

216
00:07:24,160 --> 00:07:24,960
is

217
00:07:24,960 --> 00:07:26,639
the enterprise admins or the ground

218
00:07:26,639 --> 00:07:28,720
users of the empire forest

219
00:07:28,720 --> 00:07:31,280
the second is the domain of trans rules

220
00:07:31,280 --> 00:07:33,039
of the entire domain

221
00:07:33,039 --> 00:07:35,599
after that comes the schema admins

222
00:07:35,599 --> 00:07:37,039
and then any other user defined

223
00:07:37,039 --> 00:07:39,280
administrative project

224
00:07:39,280 --> 00:07:40,160
okay

225
00:07:40,160 --> 00:07:42,319
so what are objects accounts and groups

226
00:07:42,319 --> 00:07:44,879
etc etc are under administrators group

227
00:07:44,879 --> 00:07:47,280
for that we will simply use the command

228
00:07:47,280 --> 00:07:49,440
net local group administrators slash

229
00:07:49,440 --> 00:07:50,960
domain

230
00:07:50,960 --> 00:07:53,360
now as we can see the output is that we

231
00:07:53,360 --> 00:07:55,360
are getting administrator the main

232
00:07:55,360 --> 00:07:57,280
admins enterprise admins as we discussed

233
00:07:57,280 --> 00:07:59,120
earlier

234
00:07:59,120 --> 00:08:01,199
okay now we know what our target account

235
00:08:01,199 --> 00:08:03,520
is but let's enumerate our own rights

236
00:08:03,520 --> 00:08:05,680
and for that we'll use the command net

237
00:08:05,680 --> 00:08:10,240
user our username here slash domain now

238
00:08:10,240 --> 00:08:11,599
the information gives us the username

239
00:08:11,599 --> 00:08:14,080
full name comments etc etc but down here

240
00:08:14,080 --> 00:08:15,599
below we see that the global group

241
00:08:15,599 --> 00:08:18,960
membership is domain users

242
00:08:19,280 --> 00:08:22,080
okay so here's our as a standard user

243
00:08:22,080 --> 00:08:23,440
permissions now what's the difference

244
00:08:23,440 --> 00:08:25,039
between a standard user and an

245
00:08:25,039 --> 00:08:26,560
administrator.com

246
00:08:26,560 --> 00:08:28,080
so the differences are

247
00:08:28,080 --> 00:08:29,680
in the standard user the global group

248
00:08:29,680 --> 00:08:31,840
memberships are domain users but for a

249
00:08:31,840 --> 00:08:34,719
domain admin account the memberships are

250
00:08:34,719 --> 00:08:37,039
administrators enterprise admins domain

251
00:08:37,039 --> 00:08:38,000
admin

252
00:08:38,000 --> 00:08:40,000
and various

253
00:08:40,000 --> 00:08:40,958
okay

254
00:08:40,958 --> 00:08:42,719
so now let's gather information about

255
00:08:42,719 --> 00:08:44,560
how an actor directory is set up in our

256
00:08:44,560 --> 00:08:46,480
school

257
00:08:46,480 --> 00:08:48,320
we can do this because almost everyone

258
00:08:48,320 --> 00:08:50,080
can read almost everything in an active

259
00:08:50,080 --> 00:08:51,120
directory

260
00:08:51,120 --> 00:08:52,720
you can you only need some special

261
00:08:52,720 --> 00:08:55,120
privileges to write new objects or read

262
00:08:55,120 --> 00:08:56,480
sensitive information like password

263
00:08:56,480 --> 00:08:59,519
hashes and stuff like that

264
00:08:59,519 --> 00:09:01,760
okay but the thing is how do we get all

265
00:09:01,760 --> 00:09:03,040
these information

266
00:09:03,040 --> 00:09:04,880
on our environment and make it human

267
00:09:04,880 --> 00:09:06,640
readable and not lose our salary all at

268
00:09:06,640 --> 00:09:09,360
the same time why is that because we

269
00:09:09,360 --> 00:09:10,880
know that there are around thousand

270
00:09:10,880 --> 00:09:12,480
computers and around seven thousand user

271
00:09:12,480 --> 00:09:14,880
accounts and that's a lot of data right

272
00:09:14,880 --> 00:09:17,120
so that's where bloodhound kicks in it's

273
00:09:17,120 --> 00:09:19,519
a tool which takes json data passes it

274
00:09:19,519 --> 00:09:20,839
and makes graphs for us for better

275
00:09:20,839 --> 00:09:22,720
understanding led hand has many

276
00:09:22,720 --> 00:09:24,240
injustice offers

277
00:09:24,240 --> 00:09:26,160
which can be used to retrieve the data

278
00:09:26,160 --> 00:09:29,440
in json format compile them in a single

279
00:09:29,440 --> 00:09:31,839
file and feed the beast basically this

280
00:09:31,839 --> 00:09:34,000
program is basically a visualizer and it

281
00:09:34,000 --> 00:09:36,080
needs json and that's where industrial

282
00:09:36,080 --> 00:09:38,080
softwares come in some examples are

283
00:09:38,080 --> 00:09:42,240
sharp hound bloodhound python and

284
00:09:42,480 --> 00:09:44,800
now this is basically a graph which is

285
00:09:44,800 --> 00:09:46,800
taken from down this the screenshot is

286
00:09:46,800 --> 00:09:49,040
of

287
00:09:49,040 --> 00:09:50,959
our home lab which mimics the network

288
00:09:50,959 --> 00:09:53,040
play out of the vulnerable condition of

289
00:09:53,040 --> 00:09:55,599
our school

290
00:09:56,080 --> 00:09:57,760
now this is suggesting us a dc stink

291
00:09:57,760 --> 00:10:00,320
attack more on that later

292
00:10:00,320 --> 00:10:02,560
okay so before doing a dc sync attack

293
00:10:02,560 --> 00:10:03,920
you need to know what exactly is the

294
00:10:03,920 --> 00:10:05,360
receiving required

295
00:10:05,360 --> 00:10:07,360
so in an active directory environment

296
00:10:07,360 --> 00:10:09,519
there are many server machines

297
00:10:09,519 --> 00:10:11,360
as we talked about earlier which manage

298
00:10:11,360 --> 00:10:12,560
the whole domain called the domain

299
00:10:12,560 --> 00:10:15,040
controllers or the dc

300
00:10:15,040 --> 00:10:16,640
there is literally a built-in groups

301
00:10:16,640 --> 00:10:18,399
called the domain controllers and all

302
00:10:18,399 --> 00:10:20,560
the machines which act as a dc are part

303
00:10:20,560 --> 00:10:21,920
of it

304
00:10:21,920 --> 00:10:24,160
now let's understand what is the need or

305
00:10:24,160 --> 00:10:26,000
the intended purpose of this privilege

306
00:10:26,000 --> 00:10:27,600
which can which attackers leverage to

307
00:10:27,600 --> 00:10:30,079
perform a dc sync attack

308
00:10:30,079 --> 00:10:32,399
since we know that in a domain there are

309
00:10:32,399 --> 00:10:34,160
there's not one but multiple machines

310
00:10:34,160 --> 00:10:36,640
right activists remain controlled hence

311
00:10:36,640 --> 00:10:38,240
as per the organization's leads and

312
00:10:38,240 --> 00:10:40,079
other technological factors one may

313
00:10:40,079 --> 00:10:42,560
promote any normal machine as a dc or d

314
00:10:42,560 --> 00:10:44,959
mode a dc to be a normal machine

315
00:10:44,959 --> 00:10:46,880
hence to do all these actions of

316
00:10:46,880 --> 00:10:48,880
promoting and demoting machines one

317
00:10:48,880 --> 00:10:51,040
needs certain privileges which are by

318
00:10:51,040 --> 00:10:52,720
default given

319
00:10:52,720 --> 00:10:54,720
but not limited to domain admins

320
00:10:54,720 --> 00:10:56,320
enterprise admins

321
00:10:56,320 --> 00:10:58,079
administrators group

322
00:10:58,079 --> 00:11:00,640
and domain controllers group

323
00:11:00,640 --> 00:11:02,560
hence any user falling under any of

324
00:11:02,560 --> 00:11:04,880
these groups can by by default promote

325
00:11:04,880 --> 00:11:07,360
or demo machines from the dc queue

326
00:11:07,360 --> 00:11:09,600
please note that we said

327
00:11:09,600 --> 00:11:12,000
it is by default but it's not limited to

328
00:11:12,000 --> 00:11:13,920
these groups and one can manually give

329
00:11:13,920 --> 00:11:15,839
these requests rights to any other

330
00:11:15,839 --> 00:11:19,440
objects users or groups

331
00:11:19,440 --> 00:11:21,360
okay so how exactly does this promotion

332
00:11:21,360 --> 00:11:23,040
and demotion take place in the first

333
00:11:23,040 --> 00:11:25,279
place when any user initiates the

334
00:11:25,279 --> 00:11:27,360
request of the promotion or existing

335
00:11:27,360 --> 00:11:28,959
domain controllers first check if the

336
00:11:28,959 --> 00:11:31,519
user has sufficient rights or not if yes

337
00:11:31,519 --> 00:11:33,440
then it copies all its records all the

338
00:11:33,440 --> 00:11:35,920
directory services machine accounts user

339
00:11:35,920 --> 00:11:38,720
accounts password groups etc etc with a

340
00:11:38,720 --> 00:11:40,480
new machine and assigns it as a part of

341
00:11:40,480 --> 00:11:42,320
domain controllers group hence the

342
00:11:42,320 --> 00:11:44,240
promotion is complete

343
00:11:44,240 --> 00:11:46,240
when any user initiates the request for

344
00:11:46,240 --> 00:11:49,040
demotion the target first checks

345
00:11:49,040 --> 00:11:51,279
if the user has sufficient right server

346
00:11:51,279 --> 00:11:53,600
if yes then it deletes all its records

347
00:11:53,600 --> 00:11:55,279
and removes itself from the domain so

348
00:11:55,279 --> 00:11:56,720
that's true hence the demotion is

349
00:11:56,720 --> 00:11:58,320
complete

350
00:11:58,320 --> 00:12:00,079
okay so now we see that there are there

351
00:12:00,079 --> 00:12:01,680
are transfer of records from one machine

352
00:12:01,680 --> 00:12:04,160
to another including passwords from

353
00:12:04,160 --> 00:12:05,680
and that's interesting

354
00:12:05,680 --> 00:12:07,680
and this is what exactly an attacker

355
00:12:07,680 --> 00:12:10,240
leverages to get the password hashes

356
00:12:10,240 --> 00:12:11,839
once an attacker controls an account

357
00:12:11,839 --> 00:12:14,079
falling under any of the built-in groups

358
00:12:14,079 --> 00:12:15,760
or if the target user has sufficient

359
00:12:15,760 --> 00:12:17,760
rights then the attacker can invoke

360
00:12:17,760 --> 00:12:19,680
certain commands telling the existing

361
00:12:19,680 --> 00:12:21,440
domain controllers to promote any

362
00:12:21,440 --> 00:12:22,959
machine of the attacker's choice with

363
00:12:22,959 --> 00:12:25,760
the remaining controller

364
00:12:25,760 --> 00:12:28,320
and during this transfer of records and

365
00:12:28,320 --> 00:12:30,399
data the attacker gets hold of all the

366
00:12:30,399 --> 00:12:32,720
crown jumps like the password hashes the

367
00:12:32,720 --> 00:12:35,360
kerberos tickets of other users and

368
00:12:35,360 --> 00:12:37,040
machines and thereby compromising the

369
00:12:37,040 --> 00:12:39,200
entire degree

370
00:12:39,200 --> 00:12:41,279
okay yet another disclaimer before the

371
00:12:41,279 --> 00:12:43,360
exportation phase i had made the id

372
00:12:43,360 --> 00:12:44,399
department

373
00:12:44,399 --> 00:12:46,000
of our school with all my findings and

374
00:12:46,000 --> 00:12:47,680
wanted to get my hands dirty with the

375
00:12:47,680 --> 00:12:49,680
exploitation so ask them for the request

376
00:12:49,680 --> 00:12:51,920
permission to continue hence with no

377
00:12:51,920 --> 00:12:54,000
means the following would be legal if

378
00:12:54,000 --> 00:12:56,000
not for their permission

379
00:12:56,000 --> 00:12:57,600
it would be illegal if they denied my

380
00:12:57,600 --> 00:12:58,880
request and i still exported to the

381
00:12:58,880 --> 00:13:03,079
level so do keep these impacts

382
00:13:08,480 --> 00:13:11,440
okay so essentially this is the graph

383
00:13:11,440 --> 00:13:13,279
had the screenshot in the previous

384
00:13:13,279 --> 00:13:15,440
slides basically what's in the graph is

385
00:13:15,440 --> 00:13:17,839
that say there are student accounts

386
00:13:17,839 --> 00:13:19,440
called student

387
00:13:19,440 --> 00:13:20,959
teacher accounts called teacher one

388
00:13:20,959 --> 00:13:24,000
faculty account for sacrifice now so

389
00:13:24,000 --> 00:13:26,800
let's look at the students students user

390
00:13:26,800 --> 00:13:29,200
the students is a member of students and

391
00:13:29,200 --> 00:13:31,120
which is a member of domain users now

392
00:13:31,120 --> 00:13:32,800
this is perfect

393
00:13:32,800 --> 00:13:35,120
this is how it should be but the main

394
00:13:35,120 --> 00:13:36,800
fault lies in that the domain users is a

395
00:13:36,800 --> 00:13:38,639
number of administrators

396
00:13:38,639 --> 00:13:40,720
and this should never be

397
00:13:40,720 --> 00:13:42,959
as we can see that the administrator has

398
00:13:42,959 --> 00:13:44,959
edges get changes on and get changes to

399
00:13:44,959 --> 00:13:48,279
the whole domain

400
00:13:48,480 --> 00:13:50,240
if we right click on the one of the edge

401
00:13:50,240 --> 00:13:53,600
and press help and go abuse info

402
00:13:53,600 --> 00:13:55,839
we will see that the bloodhound suggests

403
00:13:55,839 --> 00:13:57,760
us that which would get changes and get

404
00:13:57,760 --> 00:14:00,000
changes or privilege in bloodhound you

405
00:14:00,000 --> 00:14:01,920
may perform a dc sync attack to get the

406
00:14:01,920 --> 00:14:04,160
password hash of any arbitrary principle

407
00:14:04,160 --> 00:14:06,880
or in this sense any arbitrary account

408
00:14:06,880 --> 00:14:10,079
using mimic apps now

409
00:14:10,079 --> 00:14:12,240
and the command for the mimikatz is

410
00:14:12,240 --> 00:14:13,680
given right here

411
00:14:13,680 --> 00:14:15,360
now we didn't use memory cats in this

412
00:14:15,360 --> 00:14:17,040
case because uh

413
00:14:17,040 --> 00:14:19,120
there is an alternative called sequence

414
00:14:19,120 --> 00:14:21,120
number five from impacted and that's

415
00:14:21,120 --> 00:14:22,959
much more healthier than mimic apps in

416
00:14:22,959 --> 00:14:24,800
my cats what you have to do is you need

417
00:14:24,800 --> 00:14:27,199
to have an admin command shell on a

418
00:14:27,199 --> 00:14:29,360
domain controller but with secrets

419
00:14:29,360 --> 00:14:30,480
jumped out by

420
00:14:30,480 --> 00:14:32,800
none of the assets

421
00:14:32,800 --> 00:14:35,040
so

422
00:14:37,440 --> 00:14:40,000
so the command is goes like this secret

423
00:14:40,000 --> 00:14:42,959
standard by space homeland total that's

424
00:14:42,959 --> 00:14:45,600
your group slash your username calling

425
00:14:45,600 --> 00:14:47,920
students at one that's your password at

426
00:14:47,920 --> 00:14:50,079
the rate you're doing controller id ip

427
00:14:50,079 --> 00:14:51,440
address

428
00:14:51,440 --> 00:14:54,959
and after we press enter

429
00:14:55,440 --> 00:14:57,199
as we see that it start it starts to

430
00:14:57,199 --> 00:15:00,880
dump all the password hashes and tickets

431
00:15:00,880 --> 00:15:04,160
here we see we have the plain text

432
00:15:04,160 --> 00:15:06,800
password hex of plain text password in

433
00:15:06,800 --> 00:15:09,040
hex of the machine dc 01 basically the

434
00:15:09,040 --> 00:15:11,279
domain controller and that's here

435
00:15:11,279 --> 00:15:14,480
the dp api keys the kerberos tickets

436
00:15:14,480 --> 00:15:17,279
the ntlm hashes of administrator the krb

437
00:15:17,279 --> 00:15:20,959
tgt or basically the your kdc the the

438
00:15:20,959 --> 00:15:23,040
kdc server

439
00:15:23,040 --> 00:15:24,959
student users teacher users faculty

440
00:15:24,959 --> 00:15:27,199
users etc etc

441
00:15:27,199 --> 00:15:30,639
and some more versions are like desktop

442
00:15:30,639 --> 00:15:32,240
so basically thereby compromising the

443
00:15:32,240 --> 00:15:35,560
entire domain

444
00:15:40,000 --> 00:15:42,399
okay latest developments for this case

445
00:15:42,399 --> 00:15:43,920
these have also been worked upon and are

446
00:15:43,920 --> 00:15:45,680
no longer constructed

447
00:15:45,680 --> 00:15:47,199
this is basically the main reason of

448
00:15:47,199 --> 00:15:48,800
this biscuit refrigeration and what the

449
00:15:48,800 --> 00:15:50,720
iot team was

450
00:15:50,720 --> 00:15:53,279
benefiting from this configuration

451
00:15:53,279 --> 00:15:54,959
after this hack was done and fixes were

452
00:15:54,959 --> 00:15:56,959
in place what happened is our college

453
00:15:56,959 --> 00:15:58,639
had a web portal in which people could

454
00:15:58,639 --> 00:16:00,320
change their credentials without having

455
00:16:00,320 --> 00:16:02,320
to rdp to any machine

456
00:16:02,320 --> 00:16:03,120
now

457
00:16:03,120 --> 00:16:04,000
while

458
00:16:04,000 --> 00:16:05,519
in windows

459
00:16:05,519 --> 00:16:08,160
uh in domain joint windows basically if

460
00:16:08,160 --> 00:16:09,360
you want to change your password you

461
00:16:09,360 --> 00:16:11,279
need to rdp to one of the machines and

462
00:16:11,279 --> 00:16:13,440
then change the password but to

463
00:16:13,440 --> 00:16:15,040
circumvent this issue

464
00:16:15,040 --> 00:16:18,079
our it team made a web app which

465
00:16:18,079 --> 00:16:19,680
took in usernames and passwords and

466
00:16:19,680 --> 00:16:21,759
simply changed it but upon driving the

467
00:16:21,759 --> 00:16:23,199
source code the password change

468
00:16:23,199 --> 00:16:25,199
functionality of the web app what i

469
00:16:25,199 --> 00:16:26,720
found was that it doesn't start changing

470
00:16:26,720 --> 00:16:29,759
passwords rather it was resetting it now

471
00:16:29,759 --> 00:16:31,199
the difference between changing and

472
00:16:31,199 --> 00:16:32,480
resetting

473
00:16:32,480 --> 00:16:34,399
changing and changing passwords the

474
00:16:34,399 --> 00:16:37,199
target user has its own password and

475
00:16:37,199 --> 00:16:39,199
sets a new password in the resetting

476
00:16:39,199 --> 00:16:41,759
queue structure user does not have its

477
00:16:41,759 --> 00:16:43,120
own

478
00:16:43,120 --> 00:16:46,240
password and for resetting password

479
00:16:46,240 --> 00:16:48,480
a user having more privileges than the

480
00:16:48,480 --> 00:16:52,160
target user can also insert the password

481
00:16:52,160 --> 00:16:53,680
meaning the account had to be the part

482
00:16:53,680 --> 00:16:55,120
of administrators group because that's

483
00:16:55,120 --> 00:16:57,040
how intersected directory works

484
00:16:57,040 --> 00:16:59,040
directly or non-directly we start

485
00:16:59,040 --> 00:17:01,040
working because the accounts were no

486
00:17:01,040 --> 00:17:02,399
longer the part of the status group

487
00:17:02,399 --> 00:17:04,079
anymore

488
00:17:04,079 --> 00:17:06,240
in order to make in order to make the

489
00:17:06,240 --> 00:17:07,919
script working what they did was they

490
00:17:07,919 --> 00:17:09,520
had to put the domain users group as the

491
00:17:09,520 --> 00:17:11,839
number of administrators hence all those

492
00:17:11,839 --> 00:17:13,119
hassle

493
00:17:13,119 --> 00:17:14,880
so there was only one thing which needed

494
00:17:14,880 --> 00:17:16,319
to be done

495
00:17:16,319 --> 00:17:18,160
change the backend code for changing the

496
00:17:18,160 --> 00:17:21,119
password start resetting them

497
00:17:21,119 --> 00:17:24,000
so these are my takeaways from this hack

498
00:17:24,000 --> 00:17:26,160
from the for the it staff just to make

499
00:17:26,160 --> 00:17:28,720
your lives easier do not in any point of

500
00:17:28,720 --> 00:17:30,720
time fiddle with group hierarchies and

501
00:17:30,720 --> 00:17:33,120
permission levels if you do not fully

502
00:17:33,120 --> 00:17:35,120
understand the consequences of the

503
00:17:35,120 --> 00:17:36,799
changes you are thinking then do not

504
00:17:36,799 --> 00:17:38,000
implement them

505
00:17:38,000 --> 00:17:39,520
there are reasons on why these groups

506
00:17:39,520 --> 00:17:40,960
hierarchies are particularly designed by

507
00:17:40,960 --> 00:17:42,480
microsoft

508
00:17:42,480 --> 00:17:44,559
and so pentesters know your environment

509
00:17:44,559 --> 00:17:46,320
well in order to know what you are up

510
00:17:46,320 --> 00:17:48,480
against and you enumerate as much as you

511
00:17:48,480 --> 00:17:50,320
can because there can never be too much

512
00:17:50,320 --> 00:17:51,440
information

513
00:17:51,440 --> 00:17:52,559
and

514
00:17:52,559 --> 00:17:54,320
and remember blue teams and i.t staff

515
00:17:54,320 --> 00:17:55,679
are also human and they are bound to

516
00:17:55,679 --> 00:17:56,559
make

517
00:17:56,559 --> 00:17:58,799
mistakes and it's our duty to look out

518
00:17:58,799 --> 00:18:00,480
for them and responsibly reported to

519
00:18:00,480 --> 00:18:01,360
them

520
00:18:01,360 --> 00:18:03,840
thank you

521
00:18:05,360 --> 00:18:06,400
awesome

522
00:18:06,400 --> 00:18:07,919
that was uh

523
00:18:07,919 --> 00:18:09,919
quite enlightening about well let's say

524
00:18:09,919 --> 00:18:12,160
real world things that happen uh well

525
00:18:12,160 --> 00:18:14,799
that can happen in the real world um

526
00:18:14,799 --> 00:18:16,240
it's

527
00:18:16,240 --> 00:18:18,960
i guess frightening um to see that you

528
00:18:18,960 --> 00:18:20,480
know various uh

529
00:18:20,480 --> 00:18:22,720
institutions that you know let's be

530
00:18:22,720 --> 00:18:24,320
honest should probably invest a little

531
00:18:24,320 --> 00:18:26,960
bit more into security uh have things

532
00:18:26,960 --> 00:18:29,120
that are well

533
00:18:29,120 --> 00:18:30,880
exploitable at large

534
00:18:30,880 --> 00:18:31,150
um

535
00:18:31,150 --> 00:18:32,559
[Music]

536
00:18:32,559 --> 00:18:34,879
yeah

537
00:18:35,120 --> 00:18:36,640
yeah thank you so much alien that was a

538
00:18:36,640 --> 00:18:40,320
great talk uh is there any questions

539
00:18:40,320 --> 00:18:42,559
in regards to what alien has just talked

540
00:18:42,559 --> 00:18:44,879
about

541
00:18:45,280 --> 00:18:47,120
i'm not seeing any in twitch let's check

542
00:18:47,120 --> 00:18:49,280
the discord you were very thorough in

543
00:18:49,280 --> 00:18:50,720
covering this topic by the way great

544
00:18:50,720 --> 00:18:55,039
work it was a lot of fun to listen to

545
00:18:55,120 --> 00:18:57,840
ah we have one person typing uh in the

546
00:18:57,840 --> 00:19:01,039
meantime i do have a question for you um

547
00:19:01,039 --> 00:19:05,360
when you started this um

548
00:19:05,520 --> 00:19:08,240
i guess your hack were you already aware

549
00:19:08,240 --> 00:19:10,320
of the potential consequences or did you

550
00:19:10,320 --> 00:19:14,480
learn about this uh like in the future

551
00:19:14,480 --> 00:19:16,080
uh

552
00:19:16,080 --> 00:19:17,919
right could you like repeat i couldn't

553
00:19:17,919 --> 00:19:19,200
understand

554
00:19:19,200 --> 00:19:20,559
uh so

555
00:19:20,559 --> 00:19:23,200
when you did this um you know this hack

556
00:19:23,200 --> 00:19:25,200
were you aware of all the consequences

557
00:19:25,200 --> 00:19:27,280
that it could have or is this something

558
00:19:27,280 --> 00:19:29,280
where you just experimented and then

559
00:19:29,280 --> 00:19:31,600
found it out and were like oh i need to

560
00:19:31,600 --> 00:19:32,880
like

561
00:19:32,880 --> 00:19:35,280
check myself a bit

562
00:19:35,280 --> 00:19:39,120
uh yeah i already knew like uh

563
00:19:39,120 --> 00:19:40,799
i knew if something

564
00:19:40,799 --> 00:19:43,120
like this happens in the university it's

565
00:19:43,120 --> 00:19:45,039
pretty bad so

566
00:19:45,039 --> 00:19:46,480
i was simply like fiddling with my

567
00:19:46,480 --> 00:19:48,000
permissions and

568
00:19:48,000 --> 00:19:50,240
saw that i was a part of the

569
00:19:50,240 --> 00:19:51,919
administrators group so that's when i

570
00:19:51,919 --> 00:19:54,080
reported to the iit admin

571
00:19:54,080 --> 00:19:55,679
and they said yeah

572
00:19:55,679 --> 00:19:58,080
go forward with it

573
00:19:58,080 --> 00:20:00,400
like let's see how much like how much

574
00:20:00,400 --> 00:20:04,039
permissions can you get

575
00:20:08,799 --> 00:20:10,720
oh i think nicos is having some

576
00:20:10,720 --> 00:20:12,320
technical difficulty

577
00:20:12,320 --> 00:20:14,400
no i'm not i'm uh someone is

578
00:20:14,400 --> 00:20:16,880
interrupting

579
00:20:17,520 --> 00:20:18,960
anyways uh you actually have a couple

580
00:20:18,960 --> 00:20:21,280
more questions in chat if i may take it

581
00:20:21,280 --> 00:20:22,400
from here

582
00:20:22,400 --> 00:20:24,080
uh another one is any recommended

583
00:20:24,080 --> 00:20:26,400
resources to learn

584
00:20:26,400 --> 00:20:27,600
okay

585
00:20:27,600 --> 00:20:29,760
from my personal experience i basically

586
00:20:29,760 --> 00:20:32,480
do have the boxes and try hackneys

587
00:20:32,480 --> 00:20:36,400
like stuff so that's all i did to learn

588
00:20:36,400 --> 00:20:39,760
whatever i have and i do

589
00:20:39,760 --> 00:20:42,640
and uh some books uh not books exactly

590
00:20:42,640 --> 00:20:44,400
some blogs i would recommend

591
00:20:44,400 --> 00:20:47,440
the book.haptics is a pretty good blog

592
00:20:47,440 --> 00:20:50,320
you can simply google like

593
00:20:50,320 --> 00:20:51,919
say if you are stuck

594
00:20:51,919 --> 00:20:54,240
in a topic say a dc sync you can simply

595
00:20:54,240 --> 00:20:56,080
uh google how to perform a decision

596
00:20:56,080 --> 00:20:57,760
called what exactly the decision can you

597
00:20:57,760 --> 00:21:00,880
get tons of blocks to read from

598
00:21:00,880 --> 00:21:02,720
that's it

599
00:21:02,720 --> 00:21:05,039
awesome thank you and how did you

600
00:21:05,039 --> 00:21:06,960
communicate the vulnerability to the i.t

601
00:21:06,960 --> 00:21:08,720
staff were they receptive and did they

602
00:21:08,720 --> 00:21:10,080
understand the vulnerability when it was

603
00:21:10,080 --> 00:21:11,520
presented or

604
00:21:11,520 --> 00:21:12,799
did you have to explain it like what

605
00:21:12,799 --> 00:21:14,240
happened there

606
00:21:14,240 --> 00:21:16,320
i had to explain what what happened is

607
00:21:16,320 --> 00:21:18,400
that when i got that i was the public

608
00:21:18,400 --> 00:21:19,679
administrators

609
00:21:19,679 --> 00:21:22,559
uh i took a screenshot i mailed them and

610
00:21:22,559 --> 00:21:23,440
i

611
00:21:23,440 --> 00:21:25,440
tried to uh

612
00:21:25,440 --> 00:21:27,039
write them like

613
00:21:27,039 --> 00:21:29,280
i had i tried to uh

614
00:21:29,280 --> 00:21:30,799
explain it explain it to them like how

615
00:21:30,799 --> 00:21:33,039
severe that it was but they i don't

616
00:21:33,039 --> 00:21:34,720
think they could understand it much so

617
00:21:34,720 --> 00:21:36,720
they simply said that go ahead and let's

618
00:21:36,720 --> 00:21:40,520
see how far can

