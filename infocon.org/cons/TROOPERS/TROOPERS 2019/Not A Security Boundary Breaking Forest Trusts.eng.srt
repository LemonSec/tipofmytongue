1
00:00:01,379 --> 00:00:09,639
cool<font color="#CCCCCC"> so this</font><font color="#E5E5E5"> is not a security boundary</font>

2
00:00:04,960 --> 00:00:11,620
<font color="#CCCCCC">breaking forest</font><font color="#E5E5E5"> trusts so my name</font><font color="#CCCCCC"> is</font>

3
00:00:09,639 --> 00:00:13,539
<font color="#CCCCCC">Will</font><font color="#E5E5E5"> Schrader my handle is harm joy</font>

4
00:00:11,620 --> 00:00:15,459
it's my obligatory picture I think<font color="#CCCCCC"> that</font>

5
00:00:13,539 --> 00:00:18,039
might have<font color="#E5E5E5"> been from Walter I forget at</font>

6
00:00:15,459 --> 00:00:21,220
the<font color="#E5E5E5"> little Yoda</font><font color="#CCCCCC"> but I'm a red teamer an</font>

7
00:00:18,039 --> 00:00:24,279
offensive engineer at<font color="#CCCCCC"> spec drops off in</font>

8
00:00:21,220 --> 00:00:26,109
the<font color="#CCCCCC"> US I've written a</font><font color="#E5E5E5"> lot of code talk</font>

9
00:00:24,279 --> 00:00:27,730
to the few conferences<font color="#E5E5E5"> but I was a</font>

10
00:00:26,109 --> 00:00:30,039
co-founder<font color="#CCCCCC"> of</font><font color="#E5E5E5"> the Bloodhound project</font>

11
00:00:27,730 --> 00:00:32,200
<font color="#E5E5E5">PowerShell</font><font color="#CCCCCC"> Empire</font><font color="#E5E5E5"> written a bunch of</font>

12
00:00:30,039 --> 00:00:33,460
stuff for<font color="#CCCCCC"> power sploit ruby is a bunch</font>

13
00:00:32,200 --> 00:00:37,570
of fun<font color="#CCCCCC"> things some of which we'll be</font>

14
00:00:33,460 --> 00:00:39,640
<font color="#CCCCCC">using this talk and so my</font><font color="#E5E5E5"> name is</font><font color="#CCCCCC"> Lea</font>

15
00:00:37,570 --> 00:00:41,469
<font color="#CCCCCC">Christensen I go by TIFF skin on</font><font color="#E5E5E5"> Twitter</font>

16
00:00:39,640 --> 00:00:44,590
<font color="#CCCCCC">I do a lot of things</font>

17
00:00:41,469 --> 00:00:46,059
inspector<font color="#CCCCCC"> UPS</font><font color="#E5E5E5"> I worked on</font><font color="#CCCCCC"> red</font><font color="#E5E5E5"> teams I</font>

18
00:00:44,590 --> 00:00:48,100
worked on<font color="#CCCCCC"> our hunt side</font><font color="#E5E5E5"> building</font>

19
00:00:46,059 --> 00:00:50,019
detection<font color="#E5E5E5"> and I also like to do research</font>

20
00:00:48,100 --> 00:00:53,079
<font color="#CCCCCC">a lot</font><font color="#E5E5E5"> of times and I'm in the background</font>

21
00:00:50,020 --> 00:00:56,320
<font color="#CCCCCC">because I hate</font><font color="#E5E5E5"> writing it's a lot of</font>

22
00:00:53,079 --> 00:00:58,809
<font color="#CCCCCC">posts</font><font color="#E5E5E5"> for</font><font color="#CCCCCC"> anything but always</font><font color="#E5E5E5"> are I'm</font>

23
00:00:56,320 --> 00:01:00,340
collaborating with will on things<font color="#CCCCCC"> so</font>

24
00:00:58,809 --> 00:01:01,629
this bug is a really cool<font color="#E5E5E5"> what we're</font>

25
00:01:00,340 --> 00:01:03,399
<font color="#CCCCCC">going to be</font><font color="#E5E5E5"> talking about is a really</font>

26
00:01:01,629 --> 00:01:04,569
cool combination of some of<font color="#E5E5E5"> these work</font>

27
00:01:03,399 --> 00:01:06,369
<font color="#E5E5E5">and then some of the stuff</font><font color="#CCCCCC"> that I've</font>

28
00:01:04,569 --> 00:01:10,139
done<font color="#E5E5E5"> concerning domains and trusts so</font>

29
00:01:06,369 --> 00:01:13,470
we're<font color="#E5E5E5"> excited for it but first though</font>

30
00:01:10,140 --> 00:01:15,970
one<font color="#E5E5E5"> of the crux of part of this talk</font><font color="#CCCCCC"> is</font>

31
00:01:13,470 --> 00:01:18,130
<font color="#CCCCCC">forest as</font><font color="#E5E5E5"> this concept of security</font>

32
00:01:15,970 --> 00:01:22,119
boundaries and<font color="#E5E5E5"> security boundary is a</font>

33
00:01:18,130 --> 00:01:24,460
very like definitive like real type of

34
00:01:22,119 --> 00:01:27,100
concept in Microsoft and Microsoft

35
00:01:24,460 --> 00:01:28,689
circles so when something<font color="#E5E5E5"> is a security</font>

36
00:01:27,100 --> 00:01:32,229
<font color="#E5E5E5">boundary if you're</font><font color="#CCCCCC"> able to</font><font color="#E5E5E5"> breach</font><font color="#CCCCCC"> that</font>

37
00:01:28,689 --> 00:01:34,389
boundary<font color="#E5E5E5"> it's supposed to be fixed we</font>

38
00:01:32,229 --> 00:01:36,189
argued that<font color="#E5E5E5"> forests were treated as</font>

39
00:01:34,390 --> 00:01:37,600
security boundary as per Microsoft

40
00:01:36,189 --> 00:01:39,939
documentation because<font color="#E5E5E5"> they literally</font>

41
00:01:37,600 --> 00:01:41,710
said<font color="#CCCCCC"> forest our security boundaries and</font>

42
00:01:39,939 --> 00:01:44,350
say a<font color="#CCCCCC"> security boundary security</font>

43
00:01:41,710 --> 00:01:46,839
security<font color="#CCCCCC"> boundary so we're gonna go over</font>

44
00:01:44,350 --> 00:01:48,520
how we approached actually chaining a

45
00:01:46,840 --> 00:01:51,579
couple of interesting misconfigurations

46
00:01:48,520 --> 00:01:53,890
<font color="#E5E5E5">our default functionality to break this</font>

47
00:01:51,579 --> 00:01:57,399
concept of forest as a security boundary

48
00:01:53,890 --> 00:01:58,990
<font color="#CCCCCC">of protection so we're just</font><font color="#E5E5E5"> gonna give a</font>

49
00:01:57,399 --> 00:02:00,759
super high overview first then we're

50
00:01:58,990 --> 00:02:02,710
gonna dive into a lot of<font color="#CCCCCC"> the details so</font>

51
00:02:00,759 --> 00:02:04,840
<font color="#E5E5E5">people can hopefully understand all the</font>

52
00:02:02,710 --> 00:02:08,019
components of<font color="#E5E5E5"> this so</font><font color="#CCCCCC"> okay we know the</font>

53
00:02:04,840 --> 00:02:10,150
<font color="#CCCCCC">Forester</font><font color="#E5E5E5"> boundaries but what if we had a</font>

54
00:02:08,020 --> 00:02:13,720
computer<font color="#E5E5E5"> and fourth day that</font>

55
00:02:10,150 --> 00:02:17,890
authenticates<font color="#E5E5E5"> to a system in forest</font><font color="#CCCCCC"> be</font>

56
00:02:13,720 --> 00:02:19,570
normal behavior bonus and this<font color="#E5E5E5"> will be</font>

57
00:02:17,890 --> 00:02:21,850
<font color="#E5E5E5">relevant later but bonus if we could</font>

58
00:02:19,570 --> 00:02:24,160
force a computer and<font color="#CCCCCC"> forestay to</font>

59
00:02:21,850 --> 00:02:28,630
authenticate<font color="#CCCCCC"> to a specific computer</font><font color="#E5E5E5"> we</font>

60
00:02:24,160 --> 00:02:30,670
want<font color="#E5E5E5"> enforce B then what if full ticket</font>

61
00:02:28,630 --> 00:02:33,130
granting ticket s-- TG<font color="#E5E5E5"> T's could move</font>

62
00:02:30,670 --> 00:02:36,940
<font color="#E5E5E5">across the forest boundaries from forest</font>

63
00:02:33,130 --> 00:02:39,370
a to force B and we had a way<font color="#E5E5E5"> to easily</font>

64
00:02:36,940 --> 00:02:41,829
extract and reuse these ticket granting

65
00:02:39,370 --> 00:02:43,240
ticket s--<font color="#E5E5E5"> while and for is</font><font color="#CCCCCC"> b so we're</font>

66
00:02:41,830 --> 00:02:44,800
in completely separate<font color="#CCCCCC"> forest</font>

67
00:02:43,240 --> 00:02:47,170
supposed to<font color="#E5E5E5"> be</font><font color="#CCCCCC"> even there supposed to</font><font color="#E5E5E5"> be</font>

68
00:02:44,800 --> 00:02:49,390
<font color="#E5E5E5">a boundary</font><font color="#CCCCCC"> between these</font><font color="#E5E5E5"> two but if you</font>

69
00:02:47,170 --> 00:02:51,220
could coerce authentication<font color="#E5E5E5"> and somehow</font>

70
00:02:49,390 --> 00:02:53,380
you can get these ticket granting ticket

71
00:02:51,220 --> 00:02:55,510
<font color="#E5E5E5">Stu flow over that boundary</font><font color="#CCCCCC"> and re</font>

72
00:02:53,380 --> 00:02:57,190
extract them in the other domain then

73
00:02:55,510 --> 00:03:00,010
there might be some<font color="#CCCCCC"> interesting ways</font>

74
00:02:57,190 --> 00:03:04,600
that<font color="#CCCCCC"> you could mess with</font><font color="#E5E5E5"> this concept of</font>

75
00:03:00,010 --> 00:03:07,329
<font color="#E5E5E5">forest as security values so we already</font>

76
00:03:04,600 --> 00:03:10,030
mentioned<font color="#E5E5E5"> some nomenclature that you may</font>

77
00:03:07,330 --> 00:03:12,430
or<font color="#CCCCCC"> may not</font><font color="#E5E5E5"> be familiar with so we're</font>

78
00:03:10,030 --> 00:03:16,240
gonna dive really quickly<font color="#E5E5E5"> into Kerberos</font>

79
00:03:12,430 --> 00:03:19,540
really fast<font color="#CCCCCC"> and</font><font color="#E5E5E5"> we</font><font color="#CCCCCC"> realize Kerberos is</font><font color="#E5E5E5"> a</font>

80
00:03:16,240 --> 00:03:21,790
massive<font color="#E5E5E5"> topic so we aren't gonna do go</font>

81
00:03:19,540 --> 00:03:24,130
into every nitty-gritty detail<font color="#E5E5E5"> behind it</font>

82
00:03:21,790 --> 00:03:25,720
<font color="#E5E5E5">we</font><font color="#CCCCCC"> definitely don't have time but we'll</font>

83
00:03:24,130 --> 00:03:30,120
focus<font color="#CCCCCC"> on the major points are</font><font color="#E5E5E5"> gonna be</font>

84
00:03:25,720 --> 00:03:33,730
relative or relative relevant<font color="#E5E5E5"> relevant</font>

85
00:03:30,120 --> 00:03:35,620
to this specific bug and as<font color="#E5E5E5"> always</font>

86
00:03:33,730 --> 00:03:37,540
there's a<font color="#E5E5E5"> we'll post this deck after</font>

87
00:03:35,620 --> 00:03:39,640
there's a link<font color="#E5E5E5"> from Shawn</font><font color="#CCCCCC"> Metcalf that</font>

88
00:03:37,540 --> 00:03:42,820
has like a complete<font color="#CCCCCC"> in-depth</font><font color="#E5E5E5"> you know</font>

89
00:03:39,640 --> 00:03:46,958
kind of Kerberos overview so Kerberos

90
00:03:42,820 --> 00:03:49,269
<font color="#CCCCCC">TLDR</font><font color="#E5E5E5"> when you say a person gets on their</font>

91
00:03:46,959 --> 00:03:51,040
computer<font color="#E5E5E5"> on</font><font color="#CCCCCC"> their keyboard</font><font color="#E5E5E5"> they type in</font>

92
00:03:49,270 --> 00:03:52,720
<font color="#CCCCCC">their password they're authenticating to</font>

93
00:03:51,040 --> 00:03:55,090
the domain controller<font color="#E5E5E5"> how does that</font>

94
00:03:52,720 --> 00:03:57,880
actually happen<font color="#CCCCCC"> they encrypt a piece of</font>

95
00:03:55,090 --> 00:03:59,680
data<font color="#E5E5E5"> and they send it</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> the DC and then</font>

96
00:03:57,880 --> 00:04:05,290
the DC validates that that was encrypted

97
00:03:59,680 --> 00:04:07,900
<font color="#E5E5E5">with their password if it was if the DC</font>

98
00:04:05,290 --> 00:04:08,440
<font color="#E5E5E5">validates</font><font color="#CCCCCC"> that</font><font color="#E5E5E5"> it it that password was</font>

99
00:04:07,900 --> 00:04:10,390
correct

100
00:04:08,440 --> 00:04:14,970
it returns what's called a ticket

101
00:04:10,390 --> 00:04:17,950
granting<font color="#E5E5E5"> ticket</font><font color="#CCCCCC"> so 80 GT</font><font color="#E5E5E5"> ATG T's it</font>

102
00:04:14,970 --> 00:04:21,399
contains inside of it a<font color="#E5E5E5"> pack the</font>

103
00:04:17,950 --> 00:04:24,430
privileged<font color="#E5E5E5"> authentication certain</font>

104
00:04:21,399 --> 00:04:26,539
attributes or certificate inside<font color="#E5E5E5"> of the</font>

105
00:04:24,430 --> 00:04:28,340
pack contains

106
00:04:26,540 --> 00:04:30,170
information about<font color="#CCCCCC"> that user who just</font>

107
00:04:28,340 --> 00:04:33,349
authenticated so that includes the user

108
00:04:30,170 --> 00:04:35,780
security<font color="#E5E5E5"> identifier and any</font><font color="#CCCCCC"> groups id's</font>

109
00:04:33,350 --> 00:04:38,720
that that user may also be a<font color="#E5E5E5"> part of so</font>

110
00:04:35,780 --> 00:04:40,880
<font color="#E5E5E5">the</font><font color="#CCCCCC"> pack is what kind of identifies that</font>

111
00:04:38,720 --> 00:04:46,430
user and the groups<font color="#E5E5E5"> that they they</font>

112
00:04:40,880 --> 00:04:49,550
belong to so once you<font color="#E5E5E5"> have once the user</font>

113
00:04:46,430 --> 00:04:52,790
has<font color="#E5E5E5"> a TGT the user may want to access a</font>

114
00:04:49,550 --> 00:04:56,630
service<font color="#E5E5E5"> so in that case the user</font>

115
00:04:52,790 --> 00:04:58,190
<font color="#E5E5E5">presents their ticket granting ticket to</font>

116
00:04:56,630 --> 00:05:01,640
the domain controller to<font color="#CCCCCC"> reach</font><font color="#E5E5E5"> and</font>

117
00:04:58,190 --> 00:05:04,460
requests a service ticket<font color="#E5E5E5"> so they send</font>

118
00:05:01,640 --> 00:05:07,789
their TGT to the<font color="#E5E5E5"> DC requesting a</font><font color="#CCCCCC"> service</font>

119
00:05:04,460 --> 00:05:11,870
ticket<font color="#E5E5E5"> and assuming that</font><font color="#CCCCCC"> TGT is valid</font>

120
00:05:07,790 --> 00:05:14,390
the DC is going<font color="#CCCCCC"> to return</font><font color="#E5E5E5"> a service</font>

121
00:05:11,870 --> 00:05:18,500
<font color="#E5E5E5">ticket</font><font color="#CCCCCC"> so now the</font><font color="#E5E5E5"> user has a TGT and a</font>

122
00:05:14,390 --> 00:05:21,320
service<font color="#CCCCCC"> ticket that that service ticket</font>

123
00:05:18,500 --> 00:05:23,300
<font color="#E5E5E5">also contains that those SIDS the group</font>

124
00:05:21,320 --> 00:05:26,090
<font color="#E5E5E5">SIDS and the user SIDS that identified</font>

125
00:05:23,300 --> 00:05:30,560
the user so one<font color="#E5E5E5"> once the user has a</font>

126
00:05:26,090 --> 00:05:33,260
service<font color="#E5E5E5"> ticket he presents that ticket</font>

127
00:05:30,560 --> 00:05:36,340
<font color="#E5E5E5">to whatever service he's</font><font color="#CCCCCC"> uh</font><font color="#E5E5E5"> he wants to</font>

128
00:05:33,260 --> 00:05:39,289
access<font color="#E5E5E5"> so if it's a</font><font color="#CCCCCC"> files file share</font>

129
00:05:36,340 --> 00:05:42,020
<font color="#E5E5E5">he's going to send the service ticket</font>

130
00:05:39,290 --> 00:05:44,330
<font color="#CCCCCC">over SMB to the file share the file</font>

131
00:05:42,020 --> 00:05:46,969
share is then<font color="#E5E5E5"> going</font><font color="#CCCCCC"> to decide whether</font><font color="#E5E5E5"> to</font>

132
00:05:44,330 --> 00:05:47,419
<font color="#CCCCCC">grant</font><font color="#E5E5E5"> that user access to resources on</font>

133
00:05:46,970 --> 00:05:49,730
the<font color="#CCCCCC"> phone</font>

134
00:05:47,420 --> 00:05:55,070
<font color="#CCCCCC">everyone's a Kerberos expert now like it</font>

135
00:05:49,730 --> 00:05:58,490
only we<font color="#E5E5E5"> will be reviewing a</font><font color="#CCCCCC"> lot of this</font>

136
00:05:55,070 --> 00:06:01,250
<font color="#E5E5E5">this is for reference</font><font color="#CCCCCC"> we do want to</font>

137
00:05:58,490 --> 00:06:04,360
mention<font color="#E5E5E5"> one slight change we didn't tell</font>

138
00:06:01,250 --> 00:06:06,470
you<font color="#E5E5E5"> everything</font><font color="#CCCCCC"> one when there's</font>

139
00:06:04,360 --> 00:06:09,470
<font color="#E5E5E5">authentication between multiple domains</font>

140
00:06:06,470 --> 00:06:12,170
there's one extra<font color="#E5E5E5"> step</font><font color="#CCCCCC"> so again this is</font>

141
00:06:09,470 --> 00:06:14,630
us requesting a TGT step number one

142
00:06:12,170 --> 00:06:16,130
we're<font color="#E5E5E5"> getting the TGT in two and then</font>

143
00:06:14,630 --> 00:06:18,370
what if we're trying<font color="#CCCCCC"> to access a</font>

144
00:06:16,130 --> 00:06:22,250
different forest or a different domain

145
00:06:18,370 --> 00:06:25,130
<font color="#CCCCCC">there's a step where you get</font><font color="#E5E5E5"> a tea a</font>

146
00:06:22,250 --> 00:06:27,650
referral ticket to the other<font color="#E5E5E5"> domain in a</font>

147
00:06:25,130 --> 00:06:29,330
<font color="#E5E5E5">roam ticket granting ticket and that's</font>

148
00:06:27,650 --> 00:06:31,849
<font color="#E5E5E5">the inner realm</font><font color="#CCCCCC"> dinner ticket granting</font>

149
00:06:29,330 --> 00:06:34,430
ticket<font color="#E5E5E5"> and so there's just an extra step</font>

150
00:06:31,850 --> 00:06:37,159
<font color="#E5E5E5">there that will dive into later on</font>

151
00:06:34,430 --> 00:06:40,729
<font color="#E5E5E5">because it's gonna become relevant</font>

152
00:06:37,159 --> 00:06:42,860
all right so that's<font color="#E5E5E5"> Kerberos in three</font>

153
00:06:40,729 --> 00:06:46,219
<font color="#E5E5E5">minutes and it makes perfect sense</font><font color="#CCCCCC"> we're</font>

154
00:06:42,860 --> 00:06:47,449
gonna cover a<font color="#E5E5E5"> a concept in Windows</font>

155
00:06:46,219 --> 00:06:49,429
Active Directory<font color="#CCCCCC"> in Kerberos called</font>

156
00:06:47,449 --> 00:06:51,110
delegation<font color="#E5E5E5"> which was touched on a little</font>

157
00:06:49,429 --> 00:06:52,399
<font color="#E5E5E5">bit yes a little bit yesterday in a</font>

158
00:06:51,110 --> 00:06:54,349
couple of talks and<font color="#E5E5E5"> I and</font><font color="#CCCCCC"> II talked</font>

159
00:06:52,399 --> 00:06:56,809
about<font color="#CCCCCC"> it</font><font color="#E5E5E5"> or talked about it but we're</font>

160
00:06:54,349 --> 00:06:58,909
gonna give our our<font color="#E5E5E5"> overview of it so in</font>

161
00:06:56,809 --> 00:07:01,069
general<font color="#E5E5E5"> there's a reason</font><font color="#CCCCCC"> that delegation</font>

162
00:06:58,909 --> 00:07:02,899
<font color="#CCCCCC">is needed in Active Directory so the</font>

163
00:07:01,069 --> 00:07:04,699
canonical<font color="#CCCCCC"> example is if you</font><font color="#E5E5E5"> have</font><font color="#CCCCCC"> like a</font>

164
00:07:02,899 --> 00:07:06,709
front-end<font color="#E5E5E5"> web server</font><font color="#CCCCCC"> that people</font>

165
00:07:04,699 --> 00:07:08,659
authenticate<font color="#CCCCCC"> to then that</font><font color="#E5E5E5"> web server</font>

166
00:07:06,709 --> 00:07:10,959
<font color="#CCCCCC">might need</font><font color="#E5E5E5"> to pretend to be</font><font color="#CCCCCC"> that user</font>

167
00:07:08,659 --> 00:07:14,589
<font color="#E5E5E5">when talking to say a back-end</font><font color="#CCCCCC"> database</font>

168
00:07:10,959 --> 00:07:16,849
so that<font color="#CCCCCC"> user</font><font color="#E5E5E5"> else to the front-end</font>

169
00:07:14,589 --> 00:07:19,249
front-end server needs to pretend<font color="#CCCCCC"> to be</font>

170
00:07:16,849 --> 00:07:21,259
a particular user to a<font color="#CCCCCC"> back-end</font><font color="#E5E5E5"> so there</font>

171
00:07:19,249 --> 00:07:22,699
is a<font color="#E5E5E5"> reason that delegation is needed</font>

172
00:07:21,259 --> 00:07:24,199
we've talked to a few<font color="#E5E5E5"> people</font><font color="#CCCCCC"> about some</font>

173
00:07:22,699 --> 00:07:27,499
of the recent delegation type<font color="#CCCCCC"> attacks</font>

174
00:07:24,199 --> 00:07:29,240
and a piece of<font color="#E5E5E5"> functionality</font><font color="#CCCCCC"> and a lot</font>

175
00:07:27,499 --> 00:07:30,619
<font color="#E5E5E5">of people like why is this even exist</font>

176
00:07:29,240 --> 00:07:33,199
like there's there's a<font color="#E5E5E5"> reason</font><font color="#CCCCCC"> it needs</font>

177
00:07:30,619 --> 00:07:35,659
<font color="#E5E5E5">to exist services need to</font><font color="#CCCCCC"> be able to</font>

178
00:07:33,199 --> 00:07:38,149
impersonate<font color="#CCCCCC"> or pretend to be users to</font>

179
00:07:35,659 --> 00:07:40,308
other back-end components so how does

180
00:07:38,149 --> 00:07:43,969
Microsoft do this there's three

181
00:07:40,309 --> 00:07:46,699
<font color="#CCCCCC">different ways the original</font><font color="#E5E5E5"> og way back</font>

182
00:07:43,969 --> 00:07:48,229
in Windows 2000<font color="#E5E5E5"> our domain functional</font>

183
00:07:46,699 --> 00:07:50,360
level 2000 as they introduced something

184
00:07:48,229 --> 00:07:52,089
called<font color="#E5E5E5"> unconstrained delegation this is</font>

185
00:07:50,360 --> 00:07:54,709
<font color="#E5E5E5">going to be what we're focusing on</font>

186
00:07:52,089 --> 00:07:56,599
there's also<font color="#E5E5E5"> traditional constrained</font>

187
00:07:54,709 --> 00:07:59,689
delegation<font color="#E5E5E5"> that uses s for you to self</font>

188
00:07:56,599 --> 00:08:03,378
<font color="#E5E5E5">sp2 proxy that was introduced in domain</font>

189
00:07:59,689 --> 00:08:05,089
functional level<font color="#CCCCCC"> I forget 2008 or no it</font>

190
00:08:03,379 --> 00:08:07,339
was uh they did<font color="#E5E5E5"> a bunch</font><font color="#CCCCCC"> of Kerberos</font>

191
00:08:05,089 --> 00:08:09,079
extensions and that's for you extensions

192
00:08:07,339 --> 00:08:10,729
and all<font color="#E5E5E5"> those kind of stuff there's also</font>

193
00:08:09,079 --> 00:08:13,399
<font color="#E5E5E5">and this is what was touched on in the</font>

194
00:08:10,729 --> 00:08:14,959
<font color="#E5E5E5">talks yesterday</font><font color="#CCCCCC"> there's some more</font><font color="#E5E5E5"> recent</font>

195
00:08:13,399 --> 00:08:17,959
resource<font color="#E5E5E5"> based constrained delegation</font>

196
00:08:14,959 --> 00:08:23,089
<font color="#CCCCCC">that</font><font color="#E5E5E5"> that was introduced of Windows</font>

197
00:08:17,959 --> 00:08:24,800
Server 2012<font color="#E5E5E5"> r2 I think that it's</font><font color="#CCCCCC"> just</font>

198
00:08:23,089 --> 00:08:26,479
<font color="#E5E5E5">like a different</font><font color="#CCCCCC"> way to constrain</font><font color="#E5E5E5"> the</font>

199
00:08:24,800 --> 00:08:28,219
delegation like to the particular target

200
00:08:26,479 --> 00:08:29,839
<font color="#E5E5E5">so the target says only certain people</font>

201
00:08:28,219 --> 00:08:31,909
<font color="#E5E5E5">can</font><font color="#CCCCCC"> like delegate to me and all I kind</font>

202
00:08:29,839 --> 00:08:33,828
<font color="#E5E5E5">of stuff we're focusing on again is</font>

203
00:08:31,909 --> 00:08:36,019
unconstrained<font color="#CCCCCC"> the most</font><font color="#E5E5E5"> dangerous and</font>

204
00:08:33,828 --> 00:08:38,899
kind of<font color="#E5E5E5"> the original so with</font>

205
00:08:36,019 --> 00:08:42,049
unconstrained delegation<font color="#CCCCCC"> a user will</font>

206
00:08:38,899 --> 00:08:44,120
request a forwarded TGT and<font color="#CCCCCC"> it'll send</font>

207
00:08:42,049 --> 00:08:45,740
this along<font color="#CCCCCC"> with the service ticket</font><font color="#E5E5E5"> when</font>

208
00:08:44,120 --> 00:08:48,559
it's authenticating to remote service

209
00:08:45,740 --> 00:08:50,209
the remote<font color="#E5E5E5"> service will extract the</font>

210
00:08:48,559 --> 00:08:52,670
ticket granting<font color="#E5E5E5"> ticket out of</font><font color="#CCCCCC"> that</font>

211
00:08:50,209 --> 00:08:54,469
exchange<font color="#E5E5E5"> and then it'll cash that ticket</font>

212
00:08:52,670 --> 00:08:57,139
granting ticket for a period<font color="#E5E5E5"> of time on</font>

213
00:08:54,470 --> 00:08:58,730
<font color="#E5E5E5">the machine</font><font color="#CCCCCC"> so if</font><font color="#E5E5E5"> I off to the front end</font>

214
00:08:57,139 --> 00:09:01,129
service I'm doing this with

215
00:08:58,730 --> 00:09:03,019
unconstrained delegation the front end

216
00:09:01,129 --> 00:09:06,110
service<font color="#E5E5E5"> now has my ticket</font><font color="#CCCCCC"> granting</font>

217
00:09:03,019 --> 00:09:08,829
ticket<font color="#E5E5E5"> and can pretend to</font><font color="#CCCCCC"> be</font><font color="#E5E5E5"> me to any</font>

218
00:09:06,110 --> 00:09:10,819
other service in the entire<font color="#CCCCCC"> domain</font>

219
00:09:08,829 --> 00:09:14,529
hopefully this seems like<font color="#CCCCCC"> you might be</font>

220
00:09:10,819 --> 00:09:16,790
slightly<font color="#E5E5E5"> scary to people because</font>

221
00:09:14,529 --> 00:09:17,480
<font color="#CCCCCC">unconstraint delegation is very very</font>

222
00:09:16,790 --> 00:09:19,579
dangerous

223
00:09:17,480 --> 00:09:21,649
<font color="#E5E5E5">Microsoft realized this that's why they</font>

224
00:09:19,579 --> 00:09:23,899
introduced the constrained or more

225
00:09:21,649 --> 00:09:27,199
restricted<font color="#E5E5E5"> flavors of delegation in the</font>

226
00:09:23,899 --> 00:09:29,089
past few years<font color="#E5E5E5"> the reason it's very very</font>

227
00:09:27,199 --> 00:09:30,829
<font color="#CCCCCC">dangerous is if an attacker can</font>

228
00:09:29,089 --> 00:09:33,920
<font color="#CCCCCC">compromise a server with unconstrained</font>

229
00:09:30,829 --> 00:09:36,498
delegation they can obtain<font color="#CCCCCC"> a TGT for any</font>

230
00:09:33,920 --> 00:09:38,269
non protected user who authenticates

231
00:09:36,499 --> 00:09:40,519
that server<font color="#E5E5E5"> so people that aren't in the</font>

232
00:09:38,269 --> 00:09:42,230
protected users groups<font color="#E5E5E5"> or don't have the</font>

233
00:09:40,519 --> 00:09:43,939
<font color="#E5E5E5">this account</font><font color="#CCCCCC"> is sensitive</font><font color="#E5E5E5"> and cannot be</font>

234
00:09:42,230 --> 00:09:45,499
delegated<font color="#E5E5E5"> setting which sadly most</font>

235
00:09:43,939 --> 00:09:47,629
<font color="#E5E5E5">places don't take advantage</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> those</font>

236
00:09:45,499 --> 00:09:49,850
like they should but anyways<font color="#CCCCCC"> I</font>

237
00:09:47,629 --> 00:09:51,589
<font color="#CCCCCC">compromised a rein in one constrained</font>

238
00:09:49,850 --> 00:09:53,660
delegation server and then<font color="#E5E5E5"> anyone that</font>

239
00:09:51,589 --> 00:09:56,420
authenticates to it I can extract<font color="#E5E5E5"> their</font>

240
00:09:53,660 --> 00:09:59,059
<font color="#CCCCCC">tea gt's out of memory</font><font color="#E5E5E5"> and then pretend</font>

241
00:09:56,420 --> 00:10:01,009
to<font color="#E5E5E5"> be</font><font color="#CCCCCC"> that person so the classic</font><font color="#E5E5E5"> attack</font>

242
00:09:59,059 --> 00:10:02,868
scenario for<font color="#E5E5E5"> this I think</font><font color="#CCCCCC"> Sean</font><font color="#E5E5E5"> Metcalfe</font>

243
00:10:01,009 --> 00:10:04,670
talked about was kind of like<font color="#E5E5E5"> a watering</font>

244
00:10:02,869 --> 00:10:06,230
hole type attack<font color="#E5E5E5"> or if you</font><font color="#CCCCCC"> compromised</font>

245
00:10:04,670 --> 00:10:08,660
this<font color="#E5E5E5"> type</font><font color="#CCCCCC"> of server or maybe you send</font>

246
00:10:06,230 --> 00:10:13,160
like a UNC<font color="#CCCCCC"> link in an</font><font color="#E5E5E5"> email</font><font color="#CCCCCC"> to an admin</font>

247
00:10:08,660 --> 00:10:14,809
<font color="#E5E5E5">or you do like a an</font><font color="#CCCCCC"> Ellen Kay file</font><font color="#E5E5E5"> and a</font>

248
00:10:13,160 --> 00:10:16,610
file share somehow<font color="#E5E5E5"> you're trying to</font>

249
00:10:14,809 --> 00:10:21,199
<font color="#CCCCCC">coerce people to connect to</font><font color="#E5E5E5"> basically</font>

250
00:10:16,610 --> 00:10:23,869
<font color="#E5E5E5">your capture server and</font><font color="#CCCCCC"> OneNote is a</font>

251
00:10:21,199 --> 00:10:26,479
modern domains only<font color="#E5E5E5"> domain controllers</font>

252
00:10:23,869 --> 00:10:28,429
<font color="#E5E5E5">by default are configured for</font>

253
00:10:26,480 --> 00:10:30,529
unconstrained delegation<font color="#E5E5E5"> so even the</font>

254
00:10:28,429 --> 00:10:32,420
<font color="#E5E5E5">most modern domains you are guaranteed</font>

255
00:10:30,529 --> 00:10:33,769
to<font color="#E5E5E5"> have at</font><font color="#CCCCCC"> least one server with</font>

256
00:10:32,420 --> 00:10:35,360
unconstrained delegation in<font color="#E5E5E5"> the</font>

257
00:10:33,769 --> 00:10:38,629
environment<font color="#E5E5E5"> so this is very very</font>

258
00:10:35,360 --> 00:10:41,149
<font color="#E5E5E5">important for this bug but beside that</font>

259
00:10:38,629 --> 00:10:43,759
<font color="#CCCCCC">we've seen many environments</font><font color="#E5E5E5"> that have</font>

260
00:10:41,149 --> 00:10:45,589
<font color="#CCCCCC">misconfigurations to where you know like</font>

261
00:10:43,759 --> 00:10:47,869
<font color="#E5E5E5">something with machine provisioning to</font>

262
00:10:45,589 --> 00:10:50,420
are like all<font color="#E5E5E5"> servers have unconstrained</font>

263
00:10:47,869 --> 00:10:52,879
delegation or desktops have it and this

264
00:10:50,420 --> 00:10:55,420
is a big enough of a security<font color="#E5E5E5"> issue that</font>

265
00:10:52,879 --> 00:10:57,679
<font color="#E5E5E5">we actually have like there's built-in</font>

266
00:10:55,420 --> 00:10:59,299
queries right Andy for bloodhound<font color="#E5E5E5"> to</font>

267
00:10:57,679 --> 00:11:02,360
like I'll<font color="#E5E5E5"> find all passed on constrained</font>

268
00:10:59,299 --> 00:11:03,980
servers and things<font color="#CCCCCC"> like that</font><font color="#E5E5E5"> so you</font><font color="#CCCCCC"> can</font>

269
00:11:02,360 --> 00:11:07,130
analyze<font color="#E5E5E5"> this stuff with bloodhound</font>

270
00:11:03,980 --> 00:11:09,170
either<font color="#E5E5E5"> recommend you do again just the</font>

271
00:11:07,130 --> 00:11:11,180
big<font color="#CCCCCC"> takeaway if if I as an attacker</font>

272
00:11:09,170 --> 00:11:11,740
<font color="#CCCCCC">compromised an unconstrained delegation</font>

273
00:11:11,180 --> 00:11:14,060
server

274
00:11:11,740 --> 00:11:16,580
anytime somebody authenticates to that

275
00:11:14,060 --> 00:11:18,829
server<font color="#E5E5E5"> I can impersonate that user so I</font>

276
00:11:16,580 --> 00:11:22,910
can I have<font color="#E5E5E5"> their TGT and can impersonate</font>

277
00:11:18,830 --> 00:11:24,800
that user<font color="#E5E5E5"> so was this kind</font><font color="#CCCCCC"> of look like</font>

278
00:11:22,910 --> 00:11:26,959
<font color="#E5E5E5">and these are my super</font><font color="#CCCCCC"> hack together</font>

279
00:11:24,800 --> 00:11:30,079
screenshots<font color="#CCCCCC"> but if we have the server</font>

280
00:11:26,960 --> 00:11:32,060
primary that is it has the trusted<font color="#E5E5E5"> for</font>

281
00:11:30,080 --> 00:11:33,620
delegation bit flipped in its user

282
00:11:32,060 --> 00:11:35,630
account control<font color="#CCCCCC"> attributes so this is</font>

283
00:11:33,620 --> 00:11:36,740
like a binary<font color="#E5E5E5"> blob of a bunch</font><font color="#CCCCCC"> of</font>

284
00:11:35,630 --> 00:11:39,050
<font color="#E5E5E5">different things that</font><font color="#CCCCCC"> control different</font>

285
00:11:36,740 --> 00:11:40,790
<font color="#E5E5E5">account behavior so the trusted for</font>

286
00:11:39,050 --> 00:11:42,859
delegation bit when its flipped<font color="#E5E5E5"> that</font>

287
00:11:40,790 --> 00:11:44,510
means<font color="#E5E5E5"> unconstrained delegation so I'm</font>

288
00:11:42,860 --> 00:11:47,150
just<font color="#CCCCCC"> showing you primary has</font>

289
00:11:44,510 --> 00:11:50,000
unconstrained delegation enabled<font color="#E5E5E5"> if I'm</font>

290
00:11:47,150 --> 00:11:52,310
on a<font color="#CCCCCC"> different system</font><font color="#E5E5E5"> and like</font><font color="#CCCCCC"> test</font><font color="#E5E5E5"> live</font>

291
00:11:50,000 --> 00:11:54,620
<font color="#E5E5E5">da and then</font><font color="#CCCCCC"> I just</font><font color="#E5E5E5"> do</font><font color="#CCCCCC"> like a directory</font>

292
00:11:52,310 --> 00:11:56,630
listing of that<font color="#E5E5E5"> primary server of</font><font color="#CCCCCC"> see</font>

293
00:11:54,620 --> 00:12:00,530
<font color="#E5E5E5">dollar I have access to</font><font color="#CCCCCC"> do that you know</font>

294
00:11:56,630 --> 00:12:02,060
goes through in the<font color="#CCCCCC"> backend</font><font color="#E5E5E5"> my TGT is</font>

295
00:12:00,530 --> 00:12:03,500
gonna be sent<font color="#CCCCCC"> with that service</font><font color="#E5E5E5"> ticket</font>

296
00:12:02,060 --> 00:12:07,130
<font color="#E5E5E5">request and everything in the</font><font color="#CCCCCC"> process</font>

297
00:12:03,500 --> 00:12:09,410
<font color="#E5E5E5">and the end result is my</font><font color="#CCCCCC"> da</font><font color="#E5E5E5"> ticket</font>

298
00:12:07,130 --> 00:12:11,840
granting ticket<font color="#E5E5E5"> is gonna be at</font><font color="#CCCCCC"> least for</font>

299
00:12:09,410 --> 00:12:13,850
a short period<font color="#CCCCCC"> of time</font><font color="#E5E5E5"> if not longer</font>

300
00:12:11,840 --> 00:12:15,680
it's<font color="#CCCCCC"> gonna</font><font color="#E5E5E5"> be in the memory of</font><font color="#CCCCCC"> that</font>

301
00:12:13,850 --> 00:12:17,120
<font color="#E5E5E5">primary machine so we're just proving to</font>

302
00:12:15,680 --> 00:12:19,760
you what we had on<font color="#CCCCCC"> the last</font><font color="#E5E5E5"> slide you</font>

303
00:12:17,120 --> 00:12:23,390
can see<font color="#E5E5E5"> all right the krbtgt that's the</font>

304
00:12:19,760 --> 00:12:25,310
server name<font color="#E5E5E5"> that's my TGT</font><font color="#CCCCCC"> and anyone who</font>

305
00:12:23,390 --> 00:12:27,680
has administrative access on<font color="#CCCCCC"> that</font>

306
00:12:25,310 --> 00:12:29,510
primary<font color="#E5E5E5"> server can then extract my</font>

307
00:12:27,680 --> 00:12:30,849
ticket granting ticket<font color="#E5E5E5"> and pretend to</font><font color="#CCCCCC"> be</font>

308
00:12:29,510 --> 00:12:37,010
<font color="#E5E5E5">me</font>

309
00:12:30,850 --> 00:12:39,050
very dangerous so unconstrained

310
00:12:37,010 --> 00:12:42,230
delegation is one component<font color="#E5E5E5"> another</font>

311
00:12:39,050 --> 00:12:47,140
<font color="#E5E5E5">thing that we</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> review is domain trusts</font>

312
00:12:42,230 --> 00:12:49,100
<font color="#E5E5E5">so quick background on trusts trust link</font>

313
00:12:47,140 --> 00:12:50,830
<font color="#E5E5E5">authentication systems of two different</font>

314
00:12:49,100 --> 00:12:53,210
<font color="#E5E5E5">domains so if you have multiple domains</font>

315
00:12:50,830 --> 00:12:54,920
<font color="#E5E5E5">inside of a forest or even</font><font color="#CCCCCC"> multiple</font>

316
00:12:53,210 --> 00:12:57,590
<font color="#E5E5E5">forest with the Wayne's inside of it</font>

317
00:12:54,920 --> 00:12:59,990
<font color="#E5E5E5">this allows you to</font><font color="#CCCCCC"> authenticate to</font><font color="#E5E5E5"> those</font>

318
00:12:57,590 --> 00:13:02,960
other domains so one user can access

319
00:12:59,990 --> 00:13:06,680
potentially<font color="#CCCCCC"> the resources in other</font>

320
00:13:02,960 --> 00:13:08,930
domains<font color="#E5E5E5"> so it again the whole purpose is</font>

321
00:13:06,680 --> 00:13:12,489
just<font color="#E5E5E5"> to allow this authentication</font><font color="#CCCCCC"> to</font>

322
00:13:08,930 --> 00:13:12,489
flow between each<font color="#CCCCCC"> door</font>

323
00:13:12,620 --> 00:13:19,160
how this<font color="#E5E5E5"> works is when a trust is set up</font>

324
00:13:16,750 --> 00:13:21,410
<font color="#CCCCCC">what gets created is a thing called a</font>

325
00:13:19,160 --> 00:13:24,860
inner realm<font color="#E5E5E5"> trust key so this is just an</font>

326
00:13:21,410 --> 00:13:26,990
encryption key that's used<font color="#CCCCCC"> it to</font><font color="#E5E5E5"> encrypt</font>

327
00:13:24,860 --> 00:13:28,970
Kerberos referral tickets<font color="#CCCCCC"> so if I'm a</font>

328
00:13:26,990 --> 00:13:32,060
user and I want to access a resource<font color="#CCCCCC"> and</font>

329
00:13:28,970 --> 00:13:34,070
another domain during the Kerberos

330
00:13:32,060 --> 00:13:37,069
process<font color="#E5E5E5"> one of those tickets is</font>

331
00:13:34,070 --> 00:13:41,330
encrypted using<font color="#CCCCCC"> the interim Trust key</font>

332
00:13:37,070 --> 00:13:43,700
<font color="#E5E5E5">that's that's</font><font color="#CCCCCC"> created</font><font color="#E5E5E5"> so there's these</font>

333
00:13:41,330 --> 00:13:45,740
different referrals that go on<font color="#E5E5E5"> again</font>

334
00:13:43,700 --> 00:13:48,620
<font color="#E5E5E5">when I'm accessing that other domain I</font>

335
00:13:45,740 --> 00:13:51,410
<font color="#E5E5E5">can</font><font color="#CCCCCC"> it's just back in a realm trust key</font>

336
00:13:48,620 --> 00:13:53,630
encrypts the<font color="#E5E5E5"> ticket granting</font><font color="#CCCCCC"> that inter</font>

337
00:13:51,410 --> 00:13:56,150
realm<font color="#E5E5E5"> ticket granting ticket so once I</font><font color="#CCCCCC"> I</font>

338
00:13:53,630 --> 00:13:58,010
talked to my<font color="#CCCCCC"> domain controller and I say</font>

339
00:13:56,150 --> 00:14:00,770
hey I want to access<font color="#CCCCCC"> this resource</font><font color="#E5E5E5"> in</font>

340
00:13:58,010 --> 00:14:04,250
another<font color="#E5E5E5"> domain it returns a referral</font>

341
00:14:00,770 --> 00:14:06,949
ticket encrypted with this interim key

342
00:14:04,250 --> 00:14:08,420
and then I send that<font color="#E5E5E5"> to a domain</font><font color="#CCCCCC"> control</font>

343
00:14:06,950 --> 00:14:10,580
<font color="#E5E5E5">to</font><font color="#CCCCCC"> the domain controller in</font><font color="#E5E5E5"> the other</font>

344
00:14:08,420 --> 00:14:14,110
<font color="#E5E5E5">domain</font><font color="#CCCCCC"> and because it's encrypted</font><font color="#E5E5E5"> with</font>

345
00:14:10,580 --> 00:14:17,240
that key it knows that it's a valid TGT

346
00:14:14,110 --> 00:14:19,130
and then<font color="#E5E5E5"> I can receive a service ticket</font>

347
00:14:17,240 --> 00:14:21,950
<font color="#E5E5E5">from that domain coach and fundamentally</font>

348
00:14:19,130 --> 00:14:23,360
<font color="#CCCCCC">trust</font><font color="#E5E5E5"> like</font><font color="#CCCCCC"> there trusts are weird to</font>

349
00:14:21,950 --> 00:14:25,280
where<font color="#CCCCCC"> they're you seem really simple but</font>

350
00:14:23,360 --> 00:14:26,990
<font color="#E5E5E5">also they're really complicated toward</font>

351
00:14:25,280 --> 00:14:29,180
this<font color="#E5E5E5"> really is all a trust is is they</font>

352
00:14:26,990 --> 00:14:31,100
<font color="#E5E5E5">these two domains</font><font color="#CCCCCC"> exchange a key and</font>

353
00:14:29,180 --> 00:14:32,930
<font color="#E5E5E5">they can like issue referrals between</font>

354
00:14:31,100 --> 00:14:34,730
each<font color="#E5E5E5"> other that's it it gets really</font>

355
00:14:32,930 --> 00:14:37,189
really<font color="#E5E5E5"> complicated with exactly how</font><font color="#CCCCCC"> the</font>

356
00:14:34,730 --> 00:14:38,240
referrals are honored depending<font color="#E5E5E5"> on the</font>

357
00:14:37,190 --> 00:14:40,310
different trust types and the different

358
00:14:38,240 --> 00:14:44,090
<font color="#CCCCCC">kind of characteristics</font><font color="#E5E5E5"> that we're going</font>

359
00:14:40,310 --> 00:14:47,300
<font color="#E5E5E5">to be going</font><font color="#CCCCCC"> through so like you said</font>

360
00:14:44,090 --> 00:14:49,400
there's different<font color="#E5E5E5"> kinds of trusts so and</font>

361
00:14:47,300 --> 00:14:52,910
trusts have direction<font color="#E5E5E5"> and transitivity</font>

362
00:14:49,400 --> 00:14:55,490
<font color="#CCCCCC">at transitivity</font><font color="#E5E5E5"> so first type</font><font color="#CCCCCC"> of trust</font>

363
00:14:52,910 --> 00:15:00,020
<font color="#E5E5E5">is a one-way trust so domain a</font><font color="#CCCCCC"> trusts</font>

364
00:14:55,490 --> 00:15:01,520
domain B so it's one directional<font color="#E5E5E5"> then</font>

365
00:15:00,020 --> 00:15:03,560
there's also two-way<font color="#CCCCCC"> trust which in</font>

366
00:15:01,520 --> 00:15:06,290
reality<font color="#E5E5E5"> is just two one-way trusts so a</font>

367
00:15:03,560 --> 00:15:09,260
trust B and B trust a that means

368
00:15:06,290 --> 00:15:11,209
<font color="#E5E5E5">authentication can flow from A to B or</font><font color="#CCCCCC"> B</font>

369
00:15:09,260 --> 00:15:13,480
to<font color="#CCCCCC"> it</font><font color="#E5E5E5"> and that's gonna be the</font><font color="#CCCCCC"> one that</font>

370
00:15:11,210 --> 00:15:15,760
<font color="#E5E5E5">we're gonna focus on primarily here</font>

371
00:15:13,480 --> 00:15:19,400
<font color="#CCCCCC">trusts also have a property called</font>

372
00:15:15,760 --> 00:15:22,970
<font color="#E5E5E5">transitivity so this is just saying if a</font>

373
00:15:19,400 --> 00:15:25,870
<font color="#CCCCCC">trust</font><font color="#E5E5E5"> b and b trusts c there for a</font>

374
00:15:22,970 --> 00:15:28,130
implicitly also trustee

375
00:15:25,870 --> 00:15:29,720
they don't have to be transitive<font color="#E5E5E5"> it's</font>

376
00:15:28,130 --> 00:15:33,740
just it can<font color="#CCCCCC"> be transferred or not ransom</font>

377
00:15:29,720 --> 00:15:36,260
<font color="#E5E5E5">yeah so you have the direction and the</font>

378
00:15:33,740 --> 00:15:39,500
transitivity<font color="#E5E5E5"> then there's also different</font>

379
00:15:36,260 --> 00:15:42,350
trust types you have<font color="#E5E5E5"> intra forest so</font>

380
00:15:39,500 --> 00:15:46,520
that's if you<font color="#E5E5E5"> have everything inside</font><font color="#CCCCCC"> of</font>

381
00:15:42,350 --> 00:15:48,890
a single forest<font color="#CCCCCC"> active</font><font color="#E5E5E5"> a single Active</font>

382
00:15:46,520 --> 00:15:50,689
Directory forest so the types there are

383
00:15:48,890 --> 00:15:53,150
parent-child which is probably the<font color="#E5E5E5"> most</font>

384
00:15:50,690 --> 00:15:57,770
common that you'll see and then you<font color="#E5E5E5"> have</font>

385
00:15:53,150 --> 00:15:59,600
cross link which is<font color="#E5E5E5"> just it yeah it's</font>

386
00:15:57,770 --> 00:16:03,170
just<font color="#E5E5E5"> another type</font><font color="#CCCCCC"> that helps a shortcut</font>

387
00:15:59,600 --> 00:16:06,620
<font color="#CCCCCC">yeah then you also have</font><font color="#E5E5E5"> inter domain</font>

388
00:16:03,170 --> 00:16:07,689
<font color="#E5E5E5">forest trusts so if you have multiple</font>

389
00:16:06,620 --> 00:16:10,160
forests

390
00:16:07,690 --> 00:16:12,800
<font color="#E5E5E5">inside of</font><font color="#CCCCCC"> your environment you may</font>

391
00:16:10,160 --> 00:16:14,390
create these<font color="#E5E5E5"> forest stress forced a may</font>

392
00:16:12,800 --> 00:16:17,569
want to trust one<font color="#CCCCCC"> of the domains in</font>

393
00:16:14,390 --> 00:16:19,670
<font color="#E5E5E5">forest</font><font color="#CCCCCC"> B likewise</font><font color="#E5E5E5"> you may have an</font>

394
00:16:17,570 --> 00:16:21,290
external<font color="#E5E5E5"> trust as well so it's</font><font color="#CCCCCC"> just</font>

395
00:16:19,670 --> 00:16:24,229
<font color="#CCCCCC">another</font><font color="#E5E5E5"> way that you can connect those</font>

396
00:16:21,290 --> 00:16:26,630
<font color="#E5E5E5">two disparate forests together</font>

397
00:16:24,230 --> 00:16:29,540
so external<font color="#E5E5E5"> trust or two between two</font>

398
00:16:26,630 --> 00:16:31,100
like single one-off domains<font color="#E5E5E5"> Microsoft</font>

399
00:16:29,540 --> 00:16:32,930
actually<font color="#E5E5E5"> doesn't really recommend these</font>

400
00:16:31,100 --> 00:16:34,940
<font color="#E5E5E5">they actually recommend forest trust</font>

401
00:16:32,930 --> 00:16:36,620
<font color="#E5E5E5">because it's much easier</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> get Kerberos</font>

402
00:16:34,940 --> 00:16:40,250
working<font color="#CCCCCC"> completely correctly</font><font color="#E5E5E5"> between</font>

403
00:16:36,620 --> 00:16:41,780
<font color="#E5E5E5">multiple domains</font><font color="#CCCCCC"> so but</font><font color="#E5E5E5"> again basically</font>

404
00:16:40,250 --> 00:16:43,940
we're gonna go<font color="#E5E5E5"> over that things within</font>

405
00:16:41,780 --> 00:16:45,949
<font color="#E5E5E5">the same forest</font><font color="#CCCCCC"> there's</font><font color="#E5E5E5"> no guarantee of</font>

406
00:16:43,940 --> 00:16:47,750
a<font color="#E5E5E5"> boundary and we'll go over why things</font>

407
00:16:45,950 --> 00:16:49,340
between<font color="#E5E5E5"> two forests they were supposed</font>

408
00:16:47,750 --> 00:16:53,570
to<font color="#E5E5E5"> be like isolated and we'll go over</font>

409
00:16:49,340 --> 00:16:55,220
<font color="#E5E5E5">the exact security protections so like</font>

410
00:16:53,570 --> 00:16:56,780
<font color="#E5E5E5">we mentioned before</font><font color="#CCCCCC"> so when you</font>

411
00:16:55,220 --> 00:16:59,270
authenticate you get a ticket granting

412
00:16:56,780 --> 00:17:00,949
ticket<font color="#E5E5E5"> inside</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> that ticket granting</font>

413
00:16:59,270 --> 00:17:06,319
ticket<font color="#E5E5E5"> is the privileged account</font>

414
00:17:00,950 --> 00:17:10,010
certificate<font color="#E5E5E5"> so the</font><font color="#CCCCCC"> prison that's inside</font>

415
00:17:06,319 --> 00:17:12,800
of<font color="#CCCCCC"> the TGT the TGT</font><font color="#E5E5E5"> inside of that pack</font>

416
00:17:10,010 --> 00:17:15,109
<font color="#E5E5E5">it contains information about who the</font>

417
00:17:12,800 --> 00:17:17,990
user is<font color="#E5E5E5"> and the group said that</font><font color="#CCCCCC"> user</font><font color="#E5E5E5"> is</font>

418
00:17:15,109 --> 00:17:20,469
a part of so and that's made<font color="#CCCCCC"> possible</font>

419
00:17:17,990 --> 00:17:22,520
through security<font color="#CCCCCC"> identifier z' so a</font>

420
00:17:20,470 --> 00:17:24,920
different<font color="#E5E5E5"> way of</font><font color="#CCCCCC"> looking at this is you</font>

421
00:17:22,520 --> 00:17:27,500
have your<font color="#E5E5E5"> TGT there and then you have</font>

422
00:17:24,920 --> 00:17:29,900
the probably<font color="#CCCCCC"> the pack on the inside</font>

423
00:17:27,500 --> 00:17:31,840
there containing<font color="#E5E5E5"> various fields so you</font>

424
00:17:29,900 --> 00:17:35,960
<font color="#E5E5E5">have a field that identifies the user</font>

425
00:17:31,840 --> 00:17:37,669
<font color="#E5E5E5">itself and that's by their</font><font color="#CCCCCC"> sid you have</font>

426
00:17:35,960 --> 00:17:39,230
<font color="#E5E5E5">different groups</font><font color="#CCCCCC"> that that</font><font color="#E5E5E5"> user may</font>

427
00:17:37,670 --> 00:17:41,509
<font color="#E5E5E5">belong to</font>

428
00:17:39,230 --> 00:17:43,580
and then you may<font color="#CCCCCC"> also</font><font color="#E5E5E5"> have there's like</font>

429
00:17:41,509 --> 00:17:45,499
this extra<font color="#E5E5E5"> SIDS field that's using</font><font color="#CCCCCC"> for</font>

430
00:17:43,580 --> 00:17:51,199
<font color="#E5E5E5">but we covered yep that will dive into</font>

431
00:17:45,499 --> 00:17:53,899
in<font color="#E5E5E5"> just a little</font><font color="#CCCCCC"> bit so you have you</font>

432
00:17:51,200 --> 00:17:55,840
<font color="#CCCCCC">have your pack and there's</font><font color="#E5E5E5"> something</font>

433
00:17:53,899 --> 00:17:57,918
important that happens when you're

434
00:17:55,840 --> 00:18:00,619
authenticating to other domains<font color="#CCCCCC"> it's</font>

435
00:17:57,919 --> 00:18:03,609
this thing called CID filtering so when

436
00:18:00,619 --> 00:18:07,459
you authenticate to<font color="#E5E5E5"> a separate domain</font>

437
00:18:03,609 --> 00:18:09,559
<font color="#E5E5E5">the so I get</font><font color="#CCCCCC"> a TGT and then I want to</font>

438
00:18:07,460 --> 00:18:12,139
<font color="#CCCCCC">authenticate to another</font><font color="#E5E5E5"> domain</font>

439
00:18:09,559 --> 00:18:13,999
during that authentication process<font color="#CCCCCC"> the</font>

440
00:18:12,139 --> 00:18:17,600
remote domain controller<font color="#CCCCCC"> I'm trying</font><font color="#E5E5E5"> to</font>

441
00:18:13,999 --> 00:18:20,869
access is<font color="#E5E5E5"> going to analyze the SIDS that</font>

442
00:18:17,600 --> 00:18:23,779
are inside of my TG<font color="#CCCCCC"> T's pack</font><font color="#E5E5E5"> so you have</font>

443
00:18:20,869 --> 00:18:27,289
those<font color="#E5E5E5"> group SIDS that that I claim I am</font>

444
00:18:23,779 --> 00:18:29,200
<font color="#CCCCCC">a part of so the remote domain</font>

445
00:18:27,289 --> 00:18:31,730
<font color="#E5E5E5">controller is going to analyze those and</font>

446
00:18:29,200 --> 00:18:33,859
depending<font color="#E5E5E5"> on the type of trust that we</font>

447
00:18:31,730 --> 00:18:38,059
<font color="#E5E5E5">have with that</font><font color="#CCCCCC"> domain</font><font color="#E5E5E5"> it's going to</font>

448
00:18:33,859 --> 00:18:39,918
filter the SIDS<font color="#E5E5E5"> inside of my pack</font><font color="#CCCCCC"> so it</font>

449
00:18:38,059 --> 00:18:44,350
what I mean by filters<font color="#E5E5E5"> it may just</font>

450
00:18:39,919 --> 00:18:47,690
remove them and which SIDS get removed

451
00:18:44,350 --> 00:18:51,109
<font color="#E5E5E5">depends and there's a long set</font><font color="#CCCCCC"> of rules</font>

452
00:18:47,690 --> 00:18:53,359
<font color="#E5E5E5">in ms pack</font><font color="#CCCCCC"> we</font><font color="#E5E5E5"> have to link there</font><font color="#CCCCCC"> there's</font>

453
00:18:51,109 --> 00:18:55,039
a large<font color="#E5E5E5"> giant table of rules like</font>

454
00:18:53,359 --> 00:18:57,080
<font color="#E5E5E5">depending on this these are in these</font>

455
00:18:55,039 --> 00:18:59,119
<font color="#E5E5E5">situations filter but these aren't this</font>

456
00:18:57,080 --> 00:19:01,699
trust type then remove these says if

457
00:18:59,119 --> 00:19:06,109
it's this<font color="#E5E5E5"> kind</font><font color="#CCCCCC"> of trust</font><font color="#E5E5E5"> do this so for</font>

458
00:19:01,700 --> 00:19:08,899
reference<font color="#E5E5E5"> go look at that</font><font color="#CCCCCC"> document</font><font color="#E5E5E5"> but</font>

459
00:19:06,109 --> 00:19:10,309
<font color="#CCCCCC">the important thing</font><font color="#E5E5E5"> is that when you're</font>

460
00:19:08,899 --> 00:19:14,658
authenticating between two different

461
00:19:10,309 --> 00:19:16,580
forests so just as an example<font color="#E5E5E5"> if I'm</font>

462
00:19:14,659 --> 00:19:19,970
<font color="#CCCCCC">enforce</font><font color="#E5E5E5"> a trying to get into fours be</font>

463
00:19:16,580 --> 00:19:24,049
the<font color="#E5E5E5"> TG T's one of the common filters</font>

464
00:19:19,970 --> 00:19:26,450
that occurs is that<font color="#CCCCCC"> the</font><font color="#E5E5E5"> my ticket so</font>

465
00:19:24,049 --> 00:19:30,289
when I try and<font color="#E5E5E5"> access</font><font color="#CCCCCC"> a different</font><font color="#E5E5E5"> forest</font>

466
00:19:26,450 --> 00:19:32,239
<font color="#E5E5E5">my ticket should not contain privileged</font>

467
00:19:30,289 --> 00:19:34,009
groups in the other<font color="#CCCCCC"> forest like domain</font>

468
00:19:32,239 --> 00:19:36,409
admins Enterprise admins like these

469
00:19:34,009 --> 00:19:39,379
highly privileged groups<font color="#E5E5E5"> so what happens</font>

470
00:19:36,409 --> 00:19:42,619
is<font color="#E5E5E5"> even if I have those SIDS in my my</font>

471
00:19:39,379 --> 00:19:44,119
pack in my ticket<font color="#E5E5E5"> when I authenticate to</font>

472
00:19:42,619 --> 00:19:47,359
that other domain it's actually going to

473
00:19:44,119 --> 00:19:49,220
remove<font color="#E5E5E5"> them so that when I get a ticket</font>

474
00:19:47,359 --> 00:19:52,399
<font color="#E5E5E5">back I'm not actually gonna have those</font>

475
00:19:49,220 --> 00:19:54,820
privileges<font color="#E5E5E5"> that being</font>

476
00:19:52,400 --> 00:19:58,010
said there are it's only for those

477
00:19:54,820 --> 00:20:00,639
defined privileged groups<font color="#E5E5E5"> in those rules</font>

478
00:19:58,010 --> 00:20:06,350
<font color="#CCCCCC">so</font><font color="#E5E5E5"> you may be able to inject other</font><font color="#CCCCCC"> SIDS</font>

479
00:20:00,640 --> 00:20:08,780
<font color="#E5E5E5">that aren't filtered so why do we</font>

480
00:20:06,350 --> 00:20:11,629
<font color="#CCCCCC">mention this so</font><font color="#E5E5E5"> CID filter means whole</font>

481
00:20:08,780 --> 00:20:14,120
<font color="#CCCCCC">purpose is to</font><font color="#E5E5E5"> well</font><font color="#CCCCCC"> Prime one of the</font>

482
00:20:11,630 --> 00:20:17,720
effects of CID filtering is it prevents

483
00:20:14,120 --> 00:20:21,110
a trusted domain or forest from

484
00:20:17,720 --> 00:20:25,490
compromising another a trusting domain

485
00:20:21,110 --> 00:20:27,949
<font color="#E5E5E5">or forest so if if you set up a brand</font>

486
00:20:25,490 --> 00:20:30,470
<font color="#E5E5E5">new if you set up</font><font color="#CCCCCC"> two brand</font><font color="#E5E5E5"> new forests</font>

487
00:20:27,950 --> 00:20:32,690
and you create a trust<font color="#E5E5E5"> between them like</font>

488
00:20:30,470 --> 00:20:35,000
a<font color="#E5E5E5"> bi-directional trust just because you</font>

489
00:20:32,690 --> 00:20:38,780
have those set up<font color="#E5E5E5"> those</font><font color="#CCCCCC"> trust set up</font>

490
00:20:35,000 --> 00:20:41,090
<font color="#CCCCCC">does</font><font color="#E5E5E5"> not mean that one forest should now</font>

491
00:20:38,780 --> 00:20:45,110
be able to compromise<font color="#CCCCCC"> the other forest</font>

492
00:20:41,090 --> 00:20:47,120
<font color="#E5E5E5">and so how that why that's the cases is</font>

493
00:20:45,110 --> 00:20:48,620
due to<font color="#CCCCCC"> CID filtering this is the main</font>

494
00:20:47,120 --> 00:20:50,239
security<font color="#E5E5E5"> protection there was the</font>

495
00:20:48,620 --> 00:20:53,629
enforcement of<font color="#E5E5E5"> the security boundary</font>

496
00:20:50,240 --> 00:20:56,090
concept with Active Directory for us so

497
00:20:53,630 --> 00:20:58,280
this<font color="#E5E5E5"> is but also we're gonna dive</font><font color="#CCCCCC"> right</font>

498
00:20:56,090 --> 00:21:00,169
back<font color="#E5E5E5"> in and touch on some Benjamin Delpy</font>

499
00:20:58,280 --> 00:21:02,090
work along<font color="#CCCCCC"> with some of the stuff he did</font>

500
00:21:00,170 --> 00:21:04,070
with<font color="#CCCCCC"> Metcalf a couple years ago</font><font color="#E5E5E5"> but this</font>

501
00:21:02,090 --> 00:21:06,350
<font color="#E5E5E5">is why the domain itself is not a</font>

502
00:21:04,070 --> 00:21:09,230
<font color="#E5E5E5">security boundary so we talked about in</font>

503
00:21:06,350 --> 00:21:11,060
that<font color="#CCCCCC"> ms pact documentation this giant</font>

504
00:21:09,230 --> 00:21:12,740
set<font color="#CCCCCC"> of rules that</font><font color="#E5E5E5"> says these certain</font>

505
00:21:11,060 --> 00:21:14,990
SIDS are<font color="#E5E5E5"> filtered out</font><font color="#CCCCCC"> and other ones</font>

506
00:21:12,740 --> 00:21:17,660
aren't<font color="#E5E5E5"> so there's a specific filtering</font>

507
00:21:14,990 --> 00:21:19,250
rule called for specific and these are

508
00:21:17,660 --> 00:21:21,170
for SIDS that are never allowed in a

509
00:21:19,250 --> 00:21:24,560
<font color="#CCCCCC">pack that originates from outside the</font>

510
00:21:21,170 --> 00:21:27,170
forest<font color="#E5E5E5"> so within this is</font><font color="#CCCCCC"> Enterprise</font>

511
00:21:24,560 --> 00:21:30,169
admins<font color="#E5E5E5"> so you notice it says originates</font>

512
00:21:27,170 --> 00:21:35,390
from outside the forest not outside<font color="#CCCCCC"> the</font>

513
00:21:30,170 --> 00:21:37,790
domain so<font color="#CCCCCC"> the</font><font color="#E5E5E5"> SID for enterprise admins</font>

514
00:21:35,390 --> 00:21:39,410
is not filtered out<font color="#CCCCCC"> you can just mention</font>

515
00:21:37,790 --> 00:21:42,680
if both domains<font color="#E5E5E5"> are within the same</font>

516
00:21:39,410 --> 00:21:44,960
forest<font color="#E5E5E5"> so if you can somehow set the</font><font color="#CCCCCC"> SID</font>

517
00:21:42,680 --> 00:21:48,140
history of your<font color="#E5E5E5"> ticket granting ticket</font>

518
00:21:44,960 --> 00:21:50,270
<font color="#E5E5E5">to be</font><font color="#CCCCCC"> Enterprise admins</font><font color="#E5E5E5"> which you can do</font>

519
00:21:48,140 --> 00:21:52,580
this with mimic<font color="#CCCCCC"> cots</font><font color="#E5E5E5"> you can escalate</font>

520
00:21:50,270 --> 00:21:54,560
from<font color="#E5E5E5"> a child</font><font color="#CCCCCC"> domain</font><font color="#E5E5E5"> to any force root</font>

521
00:21:52,580 --> 00:21:57,860
domain<font color="#E5E5E5"> so when I first learned this a</font>

522
00:21:54,560 --> 00:21:59,720
couple<font color="#E5E5E5"> years ago I remember</font><font color="#CCCCCC"> direct</font>

523
00:21:57,860 --> 00:22:01,939
messaging Benjamin it was like does this

524
00:21:59,720 --> 00:22:03,380
work how I think<font color="#E5E5E5"> it works and he said</font>

525
00:22:01,940 --> 00:22:05,530
sorry<font color="#E5E5E5"> for</font><font color="#CCCCCC"> your head</font><font color="#E5E5E5"> and said be some</font>

526
00:22:03,380 --> 00:22:07,000
gift of someone's like head exploding

527
00:22:05,530 --> 00:22:08,200
I was like I ran to<font color="#E5E5E5"> my bosses like guys</font>

528
00:22:07,000 --> 00:22:09,310
guys you<font color="#CCCCCC"> don't understand</font><font color="#E5E5E5"> this is the</font>

529
00:22:08,200 --> 00:22:11,380
coolest<font color="#E5E5E5"> thing ever</font><font color="#CCCCCC"> and they were like</font>

530
00:22:09,310 --> 00:22:12,760
what<font color="#E5E5E5"> are you talking about stop just we</font>

531
00:22:11,380 --> 00:22:13,870
just<font color="#CCCCCC"> want to eat dinner</font><font color="#E5E5E5"> man like stop</font>

532
00:22:12,760 --> 00:22:17,140
<font color="#E5E5E5">just shut up</font>

533
00:22:13,870 --> 00:22:18,969
so this was really<font color="#CCCCCC"> really cool</font><font color="#E5E5E5"> to</font><font color="#CCCCCC"> me</font>

534
00:22:17,140 --> 00:22:20,620
<font color="#E5E5E5">because</font><font color="#CCCCCC"> before when we would we we</font>

535
00:22:18,970 --> 00:22:22,090
attacked a lot<font color="#E5E5E5"> of</font><font color="#CCCCCC"> forests</font><font color="#E5E5E5"> and we attack</font>

536
00:22:20,620 --> 00:22:24,669
log domain<font color="#CCCCCC"> trusts and things when we do</font>

537
00:22:22,090 --> 00:22:26,230
<font color="#E5E5E5">Active Directory engagements so</font><font color="#CCCCCC"> before</font>

538
00:22:24,670 --> 00:22:28,030
if we compromised a child<font color="#CCCCCC"> domain</font><font color="#E5E5E5"> you</font>

539
00:22:26,230 --> 00:22:30,010
have<font color="#CCCCCC"> a forced lots of you know lots of</font>

540
00:22:28,030 --> 00:22:31,720
branches lots of domains within it<font color="#E5E5E5"> if we</font>

541
00:22:30,010 --> 00:22:33,220
compromised a child domain<font color="#E5E5E5"> all the way</font>

542
00:22:31,720 --> 00:22:34,720
down that forest tree we would have to

543
00:22:33,220 --> 00:22:36,640
like manually walk our<font color="#CCCCCC"> way up to the</font>

544
00:22:34,720 --> 00:22:39,190
<font color="#CCCCCC">forest route to try to compromise the</font>

545
00:22:36,640 --> 00:22:41,350
<font color="#E5E5E5">whole thing but now if you</font><font color="#CCCCCC"> compromised</font>

546
00:22:39,190 --> 00:22:43,510
domain admin credentials for five

547
00:22:41,350 --> 00:22:47,169
minutes<font color="#CCCCCC"> in any child domain in the</font>

548
00:22:43,510 --> 00:22:49,690
entire forest you DC sync you get the

549
00:22:47,170 --> 00:22:52,150
<font color="#CCCCCC">Kerry</font><font color="#E5E5E5"> be TGT of that child domain and</font>

550
00:22:49,690 --> 00:22:55,150
you just put slash seeds for the extra

551
00:22:52,150 --> 00:22:57,550
<font color="#CCCCCC">SIDS</font><font color="#E5E5E5"> in your forged golden ticket and</font>

552
00:22:55,150 --> 00:22:59,170
<font color="#CCCCCC">you set the SIDS to be enterprise admins</font>

553
00:22:57,550 --> 00:23:00,669
of<font color="#E5E5E5"> the forest route you could hop in</font>

554
00:22:59,170 --> 00:23:02,410
that<font color="#E5E5E5"> child domain all the way up to the</font>

555
00:23:00,670 --> 00:23:03,730
top<font color="#E5E5E5"> instantly in just a couple of</font>

556
00:23:02,410 --> 00:23:06,400
<font color="#CCCCCC">minutes we have done this in the</font><font color="#E5E5E5"> field</font>

557
00:23:03,730 --> 00:23:09,160
it's super super<font color="#E5E5E5"> cool and and again the</font>

558
00:23:06,400 --> 00:23:10,690
reason<font color="#CCCCCC"> why this works is because</font><font color="#E5E5E5"> even</font>

559
00:23:09,160 --> 00:23:13,990
though we're accessing<font color="#E5E5E5"> other domains</font>

560
00:23:10,690 --> 00:23:16,660
<font color="#E5E5E5">because</font><font color="#CCCCCC"> it's intra forest</font><font color="#E5E5E5"> the enterprise</font>

561
00:23:13,990 --> 00:23:18,610
admin<font color="#CCCCCC"> Sid</font><font color="#E5E5E5"> is not getting filtered yeah</font>

562
00:23:16,660 --> 00:23:20,380
whereas if we<font color="#E5E5E5"> were</font><font color="#CCCCCC"> trying</font><font color="#E5E5E5"> to</font><font color="#CCCCCC"> access a</font>

563
00:23:18,610 --> 00:23:22,419
different<font color="#E5E5E5"> forest</font><font color="#CCCCCC"> this would</font><font color="#E5E5E5"> not</font><font color="#CCCCCC"> work</font>

564
00:23:20,380 --> 00:23:28,300
<font color="#CCCCCC">then we have our obligatory we have</font>

565
00:23:22,420 --> 00:23:29,560
Benjamin<font color="#CCCCCC"> 3 so now but you know we keep</font>

566
00:23:28,300 --> 00:23:32,409
kind of hammering<font color="#E5E5E5"> this but that</font>

567
00:23:29,560 --> 00:23:34,450
<font color="#E5E5E5">protection was supposed to protect force</font>

568
00:23:32,410 --> 00:23:36,070
themselves<font color="#CCCCCC"> so I said</font><font color="#E5E5E5"> filtering these</font>

569
00:23:34,450 --> 00:23:39,010
sensitive groups does protect across

570
00:23:36,070 --> 00:23:41,320
forest boundaries this is why<font color="#E5E5E5"> people had</font>

571
00:23:39,010 --> 00:23:43,870
said for<font color="#E5E5E5"> a long time the forest is a</font>

572
00:23:41,320 --> 00:23:45,460
security boundary there is not supposed

573
00:23:43,870 --> 00:23:48,040
to<font color="#E5E5E5"> be away if you compromise forest a</font>

574
00:23:45,460 --> 00:23:49,960
that has a trust<font color="#E5E5E5"> for sb2 then you know</font>

575
00:23:48,040 --> 00:23:51,639
compromise the other<font color="#E5E5E5"> external one again</font>

576
00:23:49,960 --> 00:23:52,840
<font color="#E5E5E5">security</font><font color="#CCCCCC"> boundary</font><font color="#E5E5E5"> security</font><font color="#CCCCCC"> Bhaiji</font>

577
00:23:51,640 --> 00:23:56,320
security<font color="#E5E5E5"> about a new security</font><font color="#CCCCCC"> bed</font>

578
00:23:52,840 --> 00:23:58,990
<font color="#E5E5E5">according to Microsoft a couple other</font>

579
00:23:56,320 --> 00:24:01,000
like<font color="#E5E5E5"> little caveats though because I</font>

580
00:23:58,990 --> 00:24:02,500
swear half of our literal have literally

581
00:24:01,000 --> 00:24:05,680
<font color="#E5E5E5">half our job</font><font color="#CCCCCC"> is just</font><font color="#E5E5E5"> reading marched off</font>

582
00:24:02,500 --> 00:24:08,260
documentation which<font color="#CCCCCC"> is super fun but</font>

583
00:24:05,680 --> 00:24:10,090
within<font color="#E5E5E5"> those</font><font color="#CCCCCC"> Doc's there are were a</font>

584
00:24:08,260 --> 00:24:11,110
<font color="#E5E5E5">couple things that started to pop up in</font>

585
00:24:10,090 --> 00:24:13,360
the fall<font color="#CCCCCC"> and when you're reading these</font>

586
00:24:11,110 --> 00:24:14,830
<font color="#E5E5E5">things so one I mean some</font><font color="#CCCCCC"> of the</font>

587
00:24:13,360 --> 00:24:17,050
documentation<font color="#E5E5E5"> they say when users</font>

588
00:24:14,830 --> 00:24:19,120
authenticate<font color="#E5E5E5"> from a trusted forest they</font>

589
00:24:17,050 --> 00:24:21,309
<font color="#E5E5E5">receive the authenticated users</font>

590
00:24:19,120 --> 00:24:24,610
<font color="#CCCCCC">Syd</font><font color="#E5E5E5"> in their token</font><font color="#CCCCCC"> this is gonna be very</font>

591
00:24:21,309 --> 00:24:26,500
<font color="#CCCCCC">important later but this</font><font color="#E5E5E5"> is why if you</font>

592
00:24:24,610 --> 00:24:29,169
<font color="#CCCCCC">have like a forest of</font><font color="#E5E5E5"> forest trust you</font>

593
00:24:26,500 --> 00:24:30,430
can like query any LDAP information from

594
00:24:29,170 --> 00:24:32,500
a foreign forest because that's like a

595
00:24:30,430 --> 00:24:35,770
basic authenticated user type of

596
00:24:32,500 --> 00:24:39,190
permission<font color="#E5E5E5"> what's</font><font color="#CCCCCC"> even more interesting</font>

597
00:24:35,770 --> 00:24:41,290
<font color="#E5E5E5">is a server can use a delegated ticket</font>

598
00:24:39,190 --> 00:24:44,130
granting ticket<font color="#CCCCCC"> to connect as a user to</font>

599
00:24:41,290 --> 00:24:47,110
<font color="#CCCCCC">any server including those across a</font>

600
00:24:44,130 --> 00:24:49,510
one-way trust<font color="#E5E5E5"> this is like kind of the</font>

601
00:24:47,110 --> 00:24:51,459
crux of this entire bug is that

602
00:24:49,510 --> 00:24:55,950
delegated ticket granting tickets will

603
00:24:51,460 --> 00:24:55,950
work<font color="#CCCCCC"> across forest trust boundaries okay</font>

604
00:24:56,100 --> 00:25:02,709
<font color="#CCCCCC">so we've talked about</font><font color="#E5E5E5"> a lot just as a</font>

605
00:24:58,900 --> 00:25:04,809
<font color="#E5E5E5">quickly quick review so</font><font color="#CCCCCC"> delegated ticket</font>

606
00:25:02,710 --> 00:25:06,429
granting ticket s-- are usable across

607
00:25:04,809 --> 00:25:09,100
<font color="#E5E5E5">forest boundaries so if there's a</font>

608
00:25:06,429 --> 00:25:11,230
machine<font color="#E5E5E5"> and a separate forest that</font>

609
00:25:09,100 --> 00:25:12,428
authenticates to a machine<font color="#E5E5E5"> that</font>

610
00:25:11,230 --> 00:25:16,150
authenticates to an unconstrained

611
00:25:12,429 --> 00:25:18,340
<font color="#E5E5E5">delegation server in my forest then</font><font color="#CCCCCC"> i</font>

612
00:25:16,150 --> 00:25:20,920
<font color="#E5E5E5">can impersonate whoever authenticated to</font>

613
00:25:18,340 --> 00:25:26,199
<font color="#CCCCCC">my</font><font color="#E5E5E5"> machine even</font><font color="#CCCCCC"> if it's in another</font>

614
00:25:20,920 --> 00:25:28,270
<font color="#E5E5E5">forest so yep and so that means you know</font>

615
00:25:26,200 --> 00:25:31,660
as the attacker can impersonate a user

616
00:25:28,270 --> 00:25:34,300
in a different forest so<font color="#CCCCCC"> that begs</font><font color="#E5E5E5"> the</font>

617
00:25:31,660 --> 00:25:36,880
question you know can<font color="#CCCCCC"> we coerce</font><font color="#E5E5E5"> any</font>

618
00:25:34,300 --> 00:25:41,050
accounts<font color="#E5E5E5"> in a remote forest to</font>

619
00:25:36,880 --> 00:25:45,429
authenticate to<font color="#E5E5E5"> our forest</font><font color="#CCCCCC"> and why yes</font>

620
00:25:41,050 --> 00:25:49,230
yes we can<font color="#CCCCCC"> and that's where the printer</font>

621
00:25:45,429 --> 00:25:53,290
bug comes in handy<font color="#E5E5E5"> so the printer bug is</font>

622
00:25:49,230 --> 00:25:56,200
a little feature<font color="#E5E5E5"> I wouldn't really even</font>

623
00:25:53,290 --> 00:25:57,760
<font color="#E5E5E5">call it a bug it's a it's a feature that</font>

624
00:25:56,200 --> 00:26:01,420
will not be<font color="#E5E5E5"> fixed yes</font>

625
00:25:57,760 --> 00:26:03,070
so it's a it abuses an old protocol

626
00:26:01,420 --> 00:26:06,660
<font color="#E5E5E5">that's enabled by default so it's the</font>

627
00:26:03,070 --> 00:26:09,879
print system remote protocol MSRP<font color="#E5E5E5"> RN um</font>

628
00:26:06,660 --> 00:26:12,910
<font color="#E5E5E5">it's it's a well documented protocol</font>

629
00:26:09,880 --> 00:26:15,940
<font color="#E5E5E5">it's on</font><font color="#CCCCCC"> MSDN</font><font color="#E5E5E5"> and that's how I found it</font>

630
00:26:12,910 --> 00:26:18,429
was reading through<font color="#E5E5E5"> the documentation</font><font color="#CCCCCC"> on</font>

631
00:26:15,940 --> 00:26:22,000
<font color="#E5E5E5">this specific protocol</font><font color="#CCCCCC"> inside</font><font color="#E5E5E5"> of that</font>

632
00:26:18,429 --> 00:26:23,590
protocol there's a RPC method called RPC

633
00:26:22,000 --> 00:26:26,020
remote find first printer change

634
00:26:23,590 --> 00:26:28,600
notification<font color="#E5E5E5"> X</font><font color="#CCCCCC"> there's two of</font><font color="#E5E5E5"> them</font>

635
00:26:26,020 --> 00:26:31,179
actually<font color="#CCCCCC"> and so the whole purpose</font><font color="#E5E5E5"> of</font>

636
00:26:28,600 --> 00:26:32,919
this<font color="#E5E5E5"> RPC method is you you connect to a</font>

637
00:26:31,179 --> 00:26:37,330
printer<font color="#CCCCCC"> and you may</font><font color="#E5E5E5"> want to be notified</font>

638
00:26:32,920 --> 00:26:39,040
<font color="#CCCCCC">when when a print job occurs so you say</font>

639
00:26:37,330 --> 00:26:41,710
send me<font color="#CCCCCC"> a</font><font color="#E5E5E5"> notification every</font><font color="#CCCCCC"> time</font>

640
00:26:39,040 --> 00:26:44,950
there's a new print job<font color="#CCCCCC"> but there's a</font>

641
00:26:41,710 --> 00:26:49,330
feature<font color="#E5E5E5"> of this that during the the</font>

642
00:26:44,950 --> 00:26:51,940
setup<font color="#E5E5E5"> of this</font><font color="#CCCCCC"> notification can just say</font>

643
00:26:49,330 --> 00:26:55,090
hey<font color="#CCCCCC"> can</font><font color="#E5E5E5"> pay print server please notify</font>

644
00:26:51,940 --> 00:26:56,680
me please notify my computer<font color="#E5E5E5"> whenever</font>

645
00:26:55,090 --> 00:26:59,169
there's a new print job during<font color="#E5E5E5"> that</font>

646
00:26:56,680 --> 00:27:01,030
<font color="#CCCCCC">setup</font><font color="#E5E5E5"> that causes the remote print</font>

647
00:26:59,170 --> 00:27:04,720
server to authenticate back to me

648
00:27:01,030 --> 00:27:07,750
so the TLDR is<font color="#E5E5E5"> I'm on computer a</font>

649
00:27:04,720 --> 00:27:10,180
computer<font color="#CCCCCC"> B's over</font><font color="#E5E5E5"> there when I use this</font>

650
00:27:07,750 --> 00:27:12,910
<font color="#CCCCCC">computer B is going to authenticate to</font>

651
00:27:10,180 --> 00:27:16,660
me with this machine account with its

652
00:27:12,910 --> 00:27:20,560
<font color="#E5E5E5">machine account so this allows us</font><font color="#CCCCCC"> to</font>

653
00:27:16,660 --> 00:27:21,850
<font color="#E5E5E5">coerce authentication so this is this is</font>

654
00:27:20,560 --> 00:27:25,720
<font color="#E5E5E5">handy</font><font color="#CCCCCC"> in</font><font color="#E5E5E5"> a lot</font><font color="#CCCCCC"> of different scenarios</font>

655
00:27:21,850 --> 00:27:27,040
<font color="#E5E5E5">but and it's worth noting that this is</font>

656
00:27:25,720 --> 00:27:28,870
<font color="#E5E5E5">only</font><font color="#CCCCCC"> one technique</font>

657
00:27:27,040 --> 00:27:32,320
Microsoft has said that in a future

658
00:27:28,870 --> 00:27:35,610
<font color="#E5E5E5">version they might disable this but for</font>

659
00:27:32,320 --> 00:27:35,610
<font color="#E5E5E5">now it still works quite well</font>

660
00:27:35,880 --> 00:27:41,470
so<font color="#E5E5E5"> just a few details</font><font color="#CCCCCC"> behind it</font><font color="#E5E5E5"> like</font>

661
00:27:39,250 --> 00:27:43,330
that's some protocol information<font color="#CCCCCC"> one</font>

662
00:27:41,470 --> 00:27:46,420
thing I do want to note<font color="#E5E5E5"> is it's on TCP</font>

663
00:27:43,330 --> 00:27:49,800
<font color="#CCCCCC">four four</font><font color="#E5E5E5"> five it's using SMB RPC so</font>

664
00:27:46,420 --> 00:27:52,390
that's<font color="#E5E5E5"> exposed a lot in environments</font>

665
00:27:49,800 --> 00:27:55,330
<font color="#CCCCCC">likewise this is very important to note</font>

666
00:27:52,390 --> 00:27:58,690
is the RPC<font color="#E5E5E5"> server is accessible by</font>

667
00:27:55,330 --> 00:28:00,310
authenticated users<font color="#E5E5E5"> and on</font><font color="#CCCCCC"> Windows</font>

668
00:27:58,690 --> 00:28:02,530
greater than<font color="#E5E5E5"> eight</font><font color="#CCCCCC"> so number when I</font>

669
00:28:00,310 --> 00:28:04,899
mentioned<font color="#E5E5E5"> you</font><font color="#CCCCCC"> that very</font><font color="#E5E5E5"> specific thing</font>

670
00:28:02,530 --> 00:28:05,980
of between like<font color="#E5E5E5"> inter</font><font color="#CCCCCC"> force stuff</font><font color="#E5E5E5"> when</font>

671
00:28:04,900 --> 00:28:08,560
you get<font color="#E5E5E5"> that</font><font color="#CCCCCC"> referral you have</font>

672
00:28:05,980 --> 00:28:10,810
<font color="#E5E5E5">authenticated users and you're said this</font>

673
00:28:08,560 --> 00:28:13,000
<font color="#E5E5E5">means that anyone in forest a can</font>

674
00:28:10,810 --> 00:28:17,129
trigger the printer<font color="#E5E5E5"> callback course</font>

675
00:28:13,000 --> 00:28:17,130
authentication bug and<font color="#CCCCCC"> force be</font>

676
00:28:21,600 --> 00:28:26,370
so this is just<font color="#E5E5E5"> an</font><font color="#CCCCCC"> example</font><font color="#E5E5E5"> of</font><font color="#CCCCCC"> kind of</font>

677
00:28:23,250 --> 00:28:29,220
what it looks<font color="#CCCCCC"> like so at the</font><font color="#E5E5E5"> top I am</font><font color="#CCCCCC"> on</font>

678
00:28:26,370 --> 00:28:31,379
a machine called<font color="#CCCCCC"> wind</font><font color="#E5E5E5"> 10 I'm running as</font>

679
00:28:29,220 --> 00:28:34,260
the user marketer a low privileged user

680
00:28:31,380 --> 00:28:36,330
in the domain<font color="#E5E5E5"> and then I'm using a tool</font>

681
00:28:34,260 --> 00:28:39,480
called spool sample<font color="#E5E5E5"> which is an</font>

682
00:28:36,330 --> 00:28:42,389
<font color="#CCCCCC">implementation of this</font><font color="#E5E5E5"> so and all it's</font>

683
00:28:39,480 --> 00:28:43,380
<font color="#E5E5E5">saying is I'm using spool sampling</font>

684
00:28:42,390 --> 00:28:46,370
saying

685
00:28:43,380 --> 00:28:48,870
<font color="#E5E5E5">lab DC so that's a domain controller</font>

686
00:28:46,370 --> 00:28:51,419
<font color="#E5E5E5">please authenticate to the Windows 10</font>

687
00:28:48,870 --> 00:28:53,429
machine<font color="#E5E5E5"> so again I'm running as the</font>

688
00:28:51,420 --> 00:28:56,370
marketer user<font color="#E5E5E5"> super low privileged I</font>

689
00:28:53,430 --> 00:28:59,280
executed that<font color="#E5E5E5"> and now when I look</font><font color="#CCCCCC"> at the</font>

690
00:28:56,370 --> 00:29:01,169
logon<font color="#E5E5E5"> events I'm using seat belt which</font>

691
00:28:59,280 --> 00:29:03,090
is<font color="#E5E5E5"> one</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> our tools</font><font color="#CCCCCC"> when I look at the</font>

692
00:29:01,170 --> 00:29:06,270
logon events<font color="#E5E5E5"> I can see that the domain</font>

693
00:29:03,090 --> 00:29:08,310
controller<font color="#E5E5E5"> account authenticated back to</font>

694
00:29:06,270 --> 00:29:10,020
the Windows 10 machine<font color="#E5E5E5"> so this seems</font>

695
00:29:08,310 --> 00:29:12,480
hopefully this seems is bad to other

696
00:29:10,020 --> 00:29:14,820
people as it does to us<font color="#E5E5E5"> or like low</font>

697
00:29:12,480 --> 00:29:16,500
privilege or not privileged users it

698
00:29:14,820 --> 00:29:18,389
doesn't seem like they should<font color="#CCCCCC"> be allowed</font>

699
00:29:16,500 --> 00:29:20,670
<font color="#CCCCCC">to</font><font color="#E5E5E5"> force certain machines authenticate</font>

700
00:29:18,390 --> 00:29:23,490
<font color="#CCCCCC">to other machines Lee had reported this</font>

701
00:29:20,670 --> 00:29:25,560
a while<font color="#E5E5E5"> back in</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> general</font><font color="#CCCCCC"> opinion</font><font color="#E5E5E5"> I</font>

702
00:29:23,490 --> 00:29:27,510
believe<font color="#CCCCCC"> from like Microsoft and</font>

703
00:29:25,560 --> 00:29:29,760
<font color="#E5E5E5">everybody is like well</font><font color="#CCCCCC"> their machine</font>

704
00:29:27,510 --> 00:29:31,650
<font color="#E5E5E5">accounts so by default</font><font color="#CCCCCC"> there's not a way</font>

705
00:29:29,760 --> 00:29:34,560
that<font color="#CCCCCC"> you can abuse like this machine</font>

706
00:29:31,650 --> 00:29:36,630
<font color="#E5E5E5">account coerced authentication so these</font>

707
00:29:34,560 --> 00:29:38,639
kind<font color="#E5E5E5"> of been on a crusade</font><font color="#CCCCCC"> to try</font><font color="#E5E5E5"> to</font>

708
00:29:36,630 --> 00:29:40,260
prove<font color="#CCCCCC"> that no machine accounts can</font><font color="#E5E5E5"> be</font>

709
00:29:38,640 --> 00:29:43,050
very very<font color="#CCCCCC"> useful</font><font color="#E5E5E5"> from an authentication</font>

710
00:29:40,260 --> 00:29:45,240
standpoint like offensively<font color="#E5E5E5"> and this is</font>

711
00:29:43,050 --> 00:29:46,620
one application<font color="#E5E5E5"> with the the trust bug</font>

712
00:29:45,240 --> 00:29:49,170
<font color="#CCCCCC">I'm about</font><font color="#E5E5E5"> to put all the pieces together</font>

713
00:29:46,620 --> 00:29:52,290
<font color="#E5E5E5">where we are able to use these machine</font>

714
00:29:49,170 --> 00:29:54,660
accounts in a very interesting way<font color="#E5E5E5"> all</font>

715
00:29:52,290 --> 00:29:56,879
right<font color="#E5E5E5"> so let's smash some forest trust</font>

716
00:29:54,660 --> 00:29:58,890
<font color="#E5E5E5">put all the pieces together here's our</font>

717
00:29:56,880 --> 00:30:02,550
scenario<font color="#E5E5E5"> an attacker completely</font>

718
00:29:58,890 --> 00:30:03,870
compromises force be like I'd mentioned

719
00:30:02,550 --> 00:30:05,850
<font color="#E5E5E5">you're always going</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> have at</font><font color="#CCCCCC"> least one</font>

720
00:30:03,870 --> 00:30:08,129
server<font color="#CCCCCC"> and a forest</font><font color="#E5E5E5"> or a domain</font><font color="#CCCCCC"> that has</font>

721
00:30:05,850 --> 00:30:09,959
on constrained delegation<font color="#CCCCCC"> so we're in</font>

722
00:30:08,130 --> 00:30:13,290
control<font color="#CCCCCC"> a force</font><font color="#E5E5E5"> B is</font><font color="#CCCCCC"> two main controller</font>

723
00:30:09,960 --> 00:30:17,130
that<font color="#CCCCCC"> has on constrained delegation force</font>

724
00:30:13,290 --> 00:30:20,010
B has a<font color="#CCCCCC"> two-way forest trust before a</font>

725
00:30:17,130 --> 00:30:23,070
<font color="#CCCCCC">state no other configuration no other</font>

726
00:30:20,010 --> 00:30:27,420
nested groups<font color="#E5E5E5"> no other anything this</font><font color="#CCCCCC"> is</font>

727
00:30:23,070 --> 00:30:28,620
<font color="#CCCCCC">it stock as you can possibly get the</font>

728
00:30:27,420 --> 00:30:30,570
tools are going to<font color="#CCCCCC"> be using the scenario</font>

729
00:30:28,620 --> 00:30:32,699
<font color="#E5E5E5">are going to be</font><font color="#CCCCCC"> Rubeus for TGT</font>

730
00:30:30,570 --> 00:30:34,350
monitoring and<font color="#CCCCCC"> extraction the spool</font>

731
00:30:32,700 --> 00:30:35,470
sample implementation<font color="#E5E5E5"> for Korra stopped</font>

732
00:30:34,350 --> 00:30:38,320
indication of the<font color="#CCCCCC"> Printrbot</font>

733
00:30:35,470 --> 00:30:42,129
and then of course mimic<font color="#CCCCCC"> cots with DC</font>

734
00:30:38,320 --> 00:30:44,950
<font color="#CCCCCC">sync</font><font color="#E5E5E5"> so this is what we're gonna do we</font>

735
00:30:42,129 --> 00:30:47,320
have our<font color="#CCCCCC"> compromised forest force B we</font>

736
00:30:44,950 --> 00:30:49,659
have our victim<font color="#CCCCCC"> forest forest day we've</font>

737
00:30:47,320 --> 00:30:53,470
compromised this little<font color="#CCCCCC"> DCB guy</font><font color="#E5E5E5"> right</font>

738
00:30:49,659 --> 00:30:56,230
here so from<font color="#CCCCCC"> here I'm gonna say hey</font>

739
00:30:53,470 --> 00:30:59,049
domain controller<font color="#E5E5E5"> a please Afeni Kate</font><font color="#CCCCCC"> -</font>

740
00:30:56,230 --> 00:31:03,039
domain controller B I can<font color="#CCCCCC"> do this</font><font color="#E5E5E5"> with</font>

741
00:30:59,049 --> 00:31:06,158
that with the<font color="#E5E5E5"> RPC printer bug</font><font color="#CCCCCC"> and when</font>

742
00:31:03,039 --> 00:31:09,549
this happens<font color="#E5E5E5"> DCA is going to</font>

743
00:31:06,159 --> 00:31:11,500
authenticate back to<font color="#E5E5E5"> DC B with its</font>

744
00:31:09,549 --> 00:31:14,350
<font color="#E5E5E5">machine account so I'm gonna get that</font>

745
00:31:11,500 --> 00:31:17,740
<font color="#CCCCCC">DCA dollar account that's gonna thinik 8</font>

746
00:31:14,350 --> 00:31:20,320
over SMB<font color="#E5E5E5"> - domain controller B and it'll</font>

747
00:31:17,740 --> 00:31:22,570
send is ticket granting ticket because

748
00:31:20,320 --> 00:31:24,039
<font color="#E5E5E5">of unconstrained delegation and those</font>

749
00:31:22,570 --> 00:31:26,139
default trust settings that allow

750
00:31:24,039 --> 00:31:28,570
delegated tickets to flow<font color="#E5E5E5"> across forest</font>

751
00:31:26,139 --> 00:31:30,399
boundaries so these first<font color="#E5E5E5"> two parts this</font>

752
00:31:28,570 --> 00:31:31,960
is<font color="#CCCCCC"> the</font><font color="#E5E5E5"> printer bug and we can trigger</font>

753
00:31:30,399 --> 00:31:33,850
the printer bug in the foreign<font color="#E5E5E5"> forest</font>

754
00:31:31,960 --> 00:31:36,399
because that authenticated user said

755
00:31:33,850 --> 00:31:38,830
that group is the<font color="#CCCCCC"> only permission</font><font color="#E5E5E5"> we</font>

756
00:31:36,399 --> 00:31:41,830
need by default to trigger this and then

757
00:31:38,830 --> 00:31:43,658
DCA's<font color="#E5E5E5"> machine account TGT</font><font color="#CCCCCC"> this is gonna</font>

758
00:31:41,830 --> 00:31:48,059
flow back because of default trust

759
00:31:43,659 --> 00:31:52,299
settings the attacker will then extract

760
00:31:48,059 --> 00:31:53,860
<font color="#E5E5E5">DC dollars</font><font color="#CCCCCC"> take a granting ticket out</font><font color="#E5E5E5"> of</font>

761
00:31:52,299 --> 00:31:56,139
memory<font color="#CCCCCC"> which we can do</font><font color="#E5E5E5"> because we're</font>

762
00:31:53,860 --> 00:32:00,189
admin on the server<font color="#E5E5E5"> we're gonna submit</font>

763
00:31:56,139 --> 00:32:03,490
that to LSA<font color="#E5E5E5"> and now we it is as if</font><font color="#CCCCCC"> we</font>

764
00:32:00,190 --> 00:32:06,340
are<font color="#E5E5E5"> DC a</font><font color="#CCCCCC"> dollar and then we can just DC</font>

765
00:32:03,490 --> 00:32:09,399
sync DC<font color="#E5E5E5"> a dollar and compromise all the</font>

766
00:32:06,340 --> 00:32:12,039
credential material in the forest for

767
00:32:09,399 --> 00:32:14,768
<font color="#E5E5E5">forest a so this is the entire attack</font>

768
00:32:12,039 --> 00:32:16,149
there's not a ton<font color="#E5E5E5"> of moving pieces it's</font>

769
00:32:14,769 --> 00:32:17,409
just kind of chaining<font color="#CCCCCC"> together a couple</font>

770
00:32:16,149 --> 00:32:20,018
<font color="#CCCCCC">of these things of Oh course</font>

771
00:32:17,409 --> 00:32:20,889
authentication<font color="#E5E5E5"> pull the ticket out and</font>

772
00:32:20,019 --> 00:32:23,049
you're basically<font color="#E5E5E5"> doing almost like</font>

773
00:32:20,889 --> 00:32:24,250
Kerberos ticket reflection back back to

774
00:32:23,049 --> 00:32:27,820
the server<font color="#E5E5E5"> it is kind of funny to me</font>

775
00:32:24,250 --> 00:32:30,879
<font color="#CCCCCC">that like DC</font><font color="#E5E5E5"> a will accept a DC</font>

776
00:32:27,820 --> 00:32:32,259
synchronization request from itself<font color="#E5E5E5"> from</font>

777
00:32:30,879 --> 00:32:34,259
<font color="#E5E5E5">a</font><font color="#CCCCCC"> different</font><font color="#E5E5E5"> location that's kind of</font>

778
00:32:32,259 --> 00:32:37,200
<font color="#E5E5E5">weird but anyways that's how it works</font>

779
00:32:34,259 --> 00:32:39,610
<font color="#E5E5E5">so this is a video should start playing</font>

780
00:32:37,200 --> 00:32:41,350
<font color="#E5E5E5">so I know the text a</font><font color="#CCCCCC"> little small we</font>

781
00:32:39,610 --> 00:32:43,649
can't zoom unfortunately anyways we have

782
00:32:41,350 --> 00:32:45,759
<font color="#E5E5E5">forced a is a</font><font color="#CCCCCC"> two-way trust so</font><font color="#E5E5E5"> force B</font>

783
00:32:43,649 --> 00:32:47,529
we're gonna start monitoring<font color="#E5E5E5"> for new</font>

784
00:32:45,759 --> 00:32:48,820
ticket granting ticket<font color="#E5E5E5"> s-- on this</font>

785
00:32:47,529 --> 00:32:49,690
domain controller<font color="#E5E5E5"> bead that we've</font>

786
00:32:48,820 --> 00:32:51,399
compromised

787
00:32:49,690 --> 00:32:53,950
we're<font color="#E5E5E5"> gonna trigger the printer bug</font>

788
00:32:51,400 --> 00:32:57,160
against<font color="#E5E5E5"> domain controller a from domain</font>

789
00:32:53,950 --> 00:32:59,530
controller<font color="#CCCCCC"> B it's gonna</font><font color="#E5E5E5"> be waiting this</font>

790
00:32:57,160 --> 00:33:01,660
<font color="#E5E5E5">is that we see</font><font color="#CCCCCC"> for six to four events we</font>

791
00:32:59,530 --> 00:33:05,260
<font color="#CCCCCC">see the full the blob of the ticket</font>

792
00:33:01,660 --> 00:33:08,020
granting ticket for<font color="#CCCCCC"> DCA this is the</font>

793
00:33:05,260 --> 00:33:11,980
<font color="#E5E5E5">Rubeus</font><font color="#CCCCCC"> I'm just gonna pull the base64</font>

794
00:33:08,020 --> 00:33:16,750
representation of that<font color="#E5E5E5"> out I'm gonna</font>

795
00:33:11,980 --> 00:33:20,680
just replace all the new lines my

796
00:33:16,750 --> 00:33:24,760
<font color="#E5E5E5">super-awesome regex</font><font color="#CCCCCC"> kills alright okay</font>

797
00:33:20,680 --> 00:33:27,400
<font color="#CCCCCC">so now we have a base64 blob</font><font color="#E5E5E5"> that is</font><font color="#CCCCCC"> DCA</font>

798
00:33:24,760 --> 00:33:29,890
is to<font color="#E5E5E5"> granny ticket we're gonna describe</font>

799
00:33:27,400 --> 00:33:35,830
<font color="#E5E5E5">it</font><font color="#CCCCCC"> just to like prove to you that yep</font>

800
00:33:29,890 --> 00:33:39,310
<font color="#CCCCCC">it's</font><font color="#E5E5E5"> DCA krbtgt then we're going</font><font color="#CCCCCC"> to pass</font>

801
00:33:35,830 --> 00:33:41,320
the ticket with this blob so we're gonna

802
00:33:39,310 --> 00:33:44,110
<font color="#CCCCCC">import</font><font color="#E5E5E5"> that now it is as if</font><font color="#CCCCCC"> we are</font>

803
00:33:41,320 --> 00:33:48,580
domain controller a and then we're gonna

804
00:33:44,110 --> 00:33:50,919
meet<font color="#E5E5E5"> me cats DC sync forest a the</font>

805
00:33:48,580 --> 00:33:53,110
foreign<font color="#CCCCCC"> forest</font><font color="#E5E5E5"> and then we compromise</font>

806
00:33:50,920 --> 00:33:54,280
the entire set of credential material<font color="#CCCCCC"> so</font>

807
00:33:53,110 --> 00:33:56,800
that's a complete separate forest

808
00:33:54,280 --> 00:33:58,899
compromise that<font color="#E5E5E5"> you know even though</font>

809
00:33:56,800 --> 00:34:00,330
this was a<font color="#E5E5E5"> security boundary we're able</font>

810
00:33:58,900 --> 00:34:03,910
to to do that

811
00:34:00,330 --> 00:34:05,710
so the<font color="#E5E5E5"> TLDR is the compromise of any</font>

812
00:34:03,910 --> 00:34:08,710
server with unconstrained delegation

813
00:34:05,710 --> 00:34:10,600
domain controller otherwise can not only

814
00:34:08,710 --> 00:34:12,670
be leveraged<font color="#CCCCCC"> to compromise the current</font>

815
00:34:10,600 --> 00:34:14,620
domain<font color="#CCCCCC"> in any domains in</font><font color="#E5E5E5"> the current</font>

816
00:34:12,670 --> 00:34:16,810
forest<font color="#CCCCCC"> but you can compromise</font><font color="#E5E5E5"> any and</font>

817
00:34:14,620 --> 00:34:20,790
all domains in any foreign forest<font color="#E5E5E5"> that</font>

818
00:34:16,810 --> 00:34:24,100
<font color="#E5E5E5">you share a</font><font color="#CCCCCC"> 2-way for us trust with so</font>

819
00:34:20,790 --> 00:34:25,750
we<font color="#E5E5E5"> think that's bad and we're gonna</font>

820
00:34:24,100 --> 00:34:28,540
explain exactly why we think<font color="#E5E5E5"> it's really</font>

821
00:34:25,750 --> 00:34:30,940
<font color="#E5E5E5">really bad but when we</font><font color="#CCCCCC"> published this</font><font color="#E5E5E5"> we</font>

822
00:34:28,540 --> 00:34:32,860
it was in the fall we published<font color="#E5E5E5"> along an</font>

823
00:34:30,940 --> 00:34:34,690
offensive blog post and<font color="#E5E5E5"> also</font><font color="#CCCCCC"> a complete</font>

824
00:34:32,860 --> 00:34:38,290
set of defensive and mitigation guidance

825
00:34:34,690 --> 00:34:39,820
from<font color="#E5E5E5"> one of our blue teamers but some of</font>

826
00:34:38,290 --> 00:34:41,199
the public reaction<font color="#E5E5E5"> it was mostly good</font>

827
00:34:39,820 --> 00:34:42,820
and there's a lot<font color="#E5E5E5"> of people being like</font>

828
00:34:41,199 --> 00:34:44,529
oh this is crazy<font color="#E5E5E5"> but</font><font color="#CCCCCC"> some of the other</font>

829
00:34:42,820 --> 00:34:45,970
reactions or like there's still<font color="#E5E5E5"> a</font>

830
00:34:44,530 --> 00:34:48,220
security boundary as long as it's<font color="#E5E5E5"> not a</font>

831
00:34:45,969 --> 00:34:50,230
<font color="#CCCCCC">two-way</font><font color="#E5E5E5"> trust</font><font color="#CCCCCC"> in an ad</font><font color="#E5E5E5"> for so domain so</font>

832
00:34:48,219 --> 00:34:51,429
if a force<font color="#E5E5E5"> is a security boundary if it</font>

833
00:34:50,230 --> 00:34:54,490
doesn't have a trust with<font color="#CCCCCC"> anything</font><font color="#E5E5E5"> I'm</font>

834
00:34:51,429 --> 00:34:55,839
like<font color="#CCCCCC"> alright okay have forest root</font>

835
00:34:54,489 --> 00:34:57,759
domain admin credentials<font color="#E5E5E5"> have things</font>

836
00:34:55,840 --> 00:35:00,070
grossly misconfigured so<font color="#E5E5E5"> I guess a stock</font>

837
00:34:57,760 --> 00:35:02,110
domain<font color="#E5E5E5"> trust is gross miss configuration</font>

838
00:35:00,070 --> 00:35:02,829
according to this person<font color="#CCCCCC"> I don't think</font>

839
00:35:02,110 --> 00:35:04,359
I've<font color="#CCCCCC"> ever heard any</font>

840
00:35:02,829 --> 00:35:06,359
<font color="#E5E5E5">claim the boundary exists in a</font><font color="#CCCCCC"> two-way</font>

841
00:35:04,359 --> 00:35:09,279
trust is in place even though<font color="#CCCCCC"> Microsoft</font>

842
00:35:06,359 --> 00:35:11,229
<font color="#E5E5E5">says that in their documentation</font><font color="#CCCCCC"> so you</font>

843
00:35:09,279 --> 00:35:12,609
<font color="#CCCCCC">know I</font><font color="#E5E5E5"> think there was just</font><font color="#CCCCCC"> a Miss we're</font>

844
00:35:11,229 --> 00:35:13,239
not trying to<font color="#E5E5E5"> like poke fun at stuff we</font>

845
00:35:12,609 --> 00:35:15,788
just<font color="#CCCCCC"> think there were some</font>

846
00:35:13,239 --> 00:35:17,979
misconceptions with how people

847
00:35:15,789 --> 00:35:20,259
<font color="#E5E5E5">understood this problem</font><font color="#CCCCCC"> and what</font><font color="#E5E5E5"> the</font>

848
00:35:17,979 --> 00:35:22,078
promise<font color="#CCCCCC"> of that boundary was in</font>

849
00:35:20,259 --> 00:35:24,219
Microsoft documentation they were

850
00:35:22,079 --> 00:35:25,930
Microsoft themselves were a little<font color="#E5E5E5"> bit</font>

851
00:35:24,219 --> 00:35:28,989
kind<font color="#E5E5E5"> of unclear of like well boundary</font>

852
00:35:25,930 --> 00:35:30,578
<font color="#E5E5E5">and whatever but it's we made the</font>

853
00:35:28,989 --> 00:35:31,869
<font color="#CCCCCC">argument that based on</font><font color="#E5E5E5"> the documentation</font>

854
00:35:30,579 --> 00:35:33,459
and based on<font color="#E5E5E5"> the</font><font color="#CCCCCC"> CID filtering</font>

855
00:35:31,869 --> 00:35:35,410
protection that there<font color="#CCCCCC"> was supposed to</font><font color="#E5E5E5"> be</font>

856
00:35:33,459 --> 00:35:37,690
a<font color="#E5E5E5"> security enforcement between these two</font>

857
00:35:35,410 --> 00:35:41,739
external forests<font color="#E5E5E5"> with a stock config</font>

858
00:35:37,690 --> 00:35:45,489
with like a stock trust configuration so

859
00:35:41,739 --> 00:35:47,170
why this matters<font color="#E5E5E5"> so</font><font color="#CCCCCC"> the big thing the</font>

860
00:35:45,489 --> 00:35:49,269
big thing is<font color="#CCCCCC"> that this</font><font color="#E5E5E5"> is gonna work in</font>

861
00:35:47,170 --> 00:35:52,509
the<font color="#E5E5E5"> default configuration of any forest</font>

862
00:35:49,269 --> 00:35:54,279
<font color="#E5E5E5">that has a two-way trust so it's</font>

863
00:35:52,509 --> 00:35:56,229
extremely<font color="#E5E5E5"> powerful in</font><font color="#CCCCCC"> that sense you</font>

864
00:35:54,279 --> 00:35:57,940
don't<font color="#E5E5E5"> have to do anything all you have</font>

865
00:35:56,229 --> 00:35:59,529
<font color="#E5E5E5">to do is set up a two-way trust and this</font>

866
00:35:57,940 --> 00:36:02,380
<font color="#E5E5E5">is</font><font color="#CCCCCC"> going to work</font><font color="#E5E5E5"> and we tried really</font>

867
00:35:59,529 --> 00:36:04,719
hard to<font color="#CCCCCC"> make sure</font><font color="#E5E5E5"> that these stock demos</font>

868
00:36:02,380 --> 00:36:07,900
and examples<font color="#E5E5E5"> and everything we did were</font>

869
00:36:04,719 --> 00:36:09,789
just<font color="#E5E5E5"> like patched</font><font color="#CCCCCC"> real like up to date</font>

870
00:36:07,900 --> 00:36:12,339
at least<font color="#E5E5E5"> 2012</font><font color="#CCCCCC"> or higher</font><font color="#E5E5E5"> operating</font>

871
00:36:09,789 --> 00:36:13,779
systems with just a stock trust so<font color="#E5E5E5"> we</font>

872
00:36:12,339 --> 00:36:15,759
didn't do any weird Nessa<font color="#CCCCCC"> group</font>

873
00:36:13,779 --> 00:36:17,709
configuration we didn't like you know

874
00:36:15,759 --> 00:36:19,420
<font color="#E5E5E5">mess with anything we wanted to</font><font color="#CCCCCC"> keep</font>

875
00:36:17,709 --> 00:36:21,969
<font color="#E5E5E5">everything as default in stock as</font>

876
00:36:19,420 --> 00:36:24,880
possible<font color="#E5E5E5"> that also mimics the quote</font>

877
00:36:21,969 --> 00:36:26,979
unquote<font color="#E5E5E5"> most secure implementation that</font>

878
00:36:24,880 --> 00:36:31,930
<font color="#E5E5E5">you may have which you</font><font color="#CCCCCC"> know is having no</font>

879
00:36:26,979 --> 00:36:34,029
extra groups<font color="#E5E5E5"> all right so one of the big</font>

880
00:36:31,930 --> 00:36:36,368
implications of this now is you know if

881
00:36:34,029 --> 00:36:40,989
you have<font color="#E5E5E5"> to to forests that trust each</font>

882
00:36:36,369 --> 00:36:43,390
other for stay in<font color="#E5E5E5"> forest be the security</font>

883
00:36:40,989 --> 00:36:44,949
<font color="#CCCCCC">of</font><font color="#E5E5E5"> one forest is completely</font><font color="#CCCCCC"> dependent</font><font color="#E5E5E5"> on</font>

884
00:36:43,390 --> 00:36:47,019
the security<font color="#CCCCCC"> of another force</font>

885
00:36:44,949 --> 00:36:49,059
so think about acquisitions<font color="#E5E5E5"> to where if</font>

886
00:36:47,019 --> 00:36:51,249
you have a company<font color="#E5E5E5"> that purchases other</font>

887
00:36:49,059 --> 00:36:53,529
companies and they're like<font color="#CCCCCC"> ok the</font>

888
00:36:51,249 --> 00:36:54,939
Microsoft<font color="#E5E5E5"> Guardian says that the domains</font>

889
00:36:53,529 --> 00:36:56,799
not<font color="#E5E5E5"> the boundary so</font><font color="#CCCCCC"> we're gonna just</font><font color="#E5E5E5"> do</font>

890
00:36:54,940 --> 00:36:58,599
a force<font color="#E5E5E5"> to forest recipes we need to</font>

891
00:36:56,799 --> 00:37:00,519
link up authentication systems and have

892
00:36:58,599 --> 00:37:01,630
<font color="#E5E5E5">everything brought in but like oh this</font>

893
00:37:00,519 --> 00:37:03,430
<font color="#E5E5E5">is a battery</font><font color="#CCCCCC"> so we're doing this</font>

894
00:37:01,630 --> 00:37:05,680
correctly<font color="#CCCCCC"> because</font><font color="#E5E5E5"> we just have external</font>

895
00:37:03,430 --> 00:37:07,509
force<font color="#E5E5E5"> to forest</font><font color="#CCCCCC"> trust so you know they</font>

896
00:37:05,680 --> 00:37:10,149
they acquire some other company<font color="#E5E5E5"> they may</font>

897
00:37:07,509 --> 00:37:12,069
have already been owned<font color="#E5E5E5"> and they're like</font>

898
00:37:10,150 --> 00:37:14,430
<font color="#CCCCCC">ok no we're totally</font><font color="#E5E5E5"> safe because</font><font color="#CCCCCC"> we have</font>

899
00:37:12,069 --> 00:37:17,079
<font color="#E5E5E5">this forest a forest boundary like the</font>

900
00:37:14,430 --> 00:37:18,669
<font color="#CCCCCC">compromised of</font><font color="#E5E5E5"> the newly acquire</font>

901
00:37:17,079 --> 00:37:20,770
company<font color="#E5E5E5"> can be used completely</font>

902
00:37:18,670 --> 00:37:23,650
compromised<font color="#CCCCCC"> you know like the acquiring</font>

903
00:37:20,770 --> 00:37:25,630
<font color="#E5E5E5">company so it's just that yeah again</font><font color="#CCCCCC"> the</font>

904
00:37:23,650 --> 00:37:29,069
security<font color="#CCCCCC"> of each forest is completely</font>

905
00:37:25,630 --> 00:37:29,069
<font color="#CCCCCC">dependent on</font><font color="#E5E5E5"> each other which</font><font color="#CCCCCC"> is scary</font>

906
00:37:30,630 --> 00:37:35,980
and again yeah even if we the way that

907
00:37:34,299 --> 00:37:38,589
we tried<font color="#E5E5E5"> to set up all of our</font><font color="#CCCCCC"> examples</font>

908
00:37:35,980 --> 00:37:41,170
was even if<font color="#E5E5E5"> forest a has near perfect</font>

909
00:37:38,589 --> 00:37:43,960
<font color="#E5E5E5">security so like even</font><font color="#CCCCCC"> its default</font>

910
00:37:41,170 --> 00:37:47,289
configuration no other users there's

911
00:37:43,960 --> 00:37:49,180
very few<font color="#E5E5E5"> moving</font><font color="#CCCCCC"> pieces</font><font color="#E5E5E5"> if something</font>

912
00:37:47,289 --> 00:37:56,650
enforced<font color="#E5E5E5"> a is compromised</font><font color="#CCCCCC"> then you can</font>

913
00:37:49,180 --> 00:37:58,419
<font color="#E5E5E5">compromise first</font><font color="#CCCCCC"> B so when we we do want</font>

914
00:37:56,650 --> 00:38:02,339
to give a<font color="#E5E5E5"> shout out to Microsoft so we</font>

915
00:37:58,420 --> 00:38:04,990
reported this to<font color="#CCCCCC"> nsrc</font><font color="#E5E5E5"> back in the fall</font>

916
00:38:02,339 --> 00:38:07,420
<font color="#CCCCCC">when they first</font><font color="#E5E5E5"> triaged it</font>

917
00:38:04,990 --> 00:38:11,410
we had some<font color="#CCCCCC"> back-and-forth going with</font>

918
00:38:07,420 --> 00:38:14,589
them they and they decided<font color="#CCCCCC"> to</font><font color="#E5E5E5"> just call</font>

919
00:38:11,410 --> 00:38:16,299
it it won't<font color="#E5E5E5"> fix it wasn't an issue so we</font>

920
00:38:14,589 --> 00:38:18,940
went ahead and<font color="#CCCCCC"> we</font><font color="#E5E5E5"> published our details</font>

921
00:38:16,299 --> 00:38:23,410
and a bunch of defensive<font color="#E5E5E5"> guidance on it</font>

922
00:38:18,940 --> 00:38:26,740
and<font color="#CCCCCC"> got let's just say it was shuffled</font>

923
00:38:23,410 --> 00:38:30,250
around within<font color="#E5E5E5"> Microsoft and some people</font>

924
00:38:26,740 --> 00:38:35,410
who had a bigger stake in the game there

925
00:38:30,250 --> 00:38:37,750
<font color="#E5E5E5">i've decided to escalate it yeah so to</font>

926
00:38:35,410 --> 00:38:40,118
their credit they decided that<font color="#E5E5E5"> that</font>

927
00:38:37,750 --> 00:38:42,279
<font color="#E5E5E5">decision was a mistake they released an</font>

928
00:38:40,119 --> 00:38:43,510
advisory early in the spring we've been

929
00:38:42,279 --> 00:38:45,640
working with<font color="#E5E5E5"> them</font><font color="#CCCCCC"> back and</font><font color="#E5E5E5"> forth they</font>

930
00:38:43,510 --> 00:38:47,200
<font color="#E5E5E5">release an advisory and we're gonna talk</font>

931
00:38:45,640 --> 00:38:48,970
about<font color="#E5E5E5"> a patch here in just a little bit</font>

932
00:38:47,200 --> 00:38:52,868
<font color="#E5E5E5">but we</font><font color="#CCCCCC"> definitely</font><font color="#E5E5E5"> want</font><font color="#CCCCCC"> to applaud</font>

933
00:38:48,970 --> 00:38:54,250
Microsoft<font color="#E5E5E5"> and nsrc for saying like we</font>

934
00:38:52,869 --> 00:38:56,260
made a mistake<font color="#CCCCCC"> you know and they've been</font>

935
00:38:54,250 --> 00:38:57,700
<font color="#E5E5E5">handling the</font><font color="#CCCCCC"> situation like extremely</font>

936
00:38:56,260 --> 00:39:01,029
extremely well since then they've<font color="#CCCCCC"> been</font>

937
00:38:57,700 --> 00:39:03,250
amazing<font color="#E5E5E5"> to work with so it's you know I</font>

938
00:39:01,029 --> 00:39:04,720
don't know where the<font color="#E5E5E5"> situation could</font>

939
00:39:03,250 --> 00:39:06,430
have ended up a little<font color="#CCCCCC"> bit</font><font color="#E5E5E5"> better if the</font>

940
00:39:04,720 --> 00:39:08,020
determination originally was this is an

941
00:39:06,430 --> 00:39:09,368
issue<font color="#CCCCCC"> that we're gonna fix</font><font color="#E5E5E5"> that would</font>

942
00:39:08,020 --> 00:39:11,619
have been the<font color="#E5E5E5"> ideal</font><font color="#CCCCCC"> situation but</font>

943
00:39:09,369 --> 00:39:13,599
<font color="#CCCCCC">they're</font><font color="#E5E5E5"> doing</font><font color="#CCCCCC"> everything they can to</font>

944
00:39:11,619 --> 00:39:14,740
<font color="#E5E5E5">actually squash this entire bug in the</font>

945
00:39:13,599 --> 00:39:17,170
coming months<font color="#E5E5E5"> so</font><font color="#CCCCCC"> we'll go over the</font>

946
00:39:14,740 --> 00:39:19,959
specifics<font color="#E5E5E5"> because they actually</font><font color="#CCCCCC"> release</font>

947
00:39:17,170 --> 00:39:21,250
<font color="#E5E5E5">a</font><font color="#CCCCCC"> CVE last week so</font><font color="#E5E5E5"> we have Active</font>

948
00:39:19,960 --> 00:39:22,900
<font color="#E5E5E5">Directory elevation</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> privileged</font>

949
00:39:21,250 --> 00:39:25,089
vulnerabilities so we actually<font color="#CCCCCC"> got a</font>

950
00:39:22,900 --> 00:39:27,609
full<font color="#CCCCCC"> CVE they like completely recognize</font>

951
00:39:25,089 --> 00:39:29,230
this<font color="#E5E5E5"> so anyone that was claiming like is</font>

952
00:39:27,609 --> 00:39:29,740
this an<font color="#E5E5E5"> issue or was this a boundary or</font>

953
00:39:29,230 --> 00:39:32,490
<font color="#E5E5E5">not</font>

954
00:39:29,740 --> 00:39:37,720
microsoft says it<font color="#E5E5E5"> was</font><font color="#CCCCCC"> because they are</font>

955
00:39:32,490 --> 00:39:39,729
<font color="#E5E5E5">going to fix it</font><font color="#CCCCCC"> so the defense's a</font>

956
00:39:37,720 --> 00:39:43,419
little bit on some<font color="#CCCCCC"> of</font><font color="#E5E5E5"> this stuff</font><font color="#CCCCCC"> and</font>

957
00:39:39,730 --> 00:39:46,270
<font color="#E5E5E5">we'll cover the patch so the first one</font>

958
00:39:43,420 --> 00:39:50,170
<font color="#CCCCCC">is called selective authentication which</font>

959
00:39:46,270 --> 00:39:53,170
is just<font color="#CCCCCC"> I</font><font color="#E5E5E5"> get we</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> true fix is going</font>

960
00:39:50,170 --> 00:39:54,790
to be to install<font color="#E5E5E5"> the patch but you</font>

961
00:39:53,170 --> 00:39:58,270
potentially can use selective

962
00:39:54,790 --> 00:40:00,069
authentication as a way to prevent or to

963
00:39:58,270 --> 00:40:02,880
protect the accounts that<font color="#E5E5E5"> are allowed to</font>

964
00:40:00,069 --> 00:40:05,440
<font color="#E5E5E5">authenticate across the the</font><font color="#CCCCCC"> trusts</font>

965
00:40:02,880 --> 00:40:11,500
<font color="#CCCCCC">typically this</font><font color="#E5E5E5"> is primarily</font><font color="#CCCCCC"> focused on</font>

966
00:40:05,440 --> 00:40:12,940
administrative users<font color="#CCCCCC"> so it can be</font>

967
00:40:11,500 --> 00:40:14,530
potentially be possible we haven't

968
00:40:12,940 --> 00:40:16,420
actually<font color="#E5E5E5"> seen anybody that's implemented</font>

969
00:40:14,530 --> 00:40:18,550
<font color="#E5E5E5">this for like domain controller accounts</font>

970
00:40:16,420 --> 00:40:20,079
<font color="#E5E5E5">because we think DC's need to be able to</font>

971
00:40:18,550 --> 00:40:22,660
<font color="#CCCCCC">authenticate to</font><font color="#E5E5E5"> each other</font><font color="#CCCCCC"> in</font><font color="#E5E5E5"> a lot of</font>

972
00:40:20,079 --> 00:40:24,160
situations<font color="#E5E5E5"> to do proper</font><font color="#CCCCCC"> whatever between</font>

973
00:40:22,660 --> 00:40:26,379
<font color="#E5E5E5">all the weird</font><font color="#CCCCCC"> stuff that happens</font><font color="#E5E5E5"> in the</font>

974
00:40:24,160 --> 00:40:28,210
hood<font color="#E5E5E5"> but for the sake of being complete</font>

975
00:40:26,380 --> 00:40:29,950
we wanted to like give a shout out<font color="#CCCCCC"> that</font>

976
00:40:28,210 --> 00:40:36,160
selective auth theoretically can block

977
00:40:29,950 --> 00:40:39,009
this attack<font color="#CCCCCC"> and then another thing that</font>

978
00:40:36,160 --> 00:40:41,368
you<font color="#E5E5E5"> can do is to just disable TGT</font>

979
00:40:39,010 --> 00:40:45,609
delegation across the trust<font color="#E5E5E5"> so since</font>

980
00:40:41,369 --> 00:40:48,609
2012 r2<font color="#CCCCCC"> there's been a feature on the</font>

981
00:40:45,609 --> 00:40:52,420
trusted domain objects called<font color="#CCCCCC"> a naval</font>

982
00:40:48,609 --> 00:40:55,598
<font color="#CCCCCC">TGT delegation</font><font color="#E5E5E5"> no</font><font color="#CCCCCC"> n/a</font><font color="#E5E5E5"> enable TGT</font>

983
00:40:52,420 --> 00:40:59,079
delegation and you can set<font color="#E5E5E5"> that you can</font>

984
00:40:55,599 --> 00:41:01,000
<font color="#E5E5E5">disable that so that delegation cannot</font>

985
00:40:59,079 --> 00:41:02,710
occur<font color="#E5E5E5"> across those trusts so this just</font>

986
00:41:01,000 --> 00:41:05,440
flips a bit<font color="#E5E5E5"> and that</font><font color="#CCCCCC"> trusts a domain</font>

987
00:41:02,710 --> 00:41:06,880
object<font color="#E5E5E5"> one key here is</font><font color="#CCCCCC"> that this needs</font>

988
00:41:05,440 --> 00:41:09,369
to<font color="#E5E5E5"> be done</font><font color="#CCCCCC"> in each end of</font><font color="#E5E5E5"> the trust</font>

989
00:41:06,880 --> 00:41:11,049
<font color="#E5E5E5">because if you only do this on like a</font>

990
00:41:09,369 --> 00:41:14,710
then like you can still compromise in

991
00:41:11,049 --> 00:41:19,180
the other direction<font color="#E5E5E5"> but what's really</font>

992
00:41:14,710 --> 00:41:21,700
cool<font color="#E5E5E5"> is the CVE</font><font color="#CCCCCC"> 2019 oh</font><font color="#E5E5E5"> six eight three</font>

993
00:41:19,180 --> 00:41:24,700
details so they've recently released

994
00:41:21,700 --> 00:41:26,200
this<font color="#E5E5E5"> patch and this is just we haven't</font>

995
00:41:24,700 --> 00:41:27,368
<font color="#E5E5E5">fully tested all the components of the</font>

996
00:41:26,200 --> 00:41:28,899
patch this<font color="#CCCCCC"> is based</font><font color="#E5E5E5"> on their</font>

997
00:41:27,369 --> 00:41:31,420
documentation<font color="#E5E5E5"> of what they're going to</font>

998
00:41:28,900 --> 00:41:33,670
<font color="#E5E5E5">be</font><font color="#CCCCCC"> doing on their slowly rolling this</font>

999
00:41:31,420 --> 00:41:35,859
patch out<font color="#CCCCCC"> the disables TGT delegation</font>

1000
00:41:33,670 --> 00:41:39,040
across<font color="#CCCCCC"> forest boundaries by default</font>

1001
00:41:35,859 --> 00:41:40,869
<font color="#CCCCCC">which</font><font color="#E5E5E5"> is awesome on the roadmap they're</font>

1002
00:41:39,040 --> 00:41:43,360
going to be implementing a new safe

1003
00:41:40,869 --> 00:41:45,370
configuration for unconstrained

1004
00:41:43,360 --> 00:41:47,080
<font color="#CCCCCC">rose delegation across trust so how are</font>

1005
00:41:45,370 --> 00:41:49,930
they going<font color="#E5E5E5"> to be doing</font><font color="#CCCCCC"> this</font><font color="#E5E5E5"> a little bit</font>

1006
00:41:47,080 --> 00:41:52,630
<font color="#E5E5E5">on the timeline so</font><font color="#CCCCCC"> a couple</font><font color="#E5E5E5"> days ago</font>

1007
00:41:49,930 --> 00:41:55,600
they actually<font color="#E5E5E5"> back ported the full</font>

1008
00:41:52,630 --> 00:41:57,880
delegation block to<font color="#CCCCCC"> Server 2008 and 2008</font>

1009
00:41:55,600 --> 00:42:01,420
r2<font color="#E5E5E5"> so this used to only be a feature</font><font color="#CCCCCC"> in</font>

1010
00:41:57,880 --> 00:42:04,660
<font color="#E5E5E5">Server 2012 so first step awesome</font>

1011
00:42:01,420 --> 00:42:06,670
they back ported<font color="#CCCCCC"> this stuff the second</font>

1012
00:42:04,660 --> 00:42:09,879
step in a few months<font color="#CCCCCC"> is they're going to</font>

1013
00:42:06,670 --> 00:42:12,070
<font color="#E5E5E5">be introducing a new flag</font><font color="#CCCCCC"> and they've</font>

1014
00:42:09,880 --> 00:42:13,630
stated<font color="#E5E5E5"> in case you do need Kerberos full</font>

1015
00:42:12,070 --> 00:42:15,190
delegation across trusts that are

1016
00:42:13,630 --> 00:42:16,480
introducing this new<font color="#E5E5E5"> flag we I don't</font>

1017
00:42:15,190 --> 00:42:18,060
<font color="#CCCCCC">know what the flag name is</font><font color="#E5E5E5"> going to be</font>

1018
00:42:16,480 --> 00:42:21,340
they didn't have it in<font color="#E5E5E5"> the documentation</font>

1019
00:42:18,060 --> 00:42:26,259
along with this<font color="#E5E5E5"> any new trust will have</font>

1020
00:42:21,340 --> 00:42:27,700
<font color="#E5E5E5">enabled TGT delegation set to</font><font color="#CCCCCC"> know so</font>

1021
00:42:26,260 --> 00:42:29,290
<font color="#E5E5E5">they're basically with this step they're</font>

1022
00:42:27,700 --> 00:42:31,149
giving people<font color="#CCCCCC"> a chance they're giving</font>

1023
00:42:29,290 --> 00:42:33,009
people<font color="#CCCCCC"> a window</font><font color="#E5E5E5"> saying if you do still</font>

1024
00:42:31,150 --> 00:42:35,200
need<font color="#E5E5E5"> this feature like here's your</font>

1025
00:42:33,010 --> 00:42:37,780
<font color="#E5E5E5">chance to flip this and still allow it</font>

1026
00:42:35,200 --> 00:42:39,790
to happen<font color="#E5E5E5"> because then in July they're</font>

1027
00:42:37,780 --> 00:42:41,500
gonna start enforcing the new flag<font color="#E5E5E5"> that</font>

1028
00:42:39,790 --> 00:42:43,660
they implement and they're<font color="#E5E5E5"> going to</font>

1029
00:42:41,500 --> 00:42:45,190
completely<font color="#CCCCCC"> ignore the enable TGT</font>

1030
00:42:43,660 --> 00:42:47,109
delegation flag so the reason they're

1031
00:42:45,190 --> 00:42:49,900
doing it like this<font color="#CCCCCC"> of like introducing a</font>

1032
00:42:47,110 --> 00:42:52,270
related but separate flag to block this

1033
00:42:49,900 --> 00:42:53,830
stuff is this is this is a way to deal

1034
00:42:52,270 --> 00:42:55,420
<font color="#CCCCCC">with the backwards compatibility problem</font>

1035
00:42:53,830 --> 00:42:58,450
so when<font color="#E5E5E5"> this</font><font color="#CCCCCC"> thing comes</font><font color="#E5E5E5"> out like hey</font>

1036
00:42:55,420 --> 00:43:00,580
<font color="#E5E5E5">you actually want</font><font color="#CCCCCC"> this you better flip</font>

1037
00:42:58,450 --> 00:43:02,950
<font color="#E5E5E5">this flag to say specifically say yes</font>

1038
00:43:00,580 --> 00:43:04,960
<font color="#E5E5E5">because you know once it hits in July</font>

1039
00:43:02,950 --> 00:43:08,620
<font color="#E5E5E5">they're gonna completely ignore</font><font color="#CCCCCC"> the old</font>

1040
00:43:04,960 --> 00:43:11,130
one<font color="#CCCCCC"> so</font><font color="#E5E5E5"> once this flips over in July any</font>

1041
00:43:08,620 --> 00:43:13,330
updated<font color="#CCCCCC"> dcs will no longer be vulnerable</font>

1042
00:43:11,130 --> 00:43:15,010
<font color="#CCCCCC">to this particular attack</font><font color="#E5E5E5"> in this</font>

1043
00:43:13,330 --> 00:43:17,500
particular issue<font color="#E5E5E5"> unless they explicitly</font>

1044
00:43:15,010 --> 00:43:19,900
went in and<font color="#CCCCCC"> actually explicitly enable</font>

1045
00:43:17,500 --> 00:43:21,850
full delegation across<font color="#CCCCCC"> t</font><font color="#E5E5E5"> GTS across</font>

1046
00:43:19,900 --> 00:43:22,750
forest boundaries<font color="#E5E5E5"> and based on like some</font>

1047
00:43:21,850 --> 00:43:25,870
of the<font color="#CCCCCC"> admins some of the environments</font>

1048
00:43:22,750 --> 00:43:27,400
we<font color="#E5E5E5"> know like</font><font color="#CCCCCC"> i doubt many people are</font>

1049
00:43:25,870 --> 00:43:29,049
really gonna need<font color="#E5E5E5"> that or realize that</font>

1050
00:43:27,400 --> 00:43:30,760
they might even need<font color="#CCCCCC"> it so this</font><font color="#E5E5E5"> is</font><font color="#CCCCCC"> a way</font>

1051
00:43:29,050 --> 00:43:32,680
for<font color="#CCCCCC"> them to</font><font color="#E5E5E5"> say</font><font color="#CCCCCC"> alright we're doing the</font>

1052
00:43:30,760 --> 00:43:34,000
right thing you've given you a window<font color="#E5E5E5"> in</font>

1053
00:43:32,680 --> 00:43:35,230
case you need this<font color="#E5E5E5"> functionality but</font>

1054
00:43:34,000 --> 00:43:37,840
then we're flipping<font color="#CCCCCC"> the switch and the</font>

1055
00:43:35,230 --> 00:43:39,700
whole bug class would be<font color="#E5E5E5"> dead yeah so</font>

1056
00:43:37,840 --> 00:43:41,410
<font color="#CCCCCC">tree their credit and they're breaking</font>

1057
00:43:39,700 --> 00:43:42,790
<font color="#CCCCCC">it like</font><font color="#E5E5E5"> they're gonna stop the attack</font>

1058
00:43:41,410 --> 00:43:46,450
it's<font color="#CCCCCC"> gonna</font><font color="#E5E5E5"> but until then it's still</font>

1059
00:43:42,790 --> 00:43:49,420
gonna work<font color="#E5E5E5"> so enjoy like</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> good so</font>

1060
00:43:46,450 --> 00:43:51,189
that's<font color="#E5E5E5"> the talk</font><font color="#CCCCCC"> now if there'll</font><font color="#E5E5E5"> be any</font>

1061
00:43:49,420 --> 00:43:52,840
questions also<font color="#CCCCCC"> we'll put the slide deck</font>

1062
00:43:51,190 --> 00:43:55,090
up and<font color="#E5E5E5"> like tweet it we have like</font><font color="#CCCCCC"> some</font>

1063
00:43:52,840 --> 00:43:56,530
references<font color="#E5E5E5"> to the slides</font><font color="#CCCCCC"> and like the</font>

1064
00:43:55,090 --> 00:43:57,300
timelines<font color="#E5E5E5"> and all the details and things</font>

1065
00:43:56,530 --> 00:43:58,680
<font color="#E5E5E5">like that</font>

1066
00:43:57,300 --> 00:44:01,200
we'll also be<font color="#E5E5E5"> hanging out if in case</font>

1067
00:43:58,680 --> 00:44:04,609
<font color="#CCCCCC">people want</font><font color="#E5E5E5"> to talk to us</font><font color="#CCCCCC"> after but are</font>

1068
00:44:01,200 --> 00:44:04,609
there<font color="#E5E5E5"> any questions right now</font>

1069
00:44:06,710 --> 00:44:10,619
<font color="#CCCCCC">one-way</font><font color="#E5E5E5"> inbound trust so the blog post</font>

1070
00:44:09,060 --> 00:44:15,119
does cover that<font color="#E5E5E5"> specifically if you're</font>

1071
00:44:10,619 --> 00:44:17,550
talking<font color="#E5E5E5"> about ESA</font><font color="#CCCCCC"> ERF orest the reate</font>

1072
00:44:15,119 --> 00:44:20,700
right now the attack<font color="#E5E5E5"> only works with</font>

1073
00:44:17,550 --> 00:44:22,310
<font color="#E5E5E5">two-way forest trust because in one</font>

1074
00:44:20,700 --> 00:44:24,270
<font color="#CCCCCC">direction you get</font><font color="#E5E5E5"> the authentication</font>

1075
00:44:22,310 --> 00:44:26,730
<font color="#E5E5E5">authenticated since to trigger the bug</font>

1076
00:44:24,270 --> 00:44:27,869
and<font color="#CCCCCC"> then the trust needs to</font><font color="#E5E5E5"> be the also</font>

1077
00:44:26,730 --> 00:44:30,450
in the other<font color="#CCCCCC"> direction</font><font color="#E5E5E5"> to have the</font>

1078
00:44:27,869 --> 00:44:32,160
<font color="#CCCCCC">delegated TGT to flow back so you</font><font color="#E5E5E5"> have</font>

1079
00:44:30,450 --> 00:44:34,049
to have<font color="#E5E5E5"> both directions so one direction</font>

1080
00:44:32,160 --> 00:44:37,190
is for the trigger<font color="#E5E5E5"> and one direction is</font>

1081
00:44:34,050 --> 00:44:37,190
to capture<font color="#E5E5E5"> the TGT</font>

