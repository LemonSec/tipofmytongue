1
00:00:01,069 --> 00:00:06,439
this is<font color="#E5E5E5"> Peter</font><font color="#CCCCCC"> and Stan they will be</font>

2
00:00:04,730 --> 00:00:11,270
talking<font color="#E5E5E5"> about Microsoft Office file</font>

3
00:00:06,439 --> 00:00:13,610
format sorcery and stages use guys good

4
00:00:11,270 --> 00:00:14,540
morning<font color="#CCCCCC"> everyone it's a real pleasure to</font>

5
00:00:13,610 --> 00:00:17,570
<font color="#CCCCCC">be</font><font color="#E5E5E5"> here</font><font color="#CCCCCC"> supers</font>

6
00:00:14,540 --> 00:00:19,939
my name is<font color="#CCCCCC"> Stan this</font><font color="#E5E5E5"> is Peter he's my</font>

7
00:00:17,570 --> 00:00:22,039
colleague<font color="#E5E5E5"> and we're about ready</font><font color="#CCCCCC"> MERS</font>

8
00:00:19,940 --> 00:00:26,660
that is small and dedicated company in

9
00:00:22,039 --> 00:00:28,369
the Netherlands<font color="#CCCCCC"> called</font><font color="#E5E5E5"> outflank and we</font>

10
00:00:26,660 --> 00:00:31,520
are<font color="#E5E5E5"> going to take you into the</font><font color="#CCCCCC"> world of</font>

11
00:00:28,369 --> 00:00:35,120
Microsoft Office<font color="#E5E5E5"> today what we see</font><font color="#CCCCCC"> in</font>

12
00:00:31,520 --> 00:00:39,199
the<font color="#CCCCCC"> wild</font><font color="#E5E5E5"> is that</font><font color="#CCCCCC"> MS Office macros are</font>

13
00:00:35,120 --> 00:00:42,108
one of the most important methods<font color="#E5E5E5"> for</font>

14
00:00:39,199 --> 00:00:44,929
<font color="#E5E5E5">gaining an entry for actual attackers so</font>

15
00:00:42,109 --> 00:00:48,079
that is why we as red teamers also need

16
00:00:44,929 --> 00:00:52,010
to<font color="#E5E5E5"> employ those methods and as both</font>

17
00:00:48,079 --> 00:00:53,959
static and dynamic<font color="#E5E5E5"> analysis measures</font><font color="#CCCCCC"> or</font>

18
00:00:52,010 --> 00:00:56,420
<font color="#E5E5E5">macros are getting stronger and stronger</font>

19
00:00:53,959 --> 00:00:58,129
this requires<font color="#E5E5E5"> offensive research in</font>

20
00:00:56,420 --> 00:01:00,589
order<font color="#CCCCCC"> to</font><font color="#E5E5E5"> be able to bypass those</font>

21
00:00:58,129 --> 00:01:03,170
measures<font color="#E5E5E5"> so this is what we'll be</font><font color="#CCCCCC"> doing</font>

22
00:01:00,589 --> 00:01:05,209
today<font color="#E5E5E5"> the first part will be on static</font>

23
00:01:03,170 --> 00:01:07,070
analysis that will be me<font color="#E5E5E5"> doing that and</font>

24
00:01:05,209 --> 00:01:11,899
then we'll<font color="#CCCCCC"> switch to</font><font color="#E5E5E5"> Peter who's going</font>

25
00:01:07,070 --> 00:01:13,759
into<font color="#E5E5E5"> bypassing dynamic analysis for</font>

26
00:01:11,900 --> 00:01:15,530
static analysis to start we<font color="#E5E5E5"> have</font><font color="#CCCCCC"> to</font>

27
00:01:13,760 --> 00:01:18,800
<font color="#CCCCCC">start</font><font color="#E5E5E5"> with the boring part which is</font><font color="#CCCCCC"> a</font>

28
00:01:15,530 --> 00:01:21,290
primer on<font color="#CCCCCC"> what kind of file formats are</font>

29
00:01:18,800 --> 00:01:24,259
<font color="#E5E5E5">actually being used</font><font color="#CCCCCC"> in in Microsoft</font>

30
00:01:21,290 --> 00:01:25,940
Office<font color="#CCCCCC"> and we</font><font color="#E5E5E5"> won't go too</font><font color="#CCCCCC"> deep into</font>

31
00:01:24,260 --> 00:01:28,730
this because it's<font color="#E5E5E5"> really boring</font>

32
00:01:25,940 --> 00:01:30,920
<font color="#E5E5E5">but one of the most important mechanisms</font>

33
00:01:28,730 --> 00:01:33,560
<font color="#E5E5E5">that's being used in Microsoft Office is</font>

34
00:01:30,920 --> 00:01:36,980
<font color="#E5E5E5">the so-called compound file binary</font>

35
00:01:33,560 --> 00:01:39,260
format or simply called compound files

36
00:01:36,980 --> 00:01:41,930
<font color="#E5E5E5">all a compound files</font><font color="#CCCCCC"> there are different</font>

37
00:01:39,260 --> 00:01:43,550
names<font color="#E5E5E5"> for</font><font color="#CCCCCC"> that who of you</font><font color="#E5E5E5"> are familiar</font>

38
00:01:41,930 --> 00:01:46,460
<font color="#CCCCCC">with this file format</font><font color="#E5E5E5"> can I see some</font>

39
00:01:43,550 --> 00:01:48,530
hands please<font color="#E5E5E5"> that's a few that's that</font>

40
00:01:46,460 --> 00:01:51,649
<font color="#E5E5E5">that's a good time so basically what the</font>

41
00:01:48,530 --> 00:01:54,560
CSVs format is it's it's like<font color="#E5E5E5"> a file</font>

42
00:01:51,650 --> 00:01:56,810
<font color="#E5E5E5">system in a single file</font><font color="#CCCCCC"> so there's the</font>

43
00:01:54,560 --> 00:01:58,610
<font color="#CCCCCC">concepts</font><font color="#E5E5E5"> of like directories and files</font>

44
00:01:56,810 --> 00:02:00,320
within<font color="#E5E5E5"> a single file but then they're</font>

45
00:01:58,610 --> 00:02:03,560
called storages for directories and

46
00:02:00,320 --> 00:02:05,289
streams for files<font color="#E5E5E5"> and this format is</font>

47
00:02:03,560 --> 00:02:09,259
<font color="#E5E5E5">used heavily in Microsoft Office</font>

48
00:02:05,290 --> 00:02:12,530
<font color="#E5E5E5">actually up to 2003 all</font><font color="#CCCCCC"> Dokken XLS files</font>

49
00:02:09,258 --> 00:02:14,809
they were all in<font color="#E5E5E5"> this format but even</font>

50
00:02:12,530 --> 00:02:17,390
<font color="#CCCCCC">nowadays some parts in the new</font>

51
00:02:14,810 --> 00:02:19,760
zip and xml-based format that's used

52
00:02:17,390 --> 00:02:23,359
from 2007 and<font color="#CCCCCC"> up there are still parts</font>

53
00:02:19,760 --> 00:02:25,700
<font color="#CCCCCC">within that zip file</font><font color="#E5E5E5"> that</font><font color="#CCCCCC"> are DC FBF</font>

54
00:02:23,360 --> 00:02:27,980
format<font color="#E5E5E5"> most important one is the file</font>

55
00:02:25,700 --> 00:02:31,100
<font color="#E5E5E5">VBA project of bin which actually</font>

56
00:02:27,980 --> 00:02:34,940
contains macros<font color="#E5E5E5"> from 2007 and up but</font>

57
00:02:31,100 --> 00:02:36,680
we'll see<font color="#E5E5E5"> more</font><font color="#CCCCCC"> of that later</font><font color="#E5E5E5"> I wouldn't</font>

58
00:02:34,940 --> 00:02:39,140
really recommend reading this document

59
00:02:36,680 --> 00:02:40,850
<font color="#E5E5E5">because it's quite boring 46 pages and</font>

60
00:02:39,140 --> 00:02:43,279
there's a lot of<font color="#E5E5E5"> references</font><font color="#CCCCCC"> to other</font>

61
00:02:40,850 --> 00:02:45,829
<font color="#E5E5E5">standards there but there is a lot</font><font color="#CCCCCC"> of</font>

62
00:02:43,280 --> 00:02:48,620
fun to<font color="#E5E5E5"> get</font><font color="#CCCCCC"> out of it</font><font color="#E5E5E5"> so a little bit</font>

63
00:02:45,830 --> 00:02:51,140
<font color="#E5E5E5">more on this file format</font><font color="#CCCCCC"> what does it</font>

64
00:02:48,620 --> 00:02:52,790
look<font color="#CCCCCC"> like if you open</font><font color="#E5E5E5"> it in a compound</font>

65
00:02:51,140 --> 00:02:55,970
file editor like this one this is<font color="#CCCCCC"> my</font>

66
00:02:52,790 --> 00:02:57,890
<font color="#CCCCCC">personal favorite flex hex</font><font color="#E5E5E5"> it just looks</font>

67
00:02:55,970 --> 00:03:02,450
like this I'll switch to<font color="#E5E5E5"> an interactive</font>

68
00:02:57,890 --> 00:03:05,839
<font color="#CCCCCC">view so I say</font><font color="#E5E5E5"> I have a file</font><font color="#CCCCCC"> here I can</font>

69
00:03:02,450 --> 00:03:11,738
open<font color="#CCCCCC"> it open</font><font color="#E5E5E5"> as a compound file and you</font>

70
00:03:05,840 --> 00:03:14,420
<font color="#E5E5E5">just see containers and streams with</font>

71
00:03:11,739 --> 00:03:18,280
information that's basically how with

72
00:03:14,420 --> 00:03:22,670
how it works if you<font color="#CCCCCC"> would open a newer</font>

73
00:03:18,280 --> 00:03:24,680
zip and<font color="#E5E5E5"> XML based file format from word</font>

74
00:03:22,670 --> 00:03:26,149
<font color="#E5E5E5">then the contents would look like this</font>

75
00:03:24,680 --> 00:03:28,100
<font color="#E5E5E5">and if</font><font color="#CCCCCC"> you</font><font color="#E5E5E5"> go into the word directory</font>

76
00:03:26,150 --> 00:03:30,620
there's this file called<font color="#E5E5E5"> VBA project of</font>

77
00:03:28,100 --> 00:03:33,230
bin and<font color="#CCCCCC"> the PBA project of bin file is</font>

78
00:03:30,620 --> 00:03:36,200
actually<font color="#CCCCCC"> a compound file again which is</font>

79
00:03:33,230 --> 00:03:38,268
exactly<font color="#CCCCCC"> like what is shown in a previous</font>

80
00:03:36,200 --> 00:03:42,260
slide<font color="#E5E5E5"> but then only the macros container</font>

81
00:03:38,269 --> 00:03:45,380
and its contents<font color="#CCCCCC"> short introduction so</font>

82
00:03:42,260 --> 00:03:48,290
what is in this<font color="#E5E5E5"> VBA project of bin what</font>

83
00:03:45,380 --> 00:03:50,570
would<font color="#E5E5E5"> it what is there to work</font><font color="#CCCCCC"> with that</font>

84
00:03:48,290 --> 00:03:53,108
<font color="#CCCCCC">you can do this far the GUI</font><font color="#E5E5E5"> I've shown</font>

85
00:03:50,570 --> 00:03:56,209
<font color="#CCCCCC">you my favorite tool flex X but there</font>

86
00:03:53,109 --> 00:03:58,730
<font color="#E5E5E5">you might also want</font><font color="#CCCCCC"> to automate working</font>

87
00:03:56,209 --> 00:04:00,200
with<font color="#E5E5E5"> this file type there's different</font>

88
00:03:58,730 --> 00:04:02,869
directions that<font color="#E5E5E5"> you could go there most</font>

89
00:04:00,200 --> 00:04:05,720
important ones are<font color="#E5E5E5"> all a file which is</font>

90
00:04:02,870 --> 00:04:08,900
from<font color="#CCCCCC"> philip gothic author of only tools</font>

91
00:04:05,720 --> 00:04:10,549
only<font color="#E5E5E5"> VBA that has really limited options</font>

92
00:04:08,900 --> 00:04:11,930
for writing so that's mostly<font color="#CCCCCC"> for</font>

93
00:04:10,549 --> 00:04:14,209
defensive analysis

94
00:04:11,930 --> 00:04:17,060
there's the native<font color="#E5E5E5"> storage interface</font>

95
00:04:14,209 --> 00:04:20,358
<font color="#CCCCCC">from</font><font color="#E5E5E5"> Microsoft which only works on</font>

96
00:04:17,060 --> 00:04:22,310
<font color="#E5E5E5">Windows so no real cross-platform stuff</font>

97
00:04:20,358 --> 00:04:24,620
that you can do there<font color="#CCCCCC"> and then there's</font>

98
00:04:22,310 --> 00:04:26,570
my<font color="#CCCCCC"> favorite one thanks</font><font color="#E5E5E5"> to Nick from</font>

99
00:04:24,620 --> 00:04:28,759
<font color="#E5E5E5">silent</font><font color="#CCCCCC"> back to</font><font color="#E5E5E5"> security for pointing</font>

100
00:04:26,570 --> 00:04:30,830
<font color="#CCCCCC">this one outta</font><font color="#E5E5E5"> me which is open</font><font color="#CCCCCC"> MPD</font>

101
00:04:28,759 --> 00:04:33,620
which is a dotnet framework which allows

102
00:04:30,830 --> 00:04:35,270
<font color="#CCCCCC">you to work with this file type and it</font>

103
00:04:33,620 --> 00:04:36,979
also runs<font color="#E5E5E5"> on mono which means that</font>

104
00:04:35,270 --> 00:04:39,498
therefore it's cross-platform and we'll

105
00:04:36,979 --> 00:04:46,849
be using<font color="#E5E5E5"> that heavily in the coming</font>

106
00:04:39,499 --> 00:04:50,180
demos so then<font color="#CCCCCC"> two macros</font><font color="#E5E5E5"> so</font><font color="#CCCCCC"> markers are</font>

107
00:04:46,849 --> 00:04:52,308
stored within this CF bf file format and

108
00:04:50,180 --> 00:04:53,839
there's another<font color="#E5E5E5"> specification for how</font>

109
00:04:52,309 --> 00:04:56,900
markers are stored within this file

110
00:04:53,839 --> 00:04:59,779
<font color="#E5E5E5">format it's even more pages</font><font color="#CCCCCC"> 109 pages</font><font color="#E5E5E5"> of</font>

111
00:04:56,900 --> 00:05:02,539
complexity<font color="#CCCCCC"> various</font><font color="#E5E5E5"> parts are still</font>

112
00:04:59,779 --> 00:05:04,279
<font color="#E5E5E5">undocumented Microsoft doesn't always</font>

113
00:05:02,539 --> 00:05:06,139
stick<font color="#E5E5E5"> to their own specifications</font><font color="#CCCCCC"> and</font>

114
00:05:04,279 --> 00:05:08,710
that's<font color="#E5E5E5"> actually where the fun starts</font>

115
00:05:06,139 --> 00:05:14,089
<font color="#E5E5E5">we'll get to that in a</font><font color="#CCCCCC"> few minutes and</font>

116
00:05:08,710 --> 00:05:17,270
part of this specification heavily

117
00:05:14,089 --> 00:05:19,039
relies on another<font color="#E5E5E5"> implementation and</font>

118
00:05:17,270 --> 00:05:20,779
understanding which<font color="#CCCCCC"> is about</font><font color="#E5E5E5"> compression</font>

119
00:05:19,039 --> 00:05:23,599
so there's<font color="#E5E5E5"> this custom compression</font>

120
00:05:20,779 --> 00:05:27,710
algorithm that's all over<font color="#E5E5E5"> the file</font>

121
00:05:23,599 --> 00:05:29,748
contents of macros<font color="#CCCCCC"> and we'll also get</font><font color="#E5E5E5"> to</font>

122
00:05:27,710 --> 00:05:32,989
<font color="#CCCCCC">that in a minute as I promised</font><font color="#E5E5E5"> this was</font>

123
00:05:29,749 --> 00:05:35,330
the boring<font color="#E5E5E5"> part so a little bit</font><font color="#CCCCCC"> on the</font>

124
00:05:32,990 --> 00:05:36,800
<font color="#E5E5E5">different streams that are in this in</font>

125
00:05:35,330 --> 00:05:40,128
<font color="#E5E5E5">this file</font><font color="#CCCCCC"> so there's the macros</font>

126
00:05:36,800 --> 00:05:42,589
container<font color="#E5E5E5"> the</font><font color="#CCCCCC"> macro container contains</font>

127
00:05:40,129 --> 00:05:45,499
two streams project and project WM it

128
00:05:42,589 --> 00:05:47,449
contains another container called<font color="#E5E5E5"> VBA</font>

129
00:05:45,499 --> 00:05:52,310
and<font color="#CCCCCC"> that one also contains several</font>

130
00:05:47,449 --> 00:05:54,409
streams in this case let's start with

131
00:05:52,310 --> 00:05:56,149
the<font color="#E5E5E5"> project stream the project stream it</font>

132
00:05:54,409 --> 00:05:58,279
actually contains project information

133
00:05:56,149 --> 00:06:02,209
<font color="#CCCCCC">and what it does is just instruct the</font>

134
00:05:58,279 --> 00:06:04,819
VBA<font color="#E5E5E5"> editor GUI that's what it does the</font>

135
00:06:02,209 --> 00:06:07,069
VBA project stream within<font color="#E5E5E5"> the VBA</font>

136
00:06:04,819 --> 00:06:08,509
container that contains project

137
00:06:07,069 --> 00:06:11,209
information<font color="#CCCCCC"> but that one instructs this</font>

138
00:06:08,509 --> 00:06:13,879
VBA<font color="#E5E5E5"> engine so not a GUI but the actual</font>

139
00:06:11,209 --> 00:06:17,120
engine<font color="#E5E5E5"> that's going to run the macro</font><font color="#CCCCCC"> and</font>

140
00:06:13,879 --> 00:06:19,849
there is actually<font color="#CCCCCC"> no serious official</font>

141
00:06:17,120 --> 00:06:22,249
documentation on what's in this in this

142
00:06:19,849 --> 00:06:24,800
<font color="#E5E5E5">file but it is really important in</font>

143
00:06:22,249 --> 00:06:26,149
execution of markers<font color="#E5E5E5"> then there's</font><font color="#CCCCCC"> a</font><font color="#E5E5E5"> dear</font>

144
00:06:24,800 --> 00:06:28,309
stream and the dear stream is<font color="#CCCCCC"> just</font>

145
00:06:26,149 --> 00:06:30,830
basically a project layout<font color="#E5E5E5"> a directory</font>

146
00:06:28,309 --> 00:06:33,649
layout and though this whole stream is

147
00:06:30,830 --> 00:06:34,998
completely<font color="#E5E5E5"> compressed</font><font color="#CCCCCC"> whereas for the</font>

148
00:06:33,649 --> 00:06:37,370
next stream that we're going<font color="#E5E5E5"> to look at</font>

149
00:06:34,999 --> 00:06:39,649
a module stream the module stream

150
00:06:37,370 --> 00:06:42,019
contains the<font color="#CCCCCC"> actual code amongst others</font>

151
00:06:39,649 --> 00:06:43,340
and in this case<font color="#CCCCCC"> only the code is</font>

152
00:06:42,019 --> 00:06:45,430
compressed

153
00:06:43,340 --> 00:06:49,369
rest of this is not compressed<font color="#E5E5E5"> and</font>

154
00:06:45,430 --> 00:06:50,930
partly documented<font color="#E5E5E5"> smiley</font><font color="#CCCCCC"> face again if</font>

155
00:06:49,370 --> 00:06:53,900
it's not<font color="#E5E5E5"> documented</font><font color="#CCCCCC"> it's going to be fun</font>

156
00:06:50,930 --> 00:06:56,330
<font color="#CCCCCC">we'll</font><font color="#E5E5E5"> get there in a</font><font color="#CCCCCC"> minute as well</font><font color="#E5E5E5"> so</font>

157
00:06:53,900 --> 00:06:58,299
<font color="#CCCCCC">phew that was a few</font><font color="#E5E5E5"> minutes for</font><font color="#CCCCCC"> the for</font>

158
00:06:56,330 --> 00:07:01,820
the boring part now it's time for abuse

159
00:06:58,300 --> 00:07:04,759
<font color="#E5E5E5">for</font><font color="#CCCCCC"> the fun stuff</font><font color="#E5E5E5"> and for the fun</font><font color="#CCCCCC"> stuff</font>

160
00:07:01,820 --> 00:07:08,150
<font color="#CCCCCC">we are</font><font color="#E5E5E5"> going to work with one</font><font color="#CCCCCC"> of the</font>

161
00:07:04,759 --> 00:07:10,910
most obviously malicious<font color="#CCCCCC"> macros</font><font color="#E5E5E5"> we're</font>

162
00:07:08,150 --> 00:07:14,500
going to switch to<font color="#E5E5E5"> COBOL strike in our</font>

163
00:07:10,910 --> 00:07:19,430
case let's see where did I hide it<font color="#CCCCCC"> I</font>

164
00:07:14,500 --> 00:07:24,949
think I hit it<font color="#E5E5E5"> right here yeah</font><font color="#CCCCCC"> so this</font>

165
00:07:19,430 --> 00:07:26,330
<font color="#CCCCCC">is Coble strike red teaming tool</font><font color="#E5E5E5"> and one</font>

166
00:07:24,949 --> 00:07:28,190
<font color="#E5E5E5">of the basic</font><font color="#CCCCCC"> things that</font><font color="#E5E5E5"> you can do is</font>

167
00:07:26,330 --> 00:07:33,109
<font color="#E5E5E5">just create a really really really basic</font>

168
00:07:28,190 --> 00:07:38,930
office<font color="#CCCCCC"> micro office macro with the</font>

169
00:07:33,110 --> 00:07:40,960
clipboard<font color="#E5E5E5"> let's put it in a Word</font>

170
00:07:38,930 --> 00:07:40,960
document

171
00:07:48,080 --> 00:07:56,150
not in that normal dot<font color="#E5E5E5"> module so this is</font>

172
00:07:53,419 --> 00:07:58,250
default<font color="#CCCCCC"> Kobus</font><font color="#E5E5E5"> right macro it's a really</font>

173
00:07:56,150 --> 00:08:02,179
obviously malicious macro what it does

174
00:07:58,250 --> 00:08:04,220
is just<font color="#E5E5E5"> it kicks off</font><font color="#CCCCCC"> run DLL and</font><font color="#E5E5E5"> through</font>

175
00:08:02,180 --> 00:08:05,990
process injection via<font color="#CCCCCC"> Windows API</font><font color="#E5E5E5"> calls</font>

176
00:08:04,220 --> 00:08:07,580
it creates a<font color="#E5E5E5"> RW wakes memory block</font>

177
00:08:05,990 --> 00:08:09,379
insert<font color="#E5E5E5"> shell code there and</font><font color="#CCCCCC"> then creates</font>

178
00:08:07,580 --> 00:08:12,530
a threat in run<font color="#CCCCCC"> dll to kick off the</font>

179
00:08:09,379 --> 00:08:15,110
shell code obviously<font color="#E5E5E5"> militia is a really</font>

180
00:08:12,530 --> 00:08:17,559
basic mark<font color="#CCCCCC"> ro</font><font color="#E5E5E5"> and as we can</font><font color="#CCCCCC"> see if we</font>

181
00:08:15,110 --> 00:08:21,020
upload this file<font color="#E5E5E5"> to fires total we have</font>

182
00:08:17,560 --> 00:08:23,960
34 out<font color="#E5E5E5"> of 60 detections</font><font color="#CCCCCC"> and basically</font>

183
00:08:21,020 --> 00:08:29,628
<font color="#E5E5E5">all the major vendors</font><font color="#CCCCCC"> of course detect</font>

184
00:08:23,960 --> 00:08:31,250
such a macro easy stuff<font color="#E5E5E5"> so then one of</font>

185
00:08:29,629 --> 00:08:35,630
<font color="#E5E5E5">the first</font><font color="#CCCCCC"> tricks that we are going</font><font color="#E5E5E5"> to</font>

186
00:08:31,250 --> 00:08:37,578
<font color="#E5E5E5">apply is to hide our macro from the GUI</font>

187
00:08:35,630 --> 00:08:40,849
and therefore we go to the project

188
00:08:37,578 --> 00:08:43,789
stream<font color="#E5E5E5"> and the project stream as I said</font>

189
00:08:40,849 --> 00:08:45,800
it's just a GUI instruction stream it's

190
00:08:43,789 --> 00:08:47,600
like a like a text file it's not

191
00:08:45,800 --> 00:08:51,800
compressed<font color="#E5E5E5"> only</font><font color="#CCCCCC"> Eskie characters and</font>

192
00:08:47,600 --> 00:08:54,920
actually there's<font color="#CCCCCC"> just lines with crlf</font>

193
00:08:51,800 --> 00:08:58,520
<font color="#E5E5E5">ends for for each line and what we can</font>

194
00:08:54,920 --> 00:09:00,620
simply do is instruct the lines that

195
00:08:58,520 --> 00:09:05,630
tell the GUI that<font color="#E5E5E5"> there is actually a</font>

196
00:09:00,620 --> 00:09:07,579
VBA module in our in our file<font color="#CCCCCC"> and now</font><font color="#E5E5E5"> we</font>

197
00:09:05,630 --> 00:09:09,350
<font color="#E5E5E5">are going to switch</font><font color="#CCCCCC"> to code so we're</font>

198
00:09:07,579 --> 00:09:11,870
going<font color="#E5E5E5"> to use the open</font><font color="#CCCCCC"> MC DF</font><font color="#E5E5E5"> frameworks</font>

199
00:09:09,350 --> 00:09:14,209
<font color="#E5E5E5">actually parse a file from an on</font><font color="#CCCCCC"> Windows</font>

200
00:09:11,870 --> 00:09:16,370
system so this<font color="#E5E5E5"> is</font><font color="#CCCCCC"> OS X parsing the</font>

201
00:09:14,209 --> 00:09:20,829
<font color="#E5E5E5">Windows File and doing this manipulation</font>

202
00:09:16,370 --> 00:09:23,959
<font color="#E5E5E5">so if I say I copy my original file to</font>

203
00:09:20,829 --> 00:09:27,439
hidden dot doc and<font color="#E5E5E5"> I then say evil</font>

204
00:09:23,959 --> 00:09:32,779
<font color="#E5E5E5">office - I'll show the help file - gee</font>

205
00:09:27,440 --> 00:09:39,130
for<font color="#E5E5E5"> GUI hide on CS hidden yep</font><font color="#CCCCCC"> now it's</font>

206
00:09:32,779 --> 00:09:42,920
done and<font color="#CCCCCC"> we switch back here don't say</font>

207
00:09:39,130 --> 00:09:45,310
<font color="#E5E5E5">there should be a file called CS and DS</font>

208
00:09:42,920 --> 00:09:45,310
hidden

209
00:09:48,649 --> 00:09:55,440
so indeed<font color="#CCCCCC"> there's</font><font color="#E5E5E5"> a</font><font color="#CCCCCC"> macro in here I can</font>

210
00:09:51,660 --> 00:09:57,389
execute it if I execute<font color="#E5E5E5"> it I should be</font>

211
00:09:55,440 --> 00:10:00,300
seeing a new<font color="#E5E5E5"> beacon connection indeed</font>

212
00:09:57,389 --> 00:10:04,050
coming<font color="#E5E5E5"> in at Cobo strike</font><font color="#CCCCCC"> but if I now go</font>

213
00:10:00,300 --> 00:10:06,800
to<font color="#E5E5E5"> the GUI there is no macro anymore</font>

214
00:10:04,050 --> 00:10:10,769
<font color="#E5E5E5">it's completely hidden but this is just</font>

215
00:10:06,800 --> 00:10:12,990
gooey stuff on a file system level for

216
00:10:10,769 --> 00:10:19,889
<font color="#CCCCCC">sure the macro is still there</font><font color="#E5E5E5"> so if I</font>

217
00:10:12,990 --> 00:10:21,959
use Philips<font color="#CCCCCC"> oleh VBA then I see</font><font color="#E5E5E5"> that the</font>

218
00:10:19,889 --> 00:10:24,209
<font color="#E5E5E5">macro is of course still in the file is</font>

219
00:10:21,959 --> 00:10:28,500
<font color="#CCCCCC">just simply</font><font color="#E5E5E5"> not hidden in the GUI so</font>

220
00:10:24,209 --> 00:10:29,160
let's go<font color="#CCCCCC"> back</font><font color="#E5E5E5"> to the file format</font><font color="#CCCCCC"> back to</font>

221
00:10:28,500 --> 00:10:31,980
<font color="#E5E5E5">flextec</font>

222
00:10:29,160 --> 00:10:34,439
and look at what<font color="#E5E5E5"> this module stream</font>

223
00:10:31,980 --> 00:10:40,019
actually<font color="#E5E5E5"> looks like looks like this the</font>

224
00:10:34,440 --> 00:10:43,490
<font color="#E5E5E5">first part is</font><font color="#CCCCCC"> well get</font><font color="#E5E5E5"> to that later</font>

225
00:10:40,019 --> 00:10:43,490
and then somewhere

226
00:10:43,550 --> 00:10:49,469
exactly here starts<font color="#E5E5E5"> the compressed macro</font>

227
00:10:48,120 --> 00:10:51,149
code so<font color="#E5E5E5"> this custom compression</font>

228
00:10:49,470 --> 00:10:53,250
mechanism and the way that I know<font color="#CCCCCC"> that</font>

229
00:10:51,149 --> 00:10:55,290
is<font color="#CCCCCC"> because there is a o1 here which</font>

230
00:10:53,250 --> 00:10:57,029
means<font color="#E5E5E5"> that here the compression starts</font>

231
00:10:55,290 --> 00:11:01,110
<font color="#E5E5E5">this is</font><font color="#CCCCCC"> an instruction as compression</font>

232
00:10:57,029 --> 00:11:05,100
<font color="#CCCCCC">stars</font><font color="#E5E5E5"> so what if what</font><font color="#CCCCCC"> if we would just</font>

233
00:11:01,110 --> 00:11:10,380
<font color="#E5E5E5">add another old one to the end of the</font>

234
00:11:05,100 --> 00:11:12,360
string<font color="#CCCCCC"> and save this file</font><font color="#E5E5E5"> so any parser</font>

235
00:11:10,380 --> 00:11:15,269
<font color="#E5E5E5">that would</font><font color="#CCCCCC"> par the office file in just</font>

236
00:11:12,360 --> 00:11:17,750
search for<font color="#E5E5E5"> the last part of the file</font>

237
00:11:15,269 --> 00:11:20,819
where the compression starts would now

238
00:11:17,750 --> 00:11:23,430
find this<font color="#E5E5E5"> a 1 and let's see what then</font>

239
00:11:20,819 --> 00:11:25,829
happens I've prepared this file on disk

240
00:11:23,430 --> 00:11:34,769
already I guess<font color="#CCCCCC"> yes I'm doing</font>

241
00:11:25,829 --> 00:11:38,609
<font color="#CCCCCC">Oly</font><font color="#E5E5E5"> VBA</font><font color="#CCCCCC"> she</font><font color="#E5E5E5"> has a</font><font color="#CCCCCC"> 1</font><font color="#E5E5E5"> then then probably I</font>

242
00:11:34,769 --> 00:11:44,959
should save<font color="#CCCCCC"> it original yeah that's fine</font>

243
00:11:38,610 --> 00:11:44,959
I'm gonna save this yep

244
00:11:47,540 --> 00:11:54,660
<font color="#E5E5E5">holy VBA oh sorry</font>

245
00:11:53,040 --> 00:11:57,240
yeah thanks that's the problem with live

246
00:11:54,660 --> 00:11:59,819
demos<font color="#E5E5E5"> and now all of</font><font color="#CCCCCC"> a sudden</font><font color="#E5E5E5"> only VBA</font>

247
00:11:57,240 --> 00:12:03,180
crashes<font color="#E5E5E5"> there's a patch coming any</font>

248
00:11:59,819 --> 00:12:05,128
<font color="#CCCCCC">anytime soon</font><font color="#E5E5E5"> but this is only VBA</font><font color="#CCCCCC"> let's</font>

249
00:12:03,180 --> 00:12:07,290
go back to<font color="#E5E5E5"> virustotal</font>

250
00:12:05,129 --> 00:12:12,360
if we upload this file so we had 34

251
00:12:07,290 --> 00:12:14,310
detections<font color="#E5E5E5"> we now lost</font><font color="#CCCCCC"> five you might</font>

252
00:12:12,360 --> 00:12:16,439
think that that's no biggie

253
00:12:14,310 --> 00:12:17,930
<font color="#E5E5E5">but let's see which one we have actually</font>

254
00:12:16,439 --> 00:12:20,300
lost<font color="#E5E5E5"> at the moment</font>

255
00:12:17,930 --> 00:12:23,069
amongst them there's end game and

256
00:12:20,300 --> 00:12:26,250
there's Sentinel<font color="#E5E5E5"> one like two really</font><font color="#CCCCCC"> big</font>

257
00:12:23,069 --> 00:12:29,339
<font color="#CCCCCC">EDR vendors that fall for this really</font>

258
00:12:26,250 --> 00:12:31,829
<font color="#E5E5E5">simple stuff</font><font color="#CCCCCC"> but even virustotal itself</font>

259
00:12:29,339 --> 00:12:33,660
has a problem<font color="#E5E5E5"> in parsing this because if</font>

260
00:12:31,829 --> 00:12:35,729
<font color="#CCCCCC">we go to</font><font color="#E5E5E5"> details on the original file</font>

261
00:12:33,660 --> 00:12:39,089
<font color="#E5E5E5">you clearly see that it is being able to</font>

262
00:12:35,730 --> 00:12:41,759
<font color="#CCCCCC">analyze the</font><font color="#E5E5E5"> macro and that we can see</font>

263
00:12:39,089 --> 00:12:44,819
the<font color="#CCCCCC"> macro source code in here</font><font color="#E5E5E5"> but if we</font>

264
00:12:41,759 --> 00:12:48,269
go<font color="#E5E5E5"> to the stream with zero one edit and</font>

265
00:12:44,819 --> 00:12:50,128
we go to details<font color="#E5E5E5"> then</font><font color="#CCCCCC"> suddenly farce</font>

266
00:12:48,269 --> 00:12:52,110
<font color="#E5E5E5">total is not being able to parse this</font>

267
00:12:50,129 --> 00:12:54,149
anymore<font color="#E5E5E5"> so really really really basic</font>

268
00:12:52,110 --> 00:12:57,600
trick<font color="#E5E5E5"> but there's much more fun stuff</font>

269
00:12:54,149 --> 00:13:01,709
<font color="#CCCCCC">sorry</font><font color="#E5E5E5"> for switching our screen guys so</font>

270
00:12:57,600 --> 00:13:06,509
<font color="#E5E5E5">that's basic</font><font color="#CCCCCC"> but what if we wanted to</font>

271
00:13:01,709 --> 00:13:08,790
completely remove VBA not even there

272
00:13:06,509 --> 00:13:10,350
then let's<font color="#CCCCCC"> go back</font><font color="#E5E5E5"> to the specification</font>

273
00:13:08,790 --> 00:13:11,880
and<font color="#E5E5E5"> this is a module stream so this is</font>

274
00:13:10,350 --> 00:13:14,220
where the stream that<font color="#E5E5E5"> holds the code and</font>

275
00:13:11,880 --> 00:13:15,779
it consists of two parts<font color="#CCCCCC"> a performance</font>

276
00:13:14,220 --> 00:13:17,009
<font color="#CCCCCC">cache and compressed source code</font>

277
00:13:15,779 --> 00:13:18,779
well compress source code<font color="#CCCCCC"> I've just</font>

278
00:13:17,009 --> 00:13:20,639
explained starting with a 1 and<font color="#CCCCCC"> then a</font>

279
00:13:18,779 --> 00:13:24,329
<font color="#CCCCCC">compression</font><font color="#E5E5E5"> of just basically the VBA</font>

280
00:13:20,639 --> 00:13:27,149
<font color="#CCCCCC">techs</font><font color="#E5E5E5"> that you see in the editor the</font>

281
00:13:24,329 --> 00:13:33,779
performance<font color="#E5E5E5"> cache what the heck is that</font>

282
00:13:27,149 --> 00:13:35,850
<font color="#CCCCCC">a really</font><font color="#E5E5E5"> fake sentence test here</font><font color="#CCCCCC"> there's</font>

283
00:13:33,779 --> 00:13:37,920
no additional explanation except from

284
00:13:35,850 --> 00:13:41,480
this fake sentence and it says must be

285
00:13:37,920 --> 00:13:46,139
ignored<font color="#E5E5E5"> on read well</font><font color="#CCCCCC"> I promise you</font>

286
00:13:41,480 --> 00:13:47,579
<font color="#E5E5E5">office is not ignoring this on read this</font>

287
00:13:46,139 --> 00:13:53,939
is where they<font color="#E5E5E5"> are deviating from their</font>

288
00:13:47,579 --> 00:13:55,079
own specs<font color="#CCCCCC"> yeah so what is this</font>

289
00:13:53,939 --> 00:13:57,870
performance cache

290
00:13:55,079 --> 00:13:59,888
well if you save a file in Microsoft

291
00:13:57,870 --> 00:14:01,420
Office<font color="#CCCCCC"> every module steam</font><font color="#E5E5E5"> 3</font>

292
00:13:59,889 --> 00:14:02,949
has they<font color="#E5E5E5"> performance yet as I said</font>

293
00:14:01,420 --> 00:14:04,779
<font color="#CCCCCC">there's</font><font color="#E5E5E5"> no official documentation and</font>

294
00:14:02,949 --> 00:14:07,779
this performance<font color="#CCCCCC"> cash it contains</font>

295
00:14:04,779 --> 00:14:09,790
<font color="#E5E5E5">pseudocode which is called</font><font color="#CCCCCC"> p code which</font>

296
00:14:07,779 --> 00:14:12,009
is pseudo code like compiled code for a

297
00:14:09,790 --> 00:14:14,709
<font color="#E5E5E5">VBA stack machine and a stack machine is</font>

298
00:14:12,009 --> 00:14:16,419
VBA version specific but the<font color="#E5E5E5"> VBA version</font>

299
00:14:14,709 --> 00:14:18,459
hasn't changed in the last few office

300
00:14:16,419 --> 00:14:21,819
releases so everything from 2010 onwards

301
00:14:18,459 --> 00:14:25,479
will work just fine<font color="#CCCCCC"> and the</font><font color="#E5E5E5"> P code is</font>

302
00:14:21,819 --> 00:14:29,469
executed if the version<font color="#E5E5E5"> of the file</font>

303
00:14:25,480 --> 00:14:32,589
matches the<font color="#E5E5E5"> version of of the host like</font>

304
00:14:29,470 --> 00:14:34,989
Word or Excel that's that's running<font color="#E5E5E5"> and</font>

305
00:14:32,589 --> 00:14:37,629
it then completely<font color="#E5E5E5"> ignores the VBA macro</font>

306
00:14:34,989 --> 00:14:39,369
and ruins the<font color="#E5E5E5"> P code instead this has</font>

307
00:14:37,629 --> 00:14:42,040
been explored from<font color="#E5E5E5"> a defensive</font>

308
00:14:39,369 --> 00:14:43,749
perspective<font color="#E5E5E5"> most importantly by dr.</font>

309
00:14:42,040 --> 00:14:45,459
Bowen<font color="#E5E5E5"> Jeff but also by the team from</font>

310
00:14:43,749 --> 00:14:48,730
Walmart we have released several tools

311
00:14:45,459 --> 00:14:51,608
<font color="#E5E5E5">the website is at PBS bomb.com but this</font>

312
00:14:48,730 --> 00:14:53,980
hasn't<font color="#CCCCCC"> been properly</font><font color="#E5E5E5"> explored and reppin</font>

313
00:14:51,609 --> 00:15:04,509
eyes from a<font color="#E5E5E5"> offensive perspective so</font>

314
00:14:53,980 --> 00:15:06,579
that<font color="#CCCCCC"> is what we are</font><font color="#E5E5E5"> going to do yes okay</font>

315
00:15:04,509 --> 00:15:10,419
yeah so this<font color="#E5E5E5"> is what what we</font><font color="#CCCCCC"> are going</font>

316
00:15:06,579 --> 00:15:15,519
<font color="#E5E5E5">to do I'm gonna do this light</font><font color="#CCCCCC"> so that's</font>

317
00:15:10,419 --> 00:15:19,360
fight first<font color="#E5E5E5"> so what it will look at to</font>

318
00:15:15,519 --> 00:15:21,459
know<font color="#CCCCCC"> if the version of office matches</font>

319
00:15:19,360 --> 00:15:24,579
the<font color="#CCCCCC"> version of the file is in the</font><font color="#E5E5E5"> VBA</font>

320
00:15:21,459 --> 00:15:27,339
project<font color="#E5E5E5"> stream and there is a version by</font>

321
00:15:24,579 --> 00:15:31,660
<font color="#E5E5E5">there and it says must be ignored on</font>

322
00:15:27,339 --> 00:15:33,249
read<font color="#E5E5E5"> must be ffff on right so let's look</font>

323
00:15:31,660 --> 00:15:40,419
at what is<font color="#E5E5E5"> actually in there when I</font>

324
00:15:33,249 --> 00:15:46,059
press save AF oh oh so sorry Microsoft

325
00:15:40,419 --> 00:15:47,199
<font color="#E5E5E5">but it was you're simply not telling the</font>

326
00:15:46,059 --> 00:15:49,809
truth<font color="#CCCCCC"> in this</font><font color="#E5E5E5"> case there's</font><font color="#CCCCCC"> more</font>

327
00:15:47,199 --> 00:15:52,569
happening so what<font color="#E5E5E5"> we have to do is we</font>

328
00:15:49,809 --> 00:15:56,618
<font color="#CCCCCC">just</font><font color="#E5E5E5"> have to match the VBA project</font>

329
00:15:52,569 --> 00:15:58,839
version and then yeah we can completely

330
00:15:56,619 --> 00:16:01,470
disregards the<font color="#CCCCCC"> Phoebe a code and execute</font>

331
00:15:58,839 --> 00:16:07,179
<font color="#CCCCCC">re</font><font color="#E5E5E5"> the Pico just being executed is that</font>

332
00:16:01,470 --> 00:16:10,569
so<font color="#E5E5E5"> we can also do that via code so back</font>

333
00:16:07,179 --> 00:16:11,560
to<font color="#E5E5E5"> here</font><font color="#CCCCCC"> what I'm now going to do is I</font>

334
00:16:10,569 --> 00:16:16,660
say

335
00:16:11,560 --> 00:16:19,859
I am going to<font color="#E5E5E5"> run evil office again I'm</font>

336
00:16:16,660 --> 00:16:24,850
first going to copy my original file

337
00:16:19,860 --> 00:16:28,720
which<font color="#CCCCCC"> has a</font><font color="#E5E5E5"> one I don't think that</font>

338
00:16:24,850 --> 00:16:30,970
that's dangerous<font color="#CCCCCC"> but just to</font><font color="#E5E5E5"> make sure</font>

339
00:16:28,720 --> 00:16:38,949
I'm<font color="#E5E5E5"> going to copy my really original</font>

340
00:16:30,970 --> 00:16:42,670
file<font color="#E5E5E5"> yep two CS</font><font color="#CCCCCC"> peacoat dot doc</font><font color="#E5E5E5"> evil</font>

341
00:16:38,949 --> 00:16:49,559
office<font color="#E5E5E5"> GUI hides and I'm going to stomp</font>

342
00:16:42,670 --> 00:16:54,628
it with fake code<font color="#CCCCCC"> okay so if I now run a</font>

343
00:16:49,559 --> 00:16:59,350
code analysis tool on this like<font color="#E5E5E5"> Olaf EBA</font>

344
00:16:54,629 --> 00:17:01,329
on<font color="#CCCCCC"> T code it will say well this is</font><font color="#E5E5E5"> the</font>

345
00:16:59,350 --> 00:17:03,839
code sub fake out with high troopers

346
00:17:01,329 --> 00:17:14,220
<font color="#E5E5E5">this is fake</font><font color="#CCCCCC"> this code this code is fake</font>

347
00:17:03,839 --> 00:17:14,220
but if I<font color="#E5E5E5"> actually go to the file</font><font color="#CCCCCC"> P code</font>

348
00:17:21,809 --> 00:17:25,459
that's the thing<font color="#E5E5E5"> with live demos</font>

349
00:17:30,020 --> 00:17:37,879
yep there's markers in here enable

350
00:17:32,540 --> 00:17:39,770
content and again we have a second<font color="#E5E5E5"> mouth</font>

351
00:17:37,880 --> 00:17:42,050
malware connection coming<font color="#E5E5E5"> in so it's not</font>

352
00:17:39,770 --> 00:17:44,960
a fake<font color="#CCCCCC"> oh that was being</font><font color="#E5E5E5"> read it was the</font>

353
00:17:42,050 --> 00:17:46,879
<font color="#CCCCCC">peek</font><font color="#E5E5E5"> out it was being read</font><font color="#CCCCCC"> so if we make</font>

354
00:17:44,960 --> 00:17:48,679
sure<font color="#CCCCCC"> that the file matches the office</font>

355
00:17:46,880 --> 00:17:51,170
version then<font color="#E5E5E5"> VBA code is disregarded</font>

356
00:17:48,679 --> 00:17:58,700
<font color="#E5E5E5">completely and another type</font><font color="#CCCCCC"> of code is</font>

357
00:17:51,170 --> 00:18:01,760
being executed so how can we<font color="#E5E5E5"> extract P</font>

358
00:17:58,700 --> 00:18:04,280
code from files<font color="#CCCCCC"> there's a tool called</font>

359
00:18:01,760 --> 00:18:08,780
<font color="#CCCCCC">Pico dump</font><font color="#E5E5E5"> which is from dr.</font><font color="#CCCCCC"> punch F and</font>

360
00:18:04,280 --> 00:18:11,899
I'll just demo it here<font color="#CCCCCC"> pico dump on this</font>

361
00:18:08,780 --> 00:18:14,059
file and<font color="#CCCCCC"> then pico dump</font><font color="#E5E5E5"> is still able to</font>

362
00:18:11,900 --> 00:18:16,070
<font color="#CCCCCC">actually parse the P code and we</font><font color="#E5E5E5"> can see</font>

363
00:18:14,059 --> 00:18:21,399
here what<font color="#E5E5E5"> kind of malicious actions that</font>

364
00:18:16,070 --> 00:18:24,470
it is doing so how can<font color="#E5E5E5"> we get</font><font color="#CCCCCC"> rid of</font>

365
00:18:21,400 --> 00:18:28,670
analysis by tools like this<font color="#CCCCCC"> P</font><font color="#E5E5E5"> code them</font>

366
00:18:24,470 --> 00:18:31,309
for that we dive back<font color="#E5E5E5"> into into the</font>

367
00:18:28,670 --> 00:18:33,440
specifications again and if you look at

368
00:18:31,309 --> 00:18:34,820
the dear stream which is<font color="#E5E5E5"> like the</font>

369
00:18:33,440 --> 00:18:37,880
directory layout<font color="#CCCCCC"> and there's a</font>

370
00:18:34,820 --> 00:18:41,659
specification<font color="#E5E5E5"> and there's a stream name</font>

371
00:18:37,880 --> 00:18:46,400
<font color="#E5E5E5">and a stream name</font><font color="#CCCCCC"> unicode so there's two</font>

372
00:18:41,660 --> 00:18:48,800
fields pointing<font color="#CCCCCC"> to</font><font color="#E5E5E5"> the same module one</font>

373
00:18:46,400 --> 00:18:52,400
is<font color="#E5E5E5"> in</font><font color="#CCCCCC"> S key and one is in Unicode so we</font>

374
00:18:48,800 --> 00:18:55,580
have two names<font color="#CCCCCC"> for the same object</font><font color="#E5E5E5"> what</font>

375
00:18:52,400 --> 00:18:57,440
could<font color="#CCCCCC"> possibly go</font><font color="#E5E5E5"> wrong here</font><font color="#CCCCCC"> and this is</font>

376
00:18:55,580 --> 00:19:00,678
like all<font color="#CCCCCC"> over</font><font color="#E5E5E5"> the specification this</font>

377
00:18:57,440 --> 00:19:02,110
this kind of stuff<font color="#E5E5E5"> well it's</font><font color="#CCCCCC"> actually</font>

378
00:19:00,679 --> 00:19:06,490
<font color="#E5E5E5">pretty simple</font>

379
00:19:02,110 --> 00:19:11,120
almost all analyst tools use this name

380
00:19:06,490 --> 00:19:13,309
<font color="#CCCCCC">Microsoft Office</font><font color="#E5E5E5"> uses this name so what</font>

381
00:19:11,120 --> 00:19:16,928
we can now do is just say so we have our

382
00:19:13,309 --> 00:19:20,450
we have a foul I'm going to copy<font color="#E5E5E5"> the</font>

383
00:19:16,929 --> 00:19:25,220
<font color="#CCCCCC">original file</font><font color="#E5E5E5"> where was it copy</font><font color="#CCCCCC"> Tampa</font>

384
00:19:20,450 --> 00:19:27,920
regional<font color="#CCCCCC"> to random and I'm going</font><font color="#E5E5E5"> to say</font>

385
00:19:25,220 --> 00:19:29,840
<font color="#E5E5E5">evil office all of this is the same but</font>

386
00:19:27,920 --> 00:19:34,600
<font color="#E5E5E5">I'm now going to set random names for</font>

387
00:19:29,840 --> 00:19:34,600
the<font color="#CCCCCC"> s key names of modules in the Destry</font>

388
00:19:38,010 --> 00:19:43,850
so what we can now see if I open random

389
00:19:46,250 --> 00:19:53,549
it's getting slower and<font color="#E5E5E5"> slower of course</font>

390
00:19:48,809 --> 00:19:55,200
and they will content<font color="#E5E5E5"> and we have a</font>

391
00:19:53,549 --> 00:19:57,270
<font color="#E5E5E5">third connection coming in so the</font><font color="#CCCCCC"> macro</font>

392
00:19:55,200 --> 00:20:05,610
is still<font color="#E5E5E5"> working but if we now do a</font>

393
00:19:57,270 --> 00:20:09,210
<font color="#CCCCCC">peacoat analysis okay this is really</font>

394
00:20:05,610 --> 00:20:18,120
really really<font color="#CCCCCC"> interesting I have it in</font>

395
00:20:09,210 --> 00:20:20,960
examples all of a<font color="#E5E5E5"> sudden you see error</font>

396
00:20:18,120 --> 00:20:20,959
file not found

397
00:20:21,080 --> 00:20:27,510
so analyst tools are using one

398
00:20:24,480 --> 00:20:29,340
specification<font color="#CCCCCC"> Microsoft</font><font color="#E5E5E5"> itself is using</font>

399
00:20:27,510 --> 00:20:33,960
<font color="#CCCCCC">another part of</font><font color="#E5E5E5"> the specification</font><font color="#CCCCCC"> and</font>

400
00:20:29,340 --> 00:20:36,449
there we<font color="#E5E5E5"> get complete mismatches so then</font>

401
00:20:33,960 --> 00:20:38,490
the<font color="#E5E5E5"> last</font><font color="#CCCCCC"> question is how do we match the</font>

402
00:20:36,450 --> 00:20:42,260
target<font color="#CCCCCC"> office:version when we are going</font>

403
00:20:38,490 --> 00:20:45,179
<font color="#E5E5E5">to weaponize this well fortunately</font>

404
00:20:42,260 --> 00:20:47,940
office itself tells you which exact

405
00:20:45,179 --> 00:20:50,160
version that it is and you<font color="#CCCCCC"> can get an</font>

406
00:20:47,940 --> 00:20:53,820
exact version by using<font color="#E5E5E5"> document</font>

407
00:20:50,160 --> 00:20:56,250
templates so what you can do is you<font color="#E5E5E5"> can</font>

408
00:20:53,820 --> 00:21:00,330
just<font color="#CCCCCC"> create an</font><font color="#E5E5E5"> empty document completely</font>

409
00:20:56,250 --> 00:21:02,820
empty<font color="#E5E5E5"> connect a template and a template</font>

410
00:21:00,330 --> 00:21:04,949
can be<font color="#E5E5E5"> on a</font><font color="#CCCCCC"> website so you can just</font>

411
00:21:02,820 --> 00:21:07,710
<font color="#E5E5E5">point it to a website</font><font color="#CCCCCC"> which can be HTTP</font>

412
00:21:04,950 --> 00:21:10,110
it can be any extension so it doesn't

413
00:21:07,710 --> 00:21:12,450
have<font color="#E5E5E5"> to be dot or dot</font><font color="#CCCCCC"> m4 for a template</font>

414
00:21:10,110 --> 00:21:14,820
<font color="#E5E5E5">can be</font><font color="#CCCCCC"> Locasto jpg you can point it</font><font color="#E5E5E5"> to</font>

415
00:21:12,450 --> 00:21:17,370
there<font color="#E5E5E5"> and upon retrieval Microsoft</font>

416
00:21:14,820 --> 00:21:19,950
Office actually<font color="#CCCCCC"> since it's a detailed</font>

417
00:21:17,370 --> 00:21:26,250
version<font color="#CCCCCC"> there</font><font color="#E5E5E5"> and from our tool it looks</font>

418
00:21:19,950 --> 00:21:30,030
<font color="#CCCCCC">like this it</font><font color="#E5E5E5"> looks like this so we have</font>

419
00:21:26,250 --> 00:21:32,790
an evil office running<font color="#CCCCCC"> actually office</font>

420
00:21:30,030 --> 00:21:34,770
sends a few bogus versions first<font color="#E5E5E5"> not</font>

421
00:21:32,790 --> 00:21:37,290
sure why<font color="#CCCCCC"> that happens</font><font color="#E5E5E5"> but</font><font color="#CCCCCC"> it's pretty</font>

422
00:21:34,770 --> 00:21:38,850
clear<font color="#CCCCCC"> if you've seen a lot</font><font color="#E5E5E5"> of</font><font color="#CCCCCC"> these</font><font color="#E5E5E5"> that</font>

423
00:21:37,290 --> 00:21:42,030
<font color="#E5E5E5">this</font><font color="#CCCCCC"> is</font><font color="#E5E5E5"> the actual header that you</font>

424
00:21:38,850 --> 00:21:50,090
should trigger on<font color="#E5E5E5"> and we see here that</font>

425
00:21:42,030 --> 00:21:53,330
this<font color="#CCCCCC"> is office</font><font color="#E5E5E5"> 16 which is 2016</font>

426
00:21:50,090 --> 00:21:55,280
which is a 32-bit<font color="#E5E5E5"> process and we have</font>

427
00:21:53,330 --> 00:21:57,770
<font color="#E5E5E5">every information that we need here and</font>

428
00:21:55,280 --> 00:22:00,170
<font color="#E5E5E5">we're</font><font color="#CCCCCC"> there now okay so</font><font color="#E5E5E5"> let's start</font>

429
00:21:57,770 --> 00:22:02,930
<font color="#E5E5E5">serving a VBA project stream which</font>

430
00:22:00,170 --> 00:22:06,230
matches<font color="#E5E5E5"> the 2016 86 version we will</font>

431
00:22:02,930 --> 00:22:07,820
release a<font color="#E5E5E5"> short table of office versions</font>

432
00:22:06,230 --> 00:22:10,700
and which<font color="#CCCCCC"> bytes should be included</font><font color="#E5E5E5"> in</font>

433
00:22:07,820 --> 00:22:12,230
VBA project and actually this<font color="#E5E5E5"> code will</font>

434
00:22:10,700 --> 00:22:14,120
be<font color="#E5E5E5"> released in a</font><font color="#CCCCCC"> couple of</font><font color="#E5E5E5"> weeks</font><font color="#CCCCCC"> it's</font>

435
00:22:12,230 --> 00:22:16,070
<font color="#E5E5E5">currently it's a really ugly proof of</font>

436
00:22:14,120 --> 00:22:17,600
<font color="#CCCCCC">concept</font><font color="#E5E5E5"> and I don't really feel</font><font color="#CCCCCC"> I would</font>

437
00:22:16,070 --> 00:22:20,179
<font color="#E5E5E5">be ashamed if I would publish the code</font>

438
00:22:17,600 --> 00:22:21,530
at<font color="#E5E5E5"> this moment but wait a few weeks and</font>

439
00:22:20,180 --> 00:22:25,760
you'll see it<font color="#E5E5E5"> arrived from our block and</font>

440
00:22:21,530 --> 00:22:27,889
<font color="#CCCCCC">I'll get up in a more polished code so</font>

441
00:22:25,760 --> 00:22:32,840
then in the<font color="#CCCCCC"> NT</font><font color="#E5E5E5"> question is like how</font>

442
00:22:27,890 --> 00:22:35,870
effective is this so we've gone from 34

443
00:22:32,840 --> 00:22:40,100
detections<font color="#E5E5E5"> on a really basic</font><font color="#CCCCCC"> and clearly</font>

444
00:22:35,870 --> 00:22:44,169
malicious macro back to 29 and<font color="#E5E5E5"> if we</font>

445
00:22:40,100 --> 00:22:47,480
scan<font color="#E5E5E5"> for</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> P code version all major</font>

446
00:22:44,170 --> 00:22:50,990
antivirus engines are completely<font color="#E5E5E5"> gone</font><font color="#CCCCCC"> so</font>

447
00:22:47,480 --> 00:22:54,470
<font color="#CCCCCC">peek out</font><font color="#E5E5E5"> from an offensive perspective</font>

448
00:22:50,990 --> 00:22:57,500
is a really interesting<font color="#CCCCCC"> area to</font><font color="#E5E5E5"> abuse</font>

449
00:22:54,470 --> 00:23:01,930
because currently it's passing<font color="#E5E5E5"> all major</font>

450
00:22:57,500 --> 00:23:04,910
static analysis analyzers that<font color="#E5E5E5"> are here</font>

451
00:23:01,930 --> 00:23:06,860
we only<font color="#E5E5E5"> have an hour for this and</font><font color="#CCCCCC"> Peter</font>

452
00:23:04,910 --> 00:23:08,870
<font color="#CCCCCC">is really anxious getting to the more</font>

453
00:23:06,860 --> 00:23:13,070
<font color="#CCCCCC">than</font><font color="#E5E5E5"> any part there's plenty of more</font>

454
00:23:08,870 --> 00:23:15,739
tricks like this<font color="#CCCCCC"> but they all follow a</font>

455
00:23:13,070 --> 00:23:18,260
simple<font color="#E5E5E5"> recipe which is</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> following one</font>

456
00:23:15,740 --> 00:23:20,380
<font color="#E5E5E5">there's much more evil and if you follow</font>

457
00:23:18,260 --> 00:23:23,050
this recipe<font color="#E5E5E5"> is a guaranteed success</font>

458
00:23:20,380 --> 00:23:26,060
<font color="#E5E5E5">first thing that you should look</font><font color="#CCCCCC"> for is</font>

459
00:23:23,050 --> 00:23:28,280
abuse ambiguity<font color="#CCCCCC"> in specs</font><font color="#E5E5E5"> I've shown</font><font color="#CCCCCC"> you</font>

460
00:23:26,060 --> 00:23:30,320
the example of a field<font color="#E5E5E5"> and eski and a</font>

461
00:23:28,280 --> 00:23:34,160
field in<font color="#E5E5E5"> Unicode according to the same</font>

462
00:23:30,320 --> 00:23:36,080
object<font color="#CCCCCC"> that's just</font><font color="#E5E5E5"> asking for problems</font>

463
00:23:34,160 --> 00:23:39,920
<font color="#CCCCCC">and there's plenty</font><font color="#E5E5E5"> of those</font><font color="#CCCCCC"> in the</font>

464
00:23:36,080 --> 00:23:42,020
specifications another guarantee for

465
00:23:39,920 --> 00:23:44,480
success<font color="#E5E5E5"> is to explore and documented</font>

466
00:23:42,020 --> 00:23:47,360
features if you<font color="#E5E5E5"> just open up the 109</font>

467
00:23:44,480 --> 00:23:50,420
pages<font color="#E5E5E5"> specification and you just do ctrl</font>

468
00:23:47,360 --> 00:23:52,879
F start searching<font color="#CCCCCC"> for must</font><font color="#E5E5E5"> be ignored</font>

469
00:23:50,420 --> 00:23:54,740
<font color="#E5E5E5">and must not</font><font color="#CCCCCC"> be present because clearly</font>

470
00:23:52,880 --> 00:23:56,570
they aren't ignored by Microsoft Office

471
00:23:54,740 --> 00:23:58,040
and they are almost always<font color="#CCCCCC"> present if</font>

472
00:23:56,570 --> 00:24:00,800
you<font color="#E5E5E5"> just save a file from Microsoft</font>

473
00:23:58,040 --> 00:24:02,870
<font color="#E5E5E5">Office really interesting and the last</font>

474
00:24:00,800 --> 00:24:04,639
one is<font color="#CCCCCC"> just try deviating from</font>

475
00:24:02,870 --> 00:24:07,250
<font color="#CCCCCC">spec's it turns out</font><font color="#E5E5E5"> that</font><font color="#CCCCCC"> microsoft</font>

476
00:24:04,640 --> 00:24:08,900
<font color="#CCCCCC">office</font><font color="#E5E5E5"> is pretty robust</font><font color="#CCCCCC"> if you don't</font>

477
00:24:07,250 --> 00:24:12,170
follow the exact specs while most

478
00:24:08,900 --> 00:24:14,660
<font color="#E5E5E5">analyst tools</font><font color="#CCCCCC"> pico de ole EPP a</font>

479
00:24:12,170 --> 00:24:17,630
<font color="#E5E5E5">virustotal and practically every tool</font>

480
00:24:14,660 --> 00:24:19,430
that<font color="#CCCCCC"> are</font><font color="#E5E5E5"> tested they are much more</font>

481
00:24:17,630 --> 00:24:21,470
sticking to the actual specs and<font color="#E5E5E5"> you</font>

482
00:24:19,430 --> 00:24:23,720
<font color="#E5E5E5">just crash if you deviate from that</font><font color="#CCCCCC"> so</font>

483
00:24:21,470 --> 00:24:25,430
this recipe<font color="#E5E5E5"> guarantees success we've</font>

484
00:24:23,720 --> 00:24:27,710
<font color="#E5E5E5">only</font><font color="#CCCCCC"> show you the tip of the iceberg and</font>

485
00:24:25,430 --> 00:24:30,440
the<font color="#E5E5E5"> funny</font><font color="#CCCCCC"> thing is</font><font color="#E5E5E5"> in this book we have</font>

486
00:24:27,710 --> 00:24:32,180
only<font color="#E5E5E5"> explored the MSL vba specification</font>

487
00:24:30,440 --> 00:24:34,730
<font color="#E5E5E5">like the way in which markers are stored</font>

488
00:24:32,180 --> 00:24:37,640
<font color="#E5E5E5">but if you go one layer deeper to the</font>

489
00:24:34,730 --> 00:24:40,130
<font color="#E5E5E5">actual compound file binary format and</font>

490
00:24:37,640 --> 00:24:42,140
the specification is there<font color="#E5E5E5"> I'm pretty</font>

491
00:24:40,130 --> 00:24:44,929
<font color="#E5E5E5">sure that you can apply</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> same recipe</font>

492
00:24:42,140 --> 00:24:46,790
<font color="#CCCCCC">and end up with even more interesting</font>

493
00:24:44,929 --> 00:24:49,929
stuff<font color="#E5E5E5"> or or</font><font color="#CCCCCC"> however you want to</font>

494
00:24:46,790 --> 00:24:54,200
<font color="#E5E5E5">call it so that concludes the first part</font>

495
00:24:49,929 --> 00:24:58,190
<font color="#E5E5E5">we've shown you how</font><font color="#CCCCCC"> to evade static</font>

496
00:24:54,200 --> 00:25:00,200
analysis in a few simple<font color="#E5E5E5"> ways by just</font>

497
00:24:58,190 --> 00:25:02,390
slightly deviating from the standards

498
00:25:00,200 --> 00:25:04,880
adding a oh one<font color="#E5E5E5"> byte we already fool a</font>

499
00:25:02,390 --> 00:25:07,130
few major engines but if we go<font color="#E5E5E5"> to peek</font>

500
00:25:04,880 --> 00:25:09,320
out a completely undocumented<font color="#E5E5E5"> feature in</font>

501
00:25:07,130 --> 00:25:12,080
<font color="#CCCCCC">Microsoft Office then we can evade all</font>

502
00:25:09,320 --> 00:25:14,210
major<font color="#E5E5E5"> antivirus engines using a really</font>

503
00:25:12,080 --> 00:25:17,210
<font color="#E5E5E5">basic marker like the default code both</font>

504
00:25:14,210 --> 00:25:19,970
right one but if<font color="#E5E5E5"> you have if you hit a</font>

505
00:25:17,210 --> 00:25:23,150
properly configured<font color="#CCCCCC"> Microsoft Office</font>

506
00:25:19,970 --> 00:25:25,520
instance on a updated<font color="#E5E5E5"> windows 10 machine</font>

507
00:25:23,150 --> 00:25:28,400
<font color="#E5E5E5">then</font><font color="#CCCCCC"> there is also dynamic analysis</font>

508
00:25:25,520 --> 00:25:30,860
involved<font color="#E5E5E5"> most importantly mz4 VBA and</font>

509
00:25:28,400 --> 00:25:38,110
that is exactly what<font color="#E5E5E5"> Peter is going to</font>

510
00:25:30,860 --> 00:25:40,309
tell you all about yeah<font color="#E5E5E5"> so that worked</font>

511
00:25:38,110 --> 00:25:43,550
<font color="#E5E5E5">thanks for the demo girls and for the</font>

512
00:25:40,309 --> 00:25:46,760
changing<font color="#CCCCCC"> of screen guards indeed talking</font>

513
00:25:43,550 --> 00:25:50,950
<font color="#E5E5E5">about escaping the</font><font color="#CCCCCC"> changed</font><font color="#E5E5E5"> and forced by</font>

514
00:25:46,760 --> 00:25:53,510
the way<font color="#E5E5E5"> mz4 VBA so in September 2018</font>

515
00:25:50,950 --> 00:25:58,429
<font color="#E5E5E5">Microsoft announced that there will be</font>

516
00:25:53,510 --> 00:26:01,910
an MZ implementation in office<font color="#E5E5E5"> and what</font>

517
00:25:58,429 --> 00:26:03,290
MZ is is it's an interface<font color="#E5E5E5"> for a lot of</font>

518
00:26:01,910 --> 00:26:05,600
descripting engines reported by

519
00:26:03,290 --> 00:26:08,240
<font color="#CCCCCC">Microsoft's or parish she'll see scripts</font>

520
00:26:05,600 --> 00:26:10,100
<font color="#E5E5E5">and they all said their commands to this</font>

521
00:26:08,240 --> 00:26:12,650
MZ interface this<font color="#E5E5E5"> mg interface</font>

522
00:26:10,100 --> 00:26:14,320
<font color="#E5E5E5">dispatches it to the antivirus engine</font>

523
00:26:12,650 --> 00:26:16,240
the at the variables engine<font color="#CCCCCC"> see</font>

524
00:26:14,320 --> 00:26:17,950
the commands being<font color="#E5E5E5"> executed and</font><font color="#CCCCCC"> gif can</font>

525
00:26:16,240 --> 00:26:22,000
<font color="#CCCCCC">give it</font><font color="#E5E5E5"> results back to</font><font color="#CCCCCC"> MZ saying block</font>

526
00:26:17,950 --> 00:26:23,440
this<font color="#E5E5E5"> file or proceed for um for office</font>

527
00:26:22,000 --> 00:26:25,000
<font color="#CCCCCC">Microsoft made a bit of a different</font>

528
00:26:23,440 --> 00:26:28,450
<font color="#CCCCCC">implementation that they did for the</font>

529
00:26:25,000 --> 00:26:31,870
<font color="#E5E5E5">other languages</font><font color="#CCCCCC"> so what they what they</font>

530
00:26:28,450 --> 00:26:34,450
came<font color="#CCCCCC"> up with was was this picture</font><font color="#E5E5E5"> so</font>

531
00:26:31,870 --> 00:26:37,989
they have this behavior<font color="#E5E5E5"> log which is</font>

532
00:26:34,450 --> 00:26:40,570
<font color="#E5E5E5">stored within office which is not</font><font color="#CCCCCC"> sent</font>

533
00:26:37,990 --> 00:26:43,630
to<font color="#E5E5E5"> MZ and this behavior</font><font color="#CCCCCC"> lock would</font>

534
00:26:40,570 --> 00:26:44,200
contain any comment or win32<font color="#CCCCCC"> API API</font>

535
00:26:43,630 --> 00:26:47,950
call

536
00:26:44,200 --> 00:26:49,960
so starting run<font color="#E5E5E5"> DLL messing with memory</font>

537
00:26:47,950 --> 00:26:53,350
<font color="#E5E5E5">these kind of things are all in this</font>

538
00:26:49,960 --> 00:26:56,139
<font color="#E5E5E5">behavior law and then they have trigger</font>

539
00:26:53,350 --> 00:26:58,570
events saying well these specific win32

540
00:26:56,139 --> 00:27:01,629
<font color="#CCCCCC">api calls or</font><font color="#E5E5E5"> api calls or these specific</font>

541
00:26:58,570 --> 00:27:04,418
<font color="#CCCCCC">events from comm</font><font color="#E5E5E5"> they should be in a</font>

542
00:27:01,629 --> 00:27:10,330
trigger<font color="#E5E5E5"> and only then this rule behavior</font>

543
00:27:04,419 --> 00:27:12,580
<font color="#E5E5E5">log is sent to this mg engine so this</font>

544
00:27:10,330 --> 00:27:14,139
<font color="#E5E5E5">was announced in</font><font color="#CCCCCC"> september</font><font color="#E5E5E5"> which means</font>

545
00:27:12,580 --> 00:27:16,360
it then gets into the<font color="#E5E5E5"> monthly release</font>

546
00:27:14,139 --> 00:27:19,330
and as of<font color="#CCCCCC"> january this is in the</font>

547
00:27:16,360 --> 00:27:22,059
<font color="#E5E5E5">semiannual release which most office 365</font>

548
00:27:19,330 --> 00:27:25,779
users have so if you're targeting a user

549
00:27:22,059 --> 00:27:27,908
which runs office 365<font color="#CCCCCC"> Windows 10 this</font>

550
00:27:25,779 --> 00:27:30,100
feature is in place and<font color="#E5E5E5"> the mga</font>

551
00:27:27,909 --> 00:27:32,710
<font color="#E5E5E5">antivirus engines Windows Defender can</font>

552
00:27:30,100 --> 00:27:36,730
pick it up and<font color="#E5E5E5"> see</font><font color="#CCCCCC"> stuff on the Mac was</font>

553
00:27:32,710 --> 00:27:38,559
being executed<font color="#E5E5E5"> so let's let's first</font>

554
00:27:36,730 --> 00:27:40,840
build a demo<font color="#CCCCCC"> building environment so</font>

555
00:27:38,559 --> 00:27:43,149
<font color="#CCCCCC">that</font><font color="#E5E5E5"> we can kind of troubleshoot this so</font>

556
00:27:40,840 --> 00:27:45,668
our first step was to build our<font color="#CCCCCC"> own</font>

557
00:27:43,149 --> 00:27:47,049
antivirus engine so hooking into a mg<font color="#E5E5E5"> is</font>

558
00:27:45,669 --> 00:27:49,059
being an<font color="#CCCCCC"> anti-virus</font><font color="#E5E5E5"> engine and it was</font>

559
00:27:47,049 --> 00:27:51,908
<font color="#CCCCCC">really</font><font color="#E5E5E5"> troublesome</font><font color="#CCCCCC"> try to make a</font><font color="#E5E5E5"> DLL</font>

560
00:27:49,059 --> 00:27:54,970
didn't work out turns<font color="#E5E5E5"> out it's much</font>

561
00:27:51,909 --> 00:27:58,750
easier you can enable mg<font color="#CCCCCC"> log in with a</font>

562
00:27:54,970 --> 00:28:01,870
<font color="#E5E5E5">couple of parallel lines with it EDW</font>

563
00:27:58,750 --> 00:28:03,309
tracing so that will generate<font color="#E5E5E5"> the</font><font color="#CCCCCC"> MZ</font>

564
00:28:01,870 --> 00:28:06,279
events and we'll just<font color="#E5E5E5"> store them in your</font>

565
00:28:03,309 --> 00:28:09,519
event<font color="#E5E5E5"> log this is a system-wide setting</font>

566
00:28:06,279 --> 00:28:11,830
any<font color="#CCCCCC"> MZ</font><font color="#E5E5E5"> events PowerShell whatever it's</font>

567
00:28:09,519 --> 00:28:14,980
all them in<font color="#E5E5E5"> this MZ operational event</font>

568
00:28:11,830 --> 00:28:16,509
<font color="#E5E5E5">log and then there's the data is</font><font color="#CCCCCC"> just in</font>

569
00:28:14,980 --> 00:28:18,309
<font color="#E5E5E5">this event log and then you have</font><font color="#CCCCCC"> a small</font>

570
00:28:16,509 --> 00:28:23,710
very very<font color="#CCCCCC"> small script to parse this</font><font color="#E5E5E5"> one</font>

571
00:28:18,309 --> 00:28:26,550
out<font color="#E5E5E5"> so this all seemed relatively simple</font>

572
00:28:23,710 --> 00:28:31,680
I took this<font color="#CCCCCC"> couple of</font><font color="#E5E5E5"> lines from from</font>

573
00:28:26,550 --> 00:28:35,370
station and I created<font color="#E5E5E5"> a file I created a</font>

574
00:28:31,680 --> 00:28:39,770
new<font color="#E5E5E5"> file ship</font><font color="#CCCCCC"> tests shall</font><font color="#E5E5E5"> call a</font>

575
00:28:35,370 --> 00:28:43,169
<font color="#CCCCCC">Claddagh</font><font color="#E5E5E5"> action</font><font color="#CCCCCC"> hit f5</font><font color="#E5E5E5"> nothing happens</font><font color="#CCCCCC"> I</font>

576
00:28:39,770 --> 00:28:44,910
looked into<font color="#E5E5E5"> my</font><font color="#CCCCCC"> mg</font><font color="#E5E5E5"> operational law there</font>

577
00:28:43,170 --> 00:28:48,330
<font color="#E5E5E5">are all kind</font><font color="#CCCCCC"> of partial stuff coming by</font>

578
00:28:44,910 --> 00:28:49,770
I looked into<font color="#E5E5E5"> my version versions</font><font color="#CCCCCC"> I it</font>

579
00:28:48,330 --> 00:28:51,060
was<font color="#E5E5E5"> the version which was supposed to be</font>

580
00:28:49,770 --> 00:28:54,990
what<font color="#CCCCCC"> happened</font>

581
00:28:51,060 --> 00:28:58,110
well<font color="#CCCCCC"> MZ doesn't work on VBA code on a</font>

582
00:28:54,990 --> 00:28:59,880
new file so and there are more<font color="#CCCCCC"> of these</font>

583
00:28:58,110 --> 00:29:01,709
kind<font color="#CCCCCC"> of edge cases</font><font color="#E5E5E5"> so anytime you want</font>

584
00:28:59,880 --> 00:29:03,930
<font color="#CCCCCC">to test and</font><font color="#E5E5E5"> play around with MZ make</font>

585
00:29:01,710 --> 00:29:05,970
sure that you save<font color="#CCCCCC"> the file</font><font color="#E5E5E5"> reopen word</font>

586
00:29:03,930 --> 00:29:07,500
<font color="#E5E5E5">because then you were certain that it's</font>

587
00:29:05,970 --> 00:29:09,240
really processing<font color="#E5E5E5"> the file your deity's</font>

588
00:29:07,500 --> 00:29:11,070
<font color="#CCCCCC">you're kind</font><font color="#E5E5E5"> of intending so these</font><font color="#CCCCCC"> look</font>

589
00:29:09,240 --> 00:29:16,800
<font color="#CCCCCC">like</font><font color="#E5E5E5"> small things</font><font color="#CCCCCC"> took a lot of</font><font color="#E5E5E5"> time to</font>

590
00:29:11,070 --> 00:29:23,040
<font color="#CCCCCC">debug</font><font color="#E5E5E5"> for sure what was going on so</font><font color="#CCCCCC"> how</font>

591
00:29:16,800 --> 00:29:25,230
does<font color="#E5E5E5"> it</font><font color="#CCCCCC"> look let me see so this is the</font>

592
00:29:23,040 --> 00:29:27,780
Windows Event log<font color="#E5E5E5"> there are these events</font>

593
00:29:25,230 --> 00:29:30,960
<font color="#E5E5E5">in this MZ operational folder now and</font>

594
00:29:27,780 --> 00:29:35,700
any details you'll see<font color="#CCCCCC"> partial loss for</font>

595
00:29:30,960 --> 00:29:40,230
<font color="#E5E5E5">now and if I go into this demo open this</font>

596
00:29:35,700 --> 00:29:44,300
<font color="#E5E5E5">demo file and I enable content I will</font>

597
00:29:40,230 --> 00:29:44,300
certainly<font color="#E5E5E5"> get</font><font color="#CCCCCC"> colic yes there's my call</font>

598
00:29:45,200 --> 00:29:54,450
then in the<font color="#CCCCCC"> event we can</font><font color="#E5E5E5"> refresh we see</font>

599
00:29:51,270 --> 00:29:57,360
there's this one new office<font color="#E5E5E5"> VBA event</font>

600
00:29:54,450 --> 00:29:59,910
that event<font color="#E5E5E5"> contains the contents of the</font>

601
00:29:57,360 --> 00:30:03,060
file name and<font color="#E5E5E5"> the contents that was</font>

602
00:29:59,910 --> 00:30:04,620
<font color="#E5E5E5">being sent which is just a byte array so</font>

603
00:30:03,060 --> 00:30:11,550
<font color="#CCCCCC">this is kind of what the antivirus</font>

604
00:30:04,620 --> 00:30:16,409
engine gets what the content of that by

605
00:30:11,550 --> 00:30:19,649
the radius is actually in this<font color="#CCCCCC"> case it's</font>

606
00:30:16,410 --> 00:30:22,440
a kernel virtual<font color="#E5E5E5"> a</font><font color="#CCCCCC"> local a virtual</font>

607
00:30:19,650 --> 00:30:24,270
protect call and a<font color="#CCCCCC"> cult call</font><font color="#E5E5E5"> and what's</font>

608
00:30:22,440 --> 00:30:28,490
interesting<font color="#E5E5E5"> here I just made so</font><font color="#CCCCCC"> we'll</font>

609
00:30:24,270 --> 00:30:28,490
also<font color="#E5E5E5"> show you the marker which is</font>

610
00:30:28,790 --> 00:30:31,970
running here

611
00:30:37,049 --> 00:30:43,929
so what my<font color="#CCCCCC"> museum in a bit</font>

612
00:30:41,409 --> 00:30:47,139
so this come on this is<font color="#CCCCCC"> just a bit of</font>

613
00:30:43,929 --> 00:30:49,389
random test code<font color="#E5E5E5"> so I did</font><font color="#CCCCCC"> two I do a</font>

614
00:30:47,139 --> 00:30:51,908
virtual airlock<font color="#E5E5E5"> just allocate memory I</font>

615
00:30:49,389 --> 00:30:54,639
play<font color="#E5E5E5"> around with rwx bytes on that</font>

616
00:30:51,909 --> 00:30:56,889
memory<font color="#CCCCCC"> just</font><font color="#E5E5E5"> for fun and then I run</font><font color="#CCCCCC"> Kok</font>

617
00:30:54,639 --> 00:30:58,299
and what we already<font color="#E5E5E5"> see is that there's</font>

618
00:30:56,889 --> 00:31:00,879
<font color="#E5E5E5">only one event in this event look</font>

619
00:30:58,299 --> 00:31:05,259
generated which means that<font color="#E5E5E5"> an in that</font>

620
00:31:00,879 --> 00:31:10,090
event<font color="#E5E5E5"> the last entry</font><font color="#CCCCCC"> was colic which</font>

621
00:31:05,259 --> 00:31:12,549
<font color="#E5E5E5">means that the other two are like they</font>

622
00:31:10,090 --> 00:31:14,439
were not trigger<font color="#E5E5E5"> events so virtual</font>

623
00:31:12,549 --> 00:31:15,789
airlock<font color="#E5E5E5"> or</font><font color="#CCCCCC"> virtual protect these were</font>

624
00:31:14,440 --> 00:31:17,590
<font color="#E5E5E5">not like the trigger events only the</font>

625
00:31:15,789 --> 00:31:19,629
shell colic<font color="#E5E5E5"> was a trigger event and this</font>

626
00:31:17,590 --> 00:31:21,129
mg<font color="#E5E5E5"> engine and then it provided its full</font>

627
00:31:19,629 --> 00:31:25,230
behavioral<font color="#CCCCCC"> locks of</font><font color="#E5E5E5"> all the events</font>

628
00:31:21,129 --> 00:31:25,230
before<font color="#E5E5E5"> that it provided to the engine so</font>

629
00:31:28,379 --> 00:31:32,980
<font color="#CCCCCC">that</font><font color="#E5E5E5"> was kind of the first step into</font>

630
00:31:31,090 --> 00:31:38,049
troubleshooting and getting this stuff

631
00:31:32,980 --> 00:31:39,399
to<font color="#E5E5E5"> work yeah so this is what I</font><font color="#CCCCCC"> just</font>

632
00:31:38,049 --> 00:31:41,499
<font color="#CCCCCC">showed there's a couple</font><font color="#E5E5E5"> of lines of fire</font>

633
00:31:39,399 --> 00:31:43,840
shell it's<font color="#E5E5E5"> really dirty so if he says</font>

634
00:31:41,499 --> 00:31:45,309
cleaning up codes don't I'll publish it

635
00:31:43,840 --> 00:31:47,649
but<font color="#E5E5E5"> it will be really dirty so</font><font color="#CCCCCC"> a big</font>

636
00:31:45,309 --> 00:31:49,950
warning<font color="#E5E5E5"> there but at least</font><font color="#CCCCCC"> it yeah it</font>

637
00:31:47,649 --> 00:31:54,699
can help you in<font color="#CCCCCC"> the</font><font color="#E5E5E5"> end</font><font color="#CCCCCC"> troubleshooting</font>

638
00:31:49,950 --> 00:31:57,850
so the first bypass approach is trust<font color="#E5E5E5"> me</font>

639
00:31:54,700 --> 00:32:00,639
and if<font color="#CCCCCC"> you looked into</font><font color="#E5E5E5"> that picture of</font>

640
00:31:57,850 --> 00:32:02,439
how<font color="#CCCCCC"> MC worked</font><font color="#E5E5E5"> well there was no</font>

641
00:32:00,639 --> 00:32:04,178
mentioning of trust but what is pressed

642
00:32:02,440 --> 00:32:10,960
actually in the in the office context

643
00:32:04,179 --> 00:32:13,480
well MZ and Trust have a relation so the

644
00:32:10,960 --> 00:32:17,679
mg engine can<font color="#E5E5E5"> be configured which files</font>

645
00:32:13,480 --> 00:32:21,190
<font color="#E5E5E5">is should process so you</font><font color="#CCCCCC"> can say well</font><font color="#E5E5E5"> I</font>

646
00:32:17,679 --> 00:32:23,619
want<font color="#E5E5E5"> all files always to be executed or</font>

647
00:32:21,190 --> 00:32:25,809
you can have the<font color="#E5E5E5"> default value which as</font>

648
00:32:23,619 --> 00:32:27,639
well we wanted<font color="#E5E5E5"> to have all the files</font>

649
00:32:25,809 --> 00:32:30,009
<font color="#E5E5E5">except the files that are on a trusted</font>

650
00:32:27,639 --> 00:32:32,529
location for<font color="#CCCCCC"> us that have a that are</font>

651
00:32:30,009 --> 00:32:34,239
<font color="#E5E5E5">twisted documents files that are</font>

652
00:32:32,529 --> 00:32:36,159
digitally<font color="#CCCCCC"> signed so let's skip them</font><font color="#E5E5E5"> and</font>

653
00:32:34,239 --> 00:32:37,119
this<font color="#E5E5E5"> is the default</font><font color="#CCCCCC"> Microsoft saying</font>

654
00:32:36,159 --> 00:32:39,850
well this<font color="#CCCCCC"> is</font><font color="#E5E5E5"> for performance reasons</font>

655
00:32:37,119 --> 00:32:41,439
<font color="#CCCCCC">we're I think why we are the performance</font>

656
00:32:39,850 --> 00:32:43,899
<font color="#CCCCCC">reasons a legit marker will probably</font>

657
00:32:41,440 --> 00:32:44,690
never do like shell calls so how<font color="#E5E5E5"> often</font>

658
00:32:43,899 --> 00:32:47,508
will have<font color="#E5E5E5"> happened</font>

659
00:32:44,690 --> 00:32:49,249
this is<font color="#CCCCCC"> Microsoft's design decision so</font>

660
00:32:47,509 --> 00:32:50,989
there<font color="#E5E5E5"> are three</font><font color="#CCCCCC"> values for this macro</font>

661
00:32:49,249 --> 00:32:53,659
<font color="#E5E5E5">runtime setting which</font><font color="#CCCCCC"> is just a registry</font>

662
00:32:50,989 --> 00:32:56,749
setting<font color="#E5E5E5"> in</font><font color="#CCCCCC"> H</font><font color="#E5E5E5"> keys in a current user</font>

663
00:32:53,659 --> 00:32:59,029
registry<font color="#CCCCCC"> if you don't set it it will be</font>

664
00:32:56,749 --> 00:33:01,369
on this<font color="#CCCCCC"> middle value and it will</font><font color="#E5E5E5"> just</font>

665
00:32:59,029 --> 00:33:06,710
ignore certain<font color="#CCCCCC"> clauses or false</font>

666
00:33:01,369 --> 00:33:10,789
well what<font color="#E5E5E5"> can go wrong there so how does</font>

667
00:33:06,710 --> 00:33:13,070
office work with trust so<font color="#E5E5E5"> we have this</font>

668
00:33:10,789 --> 00:33:15,769
macro setting this main macro setting

669
00:33:13,070 --> 00:33:17,389
<font color="#E5E5E5">disable all macros disable macros with</font>

670
00:33:15,769 --> 00:33:20,090
<font color="#E5E5E5">warning meaning the usage acidity to</font>

671
00:33:17,389 --> 00:33:23,359
<font color="#E5E5E5">click allow</font><font color="#CCCCCC"> all and we have trusted</font>

672
00:33:20,090 --> 00:33:26,330
documents<font color="#E5E5E5"> this is used to determine</font>

673
00:33:23,359 --> 00:33:29,359
<font color="#E5E5E5">whether a file you already approved a</font>

674
00:33:26,330 --> 00:33:31,789
file so if you open<font color="#CCCCCC"> a macro enabled</font>

675
00:33:29,359 --> 00:33:33,978
<font color="#CCCCCC">augment once it will set something in</font>

676
00:33:31,789 --> 00:33:35,179
<font color="#CCCCCC">the registry</font><font color="#E5E5E5"> and that way it will know</font>

677
00:33:33,979 --> 00:33:36,529
the next<font color="#E5E5E5"> time you open the file</font><font color="#CCCCCC"> that you</font>

678
00:33:35,179 --> 00:33:39,470
don't have<font color="#E5E5E5"> to click the nagging yellow</font>

679
00:33:36,529 --> 00:33:41,059
bar again then there<font color="#E5E5E5"> are at risk of</font>

680
00:33:39,470 --> 00:33:43,220
occasions they are folders where you

681
00:33:41,059 --> 00:33:46,249
typically store like templates or your

682
00:33:43,220 --> 00:33:50,269
normal<font color="#E5E5E5"> adults</font><font color="#CCCCCC"> where where they are</font>

683
00:33:46,249 --> 00:33:52,399
automatically approved and it should be

684
00:33:50,269 --> 00:33:54,259
noted that even<font color="#CCCCCC"> with this macro security</font>

685
00:33:52,399 --> 00:33:57,258
<font color="#E5E5E5">how</font><font color="#CCCCCC"> I</font><font color="#E5E5E5"> setting disable all markers</font>

686
00:33:54,259 --> 00:33:59,809
without<font color="#CCCCCC"> notification it does not</font><font color="#E5E5E5"> disable</font>

687
00:33:57,259 --> 00:34:01,519
all markers<font color="#CCCCCC"> trust darks</font><font color="#E5E5E5"> trusted Docs and</font>

688
00:33:59,809 --> 00:34:04,129
trusted locations can override that<font color="#CCCCCC"> so</font>

689
00:34:01,519 --> 00:34:06,440
there is some fakeness in what you think

690
00:34:04,129 --> 00:34:08,029
<font color="#CCCCCC">me mean</font><font color="#E5E5E5"> these I will honor</font><font color="#CCCCCC"> the old</font>

691
00:34:06,440 --> 00:34:14,750
<font color="#E5E5E5">markers because it's not meaning all</font>

692
00:34:08,029 --> 00:34:19,609
markers so first thing we can do<font color="#E5E5E5"> if we</font>

693
00:34:14,750 --> 00:34:28,869
<font color="#E5E5E5">can find a trusted location we can just</font>

694
00:34:19,609 --> 00:34:28,869
have a very<font color="#E5E5E5"> simple</font><font color="#CCCCCC"> macro which drops</font>

695
00:34:30,250 --> 00:34:37,510
so this one drops itself<font color="#CCCCCC"> in a trusted</font>

696
00:34:34,000 --> 00:34:39,730
location<font color="#CCCCCC"> and it does that</font><font color="#E5E5E5"> by just doing</font>

697
00:34:37,510 --> 00:34:42,099
safe ass which is not a<font color="#E5E5E5"> core</font><font color="#CCCCCC"> method</font>

698
00:34:39,730 --> 00:34:44,560
which is not<font color="#E5E5E5"> a win32 method it's just to</font>

699
00:34:42,099 --> 00:34:47,200
<font color="#E5E5E5">be default with</font><font color="#CCCCCC"> the word feature</font><font color="#E5E5E5"> save</font>

700
00:34:44,560 --> 00:34:50,679
<font color="#CCCCCC">ass saving into a</font><font color="#E5E5E5"> trusted location and</font>

701
00:34:47,199 --> 00:34:52,239
then opening itself<font color="#E5E5E5"> and by doing that it</font>

702
00:34:50,679 --> 00:34:54,399
suddenly<font color="#E5E5E5"> loads a macro from</font><font color="#CCCCCC"> a trusted</font>

703
00:34:52,239 --> 00:34:58,080
location and certainly<font color="#CCCCCC"> MZ completely</font>

704
00:34:54,399 --> 00:35:01,720
it's completely<font color="#CCCCCC"> behind so this is just</font>

705
00:34:58,080 --> 00:35:03,490
some simple proof of concept so the

706
00:35:01,720 --> 00:35:05,169
first the<font color="#CCCCCC"> first line says well</font><font color="#E5E5E5"> this is</font>

707
00:35:03,490 --> 00:35:06,580
the<font color="#CCCCCC"> outer open event this is an event</font>

708
00:35:05,170 --> 00:35:11,380
<font color="#E5E5E5">which always fires if you open a</font>

709
00:35:06,580 --> 00:35:14,348
document<font color="#CCCCCC"> I'd like to</font><font color="#E5E5E5"> open a doc doc X</font>

710
00:35:11,380 --> 00:35:16,780
file or<font color="#E5E5E5"> doc M file and</font><font color="#CCCCCC"> it says well just</font>

711
00:35:14,349 --> 00:35:18,700
now<font color="#CCCCCC"> save myself</font><font color="#E5E5E5"> into this</font><font color="#CCCCCC"> AB data</font>

712
00:35:16,780 --> 00:35:22,510
roaming<font color="#E5E5E5"> templates directory which</font><font color="#CCCCCC"> is the</font>

713
00:35:18,700 --> 00:35:24,009
default trusted location<font color="#CCCCCC"> and then save</font>

714
00:35:22,510 --> 00:35:27,670
myself back into<font color="#E5E5E5"> the</font><font color="#CCCCCC"> original location</font>

715
00:35:24,010 --> 00:35:29,890
<font color="#CCCCCC">and then the last line says</font><font color="#E5E5E5"> well add</font>

716
00:35:27,670 --> 00:35:31,900
create a new file and have it be

717
00:35:29,890 --> 00:35:36,368
inspired on this template which<font color="#CCCCCC"> is in</font>

718
00:35:31,900 --> 00:35:39,369
<font color="#CCCCCC">this trusted location and upon</font><font color="#E5E5E5"> creating</font>

719
00:35:36,369 --> 00:35:41,290
a new file basically with the template

720
00:35:39,369 --> 00:35:43,570
<font color="#E5E5E5">and other events is called which is</font>

721
00:35:41,290 --> 00:35:45,580
called the<font color="#CCCCCC"> outer new event so it's a new</font>

722
00:35:43,570 --> 00:35:47,980
file based on this template and that's

723
00:35:45,580 --> 00:35:51,880
<font color="#CCCCCC">where we drop our malicious code so this</font>

724
00:35:47,980 --> 00:35:53,560
was a<font color="#E5E5E5"> very simple way to bypass</font><font color="#CCCCCC"> my best</font>

725
00:35:51,880 --> 00:35:55,599
<font color="#CCCCCC">MC by just having misconfigurations</font>

726
00:35:53,560 --> 00:35:58,990
interested locations you can<font color="#E5E5E5"> already</font>

727
00:35:55,599 --> 00:36:04,180
<font color="#E5E5E5">abuse it and MZ certainly is blind I'll</font>

728
00:35:58,990 --> 00:36:08,080
share it<font color="#E5E5E5"> I just popped a second so</font>

729
00:36:04,180 --> 00:36:12,910
<font color="#E5E5E5">I'm and I only</font><font color="#CCCCCC"> still have this</font><font color="#E5E5E5"> one event</font>

730
00:36:08,080 --> 00:36:14,920
<font color="#E5E5E5">from this from this first demo I</font><font color="#CCCCCC"> did but</font>

731
00:36:12,910 --> 00:36:16,779
<font color="#E5E5E5">I</font><font color="#CCCCCC"> don't have</font><font color="#E5E5E5"> any MZ events for the</font>

732
00:36:14,920 --> 00:36:19,420
second<font color="#E5E5E5"> called popping I'll now clean my</font>

733
00:36:16,780 --> 00:36:24,310
event<font color="#CCCCCC"> loss so the next demos will all be</font>

734
00:36:19,420 --> 00:36:26,589
<font color="#CCCCCC">clean</font><font color="#E5E5E5"> so this was simple stuff but</font><font color="#CCCCCC"> there</font>

735
00:36:24,310 --> 00:36:28,420
are some cons<font color="#E5E5E5"> so do we have</font><font color="#CCCCCC"> a writable</font>

736
00:36:26,589 --> 00:36:30,369
location where we can where<font color="#E5E5E5"> we can write</font>

737
00:36:28,420 --> 00:36:35,710
can we do this<font color="#E5E5E5"> maybe even</font><font color="#CCCCCC"> with trusted</font>

738
00:36:30,369 --> 00:36:37,000
documents and this again is well I was

739
00:36:35,710 --> 00:36:38,290
<font color="#E5E5E5">already</font><font color="#CCCCCC"> looking into trusts records</font>

740
00:36:37,000 --> 00:36:40,530
actually<font color="#E5E5E5"> because</font><font color="#CCCCCC"> I'm</font><font color="#E5E5E5"> was looking at it</font>

741
00:36:38,290 --> 00:36:43,500
from<font color="#E5E5E5"> a more defensive perspective but</font>

742
00:36:40,530 --> 00:36:45,750
this is kind of how Microsoft stores

743
00:36:43,500 --> 00:36:47,550
trust in a<font color="#E5E5E5"> trusted documents this</font>

744
00:36:45,750 --> 00:36:52,260
<font color="#E5E5E5">dressed record is the registry registry</font>

745
00:36:47,550 --> 00:36:54,960
key and it has the<font color="#E5E5E5"> file name and it has</font>

746
00:36:52,260 --> 00:36:58,890
some<font color="#CCCCCC"> store</font><font color="#E5E5E5"> some attributes in addy words</font>

747
00:36:54,960 --> 00:37:00,660
to create<font color="#E5E5E5"> timestamp</font><font color="#CCCCCC"> just three random</font>

748
00:36:58,890 --> 00:37:03,810
values<font color="#E5E5E5"> I</font><font color="#CCCCCC"> don't</font><font color="#E5E5E5"> know what they are but</font>

749
00:37:00,660 --> 00:37:10,799
they're not<font color="#CCCCCC"> a hash</font><font color="#E5E5E5"> and then this</font><font color="#CCCCCC"> ff7</font><font color="#E5E5E5"> F</font>

750
00:37:03,810 --> 00:37:13,080
which<font color="#CCCCCC"> means it's approved so how does it</font>

751
00:37:10,800 --> 00:37:15,180
<font color="#E5E5E5">affect MZ whatever I do in my lab</font>

752
00:37:13,080 --> 00:37:17,310
machine<font color="#CCCCCC"> terrestrial documents are still</font>

753
00:37:15,180 --> 00:37:19,470
passing<font color="#E5E5E5"> to</font><font color="#CCCCCC"> Ramsey I really don't know</font>

754
00:37:17,310 --> 00:37:22,080
what's going<font color="#CCCCCC"> on</font><font color="#E5E5E5"> either Microsoft messed</font>

755
00:37:19,470 --> 00:37:24,359
up their documentation<font color="#E5E5E5"> or really it's an</font>

756
00:37:22,080 --> 00:37:26,790
idiot error in my hands<font color="#E5E5E5"> but whatever I</font>

757
00:37:24,359 --> 00:37:29,190
do<font color="#E5E5E5"> dress the documents still go to</font>

758
00:37:26,790 --> 00:37:31,320
<font color="#CCCCCC">Ramsey's so I really have no idea what</font>

759
00:37:29,190 --> 00:37:32,970
happens here<font color="#CCCCCC"> that doesn't mean that the</font>

760
00:37:31,320 --> 00:37:34,680
documents are<font color="#E5E5E5"> not interesting so I'll</font>

761
00:37:32,970 --> 00:37:40,319
just make<font color="#CCCCCC"> a small sidestep to stuff I</font>

762
00:37:34,680 --> 00:37:44,190
did there so this these these D words

763
00:37:40,320 --> 00:37:47,220
contain three<font color="#E5E5E5"> three at three kind of</font>

764
00:37:44,190 --> 00:37:50,160
fields this creates that<font color="#E5E5E5"> there's random</font>

765
00:37:47,220 --> 00:37:52,290
stuff and this approval<font color="#E5E5E5"> on the end well</font>

766
00:37:50,160 --> 00:37:53,640
it works with if we just add<font color="#E5E5E5"> zeros in</font>

767
00:37:52,290 --> 00:37:56,849
the middle part so we can just skip<font color="#E5E5E5"> that</font>

768
00:37:53,640 --> 00:37:59,069
one<font color="#E5E5E5"> so we now know that there is no like</font>

769
00:37:56,849 --> 00:38:00,869
integrity<font color="#CCCCCC"> checking on trusted</font><font color="#E5E5E5"> documents</font>

770
00:37:59,070 --> 00:38:03,180
so if someone at one point in time<font color="#E5E5E5"> I</font>

771
00:38:00,869 --> 00:38:06,450
<font color="#E5E5E5">prove that</font><font color="#CCCCCC"> a file</font><font color="#E5E5E5"> if we can write</font>

772
00:38:03,180 --> 00:38:08,629
something<font color="#E5E5E5"> on disk with the same location</font>

773
00:38:06,450 --> 00:38:10,589
and the same create time then

774
00:38:08,630 --> 00:38:13,410
<font color="#E5E5E5">interesting opportunities exist because</font>

775
00:38:10,589 --> 00:38:18,930
the user once approved a certain<font color="#E5E5E5"> macro</font>

776
00:38:13,410 --> 00:38:20,759
and we can just<font color="#E5E5E5"> add different code you</font>

777
00:38:18,930 --> 00:38:23,580
can even do this<font color="#E5E5E5"> on the network if you</font>

778
00:38:20,760 --> 00:38:26,339
<font color="#E5E5E5">can do this</font><font color="#CCCCCC"> one if</font><font color="#E5E5E5"> people in a company</font>

779
00:38:23,580 --> 00:38:29,009
are doing having legit<font color="#CCCCCC"> doc m-files or</font>

780
00:38:26,339 --> 00:38:31,140
legit markers on<font color="#CCCCCC"> a network we</font><font color="#E5E5E5"> can try to</font>

781
00:38:29,010 --> 00:38:32,849
<font color="#CCCCCC">use this</font><font color="#E5E5E5"> create</font><font color="#CCCCCC"> timestamp and</font><font color="#E5E5E5"> abuse it</font>

782
00:38:31,140 --> 00:38:34,490
<font color="#E5E5E5">with just timestamp and that's</font>

783
00:38:32,849 --> 00:38:38,460
sufficient

784
00:38:34,490 --> 00:38:40,799
so more interesting is that if we can

785
00:38:38,460 --> 00:38:43,890
predict this timestamp<font color="#E5E5E5"> we may have a way</font>

786
00:38:40,800 --> 00:38:45,420
<font color="#E5E5E5">to bypass even future security controls</font>

787
00:38:43,890 --> 00:38:47,520
<font color="#CCCCCC">the company may implement so we may have</font>

788
00:38:45,420 --> 00:38:49,320
long-term persistence because<font color="#CCCCCC"> Trista</font>

789
00:38:47,520 --> 00:38:50,220
directress records<font color="#CCCCCC"> overrule</font><font color="#E5E5E5"> this micro</font>

790
00:38:49,320 --> 00:38:53,310
security high

791
00:38:50,220 --> 00:38:55,750
so can we predict<font color="#CCCCCC"> this time stamp</font>

792
00:38:53,310 --> 00:38:57,549
well that's very<font color="#E5E5E5"> hot</font>

793
00:38:55,750 --> 00:39:01,360
but there are some nice tricks around

794
00:38:57,550 --> 00:39:03,130
<font color="#E5E5E5">that so it is very hard to predict this</font>

795
00:39:01,360 --> 00:39:05,590
exact<font color="#E5E5E5"> time stamp but these word</font>

796
00:39:03,130 --> 00:39:08,350
templates are very very slow<font color="#E5E5E5"> and as Stan</font>

797
00:39:05,590 --> 00:39:11,650
explains<font color="#E5E5E5"> you can set them to internet</font>

798
00:39:08,350 --> 00:39:14,020
locations so if we have a<font color="#E5E5E5"> doc file with</font>

799
00:39:11,650 --> 00:39:18,550
a template reference which is<font color="#E5E5E5"> just an</font>

800
00:39:14,020 --> 00:39:21,790
HTTP or HTTPS URL we can see what word

801
00:39:18,550 --> 00:39:24,010
does with<font color="#E5E5E5"> the Tres records and then we</font>

802
00:39:21,790 --> 00:39:25,259
see well what's the<font color="#CCCCCC"> creator</font><font color="#E5E5E5"> of a file</font>

803
00:39:24,010 --> 00:39:28,510
which lives on<font color="#E5E5E5"> the Internet</font>

804
00:39:25,260 --> 00:39:34,360
<font color="#E5E5E5">Marcus doesn't know it</font><font color="#CCCCCC"> will just give it</font>

805
00:39:28,510 --> 00:39:37,900
a CE time of<font color="#CCCCCC"> zero so if I for example on</font>

806
00:39:34,360 --> 00:39:40,870
<font color="#E5E5E5">my machine would once be able to set</font>

807
00:39:37,900 --> 00:39:42,610
this registry setting so this is where

808
00:39:40,870 --> 00:39:46,410
my malicious file would<font color="#CCCCCC"> be just a random</font>

809
00:39:42,610 --> 00:39:49,120
URL wherever later post my payload<font color="#E5E5E5"> and</font>

810
00:39:46,410 --> 00:39:51,460
just this random this<font color="#E5E5E5"> value with only</font>

811
00:39:49,120 --> 00:39:53,589
zeros and a couple of F is a couple of

812
00:39:51,460 --> 00:39:54,880
<font color="#CCCCCC">F's on the ends then the</font><font color="#E5E5E5"> only thing I</font>

813
00:39:53,590 --> 00:39:56,680
<font color="#E5E5E5">need to do if I</font><font color="#CCCCCC"> ever want to go back</font>

814
00:39:54,880 --> 00:39:59,460
into that<font color="#E5E5E5"> this company I want to get</font>

815
00:39:56,680 --> 00:40:03,850
back wanna get network access back<font color="#E5E5E5"> I</font>

816
00:39:59,460 --> 00:40:07,210
just<font color="#CCCCCC"> sent a docx file to an R user</font><font color="#E5E5E5"> and</font>

817
00:40:03,850 --> 00:40:09,610
without any<font color="#CCCCCC"> macro</font><font color="#E5E5E5"> warnings</font><font color="#CCCCCC"> we</font><font color="#E5E5E5"> already</font>

818
00:40:07,210 --> 00:40:11,200
have code execution<font color="#E5E5E5"> so this is not an</font><font color="#CCCCCC"> MZ</font>

819
00:40:09,610 --> 00:40:14,290
bypass because<font color="#CCCCCC"> twisted records don't</font>

820
00:40:11,200 --> 00:40:17,560
work with MZ in my<font color="#CCCCCC"> setup but this is</font>

821
00:40:14,290 --> 00:40:19,720
<font color="#CCCCCC">long term</font><font color="#E5E5E5"> persistence by just</font><font color="#CCCCCC"> using this</font>

822
00:40:17,560 --> 00:40:21,700
small registry<font color="#CCCCCC"> hive which is normally</font>

823
00:40:19,720 --> 00:40:28,750
<font color="#CCCCCC">used for maintaining which files are</font>

824
00:40:21,700 --> 00:40:34,210
<font color="#E5E5E5">already approved so back to mg because</font>

825
00:40:28,750 --> 00:40:36,880
<font color="#E5E5E5">this was</font><font color="#CCCCCC"> just a small</font><font color="#E5E5E5"> sidestep so in the</font>

826
00:40:34,210 --> 00:40:39,190
<font color="#E5E5E5">original</font><font color="#CCCCCC"> picture of how</font><font color="#E5E5E5"> MZ works we have</font>

827
00:40:36,880 --> 00:40:40,810
<font color="#E5E5E5">these two different</font><font color="#CCCCCC"> things we have the</font>

828
00:40:39,190 --> 00:40:42,640
<font color="#E5E5E5">behavioral log which is filled with all</font>

829
00:40:40,810 --> 00:40:45,130
<font color="#E5E5E5">the</font><font color="#CCCCCC"> comm events and we have trigger</font>

830
00:40:42,640 --> 00:40:47,200
events<font color="#E5E5E5"> so there's a question whether</font>

831
00:40:45,130 --> 00:40:50,290
<font color="#E5E5E5">there are</font><font color="#CCCCCC"> travel execution opportunities</font>

832
00:40:47,200 --> 00:40:54,120
which<font color="#E5E5E5"> are in this behavior law but are</font>

833
00:40:50,290 --> 00:40:56,529
<font color="#E5E5E5">not never triggering the real MZ event</font>

834
00:40:54,120 --> 00:40:58,089
<font color="#E5E5E5">so they're not calling</font><font color="#CCCCCC"> the MZ engines</font>

835
00:40:56,530 --> 00:40:59,830
they may be in the<font color="#E5E5E5"> lower flow of the</font>

836
00:40:58,090 --> 00:41:01,330
word macro<font color="#E5E5E5"> but if it's not sent to MZ</font>

837
00:40:59,830 --> 00:41:04,330
the antivirus<font color="#CCCCCC"> Manion has no chance to</font>

838
00:41:01,330 --> 00:41:06,700
<font color="#E5E5E5">detect and well I can invent it myself</font>

839
00:41:04,330 --> 00:41:08,740
<font color="#E5E5E5">but I</font><font color="#CCCCCC"> just</font><font color="#E5E5E5"> started looking</font><font color="#CCCCCC"> around what's</font>

840
00:41:06,700 --> 00:41:09,450
available there<font color="#E5E5E5"> and then I knew of a</font>

841
00:41:08,740 --> 00:41:11,520
couple of<font color="#E5E5E5"> noise</font>

842
00:41:09,450 --> 00:41:17,339
attack surface reduction bypasses by

843
00:41:11,520 --> 00:41:23,569
dark operator and well what<font color="#CCCCCC"> they for</font>

844
00:41:17,339 --> 00:41:26,250
<font color="#CCCCCC">example do is this is starting with WMI</font>

845
00:41:23,569 --> 00:41:28,440
doing a<font color="#CCCCCC"> start starting a process with</font>

846
00:41:26,250 --> 00:41:31,140
<font color="#CCCCCC">WMI and in the end</font><font color="#E5E5E5"> the bet is being</font>

847
00:41:28,440 --> 00:41:33,480
called is called<font color="#E5E5E5"> spawn instance and this</font>

848
00:41:31,140 --> 00:41:36,319
spawn instance<font color="#CCCCCC"> events</font><font color="#E5E5E5"> it just doesn't</font>

849
00:41:33,480 --> 00:41:36,319
show up in the<font color="#CCCCCC"> m0</font>

850
00:41:43,830 --> 00:41:51,150
so here again we<font color="#CCCCCC"> have</font><font color="#E5E5E5"> our</font><font color="#CCCCCC"> colic and we</font>

851
00:41:50,550 --> 00:41:52,830
have again

852
00:41:51,150 --> 00:41:58,170
this is<font color="#E5E5E5"> to read empty we have an empty</font>

853
00:41:52,830 --> 00:42:00,180
<font color="#E5E5E5">m0 so this is again a bypass by using</font>

854
00:41:58,170 --> 00:42:02,250
methods which Microsoft<font color="#E5E5E5"> didn't implement</font>

855
00:42:00,180 --> 00:42:05,190
a trigger<font color="#CCCCCC"> event so if we would extend</font>

856
00:42:02,250 --> 00:42:06,900
<font color="#E5E5E5">this marker by doing a shell command</font>

857
00:42:05,190 --> 00:42:08,700
<font color="#E5E5E5">afterwards we would see</font><font color="#CCCCCC"> that this is</font>

858
00:42:06,900 --> 00:42:12,360
<font color="#CCCCCC">still in behavior but it's just not</font>

859
00:42:08,700 --> 00:42:13,830
triggering<font color="#CCCCCC"> ng</font><font color="#E5E5E5"> so far I've seen the</font>

860
00:42:12,360 --> 00:42:16,260
trigger events<font color="#E5E5E5"> mainly on things like</font>

861
00:42:13,830 --> 00:42:17,970
<font color="#E5E5E5">shell</font><font color="#CCCCCC"> shall execute execute all methods</font>

862
00:42:16,260 --> 00:42:21,480
with these kind of words in it and a lot

863
00:42:17,970 --> 00:42:23,129
of<font color="#E5E5E5"> other stuff is being missed the same</font>

864
00:42:21,480 --> 00:42:25,260
<font color="#E5E5E5">holds</font><font color="#CCCCCC"> for if you start saying well I</font>

865
00:42:23,130 --> 00:42:27,960
want let's<font color="#E5E5E5"> in word let's raise an</font>

866
00:42:25,260 --> 00:42:30,930
instance of Excel<font color="#E5E5E5"> and in Excel do</font><font color="#CCCCCC"> adde</font>

867
00:42:27,960 --> 00:42:34,200
<font color="#E5E5E5">execute the initialize it's also blind</font>

868
00:42:30,930 --> 00:42:36,419
<font color="#E5E5E5">so that's another method where</font><font color="#CCCCCC"> MZ will</font>

869
00:42:34,200 --> 00:42:38,759
just be bypassed by<font color="#CCCCCC"> comm functions which</font>

870
00:42:36,420 --> 00:42:40,440
<font color="#E5E5E5">Microsoft</font><font color="#CCCCCC"> has deemed we will law but we</font>

871
00:42:38,760 --> 00:42:44,940
consider<font color="#E5E5E5"> them innocent or non trigger</font>

872
00:42:40,440 --> 00:42:46,950
<font color="#E5E5E5">able events so this is like the second</font>

873
00:42:44,940 --> 00:42:48,390
approach of<font color="#E5E5E5"> bypassing this</font><font color="#CCCCCC"> MZ</font>

874
00:42:46,950 --> 00:42:51,359
implementation we just need to find a

875
00:42:48,390 --> 00:42:53,790
lot<font color="#E5E5E5"> of methods where there which are not</font>

876
00:42:51,360 --> 00:42:59,460
<font color="#CCCCCC">know triggers and</font><font color="#E5E5E5"> then there's the third</font>

877
00:42:53,790 --> 00:43:02,370
<font color="#E5E5E5">one well it looks calm it looks win32</font>

878
00:42:59,460 --> 00:43:06,390
<font color="#CCCCCC">api calls</font><font color="#E5E5E5"> but there are ways to</font><font color="#CCCCCC"> execute</font>

879
00:43:02,370 --> 00:43:08,819
code<font color="#E5E5E5"> without any of those and</font><font color="#CCCCCC"> they're</font>

880
00:43:06,390 --> 00:43:10,710
<font color="#E5E5E5">mainly like built-in features of word</font>

881
00:43:08,820 --> 00:43:14,090
order<font color="#CCCCCC"> they're like more like trick so</font>

882
00:43:10,710 --> 00:43:18,270
one of them is<font color="#E5E5E5"> Excel for</font><font color="#CCCCCC"> macros so</font>

883
00:43:14,090 --> 00:43:20,130
<font color="#CCCCCC">there's</font><font color="#E5E5E5"> this legacy Excel format excel</font>

884
00:43:18,270 --> 00:43:22,620
for macro format which<font color="#CCCCCC"> is nothing</font><font color="#E5E5E5"> to do</font>

885
00:43:20,130 --> 00:43:25,080
with VBA<font color="#E5E5E5"> yesterday I learned it was</font>

886
00:43:22,620 --> 00:43:29,220
<font color="#E5E5E5">implemented in Excel both axes so it's</font>

887
00:43:25,080 --> 00:43:30,390
really within<font color="#CCCCCC"> Excel</font><font color="#E5E5E5"> and you can have you</font>

888
00:43:29,220 --> 00:43:32,310
need to<font color="#E5E5E5"> learn a little</font><font color="#CCCCCC"> bit a little bit</font>

889
00:43:30,390 --> 00:43:34,109
<font color="#E5E5E5">of different language but</font><font color="#CCCCCC"> within VBA you</font>

890
00:43:32,310 --> 00:43:37,080
can call social<font color="#E5E5E5"> method and this method</font>

891
00:43:34,110 --> 00:43:39,240
is not a<font color="#CCCCCC"> comb method not</font><font color="#E5E5E5"> a win32 API</font>

892
00:43:37,080 --> 00:43:43,980
method so this is just not<font color="#CCCCCC"> within</font><font color="#E5E5E5"> this</font>

893
00:43:39,240 --> 00:43:45,569
<font color="#CCCCCC">MZ behavior log so execute</font><font color="#E5E5E5"> Excel for</font>

894
00:43:43,980 --> 00:43:49,080
marker and<font color="#E5E5E5"> then within that marker</font>

895
00:43:45,570 --> 00:43:53,349
<font color="#E5E5E5">exactly</font><font color="#CCCCCC"> Kollek it will work it will</font><font color="#E5E5E5"> just</font>

896
00:43:49,080 --> 00:44:01,869
<font color="#E5E5E5">show you</font><font color="#CCCCCC"> again nothing</font>

897
00:43:53,349 --> 00:44:04,150
and<font color="#CCCCCC"> we're is eat so there's again colic</font>

898
00:44:01,869 --> 00:44:08,650
more than sufficient<font color="#CCCCCC"> calyx</font><font color="#E5E5E5"> in my in my</font>

899
00:44:04,150 --> 00:44:10,479
lifetime I was I would say other tricks

900
00:44:08,650 --> 00:44:12,069
<font color="#E5E5E5">and now we're moving into</font><font color="#CCCCCC"> more like</font><font color="#E5E5E5"> more</font>

901
00:44:10,479 --> 00:44:15,578
dirty<font color="#CCCCCC"> tricks</font><font color="#E5E5E5"> and</font><font color="#CCCCCC"> this is actually the</font>

902
00:44:12,069 --> 00:44:17,529
most lame<font color="#CCCCCC"> MGAs or bypass I have ever</font>

903
00:44:15,579 --> 00:44:24,549
developed<font color="#E5E5E5"> and I'm really proud</font><font color="#CCCCCC"> of the</font>

904
00:44:17,529 --> 00:44:25,539
lameness of<font color="#E5E5E5"> this I hope it works it's</font>

905
00:44:24,549 --> 00:44:26,769
always a bit

906
00:44:25,539 --> 00:44:35,170
this is<font color="#CCCCCC"> likely</font><font color="#E5E5E5"> really challenging the</font>

907
00:44:26,769 --> 00:44:38,529
<font color="#E5E5E5">demo gods so with</font><font color="#CCCCCC"> sent keys you can send</font>

908
00:44:35,170 --> 00:44:40,779
keys<font color="#E5E5E5"> you can't send a Windows button</font><font color="#CCCCCC"> but</font>

909
00:44:38,529 --> 00:44:42,039
there is<font color="#E5E5E5"> another button which is your</font>

910
00:44:40,779 --> 00:44:44,650
<font color="#E5E5E5">shortcut for the windows button which is</font>

911
00:44:42,039 --> 00:44:46,119
<font color="#E5E5E5">like escape space or something if you</font><font color="#CCCCCC"> do</font>

912
00:44:44,650 --> 00:44:48,400
that it<font color="#E5E5E5"> just starts off the foot Start</font>

913
00:44:46,119 --> 00:44:50,079
menu and it starts<font color="#E5E5E5"> calc you can do this</font>

914
00:44:48,400 --> 00:44:52,420
to start<font color="#E5E5E5"> PowerShell with a full I know</font>

915
00:44:50,079 --> 00:44:54,039
as well theres some timing<font color="#E5E5E5"> there</font>

916
00:44:52,420 --> 00:44:56,049
something sometimes it goes wrong

917
00:44:54,039 --> 00:44:58,059
something goes right it's really in your

918
00:44:56,049 --> 00:44:59,650
<font color="#CCCCCC">face it's</font><font color="#E5E5E5"> very dirty but if you want to</font>

919
00:44:58,059 --> 00:45:01,959
do this<font color="#CCCCCC"> acid</font><font color="#E5E5E5"> attack how you may distract</font>

920
00:44:59,650 --> 00:45:03,459
stuff and<font color="#E5E5E5"> shows</font><font color="#CCCCCC"> Queens and blue screen</font>

921
00:45:01,959 --> 00:45:07,899
on the backgrounds with pictures or

922
00:45:03,459 --> 00:45:09,819
<font color="#E5E5E5">whatever it's just a very lame</font><font color="#CCCCCC"> mg and a</font>

923
00:45:07,900 --> 00:45:12,459
tax reduction bypass because colic is

924
00:45:09,819 --> 00:45:14,319
now not started by Excel<font color="#E5E5E5"> this is just</font>

925
00:45:12,459 --> 00:45:16,239
the Windows operating system starting

926
00:45:14,319 --> 00:45:24,219
<font color="#CCCCCC">here cuz</font><font color="#E5E5E5"> I think all</font><font color="#CCCCCC"> core or any other</font>

927
00:45:16,239 --> 00:45:26,380
program you<font color="#E5E5E5"> want yes so it's ctrl a ctrl</font>

928
00:45:24,219 --> 00:45:28,209
<font color="#E5E5E5">escape is actually the shortcut for the</font>

929
00:45:26,380 --> 00:45:31,630
windows button<font color="#E5E5E5"> I didn't know</font><font color="#CCCCCC"> it</font><font color="#E5E5E5"> anymore</font>

930
00:45:28,209 --> 00:45:37,359
<font color="#CCCCCC">so it's also not MZ</font><font color="#E5E5E5"> and then the third</font>

931
00:45:31,630 --> 00:45:39,699
approach is<font color="#E5E5E5"> just to disable MZ so MZ</font><font color="#CCCCCC"> is</font>

932
00:45:37,359 --> 00:45:42,759
quote stored in our current user

933
00:45:39,699 --> 00:45:46,930
registry hive<font color="#E5E5E5"> can we influence that hard</font>

934
00:45:42,759 --> 00:45:48,489
without code execution<font color="#CCCCCC"> yes we can</font><font color="#E5E5E5"> we</font>

935
00:45:46,930 --> 00:45:52,390
just<font color="#E5E5E5"> dropped it in a</font><font color="#CCCCCC"> started directory</font>

936
00:45:48,489 --> 00:45:55,599
with your drop<font color="#E5E5E5"> our graph key and a</font><font color="#CCCCCC"> edit</font>

937
00:45:52,390 --> 00:46:00,249
commands<font color="#E5E5E5"> or</font><font color="#CCCCCC"> as</font><font color="#E5E5E5"> part of</font><font color="#CCCCCC"> bots file in in</font>

938
00:45:55,599 --> 00:46:02,589
the in the<font color="#CCCCCC"> start of 12</font><font color="#E5E5E5"> so just use just</font>

939
00:46:00,249 --> 00:46:04,149
<font color="#CCCCCC">a bot well and the nice thing is</font><font color="#E5E5E5"> what we</font>

940
00:46:02,589 --> 00:46:05,890
have word at our disposal because<font color="#E5E5E5"> we're</font>

941
00:46:04,150 --> 00:46:07,240
doing<font color="#E5E5E5"> this all within word</font>

942
00:46:05,890 --> 00:46:08,770
mostly

943
00:46:07,240 --> 00:46:10,569
and<font color="#CCCCCC"> inward we can just say well just</font>

944
00:46:08,770 --> 00:46:13,720
create a new file<font color="#CCCCCC"> having two following</font>

945
00:46:10,570 --> 00:46:18,180
contents like<font color="#E5E5E5"> we did the</font><font color="#CCCCCC"> following</font>

946
00:46:13,720 --> 00:46:22,359
registry<font color="#E5E5E5"> contents save this file name it</font>

947
00:46:18,180 --> 00:46:24,970
<font color="#CCCCCC">import the disabled MZ okay</font><font color="#E5E5E5"> make it</font><font color="#CCCCCC"> a</font>

948
00:46:22,359 --> 00:46:27,910
file format<font color="#CCCCCC"> the txt</font><font color="#E5E5E5"> do the same for a</font>

949
00:46:24,970 --> 00:46:30,040
bot file<font color="#E5E5E5"> and then we just run this drop</font>

950
00:46:27,910 --> 00:46:33,129
this in the start of directory<font color="#CCCCCC"> and voila</font>

951
00:46:30,040 --> 00:46:34,869
either we<font color="#CCCCCC"> disabled MZ or we</font><font color="#E5E5E5"> create new</font>

952
00:46:33,130 --> 00:46:36,460
trusted locations where we<font color="#E5E5E5"> drop a real</font>

953
00:46:34,869 --> 00:46:38,920
pale out and in the same<font color="#CCCCCC"> box file we can</font>

954
00:46:36,460 --> 00:46:41,710
<font color="#CCCCCC">of course also say start our payload</font>

955
00:46:38,920 --> 00:46:44,260
which<font color="#CCCCCC"> gives us if we have write access</font>

956
00:46:41,710 --> 00:46:47,650
into this<font color="#CCCCCC"> startup</font><font color="#E5E5E5"> directory it nicely</font>

957
00:46:44,260 --> 00:46:49,960
gives us an opportunity to<font color="#CCCCCC"> disable MZ</font>

958
00:46:47,650 --> 00:46:51,609
<font color="#E5E5E5">altogether and this is really half</font>

959
00:46:49,960 --> 00:46:54,550
Microsoft<font color="#CCCCCC"> two patch because</font><font color="#E5E5E5"> this is just</font>

960
00:46:51,609 --> 00:46:56,410
<font color="#CCCCCC">wood saving</font><font color="#E5E5E5"> text files</font><font color="#CCCCCC"> so how</font><font color="#E5E5E5"> will they</font>

961
00:46:54,550 --> 00:46:58,480
<font color="#CCCCCC">ever they won't be able</font><font color="#E5E5E5"> to</font><font color="#CCCCCC"> hook this up</font>

962
00:46:56,410 --> 00:47:00,549
into MZ saying well the safe<font color="#CCCCCC"> ass</font><font color="#E5E5E5"> events</font>

963
00:46:58,480 --> 00:47:06,790
should now be within<font color="#E5E5E5"> this list of</font>

964
00:47:00,550 --> 00:47:10,470
behavior log of<font color="#CCCCCC"> OMG so this is again in</font>

965
00:47:06,790 --> 00:47:13,300
the<font color="#CCCCCC"> area of</font><font color="#E5E5E5"> lame</font><font color="#CCCCCC"> ass ways around MZ and</font>

966
00:47:10,470 --> 00:47:14,890
so if we look<font color="#CCCCCC"> into MZ there are a lot of</font>

967
00:47:13,300 --> 00:47:16,630
lame<font color="#E5E5E5"> ass ways around it if you compare</font>

968
00:47:14,890 --> 00:47:19,210
it<font color="#CCCCCC"> to</font><font color="#E5E5E5"> like the powershell versions that</font>

969
00:47:16,630 --> 00:47:23,290
the the<font color="#E5E5E5"> bypasses are way harder to find</font>

970
00:47:19,210 --> 00:47:25,330
<font color="#E5E5E5">this is all still boy design a bit weak</font>

971
00:47:23,290 --> 00:47:27,369
I believe Microsoft really didn't do

972
00:47:25,330 --> 00:47:30,490
their best in my view and in<font color="#CCCCCC"> heritage</font>

973
00:47:27,369 --> 00:47:32,080
architectures<font color="#E5E5E5"> it's not very</font><font color="#CCCCCC"> robust</font><font color="#E5E5E5"> a lot</font>

974
00:47:30,490 --> 00:47:34,930
of<font color="#CCCCCC"> bypassed technique so with trusted</font>

975
00:47:32,080 --> 00:47:36,640
locations with<font color="#E5E5E5"> comm functions that don't</font>

976
00:47:34,930 --> 00:47:40,330
<font color="#E5E5E5">trigger or and and functions that</font><font color="#CCCCCC"> are</font>

977
00:47:36,640 --> 00:47:42,368
not<font color="#E5E5E5"> calm there's still stuff where I am</font>

978
00:47:40,330 --> 00:47:44,859
puzzled<font color="#CCCCCC"> so I don't</font><font color="#E5E5E5"> believe the Microsoft</font>

979
00:47:42,369 --> 00:47:47,050
specs on on<font color="#E5E5E5"> MZ</font><font color="#CCCCCC"> interested documents</font>

980
00:47:44,859 --> 00:47:48,819
what's happening if a file is<font color="#CCCCCC"> a new file</font>

981
00:47:47,050 --> 00:47:53,500
on<font color="#E5E5E5"> my computer why is it then certainly</font>

982
00:47:48,820 --> 00:47:56,080
not in<font color="#CCCCCC"> mg I don't know as a</font><font color="#E5E5E5"> side effect</font>

983
00:47:53,500 --> 00:47:58,599
I found this<font color="#E5E5E5"> trust record stuff where we</font>

984
00:47:56,080 --> 00:48:01,000
can create<font color="#CCCCCC"> long term persistence</font><font color="#E5E5E5"> bypass</font>

985
00:47:58,599 --> 00:48:02,859
any higher erased marker security

986
00:48:01,000 --> 00:48:05,920
settings<font color="#E5E5E5"> on the longer long run by just</font>

987
00:48:02,859 --> 00:48:08,410
doing<font color="#E5E5E5"> this with templates and I invite</font>

988
00:48:05,920 --> 00:48:10,060
all<font color="#CCCCCC"> of you to to enjoy this right and</font>

989
00:48:08,410 --> 00:48:11,890
there's a<font color="#E5E5E5"> lot</font><font color="#CCCCCC"> more stuff to be found in</font>

990
00:48:10,060 --> 00:48:13,810
the in<font color="#E5E5E5"> exam</font><font color="#CCCCCC"> Z implementation and a lot</font>

991
00:48:11,890 --> 00:48:15,940
more bypasses I'm wondering<font color="#E5E5E5"> whether</font>

992
00:48:13,810 --> 00:48:17,710
Microsoft will do anything on<font color="#E5E5E5"> this</font><font color="#CCCCCC"> I</font>

993
00:48:15,940 --> 00:48:19,270
didn't discuss<font color="#CCCCCC"> it</font><font color="#E5E5E5"> with them because I</font>

994
00:48:17,710 --> 00:48:19,960
<font color="#CCCCCC">believe all this behaviour according</font><font color="#E5E5E5"> to</font>

995
00:48:19,270 --> 00:48:22,180
<font color="#E5E5E5">specs</font>

996
00:48:19,960 --> 00:48:24,250
they're back to say that they do<font color="#E5E5E5"> this</font>

997
00:48:22,180 --> 00:48:26,890
well that's<font color="#E5E5E5"> what they do</font>

998
00:48:24,250 --> 00:48:29,529
we'll see how they will devolve this in

999
00:48:26,890 --> 00:48:31,720
the future<font color="#CCCCCC"> I think it's really</font><font color="#E5E5E5"> more like</font>

1000
00:48:29,529 --> 00:48:35,170
<font color="#CCCCCC">a better than like a full-figured</font>

1001
00:48:31,720 --> 00:48:39,339
implementation on the<font color="#E5E5E5"> office so that</font>

1002
00:48:35,170 --> 00:48:42,420
<font color="#E5E5E5">concludes our talk and we have a couple</font>

1003
00:48:39,339 --> 00:48:42,420
<font color="#CCCCCC">of</font><font color="#E5E5E5"> minutes</font><font color="#CCCCCC"> left for questions</font>

1004
00:48:44,440 --> 00:48:51,070
[Applause]

1005
00:49:08,600 --> 00:49:13,740
so I'm just<font color="#CCCCCC"> thinking you looked here at</font>

1006
00:49:11,040 --> 00:49:16,590
Word and Excel<font color="#E5E5E5"> is this also applicable</font>

1007
00:49:13,740 --> 00:49:18,450
<font color="#E5E5E5">to</font><font color="#CCCCCC"> you PowerPoint I mean it's just I'm</font>

1008
00:49:16,590 --> 00:49:20,190
just<font color="#E5E5E5"> thinking</font><font color="#CCCCCC"> if I open</font><font color="#E5E5E5"> a were talking</font>

1009
00:49:18,450 --> 00:49:22,140
<font color="#E5E5E5">over macro even from a friend it's kind</font>

1010
00:49:20,190 --> 00:49:25,170
of weird<font color="#E5E5E5"> if I open Excel bit that's</font>

1011
00:49:22,140 --> 00:49:26,520
weird<font color="#E5E5E5"> but you know which of our</font>

1012
00:49:25,170 --> 00:49:29,100
applications is this attack so if is

1013
00:49:26,520 --> 00:49:31,200
actually huger or the texture first<font color="#E5E5E5"> is</font>

1014
00:49:29,100 --> 00:49:33,630
is bigger<font color="#CCCCCC"> so if you look</font><font color="#E5E5E5"> at the static</font>

1015
00:49:31,200 --> 00:49:35,279
part<font color="#E5E5E5"> and storing macros is quite the</font>

1016
00:49:33,630 --> 00:49:36,900
same in PowerPoint there's a little bit

1017
00:49:35,280 --> 00:49:39,380
<font color="#E5E5E5">there's some small difference was there</font>

1018
00:49:36,900 --> 00:49:42,360
but but there's a lot<font color="#E5E5E5"> of similarities</font>

1019
00:49:39,380 --> 00:49:48,480
<font color="#CCCCCC">4mg in PowerPoint</font><font color="#E5E5E5"> I'm actually</font><font color="#CCCCCC"> not a</font>

1020
00:49:42,360 --> 00:49:50,880
word doesn't<font color="#E5E5E5"> hook the other products</font>

1021
00:49:48,480 --> 00:49:53,370
because<font color="#CCCCCC"> I think there are</font><font color="#E5E5E5"> more VBA aware</font>

1022
00:49:50,880 --> 00:49:55,980
products like<font color="#CCCCCC"> Auto</font><font color="#E5E5E5"> caught is also doing</font>

1023
00:49:53,370 --> 00:49:57,480
VBA<font color="#E5E5E5"> or dipped in the past so so we</font>

1024
00:49:55,980 --> 00:49:59,640
really have just scratched the<font color="#CCCCCC"> surface</font>

1025
00:49:57,480 --> 00:50:01,950
there's many more things<font color="#E5E5E5"> to explore we</font>

1026
00:49:59,640 --> 00:50:03,930
<font color="#CCCCCC">focused on especially Word</font><font color="#E5E5E5"> in a little</font>

1027
00:50:01,950 --> 00:50:05,910
bit of Excel<font color="#E5E5E5"> but indeed there there</font>

1028
00:50:03,930 --> 00:50:07,919
there's<font color="#E5E5E5"> PowerPoint there's one note</font>

1029
00:50:05,910 --> 00:50:09,029
there's access there there's many

1030
00:50:07,920 --> 00:50:10,470
<font color="#CCCCCC">applications</font><font color="#E5E5E5"> that could also be</font>

1031
00:50:09,030 --> 00:50:12,630
interesting from<font color="#E5E5E5"> this perspective</font><font color="#CCCCCC"> you</font>

1032
00:50:10,470 --> 00:50:19,859
<font color="#E5E5E5">look</font><font color="#CCCCCC"> forward</font><font color="#E5E5E5"> to seeing more results</font>

1033
00:50:12,630 --> 00:50:22,740
thank you<font color="#E5E5E5"> thanks are there are there any</font>

1034
00:50:19,860 --> 00:50:27,360
<font color="#CCCCCC">challenges to the AV vendors scanning</font>

1035
00:50:22,740 --> 00:50:32,009
<font color="#E5E5E5">for the P code is there anything like</font>

1036
00:50:27,360 --> 00:50:34,950
fundamentally yeah lack of specification

1037
00:50:32,010 --> 00:50:36,450
that<font color="#CCCCCC"> is</font><font color="#E5E5E5"> really an issue so Marcus was</font>

1038
00:50:34,950 --> 00:50:38,370
actually says in their specification

1039
00:50:36,450 --> 00:50:40,169
this should be ignored<font color="#CCCCCC"> well they don't</font>

1040
00:50:38,370 --> 00:50:42,180
<font color="#E5E5E5">do that themselves</font><font color="#CCCCCC"> and if there's no</font>

1041
00:50:40,170 --> 00:50:43,020
documentation on what's not there

1042
00:50:42,180 --> 00:50:45,660
officially

1043
00:50:43,020 --> 00:50:49,200
so there's<font color="#CCCCCC"> doctor</font><font color="#E5E5E5"> bunch F which is</font>

1044
00:50:45,660 --> 00:50:51,089
<font color="#E5E5E5">really a</font><font color="#CCCCCC"> ap guru</font><font color="#E5E5E5"> which has been in that</font>

1045
00:50:49,200 --> 00:50:53,430
field<font color="#E5E5E5"> for four decades and he has</font>

1046
00:50:51,090 --> 00:50:55,860
written<font color="#E5E5E5"> this</font><font color="#CCCCCC"> peek out the proof</font><font color="#E5E5E5"> of</font>

1047
00:50:53,430 --> 00:50:58,259
concept is completely<font color="#E5E5E5"> reverse</font><font color="#CCCCCC"> engineered</font>

1048
00:50:55,860 --> 00:51:01,200
the<font color="#E5E5E5"> most important stuff there</font><font color="#CCCCCC"> I think</font>

1049
00:50:58,260 --> 00:51:04,080
<font color="#CCCCCC">that</font><font color="#E5E5E5"> has been hours and hours of hard</font>

1050
00:51:01,200 --> 00:51:05,910
work<font color="#CCCCCC"> that he has put into</font><font color="#E5E5E5"> that but</font>

1051
00:51:04,080 --> 00:51:08,490
getting is completely right without<font color="#E5E5E5"> a</font>

1052
00:51:05,910 --> 00:51:10,200
specification<font color="#CCCCCC"> that that's very much</font>

1053
00:51:08,490 --> 00:51:11,790
<font color="#CCCCCC">error-prone as I've</font><font color="#E5E5E5"> just shown you if</font>

1054
00:51:10,200 --> 00:51:14,970
you just slightly deviate respects

1055
00:51:11,790 --> 00:51:16,860
<font color="#E5E5E5">switches scanner would already crash one</font>

1056
00:51:14,970 --> 00:51:18,129
<font color="#CCCCCC">edition on</font><font color="#E5E5E5"> that one is the</font><font color="#CCCCCC"> thicker</font><font color="#E5E5E5"> stuff</font>

1057
00:51:16,860 --> 00:51:21,970
<font color="#E5E5E5">does get</font><font color="#CCCCCC"> process</font>

1058
00:51:18,130 --> 00:51:25,359
<font color="#E5E5E5">by</font><font color="#CCCCCC"> M</font><font color="#E5E5E5"> G so the AV engine could see it if</font>

1059
00:51:21,970 --> 00:51:26,500
they<font color="#E5E5E5"> would hook into</font><font color="#CCCCCC"> an</font><font color="#E5E5E5"> G so to</font><font color="#CCCCCC"> really</font>

1060
00:51:25,359 --> 00:51:32,920
do<font color="#E5E5E5"> this properly</font><font color="#CCCCCC"> you need to kind of</font>

1061
00:51:26,500 --> 00:51:35,369
combine the two approaches more

1062
00:51:32,920 --> 00:51:35,369
<font color="#E5E5E5">questions</font>

1063
00:51:37,869 --> 00:51:45,010
thank you guys<font color="#CCCCCC"> thank you very</font><font color="#E5E5E5"> much</font>

1064
00:51:40,970 --> 00:51:45,009
[Applause]

