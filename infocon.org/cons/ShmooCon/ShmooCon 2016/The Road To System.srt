1
00:00:00,000 --> 00:00:08,690
Steve about reusing old unpatched
vulnerabilities in Windows right so with

2
00:00:08,690 --> 00:00:31,880
out further please give a warm welcome
to talk about gonna put a little bit and

3
00:00:31,880 --> 00:00:36,239
get a cool windows privilege escalation
that works in all versions of Windows

4
00:00:36,239 --> 00:00:41,110
last time we checked which was just a
couple days ago and we also got a new

5
00:00:41,110 --> 00:00:50,739
kind of weird network attack out of it
that will talk about green known on the

6
00:00:50,739 --> 00:00:54,989
Internet has been machine

7
00:00:54,990 --> 00:01:02,240
yeah I guess my little clip my very well
I came from a computer science and math

8
00:01:02,240 --> 00:01:06,260
background former developer all that
kind of stuff and now I do security

9
00:01:06,260 --> 00:01:13,680
consulting and penetration testing with
NTT com's security team name at NTT

10
00:01:13,680 --> 00:01:17,560
com's security is also known as Fox club
security that's why we have the logo on

11
00:01:17,560 --> 00:01:21,370
the slides and also known as the guys
who really sad Java and serialize stuff

12
00:01:21,370 --> 00:01:22,350
not too long ago

13
00:01:22,350 --> 00:01:36,710
big freediver bit of an ocean hibi
Canadian so what you get out of the

14
00:01:36,710 --> 00:01:40,610
socket designed to break it down for the
blue team in the Red Team Blue Team

15
00:01:40,610 --> 00:01:47,729
people can expect to get some insights
into common misconfigured haitians just

16
00:01:47,729 --> 00:01:54,429
sort of myself here and how they can be
abused by attackers hopefully you guys

17
00:01:54,430 --> 00:01:58,130
can use this as you know a motive get
some budget and time to actually sort

18
00:01:58,130 --> 00:02:01,030
these issues out because they're all
really old and their views all the time

19
00:02:01,030 --> 00:02:04,330
and we're just providing like another
way to abuse those same things that

20
00:02:04,330 --> 00:02:10,288
people have been going on for years for
people on the red team you're gonna get

21
00:02:10,288 --> 00:02:14,350
new tool to perform Windows privilege
escalation in Windows seven plus in

22
00:02:14,350 --> 00:02:19,690
default configurations this takes
advantage of issues marked as won't fix

23
00:02:19,690 --> 00:02:24,560
by Microsoft so hopefully it's probably
not going away anytime soon

24
00:02:24,560 --> 00:02:30,500
we're also going to be providing a tool
to do and DNS spoofing attacks outside

25
00:02:30,500 --> 00:02:35,710
of your broadcast domain so right now
those sorts of attacks are combined to

26
00:02:35,710 --> 00:02:39,120
your local network and I mean it's
pretty simple and trivial but we

27
00:02:39,120 --> 00:02:45,040
actually implemented it and how we did
it and how it all works and for those

28
00:02:45,040 --> 00:02:49,420
who don't know what actually describe
what it is as well and we're gonna be

29
00:02:49,420 --> 00:02:52,420
dropping all the code we use to do this
so that's going to include some csharp

30
00:02:52,420 --> 00:02:55,489
libraries which was actually probably
the hardest part of doing this whole

31
00:02:55,490 --> 00:02:57,140
thing that allows people to

32
00:02:57,140 --> 00:03:05,809
you know expand on this and continue
building it out alright so I'm just

33
00:03:05,810 --> 00:03:10,100
gonna go over some background I'm gonna
covering detail 3 well known issues that

34
00:03:10,100 --> 00:03:14,030
probably a lot of people in the room
already know about and DNS spoofing W

35
00:03:14,030 --> 00:03:18,270
Pat spoofing and NTLM relay these are
all from Lake you know like the year

36
00:03:18,270 --> 00:03:24,140
2000 basically the tool responded I P Y
is kind of the go to that a lot of

37
00:03:24,140 --> 00:03:27,988
people used to abuse these right now and
like a lot of people it's the first

38
00:03:27,989 --> 00:03:32,780
thing the fire up on a contest organised
something a little guy can you spent all

39
00:03:32,780 --> 00:03:40,660
this so I'm just gonna go over white
Mtns meeting is for those who are

40
00:03:40,660 --> 00:03:46,140
unfamiliar and DNS is actually it's a
broadcast name resolution protocol so

41
00:03:46,140 --> 00:03:50,070
you can think of a kind of like the nso
if you wanna look out I don't know the

42
00:03:50,070 --> 00:03:54,329
hostname cats you can use them and
that's a look that up or you could use

43
00:03:54,330 --> 00:03:59,540
DNS in Windows the way everything works
is first it's gonna check your hosts

44
00:03:59,540 --> 00:04:02,390
file and its gonna see if the name
you're trying to look up existing the

45
00:04:02,390 --> 00:04:07,859
hosts file if not its gonna try to do a
DNS lookup and then if the DNS lookup

46
00:04:07,860 --> 00:04:13,030
fails in default configurations of falls
back to and DNS and and DNS basically

47
00:04:13,030 --> 00:04:16,470
just works on the honor system so your
computer's going to ask the entire

48
00:04:16,470 --> 00:04:20,570
broadcast domain on your network hey
does anyone know the IP address for this

49
00:04:20,570 --> 00:04:25,120
post and anyone can just respond to that
and people have obviously been abusing

50
00:04:25,120 --> 00:04:30,720
this forever so I'm actually gonna go
through a little example with some

51
00:04:30,720 --> 00:04:44,410
screenshots and Wireshark and Internet
Explorer so I typed cats into my browser

52
00:04:44,410 --> 00:04:49,240
rare and you can see it search thing for
cats in on the right you see all the

53
00:04:49,240 --> 00:04:53,660
network traffic that was generated
there's a whole bunch of stuff like

54
00:04:53,660 --> 00:04:57,210
Windows machines are really noisy
especially our corporate images so you

55
00:04:57,210 --> 00:05:01,400
know like a I that's just our domain but
the Black Cats you can see all those

56
00:05:01,400 --> 00:05:02,799
look up the car that was

57
00:05:02,800 --> 00:05:09,000
a result of me typing cats into my
browser bar so I'm gonna do the exact

58
00:05:09,000 --> 00:05:15,069
same thing while running the responded
up idle and so this time you see it

59
00:05:15,069 --> 00:05:20,220
didn't search being it actually
responder actually grab that request so

60
00:05:20,220 --> 00:05:26,879
what happened is a search cats windows
in Mtns look up for cats I have

61
00:05:26,879 --> 00:05:31,310
responder running on another system and
it replied with that systems IP address

62
00:05:31,310 --> 00:05:34,569
and then Internet Explorer just went to
that site as if it was you know like it

63
00:05:34,569 --> 00:05:39,479
has an IP address for it hits it just
like a normal web site and the

64
00:05:39,479 --> 00:05:44,750
interesting thing is on the other
machine where is running responder nao

65
00:05:44,750 --> 00:05:53,430
you get my own NTLM be too harsh so what
happened there is when Internet Explorer

66
00:05:53,430 --> 00:06:00,930
went to that website server requested at
an occasion and my internet just hated

67
00:06:00,930 --> 00:06:05,020
and you know we talk that he can either
cracked that or you could do different

68
00:06:05,020 --> 00:06:07,849
things like use NTLM relay composite
which will talk a little bit more about

69
00:06:07,849 --> 00:06:14,909
ya so I i went over most of this if you
replied that's that's basically what

70
00:06:14,909 --> 00:06:20,240
happened

71
00:06:20,240 --> 00:06:24,710
alright a little bit more about 10
minutes or so different versions of used

72
00:06:24,710 --> 00:06:30,530
Windows use it in subtly different ways
so newer versions don't seem to fall

73
00:06:30,530 --> 00:06:37,750
back to NBS if the domain is a fully
qualified domain another interesting

74
00:06:37,750 --> 00:06:42,970
note is this doesn't just apply to
Internet Explorer so I showed you know I

75
00:06:42,970 --> 00:06:46,759
showed and DNS spoofing and tell me
Laynie but actually a whole bunch of

76
00:06:46,759 --> 00:06:51,449
different Windows components of them
actually will fall back to MPLS when DNS

77
00:06:51,449 --> 00:06:55,919
fails for people who are trying to fix
this you can just turn it off

78
00:06:55,919 --> 00:06:59,719
unfortunately it might break things so
that's been a recommendation that's been

79
00:06:59,720 --> 00:07:02,289
out there forever everyone knows they
should turn it off but some people just

80
00:07:02,289 --> 00:07:10,979
can't write the next we're gonna talk
about W pat's moving to this is pretty

81
00:07:10,979 --> 00:07:17,150
intimately related to Mtns moving so
again Internet Explorer this time in

82
00:07:17,150 --> 00:07:22,620
default configurations will attempt to
look for the W Pat dot dot file for

83
00:07:22,620 --> 00:07:27,449
proxy auto configuration so it's
basically like depending on what network

84
00:07:27,449 --> 00:07:32,409
it's on it's going to look for this host
the host name is just W Pat / W pad that

85
00:07:32,409 --> 00:07:37,229
it's gonna it's just gonna look for that
and if it finds that pilots going to use

86
00:07:37,229 --> 00:07:44,539
the contents of the file to configure
proxy server in an explorer so many for

87
00:07:44,539 --> 00:07:47,880
anyone who is paying attention to the
Mtns booking stuff you can probably see

88
00:07:47,880 --> 00:07:53,539
the problem here that hostname W pad
just be spoofed by anyone on the network

89
00:07:53,539 --> 00:07:57,289
and have you know they can perform
amount of middle attack and have

90
00:07:57,289 --> 00:08:00,949
everyone who has Internet Explorer
running into default configuration on

91
00:08:00,949 --> 00:08:04,639
that network all their web traffic is
going to be going through whatever the

92
00:08:04,639 --> 00:08:09,130
militias hosted so I showed an example
of it w pad i sat down at the bottom of

93
00:08:09,130 --> 00:08:14,729
the slide that's that's all it takes is
just like those three lines you do Mtns

94
00:08:14,729 --> 00:08:17,090
hoping you would put them in that file
and

95
00:08:17,090 --> 00:08:24,030
all the Internet Explorer's traffic
would go through here there's another

96
00:08:24,030 --> 00:08:29,909
fun fact that you probably won't read
about in too many places it's not just

97
00:08:29,910 --> 00:08:33,950
Internet Explorer that uses the W Pat
settings and that's something I only

98
00:08:33,950 --> 00:08:39,099
found out about what we're doing this
this research so we'll see that Windows

99
00:08:39,099 --> 00:08:44,039
services actually seen to look for the W
Pat file to even in cases where they're

100
00:08:44,039 --> 00:08:55,370
not supposed to its kinda funny so now
the third you know all this you that

101
00:08:55,370 --> 00:09:01,350
this exploit relies on his NTLM relay
NTLM relay is a simple man in the middle

102
00:09:01,350 --> 00:09:06,660
attack against NTLM authentication again
people in using this river some people

103
00:09:06,660 --> 00:09:10,319
hear about it and think Microsoft patch
that you know whenever back in the day

104
00:09:10,320 --> 00:09:13,589
so that's a bit of a misconception that
i've seen

105
00:09:13,589 --> 00:09:19,690
loved ones patched with NTLM relay where
the origin host is the same as the

106
00:09:19,690 --> 00:09:24,020
destination host and the protocol on
both sides of the same so the scenario

107
00:09:24,020 --> 00:09:30,029
they fix was like if I'm an attacker and
I'm attacking you know this one computer

108
00:09:30,029 --> 00:09:34,779
and i trick that computer to
authenticate to me over SMB then I take

109
00:09:34,779 --> 00:09:38,250
that same SMB handshake and throw it
back at the same computer that tried to

110
00:09:38,250 --> 00:09:42,050
authenticate Jimmy you can't do that
anymore they fix that but what they

111
00:09:42,050 --> 00:09:47,880
didn't fix was you know I can go from
one computer like I can take the USA

112
00:09:47,880 --> 00:09:53,560
victim like just actually in the picture
up on the slide so there's a client at a

113
00:09:53,560 --> 00:09:57,279
client-server I can relate the NTLM
authentication over to another third

114
00:09:57,279 --> 00:10:03,589
machine or I can actually real eightieth
indication back to the the same machine

115
00:10:03,589 --> 00:10:07,020
that sent it to me as long as they do it
over a different protocol because NTLM

116
00:10:07,020 --> 00:10:11,650
authentication is it's more than just
SMB NTLM authentication is used for

117
00:10:11,650 --> 00:10:13,630
HTTPS Mb

118
00:10:13,630 --> 00:10:19,080
RDP use it like tons tons and tons of
things it so you can still do that cross

119
00:10:19,080 --> 00:10:22,810
protocol relay which is interesting

120
00:10:22,810 --> 00:10:32,699
so I'm gonna go over just an attack
scenario here

121
00:10:32,700 --> 00:10:38,140
typical attack scenario so like like I
showed my wire shock example you know

122
00:10:38,140 --> 00:10:41,699
user just some users trying to search
for something in Internet Explorer so

123
00:10:41,700 --> 00:10:46,000
they take whatever they take their side
chain cats into the browser buyer that's

124
00:10:46,000 --> 00:10:51,089
internet's largest gonna try to
authenticate with NTLM over HTTP you can

125
00:10:51,089 --> 00:10:58,580
actually reflect that occasion back to
the SMB listener on that machine and

126
00:10:58,580 --> 00:11:03,220
gain a show for anyone interested in
seeing more of this kind of stuff they

127
00:11:03,220 --> 00:11:06,890
responded up I Zac attack in the
Metasploit Framework I'll have you know

128
00:11:06,890 --> 00:11:14,970
like implementations of these sorts of
attacks right now we get into some of

129
00:11:14,970 --> 00:11:20,610
the interesting stuff the basic outline
of our privilege escalation attack there

130
00:11:20,610 --> 00:11:24,190
are few challenges that we had to kind
of overcame to get it actually work but

131
00:11:24,190 --> 00:11:30,670
you know points 12 through 15 per so
earnestly and DNS move ourselves so

132
00:11:30,670 --> 00:11:34,810
you're on a machine and you're trying to
get you know thirty system level access

133
00:11:34,810 --> 00:11:41,890
from so you first 12 and DNS move
yourself and redirect W Pat to 127 001

134
00:11:41,890 --> 00:11:47,850
then you're gonna stand up a local HTTP
server on port 80 which you can totally

135
00:11:47,850 --> 00:11:54,089
do as a low privileges there and for any
HP request that is not for the W PAD

136
00:11:54,089 --> 00:12:00,390
file redirect it to you know some of
whatever some URL that you track for any

137
00:12:00,390 --> 00:12:04,970
requests to that euro request NTLM
authentication and then doing that and

138
00:12:04,970 --> 00:12:11,870
then relay that NTLM authentication back
to localhost on the SMB listener and you

139
00:12:11,870 --> 00:12:15,850
know create new service from that
service yet exactly that's exactly what

140
00:12:15,850 --> 00:12:23,500
exactly are the challenges here where Mb
NFL thing as a low privileged user on a

141
00:12:23,500 --> 00:12:26,510
Windows machine how can he do that
because you can't see if network traffic

142
00:12:26,510 --> 00:12:28,000
so how you going to

143
00:12:28,000 --> 00:12:35,900
answer and DNS replies usually relies on
that running each peter breslow

144
00:12:35,900 --> 00:12:39,170
privileged user without getting blocked
by Windows Firewall it's actually super

145
00:12:39,170 --> 00:12:45,610
easy I'll go over how we did it get now
this is the tricky part number three

146
00:12:45,610 --> 00:12:51,230
getting a high privilege account on the
machine to make a request through that w

147
00:12:51,230 --> 00:12:54,530
Pat proxy so that was kind of the trick
to this whole thing and we'll go over

148
00:12:54,530 --> 00:12:57,680
for every version of Windows that we got
this working on how we were able to do

149
00:12:57,680 --> 00:13:02,109
that and the first challenge was
actually just packaging all this crap up

150
00:13:02,110 --> 00:13:11,090
and getting it to work it was probably
the hardest part for anyone who thinks a

151
00:13:11,090 --> 00:13:15,310
lot of us that probably sounds a little
bit familiar the inspiration for the

152
00:13:15,310 --> 00:13:19,459
project came from Google project zero
they did something similar

153
00:13:19,459 --> 00:13:24,378
they use local web they were they were
using WebDAV instead of you know all

154
00:13:24,379 --> 00:13:28,970
this other weird stuff that's being
worked on Windows 7 Windows Defender and

155
00:13:28,970 --> 00:13:34,649
it was pretty cool windows 8 that's
right with Windows 8 Windows Defender I

156
00:13:34,649 --> 00:13:37,899
don't know if it works anymore they they
released a proof of concept but it

157
00:13:37,899 --> 00:13:41,970
didn't actually papel so we decided to
go and try to get this working on all

158
00:13:41,970 --> 00:13:49,629
versions of Windows and actually get
themselves so in the next section here

159
00:13:49,629 --> 00:13:52,800
and we'll just go over a list of those
four challenges and then just go over

160
00:13:52,800 --> 00:13:57,729
how we got past all of those concepts
like the actual meat of this project so

161
00:13:57,730 --> 00:14:01,839
localhost Mtns pooping how the heck do
you do that when you don't already have

162
00:14:01,839 --> 00:14:09,179
local admin window sends and receives
and DNS on UDP port 137 as a low

163
00:14:09,179 --> 00:14:13,029
privileged user you can't see if you
can't you don't have access to that you

164
00:14:13,029 --> 00:14:17,610
can't see if the network so what are you
gonna do you know anyone who remembers

165
00:14:17,610 --> 00:14:23,929
DNS spoofing in the whole source part
randomization thing that all pipes and

166
00:14:23,929 --> 00:14:31,949
DNS as well as the UDP protocol you know
it's anyone can just packets and smooth

167
00:14:31,949 --> 00:14:37,628
things and the only protection here is
just like in DNS there's a thing called

168
00:14:37,629 --> 00:14:43,720
it's it's it's TX ideas what they call
the the field in the packet so in the

169
00:14:43,720 --> 00:14:44,509
request

170
00:14:44,509 --> 00:14:49,759
there's a TX I D and in response that
we're trying to smooth out that has to

171
00:14:49,759 --> 00:14:56,160
match it turns out the TX ideas on the
two bites and has 65,000 possible values

172
00:14:56,160 --> 00:15:02,679
so especially for flooding pockets on
the loopback adapter we can totally do I

173
00:15:02,679 --> 00:15:09,309
65,000 and second we don't even have to
go that fast but we can't easily and we

174
00:15:09,309 --> 00:15:14,689
always know the source part because it's
UDP 137 so so basically to do this you

175
00:15:14,689 --> 00:15:18,149
know localhost IBNS moving all we're
doing is flooding and DNS replies

176
00:15:18,149 --> 00:15:22,819
forgiving hostname like in this case W
bad we're just gonna flood localhost and

177
00:15:22,819 --> 00:15:25,599
keep incrementing that txt field in the
packet

178
00:15:25,600 --> 00:15:35,730
and hope that it heads this shows an
example of one of these just like in

179
00:15:35,730 --> 00:15:41,209
Mtns I think it's it's a response packet
in Wireshark so you can see the TX I D

180
00:15:41,209 --> 00:15:53,040
field is down here and it's both source
and destination part of 137 looking

181
00:15:53,040 --> 00:15:58,870
example so this is kind of cool Eagles
Dean is a low privileged user and data

182
00:15:58,870 --> 00:16:05,370
is a domain I've been in in this example
so and the top part in the top screen

183
00:16:05,370 --> 00:16:11,019
shot there I'm running our exploits
which potato DAC and I have it

184
00:16:11,019 --> 00:16:16,160
doing the Mtns moving stuff so it's
moving the hostname W Pat to 127 001

185
00:16:16,160 --> 00:16:20,060
then in the bottom screen shot I'm
logged into the same machine with a

186
00:16:20,060 --> 00:16:23,979
domain I'm account he pings 12701

187
00:16:23,980 --> 00:16:28,680
sorry he paying the host W Patna comes
back 12701 so you can see that it

188
00:16:28,680 --> 00:16:43,420
actually worked 80 super easy so tired
that restricts the system.net HP

189
00:16:43,420 --> 00:16:49,209
listener 249 admins to party but you can
just not used on and set up a different

190
00:16:49,209 --> 00:16:56,420
HP servers are used a library in C sharp
called an HTTP and there's no problems

191
00:16:56,420 --> 00:17:04,849
like you just don't have to worry about
it

192
00:17:04,849 --> 00:17:11,859
so here with the the tricky part so now
we basically got we've got the same DNS

193
00:17:11,859 --> 00:17:15,979
before running the HP server running on
port 80 now we have to have somehow like

194
00:17:15,980 --> 00:17:18,890
trick a local system account

195
00:17:18,890 --> 00:17:23,750
process was system privileges on the
machine to make a request and proxy it

196
00:17:23,750 --> 00:17:28,160
through our through our web server so we
can like relay those credentials to the

197
00:17:28,160 --> 00:17:34,049
SMB Lysander and this is gonna this is
operating system dependent so we have to

198
00:17:34,049 --> 00:17:38,879
find services or processes that actually
for some crazy reason are looking for

199
00:17:38,880 --> 00:17:45,200
that w Pat dot dot file and using the
proxy settings specified there for any

200
00:17:45,200 --> 00:17:49,299
HP requesting make outbound so in our
setup here we use default installation

201
00:17:49,299 --> 00:17:53,400
of all operating systems no
configuration changes were made and

202
00:17:53,400 --> 00:17:59,120
proxy settings for for the user that we
are running this as we're all set to

203
00:17:59,120 --> 00:18:01,979
automatically detect settings but this
doesn't matter it really shouldn't

204
00:18:01,980 --> 00:18:06,200
matter like why should a low privileged
user their proxy settings and I E affect

205
00:18:06,200 --> 00:18:10,450
you know what system process of doing
but its windows so we just we left it on

206
00:18:10,450 --> 00:18:20,820
the default because you know it was
pretty easy Windows seven teams pretty

207
00:18:20,820 --> 00:18:26,960
happy to use WP for everything even when
like even when it's not supposed to for

208
00:18:26,960 --> 00:18:32,620
some reason that still seems to look for
that whadda dad on the W Pat host so all

209
00:18:32,620 --> 00:18:37,658
we did was so we ran our explained it
was spoofing the hostname W pad and

210
00:18:37,659 --> 00:18:44,159
serving out that proxy config file at a
speed of you think you can see in the

211
00:18:44,159 --> 00:18:48,659
screenshot kind of what's going on if
you read through the you know if you

212
00:18:48,659 --> 00:18:54,620
would read three times so we ran Windows
Defender and check for updates and

213
00:18:54,620 --> 00:19:01,949
Windows Defender made it HP request
through our local server and then you

214
00:19:01,950 --> 00:19:06,659
know basically Papa system shell for us

215
00:19:06,659 --> 00:19:28,859
yeah so here I am just checking the
local group and showing that the current

216
00:19:28,859 --> 00:19:40,918
user is not is not a local admin right
now the IP address of my machine because

217
00:19:40,919 --> 00:19:47,989
that's one of the arguments to the to
the tool we both here so I'm typing out

218
00:19:47,989 --> 00:19:52,149
disabled exhaust that you know I'm not
even to explain that there was just

219
00:19:52,149 --> 00:19:55,719
something I was messing with developing
this and it doesn't really have much

220
00:19:55,720 --> 00:20:03,749
bearing on the actual explained so the
command I'm gonna have the exact run is

221
00:20:03,749 --> 00:20:11,679
going to add the current user to the
local Administrators group so it's

222
00:20:11,679 --> 00:20:16,389
running this tool automatically like he
fires off the check for Windows

223
00:20:16,389 --> 00:20:20,869
defenders updates from the command line
so it'll do that for you so Windows

224
00:20:20,869 --> 00:20:23,799
Firewall popped up but if you see on
that in the terminal on the left it

225
00:20:23,799 --> 00:20:32,179
already ran so we already have local
admin eventually

226
00:20:32,179 --> 00:20:40,490
a bailout of it I hit now and then I
eventually he can't I'm just bad at

227
00:20:40,490 --> 00:20:45,639
computers takes me awhile to do this
year ago and then it when I check out

228
00:20:45,639 --> 00:20:55,418
local group administrators he's in there
so for Windows 7 p.m. to which has

229
00:20:55,419 --> 00:21:12,210
passed all the time

230
00:21:12,210 --> 00:21:17,570
Windows Server doesn't come with Windows
Defender but really all we're doing is

231
00:21:17,570 --> 00:21:20,470
checking for you know basically we're
just checking for Windows Update and

232
00:21:20,470 --> 00:21:23,950
Windows Defender updates but Windows
updates you know what the difference is

233
00:21:23,950 --> 00:21:29,149
a little different but turned out to
sell some weirdness that happened here

234
00:21:29,149 --> 00:21:34,959
is so all of these machines were joined
to a domain for some reason it didn't

235
00:21:34,960 --> 00:21:38,929
want to use W Pat it wanted W it wanted
the fully qualified domain name is

236
00:21:38,929 --> 00:21:45,149
looking forw podium C-dot local which is
stupid testimony whatever that's fine

237
00:21:45,149 --> 00:21:48,248
the two old the tool that we both here
can accommodate that you can just tell

238
00:21:48,249 --> 00:22:12,060
it what you want to do for and I get
that Mr next

239
00:22:12,060 --> 00:22:19,870
basically go through the same thing
again who am I T Nagar blow in a group

240
00:22:19,870 --> 00:22:31,780
of ministers he's not in that group in
there and then I also when a user Eagles

241
00:22:31,780 --> 00:22:35,350
/ don't mean just to show you that he's
also not in any of the groups that are

242
00:22:35,350 --> 00:22:42,260
local admins so now I'm taking out the
command used for potato that exe here on

243
00:22:42,260 --> 00:22:46,280
Windows Server 2008 song and use that
same command I'm going to add him to the

244
00:22:46,280 --> 00:23:02,970
local admin group so this time I take
their disabled offender because like I

245
00:23:02,970 --> 00:23:06,410
said it automatically checks for Windows
defenders of defender updates while

246
00:23:06,410 --> 00:23:15,480
there's no Windows Defender here so it's
kind of pointless and I like I said

247
00:23:15,480 --> 00:23:20,790
before I have to specify what host so
instead of just moving W Pat any dispute

248
00:23:20,790 --> 00:23:31,610
W pad EMC . local route running so now
I'm gonna do is check for Windows Update

249
00:23:31,610 --> 00:23:40,750
and Windows should try to use those
proxy settings and it's it's the system

250
00:23:40,750 --> 00:23:44,550
accounted indicates back to me I really
that an occasion to the local SMB

251
00:23:44,550 --> 00:23:54,060
listener and now that guys in the
country

252
00:23:54,060 --> 00:24:11,100
10 2012 looks like it was a bit tougher
totally a fluke that we've found it so

253
00:24:11,100 --> 00:24:16,280
in all the test environment we left that
we need to pee proxy settings to default

254
00:24:16,280 --> 00:24:20,510
so this is this is how you're supposed
like if you wanted Windows Update to go

255
00:24:20,510 --> 00:24:26,620
through a proxy you would set when HP
proxy settings so you can see this as a

256
00:24:26,620 --> 00:24:32,379
23 show proxy direct no proxy server so
that's how these were all set up and it

257
00:24:32,380 --> 00:24:36,040
seems like in Windows 10 and 7 2012 if
you have it set that way for the most

258
00:24:36,040 --> 00:24:43,399
part the Windows services actually do go
direct and don't use a proxy yeah so

259
00:24:43,400 --> 00:24:46,650
what ended up being disorganized as that
one is always having surprising

260
00:24:46,650 --> 00:24:56,500
discovery that's exactly what happened
here so basically like I just left the

261
00:24:56,500 --> 00:25:01,410
exploit running on our server 2012 box
and I ran out for the evening

262
00:25:01,410 --> 00:25:06,160
totally forgot I can just close out of
RTP and ran out and I came back the next

263
00:25:06,160 --> 00:25:12,679
day and I i had a system shell

264
00:25:12,679 --> 00:25:15,970
I had worked all day trying to get this
to work and I couldn't get anything

265
00:25:15,970 --> 00:25:26,499
working and I just came back and what
happened so we had obviously do a little

266
00:25:26,499 --> 00:25:30,320
bit of investigation broccoli I had some
debugging output being printed from the

267
00:25:30,320 --> 00:25:36,539
things that we kind of found out what
was going on so Windows has this new ish

268
00:25:36,539 --> 00:25:42,940
automatic updater untrusted certificate
and a link like to the MSCI an article

269
00:25:42,940 --> 00:25:47,879
for this is my blog post about this
stuff which is actually already up on

270
00:25:47,879 --> 00:25:54,168
the fact that security blogger guess but
basically what happened was it was

271
00:25:54,169 --> 00:25:59,490
trying to do these significant updates
sometime during the evening it tries to

272
00:25:59,490 --> 00:26:03,740
pull down this file this URL that you
see here disallowed certs et al doc appt

273
00:26:03,740 --> 00:26:09,080
so you can see in the screenshot it did
I get requests and then the whole thing

274
00:26:09,080 --> 00:26:11,559
went through it like relayed the
authentication yes and be less nervous

275
00:26:11,559 --> 00:26:16,678
system shell and it see it runs one
today and it seems like this is the only

276
00:26:16,679 --> 00:26:19,929
thing we could fine and they're probably
other things out there was the only

277
00:26:19,929 --> 00:26:23,690
thing we found in the short time we
allocated to researching this where

278
00:26:23,690 --> 00:26:27,659
Windows 10 and 7 2012 and all the new
versions of windows for some reason this

279
00:26:27,659 --> 00:26:33,499
crazy service still tried to use the W
Pat proxy settings even when Windows is

280
00:26:33,499 --> 00:26:52,120
set to direct access to the democrats

281
00:26:52,120 --> 00:27:02,520
2011 problem with this exploit is we
never actually found a way to get the

282
00:27:02,520 --> 00:27:06,550
same we never found a way to trigger
this manually like we can trigger it

283
00:27:06,550 --> 00:27:10,030
manually but you have to enter your
admin credentials but if you just wait

284
00:27:10,030 --> 00:27:16,940
for up to 24 hours worse case it will
trigger at some point by South I confirm

285
00:27:16,940 --> 00:27:20,110
this by you know I did this like three
times left it running overnight and sure

286
00:27:20,110 --> 00:27:24,020
enough every time it would trigger and
in the video I'm gonna cheat just a

287
00:27:24,020 --> 00:27:29,629
little bit show you guys how to get
those to fire off because I didn't wanna

288
00:27:29,630 --> 00:27:34,960
wake record for 24 hours and then
cropped out that we're gonna be here

289
00:27:34,960 --> 00:27:44,820
awhile I told the same thing checking
the user has not already been all that

290
00:27:44,820 --> 00:27:53,560
good stuff now running exploit so this
machine's IP is $10 or 15 gonna add that

291
00:27:53,560 --> 00:27:56,000
guide to the local admin group again

292
00:27:56,000 --> 00:28:12,060
disabling the Windows Defender update
check

293
00:28:12,060 --> 00:28:19,190
working properly and also something
about that the Mtns moving thing it's

294
00:28:19,190 --> 00:28:22,010
awesome that works like a hundred
percent effective at least against local

295
00:28:22,010 --> 00:28:31,550
host a Super affected our level over
9000 ok so what can I do to cheat is

296
00:28:31,550 --> 00:28:35,570
actually change the system clock to the
next day and I had to provide admin

297
00:28:35,570 --> 00:28:39,669
credentials but if you just left this
running I promise you it does our

298
00:28:39,670 --> 00:29:05,750
Christmas

299
00:29:05,750 --> 00:29:12,770
as soon as you hit the button and you
can see it's for that things he TLD lol

300
00:29:12,770 --> 00:29:17,180
disallowed search stock cab honestly
have no idea why that particular part of

301
00:29:17,180 --> 00:29:24,720
Windows Update still uses the W bad file
it's not supposed to end in a second in

302
00:29:24,720 --> 00:29:29,420
the in the video I think a actually I
check I double checked the win HP

303
00:29:29,420 --> 00:29:38,650
settings just to make sure it was set to
direct longer than this video skip a bit

304
00:29:38,650 --> 00:29:50,450
just type gas over on that terminal on
the on your left hand side so it's all

305
00:29:50,450 --> 00:30:06,210
set to direct so it totally shouldn't be
doing that but it's all those

306
00:30:06,210 --> 00:30:13,130
so that's that was pretty much it for
the experts challenged before so making

307
00:30:13,130 --> 00:30:18,410
all this stuff work the only reason this
was really difficult to throw together

308
00:30:18,410 --> 00:30:25,760
was because yeah a lot of existing tools
didn't seem to do a GPS Mb really well

309
00:30:25,760 --> 00:30:31,310
as Imperial 83 should do it it's worked
for me previously just wasn't working

310
00:30:31,310 --> 00:30:36,550
for me here so we decided to roll our
own thing if someone wants to try

311
00:30:36,550 --> 00:30:42,960
getting this whole thing working with us
and be related maybe you can not a ton

312
00:30:42,960 --> 00:30:47,460
of great libraries seems to exist to
interact with simpson SMB in this way so

313
00:30:47,460 --> 00:30:52,850
there is a good wine that's written in
Java and that's what we ended up using

314
00:30:52,850 --> 00:30:59,820
we ended up taking its called joseph's
and putting it over to see sharp and

315
00:30:59,820 --> 00:31:03,860
adding a whole bunch of stuff to it to
get it to do the stuff we need to do I

316
00:31:03,860 --> 00:31:06,590
don't know maybe there's a better way to
do it but that's what we did and it

317
00:31:06,590 --> 00:31:11,919
worked and we found windows can be
flaking and consistent you know like all

318
00:31:11,920 --> 00:31:14,350
those different things we have to do for
different version of the OS that took

319
00:31:14,350 --> 00:31:21,800
forever to get right so what were what
we're releasing today and what I think

320
00:31:21,800 --> 00:31:26,610
Justin is already posted to get her blog
and stuff so we listen I call the source

321
00:31:26,610 --> 00:31:30,360
code for all this stuff the source code
for all the libraries we use of the

322
00:31:30,360 --> 00:31:35,110
jasons library which is capable with
some modifications so the library is

323
00:31:35,110 --> 00:31:38,990
capable now to do HIV test and be
relayed you can like use the code for

324
00:31:38,990 --> 00:31:40,110
the potato

325
00:31:40,110 --> 00:31:46,729
exe project to find out how to use it to
do that this code was kinda like

326
00:31:46,730 --> 00:31:50,430
scrounge together from a few different
places so the project zero guys made a

327
00:31:50,430 --> 00:31:55,660
few modifications that Jason's library
in Java and then I took that and partly

328
00:31:55,660 --> 00:32:02,640
to share and did a few extra things to
it to make it to be exact and all that

329
00:32:02,640 --> 00:32:09,049
good stuff so whoever wants to work with
that feel free

330
00:32:09,049 --> 00:32:26,450
I don't think so yeah ok so now we get
into the bonus round of the stock semi

331
00:32:26,450 --> 00:32:30,879
related to the topic of privilege
escalation but not really just like came

332
00:32:30,879 --> 00:32:34,279
out of this project so I figured I'd
turn in here it's the new network

333
00:32:34,279 --> 00:32:44,470
attacks so it's we implemented this an
extension to the responded up ey to get

334
00:32:44,470 --> 00:32:54,450
there we go yeah so the first step in
the exploit to remember the localhost

335
00:32:54,450 --> 00:32:58,639
Mtns moving how we relate brute forcing
that TX idea in the packet well there's

336
00:32:58,639 --> 00:33:02,899
nothing to stop you from doing nothing
said network speeds and congestion and

337
00:33:02,899 --> 00:33:08,799
all that stuff to stop you from doing
that to any host anywhere so it's kind

338
00:33:08,799 --> 00:33:13,539
of cool like you can do Mb if you use
this you can do Mtns moving to any host

339
00:33:13,539 --> 00:33:20,529
to it you can talk to UDP port 137 you
can even tried on host on the Internet

340
00:33:20,529 --> 00:33:24,080
it might look like a denial of service
attack but you could give it a shot

341
00:33:24,080 --> 00:33:31,279
we have had it work internally on some
networks still a bit noisy but you know

342
00:33:31,279 --> 00:33:39,249
if you're not you're not breaking
anything then why not only are you doing

343
00:33:39,249 --> 00:33:43,429
is flooding a target host with NBN s
response packets and you're just

344
00:33:43,429 --> 00:33:47,929
incrementing that TX I D and you're
hoping like you can pick up mostly you

345
00:33:47,929 --> 00:33:52,289
know they're going to be looking for
like W patter like I don't know they're

346
00:33:52,289 --> 00:33:56,070
there are few common ones like you'll
see you'll see if you sniff in Wireshark

347
00:33:56,070 --> 00:34:01,428
on a network and you look at like what
kind of Mtns requests are being made on

348
00:34:01,429 --> 00:34:04,580
your your local broadcast segments you
could look at those and then you could

349
00:34:04,580 --> 00:34:09,179
say oh well you know I bet that on this
other network segment at the same client

350
00:34:09,179 --> 00:34:12,059
there's probably this target server that
I wanna head he's probably making that

351
00:34:12,059 --> 00:34:16,780
same request so you just flood him with
replies for that request and it actually

352
00:34:16,780 --> 00:34:17,639
does work

353
00:34:17,639 --> 00:34:25,220
actually and I have a video that i'm
gonna show so yeah it's it's noisy in

354
00:34:25,219 --> 00:34:30,638
the in the demo setup that we have for
the video that are kind of virtualized

355
00:34:30,639 --> 00:34:37,639
so I have a pfSense firewall that ended
000 network is the corporate land

356
00:34:37,639 --> 00:34:43,639
simulated corporate land 10 2010 is kind
of like the server network and from the

357
00:34:43,639 --> 00:34:46,319
corporate network I'm going to attack
one of the machines on the server

358
00:34:46,319 --> 00:35:03,710
network go back to video mode so this is
a modified version responded that we're

359
00:35:03,710 --> 00:35:10,079
going to be running so that's my IP
address of the machine is going to be

360
00:35:10,079 --> 00:35:21,720
doing the attacking I just tried to show
that he was on a different network so I

361
00:35:21,720 --> 00:35:26,439
had to jump through the firewall that's
the machine this is these windows server

362
00:35:26,440 --> 00:35:29,990
they were going to be attacking and the
hostname we're gonna be trying to spoof

363
00:35:29,990 --> 00:35:39,359
is ninjas so an opinion doesn't show
that the request times out

364
00:35:39,360 --> 00:35:48,600
and so this is a this is the extension
to the responder to also added the spoof

365
00:35:48,600 --> 00:36:05,529
flag then packets to want 10015 the Mtns
responses going to say that it's 1000

366
00:36:05,530 --> 00:36:09,880
like to and i was just a flood that I
mean its response and now we paying

367
00:36:09,880 --> 00:36:33,030
ninjas again it works so you actually
get a little bit early April I guess I

368
00:36:33,030 --> 00:36:35,650
went to the videos little faster than
expected but does anyone have any

369
00:36:35,650 --> 00:36:45,960
questions or comments

370
00:36:45,960 --> 00:36:58,349
no actually I didn't look at that so if
you saw the question was if we looked at

371
00:36:58,349 --> 00:37:03,109
the behavior if the system proxy
settings for Windows Update win HTTP

372
00:37:03,109 --> 00:37:06,359
we're actually already set to something

373
00:37:06,359 --> 00:37:10,549
no i didnt look at that and I'm not sure
how it behaves it could totally ignore

374
00:37:10,550 --> 00:37:15,040
the W Pat south or maybe you know it's
already supposed to be ignoring W pad so

375
00:37:15,040 --> 00:37:24,400
maybe it still use it I don't know

376
00:37:24,400 --> 00:37:35,790
sorry I missed the so the question was
if you have SSL enabled for your update

377
00:37:35,790 --> 00:37:41,890
server on the network would interrupt
this this attack so I think the W pad

378
00:37:41,890 --> 00:37:47,910
stop would still work but Windows Update
if you're forcing SSL the Windows Update

379
00:37:47,910 --> 00:37:56,859
stuff might fail yet so I don't know
like I would guess that Windows probably

380
00:37:56,860 --> 00:38:02,560
does validate that's so you can't just
have like anything but yeah I don't know

381
00:38:02,560 --> 00:38:19,259
I haven't tested it I don't think it
would work maybe anything else

382
00:38:19,260 --> 00:38:25,000
yeah so the question was about the the
addition to responder we're going to be

383
00:38:25,000 --> 00:38:28,410
releasing that we actually already
released it on the foxglove security

384
00:38:28,410 --> 00:38:33,379
blog foxy Knoxy care.com so it you know
that we have a blog post on all this and

385
00:38:33,380 --> 00:38:37,210
we link to our get home page where we
released all the code and that includes

386
00:38:37,210 --> 00:38:42,610
the addition to the responder to be cool
like if someone it was fun to actually

387
00:38:42,610 --> 00:38:46,120
emerged that in but I mean they can do
what they want you know it's up to them

388
00:38:46,120 --> 00:39:05,380
or anything else

389
00:39:05,380 --> 00:39:08,550
so the question is about the eighty
hours between the corporate in server

390
00:39:08,550 --> 00:39:16,160
networks actually specifically allowed
in that case UDP 137 so that the

391
00:39:16,160 --> 00:39:20,230
situation is and what we see a lot of
clients is that you know you have a

392
00:39:20,230 --> 00:39:24,130
server and a corporate machine on a
different broadcast on me but they won't

393
00:39:24,130 --> 00:39:27,450
actually be any firewall rules between
them so that's kind of the situation we

394
00:39:27,450 --> 00:39:31,490
built this for its not really for like
you know it's it's pretty unlikely that

395
00:39:31,490 --> 00:39:35,109
someone's gonna say allow UDP 137 when
they actually have a real fire wall

396
00:39:35,110 --> 00:39:39,310
that's doing any sort of real filtering
but what we see a lot as a machine we

397
00:39:39,310 --> 00:39:45,580
want to attack and we can hit every
single part by its just on a different

398
00:39:45,580 --> 00:39:49,270
broadcast on me so that's kind of the
attack that showed that this is would be

399
00:39:49,270 --> 00:39:55,800
most commonly used for things like ice

