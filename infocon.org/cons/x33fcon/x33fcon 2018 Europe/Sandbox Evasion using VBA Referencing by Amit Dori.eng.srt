1
00:00:06,410 --> 00:00:11,450
[Music]

2
00:00:08,138 --> 00:00:13,250
so let's begin<font color="#CCCCCC"> my name is Emil thank you</font>

3
00:00:11,450 --> 00:00:16,539
very much for<font color="#E5E5E5"> having me</font><font color="#CCCCCC"> I'm very</font><font color="#E5E5E5"> happy</font>

4
00:00:13,250 --> 00:00:20,119
to be<font color="#CCCCCC"> here first time in</font><font color="#E5E5E5"> Virginia and</font>

5
00:00:16,539 --> 00:00:22,009
today<font color="#E5E5E5"> I'll present a new way to perform</font>

6
00:00:20,119 --> 00:00:26,320
sandbox<font color="#E5E5E5"> evasion introducing VBA</font>

7
00:00:22,009 --> 00:00:29,509
referencing along the way and my key

8
00:00:26,320 --> 00:00:32,560
point in<font color="#E5E5E5"> this presentation I guess is I</font>

9
00:00:29,509 --> 00:00:34,850
want<font color="#CCCCCC"> to introduce a</font><font color="#E5E5E5"> new approach to</font>

10
00:00:32,560 --> 00:00:36,740
<font color="#E5E5E5">sandbox evasion to a new approach</font><font color="#CCCCCC"> to</font>

11
00:00:34,850 --> 00:00:39,320
<font color="#E5E5E5">detect the sandbox and a new approach to</font>

12
00:00:36,740 --> 00:00:40,940
<font color="#E5E5E5">evade the sandbox</font><font color="#CCCCCC"> and I</font><font color="#E5E5E5"> think this is</font>

13
00:00:39,320 --> 00:00:43,550
specifically<font color="#E5E5E5"> relevant for this</font>

14
00:00:40,940 --> 00:00:48,670
<font color="#E5E5E5">conference as blue and red teams have</font>

15
00:00:43,550 --> 00:00:52,040
met together<font color="#E5E5E5"> to discuss these topics so</font>

16
00:00:48,670 --> 00:00:54,920
as I said<font color="#CCCCCC"> my name is</font><font color="#E5E5E5"> Amit</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> I'm from</font>

17
00:00:52,040 --> 00:00:58,390
Tel Aviv<font color="#E5E5E5"> Israel</font><font color="#CCCCCC"> not chin</font><font color="#E5E5E5"> but not Mossad</font>

18
00:00:54,920 --> 00:01:02,660
<font color="#CCCCCC">I'm not lying to you I</font><font color="#E5E5E5"> promise</font><font color="#CCCCCC"> I walk at</font>

19
00:00:58,390 --> 00:01:04,640
vote Evo as a security<font color="#CCCCCC"> researcher and</font><font color="#E5E5E5"> I</font>

20
00:01:02,660 --> 00:01:07,880
used to walk for checkpoint before<font color="#E5E5E5"> that</font>

21
00:01:04,640 --> 00:01:11,179
studying exploit kids and I like to

22
00:01:07,880 --> 00:01:14,539
skate<font color="#CCCCCC"> I used to</font><font color="#E5E5E5"> skate</font><font color="#CCCCCC"> I swim and I play</font>

23
00:01:11,179 --> 00:01:18,170
the<font color="#E5E5E5"> guitar and my</font><font color="#CCCCCC"> co researcher in this</font>

24
00:01:14,539 --> 00:01:22,609
research is our CEO<font color="#E5E5E5"> Aviv who couldn't be</font>

25
00:01:18,170 --> 00:01:24,859
<font color="#CCCCCC">here today and as I said</font><font color="#E5E5E5"> we will be</font>

26
00:01:22,609 --> 00:01:27,798
talking about sandboxes and sandbox

27
00:01:24,859 --> 00:01:31,280
<font color="#E5E5E5">evasion and the main motivation for</font><font color="#CCCCCC"> this</font>

28
00:01:27,799 --> 00:01:33,619
research was<font color="#CCCCCC"> the fact that</font><font color="#E5E5E5"> sand boxes</font>

29
00:01:31,280 --> 00:01:34,999
have<font color="#CCCCCC"> become so widely</font><font color="#E5E5E5"> used in the</font>

30
00:01:33,619 --> 00:01:37,850
<font color="#CCCCCC">industry I mean almost every</font>

31
00:01:34,999 --> 00:01:40,130
<font color="#E5E5E5">organization</font><font color="#CCCCCC"> have a</font><font color="#E5E5E5"> sandbox nowadays and</font>

32
00:01:37,850 --> 00:01:43,249
<font color="#E5E5E5">it's trusted so which means if the file</font>

33
00:01:40,130 --> 00:01:45,589
has<font color="#E5E5E5"> passed the sandbox</font><font color="#CCCCCC"> and the user</font>

34
00:01:43,249 --> 00:01:48,350
<font color="#CCCCCC">quite usually thinks that the file is</font>

35
00:01:45,590 --> 00:01:50,569
safe and<font color="#E5E5E5"> you</font><font color="#CCCCCC"> can</font><font color="#E5E5E5"> open it</font><font color="#CCCCCC"> and no problem</font>

36
00:01:48,350 --> 00:01:52,908
whatsoever<font color="#CCCCCC"> and so we have sandbox</font>

37
00:01:50,569 --> 00:01:55,549
<font color="#E5E5E5">evasion techniques and I will show a</font><font color="#CCCCCC"> new</font>

38
00:01:52,909 --> 00:01:59,659
way and unlike common sandbox<font color="#E5E5E5"> evasion</font>

39
00:01:55,549 --> 00:02:04,670
techniques what<font color="#E5E5E5"> we came</font><font color="#CCCCCC"> up with doesn't</font>

40
00:01:59,659 --> 00:02:07,490
require code execution at all so<font color="#E5E5E5"> just to</font>

41
00:02:04,670 --> 00:02:08,929
set things<font color="#E5E5E5"> straight before we begin I'm</font>

42
00:02:07,490 --> 00:02:12,140
gonna jump between<font color="#CCCCCC"> topics and</font><font color="#E5E5E5"> I don't</font>

43
00:02:08,929 --> 00:02:14,780
<font color="#E5E5E5">want to confuse anyone</font><font color="#CCCCCC"> so if you see the</font>

44
00:02:12,140 --> 00:02:16,579
icon<font color="#E5E5E5"> of this little guy running he is</font>

45
00:02:14,780 --> 00:02:17,090
trying<font color="#E5E5E5"> to evade something so this is</font>

46
00:02:16,580 --> 00:02:19,310
<font color="#E5E5E5">relevant</font>

47
00:02:17,090 --> 00:02:21,650
<font color="#E5E5E5">- evasion and we will talk about evasion</font>

48
00:02:19,310 --> 00:02:24,200
techniques and<font color="#CCCCCC"> vba referencing in terms</font>

49
00:02:21,650 --> 00:02:26,840
of evasion<font color="#CCCCCC"> and if you see this</font>

50
00:02:24,200 --> 00:02:30,649
magnifying<font color="#E5E5E5"> glass it's about detecting a</font>

51
00:02:26,840 --> 00:02:39,440
sandbox<font color="#E5E5E5"> and we'll talk about that in</font><font color="#CCCCCC"> a</font>

52
00:02:30,650 --> 00:02:41,480
sec usually when<font color="#E5E5E5"> we talk about</font><font color="#CCCCCC"> sandbox</font>

53
00:02:39,440 --> 00:02:44,900
<font color="#E5E5E5">the following topics might come to mind</font>

54
00:02:41,480 --> 00:02:47,810
<font color="#E5E5E5">and I</font><font color="#CCCCCC"> talk about</font><font color="#E5E5E5"> office and VBA as well</font>

55
00:02:44,900 --> 00:02:49,310
and I'm I won't be<font color="#E5E5E5"> getting into any of</font>

56
00:02:47,810 --> 00:02:52,220
these<font color="#CCCCCC"> topics but please feel free to</font>

57
00:02:49,310 --> 00:02:55,040
<font color="#E5E5E5">contact me offline or by email if you</font>

58
00:02:52,220 --> 00:02:58,310
have<font color="#CCCCCC"> any further questions so I won't be</font>

59
00:02:55,040 --> 00:03:00,829
discussing<font color="#E5E5E5"> in length VBA macros Visual</font>

60
00:02:58,310 --> 00:03:03,830
Basic for applications or the<font color="#CCCCCC"> office</font>

61
00:03:00,830 --> 00:03:05,900
protected view as a general and we won't

62
00:03:03,830 --> 00:03:07,489
talk about sandbox solutions and the

63
00:03:05,900 --> 00:03:09,739
general concept<font color="#E5E5E5"> of a sandbox and</font>

64
00:03:07,489 --> 00:03:12,049
tracking<font color="#CCCCCC"> pixel</font><font color="#E5E5E5"> so I'm a guessing the</font>

65
00:03:09,739 --> 00:03:14,420
audience is familiar<font color="#CCCCCC"> with these</font><font color="#E5E5E5"> topics</font>

66
00:03:12,049 --> 00:03:16,010
<font color="#E5E5E5">if not please feel free to contact me</font><font color="#CCCCCC"> my</font>

67
00:03:14,420 --> 00:03:19,339
details<font color="#E5E5E5"> would</font><font color="#CCCCCC"> be at the</font><font color="#E5E5E5"> end of this</font>

68
00:03:16,010 --> 00:03:23,390
<font color="#E5E5E5">presentation</font><font color="#CCCCCC"> and I'll be happy to answer</font>

69
00:03:19,340 --> 00:03:30,410
so let's start with sandbox evasion

70
00:03:23,390 --> 00:03:33,350
<font color="#E5E5E5">techniques as they are today</font><font color="#CCCCCC"> and at the</font>

71
00:03:30,410 --> 00:03:35,989
beginning<font color="#CCCCCC"> there were just malware</font><font color="#E5E5E5"> right</font>

72
00:03:33,350 --> 00:03:37,608
and everything was fun and then<font color="#E5E5E5"> sand</font>

73
00:03:35,989 --> 00:03:40,160
<font color="#E5E5E5">boxes have began to being used in the</font>

74
00:03:37,609 --> 00:03:41,870
<font color="#E5E5E5">industry and</font><font color="#CCCCCC"> malware authors have begun</font>

75
00:03:40,160 --> 00:03:45,019
<font color="#CCCCCC">to use sandbox</font><font color="#E5E5E5"> evasion techniques and</font>

76
00:03:41,870 --> 00:03:47,720
the term sandbox<font color="#E5E5E5"> evasion usually is</font>

77
00:03:45,019 --> 00:03:51,620
being used<font color="#E5E5E5"> to describe every way you can</font>

78
00:03:47,720 --> 00:03:54,380
to detect or manipulate or evade or

79
00:03:51,620 --> 00:03:57,739
trick<font color="#CCCCCC"> or whatever</font><font color="#E5E5E5"> world you can come up</font>

80
00:03:54,380 --> 00:03:59,750
for a malware to trying<font color="#CCCCCC"> to trick a</font>

81
00:03:57,739 --> 00:04:01,370
sandbox and this is literally what

82
00:03:59,750 --> 00:04:03,079
happens when you use sandbox<font color="#E5E5E5"> evasion</font>

83
00:04:01,370 --> 00:04:06,350
it's either to detect the sandbox or

84
00:04:03,079 --> 00:04:08,239
evade it<font color="#E5E5E5"> all both so let's go over</font><font color="#CCCCCC"> some</font>

85
00:04:06,350 --> 00:04:10,549
of<font color="#E5E5E5"> sandbox evasion techniques as they</font>

86
00:04:08,239 --> 00:04:12,590
are being<font color="#CCCCCC"> used</font><font color="#E5E5E5"> today and</font><font color="#CCCCCC"> I'm actually</font>

87
00:04:10,549 --> 00:04:16,280
<font color="#CCCCCC">quoting a very good presentation from</font>

88
00:04:12,590 --> 00:04:18,200
first conference 2017 it's called

89
00:04:16,279 --> 00:04:22,250
countering innovative sandbox<font color="#E5E5E5"> evasion</font>

90
00:04:18,200 --> 00:04:25,419
techniques used by malware and we'll

91
00:04:22,250 --> 00:04:27,870
start with evasion<font color="#E5E5E5"> with detection sorry</font>

92
00:04:25,419 --> 00:04:32,460
that's a mistake

93
00:04:27,870 --> 00:04:35,820
okay so<font color="#E5E5E5"> usually</font><font color="#CCCCCC"> send boxes</font><font color="#E5E5E5"> virtualized</font>

94
00:04:32,460 --> 00:04:38,370
products<font color="#CCCCCC"> it's being</font><font color="#E5E5E5"> used on incoming</font>

95
00:04:35,820 --> 00:04:40,320
<font color="#E5E5E5">files on the inbound traffic to the</font>

96
00:04:38,370 --> 00:04:41,940
organization in<font color="#CCCCCC"> order to prevent</font>

97
00:04:40,320 --> 00:04:44,940
malicious files from entering the

98
00:04:41,940 --> 00:04:46,320
organization so<font color="#E5E5E5"> you set up a virtualized</font>

99
00:04:44,940 --> 00:04:47,790
environment and you let the file is

100
00:04:46,320 --> 00:04:49,680
<font color="#E5E5E5">executed in this environment</font>

101
00:04:47,790 --> 00:04:51,600
so because it's a virtualized

102
00:04:49,680 --> 00:04:53,310
environment<font color="#CCCCCC"> I can look</font><font color="#E5E5E5"> for virtualized</font>

103
00:04:51,600 --> 00:04:55,410
<font color="#E5E5E5">artifacts I can look at the hypervisor</font>

104
00:04:53,310 --> 00:04:58,979
<font color="#CCCCCC">and trying to understand if it's a</font>

105
00:04:55,410 --> 00:05:02,100
physical hypervisor<font color="#E5E5E5"> or virtual one for</font>

106
00:04:58,979 --> 00:05:03,810
example<font color="#CCCCCC"> VMware or VirtualBox</font><font color="#E5E5E5"> or this</font>

107
00:05:02,100 --> 00:05:06,810
kind of hypervisor<font color="#CCCCCC"> I can look for</font>

108
00:05:03,810 --> 00:05:10,080
<font color="#E5E5E5">virtualizing dll's if it's a virtualized</font>

109
00:05:06,810 --> 00:05:14,160
product<font color="#CCCCCC"> it</font><font color="#E5E5E5"> has it must have some drivers</font>

110
00:05:10,080 --> 00:05:16,849
to support it and so on another<font color="#E5E5E5"> thing I</font>

111
00:05:14,160 --> 00:05:20,160
can use inside channel attacks<font color="#E5E5E5"> I can</font>

112
00:05:16,850 --> 00:05:21,750
figure in advance the CPU<font color="#E5E5E5"> tick of a</font>

113
00:05:20,160 --> 00:05:23,610
physical<font color="#CCCCCC"> machine and compare it to the</font>

114
00:05:21,750 --> 00:05:25,410
CPU tick of the<font color="#E5E5E5"> machine I'm currently at</font>

115
00:05:23,610 --> 00:05:27,210
and<font color="#CCCCCC"> compare those</font><font color="#E5E5E5"> and</font><font color="#CCCCCC"> if it's a</font>

116
00:05:25,410 --> 00:05:29,070
virtualized machine<font color="#E5E5E5"> it should be</font>

117
00:05:27,210 --> 00:05:31,950
<font color="#E5E5E5">different than the physical machine and</font>

118
00:05:29,070 --> 00:05:36,000
so forth<font color="#E5E5E5"> and another thing I can do is</font>

119
00:05:31,950 --> 00:05:38,610
look at the hardware does this how to

120
00:05:36,000 --> 00:05:41,250
<font color="#CCCCCC">setup</font><font color="#E5E5E5"> make sense I mean if it's a</font>

121
00:05:38,610 --> 00:05:44,700
genuine user machine it makes no sense

122
00:05:41,250 --> 00:05:47,190
<font color="#CCCCCC">for</font><font color="#E5E5E5"> me to</font><font color="#CCCCCC"> have 20 gigs of disk</font><font color="#E5E5E5"> space or</font>

123
00:05:44,700 --> 00:05:49,380
<font color="#E5E5E5">2 gigs of</font><font color="#CCCCCC"> RAM because</font><font color="#E5E5E5"> it's not so common</font>

124
00:05:47,190 --> 00:05:50,639
<font color="#E5E5E5">today and in</font><font color="#CCCCCC"> virtualized machine it's</font>

125
00:05:49,380 --> 00:05:53,940
actually quite<font color="#CCCCCC"> common because</font><font color="#E5E5E5"> you want</font>

126
00:05:50,639 --> 00:05:55,919
<font color="#E5E5E5">to spare your resources</font><font color="#CCCCCC"> so that's</font><font color="#E5E5E5"> number</font>

127
00:05:53,940 --> 00:06:03,410
<font color="#E5E5E5">one and number</font><font color="#CCCCCC"> two I can look at the</font>

128
00:05:55,919 --> 00:06:05,969
environment and<font color="#CCCCCC"> I can say</font><font color="#E5E5E5"> okay how how</font>

129
00:06:03,410 --> 00:06:07,950
artificial this<font color="#E5E5E5"> environment is I mean</font>

130
00:06:05,970 --> 00:06:10,260
does<font color="#CCCCCC"> it make sense does it looks like a</font>

131
00:06:07,950 --> 00:06:12,270
genuine users<font color="#CCCCCC"> environment</font><font color="#E5E5E5"> I can look at</font>

132
00:06:10,260 --> 00:06:14,400
the<font color="#E5E5E5"> user name</font><font color="#CCCCCC"> I can look</font><font color="#E5E5E5"> at the recent</font>

133
00:06:12,270 --> 00:06:16,469
<font color="#CCCCCC">func recent file</font><font color="#E5E5E5"> code and screen</font>

134
00:06:14,400 --> 00:06:19,109
resolution<font color="#E5E5E5"> check the cookies and browser</font>

135
00:06:16,470 --> 00:06:23,039
history if<font color="#CCCCCC"> they exist I can look at</font>

136
00:06:19,110 --> 00:06:26,039
running<font color="#CCCCCC"> processes and say ok if I</font>

137
00:06:23,039 --> 00:06:28,229
encounter the Wireshark<font color="#E5E5E5"> or process</font>

138
00:06:26,039 --> 00:06:29,880
monitor<font color="#CCCCCC"> all process Explorer</font><font color="#E5E5E5"> then this</font>

139
00:06:28,229 --> 00:06:32,340
<font color="#E5E5E5">most likely is a security researcher</font>

140
00:06:29,880 --> 00:06:35,700
trying to analyze my malware<font color="#E5E5E5"> and I don't</font>

141
00:06:32,340 --> 00:06:37,349
<font color="#E5E5E5">want to infect this machine and one</font>

142
00:06:35,700 --> 00:06:40,229
final<font color="#E5E5E5"> thing</font><font color="#CCCCCC"> that's really cool actually</font>

143
00:06:37,349 --> 00:06:41,750
<font color="#E5E5E5">is looking for all vulnerable</font><font color="#CCCCCC"> ities so I</font>

144
00:06:40,229 --> 00:06:44,930
have my malware trying

145
00:06:41,750 --> 00:06:47,960
to exploit a very old vulnerability<font color="#CCCCCC"> and</font>

146
00:06:44,930 --> 00:06:49,970
if it succeeds<font color="#CCCCCC"> it means that this</font>

147
00:06:47,960 --> 00:06:51,890
environment<font color="#CCCCCC"> is vulnerable to a very old</font>

148
00:06:49,970 --> 00:06:53,420
vulnerability which makes<font color="#CCCCCC"> no sense if</font>

149
00:06:51,890 --> 00:06:55,760
<font color="#CCCCCC">it's user the user must have patched</font>

150
00:06:53,420 --> 00:06:57,980
this vulnerability beforehand<font color="#E5E5E5"> so this</font>

151
00:06:55,760 --> 00:07:00,890
<font color="#E5E5E5">most likely</font><font color="#CCCCCC"> an artificial environment</font>

152
00:06:57,980 --> 00:07:03,770
<font color="#E5E5E5">used to test my marvel and I don't want</font>

153
00:07:00,890 --> 00:07:05,900
to infect this<font color="#E5E5E5"> environment so these are</font>

154
00:07:03,770 --> 00:07:10,130
all used for detection<font color="#E5E5E5"> and we can</font>

155
00:07:05,900 --> 00:07:12,289
actually<font color="#E5E5E5"> see this tool called paranoid</font>

156
00:07:10,130 --> 00:07:14,390
fish<font color="#CCCCCC"> I'm guessing some of</font><font color="#E5E5E5"> you know it</font>

157
00:07:12,290 --> 00:07:17,090
it's used<font color="#E5E5E5"> by security</font><font color="#CCCCCC"> researchers to</font>

158
00:07:14,390 --> 00:07:20,450
test their environment so<font color="#CCCCCC"> you execute</font>

159
00:07:17,090 --> 00:07:22,099
this code in<font color="#CCCCCC"> your environment</font><font color="#E5E5E5"> and it</font>

160
00:07:20,450 --> 00:07:24,229
looks for some of the stuff that we've

161
00:07:22,100 --> 00:07:27,710
talked about<font color="#E5E5E5"> it looks the hypervisor</font><font color="#CCCCCC"> in</font>

162
00:07:24,230 --> 00:07:32,630
CPU<font color="#E5E5E5"> it checks</font><font color="#CCCCCC"> user name file path Mouse</font>

163
00:07:27,710 --> 00:07:36,140
activity<font color="#E5E5E5"> and disk size and so forth so</font>

164
00:07:32,630 --> 00:07:41,000
this covers<font color="#CCCCCC"> the</font><font color="#E5E5E5"> detection part and we</font>

165
00:07:36,140 --> 00:07:43,640
<font color="#E5E5E5">can move on to evasion well I can</font>

166
00:07:41,000 --> 00:07:45,760
analyze<font color="#E5E5E5"> the product I'm trying to evade</font>

167
00:07:43,640 --> 00:07:51,169
<font color="#E5E5E5">and go around it for example most</font>

168
00:07:45,760 --> 00:07:53,270
<font color="#E5E5E5">sandboxes uses hooks and if I know what</font>

169
00:07:51,169 --> 00:07:56,330
those hooks are I can either remove them

170
00:07:53,270 --> 00:07:58,820
<font color="#CCCCCC">altogether or rock</font><font color="#E5E5E5"> around them I can use</font>

171
00:07:56,330 --> 00:08:02,599
different<font color="#E5E5E5"> API calls</font><font color="#CCCCCC"> or functions</font><font color="#E5E5E5"> that</font>

172
00:07:58,820 --> 00:08:06,440
are not<font color="#E5E5E5"> hooked and I can delay execution</font>

173
00:08:02,600 --> 00:08:07,970
sorry<font color="#E5E5E5"> for example using</font><font color="#CCCCCC"> sleep but sleep</font>

174
00:08:06,440 --> 00:08:10,880
is a known trick by now so I can count

175
00:08:07,970 --> 00:08:14,210
Fibonacci numbers<font color="#E5E5E5"> and so on and another</font>

176
00:08:10,880 --> 00:08:15,950
thing I can do is force user interaction

177
00:08:14,210 --> 00:08:18,770
of user behavior on a virtualized

178
00:08:15,950 --> 00:08:20,870
machine<font color="#E5E5E5"> and I can say</font><font color="#CCCCCC"> okay</font><font color="#E5E5E5"> I want the</font>

179
00:08:18,770 --> 00:08:25,880
user<font color="#E5E5E5"> I want</font><font color="#CCCCCC"> the Mallo to execute after</font>

180
00:08:20,870 --> 00:08:28,160
<font color="#E5E5E5">three clicks on the GUI interface and so</font>

181
00:08:25,880 --> 00:08:29,810
forth<font color="#E5E5E5"> so I can require user interaction</font>

182
00:08:28,160 --> 00:08:32,450
I can check the date and time zone to

183
00:08:29,810 --> 00:08:35,000
see if it makes<font color="#E5E5E5"> sense or if I can target</font>

184
00:08:32,450 --> 00:08:38,240
<font color="#E5E5E5">my user according to the time the date</font>

185
00:08:35,000 --> 00:08:40,849
and time<font color="#E5E5E5"> and anchor payloads and so</font>

186
00:08:38,240 --> 00:08:42,620
forth<font color="#E5E5E5"> so this is pretty much for</font>

187
00:08:40,849 --> 00:08:44,660
detection<font color="#CCCCCC"> and evasion the thing</font><font color="#E5E5E5"> about</font>

188
00:08:42,620 --> 00:08:49,010
these techniques which are being<font color="#CCCCCC"> used</font>

189
00:08:44,660 --> 00:08:51,230
today<font color="#E5E5E5"> is most of them require code</font>

190
00:08:49,010 --> 00:08:53,750
execution so I have to get my code

191
00:08:51,230 --> 00:08:55,080
running within the<font color="#CCCCCC"> sandbox and then my</font>

192
00:08:53,750 --> 00:08:57,210
code collects

193
00:08:55,080 --> 00:09:00,390
all<font color="#E5E5E5"> sorts of data trying to fingerprint</font>

194
00:08:57,210 --> 00:09:03,000
<font color="#E5E5E5">the system and once it does it can</font>

195
00:09:00,390 --> 00:09:05,220
decide if<font color="#E5E5E5"> it's a user of a sandbox and</font>

196
00:09:03,000 --> 00:09:08,430
then act<font color="#E5E5E5"> accordingly if it's a sandbox</font>

197
00:09:05,220 --> 00:09:11,610
<font color="#CCCCCC">it will abort execution</font><font color="#E5E5E5"> if</font><font color="#CCCCCC"> its user it</font>

198
00:09:08,430 --> 00:09:14,489
will<font color="#E5E5E5"> infect the</font><font color="#CCCCCC"> machine and the thing</font><font color="#E5E5E5"> is</font>

199
00:09:11,610 --> 00:09:18,060
sandbox is nowadays<font color="#E5E5E5"> are able to identify</font>

200
00:09:14,490 --> 00:09:20,250
sandbox evasion<font color="#E5E5E5"> techniques so if I don't</font>

201
00:09:18,060 --> 00:09:22,229
bother<font color="#E5E5E5"> to obfuscate my code static</font>

202
00:09:20,250 --> 00:09:25,260
analysis tools can actually analyze my

203
00:09:22,230 --> 00:09:28,050
code<font color="#CCCCCC"> and say</font><font color="#E5E5E5"> okay he is trying to do a B</font>

204
00:09:25,260 --> 00:09:30,060
<font color="#CCCCCC">and C it's a suspicious behavior I'm not</font>

205
00:09:28,050 --> 00:09:31,920
gonna even bother<font color="#E5E5E5"> executing it it looks</font>

206
00:09:30,060 --> 00:09:34,410
suspicious<font color="#CCCCCC"> enough I'm gonna block it</font><font color="#E5E5E5"> and</font>

207
00:09:31,920 --> 00:09:36,270
if I did obfuscate my code<font color="#CCCCCC"> so the</font>

208
00:09:34,410 --> 00:09:40,230
sandbox<font color="#E5E5E5"> as a sandbox</font><font color="#CCCCCC"> environment will</font>

209
00:09:36,270 --> 00:09:42,270
execute it<font color="#E5E5E5"> and analyze my behavior and</font>

210
00:09:40,230 --> 00:09:44,820
say<font color="#CCCCCC"> okay this is a suspicious behavior</font>

211
00:09:42,270 --> 00:09:47,819
he's trying to fingerprint me<font color="#CCCCCC"> I don't</font>

212
00:09:44,820 --> 00:09:52,370
know what's going on<font color="#CCCCCC"> I'm gonna flag it</font>

213
00:09:47,820 --> 00:09:54,900
<font color="#E5E5E5">as suspicious</font><font color="#CCCCCC"> anyway so nowadays we have</font>

214
00:09:52,370 --> 00:09:56,580
<font color="#CCCCCC">sandbox as being able to detect sandbox</font>

215
00:09:54,900 --> 00:09:59,220
evasion<font color="#E5E5E5"> techniques and the process never</font>

216
00:09:56,580 --> 00:10:01,440
ends<font color="#E5E5E5"> Marvel authors provide new sandbox</font>

217
00:09:59,220 --> 00:10:04,110
evasion techniques sandbox says

218
00:10:01,440 --> 00:10:08,670
blocked them and the<font color="#E5E5E5"> will keeps on</font>

219
00:10:04,110 --> 00:10:13,520
turning and we try<font color="#E5E5E5"> to produce a new way</font>

220
00:10:08,670 --> 00:10:20,430
<font color="#CCCCCC">to perform sandbox</font><font color="#E5E5E5"> evasion altogether so</font>

221
00:10:13,520 --> 00:10:23,400
so it feels<font color="#E5E5E5"> like my bar mitzva okay okay</font>

222
00:10:20,430 --> 00:10:25,160
<font color="#CCCCCC">VI referencing will be a visual basic</font>

223
00:10:23,400 --> 00:10:27,750
for applications<font color="#E5E5E5"> it's a very known</font>

224
00:10:25,160 --> 00:10:29,459
concept it's being used in the<font color="#CCCCCC"> industry</font>

225
00:10:27,750 --> 00:10:33,600
for<font color="#E5E5E5"> a long time it's</font><font color="#CCCCCC"> been developed</font>

226
00:10:29,460 --> 00:10:35,930
since the 90s<font color="#CCCCCC"> I guess</font><font color="#E5E5E5"> and it has all</font>

227
00:10:33,600 --> 00:10:38,790
<font color="#CCCCCC">sorts of capabilities that not most use</font>

228
00:10:35,930 --> 00:10:42,089
sorry that most users<font color="#CCCCCC"> are not aware of</font>

229
00:10:38,790 --> 00:10:45,150
and in order to<font color="#CCCCCC"> truly understand its</font>

230
00:10:42,090 --> 00:10:48,090
capabilities you have<font color="#E5E5E5"> to read this</font>

231
00:10:45,150 --> 00:10:50,400
<font color="#CCCCCC">document the MSL vbi document which is</font>

232
00:10:48,090 --> 00:10:54,120
<font color="#E5E5E5">not so nice it's the documentation by</font>

233
00:10:50,400 --> 00:10:57,689
office<font color="#E5E5E5"> 111 pages and they update</font><font color="#CCCCCC"> it</font>

234
00:10:54,120 --> 00:11:00,810
every<font color="#E5E5E5"> now and then and it details all</font>

235
00:10:57,690 --> 00:11:02,070
<font color="#CCCCCC">the information you can all the</font>

236
00:11:00,810 --> 00:11:05,510
capabilities<font color="#CCCCCC"> and features</font><font color="#E5E5E5"> you have</font>

237
00:11:02,070 --> 00:11:09,390
within Visual Basic for applications<font color="#E5E5E5"> so</font>

238
00:11:05,510 --> 00:11:12,660
<font color="#E5E5E5">VBA is actually a binary file it's a</font>

239
00:11:09,390 --> 00:11:18,210
file format<font color="#E5E5E5"> and if we talk in regards to</font>

240
00:11:12,660 --> 00:11:21,030
office products<font color="#E5E5E5"> we have the</font><font color="#CCCCCC"> VBA project</font>

241
00:11:18,210 --> 00:11:24,120
bin which is a binary file<font color="#CCCCCC"> embedded</font>

242
00:11:21,030 --> 00:11:27,510
within<font color="#CCCCCC"> Office files which provides the</font>

243
00:11:24,120 --> 00:11:29,940
VBA capabilities so we<font color="#CCCCCC"> went and</font><font color="#E5E5E5"> we</font>

244
00:11:27,510 --> 00:11:32,580
looked<font color="#E5E5E5"> in</font><font color="#CCCCCC"> DMSO VBA which was not</font><font color="#E5E5E5"> that</font>

245
00:11:29,940 --> 00:11:34,110
<font color="#CCCCCC">Pleasant of a task but we did it</font><font color="#E5E5E5"> and we</font>

246
00:11:32,580 --> 00:11:35,490
were surprised to<font color="#E5E5E5"> know</font><font color="#CCCCCC"> that we were not</font>

247
00:11:34,110 --> 00:11:38,190
actually the<font color="#CCCCCC"> first one to</font><font color="#E5E5E5"> look in</font><font color="#CCCCCC"> this</font>

248
00:11:35,490 --> 00:11:41,490
document<font color="#E5E5E5"> big surprise and</font>

249
00:11:38,190 --> 00:11:43,800
mr.<font color="#E5E5E5"> Haly I hope I pronounced it right in</font>

250
00:11:41,490 --> 00:11:46,080
his presentation the<font color="#E5E5E5"> analysis of attack</font>

251
00:11:43,800 --> 00:11:49,530
surface of Microsoft Office from<font color="#E5E5E5"> a user</font>

252
00:11:46,080 --> 00:11:51,570
perspective<font color="#E5E5E5"> in this presentation he</font>

253
00:11:49,530 --> 00:11:55,620
details<font color="#E5E5E5"> a very cool remote code</font>

254
00:11:51,570 --> 00:11:58,530
execution<font color="#E5E5E5"> because it appeals that VBA</font>

255
00:11:55,620 --> 00:12:00,810
projects can<font color="#CCCCCC"> be pointed</font><font color="#E5E5E5"> to automation</font>

256
00:11:58,530 --> 00:12:04,110
type libraries<font color="#CCCCCC"> which is let's call it a</font>

257
00:12:00,810 --> 00:12:06,300
<font color="#CCCCCC">DLL for a lack of</font><font color="#E5E5E5"> a</font><font color="#CCCCCC"> better name you can</font>

258
00:12:04,110 --> 00:12:10,110
point your<font color="#CCCCCC"> VBA project</font><font color="#E5E5E5"> to this library</font>

259
00:12:06,300 --> 00:12:12,510
<font color="#E5E5E5">it will be fetched and loaded</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> it can</font>

260
00:12:10,110 --> 00:12:14,850
<font color="#E5E5E5">actually get the execution flow and then</font>

261
00:12:12,510 --> 00:12:16,830
<font color="#CCCCCC">effectively</font><font color="#E5E5E5"> you get code execution so</font>

262
00:12:14,850 --> 00:12:21,690
this is what he had discovered<font color="#CCCCCC"> and he</font>

263
00:12:16,830 --> 00:12:25,080
details<font color="#E5E5E5"> in his presentation the the life</font>

264
00:12:21,690 --> 00:12:26,700
of this<font color="#CCCCCC"> vulnerability because it has</font>

265
00:12:25,080 --> 00:12:29,040
been known for<font color="#CCCCCC"> a</font><font color="#E5E5E5"> while and Microsoft has</font>

266
00:12:26,700 --> 00:12:30,210
decided<font color="#E5E5E5"> not to fix it at once he was</font>

267
00:12:29,040 --> 00:12:34,530
able<font color="#CCCCCC"> to exploit it</font>

268
00:12:30,210 --> 00:12:36,660
<font color="#E5E5E5">Microsoft has decided to fix this so we</font>

269
00:12:34,530 --> 00:12:38,100
did<font color="#E5E5E5"> the same we went into this</font><font color="#CCCCCC"> document</font>

270
00:12:36,660 --> 00:12:40,439
and we had<font color="#CCCCCC"> to look around</font><font color="#E5E5E5"> and we found</font>

271
00:12:38,100 --> 00:12:44,280
<font color="#CCCCCC">something</font><font color="#E5E5E5"> else that we found some</font>

272
00:12:40,440 --> 00:12:48,060
curious curious<font color="#CCCCCC"> to us and it's actually</font>

273
00:12:44,280 --> 00:12:50,310
references<font color="#E5E5E5"> so VBA</font><font color="#CCCCCC"> Visual Basic full</font>

274
00:12:48,060 --> 00:12:56,810
application is based on<font color="#E5E5E5"> Visual Basic and</font>

275
00:12:50,310 --> 00:13:01,380
my guess is<font color="#E5E5E5"> that</font><font color="#CCCCCC"> Microsoft aim to</font>

276
00:12:56,810 --> 00:13:03,000
provide aim to make VBA<font color="#E5E5E5"> a sort of</font>

277
00:13:01,380 --> 00:13:05,180
programming language just like<font color="#E5E5E5"> any other</font>

278
00:13:03,000 --> 00:13:09,120
programming<font color="#E5E5E5"> languages and they can use</font>

279
00:13:05,180 --> 00:13:10,920
referencing and so why<font color="#E5E5E5"> not have VBA used</font>

280
00:13:09,120 --> 00:13:13,529
referencing as well so this<font color="#E5E5E5"> is this</font>

281
00:13:10,920 --> 00:13:17,099
capability<font color="#CCCCCC"> you can point you</font>

282
00:13:13,529 --> 00:13:20,310
<font color="#E5E5E5">VBA project into remote VBA project and</font>

283
00:13:17,100 --> 00:13:24,300
have<font color="#E5E5E5"> it fetched and loaded and then you</font>

284
00:13:20,310 --> 00:13:25,939
can use<font color="#E5E5E5"> its code as your own so this is</font>

285
00:13:24,300 --> 00:13:30,809
what it looks<font color="#E5E5E5"> like this is the actual</font>

286
00:13:25,939 --> 00:13:32,550
<font color="#E5E5E5">text from the MSO VBA document and this</font>

287
00:13:30,809 --> 00:13:35,389
<font color="#E5E5E5">is what caught our eye you can actually</font>

288
00:13:32,550 --> 00:13:38,040
provide a path<font color="#CCCCCC"> it could be a local</font>

289
00:13:35,389 --> 00:13:41,249
relative absolute<font color="#E5E5E5"> remote path and</font>

290
00:13:38,040 --> 00:13:44,009
there's actually no questions asked<font color="#E5E5E5"> I</font>

291
00:13:41,249 --> 00:13:46,199
mean no security<font color="#CCCCCC"> you don't have to test</font>

292
00:13:44,009 --> 00:13:48,689
<font color="#E5E5E5">for anything</font><font color="#CCCCCC"> as long as it's available</font>

293
00:13:46,199 --> 00:13:51,420
it will<font color="#E5E5E5"> be fetched and loaded then you</font>

294
00:13:48,689 --> 00:13:53,699
can use<font color="#E5E5E5"> its code as your own and we</font>

295
00:13:51,420 --> 00:13:55,920
thought<font color="#CCCCCC"> that this is quite</font><font color="#E5E5E5"> interesting</font>

296
00:13:53,699 --> 00:13:59,430
<font color="#E5E5E5">and we've decided to</font><font color="#CCCCCC"> explore a little</font>

297
00:13:55,920 --> 00:14:02,790
bit<font color="#E5E5E5"> and we've began doing some testing</font>

298
00:13:59,430 --> 00:14:05,459
so first of all we went<font color="#E5E5E5"> and tested world</font>

299
00:14:02,790 --> 00:14:07,290
the world processor which<font color="#CCCCCC"> is heavily</font>

300
00:14:05,459 --> 00:14:10,709
used<font color="#E5E5E5"> in the industry</font><font color="#CCCCCC"> it's a very good</font>

301
00:14:07,290 --> 00:14:13,079
<font color="#E5E5E5">candidate</font><font color="#CCCCCC"> for infection</font><font color="#E5E5E5"> and we found out</font>

302
00:14:10,709 --> 00:14:15,628
<font color="#E5E5E5">that it's</font><font color="#CCCCCC"> not that</font><font color="#E5E5E5"> reliable</font><font color="#CCCCCC"> I'm aiming</font>

303
00:14:13,079 --> 00:14:16,638
to<font color="#CCCCCC"> make to produce</font><font color="#E5E5E5"> reliable</font><font color="#CCCCCC"> attacks</font>

304
00:14:15,629 --> 00:14:20,040
something I can use

305
00:14:16,639 --> 00:14:23,269
without fail with failing<font color="#E5E5E5"> so this is</font>

306
00:14:20,040 --> 00:14:25,559
what VBA referencing looks like in world

307
00:14:23,269 --> 00:14:27,480
so you open the document and<font color="#CCCCCC"> you are</font>

308
00:14:25,559 --> 00:14:30,809
blocked by protected view which is cool

309
00:14:27,480 --> 00:14:32,850
<font color="#CCCCCC">and then you</font><font color="#E5E5E5"> get a weird prompt and you</font>

310
00:14:30,809 --> 00:14:35,370
get protected view again<font color="#E5E5E5"> which shouldn't</font>

311
00:14:32,850 --> 00:14:36,629
happen and<font color="#E5E5E5"> then nothing happens</font><font color="#CCCCCC"> you</font><font color="#E5E5E5"> can</font>

312
00:14:35,370 --> 00:14:40,680
really tell what's going on<font color="#E5E5E5"> in</font><font color="#CCCCCC"> this</font>

313
00:14:36,629 --> 00:14:43,050
document<font color="#E5E5E5"> and if this was the</font><font color="#CCCCCC"> only</font><font color="#E5E5E5"> case I</font>

314
00:14:40,680 --> 00:14:44,939
would say<font color="#CCCCCC"> okay I can live with that but</font>

315
00:14:43,050 --> 00:14:46,378
<font color="#CCCCCC">it's</font><font color="#E5E5E5"> not I mean</font><font color="#CCCCCC"> you cannot predict</font>

316
00:14:44,939 --> 00:14:48,480
what's going on this<font color="#E5E5E5"> is a completely</font>

317
00:14:46,379 --> 00:14:50,250
different<font color="#CCCCCC"> arrow you open the document</font>

318
00:14:48,480 --> 00:14:53,220
you<font color="#E5E5E5"> get a prompt and after that you'll</font>

319
00:14:50,250 --> 00:14:55,339
<font color="#CCCCCC">have</font><font color="#E5E5E5"> to</font><font color="#CCCCCC"> disabled and protected view so</font>

320
00:14:53,220 --> 00:15:01,019
the thing<font color="#CCCCCC"> is I just cannot rely on world</font>

321
00:14:55,339 --> 00:15:04,649
to produce an attack<font color="#E5E5E5"> and moving on we</font>

322
00:15:01,019 --> 00:15:08,279
have<font color="#E5E5E5"> PowerPoint the presentation program</font>

323
00:15:04,649 --> 00:15:12,569
<font color="#E5E5E5">and VBA referencing actually works and</font>

324
00:15:08,279 --> 00:15:14,939
that's<font color="#E5E5E5"> cool but you get a very alarming</font>

325
00:15:12,569 --> 00:15:17,099
security notice telling<font color="#E5E5E5"> you look this</font>

326
00:15:14,939 --> 00:15:21,300
document<font color="#E5E5E5"> we have identified</font><font color="#CCCCCC"> some</font>

327
00:15:17,100 --> 00:15:24,750
potentially dangerous elements within<font color="#E5E5E5"> it</font>

328
00:15:21,300 --> 00:15:26,979
tries to<font color="#E5E5E5"> do something and if I were was</font>

329
00:15:24,750 --> 00:15:29,580
a user I wouldn't<font color="#CCCCCC"> open this document</font>

330
00:15:26,980 --> 00:15:31,150
for myself<font color="#CCCCCC"> so I would</font><font color="#E5E5E5"> disable macros and</font>

331
00:15:29,580 --> 00:15:35,590
no attack

332
00:15:31,150 --> 00:15:38,980
so no PowerPoint<font color="#CCCCCC"> for me as</font><font color="#E5E5E5"> well and we</font>

333
00:15:35,590 --> 00:15:42,490
went to<font color="#CCCCCC"> Excel and Excel works</font>

334
00:15:38,980 --> 00:15:44,620
brilliantly<font color="#CCCCCC"> so you</font><font color="#E5E5E5"> open the document and</font>

335
00:15:42,490 --> 00:15:45,580
<font color="#E5E5E5">protected view</font><font color="#CCCCCC"> protects the user and</font>

336
00:15:44,620 --> 00:15:49,270
<font color="#E5E5E5">that's</font><font color="#CCCCCC"> okay</font>

337
00:15:45,580 --> 00:15:53,800
but once you enable<font color="#E5E5E5"> it all good and you</font>

338
00:15:49,270 --> 00:15:55,360
get code execution and we<font color="#E5E5E5"> had a message</font>

339
00:15:53,800 --> 00:15:59,979
box<font color="#E5E5E5"> and have a look this</font><font color="#CCCCCC"> is</font><font color="#E5E5E5"> what the</font>

340
00:15:55,360 --> 00:16:03,160
code looks<font color="#E5E5E5"> like in the walk look so this</font>

341
00:15:59,980 --> 00:16:06,910
code is<font color="#E5E5E5"> actually resides in the workbook</font>

342
00:16:03,160 --> 00:16:09,130
and<font color="#E5E5E5"> it says call call me function and</font>

343
00:16:06,910 --> 00:16:11,709
this function is<font color="#CCCCCC"> not in here it's</font>

344
00:16:09,130 --> 00:16:17,860
actually<font color="#E5E5E5"> in this</font><font color="#CCCCCC"> fetched project in this</font>

345
00:16:11,710 --> 00:16:20,590
module<font color="#CCCCCC"> so</font><font color="#E5E5E5"> VBA referencing works it works</font>

346
00:16:17,860 --> 00:16:24,310
<font color="#E5E5E5">very good for Excel and we will use</font><font color="#CCCCCC"> it</font>

347
00:16:20,590 --> 00:16:29,830
<font color="#CCCCCC">later on</font><font color="#E5E5E5"> in this attack and the funny</font>

348
00:16:24,310 --> 00:16:31,449
<font color="#E5E5E5">thing about office is the fact that even</font>

349
00:16:29,830 --> 00:16:33,580
though they<font color="#E5E5E5"> were all developed in the</font>

350
00:16:31,450 --> 00:16:35,290
same place in Microsoft in office and

351
00:16:33,580 --> 00:16:37,000
they're under the<font color="#E5E5E5"> same suit of products</font>

352
00:16:35,290 --> 00:16:38,260
<font color="#E5E5E5">they have different divisions so they</font>

353
00:16:37,000 --> 00:16:39,790
have the world division they have power

354
00:16:38,260 --> 00:16:44,400
point<font color="#E5E5E5"> of vision and they have</font><font color="#CCCCCC"> Excel</font>

355
00:16:39,790 --> 00:16:47,140
divisions<font color="#E5E5E5"> and they all produce something</font>

356
00:16:44,400 --> 00:16:49,150
different<font color="#E5E5E5"> I don't</font><font color="#CCCCCC"> know</font><font color="#E5E5E5"> why but you have</font>

357
00:16:47,140 --> 00:16:50,980
world and PowerPoint which doesn't act

358
00:16:49,150 --> 00:16:55,060
the<font color="#E5E5E5"> same as Excel and I'm just gonna</font>

359
00:16:50,980 --> 00:16:57,940
rely on<font color="#E5E5E5"> Excel for this attack so what we</font>

360
00:16:55,060 --> 00:17:00,400
have so<font color="#E5E5E5"> far is sandbox evasion</font>

361
00:16:57,940 --> 00:17:02,470
techniques require code execution<font color="#CCCCCC"> and</font><font color="#E5E5E5"> we</font>

362
00:17:00,400 --> 00:17:04,959
have VBA referencing<font color="#E5E5E5"> allowing us to</font>

363
00:17:02,470 --> 00:17:08,980
fetch and reference code<font color="#E5E5E5"> from</font><font color="#CCCCCC"> a</font>

364
00:17:04,959 --> 00:17:15,490
<font color="#CCCCCC">different</font><font color="#E5E5E5"> location</font><font color="#CCCCCC"> and we will use these</font>

365
00:17:08,980 --> 00:17:17,199
to craft an attack so maybe some<font color="#E5E5E5"> of you</font>

366
00:17:15,490 --> 00:17:20,260
have already<font color="#CCCCCC"> thought about</font><font color="#E5E5E5"> it</font><font color="#CCCCCC"> I can use</font>

367
00:17:17,199 --> 00:17:23,500
VBA referencing to perform sandbox

368
00:17:20,260 --> 00:17:26,319
<font color="#E5E5E5">evasion</font><font color="#CCCCCC"> somewhat I can send a blank</font>

369
00:17:23,500 --> 00:17:29,710
document which has VBA markers inside

370
00:17:26,319 --> 00:17:32,560
<font color="#E5E5E5">and uses VBA referencing and so no</font>

371
00:17:29,710 --> 00:17:35,230
suspicious code<font color="#CCCCCC"> in the document</font><font color="#E5E5E5"> that I</font>

372
00:17:32,560 --> 00:17:39,520
<font color="#CCCCCC">send an only suspicious code in the</font>

373
00:17:35,230 --> 00:17:40,660
fetched document and this might work on

374
00:17:39,520 --> 00:17:43,570
some sandbox

375
00:17:40,660 --> 00:17:45,490
but the thing is<font color="#E5E5E5"> that eventually the</font>

376
00:17:43,570 --> 00:17:47,320
fetched code will be<font color="#CCCCCC"> executed within the</font>

377
00:17:45,490 --> 00:17:50,890
sandbox<font color="#E5E5E5"> and the sandbox will identify</font><font color="#CCCCCC"> it</font>

378
00:17:47,320 --> 00:17:53,590
<font color="#E5E5E5">and you still end up in the same loop I</font>

379
00:17:50,890 --> 00:17:55,180
mean you have malicious code execution

380
00:17:53,590 --> 00:18:00,550
in<font color="#E5E5E5"> the sandbox the sandbox will detect</font>

381
00:17:55,180 --> 00:18:03,190
it and it leads to<font color="#E5E5E5"> novel so we thought</font>

382
00:18:00,550 --> 00:18:05,740
what<font color="#CCCCCC"> if I can identify who's asking if</font>

383
00:18:03,190 --> 00:18:07,660
it's a sandbox<font color="#E5E5E5"> asking I'll</font><font color="#CCCCCC"> reply with a</font>

384
00:18:05,740 --> 00:18:09,730
<font color="#E5E5E5">benign piece of code and if it's a user</font>

385
00:18:07,660 --> 00:18:12,100
asking<font color="#CCCCCC"> I'll reply</font><font color="#E5E5E5"> with a malicious piece</font>

386
00:18:09,730 --> 00:18:14,680
of code and then effectively I'll have

387
00:18:12,100 --> 00:18:19,240
sandbox evasion but<font color="#E5E5E5"> in order</font><font color="#CCCCCC"> to do that</font>

388
00:18:14,680 --> 00:18:22,330
I have to detect<font color="#E5E5E5"> the sandbox so just a</font>

389
00:18:19,240 --> 00:18:26,140
<font color="#E5E5E5">few notes on a sandbox before moving on</font>

390
00:18:22,330 --> 00:18:29,040
because sandbox is also heavily<font color="#CCCCCC"> used in</font>

391
00:18:26,140 --> 00:18:31,210
the industry<font color="#CCCCCC"> and they inspect each</font>

392
00:18:29,040 --> 00:18:33,550
<font color="#E5E5E5">incoming file and this could be</font>

393
00:18:31,210 --> 00:18:36,280
thousands<font color="#E5E5E5"> of tens of thousands of file</font>

394
00:18:33,550 --> 00:18:39,520
each day you<font color="#CCCCCC"> have to apply a set of</font>

395
00:18:36,280 --> 00:18:41,560
rules<font color="#E5E5E5"> these are logical rules to prevent</font>

396
00:18:39,520 --> 00:18:43,920
the sandbox from clogging<font color="#CCCCCC"> your network</font>

397
00:18:41,560 --> 00:18:48,300
so first of<font color="#E5E5E5"> all the sandbox has to be</font>

398
00:18:43,920 --> 00:18:51,070
<font color="#E5E5E5">automatic</font><font color="#CCCCCC"> I mean no user interaction no</font>

399
00:18:48,300 --> 00:18:54,159
<font color="#E5E5E5">thinking or messing with it</font><font color="#CCCCCC"> on the user</font>

400
00:18:51,070 --> 00:18:56,919
side<font color="#CCCCCC"> once the file has ended up on the</font>

401
00:18:54,160 --> 00:18:59,080
user<font color="#CCCCCC"> and</font><font color="#E5E5E5"> it's safe you can use it no</font>

402
00:18:56,920 --> 00:19:04,840
<font color="#E5E5E5">worries whatsoever so that's number</font><font color="#CCCCCC"> one</font>

403
00:18:59,080 --> 00:19:08,530
number<font color="#CCCCCC"> two it has to</font><font color="#E5E5E5"> be fast</font><font color="#CCCCCC"> I mean if</font>

404
00:19:04,840 --> 00:19:10,899
you have<font color="#E5E5E5"> thousand files per day each</font>

405
00:19:08,530 --> 00:19:14,230
file takes between<font color="#CCCCCC"> five to ten</font><font color="#E5E5E5"> minutes</font>

406
00:19:10,900 --> 00:19:16,420
<font color="#CCCCCC">to being</font><font color="#E5E5E5"> analyzed you'll effectively</font>

407
00:19:14,230 --> 00:19:20,560
clog your network so besides setting<font color="#E5E5E5"> a</font>

408
00:19:16,420 --> 00:19:22,350
time limit<font color="#E5E5E5"> sandbox vendors do all sorts</font>

409
00:19:20,560 --> 00:19:27,010
of optimization whether it's the

410
00:19:22,350 --> 00:19:30,010
<font color="#CCCCCC">optimization on the OS</font><font color="#E5E5E5"> level or on the</font>

411
00:19:27,010 --> 00:19:32,710
application level<font color="#E5E5E5"> and the final thing it</font>

412
00:19:30,010 --> 00:19:34,720
has to<font color="#CCCCCC"> be</font><font color="#E5E5E5"> secure less because a sandbox</font>

413
00:19:32,710 --> 00:19:37,270
<font color="#E5E5E5">is called the sandbox</font><font color="#CCCCCC"> because nothing</font>

414
00:19:34,720 --> 00:19:39,130
bad<font color="#E5E5E5"> can</font><font color="#CCCCCC"> happen within everything you do</font>

415
00:19:37,270 --> 00:19:42,940
with in a sandbox<font color="#E5E5E5"> want in it won't</font>

416
00:19:39,130 --> 00:19:45,520
affect your environment<font color="#CCCCCC"> so you can</font><font color="#E5E5E5"> just</font>

417
00:19:42,940 --> 00:19:47,980
say<font color="#E5E5E5"> okay I'm going to drop most</font><font color="#CCCCCC"> or</font><font color="#E5E5E5"> all</font>

418
00:19:45,520 --> 00:19:50,139
<font color="#CCCCCC">of the security mitigations</font><font color="#E5E5E5"> and</font><font color="#CCCCCC"> I will</font>

419
00:19:47,980 --> 00:19:52,810
<font color="#E5E5E5">allow the</font><font color="#CCCCCC"> module to execute freely and</font>

420
00:19:50,140 --> 00:19:54,040
then I can see<font color="#E5E5E5"> exactly what it tries to</font>

421
00:19:52,810 --> 00:19:56,620
do<font color="#E5E5E5"> as</font>

422
00:19:54,040 --> 00:19:59,800
as I can and then I can flag it<font color="#E5E5E5"> as fast</font>

423
00:19:56,620 --> 00:20:02,290
as<font color="#E5E5E5"> I can and I can actually if I see</font>

424
00:19:59,800 --> 00:20:04,659
<font color="#E5E5E5">what it's doing completely</font><font color="#CCCCCC"> I can say</font>

425
00:20:02,290 --> 00:20:07,750
<font color="#E5E5E5">okay it's this kind of Malibu family or</font>

426
00:20:04,660 --> 00:20:09,940
that kind and so forth<font color="#E5E5E5"> and actually the</font>

427
00:20:07,750 --> 00:20:12,280
<font color="#CCCCCC">last bullet</font><font color="#E5E5E5"> actually supports the two</font>

428
00:20:09,940 --> 00:20:14,820
above because<font color="#E5E5E5"> when you disable security</font>

429
00:20:12,280 --> 00:20:16,930
mitigations<font color="#E5E5E5"> you don't have to click</font>

430
00:20:14,820 --> 00:20:19,480
<font color="#E5E5E5">enable content so the process is</font>

431
00:20:16,930 --> 00:20:21,370
<font color="#CCCCCC">automatic for</font><font color="#E5E5E5"> example and it's faster</font>

432
00:20:19,480 --> 00:20:22,720
you don't have to load<font color="#E5E5E5"> all</font><font color="#CCCCCC"> of these</font>

433
00:20:21,370 --> 00:20:25,709
security<font color="#CCCCCC"> mitigations and you don't have</font>

434
00:20:22,720 --> 00:20:30,010
to disable<font color="#E5E5E5"> them so it's quicker</font><font color="#CCCCCC"> and</font>

435
00:20:25,710 --> 00:20:32,620
<font color="#E5E5E5">building on top of that let's have a</font>

436
00:20:30,010 --> 00:20:35,680
look at the difference<font color="#CCCCCC"> between a</font><font color="#E5E5E5"> sandbox</font>

437
00:20:32,620 --> 00:20:39,639
<font color="#E5E5E5">and a user in</font><font color="#CCCCCC"> terms of office</font><font color="#E5E5E5"> so when</font><font color="#CCCCCC"> a</font>

438
00:20:35,680 --> 00:20:41,590
user opens a document usually<font color="#E5E5E5"> and by</font>

439
00:20:39,640 --> 00:20:43,180
group policy the user is protected with

440
00:20:41,590 --> 00:20:44,770
protected view which is a very<font color="#E5E5E5"> good</font>

441
00:20:43,180 --> 00:20:47,140
<font color="#E5E5E5">project</font><font color="#CCCCCC"> I</font><font color="#E5E5E5"> don't have anything bad to</font><font color="#CCCCCC"> say</font>

442
00:20:44,770 --> 00:20:50,950
<font color="#CCCCCC">about it by the</font><font color="#E5E5E5"> way</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> so the user</font>

443
00:20:47,140 --> 00:20:54,070
opens the<font color="#CCCCCC"> document and he has to disable</font>

444
00:20:50,950 --> 00:20:56,950
protected view to allow all<font color="#E5E5E5"> sorts of</font>

445
00:20:54,070 --> 00:20:58,330
elements<font color="#CCCCCC"> to be load in the document and</font>

446
00:20:56,950 --> 00:21:01,840
we'll talk about<font color="#E5E5E5"> protective you in a sec</font>

447
00:20:58,330 --> 00:21:04,030
<font color="#E5E5E5">so</font><font color="#CCCCCC"> you have document</font><font color="#E5E5E5"> open if you want to</font>

448
00:21:01,840 --> 00:21:06,189
move<font color="#E5E5E5"> along the same a protected view at</font>

449
00:21:04,030 --> 00:21:09,480
some point the VBA engine will load

450
00:21:06,190 --> 00:21:13,060
causing VBA referencing to happen and

451
00:21:09,480 --> 00:21:15,790
that's<font color="#E5E5E5"> from the users perspective</font><font color="#CCCCCC"> if we</font>

452
00:21:13,060 --> 00:21:18,340
<font color="#CCCCCC">look at the</font><font color="#E5E5E5"> sandbox</font><font color="#CCCCCC"> because it's fast</font>

453
00:21:15,790 --> 00:21:22,570
and automatic and secure we don't have

454
00:21:18,340 --> 00:21:24,490
protected view<font color="#E5E5E5"> so the document is opened</font>

455
00:21:22,570 --> 00:21:25,899
<font color="#E5E5E5">and no protected view whatsoever to</font>

456
00:21:24,490 --> 00:21:28,630
support<font color="#E5E5E5"> all</font><font color="#CCCCCC"> of the bullet</font><font color="#E5E5E5"> points we</font>

457
00:21:25,900 --> 00:21:31,660
talked about<font color="#E5E5E5"> and once you</font><font color="#CCCCCC"> open the</font>

458
00:21:28,630 --> 00:21:33,940
document<font color="#E5E5E5"> no protected view</font><font color="#CCCCCC"> VBA engine</font>

459
00:21:31,660 --> 00:21:37,120
loads automatically actually before the

460
00:21:33,940 --> 00:21:39,520
document is fully loaded<font color="#E5E5E5"> and VBA</font>

461
00:21:37,120 --> 00:21:42,879
referencing occurs when it eventually

462
00:21:39,520 --> 00:21:44,860
<font color="#CCCCCC">just like</font><font color="#E5E5E5"> before</font><font color="#CCCCCC"> so we can actually</font><font color="#E5E5E5"> spot</font>

463
00:21:42,880 --> 00:21:47,620
a difference in here there's a gap

464
00:21:44,860 --> 00:21:49,899
between<font color="#E5E5E5"> a user and the sandbox and we</font>

465
00:21:47,620 --> 00:21:56,560
will use this gap to identify the

466
00:21:49,900 --> 00:21:58,390
sandbox<font color="#E5E5E5"> and just a few notes on</font>

467
00:21:56,560 --> 00:22:01,330
protective you<font color="#E5E5E5"> so most people</font><font color="#CCCCCC"> think that</font>

468
00:21:58,390 --> 00:22:03,070
protected<font color="#E5E5E5"> view is for code and it</font>

469
00:22:01,330 --> 00:22:06,460
protects<font color="#E5E5E5"> you from code and it protects</font>

470
00:22:03,070 --> 00:22:07,600
you from ActiveX which is true but<font color="#E5E5E5"> not</font>

471
00:22:06,460 --> 00:22:09,690
<font color="#CCCCCC">just its</font>

472
00:22:07,600 --> 00:22:12,909
not<font color="#E5E5E5"> the complete case protected view is</font>

473
00:22:09,690 --> 00:22:14,710
a very powerful sandbox<font color="#E5E5E5"> and</font><font color="#CCCCCC"> it aims to</font>

474
00:22:12,910 --> 00:22:17,289
protect<font color="#E5E5E5"> the user from all sorts of</font>

475
00:22:14,710 --> 00:22:21,640
threats as we'll see<font color="#E5E5E5"> in just a sec and</font>

476
00:22:17,289 --> 00:22:23,650
so first of all it's not<font color="#E5E5E5"> blocking code</font>

477
00:22:21,640 --> 00:22:25,900
<font color="#CCCCCC">its disabling it so protected view</font>

478
00:22:23,650 --> 00:22:27,940
disables the VBA engine until<font color="#E5E5E5"> you allow</font>

479
00:22:25,900 --> 00:22:30,280
it and it protects you from other

480
00:22:27,940 --> 00:22:31,770
<font color="#E5E5E5">elements as well and this is</font><font color="#CCCCCC"> what</font><font color="#E5E5E5"> it</font>

481
00:22:30,280 --> 00:22:34,059
looks<font color="#E5E5E5"> like this is from the</font>

482
00:22:31,770 --> 00:22:37,900
documentation from the<font color="#E5E5E5"> office</font>

483
00:22:34,059 --> 00:22:41,020
documentation<font color="#E5E5E5"> and they describe why they</font>

484
00:22:37,900 --> 00:22:43,000
block<font color="#E5E5E5"> these elements as well so we have</font>

485
00:22:41,020 --> 00:22:44,679
<font color="#E5E5E5">images</font><font color="#CCCCCC"> and images in</font><font color="#E5E5E5"> Outlook linked</font>

486
00:22:43,000 --> 00:22:47,200
media and data<font color="#E5E5E5"> connections protected</font>

487
00:22:44,679 --> 00:22:52,179
view blocks these elements<font color="#E5E5E5"> from loading</font>

488
00:22:47,200 --> 00:22:54,880
as well and let's enlarge this<font color="#E5E5E5"> and they</font>

489
00:22:52,179 --> 00:22:57,520
say attacker can send you a workbook<font color="#E5E5E5"> of</font>

490
00:22:54,880 --> 00:22:59,380
a document<font color="#E5E5E5"> with an image within and once</font>

491
00:22:57,520 --> 00:23:01,570
you open<font color="#CCCCCC"> the document the image is</font>

492
00:22:59,380 --> 00:23:03,970
<font color="#CCCCCC">loaded signaling the attacker that</font>

493
00:23:01,570 --> 00:23:06,070
you've opened<font color="#E5E5E5"> the document</font><font color="#CCCCCC"> and so in</font>

494
00:23:03,970 --> 00:23:09,669
order<font color="#E5E5E5"> to protect you from these threats</font>

495
00:23:06,070 --> 00:23:22,360
protected view blocks<font color="#E5E5E5"> these threats as</font>

496
00:23:09,669 --> 00:23:25,720
<font color="#CCCCCC">well which is good I guess but as I said</font>

497
00:23:22,360 --> 00:23:27,699
<font color="#E5E5E5">we will rely on it's always so if we</font>

498
00:23:25,720 --> 00:23:29,590
look at it from<font color="#CCCCCC"> the users perspective we</font>

499
00:23:27,700 --> 00:23:32,710
have protected view and it's being<font color="#E5E5E5"> used</font>

500
00:23:29,590 --> 00:23:36,280
<font color="#E5E5E5">to</font><font color="#CCCCCC"> protect</font><font color="#E5E5E5"> the user obviously but they</font>

501
00:23:32,710 --> 00:23:38,380
don't want<font color="#CCCCCC"> office didn't want to block</font>

502
00:23:36,280 --> 00:23:42,220
the users<font color="#CCCCCC"> experience</font><font color="#E5E5E5"> altogether so they</font>

503
00:23:38,380 --> 00:23:44,470
provided a<font color="#E5E5E5"> 2-step verification</font><font color="#CCCCCC"> so you</font>

504
00:23:42,220 --> 00:23:47,140
<font color="#E5E5E5">open the document</font><font color="#CCCCCC"> and if the document</font>

505
00:23:44,470 --> 00:23:50,470
contains suspicious<font color="#CCCCCC"> Internet files could</font>

506
00:23:47,140 --> 00:23:53,620
be<font color="#E5E5E5"> images or linked media</font><font color="#CCCCCC"> without the</font>

507
00:23:50,470 --> 00:23:55,600
connections<font color="#E5E5E5"> this will be blocked but you</font>

508
00:23:53,620 --> 00:24:00,459
can release<font color="#E5E5E5"> them first because they pose</font>

509
00:23:55,600 --> 00:24:02,969
<font color="#E5E5E5">a small risk to the user so office gives</font>

510
00:24:00,460 --> 00:24:05,409
<font color="#CCCCCC">you gives you</font><font color="#E5E5E5"> the option of be careful</font>

511
00:24:02,970 --> 00:24:09,190
<font color="#E5E5E5">files from the</font><font color="#CCCCCC"> internet</font><font color="#E5E5E5"> can contain</font>

512
00:24:05,409 --> 00:24:12,460
viruses<font color="#E5E5E5"> yeah unless you</font><font color="#CCCCCC"> blah blah blah</font>

513
00:24:09,190 --> 00:24:14,049
<font color="#E5E5E5">you can unlock protected view by enable</font>

514
00:24:12,460 --> 00:24:16,090
editing and then you can edit the

515
00:24:14,049 --> 00:24:17,740
document<font color="#CCCCCC"> and</font><font color="#E5E5E5"> all of these elements the</font>

516
00:24:16,090 --> 00:24:20,379
images the data connections will<font color="#CCCCCC"> be</font>

517
00:24:17,740 --> 00:24:21,430
loaded so that's number<font color="#CCCCCC"> one</font><font color="#E5E5E5"> and after</font>

518
00:24:20,380 --> 00:24:23,500
<font color="#CCCCCC">you do</font><font color="#E5E5E5"> that</font>

519
00:24:21,430 --> 00:24:25,420
protected view<font color="#E5E5E5"> gives you the second</font>

520
00:24:23,500 --> 00:24:27,760
option<font color="#CCCCCC"> and telling you okay look</font><font color="#E5E5E5"> this</font>

521
00:24:25,420 --> 00:24:30,610
document has some active content could

522
00:24:27,760 --> 00:24:33,520
be code could be<font color="#E5E5E5"> ActiveX</font><font color="#CCCCCC"> in this case</font>

523
00:24:30,610 --> 00:24:36,760
for<font color="#CCCCCC"> example macros</font><font color="#E5E5E5"> if you trust the</font>

524
00:24:33,520 --> 00:24:38,650
document please<font color="#CCCCCC"> enable content</font><font color="#E5E5E5"> and then</font>

525
00:24:36,760 --> 00:24:41,080
<font color="#E5E5E5">you will have the full</font><font color="#CCCCCC"> experience that</font>

526
00:24:38,650 --> 00:24:44,320
this document has<font color="#E5E5E5"> installed for you and</font>

527
00:24:41,080 --> 00:24:46,330
so this<font color="#E5E5E5"> is the 2-step verification</font><font color="#CCCCCC"> once</font>

528
00:24:44,320 --> 00:24:49,000
you open the document you have<font color="#E5E5E5"> nothing</font>

529
00:24:46,330 --> 00:24:51,429
enabled<font color="#E5E5E5"> if you want to have a small</font>

530
00:24:49,000 --> 00:24:52,540
experience<font color="#E5E5E5"> of the document enable</font>

531
00:24:51,430 --> 00:24:56,440
editing and if you want the<font color="#E5E5E5"> full</font>

532
00:24:52,540 --> 00:24:58,540
experience<font color="#CCCCCC"> alongside threats from the</font>

533
00:24:56,440 --> 00:25:00,880
macros and<font color="#E5E5E5"> stuff please enable content</font>

534
00:24:58,540 --> 00:25:02,559
<font color="#CCCCCC">so this</font><font color="#E5E5E5"> is the</font><font color="#CCCCCC"> user</font><font color="#E5E5E5"> perspective</font><font color="#CCCCCC"> it</font>

535
00:25:00,880 --> 00:25:05,700
protects the user and it's doing a very

536
00:25:02,559 --> 00:25:07,990
good job<font color="#E5E5E5"> and if we compare this to</font><font color="#CCCCCC"> the</font>

537
00:25:05,700 --> 00:25:09,610
<font color="#CCCCCC">sandbox experience when you open the</font>

538
00:25:07,990 --> 00:25:12,040
document<font color="#E5E5E5"> you'll see that it's</font><font color="#CCCCCC"> completely</font>

539
00:25:09,610 --> 00:25:16,510
different<font color="#E5E5E5"> and not just different</font><font color="#CCCCCC"> it's</font>

540
00:25:12,040 --> 00:25:18,520
completely the<font color="#E5E5E5"> opposite so the sandbox</font>

541
00:25:16,510 --> 00:25:22,780
<font color="#CCCCCC">open the document there is</font><font color="#E5E5E5"> no protected</font>

542
00:25:18,520 --> 00:25:24,879
view whatsoever<font color="#E5E5E5"> and I've placed this</font>

543
00:25:22,780 --> 00:25:26,410
image is grayed out so<font color="#E5E5E5"> because they are</font>

544
00:25:24,880 --> 00:25:29,350
not applied<font color="#CCCCCC"> I</font><font color="#E5E5E5"> just want to show you the</font>

545
00:25:26,410 --> 00:25:31,300
order<font color="#E5E5E5"> when you open the document</font><font color="#CCCCCC"> with</font>

546
00:25:29,350 --> 00:25:33,520
<font color="#CCCCCC">our protected view</font><font color="#E5E5E5"> the VBA engine</font>

547
00:25:31,300 --> 00:25:35,379
<font color="#CCCCCC">actually loads in advance before</font><font color="#E5E5E5"> the</font>

548
00:25:33,520 --> 00:25:38,080
document is fully loaded in order to

549
00:25:35,380 --> 00:25:41,290
make world load faster all sorts of

550
00:25:38,080 --> 00:25:43,149
<font color="#CCCCCC">optimizations I'm not sure</font><font color="#E5E5E5"> so in fact</font>

551
00:25:41,290 --> 00:25:46,360
what you<font color="#CCCCCC"> will get when</font><font color="#E5E5E5"> you have</font>

552
00:25:43,150 --> 00:25:49,059
<font color="#E5E5E5">protected view disabled is first the</font>

553
00:25:46,360 --> 00:25:51,760
load of the<font color="#CCCCCC"> vba engine then the document</font>

554
00:25:49,059 --> 00:25:53,620
<font color="#E5E5E5">would load and then you will have all</font>

555
00:25:51,760 --> 00:25:57,850
<font color="#CCCCCC">the content within the document</font><font color="#E5E5E5"> being</font>

556
00:25:53,620 --> 00:26:00,370
loaded<font color="#CCCCCC"> as well</font><font color="#E5E5E5"> so if the user has enable</font>

557
00:25:57,850 --> 00:26:02,860
editing and enable<font color="#CCCCCC"> content</font><font color="#E5E5E5"> the sandbox</font>

558
00:26:00,370 --> 00:26:04,809
will say enable<font color="#CCCCCC"> content and enable</font>

559
00:26:02,860 --> 00:26:08,559
editing<font color="#E5E5E5"> and it's this difference</font><font color="#CCCCCC"> that</font>

560
00:26:04,809 --> 00:26:10,780
I'm gonna rely on for my attack<font color="#E5E5E5"> and I</font>

561
00:26:08,559 --> 00:26:12,970
need<font color="#CCCCCC"> to use and you'll understand what</font>

562
00:26:10,780 --> 00:26:16,090
I'm<font color="#CCCCCC"> talking about</font><font color="#E5E5E5"> just</font><font color="#CCCCCC"> in a sec I</font><font color="#E5E5E5"> need</font>

563
00:26:12,970 --> 00:26:18,220
to use these<font color="#E5E5E5"> two prompts for my</font>

564
00:26:16,090 --> 00:26:21,428
detection scheme and as Microsoft kindly

565
00:26:18,220 --> 00:26:23,790
suggested using images<font color="#CCCCCC"> I will use and</font>

566
00:26:21,429 --> 00:26:27,840
images it will<font color="#E5E5E5"> use it will be used as</font>

567
00:26:23,790 --> 00:26:30,909
some<font color="#E5E5E5"> sort of a tracking pieces sorry and</font>

568
00:26:27,840 --> 00:26:35,879
let's craft<font color="#E5E5E5"> an attack out</font><font color="#CCCCCC"> of this</font>

569
00:26:30,910 --> 00:26:35,880
so<font color="#E5E5E5"> imagine me I'm an attacker</font>

570
00:26:37,840 --> 00:26:44,149
<font color="#E5E5E5">I'm an</font><font color="#CCCCCC"> otaku and</font><font color="#E5E5E5"> I want to craft an</font>

571
00:26:40,429 --> 00:26:46,190
attack basing<font color="#CCCCCC"> on these facts</font><font color="#E5E5E5"> so I craft</font>

572
00:26:44,149 --> 00:26:47,570
<font color="#E5E5E5">a document and I send it</font><font color="#CCCCCC"> to the user</font><font color="#E5E5E5"> and</font>

573
00:26:46,190 --> 00:26:51,559
this<font color="#E5E5E5"> is what it looks like from the</font>

574
00:26:47,570 --> 00:26:53,750
<font color="#CCCCCC">sandbox</font><font color="#E5E5E5"> perspective so the sandbox opens</font>

575
00:26:51,559 --> 00:26:56,539
<font color="#E5E5E5">the document and there is no protected</font>

576
00:26:53,750 --> 00:26:59,269
view<font color="#E5E5E5"> the VBA engine loads immediately</font>

577
00:26:56,539 --> 00:27:01,190
before the document has loaded<font color="#E5E5E5"> causing</font>

578
00:26:59,269 --> 00:27:05,649
the<font color="#E5E5E5"> VBA referencing to happen and this</font>

579
00:27:01,190 --> 00:27:08,299
causes<font color="#E5E5E5"> requests to fetch the VBA code</font>

580
00:27:05,649 --> 00:27:11,840
<font color="#CCCCCC">once this is</font><font color="#E5E5E5"> done the document is loaded</font>

581
00:27:08,299 --> 00:27:14,259
<font color="#E5E5E5">and it will load</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> rest of the content</font>

582
00:27:11,840 --> 00:27:17,029
in this case it's an image for example

583
00:27:14,259 --> 00:27:18,950
<font color="#E5E5E5">and so this is the sandbox and</font>

584
00:27:17,029 --> 00:27:20,870
<font color="#CCCCCC">protective is disabled</font><font color="#E5E5E5"> and if we talk</font>

585
00:27:18,950 --> 00:27:22,820
about<font color="#E5E5E5"> the user it's completely</font><font color="#CCCCCC"> different</font>

586
00:27:20,870 --> 00:27:23,989
<font color="#E5E5E5">so we have protected view enabled this</font>

587
00:27:22,820 --> 00:27:27,710
<font color="#E5E5E5">is the lock sign in here</font>

588
00:27:23,990 --> 00:27:29,929
and the user opens the<font color="#E5E5E5"> document</font><font color="#CCCCCC"> so this</font>

589
00:27:27,710 --> 00:27:31,490
<font color="#CCCCCC">document contains</font><font color="#E5E5E5"> nothing at the</font><font color="#CCCCCC"> moment</font>

590
00:27:29,929 --> 00:27:33,740
everything<font color="#CCCCCC"> is blocked</font><font color="#E5E5E5"> you can't do</font>

591
00:27:31,490 --> 00:27:35,149
anything<font color="#E5E5E5"> about</font><font color="#CCCCCC"> it</font><font color="#E5E5E5"> if you want to do</font>

592
00:27:33,740 --> 00:27:39,940
something<font color="#CCCCCC"> please click enable editing</font>

593
00:27:35,149 --> 00:27:43,008
<font color="#E5E5E5">and most users click it they</font><font color="#CCCCCC"> just do</font><font color="#E5E5E5"> so</font>

594
00:27:39,940 --> 00:27:46,669
<font color="#E5E5E5">you get the suspicious</font><font color="#CCCCCC"> internet files</font>

595
00:27:43,009 --> 00:27:48,440
<font color="#E5E5E5">first in this case the image now if you</font>

596
00:27:46,669 --> 00:27:50,509
want to have the full experience<font color="#E5E5E5"> of the</font>

597
00:27:48,440 --> 00:27:53,210
document if you<font color="#E5E5E5"> trust it</font><font color="#CCCCCC"> or whatnot</font>

598
00:27:50,509 --> 00:27:55,100
please click enable content<font color="#E5E5E5"> causing the</font>

599
00:27:53,210 --> 00:27:58,100
VBA engine to loan<font color="#E5E5E5"> VBA referencing</font>

600
00:27:55,100 --> 00:28:00,529
happen and actually fetching the remote

601
00:27:58,100 --> 00:28:02,178
VBA code so we<font color="#CCCCCC"> can spot a difference in</font>

602
00:28:00,529 --> 00:28:04,399
here this<font color="#CCCCCC"> is what it looks</font><font color="#E5E5E5"> like if it's</font>

603
00:28:02,179 --> 00:28:07,370
a<font color="#E5E5E5"> sandbox you will have VBA code and</font>

604
00:28:04,399 --> 00:28:10,699
then image if it's a user<font color="#E5E5E5"> completely</font>

605
00:28:07,370 --> 00:28:14,090
<font color="#E5E5E5">different we have an image and then code</font>

606
00:28:10,700 --> 00:28:16,909
so as an attacker<font color="#CCCCCC"> I craft</font><font color="#E5E5E5"> a document</font>

607
00:28:14,090 --> 00:28:20,779
which<font color="#E5E5E5"> tries to load an</font><font color="#CCCCCC"> image and the VBA</font>

608
00:28:16,909 --> 00:28:23,000
code<font color="#E5E5E5"> from my server and i host these two</font>

609
00:28:20,779 --> 00:28:26,000
files and<font color="#CCCCCC"> i just send the document and</font>

610
00:28:23,000 --> 00:28:29,809
sit and wait<font color="#CCCCCC"> for the requests to arrive</font>

611
00:28:26,000 --> 00:28:34,700
<font color="#E5E5E5">and this is the logic</font><font color="#CCCCCC"> behind the</font>

612
00:28:29,809 --> 00:28:36,740
attackers<font color="#E5E5E5"> server so if the attacker is</font>

613
00:28:34,700 --> 00:28:41,500
witnessing requests for the<font color="#E5E5E5"> VBA code</font>

614
00:28:36,740 --> 00:28:44,570
before<font color="#E5E5E5"> requests for the image so VBA</font>

615
00:28:41,500 --> 00:28:47,280
before the image then it must<font color="#E5E5E5"> be a</font>

616
00:28:44,570 --> 00:28:49,110
<font color="#E5E5E5">sandbox right</font>

617
00:28:47,280 --> 00:28:50,610
and if it's the<font color="#CCCCCC"> other way around</font><font color="#E5E5E5"> if you</font>

618
00:28:49,110 --> 00:28:53,969
see requests for an image before

619
00:28:50,610 --> 00:28:57,179
requests for the<font color="#CCCCCC"> VBA code then</font><font color="#E5E5E5"> this must</font>

620
00:28:53,970 --> 00:29:00,480
<font color="#E5E5E5">be a user image and then VBA code</font><font color="#CCCCCC"> so I</font>

621
00:28:57,180 --> 00:29:02,340
can get a very reliable<font color="#CCCCCC"> verdict</font><font color="#E5E5E5"> basing</font>

622
00:29:00,480 --> 00:29:04,170
on these requests on<font color="#CCCCCC"> the order of</font><font color="#E5E5E5"> the</font>

623
00:29:02,340 --> 00:29:06,330
requests so I'm intercepting the

624
00:29:04,170 --> 00:29:09,420
requests<font color="#CCCCCC"> and I'm looking at the order</font>

625
00:29:06,330 --> 00:29:11,370
<font color="#CCCCCC">and I can decide</font><font color="#E5E5E5"> which is which</font><font color="#CCCCCC"> so I</font>

626
00:29:09,420 --> 00:29:13,650
have my verdict<font color="#E5E5E5"> and this is the</font>

627
00:29:11,370 --> 00:29:16,050
detection<font color="#E5E5E5"> part and the detection part is</font>

628
00:29:13,650 --> 00:29:19,170
now over<font color="#E5E5E5"> and I'm moving on</font><font color="#CCCCCC"> to evading</font>

629
00:29:16,050 --> 00:29:21,360
the sandbox<font color="#E5E5E5"> so I'm intercepting the</font>

630
00:29:19,170 --> 00:29:23,970
requests and<font color="#CCCCCC"> the user</font><font color="#E5E5E5"> the victim is</font>

631
00:29:21,360 --> 00:29:28,050
waiting for me to reply with<font color="#E5E5E5"> the image</font>

632
00:29:23,970 --> 00:29:31,890
<font color="#CCCCCC">and</font><font color="#E5E5E5"> the VBA code</font><font color="#CCCCCC"> so in this part once I</font>

633
00:29:28,050 --> 00:29:34,800
have my verdict<font color="#CCCCCC"> I can say okay</font><font color="#E5E5E5"> if the</font>

634
00:29:31,890 --> 00:29:38,160
verdict is a sandbox<font color="#CCCCCC"> I will reply with a</font>

635
00:29:34,800 --> 00:29:41,580
benign VBA project<font color="#E5E5E5"> it will have nothing</font>

636
00:29:38,160 --> 00:29:44,010
<font color="#E5E5E5">in it it will do nothing</font><font color="#CCCCCC"> and it's not</font>

637
00:29:41,580 --> 00:29:46,439
suspicious<font color="#E5E5E5"> at all and if it's the user</font>

638
00:29:44,010 --> 00:29:49,290
<font color="#E5E5E5">which I want to in fact I will reply</font>

639
00:29:46,440 --> 00:29:52,140
<font color="#CCCCCC">with a malicious</font><font color="#E5E5E5"> VBA project and I won't</font>

640
00:29:49,290 --> 00:29:55,770
<font color="#E5E5E5">tell you how</font><font color="#CCCCCC"> I did this it's a</font><font color="#E5E5E5"> top</font>

641
00:29:52,140 --> 00:29:57,540
<font color="#CCCCCC">secret</font><font color="#E5E5E5"> it's not at all</font><font color="#CCCCCC"> two documents</font>

642
00:29:55,770 --> 00:30:00,750
<font color="#E5E5E5">with the same name</font><font color="#CCCCCC"> that I'm simply</font>

643
00:29:57,540 --> 00:30:03,659
<font color="#CCCCCC">swapping</font><font color="#E5E5E5"> between them</font><font color="#CCCCCC"> before allowing</font>

644
00:30:00,750 --> 00:30:05,130
<font color="#CCCCCC">two packet to go through this is from</font>

645
00:30:03,660 --> 00:30:07,410
the sandbox point of view so the sandbox

646
00:30:05,130 --> 00:30:10,080
open the document<font color="#E5E5E5"> no protected view VBA</font>

647
00:30:07,410 --> 00:30:11,730
referencing happens<font color="#E5E5E5"> requests go to the</font>

648
00:30:10,080 --> 00:30:14,220
attackers machine<font color="#E5E5E5"> asking</font><font color="#CCCCCC"> for the code</font>

649
00:30:11,730 --> 00:30:16,680
<font color="#E5E5E5">the attacker asks himself</font><font color="#CCCCCC"> okay have I</font>

650
00:30:14,220 --> 00:30:20,310
seen the requests before<font color="#E5E5E5"> or after the</font>

651
00:30:16,680 --> 00:30:22,920
image<font color="#E5E5E5"> he says before and so the victim</font>

652
00:30:20,310 --> 00:30:24,510
gets<font color="#CCCCCC"> their happy piece of code</font><font color="#E5E5E5"> nothing</font>

653
00:30:22,920 --> 00:30:28,140
bad<font color="#E5E5E5"> nothing suspicious</font><font color="#CCCCCC"> everything is</font>

654
00:30:24,510 --> 00:30:31,230
good<font color="#CCCCCC"> with him and the document keeps on</font>

655
00:30:28,140 --> 00:30:33,210
<font color="#CCCCCC">loading</font><font color="#E5E5E5"> image is loaded</font><font color="#CCCCCC"> and nothing bad</font>

656
00:30:31,230 --> 00:30:35,310
happens<font color="#E5E5E5"> right</font><font color="#CCCCCC"> there's nothing malicious</font>

657
00:30:33,210 --> 00:30:37,710
in this piece<font color="#E5E5E5"> of code so the sandbox</font>

658
00:30:35,310 --> 00:30:40,679
<font color="#E5E5E5">suspects</font><font color="#CCCCCC"> nothing and passes</font><font color="#E5E5E5"> it on to the</font>

659
00:30:37,710 --> 00:30:42,540
user the user<font color="#E5E5E5"> opens the document clicks</font>

660
00:30:40,680 --> 00:30:44,550
enable editing causing the image to load

661
00:30:42,540 --> 00:30:47,220
<font color="#E5E5E5">the attacker notes that the image has</font>

662
00:30:44,550 --> 00:30:49,860
<font color="#E5E5E5">loaded and keeps on going the user</font>

663
00:30:47,220 --> 00:30:51,600
clicks<font color="#E5E5E5"> enable content VBA engine loads</font>

664
00:30:49,860 --> 00:30:54,659
VBA referencing and now the attacker

665
00:30:51,600 --> 00:30:57,480
gets requests for the VBA code that had

666
00:30:54,660 --> 00:31:00,490
image requests<font color="#E5E5E5"> beforehand the attacker</font>

667
00:30:57,480 --> 00:31:02,440
<font color="#CCCCCC">knows he notices</font><font color="#E5E5E5"> that and says</font><font color="#CCCCCC"> ok</font>

668
00:31:00,490 --> 00:31:04,990
let's<font color="#E5E5E5"> provide with the malicious piece</font>

669
00:31:02,440 --> 00:31:08,230
of code the search<font color="#E5E5E5"> phase very bad and so</font>

670
00:31:04,990 --> 00:31:10,500
this ends up with the user<font color="#E5E5E5"> infection</font>

671
00:31:08,230 --> 00:31:17,679
effectively that's<font color="#E5E5E5"> a sandbox evasion</font>

672
00:31:10,500 --> 00:31:39,610
<font color="#E5E5E5">agreed yeah okay demo hopefully yeah</font>

673
00:31:17,679 --> 00:31:42,120
<font color="#CCCCCC">okay so let's see okay so I have my</font>

674
00:31:39,610 --> 00:31:50,260
attackers machine right here

675
00:31:42,120 --> 00:31:52,540
<font color="#E5E5E5">intercepting waiting for requests okay</font>

676
00:31:50,260 --> 00:31:54,460
<font color="#E5E5E5">and this</font><font color="#CCCCCC"> is</font><font color="#E5E5E5"> the document</font><font color="#CCCCCC"> that I'm going</font>

677
00:31:52,540 --> 00:31:57,159
<font color="#CCCCCC">to send to the victim and</font><font color="#E5E5E5"> then pass it</font>

678
00:31:54,460 --> 00:31:59,350
on<font color="#CCCCCC"> to the user and I</font><font color="#E5E5E5"> don't have a</font>

679
00:31:57,160 --> 00:32:01,030
sandbox<font color="#CCCCCC"> on this machine</font><font color="#E5E5E5"> so I'm going to</font>

680
00:31:59,350 --> 00:32:02,860
simulate it<font color="#CCCCCC"> with the</font><font color="#E5E5E5"> same billing and</font>

681
00:32:01,030 --> 00:32:06,428
enabling protected<font color="#CCCCCC"> view simultaneously</font>

682
00:32:02,860 --> 00:32:09,909
so once you enable content<font color="#E5E5E5"> on a document</font>

683
00:32:06,429 --> 00:32:11,830
<font color="#E5E5E5">it's becoming a trusted document and</font>

684
00:32:09,910 --> 00:32:14,620
office won't enable protected view again

685
00:32:11,830 --> 00:32:16,899
<font color="#E5E5E5">so I've opened this document before</font><font color="#CCCCCC"> it's</font>

686
00:32:14,620 --> 00:32:18,340
currently trusted<font color="#CCCCCC"> ok so there's not</font>

687
00:32:16,900 --> 00:32:20,890
gonna be any protected view on<font color="#E5E5E5"> this</font>

688
00:32:18,340 --> 00:32:30,730
<font color="#CCCCCC">document</font><font color="#E5E5E5"> and this is what it will</font><font color="#CCCCCC"> look</font>

689
00:32:20,890 --> 00:32:33,040
like<font color="#CCCCCC"> ok</font><font color="#E5E5E5"> so it opened</font><font color="#CCCCCC"> on my machine but</font>

690
00:32:30,730 --> 00:32:34,780
<font color="#CCCCCC">you can see the document is opened the</font>

691
00:32:33,040 --> 00:32:45,399
<font color="#CCCCCC">image is loaded</font><font color="#E5E5E5"> but if we look at the</font>

692
00:32:34,780 --> 00:32:47,379
code so call call me we've seen this

693
00:32:45,400 --> 00:32:49,000
before<font color="#CCCCCC"> now call</font><font color="#E5E5E5"> me function call me</font>

694
00:32:47,380 --> 00:32:52,270
function<font color="#CCCCCC"> is in here and it's actually</font>

695
00:32:49,000 --> 00:32:55,570
empty<font color="#E5E5E5"> nothing is happening so it's a</font>

696
00:32:52,270 --> 00:32:59,590
benign document and if we look at<font color="#E5E5E5"> this</font>

697
00:32:55,570 --> 00:33:03,210
piece<font color="#CCCCCC"> of code we can see sandbox</font><font color="#E5E5E5"> very</font>

698
00:32:59,590 --> 00:33:03,209
<font color="#CCCCCC">good okay so</font>

699
00:33:07,150 --> 00:33:11,700
let's change the name<font color="#CCCCCC"> of this document</font>

700
00:33:16,590 --> 00:33:26,679
okay now when I<font color="#CCCCCC"> open this document it</font>

701
00:33:24,700 --> 00:33:28,750
should open<font color="#E5E5E5"> in protected view and I hope</font>

702
00:33:26,680 --> 00:33:35,200
you'll<font color="#E5E5E5"> get to see this on this screen</font>

703
00:33:28,750 --> 00:33:37,120
hold on<font color="#E5E5E5"> okay</font>

704
00:33:35,200 --> 00:33:38,920
so protective you<font color="#E5E5E5"> enable the document</font>

705
00:33:37,120 --> 00:33:40,270
effectively does nothing at the<font color="#CCCCCC"> moment</font>

706
00:33:38,920 --> 00:33:42,640
and you<font color="#E5E5E5"> can see the linked image cannot</font>

707
00:33:40,270 --> 00:33:45,460
be displayed<font color="#E5E5E5"> la blah blah so let's</font>

708
00:33:42,640 --> 00:33:48,040
enable content<font color="#E5E5E5"> enable editing</font><font color="#CCCCCC"> sorry</font><font color="#E5E5E5"> and</font>

709
00:33:45,460 --> 00:33:49,510
the image has<font color="#E5E5E5"> loaded</font>

710
00:33:48,040 --> 00:33:52,120
that's very cool<font color="#E5E5E5"> if you trust the</font>

711
00:33:49,510 --> 00:33:55,240
document it has macros<font color="#E5E5E5"> in</font><font color="#CCCCCC"> E enable it so</font>

712
00:33:52,120 --> 00:34:01,719
we enable the document<font color="#E5E5E5"> and we've been</font>

713
00:33:55,240 --> 00:34:05,170
hacked let's have a look at the code so

714
00:34:01,720 --> 00:34:09,550
Walt book<font color="#CCCCCC"> oops sorry</font><font color="#E5E5E5"> is the same but if</font>

715
00:34:05,170 --> 00:34:11,500
we<font color="#CCCCCC"> look at the module we have user form</font>

716
00:34:09,550 --> 00:34:13,419
dot show so this<font color="#CCCCCC"> is effectively code</font>

717
00:34:11,500 --> 00:34:14,918
execution I could have done whatever I

718
00:34:13,418 --> 00:34:18,699
wanted at this stage<font color="#CCCCCC"> it just wanted</font><font color="#E5E5E5"> to</font>

719
00:34:14,918 --> 00:34:35,739
<font color="#CCCCCC">visualize it for you and sandbox evasion</font>

720
00:34:18,699 --> 00:34:37,060
<font color="#CCCCCC">right thank you okay let's see it's</font><font color="#E5E5E5"> not</font>

721
00:34:35,739 --> 00:34:40,209
the best piece of<font color="#CCCCCC"> code</font><font color="#E5E5E5"> I'll give you</font>

722
00:34:37,060 --> 00:34:42,940
<font color="#E5E5E5">that</font><font color="#CCCCCC"> okay</font><font color="#E5E5E5"> so I prefer the video but</font><font color="#CCCCCC"> we</font>

723
00:34:40,210 --> 00:34:45,010
can skip<font color="#E5E5E5"> that</font><font color="#CCCCCC"> and okay</font><font color="#E5E5E5"> so we've tested</font>

724
00:34:42,940 --> 00:34:48,870
several<font color="#E5E5E5"> of sandbox solutions on this</font>

725
00:34:45,010 --> 00:34:51,879
topic and I'm not going to name any

726
00:34:48,870 --> 00:34:54,520
<font color="#E5E5E5">solution open source commercial both and</font>

727
00:34:51,879 --> 00:34:56,409
we were able<font color="#CCCCCC"> to evade all of them but</font>

728
00:34:54,520 --> 00:34:58,650
<font color="#E5E5E5">that's not the main issue all of them</font>

729
00:34:56,409 --> 00:35:01,240
will be evaded<font color="#E5E5E5"> but we found out</font><font color="#CCCCCC"> more</font>

730
00:34:58,650 --> 00:35:04,690
alarming issues as well so<font color="#CCCCCC"> first of all</font>

731
00:35:01,240 --> 00:35:06,549
some<font color="#CCCCCC"> of them block SMB which is</font><font color="#E5E5E5"> even</font>

732
00:35:04,690 --> 00:35:08,560
better<font color="#CCCCCC"> for me because the sandbox should</font>

733
00:35:06,550 --> 00:35:10,060
allow everything to execute and

734
00:35:08,560 --> 00:35:13,180
everything to<font color="#CCCCCC"> happen and</font><font color="#E5E5E5"> if you block</font>

735
00:35:10,060 --> 00:35:15,370
SMB for example in this attack<font color="#CCCCCC"> I get my</font>

736
00:35:13,180 --> 00:35:17,830
<font color="#E5E5E5">chance because the document will do</font>

737
00:35:15,370 --> 00:35:19,420
<font color="#E5E5E5">nothing and it will fetch nothing so the</font>

738
00:35:17,830 --> 00:35:20,910
sandbox<font color="#E5E5E5"> will suspect nothing</font>

739
00:35:19,420 --> 00:35:23,220
<font color="#E5E5E5">it will pass it on to the</font>

740
00:35:20,910 --> 00:35:26,490
<font color="#E5E5E5">and if the user has SMB enabled for</font>

741
00:35:23,220 --> 00:35:29,519
example then I get my chance<font color="#CCCCCC"> so</font><font color="#E5E5E5"> this is</font>

742
00:35:26,490 --> 00:35:32,879
<font color="#E5E5E5">something</font><font color="#CCCCCC"> to note some other sandbox</font>

743
00:35:29,519 --> 00:35:34,769
solutions allow SMB<font color="#E5E5E5"> but don't bother to</font>

744
00:35:32,880 --> 00:35:37,349
inspect what's coming so in this case it

745
00:35:34,769 --> 00:35:40,470
was a<font color="#CCCCCC"> VBA project that had</font><font color="#E5E5E5"> a user forum</font>

746
00:35:37,349 --> 00:35:42,869
<font color="#CCCCCC">within with text</font><font color="#E5E5E5"> and an image and I can</font>

747
00:35:40,470 --> 00:35:46,049
have for<font color="#E5E5E5"> example a piece of code of a</font>

748
00:35:42,869 --> 00:35:49,380
binary file<font color="#E5E5E5"> base64 encoded embedded</font>

749
00:35:46,049 --> 00:35:51,630
within this<font color="#E5E5E5"> user</font><font color="#CCCCCC"> form</font><font color="#E5E5E5"> which will then be</font>

750
00:35:49,380 --> 00:35:53,210
extracted<font color="#CCCCCC"> with the macros and executed</font>

751
00:35:51,630 --> 00:35:56,609
<font color="#E5E5E5">so you can actually get the second stage</font>

752
00:35:53,210 --> 00:35:59,099
dropping<font color="#E5E5E5"> with this technique so</font><font color="#CCCCCC"> you have</font>

753
00:35:56,609 --> 00:36:00,750
to inspect what's coming as well<font color="#CCCCCC"> and the</font>

754
00:35:59,099 --> 00:36:03,119
final<font color="#E5E5E5"> thing</font><font color="#CCCCCC"> to consider is that</font><font color="#E5E5E5"> this is</font>

755
00:36:00,750 --> 00:36:05,069
not the<font color="#CCCCCC"> only way to perform</font><font color="#E5E5E5"> this attack</font>

756
00:36:03,119 --> 00:36:07,319
this is just<font color="#CCCCCC"> the</font><font color="#E5E5E5"> concept</font><font color="#CCCCCC"> you can do</font>

757
00:36:05,069 --> 00:36:09,359
<font color="#E5E5E5">pretty much</font><font color="#CCCCCC"> the same with PDF</font><font color="#E5E5E5"> it has a</font>

758
00:36:07,319 --> 00:36:12,119
JavaScript engine<font color="#E5E5E5"> it has its own</font>

759
00:36:09,359 --> 00:36:14,549
protected<font color="#E5E5E5"> view and</font><font color="#CCCCCC"> just a few day a</font><font color="#E5E5E5"> week</font>

760
00:36:12,119 --> 00:36:16,319
ago I<font color="#E5E5E5"> think a researcher from</font><font color="#CCCCCC"> checkpoint</font>

761
00:36:14,549 --> 00:36:19,950
has shown that<font color="#E5E5E5"> you</font><font color="#CCCCCC"> can actually</font><font color="#E5E5E5"> fetch</font>

762
00:36:16,319 --> 00:36:22,920
<font color="#E5E5E5">remote elements which will</font><font color="#CCCCCC"> lick the ntlm</font>

763
00:36:19,950 --> 00:36:26,279
hash but<font color="#E5E5E5"> will do will you so it will be</font>

764
00:36:22,920 --> 00:36:28,500
used as the<font color="#E5E5E5"> beacon that we used pretty</font>

765
00:36:26,279 --> 00:36:30,630
<font color="#E5E5E5">much the same so this concept can be</font>

766
00:36:28,500 --> 00:36:32,579
applied<font color="#CCCCCC"> to PDF and I'm guessing more</font>

767
00:36:30,630 --> 00:36:37,170
elements as well<font color="#E5E5E5"> something to think</font>

768
00:36:32,579 --> 00:36:40,019
about mitigation so first of all block

769
00:36:37,170 --> 00:36:42,329
SMB<font color="#E5E5E5"> an FTP should walk in this attack as</font>

770
00:36:40,019 --> 00:36:44,669
well<font color="#E5E5E5"> on the user and inbound and</font>

771
00:36:42,329 --> 00:36:47,099
outbound<font color="#CCCCCC"> and shouldn't be there and</font>

772
00:36:44,670 --> 00:36:49,369
<font color="#E5E5E5">don't block it on the sandbox the</font>

773
00:36:47,099 --> 00:36:53,009
sandbox<font color="#E5E5E5"> has to be as loose as possible</font>

774
00:36:49,369 --> 00:36:54,930
<font color="#E5E5E5">but as allowing as possible in terms of</font>

775
00:36:53,009 --> 00:36:57,089
communication for<font color="#E5E5E5"> the</font><font color="#CCCCCC"> model to actually</font>

776
00:36:54,930 --> 00:37:00,149
<font color="#E5E5E5">achieve its full potential</font><font color="#CCCCCC"> then</font><font color="#E5E5E5"> you can</font>

777
00:36:57,089 --> 00:37:03,150
<font color="#E5E5E5">detect it in full second of all and this</font>

778
00:37:00,150 --> 00:37:04,529
<font color="#E5E5E5">is my probably the most important you</font>

779
00:37:03,150 --> 00:37:06,569
<font color="#CCCCCC">have to</font><font color="#E5E5E5"> think</font><font color="#CCCCCC"> about your sandbox</font>

780
00:37:04,529 --> 00:37:10,849
environment<font color="#E5E5E5"> at mostly the analysis</font>

781
00:37:06,569 --> 00:37:14,038
machines<font color="#E5E5E5"> and decide whether you want to</font>

782
00:37:10,849 --> 00:37:15,839
redesign the concept<font color="#CCCCCC"> it will cost you</font>

783
00:37:14,039 --> 00:37:18,150
because if you enable protected<font color="#E5E5E5"> view you</font>

784
00:37:15,839 --> 00:37:20,160
will have to pay with automation<font color="#E5E5E5"> and</font>

785
00:37:18,150 --> 00:37:22,740
within<font color="#E5E5E5"> the analysis machine and time</font>

786
00:37:20,160 --> 00:37:28,410
costs<font color="#E5E5E5"> this is usually</font><font color="#CCCCCC"> applied at the</font>

787
00:37:22,740 --> 00:37:32,008
<font color="#E5E5E5">vendor at the vendor</font><font color="#CCCCCC"> site but you have</font>

788
00:37:28,410 --> 00:37:34,788
to<font color="#E5E5E5"> think about it one other thing you</font>

789
00:37:32,009 --> 00:37:37,309
<font color="#E5E5E5">can do is restrict</font><font color="#CCCCCC"> Internet</font>

790
00:37:34,789 --> 00:37:40,189
from office or PDF in this case<font color="#E5E5E5"> because</font>

791
00:37:37,309 --> 00:37:42,919
I don't see any reason for world or

792
00:37:40,189 --> 00:37:46,399
<font color="#E5E5E5">Excel documents to which online targets</font>

793
00:37:42,919 --> 00:37:48,919
but that's maybe just<font color="#E5E5E5"> me</font><font color="#CCCCCC"> and one final</font>

794
00:37:46,400 --> 00:37:51,349
<font color="#CCCCCC">thing you</font><font color="#E5E5E5"> can do is shift instead of</font>

795
00:37:48,919 --> 00:37:53,509
detecting malicious behavior<font color="#E5E5E5"> you can</font>

796
00:37:51,349 --> 00:37:55,189
<font color="#E5E5E5">move to content</font><font color="#CCCCCC"> disarming and</font>

797
00:37:53,509 --> 00:37:58,009
reconstruction where you take<font color="#CCCCCC"> the file</font>

798
00:37:55,189 --> 00:37:59,779
and<font color="#CCCCCC"> you strip it</font><font color="#E5E5E5"> from all</font><font color="#CCCCCC"> of its element</font>

799
00:37:58,009 --> 00:38:02,349
<font color="#E5E5E5">and then you reconstruct it according to</font>

800
00:37:59,779 --> 00:38:04,849
<font color="#E5E5E5">the specification eliminating the</font>

801
00:38:02,349 --> 00:38:08,719
malicious<font color="#E5E5E5"> and suspicious part out and</font><font color="#CCCCCC"> so</font>

802
00:38:04,849 --> 00:38:10,910
the user gets the<font color="#CCCCCC"> same file</font><font color="#E5E5E5"> and no</font>

803
00:38:08,719 --> 00:38:12,679
interruption it takes less time<font color="#E5E5E5"> and the</font>

804
00:38:10,910 --> 00:38:18,229
whole user experience<font color="#E5E5E5"> remains the same</font>

805
00:38:12,679 --> 00:38:20,569
<font color="#CCCCCC">so it's something to consider</font><font color="#E5E5E5"> and so we</font>

806
00:38:18,229 --> 00:38:22,549
talked about<font color="#E5E5E5"> sandboxes trying to avoid</font>

807
00:38:20,569 --> 00:38:24,739
becoming<font color="#CCCCCC"> a bottleneck and so they</font>

808
00:38:22,549 --> 00:38:27,169
disable security mitigations<font color="#E5E5E5"> and we</font>

809
00:38:24,739 --> 00:38:28,999
talked about<font color="#E5E5E5"> vba referencing enable us</font>

810
00:38:27,169 --> 00:38:31,969
to fetch code from remote machines and

811
00:38:28,999 --> 00:38:34,038
we combine these two<font color="#E5E5E5"> to achieve sandbox</font>

812
00:38:31,969 --> 00:38:38,599
detection server-side sandbox detection

813
00:38:34,039 --> 00:38:40,459
and sandbox<font color="#E5E5E5"> evasion and we didn't break</font>

814
00:38:38,599 --> 00:38:43,249
anything<font color="#CCCCCC"> we didn't use a vulnerability</font>

815
00:38:40,459 --> 00:38:45,379
<font color="#E5E5E5">and we didn't target specific sandbox of</font>

816
00:38:43,249 --> 00:38:48,948
a specific product<font color="#E5E5E5"> within the</font><font color="#CCCCCC"> sandbox we</font>

817
00:38:45,380 --> 00:38:52,699
used the sandbox as logic and<font color="#E5E5E5"> we abused</font>

818
00:38:48,949 --> 00:38:55,249
<font color="#E5E5E5">the</font><font color="#CCCCCC"> vba legitimate features which ended</font>

819
00:38:52,699 --> 00:38:57,199
up in infecting the<font color="#E5E5E5"> user</font><font color="#CCCCCC"> so if you can</font>

820
00:38:55,249 --> 00:38:59,718
<font color="#E5E5E5">identify a key difference</font><font color="#CCCCCC"> between a user</font>

821
00:38:57,199 --> 00:39:02,169
and the sandbox<font color="#E5E5E5"> you can actually achieve</font>

822
00:38:59,719 --> 00:39:05,749
<font color="#E5E5E5">sandbox detection and</font><font color="#CCCCCC"> server-side</font>

823
00:39:02,169 --> 00:39:07,819
<font color="#E5E5E5">detection even better if you</font><font color="#CCCCCC"> can combine</font>

824
00:39:05,749 --> 00:39:09,799
this with some kind<font color="#CCCCCC"> of code referencing</font>

825
00:39:07,819 --> 00:39:11,509
or text referencing and then evaluate

826
00:39:09,799 --> 00:39:13,969
this kind of<font color="#E5E5E5"> text then you can achieve</font>

827
00:39:11,509 --> 00:39:16,249
sandbox evasion<font color="#CCCCCC"> and because sandbox is</font>

828
00:39:13,969 --> 00:39:19,429
also<font color="#E5E5E5"> heavily used and</font><font color="#CCCCCC"> trusted</font><font color="#E5E5E5"> in the</font>

829
00:39:16,249 --> 00:39:21,979
industry if you have sandbox<font color="#E5E5E5"> evasion you</font>

830
00:39:19,429 --> 00:39:24,849
most<font color="#CCCCCC"> likely end</font><font color="#E5E5E5"> up</font><font color="#CCCCCC"> with user infection</font>

831
00:39:21,979 --> 00:39:27,089
<font color="#CCCCCC">at</font><font color="#E5E5E5"> the end and that's it</font>

832
00:39:24,849 --> 00:39:29,800
thank you very<font color="#CCCCCC"> much questions</font>

833
00:39:27,090 --> 00:39:37,300
[Music]

834
00:39:29,800 --> 00:39:39,800
so so it's a feature another<font color="#CCCCCC"> balk</font><font color="#E5E5E5"> right</font>

835
00:39:37,300 --> 00:39:44,150
thanks for<font color="#E5E5E5"> sharing this it's a really</font>

836
00:39:39,800 --> 00:39:46,130
amazing technique<font color="#CCCCCC"> my question is because</font>

837
00:39:44,150 --> 00:39:48,320
<font color="#E5E5E5">you said if you block the outgoing</font>

838
00:39:46,130 --> 00:39:50,420
traffic to SMB it will be effectively

839
00:39:48,320 --> 00:39:53,120
<font color="#E5E5E5">blocked</font><font color="#CCCCCC"> this this method</font><font color="#E5E5E5"> because it is</font>

840
00:39:50,420 --> 00:39:56,540
not<font color="#E5E5E5"> able then to download the reference</font>

841
00:39:53,120 --> 00:39:59,480
the document<font color="#E5E5E5"> right yeah</font><font color="#CCCCCC"> is it possible</font>

842
00:39:56,540 --> 00:40:02,150
<font color="#E5E5E5">to use any other protocol other than SMB</font>

843
00:39:59,480 --> 00:40:04,040
to get the remote<font color="#E5E5E5"> document like over</font>

844
00:40:02,150 --> 00:40:06,650
HTTP<font color="#E5E5E5"> I don't know if office actually</font>

845
00:40:04,040 --> 00:40:08,720
<font color="#E5E5E5">allows</font><font color="#CCCCCC"> it</font><font color="#E5E5E5"> but so yeah that's a</font><font color="#CCCCCC"> very good</font>

846
00:40:06,650 --> 00:40:10,520
question and I've<font color="#E5E5E5"> tried using different</font>

847
00:40:08,720 --> 00:40:12,290
protocols for that<font color="#E5E5E5"> I have tried FTP</font>

848
00:40:10,520 --> 00:40:14,270
which seems<font color="#CCCCCC"> to work but it's kind of</font>

849
00:40:12,290 --> 00:40:16,190
buggy<font color="#CCCCCC"> as I said you can't really rely on</font>

850
00:40:14,270 --> 00:40:16,640
office products to behave the way they

851
00:40:16,190 --> 00:40:19,190
should

852
00:40:16,640 --> 00:40:21,740
you<font color="#CCCCCC"> can just you just can predict it so</font>

853
00:40:19,190 --> 00:40:23,210
I I'm guessing I'm going out on<font color="#E5E5E5"> a</font><font color="#CCCCCC"> limb</font>

854
00:40:21,740 --> 00:40:26,060
and<font color="#E5E5E5"> saying FTP should walk</font>

855
00:40:23,210 --> 00:40:29,930
I've tried HTTP<font color="#E5E5E5"> and it didn't work so</font>

856
00:40:26,060 --> 00:40:32,570
well but it's really<font color="#CCCCCC"> hard for</font><font color="#E5E5E5"> me</font><font color="#CCCCCC"> to tell</font>

857
00:40:29,930 --> 00:40:36,460
<font color="#CCCCCC">because I might as well just say yes</font><font color="#E5E5E5"> and</font>

858
00:40:32,570 --> 00:40:36,460
<font color="#E5E5E5">let you touch the</font><font color="#CCCCCC"> ball over</font><font color="#E5E5E5"> to your side</font>

859
00:40:36,970 --> 00:40:46,060
yeah<font color="#E5E5E5"> thank you anyone else</font>

860
00:40:48,010 --> 00:40:53,940
<font color="#CCCCCC">all right</font><font color="#E5E5E5"> I guess</font><font color="#CCCCCC"> the dinner</font><font color="#E5E5E5"> wins so</font>

861
00:40:51,040 --> 00:40:53,940
<font color="#E5E5E5">thanks Sammy</font>

862
00:40:56,030 --> 00:40:59,159
[Music]

