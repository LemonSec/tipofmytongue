1
00:00:00,000 --> 00:00:06,480
yeah yeah<font color="#E5E5E5"> all right cool well thank you</font>

2
00:00:04,319 --> 00:00:08,519
<font color="#CCCCCC">so</font><font color="#E5E5E5"> much</font><font color="#CCCCCC"> and thank you especially cyber</font>

3
00:00:06,480 --> 00:00:10,769
cotton<font color="#CCCCCC"> too it's a my privilege to be</font>

4
00:00:08,519 --> 00:00:12,269
back here and definitely<font color="#E5E5E5"> more of a</font>

5
00:00:10,769 --> 00:00:13,830
technical talk last time last<font color="#E5E5E5"> year I</font>

6
00:00:12,269 --> 00:00:15,750
just<font color="#E5E5E5"> yelled at everyone for 20 minutes</font>

7
00:00:13,830 --> 00:00:17,640
so but you<font color="#E5E5E5"> know this</font><font color="#CCCCCC"> is me definitely</font>

8
00:00:15,750 --> 00:00:18,990
more technical so<font color="#E5E5E5"> monitor vision</font>

9
00:00:17,640 --> 00:00:21,689
techniques what this talk is all about

10
00:00:18,990 --> 00:00:24,180
is basically just<font color="#CCCCCC"> work arounds work</font>

11
00:00:21,689 --> 00:00:27,420
around that we find our industry and

12
00:00:24,180 --> 00:00:28,590
what works against different different

13
00:00:27,420 --> 00:00:31,980
technological components and what

14
00:00:28,590 --> 00:00:36,750
doesn't so first of all as a as a pen

15
00:00:31,980 --> 00:00:38,550
tester we we stand on the shoulders of

16
00:00:36,750 --> 00:00:39,899
giants when it comes to tools right we

17
00:00:38,550 --> 00:00:42,029
don't write all of our own tools I<font color="#E5E5E5"> use</font>

18
00:00:39,899 --> 00:00:43,590
tools like you know Callie and and

19
00:00:42,030 --> 00:00:45,120
<font color="#E5E5E5">metasploit an empire and those are</font>

20
00:00:43,590 --> 00:00:47,969
written by<font color="#E5E5E5"> some very very very smart</font>

21
00:00:45,120 --> 00:00:50,669
people and right there<font color="#CCCCCC"> jerrison 12 and</font>

22
00:00:47,969 --> 00:00:51,960
celeb trades 60 and<font color="#CCCCCC"> the rest of dads</font>

23
00:00:50,670 --> 00:00:54,629
owner there those are<font color="#E5E5E5"> people that I go</font>

24
00:00:51,960 --> 00:00:56,129
<font color="#E5E5E5">to my friends my co-workers</font><font color="#CCCCCC"> and when</font>

25
00:00:54,629 --> 00:00:57,809
<font color="#E5E5E5">oftentimes what you're going to hear me</font>

26
00:00:56,129 --> 00:01:00,000
present is not necessarily just my ideas

27
00:00:57,809 --> 00:01:02,250
but their ideas as well so I would<font color="#E5E5E5"> be</font>

28
00:01:00,000 --> 00:01:03,570
<font color="#E5E5E5">stupid and mean not to actually you know</font>

29
00:01:02,250 --> 00:01:06,659
throw shot us to them so thank you guys

30
00:01:03,570 --> 00:01:08,220
so top Ock's first things that were

31
00:01:06,659 --> 00:01:09,600
going to cover in fact these are this

32
00:01:08,220 --> 00:01:11,158
exactly we're going to see in fact<font color="#E5E5E5"> if</font>

33
00:01:09,600 --> 00:01:12,990
you're in the very back you might want

34
00:01:11,159 --> 00:01:15,509
to come up front because I'm going<font color="#E5E5E5"> to</font><font color="#CCCCCC"> be</font>

35
00:01:12,990 --> 00:01:17,759
presenting a couple demos that involve

36
00:01:15,509 --> 00:01:19,770
visual studio and ID in cali so if you

37
00:01:17,759 --> 00:01:21,270
can't see you might want to<font color="#E5E5E5"> just take a</font>

38
00:01:19,770 --> 00:01:22,560
second come on up<font color="#E5E5E5"> here so we're going to</font>

39
00:01:21,270 --> 00:01:26,670
talk about inline control workarounds

40
00:01:22,560 --> 00:01:29,159
<font color="#E5E5E5">and why in line controls i'm talking</font>

41
00:01:26,670 --> 00:01:30,900
<font color="#CCCCCC">like Palo Alto quarter net next-gen</font>

42
00:01:29,159 --> 00:01:32,549
email controls<font color="#E5E5E5"> proof point stuff like</font>

43
00:01:30,900 --> 00:01:34,200
that antivirus evasion and then some

44
00:01:32,549 --> 00:01:36,810
pelo customization at the very end so

45
00:01:34,200 --> 00:01:38,250
<font color="#E5E5E5">I'm gonna have to fly through this so I</font>

46
00:01:36,810 --> 00:01:39,600
<font color="#E5E5E5">I probably will not have time for</font>

47
00:01:38,250 --> 00:01:40,500
<font color="#E5E5E5">questions at the end of this talk but</font>

48
00:01:39,600 --> 00:01:42,089
I'm definitely gonna<font color="#E5E5E5"> be around tonight</font>

49
00:01:40,500 --> 00:01:45,090
so if you have questions just<font color="#E5E5E5"> by only to</font>

50
00:01:42,090 --> 00:01:48,030
come by me so<font color="#E5E5E5"> just look at about me I've</font>

51
00:01:45,090 --> 00:01:49,979
<font color="#E5E5E5">been doing infosec for 10 years both in</font>

52
00:01:48,030 --> 00:01:51,630
all offensive and defensive roles<font color="#CCCCCC"> I'm</font>

53
00:01:49,979 --> 00:01:53,009
<font color="#E5E5E5">currently a senior penetration tester</font>

54
00:01:51,630 --> 00:01:55,589
with center com which is based out of

55
00:01:53,009 --> 00:01:57,420
Brookfield Wisconsin and such<font color="#E5E5E5"> Caesar</font>

56
00:01:55,590 --> 00:01:59,310
Active Directory development Python

57
00:01:57,420 --> 00:02:02,490
PowerShell things like that so all right

58
00:01:59,310 --> 00:02:05,579
before<font color="#E5E5E5"> we go any further just a couple</font>

59
00:02:02,490 --> 00:02:08,128
things so first of all<font color="#E5E5E5"> this talk is not</font>

60
00:02:05,579 --> 00:02:09,660
<font color="#E5E5E5">going to hit the internet publicly and</font>

61
00:02:08,128 --> 00:02:12,269
the<font color="#E5E5E5"> reason</font><font color="#CCCCCC"> being is because I talk about</font>

62
00:02:09,660 --> 00:02:13,630
<font color="#E5E5E5">vendors good vendors span vendors yeah</font>

63
00:02:12,270 --> 00:02:15,640
I'm actually gonna drop some names

64
00:02:13,630 --> 00:02:17,230
how it goes so the talk is not<font color="#E5E5E5"> going to</font>

65
00:02:15,640 --> 00:02:21,160
<font color="#E5E5E5">eat</font><font color="#CCCCCC"> internet I'm not</font><font color="#E5E5E5"> going to lose the</font>

66
00:02:17,230 --> 00:02:23,049
slides either if you have the show say

67
00:02:21,160 --> 00:02:25,510
intestinal fortitude I have<font color="#E5E5E5"> the slides</font>

68
00:02:23,050 --> 00:02:27,340
available on this USB key you may come

69
00:02:25,510 --> 00:02:28,929
get them after<font color="#E5E5E5"> the talk if you so desire</font>

70
00:02:27,340 --> 00:02:30,700
by the way I don't know anything about

71
00:02:28,930 --> 00:02:32,380
infecting USB keys but seriously though

72
00:02:30,700 --> 00:02:36,310
just click enable content once you open

73
00:02:32,380 --> 00:02:40,720
those slides you can keep using so and

74
00:02:36,310 --> 00:02:42,100
it's far as a mini rant there's a train

75
00:02:40,720 --> 00:02:43,330
in infosec right now especially amongst

76
00:02:42,100 --> 00:02:44,829
red teamers in fact actually before even

77
00:02:43,330 --> 00:02:47,410
going for the red team in the audience

78
00:02:44,830 --> 00:02:50,650
<font color="#E5E5E5">real ready Murr like like 10</font><font color="#CCCCCC"> of you</font>

79
00:02:47,410 --> 00:02:53,230
cheese Louise blue team defenders<font color="#CCCCCC"> okay</font>

80
00:02:50,650 --> 00:02:56,260
all<font color="#E5E5E5"> right Georgie blue team</font><font color="#CCCCCC"> okay vendors</font>

81
00:02:53,230 --> 00:02:57,549
<font color="#E5E5E5">all right exits in the back vendors go</font>

82
00:02:56,260 --> 00:03:00,970
that way bring us all back a bunch<font color="#E5E5E5"> of</font>

83
00:02:57,550 --> 00:03:03,700
beer<font color="#E5E5E5"> all right vendor just get out but</font>

84
00:03:00,970 --> 00:03:05,859
the rant that<font color="#E5E5E5"> I have is</font><font color="#CCCCCC"> that there's a</font>

85
00:03:03,700 --> 00:03:07,119
train in infosec right now that goes

86
00:03:05,860 --> 00:03:08,950
something like this if you're a red team

87
00:03:07,120 --> 00:03:10,270
<font color="#CCCCCC">and you release like an awesome</font><font color="#E5E5E5"> tool or</font>

88
00:03:08,950 --> 00:03:12,339
a technique or something like that a

89
00:03:10,270 --> 00:03:13,330
bunch of other people just<font color="#E5E5E5"> like jump you</font>

90
00:03:12,340 --> 00:03:15,190
on<font color="#E5E5E5"> Twitter and say where's the</font>

91
00:03:13,330 --> 00:03:16,810
mitigations who's the mitigations you

92
00:03:15,190 --> 00:03:18,340
can't wait to without<font color="#CCCCCC"> a mitigation and</font>

93
00:03:16,810 --> 00:03:20,140
<font color="#E5E5E5">I'm here to tell you that I have a talk</font>

94
00:03:18,340 --> 00:03:21,700
and<font color="#E5E5E5"> I've workarounds and I have evasions</font>

95
00:03:20,140 --> 00:03:22,600
and I have no mitigation for i'm not

96
00:03:21,700 --> 00:03:25,929
going to release anything like that

97
00:03:22,600 --> 00:03:27,400
<font color="#E5E5E5">that's not my job so in fact my job is</font>

98
00:03:25,930 --> 00:03:28,990
to read to me i'm going<font color="#E5E5E5"> to divide the</font>

99
00:03:27,400 --> 00:03:30,760
room and<font color="#E5E5E5"> a half right now my job is red</font>

100
00:03:28,990 --> 00:03:32,230
camera is to break stuff your job is

101
00:03:30,760 --> 00:03:33,730
blue<font color="#E5E5E5"> tumors fixed up</font><font color="#CCCCCC"> okay i</font><font color="#E5E5E5"> will tell</font>

102
00:03:32,230 --> 00:03:35,829
you about the attack and then you can

103
00:03:33,730 --> 00:03:37,810
take that<font color="#E5E5E5"> knowledge about the attack and</font>

104
00:03:35,830 --> 00:03:39,790
then take it to your place<font color="#E5E5E5"> wherever you</font>

105
00:03:37,810 --> 00:03:41,470
work and put in the fix however<font color="#E5E5E5"> you see</font>

106
00:03:39,790 --> 00:03:42,670
<font color="#E5E5E5">said okay but don't expect me to drop a</font>

107
00:03:41,470 --> 00:03:44,350
bunch of your<font color="#E5E5E5"> rules the end of the</font><font color="#CCCCCC"> talks</font>

108
00:03:42,670 --> 00:03:45,790
<font color="#CCCCCC">you can just drag and drop under your</font>

109
00:03:44,350 --> 00:03:47,109
you know awesome<font color="#E5E5E5"> solution back or work</font>

110
00:03:45,790 --> 00:03:48,220
and block on my hard work because<font color="#E5E5E5"> i'm</font>

111
00:03:47,110 --> 00:03:53,110
not<font color="#E5E5E5"> going to do that so you're the blue</font>

112
00:03:48,220 --> 00:03:55,660
team's with lou harder<font color="#CCCCCC"> alright</font><font color="#E5E5E5"> inline</font>

113
00:03:53,110 --> 00:03:57,040
control inline control first of all what

114
00:03:55,660 --> 00:03:58,810
is in my control you know inline control

115
00:03:57,040 --> 00:04:01,870
is a network layer control that performs

116
00:03:58,810 --> 00:04:03,490
a real time to Rep reventon<font color="#CCCCCC"> okay so in</font>

117
00:04:01,870 --> 00:04:04,780
this case<font color="#E5E5E5"> i'm basically going to hone</font><font color="#CCCCCC"> in</font>

118
00:04:03,490 --> 00:04:07,120
on two solutions that i<font color="#CCCCCC"> think actually</font>

119
00:04:04,780 --> 00:04:09,010
do a pretty good job they are palo alto

120
00:04:07,120 --> 00:04:10,360
unfortunate<font color="#CCCCCC"> alright</font><font color="#E5E5E5"> whatever you think</font>

121
00:04:09,010 --> 00:04:12,040
in terms<font color="#E5E5E5"> of vendors this is my</font>

122
00:04:10,360 --> 00:04:13,840
<font color="#E5E5E5">experience as a pen tester you might</font>

123
00:04:12,040 --> 00:04:15,730
have completely different experience and

124
00:04:13,840 --> 00:04:18,040
you might not<font color="#E5E5E5"> use either these and you</font>

125
00:04:15,730 --> 00:04:19,750
think that you're you know firewall is

126
00:04:18,040 --> 00:04:20,799
the shizz and it does a fantastic job

127
00:04:19,750 --> 00:04:22,449
that's awesome<font color="#CCCCCC"> okay</font>

128
00:04:20,798 --> 00:04:24,008
this is my experience<font color="#CCCCCC"> working with</font><font color="#E5E5E5"> these</font>

129
00:04:22,449 --> 00:04:27,250
two they actually<font color="#CCCCCC"> do a pretty good job</font>

130
00:04:24,009 --> 00:04:31,060
when it comes to threat prevention ok so

131
00:04:27,250 --> 00:04:32,379
my the testing that I did and<font color="#CCCCCC"> and what</font>

132
00:04:31,060 --> 00:04:33,550
<font color="#E5E5E5">will get into actual test cases and</font>

133
00:04:32,379 --> 00:04:34,599
stuff like that but the testing that I

134
00:04:33,550 --> 00:04:36,819
did was performed with the fully

135
00:04:34,599 --> 00:04:39,819
licensed up-to-date<font color="#CCCCCC"> Palo Alto so</font>

136
00:04:36,819 --> 00:04:41,800
everything every check box that I could

137
00:04:39,819 --> 00:04:45,069
check I checked and what I ended up

138
00:04:41,800 --> 00:04:47,889
doing was taking standard payloads from

139
00:04:45,069 --> 00:04:49,750
meterpreter and<font color="#E5E5E5"> Empire and puffy and</font>

140
00:04:47,889 --> 00:04:51,610
custom interpreter and I ran them

141
00:04:49,750 --> 00:04:54,370
through my Palo Alto so the focus of

142
00:04:51,610 --> 00:04:56,169
<font color="#CCCCCC">this kind of test is not to determine</font>

143
00:04:54,370 --> 00:04:58,000
its<font color="#E5E5E5"> antivirus effective or not that's</font>

144
00:04:56,169 --> 00:05:00,490
not this about this<font color="#E5E5E5"> is to determine how</font>

145
00:04:58,000 --> 00:05:01,930
effective was the inline control and do

146
00:05:00,490 --> 00:05:04,000
i need<font color="#CCCCCC"> to work around anything on the</font>

147
00:05:01,930 --> 00:05:05,440
inline control ok so<font color="#CCCCCC"> meterpreter I</font>

148
00:05:04,000 --> 00:05:07,509
apologize we can't seem back if you

149
00:05:05,440 --> 00:05:09,729
can't see so let me know meterpreter is

150
00:05:07,509 --> 00:05:11,830
standard windows<font color="#CCCCCC"> 64-bit interpret</font>

151
00:05:09,729 --> 00:05:14,080
reverse<font color="#E5E5E5"> https sometime use all the time</font>

152
00:05:11,830 --> 00:05:16,810
its pen testers default certificate port

153
00:05:14,080 --> 00:05:18,639
443 and<font color="#CCCCCC"> xor encoding Empire if you're</font>

154
00:05:16,810 --> 00:05:21,099
not familiar with<font color="#E5E5E5"> Empire that is</font>

155
00:05:18,639 --> 00:05:24,969
basically<font color="#CCCCCC"> a it's a python-based server</font>

156
00:05:21,099 --> 00:05:27,279
with a full power shell<font color="#E5E5E5"> it all of the</font>

157
00:05:24,969 --> 00:05:29,319
modules and and all the agents run on

158
00:05:27,279 --> 00:05:31,960
<font color="#E5E5E5">PowerShell exclusively and it's meant in</font>

159
00:05:29,319 --> 00:05:35,500
a<font color="#CCCCCC"> windows environment</font><font color="#E5E5E5"> ok as far as puppy</font>

160
00:05:31,960 --> 00:05:37,150
goes if you've never heard<font color="#E5E5E5"> of puppy hmm</font>

161
00:05:35,500 --> 00:05:39,699
<font color="#CCCCCC">oh it's evil puppy is outstanding</font>

162
00:05:37,150 --> 00:05:41,440
probably uses the OB fs3 transport was

163
00:05:39,699 --> 00:05:43,930
the transport<font color="#CCCCCC"> use for the Tor network so</font>

164
00:05:41,440 --> 00:05:45,729
it's basically obfuscate et CP which

165
00:05:43,930 --> 00:05:47,080
means that<font color="#E5E5E5"> most inline controls don't</font>

166
00:05:45,729 --> 00:05:48,969
<font color="#E5E5E5">know what to do with it they're like no</font>

167
00:05:47,080 --> 00:05:49,900
I don't know what this means so<font color="#CCCCCC"> there</font>

168
00:05:48,969 --> 00:05:52,270
you go<font color="#E5E5E5"> I'll need to center right through</font>

169
00:05:49,900 --> 00:05:54,460
ok so a public fantastic and it's open

170
00:05:52,270 --> 00:05:56,440
source so this<font color="#CCCCCC"> being</font><font color="#E5E5E5"> open source rat</font><font color="#CCCCCC"> ok</font>

171
00:05:54,460 --> 00:05:58,870
and<font color="#E5E5E5"> I use the defaults airport over 3 as</font>

172
00:05:56,440 --> 00:06:01,569
<font color="#CCCCCC">well custom interpreter is C short code</font>

173
00:05:58,870 --> 00:06:04,090
that i pilfered from stack exchange and

174
00:06:01,569 --> 00:06:06,550
then hacked to do what<font color="#CCCCCC"> i</font><font color="#E5E5E5"> wanted to do</font>

175
00:06:04,090 --> 00:06:11,049
and then my victim machines windows 10

176
00:06:06,550 --> 00:06:12,250
and 17 both 64 bit windows defender was

177
00:06:11,050 --> 00:06:15,099
running on although<font color="#CCCCCC"> i didn't know at the</font>

178
00:06:12,250 --> 00:06:18,400
time and then just an idea about the

179
00:06:15,099 --> 00:06:19,599
<font color="#E5E5E5">palo alto configuration if anybody how</font>

180
00:06:18,400 --> 00:06:21,219
<font color="#CCCCCC">many guys are familiar parallel toes</font>

181
00:06:19,599 --> 00:06:23,860
anyone<font color="#CCCCCC"> alright gradually quite a few of</font>

182
00:06:21,219 --> 00:06:25,690
<font color="#E5E5E5">you that's great ok so URL filtering</font><font color="#CCCCCC"> i</font>

183
00:06:23,860 --> 00:06:26,979
had almost<font color="#E5E5E5"> all the categories now if the</font>

184
00:06:25,690 --> 00:06:28,419
pen says around<font color="#E5E5E5"> the city care about your</font>

185
00:06:26,979 --> 00:06:30,820
revolting because i can just<font color="#E5E5E5"> go out the</font>

186
00:06:28,419 --> 00:06:33,310
powers website and request that the

187
00:06:30,820 --> 00:06:34,580
category for my malicious domain gets

188
00:06:33,310 --> 00:06:36,710
changed to sports

189
00:06:34,580 --> 00:06:38,750
health is like<font color="#E5E5E5"> oh yeah yeah it sports</font>

190
00:06:36,710 --> 00:06:40,609
that's fine bone protection<font color="#E5E5E5"> I turn</font><font color="#CCCCCC"> on</font>

191
00:06:38,750 --> 00:06:42,860
all the things and in fact this stuff

192
00:06:40,610 --> 00:06:45,259
over<font color="#CCCCCC"> here these</font><font color="#E5E5E5"> are all the additional</font>

193
00:06:42,860 --> 00:06:47,180
vulnerability protection filters

194
00:06:45,259 --> 00:06:48,889
mechanisms rules not sure<font color="#E5E5E5"> there</font><font color="#CCCCCC"> are</font>

195
00:06:47,180 --> 00:06:50,210
<font color="#E5E5E5">terminologies that you can enable but as</font>

196
00:06:48,889 --> 00:06:54,319
you can see I needle a ton of them

197
00:06:50,210 --> 00:06:55,909
<font color="#E5E5E5">Empire metasploit meterpreter I enabled</font>

198
00:06:54,319 --> 00:06:58,400
a bunch of stuff<font color="#CCCCCC"> in fact I think I turn</font>

199
00:06:55,909 --> 00:07:00,409
<font color="#E5E5E5">on</font><font color="#CCCCCC"> an</font><font color="#E5E5E5"> additional 50 filters to try and</font>

200
00:06:58,400 --> 00:07:02,719
monitor for my malicious traffic and

201
00:07:00,409 --> 00:07:05,688
then final blocking I blocked all the

202
00:07:02,719 --> 00:07:08,030
files turn on antivirus anti-spyware and

203
00:07:05,689 --> 00:07:10,669
wildfires<font color="#CCCCCC"> well and the</font><font color="#E5E5E5"> last but not</font>

204
00:07:08,030 --> 00:07:14,000
least and this is really the<font color="#E5E5E5"> big hitter</font>

205
00:07:10,669 --> 00:07:16,580
SSL decryption if you're not using SSL

206
00:07:14,000 --> 00:07:19,520
decryption your environment see me after

207
00:07:16,580 --> 00:07:23,210
<font color="#CCCCCC">class let's talk</font><font color="#E5E5E5"> about the results</font>

208
00:07:19,520 --> 00:07:27,469
meterpreter this is like<font color="#E5E5E5"> I said standard</font>

209
00:07:23,210 --> 00:07:30,349
stock meterpreter this was actually this

210
00:07:27,469 --> 00:07:33,259
got caught with SSL decryption so you

211
00:07:30,349 --> 00:07:35,330
can see over on this<font color="#E5E5E5"> top that is the</font>

212
00:07:33,259 --> 00:07:39,650
actual<font color="#E5E5E5"> Palo Alto a message that came</font>

213
00:07:35,330 --> 00:07:42,080
back and it identified correctly as as

214
00:07:39,650 --> 00:07:44,299
interpreter and so with that episode the

215
00:07:42,080 --> 00:07:46,520
crip<font color="#CCCCCC"> shun my reverse https alfond</font>

216
00:07:44,300 --> 00:07:48,529
connection was halted and then a new and

217
00:07:46,520 --> 00:07:50,180
then the traffic was inspected and then

218
00:07:48,529 --> 00:07:52,039
a new connection was established by the

219
00:07:50,180 --> 00:07:53,930
Palo Alto so so deep packet inspection

220
00:07:52,039 --> 00:07:55,339
was taking place on that attack and

221
00:07:53,930 --> 00:07:59,029
that's how it identified it as

222
00:07:55,339 --> 00:08:01,219
meterpreter and really interesting

223
00:07:59,029 --> 00:08:02,900
behavior so if your pen tester this this

224
00:08:01,219 --> 00:08:04,849
<font color="#E5E5E5">is interesting and I had never</font><font color="#CCCCCC"> expected</font>

225
00:08:02,900 --> 00:08:06,109
<font color="#E5E5E5">where I'd experienced this on a test but</font>

226
00:08:04,849 --> 00:08:08,539
I finally was able to duplicate it

227
00:08:06,110 --> 00:08:10,759
reliably in my lab environment this

228
00:08:08,539 --> 00:08:12,919
behavior happened right here I would get

229
00:08:10,759 --> 00:08:14,659
a shell and then 10 seconds clear the

230
00:08:12,919 --> 00:08:16,310
show would die and then the show would

231
00:08:14,659 --> 00:08:18,919
come back and<font color="#CCCCCC"> 10 things later shell with</font>

232
00:08:16,310 --> 00:08:21,319
that and and this is what was happening

233
00:08:18,919 --> 00:08:22,940
when that pack so the the traffic was

234
00:08:21,319 --> 00:08:24,830
going through the Palo Alto paula was

235
00:08:22,940 --> 00:08:26,960
inspecting and then<font color="#E5E5E5"> actually determining</font>

236
00:08:24,830 --> 00:08:28,400
<font color="#CCCCCC">oh your malicious and then killing the</font>

237
00:08:26,960 --> 00:08:30,020
connection but<font color="#E5E5E5"> after the</font><font color="#CCCCCC"> connection was</font>

238
00:08:28,400 --> 00:08:32,689
established there was like five to<font color="#CCCCCC"> 10</font>

239
00:08:30,020 --> 00:08:34,519
second window where I had a shell and I

240
00:08:32,690 --> 00:08:36,079
don't you might actually like auto run

241
00:08:34,519 --> 00:08:37,698
scripts<font color="#CCCCCC"> um something malicious during</font>

242
00:08:36,078 --> 00:08:39,500
that time I did not<font color="#CCCCCC"> try that</font><font color="#E5E5E5"> but can</font>

243
00:08:37,698 --> 00:08:41,149
tell across well now without SSL

244
00:08:39,500 --> 00:08:42,740
decryption and this is blooming weight

245
00:08:41,149 --> 00:08:43,889
without a cell decryption it just<font color="#CCCCCC"> it's</font>

246
00:08:42,740 --> 00:08:45,989
still right there

247
00:08:43,889 --> 00:08:48,179
stock meterpreter just flew right past

248
00:08:45,989 --> 00:08:51,989
the<font color="#CCCCCC"> Palo Alto and in fact this</font><font color="#E5E5E5"> was</font>

249
00:08:48,179 --> 00:08:54,420
actually before I remembered that I had

250
00:08:51,989 --> 00:08:56,160
windows defender on and and i was i was

251
00:08:54,420 --> 00:08:57,389
doing doing this testing and I'm

252
00:08:56,160 --> 00:08:59,459
thinking to myself okay windows<font color="#E5E5E5"> defender</font>

253
00:08:57,389 --> 00:09:03,329
should pop up in<font color="#E5E5E5"> a second now and it did</font>

254
00:08:59,459 --> 00:09:08,309
and that's when it's the<font color="#CCCCCC"> tenor message</font>

255
00:09:03,329 --> 00:09:12,540
that I got<font color="#CCCCCC"> sweet so Microsoft and nailed</font>

256
00:09:08,309 --> 00:09:14,040
it on that one<font color="#CCCCCC"> Empire</font><font color="#E5E5E5"> Empire is the tool</font>

257
00:09:12,540 --> 00:09:17,069
that generally speaking I prefer<font color="#CCCCCC"> to land</font>

258
00:09:14,040 --> 00:09:19,679
with in my fishing campaigns Empire is

259
00:09:17,069 --> 00:09:21,719
is fantastic Empire sales through

260
00:09:19,679 --> 00:09:23,279
everything Palo Alto is like oh now

261
00:09:21,720 --> 00:09:25,499
you're that's<font color="#E5E5E5"> a little traffic yeah</font>

262
00:09:23,279 --> 00:09:27,569
you're fine agent agent agent and you do

263
00:09:25,499 --> 00:09:30,449
down<font color="#E5E5E5"> here</font><font color="#CCCCCC"> empire powershell payload I</font>

264
00:09:27,569 --> 00:09:32,549
hope specifically selected this in palo

265
00:09:30,449 --> 00:09:34,559
alto to be like hey block this stuff now

266
00:09:32,549 --> 00:09:36,959
now we're not gonna<font color="#CCCCCC"> block it</font><font color="#E5E5E5"> and it's</font>

267
00:09:34,559 --> 00:09:38,939
<font color="#E5E5E5">like I had not that I not customized the</font>

268
00:09:36,959 --> 00:09:40,979
frameworks in any way this<font color="#E5E5E5"> is just like</font>

269
00:09:38,939 --> 00:09:43,019
straight down one from good up okay and

270
00:09:40,980 --> 00:09:47,220
I just did right there alright<font color="#E5E5E5"> that's</font>

271
00:09:43,019 --> 00:09:49,470
cool puppy again<font color="#CCCCCC"> blue right there no</font>

272
00:09:47,220 --> 00:09:51,179
problems whatsoever<font color="#CCCCCC"> and interesting if</font>

273
00:09:49,470 --> 00:09:54,059
you look at this over<font color="#E5E5E5"> here I want to</font>

274
00:09:51,179 --> 00:09:57,929
draw attention this this right here kiss

275
00:09:54,059 --> 00:10:00,059
you where's decrypt unsupported<font color="#E5E5E5"> ur this</font>

276
00:09:57,929 --> 00:10:01,529
is what the Palo Alto does when it

277
00:10:00,059 --> 00:10:03,779
doesn't know it doesn't understand what

278
00:10:01,529 --> 00:10:05,879
you're doing it's like oh there's ssl

279
00:10:03,779 --> 00:10:07,829
here but then no but<font color="#E5E5E5"> then oh yeah</font>

280
00:10:05,879 --> 00:10:10,079
there's a cell and<font color="#E5E5E5"> then no and then you</font>

281
00:10:07,829 --> 00:10:11,729
know it's it's basically just wtfing

282
00:10:10,079 --> 00:10:13,859
it's like yeah yeah alright so my

283
00:10:11,730 --> 00:10:16,889
traffic through no problem he'll open Oh

284
00:10:13,860 --> 00:10:20,939
interestingly enough Windows Defender

285
00:10:16,889 --> 00:10:23,459
caught the puppy payload as when 32 pad

286
00:10:20,939 --> 00:10:25,349
of<font color="#CCCCCC"> poopie I don't so anyways I don't I</font>

287
00:10:23,459 --> 00:10:30,059
don't understand<font color="#CCCCCC"> I mean those are just</font>

288
00:10:25,350 --> 00:10:31,709
decisions<font color="#CCCCCC"> anyways agents for this</font><font color="#E5E5E5"> okay</font>

289
00:10:30,059 --> 00:10:32,819
how do<font color="#E5E5E5"> you why do you work around</font><font color="#CCCCCC"> the</font>

290
00:10:31,709 --> 00:10:34,709
<font color="#CCCCCC">Sun well as you can</font><font color="#E5E5E5"> see there wasn't a</font>

291
00:10:32,819 --> 00:10:37,049
serta lot to work around but I'm<font color="#E5E5E5"> gonna</font>

292
00:10:34,709 --> 00:10:38,819
give you a<font color="#CCCCCC"> couple of tricks that I</font><font color="#E5E5E5"> use</font>

293
00:10:37,049 --> 00:10:40,559
in my testing that makes<font color="#E5E5E5"> it a little</font>

294
00:10:38,819 --> 00:10:42,209
more difficult for defenders to<font color="#E5E5E5"> actually</font>

295
00:10:40,559 --> 00:10:43,980
catch on on what you're<font color="#CCCCCC"> doing first of</font>

296
00:10:42,209 --> 00:10:45,419
all if you're going to land with

297
00:10:43,980 --> 00:10:47,850
meterpreter and you're in your fishing

298
00:10:45,419 --> 00:10:50,429
campaign<font color="#E5E5E5"> okay use auxiliary gather and</font>

299
00:10:47,850 --> 00:10:51,389
person<font color="#CCCCCC"> SSL and what</font><font color="#E5E5E5"> that does geez you</font>

300
00:10:50,429 --> 00:10:52,230
probably cannot see that<font color="#E5E5E5"> in the back</font>

301
00:10:51,389 --> 00:10:54,300
what what that's

302
00:10:52,230 --> 00:10:57,360
is that you put in a<font color="#E5E5E5"> website in this</font>

303
00:10:54,300 --> 00:10:58,829
case w google com and it goes out to go

304
00:10:57,360 --> 00:11:00,720
we'll grab the certificate and then

305
00:10:58,830 --> 00:11:03,930
basically<font color="#CCCCCC"> it Stan's a new certificate</font>

306
00:11:00,720 --> 00:11:06,060
with Google's information and so you run

307
00:11:03,930 --> 00:11:08,790
your payload using that certificate and

308
00:11:06,060 --> 00:11:10,739
then the the the firewall just like oh

309
00:11:08,790 --> 00:11:13,530
yeah your google in fact<font color="#CCCCCC"> I was testing</font>

310
00:11:10,740 --> 00:11:15,210
this on on a<font color="#E5E5E5"> Ford Annette actually one</font>

311
00:11:13,530 --> 00:11:18,089
more thing before i get there when you

312
00:11:15,210 --> 00:11:19,980
do this when you run<font color="#E5E5E5"> ms that venom set</font>

313
00:11:18,090 --> 00:11:22,350
your stage verify its else are too true

314
00:11:19,980 --> 00:11:23,670
and your<font color="#CCCCCC"> handlers to sell certain</font><font color="#E5E5E5"> so set</font>

315
00:11:22,350 --> 00:11:26,760
those two options<font color="#E5E5E5"> and that's how you</font>

316
00:11:23,670 --> 00:11:29,310
actually use that certificate when when

317
00:11:26,760 --> 00:11:31,380
you<font color="#E5E5E5"> when your pelo connects back but I</font>

318
00:11:29,310 --> 00:11:33,630
was actually doing some testing up in

319
00:11:31,380 --> 00:11:37,050
northern Wisconsin with another firm who

320
00:11:33,630 --> 00:11:40,439
uses fortinet and and I crapped up this

321
00:11:37,050 --> 00:11:42,150
payload and they were they I send it

322
00:11:40,440 --> 00:11:43,770
through and I got a shell back and

323
00:11:42,150 --> 00:11:47,010
they're like okay let<font color="#CCCCCC"> us know when</font><font color="#E5E5E5"> you</font>

324
00:11:43,770 --> 00:11:49,050
click and I'm like I<font color="#CCCCCC"> clicked like what</font>

325
00:11:47,010 --> 00:11:50,939
did<font color="#E5E5E5"> you what happened is like I gotta</font>

326
00:11:49,050 --> 00:11:53,189
show click it again got another shelf

327
00:11:50,940 --> 00:11:58,890
and they're like well all we see is

328
00:11:53,190 --> 00:12:03,060
<font color="#E5E5E5">travis from google like yeah that's me</font>

329
00:11:58,890 --> 00:12:05,160
I'm<font color="#E5E5E5"> Google today alright so in line of</font>

330
00:12:03,060 --> 00:12:08,609
asians<font color="#CCCCCC"> i have to admit this is probably</font>

331
00:12:05,160 --> 00:12:10,680
the area where where I ended up short on

332
00:12:08,610 --> 00:12:12,930
in terms of what i really really really

333
00:12:10,680 --> 00:12:14,969
wanted to be able to get through

334
00:12:12,930 --> 00:12:16,380
meterpreter stock meterpreter through

335
00:12:14,970 --> 00:12:18,300
SSL decryption I was not able to<font color="#E5E5E5"> do it</font>

336
00:12:16,380 --> 00:12:20,610
<font color="#E5E5E5">in the time</font><font color="#CCCCCC"> I had a lot of for preparing</font>

337
00:12:18,300 --> 00:12:24,510
this talk but pay attention to

338
00:12:20,610 --> 00:12:26,400
decryption<font color="#E5E5E5"> detection patterns favorite</font>

339
00:12:24,510 --> 00:12:28,950
Empire and puppy over msf if you're

340
00:12:26,400 --> 00:12:30,030
<font color="#E5E5E5">getting infected</font><font color="#CCCCCC"> okay and hope that you</font>

341
00:12:28,950 --> 00:12:31,080
not work on the cisco fire well hope

342
00:12:30,030 --> 00:12:33,540
that<font color="#E5E5E5"> you are working</font><font color="#CCCCCC"> the cisco firewall</font>

343
00:12:31,080 --> 00:12:36,660
and the reason why I say that is cheese

344
00:12:33,540 --> 00:12:38,550
I'm sorry but<font color="#E5E5E5"> if your cisco cisco shop</font>

345
00:12:36,660 --> 00:12:40,800
they do not do threat prevention or

346
00:12:38,550 --> 00:12:43,020
maybe they do threat prevention and no

347
00:12:40,800 --> 00:12:44,520
one buys that solution but when when I

348
00:12:43,020 --> 00:12:47,460
test chops that<font color="#E5E5E5"> I have a cisco firewall</font>

349
00:12:44,520 --> 00:12:49,319
everything just flows right through it

350
00:12:47,460 --> 00:12:50,640
flies right through so if there is to

351
00:12:49,320 --> 00:12:52,440
prevention on a cisco<font color="#CCCCCC"> i would</font><font color="#E5E5E5"> love to</font>

352
00:12:50,640 --> 00:12:54,120
<font color="#E5E5E5">hear about it so that way i can tell my</font>

353
00:12:52,440 --> 00:12:56,100
customers actually used to be buying

354
00:12:54,120 --> 00:12:57,810
<font color="#E5E5E5">this firewall instead of you know the</font>

355
00:12:56,100 --> 00:12:58,660
<font color="#CCCCCC">a-si 5500 because that just it's just</font>

356
00:12:57,810 --> 00:13:01,959
not doing it

357
00:12:58,660 --> 00:13:03,160
so anyways yeah whenever I<font color="#E5E5E5"> whenever my</font>

358
00:13:01,959 --> 00:13:04,750
<font color="#CCCCCC">custard so yeah yeah we get the latest</font>

359
00:13:03,160 --> 00:13:07,719
<font color="#E5E5E5">gray cisco firewall some like me sweet</font>

360
00:13:04,750 --> 00:13:09,670
but anyways it's just this goes great

361
00:13:07,720 --> 00:13:10,930
just at the kitty where is this going

362
00:13:09,670 --> 00:13:16,329
the room you guys are awesome<font color="#E5E5E5"> okay</font>

363
00:13:10,930 --> 00:13:18,128
controls define anything that stops my

364
00:13:16,329 --> 00:13:19,599
fish from getting the inbox and that's

365
00:13:18,129 --> 00:13:20,829
really what I care about most now for

366
00:13:19,600 --> 00:13:22,509
this particular talks<font color="#E5E5E5"> I'm not going to</font>

367
00:13:20,829 --> 00:13:24,910
go into like all the various spam

368
00:13:22,509 --> 00:13:27,550
filters I'm i pretty much only care

369
00:13:24,910 --> 00:13:29,410
about next-gen spam filters okay like

370
00:13:27,550 --> 00:13:30,370
<font color="#E5E5E5">proof point mimecast Google's Panthro</font>

371
00:13:29,410 --> 00:13:32,949
there's Google sample there's that

372
00:13:30,370 --> 00:13:34,540
actually pretty decent in certain<font color="#CCCCCC"> cases</font>

373
00:13:32,949 --> 00:13:36,878
<font color="#E5E5E5">there in certain circumstances they just</font>

374
00:13:34,540 --> 00:13:39,939
<font color="#CCCCCC">Bay they feel hurt so a little bit</font><font color="#E5E5E5"> of a</font>

375
00:13:36,879 --> 00:13:41,829
story in terms of how this portion of

376
00:13:39,939 --> 00:13:42,910
talk<font color="#E5E5E5"> you in</font><font color="#CCCCCC"> carob I was sending</font><font color="#E5E5E5"> I was an</font>

377
00:13:41,829 --> 00:13:44,349
apprentice is sending a fish to a

378
00:13:42,910 --> 00:13:46,629
customer and in fact here's the phishing

379
00:13:44,350 --> 00:13:49,269
email so shooting there's no names in

380
00:13:46,629 --> 00:13:51,819
<font color="#E5E5E5">there sir quite</font><font color="#CCCCCC"> good</font><font color="#E5E5E5"> I'll give you</font>

381
00:13:49,269 --> 00:13:54,339
second to read codes often in fact i

382
00:13:51,819 --> 00:13:55,899
have my friend and co-worker<font color="#E5E5E5"> casey</font>

383
00:13:54,339 --> 00:13:57,639
<font color="#E5E5E5">camilleri in the front row here he's a</font>

384
00:13:55,899 --> 00:14:00,459
guy who put this email<font color="#CCCCCC"> together and this</font>

385
00:13:57,639 --> 00:14:03,459
<font color="#E5E5E5">is</font><font color="#CCCCCC"> my go to this email works ten times</font>

386
00:14:00,459 --> 00:14:05,410
out of<font color="#CCCCCC"> ten it is</font><font color="#E5E5E5"> fantastic you send this</font>

387
00:14:03,459 --> 00:14:09,518
thing to reach before<font color="#E5E5E5"> christmas oh my</font>

388
00:14:05,410 --> 00:14:11,529
gosh people's heads explode it's

389
00:14:09,519 --> 00:14:13,959
fantastic because and the reason<font color="#E5E5E5"> being</font>

390
00:14:11,529 --> 00:14:15,850
everyone everyone hates HR right

391
00:14:13,959 --> 00:14:18,369
everyone hates teacher all this email

392
00:14:15,850 --> 00:14:21,339
does is confirm all the reasons<font color="#E5E5E5"> why</font>

393
00:14:18,370 --> 00:14:22,839
everyone hates HR and so i had to tag it

394
00:14:21,339 --> 00:14:25,660
with we apologize for any inconvenience

395
00:14:22,839 --> 00:14:28,480
this may have caused to<font color="#E5E5E5"> babysit time I</font>

396
00:14:25,660 --> 00:14:31,000
just rub it in right and and people just

397
00:14:28,480 --> 00:14:34,269
click click<font color="#E5E5E5"> this it's like gangbusters a</font>

398
00:14:31,000 --> 00:14:37,449
fantastic so I i sent this with the

399
00:14:34,269 --> 00:14:39,730
attachment and you might recognize<font color="#CCCCCC"> the</font>

400
00:14:37,449 --> 00:14:42,819
formatting amusing office 365 another

401
00:14:39,730 --> 00:14:45,399
<font color="#E5E5E5">technique another tool there I so I sent</font>

402
00:14:42,819 --> 00:14:47,500
its with the attachment and it got back

403
00:14:45,399 --> 00:14:50,500
I got a message back just said oh this

404
00:14:47,500 --> 00:14:53,290
is<font color="#E5E5E5"> a virus</font><font color="#CCCCCC"> ok so I take the</font><font color="#E5E5E5"> cash run out</font>

405
00:14:50,500 --> 00:14:55,240
i'll put<font color="#CCCCCC"> a link in and i say and i hope</font>

406
00:14:53,290 --> 00:14:56,860
the files exactly follow on my tax<font color="#E5E5E5"> sir</font>

407
00:14:55,240 --> 00:14:58,959
when<font color="#E5E5E5"> i put a</font><font color="#CCCCCC"> lincoln and I'm like please</font>

408
00:14:56,860 --> 00:15:00,790
download the attachment here<font color="#E5E5E5"> ok so</font><font color="#CCCCCC"> I</font>

409
00:14:58,959 --> 00:15:02,589
send that off I do not get back a bounce

410
00:15:00,790 --> 00:15:05,889
saying that there's a virus<font color="#E5E5E5"> but</font><font color="#CCCCCC"> I get</font>

411
00:15:02,589 --> 00:15:07,689
back with in about 60 seconds I got 10

412
00:15:05,889 --> 00:15:10,819
to 15 clicks they all kind of look like

413
00:15:07,689 --> 00:15:13,488
this I just click click

414
00:15:10,819 --> 00:15:16,519
<font color="#CCCCCC">click click</font><font color="#E5E5E5"> I'm like what is going on</font>

415
00:15:13,489 --> 00:15:18,229
like they're<font color="#E5E5E5"> not they're not that dumb I</font>

416
00:15:16,519 --> 00:15:20,629
mean they're not they're not all gonna

417
00:15:18,229 --> 00:15:22,160
click like that fast I mean you know a

418
00:15:20,629 --> 00:15:23,689
<font color="#E5E5E5">verizon data breach investigation report</font>

419
00:15:22,160 --> 00:15:25,608
the average time from the time that<font color="#CCCCCC"> i</font>

420
00:15:23,689 --> 00:15:27,079
send a fish at<font color="#E5E5E5"> the time i get to the</font>

421
00:15:25,609 --> 00:15:29,119
time someone<font color="#E5E5E5"> opens an attachment is</font>

422
00:15:27,079 --> 00:15:32,299
about three minutes and 40 seconds that

423
00:15:29,119 --> 00:15:33,559
was rising DVR 2016<font color="#CCCCCC"> I believe so but in</font>

424
00:15:32,299 --> 00:15:35,509
this case I was getting click<font color="#E5E5E5"> after</font>

425
00:15:33,559 --> 00:15:37,759
click after<font color="#E5E5E5"> click repeatedly but I was</font>

426
00:15:35,509 --> 00:15:41,899
<font color="#E5E5E5">not getting any shells what the heck is</font>

427
00:15:37,759 --> 00:15:44,059
<font color="#E5E5E5">going on so in this case I I did after</font>

428
00:15:41,899 --> 00:15:47,209
about 60 seconds<font color="#E5E5E5"> I gotta bounce back</font>

429
00:15:44,059 --> 00:15:50,209
from office 365 and it said your email

430
00:15:47,209 --> 00:15:54,858
has a virus and it was<font color="#E5E5E5"> detected by mine</font>

431
00:15:50,209 --> 00:15:56,539
cast oh my oh never heard of it okay be

432
00:15:54,859 --> 00:15:58,160
sure everyone<font color="#CCCCCC"> else who I looked at my</font>

433
00:15:56,539 --> 00:16:00,470
customers MX record and here's<font color="#E5E5E5"> what you</font>

434
00:15:58,160 --> 00:16:01,669
got bunch<font color="#E5E5E5"> of mine cast entries like I</font>

435
00:16:00,470 --> 00:16:03,619
need<font color="#E5E5E5"> to know mine can't sit so Delta</font>

436
00:16:01,669 --> 00:16:05,149
mine cast calm and I do some research

437
00:16:03,619 --> 00:16:07,189
and they're very very<font color="#E5E5E5"> similar to prove</font>

438
00:16:05,149 --> 00:16:09,199
point which is that you send an email

439
00:16:07,189 --> 00:16:10,849
and there's a link<font color="#E5E5E5"> in the email but what</font>

440
00:16:09,199 --> 00:16:12,919
they're<font color="#CCCCCC"> gonna</font><font color="#E5E5E5"> do is like dynamic URL</font>

441
00:16:10,850 --> 00:16:14,839
analysis they'll actually go out grab

442
00:16:12,919 --> 00:16:16,399
attachments sandbox it see if it's

443
00:16:14,839 --> 00:16:19,159
malicious and you know they do all that

444
00:16:16,399 --> 00:16:21,559
work on<font color="#E5E5E5"> behalf of the user okay so in</font>

445
00:16:19,159 --> 00:16:22,789
this case in fact the only reason why I

446
00:16:21,559 --> 00:16:24,469
knew that is because they<font color="#E5E5E5"> put a fancy</font>

447
00:16:22,789 --> 00:16:25,970
little video on their website and so I

448
00:16:24,470 --> 00:16:28,489
just SAT there and watch live video in

449
00:16:25,970 --> 00:16:30,289
fact<font color="#E5E5E5"> there's a screenshot of my end user</font>

450
00:16:28,489 --> 00:16:34,399
not getting my email because his inbox

451
00:16:30,289 --> 00:16:36,319
was protected so I was not happy about

452
00:16:34,399 --> 00:16:37,819
that I'm sending a fish I'm putting<font color="#E5E5E5"> all</font>

453
00:16:36,319 --> 00:16:39,978
this work into it everyone thinks the

454
00:16:37,819 --> 00:16:41,329
fishing is easy and it's<font color="#CCCCCC"> not like hours</font>

455
00:16:39,979 --> 00:16:44,209
and hours to craft a good fishing

456
00:16:41,329 --> 00:16:46,549
campaign anyway<font color="#CCCCCC"> home of the</font><font color="#E5E5E5"> story so i</font>

457
00:16:44,209 --> 00:16:48,349
was i was just kind of sitting there<font color="#E5E5E5"> in</font>

458
00:16:46,549 --> 00:16:50,809
<font color="#E5E5E5">a WTF loop and I'm like what that go do</font>

459
00:16:48,350 --> 00:16:54,259
now and my co-worker Scott says to me oh

460
00:16:50,809 --> 00:16:55,549
you didn't use apache mod rewrite my

461
00:16:54,259 --> 00:16:57,559
reah it's got to fix<font color="#E5E5E5"> all your problems I</font>

462
00:16:55,549 --> 00:16:58,639
<font color="#E5E5E5">was like all right that's great I've</font>

463
00:16:57,559 --> 00:16:59,959
<font color="#CCCCCC">used a</font><font color="#E5E5E5"> pass you've never use mod rewrite</font>

464
00:16:58,639 --> 00:17:01,879
so I went<font color="#E5E5E5"> out and did some research on</font>

465
00:16:59,959 --> 00:17:03,409
my rewrite and it is fantastic so in

466
00:17:01,879 --> 00:17:04,730
order to get mod rewrite going what mod

467
00:17:03,409 --> 00:17:07,699
rewrite will do if you've never used it

468
00:17:04,730 --> 00:17:09,769
is it will take an incoming requests and

469
00:17:07,699 --> 00:17:11,959
then based on certain parameters like I

470
00:17:09,769 --> 00:17:13,909
don't know<font color="#E5E5E5"> regex or the IP that it's</font>

471
00:17:11,959 --> 00:17:15,470
coming<font color="#E5E5E5"> from you can have apache do</font>

472
00:17:13,909 --> 00:17:18,379
certain things with that<font color="#E5E5E5"> request like</font>

473
00:17:15,470 --> 00:17:22,159
forwarding so to get<font color="#CCCCCC"> that started you</font>

474
00:17:18,378 --> 00:17:24,230
set this in your default icon for your

475
00:17:22,159 --> 00:17:24,470
site's enable<font color="#E5E5E5"> okay and this basically a</font>

476
00:17:24,230 --> 00:17:26,839
lot

477
00:17:24,470 --> 00:17:29,270
this is the first step to getting<font color="#CCCCCC"> Apache</font>

478
00:17:26,839 --> 00:17:30,770
mod rewrite to work the<font color="#E5E5E5"> mod rewrite is</font>

479
00:17:29,270 --> 00:17:32,120
already included<font color="#E5E5E5"> by a patch if you just</font>

480
00:17:30,770 --> 00:17:35,960
apt-get install<font color="#CCCCCC"> Apache you get my</font>

481
00:17:32,120 --> 00:17:39,830
rewrite quite a fall<font color="#CCCCCC"> okay and then next</font>

482
00:17:35,960 --> 00:17:43,100
step is you create an htaccess file dot

483
00:17:39,830 --> 00:17:44,840
HD eight eight dot<font color="#CCCCCC"> H TXS file</font><font color="#E5E5E5"> okay in</font>

484
00:17:43,100 --> 00:17:46,370
your<font color="#E5E5E5"> Apache directory and oh by the way</font>

485
00:17:44,840 --> 00:17:48,559
I forgot to tell you guys if you see the

486
00:17:46,370 --> 00:17:49,610
picture icon that's probably if you're

487
00:17:48,559 --> 00:17:51,830
<font color="#E5E5E5">going to take a picture that might be</font>

488
00:17:49,610 --> 00:17:54,199
worthwhile taking picture up so in this

489
00:17:51,830 --> 00:17:56,570
particular case I simply created a bunch

490
00:17:54,200 --> 00:17:57,980
of conditions based on the addresses

491
00:17:56,570 --> 00:18:00,530
that have been coming in that I knew was

492
00:17:57,980 --> 00:18:02,059
not<font color="#CCCCCC"> my my customers landlink ok it was</font>

493
00:18:00,530 --> 00:18:03,980
not there when I<font color="#E5E5E5"> Pete so I create a</font>

494
00:18:02,059 --> 00:18:06,110
bunch of rewrite conditions and then I'm

495
00:18:03,980 --> 00:18:08,299
<font color="#E5E5E5">like oh well if you belong</font><font color="#CCCCCC"> to any one of</font>

496
00:18:06,110 --> 00:18:11,750
these at peace just send<font color="#CCCCCC"> that request</font>

497
00:18:08,299 --> 00:18:13,250
over to google com<font color="#CCCCCC"> okay so and oh by the</font>

498
00:18:11,750 --> 00:18:17,030
way I shadow to blue screen of Jeff's

499
00:18:13,250 --> 00:18:18,710
previous worker on adaptive subdivision

500
00:18:17,030 --> 00:18:22,399
of various group he was put together a

501
00:18:18,710 --> 00:18:24,770
ton of awesome information on red team

502
00:18:22,400 --> 00:18:26,570
infrastructure so I would HIGHLY highly

503
00:18:24,770 --> 00:18:28,250
recommend<font color="#E5E5E5"> you go out to his website and</font>

504
00:18:26,570 --> 00:18:29,840
read every single article because it

505
00:18:28,250 --> 00:18:33,140
will tell you how to<font color="#E5E5E5"> use apache for all</font>

506
00:18:29,840 --> 00:18:35,270
sorts of nefarious purposes so<font color="#E5E5E5"> I put</font>

507
00:18:33,140 --> 00:18:38,450
this in place and<font color="#E5E5E5"> then I send my email</font>

508
00:18:35,270 --> 00:18:41,210
again and this starts happening I get a

509
00:18:38,450 --> 00:18:43,850
bunch of clicks but notice they're all

510
00:18:41,210 --> 00:18:45,500
being<font color="#CCCCCC"> 302 all being redirecting</font>

511
00:18:43,850 --> 00:18:47,959
everyone's going out<font color="#E5E5E5"> to google and then</font>

512
00:18:45,500 --> 00:18:49,580
I sit back<font color="#E5E5E5"> I take a sip of my coffee and</font>

513
00:18:47,960 --> 00:18:52,250
<font color="#E5E5E5">then she'll start coming in and it's</font>

514
00:18:49,580 --> 00:18:53,990
just beautiful all right there's good

515
00:18:52,250 --> 00:18:55,760
work on<font color="#E5E5E5"> and everything it's absolutely</font>

516
00:18:53,990 --> 00:18:58,280
works for proof point as well<font color="#CCCCCC"> okay and</font>

517
00:18:55,760 --> 00:19:00,289
because you you're controlling the rules

518
00:18:58,280 --> 00:19:01,580
of the game at this point all right you

519
00:19:00,289 --> 00:19:03,530
know other technology works it's going

520
00:19:01,580 --> 00:19:05,149
to go out scan it and analyze that link

521
00:19:03,530 --> 00:19:06,678
but if you can control that request

522
00:19:05,150 --> 00:19:08,659
which you can you can send that request

523
00:19:06,679 --> 00:19:10,370
to wherever you want this case cool

524
00:19:08,659 --> 00:19:14,960
we're<font color="#E5E5E5"> great so it speaking of Google</font>

525
00:19:10,370 --> 00:19:19,879
what happens if your target is using

526
00:19:14,960 --> 00:19:22,220
gmail and so in this case I<font color="#CCCCCC"> if I want</font><font color="#E5E5E5"> to</font>

527
00:19:19,880 --> 00:19:24,830
send a malicious payload from a gmail

528
00:19:22,220 --> 00:19:26,179
account normally I use office 365 you

529
00:19:24,830 --> 00:19:27,559
know I'm a few<font color="#E5E5E5"> weeks and rugged niche in</font>

530
00:19:26,179 --> 00:19:29,750
a little bit but normally that's what I

531
00:19:27,559 --> 00:19:32,990
what I need but in some cases i use

532
00:19:29,750 --> 00:19:36,020
gmail however if<font color="#CCCCCC"> i want to upload an</font>

533
00:19:32,990 --> 00:19:37,580
attachment to google that contains<font color="#CCCCCC"> i</font>

534
00:19:36,020 --> 00:19:39,410
don't know because<font color="#E5E5E5"> it looks like this</font>

535
00:19:37,580 --> 00:19:41,060
I got some power shell naughtiness in

536
00:19:39,410 --> 00:19:42,830
here this is<font color="#E5E5E5"> basically just standard</font>

537
00:19:41,060 --> 00:19:45,500
Empire launcher so it looks<font color="#CCCCCC"> like just</font>

538
00:19:42,830 --> 00:19:47,389
basically for Empire stuff okay what

539
00:19:45,500 --> 00:19:52,670
happens that gets blocked who says buyer

540
00:19:47,390 --> 00:19:54,320
suteki<font color="#E5E5E5"> alright so when I look at Excel</font>

541
00:19:52,670 --> 00:19:56,270
spreadsheet and I upload them to notice

542
00:19:54,320 --> 00:19:59,090
<font color="#CCCCCC">your be calm and they have power shell</font>

543
00:19:56,270 --> 00:20:01,370
in them they all come back who's saying

544
00:19:59,090 --> 00:20:04,340
yes we caught you and you're like win32

545
00:20:01,370 --> 00:20:06,439
PowerShell dash children and that

546
00:20:04,340 --> 00:20:09,320
happens all the time so if you<font color="#E5E5E5"> look at</font>

547
00:20:06,440 --> 00:20:10,580
this code<font color="#E5E5E5"> and you see the arguments you</font>

548
00:20:09,320 --> 00:20:13,550
see the cookie the command line

549
00:20:10,580 --> 00:20:16,879
parameters how do you get this to happen

550
00:20:13,550 --> 00:20:19,220
how do you get it such<font color="#CCCCCC"> that you bypass</font>

551
00:20:16,880 --> 00:20:21,740
Google's virus checking and I can get my

552
00:20:19,220 --> 00:20:23,840
malicious<font color="#E5E5E5"> PowerShell based payload in my</font>

553
00:20:21,740 --> 00:20:28,580
excel spreadsheet how do<font color="#E5E5E5"> I get that into</font>

554
00:20:23,840 --> 00:20:36,679
a gmail message how many guesses well

555
00:20:28,580 --> 00:20:38,540
just like<font color="#E5E5E5"> that there is no joke I tested</font>

556
00:20:36,680 --> 00:20:41,030
this last night to make sure that<font color="#E5E5E5"> it</font>

557
00:20:38,540 --> 00:20:43,250
worked before keeping it in here simple

558
00:20:41,030 --> 00:20:46,340
string concatenation this is like the

559
00:20:43,250 --> 00:20:48,800
dumbest most basic most easiest of

560
00:20:46,340 --> 00:20:52,250
bypasses if you can even call it that

561
00:20:48,800 --> 00:20:54,710
and and it works flawlessly with Google

562
00:20:52,250 --> 00:20:56,420
I i have sent fish too many customers

563
00:20:54,710 --> 00:20:59,480
just doing simple string concatenation

564
00:20:56,420 --> 00:21:02,000
like that<font color="#CCCCCC"> all right so what happens if</font>

565
00:20:59,480 --> 00:21:04,640
you are sending<font color="#E5E5E5"> than someone who's using</font>

566
00:21:02,000 --> 00:21:06,920
google<font color="#CCCCCC"> okay so I I had a customer</font><font color="#E5E5E5"> that I</font>

567
00:21:04,640 --> 00:21:09,860
was testing and they were<font color="#CCCCCC"> using g sweet</font>

568
00:21:06,920 --> 00:21:12,950
so I believe<font color="#CCCCCC"> this if i recall</font><font color="#E5E5E5"> correctly</font>

569
00:21:09,860 --> 00:21:16,370
this is a educational institute and they

570
00:21:12,950 --> 00:21:18,920
had they were using g sweet for their

571
00:21:16,370 --> 00:21:20,540
for all of their their email and google

572
00:21:18,920 --> 00:21:22,340
docs and all that kind of stuff so when

573
00:21:20,540 --> 00:21:24,620
you send an email to them their domain

574
00:21:22,340 --> 00:21:27,169
simply resolve to google and all the the

575
00:21:24,620 --> 00:21:30,139
email was going to gmail well when i

576
00:21:27,170 --> 00:21:32,720
sent my fish and i got no shelves i sent

577
00:21:30,140 --> 00:21:34,340
to the everyone hates h our fish and i

578
00:21:32,720 --> 00:21:35,840
got no<font color="#CCCCCC"> shells and and</font><font color="#E5E5E5"> i was frustrated</font>

579
00:21:34,340 --> 00:21:38,000
cuz i'm like i always get shells of this

580
00:21:35,840 --> 00:21:40,040
fish and so I I contacted my customer

581
00:21:38,000 --> 00:21:42,830
and I'm like hey<font color="#E5E5E5"> uh just out of</font>

582
00:21:40,040 --> 00:21:44,870
curiosity<font color="#CCCCCC"> and you can tell</font><font color="#E5E5E5"> me it's okay</font>

583
00:21:42,830 --> 00:21:46,669
did this get caught by Google<font color="#CCCCCC"> Santos and</font>

584
00:21:44,870 --> 00:21:48,800
he's like yes okay alright that's<font color="#E5E5E5"> fine</font>

585
00:21:46,670 --> 00:21:50,410
all<font color="#E5E5E5"> they need to know and so I did some</font>

586
00:21:48,800 --> 00:21:51,700
investigation I just I

587
00:21:50,410 --> 00:21:52,870
actually talk<font color="#CCCCCC"> to kiesha again</font><font color="#E5E5E5"> I'm like</font>

588
00:21:51,700 --> 00:21:56,890
<font color="#CCCCCC">Casey you help me figure this out and</font>

589
00:21:52,870 --> 00:22:00,189
and<font color="#CCCCCC"> Kate said oh you forgot this we're</font>

590
00:21:56,890 --> 00:22:02,980
<font color="#E5E5E5">just a standard SPF record and so I</font>

591
00:22:00,190 --> 00:22:04,930
added my standard SPF record to my

592
00:22:02,980 --> 00:22:06,730
naughty domain this is the correct

593
00:22:04,930 --> 00:22:11,140
that's we have<font color="#E5E5E5"> record to use for office</font>

594
00:22:06,730 --> 00:22:13,510
365 so on my evil domain evil domain com

595
00:22:11,140 --> 00:22:16,360
I went out and add an SPF record to this

596
00:22:13,510 --> 00:22:18,550
and set my fish again and<font color="#E5E5E5"> girl was like</font>

597
00:22:16,360 --> 00:22:21,850
oh you have an SPF record you're good

598
00:22:18,550 --> 00:22:25,960
right a right to<font color="#CCCCCC"> michelle's coming ok</font>

599
00:22:21,850 --> 00:22:27,699
simple simple<font color="#E5E5E5"> workarounds so as far</font><font color="#CCCCCC"> as</font>

600
00:22:25,960 --> 00:22:29,440
email number one off you<font color="#CCCCCC"> skip your</font>

601
00:22:27,700 --> 00:22:30,820
<font color="#E5E5E5">payload it doesn't have to be fancy like</font>

602
00:22:29,440 --> 00:22:32,410
it like it's<font color="#E5E5E5"> just a simple string</font>

603
00:22:30,820 --> 00:22:34,720
concatenation generally<font color="#CCCCCC"> speaking will</font>

604
00:22:32,410 --> 00:22:37,120
work<font color="#E5E5E5"> frequently all right number two</font>

605
00:22:34,720 --> 00:22:38,350
<font color="#E5E5E5">sent your SPF record this is important</font>

606
00:22:37,120 --> 00:22:39,939
so when you go out to godaddy and

607
00:22:38,350 --> 00:22:42,760
register your evil domain now you pay

608
00:22:39,940 --> 00:22:46,750
$13<font color="#CCCCCC"> alright you can control the full</font><font color="#E5E5E5"> dns</font>

609
00:22:42,760 --> 00:22:49,000
so create a txt record that it that uses

610
00:22:46,750 --> 00:22:50,530
the @ symbol for<font color="#E5E5E5"> the host so it covers</font>

611
00:22:49,000 --> 00:22:52,900
all entries all-in-one interest to that

612
00:22:50,530 --> 00:22:55,330
and then set your SPF data to what you

613
00:22:52,900 --> 00:22:56,530
just saw<font color="#E5E5E5"> ok so yes</font><font color="#CCCCCC"> fifth record number</font>

614
00:22:55,330 --> 00:22:58,030
<font color="#E5E5E5">three use the links instead of</font>

615
00:22:56,530 --> 00:22:59,860
attachments attachments are far more

616
00:22:58,030 --> 00:23:00,910
likely to get caught at least it seems

617
00:22:59,860 --> 00:23:02,800
to be<font color="#CCCCCC"> getting that we didn't used to be</font>

618
00:23:00,910 --> 00:23:04,690
that<font color="#E5E5E5"> way even like six months ago but</font>

619
00:23:02,800 --> 00:23:07,060
more<font color="#E5E5E5"> recently especially when sending</font>

620
00:23:04,690 --> 00:23:08,170
from office 365<font color="#E5E5E5"> the attachments getting</font>

621
00:23:07,060 --> 00:23:12,159
busted links are still sailing through

622
00:23:08,170 --> 00:23:13,960
number<font color="#CCCCCC"> four</font><font color="#E5E5E5"> HT</font><font color="#CCCCCC"> Access HTA access is your</font>

623
00:23:12,160 --> 00:23:17,440
friend I will now use it<font color="#E5E5E5"> for everything</font>

624
00:23:13,960 --> 00:23:19,720
because it's just<font color="#E5E5E5"> glorious when you see</font>

625
00:23:17,440 --> 00:23:21,580
what you see<font color="#E5E5E5"> security just get kicked</font>

626
00:23:19,720 --> 00:23:23,230
out that door<font color="#E5E5E5"> and you see your client</font>

627
00:23:21,580 --> 00:23:24,669
get kicked in this store and and then

628
00:23:23,230 --> 00:23:27,190
<font color="#E5E5E5">she'll come back it's just it's like a</font>

629
00:23:24,670 --> 00:23:29,950
happy dance moment fantastic all<font color="#CCCCCC"> right</font>

630
00:23:27,190 --> 00:23:31,990
check the fish with is not spam<font color="#E5E5E5"> calm</font>

631
00:23:29,950 --> 00:23:36,070
it's not spam is really really cool

632
00:23:31,990 --> 00:23:38,560
because I you you send your email to an

633
00:23:36,070 --> 00:23:42,250
email<font color="#CCCCCC"> address they'll give you like a</font>

634
00:23:38,560 --> 00:23:43,990
randomized email address to send your

635
00:23:42,250 --> 00:23:46,330
fishing email to and so he sent it to

636
00:23:43,990 --> 00:23:48,220
them and then they<font color="#E5E5E5"> will put a report up</font>

637
00:23:46,330 --> 00:23:49,840
in<font color="#E5E5E5"> about five minutes online and that</font>

638
00:23:48,220 --> 00:23:51,670
report basically gives you all the spam

639
00:23:49,840 --> 00:23:53,139
indicators that say well this was fine

640
00:23:51,670 --> 00:23:55,750
this was not fine this is fine this was

641
00:23:53,140 --> 00:23:56,830
not fine and<font color="#E5E5E5"> your overall ranking I use</font>

642
00:23:55,750 --> 00:23:59,620
this quite frequently it's actually very

643
00:23:56,830 --> 00:24:02,020
handy<font color="#E5E5E5"> and last but not least you happen</font>

644
00:23:59,620 --> 00:24:04,209
to get a free month of office 365 with

645
00:24:02,020 --> 00:24:06,220
the godaddy domain purchase

646
00:24:04,210 --> 00:24:08,140
so you know just use<font color="#CCCCCC"> that free month and</font>

647
00:24:06,220 --> 00:24:10,270
do what you got to do and then throw it

648
00:24:08,140 --> 00:24:11,500
away for<font color="#E5E5E5"> good purposes only right right</font>

649
00:24:10,270 --> 00:24:26,710
<font color="#E5E5E5">authorised they sign the rules of</font>

650
00:24:11,500 --> 00:24:28,720
<font color="#E5E5E5">engagement why all right antivirus so I</font>

651
00:24:26,710 --> 00:24:32,560
did kind of some of the same testing

652
00:24:28,720 --> 00:24:34,390
with antivirus payloads that i did<font color="#CCCCCC"> with</font>

653
00:24:32,560 --> 00:24:37,210
inline control so<font color="#CCCCCC"> i generated material</font>

654
00:24:34,390 --> 00:24:40,300
right Jerry Empire and I sent them

655
00:24:37,210 --> 00:24:42,250
through<font color="#CCCCCC"> know distribute calm I prefer no</font>

656
00:24:40,300 --> 00:24:43,570
distribute because unlike virustotal no

657
00:24:42,250 --> 00:24:46,840
distribute will not distribute your

658
00:24:43,570 --> 00:24:48,010
results to AV vendors<font color="#E5E5E5"> ok so if you're</font>

659
00:24:46,840 --> 00:24:49,480
actually testing a payload like

660
00:24:48,010 --> 00:24:50,830
something that you put work into<font color="#E5E5E5"> I use</font>

661
00:24:49,480 --> 00:24:53,200
nodus true because they also contain all

662
00:24:50,830 --> 00:24:55,540
the major players so by major players

663
00:24:53,200 --> 00:24:57,970
here's Reming<font color="#E5E5E5"> semantics also norton</font>

664
00:24:55,540 --> 00:25:00,370
mcafee trend microsoft security

665
00:24:57,970 --> 00:25:01,480
essentials and also defender those are

666
00:25:00,370 --> 00:25:02,979
<font color="#E5E5E5">the ones that</font><font color="#CCCCCC"> i care</font><font color="#E5E5E5"> about those are the</font>

667
00:25:01,480 --> 00:25:07,360
ones that I've seen<font color="#E5E5E5"> enterprise if you</font>

668
00:25:02,980 --> 00:25:10,030
<font color="#CCCCCC">use clamavi if you use</font><font color="#E5E5E5"> to 360 how many</font>

669
00:25:07,360 --> 00:25:11,530
better look at that I you put<font color="#E5E5E5"> your hand</font>

670
00:25:10,030 --> 00:25:16,210
down no no you've never heard of<font color="#E5E5E5"> it</font>

671
00:25:11,530 --> 00:25:17,590
right no one uses that stuff everyone in

672
00:25:16,210 --> 00:25:20,680
your<font color="#E5E5E5"> enterprise uses one</font><font color="#CCCCCC"> of them</font>

673
00:25:17,590 --> 00:25:22,750
generally speaking<font color="#CCCCCC"> okay you might you</font>

674
00:25:20,680 --> 00:25:25,420
might be like some you know<font color="#E5E5E5"> crazy unix</font>

675
00:25:22,750 --> 00:25:27,970
period admin that's using like some AV

676
00:25:25,420 --> 00:25:30,880
that you download<font color="#E5E5E5"> like what most people</font>

677
00:25:27,970 --> 00:25:33,730
use this stuff<font color="#E5E5E5"> okay sorry want to like</font>

678
00:25:30,880 --> 00:25:38,080
mini rant most people use this stuff

679
00:25:33,730 --> 00:25:41,050
<font color="#CCCCCC">alright so</font><font color="#E5E5E5"> here's the results of what I</font>

680
00:25:38,080 --> 00:25:43,270
<font color="#CCCCCC">encountered</font><font color="#E5E5E5"> red means it was picked up</font>

681
00:25:41,050 --> 00:25:46,810
by one<font color="#E5E5E5"> of those major players green</font>

682
00:25:43,270 --> 00:25:48,250
means even if it was picked up it was

683
00:25:46,810 --> 00:25:51,370
picked up by someone that<font color="#E5E5E5"> I had to</font>

684
00:25:48,250 --> 00:25:53,830
google that I<font color="#E5E5E5"> never</font><font color="#CCCCCC"> okay so if you look</font>

685
00:25:51,370 --> 00:25:55,719
<font color="#E5E5E5">at mature / the the ex's interpreter I</font>

686
00:25:53,830 --> 00:25:57,699
believe<font color="#E5E5E5"> no distribute processes through</font>

687
00:25:55,720 --> 00:26:00,010
35 different engines so just the

688
00:25:57,700 --> 00:26:02,170
standard meterpreter executable that

689
00:26:00,010 --> 00:26:04,420
actually is<font color="#E5E5E5"> just that gets picked up by</font>

690
00:26:02,170 --> 00:26:07,120
a half of<font color="#E5E5E5"> av vendors that that's how you</font>

691
00:26:04,420 --> 00:26:10,510
read this even when we signed it with a

692
00:26:07,120 --> 00:26:12,520
legitimate code signing cert it was

693
00:26:10,510 --> 00:26:14,500
still picked up by 15 back to a factory

694
00:26:12,520 --> 00:26:15,900
pic 2 by 5 and then Ebola which I'll do

695
00:26:14,500 --> 00:26:18,180
a demo of later

696
00:26:15,900 --> 00:26:20,250
absolutely sail through everything which

697
00:26:18,180 --> 00:26:21,600
<font color="#CCCCCC">is fantastic the yellow field is</font>

698
00:26:20,250 --> 00:26:23,160
interesting because for the Empire deal

699
00:26:21,600 --> 00:26:25,290
who generated it was only picked by one

700
00:26:23,160 --> 00:26:27,090
we<font color="#E5E5E5"> did nothing but when we signed it it</font>

701
00:26:25,290 --> 00:26:28,830
got picked up by five I'm a little

702
00:26:27,090 --> 00:26:32,070
<font color="#CCCCCC">nervous about our code</font><font color="#E5E5E5"> signing sir but</font>

703
00:26:28,830 --> 00:26:33,389
<font color="#CCCCCC">okay anyways and then a custom seat up</font>

704
00:26:32,070 --> 00:26:36,389
over here<font color="#E5E5E5"> i will also dumb in this as</font>

705
00:26:33,390 --> 00:26:40,680
well that got picked up by very little

706
00:26:36,390 --> 00:26:44,070
to nothing<font color="#E5E5E5"> alright so maybe evasion</font>

707
00:26:40,680 --> 00:26:46,320
number one back to our factory back to a

708
00:26:44,070 --> 00:26:48,120
factory is pretty cool because what<font color="#CCCCCC"> will</font>

709
00:26:46,320 --> 00:26:50,280
allow you<font color="#E5E5E5"> to do is take an existing</font>

710
00:26:48,120 --> 00:26:52,500
executable a legitimate executable say

711
00:26:50,280 --> 00:26:55,260
for example putty or assist internals or

712
00:26:52,500 --> 00:26:58,350
you<font color="#E5E5E5"> know a standard standalone</font>

713
00:26:55,260 --> 00:27:00,930
executable and you can backdoor it with

714
00:26:58,350 --> 00:27:02,310
your malicious payload<font color="#CCCCCC"> okay it supports</font>

715
00:27:00,930 --> 00:27:04,470
user-supplied show code which is

716
00:27:02,310 --> 00:27:05,850
outstanding just a standard

717
00:27:04,470 --> 00:27:08,520
run-of-the-mill back to our factory

718
00:27:05,850 --> 00:27:09,689
payload creation was only picked up by

719
00:27:08,520 --> 00:27:12,360
five or thirty five which is actually

720
00:27:09,690 --> 00:27:14,340
pretty<font color="#E5E5E5"> good okay and then really really</font>

721
00:27:12,360 --> 00:27:17,159
easy to stall on cali just app<font color="#CCCCCC"> install</font>

722
00:27:14,340 --> 00:27:21,540
<font color="#CCCCCC">back door factory</font><font color="#E5E5E5"> okay number</font><font color="#CCCCCC"> two</font>

723
00:27:17,160 --> 00:27:24,030
powershell<font color="#E5E5E5"> oh powershell AV evasions</font>

724
00:27:21,540 --> 00:27:25,830
they're just<font color="#CCCCCC"> beautiful</font><font color="#E5E5E5"> okay when it</font>

725
00:27:24,030 --> 00:27:28,590
comes to powershell scripts how many<font color="#E5E5E5"> of</font>

726
00:27:25,830 --> 00:27:31,290
you heard me<font color="#E5E5E5"> me me cats most of you okay</font>

727
00:27:28,590 --> 00:27:35,730
so I leave you heard of invoke dash Mimi

728
00:27:31,290 --> 00:27:38,159
cats dot ps1 most of you<font color="#E5E5E5"> okay so in this</font>

729
00:27:35,730 --> 00:27:40,260
case Mimi cats a very very popular

730
00:27:38,160 --> 00:27:43,860
attack tool for polling plaintext

731
00:27:40,260 --> 00:27:46,530
credentials out of memory was reported

732
00:27:43,860 --> 00:27:49,260
over to powershell but what you<font color="#CCCCCC"> need</font><font color="#E5E5E5"> to</font>

733
00:27:46,530 --> 00:27:51,030
understand about how AV vendors detect

734
00:27:49,260 --> 00:27:53,070
powershell is that if i take invoke name

735
00:27:51,030 --> 00:27:55,470
you can't stand voc<font color="#CCCCCC"> Desmond can stop ps1</font>

736
00:27:53,070 --> 00:27:57,510
and I drop it onto a system that is

737
00:27:55,470 --> 00:27:59,520
using semantic up-to-date semantics

738
00:27:57,510 --> 00:28:02,129
semantics will catch it<font color="#E5E5E5"> okay it's going</font>

739
00:27:59,520 --> 00:28:03,780
to say this is mini cats and poom you

740
00:28:02,130 --> 00:28:06,420
know alert get sent off and you're

741
00:28:03,780 --> 00:28:07,920
caught<font color="#E5E5E5"> okay but what is important to</font>

742
00:28:06,420 --> 00:28:10,020
understand is<font color="#E5E5E5"> that a tea vendors are</font>

743
00:28:07,920 --> 00:28:11,640
really just searching<font color="#CCCCCC"> for</font><font color="#E5E5E5"> strings so how</font>

744
00:28:10,020 --> 00:28:14,430
do you get<font color="#E5E5E5"> around that remove all the</font>

745
00:28:11,640 --> 00:28:16,350
comments this is this is so embarrassing

746
00:28:14,430 --> 00:28:18,090
<font color="#CCCCCC">leeez it's great to remove all</font><font color="#E5E5E5"> the</font>

747
00:28:16,350 --> 00:28:19,379
comments<font color="#CCCCCC"> and then change the function</font>

748
00:28:18,090 --> 00:28:20,970
names and parameter rings you don't have

749
00:28:19,380 --> 00:28:25,740
to change any of the workable code in

750
00:28:20,970 --> 00:28:28,460
fact here's do you want to see this is a

751
00:28:25,740 --> 00:28:32,150
script that I run on my powershell files

752
00:28:28,460 --> 00:28:34,730
<font color="#E5E5E5">okay so the first line right here all</font>

753
00:28:32,150 --> 00:28:38,420
right<font color="#CCCCCC"> dot k call my</font><font color="#E5E5E5"> dog i'll find all my</font>

754
00:28:34,730 --> 00:28:40,190
god PS 1 files and then i get rid of the

755
00:28:38,420 --> 00:28:42,050
block comments block comments and

756
00:28:40,190 --> 00:28:44,000
powershell begin with less<font color="#CCCCCC"> than pound</font>

757
00:28:42,050 --> 00:28:47,000
and they end with boundless<font color="#CCCCCC"> not and that</font>

758
00:28:44,000 --> 00:28:48,170
is<font color="#CCCCCC"> where the</font><font color="#E5E5E5"> PowerShell authors put all</font>

759
00:28:47,000 --> 00:28:50,120
their comments they put their<font color="#CCCCCC"> Twitter</font>

760
00:28:48,170 --> 00:28:52,460
handles and things like that and<font color="#E5E5E5"> that</font><font color="#CCCCCC"> is</font>

761
00:28:50,120 --> 00:28:54,560
one huge thing that a<font color="#E5E5E5"> be vendors key off</font>

762
00:28:52,460 --> 00:28:57,920
of they also key off of standard

763
00:28:54,560 --> 00:29:00,110
comments in<font color="#E5E5E5"> the script okay and then I</font>

764
00:28:57,920 --> 00:29:01,970
for many cats i did just<font color="#CCCCCC"> there just a</font>

765
00:29:00,110 --> 00:29:06,649
couple of special things i tweaked<font color="#CCCCCC"> mimi</font>

766
00:29:01,970 --> 00:29:08,240
<font color="#CCCCCC">cat so now it is mini cars and I</font><font color="#E5E5E5"> changed</font>

767
00:29:06,650 --> 00:29:09,980
a couple of parameters dumb creds<font color="#E5E5E5"> to</font>

768
00:29:08,240 --> 00:29:11,930
give me credits and<font color="#E5E5E5"> dumb search to give</font>

769
00:29:09,980 --> 00:29:13,910
me search and so you would<font color="#E5E5E5"> simply run it</font>

770
00:29:11,930 --> 00:29:15,470
like this<font color="#E5E5E5"> you</font><font color="#CCCCCC"> run it basically just</font>

771
00:29:13,910 --> 00:29:17,480
exactly how you would run in<font color="#CCCCCC"> bovania</font>

772
00:29:15,470 --> 00:29:20,690
<font color="#E5E5E5">cats however in this particular case</font>

773
00:29:17,480 --> 00:29:22,340
running it like this just in and I

774
00:29:20,690 --> 00:29:24,440
tested this three weeks ago<font color="#CCCCCC"> on</font><font color="#E5E5E5"> a</font>

775
00:29:22,340 --> 00:29:27,169
customer<font color="#CCCCCC"> that was using</font><font color="#E5E5E5"> up-to-date</font>

776
00:29:24,440 --> 00:29:28,520
semantics ok all<font color="#E5E5E5"> of their clients versus</font>

777
00:29:27,170 --> 00:29:30,950
ate all their a be different interrupts

778
00:29:28,520 --> 00:29:32,720
date this ran flawlessly<font color="#CCCCCC"> okay so and</font>

779
00:29:30,950 --> 00:29:35,420
what's nice about this<font color="#CCCCCC"> is that these top</font>

780
00:29:32,720 --> 00:29:37,610
two just those top two will find all of

781
00:29:35,420 --> 00:29:38,840
your power shell files and remove all

782
00:29:37,610 --> 00:29:41,179
<font color="#E5E5E5">the comments something really really</font>

783
00:29:38,840 --> 00:29:43,310
handy to run and say<font color="#E5E5E5"> Empire</font><font color="#CCCCCC"> core puppy</font>

784
00:29:41,180 --> 00:29:46,430
you know on those power Shelby's

785
00:29:43,310 --> 00:29:51,560
payloads works very very well<font color="#E5E5E5"> okay and</font>

786
00:29:46,430 --> 00:29:54,080
then I custom c-sharp number one so in

787
00:29:51,560 --> 00:29:55,940
this case custom t-shirt number one is

788
00:29:54,080 --> 00:29:59,449
going to this is actually code that like

789
00:29:55,940 --> 00:30:00,950
I said I kind<font color="#E5E5E5"> of copy pasta from stack</font>

790
00:29:59,450 --> 00:30:03,140
overflow and add it<font color="#CCCCCC"> to my own</font><font color="#E5E5E5"> Dalton</font>

791
00:30:00,950 --> 00:30:06,980
muscles to it what that does<font color="#E5E5E5"> that takes</font>

792
00:30:03,140 --> 00:30:09,530
standard<font color="#CCCCCC"> NSS then I'm out put that in AC</font>

793
00:30:06,980 --> 00:30:11,240
shop format and then victory as far as

794
00:30:09,530 --> 00:30:13,190
the payload this gets picked up only by

795
00:30:11,240 --> 00:30:14,900
<font color="#CCCCCC">12 35 and it was none of</font><font color="#E5E5E5"> the major</font>

796
00:30:13,190 --> 00:30:16,370
players<font color="#CCCCCC"> okay they actually extremely</font>

797
00:30:14,900 --> 00:30:17,660
easy to use and I put all<font color="#E5E5E5"> the code up on</font>

798
00:30:16,370 --> 00:30:21,350
github which I'll drop at the<font color="#E5E5E5"> end</font><font color="#CCCCCC"> of the</font>

799
00:30:17,660 --> 00:30:23,060
<font color="#CCCCCC">store in custom seat right over to this</font>

800
00:30:21,350 --> 00:30:25,129
actually runs power so code without

801
00:30:23,060 --> 00:30:26,330
<font color="#CCCCCC">power shell dot exe which is really</font>

802
00:30:25,130 --> 00:30:27,560
handy because a lot of our customers

803
00:30:26,330 --> 00:30:29,030
back we've been telling<font color="#E5E5E5"> them and there's</font>

804
00:30:27,560 --> 00:30:30,350
something of a debate you know in the

805
00:30:29,030 --> 00:30:31,879
infosec community right now above do you

806
00:30:30,350 --> 00:30:33,620
block<font color="#CCCCCC"> PowerShell aditi do not block</font>

807
00:30:31,880 --> 00:30:34,790
<font color="#E5E5E5">PowerShell dating scene I've my own</font>

808
00:30:33,620 --> 00:30:36,439
thoughts on that before the customers

809
00:30:34,790 --> 00:30:38,240
that are<font color="#CCCCCC"> blocked in PowerShell that HC</font>

810
00:30:36,440 --> 00:30:40,520
we still need<font color="#CCCCCC"> a way of firing power</font>

811
00:30:38,240 --> 00:30:41,600
shell code without using PowerShell that

812
00:30:40,520 --> 00:30:42,918
exe and you can

813
00:30:41,600 --> 00:30:45,770
do that using the diner framework and

814
00:30:42,919 --> 00:30:47,210
the system management automation neither

815
00:30:45,770 --> 00:30:53,720
<font color="#E5E5E5">backwards system automation management</font>

816
00:30:47,210 --> 00:31:04,760
<font color="#E5E5E5">dll ok so let's actually do quick demo</font>

817
00:30:53,720 --> 00:31:09,530
all right interesting sorry oh this this

818
00:31:04,760 --> 00:31:14,780
is gonna suck you guys can't see nothin

819
00:31:09,530 --> 00:31:28,490
hang on let me come near my displays

820
00:31:14,780 --> 00:31:29,510
their displays all right<font color="#CCCCCC"> okay cool just</font>

821
00:31:28,490 --> 00:31:42,559
an you're calling instance<font color="#CCCCCC"> of what I'm</font>

822
00:31:29,510 --> 00:31:49,370
going to do<font color="#CCCCCC"> no interpreter fine misspell</font>

823
00:31:42,559 --> 00:32:00,830
something just tell me dang<font color="#CCCCCC"> it mature</font>

824
00:31:49,370 --> 00:32:08,090
mature got it so in this case I'm gonna

825
00:32:00,830 --> 00:32:13,668
set the format to<font color="#E5E5E5"> c sharp c or c c sharp</font>

826
00:32:08,090 --> 00:32:28,850
C sharp that's right what was it shark

827
00:32:13,669 --> 00:32:32,480
she<font color="#CCCCCC"> sure did alright alright oh god this</font>

828
00:32:28,850 --> 00:32:36,799
incredible<font color="#CCCCCC"> okay so if you actually look</font>

829
00:32:32,480 --> 00:32:40,370
at this code this<font color="#E5E5E5"> basically just outputs</font>

830
00:32:36,799 --> 00:32:42,610
the<font color="#CCCCCC"> mature procedure to</font><font color="#E5E5E5"> c sharp format</font>

831
00:32:40,370 --> 00:32:47,919
so

832
00:32:42,610 --> 00:32:50,110
too by<font color="#E5E5E5"> the way this</font><font color="#CCCCCC"> is actually what</font>

833
00:32:47,920 --> 00:32:56,140
real<font color="#E5E5E5"> pen testing looks like just a ton</font>

834
00:32:50,110 --> 00:32:58,510
of<font color="#E5E5E5"> typos all the time</font><font color="#CCCCCC"> alright this</font><font color="#E5E5E5"> is</font>

835
00:32:56,140 --> 00:33:01,630
<font color="#E5E5E5">gonna be difficult let's let's try this</font>

836
00:32:58,510 --> 00:33:06,760
<font color="#E5E5E5">okay it's a little better alright so in</font>

837
00:33:01,630 --> 00:33:08,260
this particular code segment standard

838
00:33:06,760 --> 00:33:09,129
main class is actually really small just

839
00:33:08,260 --> 00:33:10,299
going to talk you<font color="#E5E5E5"> through just a little</font>

840
00:33:09,130 --> 00:33:13,210
bit of<font color="#CCCCCC"> it</font><font color="#E5E5E5"> so we're allocating some</font>

841
00:33:10,299 --> 00:33:16,510
memory and then we are going<font color="#CCCCCC"> to copy our</font>

842
00:33:13,210 --> 00:33:18,640
flights from our DS bytes class into

843
00:33:16,510 --> 00:33:20,710
memory and then I<font color="#E5E5E5"> just have a couple of</font>

844
00:33:18,640 --> 00:33:22,090
junk loops literally they do absolutely

845
00:33:20,710 --> 00:33:23,440
nothing the whole point here is just<font color="#E5E5E5"> to</font>

846
00:33:22,090 --> 00:33:25,418
throw off the hash<font color="#E5E5E5"> just in case someone</font>

847
00:33:23,440 --> 00:33:28,419
else hasn't<font color="#E5E5E5"> wrkn it so you know it just</font>

848
00:33:25,419 --> 00:33:30,549
changes to whatever you want okay and

849
00:33:28,419 --> 00:33:32,500
then we kick off the thread another junk

850
00:33:30,549 --> 00:33:37,629
loop and then we're waiting so where you

851
00:33:32,500 --> 00:33:40,750
put this this is right there just paste

852
00:33:37,630 --> 00:33:42,130
in good to go and then build your

853
00:33:40,750 --> 00:33:45,549
solution you<font color="#CCCCCC"> can do this using the</font>

854
00:33:42,130 --> 00:33:53,320
communication of visual studio as well

855
00:33:45,549 --> 00:33:55,570
solution<font color="#CCCCCC"> Explorer and then there's your</font>

856
00:33:53,320 --> 00:33:57,668
payload<font color="#E5E5E5"> okay I do not have a listener up</font>

857
00:33:55,570 --> 00:33:59,500
and running this point but just<font color="#E5E5E5"> give you</font>

858
00:33:57,669 --> 00:34:02,200
an idea of<font color="#E5E5E5"> how easy and simple it is to</font>

859
00:33:59,500 --> 00:34:04,150
go ahead and built your payload ok the

860
00:34:02,200 --> 00:34:10,899
other solution just a quick demo on that

861
00:34:04,150 --> 00:34:14,320
close<font color="#CCCCCC"> that and start page because that's</font>

862
00:34:10,899 --> 00:34:19,719
easier psy<font color="#CCCCCC"> are so in this case what this</font>

863
00:34:14,320 --> 00:34:21,310
<font color="#E5E5E5">does is there is a reference to system</font>

864
00:34:19,719 --> 00:34:22,899
<font color="#E5E5E5">management automation ok this is</font>

865
00:34:21,310 --> 00:34:24,790
available<font color="#CCCCCC"> in a windows sdk and this is</font>

866
00:34:22,899 --> 00:34:26,230
the dll that you actually need in order

867
00:34:24,790 --> 00:34:28,899
to fire power shell code without

868
00:34:26,230 --> 00:34:32,050
<font color="#E5E5E5">powershell dot exe so in this case I</font>

869
00:34:28,899 --> 00:34:35,230
<font color="#E5E5E5">have this coded up simply just to take</font>

870
00:34:32,050 --> 00:34:37,210
Bay 64 encoded PowerShell commands and

871
00:34:35,230 --> 00:34:39,940
<font color="#CCCCCC">Fire</font><font color="#E5E5E5"> decode them and then fire them in</font>

872
00:34:37,210 --> 00:34:44,470
this<font color="#E5E5E5"> case all this command does is run</font>

873
00:34:39,940 --> 00:34:48,760
PS version table<font color="#CCCCCC"> ok that's all it does</font>

874
00:34:44,469 --> 00:34:50,888
so if<font color="#E5E5E5"> we fire that and you get the</font>

875
00:34:48,760 --> 00:34:53,740
output there's something<font color="#E5E5E5"> interesting to</font>

876
00:34:50,889 --> 00:34:55,300
pay attention<font color="#E5E5E5"> to it was one o'clock in</font>

877
00:34:53,739 --> 00:34:55,790
the morning when<font color="#E5E5E5"> I notice this last</font>

878
00:34:55,300 --> 00:34:59,180
night

879
00:34:55,790 --> 00:35:01,130
if you look at this the<font color="#CCCCCC"> powershell</font>

880
00:34:59,180 --> 00:35:04,069
version that comes back here is five dot

881
00:35:01,130 --> 00:35:05,810
0 build version turned out there but if

882
00:35:04,070 --> 00:35:09,680
you look up here same operating system

883
00:35:05,810 --> 00:35:11,390
power subversion 20<font color="#E5E5E5"> build version 6 dot</font>

884
00:35:09,680 --> 00:35:13,640
one that's because<font color="#CCCCCC"> I'm using an</font>

885
00:35:11,390 --> 00:35:15,620
<font color="#E5E5E5">out-of-date version of system management</font>

886
00:35:13,640 --> 00:35:18,410
automation a dll what does this mean to

887
00:35:15,620 --> 00:35:20,480
<font color="#CCCCCC">you well defenders what this means is</font>

888
00:35:18,410 --> 00:35:23,569
<font color="#E5E5E5">that if you are an intrepid defender and</font>

889
00:35:20,480 --> 00:35:25,430
you have logging enabled PowerShell

890
00:35:23,570 --> 00:35:28,550
module log enabled which you might not

891
00:35:25,430 --> 00:35:30,080
know is that module logging didn't was

892
00:35:28,550 --> 00:35:31,460
not<font color="#E5E5E5"> available in PowerShell 2 point 0</font>

893
00:35:30,080 --> 00:35:33,290
and so if I conduct a PowerShell

894
00:35:31,460 --> 00:35:35,540
downgrade attack and run all my

895
00:35:33,290 --> 00:35:38,000
PowerShell commands using<font color="#E5E5E5"> PowerShell</font>

896
00:35:35,540 --> 00:35:40,759
version 2 point 0 nothing shows up in

897
00:35:38,000 --> 00:35:42,770
your logs absolutely nothing so if i can

898
00:35:40,760 --> 00:35:45,350
get<font color="#CCCCCC"> this dll this version of</font><font color="#E5E5E5"> this dll</font>

899
00:35:42,770 --> 00:35:47,000
along with my evil power shell code onto

900
00:35:45,350 --> 00:35:49,940
your system even<font color="#E5E5E5"> though you're running</font>

901
00:35:47,000 --> 00:35:51,020
Windows 10 with PowerShell 5.1 latest

902
00:35:49,940 --> 00:35:52,670
and greatest<font color="#CCCCCC"> you got all your logs</font>

903
00:35:51,020 --> 00:35:55,250
turned to 11 you're not going to see

904
00:35:52,670 --> 00:35:56,990
anything and that's<font color="#CCCCCC"> just</font><font color="#E5E5E5"> brings joy to</font>

905
00:35:55,250 --> 00:36:06,950
my heart that's<font color="#E5E5E5"> just a warm fuzzy right</font>

906
00:35:56,990 --> 00:36:13,189
there so<font color="#CCCCCC"> Q hi how do i turn off how do i</font>

907
00:36:06,950 --> 00:36:17,660
<font color="#E5E5E5">turn off mirroring</font><font color="#CCCCCC"> okay back to this</font>

908
00:36:13,190 --> 00:36:19,970
<font color="#E5E5E5">real quick okay so how do i</font><font color="#CCCCCC"> get the</font>

909
00:36:17,660 --> 00:36:21,620
payload actually onto the system like I

910
00:36:19,970 --> 00:36:24,080
was<font color="#E5E5E5"> going to</font><font color="#CCCCCC"> phish someone how would i</font>

911
00:36:21,620 --> 00:36:26,870
get system management automation dll as

912
00:36:24,080 --> 00:36:29,600
well as that binary on to the<font color="#E5E5E5"> system</font>

913
00:36:26,870 --> 00:36:31,310
well here's exactly what<font color="#CCCCCC"> i</font><font color="#E5E5E5"> would do and</font>

914
00:36:29,600 --> 00:36:33,860
this was this<font color="#E5E5E5"> is a macro function that</font><font color="#CCCCCC"> i</font>

915
00:36:31,310 --> 00:36:36,410
put together I just couple months ago so

916
00:36:33,860 --> 00:36:38,510
in this case i'm<font color="#E5E5E5"> setting up a reference</font>

917
00:36:36,410 --> 00:36:40,730
to a windows function called URL

918
00:36:38,510 --> 00:36:42,980
download that file and my macro code

919
00:36:40,730 --> 00:36:45,710
looks just like this<font color="#E5E5E5"> i'm calling this</font>

920
00:36:42,980 --> 00:36:47,450
function i'm grabbing<font color="#E5E5E5"> i'm grabbing a PS</font>

921
00:36:45,710 --> 00:36:49,400
fired i th see that's the binary that

922
00:36:47,450 --> 00:36:51,710
you just saw and<font color="#E5E5E5"> I'm saving</font><font color="#CCCCCC"> it</font><font color="#E5E5E5"> to see</font>

923
00:36:49,400 --> 00:36:53,270
program data PS fire dot exe and then

924
00:36:51,710 --> 00:36:56,540
i'm downloading the management

925
00:36:53,270 --> 00:36:58,580
automation dll and saving that to<font color="#E5E5E5"> see</font>

926
00:36:56,540 --> 00:37:00,290
program data so if you're an<font color="#E5E5E5"> intrepid</font>

927
00:36:58,580 --> 00:37:01,670
defender and you're like well we have

928
00:37:00,290 --> 00:37:04,250
<font color="#CCCCCC">antivirus configured a block everything</font>

929
00:37:01,670 --> 00:37:06,890
in<font color="#E5E5E5"> percent tenth and percent app data</font>

930
00:37:04,250 --> 00:37:07,670
it's something<font color="#E5E5E5"> interesting is that c</font>

931
00:37:06,890 --> 00:37:10,400
program data

932
00:37:07,670 --> 00:37:14,839
allows if you look at the permissions in

933
00:37:10,400 --> 00:37:16,549
<font color="#E5E5E5">C program data it is all users have read</font>

934
00:37:14,839 --> 00:37:18,020
and execute but then if you scroll down

935
00:37:16,549 --> 00:37:19,910
a little bit it says special permissions

936
00:37:18,020 --> 00:37:21,829
and you click special permissions and

937
00:37:19,910 --> 00:37:24,618
then you see all users have<font color="#E5E5E5"> ability</font><font color="#CCCCCC"> to</font>

938
00:37:21,829 --> 00:37:27,170
write files even low privileged users

939
00:37:24,619 --> 00:37:30,079
which means that I can take my binary

940
00:37:27,170 --> 00:37:32,299
and store it<font color="#CCCCCC"> in</font><font color="#E5E5E5"> C program data as a low</font>

941
00:37:30,079 --> 00:37:34,910
privileged<font color="#E5E5E5"> user along</font><font color="#CCCCCC"> with that</font><font color="#E5E5E5"> DLL and</font>

942
00:37:32,299 --> 00:37:37,339
then fire it and<font color="#E5E5E5"> I have to say anything</font>

943
00:37:34,910 --> 00:37:41,629
<font color="#E5E5E5">attempt that's</font><font color="#CCCCCC"> actually that's</font><font color="#E5E5E5"> kind of</font>

944
00:37:37,339 --> 00:37:44,808
come on<font color="#CCCCCC"> alright last thing is Ebola in</font>

945
00:37:41,630 --> 00:37:45,890
here this will be kind<font color="#E5E5E5"> of last one of</font>

946
00:37:44,809 --> 00:37:47,960
the last things and<font color="#CCCCCC"> demos that I talked</font>

947
00:37:45,890 --> 00:37:50,210
<font color="#CCCCCC">about so Ebola is fantastic and this is</font>

948
00:37:47,960 --> 00:37:52,460
the thing<font color="#CCCCCC"> that got like zero of sixteen</font>

949
00:37:50,210 --> 00:37:54,980
we uploaded this to<font color="#E5E5E5"> virus oil as well</font>

950
00:37:52,460 --> 00:37:56,150
like I said I have a tool slide at<font color="#E5E5E5"> the</font>

951
00:37:54,980 --> 00:38:00,109
very end that has all the github link

952
00:37:56,150 --> 00:38:04,430
something like that so on Ebola what

953
00:38:00,109 --> 00:38:06,680
Ebola does is you give it a variable or

954
00:38:04,430 --> 00:38:08,839
a set of variables that are going to be

955
00:38:06,680 --> 00:38:10,730
<font color="#E5E5E5">found on your targets computer so let's</font>

956
00:38:08,839 --> 00:38:13,578
say<font color="#CCCCCC"> you</font><font color="#E5E5E5"> know that your targets name</font><font color="#CCCCCC"> is</font>

957
00:38:10,730 --> 00:38:16,819
Jason<font color="#E5E5E5"> all right and so what happens is</font>

958
00:38:13,579 --> 00:38:19,700
that<font color="#CCCCCC"> you said the invite the encryption</font>

959
00:38:16,819 --> 00:38:22,339
key to Jason and what happens is that

960
00:38:19,700 --> 00:38:26,000
Ebola takes your payload encrypts it

961
00:38:22,339 --> 00:38:28,490
with that key<font color="#E5E5E5"> and then the the</font><font color="#CCCCCC"> code that</font>

962
00:38:26,000 --> 00:38:30,650
actually runs on the target machine is a

963
00:38:28,490 --> 00:38:33,109
brute<font color="#CCCCCC"> force mechanism which brute forces</font>

964
00:38:30,650 --> 00:38:35,059
its own key using environment variables

965
00:38:33,109 --> 00:38:36,259
on<font color="#CCCCCC"> the target</font><font color="#E5E5E5"> system so some of the</font>

966
00:38:35,059 --> 00:38:38,599
<font color="#CCCCCC">things that</font><font color="#E5E5E5"> you can actually do with</font>

967
00:38:36,260 --> 00:38:40,579
this are you can you<font color="#CCCCCC"> can set the</font>

968
00:38:38,599 --> 00:38:43,970
decryption key to a user ID to a domain

969
00:38:40,579 --> 00:38:45,559
<font color="#CCCCCC">name to a lan IP to like an IP address</font>

970
00:38:43,970 --> 00:38:47,689
you can code it to all kinds<font color="#E5E5E5"> of stuff</font>

971
00:38:45,559 --> 00:38:49,520
and you can do combinations which means

972
00:38:47,690 --> 00:38:54,799
and this is a<font color="#CCCCCC"> beautiful thing because</font>

973
00:38:49,520 --> 00:38:56,569
it's it's completely defensive its self

974
00:38:54,799 --> 00:38:58,520
defending against San boxing against

975
00:38:56,569 --> 00:39:01,549
sandbox techniques so it<font color="#E5E5E5"> evades sandbox</font>

976
00:38:58,520 --> 00:39:03,020
is because the sandboxes cannot when

977
00:39:01,549 --> 00:39:04,940
they try and<font color="#CCCCCC"> do payload analysis they</font>

978
00:39:03,020 --> 00:39:05,660
cannot decrypt the payload because they

979
00:39:04,940 --> 00:39:07,040
don't have<font color="#E5E5E5"> the right environment</font>

980
00:39:05,660 --> 00:39:08,660
variable set and they don't know<font color="#E5E5E5"> what</font>

981
00:39:07,040 --> 00:39:10,250
<font color="#E5E5E5">those environment variables are but you</font>

982
00:39:08,660 --> 00:39:11,779
do because you're the attacker and

983
00:39:10,250 --> 00:39:13,940
you've done research against your target

984
00:39:11,780 --> 00:39:16,400
<font color="#CCCCCC">okay so how would</font><font color="#E5E5E5"> we chain this together</font>

985
00:39:13,940 --> 00:39:17,540
<font color="#CCCCCC">alright this</font><font color="#E5E5E5"> will be the last demo video</font>

986
00:39:16,400 --> 00:39:19,010
how would you change something like this

987
00:39:17,540 --> 00:39:19,490
together so let's say I want to generate

988
00:39:19,010 --> 00:39:22,040
a payload

989
00:39:19,490 --> 00:39:24,560
<font color="#E5E5E5">okay let's let's use a meterpreter</font>

990
00:39:22,040 --> 00:39:26,450
payload and<font color="#E5E5E5"> I want to obfuscate I want</font>

991
00:39:24,560 --> 00:39:30,890
to obfuscate it using Ebola and then I

992
00:39:26,450 --> 00:39:32,270
want to send it to my target<font color="#E5E5E5"> okay and I</font>

993
00:39:30,890 --> 00:39:34,190
want<font color="#E5E5E5"> to do this in such a way that's</font>

994
00:39:32,270 --> 00:39:36,320
going to evade as much antivirus as

995
00:39:34,190 --> 00:39:38,270
possible okay as well as<font color="#CCCCCC"> inline controls</font>

996
00:39:36,320 --> 00:39:40,700
well like<font color="#CCCCCC"> I</font><font color="#E5E5E5"> said if you</font><font color="#CCCCCC"> have ssl</font>

997
00:39:38,270 --> 00:39:46,520
inspection going on you will block this

998
00:39:40,700 --> 00:39:48,529
but if you don't you won't<font color="#E5E5E5"> okay let's</font>

999
00:39:46,520 --> 00:39:51,650
see how this works<font color="#E5E5E5"> I'm going to run</font>

1000
00:39:48,530 --> 00:39:53,930
three tools unicorn Ebola and Lucky

1001
00:39:51,650 --> 00:40:09,710
Strike to actually do this demonstration

1002
00:39:53,930 --> 00:40:27,618
your displays on<font color="#E5E5E5"> okay oh what's wrong</font>

1003
00:40:09,710 --> 00:40:33,350
that's me right ok so first let's launch

1004
00:40:27,619 --> 00:40:34,490
this F console are cypher con so what

1005
00:40:33,350 --> 00:40:37,640
I'm doing is just the same default

1006
00:40:34,490 --> 00:40:39,229
listener the listener options are

1007
00:40:37,640 --> 00:40:43,069
basically what you saw before which is

1008
00:40:39,230 --> 00:40:45,890
<font color="#E5E5E5">windows interpreter reverse</font><font color="#CCCCCC"> htps using</font>

1009
00:40:43,070 --> 00:40:47,150
port 443 so in this case<font color="#E5E5E5"> I'm kind of you</font>

1010
00:40:45,890 --> 00:40:48,618
know fudging the scenario of it because

1011
00:40:47,150 --> 00:40:50,540
<font color="#E5E5E5">I'm sending us all based on just the</font>

1012
00:40:48,619 --> 00:40:51,710
ends<font color="#E5E5E5"> that have my environment but the</font>

1013
00:40:50,540 --> 00:40:54,350
gold asst will be<font color="#E5E5E5"> I was sending it</font>

1014
00:40:51,710 --> 00:41:01,100
across the<font color="#CCCCCC"> internet to a Windows host</font>

1015
00:40:54,350 --> 00:41:03,770
that has power shell ok so the first

1016
00:41:01,100 --> 00:41:05,060
thing to do is to go to the unicorn

1017
00:41:03,770 --> 00:41:14,140
director and then what I'm going to do

1018
00:41:05,060 --> 00:41:14,140
is unicorn where is my IP address

1019
00:41:14,599 --> 00:41:34,009
here's<font color="#E5E5E5"> the IP</font><font color="#CCCCCC"> address why should watch</font>

1020
00:41:26,359 --> 00:41:38,029
it closely I get it<font color="#E5E5E5"> right all right ok</font>

1021
00:41:34,009 --> 00:41:39,229
so we<font color="#CCCCCC"> generated a lonely I've know he</font>

1022
00:41:38,029 --> 00:41:40,249
was going<font color="#CCCCCC"> to work by the</font><font color="#E5E5E5"> way fifty</font>

1023
00:41:39,229 --> 00:41:44,118
percent of<font color="#E5E5E5"> the time it works every time</font>

1024
00:41:40,249 --> 00:41:44,988
so when you and you're<font color="#E5E5E5"> gonna have to</font>

1025
00:41:44,119 --> 00:41:47,599
bear with me because it's<font color="#E5E5E5"> going to look</font>

1026
00:41:44,989 --> 00:41:51,950
hideous but what actually comes out<font color="#E5E5E5"> of</font>

1027
00:41:47,599 --> 00:41:55,910
that is a ton<font color="#CCCCCC"> of base 64 encoded stuff</font>

1028
00:41:51,950 --> 00:41:57,439
and then a PowerShell with some variable

1029
00:41:55,910 --> 00:41:58,999
substitution dash to<font color="#E5E5E5"> be one so we're</font>

1030
00:41:57,440 --> 00:42:00,559
hiding the window we're doing a bunch of

1031
00:41:58,999 --> 00:42:02,118
variable substitution here and then

1032
00:42:00,559 --> 00:42:03,739
we're actually going to call PowerShell

1033
00:42:02,119 --> 00:42:08,660
with that variable substitution passing

1034
00:42:03,739 --> 00:42:11,329
in our naughty base64 encoded stuff no I

1035
00:42:08,660 --> 00:42:16,339
<font color="#E5E5E5">learned my lesson last night from the</font>

1036
00:42:11,329 --> 00:42:23,259
bottom up<font color="#CCCCCC"> okay so I'm</font><font color="#E5E5E5"> going to take all</font>

1037
00:42:16,339 --> 00:42:23,259
this code all right

1038
00:42:24,480 --> 00:42:39,420
when base64 decode it base64<font color="#E5E5E5"> d filename</font>

1039
00:42:37,320 --> 00:42:44,460
too long that's not one it's not what

1040
00:42:39,420 --> 00:43:00,720
should be happening oh shoot<font color="#E5E5E5"> oh god</font>

1041
00:42:44,460 --> 00:43:04,619
what's that yeah<font color="#E5E5E5"> okay it's totally</font>

1042
00:43:00,720 --> 00:43:08,819
embarrassing anyways yes echo instead of

1043
00:43:04,619 --> 00:43:12,540
<font color="#CCCCCC">cad good</font><font color="#E5E5E5"> god so let's say</font><font color="#CCCCCC"> that out to</font>

1044
00:43:08,820 --> 00:43:20,310
payload ps1 and so now i have<font color="#E5E5E5"> my payload</font>

1045
00:43:12,540 --> 00:43:23,970
<font color="#CCCCCC">of ps1 which should be ok so now that's</font>

1046
00:43:20,310 --> 00:43:27,690
my my basis for decoded unicorn call so

1047
00:43:23,970 --> 00:43:29,970
all this is is the shellcode for reverse

1048
00:43:27,690 --> 00:43:32,640
<font color="#CCCCCC">HCPs stager and just being set through</font>

1049
00:43:29,970 --> 00:43:35,850
through<font color="#E5E5E5"> PowerShell ok so now in order to</font>

1050
00:43:32,640 --> 00:43:37,680
processes through Ebola it's important

1051
00:43:35,850 --> 00:43:40,859
<font color="#E5E5E5">to understand Ebola requires a file</font>

1052
00:43:37,680 --> 00:43:42,509
called genetic config so genetic config

1053
00:43:40,859 --> 00:43:45,810
is basically the max there the

1054
00:43:42,510 --> 00:43:48,300
configuration file for Ebola<font color="#CCCCCC"> okay so in</font>

1055
00:43:45,810 --> 00:43:50,009
this case i'm using output type of power

1056
00:43:48,300 --> 00:43:55,740
shell and a payload type of code i'm

1057
00:43:50,010 --> 00:43:57,240
passing in powershell code<font color="#CCCCCC"> ok and</font><font color="#E5E5E5"> then</font>

1058
00:43:55,740 --> 00:44:00,390
here are the environment variables you

1059
00:43:57,240 --> 00:44:02,459
can use a combination of environment

1060
00:44:00,390 --> 00:44:03,540
variables in order to<font color="#E5E5E5"> make this work ok</font>

1061
00:44:02,460 --> 00:44:04,980
don't just have to<font color="#E5E5E5"> go with one you can</font>

1062
00:44:03,540 --> 00:44:07,050
always amazed you want so in this case

1063
00:44:04,980 --> 00:44:15,060
I'm going with Jason because the target

1064
00:44:07,050 --> 00:44:17,100
<font color="#CCCCCC">machine there we go so obviously that's</font>

1065
00:44:15,060 --> 00:44:20,840
that's the energy so this is also my

1066
00:44:17,100 --> 00:44:20,839
target user<font color="#E5E5E5"> ok</font>

1067
00:44:21,950 --> 00:44:31,549
so I'm<font color="#CCCCCC"> going to call Ebola I thought</font>

1068
00:44:25,430 --> 00:44:34,368
what the heck<font color="#CCCCCC"> is that well</font><font color="#E5E5E5"> P want the</font>

1069
00:44:31,550 --> 00:44:36,079
past to my payload type ps1<font color="#E5E5E5"> and then I'm</font>

1070
00:44:34,369 --> 00:44:41,450
also going to pass in the genetic config

1071
00:44:36,079 --> 00:44:43,339
and so now what comes out is actually be

1072
00:44:41,450 --> 00:44:47,328
easier for<font color="#E5E5E5"> me to show you another screen</font>

1073
00:44:43,339 --> 00:44:54,589
cat put our show send<font color="#CCCCCC"> that to the</font>

1074
00:44:47,329 --> 00:44:57,950
clipboard<font color="#CCCCCC"> okay now it actually comes out</font>

1075
00:44:54,589 --> 00:45:01,099
is a bunch of power shell code that is

1076
00:44:57,950 --> 00:45:03,169
basically designed to iterate across the

1077
00:45:01,099 --> 00:45:07,160
environment variables on<font color="#CCCCCC"> the system and</font>

1078
00:45:03,170 --> 00:45:09,260
perform the decryption and then actually

1079
00:45:07,160 --> 00:45:10,730
<font color="#E5E5E5">launch the power so the malicious powers</font>

1080
00:45:09,260 --> 00:45:13,430
of code that i have here which is in my

1081
00:45:10,730 --> 00:45:14,630
lookup table right here okay<font color="#E5E5E5"> and here's</font>

1082
00:45:13,430 --> 00:45:19,098
a function here called get er done that

1083
00:45:14,630 --> 00:45:25,940
does that work so so<font color="#CCCCCC"> I'm</font><font color="#E5E5E5"> going to save</font>

1084
00:45:19,099 --> 00:45:29,359
payload a ps1 and<font color="#CCCCCC"> I'm going</font><font color="#E5E5E5"> to run a</font>

1085
00:45:25,940 --> 00:45:31,550
tool called Lucky Strike i'm going<font color="#E5E5E5"> to</font>

1086
00:45:29,359 --> 00:45:40,250
add that payload we're going<font color="#E5E5E5"> to call</font>

1087
00:45:31,550 --> 00:45:48,440
this cipher con users jason desktop

1088
00:45:40,250 --> 00:45:52,849
tailored go<font color="#E5E5E5"> ad case when a little one</font>

1089
00:45:48,440 --> 00:45:58,400
that's why<font color="#CCCCCC"> okay and i'm going</font><font color="#E5E5E5"> to create</font>

1090
00:45:52,849 --> 00:46:00,560
i'm going to select that file or select

1091
00:45:58,400 --> 00:46:02,569
that payload<font color="#CCCCCC"> cipher con and then it's</font>

1092
00:46:00,560 --> 00:46:04,160
going to prompt me for what infection

1093
00:46:02,569 --> 00:46:06,500
method<font color="#E5E5E5"> do i wanna use i'm going to</font>

1094
00:46:04,160 --> 00:46:07,790
choose number<font color="#E5E5E5"> two selling bed non base64</font>

1095
00:46:06,500 --> 00:46:09,500
which means i'm<font color="#E5E5E5"> going to take that power</font>

1096
00:46:07,790 --> 00:46:11,210
shell code the Ebola output generate

1097
00:46:09,500 --> 00:46:13,730
power shell code and<font color="#E5E5E5"> i'm going to cram</font>

1098
00:46:11,210 --> 00:46:15,710
it into a bunch<font color="#CCCCCC"> of</font><font color="#E5E5E5"> excel cells and then</font>

1099
00:46:13,730 --> 00:46:18,140
my macro code is going to perform an

1100
00:46:15,710 --> 00:46:19,520
obfuscated a call to powershell retrieve

1101
00:46:18,140 --> 00:46:23,650
all that power shell code and then

1102
00:46:19,520 --> 00:46:23,650
firing<font color="#E5E5E5"> okay</font>

1103
00:46:24,820 --> 00:46:30,400
and<font color="#CCCCCC"> I'm going to create a file this is</font>

1104
00:46:28,960 --> 00:46:32,740
running a fully up-to-date version of

1105
00:46:30,400 --> 00:46:34,870
Windows Defender by the way<font color="#CCCCCC"> okay so</font>

1106
00:46:32,740 --> 00:46:37,569
there's my malicious files to use JSON

1107
00:46:34,870 --> 00:46:41,740
<font color="#E5E5E5">documents like a strike and then</font><font color="#CCCCCC"> OT NP</font>

1108
00:46:37,570 --> 00:46:44,170
something<font color="#E5E5E5"> okay these are just</font><font color="#CCCCCC"> lucky</font>

1109
00:46:41,740 --> 00:46:48,040
strike payloads and here's my flower

1110
00:46:44,170 --> 00:46:49,870
open<font color="#E5E5E5"> up the file and here it is to be</font><font color="#CCCCCC"> to</font>

1111
00:46:48,040 --> 00:46:54,670
most dangerous words and information

1112
00:46:49,870 --> 00:46:56,770
security<font color="#CCCCCC"> alright enable content no eat</font>

1113
00:46:54,670 --> 00:47:07,630
is going to<font color="#E5E5E5"> work what those can you will</font>

1114
00:46:56,770 --> 00:47:14,770
content and there's our show so what

1115
00:47:07,630 --> 00:47:17,710
happened<font color="#CCCCCC"> we do real quick is</font><font color="#E5E5E5"> have a</font>

1116
00:47:14,770 --> 00:47:20,920
<font color="#E5E5E5">couple</font><font color="#CCCCCC"> minutes left what happened here</font>

1117
00:47:17,710 --> 00:47:28,720
cuz<font color="#E5E5E5"> I'll</font><font color="#CCCCCC"> actually shoot i found a bug in</font>

1118
00:47:20,920 --> 00:47:30,790
my own code so<font color="#E5E5E5"> i'm going to get rid</font><font color="#CCCCCC"> of</font>

1119
00:47:28,720 --> 00:47:33,879
the window style hidden so you can

1120
00:47:30,790 --> 00:47:37,390
actually see what would happen at<font color="#E5E5E5"> this</font>

1121
00:47:33,880 --> 00:47:48,640
code or to fire this is what the bola

1122
00:47:37,390 --> 00:47:52,390
script actually looks like<font color="#CCCCCC"> alright well</font>

1123
00:47:48,640 --> 00:47:55,120
yeah i'm not going to<font color="#CCCCCC"> show you that all</font>

1124
00:47:52,390 --> 00:47:57,700
right how to keep tenders are busy let's

1125
00:47:55,120 --> 00:47:59,200
<font color="#CCCCCC">just keep clicking play all</font><font color="#E5E5E5"> right not</font>

1126
00:47:57,700 --> 00:48:01,480
today but<font color="#E5E5E5"> what happens that power some</font>

1127
00:47:59,200 --> 00:48:05,230
window pops up and basically you you see

1128
00:48:01,480 --> 00:48:07,840
the brute<font color="#CCCCCC"> force attempts passing for</font>

1129
00:48:05,230 --> 00:48:10,480
each environment variable so if you

1130
00:48:07,840 --> 00:48:13,000
wanted to do<font color="#CCCCCC"> this for say a domain user</font>

1131
00:48:10,480 --> 00:48:16,270
which is generally speaking the case

1132
00:48:13,000 --> 00:48:18,250
that<font color="#E5E5E5"> i am most interested in what you</font>

1133
00:48:16,270 --> 00:48:22,840
would use instead of using a user ID you

1134
00:48:18,250 --> 00:48:24,040
would use the user domain flag which in

1135
00:48:22,840 --> 00:48:25,900
this case my machine is joined to the

1136
00:48:24,040 --> 00:48:27,670
lab domain<font color="#CCCCCC"> okay so there's going</font><font color="#E5E5E5"> to be</font>

1137
00:48:25,900 --> 00:48:29,290
the netbios domain name not the fully

1138
00:48:27,670 --> 00:48:31,810
qualified domain name<font color="#CCCCCC"> okay so if you use</font>

1139
00:48:29,290 --> 00:48:34,840
Ebola and you want to contain the

1140
00:48:31,810 --> 00:48:36,100
explosion so to speak to<font color="#E5E5E5"> only a group of</font>

1141
00:48:34,840 --> 00:48:37,900
target users that belong to a specific

1142
00:48:36,100 --> 00:48:40,150
organization that you happen to

1143
00:48:37,900 --> 00:48:42,550
no the netbios 80 domain name of I<font color="#CCCCCC"> don't</font>

1144
00:48:40,150 --> 00:48:43,870
know they left Oh ntlm authentication

1145
00:48:42,550 --> 00:48:46,210
opens the internet and you were able<font color="#E5E5E5"> to</font>

1146
00:48:43,870 --> 00:48:47,920
get<font color="#E5E5E5"> that information that way then you</font>

1147
00:48:46,210 --> 00:48:49,900
could you can contain it such that if

1148
00:48:47,920 --> 00:48:57,850
that<font color="#E5E5E5"> payload ever landed in a sandbox</font>

1149
00:48:49,900 --> 00:49:01,360
then it would<font color="#CCCCCC"> not be able to fire it and</font>

1150
00:48:57,850 --> 00:49:06,009
I<font color="#CCCCCC"> think</font><font color="#E5E5E5"> that's what all the head in fact</font>

1151
00:49:01,360 --> 00:49:07,600
I even think I'm just about on time so

1152
00:49:06,010 --> 00:49:11,650
this<font color="#CCCCCC"> is probably the slide that you want</font>

1153
00:49:07,600 --> 00:49:16,180
<font color="#E5E5E5">San</font><font color="#CCCCCC"> Diego here come the cameras</font><font color="#E5E5E5"> okay</font>

1154
00:49:11,650 --> 00:49:18,220
this is all tools using this demo both

1155
00:49:16,180 --> 00:49:21,460
of the pieces of code that you saw the

1156
00:49:18,220 --> 00:49:23,740
the demo extras are down there at the

1157
00:49:21,460 --> 00:49:26,260
bottom on my repo so grab those and

1158
00:49:23,740 --> 00:49:31,000
customizing anything you want I'll wait

1159
00:49:26,260 --> 00:49:35,770
<font color="#CCCCCC">until the cameras go down look at that</font>

1160
00:49:31,000 --> 00:49:37,930
five minutes five minutes left I'm

1161
00:49:35,770 --> 00:49:38,890
probably at this point just be

1162
00:49:37,930 --> 00:49:40,029
respectful<font color="#E5E5E5"> the next speaker I'm not</font>

1163
00:49:38,890 --> 00:49:42,009
going to<font color="#E5E5E5"> take any questions like i said</font>

1164
00:49:40,030 --> 00:49:43,510
i will be i'll back you<font color="#E5E5E5"> can definitely</font>

1165
00:49:42,010 --> 00:49:46,300
buy me beer and I'll tell anything you

1166
00:49:43,510 --> 00:49:48,420
want<font color="#E5E5E5"> to know that's it thank you very</font>

1167
00:49:46,300 --> 00:49:48,420
much

