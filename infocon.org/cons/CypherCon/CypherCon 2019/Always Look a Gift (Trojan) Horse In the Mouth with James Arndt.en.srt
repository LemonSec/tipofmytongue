1
00:00:20,470 --> 00:00:24,979
Well alrighty. Thank you everybody for
coming and hang out for this

2
00:00:24,980 --> 00:00:31,670
two o'clock session here. Welcome to
always... 'Always Look a Gift Trojan Horse

3
00:00:31,670 --> 00:00:38,600
in the Mouth'. And it just might be the
case that the king of Troy should have

4
00:00:38,600 --> 00:00:43,790
you know, been a bit more careful with
his security awareness training. But he

5
00:00:43,790 --> 00:00:48,739
certainly did not and the rest as they
say is history. Now besides the random

6
00:00:48,739 --> 00:00:53,390
credential harvesting phishing emails
that I get every day, a lot of them is

7
00:00:53,390 --> 00:00:56,510
just flat-out emUtech, all day all the
time.

8
00:00:56,510 --> 00:01:01,849
And that's really what we're talking
about here today. And the emutech it's the

9
00:01:01,850 --> 00:01:06,320
malicious documents that are, that are
being downloaded and where people are

10
00:01:06,320 --> 00:01:10,070
clicking the fateful enable content.
And so what we're gonna be talking about

11
00:01:10,070 --> 00:01:16,758
today is just how to rip those apart and
how to get the important indicators of

12
00:01:16,759 --> 00:01:21,500
compromise that can show hey, has did
somebody click the thing? Did they enable

13
00:01:21,500 --> 00:01:26,690
the content? Did and all the other bad
things happen? Did they happen? Now, all in

14
00:01:26,690 --> 00:01:31,759
all, it is really fun to click on things
that you know you shouldn't. I can see

15
00:01:31,760 --> 00:01:37,340
why end-users do it but, it's even better
to get paid for it. So let's begin. Now of

16
00:01:37,340 --> 00:01:42,110
course as always it starts with an email
and pretty typical you know, whatever the

17
00:01:42,110 --> 00:01:45,560
theme is. I really don't care about the
theme, I don't track them that way.

18
00:01:45,560 --> 00:01:50,930
I really just oh it's an invoice or it's
AT&T bill or it's whatever. To me or

19
00:01:50,930 --> 00:01:55,759
really doesn't matter. I don't focus on
that. But of course what's the bad thing

20
00:01:55,759 --> 00:01:59,030
here? The bad thing here is that that's
not really DocuSign, it's really taking

21
00:01:59,030 --> 00:02:06,439
you to the Luxor club and the WP-content of course, right? And all in all that's suspicious.

22
00:02:06,439 --> 00:02:09,519
But what's on the other end? What would
happen if an end

23
00:02:09,520 --> 00:02:13,990
user actually did click on the thing? Well it would prompt you to download a

24
00:02:13,990 --> 00:02:19,780
document and if you open it up, it says
to enable content. Now before we get into

25
00:02:19,780 --> 00:02:23,740
the document itself, there are still some
important indicators of compromise that

26
00:02:23,740 --> 00:02:28,210
we can pull so far. One of them is who
it's from, the subject and maybe even the

27
00:02:28,210 --> 00:02:32,860
originating IP address that it came from.
That's information that you can go and

28
00:02:32,860 --> 00:02:38,050
give to your favorite email admin to say
hey, search for this, it's bad and nuke

29
00:02:38,050 --> 00:02:42,610
all of them in the environment. Or
quarantine them however it works in your

30
00:02:42,610 --> 00:02:46,990
environment. Other things that are good
to know to, the URL itself you bet. Give to your

31
00:02:46,990 --> 00:02:50,260
favorite adsits or your favorite
firewall admin and they say hey, is

32
00:02:50,260 --> 00:02:54,429
there any traffic headed outbound to
there? If so, well then we've got a

33
00:02:54,430 --> 00:02:57,100
problem.
And finally, what about the name of the

34
00:02:57,100 --> 00:03:01,239
document itself they got downloaded or
even the document hash? Is that

35
00:03:01,240 --> 00:03:05,400
information that you could put into some
sort of endpoint detection and response

36
00:03:05,400 --> 00:03:09,700
tool that can search and calm your
environment or if it sees that it does

37
00:03:09,700 --> 00:03:13,899
drop on the endpoint there, it can
actually find that based on the hash or

38
00:03:13,900 --> 00:03:19,180
just the name. That's all good stuff to
know, that's all good stuff to know. So

39
00:03:19,180 --> 00:03:24,280
before I actually go and you know enable
content one thing that I was do is look

40
00:03:24,280 --> 00:03:27,700
to check hey let's see if the neatly
content is evidence that there is a

41
00:03:27,700 --> 00:03:30,850
macro in it at all
well what I want to do first is to

42
00:03:30,850 --> 00:03:34,450
extract the macros and check them out to
see if they can give us any information

43
00:03:34,450 --> 00:03:38,619
there's a couple tools that we can use
for them one of them is office mal

44
00:03:38,620 --> 00:03:41,980
scanner it's a really simple tool you
just take the tool and you point it at

45
00:03:41,980 --> 00:03:47,560
the document and there you go now if
anybody is a picture taker yeah you can

46
00:03:47,560 --> 00:03:51,160
totally do that I hope everyone but at
the very end of this presentation I've

47
00:03:51,160 --> 00:03:54,940
got three slides that lists all the
tools where you can find them how to use

48
00:03:54,940 --> 00:04:00,160
them - so we'll have plenty of time for
picture taking later if you like or do

49
00:04:00,160 --> 00:04:03,370
with that whatever folks are going but
office mal standard it's really quite

50
00:04:03,370 --> 00:04:07,720
easy you just point it at it and office
mal scanner works really good for docx

51
00:04:07,720 --> 00:04:14,220
files and docx it's really good on those
too and in this case it found three

52
00:04:14,220 --> 00:04:17,070
macros right there and it yank them out
and put

53
00:04:17,070 --> 00:04:24,030
the folder another really good tool is
Oh Ellie dumped a Python script here and

54
00:04:24,030 --> 00:04:28,559
this is a really good book because out
early is a good docx file stock X but

55
00:04:28,560 --> 00:04:34,620
Imhotep lately has been doing XML files
disguised as docx files office Mouse

56
00:04:34,620 --> 00:04:40,050
scanner can't handle them so only dump
can again a really simple tool to use

57
00:04:40,050 --> 00:04:44,730
only dump pointed up document and you're
gonna see that here all the macros

58
00:04:44,730 --> 00:04:50,160
listed out and if it has a capital M or
even a lowercase M next to it we want to

59
00:04:50,160 --> 00:04:55,080
extract those how do we do that well you
just choose the s choose the macro

60
00:04:55,080 --> 00:04:59,969
number like there's number eight V for
verbose I'll put it to a text file head

61
00:04:59,970 --> 00:05:02,700
there you go you've got through you've
got what you need

62
00:05:02,700 --> 00:05:07,050
well then now that haven't done what
actually happens with the macro here

63
00:05:07,050 --> 00:05:14,550
they go here they are and yeah it looks
like pretty horrendous stuff but if you

64
00:05:14,550 --> 00:05:18,240
start filtering out the garbage and
actually looking at you know what's

65
00:05:18,240 --> 00:05:23,310
useful you can really help too it helps
to filter out a lot of this now what I

66
00:05:23,310 --> 00:05:26,940
do then when I'm looking at this I just
look for something that looks like an

67
00:05:26,940 --> 00:05:30,450
actual word or something in English
rather than all this extra just

68
00:05:30,450 --> 00:05:34,349
gibberish right there once they do that
I start following the variables to see

69
00:05:34,350 --> 00:05:39,270
how they're being used and we can see
here that auto open that means that when

70
00:05:39,270 --> 00:05:44,070
you enable content all of that is going
to run right away but here buried in

71
00:05:44,070 --> 00:05:50,790
this way icpo wdr sh e ll - e o power
show there we go

72
00:05:50,790 --> 00:05:54,660
now whatever this is doing it's going to
toss it in that variable so that's going

73
00:05:54,660 --> 00:05:58,320
to be important later but notice we've
got a whole bunch of more variables

74
00:05:58,320 --> 00:06:04,050
coming after that what are those ones
well it's my know looking here we got

75
00:06:04,050 --> 00:06:08,880
you can see that - uh same power shell -
be right there and this variable that

76
00:06:08,880 --> 00:06:12,900
points to this function inside this much
we've got a whole bunch more garbage

77
00:06:12,900 --> 00:06:16,289
code but buried in here is this one
we've got a big long string of

78
00:06:16,290 --> 00:06:20,490
characters and another big long string
of characters and more and all of those

79
00:06:20,490 --> 00:06:24,470
get all put together in
or online that tossed and returned into

80
00:06:24,470 --> 00:06:30,740
that is interesting looking also there's
another function of the same name here

81
00:06:30,740 --> 00:06:36,830
and what we can see is win MGMT s win32
processes tossed in there that variable

82
00:06:36,830 --> 00:06:43,639
is used here get object of this win MGMT
s win32 process start up and down here

83
00:06:43,639 --> 00:06:48,620
we've got another get object into crate
so all of those strings those big long

84
00:06:48,620 --> 00:06:53,960
strings are all being put together and
all being tossed into this mix right

85
00:06:53,960 --> 00:06:59,799
here and that is going to be assembled
once it is assembled it looks like this

86
00:06:59,800 --> 00:07:07,910
powershell - e in a whole big long
string of base64 now the question is how

87
00:07:07,910 --> 00:07:13,850
do you you get from here to where it is
going to be assembled how do we get this

88
00:07:13,850 --> 00:07:18,440
output of it having been assembled again
there's a bunch of tools that can come

89
00:07:18,440 --> 00:07:21,889
up with them so to get from the macro to
the powershell we're gonna be using a

90
00:07:21,889 --> 00:07:26,270
viper monkey another couple of behavior
analysis ones come and watch from cosmic

91
00:07:26,270 --> 00:07:29,299
security they got anybody heard of them
they've got a bunch of other tools out

92
00:07:29,300 --> 00:07:34,130
there that are useful process fire
control and process hacker itself let's

93
00:07:34,130 --> 00:07:39,590
start with Viper monkey again another
very simple tool to use Viper monkey and

94
00:07:39,590 --> 00:07:43,099
he just pointed at the document and he
let it fly Viper monkey is an emulator

95
00:07:43,100 --> 00:07:46,610
it's not actually going to enable
content or trigger or anything it just

96
00:07:46,610 --> 00:07:51,800
looks at it and says hey what's going to
happen with it analyzes all the VBA code

97
00:07:51,800 --> 00:07:54,550
and once it is done and it does take a
little bit

98
00:07:54,550 --> 00:07:59,800
time it spits out at the end here hey
powershell - b and there is all of the

99
00:07:59,800 --> 00:08:04,510
base64 so they're handy tool to use
another way of doing that though is

100
00:08:04,510 --> 00:08:09,730
actually you're going to have to open
the document and enable content so when

101
00:08:09,730 --> 00:08:14,050
you do that in your analysis analysis
machine don't have pointed out the real

102
00:08:14,050 --> 00:08:18,670
internet shut down the interface because
I've of course never infected my machine

103
00:08:18,670 --> 00:08:22,840
right talk to anybody who works with
malware and yes 50% of them will say oh

104
00:08:22,840 --> 00:08:29,650
of course
I've never ransomware to myself this is

105
00:08:29,650 --> 00:08:33,909
the one from County security this one
what it does is it looks for different

106
00:08:33,909 --> 00:08:39,520
processes to spawn command powershell
run dll 32 w script you click start

107
00:08:39,520 --> 00:08:45,040
open the document enable content and it
interrupts powershell in this case we're

108
00:08:45,040 --> 00:08:50,349
opening it show as we hate her show was
called and here's what it was here's the

109
00:08:50,350 --> 00:08:55,360
command line that was spent to it so
that's all way together cross the spot

110
00:08:55,360 --> 00:08:58,690
control is any way of doing that in
PowerShell you run this script

111
00:08:58,690 --> 00:09:02,980
powershell control our spots our
processes bomb control and on its gonna

112
00:09:02,980 --> 00:09:07,330
sit there and wait open the document
enable content and i'll say hey this

113
00:09:07,330 --> 00:09:11,860
wants to run PowerShell run by the
parent process w my PR BSC you want to

114
00:09:11,860 --> 00:09:16,390
keep suspended but underneath here we've
got the new spawn process and here's the

115
00:09:16,390 --> 00:09:22,060
command line that was fed to it so again
another way of doing this my preferred

116
00:09:22,060 --> 00:09:26,589
way really quick and dirty it's not
complicated that is just have a process

117
00:09:26,590 --> 00:09:34,330
hacker open enable content watch and w
my peer he has a pair of the SE it once

118
00:09:34,330 --> 00:09:38,290
powershell opens up quick double click
it and they do get the properties of it

119
00:09:38,290 --> 00:09:43,860
and there you can find the command line
right down there yeah quick and dirty

120
00:09:43,860 --> 00:09:51,870
but it's what you it's which one so
however we got here now what we've got a

121
00:09:51,870 --> 00:09:55,740
whole bunch of basics before encoded
information what do we obviously want to

122
00:09:55,740 --> 00:10:03,060
do we want to I'm base64 it if that's
the right way to put it what is cyber

123
00:10:03,060 --> 00:10:08,189
chef Tsai chef anybody here fans of it
yeah all right well this is perfect

124
00:10:08,190 --> 00:10:11,370
application for what we're going to be
doing today

125
00:10:11,370 --> 00:10:15,540
cyber chef is great because you feed the
information into the top and then you

126
00:10:15,540 --> 00:10:19,890
pull in all these different operations
or recipes maybe ingredients because

127
00:10:19,890 --> 00:10:24,300
it's like a chef Lucas anyway it takes
me to drag them over here and one of

128
00:10:24,300 --> 00:10:29,910
them is from base64 so here's the input
you from base64 it's gonna unto it and

129
00:10:29,910 --> 00:10:33,420
then we're going to get the output here
so that mean kind of you know here's the

130
00:10:33,420 --> 00:10:38,310
output from having it been on the base64
and we see a whole lot of English words

131
00:10:38,310 --> 00:10:42,359
that's fine it's still very tough to
read so then the next thing that we want

132
00:10:42,360 --> 00:10:46,740
to do is to use another recipe called
remove null pipes that's made to be all

133
00:10:46,740 --> 00:10:51,630
these extra periods and things in there
and once we do that it'll transform the

134
00:10:51,630 --> 00:10:58,290
data - this looks better but now we have
a bunch of these ' + across the board

135
00:10:58,290 --> 00:11:03,030
sky comas for some of you but we have a
whole bunch of those all over the place

136
00:11:03,030 --> 00:11:07,140
and so let's give it of those well there
is the find/replace and let's get rid of

137
00:11:07,140 --> 00:11:11,490
that replace it with nothing once we're
done with that then here's how to

138
00:11:11,490 --> 00:11:18,660
transform the data slightly better but
if we look at it carefully we can see

139
00:11:18,660 --> 00:11:22,730
that we've got a whole bit of line in
red here we've got a whole bunch of data

140
00:11:22,730 --> 00:11:27,900
but then surrounding that is memories
string convert from base pose so all of

141
00:11:27,900 --> 00:11:33,300
this is base 64 this is going 200 base64
and then wrapped around that is

142
00:11:33,300 --> 00:11:39,120
compression deflates stream well there
are cyber chef recipes to do that so we

143
00:11:39,120 --> 00:11:43,240
need to copy
the base64 we put it back at the top and

144
00:11:43,240 --> 00:11:46,840
then we use these two recipes from
basics before and then bra inflate and

145
00:11:46,840 --> 00:11:55,810
we get ten of this what do we see we see
it one two three four five URLs and we

146
00:11:55,810 --> 00:11:59,109
see a whole bunch of other commercial
commands down here let's clean this up a

147
00:11:59,110 --> 00:12:03,130
little bit and we can see that yeah
mixing that web client and here in this

148
00:12:03,130 --> 00:12:08,230
variable we've got the five URLs they're
split on the axonal we've got another

149
00:12:08,230 --> 00:12:13,660
interesting one right here 872 is
possible to that variable this one is

150
00:12:13,660 --> 00:12:20,140
pointing to that your user profile slash
872 is across right there exe and then

151
00:12:20,140 --> 00:12:25,360
for each of the items in this and that
variable right there it's going to try

152
00:12:25,360 --> 00:12:33,730
to download the file to that location
rename it 872 vxe and then invoke it so

153
00:12:33,730 --> 00:12:38,980
we've got our five URLs that is now five
indicators of compromise that would be

154
00:12:38,980 --> 00:12:43,270
important too to hunt for the last two
things that you can do here if you

155
00:12:43,270 --> 00:12:46,890
really want to clean up your data even
more is just use these two recipes

156
00:12:46,890 --> 00:12:50,980
extract URLs and split on the accent
well then then you look at that nice

157
00:12:50,980 --> 00:12:57,400
lovely list of five lines that you can
take and copy paste on to wherever the

158
00:12:57,400 --> 00:13:03,310
heck you want us now what are other ways
that the attacker who have made over the

159
00:13:03,310 --> 00:13:07,380
past couple months what are other ways
that they have been encoding their

160
00:13:07,380 --> 00:13:12,640
powershot all over code right there well
in this case they were doing this for a

161
00:13:12,640 --> 00:13:15,910
while just to get to command exe and
they were do downtown slash dot dot

162
00:13:15,910 --> 00:13:20,290
slash windows and fine
as a way to just execute that this one

163
00:13:20,290 --> 00:13:25,180
was interesting though because we have a
huge long string of data right there and

164
00:13:25,180 --> 00:13:30,400
being taught getting tossed into xho
live and then for each character in

165
00:13:30,400 --> 00:13:36,370
there it's going to start at character
497 count backwards and at zero

166
00:13:36,370 --> 00:13:43,780
well character 497 as this 1p go reverse
Oh wer sa peau so what this is doing is

167
00:13:43,780 --> 00:13:48,100
just reversing all of that tossing it
into that variable and then once it's

168
00:13:48,100 --> 00:13:53,860
done calling it yeah and it gets my
stuff go figure

169
00:13:53,860 --> 00:13:58,570
this is an interesting one too there's
been variations on this for a while now

170
00:13:58,570 --> 00:14:03,100
to the game you see that dot dot slash
dot dot slash command EMC we've got a

171
00:14:03,100 --> 00:14:07,120
big huge long string of characters right
here and then for each of these

172
00:14:07,120 --> 00:14:11,650
characters in this big one already I
don't know the right words array might

173
00:14:11,650 --> 00:14:14,260
be the right thing
there's dictionary I don't know which

174
00:14:14,260 --> 00:14:20,560
one but anyway for each one of those 71
character number 71 that 756 character

175
00:14:20,560 --> 00:14:24,160
56 character 30 character pretty simple
everything you need to know is right

176
00:14:24,160 --> 00:14:28,449
there but this is rearranging it all in
the correct order tossing it in this

177
00:14:28,450 --> 00:14:34,120
variable and then typing it into command
so that it will execute now to go

178
00:14:34,120 --> 00:14:38,260
through and undo all of that I'm not
going to do that by hand but what you

179
00:14:38,260 --> 00:14:40,689
can't do is open up this is power show
right

180
00:14:40,690 --> 00:14:46,510
open up our shelf copy and paste from
set all the way down to right before the

181
00:14:46,510 --> 00:14:51,520
pipe so copy from the sent down right
before the pipe because all of that has

182
00:14:51,520 --> 00:14:55,720
to be mine scrambled before it gets to
the command well if you can copy and

183
00:14:55,720 --> 00:15:00,220
paste that toss it into PowerShell
command prompt power so we'll do all the

184
00:15:00,220 --> 00:15:05,050
work for you then then spit out well the
decoded commands and then you'll get

185
00:15:05,050 --> 00:15:09,439
your five URLs that way again don't copy
and paste

186
00:15:09,440 --> 00:15:12,920
in the pipe today and that will be bad
it will actually do the things it's

187
00:15:12,920 --> 00:15:18,560
trying to do five new reflux this one
was well really quite silly I mean we've

188
00:15:18,560 --> 00:15:22,369
got again a big long string of
characters but down here dot replace and

189
00:15:22,370 --> 00:15:25,910
what replacing any time you find the
triple zeros replaced it with whatever

190
00:15:25,910 --> 00:15:30,410
is in that variable well nothing is in
that variable but what we see here is a

191
00:15:30,410 --> 00:15:36,889
new object continent if you get rid of
all those zeros so end up with what HTTP

192
00:15:36,889 --> 00:15:42,470
there's an IP address and all of that so
again before a cyber chef it'd be easy

193
00:15:42,470 --> 00:15:46,699
just copy and paste all of this they
have their Find and Replace recipe

194
00:15:46,699 --> 00:15:50,990
tossing the three zeros replaced with
nothing and you'll get out the five URLs

195
00:15:50,990 --> 00:15:57,980
that you need it the JavaScript time
yeah that's something that they've been

196
00:15:57,980 --> 00:16:02,060
doing much more recently this is one of
the first ones that they tried with you

197
00:16:02,060 --> 00:16:07,369
can see the 1 2 3 4 5 here where else
just plain this days sitting out there

198
00:16:07,370 --> 00:16:12,290
just to annoy everybody apparently and
that made it obvious say that JavaScript

199
00:16:12,290 --> 00:16:17,000
which is making this much much more
difficult because up here we've got a

200
00:16:17,000 --> 00:16:20,620
whole bunch of variables and you see
like the equals equal sign right there

201
00:16:20,620 --> 00:16:26,420
every single one of these strengths is
all base64 encoded oh I could just take

202
00:16:26,420 --> 00:16:31,399
each one individually and basics before
decoded no no no no because there's

203
00:16:31,399 --> 00:16:35,480
another function down there that takes
what has been decoded runs its own one

204
00:16:35,480 --> 00:16:44,930
on encryption on the station script on
it there's no easy way to do this so in

205
00:16:44,930 --> 00:16:48,979
this case what I've been doing then is
taking them and tossing it into an

206
00:16:48,980 --> 00:16:54,920
online sandbox are called any dot run is
everybody here familiar with them yes if

207
00:16:54,920 --> 00:16:58,430
you're not familiar with it we're going
to talk about it near the end of this

208
00:16:58,430 --> 00:17:03,680
presentation but if super awesome it's
ok well quite a market anyway what it

209
00:17:03,680 --> 00:17:07,109
does is it actually
and the JavaScript and hey here's the

210
00:17:07,109 --> 00:17:10,919
error that was buried in that JavaScript
code saying oh there's an error my hope

211
00:17:10,920 --> 00:17:13,020
bummer
sorry about you but in the background

212
00:17:13,020 --> 00:17:16,349
it's actually reaching out to the one
truth be it's reaching out to the URLs

213
00:17:16,349 --> 00:17:19,169
and you can pick them up that way all
right

214
00:17:19,170 --> 00:17:25,620
so oh we're not done this one is much
more recent too with the interesting

215
00:17:25,619 --> 00:17:31,770
thing about this is that here you can
see all of the jumbled about URLs and

216
00:17:31,770 --> 00:17:35,970
what's happening here is that it's going
to find the 30th one one two three four

217
00:17:35,970 --> 00:17:39,809
oh sorry zero one two three bla bla bla
bla bla find that one and it's just

218
00:17:39,809 --> 00:17:45,570
rearranging all of these chunks into the
right order up there tossing it to mu 4

219
00:17:45,570 --> 00:17:51,030
mu 4 D and down here it's going to go
through them and invoke it and all the

220
00:17:51,030 --> 00:17:56,360
same commercial stuff that we've been
seeing this whole time so whatever way

221
00:17:56,360 --> 00:18:00,840
they're doing it whatever way that
they're going to end up doing it we've

222
00:18:00,840 --> 00:18:05,370
now added to our list of indicators
compromising that is these 5 URLs right

223
00:18:05,370 --> 00:18:11,790
there and also when is it going to be
landed on the end point itself that

224
00:18:11,790 --> 00:18:16,168
might change that's why it's important
to be able to do this manually so that

225
00:18:16,169 --> 00:18:20,580
you can see hey where is it going to be
if something is infected I might be able

226
00:18:20,580 --> 00:18:27,000
to find in at that location
well then at this point we pretty much

227
00:18:27,000 --> 00:18:30,360
done all we can with the document we've
got the URLs we know where it's going to

228
00:18:30,360 --> 00:18:34,678
land now here comes the fun part go to
one of these websites and try to

229
00:18:34,679 --> 00:18:40,380
download the executable don't download
and run it but just save it save it

230
00:18:40,380 --> 00:18:46,290
nothing this time again now that I've
made that assay but anyway what can we

231
00:18:46,290 --> 00:18:49,710
do with that executable we want to know
how it runs we want to know what it's

232
00:18:49,710 --> 00:18:53,400
going to do well there's some tools that
you can give us an idea of what's going

233
00:18:53,400 --> 00:18:59,400
to happen one of them is called PE
studio and you just take the executable

234
00:18:59,400 --> 00:19:02,700
toss it in there and it runs just a
bunch of different checks on them

235
00:19:02,700 --> 00:19:05,170
they're really
if one of them is you know he will give

236
00:19:05,170 --> 00:19:10,390
you the hem v5 hash or the sha-1 - to
say I don't know whichever one it is and

237
00:19:10,390 --> 00:19:13,600
then we'll give you that information
that's good to know but the other thing

238
00:19:13,600 --> 00:19:16,360
that does is it comes from the
executable and it looks at the import

239
00:19:16,360 --> 00:19:22,120
address table to try to figure hey what
is this piece of software what's this

240
00:19:22,120 --> 00:19:25,540
mail we're going to borrow from the
operating system in order to function

241
00:19:25,540 --> 00:19:29,020
because not all the code is baked into
the malware it's going to borrow

242
00:19:29,020 --> 00:19:35,080
something and we look at that address
table we can get an idea of what it

243
00:19:35,080 --> 00:19:39,010
might do well in this case here all the
different windows e things and it's

244
00:19:39,010 --> 00:19:44,140
going to be to be pulling in like remove
directory interesting switch to fiber

245
00:19:44,140 --> 00:19:51,160
get current thread ID get process ID
okay create process none of this is

246
00:19:51,160 --> 00:19:55,840
really that I'm opening I mean we could
totally go to MSDN and search every

247
00:19:55,840 --> 00:20:01,209
single one good idea but it's really not
that obvious which means that oh it's a

248
00:20:01,210 --> 00:20:04,870
motive it's probably package means it
has some sort of wrapper that's going to

249
00:20:04,870 --> 00:20:08,800
run to make it tougher to analyze where
if weak so if we prepared well that what

250
00:20:08,800 --> 00:20:14,200
was being imported here with another one
look at this one let's see what do we

251
00:20:14,200 --> 00:20:19,060
have here Oh registry open heat registry
close key registry said how are you okay

252
00:20:19,060 --> 00:20:23,350
so we don't for sure that this one is
likely to do something to do you have a

253
00:20:23,350 --> 00:20:26,860
question all right
I thought you even had a double question

254
00:20:26,860 --> 00:20:32,530
because you're raising both hands all
right all right all right anyway exit

255
00:20:32,530 --> 00:20:38,110
process ioo import see if an output
control side okay so this one certainly

256
00:20:38,110 --> 00:20:42,820
sounds a lot more like it's going to be
it's a bit more obvious what it's going

257
00:20:42,820 --> 00:20:47,530
to be doing well think about this one is
that this one is from word for 2004

258
00:20:47,530 --> 00:20:52,930
called dual juice and oh it's a worm so
it makes sense then and it's going to be

259
00:20:52,930 --> 00:20:56,620
doing some
if you know some psychic ones and it's

260
00:20:56,620 --> 00:21:00,639
going to be messing with your registry
all that again we didn't see that with

261
00:21:00,640 --> 00:21:05,140
the emo timeline oh well sometimes
you're not always lucky but we did get a

262
00:21:05,140 --> 00:21:09,519
couple more of a bits of information
right here md5 of sha-256 that's tough

263
00:21:09,519 --> 00:21:16,289
to know so that was our initial analysis
here now it's time to click the thing

264
00:21:16,289 --> 00:21:21,220
double clear that excuse me
now all the fun is to be happy but the

265
00:21:21,220 --> 00:21:27,159
thing about malware is that Matt we're
can't hide but it must run and when it

266
00:21:27,159 --> 00:21:31,480
runs it's going to do stuff and if we
can watch that stuff we can pay

267
00:21:31,480 --> 00:21:34,389
attention to it if you can see what it's
writing and what it's doing watch all

268
00:21:34,389 --> 00:21:38,320
the threads and the processes that is
opening that's all the information that

269
00:21:38,320 --> 00:21:41,590
is good for us to know and how it
behaves and so there's a bunch of

270
00:21:41,590 --> 00:21:46,178
different tools that we're going to be
using for them one is read shocked read

271
00:21:46,179 --> 00:21:51,610
shine is nice as a simple tool all you
have to do is just before you run the

272
00:21:51,610 --> 00:21:55,539
malware all you do is you take a shot it
takes a shot with your registry complete

273
00:21:55,539 --> 00:21:59,799
shot of it that you run your malware
wait till it's done doing its thing and

274
00:21:59,799 --> 00:22:04,179
maybe take my second shot of your
registry and it does a dip on them

275
00:22:04,179 --> 00:22:08,799
what's changed
so we mean if it does change anything it

276
00:22:08,799 --> 00:22:12,490
really does stand out like this or much
output but you'll see what has changed

277
00:22:12,490 --> 00:22:16,870
that's good Wireshark
everybody's favorite should be

278
00:22:16,870 --> 00:22:20,479
self-explanatory I hope network traffic
for those of you were going to pay

279
00:22:20,480 --> 00:22:25,520
should never traffic see what it's doing
prospects me monitor this one is a beast

280
00:22:25,520 --> 00:22:29,990
you just turn it on and did one actually
have good notes here don't know what is

281
00:22:29,990 --> 00:22:34,730
press this one interview oh yes monitors
all changes to the system so anything

282
00:22:34,730 --> 00:22:38,630
that has been written also covers
registry any new processes new threads

283
00:22:38,630 --> 00:22:43,520
it creates a ton of power in fact one of
them here yeah it was just running for

284
00:22:43,520 --> 00:22:47,990
like maybe 10 seconds and it created you
know 50,000 different events all in here

285
00:22:47,990 --> 00:22:56,150
and then the process hacker it's your
marriage on steroids basically we can do

286
00:22:56,150 --> 00:23:03,320
so let's look at process hacker here
once we start it we can see that 872 not

287
00:23:03,320 --> 00:23:09,320
the HD it makes a copy of itself okay
that's interesting after does that then

288
00:23:09,320 --> 00:23:14,720
it creates the new one spawns off the
new process called EEP meet again exe

289
00:23:14,720 --> 00:23:20,150
and then it kills itself see how 872 is
gone that's interesting so the parent

290
00:23:20,150 --> 00:23:24,140
process disappears the child process is
still there has its own process so it

291
00:23:24,140 --> 00:23:29,570
make it tough to find for that parent is
interesting well then what can we do

292
00:23:29,570 --> 00:23:34,010
with this just sitting here running well
if we double-click on it we can see the

293
00:23:34,010 --> 00:23:39,980
different properties here and one of
them is where it is running from so it's

294
00:23:39,980 --> 00:23:44,690
72 dot exe we know where that one was
going to land because that's what the

295
00:23:44,690 --> 00:23:50,150
powershell script did and then we can
also see hey once it does run where is

296
00:23:50,150 --> 00:23:54,410
the trial process likely to be and it
would be that location right there

297
00:23:54,410 --> 00:23:59,090
that's really good if you're looking for
effective systems now another thing that

298
00:23:59,090 --> 00:24:05,540
you can do at this point is as this is
running there's another tab here called

299
00:24:05,540 --> 00:24:10,040
memory that we click on that we can
start looking through all the different

300
00:24:10,040 --> 00:24:14,530
strings that it has a memory and what to
receive I appear

301
00:24:14,530 --> 00:24:21,320
here's could be see to information or on
that a little bit but yeah this is just

302
00:24:21,320 --> 00:24:28,300
know that all the information is just
right there process monitor again

303
00:24:28,300 --> 00:24:34,820
watches your system and just gives you a
ton ton of output and in this case I

304
00:24:34,820 --> 00:24:37,610
haven't filtered on PowerShell and you
created you have twenty thousand events

305
00:24:37,610 --> 00:24:42,139
after just you about 10 seconds of
beating on and yeah think about a

306
00:24:42,140 --> 00:24:46,880
process monitor is that it is completely
atrocious to comb through and try to

307
00:24:46,880 --> 00:24:51,620
find anything I mean it's really bad so
there are lovely tools that we can use

308
00:24:51,620 --> 00:24:56,330
to show all this graphically one of them
being proc duct anyone familiar with

309
00:24:56,330 --> 00:25:01,250
this yeah yeah okay so what you can do
is you can take the output for process

310
00:25:01,250 --> 00:25:07,100
monitor save it as a CSV import it into
your Proctor and you give this lovely

311
00:25:07,100 --> 00:25:12,050
graph that they're starting and doing
all the things that it did and a lovely

312
00:25:12,050 --> 00:25:15,320
graphical view so let me zoom in here a
little bit

313
00:25:15,320 --> 00:25:20,899
and we can see 872 creating its own
child process of itself and then this

314
00:25:20,900 --> 00:25:25,640
one ends up creating EAP me target right
there which is living at this address

315
00:25:25,640 --> 00:25:29,780
and then this one has threads in it
starts it looks like it's changing some

316
00:25:29,780 --> 00:25:34,460
things to the registry so all this
information after click here again when

317
00:25:34,460 --> 00:25:38,390
you're click on it don't point it to the
Internet but all this information is all

318
00:25:38,390 --> 00:25:42,830
just you know right there as we're
watching this behaviorally of course we

319
00:25:42,830 --> 00:25:48,500
can watch Wireshark and just turn it on
let it fly and you'll see that after a

320
00:25:48,500 --> 00:25:52,850
little bit after a very regular
intervals it's going to try to reach out

321
00:25:52,850 --> 00:25:58,699
to different IPS definitely its command
and control that c2 IP address and then

322
00:25:58,700 --> 00:26:04,040
swipe to go to if you get that list send
it to your favorite firewall or a smart

323
00:26:04,040 --> 00:26:09,170
person hey if you see any traffic up to
these IPS we're gonna have a bad day

324
00:26:09,170 --> 00:26:11,650
okay

325
00:26:11,660 --> 00:26:16,400
science up so there now that has given
us a whole bunch more information what

326
00:26:16,400 --> 00:26:20,060
is that on the net point we can see
where a PAP target is going to end up

327
00:26:20,060 --> 00:26:24,560
being we can see that Y it can be time
that EMC also shares the same md5 in

328
00:26:24,560 --> 00:26:29,060
cash well because it was a copy of you
know the original and we've got a whole

329
00:26:29,060 --> 00:26:34,000
bunch of command control information
that we haven't have gathered from this

330
00:26:34,000 --> 00:26:40,250
finally okay not complying I'm not done
yet but t-bucket say whatever cost

331
00:26:40,250 --> 00:26:43,400
anything into a disassembler and looked
at basics before I want to acknowledge

332
00:26:43,400 --> 00:26:48,050
your eyes oh I can see the pain in your
face right there yeah what would the

333
00:26:48,050 --> 00:26:54,440
value of this be if we're to look at the
traffic the c2 traffic that no actually

334
00:26:54,440 --> 00:26:59,660
did take and pointed my VM to the actual
Internet and let Imhotep fly

335
00:26:59,660 --> 00:27:03,050
watch the traffic and you know trying to
look at what's they actually doing of

336
00:27:03,050 --> 00:27:06,530
course it's all encoded information they
don't want people like me to see what it

337
00:27:06,530 --> 00:27:11,629
is that they're sending back and forth
well in a disassembler or in a debugger

338
00:27:11,630 --> 00:27:19,370
it should make sense that the for emote
n actually sends out any information it

339
00:27:19,370 --> 00:27:24,590
has to collect it before it actually
encodes it encrypts of somehow it has to

340
00:27:24,590 --> 00:27:29,899
have it all gathered together it should
be possible then to intercept that point

341
00:27:29,900 --> 00:27:34,730
and actually look and see what it has
put together the medics about to send

342
00:27:34,730 --> 00:27:37,400
off that would give us a lot of
information well that's the sort of

343
00:27:37,400 --> 00:27:41,670
thing that can be done if you're good at
assembly and just walk through all this

344
00:27:41,670 --> 00:27:46,170
kind of interesting just to you know
walk through it very frustrating too but

345
00:27:46,170 --> 00:27:51,110
I did not do this because that goes
beyond the scope of this presentation

346
00:27:51,110 --> 00:27:57,659
which was going for it it's really hard
so so yeah I mean without information is

347
00:27:57,660 --> 00:28:01,110
all in there and there's been a lot of
different writes about that most recent

348
00:28:01,110 --> 00:28:05,580
one I saw is this guy right here a
person I met he did his own part to his

349
00:28:05,580 --> 00:28:09,810
part one was all about the analyzing the
document to the macro and stuff but that

350
00:28:09,810 --> 00:28:17,940
right there was him actually walking
through and his adventure in in dividing

351
00:28:17,940 --> 00:28:22,980
this and going through it seeing how it
all works when it's spawned and all so

352
00:28:22,980 --> 00:28:28,710
fascinating reading
if you can't post it now at this point

353
00:28:28,710 --> 00:28:35,040
we have now crawled from the mouth of
the Trojan horse all the way through and

354
00:28:35,040 --> 00:28:39,540
we've emerged up the other end here and
it might be the case that at this point

355
00:28:39,540 --> 00:28:43,649
you still may have no idea what you do
anything that's fine there's help

356
00:28:43,650 --> 00:28:49,080
there's help online analysis is just
easy way for have someone else to do all

357
00:28:49,080 --> 00:28:52,460
the work and of course there's
everyone's favorite virustotal

358
00:28:52,460 --> 00:28:56,580
really useful just giving a thumbs-up
thumbs-down depending upon if it's

359
00:28:56,580 --> 00:29:02,370
really well known or not and that's not
all I can really say my virustotal this

360
00:29:02,370 --> 00:29:06,689
that's all too important all right
another sandbox on line I like this one

361
00:29:06,690 --> 00:29:11,190
a lot of hybrid analysis it gives just
choose on it and it gives a really good

362
00:29:11,190 --> 00:29:14,940
graphical output a whole lot of
information about what it's doing

363
00:29:14,940 --> 00:29:19,030
you know the different
it reports some ideas that I ran out to

364
00:29:19,030 --> 00:29:23,700
where it's actually going what all the
different functions that it imported

365
00:29:23,700 --> 00:29:28,180
before it ran the different mutants that
it created it just gives you a whole

366
00:29:28,180 --> 00:29:35,380
bunch of information and this one was my
favorite until any run any run it is

367
00:29:35,380 --> 00:29:39,280
amazing every time there's free version
of the pay for the free version is

368
00:29:39,280 --> 00:29:42,010
amazing
any time you toss it something I expense

369
00:29:42,010 --> 00:29:46,960
up a brand new VM and get watches and
it's beautiful it is so beautiful so

370
00:29:46,960 --> 00:29:51,580
here's the vio right here and here we've
got we were word up you can totally see

371
00:29:51,580 --> 00:29:56,230
that I know you can but down here got
windward is calling powershell 872 and

372
00:29:56,230 --> 00:30:00,280
all the processes afterwards and
afterwards and the town here we've got

373
00:30:00,280 --> 00:30:04,330
all let me just zoom in here if we're
gonna click on any one of these is it a

374
00:30:04,330 --> 00:30:08,560
pop-up or you can see PowerShell very
bad block well because it's not all this

375
00:30:08,560 --> 00:30:12,190
basics before that's the same basics
before that we saw you copy and paste

376
00:30:12,190 --> 00:30:17,500
that and analyze it all of it right
there and then we go to the next process

377
00:30:17,500 --> 00:30:23,710
there's 872 running which calls if you'd
be talking right there what is it - we

378
00:30:23,710 --> 00:30:28,210
can see that it ends up just missing
with the windows microsoft windows

379
00:30:28,210 --> 00:30:32,710
currentversion run a registry key oh
that's the persistence mechanism right

380
00:30:32,710 --> 00:30:36,100
there that's cool that's all that
information was all right there and then

381
00:30:36,100 --> 00:30:41,020
afterwards this one ran long enough
where even I actually called back on @c

382
00:30:41,020 --> 00:30:45,220
to channel and then downloaded what came
after you know temp which in this case

383
00:30:45,220 --> 00:30:49,510
was trip up now what was trip out to the
trick by it ran a bunch of commands that

384
00:30:49,510 --> 00:30:55,960
work on stop when defense off Windows
Defender delete windows Mad Max cool set

385
00:30:55,960 --> 00:30:59,950
preferences disable real time monitor
and true and all of that so all this

386
00:30:59,950 --> 00:31:04,180
information was just brought to the
surface just just wonderful wonderful

387
00:31:04,180 --> 00:31:11,350
sandbox here we can also see here's the
request to access press dot Rd Sarkar

388
00:31:11,350 --> 00:31:15,178
comm were in other word
go figure and here's all of the c2

389
00:31:15,179 --> 00:31:21,059
traffic all this information is brought
up but there is a danger to rely only on

390
00:31:21,059 --> 00:31:30,570
these online sandboxes right there
that's one out of the five URLs if I was

391
00:31:30,570 --> 00:31:34,020
only relying on this I said oh there's
the one that's bad but no there are

392
00:31:34,020 --> 00:31:39,059
still four more you have to be able to
do this by hand you have to be able to

393
00:31:39,059 --> 00:31:43,110
do this manually so that you're able to
catch everything every indicator of

394
00:31:43,110 --> 00:31:55,049
compromise possible so fair warning be
careful of it yes yes they can

395
00:31:55,049 --> 00:31:59,279
yes the question was isn't something
malware trying to be aware that it is

396
00:31:59,279 --> 00:32:05,549
running from inside the sandbox and yeah
they totally can I think there's I can't

397
00:32:05,549 --> 00:32:08,820
speak specifically on that because of a
secretive thing I just can't remember

398
00:32:08,820 --> 00:32:12,299
but yeah you're right some of them do
and if some cases sometimes they'll just

399
00:32:12,299 --> 00:32:17,100
wait a long time any doubt run is nice
because you can keep adding minutes on

400
00:32:17,100 --> 00:32:23,309
to it for the free version it's not
defined but really care too much tax

401
00:32:23,309 --> 00:32:27,059
rewrite that in there but anyway yeah
you're definitely right so if you get no

402
00:32:27,059 --> 00:32:29,399
results maybe try it different online
sandbox

403
00:32:29,399 --> 00:32:36,658
we have no very good question very good
question last word here is King and very

404
00:32:36,659 --> 00:32:41,520
similar to any run or the hybrid
analysis one however one thing that they

405
00:32:41,520 --> 00:32:45,690
toss on here is that if they detects
that the binary of tops up there is in

406
00:32:45,690 --> 00:32:51,120
110 it's actually going to extract the
RSA public key that it used and all of

407
00:32:51,120 --> 00:32:57,239
the c2 URLs so that's just you know less
work that you have to do on the front

408
00:32:57,240 --> 00:33:00,149
door the middle end it just has it all
right there

409
00:33:00,149 --> 00:33:03,928
and what they base that off was their
work from this hour right there door d0

410
00:33:03,929 --> 00:33:10,840
0 RT he was writing his own you know
reversing the Packer surrounding

411
00:33:10,840 --> 00:33:15,459
it really interesting stop check it out
if that's a thing or just use it here in

412
00:33:15,460 --> 00:33:19,210
Cape I think Kate may have modified that
since that point and adjusted it for

413
00:33:19,210 --> 00:33:25,690
them but anyway well we have now come to
a presentation wherever you'd like to

414
00:33:25,690 --> 00:33:30,429
take pictures feel free again myself
that I'm using is just VMware

415
00:33:30,429 --> 00:33:34,539
Workstation on top of the windows
windows 10 analysis machine that's where

416
00:33:34,539 --> 00:33:39,610
I do all my stuff using Microsoft Office
again completely off my corporate

417
00:33:39,610 --> 00:33:44,949
network this doesn't touch anything and
so that's why I offense my pipe to all

418
00:33:44,950 --> 00:33:48,940
the people that exist what did I use to
extract mangroves that would be off

419
00:33:48,940 --> 00:33:52,779
smell scanner oh hell the dump you can
find them right there now office mouse

420
00:33:52,779 --> 00:33:58,299
care has been a long time since it's
been updated I think 2013 it still works

421
00:33:58,299 --> 00:34:02,740
really well as a discipline yes I would
yes he does have some sort of display or

422
00:34:02,740 --> 00:34:10,060
saying it still works when you need it
holy dump it's really nice deep your

423
00:34:10,060 --> 00:34:16,119
Steven sees those a lot on the Aria side
of things and it's his work good too

424
00:34:16,119 --> 00:34:22,990
what about that macro analysis we had
Viper monkey that was the actually it

425
00:34:22,989 --> 00:34:25,629
did actually execute the document he
just combed through it it was an

426
00:34:25,629 --> 00:34:29,618
emulated all vbscript command watcher
process climate control interrupted

427
00:34:29,619 --> 00:34:33,310
those process hacker was the quick and
dirty way it's also just a handy tool to

428
00:34:33,310 --> 00:34:36,569
have and then a little cyber chef which
everyone loves

429
00:34:36,569 --> 00:34:41,889
also behavioral analysis what is it that
we did again malware has to run when it

430
00:34:41,889 --> 00:34:45,579
runs it does step so process after
process monitor knock down that shot

431
00:34:45,579 --> 00:34:49,690
Wireshark all those things really good
to have on your reverse engineering

432
00:34:49,690 --> 00:34:55,510
platform and then for the analyze
executables themselves de stereo xx

433
00:34:55,510 --> 00:34:59,290
before debug NSA had their release of I
get dry

434
00:34:59,290 --> 00:35:01,810
I think it's called naps that our
gruesome check platform I've messed

435
00:35:01,810 --> 00:35:05,529
around with it
yeah it's a thing cuz it works I think

436
00:35:05,530 --> 00:35:11,530
it's gonna get better and then finally
an analysis that's where all those are

437
00:35:11,530 --> 00:35:14,119
used now there's a whole lot of people
out

438
00:35:14,119 --> 00:35:18,920
who do work specifically on Hewitt and
releasing this information that they

439
00:35:18,920 --> 00:35:23,420
analyzed one of them is the crypto give
us one account on Twitter that's run by

440
00:35:23,420 --> 00:35:28,099
four people units Ron and Jay Bruce and
PS six to 60 K and M no you know I

441
00:35:28,099 --> 00:35:34,309
wasn't my head same dev no loop but no
it's Devon all no up yeah but you get

442
00:35:34,309 --> 00:35:37,940
your money yeah those are the four guys
behind that account that account right

443
00:35:37,940 --> 00:35:41,690
there spits out so much information
really quick up-to-date information on

444
00:35:41,690 --> 00:35:46,279
what's the latest URLs that you my pet
is using and also keeps track of a lot

445
00:35:46,279 --> 00:35:51,349
of the c2 infrastructure it was these
guys who noticed that oh there seems to

446
00:35:51,349 --> 00:35:55,549
be one big group of c2 infrastructure
over here and then another one it's only

447
00:35:55,549 --> 00:35:59,839
those two and then maybe your labor you
have can't remember who was they wrote

448
00:35:59,839 --> 00:36:02,990
an article saying oh we notice that
there are two different you know groups

449
00:36:02,990 --> 00:36:07,930
that you can test using in these guys
like no okay reduce all the guys and

450
00:36:07,930 --> 00:36:12,618
great plants everything that they dump
all those bio seeds especially when it

451
00:36:12,619 --> 00:36:17,390
comes to downloading and executable or
downloading a religious document is this

452
00:36:17,390 --> 00:36:24,920
place URL house abuse eh if you really
want up to date they have malware that

453
00:36:24,920 --> 00:36:37,549
can be downloaded for anywhere that's
the place long ago senior security

454
00:36:37,549 --> 00:36:39,380
engineer from American transmission
company

455
00:36:39,380 --> 00:36:42,410
I'm also stands mentor and I've taught
classes here in Milwaukee and Chicago

456
00:36:42,410 --> 00:36:53,749
area and are there any questions
I've never done that totally yes sir my

457
00:36:53,749 --> 00:36:56,660
own network
I already mean my own corporate network

458
00:36:56,660 --> 00:37:05,779
or I have yeah I read somewhere to
myself I just let something flying like

459
00:37:05,779 --> 00:37:09,870
oh that's interesting I was typing
and that wire train was running off some

460
00:37:09,870 --> 00:37:12,390
Chinese of traffic oh this is
interesting right

461
00:37:12,390 --> 00:37:16,109
yeah I swear myself that that's why
we're going to be answered

462
00:37:16,110 --> 00:37:22,830
that's why you work out of the empty
anything else otherwise thank you thank

463
00:37:22,830 --> 00:37:25,340
you very much

464
00:38:18,720 --> 00:38:20,810
you

