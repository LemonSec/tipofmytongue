1
00:00:03,660 --> 00:00:08,980
I'd like to dedicate this to my family

2
00:00:05,710 --> 00:00:11,200
they mean everything to me okay this has

3
00:00:08,980 --> 00:00:13,059
started happening YouTube have taken it

4
00:00:11,200 --> 00:00:15,219
upon themselves to start taking down

5
00:00:13,059 --> 00:00:17,470
videos that we make apparently we're

6
00:00:15,219 --> 00:00:20,290
criminals and our videos shouldn't be

7
00:00:17,470 --> 00:00:23,650
out there that is what we are listed

8
00:00:20,290 --> 00:00:26,919
under and as the official what they're

9
00:00:23,650 --> 00:00:28,090
saying about our videos some of the

10
00:00:26,920 --> 00:00:30,100
picketers people I follow on Twitter

11
00:00:28,090 --> 00:00:32,439
they've been saying things like this and

12
00:00:30,100 --> 00:00:33,579
I fully support this I feel like we need

13
00:00:32,439 --> 00:00:36,910
to stand up on this one

14
00:00:33,579 --> 00:00:38,440
and this is a very very good point

15
00:00:36,910 --> 00:00:41,678
or where they're gonna go to if they

16
00:00:38,440 --> 00:00:43,959
can't go to YouTube I'd like to say that

17
00:00:41,679 --> 00:00:47,739
I left school with nothing and I no

18
00:00:43,960 --> 00:00:50,379
money for education and I was a bomb I

19
00:00:47,739 --> 00:00:53,769
can't say that word and I was always I

20
00:00:50,379 --> 00:00:56,440
had no job for years and I eventually

21
00:00:53,769 --> 00:00:59,019
got into IT through a YouTube videos and

22
00:00:56,440 --> 00:01:01,329
it got me to be a network engineer it

23
00:00:59,019 --> 00:01:03,010
got me to be a security engineer got me

24
00:01:01,329 --> 00:01:05,969
to be a pen tester comments passed pen

25
00:01:03,010 --> 00:01:09,219
testing exams and without YouTube I

26
00:01:05,969 --> 00:01:10,539
won't be here today talking to you and I

27
00:01:09,219 --> 00:01:11,770
feel quite passionate about this that

28
00:01:10,540 --> 00:01:14,950
our video shouldn't be blocked it

29
00:01:11,770 --> 00:01:16,449
shouldn't be banned and that's that's

30
00:01:14,950 --> 00:01:18,939
all they have to really say on this I

31
00:01:16,450 --> 00:01:22,180
did say recently on Twitter that I'll

32
00:01:18,939 --> 00:01:25,829
talk about this and that's what I

33
00:01:22,180 --> 00:01:25,829
believe we shouldn't be censored

34
00:01:49,270 --> 00:02:03,220
okay December the 17th 2015

35
00:01:52,750 --> 00:02:03,220
Ukraine 22 225,000 lights went out

36
00:02:04,120 --> 00:02:07,799
dragonfly 2

37
00:02:05,460 --> 00:02:11,430
one-zero were held accountable for this

38
00:02:07,799 --> 00:02:14,600
hack also known as berserk bear no

39
00:02:11,430 --> 00:02:17,130
suspected Russian group they attack

40
00:02:14,600 --> 00:02:20,090
Europe but they particularly loved the

41
00:02:17,130 --> 00:02:23,040
USA they go for critical infrastructure

42
00:02:20,090 --> 00:02:24,950
this was a piece from the New York Times

43
00:02:23,040 --> 00:02:27,450
from the FBI and homeland security

44
00:02:24,950 --> 00:02:30,060
talking about them hacking dragonfly

45
00:02:27,450 --> 00:02:34,410
hacking power stations in the United

46
00:02:30,060 --> 00:02:36,209
States and this caught my eye I'm always

47
00:02:34,410 --> 00:02:38,730
interested in the word word document

48
00:02:36,209 --> 00:02:42,900
malicious code clicked and steal their

49
00:02:38,730 --> 00:02:47,790
credentials that in particular caught my

50
00:02:42,900 --> 00:02:49,380
attention okay dragonfly 2.0 are famous

51
00:02:47,790 --> 00:02:50,910
for using spear fishing techniques I

52
00:02:49,380 --> 00:02:53,730
know what you're gonna say I've

53
00:02:50,910 --> 00:02:56,910
birthdays loads and it's boring so why

54
00:02:53,730 --> 00:02:58,920
bother well this is the reason they

55
00:02:56,910 --> 00:03:00,209
steal credentials now normally we don't

56
00:02:58,920 --> 00:03:02,040
hear about people stealing Prudential

57
00:03:00,209 --> 00:03:03,330
especially apt groups we're here about

58
00:03:02,040 --> 00:03:05,280
and getting remote shells getting remote

59
00:03:03,330 --> 00:03:06,540
access so I started to read a little bit

60
00:03:05,280 --> 00:03:09,630
more into this I was interested so I

61
00:03:06,540 --> 00:03:11,340
went to the mr. miter website which can

62
00:03:09,630 --> 00:03:13,560
lose hours and hours and hours reading

63
00:03:11,340 --> 00:03:15,209
about threat groups really recommends

64
00:03:13,560 --> 00:03:17,040
people have a look but what interested

65
00:03:15,209 --> 00:03:20,970
me was I drilled down and hook to the

66
00:03:17,040 --> 00:03:23,970
groups who use SM big exploitation and I

67
00:03:20,970 --> 00:03:25,320
absolutely love SMB if anyone's been to

68
00:03:23,970 --> 00:03:27,150
him I talk to the poor you'd know that I

69
00:03:25,320 --> 00:03:30,690
took a lot about s don't bait so what

70
00:03:27,150 --> 00:03:34,320
can you do with the SMB here's my first

71
00:03:30,690 --> 00:03:36,660
video so we have a legitimate knowledge

72
00:03:34,320 --> 00:03:39,540
intimate but someone's going to an

73
00:03:36,660 --> 00:03:41,850
internet site and over here we have the

74
00:03:39,540 --> 00:03:43,530
threat actors machine where they control

75
00:03:41,850 --> 00:03:45,570
the they control the index file to the

76
00:03:43,530 --> 00:03:48,480
website they drop an SMB request into

77
00:03:45,570 --> 00:03:51,030
the index file and we go back to the

78
00:03:48,480 --> 00:03:52,709
target and they refresh their browser

79
00:03:51,030 --> 00:03:54,209
and just from looking at a site to

80
00:03:52,709 --> 00:03:55,680
listen be requesting using Internet

81
00:03:54,209 --> 00:03:58,200
Explorer and week outbound firewall

82
00:03:55,680 --> 00:03:59,790
rules or or fall by request you sent

83
00:03:58,200 --> 00:04:01,530
back to the attackers machine the

84
00:03:59,790 --> 00:04:03,870
attacks machine has responder going and

85
00:04:01,530 --> 00:04:06,000
they manage to collect the username the

86
00:04:03,870 --> 00:04:07,620
domain name and the password hash we can

87
00:04:06,000 --> 00:04:09,359
cut crack we can reverse that password

88
00:04:07,620 --> 00:04:10,560
hash I'll check it for loads and loads

89
00:04:09,359 --> 00:04:12,209
and loads about this you've got a good

90
00:04:10,560 --> 00:04:13,620
dictionary you can generally do it if

91
00:04:12,209 --> 00:04:15,269
you have loads of money you can buy lots

92
00:04:13,620 --> 00:04:18,480
of graphic cards you can definitely do

93
00:04:15,269 --> 00:04:19,200
it but not interested that is the what

94
00:04:18,480 --> 00:04:20,430
the SMB

95
00:04:19,200 --> 00:04:22,140
Qwest is an image tag that is placed

96
00:04:20,430 --> 00:04:24,510
into an index file so it's literally

97
00:04:22,140 --> 00:04:25,919
just an SMB request and when you browse

98
00:04:24,510 --> 00:04:27,330
to it job if you're ia will

99
00:04:25,920 --> 00:04:28,680
automatically make that request will

100
00:04:27,330 --> 00:04:30,300
trigger this does not work with Chrome

101
00:04:28,680 --> 00:04:32,070
anymore it used to people said didn't

102
00:04:30,300 --> 00:04:32,730
work the crime for years it did work

103
00:04:32,070 --> 00:04:35,790
with chrome

104
00:04:32,730 --> 00:04:37,860
not crime sorry edge edge I grew into

105
00:04:35,790 --> 00:04:39,450
the bit that Microsoft edge it does no

106
00:04:37,860 --> 00:04:42,900
longer work edge because they've made

107
00:04:39,450 --> 00:04:46,050
edge basically chrome so what use are

108
00:04:42,900 --> 00:04:47,969
credentials well I've spoken a lot about

109
00:04:46,050 --> 00:04:50,100
how if I get a remote access into it

110
00:04:47,970 --> 00:04:51,180
target I like to have credentials so I

111
00:04:50,100 --> 00:04:53,550
can then start to sniff around the

112
00:04:51,180 --> 00:04:55,380
network and it starts proof vest but

113
00:04:53,550 --> 00:04:58,650
what's interesting was about two three

114
00:04:55,380 --> 00:05:01,320
years ago since post released at all

115
00:04:58,650 --> 00:05:04,590
called ruler and what rule allows us to

116
00:05:01,320 --> 00:05:07,469
do if you're using waa Microsoft's web

117
00:05:04,590 --> 00:05:09,210
email solution and you have credentials

118
00:05:07,470 --> 00:05:10,680
you can then generally they don't have

119
00:05:09,210 --> 00:05:12,780
multi-factor authentication you can log

120
00:05:10,680 --> 00:05:14,040
in and read a targets emails which is

121
00:05:12,780 --> 00:05:15,359
great because attackers don't want to

122
00:05:14,040 --> 00:05:16,410
become domain admin they don't want

123
00:05:15,360 --> 00:05:19,050
things like they want to get people's

124
00:05:16,410 --> 00:05:20,400
data if you have office 365 you can also

125
00:05:19,050 --> 00:05:22,590
get hold up their Word documents their

126
00:05:20,400 --> 00:05:24,030
Excel documents SharePoint you get

127
00:05:22,590 --> 00:05:25,560
access to everything can read about an

128
00:05:24,030 --> 00:05:26,789
organization you have hundreds an

129
00:05:25,560 --> 00:05:28,290
compromised and just from student

130
00:05:26,790 --> 00:05:30,540
credentials below but what rule is

131
00:05:28,290 --> 00:05:35,520
really interesting is ruler allowed you

132
00:05:30,540 --> 00:05:38,220
to voya OWA create and upload a reverse

133
00:05:35,520 --> 00:05:40,260
shell to the targets machine for the

134
00:05:38,220 --> 00:05:42,360
credential view oh and trigger it on

135
00:05:40,260 --> 00:05:44,430
command so you can trigger that shell

136
00:05:42,360 --> 00:05:47,130
anytime you like so just with

137
00:05:44,430 --> 00:05:48,510
credentials lo you are now capable of

138
00:05:47,130 --> 00:05:51,090
getting actually a reverse shell as well

139
00:05:48,510 --> 00:05:52,830
under the right circumstances also there

140
00:05:51,090 --> 00:05:54,359
is you could use SSL VPN and other

141
00:05:52,830 --> 00:05:55,590
solutions like Citrix to get accessing

142
00:05:54,360 --> 00:05:57,840
the credential secure angels are very

143
00:05:55,590 --> 00:05:59,520
important now what's interesting is apt

144
00:05:57,840 --> 00:06:01,560
groups are starting to get used to this

145
00:05:59,520 --> 00:06:05,070
and starting to sort hear about it and

146
00:06:01,560 --> 00:06:06,840
start to use it so apt 34:33 have been

147
00:06:05,070 --> 00:06:09,990
heard to be using Haller and student

148
00:06:06,840 --> 00:06:12,840
credentials so 2019 and we're still

149
00:06:09,990 --> 00:06:14,120
honing with just SMB alone which is not

150
00:06:12,840 --> 00:06:17,070
something I thought I would be saying

151
00:06:14,120 --> 00:06:18,630
now this brings me to this point people

152
00:06:17,070 --> 00:06:20,370
are always saying especially red teaming

153
00:06:18,630 --> 00:06:22,560
I do a lot of red teaming and people

154
00:06:20,370 --> 00:06:25,850
will always say well targets are really

155
00:06:22,560 --> 00:06:28,650
mature so let's have a think about this

156
00:06:25,850 --> 00:06:30,840
business is to ask for red teens yes

157
00:06:28,650 --> 00:06:33,150
they are generally financial

158
00:06:30,840 --> 00:06:34,859
organizations or

159
00:06:33,150 --> 00:06:37,169
large large retailers people who make

160
00:06:34,860 --> 00:06:38,970
bust amounts of money they have the

161
00:06:37,170 --> 00:06:40,830
greatest the best the best toys in the

162
00:06:38,970 --> 00:06:42,420
world they secure themselves they buy

163
00:06:40,830 --> 00:06:44,310
the tin that helps them to be secure

164
00:06:42,420 --> 00:06:46,380
they want to know that it's working

165
00:06:44,310 --> 00:06:49,170
they have testing after testing after

166
00:06:46,380 --> 00:06:52,830
testing so in essence the people we

167
00:06:49,170 --> 00:06:55,620
target are mature and we will come in we

168
00:06:52,830 --> 00:06:57,539
might gain access and we'll tell them

169
00:06:55,620 --> 00:06:58,980
how to fix it and then we'll go back the

170
00:06:57,540 --> 00:07:00,720
next year and retest them and surprise

171
00:06:58,980 --> 00:07:02,820
surprise what we previously used the ER

172
00:07:00,720 --> 00:07:05,820
before hopefully no longer works again

173
00:07:02,820 --> 00:07:07,590
so yes our targets are mature and then

174
00:07:05,820 --> 00:07:10,050
we have sea bass now see best is top of

175
00:07:07,590 --> 00:07:12,810
the tree in the UK it was set up by the

176
00:07:10,050 --> 00:07:15,420
Bank of England and crest and it allow

177
00:07:12,810 --> 00:07:17,580
it's only for UK banks and it allows

178
00:07:15,420 --> 00:07:19,860
them to verify after the sea based test

179
00:07:17,580 --> 00:07:21,359
that they are up to see best standards

180
00:07:19,860 --> 00:07:23,160
they are the most secure of the secured

181
00:07:21,360 --> 00:07:25,140
now these are against the most mature

182
00:07:23,160 --> 00:07:28,110
targets in the UK you've ever come

183
00:07:25,140 --> 00:07:30,120
across so you would quite expect that

184
00:07:28,110 --> 00:07:30,750
SNP exploitation wouldn't work against

185
00:07:30,120 --> 00:07:32,940
these people

186
00:07:30,750 --> 00:07:35,520
typical PowerShell exploitation wouldn't

187
00:07:32,940 --> 00:07:40,250
work against these people so yes they're

188
00:07:35,520 --> 00:07:40,250
really really really really mature so

189
00:07:40,760 --> 00:07:47,190
this though is the reality so the people

190
00:07:45,120 --> 00:07:49,710
that we targets are incredibly mature

191
00:07:47,190 --> 00:07:52,350
but this was released about three or

192
00:07:49,710 --> 00:07:55,229
four months ago and if you look at 2010

193
00:07:52,350 --> 00:07:56,220
to 2050 - that humongous explosion and

194
00:07:55,230 --> 00:07:57,540
these are some of the largest

195
00:07:56,220 --> 00:07:58,260
organizations in the world are

196
00:07:57,540 --> 00:08:00,570
compromised

197
00:07:58,260 --> 00:08:03,030
- that explosion that if you actually

198
00:08:00,570 --> 00:08:04,950
got from 2015 to 2019 I would say is

199
00:08:03,030 --> 00:08:06,299
actually increasing is getting more so

200
00:08:04,950 --> 00:08:07,920
there's more and more compromises and

201
00:08:06,300 --> 00:08:09,270
even if you turn around side there isn't

202
00:08:07,920 --> 00:08:10,710
because that's a massive explosion we

203
00:08:09,270 --> 00:08:12,510
haven't gotten this clear what you have

204
00:08:10,710 --> 00:08:14,039
got you've got a continuing trend of the

205
00:08:12,510 --> 00:08:15,480
largest organizations out there being

206
00:08:14,040 --> 00:08:18,390
compromised and compromised and

207
00:08:15,480 --> 00:08:20,010
compromised so in all honesty I think

208
00:08:18,390 --> 00:08:22,940
it's fair to say that while at the our

209
00:08:20,010 --> 00:08:26,730
targets are mature the real bold is not

210
00:08:22,940 --> 00:08:35,960
now for your amusement I will give you a

211
00:08:26,730 --> 00:08:39,430
live red team boom right so lead

212
00:08:35,960 --> 00:08:42,649
to a red team as a red team operative

213
00:08:39,429 --> 00:08:43,880
engineer it's quite nerve-wracking

214
00:08:42,649 --> 00:08:46,940
it says nerve-wracking is giving a talk

215
00:08:43,880 --> 00:08:48,680
you have this expectancy placed upon you

216
00:08:46,940 --> 00:08:51,410
that you will compromise the target you

217
00:08:48,680 --> 00:08:52,880
will get access in leading up to it you

218
00:08:51,410 --> 00:08:54,949
will start to have a look at the

219
00:08:52,880 --> 00:08:57,320
organization you're targeting you might

220
00:08:54,950 --> 00:08:59,300
start to have LinkedIn profiles where

221
00:08:57,320 --> 00:09:02,270
you might start to make connections and

222
00:08:59,300 --> 00:09:04,790
communicate with people you might start

223
00:09:02,270 --> 00:09:05,899
to connect a lot of the business you

224
00:09:04,790 --> 00:09:07,640
also start to think about what

225
00:09:05,899 --> 00:09:08,690
infrastructure to use now when it

226
00:09:07,640 --> 00:09:10,580
actually comes to the first day of

227
00:09:08,690 --> 00:09:12,290
testing what not it is the first day of

228
00:09:10,580 --> 00:09:13,940
the official test you build your

229
00:09:12,290 --> 00:09:16,579
infrastructure and you do reconnaissance

230
00:09:13,940 --> 00:09:17,720
so the reconnaissance period is when

231
00:09:16,580 --> 00:09:19,070
we're looking at who we're going to

232
00:09:17,720 --> 00:09:21,529
target and what we're going to target

233
00:09:19,070 --> 00:09:22,910
now at this point you'll start to come

234
00:09:21,529 --> 00:09:24,500
up with your scenarios your scenarios

235
00:09:22,910 --> 00:09:27,730
are your campaigns that you're going to

236
00:09:24,500 --> 00:09:30,140
target against your target and

237
00:09:27,730 --> 00:09:32,660
infrastructure builds as well is

238
00:09:30,140 --> 00:09:35,330
incredibly stressful and we spend a

239
00:09:32,660 --> 00:09:37,630
large proportion of our time maybe once

240
00:09:35,330 --> 00:09:40,130
a three to five days at this stage

241
00:09:37,630 --> 00:09:41,839
preparing so once the campaign is

242
00:09:40,130 --> 00:09:44,360
actually about to go we will generally

243
00:09:41,839 --> 00:09:46,640
start with a phishing campaign because

244
00:09:44,360 --> 00:09:48,290
the reality is while it's a red team and

245
00:09:46,640 --> 00:09:50,209
we can do anything we like against the

246
00:09:48,290 --> 00:09:53,000
target if we have to use other

247
00:09:50,209 --> 00:09:55,130
alternative methods like Twitter or

248
00:09:53,000 --> 00:09:56,600
LinkedIn to communicate with people it's

249
00:09:55,130 --> 00:09:58,279
absolutely fantastic sand starts build

250
00:09:56,600 --> 00:09:59,959
up a rapport with a target but the

251
00:09:58,279 --> 00:10:01,670
reality is if you were to send to them a

252
00:09:59,959 --> 00:10:03,260
weaponized document via one of these

253
00:10:01,670 --> 00:10:04,550
mediums there's an incredible chance

254
00:10:03,260 --> 00:10:06,470
they're gonna open on the mobile phone

255
00:10:04,550 --> 00:10:07,790
and it's of no use to you or they're

256
00:10:06,470 --> 00:10:09,860
going to open it on their own computer

257
00:10:07,790 --> 00:10:11,810
at home again it's of no use to but

258
00:10:09,860 --> 00:10:13,580
secondly it's out of scope so the

259
00:10:11,810 --> 00:10:16,400
reality is we generally have to just

260
00:10:13,580 --> 00:10:18,380
target them for phishing email now in

261
00:10:16,400 --> 00:10:20,029
the real world an apt group wouldn't do

262
00:10:18,380 --> 00:10:22,820
that though do absolutely anything they

263
00:10:20,029 --> 00:10:24,500
possibly can so here we go we're about

264
00:10:22,820 --> 00:10:28,940
sending our phishing email you have the

265
00:10:24,500 --> 00:10:31,040
red team and who have Blanco so we're

266
00:10:28,940 --> 00:10:33,100
literally at that point now at the point

267
00:10:31,040 --> 00:10:35,899
of sending a phishing email which you

268
00:10:33,100 --> 00:10:38,180
carefully craft to either look like a

269
00:10:35,899 --> 00:10:39,680
spoofing internal email or alternative

270
00:10:38,180 --> 00:10:40,910
to not like the recruitment drive or

271
00:10:39,680 --> 00:10:43,250
something like that that you feel the

272
00:10:40,910 --> 00:10:45,079
person might click on i'm always quite

273
00:10:43,250 --> 00:10:46,100
nervous it's a buzz but it's also quite

274
00:10:45,079 --> 00:10:47,449
nerve-wracking because there's a lot of

275
00:10:46,100 --> 00:10:48,750
expectation that you're going to do well

276
00:10:47,450 --> 00:10:51,090
but let's have a look at what

277
00:10:48,750 --> 00:10:53,540
so boom we send our first phishing email

278
00:10:51,090 --> 00:10:55,920
in and the target takes it on the chin

279
00:10:53,540 --> 00:10:58,170
they're a little bit shocked and a

280
00:10:55,920 --> 00:11:00,420
little bit surprised but they come back

281
00:10:58,170 --> 00:11:01,890
so what do we do we up the game we make

282
00:11:00,420 --> 00:11:04,349
a better phishing email we make

283
00:11:01,890 --> 00:11:05,819
something that looks more enticing or we

284
00:11:04,350 --> 00:11:07,830
try a slightly different target in the

285
00:11:05,820 --> 00:11:10,500
organization we send another email in

286
00:11:07,830 --> 00:11:12,000
boom they accept it they have downloaded

287
00:11:10,500 --> 00:11:13,350
the document we no longer put

288
00:11:12,000 --> 00:11:16,080
attachments in emails

289
00:11:13,350 --> 00:11:18,150
there's no point email gateway solutions

290
00:11:16,080 --> 00:11:19,890
like mine cast will just block them so

291
00:11:18,150 --> 00:11:21,180
what we do is we put a hyperlink into an

292
00:11:19,890 --> 00:11:22,860
email and we allow that person to

293
00:11:21,180 --> 00:11:25,020
download it themselves generally

294
00:11:22,860 --> 00:11:26,280
bypassing the email solution the email

295
00:11:25,020 --> 00:11:28,290
solutions are getting smart to this

296
00:11:26,280 --> 00:11:30,000
though but it is a general technique

297
00:11:28,290 --> 00:11:31,829
that we use so they've downloaded the

298
00:11:30,000 --> 00:11:33,510
word document they've opened it we put a

299
00:11:31,830 --> 00:11:36,150
massive banner on it saying you need to

300
00:11:33,510 --> 00:11:39,689
enable this macro to access your

301
00:11:36,150 --> 00:11:41,400
documents they open it boom there you go

302
00:11:39,690 --> 00:11:43,350
we are now got a remote connection to

303
00:11:41,400 --> 00:11:44,220
them and on the internal network the

304
00:11:43,350 --> 00:11:46,230
first thing we have done is we're

305
00:11:44,220 --> 00:11:47,970
looking at ways to prove esque generally

306
00:11:46,230 --> 00:11:49,470
you will look at the user credentials

307
00:11:47,970 --> 00:11:50,970
that you've stole them with the remote

308
00:11:49,470 --> 00:11:52,680
access and see if you can use those

309
00:11:50,970 --> 00:11:54,360
anyone the internal network as it

310
00:11:52,680 --> 00:11:55,829
happens on this circumstance we have

311
00:11:54,360 --> 00:11:57,780
managed to identify a place where that

312
00:11:55,830 --> 00:11:59,100
user has local administrative access on

313
00:11:57,780 --> 00:12:00,990
one of the machines on the internal

314
00:11:59,100 --> 00:12:02,310
network so we have used that to prove s

315
00:12:00,990 --> 00:12:04,290
we have a lateral move to that machine

316
00:12:02,310 --> 00:12:06,239
and we've gained access to it as a local

317
00:12:04,290 --> 00:12:07,740
administrator we are now in control of

318
00:12:06,240 --> 00:12:09,900
that machine and we can dump the hashes

319
00:12:07,740 --> 00:12:11,130
off that box windows I've said this over

320
00:12:09,900 --> 00:12:13,020
and over again in my talks but I'll say

321
00:12:11,130 --> 00:12:15,150
again people generally on an internal

322
00:12:13,020 --> 00:12:16,500
network will build one machine and then

323
00:12:15,150 --> 00:12:18,510
they'll clone it over and over and over

324
00:12:16,500 --> 00:12:21,089
and over again and what happen is that

325
00:12:18,510 --> 00:12:22,350
local password hash is Microsoft as an

326
00:12:21,089 --> 00:12:23,430
assault it will be the same on every

327
00:12:22,350 --> 00:12:25,350
individual box

328
00:12:23,430 --> 00:12:27,390
so once you've stolen it from one you

329
00:12:25,350 --> 00:12:29,220
can reuse it on all the other boxes and

330
00:12:27,390 --> 00:12:31,110
what makes it even sweeter is you don't

331
00:12:29,220 --> 00:12:33,600
need to even reverse the hash Microsoft

332
00:12:31,110 --> 00:12:34,740
will accept the pure hash so you can

333
00:12:33,600 --> 00:12:36,660
just pass that around the internal

334
00:12:34,740 --> 00:12:38,580
network and gain local administrative

335
00:12:36,660 --> 00:12:40,620
access to all the other machines at that

336
00:12:38,580 --> 00:12:42,210
point we're almost at the point of

337
00:12:40,620 --> 00:12:44,100
taking over completely what we are doing

338
00:12:42,210 --> 00:12:45,810
now is we're trying to hunt out a user

339
00:12:44,100 --> 00:12:47,760
or users who belong to the domain

340
00:12:45,810 --> 00:12:49,229
administrative group and the reason the

341
00:12:47,760 --> 00:12:51,750
DA and the reason why we want this

342
00:12:49,230 --> 00:12:53,339
because it will give us complete access

343
00:12:51,750 --> 00:12:55,440
to the entire network

344
00:12:53,339 --> 00:12:56,700
microsoft domain completely unrestricted

345
00:12:55,440 --> 00:12:58,110
access the Microsoft the main I

346
00:12:56,700 --> 00:12:59,520
apologize someone I'm a little bit rusty

347
00:12:58,110 --> 00:13:02,370
this is my first talk this year and it's

348
00:12:59,520 --> 00:13:04,110
the only talk I'm giving boom they

349
00:13:02,370 --> 00:13:05,279
go we've done it we've nice to following

350
00:13:04,110 --> 00:13:07,260
someone with the main administrative

351
00:13:05,279 --> 00:13:08,550
group someone belonging to the main

352
00:13:07,260 --> 00:13:10,290
administrative group they're probably

353
00:13:08,550 --> 00:13:11,819
sitting on a Microsoft Exchange box as

354
00:13:10,290 --> 00:13:13,110
they typically do and we've nice to

355
00:13:11,820 --> 00:13:15,360
capture them and compromise them it was

356
00:13:13,110 --> 00:13:17,070
a Windows Server 2008 box so we could

357
00:13:15,360 --> 00:13:18,800
use mimic ATS to reverse their passwords

358
00:13:17,070 --> 00:13:20,730
in clear-text and we've got their

359
00:13:18,800 --> 00:13:22,770
password we've got the username and

360
00:13:20,730 --> 00:13:25,140
we've got their password we are now a

361
00:13:22,770 --> 00:13:28,040
domain administrator on the group on the

362
00:13:25,140 --> 00:13:32,730
entire internal domain bank it is over

363
00:13:28,040 --> 00:13:35,189
you with our effect so we now have

364
00:13:32,730 --> 00:13:37,080
complete access to their domain and we

365
00:13:35,190 --> 00:13:39,029
can start to do what an attacker would

366
00:13:37,080 --> 00:13:41,670
possibly do and look for the sensitive

367
00:13:39,029 --> 00:13:43,650
data and we're you normally given a

368
00:13:41,670 --> 00:13:45,540
target or something to go for once

369
00:13:43,650 --> 00:13:47,850
you've got access in get access to a

370
00:13:45,540 --> 00:13:50,069
sequel database very or prove that you

371
00:13:47,850 --> 00:13:52,589
could access our sensitive documents now

372
00:13:50,070 --> 00:13:54,990
the reality is this early stage from

373
00:13:52,589 --> 00:13:59,010
getting access in can take anywhere from

374
00:13:54,990 --> 00:14:01,080
a week to two weeks the actual attack

375
00:13:59,010 --> 00:14:02,700
phase from sending the email though a

376
00:14:01,080 --> 00:14:04,589
large proportion by its reconnaissance

377
00:14:02,700 --> 00:14:07,709
and building your infrastructure the

378
00:14:04,589 --> 00:14:09,360
actual cellular phishing email in and

379
00:14:07,709 --> 00:14:11,939
becoming domain admin can sometimes be

380
00:14:09,360 --> 00:14:14,010
relatively short stem in 'its it's quite

381
00:14:11,940 --> 00:14:16,160
alarming but that's how it is so what

382
00:14:14,010 --> 00:14:18,420
would we learn so far apt groups

383
00:14:16,160 --> 00:14:21,360
particularly new crane turn lights off

384
00:14:18,420 --> 00:14:25,800
and they're dangerous and we've also

385
00:14:21,360 --> 00:14:26,970
learned a bit about red teaming okay if

386
00:14:25,800 --> 00:14:28,170
you're interested in stories of happy

387
00:14:26,970 --> 00:14:29,940
endings can be better off hearing

388
00:14:28,170 --> 00:14:31,589
another talk there are no happy

389
00:14:29,940 --> 00:14:33,990
beginnings and very few happy things in

390
00:14:31,589 --> 00:14:38,820
the middle same one I'm not going to

391
00:14:33,990 --> 00:14:40,620
read that out so we're talking remote

392
00:14:38,820 --> 00:14:42,690
shells of course mail I love remote

393
00:14:40,620 --> 00:14:44,040
access into place I'll attack of someone

394
00:14:42,690 --> 00:14:47,220
last night there's no one cares near

395
00:14:44,040 --> 00:14:48,630
about shells no one cares what years and

396
00:14:47,220 --> 00:14:49,920
years ago I'm going up track of it yes

397
00:14:48,630 --> 00:14:51,779
yes years ago when I wanted to first

398
00:14:49,920 --> 00:14:53,010
talk I was asked what do I want to talk

399
00:14:51,779 --> 00:14:54,779
about I said I want talk about SMB

400
00:14:53,010 --> 00:14:56,370
exploitation remote access polling

401
00:14:54,779 --> 00:14:58,080
things getting into things exciting

402
00:14:56,370 --> 00:15:00,420
stuff stuff that I want to hear about

403
00:14:58,080 --> 00:15:02,490
now no one wants to hear that Neil well

404
00:15:00,420 --> 00:15:03,959
four ideas later I'm still Aaron I'm

405
00:15:02,490 --> 00:15:07,529
talking to people so hopefully people do

406
00:15:03,959 --> 00:15:10,140
want to hear it right quick update right

407
00:15:07,529 --> 00:15:13,380
advanced adversary's an advanced

408
00:15:10,140 --> 00:15:14,939
assistant Brett apt is a targeted cyber

409
00:15:13,380 --> 00:15:16,380
attack in which an intruder gains access

410
00:15:14,940 --> 00:15:19,529
to a network

411
00:15:16,380 --> 00:15:21,180
fancy bear and here we have a very cool

412
00:15:19,529 --> 00:15:23,459
petite image that you'll be able to get

413
00:15:21,180 --> 00:15:25,769
off the internet about an apt group now

414
00:15:23,459 --> 00:15:27,599
I don't like these diagrams and I don't

415
00:15:25,769 --> 00:15:30,029
generally understand him I do this is a

416
00:15:27,600 --> 00:15:32,640
job and I don't fully get these but

417
00:15:30,029 --> 00:15:34,709
that's maybe just me but in reality I

418
00:15:32,640 --> 00:15:37,500
get that bit they use PowerShell but

419
00:15:34,709 --> 00:15:39,660
apparently they somehow send an arrow to

420
00:15:37,500 --> 00:15:41,550
a machine and then from that machine

421
00:15:39,660 --> 00:15:45,149
there's some how do PowerShell and you

422
00:15:41,550 --> 00:15:47,010
get targeted systems right so as red

423
00:15:45,149 --> 00:15:49,230
teamers or security professionals what

424
00:15:47,010 --> 00:15:51,029
do we need to do well we need to

425
00:15:49,230 --> 00:15:52,829
replicate we need to replicate the bad

426
00:15:51,029 --> 00:15:55,050
people now this is something that I

427
00:15:52,829 --> 00:15:56,670
sometimes puzzle where are we

428
00:15:55,050 --> 00:15:59,579
replicating them or are they replicating

429
00:15:56,670 --> 00:16:01,439
us because what you find is people the

430
00:15:59,579 --> 00:16:03,269
industry will release tools we will use

431
00:16:01,440 --> 00:16:04,829
some got that's amazing we will create

432
00:16:03,269 --> 00:16:06,450
videos we'll talk about our conferences

433
00:16:04,829 --> 00:16:08,969
next thing you know apt groups are using

434
00:16:06,450 --> 00:16:12,060
them it also brings another question all

435
00:16:08,970 --> 00:16:13,829
your here in security or in my world all

436
00:16:12,060 --> 00:16:15,300
I said here is a PT's and best and the

437
00:16:13,829 --> 00:16:16,949
best they're the top of the top of the

438
00:16:15,300 --> 00:16:18,390
most scariest these are the proper

439
00:16:16,950 --> 00:16:20,640
criminals the people who really do it

440
00:16:18,390 --> 00:16:21,839
they are so advanced you need to be

441
00:16:20,640 --> 00:16:23,220
scared to sleep because they're gonna

442
00:16:21,839 --> 00:16:25,260
pone you just mention you their names

443
00:16:23,220 --> 00:16:27,660
but the reality is they seem to copy

444
00:16:25,260 --> 00:16:30,390
stuff that we've done or been using for

445
00:16:27,660 --> 00:16:32,540
two or three years so I don't know okay

446
00:16:30,390 --> 00:16:33,839
this is getting a bit too high level

447
00:16:32,540 --> 00:16:37,980
okay

448
00:16:33,839 --> 00:16:40,110
the unicorns talk to me so Matthew

449
00:16:37,980 --> 00:16:42,230
grubber so I want to shout out his name

450
00:16:40,110 --> 00:16:46,350
very lightly pronounced incorrectly

451
00:16:42,230 --> 00:16:49,110
released a way of making powershell

452
00:16:46,350 --> 00:16:51,779
one-liner to bypass antivirus and gain

453
00:16:49,110 --> 00:16:54,570
access to machines now the reason why

454
00:16:51,779 --> 00:16:56,220
this was fantastic it was about we got

455
00:16:54,570 --> 00:16:57,750
date on here we're talking three or four

456
00:16:56,220 --> 00:16:59,399
years ago alright no spoke about six six

457
00:16:57,750 --> 00:17:01,170
seven years ago now and there is my life

458
00:16:59,399 --> 00:17:02,760
is amazing cuz at the time antivirus had

459
00:17:01,170 --> 00:17:05,309
no way of looking at memory

460
00:17:02,760 --> 00:17:08,250
surround it had no way at all so if we

461
00:17:05,309 --> 00:17:10,379
could run all of our codes in RAM we

462
00:17:08,250 --> 00:17:12,660
could do absolutely anything we like and

463
00:17:10,380 --> 00:17:16,380
we did four years it was amazing

464
00:17:12,660 --> 00:17:19,079
now that has come to an end but his

465
00:17:16,380 --> 00:17:22,169
discovery was converted into a tool

466
00:17:19,079 --> 00:17:24,720
called unicorn by David Kennedy and Josh

467
00:17:22,169 --> 00:17:25,890
Kelley of trusted SEC and it's an you

468
00:17:24,720 --> 00:17:28,890
can download have a look at it if you

469
00:17:25,890 --> 00:17:30,130
want I love it it's an amazing tool so

470
00:17:28,890 --> 00:17:32,230
generating the unicorn

471
00:17:30,130 --> 00:17:33,370
loads because I like to do videos so

472
00:17:32,230 --> 00:17:36,610
let's have a look this is exactly how

473
00:17:33,370 --> 00:17:38,979
you generate a unicorn payload so you go

474
00:17:36,610 --> 00:17:40,959
to the github for their site and you

475
00:17:38,980 --> 00:17:44,860
download it and to move it to the

476
00:17:40,960 --> 00:17:46,680
directory and you simply run it to start

477
00:17:44,860 --> 00:17:49,510
with and it gives you all the examples

478
00:17:46,680 --> 00:17:51,460
now you can use cobalt strike payloads

479
00:17:49,510 --> 00:17:56,620
of it now and you can make Metasploit

480
00:17:51,460 --> 00:17:58,480
MSF payloads and if anyone took those

481
00:17:56,620 --> 00:18:01,090
laters might say I don't use MSF

482
00:17:58,480 --> 00:18:03,100
directly on the red team but I won't lie

483
00:18:01,090 --> 00:18:04,720
to people ideals do still use it once

484
00:18:03,100 --> 00:18:06,879
I've got access I might pivot and use it

485
00:18:04,720 --> 00:18:08,230
but right so to create a payload we do

486
00:18:06,880 --> 00:18:09,400
if you change your IP address you take

487
00:18:08,230 --> 00:18:12,700
the original copy you change your IP

488
00:18:09,400 --> 00:18:14,560
address and you just hit go and what it

489
00:18:12,700 --> 00:18:16,090
outputs is two files one of them is

490
00:18:14,560 --> 00:18:18,100
handler for Metasploit and the other one

491
00:18:16,090 --> 00:18:19,480
is your actual one-liner powershell now

492
00:18:18,100 --> 00:18:21,129
all you need to do is get that one line

493
00:18:19,480 --> 00:18:23,650
of powershell onto a box and I'll talk

494
00:18:21,130 --> 00:18:25,510
about that in a minute but here we go so

495
00:18:23,650 --> 00:18:27,670
it's the PowerShell attack and the

496
00:18:25,510 --> 00:18:29,560
unicorn RC file the unicorn RC is the

497
00:18:27,670 --> 00:18:30,850
Metasploit Handler and i'll explain that

498
00:18:29,560 --> 00:18:34,270
in a minute and there you go that's the

499
00:18:30,850 --> 00:18:37,840
one line up so we copy that and all you

500
00:18:34,270 --> 00:18:41,020
do is start Metasploit and you reference

501
00:18:37,840 --> 00:18:42,399
the handler file which unicorn created

502
00:18:41,020 --> 00:18:52,780
and it will automatically load your

503
00:18:42,400 --> 00:18:54,490
handler for you right I'll now move over

504
00:18:52,780 --> 00:18:56,800
to target machine I never like using the

505
00:18:54,490 --> 00:18:58,390
term victim I just personally think it's

506
00:18:56,800 --> 00:19:00,520
a bit disrespectful they're a target

507
00:18:58,390 --> 00:19:02,740
they're not a big two so we're on the

508
00:19:00,520 --> 00:19:04,560
target machine and I'll start at

509
00:19:02,740 --> 00:19:08,500
PowerShell just for the demonstration

510
00:19:04,560 --> 00:19:10,330
and hit enter now that has taken the

511
00:19:08,500 --> 00:19:11,680
code and it will send a reverse

512
00:19:10,330 --> 00:19:14,050
connection back to my handler which will

513
00:19:11,680 --> 00:19:16,030
go let me you know control you and at

514
00:19:14,050 --> 00:19:17,620
that point we have our session so she'll

515
00:19:16,030 --> 00:19:19,690
one is open we can now remotely control

516
00:19:17,620 --> 00:19:21,250
that machine but how can you make this

517
00:19:19,690 --> 00:19:23,380
look better because your likelihood have

518
00:19:21,250 --> 00:19:25,090
been asked to email someone on one line

519
00:19:23,380 --> 00:19:28,000
at PowerShell and go please install this

520
00:19:25,090 --> 00:19:29,199
or run this it's quite slip so what we

521
00:19:28,000 --> 00:19:31,240
do is we have one of my youtube videos

522
00:19:29,200 --> 00:19:36,280
which are probable banned after this and

523
00:19:31,240 --> 00:19:36,790
we have a recruitment page now it all

524
00:19:36,280 --> 00:19:38,860
works

525
00:19:36,790 --> 00:19:40,629
it looks semi-legit you'd obviously have

526
00:19:38,860 --> 00:19:43,149
over HTTP normally what I have here an

527
00:19:40,630 --> 00:19:46,929
SMB listen up which is responder

528
00:19:43,149 --> 00:19:48,070
and I also have a Metasploit handler so

529
00:19:46,929 --> 00:19:50,080
we're going to the we're going to the

530
00:19:48,070 --> 00:19:53,168
index file of the webpage we're just

531
00:19:50,080 --> 00:19:54,339
browsing with ia and you see there we've

532
00:19:53,169 --> 00:19:55,659
snagged the credentials so I said

533
00:19:54,339 --> 00:19:57,070
responder a minute ago this was actually

534
00:19:55,659 --> 00:19:58,359
using the SMB listen are built into

535
00:19:57,070 --> 00:19:59,499
Metis below back then when I made this

536
00:19:58,359 --> 00:20:02,999
video I didn't make speedy a few years

537
00:19:59,499 --> 00:20:07,119
ago right so if you go to a page and

538
00:20:02,999 --> 00:20:08,739
you'll see what they see this that takes

539
00:20:07,119 --> 00:20:11,769
them to HTA which is one of the unicorn

540
00:20:08,739 --> 00:20:14,529
payloads and you make a bit of a page

541
00:20:11,769 --> 00:20:15,879
that says allow this run this and hope

542
00:20:14,529 --> 00:20:19,389
that they will trust it and they click

543
00:20:15,879 --> 00:20:20,859
it you don't need to click that at the

544
00:20:19,389 --> 00:20:22,718
bottom let's just buy a beam r8 and

545
00:20:20,859 --> 00:20:24,158
there you go you get Riddler session

546
00:20:22,719 --> 00:20:26,349
back to them so you can now control that

547
00:20:24,159 --> 00:20:28,299
machine remotely so we've got the hash

548
00:20:26,349 --> 00:20:31,229
and we've also got a remote connection

549
00:20:28,299 --> 00:20:33,399
in this is everything I love on a test

550
00:20:31,229 --> 00:20:37,659
now this is where our story changes a

551
00:20:33,399 --> 00:20:40,658
little okay I've always spoken about you

552
00:20:37,659 --> 00:20:44,080
and see you and see is the actual

553
00:20:40,659 --> 00:20:45,639
function when I talk about SMB Microsoft

554
00:20:44,080 --> 00:20:47,468
actually call it you and say so it's

555
00:20:45,639 --> 00:20:52,178
actually here in C exploitation you in C

556
00:20:47,469 --> 00:20:53,919
is the actual request for SMB and I

557
00:20:52,179 --> 00:20:55,450
mentioned responder in my talk earlier

558
00:20:53,919 --> 00:20:56,769
if anyone's interested in getting a copy

559
00:20:55,450 --> 00:20:58,690
of respond the respondent does exactly

560
00:20:56,769 --> 00:21:00,190
what it says it listens to a request and

561
00:20:58,690 --> 00:21:01,749
it responds to her and says send me your

562
00:21:00,190 --> 00:21:03,999
domain name your username and your

563
00:21:01,749 --> 00:21:06,999
password hash at that point the target

564
00:21:03,999 --> 00:21:08,710
does so how could we add you and say

565
00:21:06,999 --> 00:21:10,899
right I'm really really interested in

566
00:21:08,710 --> 00:21:13,149
adding smb2 things so what I wanted to

567
00:21:10,899 --> 00:21:14,918
do was have unicorn and a shell all at

568
00:21:13,149 --> 00:21:16,149
the same time I didn't want to have to

569
00:21:14,919 --> 00:21:17,559
do tricky things and getting to click

570
00:21:16,149 --> 00:21:19,928
here and do that and that way to just

571
00:21:17,559 --> 00:21:21,940
trigger a shell again you get an SMB

572
00:21:19,929 --> 00:21:23,589
request at the same time so here's an

573
00:21:21,940 --> 00:21:27,309
extract from the unicorn powershell

574
00:21:23,589 --> 00:21:28,899
one-liner so I did that so I've silence

575
00:21:27,309 --> 00:21:30,700
I was inspecting something I'll make it

576
00:21:28,899 --> 00:21:32,738
clear up so literally all I did was I

577
00:21:30,700 --> 00:21:34,929
dropped in cheeky SMB request right in

578
00:21:32,739 --> 00:21:37,719
the middle and here's a video of what

579
00:21:34,929 --> 00:21:40,450
you get so there I am just copying the

580
00:21:37,719 --> 00:21:49,809
SMB request and just pasting it in

581
00:21:40,450 --> 00:21:51,779
between also slow when you were doing at

582
00:21:49,809 --> 00:21:54,579
home always seems like a good idea

583
00:21:51,779 --> 00:21:55,749
so we paste this one arm on outside you

584
00:21:54,579 --> 00:21:56,950
start responder up and that's me how

585
00:21:55,749 --> 00:21:59,080
that's how you start responder up

586
00:21:56,950 --> 00:22:00,970
stun it and you post that daily got my

587
00:21:59,080 --> 00:22:12,610
handler going on Metasploit we now paste

588
00:22:00,970 --> 00:22:14,170
that into the target machine and there

589
00:22:12,610 --> 00:22:15,909
we go so you've got a session and we

590
00:22:14,170 --> 00:22:17,260
also got our hashes now that's something

591
00:22:15,910 --> 00:22:19,000
I really like to do I like to combine

592
00:22:17,260 --> 00:22:21,180
things so I like to make it just one

593
00:22:19,000 --> 00:22:23,610
click bang you've got multiple things

594
00:22:21,180 --> 00:22:25,870
winner winner chicken dinner

595
00:22:23,610 --> 00:22:28,179
writes now let's make this even better

596
00:22:25,870 --> 00:22:29,139
because I generally like to make things

597
00:22:28,180 --> 00:22:31,180
even better

598
00:22:29,140 --> 00:22:32,470
so now gateways are getting hard to

599
00:22:31,180 --> 00:22:34,450
bypass I mentioned that earlier

600
00:22:32,470 --> 00:22:35,740
now we typically place a dot in a

601
00:22:34,450 --> 00:22:37,720
hyperlinks you have something like this

602
00:22:35,740 --> 00:22:41,490
so instead of having the attachment you

603
00:22:37,720 --> 00:22:44,320
now have a link and they get this and

604
00:22:41,490 --> 00:22:45,390
hopefully they will trigger it so how

605
00:22:44,320 --> 00:22:48,070
can I make this better

606
00:22:45,390 --> 00:22:52,240
here you go send me your creds and your

607
00:22:48,070 --> 00:22:55,210
shell and one go so here I have an index

608
00:22:52,240 --> 00:22:57,160
file which in the web directory you also

609
00:22:55,210 --> 00:22:59,200
have an index file and the document you

610
00:22:57,160 --> 00:23:01,390
want to serve to them and then what you

611
00:22:59,200 --> 00:23:03,490
have you have the SMB request in the

612
00:23:01,390 --> 00:23:06,190
index and you also have an iframe which

613
00:23:03,490 --> 00:23:08,230
automatically serves that document when

614
00:23:06,190 --> 00:23:10,480
they browse it so when they go to that

615
00:23:08,230 --> 00:23:12,340
website they now get this the documents

616
00:23:10,480 --> 00:23:14,050
still automatically and we also get that

617
00:23:12,340 --> 00:23:16,030
so we get a remote connection and we get

618
00:23:14,050 --> 00:23:20,590
their stash their credentials whether

619
00:23:16,030 --> 00:23:23,290
they're hash as well okay some will be

620
00:23:20,590 --> 00:23:24,189
thinking most will be thinking I've done

621
00:23:23,290 --> 00:23:26,830
a lot of stop talking here about

622
00:23:24,190 --> 00:23:28,660
PowerShell and a lot of people are

623
00:23:26,830 --> 00:23:29,740
saying that PowerShell is dead just to

624
00:23:28,660 --> 00:23:31,300
prove that a lot of people saying

625
00:23:29,740 --> 00:23:31,690
PowerShell is dead here I was two years

626
00:23:31,300 --> 00:23:33,070
ago

627
00:23:31,690 --> 00:23:37,870
besides London telling everyone

628
00:23:33,070 --> 00:23:39,399
PowerShell is dead so why bother well

629
00:23:37,870 --> 00:23:41,469
it's a good question but this is the

630
00:23:39,400 --> 00:23:44,560
reason why 2019 I'm still talking about

631
00:23:41,470 --> 00:23:46,720
PowerShell and if anyone goes on Reddit

632
00:23:44,560 --> 00:23:49,090
and I discussed reddit last night I find

633
00:23:46,720 --> 00:23:52,690
reddit scary it's just the place you go

634
00:23:49,090 --> 00:23:54,760
to get abused but that aside it's good

635
00:23:52,690 --> 00:23:56,950
for red teaming tips and people are

636
00:23:54,760 --> 00:23:58,960
continuously talking about ways of

637
00:23:56,950 --> 00:24:00,850
bypassing the thing that now stops

638
00:23:58,960 --> 00:24:02,680
PowerShell stops us from running it and

639
00:24:00,850 --> 00:24:04,389
what that is is an additional layer that

640
00:24:02,680 --> 00:24:06,310
Microsoft came up with for defender and

641
00:24:04,390 --> 00:24:09,730
any other antivirus that wants to use it

642
00:24:06,310 --> 00:24:10,279
it's called AM C and AB C is it's the

643
00:24:09,730 --> 00:24:12,559
pain

644
00:24:10,279 --> 00:24:15,019
our lives in red teaming if anything is

645
00:24:12,559 --> 00:24:18,408
to stop us from having our fun in his MC

646
00:24:15,019 --> 00:24:20,779
so how it works is while we are running

647
00:24:18,409 --> 00:24:22,999
right through your memory of your

648
00:24:20,779 --> 00:24:24,679
computer's Microsoft was eventually like

649
00:24:22,999 --> 00:24:27,019
you know what we need to stop this when

650
00:24:24,679 --> 00:24:29,210
you can't scan memory on machine easily

651
00:24:27,019 --> 00:24:30,710
if you actually look at defender it

652
00:24:29,210 --> 00:24:32,389
generally when it's running it will use

653
00:24:30,710 --> 00:24:34,820
when it's scanning your machine up to

654
00:24:32,389 --> 00:24:36,379
50% if your CPU and it uses a lot of

655
00:24:34,820 --> 00:24:37,668
memory anyway so if you were then to

656
00:24:36,379 --> 00:24:39,408
tell that to scan your memory your

657
00:24:37,669 --> 00:24:40,460
machine will just hold and crash we

658
00:24:39,409 --> 00:24:42,409
weren't necessarily crash but it just

659
00:24:40,460 --> 00:24:43,759
hold up and it could hold up the period

660
00:24:42,409 --> 00:24:44,089
served about continuous while it was

661
00:24:43,759 --> 00:24:46,249
running

662
00:24:44,089 --> 00:24:47,869
so what they've come up with and I can't

663
00:24:46,249 --> 00:24:49,309
explain to you the innings in the outing

664
00:24:47,869 --> 00:24:52,189
working of answer I'm just not that

665
00:24:49,309 --> 00:24:53,928
smart but it bound away a in essence

666
00:24:52,190 --> 00:24:55,279
scanning memory and looking for certain

667
00:24:53,929 --> 00:24:57,710
malicious codes like PowerShell

668
00:24:55,279 --> 00:24:59,599
javascript red teamers are all moving

669
00:24:57,710 --> 00:25:00,950
over to c-sharp and I hate to be the

670
00:24:59,599 --> 00:25:03,320
first person to say it I don't have a

671
00:25:00,950 --> 00:25:05,299
slide yet saying C sharp is dead but

672
00:25:03,320 --> 00:25:07,729
there is rumors and people are saying

673
00:25:05,299 --> 00:25:12,649
answers can start spotting to c-sharp as

674
00:25:07,729 --> 00:25:15,139
well now that's bypass bypasses for MCA

675
00:25:12,649 --> 00:25:17,570
always worth noting are quite regular so

676
00:25:15,139 --> 00:25:18,859
like once a month sometimes even once a

677
00:25:17,570 --> 00:25:22,009
week someone will come with a new and

678
00:25:18,859 --> 00:25:23,418
great way to bypass answer and that one

679
00:25:22,009 --> 00:25:25,070
day which I'm mentioning is down to

680
00:25:23,419 --> 00:25:26,719
Mohammed Danish who came up with it and

681
00:25:25,070 --> 00:25:28,849
there's a screenshot of it and it's

682
00:25:26,719 --> 00:25:31,969
download cradle and it's just a way of

683
00:25:28,849 --> 00:25:33,559
downloading our simulated malware

684
00:25:31,969 --> 00:25:35,389
scripts and running them on a machine

685
00:25:33,559 --> 00:25:37,759
that it's running defender and antsy and

686
00:25:35,389 --> 00:25:39,859
at the period of that released it did

687
00:25:37,759 --> 00:25:42,019
work does it work anymore I don't know

688
00:25:39,859 --> 00:25:46,609
interest in a unicorn which can help you

689
00:25:42,019 --> 00:25:48,469
to bypass amp C and defender bypass a

690
00:25:46,609 --> 00:25:50,119
Samson defender with a new update and

691
00:25:48,469 --> 00:25:52,849
sometimes as little as two hours later

692
00:25:50,119 --> 00:25:54,709
it stops working because Microsoft is

693
00:25:52,849 --> 00:25:56,839
that quick now that's changing

694
00:25:54,710 --> 00:25:58,909
signatures right that is defender

695
00:25:56,839 --> 00:26:00,559
running in real time with amp site so

696
00:25:58,909 --> 00:26:02,239
when you go to your defender settings if

697
00:26:00,559 --> 00:26:03,349
you've got that on you have got MC and

698
00:26:02,239 --> 00:26:05,359
you're running it on the machine now

699
00:26:03,349 --> 00:26:08,809
let's have another reason why we can

700
00:26:05,359 --> 00:26:09,408
still use PowerShell 2019 that was not

701
00:26:08,809 --> 00:26:11,779
long ago

702
00:26:09,409 --> 00:26:14,149
that's wheat now clearly you can't run

703
00:26:11,779 --> 00:26:16,639
PowerShell on Windows NT but it proves a

704
00:26:14,149 --> 00:26:19,728
good point people do love to use legacy

705
00:26:16,639 --> 00:26:22,369
systems they don't change they do keep

706
00:26:19,729 --> 00:26:23,600
using old machines now we have this this

707
00:26:22,369 --> 00:26:26,840
made me laugh and

708
00:26:23,600 --> 00:26:29,330
this was not long ago so yes you can use

709
00:26:26,840 --> 00:26:31,220
Windows XP forever so let's look at how

710
00:26:29,330 --> 00:26:32,299
we can make this safe and I wanted to

711
00:26:31,220 --> 00:26:34,460
read this because he it wasn't music

712
00:26:32,299 --> 00:26:35,720
okay so you install the dedicated

713
00:26:34,460 --> 00:26:38,390
antivirus when you can't get the fender

714
00:26:35,720 --> 00:26:40,130
on it keep your software up to date okay

715
00:26:38,390 --> 00:26:42,860
stop using Internet Explorer that's a

716
00:26:40,130 --> 00:26:44,390
very good tip stop using Java good tip

717
00:26:42,860 --> 00:26:45,520
use a day-to-day account I don't

718
00:26:44,390 --> 00:26:47,630
actually know what that means

719
00:26:45,520 --> 00:26:48,889
do you create a domain I might be

720
00:26:47,630 --> 00:26:50,780
affected do you create a domain account

721
00:26:48,890 --> 00:26:52,250
every day for a user who wants to use

722
00:26:50,780 --> 00:26:55,370
Windows like just don't use Windows XP

723
00:26:52,250 --> 00:26:56,900
okay you use a virtual machine well yes

724
00:26:55,370 --> 00:26:58,399
for live environments definitely use a

725
00:26:56,900 --> 00:26:59,809
virtual machine if you're doing anything

726
00:26:58,400 --> 00:27:00,740
that you think is slightly suspicious or

727
00:26:59,809 --> 00:27:02,270
you're running anything slightly

728
00:27:00,740 --> 00:27:03,620
suspicious on it have no network

729
00:27:02,270 --> 00:27:06,559
connectivity to do that virtual machine

730
00:27:03,620 --> 00:27:08,658
it's not a bad tip choose wisely on what

731
00:27:06,559 --> 00:27:09,740
to install on Windows XP I don't think

732
00:27:08,659 --> 00:27:11,900
you can actually install the stuff on

733
00:27:09,740 --> 00:27:13,280
Windows XP I could be wrong but I never

734
00:27:11,900 --> 00:27:15,770
go much one run on it anymore

735
00:27:13,280 --> 00:27:16,668
that bit number eight just made me

736
00:27:15,770 --> 00:27:24,260
giggle at home

737
00:27:16,669 --> 00:27:25,400
I am already feeling more secure okay as

738
00:27:24,260 --> 00:27:28,760
I've mentioned with Windows NT

739
00:27:25,400 --> 00:27:30,380
ironically Windows XP did not come with

740
00:27:28,760 --> 00:27:31,879
PowerShell toast and we use PowerShell

741
00:27:30,380 --> 00:27:34,490
version two for the majority of our

742
00:27:31,880 --> 00:27:36,620
simulated malicious code so we couldn't

743
00:27:34,490 --> 00:27:38,480
run it on this machine but we've got

744
00:27:36,620 --> 00:27:39,889
your back covered because if you want to

745
00:27:38,480 --> 00:27:41,990
install PowerShell 2 on Windows XP

746
00:27:39,890 --> 00:27:46,340
apparently you can and here's a blog on

747
00:27:41,990 --> 00:27:48,440
how to do it right this is a good tweet

748
00:27:46,340 --> 00:27:50,809
yeah I think Mac's a lot like thinking

749
00:27:48,440 --> 00:27:53,539
you're not using am see in your AV

750
00:27:50,809 --> 00:27:55,428
products I'm not gonna mention leading

751
00:27:53,539 --> 00:27:58,370
eight antivirus products but they don't

752
00:27:55,429 --> 00:28:01,100
stop us the only one that causes me the

753
00:27:58,370 --> 00:28:01,908
most amount of pay is defender now this

754
00:28:01,100 --> 00:28:04,428
is a good point

755
00:28:01,909 --> 00:28:06,860
this majority here a big chunk yeah

756
00:28:04,429 --> 00:28:08,510
they're not using am site so we can

757
00:28:06,860 --> 00:28:10,789
still attack that easily with PowerShell

758
00:28:08,510 --> 00:28:12,500
and this is quite recent by the way I'd

759
00:28:10,789 --> 00:28:16,039
only about a month back I did it

760
00:28:12,500 --> 00:28:17,450
so this Windows 10 it as a pen tester it

761
00:28:16,039 --> 00:28:19,669
does scare me I find Windows 10

762
00:28:17,450 --> 00:28:22,429
definitely a harder beast to continue to

763
00:28:19,669 --> 00:28:24,590
attack but the first thing that most

764
00:28:22,429 --> 00:28:26,419
enterprises do is turn defender off and

765
00:28:24,590 --> 00:28:27,678
so in essence they're turning MC off

766
00:28:26,419 --> 00:28:29,929
they replace it with their chosen

767
00:28:27,679 --> 00:28:31,520
antivirus so if you actually look at

768
00:28:29,929 --> 00:28:33,260
this big section here it's fairly not

769
00:28:31,520 --> 00:28:35,360
the same I always suspect probably only

770
00:28:33,260 --> 00:28:37,400
that amount has defender with am c

771
00:28:35,360 --> 00:28:40,159
running so in all honesty you can

772
00:28:37,400 --> 00:28:43,390
premised all the bats so we still have

773
00:28:40,160 --> 00:28:46,160
in 2019 at very large section machines

774
00:28:43,390 --> 00:28:48,140
out there that as long as they're in

775
00:28:46,160 --> 00:28:53,810
scope and were authorized to do we can

776
00:28:48,140 --> 00:28:56,330
attack so this is a good points 2020

777
00:28:53,810 --> 00:28:58,220
january port 8 windows 7 unfortunately

778
00:28:56,330 --> 00:28:59,240
goes end of life and i blues might say

779
00:28:58,220 --> 00:29:00,410
unfortunately i think it was one the

780
00:28:59,240 --> 00:29:03,110
best operating systems they've ever made

781
00:29:00,410 --> 00:29:05,510
but that's my opinion but what we're

782
00:29:03,110 --> 00:29:06,949
going to say six months after that is

783
00:29:05,510 --> 00:29:13,070
this i'll be talking about this next

784
00:29:06,950 --> 00:29:14,410
year ok so parish i'll still got a bit

785
00:29:13,070 --> 00:29:17,950
of time

786
00:29:14,410 --> 00:29:20,600
okay so reminder i'd mentioned unicorn

787
00:29:17,950 --> 00:29:23,750
now I use unicorn a lot on engagements

788
00:29:20,600 --> 00:29:25,310
but Midway for an engagement when I'm

789
00:29:23,750 --> 00:29:26,660
about to attack your target and I'm

790
00:29:25,310 --> 00:29:27,980
richly and this is worth mentioning I've

791
00:29:26,660 --> 00:29:29,540
discussed earlier very badly cause

792
00:29:27,980 --> 00:29:30,860
nervous at that point but when you are

793
00:29:29,540 --> 00:29:32,870
building infrastructure you're getting

794
00:29:30,860 --> 00:29:34,219
ready to attack a target you just want

795
00:29:32,870 --> 00:29:36,199
your tools that you use day-in day-out

796
00:29:34,220 --> 00:29:38,030
to work and you automate a lot of it

797
00:29:36,200 --> 00:29:40,550
because we love to automate things and

798
00:29:38,030 --> 00:29:42,350
when suddenly something breaks and you

799
00:29:40,550 --> 00:29:44,540
know that you've got one day or two days

800
00:29:42,350 --> 00:29:47,419
or three days to prepare and they are

801
00:29:44,540 --> 00:29:51,050
expecting you know simulation of an apt

802
00:29:47,420 --> 00:29:51,530
group you panic it reads really really

803
00:29:51,050 --> 00:29:53,389
scary

804
00:29:51,530 --> 00:29:55,190
anyway rewind one second color to jump

805
00:29:53,390 --> 00:29:57,290
one thing to another right so you had

806
00:29:55,190 --> 00:29:58,910
advanced adversary's yes I mean your

807
00:29:57,290 --> 00:30:00,470
work clone your work I didn't originally

808
00:29:58,910 --> 00:30:02,690
say love your work love your work before

809
00:30:00,470 --> 00:30:08,630
that's a bit shouldn probably say that

810
00:30:02,690 --> 00:30:10,540
right introducing cobalt strike so what

811
00:30:08,630 --> 00:30:13,610
is cobalt strike I'm not here to sell it

812
00:30:10,540 --> 00:30:15,560
definitely not his salad it is a very

813
00:30:13,610 --> 00:30:16,909
very good Seto now a lot of you'll be

814
00:30:15,560 --> 00:30:20,090
thinking what the hell's our say to you

815
00:30:16,910 --> 00:30:22,430
just loved that in right Osito was a US

816
00:30:20,090 --> 00:30:25,639
military word and it was a command and

817
00:30:22,430 --> 00:30:27,740
control function we took it for red

818
00:30:25,640 --> 00:30:31,400
teaming I don't know really why it's a

819
00:30:27,740 --> 00:30:33,530
paired a call word called word but if

820
00:30:31,400 --> 00:30:35,570
anyone's interested in reading about red

821
00:30:33,530 --> 00:30:37,700
teaming infrastructure and just general

822
00:30:35,570 --> 00:30:40,159
red teaming tips I think blue screen of

823
00:30:37,700 --> 00:30:41,840
Jeff is the best blog out there for

824
00:30:40,160 --> 00:30:43,220
reading about red teaming I'll go as far

825
00:30:41,840 --> 00:30:45,379
as to say I think it's the red teaming

826
00:30:43,220 --> 00:30:47,330
Bible but if you look at here here's a

827
00:30:45,380 --> 00:30:49,730
typical infrastructure so we have a c2

828
00:30:47,330 --> 00:30:51,189
and this is where our targeted or are

829
00:30:49,730 --> 00:30:53,620
compromised targets

830
00:30:51,190 --> 00:30:55,390
communicates back to and we can control

831
00:30:53,620 --> 00:30:57,969
them from our c2 and send commands

832
00:30:55,390 --> 00:31:00,400
backwards and get responses back to us

833
00:30:57,970 --> 00:31:04,210
now in the real world we have redirect

834
00:31:00,400 --> 00:31:05,890
us now these are AWS or digitalocean or

835
00:31:04,210 --> 00:31:08,680
I'm trying to think I can never say the

836
00:31:05,890 --> 00:31:10,780
marks with Microsoft one they are VPS is

837
00:31:08,680 --> 00:31:13,960
there our Dropbox that our droplets as

838
00:31:10,780 --> 00:31:15,639
they call them and so the targets all

839
00:31:13,960 --> 00:31:17,950
they ever see is a legitimate domain

840
00:31:15,640 --> 00:31:19,510
that we purchased go into a redirect or

841
00:31:17,950 --> 00:31:21,760
which is an IP address somewhere on the

842
00:31:19,510 --> 00:31:23,500
Internet and you can buy droplets in any

843
00:31:21,760 --> 00:31:24,970
country pretty much in the world so if

844
00:31:23,500 --> 00:31:26,560
we were to simulate join or assume like

845
00:31:24,970 --> 00:31:28,090
Russia or simulate England we can do

846
00:31:26,560 --> 00:31:29,919
that and they see that traffic going

847
00:31:28,090 --> 00:31:31,449
backwards too that they never see the IP

848
00:31:29,920 --> 00:31:34,360
address of our c2 where we actually

849
00:31:31,450 --> 00:31:35,890
control and block so if we were to be

850
00:31:34,360 --> 00:31:37,600
burnt on a red team and you do gets on

851
00:31:35,890 --> 00:31:40,270
the red team they go how I spotted you I

852
00:31:37,600 --> 00:31:41,919
don't care because in all honesty it's

853
00:31:40,270 --> 00:31:43,480
an attack and all we're going to do is

854
00:31:41,920 --> 00:31:45,910
we're going to just burn that redirector

855
00:31:43,480 --> 00:31:47,830
and five minutes later we've got a new

856
00:31:45,910 --> 00:31:50,140
IP address from a new country we've got

857
00:31:47,830 --> 00:31:51,340
a completely new tane we are good to go

858
00:31:50,140 --> 00:31:52,690
and what they generally don't realize is

859
00:31:51,340 --> 00:31:54,939
we've had multiple connections to

860
00:31:52,690 --> 00:31:56,620
multiple c2s so in all honesty if one

861
00:31:54,940 --> 00:31:59,260
gets burnt it really not a problem

862
00:31:56,620 --> 00:32:00,790
okay I was talking about how about

863
00:31:59,260 --> 00:32:02,080
strike and lots of red teamers use

864
00:32:00,790 --> 00:32:05,050
cobalt stripe which is what I did bring

865
00:32:02,080 --> 00:32:07,629
it up it's an amazing site or very good

866
00:32:05,050 --> 00:32:10,389
c2 but the payload creation which is

867
00:32:07,630 --> 00:32:13,120
fantastic built into it the option to

868
00:32:10,390 --> 00:32:15,580
create payloads is incredible but it

869
00:32:13,120 --> 00:32:18,520
gets caught by antivirus so a quick

870
00:32:15,580 --> 00:32:22,149
primer on antivirus signature signature

871
00:32:18,520 --> 00:32:24,639
signature so how can you use cobalt

872
00:32:22,150 --> 00:32:27,310
strike your seats pebble strike and your

873
00:32:24,640 --> 00:32:29,590
c2 to bypass antivirus this is the

874
00:32:27,310 --> 00:32:31,720
third-party solutions now I use unicorn

875
00:32:29,590 --> 00:32:34,270
mostly but md6 sharpshooter is very very

876
00:32:31,720 --> 00:32:36,580
good and Dom of MD soap released video

877
00:32:34,270 --> 00:32:38,710
of hack Paris I think about a month back

878
00:32:36,580 --> 00:32:40,689
and it's definitely worth watching and

879
00:32:38,710 --> 00:32:42,760
hunting outs because he literally just

880
00:32:40,690 --> 00:32:44,830
explains how they do a red teaming and

881
00:32:42,760 --> 00:32:47,260
it talks about sharpshooter inside and

882
00:32:44,830 --> 00:32:48,520
out very very openly talks about it and

883
00:32:47,260 --> 00:32:51,580
was a very very interesting videos a

884
00:32:48,520 --> 00:32:53,470
very brave video to do so the cool

885
00:32:51,580 --> 00:32:56,169
people said Troy cobalt strike it we

886
00:32:53,470 --> 00:32:57,490
flood so I did and I was polling lots of

887
00:32:56,170 --> 00:32:59,820
targets over and over and over until

888
00:32:57,490 --> 00:33:03,430
unicorn version 3.2 points

889
00:32:59,820 --> 00:33:04,720
unicorn broke so why did it break

890
00:33:03,430 --> 00:33:07,720
and here's a video

891
00:33:04,720 --> 00:33:11,940
so we have the cat and mouse after watch

892
00:33:07,720 --> 00:33:14,110
this video where does the cat go - I

893
00:33:11,940 --> 00:33:16,750
don't like back that's the thing right

894
00:33:14,110 --> 00:33:19,389
cat and mouse games so why is there a

895
00:33:16,750 --> 00:33:21,790
signature for unicorn well there's a

896
00:33:19,390 --> 00:33:24,760
signature for any third-party solution

897
00:33:21,790 --> 00:33:26,710
that will help obsolete your payloads

898
00:33:24,760 --> 00:33:29,530
because they're popular and they're used

899
00:33:26,710 --> 00:33:31,360
so I also have another reason if

900
00:33:29,530 --> 00:33:33,129
anyone's ever opened the unicorn Poynton

901
00:33:31,360 --> 00:33:34,570
scripts up and actually read the

902
00:33:33,130 --> 00:33:36,250
comments that Dave Kennedy has written

903
00:33:34,570 --> 00:33:37,600
they're amazing I'm going to read this

904
00:33:36,250 --> 00:33:39,490
out for anyone who can't see it right

905
00:33:37,600 --> 00:33:40,810
the back sorry for the rant but it's

906
00:33:39,490 --> 00:33:43,210
annoying annoying to have to sit here

907
00:33:40,810 --> 00:33:45,310
and rewrite stupid stuff because you

908
00:33:43,210 --> 00:33:47,980
wrote Chrome a crummy signature love day

909
00:33:45,310 --> 00:33:50,860
now it doesn't say love day but I think

910
00:33:47,980 --> 00:33:52,870
you should assign the upload date so

911
00:33:50,860 --> 00:33:55,990
what broke so I'm trying to create my

912
00:33:52,870 --> 00:33:57,729
payload and using cobalt striking

913
00:33:55,990 --> 00:33:58,570
unicorn and that's the commands you do

914
00:33:57,730 --> 00:34:00,330
to do that

915
00:33:58,570 --> 00:34:03,280
so you just reference you cobalt strike

916
00:34:00,330 --> 00:34:05,199
C sharp toads and you tell it to output

917
00:34:03,280 --> 00:34:08,320
as a macro because I love using macros

918
00:34:05,200 --> 00:34:10,330
and it said this now it always worked

919
00:34:08,320 --> 00:34:11,590
historically never a problem and a bank

920
00:34:10,330 --> 00:34:13,360
when I'm really really needed on a

921
00:34:11,590 --> 00:34:17,230
really important engagement I got too

922
00:34:13,360 --> 00:34:18,850
many line continuations so panic as I

923
00:34:17,230 --> 00:34:21,820
mentioned it's very scary on a red team

924
00:34:18,850 --> 00:34:23,770
when it goes wrong so I googled too many

925
00:34:21,820 --> 00:34:25,930
line continuations because I didn't

926
00:34:23,770 --> 00:34:28,090
actually know what it meant and said

927
00:34:25,929 --> 00:34:30,759
your code has got more how dare your

928
00:34:28,090 --> 00:34:32,740
code and your VBS code has more than 25

929
00:34:30,760 --> 00:34:35,170
physical lines joined with lying

930
00:34:32,739 --> 00:34:37,139
continuation characters so quick primer

931
00:34:35,170 --> 00:34:40,870
because I mentioned the word macros a

932
00:34:37,139 --> 00:34:42,609
macro is in office you can automate

933
00:34:40,870 --> 00:34:44,589
automate frequently use tasks by

934
00:34:42,610 --> 00:34:45,820
creating and running macros these are

935
00:34:44,590 --> 00:34:47,710
commands that you can group together

936
00:34:45,820 --> 00:34:49,600
I love grouping stuff together and

937
00:34:47,710 --> 00:34:51,970
having you do multiple things to

938
00:34:49,600 --> 00:34:53,560
accomplish a task automatically macros

939
00:34:51,969 --> 00:34:56,259
can be used to run remote shells on

940
00:34:53,560 --> 00:34:59,740
malicious code all this comes with VBA

941
00:34:56,260 --> 00:35:01,330
and here we go to show you an extract

942
00:34:59,740 --> 00:35:03,459
from it and here's your line

943
00:35:01,330 --> 00:35:06,009
continuations and what that is it's all

944
00:35:03,460 --> 00:35:08,650
one line but that and that tells the

945
00:35:06,010 --> 00:35:10,210
computer to make it one line or to work

946
00:35:08,650 --> 00:35:14,560
out that is all one line it needs to run

947
00:35:10,210 --> 00:35:16,480
it now so what I try to do knowing I

948
00:35:14,560 --> 00:35:18,220
couldn't have any more than 25 lines

949
00:35:16,480 --> 00:35:20,290
down I have a little bash Marcel

950
00:35:18,220 --> 00:35:22,118
and all I need to do is make them really

951
00:35:20,290 --> 00:35:24,520
really long so I deleted a lot of the

952
00:35:22,119 --> 00:35:26,829
long continuations and I ended up with

953
00:35:24,520 --> 00:35:27,819
like 30 odd lines down to this not this

954
00:35:26,829 --> 00:35:29,920
is going to work

955
00:35:27,819 --> 00:35:33,790
and they didn't because they saw me

956
00:35:29,920 --> 00:35:35,230
coming so not only can you have no more

957
00:35:33,790 --> 00:35:37,300
than that you can have no more than that

958
00:35:35,230 --> 00:35:41,589
so it is actually quite restrictive in

959
00:35:37,300 --> 00:35:42,520
VBA which is something that I learned by

960
00:35:41,589 --> 00:35:43,900
the way it's not like we have a very

961
00:35:42,520 --> 00:35:46,450
good time to introduce myself

962
00:35:43,900 --> 00:35:50,109
my name's Neil lines and I work for

963
00:35:46,450 --> 00:35:52,149
Pentos partners so if you've been to

964
00:35:50,109 --> 00:35:53,770
anything that I presented before you'll

965
00:35:52,150 --> 00:35:55,390
know I like to mess with things I'm a

966
00:35:53,770 --> 00:35:56,380
lover of functionality Microsoft Office

967
00:35:55,390 --> 00:35:58,420
gives you so much

968
00:35:56,380 --> 00:36:01,660
VB macros offer you great functionality

969
00:35:58,420 --> 00:36:04,150
VB macros are really hard to write

970
00:36:01,660 --> 00:36:06,399
unless you're a coder now I will be the

971
00:36:04,150 --> 00:36:08,319
very first person to cite I am far from

972
00:36:06,400 --> 00:36:09,940
a code I'm absolutely no code at all

973
00:36:08,319 --> 00:36:11,589
it's scary I just don't understand it

974
00:36:09,940 --> 00:36:14,140
really but I have a little go with it

975
00:36:11,589 --> 00:36:16,150
and what that's called but why is it

976
00:36:14,140 --> 00:36:18,279
cool because we are hackers and

977
00:36:16,150 --> 00:36:19,540
historically hackers didn't have a clue

978
00:36:18,280 --> 00:36:21,040
what they were doing they would just

979
00:36:19,540 --> 00:36:22,420
take something and have a little play

980
00:36:21,040 --> 00:36:24,310
with it and get it to do something else

981
00:36:22,420 --> 00:36:28,630
and reality that is what hacking really

982
00:36:24,310 --> 00:36:31,839
is today ok soon follow this is the end

983
00:36:28,630 --> 00:36:33,460
so how do I wrap this up ok so the weak

984
00:36:31,839 --> 00:36:35,319
unicorn was broke I got busy

985
00:36:33,460 --> 00:36:38,170
I started thinking is shell the only way

986
00:36:35,319 --> 00:36:40,359
do we need full remote access what else

987
00:36:38,170 --> 00:36:42,700
can a macro do I started looking at VBA

988
00:36:40,359 --> 00:36:45,730
it was confusing a quick insight into

989
00:36:42,700 --> 00:36:47,828
how I'd think could I just put a

990
00:36:45,730 --> 00:36:50,500
PowerShell command directly into VBA

991
00:36:47,829 --> 00:36:53,950
without tweaking it whatsoever and the

992
00:36:50,500 --> 00:36:55,780
answer is yes and no what discovered was

993
00:36:53,950 --> 00:36:58,029
if you do very very simple stuff like in

994
00:36:55,780 --> 00:37:01,780
VBA you dismiss you drop in PowerShell

995
00:36:58,030 --> 00:37:03,849
dirt or partial IP config a it works it

996
00:37:01,780 --> 00:37:06,730
will give you the results so I was like

997
00:37:03,849 --> 00:37:10,839
oh this is easy I can wing this so I

998
00:37:06,730 --> 00:37:12,190
went from that to instantly go in

999
00:37:10,839 --> 00:37:14,730
because this is how my brain works

1000
00:37:12,190 --> 00:37:16,300
right can I now do Kerberos sting just

1001
00:37:14,730 --> 00:37:17,560
like from that to that

1002
00:37:16,300 --> 00:37:19,569
now if any orders know what Kerberos

1003
00:37:17,560 --> 00:37:21,310
ting gates any standard user on a

1004
00:37:19,569 --> 00:37:24,310
Microsoft domain has the right to

1005
00:37:21,310 --> 00:37:26,230
request the copy of the user name and

1006
00:37:24,310 --> 00:37:29,049
the password hashes and the domain name

1007
00:37:26,230 --> 00:37:30,760
or your service accounts on your DC that

1008
00:37:29,050 --> 00:37:31,619
align across your network doing service

1009
00:37:30,760 --> 00:37:33,299
account things

1010
00:37:31,619 --> 00:37:35,249
now service cancer generally not

1011
00:37:33,299 --> 00:37:37,019
trembling so this counts historically

1012
00:37:35,249 --> 00:37:39,209
have often been part of the domain

1013
00:37:37,019 --> 00:37:41,339
administrative group so any standard

1014
00:37:39,210 --> 00:37:43,309
user by default can in essence ask for a

1015
00:37:41,339 --> 00:37:46,729
copy of your the main administrative

1016
00:37:43,309 --> 00:37:48,119
signed account which is quite scary and

1017
00:37:46,729 --> 00:37:49,348
there you go

1018
00:37:48,119 --> 00:37:50,880
this is the PowerShell one line that

1019
00:37:49,349 --> 00:37:52,229
allows you to do that so if you were to

1020
00:37:50,880 --> 00:37:54,569
just copy and paste that into any domain

1021
00:37:52,229 --> 00:37:55,859
drawing to machine nine times out of ten

1022
00:37:54,569 --> 00:37:57,599
it will just output you a list of

1023
00:37:55,859 --> 00:38:00,089
service accounts and their password hash

1024
00:37:57,599 --> 00:38:01,710
which you can then go up and reverse but

1025
00:38:00,089 --> 00:38:03,538
if you were to just drop that into VBA

1026
00:38:01,710 --> 00:38:05,849
and try and convert it into I want to

1027
00:38:03,539 --> 00:38:07,650
make it as a macro hell no that is just

1028
00:38:05,849 --> 00:38:09,569
not going to work you very very quickly

1029
00:38:07,650 --> 00:38:12,239
just have a sea of red and pain and this

1030
00:38:09,569 --> 00:38:14,249
just isn't going to work so I learned

1031
00:38:12,239 --> 00:38:16,229
quite quickly it's not easy to run very

1032
00:38:14,249 --> 00:38:17,729
complex commands so I googled it and

1033
00:38:16,229 --> 00:38:19,410
this took me to give you I tell people

1034
00:38:17,729 --> 00:38:21,930
I'll be very honest it took me probably

1035
00:38:19,410 --> 00:38:23,219
about three the hosts to figure out from

1036
00:38:21,930 --> 00:38:24,868
messing around in my lab I don't do

1037
00:38:23,219 --> 00:38:26,339
things quickly I'm not one of people I

1038
00:38:24,869 --> 00:38:27,719
don't think a lot of people you see

1039
00:38:26,339 --> 00:38:29,219
people on YouTube people will look up to

1040
00:38:27,719 --> 00:38:31,170
a respect you seem on YouTube on the

1041
00:38:29,219 --> 00:38:32,819
video and within seconds they've just

1042
00:38:31,170 --> 00:38:34,619
done some really complex and really

1043
00:38:32,819 --> 00:38:35,969
incredible I don't think most people

1044
00:38:34,619 --> 00:38:38,729
like that in the real world I think we

1045
00:38:35,969 --> 00:38:40,739
do take time do things anyway this is

1046
00:38:38,729 --> 00:38:44,098
the answer you had to unicode that's a

1047
00:38:40,739 --> 00:38:46,319
base encode it's base 64 so I encoded

1048
00:38:44,099 --> 00:38:49,349
the commands and I did that all by hand

1049
00:38:46,319 --> 00:38:51,058
and I didn't encode it by hand but I

1050
00:38:49,349 --> 00:38:52,200
found a way to encode it and I created

1051
00:38:51,059 --> 00:38:54,059
the script by hand

1052
00:38:52,200 --> 00:38:56,009
and it was really really really painful

1053
00:38:54,059 --> 00:38:58,319
but I ran it and it works but it did

1054
00:38:56,009 --> 00:39:00,059
take me far too long so I got the

1055
00:38:58,319 --> 00:39:02,160
Kerberos request and outputted the

1056
00:39:00,059 --> 00:39:02,880
service accounts so I was like that's

1057
00:39:02,160 --> 00:39:04,890
fantastic

1058
00:39:02,880 --> 00:39:06,690
how do I now make this better so

1059
00:39:04,890 --> 00:39:08,160
obviously you wanted to email you the

1060
00:39:06,690 --> 00:39:10,499
results because that would be quite a

1061
00:39:08,160 --> 00:39:12,569
logical solution in my head anyway so

1062
00:39:10,499 --> 00:39:14,189
this is why I came up with so we had the

1063
00:39:12,569 --> 00:39:15,630
curve Russell crest and once it's

1064
00:39:14,190 --> 00:39:17,940
completed I'll it outputs the hash files

1065
00:39:15,630 --> 00:39:19,799
which does drop to disk I apologize and

1066
00:39:17,940 --> 00:39:21,029
at some point if I carefully be bothered

1067
00:39:19,799 --> 00:39:22,469
because I'm kind of fed up of doing this

1068
00:39:21,029 --> 00:39:24,210
but if I can never be bothered I might

1069
00:39:22,469 --> 00:39:25,529
actually get it's all runs in memory so

1070
00:39:24,210 --> 00:39:27,089
it doesn't issue drop anything disk and

1071
00:39:25,529 --> 00:39:28,799
I know it's possible but once it's

1072
00:39:27,089 --> 00:39:31,170
completed with that on the target

1073
00:39:28,799 --> 00:39:34,529
machine and this is the bit I love it

1074
00:39:31,170 --> 00:39:36,869
then spins up an SMTP service and it

1075
00:39:34,529 --> 00:39:39,299
emails it to your defined Gmail accounts

1076
00:39:36,869 --> 00:39:41,549
because this is set up here for Gmail so

1077
00:39:39,299 --> 00:39:45,269
and then afterwards it shuts it all down

1078
00:39:41,549 --> 00:39:45,420
and it deletes your file so nice but it

1079
00:39:45,269 --> 00:39:47,118
would

1080
00:39:45,420 --> 00:39:49,619
very painful to manually make the macro

1081
00:39:47,119 --> 00:39:51,630
shall I googled it and there's quite a

1082
00:39:49,619 --> 00:39:53,579
few examples how to make PowerShell to

1083
00:39:51,630 --> 00:39:55,859
VBA and there's lots of scripts out

1084
00:39:53,579 --> 00:39:57,000
there and I tried them but they just

1085
00:39:55,859 --> 00:39:59,430
didn't really work we'll do what I

1086
00:39:57,000 --> 00:40:01,530
wanted they just did no one seems to

1087
00:39:59,430 --> 00:40:03,390
make a script in the way I think so I

1088
00:40:01,530 --> 00:40:04,890
bashed my owner now yes I could have

1089
00:40:03,390 --> 00:40:06,660
written this in Python I could have gone

1090
00:40:04,890 --> 00:40:09,150
away and spent another month or two

1091
00:40:06,660 --> 00:40:10,529
figuring out how to write in PI fed but

1092
00:40:09,150 --> 00:40:12,450
why would I bother I'm doing this in my

1093
00:40:10,530 --> 00:40:13,950
own time my own amusements I'm I don't

1094
00:40:12,450 --> 00:40:16,348
use bash I don't want to pretend I'm

1095
00:40:13,950 --> 00:40:18,598
late so here we go this is what I've

1096
00:40:16,349 --> 00:40:20,760
come up with so that day you can bump up

1097
00:40:18,599 --> 00:40:22,230
to I think 190 and what that is is that

1098
00:40:20,760 --> 00:40:23,609
it's the amount of lines at the amount

1099
00:40:22,230 --> 00:40:25,170
of code you were going to allow on each

1100
00:40:23,609 --> 00:40:27,450
line I discovered the live seems to be

1101
00:40:25,170 --> 00:40:29,760
around about them to 95 characters or

1102
00:40:27,450 --> 00:40:31,259
voices no it's too long and in essence

1103
00:40:29,760 --> 00:40:33,390
what the rest of us is makes PowerShell

1104
00:40:31,260 --> 00:40:34,589
kreidel and it sticks all together to

1105
00:40:33,390 --> 00:40:39,150
know what I'm not going to talk about it

1106
00:40:34,589 --> 00:40:41,520
I have a video so this is my exploits my

1107
00:40:39,150 --> 00:40:43,619
github which absolutely no one follows

1108
00:40:41,520 --> 00:40:45,180
which I quite like because for years

1109
00:40:43,619 --> 00:40:47,160
I've been using it to chinky things and

1110
00:40:45,180 --> 00:40:50,250
no one spotted what I've been up to so

1111
00:40:47,160 --> 00:40:54,240
here we go I have cloned it and about to

1112
00:40:50,250 --> 00:40:57,030
run it so all your asks you for is the

1113
00:40:54,240 --> 00:40:58,799
file that you want to turn turn like

1114
00:40:57,030 --> 00:41:00,690
change into the VBA now at this point

1115
00:40:58,799 --> 00:41:06,569
it's going to pump it up to 190

1116
00:41:00,690 --> 00:41:08,520
characters and if you only does yeah

1117
00:41:06,569 --> 00:41:10,500
that's if you make your powershell one

1118
00:41:08,520 --> 00:41:12,540
line and then you just save it as a

1119
00:41:10,500 --> 00:41:15,869
notepad file and you've reference it and

1120
00:41:12,540 --> 00:41:22,859
wait for it come on hurry up and it just

1121
00:41:15,869 --> 00:41:24,869
outputs the VBA code for you boom done

1122
00:41:22,859 --> 00:41:27,660
so now what you would do is you just

1123
00:41:24,869 --> 00:41:29,309
drop that into your target machine now

1124
00:41:27,660 --> 00:41:34,259
for this example I'll use Microsoft Word

1125
00:41:29,309 --> 00:41:37,410
clearly and you'll see the result now

1126
00:41:34,260 --> 00:41:40,170
hope that I do it in this I get asked a

1127
00:41:37,410 --> 00:41:42,029
lot on YouTube but people say to me it

1128
00:41:40,170 --> 00:41:44,400
doesn't work I don't have to develop a

1129
00:41:42,030 --> 00:41:46,170
tab in Microsoft Office it's probably my

1130
00:41:44,400 --> 00:41:48,420
number one thing that people abuse me

1131
00:41:46,170 --> 00:41:49,589
about you have to enable it in Microsoft

1132
00:41:48,420 --> 00:41:51,290
Office I'm hoping this video it's not

1133
00:41:49,589 --> 00:41:52,950
enabled so I'm told people through it I

1134
00:41:51,290 --> 00:41:54,210
can't remember I make these videos

1135
00:41:52,950 --> 00:41:54,779
sometimes months back and don't know

1136
00:41:54,210 --> 00:41:57,270
yeah here we go

1137
00:41:54,780 --> 00:41:58,720
so to turn on developer which allows you

1138
00:41:57,270 --> 00:42:00,640
access to the VB

1139
00:41:58,720 --> 00:42:02,470
section odd word you just tick the box

1140
00:42:00,640 --> 00:42:04,480
and then you have to develop a tab which

1141
00:42:02,470 --> 00:42:07,118
you can now go to create new macro so

1142
00:42:04,480 --> 00:42:09,190
import module paste it in now for this

1143
00:42:07,119 --> 00:42:10,660
video I'm just going to hit run just to

1144
00:42:09,190 --> 00:42:12,369
verify but it works this is what I'll be

1145
00:42:10,660 --> 00:42:15,190
doing at home and I'm sitting on a go

1146
00:42:12,369 --> 00:42:17,650
bang so I've now sent from a targeted

1147
00:42:15,190 --> 00:42:19,900
machine I've proven that it is possible

1148
00:42:17,650 --> 00:42:21,310
from one click to get that target

1149
00:42:19,900 --> 00:42:23,650
machine to make a request to the domain

1150
00:42:21,310 --> 00:42:26,349
controller as for a copy are the service

1151
00:42:23,650 --> 00:42:27,910
accounts and send you a copy of the

1152
00:42:26,349 --> 00:42:29,380
service accounts which very likely

1153
00:42:27,910 --> 00:42:31,089
belongs in the main administrative group

1154
00:42:29,380 --> 00:42:33,670
across the internet it's encrypted

1155
00:42:31,090 --> 00:42:35,109
it's your gmail account so in theory you

1156
00:42:33,670 --> 00:42:36,490
could weaponize this and now turn it

1157
00:42:35,109 --> 00:42:38,290
into a legitimate object you're going to

1158
00:42:36,490 --> 00:42:39,729
send to someone and you could in theory

1159
00:42:38,290 --> 00:42:41,770
compromise them quite badly or quite

1160
00:42:39,730 --> 00:42:43,119
painfully if you are told that someone

1161
00:42:41,770 --> 00:42:45,700
must get your domain administrative

1162
00:42:43,119 --> 00:42:47,710
account in an email centers from one

1163
00:42:45,700 --> 00:42:50,410
person clicking an email or clicking a

1164
00:42:47,710 --> 00:42:53,280
word document I'd be quite concerned now

1165
00:42:50,410 --> 00:42:55,299
would I use this on an engagement no I

1166
00:42:53,280 --> 00:42:56,859
don't maybe one day I might use

1167
00:42:55,300 --> 00:42:59,530
something like it I definitely would use

1168
00:42:56,859 --> 00:43:01,270
this it's not late and it's not stealthy

1169
00:42:59,530 --> 00:43:04,839
and but he's something I like to do in a

1170
00:43:01,270 --> 00:43:07,570
lab so if I went to the Chris's workshop

1171
00:43:04,839 --> 00:43:10,450
yesterday about WMI he said something

1172
00:43:07,570 --> 00:43:13,060
that resonated me and he said some

1173
00:43:10,450 --> 00:43:15,160
people like to do hello world in when

1174
00:43:13,060 --> 00:43:19,210
practicing writing code I don't I like

1175
00:43:15,160 --> 00:43:21,940
to create a rat and what it sort of said

1176
00:43:19,210 --> 00:43:23,589
to me is in our labs in our own time do

1177
00:43:21,940 --> 00:43:25,780
whatever the hell you like come up with

1178
00:43:23,589 --> 00:43:30,520
stuff you think fun and funky right

1179
00:43:25,780 --> 00:43:30,849
scene six the start okay so I had an

1180
00:43:30,520 --> 00:43:31,930
idea

1181
00:43:30,849 --> 00:43:34,720
I'm at a point where I'm quite excited

1182
00:43:31,930 --> 00:43:35,919
by this okay so we can capture people

1183
00:43:34,720 --> 00:43:36,819
who belong to the main administrative

1184
00:43:35,920 --> 00:43:39,550
group that's yes

1185
00:43:36,820 --> 00:43:41,619
so can we capture a DEA hashes enumerate

1186
00:43:39,550 --> 00:43:43,660
all machines user groups why stop there

1187
00:43:41,619 --> 00:43:44,859
can we also locate all admin users all

1188
00:43:43,660 --> 00:43:46,629
shares find out grab local

1189
00:43:44,859 --> 00:43:48,490
administrative rights see if they clear

1190
00:43:46,630 --> 00:43:51,070
text credentials flying around that can

1191
00:43:48,490 --> 00:43:52,509
we also grab interesting oils can we

1192
00:43:51,070 --> 00:43:54,640
automatically get that email back just

1193
00:43:52,510 --> 00:43:57,730
we do the whole lot do everything just

1194
00:43:54,640 --> 00:43:59,080
from one click okay so I came up with

1195
00:43:57,730 --> 00:44:02,020
this so I'm just adding more and more

1196
00:43:59,080 --> 00:44:03,759
one liners you can say yeah there you go

1197
00:44:02,020 --> 00:44:06,280
find local ministry touches this one's

1198
00:44:03,760 --> 00:44:07,300
incredible find user field and I didn't

1199
00:44:06,280 --> 00:44:10,300
know about this until I see start

1200
00:44:07,300 --> 00:44:12,250
slapping it on and on a day say it seems

1201
00:44:10,300 --> 00:44:14,410
administrators quite commonly

1202
00:44:12,250 --> 00:44:15,370
then the user failed group so when you

1203
00:44:14,410 --> 00:44:17,049
click on the user

1204
00:44:15,370 --> 00:44:20,200
you've got the tabs at the top when

1205
00:44:17,050 --> 00:44:21,970
you're on a domain when you're getting

1206
00:44:20,200 --> 00:44:23,109
one saying Active Directory sorry

1207
00:44:21,970 --> 00:44:25,180
when your Active Directory to go to

1208
00:44:23,110 --> 00:44:27,190
users you have a tab called user field

1209
00:44:25,180 --> 00:44:29,379
and people like notes about that account

1210
00:44:27,190 --> 00:44:32,140
but it seems that what is quite common

1211
00:44:29,380 --> 00:44:33,910
people add passwords and that user field

1212
00:44:32,140 --> 00:44:35,200
so I don't know why they do it they do

1213
00:44:33,910 --> 00:44:37,540
it and I've tried it on internals and

1214
00:44:35,200 --> 00:44:38,620
actually it's true they do do it so it's

1215
00:44:37,540 --> 00:44:42,090
quite interesting way of getting clear

1216
00:44:38,620 --> 00:44:45,040
text passwords anyway so here we go so

1217
00:44:42,090 --> 00:44:51,610
I'm not a target machine and open the

1218
00:44:45,040 --> 00:44:55,350
word documents and I hit enable contents

1219
00:44:51,610 --> 00:44:55,350
and boom it's done and then we just wait

1220
00:45:00,690 --> 00:45:05,890
and there we go we got it so we have the

1221
00:45:04,750 --> 00:45:08,410
Kerberos hashes we're happy to mate

1222
00:45:05,890 --> 00:45:09,910
administrate to the group and we also

1223
00:45:08,410 --> 00:45:11,859
have their create its password from a

1224
00:45:09,910 --> 00:45:14,259
user field that someone's added now this

1225
00:45:11,860 --> 00:45:17,170
is my lab worth knowing and we have

1226
00:45:14,260 --> 00:45:18,010
emotion about machines and SMB stuff and

1227
00:45:17,170 --> 00:45:20,590
blah blah blah blah blah and you have

1228
00:45:18,010 --> 00:45:22,570
whatever you like so a lot of you'll be

1229
00:45:20,590 --> 00:45:24,160
thinking well that's Windows 7 and this

1230
00:45:22,570 --> 00:45:25,660
is where the whole antsy thing comes in

1231
00:45:24,160 --> 00:45:27,609
and a lot of people will be going wow

1232
00:45:25,660 --> 00:45:30,730
it's not gonna bypass MC so you're an

1233
00:45:27,610 --> 00:45:33,910
amateur but remembering almost all of

1234
00:45:30,730 --> 00:45:36,040
that doesn't have answer so that could

1235
00:45:33,910 --> 00:45:37,420
be affected by something like that but

1236
00:45:36,040 --> 00:45:38,320
anyway just because I like to make

1237
00:45:37,420 --> 00:45:40,930
things caller

1238
00:45:38,320 --> 00:45:43,210
that's bypass answer now this is working

1239
00:45:40,930 --> 00:45:45,040
progress so this is great against

1240
00:45:43,210 --> 00:45:46,810
Windows 10 defenders on amps is running

1241
00:45:45,040 --> 00:45:48,430
and boom I still have notes about

1242
00:45:46,810 --> 00:45:52,210
Windows 10 this works dumpsite quicker

1243
00:45:48,430 --> 00:45:55,180
don't a wife bang we got it now that's

1244
00:45:52,210 --> 00:45:56,500
working progress but I do tend to you'll

1245
00:45:55,180 --> 00:45:58,509
probably got a feel from the style of

1246
00:45:56,500 --> 00:46:00,160
talking I jump from things to things I

1247
00:45:58,510 --> 00:46:06,130
don't know if I'll continue this project

1248
00:46:00,160 --> 00:46:08,750
I don't know right on my exploit 2600 on

1249
00:46:06,130 --> 00:46:10,810
Twitter thank you very much

1250
00:46:08,750 --> 00:46:10,810
you

