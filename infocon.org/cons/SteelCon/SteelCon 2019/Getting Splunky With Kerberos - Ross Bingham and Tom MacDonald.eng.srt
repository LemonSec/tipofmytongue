1
00:00:02,850 --> 00:00:07,779
hi there everybody cool thanks very much

2
00:00:06,310 --> 00:00:10,000
for coming down to our talk my name is

3
00:00:07,779 --> 00:00:11,559
Tom I've got Ross here thanks for coming

4
00:00:10,000 --> 00:00:12,910
to investigate how we're attacking and

5
00:00:11,559 --> 00:00:14,469
breaking into networks using code Ross

6
00:00:12,910 --> 00:00:15,789
but also more importantly like how to

7
00:00:14,469 --> 00:00:17,439
detect and stop these hype things

8
00:00:15,789 --> 00:00:18,850
happening ultimately we are here to make

9
00:00:17,440 --> 00:00:20,410
the organizations we're testing better

10
00:00:18,850 --> 00:00:22,300
so we don't actually provide any

11
00:00:20,410 --> 00:00:24,160
remediation advice then we're not

12
00:00:22,300 --> 00:00:25,150
actually delivering much value just very

13
00:00:24,160 --> 00:00:28,240
quickly how many people have come like

14
00:00:25,150 --> 00:00:31,240
the blue side of things yeah nice one

15
00:00:28,240 --> 00:00:32,820
someone's gonna be and the red yeah God

16
00:00:31,240 --> 00:00:35,289
patrollers chosen trait happy days

17
00:00:32,820 --> 00:00:38,199
there's only like policy guys or you

18
00:00:35,289 --> 00:00:40,179
know like all bit types and stuff just

19
00:00:38,199 --> 00:00:43,149
just that one dude in the pack nice

20
00:00:40,179 --> 00:00:44,920
rotten thanks but someone's someone's

21
00:00:43,149 --> 00:00:47,589
got to do it that's cool anyway so let's

22
00:00:44,920 --> 00:00:48,730
get cracking this is me up here I work

23
00:00:47,589 --> 00:00:50,440
at night - doing red teaming and

24
00:00:48,730 --> 00:00:52,870
large-scale infrastructure complicated

25
00:00:50,440 --> 00:00:54,309
infrastructures my thing that I enjoy

26
00:00:52,870 --> 00:00:55,809
doing is abusing like systems

27
00:00:54,309 --> 00:00:57,879
administration tools against their

28
00:00:55,809 --> 00:01:00,218
organizations I used to be a sysadmin

29
00:00:57,879 --> 00:01:02,019
until I sort of reformed myself and now

30
00:01:00,219 --> 00:01:03,219
got into pen testing and security did

31
00:01:02,019 --> 00:01:05,850
some time in the army did some cyber

32
00:01:03,219 --> 00:01:08,710
related stuffs and now got some cert

33
00:01:05,850 --> 00:01:10,509
yeah and he wrote my name's Ross at

34
00:01:08,710 --> 00:01:12,399
Windex top on Twitter for those of you

35
00:01:10,509 --> 00:01:14,079
who care and they also borrowed small

36
00:01:12,399 --> 00:01:16,869
shred team up for obvious reasons and

37
00:01:14,079 --> 00:01:18,820
bulk of my team has been on the red team

38
00:01:16,869 --> 00:01:20,259
side of things doing engagements as an

39
00:01:18,820 --> 00:01:21,369
operator fighting read ER playing the

40
00:01:20,259 --> 00:01:23,979
blue team's and then ultimately

41
00:01:21,369 --> 00:01:25,329
reporting and also because of our

42
00:01:23,979 --> 00:01:26,890
engagements or threat intelligence they

43
00:01:25,329 --> 00:01:29,408
have been working more with a cyber

44
00:01:26,890 --> 00:01:31,960
threat intelligence recently yeah and in

45
00:01:29,409 --> 00:01:33,969
particular opponents in CI by exploring

46
00:01:31,960 --> 00:01:35,710
the board bully team side of things so

47
00:01:33,969 --> 00:01:38,350
looking at detection in 300 web tools

48
00:01:35,710 --> 00:01:40,509
like Hezbollah at spawn carbon black etc

49
00:01:38,350 --> 00:01:42,548
me research celesta beer and their

50
00:01:40,509 --> 00:01:44,859
priority swapping over to the red team

51
00:01:42,549 --> 00:01:47,679
side of things as a pen tester five

52
00:01:44,859 --> 00:01:48,669
years okay excellent let's talk about

53
00:01:47,679 --> 00:01:50,049
what we're going to actually cover

54
00:01:48,670 --> 00:01:51,670
because quite important we gather in

55
00:01:50,049 --> 00:01:53,049
context around what we're covering and

56
00:01:51,670 --> 00:01:54,520
otherwise all the knowledge just kind of

57
00:01:53,049 --> 00:01:56,200
sits in isolation doesn't really glue

58
00:01:54,520 --> 00:01:57,399
together at all more importantly I'm

59
00:01:56,200 --> 00:01:59,170
running through Kerberos and there's a

60
00:01:57,399 --> 00:02:00,969
super complicated topic at the level we

61
00:01:59,170 --> 00:02:02,499
need now it's not going to be that

62
00:02:00,969 --> 00:02:04,479
complicated don't over complicate it

63
00:02:02,499 --> 00:02:05,770
there's no algorithms lying around or

64
00:02:04,479 --> 00:02:07,899
anything like that but worry about its

65
00:02:05,770 --> 00:02:09,758
would do a tldr level and with the TLDR

66
00:02:07,899 --> 00:02:11,319
on Splunk and then we're getting to the

67
00:02:09,758 --> 00:02:13,208
good stuff into the three different

68
00:02:11,319 --> 00:02:15,879
attacks and we'll break that into attack

69
00:02:13,209 --> 00:02:17,170
detect and evade and ultimately we still

70
00:02:15,879 --> 00:02:18,459
want red to win a little bit so we've

71
00:02:17,170 --> 00:02:20,589
got some evasion stuff in there as well

72
00:02:18,459 --> 00:02:22,090
you have a quick sort of run through on

73
00:02:20,590 --> 00:02:25,150
how you can do threat on things like

74
00:02:22,090 --> 00:02:26,739
quite easily with with free tooling

75
00:02:25,150 --> 00:02:28,480
we're using Splunk throughout this which

76
00:02:26,739 --> 00:02:30,670
isn't free where you could use any tool

77
00:02:28,480 --> 00:02:31,988
whatsoever you know whether it's hell or

78
00:02:30,670 --> 00:02:33,849
you can you can using logarithm or

79
00:02:31,989 --> 00:02:35,739
something similar and more importantly

80
00:02:33,849 --> 00:02:37,450
we'll give some key takeaways that you

81
00:02:35,739 --> 00:02:39,459
can implement either on the red side on

82
00:02:37,450 --> 00:02:40,929
the reporting things on the blue side

83
00:02:39,459 --> 00:02:43,090
you can pressure your bosses to allow

84
00:02:40,930 --> 00:02:45,700
you to make some changes because if you

85
00:02:43,090 --> 00:02:47,530
struggling with prioritization do these

86
00:02:45,700 --> 00:02:51,310
things first before you start like

87
00:02:47,530 --> 00:02:52,510
getting into anything else cool so

88
00:02:51,310 --> 00:02:54,040
they're gonna have to talk what am i I

89
00:02:52,510 --> 00:02:56,260
just really thick in Apollo on from what

90
00:02:54,040 --> 00:02:57,400
max says it's basically we want to

91
00:02:56,260 --> 00:02:58,929
demonstrate like there's more two

92
00:02:57,400 --> 00:03:01,269
cameras and just like in both care

93
00:02:58,930 --> 00:03:02,920
Bristol wailed and like so we're gonna

94
00:03:01,269 --> 00:03:04,239
understand like what our footprint is is

95
00:03:02,920 --> 00:03:05,829
a red thing when we do these sorts of

96
00:03:04,239 --> 00:03:07,299
attacks and then on the blue team side

97
00:03:05,830 --> 00:03:08,830
of things how we can leverage that

98
00:03:07,299 --> 00:03:10,480
footprint to beldo detections

99
00:03:08,830 --> 00:03:12,370
performance rate hunts off the back of

100
00:03:10,480 --> 00:03:15,099
these detection x' and things like that

101
00:03:12,370 --> 00:03:16,900
and canada ultimately like improve all

102
00:03:15,099 --> 00:03:19,629
the rating and butene understanding

103
00:03:16,900 --> 00:03:21,519
whole cameras as a whole and as kind of

104
00:03:19,629 --> 00:03:23,230
Mac mentioned you can do that's West's

105
00:03:21,519 --> 00:03:24,879
Punk which is what we're using there as

106
00:03:23,230 --> 00:03:26,530
loads of free alternatives or some paid

107
00:03:24,879 --> 00:03:28,239
alternatives as well that you can do

108
00:03:26,530 --> 00:03:30,700
this with and there's a thing called

109
00:03:28,239 --> 00:03:32,500
unencoded apology to like converse plonk

110
00:03:30,700 --> 00:03:34,328
wheels to different pair cui-ui indian

111
00:03:32,500 --> 00:03:38,110
stuff and sort of point our options

112
00:03:34,329 --> 00:03:39,640
there okay so this is the TLDR of Splunk

113
00:03:38,110 --> 00:03:41,379
and this is from their show met car for

114
00:03:39,640 --> 00:03:42,700
ad security you're not familiar daily

115
00:03:41,379 --> 00:03:44,290
security and you're doing pen testing

116
00:03:42,700 --> 00:03:46,179
internal imps or red team's basically

117
00:03:44,290 --> 00:03:48,640
read the entirety of that going back as

118
00:03:46,180 --> 00:03:50,620
far as you can so Kerberos is split into

119
00:03:48,640 --> 00:03:52,000
a six way handshake process

120
00:03:50,620 --> 00:03:54,159
think of it as similar to the 3-way

121
00:03:52,000 --> 00:03:56,049
handshake from the TCP side of things

122
00:03:54,159 --> 00:03:58,450
and if we Center it around this part

123
00:03:56,049 --> 00:04:00,370
here first you need to prove who you are

124
00:03:58,450 --> 00:04:01,869
and you prove that to the in this case

125
00:04:00,370 --> 00:04:03,849
windows network the domain controller

126
00:04:01,870 --> 00:04:06,010
then you prove that you're permitted to

127
00:04:03,849 --> 00:04:08,048
access the resource you want to access

128
00:04:06,010 --> 00:04:10,030
whether that's HTTP and their sequel or

129
00:04:08,049 --> 00:04:11,769
whatever that service happens to be and

130
00:04:10,030 --> 00:04:13,629
thirdly you will apply that me

131
00:04:11,769 --> 00:04:16,180
authenticated access into the

132
00:04:13,629 --> 00:04:17,260
application that you want yeah but there

133
00:04:16,180 --> 00:04:19,180
you go you never know as much as that

134
00:04:17,260 --> 00:04:22,930
pair of rasa's I do welcome to the party

135
00:04:19,180 --> 00:04:24,370
it's fun being a service expert bill so

136
00:04:22,930 --> 00:04:25,960
just quick Splunk 101 this is mainly

137
00:04:24,370 --> 00:04:27,550
only terminology I've been using the

138
00:04:25,960 --> 00:04:28,239
talk so the server as what you would

139
00:04:27,550 --> 00:04:30,400
expect it to

140
00:04:28,240 --> 00:04:32,680
the sponsor but it's gonna consume all

141
00:04:30,400 --> 00:04:34,479
your logs and data and the forwarders

142
00:04:32,680 --> 00:04:35,770
where you deploy it on to your endpoints

143
00:04:34,479 --> 00:04:37,560
and what they are gonna do is log

144
00:04:35,770 --> 00:04:40,570
collection and forward to the server

145
00:04:37,560 --> 00:04:41,590
index or index eases basically what was

146
00:04:40,570 --> 00:04:43,210
one of the things that ones on the

147
00:04:41,590 --> 00:04:45,219
server say that then handles all that

148
00:04:43,210 --> 00:04:47,229
they are coming in and organized is it

149
00:04:45,220 --> 00:04:49,210
source types is something we're gonna

150
00:04:47,229 --> 00:04:50,650
use in the queries so when you're you

151
00:04:49,210 --> 00:04:52,150
know searching for an event and you want

152
00:04:50,650 --> 00:04:53,739
to refine that think of it's like

153
00:04:52,150 --> 00:04:55,120
hunting for a needle in a haystack right

154
00:04:53,740 --> 00:04:56,620
you want to make that a stack as small

155
00:04:55,120 --> 00:04:58,660
as possible who are you looking for that

156
00:04:56,620 --> 00:05:00,280
needle and just give them like a CPU

157
00:04:58,660 --> 00:05:03,789
optimization perspective that's the

158
00:05:00,280 --> 00:05:05,559
optimal and at scale that Mars and then

159
00:05:03,789 --> 00:05:08,169
the search queries are basically what

160
00:05:05,560 --> 00:05:09,610
we'll be using to make surgeries and so

161
00:05:08,169 --> 00:05:11,710
just quick run-through ever spawn setup

162
00:05:09,610 --> 00:05:13,570
and printing & enterprise server

163
00:05:11,710 --> 00:05:16,060
installed on a you've been to own air

164
00:05:13,570 --> 00:05:17,909
ESXi lab or what goes on at endpoints

165
00:05:16,060 --> 00:05:20,770
with the latest version assessment and

166
00:05:17,910 --> 00:05:23,139
that's one as free and gives amazing

167
00:05:20,770 --> 00:05:23,948
visibility and two endpoints and servers

168
00:05:23,139 --> 00:05:25,960
things like that so it's definitely

169
00:05:23,949 --> 00:05:28,030
something you should consider for your

170
00:05:25,960 --> 00:05:29,919
environment if you haven't already and

171
00:05:28,030 --> 00:05:31,659
we're using sessemann wes wetland

172
00:05:29,919 --> 00:05:33,639
security assessment config that just

173
00:05:31,660 --> 00:05:36,010
allows us to get additional insight on

174
00:05:33,639 --> 00:05:37,419
top of what it does pay the box and then

175
00:05:36,010 --> 00:05:39,460
finally spawn supports a number of

176
00:05:37,419 --> 00:05:41,080
plugins and so the assessment plug in

177
00:05:39,460 --> 00:05:42,638
there but it's also a deploy plugin

178
00:05:41,080 --> 00:05:43,750
where you can push out pay assess phone

179
00:05:42,639 --> 00:05:45,310
conflicts and things like that three

180
00:05:43,750 --> 00:05:47,530
years here what's the city doing it in

181
00:05:45,310 --> 00:05:51,070
every endpoint and this is a quick

182
00:05:47,530 --> 00:05:52,659
network diagram so it's basically TLDR

183
00:05:51,070 --> 00:05:55,150
of the network get brought said the

184
00:05:52,659 --> 00:05:57,639
internet to a sixteen domain controller

185
00:05:55,150 --> 00:05:59,380
2010 workstation CLE response server

186
00:05:57,639 --> 00:06:02,320
there's all the lots of going to it and

187
00:05:59,380 --> 00:06:03,880
we've also got forest trust to a domain

188
00:06:02,320 --> 00:06:06,460
called blue bank which is got a max of

189
00:06:03,880 --> 00:06:08,169
air boxes and generally up to date with

190
00:06:06,460 --> 00:06:09,969
Windows Defender AM Sekhar black

191
00:06:08,169 --> 00:06:13,090
I've also get sent a one deployed on

192
00:06:09,970 --> 00:06:15,130
this week and and then we'll get closer

193
00:06:13,090 --> 00:06:16,869
figured ad there one thing to note

194
00:06:15,130 --> 00:06:18,580
though it's and this is important for

195
00:06:16,870 --> 00:06:20,500
threat huntin some of these air

196
00:06:18,580 --> 00:06:21,849
workstations can actually get direct to

197
00:06:20,500 --> 00:06:23,199
the internet so we're going to talk

198
00:06:21,849 --> 00:06:25,949
about how we can look for that as well

199
00:06:23,199 --> 00:06:28,300
air from this configuration some point

200
00:06:25,949 --> 00:06:29,830
okay let's get into the into the good

201
00:06:28,300 --> 00:06:33,070
stuff like the attacking side of things

202
00:06:29,830 --> 00:06:35,198
let's start off with the coverage okay

203
00:06:33,070 --> 00:06:36,909
without getting massively into the weeds

204
00:06:35,199 --> 00:06:38,800
here what we're doing here is all done

205
00:06:36,909 --> 00:06:40,960
from a low privilege domain user context

206
00:06:38,800 --> 00:06:42,110
in blow Bank here we've got a Deb we've

207
00:06:40,960 --> 00:06:43,638
got a shell that we would

208
00:06:42,110 --> 00:06:45,530
in exactly the same context as we got

209
00:06:43,639 --> 00:06:47,689
from a single pitch not fine we don't

210
00:06:45,530 --> 00:06:49,789
need any enhanced privileges here we're

211
00:06:47,689 --> 00:06:51,560
using a PS implant which uses system

212
00:06:49,789 --> 00:06:52,938
management automation dll to use

213
00:06:51,560 --> 00:06:54,590
PowerShell functions without running

214
00:06:52,939 --> 00:06:55,909
PowerShell that XE yeah run in

215
00:06:54,590 --> 00:06:57,318
PowerShell actually on the endpoints on

216
00:06:55,909 --> 00:06:58,969
the red see me sides a little bit apt

217
00:06:57,319 --> 00:07:01,280
memes so we don't need to be doing that

218
00:06:58,969 --> 00:07:04,250
now what list we're doing here is we're

219
00:07:01,280 --> 00:07:06,739
requesting a TGS for all of the services

220
00:07:04,250 --> 00:07:09,379
inside that organization and then we'll

221
00:07:06,740 --> 00:07:12,139
go and copy those off into into a hash

222
00:07:09,379 --> 00:07:17,300
cuts whether that's in a GPU cracking or

223
00:07:12,139 --> 00:07:19,099
similar okay in terms of like preventing

224
00:07:17,300 --> 00:07:20,509
and detecting these things when it

225
00:07:19,099 --> 00:07:22,219
happens yeah because pretty much every

226
00:07:20,509 --> 00:07:24,500
internal pentester will probably do this

227
00:07:22,219 --> 00:07:26,330
as soon as they sort of it early on in

228
00:07:24,500 --> 00:07:28,069
the engagement on the red team side of

229
00:07:26,330 --> 00:07:30,050
why if we usually make use of it at

230
00:07:28,069 --> 00:07:31,699
times and we'll talk on such on how we

231
00:07:30,050 --> 00:07:35,150
do the evasion side of life in a moment

232
00:07:31,699 --> 00:07:37,340
so we often see that MS sequel is the

233
00:07:35,150 --> 00:07:39,679
biggest offender when of you a company

234
00:07:37,340 --> 00:07:42,049
is starting up you know they buy sequel

235
00:07:39,680 --> 00:07:43,729
and then they sort of grow over five or

236
00:07:42,050 --> 00:07:45,860
ten years and they're still using the

237
00:07:43,729 --> 00:07:48,020
same sequel instance here we often find

238
00:07:45,860 --> 00:07:49,909
shared credentials across multiple

239
00:07:48,020 --> 00:07:51,258
instances and people are terrified of

240
00:07:49,909 --> 00:07:52,699
changing it because in large

241
00:07:51,259 --> 00:07:54,710
organizations they got monstrous

242
00:07:52,699 --> 00:07:56,419
technical debt and a fear of changing

243
00:07:54,710 --> 00:07:57,948
things and breaking things they're all

244
00:07:56,419 --> 00:07:59,628
this little one-liner here from powerup

245
00:07:57,949 --> 00:08:01,330
sequel that's from Scott Sutherland I

246
00:07:59,629 --> 00:08:03,589
think you works Burnett spy in the u.s.

247
00:08:01,330 --> 00:08:05,150
so we've got get sequel instance main

248
00:08:03,589 --> 00:08:06,949
which will go across grab all of the

249
00:08:05,150 --> 00:08:08,929
instances of sequel and then pipe it

250
00:08:06,949 --> 00:08:10,819
across into a nice list and you'll end

251
00:08:08,930 --> 00:08:12,710
up with two columns you know a list of

252
00:08:10,819 --> 00:08:14,150
user names down the left and then on the

253
00:08:12,710 --> 00:08:15,620
right hand side a number of times that

254
00:08:14,150 --> 00:08:17,419
username was used across the environment

255
00:08:15,620 --> 00:08:19,370
what we're looking for is a nice long

256
00:08:17,419 --> 00:08:21,080
list of user names and then in the

257
00:08:19,370 --> 00:08:22,490
number of times used across the

258
00:08:21,080 --> 00:08:24,500
environment column we're looking for

259
00:08:22,490 --> 00:08:26,210
ones only if you're not seeing ones

260
00:08:24,500 --> 00:08:27,860
you've obviously reusing the same set of

261
00:08:26,210 --> 00:08:29,599
Active Directory credentials have all

262
00:08:27,860 --> 00:08:32,599
the same user names at least across

263
00:08:29,599 --> 00:08:33,679
different services additionally I'm a

264
00:08:32,599 --> 00:08:35,630
big fan I'm going to touch on this a

265
00:08:33,679 --> 00:08:37,789
little bit more and honey spins take

266
00:08:35,630 --> 00:08:39,469
sort of maybe seven to eight seconds to

267
00:08:37,789 --> 00:08:41,958
implant in the largest environments in

268
00:08:39,469 --> 00:08:43,940
the world so there's no no excuse not to

269
00:08:41,958 --> 00:08:45,560
be doing those all the code to do those

270
00:08:43,940 --> 00:08:47,480
as four different ways of deploying them

271
00:08:45,560 --> 00:08:49,550
all eminently doable by even the worst

272
00:08:47,480 --> 00:08:51,319
systems administrators yeah we can just

273
00:08:49,550 --> 00:08:53,000
do honey spins and try and take the

274
00:08:51,319 --> 00:08:55,699
initiative back towards the blue side a

275
00:08:53,000 --> 00:08:58,280
little bit and again

276
00:08:55,700 --> 00:09:00,170
in terms of preventing the use of the

277
00:08:58,280 --> 00:09:02,329
kerberos attack being used against your

278
00:09:00,170 --> 00:09:04,579
environments service accounts very very

279
00:09:02,330 --> 00:09:06,830
very rarely need type to interactive

280
00:09:04,580 --> 00:09:08,300
logons grunted across the domain very

281
00:09:06,830 --> 00:09:10,190
frequently the only type three and four

282
00:09:08,300 --> 00:09:11,810
which is matching Network and but type

283
00:09:10,190 --> 00:09:14,150
two interactive logins which is exactly

284
00:09:11,810 --> 00:09:16,069
the same context you have when you log

285
00:09:14,150 --> 00:09:18,199
into your machine very rare that sequel

286
00:09:16,070 --> 00:09:21,170
services or any HTTP services require

287
00:09:18,200 --> 00:09:22,700
those permission so what does this look

288
00:09:21,170 --> 00:09:24,260
like from the detection say it's just

289
00:09:22,700 --> 00:09:26,720
gonna gonna run through a quick query

290
00:09:24,260 --> 00:09:28,280
structure here and so first of all we're

291
00:09:26,720 --> 00:09:29,510
indexing pin main which I want to see

292
00:09:28,280 --> 00:09:32,540
right now is something you should

293
00:09:29,510 --> 00:09:34,100
absolutely never do as a CB generate an

294
00:09:32,540 --> 00:09:36,530
event you'll be looking for a job pretty

295
00:09:34,100 --> 00:09:38,270
quickly have you do that generally you

296
00:09:36,530 --> 00:09:40,370
want to split your indexes oats so like

297
00:09:38,270 --> 00:09:41,720
we're ingest and when event log data we

298
00:09:40,370 --> 00:09:42,920
want to win event log index and

299
00:09:41,720 --> 00:09:44,840
particular incest Monday or an

300
00:09:42,920 --> 00:09:47,000
assessment index and then we're going to

301
00:09:44,840 --> 00:09:48,590
sort by source tapes and so we're

302
00:09:47,000 --> 00:09:49,970
looking for when event logs and then

303
00:09:48,590 --> 00:09:51,740
anything that's happened in the last

304
00:09:49,970 --> 00:09:53,840
twenty fibers we're looking for four

305
00:09:51,740 --> 00:09:56,270
seven six nine switches at TGS has been

306
00:09:53,840 --> 00:09:58,340
requested and that's kinda like what we

307
00:09:56,270 --> 00:10:00,410
get back here we've got you know 250

308
00:09:58,340 --> 00:10:03,230
events and the last survivors that may

309
00:10:00,410 --> 00:10:06,230
be normal for enterprise environment

310
00:10:03,230 --> 00:10:08,180
maybe not and and then so we can see

311
00:10:06,230 --> 00:10:09,710
here as well as this is the lamby tree

312
00:10:08,180 --> 00:10:11,630
so we can see it create a loop it it

313
00:10:09,710 --> 00:10:12,890
Peaks here and just to kind of put that

314
00:10:11,630 --> 00:10:14,840
in your mind we're gonna cover telemetry

315
00:10:12,890 --> 00:10:17,180
detection later and that's basically

316
00:10:14,840 --> 00:10:18,830
what query whoops like the message

317
00:10:17,180 --> 00:10:21,020
cannot break quick you know overview of

318
00:10:18,830 --> 00:10:22,220
what the event itself looks like and so

319
00:10:21,020 --> 00:10:24,770
then say we're getting here we can see

320
00:10:22,220 --> 00:10:26,390
Jason fell Perry regular domain user hey

321
00:10:24,770 --> 00:10:28,579
the DB need then is making this four

322
00:10:26,390 --> 00:10:29,569
seven six nine event he's greeting for

323
00:10:28,580 --> 00:10:32,390
the mssql

324
00:10:29,570 --> 00:10:33,980
a service and this is the IP is coming

325
00:10:32,390 --> 00:10:35,780
from and they take encryption type is

326
00:10:33,980 --> 00:10:38,080
seventeen which is our c4 which is an

327
00:10:35,780 --> 00:10:40,250
IOC which Michael talked about shortly

328
00:10:38,080 --> 00:10:42,050
I'm just the kind of end part of the

329
00:10:40,250 --> 00:10:43,310
query as the stat so generally when

330
00:10:42,050 --> 00:10:44,270
you're looking for things like this in

331
00:10:43,310 --> 00:10:46,010
your environment you're looking for

332
00:10:44,270 --> 00:10:48,199
irregularities you want to see like

333
00:10:46,010 --> 00:10:50,960
what's good on as the regularities and

334
00:10:48,200 --> 00:10:52,580
so you can get a get a get a count of

335
00:10:50,960 --> 00:10:55,220
how many accounts were making these

336
00:10:52,580 --> 00:10:56,930
events and so this so you can use all

337
00:10:55,220 --> 00:10:58,910
that data to refine it drill at down if

338
00:10:56,930 --> 00:11:00,469
you're gonna try and build a detection

339
00:10:58,910 --> 00:11:02,240
or per this also you want to note as

340
00:11:00,470 --> 00:11:04,490
much noise as possible so we're gonna

341
00:11:02,240 --> 00:11:06,620
try and refine the query a bit and so

342
00:11:04,490 --> 00:11:09,050
we've got our good stuff here or picking

343
00:11:06,620 --> 00:11:09,410
this event and we're taking aim and the

344
00:11:09,050 --> 00:11:12,228
incorrect

345
00:11:09,410 --> 00:11:13,999
5:17 which is our seaport and then we're

346
00:11:12,229 --> 00:11:16,249
filtering out computer accounts so we're

347
00:11:13,999 --> 00:11:18,229
only really interested and basically and

348
00:11:16,249 --> 00:11:20,660
Active Directory domain user accounts

349
00:11:18,229 --> 00:11:23,089
making four seven six names that have

350
00:11:20,660 --> 00:11:25,160
the tech encryption type 17 and we can

351
00:11:23,089 --> 00:11:27,739
see here that that reveals one user in

352
00:11:25,160 --> 00:11:29,539
particular aichi sendou Perry has made

353
00:11:27,739 --> 00:11:31,519
82 of those which is also a non-standard

354
00:11:29,539 --> 00:11:33,169
behavior may indicate a compromise so we

355
00:11:31,519 --> 00:11:35,089
can now compare this internal air and

356
00:11:33,169 --> 00:11:36,978
then have a monitor and real timer in

357
00:11:35,089 --> 00:11:39,019
our environment so to do that and spawn

358
00:11:36,979 --> 00:11:40,849
any time you write a query and you can

359
00:11:39,019 --> 00:11:42,169
save that as a no there so that's what

360
00:11:40,849 --> 00:11:43,879
it's kind of doing here or saving a

361
00:11:42,169 --> 00:11:45,589
Cobra's for certain sites name our

362
00:11:43,879 --> 00:11:47,749
weekend a description for the soft team

363
00:11:45,589 --> 00:11:49,819
to look a look at so they know what's

364
00:11:47,749 --> 00:11:51,019
half of what it means minute fires and

365
00:11:49,819 --> 00:11:52,429
we're going to do it no thresholds off

366
00:11:51,019 --> 00:11:53,839
so you don't want out a layer on every

367
00:11:52,429 --> 00:11:56,029
four seven six nine that happens or

368
00:11:53,839 --> 00:11:57,529
environments are unmanageable so we're

369
00:11:56,029 --> 00:11:59,089
gonna do obviously our environments much

370
00:11:57,529 --> 00:12:01,009
smaller would be enterprise so we're

371
00:11:59,089 --> 00:12:03,139
just gonna alert on at more than three

372
00:12:01,009 --> 00:12:05,149
of these happen and a 60 second period

373
00:12:03,139 --> 00:12:06,919
we're gonna generate a trigger earlier

374
00:12:05,149 --> 00:12:08,659
and that will come up on a trigger alert

375
00:12:06,919 --> 00:12:10,699
dashboard as a high and then that gives

376
00:12:08,659 --> 00:12:12,259
us something to action and you can do

377
00:12:10,699 --> 00:12:13,969
lots of cool stuff West Blanc in terms

378
00:12:12,259 --> 00:12:15,889
of its alert and what it does is Pinner

379
00:12:13,970 --> 00:12:17,479
highlight that's here we can wait for

380
00:12:15,889 --> 00:12:19,789
example have it send an email to stock

381
00:12:17,479 --> 00:12:20,809
at company comm and that means you don't

382
00:12:19,789 --> 00:12:22,249
have to you know certain refresher

383
00:12:20,809 --> 00:12:23,419
dashboard all the thing you can also do

384
00:12:22,249 --> 00:12:25,220
web hooks and things like that and

385
00:12:23,419 --> 00:12:26,600
integrator and his slack you know like a

386
00:12:25,220 --> 00:12:29,569
slight bar that's going out there on

387
00:12:26,600 --> 00:12:31,249
certain things or any other you can have

388
00:12:29,569 --> 00:12:34,069
put the slack or they criticals for

389
00:12:31,249 --> 00:12:35,869
example and then this is what it look

390
00:12:34,069 --> 00:12:37,459
like finally on your alert dashboard

391
00:12:35,869 --> 00:12:38,779
once you can I drill down your layer and

392
00:12:37,459 --> 00:12:40,819
hopefully you're not seeing too many of

393
00:12:38,779 --> 00:12:42,319
them but that's you know what was what

394
00:12:40,819 --> 00:12:43,849
the alert dashboards gonna populate lake

395
00:12:42,319 --> 00:12:45,199
and anything when you view the results

396
00:12:43,850 --> 00:12:46,879
that have led to that'll airplay or not

397
00:12:45,199 --> 00:12:48,789
you know start doing them a bit an

398
00:12:46,879 --> 00:12:51,350
investigation into it

399
00:12:48,789 --> 00:12:53,239
okay so how does the red team keep the

400
00:12:51,350 --> 00:12:54,679
initiative you know because we'll talk

401
00:12:53,239 --> 00:12:56,389
about how the battle is kind of swinging

402
00:12:54,679 --> 00:12:59,478
between blue and red and under in the

403
00:12:56,389 --> 00:13:01,220
captain Mouse so on the endpoint we most

404
00:12:59,479 --> 00:13:03,229
competent red seems announced moving to

405
00:13:01,220 --> 00:13:06,199
c-sharp implants or making use of

406
00:13:03,229 --> 00:13:07,789
c-sharp tooling because allegedly

407
00:13:06,199 --> 00:13:09,559
PowerShell is dead except that actually

408
00:13:07,789 --> 00:13:10,789
we on the red side we still find the

409
00:13:09,559 --> 00:13:12,978
Power Cell is good to go through many

410
00:13:10,789 --> 00:13:14,598
environments we make to reduce the

411
00:13:12,979 --> 00:13:17,329
chance of detection on the endpoints you

412
00:13:14,599 --> 00:13:19,069
know from whether that's from EDR or AV

413
00:13:17,329 --> 00:13:20,919
if people are still running AV we can

414
00:13:19,069 --> 00:13:22,620
sort of make use of like Rubeus which is

415
00:13:20,919 --> 00:13:24,060
basically a sea

416
00:13:22,620 --> 00:13:26,340
implementation of all the kikyo

417
00:13:24,060 --> 00:13:28,290
functionality from gentle QE as made by

418
00:13:26,340 --> 00:13:30,900
a part of ghost pack from inspector ops

419
00:13:28,290 --> 00:13:32,010
and we can use sharp view which is a C

420
00:13:30,900 --> 00:13:35,280
sharp implementation of all the

421
00:13:32,010 --> 00:13:38,460
functional functions from Power View so

422
00:13:35,280 --> 00:13:41,760
we often see again that there's 2002

423
00:13:38,460 --> 00:13:44,490
sorry 2012 r2 or plus so it may be even

424
00:13:41,760 --> 00:13:46,920
2016 or even 2019 if you live in

425
00:13:44,490 --> 00:13:48,390
dangerously domain controllers and you

426
00:13:46,920 --> 00:13:49,740
can carry on replacing domain

427
00:13:48,390 --> 00:13:51,510
controllers with you know more

428
00:13:49,740 --> 00:13:53,070
up-to-date operating systems but at some

429
00:13:51,510 --> 00:13:54,780
point you need to remember to actually

430
00:13:53,070 --> 00:13:56,580
update that the domain functional level

431
00:13:54,780 --> 00:13:58,650
or the forest functional level of your

432
00:13:56,580 --> 00:14:00,000
domain because we often see that if you

433
00:13:58,650 --> 00:14:02,250
aren't raising the domain functional

434
00:14:00,000 --> 00:14:04,440
levels many of the protections granted

435
00:14:02,250 --> 00:14:07,320
by that increase aren't actually taking

436
00:14:04,440 --> 00:14:10,740
effect in your environment so from 2008

437
00:14:07,320 --> 00:14:12,660
course AES rather than a c4 became the

438
00:14:10,740 --> 00:14:14,520
default Perl Kerberos tickets so that's

439
00:14:12,660 --> 00:14:16,230
quite handy from your side on the blue

440
00:14:14,520 --> 00:14:19,410
because you can obviously detect the

441
00:14:16,230 --> 00:14:21,450
usage of our c4 tickets we shouldn't in

442
00:14:19,410 --> 00:14:22,770
theory in theory never be flying around

443
00:14:21,450 --> 00:14:27,690
in your environment that's where you'd

444
00:14:22,770 --> 00:14:30,120
alarm on 0 x1 7 AE s is 0 x1 2 so from

445
00:14:27,690 --> 00:14:31,890
our side and 2 again we try and fit in

446
00:14:30,120 --> 00:14:34,320
because they need a really good way that

447
00:14:31,890 --> 00:14:37,560
blue team's capture is presence of the

448
00:14:34,320 --> 00:14:40,770
abnormal and absence of the normal so if

449
00:14:37,560 --> 00:14:42,869
we start roasting from a incorrect user

450
00:14:40,770 --> 00:14:44,699
context if we fish the recruitment or

451
00:14:42,870 --> 00:14:46,110
something like that or marketing you

452
00:14:44,700 --> 00:14:47,970
know through a macro or hey tier

453
00:14:46,110 --> 00:14:50,130
whatever it happens to be and then we

454
00:14:47,970 --> 00:14:52,350
start roasting across the entire domain

455
00:14:50,130 --> 00:14:54,300
you know for MS sequel it's quite

456
00:14:52,350 --> 00:14:56,940
unlikely in many organizations that that

457
00:14:54,300 --> 00:14:58,439
particular user in HR marketing or some

458
00:14:56,940 --> 00:15:00,240
or finance or something like that would

459
00:14:58,440 --> 00:15:02,190
actually be requesting those tgs's in

460
00:15:00,240 --> 00:15:04,620
normal and normal sort of company

461
00:15:02,190 --> 00:15:07,410
operations so we need to roast carefully

462
00:15:04,620 --> 00:15:09,660
against individual users and against

463
00:15:07,410 --> 00:15:11,760
individual service principle names from

464
00:15:09,660 --> 00:15:13,530
the right user context and helpfully

465
00:15:11,760 --> 00:15:14,580
Rubeus has got all sorts of cool

466
00:15:13,530 --> 00:15:17,160
functionality that we'll go through in a

467
00:15:14,580 --> 00:15:19,100
second to help us pretend that we're in

468
00:15:17,160 --> 00:15:21,449
the right context even if we aren't and

469
00:15:19,100 --> 00:15:23,250
again this is quite important and

470
00:15:21,450 --> 00:15:24,510
because i've been recommending her nice

471
00:15:23,250 --> 00:15:25,710
pins to everybody that i've been

472
00:15:24,510 --> 00:15:28,290
speaking to for the past couple of years

473
00:15:25,710 --> 00:15:30,240
more more people are putting them in so

474
00:15:28,290 --> 00:15:32,550
if we see a honey spin that looks

475
00:15:30,240 --> 00:15:34,980
suspicious you know and it's got a

476
00:15:32,550 --> 00:15:36,359
almost an account name that says just

477
00:15:34,980 --> 00:15:38,459
look at me and then

478
00:15:36,360 --> 00:15:40,500
we discover it was created relatively

479
00:15:38,459 --> 00:15:42,119
recently what we'll do is we'll try and

480
00:15:40,500 --> 00:15:44,310
pull as much information for that where

481
00:15:42,120 --> 00:15:46,019
the user or that services we can then

482
00:15:44,310 --> 00:15:47,550
we'll go back to Ti because red teaming

483
00:15:46,019 --> 00:15:49,079
is an iterative cycle at the surface

484
00:15:47,550 --> 00:15:50,490
cyber kill tree soon as we get new

485
00:15:49,079 --> 00:15:52,290
information like that we'll go back to

486
00:15:50,490 --> 00:15:53,820
the reconnaissance stage so then we'll

487
00:15:52,290 --> 00:15:56,880
get the TI out or carry out additional

488
00:15:53,820 --> 00:15:58,440
threat Intel where we'll work out if we

489
00:15:56,880 --> 00:16:00,959
are trying to roast a particular user

490
00:15:58,440 --> 00:16:03,089
when did that user start at the

491
00:16:00,959 --> 00:16:04,319
organization so for example if we find

492
00:16:03,089 --> 00:16:06,120
somebody's LinkedIn that's a good

493
00:16:04,320 --> 00:16:08,490
example they'll often put their latest

494
00:16:06,120 --> 00:16:10,440
you know their latest jobs and such on

495
00:16:08,490 --> 00:16:12,360
there and if the dates kind of correlate

496
00:16:10,440 --> 00:16:15,089
across so Active Directory when there

497
00:16:12,360 --> 00:16:16,860
are user accounts etc we're created they

498
00:16:15,089 --> 00:16:19,019
sort of helps karmas that it might not

499
00:16:16,860 --> 00:16:22,529
be a honey spin okay let's get some

500
00:16:19,019 --> 00:16:24,750
videos on the go okay so what we've got

501
00:16:22,529 --> 00:16:27,510
up here is posh see two implants on the

502
00:16:24,750 --> 00:16:29,970
right feedback on the left we've got

503
00:16:27,510 --> 00:16:31,500
some fishes here is Jason Perry and we

504
00:16:29,970 --> 00:16:33,810
can see that the domain functional level

505
00:16:31,500 --> 00:16:36,149
and the forest functional level reported

506
00:16:33,810 --> 00:16:37,500
as seven so that's Server 2016 so we

507
00:16:36,149 --> 00:16:39,450
weren't lying when we said its latest in

508
00:16:37,500 --> 00:16:41,100
greatest what we're going to do is we

509
00:16:39,450 --> 00:16:42,959
used sharp view and just get the

510
00:16:41,100 --> 00:16:44,220
information on a particular user you

511
00:16:42,959 --> 00:16:46,619
know so we're not going to try and roast

512
00:16:44,220 --> 00:16:48,690
all users across the domain at once

513
00:16:46,620 --> 00:16:51,329
that's very high threat and we can use

514
00:16:48,690 --> 00:16:52,920
telemetry to detect that yeah when we've

515
00:16:51,329 --> 00:16:54,420
see that we get different types of

516
00:16:52,920 --> 00:16:56,819
hashes return depending on what that

517
00:16:54,420 --> 00:17:08,668
configuration is so we've got this value

518
00:16:56,820 --> 00:17:18,870
here and that changes in smoothing that

519
00:17:08,669 --> 00:17:21,839
changes from that changes depending on

520
00:17:18,869 --> 00:17:24,239
what that setting it is so if you are

521
00:17:21,839 --> 00:17:27,178
supporting aes-256 and one to eight

522
00:17:24,240 --> 00:17:28,980
you'll get a different variation what we

523
00:17:27,179 --> 00:17:31,110
can see here though is with now roasting

524
00:17:28,980 --> 00:17:33,900
Bob chicken okay we can see that we're

525
00:17:31,110 --> 00:17:35,340
receiving a type eighteen ash that's AES

526
00:17:33,900 --> 00:17:37,559
for Bob chicken cause the domain

527
00:17:35,340 --> 00:17:39,750
functional levels so high you can see

528
00:17:37,559 --> 00:17:41,639
though when we roast him using this TGT

529
00:17:39,750 --> 00:17:43,080
Delic flag what that does is it tells

530
00:17:41,640 --> 00:17:46,290
Rubeus to use the current users

531
00:17:43,080 --> 00:17:48,840
impersonation of Jason Perry to request

532
00:17:46,290 --> 00:17:50,220
at eg a TGT from the domain controller

533
00:17:48,840 --> 00:17:51,809
which is obviously config

534
00:17:50,220 --> 00:17:53,760
from constrained delegation because main

535
00:17:51,809 --> 00:17:56,370
control and that it will use that user

536
00:17:53,760 --> 00:17:59,070
context to are still obtain a type 23

537
00:17:56,370 --> 00:18:00,360
hash so it although a yes is enforced at

538
00:17:59,070 --> 00:18:02,428
the domain level with the domain

539
00:18:00,360 --> 00:18:05,908
functional level and on the account we

540
00:18:02,429 --> 00:18:07,830
can still get TGS hashes for individual

541
00:18:05,909 --> 00:18:09,929
users obviously again on the blue side

542
00:18:07,830 --> 00:18:12,780
you can detect that because alright you

543
00:18:09,929 --> 00:18:15,870
shouldn't be really be seeing type 23

544
00:18:12,780 --> 00:18:23,520
rather than type 18 request soon so type

545
00:18:15,870 --> 00:18:31,918
23 is rc4 and type 18 is AES okay let's

546
00:18:23,520 --> 00:18:33,870
move on slightly okay so that's the

547
00:18:31,919 --> 00:18:35,940
first attack Kerberos yeah pretty much

548
00:18:33,870 --> 00:18:37,469
carried out by many actors very

549
00:18:35,940 --> 00:18:39,630
frequently but this is how we can do it

550
00:18:37,470 --> 00:18:41,520
to try and stay below the radar so I'm

551
00:18:39,630 --> 00:18:43,890
constrained delegation we're getting too

552
00:18:41,520 --> 00:18:45,090
much into Kerberos 101 again we can't we

553
00:18:43,890 --> 00:18:46,620
have a problem with Kerberos called the

554
00:18:45,090 --> 00:18:48,270
double hop problem where we can't

555
00:18:46,620 --> 00:18:50,039
authenticate from here into there and

556
00:18:48,270 --> 00:18:52,679
then onwards to there that would be two

557
00:18:50,039 --> 00:18:55,260
hearts one and two so we invented the

558
00:18:52,679 --> 00:18:57,090
concept of delegation so this scenario

559
00:18:55,260 --> 00:18:58,500
here we've got a user's workstation who

560
00:18:57,090 --> 00:19:00,240
wants to login to the web application

561
00:18:58,500 --> 00:19:02,100
and the web application then speaks to

562
00:19:00,240 --> 00:19:04,620
the database server but because we're a

563
00:19:02,100 --> 00:19:07,020
switched on company we don't want all of

564
00:19:04,620 --> 00:19:10,139
the actions taken on the database to be

565
00:19:07,020 --> 00:19:11,730
logged and recorded as the web server we

566
00:19:10,140 --> 00:19:14,850
want to know you know what Joe Bob and

567
00:19:11,730 --> 00:19:17,340
Alice are doing in the database so we

568
00:19:14,850 --> 00:19:19,918
allow the web server to to impersonate

569
00:19:17,340 --> 00:19:21,600
and have permissions delegated to act on

570
00:19:19,919 --> 00:19:23,610
behalf of the user

571
00:19:21,600 --> 00:19:26,189
ok so that's pretty much what one

572
00:19:23,610 --> 00:19:27,719
constrained delegation is I often see

573
00:19:26,190 --> 00:19:29,100
this where people make use of

574
00:19:27,720 --> 00:19:31,020
third-party active directory

575
00:19:29,100 --> 00:19:32,850
administrative tools and so if your

576
00:19:31,020 --> 00:19:34,530
admins aren't happy with are you using

577
00:19:32,850 --> 00:19:36,209
like you know how do Directory users and

578
00:19:34,530 --> 00:19:38,340
computers or you're using some form of

579
00:19:36,210 --> 00:19:40,080
Active Directory orchestration maybe to

580
00:19:38,340 --> 00:19:41,428
tie into your head to HR system like

581
00:19:40,080 --> 00:19:43,139
success factors for example is quite

582
00:19:41,429 --> 00:19:45,030
large that you can have all sorts of

583
00:19:43,140 --> 00:19:46,590
automation off the back of that into

584
00:19:45,030 --> 00:19:48,990
your Active Directory you know you use a

585
00:19:46,590 --> 00:19:51,689
creation of things like that that often

586
00:19:48,990 --> 00:19:54,330
is configured poorly with delegation and

587
00:19:51,690 --> 00:19:57,030
we also see it's quite frequently legacy

588
00:19:54,330 --> 00:19:59,549
exchange and environments have this as

589
00:19:57,030 --> 00:20:01,678
well as every instance where a company

590
00:19:59,549 --> 00:20:02,820
has had Blackberry services and you know

591
00:20:01,679 --> 00:20:04,249
in the good old days while black where

592
00:20:02,820 --> 00:20:06,718
your sort of thing

593
00:20:04,249 --> 00:20:08,999
so to actually say from the blue side

594
00:20:06,719 --> 00:20:10,649
how do I trip very quickly check again

595
00:20:08,999 --> 00:20:13,320
credit to a Shore Metcalf down here

596
00:20:10,649 --> 00:20:14,699
saves me typing all this out so if you

597
00:20:13,320 --> 00:20:16,859
just open a PS session from a domain

598
00:20:14,700 --> 00:20:18,899
user context import Li Active Directory

599
00:20:16,859 --> 00:20:20,279
commandlets which again all digitally

600
00:20:18,899 --> 00:20:22,258
Sciences they don't need any elevated

601
00:20:20,279 --> 00:20:24,629
permissions there and run this query

602
00:20:22,259 --> 00:20:26,369
here this will go across to your entire

603
00:20:24,629 --> 00:20:29,189
Active Directory and quickly tell you

604
00:20:26,369 --> 00:20:31,379
whether if this flag is true your that

605
00:20:29,190 --> 00:20:32,999
particular account is configured for

606
00:20:31,379 --> 00:20:35,099
unconstrained delegation so

607
00:20:32,999 --> 00:20:37,859
unconstrained delegation means that you

608
00:20:35,099 --> 00:20:39,479
can impersonate any user to any service

609
00:20:37,859 --> 00:20:41,639
that's kind of the Kerberos input

610
00:20:39,479 --> 00:20:43,109
equivalent of any any you know and we'll

611
00:20:41,639 --> 00:20:44,998
get on to why that's a bad thing in a

612
00:20:43,109 --> 00:20:47,218
minute if you see that this field is

613
00:20:44,999 --> 00:20:49,830
false that means it's configured for

614
00:20:47,219 --> 00:20:51,419
constrained delegation highly restricted

615
00:20:49,830 --> 00:20:55,080
the user context or you've restricted

616
00:20:51,419 --> 00:20:56,669
the service context this is a side by

617
00:20:55,080 --> 00:20:59,249
side to say hey this is how you guys

618
00:20:56,669 --> 00:21:01,589
should be doing it use Kerberos only and

619
00:20:59,249 --> 00:21:04,289
say we can only use this particular

620
00:21:01,589 --> 00:21:07,019
service or this computer but the note

621
00:21:04,289 --> 00:21:09,269
that says user or computer and always on

622
00:21:07,019 --> 00:21:10,769
this side this is a sort of the Yolo

623
00:21:09,269 --> 00:21:12,929
approach you know the the any-any

624
00:21:10,769 --> 00:21:15,599
approach of we can we can delegate to

625
00:21:12,929 --> 00:21:20,219
any services any user it's it's a bold

626
00:21:15,599 --> 00:21:21,869
architectural decision to be making okay

627
00:21:20,219 --> 00:21:23,940
so let's say let's do a little bit of an

628
00:21:21,869 --> 00:21:26,009
attack in like actually taking taking

629
00:21:23,940 --> 00:21:27,839
this giving us some additional accesses

630
00:21:26,009 --> 00:21:29,129
the current scenario cuz I'm a conscious

631
00:21:27,839 --> 00:21:31,559
not everybody familiar with the whole c2

632
00:21:29,129 --> 00:21:33,209
concept we have system access on a

633
00:21:31,559 --> 00:21:35,210
machine that is configured for

634
00:21:33,210 --> 00:21:38,219
unconstrained delegation and in this

635
00:21:35,210 --> 00:21:41,399
implementation it's Windows Server 2016

636
00:21:38,219 --> 00:21:43,619
- s1 that's the hostname the aim for

637
00:21:41,399 --> 00:21:46,139
what we're doing here is to use the

638
00:21:43,619 --> 00:21:48,658
printer book demo device backdrops at

639
00:21:46,139 --> 00:21:50,908
Derby con last year and what we do here

640
00:21:48,659 --> 00:21:53,190
is we curse a domain controller with the

641
00:21:50,909 --> 00:21:56,309
principle they're running and we look

642
00:21:53,190 --> 00:21:58,440
for printer updates you know using MSRP

643
00:21:56,309 --> 00:22:00,089
ste calls what we do there is we don't

644
00:21:58,440 --> 00:22:02,639
encourage the domain controller to

645
00:22:00,089 --> 00:22:04,769
authenticate to the server that we have

646
00:22:02,639 --> 00:22:06,658
unconstrained delegation on because we

647
00:22:04,769 --> 00:22:08,759
are system we can then dump out

648
00:22:06,659 --> 00:22:10,889
TG T's and in effect we've now got the

649
00:22:08,759 --> 00:22:12,779
TGT the ticket granting ticket a large

650
00:22:10,889 --> 00:22:14,820
basically for blob of the domain

651
00:22:12,779 --> 00:22:16,740
controller computer account and that's

652
00:22:14,820 --> 00:22:18,570
obviously exceptionally powerful in

653
00:22:16,740 --> 00:22:20,400
Active Directory environment this has

654
00:22:18,570 --> 00:22:21,629
actually been patched Microsoft have

655
00:22:20,400 --> 00:22:24,360
made a couple of changes now is there

656
00:22:21,630 --> 00:22:26,160
any new delegations and new forest

657
00:22:24,360 --> 00:22:28,199
boundaries because we can jump across to

658
00:22:26,160 --> 00:22:31,110
forest boundaries here which is a new

659
00:22:28,200 --> 00:22:32,429
concept is actually any new forest

660
00:22:31,110 --> 00:22:34,320
boundaries from this month if you've

661
00:22:32,429 --> 00:22:36,420
applied this patch for this won't

662
00:22:34,320 --> 00:22:37,439
supports this my personal prediction

663
00:22:36,420 --> 00:22:39,090
having been an admin in an

664
00:22:37,440 --> 00:22:41,640
Intercontinental organization we're not

665
00:22:39,090 --> 00:22:43,860
Voyager on the army this is unlikely to

666
00:22:41,640 --> 00:22:46,140
be implemented that quickly simply at

667
00:22:43,860 --> 00:22:47,719
the fear factor of breaking across realm

668
00:22:46,140 --> 00:22:49,920
authentication in a massive business

669
00:22:47,720 --> 00:22:51,600
massive businesses don't tend not to run

670
00:22:49,920 --> 00:22:52,290
that quickly in terms of change at the

671
00:22:51,600 --> 00:22:55,080
best of times

672
00:22:52,290 --> 00:22:56,490
so as we say we can jump across forest

673
00:22:55,080 --> 00:22:59,040
boundaries so since I've been doing

674
00:22:56,490 --> 00:23:01,080
computers the domain has always been the

675
00:22:59,040 --> 00:23:02,670
security never been the security

676
00:23:01,080 --> 00:23:04,439
boundary sorry it's always been the

677
00:23:02,670 --> 00:23:06,870
forest but now as we'll see we'll be

678
00:23:04,440 --> 00:23:08,190
going across forest boundaries probably

679
00:23:06,870 --> 00:23:10,229
worth me saying this is the first time

680
00:23:08,190 --> 00:23:12,210
this has ever been devoted posh see - so

681
00:23:10,230 --> 00:23:14,010
thanks very much - then for getting this

682
00:23:12,210 --> 00:23:17,730
working and thanks for our to be - the

683
00:23:14,010 --> 00:23:20,670
attempt so what we've got here we've got

684
00:23:17,730 --> 00:23:23,190
some shells on shell 103

685
00:23:20,670 --> 00:23:24,330
yeah which is Windows Server and what

686
00:23:23,190 --> 00:23:26,700
we're doing we're opening up a patched

687
00:23:24,330 --> 00:23:29,428
version of Rubeus that should work in

688
00:23:26,700 --> 00:23:31,500
Pasha - we'll push this out soon we're

689
00:23:29,429 --> 00:23:34,140
saying - Rubeus hey just monitor every

690
00:23:31,500 --> 00:23:37,800
three seconds from when the block lor DC

691
00:23:34,140 --> 00:23:39,540
computer account authenticates - now

692
00:23:37,800 --> 00:23:42,360
we'll zip over to this shell which is

693
00:23:39,540 --> 00:23:43,950
Jason Perry he's a low privileged user

694
00:23:42,360 --> 00:23:45,719
and you'll note he is in a different

695
00:23:43,950 --> 00:23:49,080
forest you know there are forest trust

696
00:23:45,720 --> 00:23:50,760
between the two that not domain will now

697
00:23:49,080 --> 00:23:52,949
use a past version of the spool sample

698
00:23:50,760 --> 00:23:53,790
proof of concept from forget the

699
00:23:52,950 --> 00:23:55,530
gentleman's name I think it's

700
00:23:53,790 --> 00:23:57,840
Christensen personally Lee Christensen

701
00:23:55,530 --> 00:23:59,940
or something and we'll now in cut entice

702
00:23:57,840 --> 00:24:02,939
law domain controller to authenticate to

703
00:23:59,940 --> 00:24:04,530
us and then using rubyists in monitor we

704
00:24:02,940 --> 00:24:06,780
now extract it so you can see we've got

705
00:24:04,530 --> 00:24:07,500
the computer account here applause the

706
00:24:06,780 --> 00:24:10,050
main controller

707
00:24:07,500 --> 00:24:11,580
so this is absolutely game on from the

708
00:24:10,050 --> 00:24:12,780
effect side at this point you're

709
00:24:11,580 --> 00:24:17,010
probably getting close to rebuilding

710
00:24:12,780 --> 00:24:19,050
your forest ok so we've got this basic

711
00:24:17,010 --> 00:24:21,080
t4 blob now we need to do something with

712
00:24:19,050 --> 00:24:21,080
it

713
00:24:21,380 --> 00:24:27,450
okay so again pasting into Jason's no

714
00:24:24,809 --> 00:24:30,330
privilege user context implant 104 we

715
00:24:27,450 --> 00:24:32,700
paste in that large base64 ticket and

716
00:24:30,330 --> 00:24:34,529
Rubeus supplies it covers excellent so

717
00:24:32,700 --> 00:24:37,049
this will apply to all implants of all

718
00:24:34,529 --> 00:24:39,179
logins that Jason currently house you

719
00:24:37,049 --> 00:24:41,340
now we can just approve that we have

720
00:24:39,179 --> 00:24:44,549
allocated access we're now just going to

721
00:24:41,340 --> 00:24:47,519
DC sync in a across from Digital

722
00:24:44,549 --> 00:24:50,190
Solutions forest one across the forest

723
00:24:47,519 --> 00:24:53,159
boundary into blur Bank and DC sync the

724
00:24:50,190 --> 00:24:54,840
youth have been the purposes of this Ben

725
00:24:53,159 --> 00:24:56,970
is an enterprise admin but actually the

726
00:24:54,840 --> 00:24:58,860
fact that you have privileges to TCC is

727
00:24:56,970 --> 00:25:01,610
indicative of you could DC sync

728
00:24:58,860 --> 00:25:03,899
anybody's ntlm password that you needed

729
00:25:01,610 --> 00:25:05,879
maybe cats helpfully takes quite a while

730
00:25:03,899 --> 00:25:07,229
to come back rather than you guys

731
00:25:05,880 --> 00:25:09,269
looking at a blank screen if Minnie

732
00:25:07,230 --> 00:25:12,799
counts the 30 meter 35 seconds or so

733
00:25:09,269 --> 00:25:15,059
just trust me it comes back okay so

734
00:25:12,799 --> 00:25:17,639
we've been like working on this tour you

735
00:25:15,059 --> 00:25:19,019
know for a fair old time now and I think

736
00:25:17,639 --> 00:25:21,899
it's probably a fair assumption to say

737
00:25:19,019 --> 00:25:25,070
that detecting unconstrained delegation

738
00:25:21,899 --> 00:25:27,899
of Bruce have you sorry is non-trivial

739
00:25:25,070 --> 00:25:29,399
Robb's sorry Ross is pretty good at this

740
00:25:27,899 --> 00:25:31,260
whole career hunting thing and as is

741
00:25:29,399 --> 00:25:33,178
spectral ops who invented the concept of

742
00:25:31,260 --> 00:25:35,220
it we're still struggling to get really

743
00:25:33,179 --> 00:25:36,570
really reliable as scale detections

744
00:25:35,220 --> 00:25:39,149
depending on the level of visibility

745
00:25:36,570 --> 00:25:40,950
you've got currently however we can do a

746
00:25:39,149 --> 00:25:42,959
little bit about it as admins as you

747
00:25:40,950 --> 00:25:46,010
know as the security community if you

748
00:25:42,960 --> 00:25:48,210
cannot remove this functionality and

749
00:25:46,010 --> 00:25:50,639
because you've got monstrous technical

750
00:25:48,210 --> 00:25:53,010
debt that's okay but I guarantee there's

751
00:25:50,639 --> 00:25:54,689
probably a very very high chance you can

752
00:25:53,010 --> 00:25:57,450
reconfigure to use constrained

753
00:25:54,690 --> 00:25:59,309
delegation you know so authenticate to

754
00:25:57,450 --> 00:26:00,899
particular services has particularly

755
00:25:59,309 --> 00:26:03,510
users we don't need the Kerberos

756
00:26:00,899 --> 00:26:05,189
equivalent of any any the other side we

757
00:26:03,510 --> 00:26:06,960
can do is actually force your vendors to

758
00:26:05,190 --> 00:26:08,730
act like you control this you're the

759
00:26:06,960 --> 00:26:09,899
buying community yeah if your vendors

760
00:26:08,730 --> 00:26:11,340
are saying hey we need on constrained

761
00:26:09,899 --> 00:26:13,918
delegation to make our software works

762
00:26:11,340 --> 00:26:16,799
get better software my generally is that

763
00:26:13,919 --> 00:26:19,679
simple we often see again the IT

764
00:26:16,799 --> 00:26:22,019
administrators or service accounts etc

765
00:26:19,679 --> 00:26:24,179
they have higher privilege within the

766
00:26:22,019 --> 00:26:27,059
environment but because Security's

767
00:26:24,179 --> 00:26:29,370
inconvenience we often find that they

768
00:26:27,059 --> 00:26:31,350
have less security control you know and

769
00:26:29,370 --> 00:26:33,090
so like administer are doing tiered

770
00:26:31,350 --> 00:26:34,830
administrative accounts we often find

771
00:26:33,090 --> 00:26:36,299
that elevated accounts that you use for

772
00:26:34,830 --> 00:26:38,010
workstation administration or server

773
00:26:36,299 --> 00:26:39,539
administration or domain administration

774
00:26:38,010 --> 00:26:41,370
they're actually still permitted onto

775
00:26:39,539 --> 00:26:42,840
the internet through the proxy on

776
00:26:41,370 --> 00:26:43,639
through group policy and all that great

777
00:26:42,840 --> 00:26:45,050
stuff

778
00:26:43,640 --> 00:26:47,150
having all those privileges restricted

779
00:26:45,050 --> 00:26:49,310
so if we are having to use these things

780
00:26:47,150 --> 00:26:50,690
know that they are a greater attached

781
00:26:49,310 --> 00:26:52,790
service and because they have higher

782
00:26:50,690 --> 00:26:55,190
privileges subject them to even more

783
00:26:52,790 --> 00:26:57,889
security than your normal users or your

784
00:26:55,190 --> 00:26:59,240
normal admin account depending on the

785
00:26:57,890 --> 00:27:01,220
visibility you've got in all of your

786
00:26:59,240 --> 00:27:03,350
forests and we'll come on to that in a

787
00:27:01,220 --> 00:27:04,760
little bit more you can actually monitor

788
00:27:03,350 --> 00:27:07,129
for this security event on the

789
00:27:04,760 --> 00:27:08,810
unconstrained server but again you're

790
00:27:07,130 --> 00:27:11,150
going to need really really granular

791
00:27:08,810 --> 00:27:12,639
visibility at this point and Russell in

792
00:27:11,150 --> 00:27:14,420
creeper touch on that in a little bit

793
00:27:12,640 --> 00:27:16,190
prosecutor for the court quickly for

794
00:27:14,420 --> 00:27:17,990
that yeah so one thing you can do is

795
00:27:16,190 --> 00:27:20,960
monitor for a said pillar in events

796
00:27:17,990 --> 00:27:23,330
which is the four six it's for 675 and

797
00:27:20,960 --> 00:27:25,250
and Bella Furness said which is

798
00:27:23,330 --> 00:27:26,840
Enterprise domain controller and so just

799
00:27:25,250 --> 00:27:28,640
quickly sure what that looks like here

800
00:27:26,840 --> 00:27:30,050
and so I guess yeah I'm just gonna add

801
00:27:28,640 --> 00:27:31,520
to what Mac said right we'll have a

802
00:27:30,050 --> 00:27:34,840
challenge in the red team who doesn't

803
00:27:31,520 --> 00:27:38,090
and so we wanted to try and look into

804
00:27:34,840 --> 00:27:40,220
the challenge of you have one you know

805
00:27:38,090 --> 00:27:41,750
domain and them in bed there's no

806
00:27:40,220 --> 00:27:42,800
solutions there's you know all well

807
00:27:41,750 --> 00:27:44,270
configured you'll get really good

808
00:27:42,800 --> 00:27:46,399
visibility in it but maybe you've got

809
00:27:44,270 --> 00:27:47,720
you know a secondary domain and another

810
00:27:46,400 --> 00:27:49,010
country or whatever that's maybe not

811
00:27:47,720 --> 00:27:51,320
quite as secure that you don't have

812
00:27:49,010 --> 00:27:53,390
visible in to it's not uncommon for us

813
00:27:51,320 --> 00:27:54,770
to see that and so when you're only seen

814
00:27:53,390 --> 00:27:56,990
half the Petra how are you gonna try and

815
00:27:54,770 --> 00:27:58,940
detect this turns out it's pretty

816
00:27:56,990 --> 00:28:00,620
difficult and to be honest and you

817
00:27:58,940 --> 00:28:02,420
really want to see everything on both

818
00:28:00,620 --> 00:28:04,070
sides so that's why centralized logging

819
00:28:02,420 --> 00:28:06,500
things that are super important across

820
00:28:04,070 --> 00:28:07,939
all your forests and so just a quick

821
00:28:06,500 --> 00:28:09,770
run-through here we're looking for for

822
00:28:07,940 --> 00:28:11,720
sex of the pipe and said and we're

823
00:28:09,770 --> 00:28:13,820
looking for other failures and this said

824
00:28:11,720 --> 00:28:15,740
and that gives us more it for events and

825
00:28:13,820 --> 00:28:17,510
in the last eight days so it's quite a

826
00:28:15,740 --> 00:28:19,220
low amount but the thing is you just

827
00:28:17,510 --> 00:28:20,540
kind of need to like basically monitor

828
00:28:19,220 --> 00:28:21,830
these this might be normal traffic

829
00:28:20,540 --> 00:28:26,180
career environment if you've got a lock

830
00:28:21,830 --> 00:28:28,370
in a a cross forest a pen occasionally

831
00:28:26,180 --> 00:28:29,990
that happen it may not be and you can

832
00:28:28,370 --> 00:28:31,340
obviously use telemetry detection so if

833
00:28:29,990 --> 00:28:33,260
you maybe only have like one of these a

834
00:28:31,340 --> 00:28:36,050
week year and it suddenly get more that

835
00:28:33,260 --> 00:28:37,070
could be an indicator and so that's kind

836
00:28:36,050 --> 00:28:39,110
of like think you want to start looking

837
00:28:37,070 --> 00:28:40,879
up really and thinking about its what's

838
00:28:39,110 --> 00:28:44,360
normal for environment and then go from

839
00:28:40,880 --> 00:28:48,110
there and another one you can do as well

840
00:28:44,360 --> 00:28:51,469
as look for air just delegate well

841
00:28:48,110 --> 00:28:52,939
within a wild card appear and but you're

842
00:28:51,470 --> 00:28:55,760
looking for basically events that have

843
00:28:52,940 --> 00:28:56,600
the correlated delegation privileges so

844
00:28:55,760 --> 00:28:58,340
you can

845
00:28:56,600 --> 00:29:00,169
Splunk those things don't look up piles

846
00:28:58,340 --> 00:29:02,600
and when there's basically CSV files and

847
00:29:00,170 --> 00:29:04,460
you can see only these accounts and NS

848
00:29:02,600 --> 00:29:06,770
CSV should ever be able to do a

849
00:29:04,460 --> 00:29:08,270
delegation so you can monitor for any

850
00:29:06,770 --> 00:29:10,340
accounts not on that list

851
00:29:08,270 --> 00:29:11,870
there are some are magically starting to

852
00:29:10,340 --> 00:29:13,760
do a delegation or in the delegation

853
00:29:11,870 --> 00:29:15,409
privilege and that might be an indicator

854
00:29:13,760 --> 00:29:20,480
of compromise something you can look at

855
00:29:15,410 --> 00:29:22,430
well okay so from the red team's ID we

856
00:29:20,480 --> 00:29:24,890
if we've got access to this technique we

857
00:29:22,430 --> 00:29:27,200
need to abide detection from Ross we've

858
00:29:24,890 --> 00:29:28,580
said it is quite hard to do but we need

859
00:29:27,200 --> 00:29:30,500
to assume that if we are making use of

860
00:29:28,580 --> 00:29:32,360
the technique we will leave a footprint

861
00:29:30,500 --> 00:29:34,250
somewhere we need to operate on the on

862
00:29:32,360 --> 00:29:36,649
the assumption that the blue team will

863
00:29:34,250 --> 00:29:39,260
eventually start investigating us based

864
00:29:36,650 --> 00:29:42,290
on what we've just done so it is tough

865
00:29:39,260 --> 00:29:44,900
to detect and but we say most of the

866
00:29:42,290 --> 00:29:46,310
detection is come from telemetry you

867
00:29:44,900 --> 00:29:48,590
know understanding what normal looks

868
00:29:46,310 --> 00:29:50,510
like your environment again not a huge

869
00:29:48,590 --> 00:29:52,879
amount of organizations actually have an

870
00:29:50,510 --> 00:29:54,080
idea of what normal is certainly not at

871
00:29:52,880 --> 00:29:55,520
the layer seven there's or Active

872
00:29:54,080 --> 00:29:57,590
Directory layer most people are still

873
00:29:55,520 --> 00:30:00,700
struggling with what is normal IPE comms

874
00:29:57,590 --> 00:30:02,780
in my environment at layer 3 so we use

875
00:30:00,700 --> 00:30:04,610
privileges that we've gained in a manner

876
00:30:02,780 --> 00:30:06,560
similar to this to diversify and I'll

877
00:30:04,610 --> 00:30:09,740
just touch on what diversification or

878
00:30:06,560 --> 00:30:11,360
removing attribution is so as the red

879
00:30:09,740 --> 00:30:13,250
team we can control quite a lot of

880
00:30:11,360 --> 00:30:14,800
variables whether that's there are the

881
00:30:13,250 --> 00:30:18,230
things that are on the next slide

882
00:30:14,800 --> 00:30:19,879
yeah so we control these a lot there is

883
00:30:18,230 --> 00:30:22,490
just a small subset of the variables we

884
00:30:19,880 --> 00:30:24,500
control at any time that we do something

885
00:30:22,490 --> 00:30:26,660
that we're concerned will generate a

886
00:30:24,500 --> 00:30:28,210
significant footprint or potentially

887
00:30:26,660 --> 00:30:31,310
lead to a detection and then a response

888
00:30:28,210 --> 00:30:33,740
we need to diversify as many of these as

889
00:30:31,310 --> 00:30:35,330
possible whether that's the situ URLs

890
00:30:33,740 --> 00:30:36,740
that we're using you know obviously

891
00:30:35,330 --> 00:30:37,790
we're making use of domain fronting

892
00:30:36,740 --> 00:30:39,620
across the CD ends

893
00:30:37,790 --> 00:30:42,320
we are not going direct to individual

894
00:30:39,620 --> 00:30:43,790
domains and if we are using fronting

895
00:30:42,320 --> 00:30:46,220
providers like a content delivery

896
00:30:43,790 --> 00:30:50,090
network like wild runs as your Akamai

897
00:30:46,220 --> 00:30:52,010
lastly or our Alibaba you know we need

898
00:30:50,090 --> 00:30:53,629
to diversify those because it's very

899
00:30:52,010 --> 00:30:56,000
easy for an organization to detect a

900
00:30:53,630 --> 00:30:57,800
small indicator of compromise that users

901
00:30:56,000 --> 00:30:59,750
say cloud funds and then just quickly

902
00:30:57,800 --> 00:31:02,270
grab through their proxy logs zooming

903
00:30:59,750 --> 00:31:04,910
the Gottlob for all all connections

904
00:31:02,270 --> 00:31:06,710
directly to cloud from execution method

905
00:31:04,910 --> 00:31:09,200
and whether that is you know dropping

906
00:31:06,710 --> 00:31:10,220
using run dll or running an axial

907
00:31:09,200 --> 00:31:12,200
whatever it happens to be

908
00:31:10,220 --> 00:31:13,970
there is a big a big feeling in the

909
00:31:12,200 --> 00:31:15,650
security community that we always need

910
00:31:13,970 --> 00:31:19,400
to remain entirely in memory and never

911
00:31:15,650 --> 00:31:21,049
touch disk and we routinely touch disk

912
00:31:19,400 --> 00:31:22,549
where appropriate and where I would say

913
00:31:21,049 --> 00:31:25,158
that our objective achievement rates are

914
00:31:22,549 --> 00:31:26,418
still pretty damn good a good a good

915
00:31:25,159 --> 00:31:29,240
example here is the lateral movement

916
00:31:26,419 --> 00:31:31,250
method so for example if we've made WMI

917
00:31:29,240 --> 00:31:33,260
is the norm in the environment or you WI

918
00:31:31,250 --> 00:31:35,240
to move let's move from one block to the

919
00:31:33,260 --> 00:31:37,220
other you know if we're using decom and

920
00:31:35,240 --> 00:31:38,600
we're not using MMC 22 move left and

921
00:31:37,220 --> 00:31:41,000
right across the network because it's

922
00:31:38,600 --> 00:31:42,649
very loud we're using a decon method you

923
00:31:41,000 --> 00:31:44,600
know we'll move maybe move to W in mind

924
00:31:42,650 --> 00:31:46,820
or we use F ups exactly is used by the

925
00:31:44,600 --> 00:31:48,709
admins will use pearce exact so it's all

926
00:31:46,820 --> 00:31:51,230
about diversification to remove as many

927
00:31:48,710 --> 00:31:53,630
towels between attack chain and access

928
00:31:51,230 --> 00:31:55,970
chain one and the tap gain access chain

929
00:31:53,630 --> 00:31:57,530
two you know so if we are dropping files

930
00:31:55,970 --> 00:31:59,270
to disk you know we're putting them in

931
00:31:57,530 --> 00:32:01,309
you know C temp but we're going to maybe

932
00:31:59,270 --> 00:32:03,139
move to app data oh you know or we might

933
00:32:01,309 --> 00:32:06,110
move to startup or you will move to a

934
00:32:03,140 --> 00:32:09,049
different location and again if we make

935
00:32:06,110 --> 00:32:11,178
the decision to use a golden ticket as a

936
00:32:09,049 --> 00:32:12,950
result of the unconstrained delegation I

937
00:32:11,179 --> 00:32:14,539
would caveat up with will go through the

938
00:32:12,950 --> 00:32:16,610
safety considerations for golden ticket

939
00:32:14,539 --> 00:32:18,799
generation in the moments we know that

940
00:32:16,610 --> 00:32:20,389
no large organization ie someone who's

941
00:32:18,799 --> 00:32:22,250
mature enough to be doing red teaming is

942
00:32:20,390 --> 00:32:24,770
that they're not going to rotate the

943
00:32:22,250 --> 00:32:26,960
krbtgt password the god mode of cope

944
00:32:24,770 --> 00:32:28,940
Kerberos password with the double tap

945
00:32:26,960 --> 00:32:30,740
very fast at all because it will break

946
00:32:28,940 --> 00:32:32,929
an awful lot of things across the

947
00:32:30,740 --> 00:32:34,880
environment so we need we know that our

948
00:32:32,929 --> 00:32:36,250
other loop which is the ability for the

949
00:32:34,880 --> 00:32:38,510
red team to observe the situation

950
00:32:36,250 --> 00:32:41,210
orientate this himself to the situation

951
00:32:38,510 --> 00:32:43,190
make a decision and then act it spins

952
00:32:41,210 --> 00:32:44,330
very quickly because we are on the phone

953
00:32:43,190 --> 00:32:46,370
or in the same room as each other

954
00:32:44,330 --> 00:32:48,379
whereas I know that the blue team's who

955
00:32:46,370 --> 00:32:50,750
de loop is distinctly slower because you

956
00:32:48,380 --> 00:32:52,610
have changed management or you have poor

957
00:32:50,750 --> 00:32:53,750
appetite for risk in such an poor

958
00:32:52,610 --> 00:32:55,789
appetite for lack of availability

959
00:32:53,750 --> 00:32:57,530
services just another note on the

960
00:32:55,789 --> 00:32:59,450
detection though the things as well and

961
00:32:57,530 --> 00:33:00,830
one of the problems are well benefits I

962
00:32:59,450 --> 00:33:02,990
guess of way things like gosh cheaters

963
00:33:00,830 --> 00:33:05,418
we're able to use assembly Lord - Lord

964
00:33:02,990 --> 00:33:07,190
binaries enter memory and run them so I

965
00:33:05,419 --> 00:33:08,990
can technical detection may be looking

966
00:33:07,190 --> 00:33:10,730
for reduced or exceed being dropped a

967
00:33:08,990 --> 00:33:12,590
desk or this full sample being dropped

968
00:33:10,730 --> 00:33:14,330
the desk and run or maybe the fail hash

969
00:33:12,590 --> 00:33:15,649
of those binaries obviously that's not

970
00:33:14,330 --> 00:33:17,689
going to get detectives when you're

971
00:33:15,650 --> 00:33:19,460
doing things and memory and flash is

972
00:33:17,690 --> 00:33:21,890
something to be aware of as well and

973
00:33:19,460 --> 00:33:23,870
what other thing is network connections

974
00:33:21,890 --> 00:33:26,330
the IPC dollar and your DC's

975
00:33:23,870 --> 00:33:27,709
again the problem there is cross forest

976
00:33:26,330 --> 00:33:29,179
if you want full visibility on both

977
00:33:27,710 --> 00:33:32,540
sides you're not necessarily gonna be

978
00:33:29,180 --> 00:33:33,680
able to see that okay so that's the

979
00:33:32,540 --> 00:33:35,450
second attack that we've covered off

980
00:33:33,680 --> 00:33:38,510
let's talk about the third one the

981
00:33:35,450 --> 00:33:40,340
golden ticket so a bit of a tldr what a

982
00:33:38,510 --> 00:33:42,230
golden ticket is it's a ticket that you

983
00:33:40,340 --> 00:33:45,649
create into which you guarantee yourself

984
00:33:42,230 --> 00:33:47,900
group memberships or privileges etc and

985
00:33:45,650 --> 00:33:50,600
then it is signed with the ntlm hash of

986
00:33:47,900 --> 00:33:52,690
krbtgt and if you don't sign your ticket

987
00:33:50,600 --> 00:33:54,889
and whatever service you were

988
00:33:52,690 --> 00:33:56,990
authenticate to well it will know that

989
00:33:54,890 --> 00:33:58,640
it isn't from the KDC he distribution

990
00:33:56,990 --> 00:34:00,559
center and thus will not allow you

991
00:33:58,640 --> 00:34:02,360
access that service and he's caveat

992
00:34:00,559 --> 00:34:04,580
that's with my personal opinion that

993
00:34:02,360 --> 00:34:06,050
this is an extremely risky attack we're

994
00:34:04,580 --> 00:34:08,270
here to be doing red teaming is here to

995
00:34:06,050 --> 00:34:09,980
reduce risk in organizations what we are

996
00:34:08,270 --> 00:34:11,918
doing here is in effect grunting

997
00:34:09,980 --> 00:34:14,360
somebody the ultimate keys to the castle

998
00:34:11,918 --> 00:34:16,250
latitude have been doing sort of red

999
00:34:14,360 --> 00:34:18,200
teaming five years and say well

1000
00:34:16,250 --> 00:34:20,629
objectives getting to our objective is

1001
00:34:18,199 --> 00:34:22,730
exceptional and we've never had to do it

1002
00:34:20,629 --> 00:34:23,929
but I'm aware that many Reds even sort

1003
00:34:22,730 --> 00:34:25,550
of consider it like an operating

1004
00:34:23,929 --> 00:34:26,659
procedure just in case they do get

1005
00:34:25,550 --> 00:34:29,240
kicked out they can just elevate their

1006
00:34:26,659 --> 00:34:31,100
access from a single fish again but I

1007
00:34:29,239 --> 00:34:34,638
will go through a couple of safety

1008
00:34:31,100 --> 00:34:36,469
habits as well so what we're going to do

1009
00:34:34,639 --> 00:34:39,500
here is at this point we've popped the

1010
00:34:36,469 --> 00:34:41,089
domain and we are domain up in very it's

1011
00:34:39,500 --> 00:34:42,469
not certain that we actually need to pop

1012
00:34:41,090 --> 00:34:44,000
the means to achieve our objectives on

1013
00:34:42,469 --> 00:34:45,739
the red team the you know the domain is

1014
00:34:44,000 --> 00:34:47,810
quite rarely the objective it's an

1015
00:34:45,739 --> 00:34:49,339
usually a critical economic function or

1016
00:34:47,810 --> 00:34:51,949
something similar so here we can just

1017
00:34:49,340 --> 00:34:53,810
see we've got an account of MJ hashes so

1018
00:34:51,949 --> 00:34:56,029
he's got no special group memberships no

1019
00:34:53,810 --> 00:34:58,430
privileges no skills he's largely

1020
00:34:56,030 --> 00:35:01,070
irrelevant to us but what we can do is

1021
00:34:58,430 --> 00:35:05,359
we can submit a golden ticket as we do

1022
00:35:01,070 --> 00:35:08,840
here using mini cats in PS v2 or we can

1023
00:35:05,360 --> 00:35:11,930
use tools in c-sharp to do similar we

1024
00:35:08,840 --> 00:35:14,390
submit this golden ticket into mark into

1025
00:35:11,930 --> 00:35:15,890
MJ hashes current session and what we're

1026
00:35:14,390 --> 00:35:19,069
giving him here is elevated rights and

1027
00:35:15,890 --> 00:35:21,680
give me ID home 500 a dick adding in

1028
00:35:19,070 --> 00:35:23,870
additional sit we can see here and the

1029
00:35:21,680 --> 00:35:25,129
additional group membership story so we

1030
00:35:23,870 --> 00:35:27,740
can see that this golden ticket is

1031
00:35:25,130 --> 00:35:30,170
successfully submitted what we've made

1032
00:35:27,740 --> 00:35:32,899
here is MJ hashes is for all intents and

1033
00:35:30,170 --> 00:35:34,880
purposes enterprise admin what we'll do

1034
00:35:32,900 --> 00:35:37,270
now is just to prove that you know he is

1035
00:35:34,880 --> 00:35:39,010
actually got elevated permissions is

1036
00:35:37,270 --> 00:35:40,930
mimic cats just a DC sync again just as

1037
00:35:39,010 --> 00:35:43,090
a prequel calm dead that he is he now

1038
00:35:40,930 --> 00:35:45,339
does have those elevated missions on the

1039
00:35:43,090 --> 00:35:49,140
movie cats ticket we did submit this via

1040
00:35:45,340 --> 00:35:52,360
TV strikes here start offset end and the

1041
00:35:49,140 --> 00:35:53,740
lifetime of the ticket so by default new

1042
00:35:52,360 --> 00:35:55,210
me Kaplan will change lots of these to

1043
00:35:53,740 --> 00:35:58,390
ten years exceptionally loud

1044
00:35:55,210 --> 00:36:00,550
exceptionally risky so we're making MJ

1045
00:35:58,390 --> 00:36:01,779
hashes enterprise admin for up to ten

1046
00:36:00,550 --> 00:36:03,310
years as long as this current logon

1047
00:36:01,780 --> 00:36:05,680
session and his Kerberos tickets aren't

1048
00:36:03,310 --> 00:36:07,480
purged quite dangerous so we can

1049
00:36:05,680 --> 00:36:09,279
mitigate that risk if we did have to use

1050
00:36:07,480 --> 00:36:11,380
that by you know making the ticket valid

1051
00:36:09,280 --> 00:36:13,000
to ten minutes or something like that

1052
00:36:11,380 --> 00:36:14,320
but obviously then the blue team could

1053
00:36:13,000 --> 00:36:16,270
detect on the length of a Kerberos

1054
00:36:14,320 --> 00:36:18,490
ticket not being ten hours the default

1055
00:36:16,270 --> 00:36:20,800
active directory so whilst looking for

1056
00:36:18,490 --> 00:36:22,540
golden tickets in your environment that

1057
00:36:20,800 --> 00:36:24,070
aren't ten hours you know you see them

1058
00:36:22,540 --> 00:36:25,570
being smaller that might be a good way

1059
00:36:24,070 --> 00:36:27,160
of catching an ethical red team but

1060
00:36:25,570 --> 00:36:28,810
obviously people trying to reduce the

1061
00:36:27,160 --> 00:36:30,368
risk for you and but actually in terms

1062
00:36:28,810 --> 00:36:33,400
of catching like actual malicious actors

1063
00:36:30,369 --> 00:36:36,850
well just make use of ten hours or

1064
00:36:33,400 --> 00:36:38,710
talent and ten years sorry okay so on

1065
00:36:36,850 --> 00:36:41,380
the detection side and well before we

1066
00:36:38,710 --> 00:36:42,670
get into the spunk so DC's only checked

1067
00:36:41,380 --> 00:36:43,869
the validity or the validity of every

1068
00:36:42,670 --> 00:36:45,609
all the information within that ticket

1069
00:36:43,869 --> 00:36:47,590
at once it's twenty minutes old so you

1070
00:36:45,609 --> 00:36:49,330
could actually in theory submit a golden

1071
00:36:47,590 --> 00:36:50,560
ticket and in the user field do forward

1072
00:36:49,330 --> 00:36:52,359
slash mean team and that would

1073
00:36:50,560 --> 00:36:54,970
absolutely work across the environment

1074
00:36:52,359 --> 00:36:56,440
for the first twenty minutes clearly so

1075
00:36:54,970 --> 00:36:59,080
of ethical security testers or grown-up

1076
00:36:56,440 --> 00:37:00,460
readiness will not do this so we can

1077
00:36:59,080 --> 00:37:02,830
also look a little bit further into the

1078
00:37:00,460 --> 00:37:04,540
Kerberos activity in the tickets that

1079
00:37:02,830 --> 00:37:05,950
you're submitting into and then

1080
00:37:04,540 --> 00:37:07,180
collecting in your app directory logs

1081
00:37:05,950 --> 00:37:09,580
because we're all doing Active Directory

1082
00:37:07,180 --> 00:37:12,399
logs right and we'll see the NetBIOS

1083
00:37:09,580 --> 00:37:14,410
name instead of the fqdn in the domain

1084
00:37:12,400 --> 00:37:16,359
field except that again grown-up red

1085
00:37:14,410 --> 00:37:19,118
teamers will ensure that we pipe in the

1086
00:37:16,359 --> 00:37:21,970
app you do if you miss the attacker

1087
00:37:19,119 --> 00:37:23,920
misses the forward slash domain flag and

1088
00:37:21,970 --> 00:37:25,270
then the rest of the FDD m mimikatz

1089
00:37:23,920 --> 00:37:26,920
tries to help you out by putting the

1090
00:37:25,270 --> 00:37:28,420
NetBIOS name in except you can then

1091
00:37:26,920 --> 00:37:30,520
alert off that because there's no real

1092
00:37:28,420 --> 00:37:31,990
reason but NetBIOS names as far as I

1093
00:37:30,520 --> 00:37:34,390
know helped it happen to be corrected

1094
00:37:31,990 --> 00:37:36,669
for that for the fqdn to not be there

1095
00:37:34,390 --> 00:37:38,350
and again we can interact the examiner

1096
00:37:36,670 --> 00:37:40,000
decryption types at every level should

1097
00:37:38,350 --> 00:37:41,589
never really be seeing rc4

1098
00:37:40,000 --> 00:37:44,530
if we are in amateur environment that's

1099
00:37:41,590 --> 00:37:46,840
moved move with the times we can also

1100
00:37:44,530 --> 00:37:48,760
use time-based analysis to use TVs to

1101
00:37:46,840 --> 00:37:49,480
see TGT submissions ticket granting

1102
00:37:48,760 --> 00:37:51,430
ticket

1103
00:37:49,480 --> 00:37:53,260
submissions with no tgs for those

1104
00:37:51,430 --> 00:37:54,730
services immediately before but again

1105
00:37:53,260 --> 00:37:57,250
grown-up red teams will make use of

1106
00:37:54,730 --> 00:37:59,050
tooling to request tgs's for services

1107
00:37:57,250 --> 00:38:02,590
just before we use a TD T to access them

1108
00:37:59,050 --> 00:38:04,780
and indeed we can look for event 6 4 7 6

1109
00:38:02,590 --> 00:38:07,270
2 which is an admin log on an elevated

1110
00:38:04,780 --> 00:38:09,520
missions and they'll have a blank domain

1111
00:38:07,270 --> 00:38:09,850
field inside that when you log in Active

1112
00:38:09,520 --> 00:38:12,369
Directory

1113
00:38:09,850 --> 00:38:13,810
yeah so what happens if it's not a PG

1114
00:38:12,369 --> 00:38:15,280
meme team in its target in year and it's

1115
00:38:13,810 --> 00:38:17,290
a competent red team that'll filter all

1116
00:38:15,280 --> 00:38:17,710
these fields made it much harder to

1117
00:38:17,290 --> 00:38:19,000
detect

1118
00:38:17,710 --> 00:38:21,310
he can't us you know detect on blank

1119
00:38:19,000 --> 00:38:22,960
kills an event well that's not so bad

1120
00:38:21,310 --> 00:38:24,580
because we can we believe reliably

1121
00:38:22,960 --> 00:38:27,040
detect that but the query that was

1122
00:38:24,580 --> 00:38:28,600
broadly similar to this and so again

1123
00:38:27,040 --> 00:38:30,250
we're indexing domain because we have no

1124
00:38:28,600 --> 00:38:33,220
fear we're looking at events in the last

1125
00:38:30,250 --> 00:38:34,990
seven days and Windows Event log ideal

1126
00:38:33,220 --> 00:38:37,240
you probably do that to secure aces you

1127
00:38:34,990 --> 00:38:38,950
have a good start here we're looking for

1128
00:38:37,240 --> 00:38:41,470
account names that are not administrator

1129
00:38:38,950 --> 00:38:43,899
or computer accounts but suspiciously

1130
00:38:41,470 --> 00:38:45,879
have a set or read of 500 as we all know

1131
00:38:43,900 --> 00:38:48,430
as local admin so why would the domain

1132
00:38:45,880 --> 00:38:51,190
user account for example have that they

1133
00:38:48,430 --> 00:38:52,750
wouldn't basically as a short answer and

1134
00:38:51,190 --> 00:38:55,420
and then we're just gonna fill around

1135
00:38:52,750 --> 00:38:57,820
some stats here so ok names as we can

1136
00:38:55,420 --> 00:38:59,890
see mg Hoshi's is causing a lot of

1137
00:38:57,820 --> 00:39:03,040
trouble here and West multiple different

1138
00:38:59,890 --> 00:39:05,680
events and the VP's requirements so in

1139
00:39:03,040 --> 00:39:07,720
one of particular note is captain koalas

1140
00:39:05,680 --> 00:39:10,569
are just gonna quickly touch on a better

1141
00:39:07,720 --> 00:39:12,040
air can a threat on here so we've seen

1142
00:39:10,570 --> 00:39:13,510
mg Hershey's is running wild with a

1143
00:39:12,040 --> 00:39:15,130
golden ticket in our environment we can

1144
00:39:13,510 --> 00:39:16,630
I want to understand what he's doing and

1145
00:39:15,130 --> 00:39:17,950
so we're looking at four seven three

1146
00:39:16,630 --> 00:39:19,780
eight event which is like an account was

1147
00:39:17,950 --> 00:39:22,240
changed or something's modified that

1148
00:39:19,780 --> 00:39:22,900
object and we can see here mg Hoshi is

1149
00:39:22,240 --> 00:39:24,669
the culprit

1150
00:39:22,900 --> 00:39:26,920
these guys said five hundred or red

1151
00:39:24,670 --> 00:39:28,810
Python video and he's making changes to

1152
00:39:26,920 --> 00:39:31,119
the target account of Captain koala and

1153
00:39:28,810 --> 00:39:34,390
and one another thing to note here is

1154
00:39:31,119 --> 00:39:36,520
all of these being a - according to

1155
00:39:34,390 --> 00:39:39,250
Microsoft documentation means that is a

1156
00:39:36,520 --> 00:39:40,750
CL changes on that object and so he's

1157
00:39:39,250 --> 00:39:42,040
probably making some backdoors or

1158
00:39:40,750 --> 00:39:43,630
something - captain koala

1159
00:39:42,040 --> 00:39:45,400
so now that we can understood the

1160
00:39:43,630 --> 00:39:47,290
account that has the tacit that are

1161
00:39:45,400 --> 00:39:48,550
running wild and the backdoor an

1162
00:39:47,290 --> 00:39:50,200
occurrence when I kind of start looking

1163
00:39:48,550 --> 00:39:52,270
at okay how widespread is this in our

1164
00:39:50,200 --> 00:39:54,819
environment and so we can just kind of

1165
00:39:52,270 --> 00:39:56,590
slightly modify our query and to do a

1166
00:39:54,820 --> 00:39:58,900
table and dis look for a cave name which

1167
00:39:56,590 --> 00:40:00,280
is gonna give us the name responsible

1168
00:39:58,900 --> 00:40:02,750
and then the target name and as we can

1169
00:40:00,280 --> 00:40:04,460
see mg hashes has been

1170
00:40:02,750 --> 00:40:06,500
depayne lots of objects in our

1171
00:40:04,460 --> 00:40:09,310
environment and that was absolutely not

1172
00:40:06,500 --> 00:40:14,300
a result of Matt a Mac fingering that

1173
00:40:09,310 --> 00:40:16,190
system up here okay so the detection

1174
00:40:14,300 --> 00:40:19,490
side is actually relatively reliable

1175
00:40:16,190 --> 00:40:21,560
okay but what we can do is again on the

1176
00:40:19,490 --> 00:40:23,060
evasion his request to TTC or TGS with

1177
00:40:21,560 --> 00:40:24,200
the service the problem the account

1178
00:40:23,060 --> 00:40:26,930
we're about to fire your ticket into

1179
00:40:24,200 --> 00:40:29,029
using Rubeus again perhaps up to spec

1180
00:40:26,930 --> 00:40:30,620
drops are giving us those two links we

1181
00:40:29,030 --> 00:40:32,390
can make use of the domain offset and

1182
00:40:30,620 --> 00:40:34,910
like tack lifetime flags again like

1183
00:40:32,390 --> 00:40:36,470
competence and risk reduction because

1184
00:40:34,910 --> 00:40:38,450
otherwise the movie Katz defaults are

1185
00:40:36,470 --> 00:40:41,660
very long and indeed they use in that

1186
00:40:38,450 --> 00:40:44,419
BIOS name okay and also we see this

1187
00:40:41,660 --> 00:40:46,190
routinely many organizations have a

1188
00:40:44,420 --> 00:40:48,830
script or something similar that will

1189
00:40:46,190 --> 00:40:50,690
check the new additions to domain admins

1190
00:40:48,830 --> 00:40:52,759
and then will email them if they see

1191
00:40:50,690 --> 00:40:54,470
additional members of the group rather

1192
00:40:52,760 --> 00:40:55,910
retro if you ask me monitoring for a

1193
00:40:54,470 --> 00:40:57,620
membership of domain admins I think

1194
00:40:55,910 --> 00:40:59,299
there's many other ways such as the

1195
00:40:57,620 --> 00:41:01,339
permission to do these the 3gu it's

1196
00:40:59,300 --> 00:41:04,130
required for rather two sometimes three

1197
00:41:01,340 --> 00:41:05,180
periods required to do get NCC changes

1198
00:41:04,130 --> 00:41:07,160
from trim using Directory replication

1199
00:41:05,180 --> 00:41:08,690
services that's what's happening under

1200
00:41:07,160 --> 00:41:10,879
the hood when we do a DC sync attack

1201
00:41:08,690 --> 00:41:12,410
those three grits I'll put a Nile github

1202
00:41:10,880 --> 00:41:14,330
and we'll give you a link to that at the

1203
00:41:12,410 --> 00:41:15,950
end just simply so you can just

1204
00:41:14,330 --> 00:41:17,750
immediately order it for any instances

1205
00:41:15,950 --> 00:41:22,609
of those particular periods having a

1206
00:41:17,750 --> 00:41:24,980
sales change okay so let's have a little

1207
00:41:22,610 --> 00:41:28,030
look at this being done and we can see

1208
00:41:24,980 --> 00:41:31,160
how actually those periods are amended

1209
00:41:28,030 --> 00:41:33,200
so again just as a top tip here c-sharp

1210
00:41:31,160 --> 00:41:34,970
implants certainly push you to is it's

1211
00:41:33,200 --> 00:41:37,009
case sensitive so if you were to miss

1212
00:41:34,970 --> 00:41:38,779
off - some account naming caps you would

1213
00:41:37,010 --> 00:41:39,530
actually dump out the we just basically

1214
00:41:38,780 --> 00:41:42,260
beat net user

1215
00:41:39,530 --> 00:41:43,280
start so we can see here that Captain

1216
00:41:42,260 --> 00:41:46,280
koala currently doesn't have any

1217
00:41:43,280 --> 00:41:49,220
elevated privileges but which we

1218
00:41:46,280 --> 00:41:51,530
submitted golden ticket from MJ hashes

1219
00:41:49,220 --> 00:41:53,509
we can then use the MJ hashes account

1220
00:41:51,530 --> 00:41:54,920
but make changes to cap in koala and

1221
00:41:53,510 --> 00:41:56,690
then we can prove that kappa inca while

1222
00:41:54,920 --> 00:41:58,630
that has those elevated privileges again

1223
00:41:56,690 --> 00:42:00,980
pushbike proving it's got DC secrets

1224
00:41:58,630 --> 00:42:04,280
here is a sharp view command that will

1225
00:42:00,980 --> 00:42:06,230
do it for you and all that shark view is

1226
00:42:04,280 --> 00:42:09,710
it is a reimplementation c-sharp of the

1227
00:42:06,230 --> 00:42:11,360
awesome power of you fooling you so that

1228
00:42:09,710 --> 00:42:12,590
tickets come back help the mini caps

1229
00:42:11,360 --> 00:42:14,150
takes quite a while to submit these

1230
00:42:12,590 --> 00:42:17,290
things all very boring in the demo isn't

1231
00:42:14,150 --> 00:42:20,180
a look at screens not doing anything

1232
00:42:17,290 --> 00:42:22,009
so here we should be able to see that

1233
00:42:20,180 --> 00:42:24,790
the tooling comes back and we see some

1234
00:42:22,010 --> 00:42:24,790
ACLs modified

1235
00:42:35,420 --> 00:42:39,650
okay so now we're in implant hormone six

1236
00:42:37,430 --> 00:42:40,879
which is Captain koala we've just proved

1237
00:42:39,650 --> 00:42:43,700
that he didn't have elevated permissions

1238
00:42:40,880 --> 00:42:45,980
so we use sharp new to grunt in them now

1239
00:42:43,700 --> 00:42:48,710
will prove that Captain koala and dump

1240
00:42:45,980 --> 00:42:51,410
out the digital solutions comm ntlm hash

1241
00:42:48,710 --> 00:42:51,950
or Bob chicken University to did have a

1242
00:42:51,410 --> 00:42:53,299
small headache

1243
00:42:51,950 --> 00:42:55,580
at this point there's all sorts of

1244
00:42:53,300 --> 00:42:57,950
errors including killing our shelves but

1245
00:42:55,580 --> 00:43:02,990
help me I came back yeah entirely sure

1246
00:42:57,950 --> 00:43:04,700
what that was they couldn't see me

1247
00:43:02,990 --> 00:43:06,259
frantically at 5:00 in the impart list

1248
00:43:04,700 --> 00:43:10,100
hoping we've not been kicked out by the

1249
00:43:06,260 --> 00:43:12,680
invisible blue team but as it was a

1250
00:43:10,100 --> 00:43:14,930
vicious the connect the internet here

1251
00:43:12,680 --> 00:43:17,330
and drop okay and we can see now that

1252
00:43:14,930 --> 00:43:20,690
captain koala has the d c-- synchronous

1253
00:43:17,330 --> 00:43:25,610
so he is in effect may not been in 5 min

1254
00:43:20,690 --> 00:43:28,490
or whatever so moving on to threat

1255
00:43:25,610 --> 00:43:29,780
huntin demo and basically you saw we're

1256
00:43:28,490 --> 00:43:31,129
gonna look at like what happens when you

1257
00:43:29,780 --> 00:43:32,750
get one of these depictions and we're

1258
00:43:31,130 --> 00:43:34,040
just gonna go to one through a quick

1259
00:43:32,750 --> 00:43:36,860
when scenario that you can do it to

1260
00:43:34,040 --> 00:43:38,779
really determine MF what's here in your

1261
00:43:36,860 --> 00:43:40,400
event or alert dashboard as actually a

1262
00:43:38,780 --> 00:43:41,600
compromise or if there's nothing to

1263
00:43:40,400 --> 00:43:43,790
worry about maybe you need a look at

1264
00:43:41,600 --> 00:43:45,110
refining your alerts again and so just

1265
00:43:43,790 --> 00:43:47,600
because everybody loves scarab roastin

1266
00:43:45,110 --> 00:43:49,100
we're gonna look at a what happens with

1267
00:43:47,600 --> 00:43:50,420
one of these four seven six nine events

1268
00:43:49,100 --> 00:43:52,850
we're going to view the results of that

1269
00:43:50,420 --> 00:43:54,950
and which you can see here and we can

1270
00:43:52,850 --> 00:43:56,720
see that the reason that the event is

1271
00:43:54,950 --> 00:43:58,879
fired or the Alerus fired sorry

1272
00:43:56,720 --> 00:44:01,189
as the jason has triggered fifteen of

1273
00:43:58,880 --> 00:44:04,970
the events matching this criteria in the

1274
00:44:01,190 --> 00:44:07,070
last 60 seconds prey a weird behavior if

1275
00:44:04,970 --> 00:44:08,810
you asked me and soon as i can a quick

1276
00:44:07,070 --> 00:44:10,910
look at like what happens when you view

1277
00:44:08,810 --> 00:44:12,080
results you get your 15 events here and

1278
00:44:10,910 --> 00:44:14,899
then you want to look in they get into

1279
00:44:12,080 --> 00:44:16,910
these events and see what's going on so

1280
00:44:14,900 --> 00:44:18,740
he feels here are you get your account

1281
00:44:16,910 --> 00:44:21,799
name okay as we know it's Jason the

1282
00:44:18,740 --> 00:44:24,709
service name is MS sequel and the client

1283
00:44:21,800 --> 00:44:26,360
IP is grown okay in a minute and then

1284
00:44:24,710 --> 00:44:28,760
they take encryption tape oh yeah it

1285
00:44:26,360 --> 00:44:30,440
takes all the boxes and for our IOC s

1286
00:44:28,760 --> 00:44:31,910
and so now we're gonna go and

1287
00:44:30,440 --> 00:44:33,500
interrogate the horse to see if actually

1288
00:44:31,910 --> 00:44:35,569
compromises I've heard on that maybe

1289
00:44:33,500 --> 00:44:38,030
something's broken and is just whaled

1290
00:44:35,570 --> 00:44:40,670
you don't know yet so we're gonna look

1291
00:44:38,030 --> 00:44:41,660
here and as you can see well actually

1292
00:44:40,670 --> 00:44:43,520
sorry the first thing we're gonna do is

1293
00:44:41,660 --> 00:44:44,990
we're gonna look for an EM indicators of

1294
00:44:43,520 --> 00:44:47,300
compromised worthless so we're gonna

1295
00:44:44,990 --> 00:44:49,279
look at has their c2 traffic because in

1296
00:44:47,300 --> 00:44:50,480
life Jason Perry is being really care

1297
00:44:49,280 --> 00:44:52,400
we're probably gonna see some see two

1298
00:44:50,480 --> 00:44:55,160
beacons comin over that's Horst and as

1299
00:44:52,400 --> 00:44:57,590
we can see here we have quite a lot of

1300
00:44:55,160 --> 00:44:59,540
traffic going to this IP which would be

1301
00:44:57,590 --> 00:45:01,280
an indicator of beacon traffic going out

1302
00:44:59,540 --> 00:45:03,560
and again just for anyone not familiar

1303
00:45:01,280 --> 00:45:04,970
with slight see two cones generally

1304
00:45:03,560 --> 00:45:07,100
happens over a period of time with

1305
00:45:04,970 --> 00:45:09,290
people so they could be on 4/32 beacons

1306
00:45:07,100 --> 00:45:11,600
and that well we all talk back to the

1307
00:45:09,290 --> 00:45:13,130
command server every 30 seconds of

1308
00:45:11,600 --> 00:45:15,410
silver period saying they start to build

1309
00:45:13,130 --> 00:45:17,780
up that sort of read that traffic there

1310
00:45:15,410 --> 00:45:19,160
so now we're in a much worse place from

1311
00:45:17,780 --> 00:45:21,170
an organization perspective because

1312
00:45:19,160 --> 00:45:23,690
we've had an alert fire off we'll be

1313
00:45:21,170 --> 00:45:25,730
looked into and know we have confirms

1314
00:45:23,690 --> 00:45:28,520
that our lately confirmed that actually

1315
00:45:25,730 --> 00:45:31,280
somebody's been fished eventually and an

1316
00:45:28,520 --> 00:45:32,720
attacker is in our environment I mean

1317
00:45:31,280 --> 00:45:34,220
this is just gonna wanna vent hoods

1318
00:45:32,720 --> 00:45:36,200
three looks like so this is assessment

1319
00:45:34,220 --> 00:45:38,899
event and so just a note you won't get

1320
00:45:36,200 --> 00:45:39,950
an aircon and NSA with regular win

1321
00:45:38,900 --> 00:45:42,380
events they don't have that capability

1322
00:45:39,950 --> 00:45:43,520
which is why you need cess one and so

1323
00:45:42,380 --> 00:45:45,110
that's why they include three years is

1324
00:45:43,520 --> 00:45:46,820
network protections or network

1325
00:45:45,110 --> 00:45:49,460
connections rather and so as we can see

1326
00:45:46,820 --> 00:45:51,920
we have PowerShell dot XE and going out

1327
00:45:49,460 --> 00:45:54,290
to the internet here and from this IP

1328
00:45:51,920 --> 00:45:56,120
user Jason it's on Puckle food and

1329
00:45:54,290 --> 00:45:58,100
that's the host name so these are all

1330
00:45:56,120 --> 00:46:00,080
things we can now start to do additional

1331
00:45:58,100 --> 00:46:02,990
threat hunting on and if the red team's

1332
00:46:00,080 --> 00:46:04,670
diversified there are kinematic chain it

1333
00:46:02,990 --> 00:46:05,959
may be harder but maybe they're not in

1334
00:46:04,670 --> 00:46:07,430
there just you know running wild with

1335
00:46:05,960 --> 00:46:10,190
PowerShell door excerpts then on it

1336
00:46:07,430 --> 00:46:12,830
that's something you can look for and so

1337
00:46:10,190 --> 00:46:14,450
no we will find one compromise to Austin

1338
00:46:12,830 --> 00:46:16,279
environment we want to try and find have

1339
00:46:14,450 --> 00:46:18,049
since any other instances access is much

1340
00:46:16,280 --> 00:46:20,000
more widespread in chaotic than just one

1341
00:46:18,050 --> 00:46:21,410
course or one user that's quite on an

1342
00:46:20,000 --> 00:46:23,240
email so we're gonna look in our

1343
00:46:21,410 --> 00:46:25,190
environment for any hosts of in

1344
00:46:23,240 --> 00:46:27,890
connecting to that IP that we believe to

1345
00:46:25,190 --> 00:46:29,660
be the c2 IP and in the last seven days

1346
00:46:27,890 --> 00:46:31,940
that's what we're doing here and you can

1347
00:46:29,660 --> 00:46:33,920
see that this source type is set one to

1348
00:46:31,940 --> 00:46:35,710
the top of the other and we can see here

1349
00:46:33,920 --> 00:46:38,930
were playing three additional hosts and

1350
00:46:35,710 --> 00:46:42,710
which now means oh no okay widespread

1351
00:46:38,930 --> 00:46:44,299
breach not just one user and so another

1352
00:46:42,710 --> 00:46:46,400
thing I wanted to add in here which is e

1353
00:46:44,300 --> 00:46:47,930
NS n say this is a new thing for Sussman

1354
00:46:46,400 --> 00:46:49,820
they recently did that once a month or

1355
00:46:47,930 --> 00:46:52,310
two ago the ability can I get better

1356
00:46:49,820 --> 00:46:53,990
billion the DNS events and so that's

1357
00:46:52,310 --> 00:46:56,750
what we're doing here we're looking at a

1358
00:46:53,990 --> 00:46:59,089
banquet 22 which is DNS which reveals

1359
00:46:56,750 --> 00:47:00,610
our fourth fourth and you know the

1360
00:46:59,090 --> 00:47:02,320
reason this is important as

1361
00:47:00,610 --> 00:47:04,390
just for complications our environment

1362
00:47:02,320 --> 00:47:06,970
and reasons we weren't able to consume

1363
00:47:04,390 --> 00:47:09,009
proxy logs and so if all your hosts are

1364
00:47:06,970 --> 00:47:10,689
configured to go a proxy hell you'd have

1365
00:47:09,010 --> 00:47:13,210
to do this or the proxy level not at the

1366
00:47:10,690 --> 00:47:14,230
host level and but it's also just can't

1367
00:47:13,210 --> 00:47:16,300
important to understand if you have

1368
00:47:14,230 --> 00:47:18,070
hosts that go straight to the internet

1369
00:47:16,300 --> 00:47:20,860
Lane you would need to do this one as

1370
00:47:18,070 --> 00:47:22,960
well and so does the DNS event look like

1371
00:47:20,860 --> 00:47:25,900
broadly similar to the net con event and

1372
00:47:22,960 --> 00:47:28,570
what got the query that is looking up

1373
00:47:25,900 --> 00:47:31,330
resolve the IP again the process making

1374
00:47:28,570 --> 00:47:32,590
the connection the process ID and so

1375
00:47:31,330 --> 00:47:35,020
again these are all things we can get a

1376
00:47:32,590 --> 00:47:36,460
hunk off the back of and and just a kind

1377
00:47:35,020 --> 00:47:37,810
of quick two-for-one query we will be

1378
00:47:36,460 --> 00:47:39,670
putting all these queries on github so

1379
00:47:37,810 --> 00:47:41,230
for anyone who wants to go and you know

1380
00:47:39,670 --> 00:47:44,290
through these and Airwaves or have a

1381
00:47:41,230 --> 00:47:46,000
play with them and whatever a log until

1382
00:47:44,290 --> 00:47:48,160
they have they can do that or even test

1383
00:47:46,000 --> 00:47:50,680
American environment and so that's all

1384
00:47:48,160 --> 00:47:52,540
SPD's gonna do is cover both event to a

1385
00:47:50,680 --> 00:47:54,040
two and three and then we just get it

1386
00:47:52,540 --> 00:47:57,160
all in one nice 3d instead of having to

1387
00:47:54,040 --> 00:47:58,750
do two queries and so one thing there's

1388
00:47:57,160 --> 00:48:00,310
loads of different types of things you

1389
00:47:58,750 --> 00:48:02,680
can do where threat hunt runs off the

1390
00:48:00,310 --> 00:48:04,360
back of detections so one of those is

1391
00:48:02,680 --> 00:48:06,069
like if you've identified the process

1392
00:48:04,360 --> 00:48:07,630
such as power shell you can look like

1393
00:48:06,070 --> 00:48:09,460
PowerShell making Network nations

1394
00:48:07,630 --> 00:48:11,470
throughout your environment and you can

1395
00:48:09,460 --> 00:48:13,210
look for processes connecting to the

1396
00:48:11,470 --> 00:48:15,910
internet it shouldn't be so basically

1397
00:48:13,210 --> 00:48:17,290
anything like non browser-based probably

1398
00:48:15,910 --> 00:48:20,109
shouldn't be talking making an external

1399
00:48:17,290 --> 00:48:22,180
net Korn's especially on a 4.3 and even

1400
00:48:20,110 --> 00:48:24,670
notepad xox April I shouldn't be doing

1401
00:48:22,180 --> 00:48:26,470
DNS lookups as probably big IOC in

1402
00:48:24,670 --> 00:48:28,060
itself you know absolute profile names

1403
00:48:26,470 --> 00:48:29,589
file hashes and to discuss the earlier

1404
00:48:28,060 --> 00:48:31,540
the river since pool sample and things

1405
00:48:29,590 --> 00:48:33,640
but that's not always going to be a

1406
00:48:31,540 --> 00:48:35,440
reliable way of finding things another

1407
00:48:33,640 --> 00:48:36,850
one good one is unsane binaries as well

1408
00:48:35,440 --> 00:48:39,190
so i'm the same binaries live internet

1409
00:48:36,850 --> 00:48:40,930
and out sentiment or binaries that

1410
00:48:39,190 --> 00:48:42,910
should be saying that aren't so if you

1411
00:48:40,930 --> 00:48:44,799
get out licked or XE going out to the

1412
00:48:42,910 --> 00:48:47,170
Internet and it's fun sane that's boy

1413
00:48:44,800 --> 00:48:49,240
and indicator that you know the red

1414
00:48:47,170 --> 00:48:51,370
team's tried to be smart and cover their

1415
00:48:49,240 --> 00:48:52,959
tracks by having equipped or XE but

1416
00:48:51,370 --> 00:48:55,480
actually it's an insane binary or maybe

1417
00:48:52,960 --> 00:48:57,970
the backboards and a same binary that's

1418
00:48:55,480 --> 00:48:59,110
then they done st. another really

1419
00:48:57,970 --> 00:49:02,080
powerful one as well as

1420
00:48:59,110 --> 00:49:03,220
never-before-seen domains so if you see

1421
00:49:02,080 --> 00:49:05,230
a breach you can go to look like

1422
00:49:03,220 --> 00:49:06,850
never-before-seen domains in the last 24

1423
00:49:05,230 --> 00:49:09,640
hours or even this in real time look for

1424
00:49:06,850 --> 00:49:13,150
never-before-seen domains and that can

1425
00:49:09,640 --> 00:49:14,440
be noisy as well and so it's again just

1426
00:49:13,150 --> 00:49:17,349
something to be aware of

1427
00:49:14,440 --> 00:49:19,960
a-and you can use lookup files as well

1428
00:49:17,349 --> 00:49:21,599
for this so if you have if you want to

1429
00:49:19,960 --> 00:49:23,740
ignore certain things you can do that

1430
00:49:21,599 --> 00:49:25,869
and then as we can attach it on your

1431
00:49:23,740 --> 00:49:27,700
like telemetry based detection so don't

1432
00:49:25,869 --> 00:49:29,319
be amazed example you might use W am I

1433
00:49:27,700 --> 00:49:31,270
on a daily basis in your environment and

1434
00:49:29,319 --> 00:49:33,520
so maybe you don't give or take a

1435
00:49:31,270 --> 00:49:35,500
hundred WMI events is normal for your

1436
00:49:33,520 --> 00:49:38,140
environment and then one day or the one

1437
00:49:35,500 --> 00:49:39,730
hour period suddenly C 250 W mi events

1438
00:49:38,140 --> 00:49:41,618
fire up that's probably an indicator of

1439
00:49:39,730 --> 00:49:43,270
compromise maybe the red team's time for

1440
00:49:41,619 --> 00:49:46,210
being smart when the nine but actually

1441
00:49:43,270 --> 00:49:47,319
live offset or whenever F were as normal

1442
00:49:46,210 --> 00:49:49,030
for your environment so that's for

1443
00:49:47,319 --> 00:49:51,940
understanding your environment becomes

1444
00:49:49,030 --> 00:49:53,950
really important and we did try to or

1445
00:49:51,940 --> 00:49:56,109
we're going to demo most of these but

1446
00:49:53,950 --> 00:49:57,399
unfortunately time constraints meant we

1447
00:49:56,109 --> 00:50:00,609
couldn't so I'm just going to quickly go

1448
00:49:57,400 --> 00:50:01,539
through and Flula says he's good at

1449
00:50:00,609 --> 00:50:03,730
making net buttons

1450
00:50:01,539 --> 00:50:05,020
so again just gonna back to this we're

1451
00:50:03,730 --> 00:50:06,640
gonna look for like powershell don't

1452
00:50:05,020 --> 00:50:09,220
exit and our environment making network

1453
00:50:06,640 --> 00:50:12,490
connections and that's kind of what we

1454
00:50:09,220 --> 00:50:14,109
get here so we're looking for any of

1455
00:50:12,490 --> 00:50:16,479
these events and we're filtering on

1456
00:50:14,109 --> 00:50:18,220
computer named air event called an image

1457
00:50:16,480 --> 00:50:20,319
which is the process is maybe they're

1458
00:50:18,220 --> 00:50:23,230
not used just using power field or XE a

1459
00:50:20,319 --> 00:50:25,029
zillionaire SH Bruno SVC horse bono as

1460
00:50:23,230 --> 00:50:26,770
well so that maybe gives us an idea of

1461
00:50:25,029 --> 00:50:28,210
the typical things that are using in our

1462
00:50:26,770 --> 00:50:32,740
environment so we can then go and look

1463
00:50:28,210 --> 00:50:34,960
for them and so this is know where those

1464
00:50:32,740 --> 00:50:36,459
air processes are going so we know these

1465
00:50:34,960 --> 00:50:38,170
processes are making network connections

1466
00:50:36,460 --> 00:50:40,750
you know when I see if any are going to

1467
00:50:38,170 --> 00:50:42,220
the c2 IEP and that's what I doing here

1468
00:50:40,750 --> 00:50:45,039
as you can see we've got quite a lot of

1469
00:50:42,220 --> 00:50:48,308
PowerShell one's going out here and and

1470
00:50:45,039 --> 00:50:50,079
yet flashes like something you can do in

1471
00:50:48,309 --> 00:50:51,700
effect once you see annotation they

1472
00:50:50,079 --> 00:50:54,220
trying to understand what's gonna you

1473
00:50:51,700 --> 00:50:56,049
see other IPS or maybe suspicious or if

1474
00:50:54,220 --> 00:51:00,700
you've been on the URLs basis you can

1475
00:50:56,049 --> 00:51:01,839
obviously and look for them as well okay

1476
00:51:00,700 --> 00:51:04,058
so we could have quite a lot of ground

1477
00:51:01,839 --> 00:51:05,230
here and just conscious that inhabitants

1478
00:51:04,059 --> 00:51:06,520
like struggle to make notes and stuff

1479
00:51:05,230 --> 00:51:09,339
these slides are already on our github

1480
00:51:06,520 --> 00:51:11,440
and so if you've got limited time we do

1481
00:51:09,339 --> 00:51:13,869
such limited like resources until

1482
00:51:11,440 --> 00:51:17,170
personnel or money or time or just a

1483
00:51:13,869 --> 00:51:19,000
slow-moving organization and we really

1484
00:51:17,170 --> 00:51:21,549
feel on our side of the house on the red

1485
00:51:19,000 --> 00:51:24,250
side the ad logging isn't really being

1486
00:51:21,549 --> 00:51:26,410
done particularly well at scale it's

1487
00:51:24,250 --> 00:51:27,450
okay as we saw in our lab here you know

1488
00:51:26,410 --> 00:51:28,920
we've got a couple

1489
00:51:27,450 --> 00:51:30,779
machines you know and it's much easier

1490
00:51:28,920 --> 00:51:32,760
to do but actually Active Directory

1491
00:51:30,780 --> 00:51:34,740
logging the total cost to deploy system

1492
00:51:32,760 --> 00:51:36,270
on is probably about 15 minutes and it

1493
00:51:34,740 --> 00:51:38,279
gives you a phenomenal amount of

1494
00:51:36,270 --> 00:51:40,950
visibility that probably rivals EDR

1495
00:51:38,280 --> 00:51:43,110
talking about EDR obviously the sales

1496
00:51:40,950 --> 00:51:44,730
guys will tell you the EDR is the silver

1497
00:51:43,110 --> 00:51:46,380
bullets that will entirely move the

1498
00:51:44,730 --> 00:51:48,690
pyramid you know that the battlespace in

1499
00:51:46,380 --> 00:51:50,940
blues favor every competent red team in

1500
00:51:48,690 --> 00:51:53,400
the UK and overseas has bypasses for all

1501
00:51:50,940 --> 00:51:55,440
of the all of the EDR products there are

1502
00:51:53,400 --> 00:51:57,090
people invest time and money into and if

1503
00:51:55,440 --> 00:51:59,100
not we have companies ourselves so we

1504
00:51:57,090 --> 00:52:01,290
can work out exactly what under T in

1505
00:51:59,100 --> 00:52:02,279
silence does that might get past carbon

1506
00:52:01,290 --> 00:52:05,520
black and things like that

1507
00:52:02,280 --> 00:52:07,710
so again Active Directory and this age

1508
00:52:05,520 --> 00:52:09,540
of single sign-on people using octor or

1509
00:52:07,710 --> 00:52:11,760
Active Directory Federation services

1510
00:52:09,540 --> 00:52:12,720
with sam'l claims across organizations

1511
00:52:11,760 --> 00:52:14,460
and things like that

1512
00:52:12,720 --> 00:52:16,080
your Active Directory is now the attack

1513
00:52:14,460 --> 00:52:18,780
surface and indeed it has been for a

1514
00:52:16,080 --> 00:52:21,150
while you know the idea that kids or

1515
00:52:18,780 --> 00:52:23,280
apts or red team's r5 and exploits down

1516
00:52:21,150 --> 00:52:24,840
Sox chains in Co box right it's just not

1517
00:52:23,280 --> 00:52:27,720
happening it's all about Active

1518
00:52:24,840 --> 00:52:29,370
Directory and legacy problems and people

1519
00:52:27,720 --> 00:52:31,080
having a grip on what normal looks like

1520
00:52:29,370 --> 00:52:32,580
in the right directory apartment you

1521
00:52:31,080 --> 00:52:35,009
need to know what normal does look like

1522
00:52:32,580 --> 00:52:36,960
yeah you should be collecting these logs

1523
00:52:35,010 --> 00:52:38,970
already from a guarantee of availability

1524
00:52:36,960 --> 00:52:40,380
services and if your admins or your NOC

1525
00:52:38,970 --> 00:52:41,339
are knocking that collecting logs

1526
00:52:40,380 --> 00:52:43,170
through your servers or your

1527
00:52:41,340 --> 00:52:44,730
workstations at this point just get new

1528
00:52:43,170 --> 00:52:46,800
admins because this is kind of like

1529
00:52:44,730 --> 00:52:47,250
pretty much systems administration what

1530
00:52:46,800 --> 00:52:48,870
I want

1531
00:52:47,250 --> 00:52:50,250
so proactively we should be monitoring

1532
00:52:48,870 --> 00:52:51,359
these things rather than trying to go

1533
00:52:50,250 --> 00:52:54,810
back in time and do these things

1534
00:52:51,360 --> 00:52:56,940
reactively know you need to invest in

1535
00:52:54,810 --> 00:52:58,710
there to get some visibility granted you

1536
00:52:56,940 --> 00:53:01,530
know Splunk is definitely not free if

1537
00:52:58,710 --> 00:53:03,270
you use it just as a seen what there's

1538
00:53:01,530 --> 00:53:05,640
plenty of alternative you know from some

1539
00:53:03,270 --> 00:53:07,230
form of elasticsearch log stashing

1540
00:53:05,640 --> 00:53:08,940
habana stack with whatever it needs to

1541
00:53:07,230 --> 00:53:11,160
be or you can even go like logarithm or

1542
00:53:08,940 --> 00:53:12,630
whatever whatever works there's plenty

1543
00:53:11,160 --> 00:53:14,040
of free options you don't have to see

1544
00:53:12,630 --> 00:53:15,690
you spunk we just use sprung here

1545
00:53:14,040 --> 00:53:17,759
because we were able to get a 60 or 90

1546
00:53:15,690 --> 00:53:20,730
day dev license for just the sake of

1547
00:53:17,760 --> 00:53:22,860
sending them an email so there's lots of

1548
00:53:20,730 --> 00:53:25,050
free tooling here as this isn't a it's

1549
00:53:22,860 --> 00:53:27,600
going to cost us a huge amount storage

1550
00:53:25,050 --> 00:53:29,370
it's 2019 even enterprise class storage

1551
00:53:27,600 --> 00:53:31,380
is still pretty treat when you look at

1552
00:53:29,370 --> 00:53:33,930
the alternatives you know saving 50

1553
00:53:31,380 --> 00:53:35,520
grand on on a San or whatever but then

1554
00:53:33,930 --> 00:53:37,620
suffering multi-million pounds worth of

1555
00:53:35,520 --> 00:53:38,350
breaches is obviously not a good thing

1556
00:53:37,620 --> 00:53:44,500
just ask

1557
00:53:38,350 --> 00:53:44,830
Arius or B or M PA you know take your

1558
00:53:44,500 --> 00:53:46,330
pick

1559
00:53:44,830 --> 00:53:48,610
no just like say thank you very much to

1560
00:53:46,330 --> 00:53:50,319
these guys here and forgiveness the sort

1561
00:53:48,610 --> 00:53:52,000
of the time to do this and to everyone

1562
00:53:50,320 --> 00:53:53,980
I've liked work with now or people of

1563
00:53:52,000 --> 00:53:55,510
whether previously I'd know her even

1564
00:53:53,980 --> 00:54:07,150
less if I hadn't been under your

1565
00:53:55,510 --> 00:54:09,250
tutelage so thanks very much and on

1566
00:54:07,150 --> 00:54:11,110
Ghani questions I confess that I'm not

1567
00:54:09,250 --> 00:54:12,490
like an awesome blue team or in any way

1568
00:54:11,110 --> 00:54:24,610
so I may have said something wrong and

1569
00:54:12,490 --> 00:54:27,279
that's absolutely rusty the spunky

1570
00:54:24,610 --> 00:54:29,230
logging question I some experience with

1571
00:54:27,280 --> 00:54:30,850
an organization that believes spokes the

1572
00:54:29,230 --> 00:54:32,620
answers to the logging so rather than

1573
00:54:30,850 --> 00:54:34,330
have an independent blogging everything

1574
00:54:32,620 --> 00:54:37,029
gets tripped is slump you may think that

1575
00:54:34,330 --> 00:54:39,520
that's a longing solution won't be your

1576
00:54:37,030 --> 00:54:42,070
exposure or your argument against our I

1577
00:54:39,520 --> 00:54:45,930
think it's stupid it's very difficult

1578
00:54:42,070 --> 00:54:45,930
for me to turn the organization of these

1579
00:54:46,380 --> 00:54:51,250
splints fighting is like non-trivial to

1580
00:54:49,240 --> 00:54:53,709
say the least it's if you just use

1581
00:54:51,250 --> 00:54:57,130
Splunk as a scene for your organization

1582
00:54:53,710 --> 00:54:58,870
it's yeah yeah number one it wasn't

1583
00:54:57,130 --> 00:55:01,000
designed as a city it's a data platform

1584
00:54:58,870 --> 00:55:02,710
so I went over to Splunk HQ in like a

1585
00:55:01,000 --> 00:55:04,780
three-hour workshop on like slunk 101

1586
00:55:02,710 --> 00:55:06,040
and they use some really good case

1587
00:55:04,780 --> 00:55:08,320
studies that if your organisation you

1588
00:55:06,040 --> 00:55:09,610
Splunk for everything already you can

1589
00:55:08,320 --> 00:55:11,290
actually get some really good valuable

1590
00:55:09,610 --> 00:55:12,640
information and insights that aren't

1591
00:55:11,290 --> 00:55:14,800
related to security out of it

1592
00:55:12,640 --> 00:55:15,850
I'm spunked exceptionally powerful and I

1593
00:55:14,800 --> 00:55:17,860
think one of the reasons it is so

1594
00:55:15,850 --> 00:55:19,810
powerful is like let's face it all the

1595
00:55:17,860 --> 00:55:22,000
big boys use it you know so all of the

1596
00:55:19,810 --> 00:55:24,009
large successful tier 0 Tier one

1597
00:55:22,000 --> 00:55:25,690
financial organizations health care

1598
00:55:24,010 --> 00:55:27,220
providers and so they're starting to

1599
00:55:25,690 --> 00:55:28,540
come across the spoon and because of

1600
00:55:27,220 --> 00:55:30,520
that there's a big massive blue team

1601
00:55:28,540 --> 00:55:32,110
threat hunting ecosystem around it you

1602
00:55:30,520 --> 00:55:33,600
know on this one cap store almost you

1603
00:55:32,110 --> 00:55:35,470
know we the loads of pre-built stuff I

1604
00:55:33,600 --> 00:55:37,900
think the different there with larger

1605
00:55:35,470 --> 00:55:40,629
organizations at their log capture logs

1606
00:55:37,900 --> 00:55:42,160
as well as three gifts blog as like this

1607
00:55:40,630 --> 00:55:43,870
particular organization their fusion

1608
00:55:42,160 --> 00:55:46,000
believes that the flunkies that we all

1609
00:55:43,870 --> 00:55:47,980
mendel so there's no filtering there's

1610
00:55:46,000 --> 00:55:49,170
no capture it just all goes to spunk

1611
00:55:47,980 --> 00:55:51,630
without this

1612
00:55:49,170 --> 00:55:54,210
stick and make it happy us say large

1613
00:55:51,630 --> 00:55:56,069
organizations law and poor just bummed

1614
00:55:54,210 --> 00:55:58,290
and useful practically zyk results path

1615
00:55:56,069 --> 00:56:01,140
because their application box Interscope

1616
00:55:58,290 --> 00:56:03,390
rather than just slump Adobe nifty

1617
00:56:01,140 --> 00:56:04,770
something will stay yes it cuz plug

1618
00:56:03,390 --> 00:56:06,328
spliced on like a pair giggle pair

1619
00:56:04,770 --> 00:56:07,829
terabyte belay basis I've made you'd

1620
00:56:06,329 --> 00:56:09,450
like filter before you put it in spooky

1621
00:56:07,829 --> 00:56:11,069
and that's you know your credit your

1622
00:56:09,450 --> 00:56:13,230
sort of like credit card light has many

1623
00:56:11,069 --> 00:56:15,180
digits that all of the lines also liked

1624
00:56:13,230 --> 00:56:17,280
Splunk and as only as good as the log

1625
00:56:15,180 --> 00:56:19,078
your send it into it it's you know by

1626
00:56:17,280 --> 00:56:20,790
default their spunk orders are only

1627
00:56:19,079 --> 00:56:22,859
going to send when event logs in ad logs

1628
00:56:20,790 --> 00:56:24,000
in so like if you're not putting Sussman

1629
00:56:22,859 --> 00:56:26,250
on there you're really limiting yourself

1630
00:56:24,000 --> 00:56:28,530
and what you can see it can ingest other

1631
00:56:26,250 --> 00:56:30,750
tools as well so just flunk on its own

1632
00:56:28,530 --> 00:56:32,430
is probably not really gonna do what you

1633
00:56:30,750 --> 00:56:33,540
wanted to do you want to have additional

1634
00:56:32,430 --> 00:56:35,520
tool and on top of that on your

1635
00:56:33,540 --> 00:56:37,589
endpoints that then you can simmer all

1636
00:56:35,520 --> 00:56:39,150
into Splunk and then you cannot go from

1637
00:56:37,589 --> 00:56:41,609
there but if you're not doing that in

1638
00:56:39,150 --> 00:56:42,950
ask you know what just to capture when

1639
00:56:41,609 --> 00:56:46,619
event logs is probably not really

1640
00:56:42,950 --> 00:56:47,879
sensible to be honest unless you've got

1641
00:56:46,619 --> 00:56:49,589
a deal I know Splunk do have this

1642
00:56:47,880 --> 00:56:51,480
ability where you did pay a flat fee and

1643
00:56:49,589 --> 00:56:54,390
they just give you like a data ingestion

1644
00:56:51,480 --> 00:56:57,089
limit of start then you don't need to

1645
00:56:54,390 --> 00:56:59,009
worry about the pricing but that's the

1646
00:56:57,089 --> 00:57:00,450
exception should say as well and we're

1647
00:56:59,010 --> 00:57:02,819
gonna put all the queries the slides

1648
00:57:00,450 --> 00:57:04,470
videos etc here and so it is said

1649
00:57:02,819 --> 00:57:06,270
earlier pen on once to go and have a

1650
00:57:04,470 --> 00:57:07,558
play with the queries or go back over

1651
00:57:06,270 --> 00:57:10,049
the side or whatever slaves wherever

1652
00:57:07,559 --> 00:57:11,490
they can do that as well yeah just I

1653
00:57:10,049 --> 00:57:13,650
forgot to mention we chose to do Clooney

1654
00:57:11,490 --> 00:57:15,058
spins is up there really simple I forgot

1655
00:57:13,650 --> 00:57:16,500
to mention there's a holy spin it's a

1656
00:57:15,059 --> 00:57:17,790
service principle name that you register

1657
00:57:16,500 --> 00:57:19,770
for an account that doesn't exist in

1658
00:57:17,790 --> 00:57:22,020
Active Directory so there's two chances

1659
00:57:19,770 --> 00:57:23,819
to catch this you register a spin or

1660
00:57:22,020 --> 00:57:25,290
service principal name for an account

1661
00:57:23,819 --> 00:57:26,970
that doesn't exist when a low tier

1662
00:57:25,290 --> 00:57:28,500
attacker or a PC meme team arrive

1663
00:57:26,970 --> 00:57:30,569
they'll Kerberos the domain instantly

1664
00:57:28,500 --> 00:57:32,099
yeah but you know that because that

1665
00:57:30,569 --> 00:57:33,630
service will that user account than that

1666
00:57:32,099 --> 00:57:36,059
service principal name doesn't actually

1667
00:57:33,630 --> 00:57:36,510
provide services on the normal network

1668
00:57:36,059 --> 00:57:38,280
hops

1669
00:57:36,510 --> 00:57:40,440
would be no need for actually any

1670
00:57:38,280 --> 00:57:41,940
requests for that particular TGS to ever

1671
00:57:40,440 --> 00:57:44,160
be made whose nothing actually

1672
00:57:41,940 --> 00:57:46,079
legitimately talks to it well it points

1673
00:57:44,160 --> 00:57:48,210
to nothing so that's a chance one to

1674
00:57:46,079 --> 00:57:51,059
catch it you know soon as the TGS for

1675
00:57:48,210 --> 00:57:52,290
honey account you know is requested you

1676
00:57:51,059 --> 00:57:54,059
know you're being Kerberos did because

1677
00:57:52,290 --> 00:57:55,829
there's no lead and there's no there's

1678
00:57:54,059 --> 00:57:58,410
ever there's no functionality that would

1679
00:57:55,829 --> 00:58:00,000
ever leave for those VM requested

1680
00:57:58,410 --> 00:58:01,859
additionally then you give it a trivial

1681
00:58:00,000 --> 00:58:03,420
password and then an attack that will

1682
00:58:01,859 --> 00:58:05,190
pipe it into his hash cap

1683
00:58:03,420 --> 00:58:07,830
being improperly accountant gain access

1684
00:58:05,190 --> 00:58:09,390
to the plaintext password and then they

1685
00:58:07,830 --> 00:58:10,650
will use that account to vendor call

1686
00:58:09,390 --> 00:58:12,420
said trying to authenticate across it to

1687
00:58:10,650 --> 00:58:13,710
me and that is then a second chance to

1688
00:58:12,420 --> 00:58:15,870
try and capture you know so when it's

1689
00:58:13,710 --> 00:58:18,360
TGS requested or when your honey account

1690
00:58:15,870 --> 00:58:19,770
is then actively used to move to attempt

1691
00:58:18,360 --> 00:58:21,750
to authenticate into the services

1692
00:58:19,770 --> 00:58:23,820
there's two chances to create a honey

1693
00:58:21,750 --> 00:58:25,500
spin a to catch usage of honey spin

1694
00:58:23,820 --> 00:58:27,240
almost four different ways of doing it

1695
00:58:25,500 --> 00:58:28,380
all are trivially simple but there's

1696
00:58:27,240 --> 00:58:30,089
loads of copy busters for you in

1697
00:58:28,380 --> 00:58:31,680
defensive scripts just simply because

1698
00:58:30,090 --> 00:58:33,690
it's so easy to do and it's like trying

1699
00:58:31,680 --> 00:58:34,230
to shifts the battlefield back to the

1700
00:58:33,690 --> 00:58:36,030
blue team

1701
00:58:34,230 --> 00:58:37,620
you know red team has been going going

1702
00:58:36,030 --> 00:58:39,630
wild for like past sort three three five

1703
00:58:37,620 --> 00:58:41,970
years or something blue team's you

1704
00:58:39,630 --> 00:58:44,250
understand the network better than us we

1705
00:58:41,970 --> 00:58:45,180
are doing keyhole surgery down c2 from

1706
00:58:44,250 --> 00:58:46,800
the up you know potentially from the

1707
00:58:45,180 --> 00:58:48,029
other side of the planet you guys are

1708
00:58:46,800 --> 00:58:49,500
all working in those environments you

1709
00:58:48,030 --> 00:58:50,820
know the constraints and you know where

1710
00:58:49,500 --> 00:58:52,980
the critical economic functions or the

1711
00:58:50,820 --> 00:58:55,200
important base it is trying take the

1712
00:58:52,980 --> 00:58:57,780
initiative back make use of honey spins

1713
00:58:55,200 --> 00:58:59,910
maybe some technologies like elusive you

1714
00:58:57,780 --> 00:59:01,820
know they drop honey honey creds into

1715
00:58:59,910 --> 00:59:04,950
memory and all that good stuff try and

1716
00:59:01,820 --> 00:59:06,630
protect what you care about and put the

1717
00:59:04,950 --> 00:59:08,640
little metaphorical minefields around

1718
00:59:06,630 --> 00:59:10,680
those rather than trying to detect and

1719
00:59:08,640 --> 00:59:11,970
defend a Gauss all the things out all

1720
00:59:10,680 --> 00:59:13,589
the time particularly if you are

1721
00:59:11,970 --> 00:59:15,089
struggling with scale or log ingestion

1722
00:59:13,590 --> 00:59:17,190
problems oh we're dead as well don't

1723
00:59:15,090 --> 00:59:18,690
like those abilities only one things or

1724
00:59:17,190 --> 00:59:20,370
it's only one step like just being able

1725
00:59:18,690 --> 00:59:21,990
to see things as ain't gonna you know

1726
00:59:20,370 --> 00:59:24,330
protect your organization you have to be

1727
00:59:21,990 --> 00:59:25,830
able to detect container advocate and

1728
00:59:24,330 --> 00:59:27,930
remediate and if you can't do that then

1729
00:59:25,830 --> 00:59:29,370
you know you know you're going to do is

1730
00:59:27,930 --> 00:59:30,750
watch attackers run wailed in your

1731
00:59:29,370 --> 00:59:34,589
network rather than actually get them

1732
00:59:30,750 --> 00:59:36,000
out so you mindful of that as well just

1733
00:59:34,590 --> 00:59:37,440
one last thing if you are if you do have

1734
00:59:36,000 --> 00:59:38,970
forest trusts and stuff and you've got

1735
00:59:37,440 --> 00:59:41,100
like a follow-the-sun capability in your

1736
00:59:38,970 --> 00:59:42,779
blue teen site will often roast across

1737
00:59:41,100 --> 00:59:44,580
forest boundaries or international

1738
00:59:42,780 --> 00:59:46,620
boundaries because we know that they're

1739
00:59:44,580 --> 00:59:48,990
organizational or cultural or language

1740
00:59:46,620 --> 00:59:50,549
problems in between different countries

1741
00:59:48,990 --> 00:59:52,200
and different stock teams you know in

1742
00:59:50,550 --> 00:59:54,840
the stock that's here in the UK might be

1743
00:59:52,200 --> 00:59:56,430
amazing so we'll try and roast across a

1744
00:59:54,840 --> 00:59:57,870
trust into where the stock isn't as

1745
00:59:56,430 --> 00:59:59,520
skilled because we know that it'll take

1746
00:59:57,870 --> 01:00:00,960
longer for them to react and then they

1747
00:59:59,520 --> 01:00:02,460
won't want to talk to the sock over here

1748
01:00:00,960 --> 01:00:04,110
because of cultural problems so we

1749
01:00:02,460 --> 01:00:07,950
abused the people and the process as

1750
01:00:04,110 --> 01:00:10,280
well as technology I think we're all

1751
01:00:07,950 --> 01:00:10,279
good yeah

