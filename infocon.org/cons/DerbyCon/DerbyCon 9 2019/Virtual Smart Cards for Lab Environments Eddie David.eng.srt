1
00:00:00,000 --> 00:00:03,179
thank you again for coming to my

2
00:00:01,230 --> 00:00:06,150
presentation hopefully this is something

3
00:00:03,179 --> 00:00:08,700
a little bit unique that you all haven't

4
00:00:06,150 --> 00:00:10,050
seen before I know I've been like

5
00:00:08,700 --> 00:00:12,599
playing around with it in my lab

6
00:00:10,050 --> 00:00:14,160
environment and and really I emphasize

7
00:00:12,599 --> 00:00:15,839
lab environment because what I'm going

8
00:00:14,160 --> 00:00:17,430
to show you guys probably shouldn't do

9
00:00:15,839 --> 00:00:20,240
it in a production environment be kind

10
00:00:17,430 --> 00:00:24,359
of you should kind of get an idea of

11
00:00:20,240 --> 00:00:25,709
kind of the point of it and maybe you're

12
00:00:24,359 --> 00:00:27,390
looking at doing it in your own

13
00:00:25,710 --> 00:00:29,279
environment maybe already have it set up

14
00:00:27,390 --> 00:00:34,530
maybe I'm doing something different they

15
00:00:29,279 --> 00:00:37,260
you're not doing so just to get started

16
00:00:34,530 --> 00:00:39,629
a little bit about me mild a BS degree

17
00:00:37,260 --> 00:00:43,379
in management information systems it's

18
00:00:39,629 --> 00:00:47,190
just a hybrid business IT degree started

19
00:00:43,379 --> 00:00:49,649
at the age of 17 just interning doing

20
00:00:47,190 --> 00:00:52,879
the normal stuff that most people do

21
00:00:49,649 --> 00:00:56,640
float through different positions

22
00:00:52,879 --> 00:00:59,039
currently I my main focus is Active

23
00:00:56,640 --> 00:01:02,850
Directory security and Microsoft

24
00:00:59,039 --> 00:01:05,850
client-server system hardening as well

25
00:01:02,850 --> 00:01:08,729
as office 365 and Azure cloud security

26
00:01:05,850 --> 00:01:11,250
although after looking at servos talk

27
00:01:08,729 --> 00:01:13,710
yesterday I may have to kick that out

28
00:01:11,250 --> 00:01:18,030
because that was an amazing talk on

29
00:01:13,710 --> 00:01:22,889
Microsoft flow so I spent the past seven

30
00:01:18,030 --> 00:01:26,040
years working not working but donating

31
00:01:22,890 --> 00:01:28,290
my time for like a non-profit and I

32
00:01:26,040 --> 00:01:29,729
managed to get them on Azure and that's

33
00:01:28,290 --> 00:01:32,430
really kind of where I picked up a lot

34
00:01:29,729 --> 00:01:34,320
of cloud based security training because

35
00:01:32,430 --> 00:01:37,020
obviously stuff in that landscape isn't

36
00:01:34,320 --> 00:01:40,289
free so if you do get an opportunity to

37
00:01:37,020 --> 00:01:45,179
donate your time it's well worth it as a

38
00:01:40,290 --> 00:01:49,380
lot of intangible benefits my slide that

39
00:01:45,180 --> 00:01:51,720
contact content is all on github so my

40
00:01:49,380 --> 00:01:53,220
twitter handle is route sect up so you

41
00:01:51,720 --> 00:01:55,590
can go to the virtual smartcards

42
00:01:53,220 --> 00:01:58,500
repository and you can download that my

43
00:01:55,590 --> 00:02:00,750
slide decks you can download the video

44
00:01:58,500 --> 00:02:03,119
presentations because I have a lot of

45
00:02:00,750 --> 00:02:04,740
interactive demos so I'm gonna try not

46
00:02:03,119 --> 00:02:06,890
bore you to death with a bunch of slide

47
00:02:04,740 --> 00:02:09,929
decks

48
00:02:06,890 --> 00:02:12,680
so so the main purpose of this is

49
00:02:09,929 --> 00:02:15,750
passwords and I think in any environment

50
00:02:12,680 --> 00:02:18,300
people want to get past passwords and

51
00:02:15,750 --> 00:02:21,390
you have a lot of you have a lot of

52
00:02:18,300 --> 00:02:25,140
stumbling blocks and and this this to me

53
00:02:21,390 --> 00:02:26,970
is perfect sense because we have end

54
00:02:25,140 --> 00:02:30,059
users that do really dumb things with

55
00:02:26,970 --> 00:02:35,700
passwords so that that's what this talk

56
00:02:30,060 --> 00:02:38,250
in a nutshell is about so another thing

57
00:02:35,700 --> 00:02:41,609
that's changed in kind of password

58
00:02:38,250 --> 00:02:45,569
landscape if you don't follow it when

59
00:02:41,610 --> 00:02:47,280
Microsoft released Windows 10 1903 they

60
00:02:45,569 --> 00:02:50,220
came out with some very radical

61
00:02:47,280 --> 00:02:52,739
different password guidance they they

62
00:02:50,220 --> 00:02:54,629
basically if you look at this and

63
00:02:52,739 --> 00:02:57,329
hopefully it's clear enough if not

64
00:02:54,629 --> 00:02:59,940
download my slide decks they they got

65
00:02:57,329 --> 00:03:03,000
rid of the they got rid of password

66
00:02:59,940 --> 00:03:06,599
explorations and that was very

67
00:03:03,000 --> 00:03:13,560
controversial a lot of people had just

68
00:03:06,599 --> 00:03:16,649
kind of thought that everyone was used

69
00:03:13,560 --> 00:03:20,130
to changing passwords and for me when

70
00:03:16,650 --> 00:03:23,069
you said when you set you know 30 45 90

71
00:03:20,130 --> 00:03:27,030
days some people have a really hard time

72
00:03:23,069 --> 00:03:29,310
picking and choosing secure passwords so

73
00:03:27,030 --> 00:03:31,769
this is kind of working in tandem with

74
00:03:29,310 --> 00:03:34,730
some of those new policy capabilities

75
00:03:31,769 --> 00:03:37,769
that Microsoft is kind of come out with

76
00:03:34,730 --> 00:03:39,510
so another thing to think about if

77
00:03:37,769 --> 00:03:44,069
you're doing more advanced stuff like

78
00:03:39,510 --> 00:03:47,608
ESA admin forest you got to think about

79
00:03:44,069 --> 00:03:50,149
isolated identities so you know smart

80
00:03:47,609 --> 00:03:54,690
card technology is really nothing new

81
00:03:50,150 --> 00:03:56,700
but at the same time you even even out

82
00:03:54,690 --> 00:03:58,380
in those areas you don't want people to

83
00:03:56,700 --> 00:04:00,208
use passwords especially if you have a

84
00:03:58,380 --> 00:04:01,950
forest trust and you have all your

85
00:04:00,209 --> 00:04:07,430
admins in a different force and you're

86
00:04:01,950 --> 00:04:10,380
segregating your two environments so

87
00:04:07,430 --> 00:04:11,910
with that being said whenever you don't

88
00:04:10,380 --> 00:04:14,129
have those options

89
00:04:11,910 --> 00:04:18,329
Windows 10 hello for business isn't an

90
00:04:14,129 --> 00:04:19,889
option and you want to use MFA smart

91
00:04:18,329 --> 00:04:24,870
cards is the way to go

92
00:04:19,889 --> 00:04:27,569
and when you're doing all this stuff and

93
00:04:24,870 --> 00:04:30,870
you set this for the first time and this

94
00:04:27,569 --> 00:04:32,699
is nothing new you you go into the

95
00:04:30,870 --> 00:04:36,180
project count properties of a privileged

96
00:04:32,699 --> 00:04:38,939
user and you right-click on that box

97
00:04:36,180 --> 00:04:43,909
that says hey smartcard is required for

98
00:04:38,939 --> 00:04:47,580
interactive logon some things happen

99
00:04:43,909 --> 00:04:48,930
traditionally in the past you get a one

100
00:04:47,580 --> 00:04:53,688
hundred and twenty character random

101
00:04:48,930 --> 00:04:57,349
value the password hash never changes so

102
00:04:53,689 --> 00:05:01,500
hopefully as people are moving beyond

103
00:04:57,349 --> 00:05:04,229
Windows 2008 since that is coming up end

104
00:05:01,500 --> 00:05:06,120
of life very very soon it's gonna get

105
00:05:04,229 --> 00:05:09,870
you here before we know it and people

106
00:05:06,120 --> 00:05:11,400
are migrating systems you know we're

107
00:05:09,870 --> 00:05:14,039
gonna be everyone's gonna be the same

108
00:05:11,400 --> 00:05:15,960
boat when you start migrating 2012 r2

109
00:05:14,039 --> 00:05:17,729
systems and so you start thinking about

110
00:05:15,960 --> 00:05:19,589
the main controllers and where you need

111
00:05:17,729 --> 00:05:22,699
to go and where you need to get to and

112
00:05:19,589 --> 00:05:25,949
this has always been a problem with

113
00:05:22,699 --> 00:05:27,569
smart cards because they were very very

114
00:05:25,949 --> 00:05:30,300
vulnerable to passes pass the hash

115
00:05:27,569 --> 00:05:33,150
attacks if you are doing things

116
00:05:30,300 --> 00:05:40,259
correctly with segregating your admin

117
00:05:33,150 --> 00:05:43,739
workstations so enter in 2016 forests so

118
00:05:40,259 --> 00:05:46,169
there's a tribute here it's it's

119
00:05:43,740 --> 00:05:48,300
basically expired passwords on smart

120
00:05:46,169 --> 00:05:52,620
card only accounts this is only

121
00:05:48,300 --> 00:05:55,409
available in Server 2016 forest you have

122
00:05:52,620 --> 00:05:58,020
to be at a forest functional and domain

123
00:05:55,409 --> 00:06:00,479
functional level and Server 2016 for us

124
00:05:58,020 --> 00:06:03,839
so if you upgrade Active Directory it's

125
00:06:00,479 --> 00:06:05,219
definitely not on by default so you're

126
00:06:03,839 --> 00:06:08,939
probably going to want to check mark

127
00:06:05,219 --> 00:06:13,409
that box whenever you put it up to allow

128
00:06:08,939 --> 00:06:15,419
ntlm secrets to automatically rotate in

129
00:06:13,409 --> 00:06:18,870
accordance with what are you whatever

130
00:06:15,419 --> 00:06:21,628
your password policies are so then that

131
00:06:18,870 --> 00:06:22,919
gets a little bit more fun because then

132
00:06:21,629 --> 00:06:26,460
you can start looking at other things

133
00:06:22,919 --> 00:06:31,380
like fine-grained password policies hey

134
00:06:26,460 --> 00:06:33,180
I got somebody with a hardware token and

135
00:06:31,380 --> 00:06:36,240
I don't care when they use it how they

136
00:06:33,180 --> 00:06:38,760
use it what data use it but I'm gonna go

137
00:06:36,240 --> 00:06:40,920
ahead and I'm going to set my 120

138
00:06:38,760 --> 00:06:42,930
character value and I'm gonna tell that

139
00:06:40,920 --> 00:06:48,450
password hash to rotate every two days

140
00:06:42,930 --> 00:06:50,550
mmm sounds crazy but once we get past

141
00:06:48,450 --> 00:06:53,490
where we're using hardware-based tokens

142
00:06:50,550 --> 00:06:55,200
or password Allah solutions this will

143
00:06:53,490 --> 00:06:57,090
start making more sense and later on my

144
00:06:55,200 --> 00:07:00,180
slide decks you'll kind of see the

145
00:06:57,090 --> 00:07:02,039
ubiquity of this across other systems

146
00:07:00,180 --> 00:07:09,360
than the besides just Active Directory

147
00:07:02,040 --> 00:07:12,030
for us so there's four and I'm sorry

148
00:07:09,360 --> 00:07:17,640
that the one got cut off the top the one

149
00:07:12,030 --> 00:07:20,130
at the top is deny access to computer

150
00:07:17,640 --> 00:07:24,510
from the network so basically what these

151
00:07:20,130 --> 00:07:26,460
are these are just templates and outside

152
00:07:24,510 --> 00:07:29,909
you're privileged access workstations

153
00:07:26,460 --> 00:07:31,830
you should really be adding this to both

154
00:07:29,910 --> 00:07:35,040
your member server and client server

155
00:07:31,830 --> 00:07:36,840
landscape it's gonna get your domain and

156
00:07:35,040 --> 00:07:39,120
enterprise admins if any of those users

157
00:07:36,840 --> 00:07:42,000
exist so they're only gonna be able to

158
00:07:39,120 --> 00:07:44,430
log into certain places so you want them

159
00:07:42,000 --> 00:07:48,420
to jump from a privileged admin box to

160
00:07:44,430 --> 00:07:51,690
domain controllers or any other jump box

161
00:07:48,420 --> 00:07:54,510
where they may have to they may have to

162
00:07:51,690 --> 00:07:56,670
triage Active Directory or maintain it

163
00:07:54,510 --> 00:07:58,620
and you don't want those users jumping

164
00:07:56,670 --> 00:08:00,270
to other systems especially when those

165
00:07:58,620 --> 00:08:06,480
systems are getting connected to the

166
00:08:00,270 --> 00:08:09,090
Internet which leads to this so past the

167
00:08:06,480 --> 00:08:10,890
house is a problem and that's why it's

168
00:08:09,090 --> 00:08:13,469
set on this fit this previous slide deck

169
00:08:10,890 --> 00:08:15,840
these settings are very important if you

170
00:08:13,470 --> 00:08:18,330
download the DISA stiggs and just even

171
00:08:15,840 --> 00:08:22,320
look at the reports these are there so

172
00:08:18,330 --> 00:08:24,510
they're pretty there they're very

173
00:08:22,320 --> 00:08:25,710
understanding with hey here's the groups

174
00:08:24,510 --> 00:08:27,480
that you really need to put in these

175
00:08:25,710 --> 00:08:33,598
because even with Microsoft guidance

176
00:08:27,480 --> 00:08:35,760
this is not defaulted in there so just a

177
00:08:33,599 --> 00:08:37,650
couple warnings just some disclaimers

178
00:08:35,760 --> 00:08:41,340
that's why I put that this is a lab

179
00:08:37,650 --> 00:08:42,140
environment hopefully like many of you

180
00:08:41,340 --> 00:08:45,470
who

181
00:08:42,140 --> 00:08:47,720
what I do I have a lab I like to play

182
00:08:45,470 --> 00:08:50,330
around with stuff I like to break stuff

183
00:08:47,720 --> 00:08:53,000
down I like to get into Metasploit and

184
00:08:50,330 --> 00:08:56,540
get into that area because it really

185
00:08:53,000 --> 00:08:58,100
helps me understand what I'm doing on

186
00:08:56,540 --> 00:09:00,530
the active directory side especially

187
00:08:58,100 --> 00:09:04,010
whenever it comes to the fact of

188
00:09:00,530 --> 00:09:06,230
securing your users so deploying an

189
00:09:04,010 --> 00:09:07,930
enterprise root CA role to it to a

190
00:09:06,230 --> 00:09:10,520
domain controller could lead to resume

191
00:09:07,930 --> 00:09:11,900
generating event I don't suggest that at

192
00:09:10,520 --> 00:09:15,319
all

193
00:09:11,900 --> 00:09:17,569
so but that's that's why I do in my lab

194
00:09:15,320 --> 00:09:21,560
to kind of conserve space to reduce

195
00:09:17,570 --> 00:09:24,200
memory footprint and PK I can be complex

196
00:09:21,560 --> 00:09:26,449
to roll out so I have 30 minutes to do

197
00:09:24,200 --> 00:09:30,550
this so we're just going to do a 1/2

198
00:09:26,450 --> 00:09:34,250
your ADCs environment don't recommend it

199
00:09:30,550 --> 00:09:37,160
another thing be SES will be depreciated

200
00:09:34,250 --> 00:09:39,050
there's no set date so you can go in you

201
00:09:37,160 --> 00:09:41,060
can download the latest Windows 10 build

202
00:09:39,050 --> 00:09:43,969
and I'll show you later on how to do

203
00:09:41,060 --> 00:09:46,160
this but but the whole point of this is

204
00:09:43,970 --> 00:09:49,160
if you don't have physical Hardware gear

205
00:09:46,160 --> 00:09:51,650
you can still provision out smart cards

206
00:09:49,160 --> 00:09:54,829
to an environment with the virtualized

207
00:09:51,650 --> 00:09:58,069
TPM chip so this is just a low-cost way

208
00:09:54,830 --> 00:09:59,120
of deployment the bright side is a lot

209
00:09:58,070 --> 00:10:03,050
of what I'm going to show you here is

210
00:09:59,120 --> 00:10:08,080
applicable to give you key fives so that

211
00:10:03,050 --> 00:10:12,189
landscape is growing between personal

212
00:10:08,080 --> 00:10:15,470
professional type of logins you know

213
00:10:12,190 --> 00:10:17,870
Google Google advanced threat they're

214
00:10:15,470 --> 00:10:20,650
the Google advanced management program

215
00:10:17,870 --> 00:10:24,230
you know you sign it with DB keys there

216
00:10:20,650 --> 00:10:27,110
adders in preview so this can kind of

217
00:10:24,230 --> 00:10:29,120
extend well beyond that realm so if I if

218
00:10:27,110 --> 00:10:31,580
I get time I will show you how to do

219
00:10:29,120 --> 00:10:33,800
that if I'm out of time please download

220
00:10:31,580 --> 00:10:35,660
the slide decks and the demo content

221
00:10:33,800 --> 00:10:38,420
you'll see how I'm doing some that stuff

222
00:10:35,660 --> 00:10:40,550
so obviously the path before word is

223
00:10:38,420 --> 00:10:42,860
Windows 10 hello for business Microsoft

224
00:10:40,550 --> 00:10:44,660
is recommending to go that route but I'm

225
00:10:42,860 --> 00:10:47,690
not discussing any of that today this is

226
00:10:44,660 --> 00:10:50,209
really if you're not on office 365 is

227
00:10:47,690 --> 00:10:51,800
your customer or maybe you're using an

228
00:10:50,210 --> 00:10:54,320
enterprise security administrative

229
00:10:51,800 --> 00:10:57,550
forest for isolated identities then

230
00:10:54,320 --> 00:11:01,930
smart card is still the path

231
00:10:57,550 --> 00:11:05,510
so just a couple prerequisites here so

232
00:11:01,930 --> 00:11:08,839
this works on not only hyper-v

233
00:11:05,510 --> 00:11:11,150
workstation it also works on VMware

234
00:11:08,840 --> 00:11:12,950
Workstation I crossed out a few things

235
00:11:11,150 --> 00:11:14,630
because this is normally how I would

236
00:11:12,950 --> 00:11:17,060
deploy an Active Directory certificate

237
00:11:14,630 --> 00:11:19,910
services environment I'd have an offline

238
00:11:17,060 --> 00:11:22,760
root CA an enterprise sub CA and then

239
00:11:19,910 --> 00:11:24,170
and then an online Enterprise CA it's

240
00:11:22,760 --> 00:11:26,630
very important if you're doing this

241
00:11:24,170 --> 00:11:30,020
beyond the lab to have an offline root

242
00:11:26,630 --> 00:11:31,970
CA it's going to prevent any type of

243
00:11:30,020 --> 00:11:34,310
compromise or at least it's going to be

244
00:11:31,970 --> 00:11:35,690
a lot harder to compromise root

245
00:11:34,310 --> 00:11:37,459
certificate authority whenever it's

246
00:11:35,690 --> 00:11:39,440
completely offline desegregated from

247
00:11:37,460 --> 00:11:41,420
your network and then we're going to

248
00:11:39,440 --> 00:11:47,090
Windows 10 19:03 client with a virtual

249
00:11:41,420 --> 00:11:49,939
TPM enabled so along with that I don't

250
00:11:47,090 --> 00:11:51,800
disable ipv6 there's actually some

251
00:11:49,940 --> 00:11:54,290
Microsoft guidance on what they prefer

252
00:11:51,800 --> 00:11:58,520
you to do which is there's a registry

253
00:11:54,290 --> 00:12:00,530
key to prefer ipv4 over ipv6 and I'm

254
00:11:58,520 --> 00:12:03,410
gonna use this config to set a static IP

255
00:12:00,530 --> 00:12:05,689
I'm going to install a DDS and confirm

256
00:12:03,410 --> 00:12:07,760
my domain controllers running and I'm

257
00:12:05,690 --> 00:12:10,430
just gonna give you a very quick demo of

258
00:12:07,760 --> 00:12:14,500
a way to set up your own domain

259
00:12:10,430 --> 00:12:14,500
controller using nothing but server core

260
00:12:32,210 --> 00:12:37,710
okay default server and cor I'm getting

261
00:12:35,670 --> 00:12:39,569
into s config s configures your friend

262
00:12:37,710 --> 00:12:41,970
because it gives you tons of menu

263
00:12:39,570 --> 00:12:43,470
options I already have some IP addresses

264
00:12:41,970 --> 00:12:45,690
in here because I have a PS since

265
00:12:43,470 --> 00:12:49,620
firewall setup so I'm going to go ahead

266
00:12:45,690 --> 00:12:53,400
and static IP this guy plug in my

267
00:12:49,620 --> 00:12:54,990
Gateway to my PS since firewall then

268
00:12:53,400 --> 00:12:57,449
then you're going to notice here on my

269
00:12:54,990 --> 00:13:03,140
DNS server I'm gonna go ahead and just

270
00:12:57,450 --> 00:13:05,820
do 2.2 so that's that set that's done

271
00:13:03,140 --> 00:13:09,360
we're off and running we we have a

272
00:13:05,820 --> 00:13:11,220
static IP and then next what we're going

273
00:13:09,360 --> 00:13:16,250
to do here is we're going to get into

274
00:13:11,220 --> 00:13:19,080
powershell and if you ever set up a

275
00:13:16,250 --> 00:13:21,600
server core with active directory this

276
00:13:19,080 --> 00:13:24,690
is this basically how you do it you can

277
00:13:21,600 --> 00:13:28,800
you can automate it with scripts so you

278
00:13:24,690 --> 00:13:40,350
can get windows get windows feature 80

279
00:13:28,800 --> 00:13:45,329
domain services and install install

280
00:13:40,350 --> 00:13:49,530
windows feature so this is going to

281
00:13:45,330 --> 00:13:52,320
download all the modules and I'm gonna

282
00:13:49,530 --> 00:13:55,230
go a little bit further so it's

283
00:13:52,320 --> 00:13:58,740
installed and next we're going to import

284
00:13:55,230 --> 00:14:06,630
all the modules a little bit further he

285
00:13:58,740 --> 00:14:07,740
is I'm worried about time here and then

286
00:14:06,630 --> 00:14:10,530
we're gonna go ahead and we're going to

287
00:14:07,740 --> 00:14:12,360
install our 80 PS force this is brand

288
00:14:10,530 --> 00:14:18,000
new forest so I'm just gonna call it sec

289
00:14:12,360 --> 00:14:21,570
lab gonna give my safe mode

290
00:14:18,000 --> 00:14:25,620
administrator password and then pretty

291
00:14:21,570 --> 00:14:27,600
much at this point the forest is going

292
00:14:25,620 --> 00:14:30,960
to go off and it's going to run it's

293
00:14:27,600 --> 00:14:33,690
going to start installing so that a

294
00:14:30,960 --> 00:14:36,390
nutshell want to reboots you should be

295
00:14:33,690 --> 00:14:40,020
good if for some reason this is your

296
00:14:36,390 --> 00:14:42,270
first domain controller and after you

297
00:14:40,020 --> 00:14:45,060
reboot you may want to run

298
00:14:42,270 --> 00:14:46,980
in that connection profile and unplug

299
00:14:45,060 --> 00:14:49,319
your NIC and we plug it back in because

300
00:14:46,980 --> 00:14:51,000
your firewall rules may be messed up it

301
00:14:49,320 --> 00:14:53,990
may switch over to public since it's the

302
00:14:51,000 --> 00:14:56,580
first one so that's really kind of it on

303
00:14:53,990 --> 00:14:58,110
basically setting up your first domain

304
00:14:56,580 --> 00:15:00,270
controller you see here I'm running to

305
00:14:58,110 --> 00:15:04,410
actually a red script to prefer ipv4

306
00:15:00,270 --> 00:15:06,949
over ipv6 so so that's that's all done

307
00:15:04,410 --> 00:15:11,310
we have our first domain controller

308
00:15:06,950 --> 00:15:14,279
setup so next I'm gonna get on my

309
00:15:11,310 --> 00:15:16,890
Windows 10 device and on I believe it's

310
00:15:14,279 --> 00:15:19,020
1809 above you have to go with optional

311
00:15:16,890 --> 00:15:20,819
features and download barsaat tools that

312
00:15:19,020 --> 00:15:23,760
way so I'm gonna I'm going to download

313
00:15:20,820 --> 00:15:26,430
all the tools that I need to get this

314
00:15:23,760 --> 00:15:30,810
rolling so next I'm going to install a

315
00:15:26,430 --> 00:15:33,449
ADCs on my domain controller so got

316
00:15:30,810 --> 00:15:35,959
another little short presentation on

317
00:15:33,450 --> 00:15:35,959
that

318
00:15:46,209 --> 00:15:52,579
so here what we're doing we are putting

319
00:15:49,610 --> 00:15:56,930
our credentials in we're going to hit

320
00:15:52,579 --> 00:15:58,579
okay here because it's run server core

321
00:15:56,930 --> 00:16:01,579
only I have to connect to it remotely

322
00:15:58,579 --> 00:16:03,800
through server manager so we're doing

323
00:16:01,579 --> 00:16:06,199
that so it's gonna look and make sure

324
00:16:03,800 --> 00:16:07,880
that valid enterprise admin credentials

325
00:16:06,200 --> 00:16:11,870
so I'm going to select my certificate

326
00:16:07,880 --> 00:16:14,060
authority and then next I'm just going

327
00:16:11,870 --> 00:16:17,510
to do it on our online enterprise root

328
00:16:14,060 --> 00:16:20,719
CA so then I'm gonna get to my private

329
00:16:17,510 --> 00:16:23,240
key options and right here you're gonna

330
00:16:20,720 --> 00:16:24,529
notice I'm going to select a shot 256

331
00:16:23,240 --> 00:16:26,690
hash and I'm gonna get into that a

332
00:16:24,529 --> 00:16:30,680
little bit further because people have a

333
00:16:26,690 --> 00:16:32,839
tendency to go exotic or extreme or they

334
00:16:30,680 --> 00:16:35,510
want to make sure that they are securing

335
00:16:32,839 --> 00:16:37,850
that root CA in a way that they're not

336
00:16:35,510 --> 00:16:39,500
gonna have to touch it for years and I'm

337
00:16:37,850 --> 00:16:41,720
gonna explain a little pitfall with that

338
00:16:39,500 --> 00:16:45,670
because I think some people run into it

339
00:16:41,720 --> 00:16:53,660
so kind of at that point ADCs is

340
00:16:45,670 --> 00:16:56,689
installed it's ready to go there are

341
00:16:53,660 --> 00:17:01,579
four MMC tools that I always collapse in

342
00:16:56,690 --> 00:17:05,089
and use so I I'll put in an enterprise

343
00:17:01,579 --> 00:17:06,709
PKI the the certificate template the

344
00:17:05,089 --> 00:17:08,899
certificates that point to the domain

345
00:17:06,709 --> 00:17:12,199
controller and the certificate authority

346
00:17:08,900 --> 00:17:15,919
that points to the domain controller so

347
00:17:12,199 --> 00:17:18,079
now that I got all that stuff I'm gonna

348
00:17:15,919 --> 00:17:24,290
tell you right now that ABC is gonna

349
00:17:18,079 --> 00:17:26,869
have issues Microsoft so so whenever you

350
00:17:24,290 --> 00:17:29,030
open up that enterprise PKI you're gonna

351
00:17:26,869 --> 00:17:31,909
see some like red X's and you're gonna

352
00:17:29,030 --> 00:17:35,120
think what the hell is going on so run a

353
00:17:31,910 --> 00:17:37,760
gpupdate slash Forks force refresh it

354
00:17:35,120 --> 00:17:40,010
it'll fix it and the reason being is

355
00:17:37,760 --> 00:17:43,220
once you deploy that first online

356
00:17:40,010 --> 00:17:45,440
enterprise CA if you get into the

357
00:17:43,220 --> 00:17:48,200
properties of your enterprise PK manage

358
00:17:45,440 --> 00:17:51,200
ad containers you're going to notice

359
00:17:48,200 --> 00:17:54,230
that what you just deployed is actually

360
00:17:51,200 --> 00:17:57,470
in the certificate authorities container

361
00:17:54,230 --> 00:17:58,160
but you need to let policy take hold of

362
00:17:57,470 --> 00:17:59,990
all your machine

363
00:17:58,160 --> 00:18:01,570
so that that root CA just gets rolled

364
00:17:59,990 --> 00:18:06,440
out so that's why you have to do that

365
00:18:01,570 --> 00:18:08,330
not a big deal you see number two so

366
00:18:06,440 --> 00:18:10,310
because we've rolled this out onto a

367
00:18:08,330 --> 00:18:12,399
domain controller we have a domain

368
00:18:10,310 --> 00:18:15,530
controller certificate that's

369
00:18:12,400 --> 00:18:17,930
certificate does not support Kerberos

370
00:18:15,530 --> 00:18:20,570
syndication and it does not support

371
00:18:17,930 --> 00:18:23,660
smart cards or outbox we're gonna have

372
00:18:20,570 --> 00:18:25,639
we got problems and this is on like a

373
00:18:23,660 --> 00:18:27,830
server 20:19 domain controller so this

374
00:18:25,640 --> 00:18:33,560
this prima this pretty much is what

375
00:18:27,830 --> 00:18:35,300
happens by default so whenever you get

376
00:18:33,560 --> 00:18:37,210
in and look at the templates there are

377
00:18:35,300 --> 00:18:41,060
like three different domain controller

378
00:18:37,210 --> 00:18:43,670
templates and the first time I was ever

379
00:18:41,060 --> 00:18:48,110
even exposed ADCs and like which one do

380
00:18:43,670 --> 00:18:51,050
I use so use Kerberos authentication if

381
00:18:48,110 --> 00:18:52,280
you are if you are on 2008 above you

382
00:18:51,050 --> 00:18:55,159
should be using Kerberos authentication

383
00:18:52,280 --> 00:18:58,639
so Kerberos authentication supports

384
00:18:55,160 --> 00:19:01,850
smart cards also so that's going to set

385
00:18:58,640 --> 00:19:03,770
their KDC so you use Kerberos

386
00:19:01,850 --> 00:19:06,139
authentication kick the other ones out

387
00:19:03,770 --> 00:19:08,240
you do not need them that's that's

388
00:19:06,140 --> 00:19:12,590
explained in this blog URL on why you

389
00:19:08,240 --> 00:19:16,190
want to do that so another one on the

390
00:19:12,590 --> 00:19:20,120
hate how do we how do we do all that how

391
00:19:16,190 --> 00:19:22,010
do we perform all these fixes and get

392
00:19:20,120 --> 00:19:22,689
this set up to where it really should be

393
00:19:22,010 --> 00:19:30,620
going

394
00:19:22,690 --> 00:19:33,500
so I'm gonna go ahead and do that let me

395
00:19:30,620 --> 00:19:35,719
go into my video and get that that'll

396
00:19:33,500 --> 00:19:37,520
probably be much helpful

397
00:19:35,720 --> 00:19:39,680
so right here I'm looking at my

398
00:19:37,520 --> 00:19:41,530
certificate templates I see my domain

399
00:19:39,680 --> 00:19:45,830
controller template I'm going to dump it

400
00:19:41,530 --> 00:19:49,250
it's not needed so I'm gonna get rid of

401
00:19:45,830 --> 00:19:52,070
domain controller authentication really

402
00:19:49,250 --> 00:19:53,780
not need it either for this so then I'm

403
00:19:52,070 --> 00:19:56,840
gonna get into my certificate templates

404
00:19:53,780 --> 00:20:00,530
and I'm going to go to Kerberos

405
00:19:56,840 --> 00:20:02,540
authentication and then go back to my my

406
00:20:00,530 --> 00:20:05,360
certificate templates I'm gonna click on

407
00:20:02,540 --> 00:20:08,389
new I want to issue that certificate

408
00:20:05,360 --> 00:20:11,879
template to my domain controller so

409
00:20:08,390 --> 00:20:14,820
gonna go ahead and click OK so

410
00:20:11,880 --> 00:20:17,669
I just left the defaults the way that

411
00:20:14,820 --> 00:20:20,879
the template was created you're gonna

412
00:20:17,669 --> 00:20:25,429
notice here like by refresh you're gonna

413
00:20:20,880 --> 00:20:28,230
see my original domain controller sir

414
00:20:25,429 --> 00:20:30,900
template in there so I'm just going to

415
00:20:28,230 --> 00:20:33,120
go ahead and I'm going to kill that so

416
00:20:30,900 --> 00:20:42,570
you kind of see it right there there we

417
00:20:33,120 --> 00:20:44,939
go okay it's dead since we're running

418
00:20:42,570 --> 00:20:46,559
server core I'm going to use get

419
00:20:44,940 --> 00:20:50,130
certificate I'm just going to power sell

420
00:20:46,559 --> 00:20:51,480
remote into the domain controller gonna

421
00:20:50,130 --> 00:20:54,210
issue my Kerberos authentication

422
00:20:51,480 --> 00:20:56,789
certificate from that point I refresh

423
00:20:54,210 --> 00:20:58,380
it's in there you should not have to

424
00:20:56,789 --> 00:21:01,770
reboot the domain controller that should

425
00:20:58,380 --> 00:21:04,730
be a transient change so at this point I

426
00:21:01,770 --> 00:21:09,270
at least got a basis infrastructure to

427
00:21:04,730 --> 00:21:16,770
to set up smart cards so next what we're

428
00:21:09,270 --> 00:21:18,570
going to do here and I got that listed

429
00:21:16,770 --> 00:21:21,179
in my slide here too so whenever you

430
00:21:18,570 --> 00:21:24,230
download it you'll see what is you'd so

431
00:21:21,179 --> 00:21:26,700
you can do in your lab and then also

432
00:21:24,230 --> 00:21:29,070
anything that was issued out with that

433
00:21:26,700 --> 00:21:30,780
domain controller template get into your

434
00:21:29,070 --> 00:21:33,210
shoot certificates on your certificate

435
00:21:30,780 --> 00:21:36,149
authority and pop it out revoke it do a

436
00:21:33,210 --> 00:21:37,799
cease of operations some people

437
00:21:36,150 --> 00:21:41,159
depending on what landscape you're in

438
00:21:37,799 --> 00:21:42,990
whether you're working for the DoD any

439
00:21:41,159 --> 00:21:45,390
type of critical infrastructure there's

440
00:21:42,990 --> 00:21:48,210
a dog there's from the cns website

441
00:21:45,390 --> 00:21:51,179
that's like an estate guidance on

442
00:21:48,210 --> 00:21:53,070
encryption keys to use this is kind of a

443
00:21:51,179 --> 00:21:55,919
doc they released a few years ago for

444
00:21:53,070 --> 00:21:58,770
post quantum cryptography and some

445
00:21:55,919 --> 00:22:01,710
people some 80 SCS people will actually

446
00:21:58,770 --> 00:22:03,870
see this and they'll be like oh I want

447
00:22:01,710 --> 00:22:07,559
to go ahead and choose something really

448
00:22:03,870 --> 00:22:10,500
strong I want to protect myself from the

449
00:22:07,559 --> 00:22:13,049
NSA I'm gonna use this sha-512 hash and

450
00:22:10,500 --> 00:22:14,669
you know some people unfortunately have

451
00:22:13,049 --> 00:22:17,429
this mentality that where they want to

452
00:22:14,669 --> 00:22:19,320
use the exotic crypto please don't

453
00:22:17,429 --> 00:22:20,909
you're gonna find that it's incompatible

454
00:22:19,320 --> 00:22:22,070
with with gear and stuff that you want

455
00:22:20,909 --> 00:22:24,350
to sign

456
00:22:22,070 --> 00:22:26,780
and and people are doing it that they

457
00:22:24,350 --> 00:22:28,669
they they asked like hey I'm trying to

458
00:22:26,780 --> 00:22:31,160
establish a TLS 1 2 connection with

459
00:22:28,670 --> 00:22:34,150
Active Directory server using Shia shop

460
00:22:31,160 --> 00:22:38,090
5 pulse certificates it's not working

461
00:22:34,150 --> 00:22:42,140
here's wife so whenever I hit my domain

462
00:22:38,090 --> 00:22:44,090
control over 636 with an nmap scan I get

463
00:22:42,140 --> 00:22:46,340
all the different ciphers from 1o

464
00:22:44,090 --> 00:22:48,500
through 1/2 and you'll probably know

465
00:22:46,340 --> 00:22:52,610
some interesting there that it sports 3

466
00:22:48,500 --> 00:22:54,770
does suite 32 attacks so if if you're

467
00:22:52,610 --> 00:22:56,090
into like compliance in scanning that

468
00:22:54,770 --> 00:22:58,910
type of thing you may want to pop that

469
00:22:56,090 --> 00:23:01,070
out or your permission security you guys

470
00:22:58,910 --> 00:23:03,550
get make it mad at you there's no

471
00:23:01,070 --> 00:23:07,580
practical attacks for sweet 32 but

472
00:23:03,550 --> 00:23:09,889
disable it Eve my the reason why I'm

473
00:23:07,580 --> 00:23:13,870
harping on LDAP is whenever you set up a

474
00:23:09,890 --> 00:23:13,870
one tiered ADCs forest

475
00:23:14,500 --> 00:23:19,970
it relies on LDAP so that's why I'm

476
00:23:17,570 --> 00:23:23,090
picking on LDAP you do something like

477
00:23:19,970 --> 00:23:23,860
sha-512 nothing's going to work you're

478
00:23:23,090 --> 00:23:26,540
gonna have problems

479
00:23:23,860 --> 00:23:29,780
so I officially started to start a hate

480
00:23:26,540 --> 00:23:32,330
LDAP really a hierarchy you should

481
00:23:29,780 --> 00:23:34,970
probably like a you should pride set

482
00:23:32,330 --> 00:23:39,020
your online responders for revocation to

483
00:23:34,970 --> 00:23:40,640
like a web server so so next I'm just

484
00:23:39,020 --> 00:23:43,550
gonna get in meet a provisioning a

485
00:23:40,640 --> 00:23:46,100
virtual smart card so on my hosts I

486
00:23:43,550 --> 00:23:48,860
don't have a TPM you kind of see out in

487
00:23:46,100 --> 00:23:51,110
the power so wind up in hyper-v you can

488
00:23:48,860 --> 00:23:53,479
check mark a box that says hey I want to

489
00:23:51,110 --> 00:23:56,479
enable trusted platform module support

490
00:23:53,480 --> 00:23:58,250
so you can do that you can do that with

491
00:23:56,480 --> 00:24:00,230
VMware you got it if you do it with

492
00:23:58,250 --> 00:24:05,560
VMware you got to encrypt it first and

493
00:24:00,230 --> 00:24:09,470
then you can pop out a virtual TPM chip

494
00:24:05,560 --> 00:24:11,360
see don't even need to do it so in

495
00:24:09,470 --> 00:24:14,630
essence of time I'm going to talk about

496
00:24:11,360 --> 00:24:17,570
TPM service manager that's how to

497
00:24:14,630 --> 00:24:21,020
provision virtual smart cards yeah ten

498
00:24:17,570 --> 00:24:23,689
minutes so good timing so what I'm gonna

499
00:24:21,020 --> 00:24:25,970
do I'm gonna do a demo on how to

500
00:24:23,690 --> 00:24:28,190
provision that how to provision your

501
00:24:25,970 --> 00:24:30,460
first virtual smart card and get logged

502
00:24:28,190 --> 00:24:30,460
in

503
00:24:36,730 --> 00:24:43,250
make sure that I get that out so right

504
00:24:41,870 --> 00:24:46,340
here what you're seeing is I'm going

505
00:24:43,250 --> 00:24:48,470
through my certificate template on

506
00:24:46,340 --> 00:24:51,080
duplicating the smart card log on

507
00:24:48,470 --> 00:24:53,530
certain certificate template and if you

508
00:24:51,080 --> 00:24:56,300
my previous slide if you look at the URL

509
00:24:53,530 --> 00:24:59,149
it goes like how to how to actually

510
00:24:56,300 --> 00:25:01,159
provision these settings so I'm just

511
00:24:59,150 --> 00:25:04,240
gonna call a TPM virtual smart card

512
00:25:01,160 --> 00:25:07,610
logon I'm just gonna set it to two years

513
00:25:04,240 --> 00:25:12,620
mm-hmm just set my request handling over

514
00:25:07,610 --> 00:25:15,320
to signature and smart card logon gonna

515
00:25:12,620 --> 00:25:17,300
hit okay so here's kind of Rob with

516
00:25:15,320 --> 00:25:21,980
virtual smart cards you still have to

517
00:25:17,300 --> 00:25:24,200
use RSA 2048 completely fine just make

518
00:25:21,980 --> 00:25:26,390
sure that you use the Microsoft smart

519
00:25:24,200 --> 00:25:28,220
card based crypto provider otherwise

520
00:25:26,390 --> 00:25:29,990
this will not work and that those are

521
00:25:28,220 --> 00:25:32,120
those are in the Microsoft instructions

522
00:25:29,990 --> 00:25:34,670
I'm just going to provision like give a

523
00:25:32,120 --> 00:25:37,969
couple users access to enroll luke

524
00:25:34,670 --> 00:25:39,770
skywalker's my domain admins you can set

525
00:25:37,970 --> 00:25:41,240
the role capability for a tentative

526
00:25:39,770 --> 00:25:45,680
users if you want to do that whole thing

527
00:25:41,240 --> 00:25:49,340
so so that's all good so kind of coming

528
00:25:45,680 --> 00:25:51,530
up to that point I'm getting into my

529
00:25:49,340 --> 00:25:55,480
certificate authority and I'm going to

530
00:25:51,530 --> 00:26:01,970
issue that TPM virtual smart card logon

531
00:25:55,480 --> 00:26:05,390
template so there it's issued so now at

532
00:26:01,970 --> 00:26:07,760
this point I'm going into TPM service

533
00:26:05,390 --> 00:26:11,450
manager I'm just going to give it a name

534
00:26:07,760 --> 00:26:13,910
called BSC I'm gonna tell it to prompt

535
00:26:11,450 --> 00:26:16,880
for a pin code so I can do a pin code of

536
00:26:13,910 --> 00:26:18,950
my choosing that Minh key I'm just doing

537
00:26:16,880 --> 00:26:21,920
a random generated one because this is

538
00:26:18,950 --> 00:26:23,600
an on management environment I can

539
00:26:21,920 --> 00:26:26,780
destroy it I don't care about managing

540
00:26:23,600 --> 00:26:28,790
it so I'm creating a random one so this

541
00:26:26,780 --> 00:26:33,200
is gonna happen at least for the next

542
00:26:28,790 --> 00:26:35,300
minute or so once it's done we we got

543
00:26:33,200 --> 00:26:39,530
our we got our first virtual smart card

544
00:26:35,300 --> 00:26:44,389
created so next you know what do we do

545
00:26:39,530 --> 00:26:47,320
with that well we're going to get into

546
00:26:44,390 --> 00:26:47,320
an MMC console

547
00:26:50,470 --> 00:26:58,460
and we're going to get into my user

548
00:26:54,470 --> 00:27:00,230
accounts in certificates and it's kind

549
00:26:58,460 --> 00:27:02,270
of the manual way you can set up to auto

550
00:27:00,230 --> 00:27:05,600
enroll but anyway so I'm gonna go to all

551
00:27:02,270 --> 00:27:06,950
tasks request new certificate I'm gonna

552
00:27:05,600 --> 00:27:09,709
go ahead and I'm going to select my

553
00:27:06,950 --> 00:27:12,020
Active Directory enrollment policy I'm

554
00:27:09,710 --> 00:27:15,500
gonna choose my TPM virtual smart card

555
00:27:12,020 --> 00:27:18,580
log on it's gonna prompt me for a pen

556
00:27:15,500 --> 00:27:26,030
just like a fiscal smart card would and

557
00:27:18,580 --> 00:27:29,570
then I'm gonna click on OK it's

558
00:27:26,030 --> 00:27:32,180
enrolling ok you want to see this

559
00:27:29,570 --> 00:27:35,210
succeeded sign that means that inside

560
00:27:32,180 --> 00:27:37,490
our personal certificate store now we

561
00:27:35,210 --> 00:27:40,580
have a we have a certificate that is

562
00:27:37,490 --> 00:27:41,810
tied to that virtual smart card so Kai

563
00:27:40,580 --> 00:27:43,490
at this far I'm going to log out I'm

564
00:27:41,810 --> 00:27:47,480
going to test that so I'm going to go

565
00:27:43,490 --> 00:27:49,490
over to the old chip looking icon it's

566
00:27:47,480 --> 00:27:53,290
gonna say security device I'm gonna

567
00:27:49,490 --> 00:27:56,360
login with the pen that I signed it and

568
00:27:53,290 --> 00:27:58,190
from that point we will be back into

569
00:27:56,360 --> 00:28:07,699
Windows here in just the next few

570
00:27:58,190 --> 00:28:09,470
seconds okay we're in so at this point I

571
00:28:07,700 --> 00:28:11,420
know that it's working I'm gonna go

572
00:28:09,470 --> 00:28:14,270
ahead and I'm going to check mark that

573
00:28:11,420 --> 00:28:19,520
box that says hey smart card is required

574
00:28:14,270 --> 00:28:21,620
for interactive login I'm going to

575
00:28:19,520 --> 00:28:24,500
confirm that that attribute that I

576
00:28:21,620 --> 00:28:26,840
talked about earlier is on so that tells

577
00:28:24,500 --> 00:28:28,910
me that hey now I've checked mark that

578
00:28:26,840 --> 00:28:32,209
box that's gonna that's going to adhere

579
00:28:28,910 --> 00:28:36,040
to a password policy so then at this

580
00:28:32,210 --> 00:28:36,040
point I'm gonna create a security group

581
00:28:44,210 --> 00:28:53,010
and call it smart card users I'm gonna

582
00:28:47,610 --> 00:28:56,760
put my Luke Skywalker ID in there there

583
00:28:53,010 --> 00:28:58,950
we go okay he's in there kinda like what

584
00:28:56,760 --> 00:29:01,110
does that do so next I'm gonna open up

585
00:28:58,950 --> 00:29:02,640
Active Directory administration center

586
00:29:01,110 --> 00:29:04,379
and get into my password settings

587
00:29:02,640 --> 00:29:08,760
container I'm gonna make sure that that

588
00:29:04,380 --> 00:29:11,520
checkbox is on it is so that's good

589
00:29:08,760 --> 00:29:13,830
I'm gonna create a new fine grained

590
00:29:11,520 --> 00:29:15,658
password policy I'm gonna set it to that

591
00:29:13,830 --> 00:29:18,750
stuff I thought I was gonna set it's

592
00:29:15,659 --> 00:29:22,950
gonna be 120 character value they asked

593
00:29:18,750 --> 00:29:24,770
lipid a rotates every two days so user

594
00:29:22,950 --> 00:29:27,750
logs in they don't need to worry about

595
00:29:24,770 --> 00:29:30,360
changing their password they just log in

596
00:29:27,750 --> 00:29:33,390
with their pen each day wherever they're

597
00:29:30,360 --> 00:29:36,149
segregated - so I said the precedence of

598
00:29:33,390 --> 00:29:39,390
one so that will process for that

599
00:29:36,150 --> 00:29:44,309
security group even if you have just no

600
00:29:39,390 --> 00:29:46,950
password policies for anybody else so

601
00:29:44,309 --> 00:29:52,260
real quickly I think I am I still good

602
00:29:46,950 --> 00:29:54,360
on top thought okay perfect so I got a

603
00:29:52,260 --> 00:29:56,820
couple of reference links here password

604
00:29:54,360 --> 00:30:02,158
strategies test lab guides how to set up

605
00:29:56,820 --> 00:30:06,360
in a dcs hierarchy - tre are key it's

606
00:30:02,159 --> 00:30:08,760
very important to download at least at

607
00:30:06,360 --> 00:30:10,979
minimum Microsoft security baselines and

608
00:30:08,760 --> 00:30:13,379
secure domain controllers with them your

609
00:30:10,980 --> 00:30:15,419
workstations and kind of go from there

610
00:30:13,380 --> 00:30:17,640
and then of course their security and

611
00:30:15,419 --> 00:30:19,409
privileged identity access box they'll

612
00:30:17,640 --> 00:30:21,030
give you more ingrained details if you

613
00:30:19,409 --> 00:30:25,200
want to get to that level about how to

614
00:30:21,030 --> 00:30:28,340
set up pause so next I just want to talk

615
00:30:25,200 --> 00:30:28,340
briefly about you be keys

