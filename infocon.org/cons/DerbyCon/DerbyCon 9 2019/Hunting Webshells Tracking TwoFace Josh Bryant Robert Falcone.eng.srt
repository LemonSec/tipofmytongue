1
00:00:00,620 --> 00:00:05,279
all right everyone it's noon so let's go

2
00:00:03,330 --> 00:00:06,600
ahead and get started yes I'm very loud

3
00:00:05,279 --> 00:00:09,629
I probably don't even need the

4
00:00:06,600 --> 00:00:11,129
microphone except for the video here so

5
00:00:09,630 --> 00:00:13,469
I'll trying to blow your eardrums out

6
00:00:11,130 --> 00:00:16,710
but welcome to hunting web shells

7
00:00:13,469 --> 00:00:18,180
tracking two-face my name is Josh Bryan

8
00:00:16,710 --> 00:00:20,279
I'm a technical director of technical

9
00:00:18,180 --> 00:00:21,779
account management at tinium where I

10
00:00:20,279 --> 00:00:24,509
specialized in our threat response

11
00:00:21,779 --> 00:00:26,460
module prior to coming to taenia my work

12
00:00:24,510 --> 00:00:28,619
for a little company called Microsoft

13
00:00:26,460 --> 00:00:31,410
where I focused on the recovery side of

14
00:00:28,619 --> 00:00:33,570
Incident Response hey folks my name is

15
00:00:31,410 --> 00:00:35,309
Robert Falcone I work for Palo Alto

16
00:00:33,570 --> 00:00:37,700
Networks especially specifically on the

17
00:00:35,309 --> 00:00:40,828
unit 42 team I'm a threat researcher I

18
00:00:37,700 --> 00:00:42,930
re/code all day and tried to track

19
00:00:40,829 --> 00:00:46,170
adversaries as they kind of use these

20
00:00:42,930 --> 00:00:48,719
tools in their attack campaigns and both

21
00:00:46,170 --> 00:00:52,469
both Josh and I kind of came across this

22
00:00:48,719 --> 00:00:54,390
the same incident just in from two

23
00:00:52,469 --> 00:00:56,129
different perspectives Josh was at

24
00:00:54,390 --> 00:00:58,079
Microsoft I was at palette and networks

25
00:00:56,129 --> 00:01:00,690
we're looking at the same thing from you

26
00:00:58,079 --> 00:01:03,090
know two vantage points okay so let's

27
00:01:00,690 --> 00:01:04,759
kind of get into the content of this

28
00:01:03,090 --> 00:01:07,049
talk because we have a lot to talk about

29
00:01:04,760 --> 00:01:08,880
here's what we're talking about when it

30
00:01:07,049 --> 00:01:10,890
comes to web shells I am NOT going to

31
00:01:08,880 --> 00:01:12,298
define what a web shell is this crowd I

32
00:01:10,890 --> 00:01:14,790
hope you all know what it what what

33
00:01:12,299 --> 00:01:16,860
these things are but what I want to talk

34
00:01:14,790 --> 00:01:18,900
about is the fact that there are a ton

35
00:01:16,860 --> 00:01:21,000
of different flavors of web shells out

36
00:01:18,900 --> 00:01:23,280
there and written in multiple different

37
00:01:21,000 --> 00:01:25,710
languages different functionalities

38
00:01:23,280 --> 00:01:27,540
capabilities that kind of thing so we're

39
00:01:25,710 --> 00:01:29,880
not going to be talking about this today

40
00:01:27,540 --> 00:01:31,770
because anyone can go out to you know a

41
00:01:29,880 --> 00:01:33,390
github repository and download a web

42
00:01:31,770 --> 00:01:35,220
shell and deploy in their operations

43
00:01:33,390 --> 00:01:37,920
right so instead what we're going to

44
00:01:35,220 --> 00:01:41,369
talk about is a custom developed web

45
00:01:37,920 --> 00:01:44,310
shell that both Josh and I analyzed that

46
00:01:41,369 --> 00:01:46,079
was created by one threat group and used

47
00:01:44,310 --> 00:01:48,630
by that threat group in their attack

48
00:01:46,079 --> 00:01:51,689
campaigns and I called it to face back

49
00:01:48,630 --> 00:01:54,780
in 2017 because there's a cool name

50
00:01:51,689 --> 00:01:58,710
that's about it so and I'll explain why

51
00:01:54,780 --> 00:02:00,960
we call it to face but so both Josh and

52
00:01:58,710 --> 00:02:03,210
I were looking at this you were looking

53
00:02:00,960 --> 00:02:05,189
at in 2016 I was looking at 2017

54
00:02:03,210 --> 00:02:08,149
probably asking why are we talking about

55
00:02:05,189 --> 00:02:10,829
it today and in September 2019 well

56
00:02:08,149 --> 00:02:13,680
March 2019 we had some interesting

57
00:02:10,830 --> 00:02:13,920
insight kind of we were able to figure

58
00:02:13,680 --> 00:02:16,440
out

59
00:02:13,920 --> 00:02:18,720
a little bit more about this this web

60
00:02:16,440 --> 00:02:21,420
shell in the group behind it thanks to

61
00:02:18,720 --> 00:02:24,300
this this data leak that was for the

62
00:02:21,420 --> 00:02:25,769
dump that was leaked by this Twitter

63
00:02:24,300 --> 00:02:28,160
handle and I'm not gonna try to

64
00:02:25,770 --> 00:02:33,930
pronounce that it's like lab dude

65
00:02:28,160 --> 00:02:39,170
whatever this Twitter alias dumped all

66
00:02:33,930 --> 00:02:41,610
sorts of of tools URLs and web shells

67
00:02:39,170 --> 00:02:43,530
associated with a group called oil rig

68
00:02:41,610 --> 00:02:47,489
I think fireEye calls it a PT 34

69
00:02:43,530 --> 00:02:49,500
whatever the name is the benefit of this

70
00:02:47,489 --> 00:02:50,790
data dump though is that it gave us a

71
00:02:49,500 --> 00:02:54,239
lot of insight that we wouldn't have

72
00:02:50,790 --> 00:02:56,970
necessarily been able to to derive from

73
00:02:54,239 --> 00:03:00,180
our own telemetry okay and what we were

74
00:02:56,970 --> 00:03:03,120
able to get out of this is the kind of

75
00:03:00,180 --> 00:03:07,709
the expanse of the use of this to face

76
00:03:03,120 --> 00:03:10,290
this to face web shell they counted 112

77
00:03:07,709 --> 00:03:12,360
we count 112 URLs that this was

78
00:03:10,290 --> 00:03:15,690
installed on but that didn't include any

79
00:03:12,360 --> 00:03:17,459
of the the URLs that we knew about from

80
00:03:15,690 --> 00:03:19,109
the impacted organizations that we were

81
00:03:17,459 --> 00:03:22,230
working with okay so that numbers are a

82
00:03:19,109 --> 00:03:23,280
little higher there were in in this data

83
00:03:22,230 --> 00:03:25,578
dump there were 87 different

84
00:03:23,280 --> 00:03:28,019
organizations that were impacted by this

85
00:03:25,579 --> 00:03:30,359
27 different countries like there's a

86
00:03:28,019 --> 00:03:33,570
this was a pretty big campaign using

87
00:03:30,359 --> 00:03:34,859
two-faced so the other thing about the

88
00:03:33,570 --> 00:03:36,989
dump which was kind of interesting we

89
00:03:34,859 --> 00:03:38,820
got insight into what thread actor

90
00:03:36,989 --> 00:03:42,299
called this web shell and it was hyper

91
00:03:38,820 --> 00:03:43,380
shell and in hi shell those are kind of

92
00:03:42,299 --> 00:03:44,970
boring names that's why we're gonna

93
00:03:43,380 --> 00:03:47,609
continue using to face going forward

94
00:03:44,970 --> 00:03:51,690
first off because I named it and second

95
00:03:47,609 --> 00:03:54,209
off it's a much better name okay so why

96
00:03:51,690 --> 00:03:56,220
did I call it to face back in 2017 well

97
00:03:54,209 --> 00:03:57,690
the reason why I called it that was

98
00:03:56,220 --> 00:04:00,150
because it had two different layers to

99
00:03:57,690 --> 00:04:01,920
it okay there was a loader layer and

100
00:04:00,150 --> 00:04:03,900
then there was a payload layer though

101
00:04:01,920 --> 00:04:07,260
the whole purpose of the loader was to

102
00:04:03,900 --> 00:04:09,450
be able to extract a embedded payload

103
00:04:07,260 --> 00:04:12,358
layer and install it onto the web server

104
00:04:09,450 --> 00:04:13,980
okay so this is what one of the loaders

105
00:04:12,359 --> 00:04:16,350
looks like if you were just to navigate

106
00:04:13,980 --> 00:04:18,630
to it it just looks like it's a error

107
00:04:16,350 --> 00:04:21,389
page from an exchange server okay and

108
00:04:18,630 --> 00:04:24,570
speaking of exchange server to face was

109
00:04:21,389 --> 00:04:26,310
deployed almost exclusively on on to

110
00:04:24,570 --> 00:04:27,870
exchange servers okay so they were

111
00:04:26,310 --> 00:04:30,960
really for this group is really full

112
00:04:27,870 --> 00:04:33,540
Gaston on targeting exchange servers so

113
00:04:30,960 --> 00:04:35,460
if you did just navigate to it looks

114
00:04:33,540 --> 00:04:37,860
legitimate but it actually has a

115
00:04:35,460 --> 00:04:41,010
malicious payload shell embedded within

116
00:04:37,860 --> 00:04:43,650
it that if the adversary interacted with

117
00:04:41,010 --> 00:04:45,900
it in a specific way who dropped this

118
00:04:43,650 --> 00:04:47,969
payload right so this has all the

119
00:04:45,900 --> 00:04:49,859
functionality at the adversary would you

120
00:04:47,970 --> 00:04:52,169
know start in or used to start

121
00:04:49,860 --> 00:04:54,810
interacting with the the web web shell

122
00:04:52,169 --> 00:04:56,400
itself like running commands downloading

123
00:04:54,810 --> 00:04:58,350
files uploading files running sequel

124
00:04:56,400 --> 00:05:00,780
queries whatever right so this is pretty

125
00:04:58,350 --> 00:05:02,639
functional now the one thing I do want

126
00:05:00,780 --> 00:05:04,380
to call out here is that to be able to

127
00:05:02,639 --> 00:05:07,080
run anything on this you actually had to

128
00:05:04,380 --> 00:05:08,969
provide a password to authenticate to it

129
00:05:07,080 --> 00:05:11,370
so you couldn't just stumble upon this

130
00:05:08,970 --> 00:05:13,139
and start executing commands on the web

131
00:05:11,370 --> 00:05:15,180
on the web server because he actually

132
00:05:13,139 --> 00:05:16,860
had to use a password to be able to

133
00:05:15,180 --> 00:05:18,600
carry out any of that activity and

134
00:05:16,860 --> 00:05:20,940
that's going to become more and more

135
00:05:18,600 --> 00:05:22,530
important as you see you know what they

136
00:05:20,940 --> 00:05:26,100
did where they did where they did it

137
00:05:22,530 --> 00:05:28,049
from ok so real quick how did the how

138
00:05:26,100 --> 00:05:30,660
did the loader install the payload

139
00:05:28,050 --> 00:05:32,910
there's kind of a you know complicated

140
00:05:30,660 --> 00:05:36,150
process but I want to kind of highlight

141
00:05:32,910 --> 00:05:37,620
this using a demo in a couple seconds

142
00:05:36,150 --> 00:05:40,109
but this is what's going to happen at a

143
00:05:37,620 --> 00:05:42,660
very high level the actor would have to

144
00:05:40,110 --> 00:05:45,150
provide is 64 byte key to the loader

145
00:05:42,660 --> 00:05:48,300
then the loader would use that key to

146
00:05:45,150 --> 00:05:51,150
decrypt to the embedded web shell salt

147
00:05:48,300 --> 00:05:52,979
is applied as well but then the results

148
00:05:51,150 --> 00:05:54,690
of that is actually used to decrypt the

149
00:05:52,979 --> 00:05:57,479
embedded web shell and then the

150
00:05:54,690 --> 00:05:59,969
browser's redirected to it okay so

151
00:05:57,479 --> 00:06:01,560
that's a pretty it's a fairly

152
00:05:59,970 --> 00:06:03,180
complicated process how it does it and

153
00:06:01,560 --> 00:06:06,810
I'll show you how it does it in this

154
00:06:03,180 --> 00:06:08,760
demo this is just a UH a server that I

155
00:06:06,810 --> 00:06:11,400
set up real quick there's nothing else

156
00:06:08,760 --> 00:06:13,440
on it I I briefly mentioned earlier that

157
00:06:11,400 --> 00:06:15,599
this would have been in an actual

158
00:06:13,440 --> 00:06:17,039
operation this would probably be an

159
00:06:15,599 --> 00:06:19,500
exchange server because that's what this

160
00:06:17,039 --> 00:06:21,440
direct group actually targeted but this

161
00:06:19,500 --> 00:06:24,840
is just a stock IAS server that I

162
00:06:21,440 --> 00:06:26,639
installed for this demo there's only one

163
00:06:24,840 --> 00:06:27,810
aspx file sorry for the folks in the

164
00:06:26,639 --> 00:06:29,729
back you can't read that it's way too

165
00:06:27,810 --> 00:06:32,550
small there's only one file on the

166
00:06:29,729 --> 00:06:34,650
server and it's the the loader tool that

167
00:06:32,550 --> 00:06:36,500
that two-faced loader so I'm going to

168
00:06:34,650 --> 00:06:39,810
visit it in the browser right now and

169
00:06:36,500 --> 00:06:41,500
this is actually an edge case where they

170
00:06:39,810 --> 00:06:42,850
actually took their low

171
00:06:41,500 --> 00:06:46,030
our code and appended it to a legitimate

172
00:06:42,850 --> 00:06:48,250
news article on that server okay just to

173
00:06:46,030 --> 00:06:52,030
blend in because this actually wasn't an

174
00:06:48,250 --> 00:06:54,160
exchange server so ever a script to take

175
00:06:52,030 --> 00:06:56,320
that 64 byte key which I'll explain how

176
00:06:54,160 --> 00:06:58,270
we figured that out in a second but I

177
00:06:56,320 --> 00:07:00,760
wrote a script to be able to provide

178
00:06:58,270 --> 00:07:02,830
that in the specific way to tell the

179
00:07:00,760 --> 00:07:05,860
loader to install or to decrypt and

180
00:07:02,830 --> 00:07:11,050
install the payload of the two-faced

181
00:07:05,860 --> 00:07:13,810
payload it ran then the web server is

182
00:07:11,050 --> 00:07:17,770
responding back with the the the content

183
00:07:13,810 --> 00:07:21,130
of the payload itself so I actually

184
00:07:17,770 --> 00:07:23,770
scripted it to drop the payload to drops

185
00:07:21,130 --> 00:07:27,040
aspx so if we flip back over there's the

186
00:07:23,770 --> 00:07:30,430
new file that was created I'll open that

187
00:07:27,040 --> 00:07:32,169
up in in in the browser and there it is

188
00:07:30,430 --> 00:07:34,120
so it's a little bit different than the

189
00:07:32,169 --> 00:07:38,500
one I showed earlier on this one just as

190
00:07:34,120 --> 00:07:39,910
blue in black but it's the same so

191
00:07:38,500 --> 00:07:41,530
actually you can see here I'm trying to

192
00:07:39,910 --> 00:07:43,360
run the who my command but it's not

193
00:07:41,530 --> 00:07:44,500
working right like I said you have to

194
00:07:43,360 --> 00:07:46,900
provide a password to be able to

195
00:07:44,500 --> 00:07:49,240
actually use this thing so I provide the

196
00:07:46,900 --> 00:07:51,549
password I ran some some commands and

197
00:07:49,240 --> 00:07:53,350
that's how the adversary would actually

198
00:07:51,550 --> 00:07:55,600
interact with this clearly they won't be

199
00:07:53,350 --> 00:07:57,160
using my Python script but they would

200
00:07:55,600 --> 00:08:01,810
have something on there and to be able

201
00:07:57,160 --> 00:08:03,820
to carry out that activity so why do

202
00:08:01,810 --> 00:08:06,610
they do this right why did they have

203
00:08:03,820 --> 00:08:09,880
this like multi-layer web shell

204
00:08:06,610 --> 00:08:11,950
well the loader itself is is highly

205
00:08:09,880 --> 00:08:14,320
office gated right it's pretty hard to

206
00:08:11,950 --> 00:08:17,469
detect with signatures and an end points

207
00:08:14,320 --> 00:08:19,810
are actually endpoint protection tools

208
00:08:17,470 --> 00:08:21,610
are have difficulty trying to detecting

209
00:08:19,810 --> 00:08:23,470
this because they're using random names

210
00:08:21,610 --> 00:08:25,979
lots of encoding encryption all that

211
00:08:23,470 --> 00:08:30,250
stuff right so how did we go about

212
00:08:25,979 --> 00:08:31,990
tracking this stuff right well remember

213
00:08:30,250 --> 00:08:34,539
the installation process I mentioned

214
00:08:31,990 --> 00:08:37,930
that the actor had to provide a key that

215
00:08:34,539 --> 00:08:41,640
was then modified by a salt well this is

216
00:08:37,929 --> 00:08:44,680
the process that that it uses to do that

217
00:08:41,640 --> 00:08:46,839
then after it applies the key salt to

218
00:08:44,680 --> 00:08:48,790
the key or the salt to the key it uses

219
00:08:46,839 --> 00:08:52,300
this for loop to decrypt it then you get

220
00:08:48,790 --> 00:08:53,620
your payload well I don't know if you

221
00:08:52,300 --> 00:08:55,430
can see in the way back but what they're

222
00:08:53,620 --> 00:08:57,260
doing is they're just using addition

223
00:08:55,430 --> 00:08:59,510
traction to modify these things right

224
00:08:57,260 --> 00:09:01,220
and I'm not a crypto guy but addition

225
00:08:59,510 --> 00:09:04,040
and subtraction are really bad operators

226
00:09:01,220 --> 00:09:06,860
to be doing any sort of you know ciphers

227
00:09:04,040 --> 00:09:09,649
so what did we do well we just did a

228
00:09:06,860 --> 00:09:11,240
very very simple crypto attack on it

229
00:09:09,649 --> 00:09:14,570
just using some algebra that's it

230
00:09:11,240 --> 00:09:16,520
because we knew we knew what the the

231
00:09:14,570 --> 00:09:18,230
output would be because it would be a

232
00:09:16,520 --> 00:09:19,160
web shell so it's probably going to be

233
00:09:18,230 --> 00:09:21,740
an ASP X file

234
00:09:19,160 --> 00:09:23,810
we knew the salt and we knew the cipher

235
00:09:21,740 --> 00:09:26,180
text all the one thing that we didn't

236
00:09:23,810 --> 00:09:28,630
know was the 64 byte key that they were

237
00:09:26,180 --> 00:09:31,819
going to provide at the you know the

238
00:09:28,630 --> 00:09:35,330
installation time so just simple algebra

239
00:09:31,820 --> 00:09:35,750
to solve for one unknown so we wrote a

240
00:09:35,330 --> 00:09:39,290
script

241
00:09:35,750 --> 00:09:40,790
it started out putting some stuff and

242
00:09:39,290 --> 00:09:42,649
then guess what we found the key now

243
00:09:40,790 --> 00:09:46,339
take a look at that key it's 64 bytes

244
00:09:42,649 --> 00:09:47,450
long there it's just you know garbage so

245
00:09:46,339 --> 00:09:49,520
that actually gives us a little bit more

246
00:09:47,450 --> 00:09:51,740
insight into what the operator was doing

247
00:09:49,520 --> 00:09:53,329
the adversary was doing because there's

248
00:09:51,740 --> 00:09:54,970
no way they were remembering that so

249
00:09:53,330 --> 00:09:57,980
they have some sort of key storage

250
00:09:54,970 --> 00:09:59,839
utility on their end as well and then

251
00:09:57,980 --> 00:10:01,670
there's the declared X output which was

252
00:09:59,839 --> 00:10:03,580
the payload okay so that's how we went

253
00:10:01,670 --> 00:10:07,279
about tracking this thing going forward

254
00:10:03,580 --> 00:10:10,370
until about I'm gonna say it was

255
00:10:07,279 --> 00:10:12,080
probably about June 2017

256
00:10:10,370 --> 00:10:14,390
right before we published on this

257
00:10:12,080 --> 00:10:17,180
publish a blog on this the adversary

258
00:10:14,390 --> 00:10:19,730
kind of probably caught on to the fact

259
00:10:17,180 --> 00:10:22,430
that their crypto sucked so they

260
00:10:19,730 --> 00:10:24,740
released a new version of this of this

261
00:10:22,430 --> 00:10:27,319
of this web shell where the loader

262
00:10:24,740 --> 00:10:29,600
didn't use that you know kind of the

263
00:10:27,320 --> 00:10:30,350
janky cipher using addition and

264
00:10:29,600 --> 00:10:32,240
subtraction

265
00:10:30,350 --> 00:10:34,370
instead they started using an actual

266
00:10:32,240 --> 00:10:37,310
cipher okay everything else is the same

267
00:10:34,370 --> 00:10:40,310
but instead they used Triple DES okay so

268
00:10:37,310 --> 00:10:42,619
very similar that the loader was very

269
00:10:40,310 --> 00:10:45,260
very almost the same but instead they

270
00:10:42,620 --> 00:10:49,220
just swapped out Triple DES to be a

271
00:10:45,260 --> 00:10:52,250
little bit more robust so in addition to

272
00:10:49,220 --> 00:10:55,370
that they started taking the same idea

273
00:10:52,250 --> 00:10:57,380
of bringing in some authentication to

274
00:10:55,370 --> 00:10:59,779
this process where instead of just

275
00:10:57,380 --> 00:11:02,750
taking the actor supplied key creating a

276
00:10:59,779 --> 00:11:04,189
you know a key and using that to decrypt

277
00:11:02,750 --> 00:11:05,839
it they would actually check to see if

278
00:11:04,190 --> 00:11:08,329
that key was legit before they did that

279
00:11:05,839 --> 00:11:09,370
and this is how they did it they had a

280
00:11:08,329 --> 00:11:11,529
salt just like

281
00:11:09,370 --> 00:11:14,140
the the other two-face loader which

282
00:11:11,529 --> 00:11:17,860
they'd apply they depend to the key

283
00:11:14,140 --> 00:11:19,960
provided by the the the actor they do a

284
00:11:17,860 --> 00:11:21,430
shot shot one of it then they basically

285
00:11:19,960 --> 00:11:24,940
for encode it and then check it to that

286
00:11:21,430 --> 00:11:27,849
hard-coded string right so at this point

287
00:11:24,940 --> 00:11:29,560
we have no idea what the payload is in

288
00:11:27,850 --> 00:11:32,140
this right it's encrypted with Triple

289
00:11:29,560 --> 00:11:34,750
DES so in a very long key we have no

290
00:11:32,140 --> 00:11:36,550
idea how to break this because we all

291
00:11:34,750 --> 00:11:39,070
have a rig to be able to brute-force

292
00:11:36,550 --> 00:11:42,849
this so this is a completely unknown for

293
00:11:39,070 --> 00:11:45,250
a while okay so the way that this works

294
00:11:42,850 --> 00:11:46,930
is it takes that key grabs a shot 256

295
00:11:45,250 --> 00:11:48,430
takes the first 24 bytes and that is

296
00:11:46,930 --> 00:11:50,349
your Triple DES key all right so we're

297
00:11:48,430 --> 00:11:54,550
stumped we have no idea you know what

298
00:11:50,350 --> 00:11:58,270
the key is here so probably like I said

299
00:11:54,550 --> 00:12:00,550
that was June 2017 up until the the data

300
00:11:58,270 --> 00:12:01,870
dome that I that I mentioned earlier we

301
00:12:00,550 --> 00:12:03,579
couldn't we couldn't figure out what the

302
00:12:01,870 --> 00:12:06,670
payload was for this okay

303
00:12:03,580 --> 00:12:08,800
it's just kind of a question mark except

304
00:12:06,670 --> 00:12:13,240
one of the files that was included in

305
00:12:08,800 --> 00:12:17,170
the dump actually exposed oops by the

306
00:12:13,240 --> 00:12:19,120
the developer they included this in the

307
00:12:17,170 --> 00:12:21,010
loader right and as you can see here

308
00:12:19,120 --> 00:12:23,560
this is just some HTML with a pre tag

309
00:12:21,010 --> 00:12:25,810
when you opened up the loader and did a

310
00:12:23,560 --> 00:12:28,599
get request it just displayed this you

311
00:12:25,810 --> 00:12:30,430
know wacky string here this and xkk

312
00:12:28,600 --> 00:12:32,410
string right we had no idea what that

313
00:12:30,430 --> 00:12:34,989
was for like it didn't mean anything so

314
00:12:32,410 --> 00:12:37,240
why would they include that well it

315
00:12:34,990 --> 00:12:38,680
turned out that was the key so I'm not

316
00:12:37,240 --> 00:12:41,050
sure if this was just a development

317
00:12:38,680 --> 00:12:44,620
version or what they were doing a pretty

318
00:12:41,050 --> 00:12:46,689
big OPSEC fail and we actually you know

319
00:12:44,620 --> 00:12:49,570
exploited that to figure out what the

320
00:12:46,690 --> 00:12:52,540
payload was within this within this this

321
00:12:49,570 --> 00:12:54,130
loader so I'll just walk you through

322
00:12:52,540 --> 00:12:57,520
really quick how this worked and how we

323
00:12:54,130 --> 00:12:59,439
confirmed that that was the key so here

324
00:12:57,520 --> 00:13:02,500
we concatenate the salt and the key

325
00:12:59,440 --> 00:13:05,200
that's in that pre tag here we take the

326
00:13:02,500 --> 00:13:08,950
shot one of that of that string we

327
00:13:05,200 --> 00:13:10,990
base64 that sha sha one and then we

328
00:13:08,950 --> 00:13:12,700
compare that while we basics for it then

329
00:13:10,990 --> 00:13:14,470
we compare the output of that to the

330
00:13:12,700 --> 00:13:16,270
hard-coded basic C for a string in that

331
00:13:14,470 --> 00:13:18,700
top box there and if you actually looked

332
00:13:16,270 --> 00:13:20,589
at exactly the same so now we know that

333
00:13:18,700 --> 00:13:22,870
we've got the key to be able to decrypt

334
00:13:20,589 --> 00:13:26,560
this this embedded payload that's been

335
00:13:22,870 --> 00:13:28,720
kind of stumping us for a long time so

336
00:13:26,560 --> 00:13:31,300
another another script I wrote it just

337
00:13:28,720 --> 00:13:33,850
it simple like it's probably five lines

338
00:13:31,300 --> 00:13:36,910
just doesn't Triple DES and there it is

339
00:13:33,850 --> 00:13:39,430
that's what came out right now does that

340
00:13:36,910 --> 00:13:41,740
look really familiar to like slide three

341
00:13:39,430 --> 00:13:42,939
or whatever that showed the payload well

342
00:13:41,740 --> 00:13:45,820
it kind of is right

343
00:13:42,940 --> 00:13:47,110
so I'm not sure people in the back and

344
00:13:45,820 --> 00:13:48,760
see that but this is actually an

345
00:13:47,110 --> 00:13:51,700
animated gif that compares the

346
00:13:48,760 --> 00:13:53,650
difference between that first that first

347
00:13:51,700 --> 00:13:56,350
payload and the one that I just

348
00:13:53,650 --> 00:13:58,900
extracted and the only difference is

349
00:13:56,350 --> 00:14:01,029
that they added version 5.0 in the top

350
00:13:58,900 --> 00:14:02,949
right corner okay so they add some

351
00:14:01,029 --> 00:14:06,790
versioning which just seems kind of

352
00:14:02,950 --> 00:14:08,920
weird especially because when we start

353
00:14:06,790 --> 00:14:12,640
looking at the the data dump and looking

354
00:14:08,920 --> 00:14:14,949
at the other payloads the we got this

355
00:14:12,640 --> 00:14:17,980
one this is another two-faced payload

356
00:14:14,950 --> 00:14:20,980
from that dump that is version 5.0 that

357
00:14:17,980 --> 00:14:24,100
is clearly different especially in

358
00:14:20,980 --> 00:14:26,680
visual so they're very very bad at

359
00:14:24,100 --> 00:14:28,720
versioning but they also added some

360
00:14:26,680 --> 00:14:32,229
functionality here where they added some

361
00:14:28,720 --> 00:14:34,089
you know a file file system Explorer on

362
00:14:32,230 --> 00:14:36,820
that file system or the Explorer tab

363
00:14:34,089 --> 00:14:40,570
here another version that we saw them

364
00:14:36,820 --> 00:14:42,670
create was version set of 7.1 here all

365
00:14:40,570 --> 00:14:45,760
the same functionality all the same code

366
00:14:42,670 --> 00:14:48,099
they just broke it out over over several

367
00:14:45,760 --> 00:14:50,860
tabs here and then you get this one

368
00:14:48,100 --> 00:14:53,200
eight eight point six point two where

369
00:14:50,860 --> 00:14:55,350
this is radically different they so this

370
00:14:53,200 --> 00:14:57,910
is showing that they're they're

371
00:14:55,350 --> 00:14:59,770
constantly updating developing on these

372
00:14:57,910 --> 00:15:02,319
on these web shells as they're carrying

373
00:14:59,770 --> 00:15:04,750
out these these these attack operations

374
00:15:02,320 --> 00:15:08,320
now I pass it over to Josh it's going to

375
00:15:04,750 --> 00:15:10,720
show you some hunting stuff all right

376
00:15:08,320 --> 00:15:12,100
it's time to go hunting so I've seen a

377
00:15:10,720 --> 00:15:14,279
lot of people walking around the

378
00:15:12,100 --> 00:15:16,450
conference with t-shirts that say

379
00:15:14,279 --> 00:15:18,550
attackers thinking graphs and we're

380
00:15:16,450 --> 00:15:21,760
going to do exactly that here with a

381
00:15:18,550 --> 00:15:23,949
couple of quick attack graft scenarios

382
00:15:21,760 --> 00:15:25,779
first one here I call an attackers hope

383
00:15:23,950 --> 00:15:27,520
this is something that we see a lot of

384
00:15:25,779 --> 00:15:29,830
adversaries attempt usually

385
00:15:27,520 --> 00:15:31,750
unsuccessfully but they really wish it

386
00:15:29,830 --> 00:15:34,510
would work so here we have your typical

387
00:15:31,750 --> 00:15:36,640
environment where we have a domain admin

388
00:15:34,510 --> 00:15:37,089
that uses his domain admin creds for

389
00:15:36,640 --> 00:15:41,550
everything

390
00:15:37,089 --> 00:15:44,350
and he exposes them all over the place

391
00:15:41,550 --> 00:15:46,120
next our attacker is going to target the

392
00:15:44,350 --> 00:15:48,459
exchange server directly because it's a

393
00:15:46,120 --> 00:15:49,930
high-value target and it's often exposed

394
00:15:48,459 --> 00:15:52,479
directly to the internet so people can

395
00:15:49,930 --> 00:15:54,969
access things like OWA so he's going to

396
00:15:52,480 --> 00:15:56,850
try a few common techniques maybe sequel

397
00:15:54,970 --> 00:15:58,959
injection remote file inclusion

398
00:15:56,850 --> 00:16:01,540
cross-site scripting local file

399
00:15:58,959 --> 00:16:03,790
inclusion and maybe eventually get on to

400
00:16:01,540 --> 00:16:06,879
remote code execution which is most

401
00:16:03,790 --> 00:16:08,339
likely Avenue however there aren't any

402
00:16:06,879 --> 00:16:10,240
known remote code execution

403
00:16:08,339 --> 00:16:12,129
vulnerabilities in exchange that I can

404
00:16:10,240 --> 00:16:14,439
find you may target some of the

405
00:16:12,129 --> 00:16:17,470
underlying components such as is itself

406
00:16:14,439 --> 00:16:20,699
made with HTTP that sis or the

407
00:16:17,470 --> 00:16:25,449
underlying operating system however

408
00:16:20,699 --> 00:16:27,939
probable but still may be unlikely or do

409
00:16:25,449 --> 00:16:30,240
our remote code execution attacker comes

410
00:16:27,939 --> 00:16:33,279
in compromises the exchange server

411
00:16:30,240 --> 00:16:35,740
implants the web shell and from here

412
00:16:33,279 --> 00:16:37,899
because our domain admin uses

413
00:16:35,740 --> 00:16:40,949
credentials all over the place you can

414
00:16:37,899 --> 00:16:43,779
use credential theft techniques and then

415
00:16:40,949 --> 00:16:45,609
pivot to the domain controller and now

416
00:16:43,779 --> 00:16:48,610
have complete control over the

417
00:16:45,610 --> 00:16:51,429
environment so that's one way that these

418
00:16:48,610 --> 00:16:55,019
attacks can happen what we see more

419
00:16:51,429 --> 00:16:58,990
often though is something like this

420
00:16:55,019 --> 00:17:01,929
where the attacker sends a phishing

421
00:16:58,990 --> 00:17:03,550
campaign and our user opens it because

422
00:17:01,929 --> 00:17:05,918
they're excited to get mail

423
00:17:03,550 --> 00:17:08,770
they love attachments and they're more

424
00:17:05,919 --> 00:17:11,319
than happy to enable macros and get

425
00:17:08,770 --> 00:17:13,148
their machine infected so that gives our

426
00:17:11,319 --> 00:17:15,579
attacker their initial foothold into the

427
00:17:13,148 --> 00:17:17,349
environment but now they need to do some

428
00:17:15,579 --> 00:17:19,799
privilege escalation here so they could

429
00:17:17,349 --> 00:17:22,869
do something like cause a little mayhem

430
00:17:19,799 --> 00:17:25,148
which makes our helpdesk guy come out

431
00:17:22,869 --> 00:17:27,398
and he's gonna use his admin creds on

432
00:17:25,148 --> 00:17:30,370
this system and expose credentials again

433
00:17:27,398 --> 00:17:33,370
in this scenario our admin is not an

434
00:17:30,370 --> 00:17:36,158
exchange admin but he is haves admin

435
00:17:33,370 --> 00:17:39,070
privileges to the file server and our

436
00:17:36,159 --> 00:17:40,899
attacker is going to use advantage of a

437
00:17:39,070 --> 00:17:43,720
Miss configuration that he finds on the

438
00:17:40,899 --> 00:17:46,539
exchange server to now implant his web

439
00:17:43,720 --> 00:17:48,970
shell over there and it doesn't

440
00:17:46,539 --> 00:17:50,940
necessarily need to go after domain

441
00:17:48,970 --> 00:17:52,680
admins because exchange is really

442
00:17:50,940 --> 00:17:55,200
highly privileged inside Active

443
00:17:52,680 --> 00:17:57,570
Directory he can use that to his

444
00:17:55,200 --> 00:18:00,510
advantage and gain access to other

445
00:17:57,570 --> 00:18:02,220
servers and systems in the environments

446
00:18:00,510 --> 00:18:05,160
another thing that he could possibly

447
00:18:02,220 --> 00:18:08,100
have done here is use something like the

448
00:18:05,160 --> 00:18:11,400
ruler vulnerability and technique to

449
00:18:08,100 --> 00:18:12,389
gain privilege escalation and lateral

450
00:18:11,400 --> 00:18:16,560
movement to get throughout the

451
00:18:12,390 --> 00:18:19,980
environment so typically what happens

452
00:18:16,560 --> 00:18:22,020
here then some time goes by most AV and

453
00:18:19,980 --> 00:18:23,580
EDR tools out there are really bad at

454
00:18:22,020 --> 00:18:25,320
finding web shells especially when

455
00:18:23,580 --> 00:18:27,840
they're in targeted campaigns like this

456
00:18:25,320 --> 00:18:29,429
but they may find the other activity

457
00:18:27,840 --> 00:18:31,740
that happened after the web shell was

458
00:18:29,430 --> 00:18:33,630
implanted so our security guy came in

459
00:18:31,740 --> 00:18:35,340
and he cleaned up everything that his

460
00:18:33,630 --> 00:18:37,890
tools alerted him on but maybe they

461
00:18:35,340 --> 00:18:39,629
often end up missing the web shell and

462
00:18:37,890 --> 00:18:41,370
that gives the attacker some persistence

463
00:18:39,630 --> 00:18:44,340
and a way back into the environment

464
00:18:41,370 --> 00:18:47,250
which brings us into our third scenario

465
00:18:44,340 --> 00:18:48,810
here return of the attacker because that

466
00:18:47,250 --> 00:18:51,240
web shell got left behind it wasn't

467
00:18:48,810 --> 00:18:53,879
detected our attacker can get back in

468
00:18:51,240 --> 00:18:56,070
direct access to the exchange server and

469
00:18:53,880 --> 00:19:00,560
again move laterally throughout the

470
00:18:56,070 --> 00:19:00,560
environments and gain complete control

471
00:19:01,190 --> 00:19:05,040
so with that I'm going to pass back to

472
00:19:03,150 --> 00:19:06,900
Rob here to go over what he saw the

473
00:19:05,040 --> 00:19:09,770
attackers doing in his investigation

474
00:19:06,900 --> 00:19:12,090
yeah so that was a pretty high-level

475
00:19:09,770 --> 00:19:15,840
scenario I'm actually gonna dig into

476
00:19:12,090 --> 00:19:19,350
exactly what the adversary did on one

477
00:19:15,840 --> 00:19:24,480
organization now this is going back to

478
00:19:19,350 --> 00:19:27,270
2016 I think it's tuned but we actually

479
00:19:24,480 --> 00:19:29,850
saw this very very similar activity

480
00:19:27,270 --> 00:19:35,730
carrying out all the way through January

481
00:19:29,850 --> 00:19:38,580
to 2019 as well so so the oh yeah my

482
00:19:35,730 --> 00:19:41,610
clicker so this slide right here I'm

483
00:19:38,580 --> 00:19:43,379
just gonna start with some pew-pew map

484
00:19:41,610 --> 00:19:45,689
that I actually created in PowerPoint

485
00:19:43,380 --> 00:19:47,670
so when you see arrows happening here

486
00:19:45,690 --> 00:19:49,860
just in your head think of the work like

487
00:19:47,670 --> 00:19:52,140
just to peep you in your head we've got

488
00:19:49,860 --> 00:19:53,909
an exchange server down here in the

489
00:19:52,140 --> 00:19:55,170
Middle East's here it's in Saudi Arabia

490
00:19:53,910 --> 00:19:58,170
I don't remember if it was there or not

491
00:19:55,170 --> 00:20:00,030
but I'm just gonna show you at a high

492
00:19:58,170 --> 00:20:01,260
level where this activity came from and

493
00:20:00,030 --> 00:20:03,120
then we're gonna dig into the exact

494
00:20:01,260 --> 00:20:04,530
commands that were issued by the

495
00:20:03,120 --> 00:20:06,629
adversary

496
00:20:04,530 --> 00:20:13,320
carry out their their activities using

497
00:20:06,630 --> 00:20:16,580
the web shell so June 16th 2016 so we

498
00:20:13,320 --> 00:20:19,649
have a line coming out of Iran and

499
00:20:16,580 --> 00:20:23,250
there's an IP address that logs into OWA

500
00:20:19,650 --> 00:20:26,190
into the into the exchange server the

501
00:20:23,250 --> 00:20:31,350
next day same exact IP address logs back

502
00:20:26,190 --> 00:20:32,940
into OWA then the day after June 18th

503
00:20:31,350 --> 00:20:35,159
that's when we start seeing the first

504
00:20:32,940 --> 00:20:37,530
the first web shell activity

505
00:20:35,160 --> 00:20:39,570
specifically using to face it's coming

506
00:20:37,530 --> 00:20:45,000
from the same ip address as you know geo

507
00:20:39,570 --> 00:20:47,280
geo located in Iran then September 28th

508
00:20:45,000 --> 00:20:48,990
a couple months later we see six

509
00:20:47,280 --> 00:20:52,290
commands being run from an IP address in

510
00:20:48,990 --> 00:20:54,510
France a few months later like six

511
00:20:52,290 --> 00:20:56,040
months later there's sixteen commands

512
00:20:54,510 --> 00:20:59,940
being run from a different IP address

513
00:20:56,040 --> 00:21:03,780
geo located in France sixty-one commands

514
00:20:59,940 --> 00:21:06,450
run in April from a us-based IP and then

515
00:21:03,780 --> 00:21:08,580
finally we see activity from an IP

516
00:21:06,450 --> 00:21:09,060
address in Germany running ten commands

517
00:21:08,580 --> 00:21:10,710
okay

518
00:21:09,060 --> 00:21:13,530
so the one thing I do want to kind of

519
00:21:10,710 --> 00:21:14,940
show you at a high level is that all

520
00:21:13,530 --> 00:21:17,430
this activity came from different places

521
00:21:14,940 --> 00:21:19,110
right so different IP addresses at

522
00:21:17,430 --> 00:21:21,660
different locations whether they're

523
00:21:19,110 --> 00:21:23,760
using different VPNs or they're hopping

524
00:21:21,660 --> 00:21:27,060
from compromised organizations

525
00:21:23,760 --> 00:21:28,860
what-have-you but if you think about the

526
00:21:27,060 --> 00:21:31,530
process that I showed earlier of the

527
00:21:28,860 --> 00:21:33,510
installation of this web shell these

528
00:21:31,530 --> 00:21:35,490
folks aren't or these IP addresses

529
00:21:33,510 --> 00:21:37,740
aren't just falling upon these these web

530
00:21:35,490 --> 00:21:39,780
shells and running these commands okay

531
00:21:37,740 --> 00:21:42,120
so because of the installation process

532
00:21:39,780 --> 00:21:44,160
in the requirement for you know

533
00:21:42,120 --> 00:21:46,320
authentication with the password these

534
00:21:44,160 --> 00:21:49,470
are highly likely all the same threat

535
00:21:46,320 --> 00:21:51,600
group same adversary okay so what's

536
00:21:49,470 --> 00:21:54,240
going to exactly what they did when they

537
00:21:51,600 --> 00:21:56,699
had access to this exchange server so

538
00:21:54,240 --> 00:21:59,400
remember they logged into OWA here so

539
00:21:56,700 --> 00:22:00,990
what did they do well at first they came

540
00:21:59,400 --> 00:22:02,820
in they started enumerate some

541
00:22:00,990 --> 00:22:05,640
distribution lists and they looked at a

542
00:22:02,820 --> 00:22:07,860
bunch of different user accounts which

543
00:22:05,640 --> 00:22:09,900
is kind of interesting right why no what

544
00:22:07,860 --> 00:22:11,310
they did they used one of those

545
00:22:09,900 --> 00:22:14,520
distribution lists to send an email

546
00:22:11,310 --> 00:22:17,550
right and so the email is sent to the

547
00:22:14,520 --> 00:22:18,418
network support distribution list and I

548
00:22:17,550 --> 00:22:20,279
would have mad

549
00:22:18,419 --> 00:22:22,489
network support distribution list the

550
00:22:20,279 --> 00:22:26,009
folks on that would have pretty high

551
00:22:22,489 --> 00:22:28,950
privileges and we don't actually have

552
00:22:26,009 --> 00:22:31,320
the the if there was any attachments or

553
00:22:28,950 --> 00:22:33,919
what was in the body of the email but we

554
00:22:31,320 --> 00:22:36,029
believe this is them trying to SQ or

555
00:22:33,919 --> 00:22:38,309
compromise an endpoint that would have

556
00:22:36,029 --> 00:22:40,529
an admin logged into it so they're

557
00:22:38,309 --> 00:22:42,720
trying to go after the system that would

558
00:22:40,529 --> 00:22:47,309
have an account with elevated privileges

559
00:22:42,720 --> 00:22:48,629
okay so they came back the next day and

560
00:22:47,309 --> 00:22:50,668
they didn't do anything except for

561
00:22:48,629 --> 00:22:52,590
download the offline address book and

562
00:22:50,669 --> 00:22:55,259
why was why it would that be important

563
00:22:52,590 --> 00:22:58,109
Josh yes again exchange is a very

564
00:22:55,259 --> 00:23:00,210
high-value target and the address book

565
00:22:58,109 --> 00:23:01,918
pulls all its attributes from the

566
00:23:00,210 --> 00:23:03,269
objects in Active Directory and the user

567
00:23:01,919 --> 00:23:05,129
accounts so this is going to help them

568
00:23:03,269 --> 00:23:07,980
identify further targets in the

569
00:23:05,129 --> 00:23:09,509
organization they're gonna know titles

570
00:23:07,980 --> 00:23:10,919
so they can look for things like this is

571
00:23:09,509 --> 00:23:13,139
a system administrator or network

572
00:23:10,919 --> 00:23:14,519
support person and they're also going to

573
00:23:13,139 --> 00:23:16,428
be able to see things like who their

574
00:23:14,519 --> 00:23:19,019
manager is what their phone number is

575
00:23:16,429 --> 00:23:21,119
and maybe even their physical address so

576
00:23:19,019 --> 00:23:22,440
they have other avenues to attack

577
00:23:21,119 --> 00:23:27,720
potential targets with the new

578
00:23:22,440 --> 00:23:31,919
organization yep so moving on now that

579
00:23:27,720 --> 00:23:33,629
you know the the next day June 18th this

580
00:23:31,919 --> 00:23:35,850
is when we first saw that first command

581
00:23:33,629 --> 00:23:37,529
being issued to the to the web shell now

582
00:23:35,850 --> 00:23:41,279
I've got like this command prompt dish

583
00:23:37,529 --> 00:23:42,570
kind of box here this this isn't what

584
00:23:41,279 --> 00:23:44,070
the adversary would be looking at they'd

585
00:23:42,570 --> 00:23:46,289
be looking at the web shell obviously

586
00:23:44,070 --> 00:23:48,059
right but what I did want to point out

587
00:23:46,289 --> 00:23:51,090
here is that the top left corner you see

588
00:23:48,059 --> 00:23:53,190
this Oh W a auth error to DES aspx and

589
00:23:51,090 --> 00:23:55,590
then there's error three aspx right

590
00:23:53,190 --> 00:23:57,570
underneath it those are the two URLs for

591
00:23:55,590 --> 00:24:00,389
the loader and the payload so there

592
00:23:57,570 --> 00:24:02,609
they're using error to to install the

593
00:24:00,389 --> 00:24:03,869
payload to error 3 okay so error 2 is

594
00:24:02,609 --> 00:24:06,899
never going to change that's actually a

595
00:24:03,869 --> 00:24:10,799
legitimate that legitimate error message

596
00:24:06,899 --> 00:24:13,590
or error page in exchange that the

597
00:24:10,799 --> 00:24:14,639
adversary appended their code to okay so

598
00:24:13,590 --> 00:24:16,619
that's never going to change

599
00:24:14,639 --> 00:24:18,479
only the the payload file is going to

600
00:24:16,619 --> 00:24:20,549
change so in June eighteenth they hopped

601
00:24:18,480 --> 00:24:24,210
on to their their web shell and ran one

602
00:24:20,549 --> 00:24:26,100
command to a my they wanted to know

603
00:24:24,210 --> 00:24:26,730
where they landed so they you know ran

604
00:24:26,100 --> 00:24:30,469
Who am I

605
00:24:26,730 --> 00:24:31,610
a couple months later they come back

606
00:24:30,470 --> 00:24:35,990
they

607
00:24:31,610 --> 00:24:37,820
upload a file m64 dot exe and just bait

608
00:24:35,990 --> 00:24:39,830
and then they run it based off of the

609
00:24:37,820 --> 00:24:41,840
command line parameters we have a pretty

610
00:24:39,830 --> 00:24:44,540
good idea that that's mini cats just

611
00:24:41,840 --> 00:24:47,360
based off of the parameters and they

612
00:24:44,540 --> 00:24:51,080
output that the the output to a text

613
00:24:47,360 --> 00:24:52,669
file then they exfiltrate the text file

614
00:24:51,080 --> 00:24:54,860
just by using the type command to

615
00:24:52,670 --> 00:24:56,780
actually visit like just visualize that

616
00:24:54,860 --> 00:24:58,299
data they probably copy and paste it

617
00:24:56,780 --> 00:25:01,690
right out of the web shell from there

618
00:24:58,299 --> 00:25:03,860
then this shows another kind of

619
00:25:01,690 --> 00:25:05,210
technique they use they just clean up

620
00:25:03,860 --> 00:25:07,399
after themselves by just deleting

621
00:25:05,210 --> 00:25:09,980
everything that they've uploaded and

622
00:25:07,400 --> 00:25:12,200
generated they delete the mini cats dump

623
00:25:09,980 --> 00:25:14,540
file they delete the mini cats

624
00:25:12,200 --> 00:25:17,179
executable and then they delete the

625
00:25:14,540 --> 00:25:19,100
two-faced payload okay this is actually

626
00:25:17,179 --> 00:25:21,740
kind of important because it shows why

627
00:25:19,100 --> 00:25:23,659
they have that two layer approach with a

628
00:25:21,740 --> 00:25:24,950
loader and a payload because they just

629
00:25:23,660 --> 00:25:26,960
delete the payload when they're done

630
00:25:24,950 --> 00:25:29,240
with it and they in the loader remains

631
00:25:26,960 --> 00:25:31,580
so it's harder to detect the office

632
00:25:29,240 --> 00:25:34,120
cated loader so they can come back and

633
00:25:31,580 --> 00:25:36,620
install the payload whenever they want

634
00:25:34,120 --> 00:25:38,928
okay a couple months later they come

635
00:25:36,620 --> 00:25:42,918
back and they run this command net group

636
00:25:38,929 --> 00:25:45,679
exchange trusted subsystem and do you

637
00:25:42,919 --> 00:25:48,049
want to explain what that is yeah so the

638
00:25:45,679 --> 00:25:50,059
exchange trusted subsystem contains all

639
00:25:48,049 --> 00:25:52,790
the computer objects in Active Directory

640
00:25:50,059 --> 00:25:55,760
that the exchange servers are and it

641
00:25:52,790 --> 00:25:57,918
gives them that high level of privileges

642
00:25:55,760 --> 00:26:00,410
that they have in the directory and to

643
00:25:57,919 --> 00:26:02,630
each other that gives each computer

644
00:26:00,410 --> 00:26:06,110
object admin rights to the other

645
00:26:02,630 --> 00:26:08,690
exchange server as well yep and that's

646
00:26:06,110 --> 00:26:11,090
really important too as you'll see but

647
00:26:08,690 --> 00:26:13,549
this specific command its output is

648
00:26:11,090 --> 00:26:15,080
going to be the other host names of

649
00:26:13,549 --> 00:26:17,720
these change servers in the environment

650
00:26:15,080 --> 00:26:19,399
so now they're identifying other targets

651
00:26:17,720 --> 00:26:22,490
that they're gonna try to move to okay

652
00:26:19,400 --> 00:26:26,030
so the next thing that they do is they

653
00:26:22,490 --> 00:26:28,070
try to they I should say there was four

654
00:26:26,030 --> 00:26:31,549
different host names that were that were

655
00:26:28,070 --> 00:26:33,139
returned by this command I replaced them

656
00:26:31,549 --> 00:26:35,889
with server name one two three and four

657
00:26:33,140 --> 00:26:40,280
so they'll see that as on the slides

658
00:26:35,890 --> 00:26:42,500
whoa so so here you can see that they're

659
00:26:40,280 --> 00:26:44,330
listing the the directory trying to find

660
00:26:42,500 --> 00:26:45,450
where the file shares are for these for

661
00:26:44,330 --> 00:26:47,129
these servers

662
00:26:45,450 --> 00:26:49,950
you can see the third one the third

663
00:26:47,130 --> 00:26:52,200
command here they pretty much enumerated

664
00:26:49,950 --> 00:26:55,680
a path to the exchange client access

665
00:26:52,200 --> 00:26:57,990
exchange web EWS folder okay that's

666
00:26:55,680 --> 00:27:01,020
where the installation is for for

667
00:26:57,990 --> 00:27:03,270
exchange and what they did was they then

668
00:27:01,020 --> 00:27:06,900
uploaded another web shell to the

669
00:27:03,270 --> 00:27:09,420
current web shell and they then time

670
00:27:06,900 --> 00:27:12,300
stomped that that file if they just

671
00:27:09,420 --> 00:27:14,880
uploaded to mimic the timestamps of a

672
00:27:12,300 --> 00:27:16,740
legitimate file on the in the

673
00:27:14,880 --> 00:27:19,110
installation of exchange called exchange

674
00:27:16,740 --> 00:27:20,880
a SM X so what are they trying to do

675
00:27:19,110 --> 00:27:22,740
they're trying to make it look like you

676
00:27:20,880 --> 00:27:24,060
know this file was part of the exchange

677
00:27:22,740 --> 00:27:27,270
installation okay

678
00:27:24,060 --> 00:27:29,429
right after they time stop it they copy

679
00:27:27,270 --> 00:27:31,350
it over to that that other exchange

680
00:27:29,430 --> 00:27:33,420
server and the time stomping is actually

681
00:27:31,350 --> 00:27:34,889
kind of important for what josh is going

682
00:27:33,420 --> 00:27:35,960
to talk about later on so just keep that

683
00:27:34,890 --> 00:27:39,720
in mind

684
00:27:35,960 --> 00:27:42,030
so what else did they do they copied

685
00:27:39,720 --> 00:27:45,450
that that web shell over to the other

686
00:27:42,030 --> 00:27:47,490
the other three exchange servers that

687
00:27:45,450 --> 00:27:50,490
they found okay this is them pivoting

688
00:27:47,490 --> 00:27:53,850
and moving laterally to other servers on

689
00:27:50,490 --> 00:27:56,670
the network to expand their their access

690
00:27:53,850 --> 00:27:58,590
then what did they do before they left

691
00:27:56,670 --> 00:28:00,510
they just deleted the two-faced payload

692
00:27:58,590 --> 00:28:03,090
from the system just to kind of clean up

693
00:28:00,510 --> 00:28:05,790
after themselves okay so like a month

694
00:28:03,090 --> 00:28:07,590
and a half later we see the adversary

695
00:28:05,790 --> 00:28:10,290
come back they were probably doing other

696
00:28:07,590 --> 00:28:11,970
activities on the other exchange servers

697
00:28:10,290 --> 00:28:14,310
unfortunately we didn't have access to

698
00:28:11,970 --> 00:28:16,380
the the logs on that system or those

699
00:28:14,310 --> 00:28:18,990
systems so we kind of lost visibility

700
00:28:16,380 --> 00:28:21,060
and what they were doing but this is

701
00:28:18,990 --> 00:28:23,520
where they come back they run that same

702
00:28:21,060 --> 00:28:26,850
command net group exchange trusted sub

703
00:28:23,520 --> 00:28:28,980
system and there you are now trying to

704
00:28:26,850 --> 00:28:30,959
figure out why they lost access to one

705
00:28:28,980 --> 00:28:33,750
of their exchange servers okay and

706
00:28:30,960 --> 00:28:36,210
you'll see why we think that based off

707
00:28:33,750 --> 00:28:38,040
the next couple the next couple commands

708
00:28:36,210 --> 00:28:39,750
so what are they trying to do here

709
00:28:38,040 --> 00:28:44,510
they're trying to list the contents of

710
00:28:39,750 --> 00:28:49,800
that folder that they copied the the

711
00:28:44,510 --> 00:28:51,990
exchange web shell - and they do that on

712
00:28:49,800 --> 00:28:54,090
all four of those servers and then

713
00:28:51,990 --> 00:28:56,010
immediately after they try pinging one

714
00:28:54,090 --> 00:28:59,159
of the servers because they lost access

715
00:28:56,010 --> 00:29:02,150
to cert in this case server number three

716
00:28:59,160 --> 00:29:03,630
and what did they do to kind of you know

717
00:29:02,150 --> 00:29:06,090
fix that

718
00:29:03,630 --> 00:29:09,180
well they uploaded yet another web shell

719
00:29:06,090 --> 00:29:11,010
to all of the exchange servers on the

720
00:29:09,180 --> 00:29:12,810
network and this wasn't even to face

721
00:29:11,010 --> 00:29:14,310
this is completely different so what

722
00:29:12,810 --> 00:29:16,290
they trying to do they're trying to make

723
00:29:14,310 --> 00:29:18,300
sure that if the organization that is

724
00:29:16,290 --> 00:29:21,090
now trying to remediate their servers

725
00:29:18,300 --> 00:29:23,370
hopefully they don't catch this now

726
00:29:21,090 --> 00:29:25,679
completely new web shell on the system

727
00:29:23,370 --> 00:29:27,959
as well so what they did was they

728
00:29:25,680 --> 00:29:30,060
uploaded it global that aspx to all

729
00:29:27,960 --> 00:29:33,240
those systems all those exchange servers

730
00:29:30,060 --> 00:29:36,090
they hit it using the Trib command and

731
00:29:33,240 --> 00:29:37,590
so it's now hidden but while they're at

732
00:29:36,090 --> 00:29:39,689
it and while they're here what they do

733
00:29:37,590 --> 00:29:42,659
is they upload yet another executable

734
00:29:39,690 --> 00:29:46,290
and they run it and it's mini cats the

735
00:29:42,660 --> 00:29:48,330
outlook output the contents to a text

736
00:29:46,290 --> 00:29:50,310
file and then they exfiltrate it so

737
00:29:48,330 --> 00:29:53,850
every almost every single time they came

738
00:29:50,310 --> 00:29:56,129
back they uploaded a new mini cats tool

739
00:29:53,850 --> 00:29:58,129
and try to dump the credentials so it

740
00:29:56,130 --> 00:30:01,140
was definitely a part of their playbook

741
00:29:58,130 --> 00:30:02,630
again they delete the payload after to

742
00:30:01,140 --> 00:30:05,640
kind of clean up after themselves

743
00:30:02,630 --> 00:30:08,250
okay so may third and we're kind of

744
00:30:05,640 --> 00:30:09,960
running out of time may 3rd they come

745
00:30:08,250 --> 00:30:11,820
back and this is the last time we saw

746
00:30:09,960 --> 00:30:13,590
them at this point this is when the

747
00:30:11,820 --> 00:30:15,270
organization the impacted organization

748
00:30:13,590 --> 00:30:17,250
was really on to you know in the

749
00:30:15,270 --> 00:30:20,250
remediation process to get this this

750
00:30:17,250 --> 00:30:22,320
adversary out of their network they lost

751
00:30:20,250 --> 00:30:24,330
access to some of their of their

752
00:30:22,320 --> 00:30:26,639
exchange servers they're just trying to

753
00:30:24,330 --> 00:30:28,620
you know recoup as much as they can they

754
00:30:26,640 --> 00:30:30,540
uploaded another mini cat's tool to the

755
00:30:28,620 --> 00:30:33,479
system and tried to exfiltrate those

756
00:30:30,540 --> 00:30:37,170
those dumped credentials and that was it

757
00:30:33,480 --> 00:30:39,180
that we'd never saw them again ok so

758
00:30:37,170 --> 00:30:41,580
let's talk about how we would find this

759
00:30:39,180 --> 00:30:43,800
type of activity from the host side

760
00:30:41,580 --> 00:30:46,230
obviously we've been talking a lot about

761
00:30:43,800 --> 00:30:48,870
exchange servers because to face and

762
00:30:46,230 --> 00:30:51,060
many other shells target them so first

763
00:30:48,870 --> 00:30:53,070
thing you're gonna want to do is find

764
00:30:51,060 --> 00:30:54,780
out where all the exchange servers

765
00:30:53,070 --> 00:30:56,340
specifically with the client access

766
00:30:54,780 --> 00:30:59,010
server role because that's going to be

767
00:30:56,340 --> 00:31:01,199
the internet facing role exists and you

768
00:30:59,010 --> 00:31:02,970
could use this PowerShell command and

769
00:31:01,200 --> 00:31:06,350
the Exchange Management shell to do that

770
00:31:02,970 --> 00:31:09,510
now exchange is just a at least the

771
00:31:06,350 --> 00:31:12,340
public facing portions of it is just a

772
00:31:09,510 --> 00:31:14,289
web application running on is

773
00:31:12,340 --> 00:31:16,570
so once you find out where those servers

774
00:31:14,289 --> 00:31:18,158
are you're going to want to know where

775
00:31:16,570 --> 00:31:20,080
the log files are typically they're

776
00:31:18,159 --> 00:31:22,000
gonna be in the default location but it

777
00:31:20,080 --> 00:31:24,490
is possible and many organizations do

778
00:31:22,000 --> 00:31:25,330
move those off to another Drive for many

779
00:31:24,490 --> 00:31:27,730
different reasons

780
00:31:25,330 --> 00:31:31,168
so this PowerShell command here will

781
00:31:27,730 --> 00:31:32,799
identify where your log files are stored

782
00:31:31,169 --> 00:31:36,429
another thing you're going to want to

783
00:31:32,799 --> 00:31:39,000
look at is these settings in is related

784
00:31:36,429 --> 00:31:42,070
to logging one thing that we've seen

785
00:31:39,000 --> 00:31:43,779
attackers do not necessarily this one in

786
00:31:42,070 --> 00:31:46,240
this campaign but with some other web

787
00:31:43,779 --> 00:31:48,429
shells we found on it on different is

788
00:31:46,240 --> 00:31:50,500
and exchange servers is they'll use the

789
00:31:48,429 --> 00:31:53,159
advanced logging to try and hide their

790
00:31:50,500 --> 00:31:56,559
activity this is a built in function in

791
00:31:53,159 --> 00:31:59,649
iis and allows you to filter out things

792
00:31:56,559 --> 00:32:02,020
in the logs the legit use of it is to

793
00:31:59,649 --> 00:32:03,489
make your logs a little less noisy but

794
00:32:02,020 --> 00:32:06,539
attackers will use it to try and hide

795
00:32:03,490 --> 00:32:08,649
access to their web shell implants

796
00:32:06,539 --> 00:32:09,908
another thing you're gonna want to do is

797
00:32:08,649 --> 00:32:11,979
and this is something you should

798
00:32:09,909 --> 00:32:13,570
absolutely do proactively don't wait

799
00:32:11,980 --> 00:32:16,600
until you're trying to find a web shell

800
00:32:13,570 --> 00:32:19,629
on your system make sure that you are

801
00:32:16,600 --> 00:32:25,120
logging cookies this is not a field that

802
00:32:19,630 --> 00:32:27,820
is logged by default and once you've

803
00:32:25,120 --> 00:32:29,620
found all that it's time to take a look

804
00:32:27,820 --> 00:32:32,260
in those logs here I'm using a tool

805
00:32:29,620 --> 00:32:35,590
called log parser studio because it has

806
00:32:32,260 --> 00:32:38,620
a lot of built-in functions for parsing

807
00:32:35,590 --> 00:32:40,570
exchange and is log specifically first

808
00:32:38,620 --> 00:32:42,658
thing we're going to look for is post

809
00:32:40,570 --> 00:32:46,720
operations with low request accounts

810
00:32:42,659 --> 00:32:48,880
these applications like exchange have

811
00:32:46,720 --> 00:32:51,039
very few pages that you post to at all

812
00:32:48,880 --> 00:32:53,890
but you can kind of do some long tail

813
00:32:51,039 --> 00:32:55,450
analysis here right our top end is going

814
00:32:53,890 --> 00:32:57,309
to be our legitimate pages where they

815
00:32:55,450 --> 00:32:59,409
have lots and lots and lots of requests

816
00:32:57,309 --> 00:33:01,690
and then down at the low end on that

817
00:32:59,409 --> 00:33:04,960
long tail we're gonna see some hits with

818
00:33:01,690 --> 00:33:06,520
very few requests and there shouldn't be

819
00:33:04,960 --> 00:33:08,350
a whole lot of them so they'll be easily

820
00:33:06,520 --> 00:33:09,639
identifiable for me only one of the

821
00:33:08,350 --> 00:33:11,770
three that I have highlighted in this

822
00:33:09,640 --> 00:33:14,500
screenshot is actually a web shell the

823
00:33:11,770 --> 00:33:16,029
other two are legitimate sometimes just

824
00:33:14,500 --> 00:33:18,760
the way that people type things in or

825
00:33:16,029 --> 00:33:20,440
make typos you'll find a few low counts

826
00:33:18,760 --> 00:33:22,690
in there on those but you can very

827
00:33:20,440 --> 00:33:24,730
quickly rule them out as legitimate and

828
00:33:22,690 --> 00:33:26,380
focus your efforts on analyzing the

829
00:33:24,730 --> 00:33:27,700
shell that you've just found

830
00:33:26,380 --> 00:33:31,150
other thing that you're going to want to

831
00:33:27,700 --> 00:33:32,650
use to focus your hunts is look for your

832
00:33:31,150 --> 00:33:35,050
eyes that don't require authentication

833
00:33:32,650 --> 00:33:38,020
it doesn't make a lot of sense for me as

834
00:33:35,050 --> 00:33:39,450
an attacker to drop my web shell in a

835
00:33:38,020 --> 00:33:41,920
location that requires me to

836
00:33:39,450 --> 00:33:44,440
authenticate using credentials that I've

837
00:33:41,920 --> 00:33:46,270
obtained from my target because if I

838
00:33:44,440 --> 00:33:48,520
lose those credentials I want a way to

839
00:33:46,270 --> 00:33:51,280
get back in so in applications like

840
00:33:48,520 --> 00:33:53,920
exchange the paths that we saw on Rob

841
00:33:51,280 --> 00:33:56,230
slide earlier are pre authentication

842
00:33:53,920 --> 00:33:58,030
paths and that's where they're most

843
00:33:56,230 --> 00:34:00,040
likely to drop them in and that's you'll

844
00:33:58,030 --> 00:34:02,740
see that one highlighted here that OWA

845
00:34:00,040 --> 00:34:05,889
off and then you're gonna want to look

846
00:34:02,740 --> 00:34:07,630
for some get operations with the 404

847
00:34:05,890 --> 00:34:11,070
status meaning that the page wasn't

848
00:34:07,630 --> 00:34:14,590
found and this is how I have found

849
00:34:11,070 --> 00:34:17,110
attacker implants and access where they

850
00:34:14,590 --> 00:34:19,510
have used that advanced logging to try

851
00:34:17,110 --> 00:34:21,730
and hide their activities because your

852
00:34:19,510 --> 00:34:24,040
adversary especially in cases like the

853
00:34:21,730 --> 00:34:26,429
threat actor that used to face are

854
00:34:24,040 --> 00:34:29,830
humans just like us they make mistakes

855
00:34:26,429 --> 00:34:31,330
they make typos those typos are not

856
00:34:29,830 --> 00:34:33,759
going to get caught by the advanced log

857
00:34:31,330 --> 00:34:35,770
filtering they're going to show up as a

858
00:34:33,760 --> 00:34:38,800
404 because you know I missed something

859
00:34:35,770 --> 00:34:42,300
like the O in error or the U and off

860
00:34:38,800 --> 00:34:45,430
when I was trying to access my web show

861
00:34:42,300 --> 00:34:47,200
once you've identified the shell we're

862
00:34:45,429 --> 00:34:49,859
going to want to start seeing what did

863
00:34:47,199 --> 00:34:52,449
they do with their access to the

864
00:34:49,860 --> 00:34:55,420
exchange server one thing I want to know

865
00:34:52,449 --> 00:34:57,430
is the user agent now in the case of

866
00:34:55,420 --> 00:34:59,380
two-face they really liked old versions

867
00:34:57,430 --> 00:35:02,350
of Firefox for some reason and that

868
00:34:59,380 --> 00:35:03,940
actually tends to stand out it helps you

869
00:35:02,350 --> 00:35:07,270
know if your organization's have a

870
00:35:03,940 --> 00:35:09,790
standard web browser that they use but

871
00:35:07,270 --> 00:35:12,160
that's not always the case and you'll

872
00:35:09,790 --> 00:35:13,840
still find that it tends to be unique

873
00:35:12,160 --> 00:35:15,609
right what they used is going to stand

874
00:35:13,840 --> 00:35:17,700
out from your legitimate activity and

875
00:35:15,610 --> 00:35:20,680
it's a way that you can pivot into

876
00:35:17,700 --> 00:35:22,390
finding what they did so from here we

877
00:35:20,680 --> 00:35:26,140
can combine that information and

878
00:35:22,390 --> 00:35:27,700
identify compromised accounts and then

879
00:35:26,140 --> 00:35:30,910
once we've identified compromised

880
00:35:27,700 --> 00:35:33,540
accounts we can identify further

881
00:35:30,910 --> 00:35:37,180
activity and further compromised by

882
00:35:33,540 --> 00:35:39,580
looking at the clients ID field in the

883
00:35:37,180 --> 00:35:40,029
is logs here that clients ID is kind of

884
00:35:39,580 --> 00:35:42,430
a

885
00:35:40,030 --> 00:35:46,660
server-side cookie reference its unique

886
00:35:42,430 --> 00:35:49,089
per computer so if I have accessed one

887
00:35:46,660 --> 00:35:51,100
account from the same computer and an I

888
00:35:49,090 --> 00:35:53,920
log in with a different account my

889
00:35:51,100 --> 00:35:55,330
client ID will stay the same and I can

890
00:35:53,920 --> 00:35:57,160
identify additional accounts that have

891
00:35:55,330 --> 00:35:58,690
been compromised that way so I'm going

892
00:35:57,160 --> 00:36:01,750
to give it back to Rob here to show some

893
00:35:58,690 --> 00:36:05,050
other analysis yeah so Josh was using

894
00:36:01,750 --> 00:36:07,590
log parts of Studio I don't use that I

895
00:36:05,050 --> 00:36:11,110
use grep so I just looked through the

896
00:36:07,590 --> 00:36:12,760
logs using some simple grab I just want

897
00:36:11,110 --> 00:36:15,010
to kind of show like the things that I

898
00:36:12,760 --> 00:36:17,260
showed in the commands and what would

899
00:36:15,010 --> 00:36:19,780
run and some of the activity this all

900
00:36:17,260 --> 00:36:21,940
came from IAS logs okay so there's a

901
00:36:19,780 --> 00:36:24,370
wealth of information in those logs that

902
00:36:21,940 --> 00:36:26,430
you can really extract and figure out

903
00:36:24,370 --> 00:36:28,779
what was actually done on your network

904
00:36:26,430 --> 00:36:32,140
so in this case you can actually see

905
00:36:28,780 --> 00:36:35,290
this is the URL that was access to read

906
00:36:32,140 --> 00:36:37,720
the the the address book specifically

907
00:36:35,290 --> 00:36:40,029
looking for specific I think this was a

908
00:36:37,720 --> 00:36:41,770
mailbox user so this is they're looking

909
00:36:40,030 --> 00:36:44,380
for a specific person in this case

910
00:36:41,770 --> 00:36:46,870
that's in that yellow highlight in this

911
00:36:44,380 --> 00:36:49,120
green highlight box that's the kind of

912
00:36:46,870 --> 00:36:51,250
redacted IP address that was carrying

913
00:36:49,120 --> 00:36:53,770
out that activity so it's a routable IP

914
00:36:51,250 --> 00:36:57,220
address and that's the one that was geo

915
00:36:53,770 --> 00:36:59,380
located in iran here's another one of

916
00:36:57,220 --> 00:37:01,810
those logs that I found this is the

917
00:36:59,380 --> 00:37:04,570
actual sending of the email you can

918
00:37:01,810 --> 00:37:05,799
actually see it's using the exchange to

919
00:37:04,570 --> 00:37:09,010
send this email you can see the

920
00:37:05,800 --> 00:37:11,290
recipients you can see the the nm I

921
00:37:09,010 --> 00:37:13,450
guess is the the word for subject or the

922
00:37:11,290 --> 00:37:15,370
the parameter for the subject here and

923
00:37:13,450 --> 00:37:18,520
you can see again in that green box it's

924
00:37:15,370 --> 00:37:20,859
it's that same IP address now from the

925
00:37:18,520 --> 00:37:23,560
commands that were issued to to face

926
00:37:20,860 --> 00:37:27,100
itself all the commands were just passed

927
00:37:23,560 --> 00:37:30,460
through the cookie field so that's

928
00:37:27,100 --> 00:37:32,650
getting back to what Josh said if we

929
00:37:30,460 --> 00:37:35,920
didn't have cookies enabled on this

930
00:37:32,650 --> 00:37:38,740
organizations is server we would have

931
00:37:35,920 --> 00:37:40,810
had no idea what the adversary ran from

932
00:37:38,740 --> 00:37:42,819
a command perspective but here you can

933
00:37:40,810 --> 00:37:44,710
see that same IP address here was

934
00:37:42,820 --> 00:37:47,560
interacting with a post request to a to

935
00:37:44,710 --> 00:37:49,270
face payload and there in that cookie I

936
00:37:47,560 --> 00:37:53,730
highlighted and yell out that that's

937
00:37:49,270 --> 00:37:53,730
where the who a my command was issued

938
00:37:53,950 --> 00:37:58,279
all right all hope is not necessarily

939
00:37:56,240 --> 00:38:01,009
lost if you don't have that cookie field

940
00:37:58,280 --> 00:38:02,990
available in your logs you can also look

941
00:38:01,010 --> 00:38:05,510
for suspicious process creation in your

942
00:38:02,990 --> 00:38:07,160
windows event logs however this is

943
00:38:05,510 --> 00:38:08,660
another thing that isn't enabled by

944
00:38:07,160 --> 00:38:12,649
default you need to make sure that you

945
00:38:08,660 --> 00:38:14,960
have enabled process creation policy so

946
00:38:12,650 --> 00:38:17,420
you can look for either the 46 88 event

947
00:38:14,960 --> 00:38:20,000
or if you're using system on event ID 1

948
00:38:17,420 --> 00:38:21,260
and what you're going to want to or you

949
00:38:20,000 --> 00:38:22,430
could use any other tool out there's a

950
00:38:21,260 --> 00:38:28,430
lot of different tools on the market

951
00:38:22,430 --> 00:38:29,839
that will record process creation and

952
00:38:28,430 --> 00:38:32,720
then what you're going to look for is

953
00:38:29,840 --> 00:38:35,540
the w3 WP process which is the IAS

954
00:38:32,720 --> 00:38:37,939
worker spawning different things it's

955
00:38:35,540 --> 00:38:40,060
not normal for this to happen usually

956
00:38:37,940 --> 00:38:42,320
that process is only going to be

957
00:38:40,060 --> 00:38:44,660
creating the application pools and

958
00:38:42,320 --> 00:38:46,730
things like that so if you remember back

959
00:38:44,660 --> 00:38:48,950
we're talking about that Who am I

960
00:38:46,730 --> 00:38:51,350
command being issued you know that'll

961
00:38:48,950 --> 00:38:54,980
show up in those event logs and in that

962
00:38:51,350 --> 00:38:56,630
process creation now when you run that

963
00:38:54,980 --> 00:38:59,090
you'll typically get returned NT

964
00:38:56,630 --> 00:39:00,920
authorities system because this process

965
00:38:59,090 --> 00:39:03,140
or the parent process is running under

966
00:39:00,920 --> 00:39:05,540
the system context which means you are

967
00:39:03,140 --> 00:39:07,339
that exchange server and that gives you

968
00:39:05,540 --> 00:39:09,259
those really powerful privileges to move

969
00:39:07,340 --> 00:39:10,760
throughout the environments so that's

970
00:39:09,260 --> 00:39:12,680
another thing you really want to look

971
00:39:10,760 --> 00:39:14,480
out for when you're hunting and

972
00:39:12,680 --> 00:39:17,089
investigating on on your changeover

973
00:39:14,480 --> 00:39:18,830
serum next I have a tool that I wrote a

974
00:39:17,090 --> 00:39:22,340
couple years ago called invoke exchange

975
00:39:18,830 --> 00:39:25,310
web shell hunter and this is looking at

976
00:39:22,340 --> 00:39:26,930
the install date which is stamped on the

977
00:39:25,310 --> 00:39:30,970
exchange server object in Active

978
00:39:26,930 --> 00:39:33,830
Directory and it is updated every time a

979
00:39:30,970 --> 00:39:36,410
cumulative update in exchange 2013 and

980
00:39:33,830 --> 00:39:40,100
later is installed and comparing against

981
00:39:36,410 --> 00:39:42,740
the timestamp in the Master File table

982
00:39:40,100 --> 00:39:44,420
and I gotta give a shout out to Jared

983
00:39:42,740 --> 00:39:46,279
Atkinson for helping me out with this

984
00:39:44,420 --> 00:39:49,190
and let me borrow some code from power

985
00:39:46,280 --> 00:39:51,890
forensics but this will quickly identify

986
00:39:49,190 --> 00:39:53,560
anything that's out of place on the

987
00:39:51,890 --> 00:39:57,200
exchange server because this script

988
00:39:53,560 --> 00:39:59,720
focuses on the exchange install

989
00:39:57,200 --> 00:40:02,419
directory as well as keeping the focus

990
00:39:59,720 --> 00:40:06,009
on those paths that do not require

991
00:40:02,420 --> 00:40:06,010
authentication to access

992
00:40:06,470 --> 00:40:10,950
so with that you should be able to use

993
00:40:08,880 --> 00:40:14,250
most of these hunting techniques in our

994
00:40:10,950 --> 00:40:15,750
final attack graft scenario here to kind

995
00:40:14,250 --> 00:40:19,200
of get our adversary out of the

996
00:40:15,750 --> 00:40:22,920
environment here or asking for some dfi

997
00:40:19,200 --> 00:40:24,808
our help our expert comes in and most

998
00:40:22,920 --> 00:40:26,880
investigations don't necessarily start

999
00:40:24,809 --> 00:40:28,799
with the exchange server but as you see

1000
00:40:26,880 --> 00:40:30,569
there's a lot of quick wins you can have

1001
00:40:28,799 --> 00:40:33,329
there so if you're coming in doing some

1002
00:40:30,569 --> 00:40:35,339
proactive threat hunting start there use

1003
00:40:33,329 --> 00:40:37,859
what you just learned today and from

1004
00:40:35,339 --> 00:40:40,259
there you can start tracing back through

1005
00:40:37,859 --> 00:40:43,589
the environment and find out what else

1006
00:40:40,260 --> 00:40:45,270
the attacker did once they were in or

1007
00:40:43,589 --> 00:40:48,270
maybe even traced back to the start of

1008
00:40:45,270 --> 00:40:51,420
the compromise there and end up cleaning

1009
00:40:48,270 --> 00:40:53,910
everything out I also wanted to talk

1010
00:40:51,420 --> 00:40:56,099
about some mitigation so we talked about

1011
00:40:53,910 --> 00:40:57,808
you know how to find this and analyze

1012
00:40:56,099 --> 00:41:00,089
the activity if it's happening in there

1013
00:40:57,809 --> 00:41:02,160
but I think it's just as important to

1014
00:41:00,089 --> 00:41:04,859
take some steps to try and prevent this

1015
00:41:02,160 --> 00:41:06,359
from happening in the first place now I

1016
00:41:04,859 --> 00:41:09,210
don't want to sound like that hey just

1017
00:41:06,359 --> 00:41:12,750
patch your systems guy right but Patra

1018
00:41:09,210 --> 00:41:14,279
systems first one that you're gonna want

1019
00:41:12,750 --> 00:41:16,559
to make sure you pay attention to is

1020
00:41:14,279 --> 00:41:19,289
this vulnerability here that was related

1021
00:41:16,559 --> 00:41:22,160
to per if exchange which was kind of

1022
00:41:19,289 --> 00:41:26,520
announced earlier this year and then

1023
00:41:22,160 --> 00:41:29,368
these patches help mitigate against

1024
00:41:26,520 --> 00:41:34,020
Prive exchange as well they reduce the

1025
00:41:29,369 --> 00:41:37,650
over privileged aspect of exchange in

1026
00:41:34,020 --> 00:41:40,109
Active Directory and then also make sure

1027
00:41:37,650 --> 00:41:41,880
that your outlook systems or any system

1028
00:41:40,109 --> 00:41:45,808
running outlook is patched for that

1029
00:41:41,880 --> 00:41:48,809
Ruler vulnerability and then there's a

1030
00:41:45,809 --> 00:41:51,720
blog article that I wrote a while back

1031
00:41:48,809 --> 00:41:54,210
that will tell you how to further reduce

1032
00:41:51,720 --> 00:41:55,890
the impact that exchange has in your

1033
00:41:54,210 --> 00:41:57,960
Active Directory environment and I'll

1034
00:41:55,890 --> 00:41:59,549
make these slides available tomorrow

1035
00:41:57,960 --> 00:42:02,460
when I get home so everybody can have

1036
00:41:59,549 --> 00:42:04,259
the reference points and then finally

1037
00:42:02,460 --> 00:42:06,210
want to implement secure administration

1038
00:42:04,260 --> 00:42:09,480
practices so if you're using things like

1039
00:42:06,210 --> 00:42:12,329
privileged access workstations and laps

1040
00:42:09,480 --> 00:42:14,279
and whatnot you know you're gonna reduce

1041
00:42:12,329 --> 00:42:17,549
the chance that the attacker has the

1042
00:42:14,279 --> 00:42:18,660
ability to move laterally and make their

1043
00:42:17,549 --> 00:42:21,810
way to your exchange

1044
00:42:18,660 --> 00:42:23,940
server to implement a web shell or

1045
00:42:21,810 --> 00:42:26,130
implant a web show on that and so with

1046
00:42:23,940 --> 00:42:27,750
that I think we got a couple minutes

1047
00:42:26,130 --> 00:42:30,910
left we're just almost out of time but

1048
00:42:27,750 --> 00:42:34,100
we have any questions yeah

1049
00:42:30,910 --> 00:42:34,100
[Music]

1050
00:42:42,000 --> 00:42:51,780
it could yes so I have not this one

1051
00:42:47,730 --> 00:42:54,090
specifically seen some go after male

1052
00:42:51,780 --> 00:42:57,000
host but not the the big ones that are

1053
00:42:54,090 --> 00:43:00,120
out there so like your office 365's and

1054
00:42:57,000 --> 00:43:01,530
Gmail and whatnot are really good at

1055
00:43:00,120 --> 00:43:03,569
preventing this sort of thing from

1056
00:43:01,530 --> 00:43:06,570
happening but kind of your lower more

1057
00:43:03,570 --> 00:43:09,620
mom-and-pop server hosting mail type

1058
00:43:06,570 --> 00:43:22,280
places definitely there are questions

1059
00:43:09,620 --> 00:43:24,600
yeah the the question was why the the

1060
00:43:22,280 --> 00:43:29,040
developer of the web shell used cookies

1061
00:43:24,600 --> 00:43:32,120
to you know past the commands I don't

1062
00:43:29,040 --> 00:43:35,610
know because some versions they use the

1063
00:43:32,120 --> 00:43:38,549
post date parameters in the the data

1064
00:43:35,610 --> 00:43:41,670
itself it could also be the fact that

1065
00:43:38,550 --> 00:43:43,350
you know by default IAS doesn't log that

1066
00:43:41,670 --> 00:43:45,870
so it just kind of flies under the radar

1067
00:43:43,350 --> 00:43:48,390
but I'm not quite sure one of the other

1068
00:43:45,870 --> 00:43:50,490
things is if you are you know doing any

1069
00:43:48,390 --> 00:43:52,680
sort of network capture these would kind

1070
00:43:50,490 --> 00:43:56,779
of be right there in the P cap so I

1071
00:43:52,680 --> 00:43:56,779
honestly I don't know it's pretty noisy

1072
00:43:57,260 --> 00:44:00,440
wait about

1073
00:44:06,609 --> 00:44:13,578
so not specifically we actually lost

1074
00:44:10,609 --> 00:44:14,869
visibility on that but the I mean if you

1075
00:44:13,579 --> 00:44:16,430
look at most of the things that they're

1076
00:44:14,869 --> 00:44:18,619
doing they're using creds to just kind

1077
00:44:16,430 --> 00:44:20,960
of spread all over so we don't know

1078
00:44:18,619 --> 00:44:23,089
they're like mission objective like what

1079
00:44:20,960 --> 00:44:24,739
the but they were trying to get to but

1080
00:44:23,089 --> 00:44:26,480
they were clearly using dumped

1081
00:44:24,739 --> 00:44:28,279
credentials and stolen credentials to

1082
00:44:26,480 --> 00:44:31,730
move to other places to try to get to

1083
00:44:28,279 --> 00:44:34,460
whatever they were looking for one thing

1084
00:44:31,730 --> 00:44:36,890
I'll add to that if you've never run

1085
00:44:34,460 --> 00:44:39,619
movie cats on an exchange server

1086
00:44:36,890 --> 00:44:41,779
it's like it'll just rain creds if you

1087
00:44:39,619 --> 00:44:43,700
run it on there so it gives them access

1088
00:44:41,779 --> 00:44:45,319
to other mailboxes and as you saw they

1089
00:44:43,700 --> 00:44:48,169
were very interested in going through

1090
00:44:45,319 --> 00:44:50,660
and accessing different mailboxes and

1091
00:44:48,170 --> 00:44:53,359
gathering data out of the email

1092
00:44:50,660 --> 00:44:56,629
environment itself but again it gives

1093
00:44:53,359 --> 00:45:00,759
them further access into their target so

1094
00:44:56,630 --> 00:45:03,499
they can excel trade data questions I

1095
00:45:00,759 --> 00:45:07,190
think that's all right thank you guys so

1096
00:45:03,499 --> 00:45:10,578
much for hanging out and being here late

1097
00:45:07,190 --> 00:45:14,170
on the last day of derbycon we're very

1098
00:45:10,579 --> 00:45:14,170
very honored to be here thank you guys

