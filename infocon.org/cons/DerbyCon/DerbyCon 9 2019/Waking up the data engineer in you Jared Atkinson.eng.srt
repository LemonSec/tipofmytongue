1
00:00:00,000 --> 00:00:04,470
okay cool all right everybody welcome to

2
00:00:02,310 --> 00:00:07,680
my talk waking up the data engineering

3
00:00:04,470 --> 00:00:09,149
you so I'm Jared Atkinson a quick bio so

4
00:00:07,680 --> 00:00:11,219
I don't have much time but I'm the

5
00:00:09,150 --> 00:00:13,049
technical director at adversary

6
00:00:11,219 --> 00:00:15,239
detection inspector ops do a lot of

7
00:00:13,049 --> 00:00:17,400
PowerShell developments I'm really good

8
00:00:15,240 --> 00:00:19,770
at minesweeper on Windows little school

9
00:00:17,400 --> 00:00:22,830
game 56 seconds on expert if anybody

10
00:00:19,770 --> 00:00:24,350
wants to challenge me is my record used

11
00:00:22,830 --> 00:00:26,669
to be an air force that kind of thing so

12
00:00:24,350 --> 00:00:29,279
what I'm planning on talking about today

13
00:00:26,670 --> 00:00:30,929
is a specter ops one of the things that

14
00:00:29,279 --> 00:00:32,430
we get to do is teach teach training

15
00:00:30,929 --> 00:00:34,829
classes and one of the training classes

16
00:00:32,430 --> 00:00:36,329
that I'm involved in really focuses on

17
00:00:34,829 --> 00:00:38,610
detection engineering right so how do

18
00:00:36,329 --> 00:00:42,270
you how do you build robust detections

19
00:00:38,610 --> 00:00:45,300
to focus on technique level attacks as

20
00:00:42,270 --> 00:00:46,800
opposed to very very naive detections

21
00:00:45,300 --> 00:00:48,360
that would focus on things like hashes

22
00:00:46,800 --> 00:00:51,718
URLs that type of thing so how do we

23
00:00:48,360 --> 00:00:54,000
build really robust detection in in our

24
00:00:51,719 --> 00:00:56,370
experience as instructors oftentimes

25
00:00:54,000 --> 00:00:57,960
students students teach us as much as

26
00:00:56,370 --> 00:01:00,239
we're teaching them right and so we get

27
00:00:57,960 --> 00:01:01,320
to learn learn from kind of different

28
00:01:00,239 --> 00:01:03,660
things that they're trying that we had

29
00:01:01,320 --> 00:01:05,640
never considered and so through the

30
00:01:03,660 --> 00:01:07,470
through the process of this talk I hope

31
00:01:05,640 --> 00:01:09,540
to kind of like share with you some of

32
00:01:07,470 --> 00:01:10,619
the things that I learned and how how

33
00:01:09,540 --> 00:01:12,659
like that student instructor

34
00:01:10,619 --> 00:01:15,570
relationship really helps to kind of

35
00:01:12,659 --> 00:01:18,210
inform some of the detection engineering

36
00:01:15,570 --> 00:01:20,250
efforts that we do and kind of reinforce

37
00:01:18,210 --> 00:01:21,779
the idea of how you can leverage an

38
00:01:20,250 --> 00:01:23,460
understanding of data the data or

39
00:01:21,780 --> 00:01:25,080
telemetry that you're collecting to

40
00:01:23,460 --> 00:01:29,250
really understand better ways of

41
00:01:25,080 --> 00:01:31,920
building detections okay so just kind of

42
00:01:29,250 --> 00:01:33,720
set the stage of tell a story about this

43
00:01:31,920 --> 00:01:35,280
interaction with a student and I'm going

44
00:01:33,720 --> 00:01:37,079
to talk about some strategies that you

45
00:01:35,280 --> 00:01:39,150
can use to to kind of build on it right

46
00:01:37,079 --> 00:01:40,919
so in the class one of the things that

47
00:01:39,150 --> 00:01:42,450
we do is we talk about you know how do

48
00:01:40,920 --> 00:01:43,710
you select the different attack

49
00:01:42,450 --> 00:01:45,600
technique that you're that you're

50
00:01:43,710 --> 00:01:47,399
focusing on to build intersection so

51
00:01:45,600 --> 00:01:49,229
you're building a hypothesis which says

52
00:01:47,399 --> 00:01:51,930
I think that the attacker is going to do

53
00:01:49,229 --> 00:01:53,460
X attack technique right and so I'm

54
00:01:51,930 --> 00:01:55,439
going to build a detection for that so

55
00:01:53,460 --> 00:01:56,820
one of the ways that we present to the

56
00:01:55,439 --> 00:02:00,000
students is to use threat intelligence

57
00:01:56,820 --> 00:02:02,369
right and so this is just a snippet from

58
00:02:00,000 --> 00:02:03,240
a threat intelligence report Katie Katie

59
00:02:02,369 --> 00:02:05,009
Nichols from mitre

60
00:02:03,240 --> 00:02:06,420
she wrote a blog post that's referenced

61
00:02:05,009 --> 00:02:07,829
down there at the bottom and this is

62
00:02:06,420 --> 00:02:09,780
this is taken from that right and so

63
00:02:07,829 --> 00:02:10,769
just to kind of show an example we see

64
00:02:09,780 --> 00:02:13,110
that there's a lot of

65
00:02:10,770 --> 00:02:15,930
formation here we see for instance four

66
00:02:13,110 --> 00:02:17,970
one one three PDB we see that there's

67
00:02:15,930 --> 00:02:21,630
SCH taps with the command line we see

68
00:02:17,970 --> 00:02:24,300
cmd.exe slash see who am i a lot of

69
00:02:21,630 --> 00:02:26,310
times we find that students or clients

70
00:02:24,300 --> 00:02:28,230
or just people in general and better

71
00:02:26,310 --> 00:02:29,670
ability detections focus on those very

72
00:02:28,230 --> 00:02:31,320
like specific details when they're

73
00:02:29,670 --> 00:02:34,589
building detections right so like maybe

74
00:02:31,320 --> 00:02:36,329
I want to look for sch tests being run

75
00:02:34,590 --> 00:02:37,560
with like slash creator in the command

76
00:02:36,330 --> 00:02:40,500
line or something like that or maybe I

77
00:02:37,560 --> 00:02:42,300
want to look for this bad IP address 191

78
00:02:40,500 --> 00:02:44,490
five seven one nine eight one or three

79
00:02:42,300 --> 00:02:46,920
right or these specific ports one one

80
00:02:44,490 --> 00:02:48,390
nine one three right so we see people

81
00:02:46,920 --> 00:02:49,709
that are building those but ultimately

82
00:02:48,390 --> 00:02:51,209
what we want to do is we want to treat

83
00:02:49,710 --> 00:02:53,880
this as a narrative that's just giving

84
00:02:51,210 --> 00:02:55,530
us concepts right and so what Katie does

85
00:02:53,880 --> 00:02:57,600
in her blog post is she really like kind

86
00:02:55,530 --> 00:02:59,160
of builds out and says you should read

87
00:02:57,600 --> 00:03:01,109
this narrative and as you're reading and

88
00:02:59,160 --> 00:03:03,150
say how does this relate to different

89
00:03:01,110 --> 00:03:04,350
attack techniques right so I assume most

90
00:03:03,150 --> 00:03:06,300
people are familiar with the mitre

91
00:03:04,350 --> 00:03:07,710
attack framework right so these

92
00:03:06,300 --> 00:03:09,540
techniques that are being referenced are

93
00:03:07,710 --> 00:03:11,400
all techniques from from attack

94
00:03:09,540 --> 00:03:13,620
framework and so for instance instead of

95
00:03:11,400 --> 00:03:15,090
SCH tasks let's look at it as you know

96
00:03:13,620 --> 00:03:16,650
the schedule tasks technique right

97
00:03:15,090 --> 00:03:19,230
because they're not limited to just

98
00:03:16,650 --> 00:03:20,700
using SCH tasks that exceed a build to

99
00:03:19,230 --> 00:03:22,440
create scheduled tasks they can they can

100
00:03:20,700 --> 00:03:24,269
use PowerShell they could use a third

101
00:03:22,440 --> 00:03:25,590
party binary they could do it they could

102
00:03:24,270 --> 00:03:27,090
kind of do whatever they want right and

103
00:03:25,590 --> 00:03:28,290
so we want to kind of get an

104
00:03:27,090 --> 00:03:29,370
understanding of what techniques the

105
00:03:28,290 --> 00:03:32,609
attackers will use it and then we want

106
00:03:29,370 --> 00:03:33,570
to go from there okay so in our training

107
00:03:32,610 --> 00:03:35,690
class we kind of have a similar

108
00:03:33,570 --> 00:03:38,430
situation where we present them with a

109
00:03:35,690 --> 00:03:39,690
fictional threat report they read

110
00:03:38,430 --> 00:03:41,310
through it and then they pull out the

111
00:03:39,690 --> 00:03:44,520
different techniques that they come with

112
00:03:41,310 --> 00:03:46,530
come up with and so this is kind of an

113
00:03:44,520 --> 00:03:48,600
eye chart on purpose but this is a tap

114
00:03:46,530 --> 00:03:50,490
navigator which is just a way to that

115
00:03:48,600 --> 00:03:52,049
might or is it provides to kind of

116
00:03:50,490 --> 00:03:53,580
represent the different techniques and

117
00:03:52,050 --> 00:03:56,280
so everything that's highlighted in

118
00:03:53,580 --> 00:03:57,660
purple are what we expect the students

119
00:03:56,280 --> 00:04:00,120
to be able to pull from that threat

120
00:03:57,660 --> 00:04:01,680
report right and so in this case and

121
00:04:00,120 --> 00:04:03,120
basically the reason why we really want

122
00:04:01,680 --> 00:04:05,490
to focus on the threat report is because

123
00:04:03,120 --> 00:04:06,570
the lab is recorded and we want them to

124
00:04:05,490 --> 00:04:09,300
be looking for things that they're

125
00:04:06,570 --> 00:04:11,280
probably going to find real bad stuff in

126
00:04:09,300 --> 00:04:14,520
the lab right so this particular team

127
00:04:11,280 --> 00:04:15,720
chose remote services as their as their

128
00:04:14,520 --> 00:04:17,370
technique that they wanted to look up

129
00:04:15,720 --> 00:04:19,079
and then they wanted to start building a

130
00:04:17,370 --> 00:04:21,120
detection right so

131
00:04:19,079 --> 00:04:23,130
the first thing that we like to do is

132
00:04:21,120 --> 00:04:24,479
kind of point you to the attack

133
00:04:23,130 --> 00:04:26,190
framework and say okay well you want to

134
00:04:24,479 --> 00:04:28,020
look into remote services let's go see

135
00:04:26,190 --> 00:04:29,969
what mitre says about that right so this

136
00:04:28,020 --> 00:04:31,500
is just a a really good starting point

137
00:04:29,970 --> 00:04:33,030
probably not comprehensive but it just

138
00:04:31,500 --> 00:04:36,509
gets you an idea of what's going on and

139
00:04:33,030 --> 00:04:38,609
so what they actually say is hey remote

140
00:04:36,509 --> 00:04:41,340
services is used for lateral movement

141
00:04:38,610 --> 00:04:43,319
and what it actually what they they say

142
00:04:41,340 --> 00:04:45,448
it is is chapters Tucker's end up using

143
00:04:43,319 --> 00:04:47,009
legitimate credentials to access these

144
00:04:45,449 --> 00:04:49,349
services that are mentoring remote

145
00:04:47,009 --> 00:04:50,580
administration things like ssh telnet I

146
00:04:49,349 --> 00:04:53,969
guess

147
00:04:50,580 --> 00:04:55,039
wmii or PC windows remote management

148
00:04:53,970 --> 00:04:56,880
those types of things

149
00:04:55,039 --> 00:04:58,530
attackers are just connecting to those

150
00:04:56,880 --> 00:05:00,300
and being able to run some sort of task

151
00:04:58,530 --> 00:05:03,750
on the remote system for lateral

152
00:05:00,300 --> 00:05:05,370
movement right and so once you're as

153
00:05:03,750 --> 00:05:06,870
you're reading through that what we want

154
00:05:05,370 --> 00:05:09,180
the best kind of most overlooked

155
00:05:06,870 --> 00:05:11,610
features of my air attack framework is

156
00:05:09,180 --> 00:05:13,830
this data sources piece right and so

157
00:05:11,610 --> 00:05:16,229
that's that's them giving you a hint of

158
00:05:13,830 --> 00:05:17,699
maybe where to start right so you want

159
00:05:16,229 --> 00:05:20,099
to detect remote services maybe the

160
00:05:17,699 --> 00:05:22,409
place that you should start is looking

161
00:05:20,099 --> 00:05:24,240
at authentication logs this is this

162
00:05:22,409 --> 00:05:26,849
feature of the attack framework is not

163
00:05:24,240 --> 00:05:29,099
like the most comprehensive or

164
00:05:26,849 --> 00:05:32,550
full-featured but it's just a kind of a

165
00:05:29,099 --> 00:05:34,199
good starting point so if I were to like

166
00:05:32,550 --> 00:05:35,849
ask somebody hey I want to look at

167
00:05:34,199 --> 00:05:37,440
Windows authentication logs can anybody

168
00:05:35,849 --> 00:05:39,680
help me figure out like where's the

169
00:05:37,440 --> 00:05:42,300
first place that you would think to look

170
00:05:39,680 --> 00:05:44,930
Active Directory so okay so that's

171
00:05:42,300 --> 00:05:47,039
that's kind of a thing that manages some

172
00:05:44,930 --> 00:05:48,930
endpoint logs yes so like the Windows

173
00:05:47,039 --> 00:05:52,860
Event log anybody know what you've meant

174
00:05:48,930 --> 00:05:56,250
log is like the canonical for 6to4 yep

175
00:05:52,860 --> 00:05:58,770
so 46 24 and so this again probably not

176
00:05:56,250 --> 00:06:00,479
the easiest thing to see but 46:24 as an

177
00:05:58,770 --> 00:06:03,120
account was successfully logged on and

178
00:06:00,479 --> 00:06:05,099
so just walking through their process

179
00:06:03,120 --> 00:06:07,199
right they said okay well we want to go

180
00:06:05,099 --> 00:06:09,479
into Cubana which is where our data was

181
00:06:07,199 --> 00:06:12,180
for the for the sixers exercise and we

182
00:06:09,479 --> 00:06:13,469
want to look at 46 24 events right so

183
00:06:12,180 --> 00:06:16,710
let's go ahead and check that out real

184
00:06:13,469 --> 00:06:18,750
quick okay so this is this is what they

185
00:06:16,710 --> 00:06:20,758
were presented with there's 1.1 million

186
00:06:18,750 --> 00:06:22,560
events whether that's realistic to your

187
00:06:20,759 --> 00:06:24,360
environments I don't know but just kind

188
00:06:22,560 --> 00:06:26,340
of work with be the thought process here

189
00:06:24,360 --> 00:06:28,250
and so what they what they did is they

190
00:06:26,340 --> 00:06:32,119
decide to search for

191
00:06:28,250 --> 00:06:35,390
even ID 46:24 and they came up with 3850

192
00:06:32,120 --> 00:06:37,220
90 minutes in real environments with

193
00:06:35,390 --> 00:06:38,690
clients that could be millions or you

194
00:06:37,220 --> 00:06:41,480
know hundreds of millions different

195
00:06:38,690 --> 00:06:43,040
events but even even so four thousand

196
00:06:41,480 --> 00:06:44,960
events is not something that I'm going

197
00:06:43,040 --> 00:06:46,130
to go through one by one and start

198
00:06:44,960 --> 00:06:47,750
looking through it right that's still

199
00:06:46,130 --> 00:06:50,870
too much for me to kind of go through

200
00:06:47,750 --> 00:06:53,240
and authentication in and of itself is a

201
00:06:50,870 --> 00:06:54,380
normal feature of like an operating

202
00:06:53,240 --> 00:06:55,580
system right so that there's nothing

203
00:06:54,380 --> 00:06:57,620
malicious here yet

204
00:06:55,580 --> 00:06:59,060
and so what they did is they they start

205
00:06:57,620 --> 00:07:02,240
looking around and you could kind of dig

206
00:06:59,060 --> 00:07:03,410
into this and maybe somewhat difficult

207
00:07:02,240 --> 00:07:04,940
to see but you can start to look at the

208
00:07:03,410 --> 00:07:08,150
different fields that work that we have

209
00:07:04,940 --> 00:07:10,580
right so one thing that they keyed in on

210
00:07:08,150 --> 00:07:14,030
based on their their experience let me

211
00:07:10,580 --> 00:07:15,859
find it here was this logon logon type

212
00:07:14,030 --> 00:07:19,609
field anybody familiar with the logon

213
00:07:15,860 --> 00:07:21,560
type yep so so the idea of logon type is

214
00:07:19,610 --> 00:07:23,150
it tells you like what's the context of

215
00:07:21,560 --> 00:07:25,190
that the logon happened in so like

216
00:07:23,150 --> 00:07:26,690
there's interactive log ons which is

217
00:07:25,190 --> 00:07:28,730
where you're interacting at the actual

218
00:07:26,690 --> 00:07:30,530
like console right there's Network log

219
00:07:28,730 --> 00:07:33,080
ons which is where you're doing a

220
00:07:30,530 --> 00:07:34,609
connection over over the network remote

221
00:07:33,080 --> 00:07:37,039
interactive log ons which would be like

222
00:07:34,610 --> 00:07:38,810
RDP something long about lines and

223
00:07:37,040 --> 00:07:40,820
there's quite a few different ones right

224
00:07:38,810 --> 00:07:43,460
and so what they decided to look at was

225
00:07:40,820 --> 00:07:45,020
where logon type equals three which is

226
00:07:43,460 --> 00:07:47,090
that Network logon remember we're

227
00:07:45,020 --> 00:07:48,799
thinking about remote services that kind

228
00:07:47,090 --> 00:07:51,049
of leads us to think about network log

229
00:07:48,800 --> 00:07:53,600
ons and so that's where they ended up

230
00:07:51,050 --> 00:07:56,300
going so just to kind of reiterate we're

231
00:07:53,600 --> 00:07:59,150
at about 3,800 3,900 different events

232
00:07:56,300 --> 00:08:00,740
and they decide to log on type 3 to

233
00:07:59,150 --> 00:08:02,090
their query and they went down to 3200

234
00:08:00,740 --> 00:08:04,010
and they're like well you know that

235
00:08:02,090 --> 00:08:05,750
doesn't really narrow it in all so like

236
00:08:04,010 --> 00:08:06,890
you know just because somebody logs in

237
00:08:05,750 --> 00:08:09,229
over the network doesn't mean that it's

238
00:08:06,890 --> 00:08:11,780
necessarily bad right so like one

239
00:08:09,229 --> 00:08:13,640
example of a benign Network logon event

240
00:08:11,780 --> 00:08:15,380
would be when you mount to share from

241
00:08:13,640 --> 00:08:17,570
like your share drive right so that's

242
00:08:15,380 --> 00:08:19,430
that's not necessarily indicative of bad

243
00:08:17,570 --> 00:08:20,719
behavior and so they're they're kind of

244
00:08:19,430 --> 00:08:23,300
like okay well what's the what's the

245
00:08:20,720 --> 00:08:25,610
next step well in the fictional scenario

246
00:08:23,300 --> 00:08:27,470
that we provided them we said hey one

247
00:08:25,610 --> 00:08:29,180
thing that we should be worried about is

248
00:08:27,470 --> 00:08:31,400
that there's or that you should be aware

249
00:08:29,180 --> 00:08:33,080
of as like a detection engineer within

250
00:08:31,400 --> 00:08:35,000
your company this fictional company is

251
00:08:33,080 --> 00:08:36,229
that every system has a shared vocal

252
00:08:35,000 --> 00:08:37,820
admin accountant and that has the same

253
00:08:36,229 --> 00:08:40,719
passwords right and it's called test

254
00:08:37,820 --> 00:08:42,310
admin and so what

255
00:08:40,719 --> 00:08:43,930
they did as they said okay at first we

256
00:08:42,309 --> 00:08:46,420
were trying our focus of our detection

257
00:08:43,929 --> 00:08:48,219
was to detect remote service abuse but

258
00:08:46,420 --> 00:08:49,839
now like we can based on what we found

259
00:08:48,220 --> 00:08:51,250
we want to kind of narrow and I'll focus

260
00:08:49,839 --> 00:08:53,290
a little bit right and this is a really

261
00:08:51,250 --> 00:08:55,269
good strategy a lot of times is say hey

262
00:08:53,290 --> 00:08:56,740
I'm gonna make an assumption but I'm

263
00:08:55,269 --> 00:08:58,029
going to document that for future

264
00:08:56,740 --> 00:09:00,459
reference right and so their assumption

265
00:08:58,029 --> 00:09:02,529
was now we want to look for the abuse of

266
00:09:00,459 --> 00:09:05,079
the shared local admin password in

267
00:09:02,529 --> 00:09:07,180
remote Services context right so they

268
00:09:05,079 --> 00:09:09,310
they went forward and they specified hey

269
00:09:07,180 --> 00:09:10,959
we want to see where you know logon

270
00:09:09,310 --> 00:09:13,359
events are happening over the network

271
00:09:10,959 --> 00:09:17,109
this logon type 3 and the user username

272
00:09:13,360 --> 00:09:19,300
is test admin ok and so by doing that

273
00:09:17,110 --> 00:09:21,220
they came up with 16 hits right and so

274
00:09:19,300 --> 00:09:22,839
this was the point that the students

275
00:09:21,220 --> 00:09:24,939
they kind of called me over as the

276
00:09:22,839 --> 00:09:26,350
instructor and said hey like based on

277
00:09:24,939 --> 00:09:27,819
what I've learned over the past three

278
00:09:26,350 --> 00:09:31,180
days and my experience in this lab

279
00:09:27,819 --> 00:09:33,969
environment I've identified that this is

280
00:09:31,180 --> 00:09:37,420
bad right well I can't I can't explain

281
00:09:33,970 --> 00:09:39,490
to you why why I got to where I got it

282
00:09:37,420 --> 00:09:40,839
right like it like why is this bad like

283
00:09:39,490 --> 00:09:42,910
I can't really explain that to you so

284
00:09:40,839 --> 00:09:44,980
like I'm missing some sort of context

285
00:09:42,910 --> 00:09:47,529
that allows me to definitively say this

286
00:09:44,980 --> 00:09:49,209
is in fact bad right and so this is the

287
00:09:47,529 --> 00:09:50,980
point at which I kind of told them like

288
00:09:49,209 --> 00:09:53,109
we need to take a step back and start to

289
00:09:50,980 --> 00:09:55,120
understand what the data is that we're

290
00:09:53,110 --> 00:09:56,800
dealing with right so one of the things

291
00:09:55,120 --> 00:09:58,240
this is where we're going to from like

292
00:09:56,800 --> 00:09:59,559
we have detection engineering right

293
00:09:58,240 --> 00:10:01,779
which is where you're building detection

294
00:09:59,559 --> 00:10:03,399
in a robust manner you're documenting

295
00:10:01,779 --> 00:10:04,600
those that type of thing and then we

296
00:10:03,399 --> 00:10:06,339
have data engineering which is where

297
00:10:04,600 --> 00:10:07,689
you're understanding the data or

298
00:10:06,339 --> 00:10:09,309
telemetry that you have available to you

299
00:10:07,689 --> 00:10:11,290
and how it interconnects and how it

300
00:10:09,309 --> 00:10:12,790
relates to one another right so Windows

301
00:10:11,290 --> 00:10:14,889
Event log there's hundreds or thousands

302
00:10:12,790 --> 00:10:16,569
of events those different events can be

303
00:10:14,889 --> 00:10:18,639
related to one another in different ways

304
00:10:16,569 --> 00:10:20,979
and so what we what we did is we started

305
00:10:18,639 --> 00:10:22,870
looking at one of the projects that one

306
00:10:20,980 --> 00:10:25,600
of our former colleagues made called

307
00:10:22,870 --> 00:10:27,160
OSEM and what he does is he goes through

308
00:10:25,600 --> 00:10:30,730
and documents all the different data

309
00:10:27,160 --> 00:10:32,860
that can be that can be ingested and so

310
00:10:30,730 --> 00:10:35,529
this is Windows security events even ID

311
00:10:32,860 --> 00:10:37,149
4624 just as an example and he comes

312
00:10:35,529 --> 00:10:38,949
down and he starts to say you know hey

313
00:10:37,149 --> 00:10:40,269
what's the description of this event and

314
00:10:38,949 --> 00:10:42,490
this is really this is just a really

315
00:10:40,269 --> 00:10:44,769
good practice in general so if you're

316
00:10:42,490 --> 00:10:46,089
running a sock a lot of times we go to a

317
00:10:44,769 --> 00:10:48,819
sock and we say hey what data do you

318
00:10:46,089 --> 00:10:50,559
have and the analysts say I don't know

319
00:10:48,819 --> 00:10:52,029
we have like Windows event logs and we

320
00:10:50,559 --> 00:10:53,639
have you know Proofpoint logs and we

321
00:10:52,029 --> 00:10:55,350
have system owned or whatever

322
00:10:53,639 --> 00:10:56,370
and I'm like okay well like what windows

323
00:10:55,350 --> 00:10:59,519
event logs do you have and they're like

324
00:10:56,370 --> 00:11:01,500
no idea right and so what we what we try

325
00:10:59,519 --> 00:11:03,360
to work with them on is like hey let's

326
00:11:01,500 --> 00:11:06,089
let's actually start documenting this in

327
00:11:03,360 --> 00:11:07,980
a very like intentional way and so what

328
00:11:06,089 --> 00:11:10,079
we come down to is okay well we have 46

329
00:11:07,980 --> 00:11:11,279
24 events here's kind of like an

330
00:11:10,079 --> 00:11:12,870
understanding of what this is and this

331
00:11:11,279 --> 00:11:14,790
really helps our junior analysts right

332
00:11:12,870 --> 00:11:16,529
so like there's always a guy that knows

333
00:11:14,790 --> 00:11:18,540
everything about everything and all the

334
00:11:16,529 --> 00:11:20,399
data that you have but that person is

335
00:11:18,540 --> 00:11:22,349
not sharing that information in a like

336
00:11:20,399 --> 00:11:23,850
repeatable way with the entire team

337
00:11:22,350 --> 00:11:25,439
right so we want to we want to raise the

338
00:11:23,850 --> 00:11:27,420
bar of kind of like what's our most

339
00:11:25,439 --> 00:11:29,849
junior person so that they have all the

340
00:11:27,420 --> 00:11:31,469
information they need right so so we

341
00:11:29,850 --> 00:11:33,389
come down we start saying what are the

342
00:11:31,470 --> 00:11:34,889
different fields that this this even has

343
00:11:33,389 --> 00:11:36,959
so there's like a subject user CID

344
00:11:34,889 --> 00:11:39,240
target user CID there's a logon type

345
00:11:36,959 --> 00:11:41,430
field right we saw that there's a

346
00:11:39,240 --> 00:11:43,170
workstation name there's a logon good so

347
00:11:41,430 --> 00:11:44,939
on and so forth and we're actually like

348
00:11:43,170 --> 00:11:47,209
documenting the entire part of the

349
00:11:44,939 --> 00:11:50,069
process right and kind of going through

350
00:11:47,209 --> 00:11:52,739
we also have for instance we can go and

351
00:11:50,069 --> 00:11:54,300
check out the Microsoft Microsoft has a

352
00:11:52,740 --> 00:11:56,509
github page that kind of keeps track of

353
00:11:54,300 --> 00:11:59,040
this as well and so they they go into

354
00:11:56,509 --> 00:12:00,449
what does it look like in the XML format

355
00:11:59,040 --> 00:12:03,839
that you would be receiving it at your

356
00:12:00,449 --> 00:12:05,819
sim they also actually describe in

357
00:12:03,839 --> 00:12:07,110
detail every single field that's in the

358
00:12:05,819 --> 00:12:09,149
events right so we could start to

359
00:12:07,110 --> 00:12:11,399
leverage that and understand and so to

360
00:12:09,149 --> 00:12:13,199
go back let's say let's say you didn't

361
00:12:11,399 --> 00:12:15,600
know what the logon type thing was right

362
00:12:13,199 --> 00:12:17,758
and I talked about you come here and it

363
00:12:15,600 --> 00:12:19,050
says hey logon type is a type of logon

364
00:12:17,759 --> 00:12:20,279
that was performed here's a table that

365
00:12:19,050 --> 00:12:23,128
tells you all the different types right

366
00:12:20,279 --> 00:12:24,720
so type two is interactive user logged

367
00:12:23,129 --> 00:12:26,550
onto the computer type three is network

368
00:12:24,720 --> 00:12:28,470
so on and so forth right so you're able

369
00:12:26,550 --> 00:12:30,589
to kind of like get into that and start

370
00:12:28,470 --> 00:12:33,290
understanding it okay

371
00:12:30,589 --> 00:12:36,000
all right so one of the things that we

372
00:12:33,290 --> 00:12:43,250
as we're going through this that we we

373
00:12:36,000 --> 00:12:46,230
identified trying to find it here okay

374
00:12:43,250 --> 00:12:48,120
so we have the user logon ID and so what

375
00:12:46,230 --> 00:12:49,230
that ends up being is this is kind of

376
00:12:48,120 --> 00:12:51,029
like an understanding of Windows

377
00:12:49,230 --> 00:12:53,040
internals a little bit but when you log

378
00:12:51,029 --> 00:12:54,660
on to a system there's what's called a

379
00:12:53,040 --> 00:12:56,639
logon session that's created right and

380
00:12:54,660 --> 00:12:58,620
so every logon session has what they

381
00:12:56,639 --> 00:13:01,139
call a locally unique identifier or Luud

382
00:12:58,620 --> 00:13:03,449
and that represents that logon that's

383
00:13:01,139 --> 00:13:07,769
like the identifier for that that logon

384
00:13:03,449 --> 00:13:09,508
session 46:24 have that information and

385
00:13:07,769 --> 00:13:11,459
what we could actually do if we've

386
00:13:09,509 --> 00:13:12,959
documented all of this and all of this

387
00:13:11,459 --> 00:13:16,709
stuff is we could take this name user

388
00:13:12,959 --> 00:13:19,380
logon ID and we could actually search

389
00:13:16,709 --> 00:13:20,609
through our repository and we can start

390
00:13:19,380 --> 00:13:22,620
to see all the different events that

391
00:13:20,610 --> 00:13:25,410
have user logon D four four seven nine

392
00:13:22,620 --> 00:13:26,970
nine four six six two five three seven

393
00:13:25,410 --> 00:13:28,439
seven and we could click into these and

394
00:13:26,970 --> 00:13:29,910
you know start to learn more about them

395
00:13:28,439 --> 00:13:31,949
I think an account was logged off for

396
00:13:29,910 --> 00:13:36,139
six three four right and that has a user

397
00:13:31,949 --> 00:13:39,179
logon ID and so what I told them was hey

398
00:13:36,139 --> 00:13:41,490
we have these 16 events what happens if

399
00:13:39,179 --> 00:13:44,250
we take the user logon ID that's

400
00:13:41,490 --> 00:13:49,459
associated with it and we actually just

401
00:13:44,250 --> 00:13:49,459
kind of search for that alright so again

402
00:13:51,709 --> 00:13:59,099
we have oops not ite Qabbani of course

403
00:13:57,209 --> 00:14:02,699
puts commas in the output but you can't

404
00:13:59,100 --> 00:14:04,800
have that in the actual query and so we

405
00:14:02,699 --> 00:14:06,449
end up having three hits right so these

406
00:14:04,800 --> 00:14:09,209
are basically all the events that are

407
00:14:06,449 --> 00:14:11,699
related to this user logon ID we have a

408
00:14:09,209 --> 00:14:13,589
four six to four right so that's that

409
00:14:11,699 --> 00:14:16,889
logon event we have a four six three

410
00:14:13,589 --> 00:14:18,660
four which is a log off event and we

411
00:14:16,889 --> 00:14:19,860
have a four six seven two which again we

412
00:14:18,660 --> 00:14:21,600
would be able to come in here

413
00:14:19,860 --> 00:14:24,000
search for four six seven two because

414
00:14:21,600 --> 00:14:25,620
we've documented this data and then we

415
00:14:24,000 --> 00:14:27,839
would be able to see what that is what

416
00:14:25,620 --> 00:14:29,879
that ends up being a special privilege

417
00:14:27,839 --> 00:14:31,529
was assigned which every logon is going

418
00:14:29,879 --> 00:14:32,939
to have that event associated with it

419
00:14:31,529 --> 00:14:34,319
okay

420
00:14:32,939 --> 00:14:36,000
but we don't we don't see any additional

421
00:14:34,319 --> 00:14:37,860
context that might be interesting you

422
00:14:36,000 --> 00:14:39,540
may see that I have this command line

423
00:14:37,860 --> 00:14:41,399
field highlighted over here so that

424
00:14:39,540 --> 00:14:45,480
might kind of tip tip my hand at what

425
00:14:41,399 --> 00:14:47,399
what I'm looking for but as we kind of

426
00:14:45,480 --> 00:14:48,899
go through these and notice I'm doing it

427
00:14:47,399 --> 00:14:53,100
very manually right now kind of on

428
00:14:48,899 --> 00:14:55,050
purpose to demonstrate the point we run

429
00:14:53,100 --> 00:14:57,120
that and we have a different event that

430
00:14:55,050 --> 00:14:59,128
pops up for this specific logon session

431
00:14:57,120 --> 00:15:00,300
right that's a four six eight eight

432
00:14:59,129 --> 00:15:04,170
does anybody know two four six eight

433
00:15:00,300 --> 00:15:06,508
eight is yeah process was created is the

434
00:15:04,170 --> 00:15:09,269
name of it right so see if I see

435
00:15:06,509 --> 00:15:12,449
anything that might be worrisome to them

436
00:15:09,269 --> 00:15:15,389
if they were to come across this no yeah

437
00:15:12,449 --> 00:15:16,569
of course in that gray vs. no yeah so

438
00:15:15,389 --> 00:15:18,490
okay so

439
00:15:16,570 --> 00:15:19,840
I mean the the most obvious one I think

440
00:15:18,490 --> 00:15:21,610
is probably this powershell with an

441
00:15:19,840 --> 00:15:24,100
encoded command maybe what I would do is

442
00:15:21,610 --> 00:15:25,540
you know come down here I mean this is

443
00:15:24,100 --> 00:15:26,950
what it really looks like right so I

444
00:15:25,540 --> 00:15:29,110
don't know about you but I don't like to

445
00:15:26,950 --> 00:15:31,450
type that in myself typically when I'm

446
00:15:29,110 --> 00:15:32,920
answering systems but you could you

447
00:15:31,450 --> 00:15:34,720
could go and decode this and go see

448
00:15:32,920 --> 00:15:35,890
what's actually happening some other

449
00:15:34,720 --> 00:15:37,480
things that you might look at or like

450
00:15:35,890 --> 00:15:39,130
Who am I which is kind of something that

451
00:15:37,480 --> 00:15:40,480
an attacker might use for situational

452
00:15:39,130 --> 00:15:42,520
awareness to know what user they're

453
00:15:40,480 --> 00:15:45,040
operating as they're doing some sort of

454
00:15:42,520 --> 00:15:47,199
group enumeration domain group

455
00:15:45,040 --> 00:15:48,250
enumeration for domain computers and so

456
00:15:47,200 --> 00:15:49,780
that that's starting to look like

457
00:15:48,250 --> 00:15:52,060
something that's suspicious right and so

458
00:15:49,780 --> 00:15:53,650
then then we kind of like I only have

459
00:15:52,060 --> 00:15:54,930
you know twenty five minutes so we're

460
00:15:53,650 --> 00:15:56,829
not going to go through each one but

461
00:15:54,930 --> 00:15:58,630
basically we went through all sixteen

462
00:15:56,830 --> 00:16:00,340
and we said hey what context can we pull

463
00:15:58,630 --> 00:16:02,050
from all of these right and so they said

464
00:16:00,340 --> 00:16:03,580
hey that's that's really awesome like we

465
00:16:02,050 --> 00:16:05,469
were able to document our data

466
00:16:03,580 --> 00:16:07,120
understand the connections between these

467
00:16:05,470 --> 00:16:11,860
different data points and then we were

468
00:16:07,120 --> 00:16:14,050
able to start to like see at context the

469
00:16:11,860 --> 00:16:15,190
problem is is like we did that manually

470
00:16:14,050 --> 00:16:16,930
right and it was kind of a pain in the

471
00:16:15,190 --> 00:16:18,610
butt when we did it for sixteen but like

472
00:16:16,930 --> 00:16:20,859
in a real environment there may be

473
00:16:18,610 --> 00:16:22,990
thousands or hundreds of thousands right

474
00:16:20,860 --> 00:16:25,570
so I'm not going to do that kind of in a

475
00:16:22,990 --> 00:16:26,890
manual way right so what we end up

476
00:16:25,570 --> 00:16:31,150
having I'm going to go back to the

477
00:16:26,890 --> 00:16:33,520
slides and skip a few we end up having a

478
00:16:31,150 --> 00:16:35,560
situation like this where we end up

479
00:16:33,520 --> 00:16:36,730
seeing a user authenticated to a host

480
00:16:35,560 --> 00:16:39,640
we're building all these connections

481
00:16:36,730 --> 00:16:40,440
that host had a process that received

482
00:16:39,640 --> 00:16:43,330
that connection

483
00:16:40,440 --> 00:16:44,020
it ends up spine in a process called WMI

484
00:16:43,330 --> 00:16:45,790
prpsc

485
00:16:44,020 --> 00:16:48,550
then there's this logon session that's

486
00:16:45,790 --> 00:16:50,319
created and then a process and a

487
00:16:48,550 --> 00:16:52,329
nondescript process we don't care what

488
00:16:50,320 --> 00:16:53,890
that process is but we just care that

489
00:16:52,330 --> 00:16:56,230
there's a process that's associated with

490
00:16:53,890 --> 00:16:59,920
this type three logon session right and

491
00:16:56,230 --> 00:17:02,080
so again we have this 46 24 one thing

492
00:16:59,920 --> 00:17:04,599
that we really like to look at is this

493
00:17:02,080 --> 00:17:06,700
concept of a force is like a Windows

494
00:17:04,599 --> 00:17:09,040
Event log is really just a storytelling

495
00:17:06,700 --> 00:17:11,350
device right so really like I look at it

496
00:17:09,040 --> 00:17:13,420
as what can I get from this a lot of

497
00:17:11,349 --> 00:17:16,359
times we look at it as a unique entity

498
00:17:13,420 --> 00:17:17,980
like this is a 4624 but really there's

499
00:17:16,359 --> 00:17:19,629
there's quite a few different concepts

500
00:17:17,980 --> 00:17:23,349
that are really at play inside of the

501
00:17:19,630 --> 00:17:24,060
46:24 right so this is kind of what i

502
00:17:23,349 --> 00:17:27,030
end up look

503
00:17:24,060 --> 00:17:28,889
so 46:24 I created data model Ford and I

504
00:17:27,030 --> 00:17:31,770
kind of in my mind and so we have a

505
00:17:28,890 --> 00:17:34,050
source computer right that well in

506
00:17:31,770 --> 00:17:35,910
context of a type three logon event we

507
00:17:34,050 --> 00:17:37,830
have a source computer it authenticates

508
00:17:35,910 --> 00:17:39,540
to a target computer all right so that's

509
00:17:37,830 --> 00:17:42,120
what's happening that target computer

510
00:17:39,540 --> 00:17:43,710
creates a target logon session and then

511
00:17:42,120 --> 00:17:46,050
that target logon session is running as

512
00:17:43,710 --> 00:17:48,120
a target user so whatever user logged

513
00:17:46,050 --> 00:17:50,430
onto that that destination or target

514
00:17:48,120 --> 00:17:52,800
computer brings similarly we have a

515
00:17:50,430 --> 00:17:55,230
forty six eighty eight and that tells us

516
00:17:52,800 --> 00:17:56,580
a process process created a new process

517
00:17:55,230 --> 00:17:58,770
to think of this is like the parent

518
00:17:56,580 --> 00:18:00,780
process this is the child process or the

519
00:17:58,770 --> 00:18:03,000
process that was being created those

520
00:18:00,780 --> 00:18:05,580
processes are running on a computer we

521
00:18:03,000 --> 00:18:07,620
have a subject user who is the basically

522
00:18:05,580 --> 00:18:09,780
the parent the the user that was running

523
00:18:07,620 --> 00:18:12,629
as the the parent parent process and

524
00:18:09,780 --> 00:18:14,340
then we have that new process the child

525
00:18:12,630 --> 00:18:17,010
process it's associated with a target

526
00:18:14,340 --> 00:18:19,169
logon session and it's also running as a

527
00:18:17,010 --> 00:18:22,080
target user right so that's that's the

528
00:18:19,170 --> 00:18:25,410
context that this is telling us one

529
00:18:22,080 --> 00:18:27,060
thing one problem is the 46:24 let me go

530
00:18:25,410 --> 00:18:29,160
back up here that doesn't give me any

531
00:18:27,060 --> 00:18:30,480
context about what that logon session

532
00:18:29,160 --> 00:18:33,570
was doing right so like how do I

533
00:18:30,480 --> 00:18:37,140
differentiate using just a 46:24 how do

534
00:18:33,570 --> 00:18:38,939
I differentiate a it's somebody

535
00:18:37,140 --> 00:18:40,290
connecting to a network share from

536
00:18:38,940 --> 00:18:42,270
somebody that's running a PowerShell

537
00:18:40,290 --> 00:18:44,010
encoded command rights or like you know

538
00:18:42,270 --> 00:18:46,350
Who am I and doing a bunch of post

539
00:18:44,010 --> 00:18:48,990
exploitation type stuff the the other

540
00:18:46,350 --> 00:18:51,389
problem is for 4680 a that's just

541
00:18:48,990 --> 00:18:53,090
telling me the context of a process so

542
00:18:51,390 --> 00:18:57,540
how do i how do I actually like

543
00:18:53,090 --> 00:19:00,300
differentiate between two - like our

544
00:18:57,540 --> 00:19:02,820
process that was created as parts of a

545
00:19:00,300 --> 00:19:04,830
type 3 logon session right so this is

546
00:19:02,820 --> 00:19:06,870
where we were doing that manual process

547
00:19:04,830 --> 00:19:11,070
to go back and forth and copying copying

548
00:19:06,870 --> 00:19:12,959
that logon session ID right okay so yeah

549
00:19:11,070 --> 00:19:15,480
so again was this logon session created

550
00:19:12,960 --> 00:19:18,120
via Network logon well 46 88 doesn't

551
00:19:15,480 --> 00:19:19,410
have that context and and one of the

552
00:19:18,120 --> 00:19:21,389
things that we run into especially

553
00:19:19,410 --> 00:19:23,130
within like Cabana for example is Cabana

554
00:19:21,390 --> 00:19:25,200
is not super great at like relational

555
00:19:23,130 --> 00:19:27,030
it's a document data elasticsearch is a

556
00:19:25,200 --> 00:19:29,190
document database it's not real great at

557
00:19:27,030 --> 00:19:31,379
like building relationships and allowing

558
00:19:29,190 --> 00:19:33,870
us to query for those right so we're

559
00:19:31,380 --> 00:19:36,210
able to look at 46:24 we're able to look

560
00:19:33,870 --> 00:19:36,790
at 46 88 but it's relatively difficult

561
00:19:36,210 --> 00:19:38,410
to

562
00:19:36,790 --> 00:19:40,240
be able to look at both of those in the

563
00:19:38,410 --> 00:19:41,890
same context to try to build build

564
00:19:40,240 --> 00:19:44,290
relationships okay

565
00:19:41,890 --> 00:19:46,540
and so what we end up with is trying to

566
00:19:44,290 --> 00:19:47,860
build out this like greater model here

567
00:19:46,540 --> 00:19:49,510
where we have a source computer that

568
00:19:47,860 --> 00:19:51,219
authenticates to a target computer right

569
00:19:49,510 --> 00:19:54,520
so we'll just say there's an IP address

570
00:19:51,220 --> 00:19:57,160
called 1 9 2 1 6 8 1.5 it connects to a

571
00:19:54,520 --> 00:19:59,290
system called target dot local target

572
00:19:57,160 --> 00:20:01,090
all local it's connecting as domain /

573
00:19:59,290 --> 00:20:02,560
attacker so domain is just the domain

574
00:20:01,090 --> 00:20:04,480
name and attackers that the attacker

575
00:20:02,560 --> 00:20:06,780
named and there's a logon ID of 1

576
00:20:04,480 --> 00:20:09,700
through 37 and there's a logon type of

577
00:20:06,780 --> 00:20:11,379
of type 3 right and so that's that's

578
00:20:09,700 --> 00:20:13,990
kind of the extent of what I'm really

579
00:20:11,380 --> 00:20:15,760
Glen from a 46 24 bench right so we have

580
00:20:13,990 --> 00:20:17,710
a logon type 3 we have a logon ID we

581
00:20:15,760 --> 00:20:20,110
have the user we might have the system

582
00:20:17,710 --> 00:20:21,700
that they were being connected from but

583
00:20:20,110 --> 00:20:23,409
then we also kind of like on the second

584
00:20:21,700 --> 00:20:25,960
half of this this image we have 3

585
00:20:23,410 --> 00:20:27,760
processes that were created and those 3

586
00:20:25,960 --> 00:20:30,850
processes are getting information about

587
00:20:27,760 --> 00:20:33,990
them or contexts develop them from 46 88

588
00:20:30,850 --> 00:20:36,820
events and so for instance we have

589
00:20:33,990 --> 00:20:38,530
PowerShell dot exe Who am I and net dot

590
00:20:36,820 --> 00:20:41,710
exe which is what we just saw song

591
00:20:38,530 --> 00:20:43,270
Cubana and those are being created but

592
00:20:41,710 --> 00:20:47,980
they're also telling us hey these are

593
00:20:43,270 --> 00:20:50,170
part of the 1 1 3 3 7 logon session

594
00:20:47,980 --> 00:20:51,310
right so now I'm thinking okay well like

595
00:20:50,170 --> 00:20:53,020
this is what the student was really

596
00:20:51,310 --> 00:20:54,429
asking me it's like hey I did all this

597
00:20:53,020 --> 00:20:55,510
manual stuff it's really awesome it's

598
00:20:54,430 --> 00:20:57,130
kind of cool to be able to make those

599
00:20:55,510 --> 00:20:59,110
connections I learned about logon

600
00:20:57,130 --> 00:21:01,990
sessions and power and and processes

601
00:20:59,110 --> 00:21:04,000
kind of residing within a logon session

602
00:21:01,990 --> 00:21:05,950
but like how would I do this in

603
00:21:04,000 --> 00:21:07,990
production like it like in real life I

604
00:21:05,950 --> 00:21:09,550
can I can't just go one by one and check

605
00:21:07,990 --> 00:21:11,560
each one because that's that you know we

606
00:21:09,550 --> 00:21:13,750
don't have the manpower to do that and

607
00:21:11,560 --> 00:21:16,270
so really what they were asking is how

608
00:21:13,750 --> 00:21:20,220
do I add that context that logon type 3

609
00:21:16,270 --> 00:21:23,590
to these process events spring and so

610
00:21:20,220 --> 00:21:25,140
Roberto so what we're using here is as

611
00:21:23,590 --> 00:21:28,689
anybody familiar with the health project

612
00:21:25,140 --> 00:21:31,360
if so health is ELQ is elastic elastic

613
00:21:28,690 --> 00:21:34,630
search log stash and kimono help is

614
00:21:31,360 --> 00:21:36,850
basically a flavor of ELQ that's built

615
00:21:34,630 --> 00:21:39,490
for threat hunting might use cases and

616
00:21:36,850 --> 00:21:41,080
so one of the things that it has is an

617
00:21:39,490 --> 00:21:43,570
apache spark back end which is just

618
00:21:41,080 --> 00:21:45,669
allows for like distributed computing so

619
00:21:43,570 --> 00:21:47,889
you could run a query across a number of

620
00:21:45,670 --> 00:21:49,950
different notes and try to like increase

621
00:21:47,890 --> 00:21:51,540
your computational performance

622
00:21:49,950 --> 00:21:55,740
and it also has the ability to do

623
00:21:51,540 --> 00:21:58,470
jupiter notebooks and so oh boy that

624
00:21:55,740 --> 00:22:02,370
might not be good but we have the result

625
00:21:58,470 --> 00:22:04,170
okay so let me zoom in here okay so this

626
00:22:02,370 --> 00:22:07,229
is called jupiter notebook and this is

627
00:22:04,170 --> 00:22:08,790
just a way for us to like kind of save

628
00:22:07,230 --> 00:22:10,580
off different queries that we're making

629
00:22:08,790 --> 00:22:12,659
so we could we can make a series of

630
00:22:10,580 --> 00:22:14,760
queries and like kind of save that off

631
00:22:12,660 --> 00:22:17,100
so that it could be repeatable and that

632
00:22:14,760 --> 00:22:20,520
type of thing so there's this capability

633
00:22:17,100 --> 00:22:23,040
called pi PI spark and there's spark

634
00:22:20,520 --> 00:22:24,870
sequel that allows us to actually run

635
00:22:23,040 --> 00:22:27,990
sequel queries across the data that's in

636
00:22:24,870 --> 00:22:29,399
this elasticsearch database right so at

637
00:22:27,990 --> 00:22:31,410
the beginning what we're doing here is

638
00:22:29,400 --> 00:22:33,510
we're just kind of like setting up a

639
00:22:31,410 --> 00:22:35,400
spark session which allows us to like do

640
00:22:33,510 --> 00:22:38,179
that that distributed computational

641
00:22:35,400 --> 00:22:40,559
workload and then we're going to

642
00:22:38,179 --> 00:22:42,240
basically reach out to our elastic

643
00:22:40,559 --> 00:22:44,520
search right here right and we're

644
00:22:42,240 --> 00:22:47,669
basically trying to connect connect to

645
00:22:44,520 --> 00:22:50,370
it right from there we have this this

646
00:22:47,669 --> 00:22:52,110
index of the logs endpoint windows win

647
00:22:50,370 --> 00:22:54,090
event security index which is where our

648
00:22:52,110 --> 00:22:55,979
security event logs are stored in Cabana

649
00:22:54,090 --> 00:22:59,730
let me just kind of show what that looks

650
00:22:55,980 --> 00:23:01,110
like here so in Cabana you have a bunch

651
00:22:59,730 --> 00:23:03,000
of different indices for instance we

652
00:23:01,110 --> 00:23:05,040
have a system on index we have a Windows

653
00:23:03,000 --> 00:23:07,380
security event index we have a

654
00:23:05,040 --> 00:23:10,470
PowerShell event logs index system

655
00:23:07,380 --> 00:23:13,220
system index so on and so forth you

656
00:23:10,470 --> 00:23:16,290
could have like a network like a bro

657
00:23:13,220 --> 00:23:18,809
index so on and so forth okay so we're

658
00:23:16,290 --> 00:23:21,090
really only interested in this Windows

659
00:23:18,809 --> 00:23:23,280
security events so then what we end up

660
00:23:21,090 --> 00:23:25,918
having to do is kind of like basically a

661
00:23:23,280 --> 00:23:27,389
spark to pull from that index the the

662
00:23:25,919 --> 00:23:30,929
events or the data that we're interested

663
00:23:27,390 --> 00:23:32,880
in right so we basically are saying hey

664
00:23:30,929 --> 00:23:34,169
we want to select and so anybody

665
00:23:32,880 --> 00:23:35,429
familiar with sequel should be somewhat

666
00:23:34,169 --> 00:23:37,500
familiar with this but we want these

667
00:23:35,429 --> 00:23:41,790
properties so even ID host name source

668
00:23:37,500 --> 00:23:43,919
IP address user logon ID user name logon

669
00:23:41,790 --> 00:23:46,740
type and timestamp from security events

670
00:23:43,919 --> 00:23:48,960
right which is basically that all the

671
00:23:46,740 --> 00:23:52,559
events that we pulled out where the

672
00:23:48,960 --> 00:23:55,140
event ID is 46 24 so our logon event the

673
00:23:52,559 --> 00:23:57,210
logon type is 3 so a network logon the

674
00:23:55,140 --> 00:23:58,620
source IP address is not null so we want

675
00:23:57,210 --> 00:24:00,360
to we want to be able to tell where that

676
00:23:58,620 --> 00:24:02,189
event was coming from and then we just

677
00:24:00,360 --> 00:24:03,399
have a timestamp to to narrow in on

678
00:24:02,190 --> 00:24:06,159
specific data for

679
00:24:03,399 --> 00:24:08,289
for the for the use case here okay so we

680
00:24:06,159 --> 00:24:10,960
run that and that ends up giving us back

681
00:24:08,289 --> 00:24:13,089
all those events right and then we then

682
00:24:10,960 --> 00:24:15,489
we basically do the same thing for 46 88

683
00:24:13,089 --> 00:24:17,139
we're interested in host name parent

684
00:24:15,489 --> 00:24:19,119
process name parent process command line

685
00:24:17,139 --> 00:24:21,039
process name process command line user

686
00:24:19,119 --> 00:24:25,178
name user logon ID so on and so forth

687
00:24:21,039 --> 00:24:27,399
where it's 46 88 here okay then we store

688
00:24:25,179 --> 00:24:29,649
those kind of in a variable here and now

689
00:24:27,399 --> 00:24:32,049
what we do is we actually do a join like

690
00:24:29,649 --> 00:24:34,959
a sequel join across this these events

691
00:24:32,049 --> 00:24:37,029
and we end up with user logon ID

692
00:24:34,960 --> 00:24:39,909
basically where the user logon ID from

693
00:24:37,029 --> 00:24:43,509
4624 is equal to the user logon ID from

694
00:24:39,909 --> 00:24:47,229
46 88 and just to kind of show it's not

695
00:24:43,509 --> 00:24:49,119
an instantaneous process here but this

696
00:24:47,229 --> 00:24:51,099
goes this goes forward and it's actually

697
00:24:49,119 --> 00:24:58,629
kind of like running running our query

698
00:24:51,099 --> 00:25:07,449
on the backend okay maybe I might have

699
00:24:58,629 --> 00:25:08,678
just messed everything before I did that

700
00:25:07,450 --> 00:25:12,450
did everybody see it there was output

701
00:25:08,679 --> 00:25:16,839
there okay good okay

702
00:25:12,450 --> 00:25:19,299
all right let's see if this okay that's

703
00:25:16,839 --> 00:25:21,719
a good sign so this will show how long

704
00:25:19,299 --> 00:25:24,369
it actually takes just so that there's

705
00:25:21,719 --> 00:25:25,509
okay so this is the part the part that

706
00:25:24,369 --> 00:25:31,359
takes a little while for this doing that

707
00:25:25,509 --> 00:25:33,369
kind of like correlation there and

708
00:25:31,359 --> 00:25:36,309
basically what we're trying to output is

709
00:25:33,369 --> 00:25:39,279
just show me every 46 an 88 event that

710
00:25:36,309 --> 00:25:41,168
is spawned from a logon type 3 is that

711
00:25:39,279 --> 00:25:44,830
that's the general idea right because we

712
00:25:41,169 --> 00:25:47,559
want to see that now there when when

713
00:25:44,830 --> 00:25:50,019
we're going through this process 846 88

714
00:25:47,559 --> 00:25:51,759
event is not necessarily that spawn from

715
00:25:50,019 --> 00:25:53,799
a logon type 3 is not necessarily bad

716
00:25:51,759 --> 00:25:56,440
right so like a situation I could think

717
00:25:53,799 --> 00:25:59,320
of as maybe you have you use Altiris or

718
00:25:56,440 --> 00:26:00,549
some sort of other you know like system

719
00:25:59,320 --> 00:26:02,049
management type tool or like

720
00:26:00,549 --> 00:26:04,029
vulnerability assessment type tool and

721
00:26:02,049 --> 00:26:06,219
it's it's going out and running these

722
00:26:04,029 --> 00:26:08,139
remote commands on systems that's going

723
00:26:06,219 --> 00:26:10,299
to be you know benign in this use case

724
00:26:08,139 --> 00:26:11,678
or a false positive and so so you would

725
00:26:10,299 --> 00:26:13,120
have to kind of like go through and

726
00:26:11,679 --> 00:26:14,320
figure that out but what we

727
00:26:13,120 --> 00:26:17,199
obscene and this is from a different

728
00:26:14,320 --> 00:26:20,110
data set here but we see that this P

729
00:26:17,200 --> 00:26:22,840
Gustavo user ended up spawning net dot

730
00:26:20,110 --> 00:26:26,139
exe right or from net dot exe they spawn

731
00:26:22,840 --> 00:26:28,330
con host and then they use net Med 1 dot

732
00:26:26,140 --> 00:26:31,630
exe right so and then added a user

733
00:26:28,330 --> 00:26:34,360
called backdoor with a password of PA w0

734
00:26:31,630 --> 00:26:37,510
r d1 right so the funny thing is is this

735
00:26:34,360 --> 00:26:40,659
is from the mordoor project and the

736
00:26:37,510 --> 00:26:43,210
Mordo project is based on Roberta's dog

737
00:26:40,660 --> 00:26:46,179
name is Pedro P Gustavo spot Pedro and

738
00:26:43,210 --> 00:26:48,790
so Paul Paul is his dog's paw anyway so

739
00:26:46,179 --> 00:26:50,140
that's that's generally the idea of how

740
00:26:48,790 --> 00:26:51,610
we would go about doing this in an

741
00:26:50,140 --> 00:26:52,900
automated fashion to be able to build

742
00:26:51,610 --> 00:26:54,520
those correlations based on

743
00:26:52,900 --> 00:26:57,550
understanding our data in the first

744
00:26:54,520 --> 00:26:58,540
place cool that's all I have if anybody

745
00:26:57,550 --> 00:27:02,040
has any questions I'll be outside

746
00:26:58,540 --> 00:27:02,040
afterwards too to chat about

