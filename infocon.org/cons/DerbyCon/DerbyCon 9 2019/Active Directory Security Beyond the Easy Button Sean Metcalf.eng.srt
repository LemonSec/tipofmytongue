1
00:00:00,000 --> 00:00:05,509
good morning derbycon as everyone is

2
00:00:02,129 --> 00:00:10,400
excited to be here as well everyone

3
00:00:05,509 --> 00:00:10,400
welcome to my talk I'm Sean Metcalfe and

4
00:00:23,300 --> 00:00:27,770
[Laughter]

5
00:00:29,779 --> 00:00:37,170
welcome to the reflection talk I've met

6
00:00:35,520 --> 00:00:39,770
some amazing people at Derby con I hope

7
00:00:37,170 --> 00:00:39,770
you have as well

8
00:00:54,050 --> 00:00:57,610
literally 3:00 a.m. this morning

9
00:01:25,080 --> 00:01:31,360
okay so let's get start it sorry I had

10
00:01:28,510 --> 00:01:33,760
to do that had to reflect on what dirty

11
00:01:31,360 --> 00:01:35,320
con has been for me one of my favorite

12
00:01:33,760 --> 00:01:38,050
Derby con memories was being on a stage

13
00:01:35,320 --> 00:01:41,110
much like this so many people wanted to

14
00:01:38,050 --> 00:01:43,060
be here for a talk Dave started lining

15
00:01:41,110 --> 00:01:45,820
people up front on the floor I felt very

16
00:01:43,060 --> 00:01:48,900
much like story time one of my first

17
00:01:45,820 --> 00:01:55,990
ever con talks was here at Derby con

18
00:01:48,900 --> 00:01:57,790
Derby con 2015 Derby con 5 and I have

19
00:01:55,990 --> 00:01:59,979
spoken every year that I've been at

20
00:01:57,790 --> 00:02:01,750
Derby con I am I am very blessed to have

21
00:01:59,980 --> 00:02:06,460
been able to do that and I thank you all

22
00:02:01,750 --> 00:02:08,979
for being here to support me for that so

23
00:02:06,460 --> 00:02:10,899
I'm Sean Metcalfe back to the normal

24
00:02:08,979 --> 00:02:12,970
format of this talk and the founder of

25
00:02:10,899 --> 00:02:15,160
Trimark we help organizations better

26
00:02:12,970 --> 00:02:17,230
secure their Microsoft platform on Prem

27
00:02:15,160 --> 00:02:20,799
and in the cloud Microsoft Certified

28
00:02:17,230 --> 00:02:23,320
Master in Active Directory back to being

29
00:02:20,800 --> 00:02:24,970
an MVP spoken number of conferences like

30
00:02:23,320 --> 00:02:27,640
I said I love Derby con I love the feel

31
00:02:24,970 --> 00:02:29,230
of Derby con I love the people I love

32
00:02:27,640 --> 00:02:30,850
hanging out with people at Derby con

33
00:02:29,230 --> 00:02:34,720
that's why I lobby kind as much as

34
00:02:30,850 --> 00:02:37,570
possible so we're going to talk about

35
00:02:34,720 --> 00:02:39,100
the top 15 most comments 80 security

36
00:02:37,570 --> 00:02:41,140
issues that we see a try marketing we do

37
00:02:39,100 --> 00:02:42,370
80 security assessments we're gonna talk

38
00:02:41,140 --> 00:02:45,670
about how to detect Active Directory

39
00:02:42,370 --> 00:02:48,280
recon as well as how to break it and how

40
00:02:45,670 --> 00:02:49,958
to ultimately secure and harden a number

41
00:02:48,280 --> 00:02:51,850
of critical components of Active

42
00:02:49,959 --> 00:02:58,030
Directory and then some wrap-up of

43
00:02:51,850 --> 00:03:02,260
recommendations can Active Directory be

44
00:02:58,030 --> 00:03:04,510
secured I hear this a lot absolutely one

45
00:03:02,260 --> 00:03:06,130
of active directory's greatest strengths

46
00:03:04,510 --> 00:03:08,649
is also one of its greatest weaknesses

47
00:03:06,130 --> 00:03:10,090
the fact that Active Directory is one of

48
00:03:08,650 --> 00:03:12,550
the best products that Microsoft has

49
00:03:10,090 --> 00:03:13,840
ever developed means that oftentimes

50
00:03:12,550 --> 00:03:16,260
they're very few people to actually

51
00:03:13,840 --> 00:03:18,430
manage it because it just kind of works

52
00:03:16,260 --> 00:03:20,649
unlike a lot of other products which you

53
00:03:18,430 --> 00:03:23,800
need typical care and feeding overtime

54
00:03:20,650 --> 00:03:29,980
ad you just kind of throw a bunch of DCs

55
00:03:23,800 --> 00:03:32,590
at it and it just works so let's talk

56
00:03:29,980 --> 00:03:35,290
about my top 15 most common 80 security

57
00:03:32,590 --> 00:03:36,550
issues there's a lot of different

58
00:03:35,290 --> 00:03:38,590
avenues to compromise in Active

59
00:03:36,550 --> 00:03:40,060
Directory which makes it challenging

60
00:03:38,590 --> 00:03:41,650
makes it difficult for a lot of people

61
00:03:40,060 --> 00:03:44,110
because the people that are managing and

62
00:03:41,650 --> 00:03:47,019
administering Active Directory often are

63
00:03:44,110 --> 00:03:48,730
the ones that would need to lock it down

64
00:03:47,019 --> 00:03:51,489
or protect it but they're busy fighting

65
00:03:48,730 --> 00:03:54,879
fires they're busy keeping things up and

66
00:03:51,489 --> 00:03:57,790
working and many many times people don't

67
00:03:54,879 --> 00:04:00,399
know what they don't know because

68
00:03:57,790 --> 00:04:02,440
ultimately in most environments it's not

69
00:04:00,400 --> 00:04:03,840
just about domain admins there were a

70
00:04:02,440 --> 00:04:05,739
lot of other groups that have rights

71
00:04:03,840 --> 00:04:07,900
most environments will have a

72
00:04:05,739 --> 00:04:09,280
workstation admins group have a server

73
00:04:07,900 --> 00:04:11,250
admins group and those groups are

74
00:04:09,280 --> 00:04:15,040
delegated and have access to everything

75
00:04:11,250 --> 00:04:18,970
and we've seen where there's weak

76
00:04:15,040 --> 00:04:20,349
password policies ten characters well

77
00:04:18,970 --> 00:04:23,470
that's better than the ad default of

78
00:04:20,350 --> 00:04:24,760
seven but not by a whole lot we've seen

79
00:04:23,470 --> 00:04:27,370
environments where actually there's a

80
00:04:24,760 --> 00:04:29,380
root domain in the forest and then the

81
00:04:27,370 --> 00:04:30,490
child domain where all the users are but

82
00:04:29,380 --> 00:04:32,710
all the admins are in the root domain

83
00:04:30,490 --> 00:04:35,110
and the password policy for the root

84
00:04:32,710 --> 00:04:40,359
domain is six or seven characters and in

85
00:04:35,110 --> 00:04:41,470
the in the child domain it's eight so we

86
00:04:40,360 --> 00:04:44,800
definitely want to make sure that our

87
00:04:41,470 --> 00:04:47,500
password policy makes sense I feel like

88
00:04:44,800 --> 00:04:49,800
if you make the password policy require

89
00:04:47,500 --> 00:04:52,150
longer passwords we can actually

90
00:04:49,800 --> 00:04:53,919
configure the policy so the users can

91
00:04:52,150 --> 00:04:55,570
have their passwords longer and things

92
00:04:53,919 --> 00:04:57,669
like as your ad password protection

93
00:04:55,570 --> 00:05:00,099
which is a password filter on the D on

94
00:04:57,669 --> 00:05:02,229
the dcs which can prevent users from

95
00:05:00,099 --> 00:05:04,870
actually using bad passwords like I

96
00:05:02,229 --> 00:05:06,159
don't know password there's also a

97
00:05:04,870 --> 00:05:08,950
couple ways that you can do some

98
00:05:06,160 --> 00:05:10,120
auditing of this Mike graph endure and I

99
00:05:08,950 --> 00:05:12,700
know that I'm saying his name wrong and

100
00:05:10,120 --> 00:05:15,820
I apologize Michael but he wrote a tool

101
00:05:12,700 --> 00:05:18,700
you can check out in deus internals com

102
00:05:15,820 --> 00:05:20,560
which is a PowerShell tool and he also

103
00:05:18,700 --> 00:05:21,849
wrote a tool for a psychotic which is

104
00:05:20,560 --> 00:05:23,710
based off of the same sort of

105
00:05:21,849 --> 00:05:26,770
information where you can audit your

106
00:05:23,710 --> 00:05:28,239
passwords and it checks against some

107
00:05:26,770 --> 00:05:31,979
common word lists and some other issue

108
00:05:28,240 --> 00:05:31,979
potential issues with those passwords

109
00:05:32,760 --> 00:05:39,700
this is a big one often stand-up ad it

110
00:05:37,870 --> 00:05:41,860
builds out these default policies and

111
00:05:39,700 --> 00:05:43,930
you go about your business do what you

112
00:05:41,860 --> 00:05:47,500
need to do and these policies don't

113
00:05:43,930 --> 00:05:49,330
change well kind of they do sometimes a

114
00:05:47,500 --> 00:05:52,450
product that gets installed will change

115
00:05:49,330 --> 00:05:56,380
these policies on you or someone like

116
00:05:52,450 --> 00:05:59,349
changed them 15 years ago and Bob hasn't

117
00:05:56,380 --> 00:06:00,550
have been around for like 12 years no

118
00:05:59,350 --> 00:06:04,180
one's seen him but that's okay

119
00:06:00,550 --> 00:06:06,850
I'm sure Bob's alright reminds me of a

120
00:06:04,180 --> 00:06:08,110
comedian who told a joke and he said you

121
00:06:06,850 --> 00:06:09,580
ever go in a restaurant you're sitting

122
00:06:08,110 --> 00:06:10,720
there and you're waiting you put your

123
00:06:09,580 --> 00:06:13,240
name on the less you're listening to

124
00:06:10,720 --> 00:06:16,390
everyone and they're like Johnson party

125
00:06:13,240 --> 00:06:19,510
of four Johnson party of four and no one

126
00:06:16,390 --> 00:06:22,270
gets up right he's like what happened to

127
00:06:19,510 --> 00:06:26,020
the Johnson party of four where are they

128
00:06:22,270 --> 00:06:28,150
there's nobody care where they are wow

129
00:06:26,020 --> 00:06:34,960
it is morning it's gotta be Sunday Mario

130
00:06:28,150 --> 00:06:37,390
very god this is another big issue

131
00:06:34,960 --> 00:06:40,780
domain controllers with minimal event on

132
00:06:37,390 --> 00:06:43,840
a configured with the standard auditing

133
00:06:40,780 --> 00:06:46,710
alerts or events and oftentimes the sim

134
00:06:43,840 --> 00:06:53,229
vendors have put these out back in say

135
00:06:46,710 --> 00:06:56,739
2015-2017 2019 sorry 2010 2009 2008 2011

136
00:06:53,230 --> 00:06:58,390
and the advice or the documentation from

137
00:06:56,740 --> 00:07:01,240
the sim vendor when you spun up your sim

138
00:06:58,390 --> 00:07:03,760
may not include the more advanced or the

139
00:07:01,240 --> 00:07:05,710
newer advanced auditing policies and and

140
00:07:03,760 --> 00:07:07,240
events that you get with that or you've

141
00:07:05,710 --> 00:07:10,630
added them and you didn't set this

142
00:07:07,240 --> 00:07:12,040
setting which means that well your

143
00:07:10,630 --> 00:07:14,110
domain controllers may actually just be

144
00:07:12,040 --> 00:07:17,350
having just be auditing these standard

145
00:07:14,110 --> 00:07:19,360
events so there's a command at the

146
00:07:17,350 --> 00:07:22,390
bottom of this slide audit Paul which

147
00:07:19,360 --> 00:07:26,410
allow you to pull and get your complete

148
00:07:22,390 --> 00:07:28,719
auditing config account operators is

149
00:07:26,410 --> 00:07:30,610
from NT 4 it should not be used anymore

150
00:07:28,720 --> 00:07:32,380
do not use that for delegation please

151
00:07:30,610 --> 00:07:35,170
remove it it effectively has backdoor

152
00:07:32,380 --> 00:07:41,710
access to a lot of objects in the in the

153
00:07:35,170 --> 00:07:43,480
environment 80 users and groups and by

154
00:07:41,710 --> 00:07:46,239
the way Microsoft even says do not use

155
00:07:43,480 --> 00:07:48,010
this group so please check to make sure

156
00:07:46,240 --> 00:07:49,510
that you're not using account operators

157
00:07:48,010 --> 00:07:54,070
there's no one in it if there is remove

158
00:07:49,510 --> 00:07:56,740
them it's amazing how often this is what

159
00:07:54,070 --> 00:07:57,820
we find 80 admin accounts these are

160
00:07:56,740 --> 00:08:01,510
accounts and domain admins

161
00:07:57,820 --> 00:08:04,810
administrators schema admins Enterprise

162
00:08:01,510 --> 00:08:07,260
admins and the passwords are insanely

163
00:08:04,810 --> 00:08:07,260
old

164
00:08:09,280 --> 00:08:15,020
14.5 years for the default domain

165
00:08:12,410 --> 00:08:16,970
administrator account that may not have

166
00:08:15,020 --> 00:08:18,950
changed or only changed once since the

167
00:08:16,970 --> 00:08:22,280
entire Active Directory environment has

168
00:08:18,950 --> 00:08:24,110
been around I don't know about you but

169
00:08:22,280 --> 00:08:29,419
my passwords from 10 years ago they were

170
00:08:24,110 --> 00:08:32,360
awful I guess they're better now default

171
00:08:29,419 --> 00:08:34,059
domain administrator accounts spin so

172
00:08:32,360 --> 00:08:39,650
we've heard of Kerberos thing I'm sure

173
00:08:34,059 --> 00:08:43,189
this is a way to gather the spins or I'm

174
00:08:39,650 --> 00:08:46,279
sorry look up a spin for an account pull

175
00:08:43,190 --> 00:08:48,320
a service ticket for Kerberos and then

176
00:08:46,279 --> 00:08:50,570
take that offline and crack it as long

177
00:08:48,320 --> 00:08:53,150
as it's in as long as in a format that

178
00:08:50,570 --> 00:08:54,680
we can do that with but this is bad

179
00:08:53,150 --> 00:08:56,720
because this means that someone was

180
00:08:54,680 --> 00:08:59,180
running sequel with this account I'm

181
00:08:56,720 --> 00:09:00,410
still amazed how often we find this but

182
00:08:59,180 --> 00:09:03,589
it's also really bad when you have a

183
00:09:00,410 --> 00:09:06,110
regular user account it's a person

184
00:09:03,589 --> 00:09:08,450
account and they are a member of say

185
00:09:06,110 --> 00:09:10,730
domain admins and they have a service

186
00:09:08,450 --> 00:09:12,350
principal name that's like what was

187
00:09:10,730 --> 00:09:14,240
thron doing well he set up a sequel

188
00:09:12,350 --> 00:09:15,410
server all right well what is he doing

189
00:09:14,240 --> 00:09:17,420
at that sequel server and why is he

190
00:09:15,410 --> 00:09:22,540
using his own account as as the service

191
00:09:17,420 --> 00:09:22,540
account Ron kind of does his own thing

192
00:09:25,720 --> 00:09:32,380
yes Danny said don't be throwing oh

193
00:09:28,570 --> 00:09:39,050
sorry the guy behind what's your name

194
00:09:32,380 --> 00:09:39,910
okay thank you throng so is Andrew in

195
00:09:39,050 --> 00:09:43,339
here

196
00:09:39,910 --> 00:09:51,459
Andrew Andrew Schwartz calling you out

197
00:09:43,339 --> 00:09:51,459
where are you Andrew come up here

198
00:09:53,230 --> 00:09:56,379
Andrew didn't believe I was gonna call

199
00:09:55,190 --> 00:10:00,290
him out on stage today

200
00:09:56,379 --> 00:10:02,449
don't be Andrew so service counts in

201
00:10:00,290 --> 00:10:03,800
domain admins this is a big problem what

202
00:10:02,449 --> 00:10:05,540
we want to do is we want to get these

203
00:10:03,800 --> 00:10:07,819
out of domain admins as much as we can

204
00:10:05,540 --> 00:10:09,759
domain admins have way too many rights

205
00:10:07,819 --> 00:10:13,939
full admin rights on every workstation

206
00:10:09,759 --> 00:10:18,439
server domain controller 8e itself way

207
00:10:13,939 --> 00:10:20,660
too many rights you don't need accounts

208
00:10:18,439 --> 00:10:22,610
and in domain admins to do the things

209
00:10:20,660 --> 00:10:23,870
that they need to do you can delegate

210
00:10:22,610 --> 00:10:25,220
these appropriate rights if you have a

211
00:10:23,870 --> 00:10:26,779
vulnerability scanning account please

212
00:10:25,220 --> 00:10:28,850
don't put it in the main admins that is

213
00:10:26,779 --> 00:10:31,879
an awful awful idea regardless of what

214
00:10:28,850 --> 00:10:35,060
your vendor says have one service count

215
00:10:31,879 --> 00:10:36,500
four workstations one four servers and

216
00:10:35,060 --> 00:10:38,959
one for the main controllers and if you

217
00:10:36,500 --> 00:10:40,310
can't do that at least have a separate

218
00:10:38,959 --> 00:10:42,050
one for domain admins which gets

219
00:10:40,310 --> 00:10:43,910
disabled when you're not scanning stuff

220
00:10:42,050 --> 00:10:46,040
one of the things that really concerns

221
00:10:43,910 --> 00:10:49,310
me is when you have a scanning system or

222
00:10:46,040 --> 00:10:51,079
vulnerability scanning product and you

223
00:10:49,310 --> 00:10:53,149
load in these very highly privileged in

224
00:10:51,079 --> 00:10:55,819
these privileges into these into these

225
00:10:53,149 --> 00:10:57,529
systems of course we all know that

226
00:10:55,819 --> 00:11:00,740
security software is very securely

227
00:10:57,529 --> 00:11:02,660
developed and written right how about

228
00:11:00,740 --> 00:11:05,750
server GPOs linked to domain controllers

229
00:11:02,660 --> 00:11:09,019
this is not a great idea why because

230
00:11:05,750 --> 00:11:11,569
these settings that are in that group

231
00:11:09,019 --> 00:11:13,790
policy it applies to servers also apply

232
00:11:11,569 --> 00:11:15,439
to domain controllers and when the ends

233
00:11:13,790 --> 00:11:18,769
up happening is you have unintended

234
00:11:15,439 --> 00:11:20,420
consequences please split that out you

235
00:11:18,769 --> 00:11:22,670
don't want someone to be able to modify

236
00:11:20,420 --> 00:11:24,649
that GPO that shouldn't shouldn't

237
00:11:22,670 --> 00:11:25,969
they're not a domain admin and you don't

238
00:11:24,649 --> 00:11:27,439
want some weird thing to happen like

239
00:11:25,970 --> 00:11:28,699
adding server admins to your

240
00:11:27,439 --> 00:11:30,349
administrators group for Active

241
00:11:28,699 --> 00:11:33,079
Directory because what ends up happening

242
00:11:30,350 --> 00:11:36,199
is the server admins group owns ad now

243
00:11:33,079 --> 00:11:38,388
as well as some servers so we want to

244
00:11:36,199 --> 00:11:41,449
make sure that we limit the use of this

245
00:11:38,389 --> 00:11:44,149
or at least not do it at all and like I

246
00:11:41,449 --> 00:11:47,149
said if you have the modify rights to a

247
00:11:44,149 --> 00:11:50,300
GPO link to the domain level or the DC

248
00:11:47,149 --> 00:11:53,300
level that means this person here Nick

249
00:11:50,300 --> 00:11:56,029
Fury has the ability to install a run

250
00:11:53,300 --> 00:11:58,969
code on DC's or reduce the level of

251
00:11:56,029 --> 00:12:00,910
security or update group membership in

252
00:11:58,970 --> 00:12:04,370
Active Directory

253
00:12:00,910 --> 00:12:05,930
maybe you trust Nick

254
00:12:04,370 --> 00:12:09,199
we want to make sure only our eighty

255
00:12:05,930 --> 00:12:10,939
admins can do that and then there's a

256
00:12:09,199 --> 00:12:12,979
big problem with user rights assignments

257
00:12:10,939 --> 00:12:15,529
in group policy which are rarely ever

258
00:12:12,980 --> 00:12:18,259
looked at there's a lot of accounts in

259
00:12:15,529 --> 00:12:20,449
AD that get delegated rights so through

260
00:12:18,259 --> 00:12:23,720
group membership delegated permission

261
00:12:20,449 --> 00:12:25,819
group policy delegation and user rights

262
00:12:23,720 --> 00:12:28,999
assignment so these two are bad right

263
00:12:25,819 --> 00:12:30,920
server two or three especially if

264
00:12:28,999 --> 00:12:32,300
they're not domain admins but the what's

265
00:12:30,920 --> 00:12:34,790
next to it is even worse

266
00:12:32,300 --> 00:12:36,829
why would domain users ever need to log

267
00:12:34,790 --> 00:12:42,160
on to a domain controller trust me they

268
00:12:36,829 --> 00:12:45,138
don't the other thing is when you have

269
00:12:42,160 --> 00:12:47,629
delegation at the domain level that ends

270
00:12:45,139 --> 00:12:49,249
up in a configuring situation where say

271
00:12:47,629 --> 00:12:52,459
all your computers in your domain have

272
00:12:49,249 --> 00:12:55,430
full control on objects that's a bad

273
00:12:52,459 --> 00:12:56,930
idea or server admins have the ability

274
00:12:55,430 --> 00:13:00,709
to modify all computers in the entire

275
00:12:56,930 --> 00:13:02,329
domain through their permissions and

276
00:13:00,709 --> 00:13:05,300
then there's this thing called admin st

277
00:13:02,329 --> 00:13:07,040
holder which applies permissions on the

278
00:13:05,300 --> 00:13:08,469
most privileged for highly privileged

279
00:13:07,040 --> 00:13:10,910
accounts and groups in Active Directory

280
00:13:08,470 --> 00:13:14,870
so domain admins administrators

281
00:13:10,910 --> 00:13:16,850
enterprise admin schema admins etc do

282
00:13:14,870 --> 00:13:18,350
not do delegation at the admin st holder

283
00:13:16,850 --> 00:13:19,999
unless you were very careful and you

284
00:13:18,350 --> 00:13:21,829
know exactly what your goal is and what

285
00:13:19,999 --> 00:13:23,449
the results going to be because once you

286
00:13:21,829 --> 00:13:27,429
set the permissions he or sixty minutes

287
00:13:23,449 --> 00:13:30,649
later it's going to apply to your admins

288
00:13:27,429 --> 00:13:33,259
and so there's a few links here on how

289
00:13:30,649 --> 00:13:35,269
to review your ad permissions PowerShell

290
00:13:33,259 --> 00:13:36,949
script there's an AC lite batch file

291
00:13:35,269 --> 00:13:38,600
that calls PowerShell it's using the

292
00:13:36,949 --> 00:13:45,439
same function basically as bloodhound

293
00:13:38,600 --> 00:13:47,660
and as I talked about last year we need

294
00:13:45,439 --> 00:13:49,370
to get away from our eighty admins using

295
00:13:47,660 --> 00:13:51,319
regular workstations for administration

296
00:13:49,370 --> 00:13:53,809
we've got to stop doing this it's too

297
00:13:51,319 --> 00:13:55,300
dangerous because one workstation has 30

298
00:13:53,809 --> 00:13:57,679
counts of the local administrators group

299
00:13:55,300 --> 00:14:00,498
50 accounts with local admin via

300
00:13:57,679 --> 00:14:02,029
software that's managing that 20

301
00:14:00,499 --> 00:14:04,249
accounts with control of the computer

302
00:14:02,029 --> 00:14:06,230
via security agents that can install and

303
00:14:04,249 --> 00:14:07,910
run code so there's about a hundred

304
00:14:06,230 --> 00:14:11,660
accounts that ends up with effective

305
00:14:07,910 --> 00:14:14,569
rights on workstations not that is is

306
00:14:11,660 --> 00:14:16,730
not uncommon we see this a lot and then

307
00:14:14,569 --> 00:14:18,589
how many GPO is apply these workstations

308
00:14:16,730 --> 00:14:21,980
how many accounts have modify rights to

309
00:14:18,590 --> 00:14:25,490
those GPOs ultimately who has control

310
00:14:21,980 --> 00:14:28,820
those workstations this is a very clear

311
00:14:25,490 --> 00:14:31,460
path to compromise of your Active

312
00:14:28,820 --> 00:14:32,900
Directory environment and then Kerberos

313
00:14:31,460 --> 00:14:35,420
delegation is a weird thing

314
00:14:32,900 --> 00:14:37,520
it's basically impersonation and there's

315
00:14:35,420 --> 00:14:39,260
been a number of talks certainly this

316
00:14:37,520 --> 00:14:40,610
weekend and in the past about Kerberos

317
00:14:39,260 --> 00:14:42,439
delegation which I'm glad to see that

318
00:14:40,610 --> 00:14:43,280
the highlight of delegation is

319
00:14:42,440 --> 00:14:46,670
impersonation

320
00:14:43,280 --> 00:14:49,189
it's a trusted way to say this account

321
00:14:46,670 --> 00:14:52,490
has the ability to impersonate users and

322
00:14:49,190 --> 00:14:53,930
watch what they can do but I just want

323
00:14:52,490 --> 00:14:55,580
to talk about unconstrained for a minute

324
00:14:53,930 --> 00:14:57,770
unconstrained was came out Mac active

325
00:14:55,580 --> 00:14:59,360
directory and we need to switch that

326
00:14:57,770 --> 00:15:02,420
over to constrain because unconstraint

327
00:14:59,360 --> 00:15:04,010
has access to everything it's tough to

328
00:15:02,420 --> 00:15:07,010
go from unconstrained to constrain

329
00:15:04,010 --> 00:15:09,140
because you need to know what the

330
00:15:07,010 --> 00:15:11,780
services are that it needs to be able to

331
00:15:09,140 --> 00:15:13,130
impersonate and connect to and if you're

332
00:15:11,780 --> 00:15:14,540
going to if you have delegation in your

333
00:15:13,130 --> 00:15:16,240
environment make sure all your admin

334
00:15:14,540 --> 00:15:18,560
accounts have this box checked if

335
00:15:16,240 --> 00:15:20,120
they're unable to manage sharepoint or

336
00:15:18,560 --> 00:15:23,300
something like that then uncheck the box

337
00:15:20,120 --> 00:15:25,670
for those accounts also add your Active

338
00:15:23,300 --> 00:15:28,400
Directory admin accounts to protected

339
00:15:25,670 --> 00:15:30,079
users the other thing I talked about

340
00:15:28,400 --> 00:15:35,360
last year was cross force administration

341
00:15:30,080 --> 00:15:39,200
so force B trusts users enforced a this

342
00:15:35,360 --> 00:15:42,530
domain admin account enforced a has to

343
00:15:39,200 --> 00:15:44,900
administer both of them so commonly they

344
00:15:42,530 --> 00:15:47,510
go ahead and have their domain admin

345
00:15:44,900 --> 00:15:49,790
account that's enforced a in the forest

346
00:15:47,510 --> 00:15:52,819
B admins group because that makes it

347
00:15:49,790 --> 00:15:55,310
easier and microsoft says it's okay to

348
00:15:52,820 --> 00:15:58,730
have a one-way trust because that's safe

349
00:15:55,310 --> 00:16:00,680
and it's not going to be a problem the

350
00:15:58,730 --> 00:16:04,130
issue is that if force B is a lower

351
00:16:00,680 --> 00:16:06,650
level or a forest with a lower security

352
00:16:04,130 --> 00:16:09,080
posture like a DMZ and that gets

353
00:16:06,650 --> 00:16:11,240
compromised the credentials for this

354
00:16:09,080 --> 00:16:14,420
force a domain admin account is on force

355
00:16:11,240 --> 00:16:16,340
B's DCs and that means that gets

356
00:16:14,420 --> 00:16:18,170
compromised which means forced it gets

357
00:16:16,340 --> 00:16:19,430
compromised so you want to be very

358
00:16:18,170 --> 00:16:22,520
careful with cross for some

359
00:16:19,430 --> 00:16:26,839
administration better is to make sure

360
00:16:22,520 --> 00:16:30,020
that we create a new account or use an

361
00:16:26,840 --> 00:16:30,300
account for SB 4 for SP administration

362
00:16:30,020 --> 00:16:32,280
or

363
00:16:30,300 --> 00:16:34,260
create a new account in forest a it's

364
00:16:32,280 --> 00:16:35,790
just a regular user in forest day we

365
00:16:34,260 --> 00:16:37,740
want to isolate and protect that and

366
00:16:35,790 --> 00:16:40,199
make sure that we're not in a situation

367
00:16:37,740 --> 00:16:45,710
where compromise of one compromises the

368
00:16:40,200 --> 00:16:45,710
other so let's talk about some fun stuff

369
00:16:49,820 --> 00:16:54,780
very rarely do domain controllers have

370
00:16:52,380 --> 00:16:58,370
encrypted storage this provides some

371
00:16:54,780 --> 00:17:00,540
very interesting scenarios for attackers

372
00:16:58,370 --> 00:17:05,130
so we're going to talk we could talk

373
00:17:00,540 --> 00:17:07,829
about backups or the IFM which is

374
00:17:05,130 --> 00:17:09,660
install from media so I can direct your

375
00:17:07,829 --> 00:17:11,579
admins when they're spin up spinning up

376
00:17:09,660 --> 00:17:14,700
a new domain controller will create

377
00:17:11,579 --> 00:17:15,929
knife em set using NTDs youto this means

378
00:17:14,700 --> 00:17:17,370
that the domain controller that you're

379
00:17:15,930 --> 00:17:19,800
promoting doesn't have to pull down and

380
00:17:17,369 --> 00:17:21,119
replicate all the data so create the IFM

381
00:17:19,800 --> 00:17:22,950
set put it on that server you're about

382
00:17:21,119 --> 00:17:25,050
to promote or will promote in the future

383
00:17:22,950 --> 00:17:28,950
but that servers not well protected this

384
00:17:25,050 --> 00:17:30,840
IFM file set is there or as I've heard

385
00:17:28,950 --> 00:17:36,390
this may have been put in sis fall

386
00:17:30,840 --> 00:17:39,689
before so using the DES internals tools

387
00:17:36,390 --> 00:17:42,450
we can interact and pull the hashes

388
00:17:39,690 --> 00:17:44,130
directly out of the IFM set why because

389
00:17:42,450 --> 00:17:47,940
it's everything you need in order to get

390
00:17:44,130 --> 00:17:52,440
the access to that data the encryption

391
00:17:47,940 --> 00:17:54,960
key is in the in the registry hive which

392
00:17:52,440 --> 00:17:56,460
we pull from I FM and then we can just

393
00:17:54,960 --> 00:17:58,470
go ahead and pull that data directly out

394
00:17:56,460 --> 00:18:01,260
of it put it hash cat format crack it

395
00:17:58,470 --> 00:18:02,430
reuse it what have you so let's talk

396
00:18:01,260 --> 00:18:04,379
about some really interesting things you

397
00:18:02,430 --> 00:18:06,060
can do with this we can check the

398
00:18:04,380 --> 00:18:08,910
primary group ID on the island account

399
00:18:06,060 --> 00:18:12,240
so here we have bobba fett bobba fett

400
00:18:08,910 --> 00:18:13,620
has a primary group ID is 513 that's the

401
00:18:12,240 --> 00:18:18,390
main users that's what everyone should

402
00:18:13,620 --> 00:18:20,459
have but let's stop the ad service on

403
00:18:18,390 --> 00:18:21,630
our domain controller and change this to

404
00:18:20,460 --> 00:18:25,230
512

405
00:18:21,630 --> 00:18:28,560
anyone know what 512 is thread domain

406
00:18:25,230 --> 00:18:30,150
admins so if we change this to 512

407
00:18:28,560 --> 00:18:32,040
we're basically adding this domain

408
00:18:30,150 --> 00:18:34,200
admins without modifying the membership

409
00:18:32,040 --> 00:18:36,300
of domain admins and we're going to

410
00:18:34,200 --> 00:18:36,960
start the service again why is this

411
00:18:36,300 --> 00:18:41,159
interesting

412
00:18:36,960 --> 00:18:42,600
well one we've stopped the ad service so

413
00:18:41,160 --> 00:18:44,470
there's no security auditing of this

414
00:18:42,600 --> 00:18:47,360
change

415
00:18:44,470 --> 00:18:51,170
so we can do this on the DC that's

416
00:18:47,360 --> 00:18:54,590
running if we get access to the DC or if

417
00:18:51,170 --> 00:18:57,440
the DC is turned off for maintenance or

418
00:18:54,590 --> 00:18:58,790
is rebooting we can interrupt that and

419
00:18:57,440 --> 00:19:01,550
then we can interact with the dit

420
00:18:58,790 --> 00:19:03,620
directly on the storage or think of a

421
00:19:01,550 --> 00:19:07,280
situation where an attacker compromises

422
00:19:03,620 --> 00:19:09,379
your VMware environment and then

423
00:19:07,280 --> 00:19:11,870
basically stops your domain controller

424
00:19:09,380 --> 00:19:14,060
for running connects into the storage

425
00:19:11,870 --> 00:19:18,169
and modifies the dit in the storage

426
00:19:14,060 --> 00:19:19,730
there it can do something like this so

427
00:19:18,170 --> 00:19:21,500
let's take this one one more step well

428
00:19:19,730 --> 00:19:24,890
we can change the primary group ID there

429
00:19:21,500 --> 00:19:26,660
it is now it's domain admins so this

430
00:19:24,890 --> 00:19:28,610
will obviously when the DC comes back up

431
00:19:26,660 --> 00:19:29,920
it'll replicate that means that if the

432
00:19:28,610 --> 00:19:32,120
attacker has access to this account

433
00:19:29,920 --> 00:19:34,760
they're going to have some very

434
00:19:32,120 --> 00:19:35,989
interesting persistence for awhile we

435
00:19:34,760 --> 00:19:37,510
can do something similar with Syd

436
00:19:35,990 --> 00:19:40,820
history there's no city history here

437
00:19:37,510 --> 00:19:44,600
same thing we're gonna stop ad modify

438
00:19:40,820 --> 00:19:47,060
the dit start ad again again it doesn't

439
00:19:44,600 --> 00:19:49,250
matter if we do this on a running DC by

440
00:19:47,060 --> 00:19:52,300
stop and stopping the ad service or if

441
00:19:49,250 --> 00:19:56,660
we modify the date directly on storage

442
00:19:52,300 --> 00:19:59,450
when we get the the DC backup again and

443
00:19:56,660 --> 00:20:03,020
running it replicates now we have this

444
00:19:59,450 --> 00:20:04,130
account that has CID history but it gets

445
00:20:03,020 --> 00:20:06,350
more interesting than that

446
00:20:04,130 --> 00:20:07,880
now all of this is using DES internals

447
00:20:06,350 --> 00:20:09,949
and all this is based on a presentation

448
00:20:07,880 --> 00:20:11,510
that Michael graph nerd did at the

449
00:20:09,950 --> 00:20:14,990
hybrid identity protection conference in

450
00:20:11,510 --> 00:20:17,690
November of last year there's this

451
00:20:14,990 --> 00:20:21,650
switch that he added to DES internals

452
00:20:17,690 --> 00:20:24,140
called skip meta update this is very

453
00:20:21,650 --> 00:20:26,900
interesting so let's talk about this

454
00:20:24,140 --> 00:20:28,370
switch what we're gonna do is get some

455
00:20:26,900 --> 00:20:29,930
account properties some SIDS from the

456
00:20:28,370 --> 00:20:32,179
environment we're gonna get some user

457
00:20:29,930 --> 00:20:34,670
information about Jango Fett this is our

458
00:20:32,180 --> 00:20:36,200
new persistence account then what we're

459
00:20:34,670 --> 00:20:38,150
going to do is we're going to stop at e

460
00:20:36,200 --> 00:20:40,610
again same same scenario as I said

461
00:20:38,150 --> 00:20:41,060
before we're an attacker 1dc for five

462
00:20:40,610 --> 00:20:44,360
minutes

463
00:20:41,060 --> 00:20:46,040
we're gonna stop the ad service or again

464
00:20:44,360 --> 00:20:48,020
we can modify the date directly and

465
00:20:46,040 --> 00:20:50,120
we're gonna use this new switch skip

466
00:20:48,020 --> 00:20:51,800
meta update and we're going to update

467
00:20:50,120 --> 00:20:56,020
what I just talked about Sid history

468
00:20:51,800 --> 00:20:56,020
primary group ID for this account

469
00:20:56,510 --> 00:21:00,790
well after this comes back up again I

470
00:20:58,220 --> 00:21:03,830
just want to note we've done that on 22

471
00:21:00,790 --> 00:21:05,780
when that comes back up again it's up

472
00:21:03,830 --> 00:21:07,730
and running for a while let's go ahead

473
00:21:05,780 --> 00:21:09,168
and check those properties there's been

474
00:21:07,730 --> 00:21:13,130
no change to jango fett

475
00:21:09,169 --> 00:21:14,049
at all so we check our DCs we take a

476
00:21:13,130 --> 00:21:17,480
look at everything

477
00:21:14,049 --> 00:21:22,549
well what about DC 22 we take a look at

478
00:21:17,480 --> 00:21:24,650
DC 22 the change stays on that DC all of

479
00:21:22,549 --> 00:21:28,970
your security tooling today is looking

480
00:21:24,650 --> 00:21:31,179
at DCs in your data center we now have

481
00:21:28,970 --> 00:21:33,830
to broaden that we have to think bigger

482
00:21:31,179 --> 00:21:35,450
we have to do better analysis of our 8e

483
00:21:33,830 --> 00:21:38,210
environment to check for this sort of

484
00:21:35,450 --> 00:21:39,740
compromised 80 admins rarely are

485
00:21:38,210 --> 00:21:42,590
monitoring when there's a situation

486
00:21:39,740 --> 00:21:46,760
where a DC shuts down randomly and then

487
00:21:42,590 --> 00:21:48,740
comes back up again we often don't think

488
00:21:46,760 --> 00:21:52,280
about our VMware admins as being domain

489
00:21:48,740 --> 00:21:54,880
admins it's important to do so because

490
00:21:52,280 --> 00:21:58,010
most domain controllers are now virtual

491
00:21:54,880 --> 00:22:00,970
keep in mind that access to this storage

492
00:21:58,010 --> 00:22:05,809
that DC has means ad modification and

493
00:22:00,970 --> 00:22:12,590
there's no auditing of these changes so

494
00:22:05,809 --> 00:22:14,410
how do you detect this not really not

495
00:22:12,590 --> 00:22:17,178
exactly

496
00:22:14,410 --> 00:22:18,620
we can monitor for NTDs service stop

497
00:22:17,179 --> 00:22:19,790
start events that'd be a good way to

498
00:22:18,620 --> 00:22:20,770
look for someone actually doing

499
00:22:19,790 --> 00:22:23,360
something weird

500
00:22:20,770 --> 00:22:26,629
certainly the ad admins would should

501
00:22:23,360 --> 00:22:28,070
communicate and if security sees the 80

502
00:22:26,630 --> 00:22:29,600
Service stop they should reach out and

503
00:22:28,070 --> 00:22:31,280
be like what's going on with this TC is

504
00:22:29,600 --> 00:22:33,439
everything okay and the Adi bins like

505
00:22:31,280 --> 00:22:36,678
chill out I just have to change this and

506
00:22:33,440 --> 00:22:38,510
then restart it it's like okay well we

507
00:22:36,679 --> 00:22:41,150
might be able to replicate a monitor for

508
00:22:38,510 --> 00:22:42,770
replication to see when a DC is offline

509
00:22:41,150 --> 00:22:45,679
and then it comes back up if it's doing

510
00:22:42,770 --> 00:22:48,160
some replication all of a sudden now

511
00:22:45,679 --> 00:22:50,600
this may be something that the system

512
00:22:48,160 --> 00:22:52,280
crashed and it had some changes that

513
00:22:50,600 --> 00:22:53,870
still needed to replicate but it's

514
00:22:52,280 --> 00:22:56,899
something that you might be interesting

515
00:22:53,870 --> 00:23:00,350
so if we see a scenario where the 80

516
00:22:56,900 --> 00:23:05,840
service stops and then restarts in this

517
00:23:00,350 --> 00:23:07,610
situation it only took 10 seconds so in

518
00:23:05,840 --> 00:23:09,110
10 seconds someone can modify your

519
00:23:07,610 --> 00:23:11,449
domain controller and have persistent

520
00:23:09,110 --> 00:23:14,870
forever on that DC so in my jango fett

521
00:23:11,450 --> 00:23:17,960
scenario I made that modification on 22

522
00:23:14,870 --> 00:23:20,360
that may be a branch office DC way out

523
00:23:17,960 --> 00:23:22,460
somewhere jango fett as a user

524
00:23:20,360 --> 00:23:26,990
everywhere except when he connects the

525
00:23:22,460 --> 00:23:28,190
DC 22 so we know what Active Directory

526
00:23:26,990 --> 00:23:30,620
recon is a big deal

527
00:23:28,190 --> 00:23:31,880
plugin bloodhound is out there Power

528
00:23:30,620 --> 00:23:34,010
View is out there it gives us good

529
00:23:31,880 --> 00:23:36,110
insight into what's going on in AD how

530
00:23:34,010 --> 00:23:40,280
things are configured attackers use it

531
00:23:36,110 --> 00:23:42,439
to so there's a auditing configuration

532
00:23:40,280 --> 00:23:45,020
you can set on DC is called object

533
00:23:42,440 --> 00:23:47,030
access it's usually not enabled because

534
00:23:45,020 --> 00:23:49,129
it can be pretty noisy it's for 662 it's

535
00:23:47,030 --> 00:23:52,668
just generic you have to then configure

536
00:23:49,130 --> 00:23:54,830
the objects you want some auditing so we

537
00:23:52,669 --> 00:23:57,049
can detect 80 recon activity with this

538
00:23:54,830 --> 00:24:00,580
auditing we can actually configure thus

539
00:23:57,049 --> 00:24:04,129
Ackles or the auditing settings on our

540
00:24:00,580 --> 00:24:07,970
admin st holder object and whenever

541
00:24:04,130 --> 00:24:11,080
someone reads something from that object

542
00:24:07,970 --> 00:24:14,480
it's gonna get logged and audited

543
00:24:11,080 --> 00:24:15,889
because what ends up happening is from

544
00:24:14,480 --> 00:24:18,020
the admin st holder as i said earlier

545
00:24:15,890 --> 00:24:19,340
about 60 minutes later it's going to

546
00:24:18,020 --> 00:24:21,350
update it on the objects that are

547
00:24:19,340 --> 00:24:23,570
protected by the admin st prop which is

548
00:24:21,350 --> 00:24:25,520
a process that that checks admin st

549
00:24:23,570 --> 00:24:30,200
holder and stamps those permissions on

550
00:24:25,520 --> 00:24:31,549
those objects so when we run something

551
00:24:30,200 --> 00:24:33,710
like Power View to look at our domain

552
00:24:31,549 --> 00:24:35,720
admins group we're gonna see who did it

553
00:24:33,710 --> 00:24:40,580
and we're gonna see what they were

554
00:24:35,720 --> 00:24:42,770
looking at so we can do the same thing

555
00:24:40,580 --> 00:24:44,629
not just for our privileged groups which

556
00:24:42,770 --> 00:24:46,760
are pretty much automatic when we set it

557
00:24:44,630 --> 00:24:48,080
on admin st older but other custom we

558
00:24:46,760 --> 00:24:49,750
want to set that on other custom groups

559
00:24:48,080 --> 00:24:52,250
as well it might be interesting and

560
00:24:49,750 --> 00:24:54,110
these auditing settings are pretty much

561
00:24:52,250 --> 00:24:56,360
here they're pretty easy to figure out

562
00:24:54,110 --> 00:24:57,889
so we want to set it for everyone that's

563
00:24:56,360 --> 00:25:00,110
anyone that's connecting and looking

564
00:24:57,890 --> 00:25:01,190
this object only or you could set it to

565
00:25:00,110 --> 00:25:03,250
this object in all the sentence

566
00:25:01,190 --> 00:25:05,179
depending on what your your use case is

567
00:25:03,250 --> 00:25:06,620
basically read all properties for

568
00:25:05,179 --> 00:25:08,120
permissions and properties that way you

569
00:25:06,620 --> 00:25:11,000
can see everything see what's being

570
00:25:08,120 --> 00:25:14,600
looked at so like I said we can set it

571
00:25:11,000 --> 00:25:19,669
on the admin st holder set it on custom

572
00:25:14,600 --> 00:25:21,379
privilege groups now we can also audit

573
00:25:19,669 --> 00:25:22,350
for things beyond recon with this with

574
00:25:21,380 --> 00:25:25,289
this technique

575
00:25:22,350 --> 00:25:27,178
we can look at GPO modifications so when

576
00:25:25,289 --> 00:25:29,220
someone's changing a GPO they modify it

577
00:25:27,179 --> 00:25:31,409
or they delete it or they change

578
00:25:29,220 --> 00:25:33,630
something with the GPO like the the

579
00:25:31,409 --> 00:25:37,380
display name we can set auditing on that

580
00:25:33,630 --> 00:25:38,669
and again it's a 46 62 by the way I'm

581
00:25:37,380 --> 00:25:40,200
not talking about anything new here this

582
00:25:38,669 --> 00:25:42,149
has been around since the early days of

583
00:25:40,200 --> 00:25:44,299
Active Directory but it's interesting

584
00:25:42,149 --> 00:25:47,459
because it's almost never talked about

585
00:25:44,299 --> 00:25:50,100
almost never configured environments

586
00:25:47,460 --> 00:25:53,220
because it can be noisy it can be a lot

587
00:25:50,100 --> 00:25:55,408
of events they get logged so GPO sysvol

588
00:25:53,220 --> 00:25:59,250
auditing again this is a new event

589
00:25:55,409 --> 00:26:02,460
though for 663 because GPOs are set up

590
00:25:59,250 --> 00:26:04,919
as the 80 component and the file

591
00:26:02,460 --> 00:26:07,289
component insist fall the 80 component

592
00:26:04,919 --> 00:26:08,789
is where you actually create the GPO set

593
00:26:07,289 --> 00:26:10,500
up some of the things but the actual

594
00:26:08,789 --> 00:26:12,629
settings are stored in the file insis

595
00:26:10,500 --> 00:26:14,970
fall so we need to do a little bit more

596
00:26:12,629 --> 00:26:17,009
work to set that configuration we have

597
00:26:14,970 --> 00:26:20,850
to enable it through the GPO and then

598
00:26:17,009 --> 00:26:22,649
configure it on sysvol I talked about

599
00:26:20,850 --> 00:26:25,620
something similar a while back when you

600
00:26:22,649 --> 00:26:28,229
want to audit for someone looking for

601
00:26:25,620 --> 00:26:31,889
group policy preference passwords so you

602
00:26:28,230 --> 00:26:34,080
can configure a GPO and basically set it

603
00:26:31,889 --> 00:26:35,908
so that no one would ever look at it

604
00:26:34,080 --> 00:26:37,379
because you just set the folder in there

605
00:26:35,909 --> 00:26:40,049
that for a GPO that doesn't really exist

606
00:26:37,379 --> 00:26:42,990
and anyone the scanning system for stuff

607
00:26:40,049 --> 00:26:44,580
would see it you would see that same

608
00:26:42,990 --> 00:26:45,659
thing if you have laps you can do the

609
00:26:44,580 --> 00:26:47,549
same thing there's a powershell

610
00:26:45,659 --> 00:26:49,500
commandlets for it in the laughs module

611
00:26:47,549 --> 00:27:00,029
where you can configure auditing of who

612
00:26:49,500 --> 00:27:01,350
accesses the password attribute it's one

613
00:27:00,029 --> 00:27:02,879
of the things you must be doing today

614
00:27:01,350 --> 00:27:04,620
hopefully and where you were doing this

615
00:27:02,879 --> 00:27:08,519
yesterday is monitoring for event log

616
00:27:04,620 --> 00:27:10,799
clearing of NID 1102 this should be your

617
00:27:08,519 --> 00:27:13,440
number one event to be monitored in your

618
00:27:10,799 --> 00:27:15,509
environment there's rarely a good reason

619
00:27:13,440 --> 00:27:18,779
to clear the event log attackers love

620
00:27:15,509 --> 00:27:20,639
clearing event logs okay that's

621
00:27:18,779 --> 00:27:23,399
interesting but what else can we do we

622
00:27:20,639 --> 00:27:25,019
can break 80 recon we can change the

623
00:27:23,399 --> 00:27:26,789
permissions for authenticated users

624
00:27:25,019 --> 00:27:30,169
which by default have the ability to

625
00:27:26,789 --> 00:27:33,200
look at everything we can go in and

626
00:27:30,169 --> 00:27:36,210
basically look to see will where

627
00:27:33,200 --> 00:27:37,830
authenticated users has rights

628
00:27:36,210 --> 00:27:39,570
and of course they're able to look at

629
00:27:37,830 --> 00:27:42,960
everything so they can enumerate domain

630
00:27:39,570 --> 00:27:45,450
admins so we can lock this down and we

631
00:27:42,960 --> 00:27:47,400
can set a configuration where first of

632
00:27:45,450 --> 00:27:49,590
all we remove this pre Windows 2000

633
00:27:47,400 --> 00:27:51,660
compatible access because hopefully no

634
00:27:49,590 --> 00:27:53,010
one has any NT running in their

635
00:27:51,660 --> 00:27:54,570
environment so we're gonna remove

636
00:27:53,010 --> 00:27:55,980
authenticated users out of this because

637
00:27:54,570 --> 00:27:58,770
this has some default permissions on

638
00:27:55,980 --> 00:28:02,640
some objects then what we're going to do

639
00:27:58,770 --> 00:28:05,070
is we are going to have a Nou or level

640
00:28:02,640 --> 00:28:06,240
oh you called a tea management and we're

641
00:28:05,070 --> 00:28:08,040
gonna make some changes to that so

642
00:28:06,240 --> 00:28:11,190
authenticate users cannot see inside of

643
00:28:08,040 --> 00:28:12,570
it so when users go to look at it they

644
00:28:11,190 --> 00:28:15,330
see if there's an object there but they

645
00:28:12,570 --> 00:28:17,010
can't see anything inside of it and what

646
00:28:15,330 --> 00:28:18,659
gets really interesting is that when we

647
00:28:17,010 --> 00:28:21,360
put our domain admins group inside of

648
00:28:18,660 --> 00:28:25,440
this Power View says there are no domain

649
00:28:21,360 --> 00:28:27,840
admins but if we look at our

650
00:28:25,440 --> 00:28:29,640
administrator account for example we can

651
00:28:27,840 --> 00:28:30,840
see that it's a member of domain admins

652
00:28:29,640 --> 00:28:32,280
through the member of attribute because

653
00:28:30,840 --> 00:28:35,580
there's what's called a backlink in

654
00:28:32,280 --> 00:28:39,060
Active Directory so we can configure a

655
00:28:35,580 --> 00:28:40,710
secure admin öyou with special

656
00:28:39,060 --> 00:28:42,179
permissions we're going to put all of

657
00:28:40,710 --> 00:28:44,640
our privileged admin accounts and groups

658
00:28:42,180 --> 00:28:47,400
in this so you and the object is there

659
00:28:44,640 --> 00:28:48,510
but you can't see inside of it and we

660
00:28:47,400 --> 00:28:50,550
always recommend that when you lock

661
00:28:48,510 --> 00:28:52,140
things down that you add a view group so

662
00:28:50,550 --> 00:28:53,879
that way it can be audited if you have

663
00:28:52,140 --> 00:28:55,740
GPOs that you're removing authenticated

664
00:28:53,880 --> 00:28:58,770
users from which good idea for some

665
00:28:55,740 --> 00:29:00,240
security settings you want to make sure

666
00:28:58,770 --> 00:29:01,889
there's a group that can still see it so

667
00:29:00,240 --> 00:29:03,750
that way when your security team or

668
00:29:01,890 --> 00:29:05,040
security team needs to look at it or you

669
00:29:03,750 --> 00:29:07,410
have auditors come in to look at

670
00:29:05,040 --> 00:29:10,110
settings configurations it's easy to do

671
00:29:07,410 --> 00:29:12,000
you have a group for that but what if we

672
00:29:10,110 --> 00:29:13,379
could just get rid of that entirely what

673
00:29:12,000 --> 00:29:15,810
if we could hide the whole thing

674
00:29:13,380 --> 00:29:17,790
what if we could cloak the ship it would

675
00:29:15,810 --> 00:29:19,290
be pretty cool so in AD there's this

676
00:29:17,790 --> 00:29:23,520
thing called list object access mode

677
00:29:19,290 --> 00:29:24,930
again that's been around for a while it

678
00:29:23,520 --> 00:29:26,430
adds this new permission option called

679
00:29:24,930 --> 00:29:28,170
list object and controls the visibility

680
00:29:26,430 --> 00:29:29,820
on these 80 objects and we do this

681
00:29:28,170 --> 00:29:34,080
through what's called des heuristics des

682
00:29:29,820 --> 00:29:35,610
heuristics is a single attribute in

683
00:29:34,080 --> 00:29:37,560
Active Directory that'll enables you to

684
00:29:35,610 --> 00:29:40,590
modify the way ad actually works and

685
00:29:37,560 --> 00:29:42,950
does things and actually in fact a lot

686
00:29:40,590 --> 00:29:45,510
of colleges use this in order to hide

687
00:29:42,950 --> 00:29:46,980
groups and group membership from other

688
00:29:45,510 --> 00:29:49,379
students so they can't see who's in the

689
00:29:46,980 --> 00:29:50,850
class so it's been around for a while

690
00:29:49,380 --> 00:29:52,260
used again we're going to remove

691
00:29:50,850 --> 00:29:55,620
authenticated users from pre Windows

692
00:29:52,260 --> 00:29:57,330
2000 compatible we are going to go in

693
00:29:55,620 --> 00:30:00,510
and modify or des heuristics from not

694
00:29:57,330 --> 00:30:03,990
set to one once we do that we have this

695
00:30:00,510 --> 00:30:06,000
new checkbox called list object so what

696
00:30:03,990 --> 00:30:07,080
we're gonna do is on our root of our

697
00:30:06,000 --> 00:30:10,350
domain because we're feeling a little

698
00:30:07,080 --> 00:30:11,399
crazy today it's Sunday that runs asleep

699
00:30:10,350 --> 00:30:13,469
no one will notice so we move

700
00:30:11,400 --> 00:30:15,030
authenticated users from the domain and

701
00:30:13,470 --> 00:30:17,000
what ends up happening is for all

702
00:30:15,030 --> 00:30:21,600
authenticated users all of these OU's

703
00:30:17,000 --> 00:30:23,910
disappear cloak of invisibility they're

704
00:30:21,600 --> 00:30:25,350
gone now domain admins can still see

705
00:30:23,910 --> 00:30:27,210
them we can configure the permissions on

706
00:30:25,350 --> 00:30:30,330
the domain root so again a view only

707
00:30:27,210 --> 00:30:31,980
group can see it but it hasn't really

708
00:30:30,330 --> 00:30:34,409
changed anything former econ perspective

709
00:30:31,980 --> 00:30:36,690
we can still see our domain admins so

710
00:30:34,410 --> 00:30:38,220
what do we need to do well let's kick

711
00:30:36,690 --> 00:30:40,260
authenticated users out of being able to

712
00:30:38,220 --> 00:30:42,720
see you two main admins it's gonna work

713
00:30:40,260 --> 00:30:44,700
for like 60 minutes and then add mesti

714
00:30:42,720 --> 00:30:47,190
holders gonna reach that so we modify

715
00:30:44,700 --> 00:30:49,380
the admin st holder in order to make

716
00:30:47,190 --> 00:30:53,750
sure that it's removed from there and

717
00:30:49,380 --> 00:30:58,320
then what happens there are no admins

718
00:30:53,750 --> 00:31:02,790
they're gone and we can't even look

719
00:30:58,320 --> 00:31:04,080
inside of a know you in this so let's

720
00:31:02,790 --> 00:31:06,600
run bloodhound and see what happens we

721
00:31:04,080 --> 00:31:08,189
run bloodhound so we run sharpen I like

722
00:31:06,600 --> 00:31:11,610
the power search shell thing cuz I like

723
00:31:08,190 --> 00:31:12,600
power shell so it goes through and what

724
00:31:11,610 --> 00:31:16,729
do you think is gonna be in this JSON

725
00:31:12,600 --> 00:31:19,110
file yeah two main admin membership

726
00:31:16,730 --> 00:31:20,490
bloodhound is looking at multiple

727
00:31:19,110 --> 00:31:22,590
attributes in the in Active Directory

728
00:31:20,490 --> 00:31:25,230
not just the group membership but also

729
00:31:22,590 --> 00:31:29,520
the accounts themselves and their member

730
00:31:25,230 --> 00:31:31,590
of attribute that backlink so let's

731
00:31:29,520 --> 00:31:33,900
break that feel like breaking stuff

732
00:31:31,590 --> 00:31:35,939
today so we're going to do is we're

733
00:31:33,900 --> 00:31:40,560
gonna move all of our 80 admins into

734
00:31:35,940 --> 00:31:43,470
this secure do--you including our domain

735
00:31:40,560 --> 00:31:47,429
admins group now we run bloodhound again

736
00:31:43,470 --> 00:31:49,820
and what happens there is no domain

737
00:31:47,430 --> 00:31:56,100
admins group in the bloodhound groups

738
00:31:49,820 --> 00:31:57,480
JSON file couldn't see it so this means

739
00:31:56,100 --> 00:31:58,679
that we can do some breaking here and

740
00:31:57,480 --> 00:32:01,230
let's talk some more about breaking

741
00:31:58,680 --> 00:32:03,330
bloodhound recon and again bloodhound

742
00:32:01,230 --> 00:32:05,250
can be a very good tool for blue team

743
00:32:03,330 --> 00:32:07,770
so what we want to do is provide access

744
00:32:05,250 --> 00:32:09,360
to the blue team and our security

745
00:32:07,770 --> 00:32:10,680
testing team to make sure that they can

746
00:32:09,360 --> 00:32:12,060
get the data they need in order to test

747
00:32:10,680 --> 00:32:14,280
the security and look at things in their

748
00:32:12,060 --> 00:32:16,950
environment so I've talked about

749
00:32:14,280 --> 00:32:19,350
breaking the admin group and account

750
00:32:16,950 --> 00:32:22,200
enumeration local administrators group

751
00:32:19,350 --> 00:32:24,090
membership so in Windows 10 1507 and

752
00:32:22,200 --> 00:32:25,950
newer only local admins can do that

753
00:32:24,090 --> 00:32:27,659
enumeration so that's kind of fixed by

754
00:32:25,950 --> 00:32:31,740
default once you deploy Windows sent any

755
00:32:27,660 --> 00:32:33,120
modern current version of Windows 10 but

756
00:32:31,740 --> 00:32:34,260
if you don't have Windows 10 you

757
00:32:33,120 --> 00:32:36,209
definitely want to enable a host-based

758
00:32:34,260 --> 00:32:37,680
firewall because bloodhound is going to

759
00:32:36,210 --> 00:32:40,530
reach out to all your work stations and

760
00:32:37,680 --> 00:32:42,450
get the local group enumerate the local

761
00:32:40,530 --> 00:32:46,139
group administrator the local

762
00:32:42,450 --> 00:32:47,760
administrators group membership and it

763
00:32:46,140 --> 00:32:49,650
can do that because there's this old NT

764
00:32:47,760 --> 00:32:51,570
function that just says yeah anyone

765
00:32:49,650 --> 00:32:52,950
wants to know this go ahead but when you

766
00:32:51,570 --> 00:32:54,389
use computer management you connect to

767
00:32:52,950 --> 00:32:55,950
that system inside sorry you can't see

768
00:32:54,390 --> 00:32:58,110
administrators like all right I'll just

769
00:32:55,950 --> 00:32:59,640
use this old method set which is what

770
00:32:58,110 --> 00:33:02,100
bloodhound takes advantage of this is

771
00:32:59,640 --> 00:33:07,590
what most recon systems take advantage

772
00:33:02,100 --> 00:33:09,750
of here's a tip you can also have the

773
00:33:07,590 --> 00:33:11,429
firewall there have it set not to block

774
00:33:09,750 --> 00:33:12,780
anything just in audit mode so you get a

775
00:33:11,430 --> 00:33:14,940
good idea of what's happening what's

776
00:33:12,780 --> 00:33:16,170
connecting to it you can pull that into

777
00:33:14,940 --> 00:33:18,300
your sim or you can pull that into a

778
00:33:16,170 --> 00:33:21,420
central logging system like wife and get

779
00:33:18,300 --> 00:33:22,980
some insight into that and that session

780
00:33:21,420 --> 00:33:24,600
enumeration is interesting and become

781
00:33:22,980 --> 00:33:26,550
again more popular because of bloodhound

782
00:33:24,600 --> 00:33:28,740
because it allows you to say hey

783
00:33:26,550 --> 00:33:31,139
computer what accounts are connected to

784
00:33:28,740 --> 00:33:32,580
you right now oh and by the way what

785
00:33:31,140 --> 00:33:34,500
computers are they coming from and

786
00:33:32,580 --> 00:33:35,790
Windows like sure or here you go that

787
00:33:34,500 --> 00:33:39,480
seems like important stuff for you to

788
00:33:35,790 --> 00:33:42,540
have random user on my network but we

789
00:33:39,480 --> 00:33:44,090
can turn that off we can break that with

790
00:33:42,540 --> 00:33:47,940
a tool called net seized by the

791
00:33:44,090 --> 00:33:49,350
Microsoft research team and it removes

792
00:33:47,940 --> 00:33:51,000
authenticated users so they can't do

793
00:33:49,350 --> 00:33:52,679
this we can do this on DCs we do it on

794
00:33:51,000 --> 00:33:54,870
file servers guess what bloodhound now

795
00:33:52,680 --> 00:33:57,780
cannot do necessary numeration in the

796
00:33:54,870 --> 00:33:59,429
environment because the stealth mode as

797
00:33:57,780 --> 00:34:01,139
I understand it basically switches from

798
00:33:59,430 --> 00:34:03,090
connecting to DC's for this and then

799
00:34:01,140 --> 00:34:06,150
connecting to the server's the file

800
00:34:03,090 --> 00:34:08,819
servers home directory servers and then

801
00:34:06,150 --> 00:34:11,160
the GPO security permissions again if

802
00:34:08,820 --> 00:34:12,300
you can't see it you can't enumerate the

803
00:34:11,159 --> 00:34:14,629
permissions you can't enumerate the

804
00:34:12,300 --> 00:34:14,630
settings

805
00:34:14,899 --> 00:34:19,049
so there's really interesting things we

806
00:34:17,159 --> 00:34:21,929
can do with Active Directory again

807
00:34:19,050 --> 00:34:24,059
always test before deploy don't say hey

808
00:34:21,929 --> 00:34:26,010
Sean said that we can go ahead and do

809
00:34:24,059 --> 00:34:27,089
this so we can cloak our ad and no one

810
00:34:26,010 --> 00:34:29,720
will be able to see it and it'll be

811
00:34:27,089 --> 00:34:33,418
awesome okay hold on

812
00:34:29,719 --> 00:34:34,888
you can totally cloak your ad and make

813
00:34:33,418 --> 00:34:36,808
it invisible and it's awesome but you

814
00:34:34,889 --> 00:34:38,369
absolutely need to test it and make sure

815
00:34:36,809 --> 00:34:41,069
that it's not going to break stuff first

816
00:34:38,369 --> 00:34:44,280
one good way to do this is to make sure

817
00:34:41,069 --> 00:34:46,308
that you set up auditing on these

818
00:34:44,280 --> 00:34:50,179
administrative groups so that you know

819
00:34:46,309 --> 00:34:50,179
who is connecting to them

820
00:34:50,960 --> 00:34:54,510
so one of the things that I've

821
00:34:52,949 --> 00:34:56,399
recommended for customers in the past

822
00:34:54,510 --> 00:34:58,290
and I set this up at in a pretty large

823
00:34:56,399 --> 00:35:01,290
environment many years ago is this

824
00:34:58,290 --> 00:35:03,300
concept of a secure admin oh you for

825
00:35:01,290 --> 00:35:05,609
Active Directory administrators and

826
00:35:03,300 --> 00:35:08,550
what's great about this is you have a

827
00:35:05,609 --> 00:35:12,569
root level though you that no one can

828
00:35:08,550 --> 00:35:13,829
modify except for your 80 admins make

829
00:35:12,569 --> 00:35:15,720
sure there's no group policies that

830
00:35:13,829 --> 00:35:21,059
apply to it except the one specific for

831
00:35:15,720 --> 00:35:22,589
that you put your 80 admins in there you

832
00:35:21,059 --> 00:35:24,240
put your 80 workstation 80 Avenel

833
00:35:22,589 --> 00:35:26,279
workstations in there 80 admin servers

834
00:35:24,240 --> 00:35:29,640
in there you put your 80 admin groups in

835
00:35:26,280 --> 00:35:31,530
there and control who can see them who

836
00:35:29,640 --> 00:35:34,890
can have access to them who can interact

837
00:35:31,530 --> 00:35:38,910
with them so can Active Directory be

838
00:35:34,890 --> 00:35:39,799
secured absolutely we help with that all

839
00:35:38,910 --> 00:35:43,319
the time

840
00:35:39,799 --> 00:35:47,160
but more importantly your team can do

841
00:35:43,319 --> 00:35:50,069
that as well I was sitting in the

842
00:35:47,160 --> 00:35:53,460
speaker room just before about an hour

843
00:35:50,069 --> 00:35:57,470
ago and I was updating slides my fun

844
00:35:53,460 --> 00:35:59,670
little Derby con memories thing and

845
00:35:57,470 --> 00:36:02,279
someone said what's your talk about I

846
00:35:59,670 --> 00:36:04,730
said oh it's Active Directory yeah oh

847
00:36:02,280 --> 00:36:04,730
I'm sorry

848
00:36:04,819 --> 00:36:13,230
interesting I'm sorry okay tell me more

849
00:36:08,869 --> 00:36:16,799
so he was like well I guess it's good if

850
00:36:13,230 --> 00:36:20,569
you're an attacker or a red teamer by a

851
00:36:16,799 --> 00:36:20,569
lot of organizations find it helpful too

852
00:36:20,619 --> 00:36:25,299
I said what do you do it's a Linux

853
00:36:23,589 --> 00:36:33,459
system admin oh cool

854
00:36:25,299 --> 00:36:35,859
how do you manage those let's just say

855
00:36:33,459 --> 00:36:37,689
it was a little awkward and then I

856
00:36:35,859 --> 00:36:41,859
change the subject and look how hazard

857
00:36:37,689 --> 00:36:45,308
every con going and he's like yeah it's

858
00:36:41,859 --> 00:36:46,180
the last year wow man it's like that old

859
00:36:45,309 --> 00:36:52,539
SNL skit

860
00:36:46,180 --> 00:36:55,419
wah-wah-wah-wah jeez okay have you had a

861
00:36:52,539 --> 00:36:56,559
good time yeah absolutely I was good but

862
00:36:55,420 --> 00:36:58,630
that's the thing that we run into

863
00:36:56,559 --> 00:37:01,989
especially when were 80 admins we work

864
00:36:58,630 --> 00:37:04,089
with ad we're 80 engineers it's tough

865
00:37:01,989 --> 00:37:07,630
it's tough to fix these things it's

866
00:37:04,089 --> 00:37:10,599
tough to get these things handled but we

867
00:37:07,630 --> 00:37:12,219
can configure a secure environment you

868
00:37:10,599 --> 00:37:15,099
can configure things where we can see

869
00:37:12,219 --> 00:37:18,969
what's going on you know what's going on

870
00:37:15,099 --> 00:37:20,650
in our environment we want to make sure

871
00:37:18,969 --> 00:37:22,479
that we do some sort of tearing that we

872
00:37:20,650 --> 00:37:25,539
isolate our Active Directory admins or

873
00:37:22,479 --> 00:37:27,999
domain admins so here's the thing domain

874
00:37:25,539 --> 00:37:31,059
admins only get their rights through the

875
00:37:27,999 --> 00:37:34,198
main administrators group the domain

876
00:37:31,059 --> 00:37:36,519
administrators group is the one that has

877
00:37:34,199 --> 00:37:41,170
Active Directory admin rights

878
00:37:36,519 --> 00:37:42,910
it has DC admin rights so if we can

879
00:37:41,170 --> 00:37:44,949
isolate and protect all of these groups

880
00:37:42,910 --> 00:37:47,529
that have the most privileged access in

881
00:37:44,949 --> 00:37:49,719
our environment then we can be in good

882
00:37:47,529 --> 00:37:52,569
shape at least not to the point where

883
00:37:49,719 --> 00:37:55,209
someone's on our DCs but again we have

884
00:37:52,569 --> 00:37:57,579
to make sure that our Active Directory

885
00:37:55,209 --> 00:37:59,499
databases are protected when it's

886
00:37:57,579 --> 00:38:02,559
running on the DC as well as when it's

887
00:37:59,499 --> 00:38:04,718
not we have encrypted VMs now on all the

888
00:38:02,559 --> 00:38:07,049
major platforms there's some crypt

889
00:38:04,719 --> 00:38:09,400
encryption options in the cloud as well

890
00:38:07,049 --> 00:38:12,549
but admin workstations are now a

891
00:38:09,400 --> 00:38:15,549
requirement I know that is really tough

892
00:38:12,549 --> 00:38:17,799
to implement and to work and to use but

893
00:38:15,549 --> 00:38:20,469
we have to do that so let's talk about

894
00:38:17,799 --> 00:38:22,660
levels of getting where we need to go so

895
00:38:20,469 --> 00:38:23,999
level 1 securing Active Directory make

896
00:38:22,660 --> 00:38:27,848
sure our local admin passwords change

897
00:38:23,999 --> 00:38:29,828
like easy button of doing this Microsoft

898
00:38:27,849 --> 00:38:31,089
lapse let's just get it done we want to

899
00:38:29,829 --> 00:38:33,480
minimize our groups and users with

900
00:38:31,089 --> 00:38:35,310
domain admin and log on right so

901
00:38:33,480 --> 00:38:38,760
or domain users they can log on to our

902
00:38:35,310 --> 00:38:40,680
domain controllers please I mean I

903
00:38:38,760 --> 00:38:42,420
understand that the admin is going on

904
00:38:40,680 --> 00:38:43,859
vacation or something we just in case

905
00:38:42,420 --> 00:38:46,619
something happens we want someone to be

906
00:38:43,859 --> 00:38:48,630
able to get on the DC make sure that

907
00:38:46,619 --> 00:38:50,130
just like we have been talking about for

908
00:38:48,630 --> 00:38:52,109
years a separate user account in a

909
00:38:50,130 --> 00:38:54,900
separate admin account we also have a

910
00:38:52,109 --> 00:38:57,410
separate ad admin account if that person

911
00:38:54,900 --> 00:38:59,820
is in multiple roles

912
00:38:57,410 --> 00:39:01,230
just like we separated a user account

913
00:38:59,820 --> 00:39:02,910
and an admin account we want to make

914
00:39:01,230 --> 00:39:04,590
sure that we isolate our DC's and have

915
00:39:02,910 --> 00:39:07,859
them on some sort of admin workstation

916
00:39:04,590 --> 00:39:09,390
or server and sensitive and cannot be

917
00:39:07,859 --> 00:39:11,310
delegated we'll protect against these

918
00:39:09,390 --> 00:39:14,339
Kerberos delegation attacks a lot of the

919
00:39:11,310 --> 00:39:16,890
time service counts absolutely need long

920
00:39:14,340 --> 00:39:18,570
complex passwords and one of the best

921
00:39:16,890 --> 00:39:20,549
things you can do is set a GPO in your

922
00:39:18,570 --> 00:39:22,680
environment so these highly privileged

923
00:39:20,550 --> 00:39:27,150
groups and accounts can't just log on to

924
00:39:22,680 --> 00:39:29,430
workstations serves conce group managed

925
00:39:27,150 --> 00:39:33,810
service counts you can set these up and

926
00:39:29,430 --> 00:39:35,149
configure these on most systems ad will

927
00:39:33,810 --> 00:39:38,359
manage the password for you

928
00:39:35,150 --> 00:39:40,710
automatically free out-of-the-box and

929
00:39:38,359 --> 00:39:43,859
fine-grained password policies

930
00:39:40,710 --> 00:39:46,500
starting with 2008 will enable you to

931
00:39:43,859 --> 00:39:48,690
set password policy specific to Active

932
00:39:46,500 --> 00:39:51,330
Directory admins and service accounts

933
00:39:48,690 --> 00:39:54,770
make those longer make them more complex

934
00:39:51,330 --> 00:39:57,180
force them to use better passwords

935
00:39:54,770 --> 00:40:01,200
because if your password policy for your

936
00:39:57,180 --> 00:40:02,730
domain is what seven characters guess

937
00:40:01,200 --> 00:40:07,259
what people may use for the service

938
00:40:02,730 --> 00:40:11,040
accounts that's not great we want to get

939
00:40:07,260 --> 00:40:13,830
rid of ntlm v1 and TLM v1 is a very bad

940
00:40:11,040 --> 00:40:15,690
protocol uses md5 for encryption at the

941
00:40:13,830 --> 00:40:18,569
time it was like this is great we can

942
00:40:15,690 --> 00:40:21,420
use md5 is awesome no not really we know

943
00:40:18,570 --> 00:40:23,400
that it's hard to get rid of it but we

944
00:40:21,420 --> 00:40:27,200
can set up auditing on DC's and servers

945
00:40:23,400 --> 00:40:30,450
to see what's using what version of ntlm

946
00:40:27,200 --> 00:40:32,220
and we definitely don't want any Active

947
00:40:30,450 --> 00:40:35,460
Directory admin or domain admin accounts

948
00:40:32,220 --> 00:40:38,609
in we're at least logging on to systems

949
00:40:35,460 --> 00:40:41,310
that aren't DC's scenario I talked about

950
00:40:38,609 --> 00:40:42,869
a lot with this is let's say you have a

951
00:40:41,310 --> 00:40:46,230
vulnerability scanning account and it's

952
00:40:42,869 --> 00:40:47,069
indi a common scenario right it doesn't

953
00:40:46,230 --> 00:40:49,469
matter what the product

954
00:40:47,069 --> 00:40:50,609
most of them people end up taking the

955
00:40:49,469 --> 00:40:53,789
service account putting in a domain

956
00:40:50,609 --> 00:40:58,078
admins so this account will scan all

957
00:40:53,789 --> 00:41:00,569
your systems right well unconstrained

958
00:40:58,079 --> 00:41:03,059
delegation is a way for that system to

959
00:41:00,569 --> 00:41:04,079
impersonate a user including a service

960
00:41:03,059 --> 00:41:08,579
account it's a vulnerability scan

961
00:41:04,079 --> 00:41:10,499
account can impersonate anyone or let's

962
00:41:08,579 --> 00:41:11,819
say that that security service is

963
00:41:10,499 --> 00:41:13,589
scanning everything in it hiccups

964
00:41:11,819 --> 00:41:16,079
because the developer forgot to add a

965
00:41:13,589 --> 00:41:19,469
comma or close a bracket or something

966
00:41:16,079 --> 00:41:20,699
and that credential gets sprayed across

967
00:41:19,469 --> 00:41:23,900
your entire environment

968
00:41:20,699 --> 00:41:26,400
what's the tabletop exercise for that

969
00:41:23,900 --> 00:41:27,959
what's the solution of that now you have

970
00:41:26,400 --> 00:41:29,699
your service account credentials it's in

971
00:41:27,959 --> 00:41:32,129
domain admins on every system in your

972
00:41:29,699 --> 00:41:34,049
organization well maybe that makes

973
00:41:32,130 --> 00:41:36,509
things easier I don't know for who

974
00:41:34,049 --> 00:41:38,130
though and one of the things we also

975
00:41:36,509 --> 00:41:40,499
talked about is limiting management

976
00:41:38,130 --> 00:41:45,779
protocol access on domain controllers to

977
00:41:40,499 --> 00:41:47,038
admins subnet so RDP WMI when around not

978
00:41:45,779 --> 00:41:50,430
everyone on the network needs to be able

979
00:41:47,039 --> 00:41:52,380
to use these again make sure that your

980
00:41:50,430 --> 00:41:55,190
auditors make sure that the Assessors

981
00:41:52,380 --> 00:41:57,690
can connect to these when they need to

982
00:41:55,190 --> 00:42:00,180
level 3 complete separation of

983
00:41:57,690 --> 00:42:01,920
administration so this this is where any

984
00:42:00,180 --> 00:42:03,029
service count any account that's a

985
00:42:01,920 --> 00:42:04,920
member of an Active Directory admin

986
00:42:03,029 --> 00:42:06,269
group does not log on anywhere except a

987
00:42:04,920 --> 00:42:08,489
domain controller or doesn't connect

988
00:42:06,269 --> 00:42:10,198
anything like that time-based temporal

989
00:42:08,489 --> 00:42:12,209
group and membership is hard a little

990
00:42:10,199 --> 00:42:14,219
hard to do but you race it basically

991
00:42:12,209 --> 00:42:15,538
want to make sure that if the account is

992
00:42:14,219 --> 00:42:23,459
compromised it's not a member of a

993
00:42:15,539 --> 00:42:24,180
privileged group so it has to wait so

994
00:42:23,459 --> 00:42:25,680
protecting

995
00:42:24,180 --> 00:42:27,270
and creds I have a single slide for this

996
00:42:25,680 --> 00:42:30,078
so that you have some information all on

997
00:42:27,270 --> 00:42:32,520
one page we want to make sure that again

998
00:42:30,079 --> 00:42:35,819
80 admins are logging on something

999
00:42:32,520 --> 00:42:37,589
separate and there's some additional

1000
00:42:35,819 --> 00:42:40,200
mitigations I mentioned ntlm auditing

1001
00:42:37,589 --> 00:42:43,710
you can also do SMB auditing get rid of

1002
00:42:40,200 --> 00:42:47,189
SMB v1 it's bad please change your curb

1003
00:42:43,710 --> 00:42:50,309
tdg account password why I talked about

1004
00:42:47,190 --> 00:42:52,380
backups regularly we find that the curb

1005
00:42:50,309 --> 00:42:54,420
TDT password hasn't changed in 10 years

1006
00:42:52,380 --> 00:42:56,940
or 15 years since the ADA environment

1007
00:42:54,420 --> 00:42:58,380
was created and because it hasn't

1008
00:42:56,940 --> 00:43:00,329
changed since it was created if an

1009
00:42:58,380 --> 00:43:03,390
attacker got access to a backup file

1010
00:43:00,329 --> 00:43:05,339
from 13 years ago that someone misplaced

1011
00:43:03,390 --> 00:43:09,058
your entire Active Directory environment

1012
00:43:05,339 --> 00:43:11,549
can compromised so we want to make sure

1013
00:43:09,059 --> 00:43:13,770
that we do the right things we have our

1014
00:43:11,550 --> 00:43:15,930
admins change your passwords we change

1015
00:43:13,770 --> 00:43:18,240
our curb TV especially if someone leaves

1016
00:43:15,930 --> 00:43:19,710
and then there's a tool called pink

1017
00:43:18,240 --> 00:43:20,040
castle written by Vincent Vincent in

1018
00:43:19,710 --> 00:43:22,140
here

1019
00:43:20,040 --> 00:43:24,480
I saw Marius he's over there at Vincent

1020
00:43:22,140 --> 00:43:28,500
I always mispronounce your name say your

1021
00:43:24,480 --> 00:43:30,210
last name Lou - Vincent in the - I hope

1022
00:43:28,500 --> 00:43:32,760
I said that right so Vince and ro pink

1023
00:43:30,210 --> 00:43:34,500
castle it's an awesome tool there's a

1024
00:43:32,760 --> 00:43:35,760
free version of it and an enterprise

1025
00:43:34,500 --> 00:43:37,230
version which has additional features

1026
00:43:35,760 --> 00:43:39,630
you can pay for but there's a free

1027
00:43:37,230 --> 00:43:42,180
version check it out download it run it

1028
00:43:39,630 --> 00:43:43,890
see the visualizations it will help you

1029
00:43:42,180 --> 00:43:47,210
figure out some of some of the issues in

1030
00:43:43,890 --> 00:43:47,210
your environment very quickly and easily

1031
00:43:47,299 --> 00:43:52,710
so in summary fix the easy stuff please

1032
00:43:50,579 --> 00:43:54,660
stuff I talked about here we see all the

1033
00:43:52,710 --> 00:43:58,650
time I don't want to see these anymore I

1034
00:43:54,660 --> 00:44:02,640
want to work on the hard stuff you bring

1035
00:43:58,650 --> 00:44:04,049
Trimark and make us work but the defend

1036
00:44:02,640 --> 00:44:06,779
and attack errs and red teamers make

1037
00:44:04,049 --> 00:44:09,150
them work too we want to do that but we

1038
00:44:06,780 --> 00:44:10,770
can remove these off users and change

1039
00:44:09,150 --> 00:44:13,500
the way that the permissions are puts

1040
00:44:10,770 --> 00:44:14,880
flip the permission model on its head we

1041
00:44:13,500 --> 00:44:17,309
can change it we want to test first

1042
00:44:14,880 --> 00:44:19,650
audit first get the data first then go

1043
00:44:17,309 --> 00:44:22,230
into block make sure our DC storage is

1044
00:44:19,650 --> 00:44:24,299
encrypted and please monitor you see

1045
00:44:22,230 --> 00:44:27,540
reboots and potential for modifying the

1046
00:44:24,299 --> 00:44:31,520
dip some of my time thank you very much

1047
00:44:27,540 --> 00:44:32,259
for you for for yours la vie dirty con

1048
00:44:31,520 --> 00:44:37,288
[Music]

1049
00:44:32,260 --> 00:44:37,289
[Applause]

1050
00:44:37,550 --> 00:44:41,690
on the hallway if you're quick

