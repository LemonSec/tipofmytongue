1
00:00:00,000 --> 00:00:06,299
my name is our Conrad walking my talk a
little bit about me I my father and uh I

2
00:00:06,299 --> 00:00:11,550
run a small company called back your
communications and we do pentesting

3
00:00:11,550 --> 00:00:16,379
instead of handling that kind of stuff
and lately a lot of hunting in fact my

4
00:00:16,379 --> 00:00:20,670
work shifted to mostly blue now I
probably spend one third of my time red

5
00:00:20,670 --> 00:00:27,210
teaming to third Blue teaming come on
squeeze in some other folks want to get

6
00:00:27,210 --> 00:00:31,710
in so I would appreciate that that bc
thank you

7
00:00:32,308 --> 00:00:36,899
so I saw you know Carlos is talked
yesterday but purple team in a that's

8
00:00:36,899 --> 00:00:38,489
what I've been doing

9
00:00:38,489 --> 00:00:42,180
we call it catch me if you can if it's
actually time to the end of the pen test

10
00:00:42,180 --> 00:00:45,960
will do value-added or sit down with
your sock and show them all things they

11
00:00:45,960 --> 00:00:50,820
missed and showing the events to look at
and then there's still time left

12
00:00:50,820 --> 00:00:54,719
we'll come back in again unannounced and
pretty much rerun the same thing we did

13
00:00:54,719 --> 00:00:59,219
previously seeing if that was effective
and use the second time in same thing

14
00:00:59,219 --> 00:01:03,359
don't see it and then the executive
start asking hard questions about what

15
00:01:03,359 --> 00:01:07,860
the Sox actually doing all day and we
always try to rescue that saw cannot

16
00:01:07,860 --> 00:01:13,560
have to get shut down and outsourced
cetera so that this this talk was

17
00:01:13,560 --> 00:01:17,790
inspired by and I'll talk i did i do
want to point out this code is already

18
00:01:17,790 --> 00:01:24,390
on github check it out if you go to my
site or Conrad com the first hit is a

19
00:01:24,390 --> 00:01:28,140
copy of this talk you can download to
talk two slides download the code

20
00:01:28,140 --> 00:01:32,610
download all the GPX files generated for
this talk and look at him you don't use

21
00:01:32,610 --> 00:01:37,380
my tools use EBT x-files you know in
just a min your sim see what happens in

22
00:01:37,380 --> 00:01:39,570
a sense says nothing it's wrong

23
00:01:39,570 --> 00:01:44,398
so all this stuff's online i want to see
as actual as possible in a monday

24
00:01:44,399 --> 00:01:48,450
morning value and it's really easy era
Conrad common just google my name i'm

25
00:01:48,450 --> 00:01:54,060
usually first hit and if you go there
the length of the github site and here's

26
00:01:54,060 --> 00:01:58,439
a good observer so i was updating the
code as of yesterday i was watching some

27
00:01:58,439 --> 00:02:04,258
of talks here on powershell and new
techniques and talk tomorrow and invoke

28
00:02:04,259 --> 00:02:08,848
obfuscation that caught my eye on
Twitter and updated a tool to catch this

29
00:02:08,848 --> 00:02:12,329
stuff so I want this stuff to be as
accurate as possible use the tool not

30
00:02:12,330 --> 00:02:13,740
the techniques described

31
00:02:13,740 --> 00:02:30,780
use the many sims alright and uh other
walks of life from ICS and instructor

32
00:02:30,780 --> 00:02:35,910
I'm Kohli to the blue team operation
curriculum author of the cissp study

33
00:02:35,910 --> 00:02:40,079
guide in the 11th hour guide so again
thanks to all the talks in the ETA X

34
00:02:40,080 --> 00:02:43,200
Files you can download this stuff use it
play with it

35
00:02:43,200 --> 00:02:47,100
these all the GPX files while the
shorter ones there are some that are

36
00:02:47,100 --> 00:02:51,480
called many dash events that was me is
beating on a Windows 7 p.m. relentlessly

37
00:02:51,480 --> 00:02:56,609
for four weeks really and the big ones
are all that stuff in in those are

38
00:02:56,610 --> 00:03:00,210
malleable lots of normal system events
the shorter ones like the ones with

39
00:03:00,210 --> 00:03:02,460
metasploit in powerschool in front of
them

40
00:03:02,460 --> 00:03:05,850
those are very narrow in that I'll clear
the event log attack the system say

41
00:03:05,850 --> 00:03:10,140
export the log so those are very very
actionable the signal-to-noise ratio is

42
00:03:10,140 --> 00:03:15,720
very high and again if you feed these
into your sim or whatever and they don't

43
00:03:15,720 --> 00:03:16,620
catch stuff

44
00:03:16,620 --> 00:03:21,090
well you need to dig deeper and I love
your feedback obvious and github the

45
00:03:21,090 --> 00:03:27,150
requested this is a call it a good bata
bata 0.1 version a good proof of concept

46
00:03:27,150 --> 00:03:30,210
but there's certainly tons of room for
improvement including the output engine

47
00:03:30,210 --> 00:03:34,140
right now is it very very basic but it
demonstrates the point that i believe it

48
00:03:34,140 --> 00:03:37,739
works so here's a quote i think about a
lot

49
00:03:37,740 --> 00:03:43,560
Louis Brandeis Brandeis University Fame
sunlight is the best disinfectant and he

50
00:03:43,560 --> 00:03:47,820
said that well i'm paraphrasing his a
bit longer this little punch here and uh

51
00:03:47,820 --> 00:03:52,380
I think about that the the red team and
the blue team prevention and the all

52
00:03:52,380 --> 00:03:56,730
prevent defense that we see time and
time again for 5,000 warmly embraced the

53
00:03:56,730 --> 00:04:01,410
all prevent defense set and forget
mentality appliances services shiny

54
00:04:01,410 --> 00:04:05,549
boxes and they're all failing virtually
all the feeling i was spending more

55
00:04:05,550 --> 00:04:08,640
money than we have an infosec in fact
we've been around awhile like i have

56
00:04:08,640 --> 00:04:11,700
started it scared a little bit of
started start to feel a little frosty

57
00:04:11,700 --> 00:04:15,660
little bubbly to me you know and having
kids were previous bubble that left

58
00:04:15,660 --> 00:04:19,529
scars so the money's flooding and
technologies flooding in the basic

59
00:04:19,529 --> 00:04:24,599
lesson still aren't learn such as know
that network and the stubborn refusal by

60
00:04:24,600 --> 00:04:27,430
most of 45,000 to refuse

61
00:04:27,430 --> 00:04:33,009
to learn that Network focus my mind it
just boggles my mind and that there's no

62
00:04:33,009 --> 00:04:36,610
no I network is a service provider out
there you know you have to learn it you

63
00:04:36,610 --> 00:04:40,060
have to have skin in the game you have
to want to spend that thing and as we

64
00:04:40,060 --> 00:04:43,090
homes pointed out you know defense is
heartbreaking stuff's easy and don't get

65
00:04:43,090 --> 00:04:44,739
me wrong I love breaking stuff

66
00:04:44,740 --> 00:04:48,759
pentesting it's unbridled joy the pen
testing himself another report writing

67
00:04:48,759 --> 00:04:53,020
the travel but I have other than that it
is unbridled joy to hack stuff and

68
00:04:53,020 --> 00:04:57,849
people paying tax stuff and I enjoy that
truly thats that expression of hacking

69
00:04:57,850 --> 00:05:02,259
and the more true sense is wonderful but
breaking stuff is easy and fixing stuff

70
00:05:02,259 --> 00:05:06,759
is hard and as i get older and hopefully
a little wiser i'm drawn more to fixing

71
00:05:06,759 --> 00:05:11,830
stuff too hard a challenge you know it
does the hundred pentester Rorschach on

72
00:05:11,830 --> 00:05:15,669
our campaign it's still fun don't get me
wrong but I want to make a difference

73
00:05:15,669 --> 00:05:18,880
and I come back a year later the same
company do the same things or a week

74
00:05:18,880 --> 00:05:22,780
later when I tell them here's exactly
what I did I did this I did this I did

75
00:05:22,780 --> 00:05:25,119
this I did this and they still miss it

76
00:05:25,120 --> 00:05:28,720
what are things we see is compliance
sims compliant socks

77
00:05:28,720 --> 00:05:32,500
you know I'm if you serve the gods of
compliance exclusively you will fail

78
00:05:33,039 --> 00:05:36,460
compliance is not security if you draw a
Venn diagram of compliance and security

79
00:05:36,460 --> 00:05:40,870
compliance is partly inside part of the
outside the security bubble and it's

80
00:05:40,870 --> 00:05:44,740
much smaller grab it so if you have
these compliance talks with clients

81
00:05:44,740 --> 00:05:48,699
10,000 systems running some sort of
mcafee or Symantec endpoint protection

82
00:05:48,699 --> 00:05:54,909
sweet as sugar reading over a thousand
logs today x 10000 devices although one

83
00:05:54,909 --> 00:06:00,400
sim so if you just kept hammering your
sim so a thousand-plus logs pretty this

84
00:06:00,400 --> 00:06:05,229
is unaffected systems are talking about
right x 10000 systems you're shoveling

85
00:06:05,229 --> 00:06:10,000
all that to a giant compliance in that
sometimes my client has been north of a

86
00:06:10,000 --> 00:06:13,240
million dollars on this kind of
technology and one of the things most

87
00:06:13,240 --> 00:06:15,909
awesome vendors and consultants do what
if you doing this

88
00:06:15,909 --> 00:06:20,259
please stop arm you build it you tend to
grab the the biggest buckets of the

89
00:06:20,259 --> 00:06:24,340
easiest data leave a connector for this
we are connected for that you shall the

90
00:06:24,340 --> 00:06:28,659
data in there is no real use case for
malice versus non malice that told you

91
00:06:28,659 --> 00:06:33,340
to engage in the clients is so on what
eventually look for and here's what most

92
00:06:33,340 --> 00:06:36,969
consultant say hey that's what you
decide you need to decide what's

93
00:06:36,969 --> 00:06:40,780
important to you know what you look for
like giving eventid know

94
00:06:40,780 --> 00:06:44,770
home you should decide that because only
use one more money in their pockets

95
00:06:44,770 --> 00:06:48,310
the client is no idea what to do and
they struggle you you throw a kid in a

96
00:06:48,310 --> 00:06:49,060
sock

97
00:06:49,060 --> 00:06:52,060
copy

98
00:07:08,660 --> 00:07:26,510
hi folks I'm here unfortunately audio
drops out to about the nine-minute 12

99
00:07:26,510 --> 00:07:29,510
second mark driving environments

100
00:09:20,450 --> 00:09:25,280
powershell team to the rescue

101
00:09:26,030 --> 00:09:29,030
powershell team to the rescue

102
00:09:30,980 --> 00:09:37,310
alright hey online folks I'm sorry .
later one issues so now result so if

103
00:09:37,310 --> 00:09:40,280
you're online i was just kind of
freestyling on this slide we didn't miss

104
00:09:40,280 --> 00:09:40,970
much

105
00:09:40,970 --> 00:09:45,230
so um these the eventual look for so
talk to inspire this was that deadly

106
00:09:45,230 --> 00:09:49,280
events and then we need to dig deeper
right we need to go deeper look deeper

107
00:09:49,280 --> 00:09:52,970
it turns out medically creative service
names like this because you're avoiding

108
00:09:52,970 --> 00:09:57,770
blacklisting it was met SVC every time
some enterprising blacklisting vendor

109
00:09:57,770 --> 00:10:01,939
blacklist that thing right so you may
randomly generated but turns out had 16

110
00:10:01,940 --> 00:10:07,670
characters long upper lower only alpha
only right and it's easy for human a

111
00:10:07,670 --> 00:10:11,180
spot that but I don't want human look at
every service creation about right

112
00:10:11,690 --> 00:10:15,290
you look at all service creation events
but that's gonna be noisy right so what

113
00:10:15,290 --> 00:10:19,189
do we do we start looking for patterns
and luckily powershell the regex

114
00:10:19,190 --> 00:10:24,650
supported strong- redexes for a long
time it is solid it is not quite pearl

115
00:10:24,650 --> 00:10:27,949
strong but it's python strong meaning
it's still awesome right

116
00:10:27,950 --> 00:10:32,330
I think girl is the best expression
old-school I know me and Conrad I know I

117
00:10:32,330 --> 00:10:37,100
know like my cold dead hands and all
that but I regex is support on

118
00:10:37,100 --> 00:10:41,780
powershell is robust that's what drew me
deeper down the powershell labyrinth was

119
00:10:41,780 --> 00:10:45,199
the regex support mike this is pretty
awesome a little unexpectedly awesome

120
00:10:45,200 --> 00:10:50,810
cool and thus began my voyage of an
old-school unix dude learning power show

121
00:10:50,810 --> 00:10:56,359
so we've seen an evolution of payloads
and uh as we pointed out yesterday

122
00:10:56,990 --> 00:11:00,740
it's powershell isn't giving us all post
exploitation were primarily sing right

123
00:11:00,740 --> 00:11:04,400
so the vector the exploit is in
powershell powershell just there

124
00:11:04,400 --> 00:11:08,300
afterwards right and it's better than
CMD it's better than vbscript is better

125
00:11:08,300 --> 00:11:12,500
than all that stuff the same hour using
powershell on Windows is like saying

126
00:11:12,500 --> 00:11:16,400
malware uses bash on linux you know
which is it's there it's the shell an

127
00:11:16,400 --> 00:11:17,209
awesome show

128
00:11:17,210 --> 00:11:23,540
I'm and uh so we've evolved now the the
corporate antivirus solutions have a

129
00:11:23,540 --> 00:11:27,770
goal line defense against dropping that
fat exe and running it so all your

130
00:11:27,770 --> 00:11:31,430
corporate offense is your typical
preventive defenses are like this goal

131
00:11:31,430 --> 00:11:33,920
on defense don't want that easy drop

132
00:11:33,920 --> 00:11:38,569
sure that thing that's a pretty easy use
case so the old native upload forearm

133
00:11:38,570 --> 00:11:43,970
metasploit right and uh so they're
migrating to power show powershell cuz

134
00:11:43,970 --> 00:11:46,579
they're powershell because it's
whitelisted if you are using

135
00:11:46,579 --> 00:11:50,180
whitelisting powershell because it's
used mostly of course by benign software

136
00:11:50,180 --> 00:11:56,180
and there's not a lot of logging by
default easy to fix the right and again

137
00:11:56,180 --> 00:12:00,739
they don't touch the file system they
are they run a big one command like this

138
00:12:00,740 --> 00:12:06,740
this is medical interpreter dropping
with the newer style powershell target

139
00:12:06,740 --> 00:12:12,740
so we choose target powershell which is
now default0 it will do this and that

140
00:12:12,740 --> 00:12:16,970
thing as long as you see and once you
see it now you're not going to see this

141
00:12:16,970 --> 00:12:18,230
by default

142
00:12:18,230 --> 00:12:22,940
however want to turn on some additional
login which i recommend you will and it

143
00:12:22,940 --> 00:12:27,199
stands out like the nose on your face
that is a base64 encoded will first

144
00:12:27,199 --> 00:12:33,589
compressed then base64 encoded command
line that turns out is over our 2400

145
00:12:33,589 --> 00:12:38,540
flights doesn't want the stuff is hidden
window no profile often we see this

146
00:12:38,540 --> 00:12:41,930
exact thing with cmd launching
powershell which is great actually

147
00:12:41,930 --> 00:12:45,469
because there's more visibility no
sunlight is the best disinfected

148
00:12:45,470 --> 00:12:51,050
inevitably are preventive tools will lap
right prevention will always lag the

149
00:12:51,050 --> 00:12:53,870
latest greatest the taps because you
only we have those preventive controls

150
00:12:53,870 --> 00:12:58,910
attacks happen they work we study the
use case months later years later he's a

151
00:12:58,910 --> 00:13:03,319
tool right and here's a prevention but
what I realized you have to be more

152
00:13:03,320 --> 00:13:05,990
nimble and one of the things I'm very
lucky i was talking about reading

153
00:13:05,990 --> 00:13:10,550
machine CSO opportunity to Virginia Tech
University i spent two-and-a-half years

154
00:13:10,550 --> 00:13:14,180
working at boss university in the
nineties every infosec professional

155
00:13:14,180 --> 00:13:17,959
would benefit from a two-year tour of
duty a dotted you you really well you

156
00:13:17,959 --> 00:13:22,819
can't block it all starts coming in when
you realize you have to be tactical you

157
00:13:22,819 --> 00:13:26,689
have to be nimble you know compromise is
not the end is the beginning right at

158
00:13:26,690 --> 00:13:30,500
the beginning of the fight and that
fight to me is very very interesting

159
00:13:30,500 --> 00:13:35,209
right so this is a very hard once you
see it it jumps out at you

160
00:13:35,209 --> 00:13:42,439
so John command powershell launched by
CMD as i mentioned previously compressed

161
00:13:42,440 --> 00:13:45,260
and basically four encoded function

162
00:13:45,260 --> 00:13:48,439
once you unwrap all that is what you get

163
00:13:48,440 --> 00:13:51,890
so this is actually happening powershell
function i know it's a nice sharp i was

164
00:13:51,890 --> 00:13:55,640
trying to impress upon you the the size
of all this the command line again

165
00:13:55,640 --> 00:13:57,380
there's no file in the system

166
00:13:57,380 --> 00:14:00,890
there's nothing 482 squash on the file
system yet now i'm a change that later

167
00:14:00,890 --> 00:14:06,110
of course right and the function names
are randomly generated it looks quite

168
00:14:06,110 --> 00:14:10,550
odd and again the ETA X Files I shared
on github are folded stuff so you wanna

169
00:14:10,550 --> 00:14:15,589
have a higher fidelity of you dive into
it get one events filter hashtable you

170
00:14:15,590 --> 00:14:20,930
know you'll see this stuff very very
clearly he is a powershell powersports

171
00:14:20,930 --> 00:14:25,760
rather everyone's favorite tool of
courses are many cats anyway get me cats

172
00:14:25,760 --> 00:14:31,010
going i'm getting any cats going I think
Mannion entrance 2015 said in virtually

173
00:14:31,010 --> 00:14:35,689
every engagement we have powershell was
dropped in the system right so the

174
00:14:35,690 --> 00:14:38,510
attack is running power show for all the
obvious reasons you want to plan takes

175
00:14:38,510 --> 00:14:42,350
passwords golden ticket attacks all that
kind of stuff so we want to watch for

176
00:14:42,350 --> 00:14:47,060
this is a couple ways to do it you can
just do the net . web clients which is

177
00:14:47,060 --> 00:14:51,949
one way to leave no footprints or less
footprints and it's a way too busy

178
00:14:51,950 --> 00:14:56,690
downloading script and run it and you
might say okay if I cps one being

179
00:14:56,690 --> 00:15:01,040
downloaded the problems that have to be
ps1 so below that is a short URL that's

180
00:15:01,040 --> 00:15:05,150
actually that's about one of my web
service that i use and a file called 17

181
00:15:05,150 --> 00:15:10,370
it's not actually redirect its natural
down so far called 17 that contains a

182
00:15:10,370 --> 00:15:15,860
copy of invoke many cats it was no ps1
is a fairly short command but it uses

183
00:15:15,860 --> 00:15:22,520
this net web web client download string
which is equivalent to say curl or w get

184
00:15:22,520 --> 00:15:26,600
or fetch step on Windows now native
built-in functionality

185
00:15:28,130 --> 00:15:32,930
so why the attack frameworks doing this
it works and it's pretty invisible and

186
00:15:32,930 --> 00:15:36,050
you can get super advanced tools and I
love something advanced talks but my

187
00:15:36,050 --> 00:15:38,540
mind keeps going back to where the
rubber meets the road

188
00:15:38,540 --> 00:15:42,290
what does my average client have it
doesn't have that special snowflake the

189
00:15:42,290 --> 00:15:45,500
Johnson reference in the last hours talk
right you don't have that magic

190
00:15:45,500 --> 00:15:49,880
snowflake you don't have that ninja like
me or you you get an average person to

191
00:15:49,880 --> 00:15:54,140
get to a day right so what can I
recommend for them and we can say old

192
00:15:54,140 --> 00:15:59,330
get silence get set in a wad get carbon
black and they don't know they have much

193
00:15:59,330 --> 00:16:03,440
much more basic needs you know I'm drawn
to that problem you know because

194
00:16:03,440 --> 00:16:06,830
everyone was there at one point I was a
clueless new but everyone else was too

195
00:16:06,830 --> 00:16:11,240
in this room right and I'm drawn to that
and I want to help that person i want

196
00:16:11,240 --> 00:16:14,870
that person to be successful because
ultimately it's really not that hard and

197
00:16:14,870 --> 00:16:18,110
that's what kills me all these billions
of dollars just flushing away want to

198
00:16:18,110 --> 00:16:22,190
really bad places like 10 things about
cybercrime where does that money go bad

199
00:16:22,190 --> 00:16:22,910
places

200
00:16:22,910 --> 00:16:26,360
bad things happen with that money and I
think about that as a moral issue most

201
00:16:26,360 --> 00:16:31,550
people don't but I do and I want to help
that person and so um what what

202
00:16:31,550 --> 00:16:37,729
recommendations can I make on window 7
now the easiest recommendation is they

203
00:16:37,730 --> 00:16:38,360
go to 10

204
00:16:38,360 --> 00:16:41,870
yes of course yeah it's going to end
okay thanks you know that'll be ten

205
00:16:41,870 --> 00:16:45,350
thousand dollars please annelida I'm
you're not being a good start by saying

206
00:16:45,350 --> 00:16:50,330
that cuz my client still of XP um some
do but I'm the windows seven you know

207
00:16:50,330 --> 00:16:54,890
it's solid it lacks some of the features
of Windows 10 has I have to give mad

208
00:16:54,890 --> 00:16:57,439
props the microsoft for Eminem is just
amazing

209
00:16:57,440 --> 00:17:01,520
you're not using a minute you're making
a mistake it's amazing and Microsoft

210
00:17:01,520 --> 00:17:04,010
could be like yeah you know you want the
new cool stuff

211
00:17:04,010 --> 00:17:07,730
Windows 10 and they didn't say that
though they said you know what will

212
00:17:07,730 --> 00:17:11,329
backport this stuff will back for all
this stuff you know and I you know heaps

213
00:17:11,329 --> 00:17:17,270
protection Rob stuff back to windows 7
and that's beautiful that's beautiful

214
00:17:17,270 --> 00:17:21,349
so I wanted a sweet spot for actual
stuff you do back at work on Monday

215
00:17:21,349 --> 00:17:24,770
without having to install a whole bunch
of stuff or buy anything right

216
00:17:24,770 --> 00:17:28,010
I like quote living off the land as
consultants we have to live off the land

217
00:17:28,010 --> 00:17:36,110
right let's live off the land the single
most awesome event a recent interest is

218
00:17:36,110 --> 00:17:39,979
full native command-line logging are on
windows 7 natively

219
00:17:40,610 --> 00:17:45,530
it is amazing it's been a year and a
half old dish and I it's not default

220
00:17:45,530 --> 00:17:50,629
settings you have to change two things
but all my clients sites and not all of

221
00:17:50,630 --> 00:17:54,710
them have the ninjas i mentioned it
works like I have to do anything other

222
00:17:54,710 --> 00:17:56,240
than all these two things right

223
00:17:56,240 --> 00:18:01,400
I didn't do anything and i can say make
you gpo changes in book now I haven't

224
00:18:01,400 --> 00:18:11,059
4688 and this event is a beautiful it is
now other one caveat logs everything

225
00:18:11,059 --> 00:18:15,168
everything on the command line including
perhaps passwords so there's a risk

226
00:18:15,169 --> 00:18:19,220
analysis to perform here there's a
security log in so meaning natively

227
00:18:19,220 --> 00:18:23,570
local you have to be advocacy that
anyways there should be applied level

228
00:18:23,570 --> 00:18:27,590
trust a stock i believe there should be
as all of us as in most professionals we

229
00:18:27,590 --> 00:18:31,549
often pretty too sensitive things but
you should turn this on because the

230
00:18:31,549 --> 00:18:36,230
visibility it gives you is crazy awesome
and again sunlight is the best

231
00:18:36,230 --> 00:18:40,549
disinfected here's your sunlight right
I'll try powershell Empire I was trying

232
00:18:40,549 --> 00:18:46,070
PS attack nothing like nothing it
normally when you have a breach you know

233
00:18:46,070 --> 00:18:51,530
the dwell time I think 147 days /
mandiant in 2016 the whole time of

234
00:18:51,530 --> 00:18:54,320
course how long the attackers on your
network before someone else tells you

235
00:18:54,320 --> 00:18:59,809
two thirds of the time right and 247
days and i'm normally when you go into

236
00:18:59,809 --> 00:19:03,889
look at that stuff you post instead of
handling how do they know 242 days yet

237
00:19:03,890 --> 00:19:08,330
there was this minute the second click
etc right well what if there's nothing

238
00:19:08,330 --> 00:19:12,740
there now again this is post
exploitation so something that already

239
00:19:12,740 --> 00:19:17,419
happened the boxes on patch user click
whatever layer eight strikes but then

240
00:19:17,419 --> 00:19:21,020
afterwards a lot of this post
exploitation is actually invisible and

241
00:19:21,020 --> 00:19:26,570
4688 gives you that sunlight and let you
see this stuff it is in my opinion the

242
00:19:26,570 --> 00:19:30,980
best events if you put a gun to my head
sock I'm problem you put a gun to my

243
00:19:30,980 --> 00:19:35,059
head and talking shit you only get one
event that's a 40-60 yes sir

244
00:19:35,059 --> 00:19:39,830
yes isn't available in service to is a
question yes

245
00:19:39,830 --> 00:19:44,000
yeah it's pretty amazing a lot of people
don't know about its new newer year plus

246
00:19:44,000 --> 00:19:48,020
but windows 7 plus has it in fact again
all Mike it was a patch about a year

247
00:19:48,020 --> 00:19:52,070
plus ago but all my client systems along
with a passion a year if not different

248
00:19:52,070 --> 00:19:53,299
discussion obviously

249
00:19:53,299 --> 00:19:59,389
yeah it's amazing to consider the risk
of exposing data this way but I my

250
00:19:59,389 --> 00:20:05,508
biased opinion is well worth that small
risk to get the visibility you want you

251
00:20:05,509 --> 00:20:10,039
doing that what you look for a really
really long commands and the beauty of

252
00:20:10,039 --> 00:20:11,450
really really long commands

253
00:20:11,450 --> 00:20:15,889
it's not a signature heads behavior you
know and as we all know blacklist fail

254
00:20:15,889 --> 00:20:20,600
now to be fair how deep blue sea lion
has a blacklist I was a series of regex

255
00:20:20,600 --> 00:20:26,330
is right to blacklist fail but we have a
combination like net web client download

256
00:20:26,330 --> 00:20:30,080
string will look for that looked real
along commands will look for base64

257
00:20:30,080 --> 00:20:35,059
encoded stuff will look for base64
compressed and base64 encoded commands

258
00:20:35,059 --> 00:20:40,489
will look for use of the c-sharp
compiler and the cbt res . exe heavily

259
00:20:40,489 --> 00:20:42,259
have a used by PS attack

260
00:20:42,259 --> 00:20:45,619
PS attack is invisible to do this and
then it's everywhere it's blatant it's

261
00:20:45,619 --> 00:20:50,749
loud right its herd of elephants loud
the windows script host command-line see

262
00:20:50,749 --> 00:20:57,379
script on dl the usual menagerie of
malware and the beauty of this is pen

263
00:20:57,379 --> 00:21:01,369
testing tools do this no I said in John
stalk last hour and he said this in her

264
00:21:01,369 --> 00:21:05,238
most most of these tools to tecpan
Chester's which is cool but guess what

265
00:21:05,239 --> 00:21:10,399
most people get on by pentester they get
on here so i thought a lot about that

266
00:21:10,399 --> 00:21:14,869
when he said that Michael you're exactly
right but behaviorally malware does is

267
00:21:14,869 --> 00:21:16,279
to for sure

268
00:21:16,279 --> 00:21:20,359
and again this gives you the necessary
sunlight I think if you had one command

269
00:21:20,359 --> 00:21:25,460
to look at one event to look at I this
is the one to look at but also to

270
00:21:25,460 --> 00:21:29,749
powershell logging now again my use case
was windows seven I wanted to be actual

271
00:21:29,749 --> 00:21:35,029
my clients and Windows 10 is awesome as
i said i have 4g powershell 2127 with

272
00:21:35,029 --> 00:21:40,009
very little log go to powershell for you
get better logging your power 05 even

273
00:21:40,009 --> 00:21:43,580
better logging our show for is good
enough actually for me you can get it

274
00:21:43,580 --> 00:21:47,749
running pretty painlessly on windows 7 I
did try again powershell five on windows

275
00:21:47,749 --> 00:21:52,129
7 sp1 i tried three times and I
partially failed three times now

276
00:21:52,129 --> 00:21:57,320
hopefully copper layer 8 of that was me
i'm partial five work but going to floor

277
00:21:57,320 --> 00:22:01,279
it worked in the logging work 15 I broke
the logging three times in a row and I

278
00:22:01,279 --> 00:22:04,730
sure did something wrong but again my
metric is if I can't figure it out and

279
00:22:04,730 --> 00:22:07,049
read a time for this talk my god I'll
punch

280
00:22:07,049 --> 00:22:10,649
my clients will probably have the same
problem so it turns out for is good

281
00:22:10,649 --> 00:22:15,299
enough and if you figure out how to get
going on five with logging attack please

282
00:22:15,299 --> 00:22:20,039
contact me like the night and but for
good enough but it turns out I thought

283
00:22:20,039 --> 00:22:23,549
powershell logs gonna be really really
keeping most of them hours using cmd to

284
00:22:23,549 --> 00:22:27,239
launch powershell already have the
visibility for a minute then 468 right

285
00:22:27,239 --> 00:22:31,259
I'm already there so it gives us more
visibility more sunlight which are like

286
00:22:31,259 --> 00:22:37,350
as i mentioned image his Rob choice
tailored access operations group haven't

287
00:22:37,350 --> 00:22:40,799
seen us use next video Google NSA use
next video is pretty amazing

288
00:22:41,369 --> 00:22:45,480
maybe we know that stuff my clients
don't you know the myth the zero-day 90

289
00:22:45,480 --> 00:22:49,379
days existing are quite like yetis or
anything but we all know it's not that

290
00:22:49,379 --> 00:22:51,509
hard right now that huh

291
00:22:51,509 --> 00:22:55,980
you don't need 20 days when uh they have
always on patch stuff it makes . about

292
00:22:55,980 --> 00:22:59,369
nobody networking on the kind of stuff
he talks about Emmett he's like install

293
00:22:59,369 --> 00:23:02,820
it you know that's we need to as
defenders as blue chambers you need to

294
00:23:02,820 --> 00:23:06,330
look for these asymmetries things that
you can do to make the attackers job

295
00:23:06,330 --> 00:23:10,769
exponentially harder that are easy for
you so it takes me 10 minutes it takes

296
00:23:10,769 --> 00:23:15,480
the attacker 24 hours now I'm winning
and if I have Emmett what the probably

297
00:23:15,480 --> 00:23:19,679
do is line up and like a Christmas tree
and then try to bypass it and we'll talk

298
00:23:19,679 --> 00:23:23,399
about the perfect solution fallacy very
shortly and people are all well do this

299
00:23:23,399 --> 00:23:27,570
the bypass them yes after tripping over
a minute and i'm watching for that its

300
00:23:27,570 --> 00:23:31,019
application event to service writer
Emmett so if you're looking for that

301
00:23:31,019 --> 00:23:34,529
your stock knows now you know if he
spray just killed something that's are

302
00:23:34,529 --> 00:23:36,179
heaps praying and killed it

303
00:23:36,179 --> 00:23:41,489
that should be a live event your sock
rep so the logs are actionable here it

304
00:23:41,489 --> 00:23:46,109
is provided a method id2 and I want to
get powershell examples because that's

305
00:23:46,109 --> 00:23:50,399
what they are here is my ghetto you
splunk i use our site fine security log

306
00:23:50,399 --> 00:23:52,229
application log sorry

307
00:23:52,230 --> 00:23:57,359
provide a name and ID to your spunk your
arcsight your QQ radar that can find

308
00:23:57,359 --> 00:24:02,549
this stuff right so I think about the
technique not necessarily the tool so

309
00:24:02,549 --> 00:24:08,908
you know that the script was born out of
need my clients when again the list the

310
00:24:08,909 --> 00:24:14,669
deadly events look for these 10 and I
don't look for 11 till I master 210 and

311
00:24:14,669 --> 00:24:18,840
what everyone those 10 has a use case
I'm not shopping a thousand times 10,000

312
00:24:18,840 --> 00:24:20,199
large to assume

313
00:24:20,200 --> 00:24:24,190
asking to junior stopped of a muddle
through that so every event in my sock

314
00:24:24,190 --> 00:24:31,990
has a sim has a has a use case are and i
wanted to him the script and say here

315
00:24:31,990 --> 00:24:36,130
just run this its native its power shall
run it is going to talk about some

316
00:24:36,130 --> 00:24:42,850
interesting stuff so I logging new
process creation very easy however many

317
00:24:42,850 --> 00:24:46,928
many processes launched on windows every
single day okay so now you generate a

318
00:24:46,929 --> 00:24:51,250
lot of data I want quality not quantity
so we need a way to cut through that and

319
00:24:51,250 --> 00:24:55,419
i told my clients hey look a really long
commander base64 encoded stuff like how

320
00:24:55,419 --> 00:25:02,049
do i do that i read a script no crickets
you know his transcript crickets I'm and

321
00:25:02,049 --> 00:25:05,590
it's again maybe you that magic
snowflake the John strand reference last

322
00:25:05,590 --> 00:25:09,970
hour if you're like a ninja writing
scripts in a sock your you're very

323
00:25:09,970 --> 00:25:15,639
unusual we have people entering stuff in
GUI Xin Sox large large until mostly

324
00:25:15,639 --> 00:25:20,590
right so also i noticed and socks their
way to abstract from the source data you

325
00:25:20,590 --> 00:25:24,879
know the decentralized centralized
centralized and just all this data two

326
00:25:24,880 --> 00:25:29,110
connectors get too far from the source
data like most folks don't have full

327
00:25:29,110 --> 00:25:32,469
packet capture his full packet capture
that doesn't centralized easily you know

328
00:25:32,470 --> 00:25:37,929
and so they actually rejected because
it's it's in this one box here or not

329
00:25:37,929 --> 00:25:41,950
right there goes in that box so we don't
look at it so you end up rejecting her

330
00:25:41,950 --> 00:25:46,179
perfectly good data so I like to always
make sure someone in your sock is closer

331
00:25:46,179 --> 00:25:50,590
to that data now maybe a junior staffer
entering are you know arcs I queries but

332
00:25:50,590 --> 00:25:54,908
a more senior experienced person blue
team ER they should be close to the data

333
00:25:54,909 --> 00:26:01,029
right and so I said write a script and
ultimately and I realized if they're not

334
00:26:01,029 --> 00:26:06,130
gonna do it how you better advice so I
said I read the script it was an honest

335
00:26:06,130 --> 00:26:10,960
he was a learning journey right as a
unix system from way way back

336
00:26:11,590 --> 00:26:15,939
it was definitely a journey of discovery
it's only about 350 lines of PowerShell

337
00:26:15,940 --> 00:26:19,389
so it's hardly a monster project that's
like three and twenty lines more than

338
00:26:19,389 --> 00:26:24,399
i've written before and one shot you
know I everyone talks about powershell

339
00:26:24,399 --> 00:26:27,729
objects and how you center near isn't
powerful objects makes them cry but the

340
00:26:27,730 --> 00:26:31,779
powerful right objects and more powerful
text you know powershell is more

341
00:26:31,779 --> 00:26:33,860
powerful about yes i can say that your
be

342
00:26:33,860 --> 00:26:40,760
that and a few trips the wave functions
return data is well different

343
00:26:40,760 --> 00:26:46,309
uh-huh and I kept having these assume
biases running powershell I for example

344
00:26:46,309 --> 00:26:49,129
assume there's no plus $OPERAND equals
in powershell because some of the

345
00:26:49,130 --> 00:26:52,429
language the power she reminds me up
didn't plus $OPERAND equals one-half the

346
00:26:52,429 --> 00:26:56,480
project not using plus $OPERAND equals
and I'm like hey plus awesome

347
00:26:56,480 --> 00:27:01,880
I things like that right but um and
ultimately ok with his party's object is

348
00:27:01,880 --> 00:27:06,169
XML parsing XML look for these things
and easy right and it's not quite that

349
00:27:06,169 --> 00:27:10,970
easy now it's not nasty hard either but
the person gets a little tricky some of

350
00:27:10,970 --> 00:27:15,350
the arm events really well parsed nice
little tree of xml go down some events

351
00:27:15,350 --> 00:27:19,459
are kind of blobs of texts but luckily
like I said regular expression support

352
00:27:19,460 --> 00:27:23,840
is strong right respect and support
strong so with a regex I can cut through

353
00:27:23,840 --> 00:27:27,409
any blob of text that's what regex is
designed to do carve through blobs of

354
00:27:27,410 --> 00:27:33,470
texts so if the event data here for the
data is my blah blah don't care about

355
00:27:33,470 --> 00:27:40,370
one line of that enter uh powershell to
our projections to say today few design

356
00:27:40,370 --> 00:27:45,020
notes it's designed don't shovel data
into a tool out of a tool i want actual

357
00:27:45,020 --> 00:27:48,918
stuff I want every event to matter i'd
rather have a false negative you know

358
00:27:48,919 --> 00:27:54,320
I'm i really have less than more so I
didn't it wasn't like one big loop is

359
00:27:54,320 --> 00:27:58,189
turning through this stuff each event
type had its own unique code to it

360
00:27:58,190 --> 00:28:01,910
virtually every event type requires its
own code of codes only three four five

361
00:28:01,910 --> 00:28:05,960
lines but i need unique code for each
event which actually makes me move

362
00:28:05,960 --> 00:28:10,880
slower justify the use case in every
single thing that that deep blue sea

363
00:28:10,880 --> 00:28:15,559
lida tex has a malicious use case for it
and those use cases are demonstrated in

364
00:28:15,559 --> 00:28:18,260
the EBT x-files I share with boosie lot

365
00:28:18,260 --> 00:28:22,760
ok so you can see those use cases right
now it's super-crazy basic output i

366
00:28:22,760 --> 00:28:27,140
decided to focus on the features and
demonstrate the hopeful value of this

367
00:28:27,140 --> 00:28:31,970
tool it's the output is amateur some
basic but it works you know and we'll

368
00:28:31,970 --> 00:28:34,669
talk about next steps later Robert deep
blue sea line now that I've gotten this

369
00:28:34,669 --> 00:28:40,610
far to take it further some plants now
speaking of the purpose solution fallacy

370
00:28:41,740 --> 00:28:45,340
we have a lot we find this a lot you
come up with a way to detect something

371
00:28:45,340 --> 00:28:49,209
that people are falling over themselves
to find a use case that will fail you

372
00:28:49,210 --> 00:28:53,260
know like soon as you say application
whitelisting which is actually prevent

373
00:28:53,260 --> 00:28:54,190
technology

374
00:28:54,190 --> 00:28:59,590
hey so I'm getting 100 gonna inject them
our direct around and i don't like yeah

375
00:28:59,590 --> 00:29:04,030
I know and people literally falling over
themselves an effort not to change its

376
00:29:04,030 --> 00:29:07,450
crazy how to change versus many of our
peers are they built whole careers

377
00:29:07,450 --> 00:29:10,900
delaying and stopping change they said
in change management board saying hey we

378
00:29:10,900 --> 00:29:12,280
need to think about this more

379
00:29:12,280 --> 00:29:16,240
hey we need to be prudent you know and
what they're doing they're corrosive so

380
00:29:16,240 --> 00:29:20,350
overly corrosive and harmful to your
security people can't begin to change

381
00:29:20,350 --> 00:29:24,159
management for delaying change I think
I've spent a lot of my career fighting

382
00:29:24,160 --> 00:29:28,450
change our finding people who are
fighting change i should say and uh any

383
00:29:28,450 --> 00:29:32,080
given use case yes Renee meet as many
dogs of course of course

384
00:29:32,080 --> 00:29:35,980
however long commands commands
downloaded through net web client

385
00:29:35,980 --> 00:29:40,660
download string more behavioral mixing
in with the more signature now the we

386
00:29:40,660 --> 00:29:42,309
literally look at the string me cats

387
00:29:42,309 --> 00:29:46,360
yes at the black list can you avoid that
of course you can however can you evade

388
00:29:46,360 --> 00:29:52,178
all of it right so the I've going to
turn the perfect attacker fallacy

389
00:29:52,179 --> 00:29:56,860
this is the omnipotent attacker who will
cycle anticipate every single preventive

390
00:29:56,860 --> 00:30:00,309
a detective measure you deploy
countermeasures deployed and psychically

391
00:30:00,309 --> 00:30:04,629
anticipated and avoided and avoided
without leaving any tracks this person

392
00:30:04,630 --> 00:30:08,500
doesn't exist there miss their cartoon
supervillain right they don't exist

393
00:30:09,070 --> 00:30:13,120
it's not real I don't care for the NSA I
don't care for a cripple hacking gang

394
00:30:13,120 --> 00:30:20,590
I don't care for patients state that
thank you that that that the attacker

395
00:30:20,590 --> 00:30:22,600
isn't that good because they don't have
to be that good

396
00:30:22,600 --> 00:30:26,409
they don't they don't write and I love
Grace Hopper grace hopper is a hero of

397
00:30:26,410 --> 00:30:31,840
mine a true American Hero enlisted in
the navy in 1942 I how to get a waiver

398
00:30:31,840 --> 00:30:36,040
because she was 15 pounds under the
hundred twenty pound weight minimum that

399
00:30:36,040 --> 00:30:40,928
I invented the compiler how to convince
people that computers could do more than

400
00:30:40,929 --> 00:30:47,230
ad right and the term debugging courtesy
of Grace Hopper from a month of course

401
00:30:47,230 --> 00:30:50,980
famously and she spent a lot of her
career fighting change convincing people

402
00:30:50,980 --> 00:30:52,659
that computers could do more than

403
00:30:52,659 --> 00:30:56,440
at convincing people to hate instead of
running the machine code directly we can

404
00:30:56,440 --> 00:30:59,679
write higher level code have the
computer to the rest but what that's

405
00:30:59,679 --> 00:31:04,090
crazy talk you know so she spent lots of
time fighting change or fighting people

406
00:31:04,090 --> 00:31:07,599
who are fighting change right and this
is one of the biggest challenge that

407
00:31:07,599 --> 00:31:11,769
have going into stocks going and talking
about Sims i recommend all the stuff and

408
00:31:11,769 --> 00:31:15,340
people falling over themselves to kind
of find out with a use case that could

409
00:31:15,340 --> 00:31:19,658
evade it and yet anyone control but fail
it's called the perfect solution fallacy

410
00:31:19,659 --> 00:31:24,039
because the person fallacy says a
solution is not useful unless it's

411
00:31:24,039 --> 00:31:27,399
perfect and all use cases we believe
that we wouldn't have firewalls or

412
00:31:27,399 --> 00:31:31,090
antivirus or anything would patch none
of that stuff right so it's clearly a

413
00:31:31,090 --> 00:31:35,738
fallacy you people fall over themselves
to shoot great ideas down so that's one

414
00:31:35,739 --> 00:31:39,099
of the battles i have fought with my
sins of my socks my clients is

415
00:31:39,099 --> 00:31:43,239
convincing them to try something a bit
different so I here's a list of

416
00:31:43,239 --> 00:31:47,619
Detective events designed to be
actionable designed from real-world

417
00:31:47,619 --> 00:31:51,970
events informed by my consulting
post-incident handling when I come into

418
00:31:51,970 --> 00:31:55,989
a little purple team as Carlos Perez
said and I try to try to help i try to

419
00:31:55,989 --> 00:32:00,399
heal i try to fix I've already broken
things now let's spend some time fixing

420
00:32:00,399 --> 00:32:02,379
things and I go to the sock

421
00:32:02,379 --> 00:32:06,549
here's what happened I create a new user
Adam domain admin here's the service was

422
00:32:06,549 --> 00:32:10,359
created when i launched PS exactly is
this here's this here's this Archie

423
00:32:10,359 --> 00:32:16,119
persistence is a registry run key pop
right and so informed from that whether

424
00:32:16,119 --> 00:32:22,178
it's malware or pen testers or whatever
a list of actual list of about 18 or 20

425
00:32:22,179 --> 00:32:27,549
things right that it will automatically
handle all this stuff has a list of

426
00:32:27,549 --> 00:32:32,109
regular expressions you feed it into a
csv file i saw ben ten mentioned that

427
00:32:32,109 --> 00:32:36,309
you could do you do the download string
the file colon whack whack link i didn't

428
00:32:36,309 --> 00:32:36,729
know that

429
00:32:36,729 --> 00:32:41,919
awesome right cool and so I updated deep
blue sea like to do that it would have

430
00:32:41,919 --> 00:32:43,239
missed it before right

431
00:32:43,239 --> 00:32:46,299
although i have to have to share that
would get us that's local if they did

432
00:32:46,299 --> 00:32:51,158
that like two hours ago so i'll do an
update tonight and you'll see that so

433
00:32:51,159 --> 00:32:55,119
very flexible the beauty of the regex
this is going over mostly command lines

434
00:32:55,119 --> 00:32:59,168
also powershell also service creation
event of the names associated service

435
00:32:59,169 --> 00:33:03,369
creation events that they into the
services and you don't even have to edit

436
00:33:03,369 --> 00:33:05,679
the tool is thrown into rejects

437
00:33:05,680 --> 00:33:11,140
and if any of these false just commented
out you know maybe use the the c-sharp

438
00:33:11,140 --> 00:33:15,430
compiler maybe use that so maybe you
want to turn that one off the beauty of

439
00:33:15,430 --> 00:33:17,710
that is a simple configuration change
the fact that simple configuration

440
00:33:17,710 --> 00:33:21,610
configuration change my clients who
don't have ninjas can do this right

441
00:33:21,610 --> 00:33:26,889
that's my goal right and uh also
supports a whitelist so does benign

442
00:33:26,890 --> 00:33:31,180
software make crazy long processes yeah
they do google especially love doing

443
00:33:31,180 --> 00:33:34,210
this kind of stuff and initially jumps
out at you as being evil but then you

444
00:33:34,210 --> 00:33:40,330
see what it is and use perhaps upload
that txt virustotal viruses probably

445
00:33:40,330 --> 00:33:45,639
harmless you know and so we do have
normal software running crazy long

446
00:33:45,640 --> 00:33:50,710
commands a base64 encoded stuff so we
had a whitelist in the whitelist is also

447
00:33:50,710 --> 00:33:54,940
a CS be very very simple of course is an
evasion technique if someone uses a

448
00:33:54,940 --> 00:33:58,360
wireless command in the middle of their
malice you know but I make the the regex

449
00:33:58,360 --> 00:34:01,629
strong kind of avoid that at least make
that harder

450
00:34:01,630 --> 00:34:06,550
another thing people who steal ideas
instead of just showing that blob a 64

451
00:34:06,550 --> 00:34:11,320
it'll be coded and usually powershot
Empire boom there it is right there and

452
00:34:11,320 --> 00:34:14,440
sometimes it still is compressed and
then coded so it will do that as well

453
00:34:14,440 --> 00:34:18,490
now i'm gonna warn you the output is not
super slick at all especially when I'm

454
00:34:18,489 --> 00:34:24,429
decompressing in one basically forming
the mess . stuff it's just a ton to text

455
00:34:24,429 --> 00:34:28,330
that fills the screen but i decided not
to get caught up on the form of the

456
00:34:28,330 --> 00:34:33,610
output i want to focus more on the raw
detection so let's do some use cases now

457
00:34:33,610 --> 00:34:39,370
how the stuff stacked up so i did a SNP
password getting attack using John the

458
00:34:39,370 --> 00:34:46,029
rippers password . LST 3561 entries and
that generated return that event on 3561

459
00:34:46,030 --> 00:34:50,170
events in a sock which in my experience
are all missed because usually that

460
00:34:50,170 --> 00:34:55,060
events not even turned on to audit log
on failures right easy to do so instead

461
00:34:55,060 --> 00:34:58,450
of hitting with 3561 events i'll give
you want

462
00:34:58,450 --> 00:35:02,169
hey whole bunch of password guessing is
going on you know this many of those

463
00:35:02,170 --> 00:35:09,400
right so summarize don't do us we also
powershell Empire and thanks all these

464
00:35:09,400 --> 00:35:13,000
folks here so thank you your awesome
awesome work powerful Empire and tools

465
00:35:13,000 --> 00:35:16,420
like this scared me because it was
leaving footprints again this post

466
00:35:16,420 --> 00:35:19,310
exploitation bad things have happened
but after that kind

467
00:35:19,310 --> 00:35:24,440
was invisible goes dark and with native
logging it was nothing and you have to

468
00:35:24,440 --> 00:35:28,010
remove these blind spots you need to add
more sunlight right so in deep blue sea

469
00:35:28,010 --> 00:35:31,370
lice season now it will dump the command

470
00:35:31,370 --> 00:35:34,790
why is that command there because deep
blue sea lies notice it's a long command

471
00:35:34,790 --> 00:35:39,680
line is over 5 base64 encoding
characters is also running a coded

472
00:35:39,680 --> 00:35:42,529
hidden power shell come in then it'll
arm

473
00:35:42,530 --> 00:35:47,330
d base64 that command and then inspect
what's left there it will show you the

474
00:35:47,330 --> 00:35:51,590
actual command and of course they'd be
crazy use of mixed case is always knows

475
00:35:51,590 --> 00:35:56,120
how they spelled system.net . webclient
there you know very very classic these

476
00:35:56,120 --> 00:36:02,870
kind of tools and then rescan the same
heuristics against me now normalized

477
00:36:02,870 --> 00:36:07,279
command it says so in addition all the
things i told you before it's also using

478
00:36:07,280 --> 00:36:11,510
that web down web client download string
and they're sending a user agent on the

479
00:36:11,510 --> 00:36:15,920
command line which is usually not a good
thing for you right now how much normal

480
00:36:15,920 --> 00:36:19,910
software set the user agent on the
command line not much but malware

481
00:36:19,910 --> 00:36:24,830
reliably does so we'll look for that
it's an easy street look for so of

482
00:36:24,830 --> 00:36:28,940
course metasploit on this case it's not
just a pen testers tool we see black cat

483
00:36:28,940 --> 00:36:29,960
she's been destroyed

484
00:36:29,960 --> 00:36:33,830
I handle cases where metasploit was
extended 10 days by very advanced teams

485
00:36:33,830 --> 00:36:36,170
my clients have been on the receiving
end of that

486
00:36:36,170 --> 00:36:40,460
so while minutes . of course isn't easy
to test it is useful for real-world on

487
00:36:40,460 --> 00:36:45,530
results because I've seen black cats use
it as well so this is the newer was the

488
00:36:45,530 --> 00:36:51,350
older native upload right this is the
older native upload me fat exe drops the

489
00:36:51,350 --> 00:36:55,009
filesystem goal line defense by
corporate antivirus solutions to stop

490
00:36:55,010 --> 00:36:59,510
that right its list of the older method
metasploit two years ago uses by default

491
00:36:59,510 --> 00:37:03,920
in and we did a typical pivot you know I
always type get system

492
00:37:04,490 --> 00:37:08,299
I always type you know hash dump yeah
it's like it's like muscle memory i'm

493
00:37:08,300 --> 00:37:09,890
typing this load many cats

494
00:37:09,890 --> 00:37:13,850
I'm going you know and so I want to
model that was deep blue sea like make

495
00:37:13,850 --> 00:37:14,690
of all this

496
00:37:14,690 --> 00:37:21,560
well notice a 16 character servicename
that's exclusively upper/lower alpha and

497
00:37:21,560 --> 00:37:27,440
it also notice the the system route is
$OPERAND percent system route percent /a

498
00:37:27,440 --> 00:37:31,520
characters mixed case . exe every time
now of course an attacker can change

499
00:37:31,520 --> 00:37:32,930
this you can change all this

500
00:37:32,930 --> 00:37:36,500
but one thing I've learned in my career
defaults are powerful defaults tend to

501
00:37:36,500 --> 00:37:41,390
stick important but we have put 4444 we
all know what that is right minutes . i

502
00:37:41,390 --> 00:37:44,868
can change that you you'd be surprised
how often it's not now so default a

503
00:37:44,869 --> 00:37:48,710
powerful and again the fact that someone
could dodge this easily you could take

504
00:37:48,710 --> 00:37:52,490
five minutes and dogs this i'm still
looking for it also when you type get

505
00:37:52,490 --> 00:37:55,759
system actually drops additional
artifacts on file system it touches the

506
00:37:55,760 --> 00:38:00,950
fathers of a bit deeper and it does / /
/ pipe / I think the six character

507
00:38:00,950 --> 00:38:04,819
lowercase name every single time now the
name changes but it's six card is

508
00:38:04,819 --> 00:38:08,599
lowercase every time I look for that now
we'll do the newer more modern

509
00:38:08,599 --> 00:38:12,109
powershell target right this is the more
powerful one doesn't touch the file

510
00:38:12,109 --> 00:38:17,000
system creates a number of high-value
events this is the system log you will

511
00:38:17,000 --> 00:38:20,480
actually get this one natively no
additional configuration needed this

512
00:38:20,480 --> 00:38:25,460
notice that that that service filename
there so this is a typical event 7045

513
00:38:25,460 --> 00:38:32,480
and the service file name is crazy crazy
long then of course it's basically four

514
00:38:32,480 --> 00:38:36,650
encoded compressed we unwind all that
and show you the results plus our new

515
00:38:36,650 --> 00:38:42,589
friend 4688 with similar goodness there
once you start logging that events we

516
00:38:42,589 --> 00:38:48,078
also have powersport powersport of
course met launching me cats again am

517
00:38:48,079 --> 00:38:53,569
almost every pen test i do if I've
gotten in if I can run me cats IM every

518
00:38:53,569 --> 00:38:58,400
black and white head I know does that so
we do need to look for that behavior and

519
00:38:58,400 --> 00:39:05,119
so the net web on the net web client
download string it's part of that and

520
00:39:05,119 --> 00:39:10,760
also spotted me cat itself and the first
ones using a short URL as i mentioned so

521
00:39:10,760 --> 00:39:16,940
and then if i use the actual arm
powersports from the website it triggers

522
00:39:16,940 --> 00:39:20,630
a couple other things including the use
of the word powersports and use the

523
00:39:20,630 --> 00:39:25,160
invoke dash me cats Tapia's one and you
know as far as dodging this stuff in the

524
00:39:25,160 --> 00:39:29,240
wild no one is right now because no one
hardly anyone defend this way you know

525
00:39:29,240 --> 00:39:34,879
this is not hard this is different you
know and if the day comes this tool is

526
00:39:34,880 --> 00:39:39,619
so successful that all the black cats
are dodging it well not as good and bad

527
00:39:39,619 --> 00:39:44,599
but I don't think it's coming anytime
too soon and again defenders can more

528
00:39:44,599 --> 00:39:46,400
accurately match the the attack

529
00:39:46,400 --> 00:39:50,750
RR preventive controls necessarily will
be more conservative architecture

530
00:39:50,750 --> 00:39:54,289
control to be more aggressive and I've
been doing this for a long time and I've

531
00:39:54,289 --> 00:39:58,730
always been able to go to the attackers
at least on the defense side and I don't

532
00:39:58,730 --> 00:40:02,210
see that ending anytime too soon PS
attack was interesting because it

533
00:40:02,210 --> 00:40:06,740
doesn't actually use PowerShell well its
kind of PowerShell without powershell it

534
00:40:06,740 --> 00:40:11,058
uh it's interesting use case so a lot of
course the defenders now we're trying to

535
00:40:11,059 --> 00:40:14,990
detect use the militias powershell so
what if we dodged that cause powershell

536
00:40:14,990 --> 00:40:18,109
directly to the dotnet framework this
makes it harder for enterprises the

537
00:40:18,109 --> 00:40:19,069
block

538
00:40:19,069 --> 00:40:23,029
initially when I ran it this was deeper
into me writing deep Lucille i still

539
00:40:23,029 --> 00:40:26,690
wasn't seeing it I'm like it was still
invisible even though it's looking power

540
00:40:26,690 --> 00:40:29,000
show long commands blah blah

541
00:40:29,000 --> 00:40:32,390
it was still missing it and then of
course i had a dig deeper and I realized

542
00:40:32,390 --> 00:40:35,990
what they were doing was using the
c-sharp compiler and cbt res to actually

543
00:40:35,990 --> 00:40:40,700
compile stuff on the fly on your system
so it's compiling this stuff on the fly

544
00:40:40,700 --> 00:40:44,960
on your system and it does so in very
very repeatable ways and like a lot of

545
00:40:44,960 --> 00:40:49,849
malware the the name of that temp folder
is random and the name of the . temp

546
00:40:49,849 --> 00:40:55,069
files as res be 770 right there was
always the same length but it's randomly

547
00:40:55,069 --> 00:40:59,029
generated name right so we start looking
for that we say hey by the way so much

548
00:40:59,029 --> 00:41:05,569
using csudh see and also on the bottom
now they're doing it as PS attack would

549
00:41:05,569 --> 00:41:11,690
write iops attack was interesting and uh
hot off the presses a little glimpse the

550
00:41:11,690 --> 00:41:17,690
future tomorrow i noticed this on
Twitter invoke obfuscation Michael shiny

551
00:41:17,690 --> 00:41:21,619
cool i need to look at that and I'm i
try to download it's not there yet it

552
00:41:21,619 --> 00:41:24,020
will debut tomorrow so I thought it'd be
cool

553
00:41:24,020 --> 00:41:27,259
I yesterday to detect a tool that has
been released yet

554
00:41:27,260 --> 00:41:31,849
that's what i did here haha because you
know hey you know go big or go home

555
00:41:31,849 --> 00:41:37,279
right so I'm looking at this like shiny
and red x's to the rescue right now you

556
00:41:37,279 --> 00:41:41,000
want to be careful with red x's
rejecters feel like angry gods don't

557
00:41:41,000 --> 00:41:45,680
anger them okay cuz you anger the regex
God's will consume all cpu and destroy

558
00:41:45,680 --> 00:41:50,480
your system okay well that's easy it is
to a regex with like a parenthesis star

559
00:41:50,480 --> 00:41:55,130
comma and then more than say 20 of those
and hit enter and it's like well that's

560
00:41:55,130 --> 00:41:59,810
taking a long time no I'm like click
click click

561
00:41:59,810 --> 00:42:06,710
click and i-44 virtual CPUs all consumed
you know Mike this is yesterday and like

562
00:42:06,710 --> 00:42:12,350
I just broke my instructions like
thump-thump thump-thump like I'm so

563
00:42:12,350 --> 00:42:17,900
screwed right here's a cool tool doesn't
work I thanks for see you later

564
00:42:17,900 --> 00:42:23,270
no because I hadn't changed the code but
i changed the regex I'm like oh the

565
00:42:23,270 --> 00:42:25,580
rejecters are destroying all worlds

566
00:42:25,580 --> 00:42:30,590
ok so I i did a simple cop out now you
see this code have an improvement i'm

567
00:42:30,590 --> 00:42:34,370
going to bet that improvement i just
took the string and then I took a string

568
00:42:34,370 --> 00:42:39,410
are removing the pluses and compare the
two strings really easy on the cpu not

569
00:42:39,410 --> 00:42:44,060
super league coding regex style but it
was a breeze on the cpu and it works so

570
00:42:44,060 --> 00:42:48,440
now I'm gonna test the tool that has
been released yet right so I here's a

571
00:42:48,440 --> 00:42:52,100
stock total shoutouts i'm i'm using his
technique i'm detecting his technique

572
00:42:52,100 --> 00:42:55,850
before we deployed it I at least I can
do is give a shout out to talk so check

573
00:42:55,850 --> 00:43:00,080
it out a new tomorrow and uh i also need
to exploit and they don't really have an

574
00:43:00,080 --> 00:43:03,319
exploit so if you're wondering what i'm
thinking about it try to type of screen

575
00:43:03,320 --> 00:43:07,220
full of data that's one thing about here
okay so I'm just typing up stream of

576
00:43:07,220 --> 00:43:11,359
consciousness for this late last night I
want to go see dual-core and I'm just

577
00:43:11,360 --> 00:43:17,690
time for a while that's all true by the
way and I AD&D for the way and yes yes

578
00:43:17,690 --> 00:43:22,910
Dungeon Master's unite unite that's
right the original AT&T please come on

579
00:43:22,910 --> 00:43:29,750
I and I'm so it detected it right as you
see here i can fly that's like so

580
00:43:29,750 --> 00:43:33,950
excited but a dungeon dragon so so it's
in a long time and i'll be fair would

581
00:43:33,950 --> 00:43:37,040
have detected either way based on length
of that command so out of the blocks

582
00:43:37,040 --> 00:43:40,400
deep blue sea level spot of that but i
decided to add the additional logical

583
00:43:40,400 --> 00:43:44,270
plus is now a lot more than pluses in
this command of course there's all kinds

584
00:43:44,270 --> 00:43:47,690
of stuff on the single quotes double
quotes back tix is everything

585
00:43:47,690 --> 00:43:51,590
however I thought if it's all stitched
together with pluses to obfuscate out of

586
00:43:51,590 --> 00:43:56,270
the pluses right so I noticed over 25
plus as well so i was pretty happy that

587
00:43:56,270 --> 00:44:00,110
I believe it would have detected this
too I won't know till tomorrow but I

588
00:44:00,110 --> 00:44:03,830
believe it would have anyways and with
the added code yet another obfuscation

589
00:44:03,830 --> 00:44:06,890
technique is not reliably detected

590
00:44:06,890 --> 00:44:11,750
alright so next steps and then a demo so
like I said the outputs crazy basically

591
00:44:11,750 --> 00:44:12,450
sell

592
00:44:12,450 --> 00:44:17,279
and next step is to separate the
detection engine from the reporting

593
00:44:17,280 --> 00:44:21,000
engine i think that makes sense so how
the raw detection that we gotta text or

594
00:44:21,000 --> 00:44:25,800
csv or whatever and i have the rod
attention and be able to feed that into

595
00:44:25,800 --> 00:44:30,690
other tools and then reporting engine
which work off of that already talked to

596
00:44:30,690 --> 00:44:33,690
justin anderson about integrating
software cannot really soft though

597
00:44:33,690 --> 00:44:38,010
that's a blue team in forensics our
network forensics district based on

598
00:44:38,010 --> 00:44:42,630
elkin and a lot of the biggest sites
when they outgrow their sim when you're

599
00:44:42,630 --> 00:44:46,710
handling terabytes of data petabytes of
data that's Virginia Tech University

600
00:44:46,710 --> 00:44:51,540
there's no commercial sense that
actually scales that big butt out does

601
00:44:51,540 --> 00:44:56,250
right out does so we're seeing a lot of
work move towards help now and I saw

602
00:44:56,250 --> 00:45:00,900
Falcons a again network forensics in
blue team distro and I already talked to

603
00:45:00,900 --> 00:45:05,790
justin anderson who is one of the
developers there and uh he's already he

604
00:45:05,790 --> 00:45:10,770
actually reviewed my talk about a few
typos and said hey I'm putting this off

605
00:45:10,770 --> 00:45:14,700
and said you'd be your own bad self man
do it do it right so i will work one him

606
00:45:14,700 --> 00:45:19,649
with that and another thing i have is i
have a domain that's 15 years old that I

607
00:45:19,650 --> 00:45:24,180
used to use for email and then a gmail
account i stopped right and I'm but i

608
00:45:24,180 --> 00:45:27,960
have like you know back when romell
serving some you probably still do but

609
00:45:27,960 --> 00:45:32,550
but i think a fifteen-year-old domain
the MX records have disabled for like

610
00:45:32,550 --> 00:45:36,569
ten years but it had been exposed to
every spam list out there so just for

611
00:45:36,569 --> 00:45:40,410
grins at 20 ms record back on and in 60
seconds I'd like five pieces of malware

612
00:45:40,410 --> 00:45:45,690
roll right in so the spoon that stuff up
for about four months now and my next

613
00:45:45,690 --> 00:45:50,579
step is I'm going to sit down with the
clean windows 7 image and my true inner

614
00:45:50,579 --> 00:45:53,069
user and clickety clickety click on all
things right

615
00:45:53,069 --> 00:45:57,180
yes i agree of course you have anybody
I'm about my pc is infected Oh No click

616
00:45:57,180 --> 00:46:00,839
here yes and I'll install remote helper
object i'll do all kind of stuff you

617
00:46:00,839 --> 00:46:09,930
know and I'll channel my true CFO and
i'll do all those things and I'm and

618
00:46:09,930 --> 00:46:14,160
then i'll see whats with lying beneath
right and I decided have time to do that

619
00:46:14,160 --> 00:46:16,140
for now but I think we've got enough
stuff now

620
00:46:16,140 --> 00:46:20,490
so next day's the stage one was a heavy
focus on testing tools and mindfully

621
00:46:20,490 --> 00:46:25,078
John stranger said phase 2 for detection
the whole time Alice actual raw malice

622
00:46:25,609 --> 00:46:28,700
and then seeing what looks like they're
I think the Lucy Liu pretty well

623
00:46:28,700 --> 00:46:31,970
behaviorally I think there's definitely
room for improvement so kind of a

624
00:46:31,970 --> 00:46:35,359
two-phase approach of separating the
detection engine from the reporting

625
00:46:35,359 --> 00:46:40,038
engine and also again more actual malice
more use cases and every step along the

626
00:46:40,039 --> 00:46:43,999
way if I find something that works love
to get hub i'll drop a new ETFs there as

627
00:46:43,999 --> 00:46:46,999
well so you can adjust in your tools and
check it out as well

628
00:46:47,660 --> 00:46:52,819
alright so I'm able to possibly go wrong
right so I'm the microphone already

629
00:46:52,819 --> 00:46:59,089
broken the demigods be sure so i'll keep
it kind of short here so I'm you can see

630
00:46:59,089 --> 00:47:06,769
that of course so it's deep blue sea
alive and it can they can process the

631
00:47:06,769 --> 00:47:09,859
security log depend on the size log in
and check along for a while

632
00:47:10,819 --> 00:47:15,680
well let's go and have some other stuff
here why look at ok that's back so here

633
00:47:15,680 --> 00:47:19,460
is the the live security log many many
bad things have happened the system of

634
00:47:19,460 --> 00:47:21,440
course right I've been naughty

635
00:47:21,440 --> 00:47:24,890
I've been a bad boy and on this poor
windows seven system did nothing to

636
00:47:24,890 --> 00:47:29,390
deserve any of these things and I'm
again the the outputs a bit this is me

637
00:47:29,390 --> 00:47:33,589
testing a invoke confiscation by setting
lot of pluses at it just to see if I can

638
00:47:33,589 --> 00:47:37,849
detect that this is me testing that
stringer said earlier this is me fixing

639
00:47:37,849 --> 00:47:42,440
some typos in that string and because
you cannot type along crazy diatribe you

640
00:47:42,440 --> 00:47:46,039
should at least be syntactically correct
right I'm any other way to that out to

641
00:47:46,039 --> 00:47:51,739
everyone to do that and you can also do
get a log name i can do dash log system

642
00:47:51,739 --> 00:47:56,119
and go to the system log

643
00:47:56,119 --> 00:48:04,730
you can also give ETA X Files so i'll go
Evie TX /p oh whatever powers . that's

644
00:48:04,730 --> 00:48:09,499
the security log by the way that's
powers Boyd for the security log and

645
00:48:09,499 --> 00:48:16,220
again here's a base64 is a code base 64
etc etc etc you can feed it I got a

646
00:48:16,220 --> 00:48:18,109
whole bunch of use cases in here

647
00:48:18,109 --> 00:48:23,749
metasploit whatever share with the
security log for a native target pretty

648
00:48:23,749 --> 00:48:27,769
brief there that's the security log
girls look at the system log

649
00:48:29,040 --> 00:48:33,600
Sarah so you an idea here i'll leave it
on that my demo because I've got this

650
00:48:33,600 --> 00:48:39,330
far without blowing up so i'll call that
good and i'm pretty excited about it and

651
00:48:39,330 --> 00:48:42,960
a pretty sight of the Derby khan and
again i love your help on this stuff

652
00:48:42,960 --> 00:48:50,400
it's open source open source license all
kind of stuff so I love to love to get

653
00:48:50,400 --> 00:48:56,430
some more collaboration going on that
and how we doing on time I think we're

654
00:48:56,430 --> 00:48:56,910
good

655
00:48:56,910 --> 00:48:59,730
so yeah that's good thank you folks
thank you very much

