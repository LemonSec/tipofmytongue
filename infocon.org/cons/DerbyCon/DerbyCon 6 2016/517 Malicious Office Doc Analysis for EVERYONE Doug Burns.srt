1
00:00:00,000 --> 00:00:03,000
that's a mouthful but that's what we got

2
00:00:03,510 --> 00:00:08,490
so just a little bit about me . burns at
dogs on Twitter there's a blog that i

3
00:00:08,490 --> 00:00:14,429
posted on twice should be more so if i
do so much water i'm a senior security

4
00:00:14,429 --> 00:00:20,189
analyst for a large media company got
some letters dominating got osep in june

5
00:00:20,189 --> 00:00:25,170
which is kind of accomplishment forming
GED so I got some blue team experience 2

6
00:00:25,170 --> 00:00:28,230
and CH because why not

7
00:00:28,230 --> 00:00:34,410
so interests lie in CTFs playing this
weekend derby con so if you've got flags

8
00:00:34,410 --> 00:00:39,419
I'll take them malware analysis of
course board games and everybody loves

9
00:00:39,420 --> 00:00:40,110
cats

10
00:00:40,110 --> 00:00:45,420
so I just want to get a little bit of a
road map out how we're going to get from

11
00:00:45,420 --> 00:00:49,860
where we're from the beginning to the
end just kind of a disclaimer here this

12
00:00:49,860 --> 00:00:54,809
is a very low level talks so if you're
using I'd every day and you're reversing

13
00:00:54,809 --> 00:00:58,079
executables and doing all kinds of crazy
debugging and stuff

14
00:00:58,649 --> 00:01:02,010
this is probably going to be information
that you already know hopefully can pick

15
00:01:02,010 --> 00:01:05,820
something up out of it but just want to
get that out there so when you talk

16
00:01:05,820 --> 00:01:07,259
about a couple different things

17
00:01:07,260 --> 00:01:12,720
why do we want to analyze malware what's
the point we're all busy why even spend

18
00:01:12,720 --> 00:01:16,650
the time on it some other things so then
we're going to make some preparations

19
00:01:16,650 --> 00:01:21,390
and precautions because you are dealing
with malware so like you don't want to

20
00:01:21,390 --> 00:01:24,900
be the person to affect your entire
company with ransomware so how can you

21
00:01:24,900 --> 00:01:26,369
make sure that doesn't happen

22
00:01:26,369 --> 00:01:30,570
where are we going to get the malware
then we're going to analyze the malware

23
00:01:30,570 --> 00:01:34,199
and at the end we're going to talk a
little bit about prevention some quick

24
00:01:34,200 --> 00:01:40,320
wins and some things that you can do to
increase your security posture so that

25
00:01:40,320 --> 00:01:45,720
you can kind of lesson your malware load
so why analyze malware what's wrong with

26
00:01:45,720 --> 00:01:49,110
virustotal right everybody loves
virustotal you can throw your executable

27
00:01:49,110 --> 00:01:52,259
up there and it will scan it with every
AV engine and maybe there's some

28
00:01:52,259 --> 00:01:55,229
comments in there and say oh look at all
these indicators that that's awesome

29
00:01:55,229 --> 00:01:55,860
right

30
00:01:55,860 --> 00:02:00,630
that is good that's what I did for a
really long time you just throw it on

31
00:02:00,630 --> 00:02:04,229
virustotal oh I've got something nobody
seen before i'm helping the community

32
00:02:04,229 --> 00:02:08,699
sure you are but then I was taking a pin
testing class with Dave Kennedy actually

33
00:02:08,699 --> 00:02:13,160
black hat and he presented the idea that
attackers could also be using fire

34
00:02:13,160 --> 00:02:17,780
total so if this is a targeted attack
i'm gonna have a virus or API and i'm

35
00:02:17,780 --> 00:02:20,810
going to call that thing every five
minutes looking for you to upload my

36
00:02:20,810 --> 00:02:22,400
executable so that I know

37
00:02:22,400 --> 00:02:25,460
oh yeah i'm caught so I'm gonna shut
everything down and try to get a couple

38
00:02:25,460 --> 00:02:30,530
more months nobody will get caught so
there are better ways to do do it other

39
00:02:30,530 --> 00:02:36,170
than virustotal not everybody's in a
targeted attack say 99.999 percent of

40
00:02:36,170 --> 00:02:40,850
the time it's just going to be internet
whether just random ransomware that she

41
00:02:40,850 --> 00:02:45,380
was getting because you have an email
address but in the case that it is a

42
00:02:45,380 --> 00:02:51,290
targeted attack you should keep your
cards your chest as long as you came so

43
00:02:51,290 --> 00:02:56,179
I when you so we're going to analyze
malware you need to start with questions

44
00:02:56,180 --> 00:03:00,740
right because you can analyze my we're
forever all day long you get down you've

45
00:03:00,740 --> 00:03:05,390
got the debugger in the disassembly and
you're going crazy but if that's not

46
00:03:05,390 --> 00:03:08,299
what you need to know when you're just
spinning your wheels on it

47
00:03:08,300 --> 00:03:12,830
so before you analyze malware before you
start a program or process for analyzing

48
00:03:12,830 --> 00:03:17,060
malware formulate some questions so that
you can have these questions and at the

49
00:03:17,060 --> 00:03:21,230
end of it you can answer it then you can
put it to bed so are you sure none of

50
00:03:21,230 --> 00:03:24,950
your users are infected right so you get
the email and somebody said hey can you

51
00:03:24,950 --> 00:03:29,420
check this out for me like oh yeah thats
badness you look at the email filter and

52
00:03:29,420 --> 00:03:33,170
you find 10 other people got it is it an
email to the 10 people don't open this

53
00:03:33,170 --> 00:03:37,790
if you did let me know right but
sometimes people are so forthcoming

54
00:03:37,790 --> 00:03:41,120
about letting you know that they open
the files because they're embarrassed or

55
00:03:41,120 --> 00:03:45,320
because they gonna get in trouble so
there's a lot of reasons that a user

56
00:03:45,320 --> 00:03:49,579
might open a file and then not report it
to you and maybe they don't understand

57
00:03:49,580 --> 00:03:54,110
the ramifications of what they're doing
so if you're not analyzing malware and

58
00:03:54,110 --> 00:03:57,739
looking for these indicators on your
network then the matter is going to run

59
00:03:57,739 --> 00:04:00,739
crazy because you don't actually know
whether anybody open it or not

60
00:04:01,250 --> 00:04:05,989
next question is what was the email
actually trying to accomplish so was it

61
00:04:05,989 --> 00:04:11,480
a fishing link where they just trying to
steal gmail and dropbox stuff like that

62
00:04:11,480 --> 00:04:15,950
or was it a targeted attack was a
targeted fish and it looks like your

63
00:04:15,950 --> 00:04:18,469
company's website they're saying hey
give me your domain credentials because

64
00:04:18,470 --> 00:04:21,470
this is a new update that's something
that might be a little more interesting

65
00:04:22,270 --> 00:04:28,030
and then it's file was the file trying
to do is it just random rants employer

66
00:04:28,030 --> 00:04:32,080
or something looks more targeted or
there's things in there that are

67
00:04:32,080 --> 00:04:35,258
indicators like your company are their
names within the documents and stuff

68
00:04:35,259 --> 00:04:40,569
like that so I just kind of analyzing
and assessing what the threat is and

69
00:04:40,569 --> 00:04:44,590
then the last point why did you usually
users even receive the email right we're

70
00:04:44,590 --> 00:04:49,030
all spending a ton of money on email
filters I'm host based detection all the

71
00:04:49,030 --> 00:04:55,448
fancy boxes with blinky lights so we
should be safe no spam know a malware in

72
00:04:55,449 --> 00:04:59,409
the email right so why are they getting
it is there anything that we can do to

73
00:04:59,409 --> 00:05:01,930
make sure that this type of stuff has
been happening again

74
00:05:01,930 --> 00:05:08,380
so precautions and preparations i always
use a vm so if you can swing it your

75
00:05:08,380 --> 00:05:13,330
best to have two teams i would recommend
like a VPS just out somewhere that's not

76
00:05:13,330 --> 00:05:17,050
tied your corporate network running on a
personal credit card expenses off your

77
00:05:17,050 --> 00:05:20,680
boss just not attributable to your
company so that there's no way that

78
00:05:20,680 --> 00:05:25,659
anybody can link your VPS machine back
to your company and then just a local vm

79
00:05:25,659 --> 00:05:31,479
so windows be him you got it and you can
get the licensing you can just install

80
00:05:31,479 --> 00:05:34,750
something if you get the licensing but
if you don't have licensing for you

81
00:05:34,750 --> 00:05:38,830
don't spend money on it you can go to
modern iie windows done a really cool

82
00:05:38,830 --> 00:05:43,508
thing Microsoft and they actually
released VM images for windows 7 windows

83
00:05:43,509 --> 00:05:48,190
8 windows 10 for a whole slew of
different browsers it's got some weird

84
00:05:48,190 --> 00:05:52,300
licensing things where it's like 30 days
or something that's going to crap out

85
00:05:52,300 --> 00:05:55,690
but if you just take a snapshot and keep
reverting back to that snapshot you'll

86
00:05:55,690 --> 00:05:59,289
never get the license . so you can just
kind of keep using it as your little

87
00:05:59,289 --> 00:06:06,068
sandbox so on your VPS if you really
want to level it out you might look at

88
00:06:06,069 --> 00:06:10,240
running something like rednecks there's
a couple different ways you can get it

89
00:06:10,240 --> 00:06:13,900
on their room Knox's specialized linux
distributions specifically for malware

90
00:06:13,900 --> 00:06:18,940
analysis you're gonna have a whole slew
of tools in there that like you'll

91
00:06:18,940 --> 00:06:22,659
probably never touch but there's a few
things in there that you will use a and

92
00:06:22,659 --> 00:06:25,810
as you progress and if you decide to go
further down it then you'll always have

93
00:06:25,810 --> 00:06:30,130
you already have the toolkit there so if
you go to the rim ducks website they've

94
00:06:30,130 --> 00:06:32,689
got a rebellious script which basically

95
00:06:32,689 --> 00:06:36,709
she's a tattoo like AWS or dad or
something like that or you can just do a

96
00:06:36,709 --> 00:06:40,069
regular linux install and they have
install scripts we just run it from the

97
00:06:40,069 --> 00:06:45,769
fresh install and install the tools on
so important thing to note here is that

98
00:06:45,769 --> 00:06:49,219
even static analysis can lead to
execution so even though you think

99
00:06:49,219 --> 00:06:52,159
you're not executing malware maybe
you're just running it through some

100
00:06:52,159 --> 00:06:55,849
tools and things like that that could be
the while you're doing the static

101
00:06:55,849 --> 00:06:59,058
analysis and running through your tools
that malware is actually being executed

102
00:06:59,059 --> 00:07:02,929
just because of the way that it analyzes
and how it has to get the information

103
00:07:02,929 --> 00:07:07,878
that needs so as you learn there's
certain tools that are more likely less

104
00:07:07,879 --> 00:07:13,849
likely but by and large just use a vm
right keep it sandbox away don't let it

105
00:07:13,849 --> 00:07:17,179
be connected to your corporate network
and the other good thing is you can

106
00:07:17,179 --> 00:07:21,049
start fresh every time so you can just
start with a fresh good analysis

107
00:07:21,050 --> 00:07:24,409
environment you don't have a lot of junk
sitting around for macros that you've

108
00:07:24,409 --> 00:07:30,379
already extracted things like that i
just have a fresh spot so we get malware

109
00:07:30,379 --> 00:07:34,969
uh the you've got to get your malware
from your users right because you can go

110
00:07:34,969 --> 00:07:39,110
to mal share whatever and download
malware and like look at all this cool

111
00:07:39,110 --> 00:07:43,309
fancy stuff but if that's not what's in
your environment then who cares right

112
00:07:43,969 --> 00:07:47,449
so you should be encouraging your users
to send you as much email as they could

113
00:07:47,449 --> 00:07:50,089
possibly send you you're gonna hate
yourself at the end of the day because

114
00:07:50,089 --> 00:07:54,889
your mail load is going to triple but uh
you've got it do it you're going to see

115
00:07:54,889 --> 00:07:58,519
a lot of nigerian stuff but like it
mixed in with that you're going to see

116
00:07:58,519 --> 00:08:00,860
the malware and that's the important
thing

117
00:08:00,860 --> 00:08:05,809
so another way to kind of train your
users to get more malware to you as to

118
00:08:05,809 --> 00:08:09,409
fish yourself so there's a couple
different programs for this

119
00:08:09,409 --> 00:08:13,219
there's an open source one called go
fish it's completely open source you

120
00:08:13,219 --> 00:08:18,199
spend up a server run it and consent
fishes to your users on if you want to

121
00:08:18,199 --> 00:08:22,759
spend a little bit of money in it
there's a service called know before

122
00:08:22,759 --> 00:08:28,759
it's actually getting it mixed company
and they have some user awareness videos

123
00:08:28,759 --> 00:08:33,919
and things like that but the butcher the
constant mission really is there fishing

124
00:08:33,919 --> 00:08:37,250
module because it's just incredible you
can write great reports you can set up

125
00:08:37,250 --> 00:08:41,688
schedules you can randomize when people
get the emails you can include documents

126
00:08:41,688 --> 00:08:43,760
it's it's really amazing and

127
00:08:43,760 --> 00:08:47,390
for the check prices charged for $MONEY
it's a steal so if you want to spend

128
00:08:47,390 --> 00:08:50,120
some money and you've got some extra
budget definitely check out know before

129
00:08:50,120 --> 00:08:55,490
and then the last thing is gamification
so even when you're finishing your users

130
00:08:55,490 --> 00:08:58,910
and even when you're getting them to
send you emails if you can kind of make

131
00:08:58,910 --> 00:09:02,300
this into a game when you're gonna get a
lot more participation from it so a

132
00:09:02,300 --> 00:09:06,979
couple things that I've done before in
previous jobs is a once there with one

133
00:09:06,980 --> 00:09:11,180
time we had a was too selfish to our
users and we were organized by the

134
00:09:11,180 --> 00:09:16,189
department and so then we would have the
highest clickers in the apartment and we

135
00:09:16,190 --> 00:09:20,600
put it up on a board in the break room
so if finances 12 people who click and

136
00:09:20,600 --> 00:09:24,050
malicious links and there at the top of
it that gets a lot of people's attention

137
00:09:24,050 --> 00:09:27,469
and managers all the way through finance
are going to say hey guys we really do

138
00:09:27,470 --> 00:09:30,410
like step it up and make sure that we
had at the top of that list anymore

139
00:09:30,410 --> 00:09:33,860
anyways you'll see that those people
drop off really quick

140
00:09:33,860 --> 00:09:39,050
another cool thing that i did with
gamification is a when sending fishes

141
00:09:39,050 --> 00:09:42,560
out i sent an email and we started the
program said hey I'm gonna start fishing

142
00:09:42,560 --> 00:09:46,819
people if you send me the email back
that i sent to you that the fish eye

143
00:09:46,820 --> 00:09:50,360
liner you name into a drawing for like a
hundred dollar gift card and people

144
00:09:50,360 --> 00:09:54,200
loved it i mean my gosh like the day
that the gift card was drawn it was like

145
00:09:54,200 --> 00:09:58,880
electric in the office and everybody was
sending emails and then my email load

146
00:09:58,880 --> 00:10:01,880
tripled again so more coffee

147
00:10:02,390 --> 00:10:07,730
so he's kind of a methodology this is a
short talk so I'm not going to be able

148
00:10:07,730 --> 00:10:11,450
to go through all this but if you have a
chance i'm going to put these slides up

149
00:10:11,450 --> 00:10:13,940
on a SlideShare I'll tweet it out

150
00:10:13,940 --> 00:10:18,380
so this is something you can kind of
print out stick it on your cube wall

151
00:10:18,380 --> 00:10:21,950
office whatever you got and just kind of
watching through like what you're

152
00:10:21,950 --> 00:10:24,290
looking at right so you're not require
the email

153
00:10:24,290 --> 00:10:28,370
what what's in the email right is it a
link is an attachment the link kind of

154
00:10:28,370 --> 00:10:32,300
go through here do some recent on the
link and things like that am I gonna get

155
00:10:32,300 --> 00:10:35,750
into that the magics we're not talking
about it it's an attachment then what

156
00:10:35,750 --> 00:10:39,080
type of attachment is it is an office
dr. we're going to local office

157
00:10:39,080 --> 00:10:43,940
mailscanner i'm going to go over that in
a little bit if it's something where the

158
00:10:43,940 --> 00:10:47,690
codes already there like JavaScript or
something like that it's just packed

159
00:10:47,690 --> 00:10:51,110
inside of a zip file then you can go
straight to the static analysis and

160
00:10:51,110 --> 00:10:55,700
office mailscanner is gonna feed into
static analysis so for this methodology

161
00:10:55,700 --> 00:10:56,520
and

162
00:10:56,520 --> 00:11:00,360
for the beginning that's the way I say
to go just go ahead and pull out the

163
00:11:00,360 --> 00:11:04,680
macros it's Adolphus doc pull the
JavaScript the new static analysis on it

164
00:11:04,680 --> 00:11:06,689
i know it sounds scary but we're gonna
get through it

165
00:11:06,690 --> 00:11:10,920
I'm and then what you gonna do the
static analysis figure out the payload

166
00:11:10,920 --> 00:11:14,490
is I was a self-contained was that
actually the malware was actually in the

167
00:11:14,490 --> 00:11:19,110
macro was actually the JavaScript was
the ransom where r is a dropper where

168
00:11:19,110 --> 00:11:23,280
it's not the malware it's going to reach
out somewhere else and pull down the

169
00:11:23,280 --> 00:11:28,319
second stage which is the malware and so
once you figure that out both of those

170
00:11:28,320 --> 00:11:33,570
feedback and check your current defenses
so check and see what you've got in

171
00:11:33,570 --> 00:11:36,990
place already check your url filter is
getting blocked check your IP filter is

172
00:11:36,990 --> 00:11:42,750
that getting blocked check your Navy
check any kind of host-based production

173
00:11:42,750 --> 00:11:47,010
that you have so is there any way that
you're already blocking this stuff so it

174
00:11:47,010 --> 00:11:51,090
doesn't matter if anybody i'll open it
or not and if they're all our holes of

175
00:11:51,090 --> 00:11:55,170
working to build up defenses what can
you beefed up so that you don't get the

176
00:11:55,170 --> 00:12:00,329
stuff in the future or you can prevent
people from downloading the second stage

177
00:12:00,330 --> 00:12:06,840
or executing malware so initial triage
we're going to go back to virustotal

178
00:12:06,840 --> 00:12:09,900
right i know i said not to use
virustotal but there are good things we

179
00:12:09,900 --> 00:12:13,350
can do with virustotal so you want to
search virustotal so if you look at

180
00:12:13,350 --> 00:12:17,040
virustotal everybody goes the file you
drop you upload your file you go for it

181
00:12:17,040 --> 00:12:19,890
that's the bad stuff we don't want to do
that but over on the right there's

182
00:12:19,890 --> 00:12:21,630
search searches amazing

183
00:12:21,630 --> 00:12:25,530
you can't as far as I know there's no
way to actually look through virustotal

184
00:12:25,530 --> 00:12:29,130
searches so nobody can detect whether
you're searching for the hash of that

185
00:12:29,130 --> 00:12:32,850
file so that's a quick way to go ahead
and like you're basically doing the same

186
00:12:32,850 --> 00:12:37,350
thing without tipping your hand and
uploading and a diviner so generate the

187
00:12:37,350 --> 00:12:41,970
md5 sum of the file 25 will do that for
you just copy and paste put it in there

188
00:12:41,970 --> 00:12:45,780
and see what happens if it shows up
that's great then somebody else is

189
00:12:45,780 --> 00:12:49,770
already seen it you can kinda alright
it's not a targeted attack kind of

190
00:12:49,770 --> 00:12:54,060
internet whether and move along like
that it hasn't seen before then maybe

191
00:12:54,060 --> 00:12:57,209
you're going to be a little bit more on
edge say well let's see what I've got

192
00:12:57,210 --> 00:13:00,510
here but it depends on your search into
right i mean its first thing in the

193
00:13:00,510 --> 00:13:02,640
morning or in the UK or something like
that

194
00:13:02,640 --> 00:13:04,710
obviously I'm you probably have more

195
00:13:04,710 --> 00:13:13,710
new things said so once we do that then
we decided that we don't have any

196
00:13:13,710 --> 00:13:16,530
information for virustotal nobody's
giving us indicators or anything like

197
00:13:16,530 --> 00:13:21,449
that or maybe it's not even showing up
in virustotal now what you're going to

198
00:13:21,450 --> 00:13:25,410
do if it's not this document you're
gonna use office mailscanner uh it's a

199
00:13:25,410 --> 00:13:30,510
great tool I've used it a lot which will
release in $MONTH 2009 different Bowl

200
00:13:30,510 --> 00:13:34,710
win his website is reconstructed at
$TIME or so it can be used to scan

201
00:13:34,710 --> 00:13:39,240
office dr. shellcode PE files embedded
le streams and can also be used to

202
00:13:39,240 --> 00:13:43,710
extract macros so used to be a lot of
times and macros would actually be

203
00:13:43,710 --> 00:13:47,700
malicious things and they would be doing
malicious things but he's gotten pretty

204
00:13:47,700 --> 00:13:52,500
good about detecting when it's actually
the macro code is doing bad stuff so a

205
00:13:52,500 --> 00:13:57,900
lot of times it's just going to be on a
macro that's in there is going to get

206
00:13:57,900 --> 00:13:59,579
downloads and like that

207
00:13:59,580 --> 00:14:04,260
it also supports inflating docx xlsx
pptx I'm so if you're not aware those

208
00:14:04,260 --> 00:14:08,010
are basically exhibit files you can
literally just open them up like a zip

209
00:14:08,010 --> 00:14:10,650
file and see all the formatting and
stuff and the macros are also going to

210
00:14:10,650 --> 00:14:16,110
be in there i just kind of a word of
warning if you do go download this I i

211
00:14:16,110 --> 00:14:19,470
always get caught by this so I just put
it in slide so you if you get the slides

212
00:14:19,470 --> 00:14:22,920
and you'll have it with the zip file
that you get is password protected

213
00:14:22,920 --> 00:14:27,150
the password is reconstructed dot org I
i always for some reason forget that and

214
00:14:27,150 --> 00:14:30,180
i try to open look at what's the
password and then go to his website and

215
00:14:30,180 --> 00:14:32,670
that's the password is really
embarrassing

216
00:14:32,670 --> 00:14:38,670
so this is what happens now skin looks
like when you run it with no files or

217
00:14:38,670 --> 00:14:42,479
anything like that so you can see here
to give you the usage office mailscanner

218
00:14:42,480 --> 00:14:46,770
the file you want to look at I can scan
it for shellcode you cannot do info

219
00:14:46,770 --> 00:14:50,400
which is going to dump it for macro
stuff you can inflate which is what we

220
00:14:50,400 --> 00:14:55,770
are inflating those x-files brute force
it so if there's like encrypted strings

221
00:14:55,770 --> 00:14:59,880
can actually do some brute forcing on
that encryption to get your plain text

222
00:14:59,880 --> 00:15:05,370
information or find shellcode that's
been encrypted and then debug so find

223
00:15:05,370 --> 00:15:08,370
something that can actually pronounce
and disassembly for you

224
00:15:09,120 --> 00:15:12,510
so that's basically it so your office
mailscanner the file you want to do and

225
00:15:12,510 --> 00:15:15,510
for this purposes we're going to use and
foremost

226
00:15:16,080 --> 00:15:21,660
so static analysis this is where it gets
really fun right

227
00:15:22,980 --> 00:15:26,640
you don't have to be a program
introduced tag analysis i am a terrible

228
00:15:26,640 --> 00:15:31,080
programmer but if I can sit down with a
static file and look at it for an hour

229
00:15:31,080 --> 00:15:35,610
so i can generally pull out what I need
to know because most of the time all I'm

230
00:15:35,610 --> 00:15:39,690
looking for is an IP address or URL and
if that's all you're looking for than

231
00:15:39,690 --> 00:15:43,440
the scary stuff really isn't that scary
because you're only targeting certain

232
00:15:43,440 --> 00:15:46,350
information that's relevant to what you
need that's where we're going back to

233
00:15:46,350 --> 00:15:50,130
the questions that we had at the
beginning so there's two main

234
00:15:50,130 --> 00:15:56,760
obfuscation things that I've seen just
in my experience so one that's very

235
00:15:56,760 --> 00:15:59,430
common as variables that are used to
build commands so if you're not familiar

236
00:15:59,430 --> 00:16:02,400
not a programmer variables just
essentially a box is going to contain

237
00:16:02,400 --> 00:16:03,510
something else

238
00:16:03,510 --> 00:16:09,450
so if I could take the sentence that has
black and store the and a variable hat

239
00:16:09,450 --> 00:16:13,380
in the be variable and black and see
variable and then i can say a plus B

240
00:16:13,380 --> 00:16:17,820
plus C equals the head is what it's
super simple but it just looks nasty

241
00:16:17,820 --> 00:16:21,600
because everything's in like upper and
lowercase and numbers and it just looks

242
00:16:21,600 --> 00:16:24,930
like garbage but really when you get
down to it that's all that they're doing

243
00:16:24,930 --> 00:16:29,040
and functions work like this too so it
might be a function that they call it

244
00:16:29,040 --> 00:16:32,730
setting a variable that's just returning
that fuck that variable so it's doing

245
00:16:32,730 --> 00:16:37,170
the same thing it just looks a little
bit trickier and the other thing is that

246
00:16:37,170 --> 00:16:42,930
car codes so with ascii text all I ascii
characters have a car code assigned to

247
00:16:42,930 --> 00:16:47,849
them and you can actually call that with
functions so a lot of times in vb I

248
00:16:47,850 --> 00:16:52,200
think it's just ch AR parentheses and
then a number so there's going to have

249
00:16:52,200 --> 00:16:55,740
all these car codes concatenated
together and they're building sentences

250
00:16:55,740 --> 00:17:01,890
and commands and strings from that that
one it it's not fun because you're

251
00:17:01,890 --> 00:17:05,459
basically just going to pull up and ask
you list and say okay what it is 42 ok

252
00:17:05,459 --> 00:17:10,560
that's a and then kind of go through it
that way you can automate this to a

253
00:17:10,560 --> 00:17:11,310
certain extent

254
00:17:11,310 --> 00:17:15,599
I've built some powershell tools i was
hoping that I could like released into

255
00:17:15,599 --> 00:17:19,889
and say hey look at the school stuff
done but it's definitely not ready for

256
00:17:19,890 --> 00:17:24,060
prime time maybe at some point but just
basically just feeding it in car codes

257
00:17:24,060 --> 00:17:27,060
and then powershell quickly convert this
scar codes into

258
00:17:27,630 --> 00:17:33,870
ascii text and so you can see it and
because why not

259
00:17:33,870 --> 00:17:39,629
I've got some examples here so you keep
it

260
00:17:40,440 --> 00:17:46,770
alright so this is invoice details . jas
text so i can do you think it a little

261
00:17:46,770 --> 00:17:51,090
bit so this is what you're looking at
right like it just looks like garbage

262
00:17:51,090 --> 00:17:56,459
right like function blah blah blah blah
equals Bob so it doesn't look like

263
00:17:56,460 --> 00:17:59,880
anything but if you would notice here
like here's 60 / ESPN

264
00:18:00,510 --> 00:18:07,980
oh the mechanics can maximize it said I
nope

265
00:18:09,570 --> 00:18:12,570
oh yeah

266
00:18:14,070 --> 00:18:24,990
ctrl + hey now we're rocking all right
so yeah so here we got 60 . 60 / sdn is

267
00:18:24,990 --> 00:18:25,950
that part of the URL

268
00:18:25,950 --> 00:18:29,010
maybe that's why we're going to start
our analysis and then you kind of scroll

269
00:18:29,010 --> 00:18:33,570
down here and you look there's some
numbers on the part of an IP address

270
00:18:33,570 --> 00:18:37,590
over there CMD is a calling CMD to run
something maybe that's where we're going

271
00:18:37,590 --> 00:18:39,209
to start our analysis and do something

272
00:18:39,210 --> 00:18:42,750
here's get it's just sitting a variable
here forget that's definitely gonna be

273
00:18:42,750 --> 00:18:47,700
part of your dropper here so like I said
I mean this thing is huge i think if you

274
00:18:47,700 --> 00:18:51,630
get to the bottom of it it's like 500
lines but it's just all this nonsense of

275
00:18:51,630 --> 00:18:55,530
like setting variables and gluing them
together so if you start going through

276
00:18:55,530 --> 00:18:59,460
here and you can pick out stuff the best
way to go about it

277
00:18:59,460 --> 00:19:05,370
so here's some I i took the spot i took
this file actually did some diablo

278
00:19:05,370 --> 00:19:10,800
education on it and down here you can
see where it sets of our sake three and

279
00:19:10,800 --> 00:19:15,270
that's the URL so that was just a
mash-up of a bunch of these function

280
00:19:15,270 --> 00:19:18,360
calls here and you just kind of
reference it me that's easy right

281
00:19:18,360 --> 00:19:22,290
control find find the function find the
function again and then replace it with

282
00:19:22,290 --> 00:19:26,760
the string and then one other file to
show you here

283
00:19:26,760 --> 00:19:31,440
uh this is that car coat stuff so this
is what you're going to see what

284
00:19:31,440 --> 00:19:34,020
something like that so it's got create
objects so we can tell it's vbscript

285
00:19:34,020 --> 00:19:39,570
then you've got Karkos where it's like
r77 bus and car 105 and all its doing is

286
00:19:39,570 --> 00:19:40,519
mashing those

287
00:19:40,519 --> 00:19:46,429
ascii characters together to build
strings and commands so when you see

288
00:19:46,429 --> 00:19:47,570
something like that

289
00:19:47,570 --> 00:19:51,109
like I said roll up your sleeves but
you're asking charter right cool tool

290
00:19:51,109 --> 00:19:54,109
church

291
00:19:56,029 --> 00:20:02,690
alright so static analysis so the second
stage right so we've decided this is a

292
00:20:02,690 --> 00:20:06,919
dropper we don't have the bad stuff in
the macros this is a dropper

293
00:20:06,919 --> 00:20:10,489
so now we want to pull them a second
stage and see what is the badness right

294
00:20:10,489 --> 00:20:14,149
so if at all possible don't download
this from your corporate network that's

295
00:20:14,149 --> 00:20:18,168
where we're going to spin up the VPS
that we've gotten toledo ohio pull down

296
00:20:18,169 --> 00:20:22,579
the malware so it doesn't look like that
it's my company pulling down it's just a

297
00:20:22,579 --> 00:20:26,629
non attribution thing right don't tip
your hand if you don't have to if you

298
00:20:26,629 --> 00:20:31,279
don't get an exe so maybe you just get a
filename or a string of characters and

299
00:20:31,279 --> 00:20:37,429
it doesn't actually look like a file a
lot of times it is a an executable they

300
00:20:37,429 --> 00:20:39,979
just don't have the extension on it
because all items and macros going to

301
00:20:39,979 --> 00:20:41,419
add that extension later

302
00:20:41,419 --> 00:20:46,219
so if you run the linux command file on
that thing that you download it comes

303
00:20:46,219 --> 00:20:51,109
back and says it's like a win pe32 then
like that your binary a dot exe and you

304
00:20:51,109 --> 00:20:55,968
can run just fine again so once you've
got the second stage generate a hash

305
00:20:55,969 --> 00:21:02,089
search virustotal is it there is it not
there most of the time propers maybe not

306
00:21:02,089 --> 00:21:06,469
show up depending on where people are in
their morning coffee but that second

307
00:21:06,469 --> 00:21:10,459
stage is a lot of where the reuse code
comes from so that's where the commodity

308
00:21:10,459 --> 00:21:13,700
ransomware and stuff comes into a lot of
times you'll search and you'll find that

309
00:21:13,700 --> 00:21:17,839
file was uploaded three months ago but
it's going through a different way to

310
00:21:17,839 --> 00:21:21,259
kind of breach the barrier so it doesn't
have to use the same kind of obfuscation

311
00:21:21,259 --> 00:21:27,979
techniques now that files not showing
virustotal that might be at a time to be

312
00:21:27,979 --> 00:21:32,119
concerned right so that might be a time
when you want to engage like your

313
00:21:32,119 --> 00:21:35,329
incident response team if you've got
something like that just letting people

314
00:21:35,329 --> 00:21:38,479
know that like we've got something that
nobody else has seen before

315
00:21:38,479 --> 00:21:44,359
it's going to take some next-level
analysis again probably it's not showing

316
00:21:44,359 --> 00:21:48,408
a virus soul you can scan it with your
regular AV but I imagine your baby's

317
00:21:48,409 --> 00:21:51,130
gonna find either

318
00:21:51,130 --> 00:21:56,140
alright so do your research check your
email logs who received the email sure

319
00:21:56,140 --> 00:22:00,940
I'm so just like I said make sure to
email out everybody that received the

320
00:22:00,940 --> 00:22:02,860
file let them know that they got the
file

321
00:22:02,860 --> 00:22:07,149
tell him not to open it and then go
through and check make sure that nobody

322
00:22:07,150 --> 00:22:10,510
open the file check your URL filtering
for those URLs we pulled out of the

323
00:22:10,510 --> 00:22:13,960
macros did anybody actually call out to
it there should be no record of that

324
00:22:13,960 --> 00:22:17,650
call being called out to and if you see
a record that somebody downloaded the

325
00:22:17,650 --> 00:22:22,240
second stage and at that point the macro
executed form so it's done

326
00:22:22,810 --> 00:22:27,250
that's when you're going to have to take
the computer and whatever your virus

327
00:22:27,250 --> 00:22:32,170
removal processes check firewall logs
for IP addresses and calls out like that

328
00:22:32,170 --> 00:22:37,180
unblock right so long term blocks are
really going to matter he's a lot of

329
00:22:37,180 --> 00:22:42,550
times the URLs and the IP addresses and
stuff they're using is a very short-term

330
00:22:42,550 --> 00:22:46,600
thing so a lot of times they're going to
use it for a day or two and they're just

331
00:22:46,600 --> 00:22:50,439
going to do the whole thing and start
over with a new URLs and stuff so you

332
00:22:50,440 --> 00:22:53,980
can block it and you can maybe set to
expire in seven days and then at the end

333
00:22:53,980 --> 00:22:56,590
of the seven days it's probably not
gonna be used anymore

334
00:22:56,590 --> 00:23:00,850
you can check maybe you want to start
with like 30 days and expired that i

335
00:23:00,850 --> 00:23:03,310
would imagine like seven days it's
probably gonna be good

336
00:23:03,310 --> 00:23:10,450
so quick wins uh how can we reduce our
overall malware stuff so blah commonly

337
00:23:10,450 --> 00:23:14,500
malicious file types were probably
already doing that but how many are you

338
00:23:14,500 --> 00:23:19,360
actually blocking there's a really great
link here how to get got 50 file

339
00:23:19,360 --> 00:23:24,340
extensions that are potentially
dangerous it's really good so check that

340
00:23:24,340 --> 00:23:24,850
out

341
00:23:24,850 --> 00:23:27,040
I can't say that you can block all of
them it's going to depend on your

342
00:23:27,040 --> 00:23:30,310
environment some of it could be
legitimate stuff if you're working with

343
00:23:30,310 --> 00:23:33,429
outsourcing or something that are
sending your powershell scripts you

344
00:23:33,430 --> 00:23:38,020
can't block powershell the other thing
you can do to kind of spoil this is the

345
00:23:38,020 --> 00:23:42,760
keynote yesterday but changing default
extensions so JavaScript by default is

346
00:23:42,760 --> 00:23:45,970
going to open up in windows script host
why does it need to do that

347
00:23:45,970 --> 00:23:50,290
who knows let's set that to you can set
that by gpo to open just in text and

348
00:23:50,290 --> 00:23:54,790
notepad so then if somebody opens it and
tries to double click that Jas it's just

349
00:23:54,790 --> 00:23:57,399
going to open up into notepad and
they're just going to see a bunch of

350
00:23:57,400 --> 00:24:02,470
garbage so I'm kind of d thinking that
and changing the file extension to

351
00:24:02,470 --> 00:24:04,900
notepad can be done for any of it

352
00:24:04,900 --> 00:24:08,260
also if you can and most of the time
it's somebody's getting a JSP file and

353
00:24:08,260 --> 00:24:09,640
they actually need to use it

354
00:24:09,640 --> 00:24:11,560
they're gonna know how to open it
properly and it's not going to matter

355
00:24:11,560 --> 00:24:16,030
that no pads default on the last
encourage trust but verify

356
00:24:16,540 --> 00:24:21,430
right so your users are smart I know
everybody all users make mistakes

357
00:24:21,430 --> 00:24:24,550
there's always the one user at the
company that makes mistakes over and

358
00:24:24,550 --> 00:24:28,120
over and over and over but you'll get
there you'll get there eventually maybe

359
00:24:28,120 --> 00:24:29,229
we can get there

360
00:24:29,230 --> 00:24:33,250
I mean just using common sense right are
you expecting files to come from this

361
00:24:33,250 --> 00:24:38,110
person are you expecting the files to
come in this format is that a common way

362
00:24:38,110 --> 00:24:41,770
that you get files from that person they
normally send your powershell scripts no

363
00:24:41,770 --> 00:24:43,180
don't open it

364
00:24:43,180 --> 00:24:48,190
these are common-sense things that we
can teach our users and really build up

365
00:24:48,190 --> 00:24:52,000
their security posture from that and
hopefully in another thing is to use

366
00:24:52,000 --> 00:24:55,870
like a second channel so if you get an
email from the you teaching your users

367
00:24:55,870 --> 00:24:59,260
that if they get an email with an
attachment to use the secondary channel

368
00:24:59,260 --> 00:25:02,320
like pick up the phone and call and say
hey did you see this file

369
00:25:02,320 --> 00:25:05,649
it's a quick phone call and if they
didn't maybe you're letting them know

370
00:25:05,650 --> 00:25:10,390
that their emails compromised and then
you're doing them a favor to so further

371
00:25:10,390 --> 00:25:13,510
reading if you're all really jazzed
about malware analysis and you want to

372
00:25:13,510 --> 00:25:17,350
get in there and do the cool stuff I
really can't recommend enough practical

373
00:25:17,350 --> 00:25:21,969
malware analysis by internet Michael
Sikorsky it's really the default the

374
00:25:21,970 --> 00:25:26,350
book for this type of stuff and it's
going to start you from 0 and at the end

375
00:25:26,350 --> 00:25:30,340
of it you're going to be a master of IDA
so it's not that walks you through

376
00:25:30,340 --> 00:25:34,240
setting up a lab watching the basic
static analysis based dynamic analysis

377
00:25:34,240 --> 00:25:39,040
disassembly debugging I mean it's
fantastic book if you put something a

378
00:25:39,040 --> 00:25:42,790
little bit more structured rensselaer
polytechnic released an open-source

379
00:25:42,790 --> 00:25:46,629
course on now where it actually uses the
practical malware analysis book is the

380
00:25:46,630 --> 00:25:50,080
course material so if you want something
that's all the more structured they have

381
00:25:50,080 --> 00:25:55,990
more labs for the malware stuff do that
and finally become the Derby con Tyler

382
00:25:55,990 --> 00:26:00,070
Hudak is a really great intro to our
analysis class I took it last year kind

383
00:26:00,070 --> 00:26:04,270
of what got me jazzed up about this on
so he's done it for the last several

384
00:26:04,270 --> 00:26:09,490
years hopefully soon it's a really good
beneficial thing so that the

