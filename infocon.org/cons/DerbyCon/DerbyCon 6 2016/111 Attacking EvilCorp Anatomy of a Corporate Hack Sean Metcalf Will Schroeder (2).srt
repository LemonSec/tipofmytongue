1
00:00:00,000 --> 00:00:03,300
some kind of password changing service
we want to dig a little bit deeper so

2
00:00:03,300 --> 00:00:08,490
using some w my numeration through
powershell an empire again we're going

3
00:00:08,490 --> 00:00:11,759
to numerate all the services that are
currently installed in the system that

4
00:00:11,759 --> 00:00:15,750
have the name past somewhere within the
name where they match that we're going

5
00:00:15,750 --> 00:00:18,930
to pull out the name of the service and
then the full binary path where the

6
00:00:18,930 --> 00:00:23,070
binary is so you see this password
changing our this password changer with

7
00:00:23,070 --> 00:00:30,060
a this kind of a you know whatever the
exe path is right we're going to go

8
00:00:30,060 --> 00:00:34,140
ahead and download this and we're again
going to take this off to like kind of

9
00:00:34,140 --> 00:00:39,870
an offline analyst machine to pull it
down and we're going to fade out and go

10
00:00:39,870 --> 00:00:44,578
into our animals machine so we're gonna
skip you would do kind of basic exe

11
00:00:44,579 --> 00:00:47,700
triage figure out what it's written in
those types of things will say we

12
00:00:47,700 --> 00:00:52,440
determine that it was written in $YEAR .
net in this case our C sharp which is

13
00:00:52,440 --> 00:00:57,780
also for us because we don't actually
have the reversing with.net and clr type

14
00:00:57,780 --> 00:01:03,660
applications and assemblies you can
throw them into a like a decompiler and

15
00:01:03,660 --> 00:01:07,530
take you can go from the common
intermediate language like kind of run

16
00:01:07,530 --> 00:01:11,369
time are the the opcodes and go straight
back to what the actual source code is

17
00:01:11,369 --> 00:01:17,790
so our favorite tool for this is DN spy
is free and open source we can just

18
00:01:17,790 --> 00:01:21,390
throw our binder in here and start
racing through you know we see also men

19
00:01:21,390 --> 00:01:25,560
here in a second we see kind of the
entry points you know this

20
00:01:25,560 --> 00:01:30,930
ok the services starting on you know see
this like create user function that

21
00:01:30,930 --> 00:01:35,460
looks like a screen and helpdesk admin
all right that's kinda weird there's a

22
00:01:35,460 --> 00:01:39,298
generate our you know this password
function okay this looks like it's some

23
00:01:39,299 --> 00:01:43,890
type of algorithm that's being used to
set whatever the local admin password is

24
00:01:43,890 --> 00:01:48,840
we see there's a date there's the
hostname there's some kind of seed that

25
00:01:48,840 --> 00:01:53,820
looks like they're combining everything
md5 being it doing some kind of string

26
00:01:53,820 --> 00:01:58,048
transformation and then you know
depending some kind of character at the

27
00:01:58,049 --> 00:02:04,110
end so this is an algorithm similar to
things we've seen in the field that the

28
00:02:04,110 --> 00:02:09,330
only secret information is the hostname
essentially and then whatever the date

29
00:02:09,330 --> 00:02:12,500
is so this is nice for us because if we
can enumerate the host

30
00:02:12,500 --> 00:02:16,070
they remotely from a machine we can
generate the local admin password and

31
00:02:16,070 --> 00:02:21,260
remotely compromise it so because
sharpen powershell are so similar is

32
00:02:21,260 --> 00:02:24,260
really really easy to take that
algorithm and pour it into powershell

33
00:02:24,260 --> 00:02:33,290
what you see here now from here we're
going to go one step further and we are

34
00:02:33,290 --> 00:02:38,870
actually going to build a custom Empire
module to execute this so right here you

35
00:02:38,870 --> 00:02:43,550
see is the similar type of algorithm
right there in that this kind of custom

36
00:02:43,550 --> 00:02:47,630
Empire module so I took just the basic
template but the powershell snippets and

37
00:02:47,630 --> 00:02:51,829
in that basic function and we're going
to pair that with w my some folk w my

38
00:02:51,830 --> 00:02:57,770
method so this will let us do remote
lateral spread through w my with the

39
00:02:57,770 --> 00:03:01,220
password being pre-generated executed
based on whatever the host name is so we

40
00:03:01,220 --> 00:03:05,600
can just give it a hostname it will go
and essentially install an agent be

41
00:03:05,600 --> 00:03:08,209
pretty cool again very similar to
something we've actually done in the

42
00:03:08,209 --> 00:03:13,070
field so now we need some target so now
it's going to scroll off here in a

43
00:03:13,070 --> 00:03:17,750
second but we're going to use a module a
Power View module with an empire and

44
00:03:17,750 --> 00:03:21,709
we're going to do right all the
computers that have the Windows 7

45
00:03:21,709 --> 00:03:26,090
operating system so we're assuming this
password change your binary is done for

46
00:03:26,090 --> 00:03:29,120
clients and we just kind of in the
little network segment where we're going

47
00:03:29,120 --> 00:03:33,590
to see what other machines they are so
we landed on sirius say and we see a sea

48
00:03:33,590 --> 00:03:37,400
critter for Freddy Kruger and jigsaw or
some of the other some of the other host

49
00:03:37,400 --> 00:03:42,920
so now I talked about pathfinding with
bloodhound you can find a path from any

50
00:03:42,920 --> 00:03:48,048
node in the graph to any other node in
the graph so instead of just spraying

51
00:03:48,049 --> 00:03:51,530
agents to every single machine that we
might have access to we wanted to do

52
00:03:51,530 --> 00:03:57,320
like kind of targeted attack path
execution so we'll gather a lot of

53
00:03:57,320 --> 00:04:00,769
information trace out exactly what we
want to do and then do targeted

54
00:04:00,769 --> 00:04:07,489
compromise on on those sections so we're
going to see is there a path from uh I

55
00:04:07,489 --> 00:04:11,000
think like jigsaw tata to the domain
controller Vader no there's not

56
00:04:11,510 --> 00:04:15,140
but there is for this of the screw
machine

57
00:04:15,140 --> 00:04:18,140
so we see it has a has a session

58
00:04:20,600 --> 00:04:28,250
whatever no I'm just got a particular
user logged in as a member of plans and

59
00:04:28,250 --> 00:04:31,700
but you see like this kind of nessa
group memberships that might have admin

60
00:04:31,700 --> 00:04:35,360
access specific machines that have
different users logged in so with the

61
00:04:35,360 --> 00:04:38,360
information that we gather in the first
numeration phase we can actually start

62
00:04:38,360 --> 00:04:42,530
tracing out a multi-step attack PAP now
we're going to flip back

63
00:04:45,169 --> 00:04:50,810
cool we're going to verify that the next
step in this mission next step in this

64
00:04:50,810 --> 00:04:52,669
attack path is actually true

65
00:04:52,669 --> 00:04:55,880
so we're gonna use one my favorite its
functionality power of you getting at

66
00:04:55,880 --> 00:05:01,700
local group it's rolled into the get
local group module Empire this will use

67
00:05:01,700 --> 00:05:06,169
the windy service provider or some API
calls in the back end to enumerate the

68
00:05:06,169 --> 00:05:11,659
members of a local group on a remote
machine so i can figure out who is a

69
00:05:11,660 --> 00:05:15,770
member of administrators and remote
machine without having elevated access

70
00:05:15,770 --> 00:05:20,000
to that machine so this really is kind
of crazy to me that you're allowed to do

71
00:05:20,000 --> 00:05:20,660
this

72
00:05:20,660 --> 00:05:25,220
Windows 10 inner Bruce tradition yeah
when Dustin anniversary edition Server

73
00:05:25,220 --> 00:05:29,690
2016 finally lock this down by default
so they're paying attention and realized

74
00:05:29,690 --> 00:05:33,979
maybe it's not the best idea to let any
user in your domain know all the local

75
00:05:33,979 --> 00:05:37,550
admin memberships of every other machine
in the domain as you'll see how this

76
00:05:37,550 --> 00:05:41,030
kind of comes into play and how we can
build these attack graphs so we verify

77
00:05:41,030 --> 00:05:46,969
ok this helpdesk admin is a local admin
on on this machine so now we're going to

78
00:05:46,970 --> 00:05:51,650
start executing our attack path we know
we can use this algorithmic like kind of

79
00:05:51,650 --> 00:05:57,770
w my module to jump to the next quarter
machine so we can set it executed in the

80
00:05:57,770 --> 00:06:02,000
back end is going to task down to
powershell to the pivot host and then

81
00:06:02,000 --> 00:06:06,200
you see it generated whatever the seed
and the password and then it executed w

82
00:06:06,200 --> 00:06:12,140
my with an empire stage on the road
system and got it back so this when we

83
00:06:12,140 --> 00:06:15,710
did something kind of like this in the
field it only took less than a day or a

84
00:06:15,710 --> 00:06:17,659
few hours to go up

85
00:06:17,660 --> 00:06:21,710
well yeah about like less than one
assessment day to go from holding down a

86
00:06:21,710 --> 00:06:26,299
binary pulling out the algorithm
building an empire module and then

87
00:06:26,300 --> 00:06:30,410
having essentially like you know an
internal kind of oday whatever not okay

88
00:06:30,410 --> 00:06:34,130
but whatever is an exploit on any
workstation the entire environment that

89
00:06:34,130 --> 00:06:37,909
made it really really awesome so the
advantage of something like empire in

90
00:06:37,910 --> 00:06:41,300
this situation is the ability to
customize these things in the field and

91
00:06:41,300 --> 00:06:46,550
kind of roll roll with this new
functionality so okay we compromise the

92
00:06:46,550 --> 00:06:53,870
helpdesk admin on this crew machine we
know that I think you lose the person is

93
00:06:53,870 --> 00:06:55,010
login here

94
00:06:55,010 --> 00:06:59,990
oh wait okay yeah so we knew that the
wave had a session here based on the

95
00:06:59,990 --> 00:07:03,410
Bloodhound data so we could steal tokens
weekend me cats or we could just

96
00:07:03,410 --> 00:07:08,330
essentially migrate into the process so
we're going to PS inject into their

97
00:07:08,330 --> 00:07:13,430
process space and assume all their token
privileges so was nice of empire it does

98
00:07:13,430 --> 00:07:16,760
a whole bunch of kind of black magic in
the back end that one my workmates

99
00:07:16,760 --> 00:07:22,640
worked up of taking ways to load up the
dotnet common language runtime into an

100
00:07:22,640 --> 00:07:26,780
unmanaged see your C++ process space
that then loads up an assembly that then

101
00:07:26,780 --> 00:07:30,890
does a powershell runner and does much
other stuff so end result what you guys

102
00:07:30,890 --> 00:07:35,419
should care about is you can run your
powershell Empire agents and processes

103
00:07:35,419 --> 00:07:40,130
that are not powerful vxc so we're going
to migrate into her process basic

104
00:07:40,130 --> 00:07:47,150
consumer privileges and then then we're
just going to use a regular w my module

105
00:07:47,150 --> 00:07:50,179
for lateral spread to move to the next .
so we're going to move to the Baltimore

106
00:07:50,180 --> 00:07:55,550
server arm because that we saw that
bloodhound attack graph that the wave

107
00:07:55,550 --> 00:07:59,300
did have access to this based on her
unrolled like multi nested group

108
00:07:59,300 --> 00:08:02,690
membership so if you adjust the
numerator that server directly you would

109
00:08:02,690 --> 00:08:06,980
have known you know does this person
have access there because these things

110
00:08:06,980 --> 00:08:11,330
to start to spider and this even though
this is a relatively simple example if

111
00:08:11,330 --> 00:08:14,990
you can think about these things that
scale if you're thinking about thousands

112
00:08:14,990 --> 00:08:18,980
of groups or thousands of users and
systems there is no way that you're

113
00:08:18,980 --> 00:08:23,600
going to be able like by hand to find
every single attack path you might get

114
00:08:23,600 --> 00:08:26,600
lucky and find one but you're not going
to find all

115
00:08:28,529 --> 00:08:33,149
ok so now from here we know that the
wave has access

116
00:08:33,779 --> 00:08:36,779
I wait with it yet

117
00:08:37,438 --> 00:08:43,289
ok yeah so Eric Cartman is a domain
admin respect authority that the this is

118
00:08:43,289 --> 00:08:46,980
the research and development group they
have their own domain because of this

119
00:08:46,980 --> 00:08:49,889
reason they kind of do their own thing
so we have our production environment

120
00:08:49,889 --> 00:08:53,819
another demand the same for so we're
fine like going yeah yeah we'll see

121
00:08:55,290 --> 00:09:00,029
oh ok now the last kind of lateral
spread them to go over is something

122
00:09:00,029 --> 00:09:04,529
called subversive profiles has anyone
heard of PowerShell profiles or a little

123
00:09:04,529 --> 00:09:08,759
bit a few people's ok whenever
powershell txt starts up whether it's

124
00:09:08,759 --> 00:09:12,930
the ISE or regular powershell dxc it
looks through a series of locations

125
00:09:12,930 --> 00:09:17,189
which i'll highlight here in a second
for your profile your profile . ps1 the

126
00:09:17,189 --> 00:09:20,610
set of PowerShell code that's normally
used for like she'll customizations and

127
00:09:20,610 --> 00:09:21,689
things like that

128
00:09:21,689 --> 00:09:26,998
now whenever so whenever powershell that
exe starts it's going to execute

129
00:09:26,999 --> 00:09:30,689
whatever code is in that profile so
there's a blog post which I'll show in a

130
00:09:30,689 --> 00:09:35,309
second where Mack graber my boss in the
next room talked about attackers

131
00:09:35,309 --> 00:09:39,149
potentially using the subversively for
persistence we're going to use it for

132
00:09:39,149 --> 00:09:43,649
lateral spread to get around script
block logging so essentially what's

133
00:09:43,649 --> 00:09:47,819
going to happen is we're going to
generate the zoom in a second we're

134
00:09:47,819 --> 00:09:53,639
going to generate your empire launcher
your empire launcher code and then using

135
00:09:53,639 --> 00:09:57,089
Wi-Fi remote registry we're going to
push it over to a value on the remote

136
00:09:57,089 --> 00:10:02,069
system execute command that pulls it
down and saves that malicious logic to a

137
00:10:02,069 --> 00:10:07,079
profile that ps1 and like the the
powershell program files are the see you

138
00:10:07,079 --> 00:10:11,339
know system32 windows powershell profile
be one thing then we're going to execute

139
00:10:11,339 --> 00:10:16,649
powershell txt on the host its going to
start load the profile executor actual

140
00:10:16,649 --> 00:10:20,220
logic is going to kill itself and then
we're going to restore with the original

141
00:10:20,220 --> 00:10:24,120
profile ps1 is so all the client will
see or if you're doing command-line

142
00:10:24,120 --> 00:10:27,360
login or carbon black or anything like
that is really awesome solutions you're

143
00:10:27,360 --> 00:10:30,160
just going to see powershell BAC
starting no command

144
00:10:30,160 --> 00:10:34,959
no command line flags no command line
whatever else is not doing Dash f4 file

145
00:10:34,959 --> 00:10:36,310
or anything like that

146
00:10:36,310 --> 00:10:39,008
then if they did have an original
profile like this system will be

147
00:10:39,009 --> 00:10:43,209
completely cleaned up so this modules
and public yet we just need to clean up

148
00:10:43,209 --> 00:10:46,540
a couple of things and we're going to
release it in the next month or so

149
00:10:46,540 --> 00:10:51,250
so this is the blog post that Matt put
out so investigating subversive power

150
00:10:51,250 --> 00:10:56,649
show profiles highly recommend everybody
ingredients so pretty cool so again he

151
00:10:56,649 --> 00:11:00,970
kind of talked about this from dfi our
perspective of you want to ensure that

152
00:11:00,970 --> 00:11:07,959
you know you pull all profile . ps1 when
you're doing ironing machine for us it

153
00:11:07,959 --> 00:11:10,209
doesn't really matter because we're
using it for lateral spreading out

154
00:11:10,209 --> 00:11:14,709
persistence and we repair and clean
everything up so there's you know we're

155
00:11:14,709 --> 00:11:19,268
not really leaving any traces so again
nothing super super crazy but we thought

156
00:11:19,269 --> 00:11:25,029
a kind of a cool new little lateral
spread method but uh no command line

157
00:11:25,029 --> 00:11:28,180
logging has become a more and more of a
pain over the last year

158
00:11:28,720 --> 00:11:35,529
ok so because of the local admin
password changing executable you took

159
00:11:35,529 --> 00:11:41,019
advantage of the fact that the algorithm
wasn't secure as possible etc figured

160
00:11:41,019 --> 00:11:44,199
out what that password was on a
different machine and then leverage that

161
00:11:44,199 --> 00:11:48,550
information to jump 21 with the domain
admin and then using powershell family

162
00:11:48,550 --> 00:11:51,279
to then run your code on our domain
controller

163
00:11:51,279 --> 00:11:54,819
yeah so you know you see up there are
creating the profile pushing it over

164
00:11:54,819 --> 00:11:59,709
executing powershell THC we get an agent
back and repairing the profile so okay

165
00:11:59,709 --> 00:12:03,279
let's say we take care of that then
we're good right oh yeah sure

166
00:12:05,000 --> 00:12:24,590
alright so that was attacking client to
client how many you guys Proust on a

167
00:12:24,590 --> 00:12:30,140
regular basis anybody all right if
you're not you absolutely should be so

168
00:12:30,140 --> 00:12:38,360
kerberos team kerberos ting involves the
abuse of user accounts that have SPN set

169
00:12:38,360 --> 00:12:43,310
so ESPN's or service principal names are
configured for service accounts to kind

170
00:12:43,310 --> 00:12:48,290
of enable the authentication flow for
kerberos and the normal Active Directory

171
00:12:48,290 --> 00:12:54,949
domains so when a user request a service
ticket at TGS on it its ends

172
00:12:54,950 --> 00:12:58,220
I he I keep forgetting exactly how like
this

173
00:12:58,220 --> 00:13:02,750
kerberos is extremely complicated but
when a user request the TGS it will send

174
00:13:02,750 --> 00:13:07,490
the request for the exact spin with the
user account to the domain controller

175
00:13:07,490 --> 00:13:10,550
which will actually go through the
kerberos negotiation process and the end

176
00:13:10,550 --> 00:13:15,410
result is you get a TGS that sit back
down to the user curve roasting you can

177
00:13:15,410 --> 00:13:20,120
request these tickets as a regular user
non non admin on and those tickets are

178
00:13:20,120 --> 00:13:23,810
going to be saved in your current
process space you can extract these

179
00:13:23,810 --> 00:13:27,739
because you own your current process
space extracting and transform them into

180
00:13:27,740 --> 00:13:32,089
such a way that you can then export the
McCracken with hash kapoor John so it's

181
00:13:32,089 --> 00:13:36,770
a way to depending on the service
accounts are configured be able to

182
00:13:36,770 --> 00:13:42,079
brute-force offline service account
passwords and service account passwords

183
00:13:42,080 --> 00:13:45,710
usually don't change very often write
like they're they're usually around for

184
00:13:45,710 --> 00:13:46,730
a long long time

185
00:13:46,730 --> 00:13:50,720
so previously when you wanted to
kerberos you would do a bunch of

186
00:13:50,720 --> 00:13:54,980
one-liners no mom it's intimidating a
year year-and-a-half ago I think he

187
00:13:54,980 --> 00:13:58,190
talked to derby last year had you know
kinda came up with a lot of this

188
00:13:58,190 --> 00:14:01,430
research and then had all these
one-liners request request the tickets

189
00:14:01,430 --> 00:14:04,910
and you could use mimic cats to extract
the tickets out of memory either to

190
00:14:04,910 --> 00:14:10,010
discard like kind of a 64 encoding blobs
now thanks to a poor request by

191
00:14:10,880 --> 00:14:17,030
i think is macho sec from on the power
view the power of you prod the power of

192
00:14:17,030 --> 00:14:21,230
you code in PowerPoint there's a much
much easier way to do this without

193
00:14:21,230 --> 00:14:27,650
needing mccants so first we're going to
check whether our targets we're gonna

194
00:14:27,650 --> 00:14:33,949
use the the get user module in Empire
which wraps get net user in a Power View

195
00:14:33,950 --> 00:14:39,290
and there's a spin flag which will
return all users on Noel's ESPN set in

196
00:14:39,290 --> 00:14:44,030
the entire domain so again these are the
targeted accounts that we may be able to

197
00:14:44,030 --> 00:14:48,110
kerberos so it's going to task
everything in the back end is going to

198
00:14:48,110 --> 00:14:53,330
execute it and we should get the results
back for i think in this kind of sample

199
00:14:53,330 --> 00:14:57,560
there's three let's see we have a we
have the ring we have Death Star and we

200
00:14:57,560 --> 00:15:03,469
have a white Walker somewhere up there i
think yeah okay so we have three

201
00:15:03,470 --> 00:15:07,430
different service accounts that we may
be able to prost now we're going to go

202
00:15:07,430 --> 00:15:11,030
back to our blood analysis platform and
again instead of purchase kerberos seen

203
00:15:11,030 --> 00:15:13,430
everything and trying to exploit
everything we're gonna do targeted

204
00:15:13,430 --> 00:15:16,849
compromise so we're going to see is that
our paths from any of these three

205
00:15:16,850 --> 00:15:22,190
service accounts to the domain admins
group a bloodhound like the first one no

206
00:15:22,190 --> 00:15:27,650
let's see does her know it doesn't look
like there's a path but for white Walker

207
00:15:27,650 --> 00:15:33,949
there is a bath a white Walker which is
a member of house Bolton and then member

208
00:15:33,950 --> 00:15:37,610
of the guild the clams 10 which has
access to that same Baltimore server

209
00:15:37,610 --> 00:15:41,390
that we used in the previous attack
chain so we know that if we cover the

210
00:15:41,390 --> 00:15:44,900
plaintext credentials for the white
Walker service account through nessa

211
00:15:44,900 --> 00:15:48,980
group membership we should be able to
compromise that same server migrated to

212
00:15:48,980 --> 00:15:53,210
Eric Cartman's process again and then
kind of go about the similar parts of

213
00:15:53,210 --> 00:16:02,270
the attaching so now let's kerberos the
get yeah it's been tickets model this is

214
00:16:02,270 --> 00:16:08,060
it's so nice this is a nam Empire too .
oh that was released yesterday so you

215
00:16:08,060 --> 00:16:12,770
can either if you don't set any user
account request all tickets if you like

216
00:16:12,770 --> 00:16:16,579
in this particular case we know we just
want one with white Walker and instead

217
00:16:16,580 --> 00:16:20,210
of doing all that stuff and running
mechanics and doing multiple stages is

218
00:16:20,210 --> 00:16:24,800
just one file its going to execute it
down it's only like a dozen or so lines

219
00:16:24,800 --> 00:16:27,620
powershell and you can pull the
encrypted component of the ticket out of

220
00:16:27,620 --> 00:16:28,880
memory so

221
00:16:28,880 --> 00:16:34,550
oh and it will preform at it ready for
cracking for John so like way way easier

222
00:16:34,550 --> 00:16:38,270
it's just like one single step you could
run this essentially and through

223
00:16:38,270 --> 00:16:41,150
whatever age you want you could run this
through interpreter you can run this

224
00:16:41,150 --> 00:16:46,670
through couple strike or whatever with
the ps1 or we're going to switch over to

225
00:16:46,670 --> 00:16:50,660
the tickets saved off for John we're
going to go ahead and see if we can

226
00:16:50,660 --> 00:16:52,219
crack it

227
00:16:52,220 --> 00:16:57,830
so again just literally copied that text
straight over already pretty kind of

228
00:16:57,830 --> 00:17:02,570
formatted for the cracking format for
you guys and we see White Walkers

229
00:17:02,570 --> 00:17:08,540
password is jon snow sucks okay like I
said these are already folks they like

230
00:17:08,540 --> 00:17:13,220
it with arms i'm gonna have some
conversations with them so now we know

231
00:17:13,220 --> 00:17:17,689
the plaintext credentials for the
service account that lets start to

232
00:17:17,689 --> 00:17:22,010
execute that attack path so with the
invoke w my module and Empire you can

233
00:17:22,010 --> 00:17:26,869
you don't have to use the current users
credential set you can specify plaintext

234
00:17:26,869 --> 00:17:28,399
credentials if you like

235
00:17:28,400 --> 00:17:33,260
so we're going to set the credentials
for this white Walker service account we

236
00:17:33,260 --> 00:17:37,490
are going to set the target to be that
that kind of Baltimore server that we

237
00:17:37,490 --> 00:17:40,520
were able to spread to with an
additional hop from you know the client

238
00:17:40,520 --> 00:17:47,420
side with the password change your
binary executed get our agent back we're

239
00:17:47,420 --> 00:17:50,870
going to do the similar you know the
same couple of steps that we did in the

240
00:17:50,870 --> 00:17:55,250
previous demo to where we do our
numeration of what what processes are

241
00:17:55,250 --> 00:17:58,580
running because we know from the graph
that a user has to be logged on and

242
00:17:58,580 --> 00:18:06,800
logged on we're going to PS inject into
this process is injected into this

243
00:18:06,800 --> 00:18:13,220
process again it's going to do all that
kind of crazy you know . net stuff

244
00:18:13,220 --> 00:18:16,730
loading up on the backend which i think
is like one of the coolest coolest

245
00:18:16,730 --> 00:18:23,030
features of the project we should get
our new agent back here in a second and

246
00:18:23,030 --> 00:18:28,879
now instead of spreading an agent to a
domain controller general we want to

247
00:18:28,880 --> 00:18:31,450
probably try to stay FDCs as much as we
can

248
00:18:31,450 --> 00:18:36,639
we're going to be a bit healthier and
use DC sink has anyone used e sink

249
00:18:36,639 --> 00:18:43,059
hopefully a good chunk of people yet so
DC sink was a module for many cats

250
00:18:43,059 --> 00:18:48,908
written by pimentel be gentle kiwi and
Vincent towed it allows you to simulate

251
00:18:48,909 --> 00:18:53,980
DC replication traffic so the normal
kind of traffic protocol that's used to

252
00:18:53,980 --> 00:18:57,309
replicate like password and let user
information data between domain

253
00:18:57,309 --> 00:19:02,230
controllers with mimic as you can now
say on a client and Jaime Katz and i'll

254
00:19:02,230 --> 00:19:05,019
say hey domain controller i'm also the
main controller please give me this

255
00:19:05,019 --> 00:19:09,760
password assuming you have domain admin
rights so we do have da rates now but

256
00:19:09,760 --> 00:19:14,080
this is a way to replicate that hash and
historical password information for

257
00:19:14,080 --> 00:19:19,210
whatever account we want without running
an agent or any type of actual code on

258
00:19:19,210 --> 00:19:27,190
the DC so we're going to set the user
account for where the really . ppl Corp

259
00:19:27,190 --> 00:19:32,620
domain we have the care BTW that's going
to execute this and will inject me cats

260
00:19:32,620 --> 00:19:37,600
down do that d sync functionality and
Empire also has a really nice credential

261
00:19:37,600 --> 00:19:41,408
store in the back and they can almost
act as a golden ticket catalog so it

262
00:19:41,409 --> 00:19:45,820
will automatically screaming cats output
and save all the information for you in

263
00:19:45,820 --> 00:19:51,070
the back end so we see let's see a fader
fader . really evil corporate domain

264
00:19:51,070 --> 00:19:56,678
controller so saved everything out if
you type Reds you see that everything is

265
00:19:56,679 --> 00:20:00,010
saved is going to say about the domain
sit and everything else will show in the

266
00:20:00,010 --> 00:20:05,320
next part of the demo how easy it is
after EDC sink or ash dump to use the

267
00:20:05,320 --> 00:20:07,360
credential stores a golden ticket
counter

268
00:20:07,360 --> 00:20:11,918
ok so alright lot of stuff going on here

269
00:20:11,919 --> 00:20:17,799
um so you were able to get a service
ticket for this kerberos service account

270
00:20:17,799 --> 00:20:22,629
and basically take that ticket crack it
offline because of how progress works

271
00:20:22,630 --> 00:20:26,260
and then use that password because a
horrible password

272
00:20:26,830 --> 00:20:32,980
pretty easily obviously in order to gain
access to get domain admin access on

273
00:20:32,980 --> 00:20:37,390
this argument so when you do this blood
and stuff and pull the information from

274
00:20:37,390 --> 00:20:43,210
the environment is not a traffic note so
I mean we do the numeration once and the

275
00:20:43,210 --> 00:20:47,200
collection component can either be as
noisy years by kind of is we want you

276
00:20:47,200 --> 00:20:51,039
know / situation and after that all the
queries have been offline so we're not

277
00:20:51,039 --> 00:20:57,340
doing additional l decorators every time
in the the traffic itself is just ldap

278
00:20:57,340 --> 00:21:01,178
enumeration for the most part for any
any type of the user group on rolling

279
00:21:01,179 --> 00:21:05,649
and then it's a handful of like kind of
typical API calls with a remote nets

280
00:21:05,649 --> 00:21:09,340
session and nam type things like in the
back end that are going up against a

281
00:21:09,340 --> 00:21:13,689
couple of your servers at this point the
only thing that i know of there's

282
00:21:13,690 --> 00:21:16,510
probably some commercial products that
can detect some of these components the

283
00:21:16,510 --> 00:21:21,010
main one that i know of his microsoft
ATA for i think is an adaptive or

284
00:21:21,010 --> 00:21:26,379
advanced threat analytics it can detect
the remote session enumeration against a

285
00:21:26,380 --> 00:21:29,440
domain controller if its installed but
it won't detect against all these are

286
00:21:29,440 --> 00:21:32,919
the servers at this point they don't
detect kind of anomalous ldap

287
00:21:32,919 --> 00:21:36,820
enumeration traffic they say that that's
coming which kind of terrifies me but

288
00:21:36,820 --> 00:21:42,460
we'll see because there's so many
devices are so many things that you know

289
00:21:42,460 --> 00:21:45,730
all networked printers and address books
and all this kind of crap that needs

290
00:21:45,730 --> 00:21:50,139
ldap and plugs in the ldap so there's a
reason that people haven't you know walk

291
00:21:50,139 --> 00:21:54,939
down people running internet the next
group domain admins on domains because

292
00:21:54,940 --> 00:21:58,090
lots of things plug into this
functionality active directory is meant

293
00:21:58,090 --> 00:22:03,820
to be a directory for things look up
information i was Server 2016 there is

294
00:22:03,820 --> 00:22:08,379
the ability to they've introduced ackles
that will let you lock down who can

295
00:22:08,380 --> 00:22:12,399
enumerate what information the domain is
also kind of scary but that's not

296
00:22:12,399 --> 00:22:15,549
enabled by default and we all know I
mean we all know that all clients will

297
00:22:15,549 --> 00:22:18,940
enable and configure perfectly as soon
as it comes out so I'm sure that will

298
00:22:18,940 --> 00:22:20,280
happen

299
00:22:20,280 --> 00:22:26,760
so now we saw you know there is we're in
a really evil Corps domain we were in a

300
00:22:26,760 --> 00:22:30,270
child domain and a forest so you guys
have some kind of like Boris trust

301
00:22:30,270 --> 00:22:33,450
relationship so here we go

302
00:22:33,450 --> 00:22:39,270
ok so we're going to go back to our
initial pivots or unprivileged user on

303
00:22:39,270 --> 00:22:43,920
of Ramsay Bolton cirse with without any
kind of privileges and because we d/c

304
00:22:43,920 --> 00:22:50,130
synced what we're going to do is kind of
the sid sid trust hopping attack to

305
00:22:50,130 --> 00:22:54,990
elevate from the child domain all the
way up to the parenting normally trust

306
00:22:54,990 --> 00:22:58,290
will flow down from the force route down
to everything else if your enterprise

307
00:22:58,290 --> 00:23:02,970
admin great about a year ago on this
researcher named John Metcalf and

308
00:23:02,970 --> 00:23:08,640
Benjamin delpy worked out a way to
really weaponize ati an attack that's

309
00:23:08,640 --> 00:23:12,840
been theoretical for about ten years
which if you have domains within a

310
00:23:12,840 --> 00:23:19,050
forest and you compromise any domain
admin rights are any if you compromise a

311
00:23:19,050 --> 00:23:24,149
domain controller the kar bt or whatever
within anywhere within the forest if you

312
00:23:24,150 --> 00:23:28,380
can modify the CID history for a
particular user and set the city history

313
00:23:28,380 --> 00:23:32,190
to be enterprise admin is you can
instantly compromise the root of the

314
00:23:32,190 --> 00:23:37,470
entire forest so you can hop up i know
this is like this blew my mind when I

315
00:23:37,470 --> 00:23:40,320
first kind of learned about it and I
didn't really believe it but we've done

316
00:23:40,320 --> 00:23:45,389
in the field and it works so Sid history
is a migration function arts function to

317
00:23:45,390 --> 00:23:49,350
facilitate migration between domain so
if you had like going from domain be a

318
00:23:49,350 --> 00:23:53,459
domain a the idea would be when you take
those users and migrate the menu set the

319
00:23:53,460 --> 00:23:58,590
CID history to be that Sid security
identifier of their old groups so this

320
00:23:58,590 --> 00:24:03,360
would preserve their access to the old
groups on again the idea was meant for

321
00:24:03,360 --> 00:24:07,530
migration but people realize 10 years
ago that a theoretical attack was

322
00:24:07,530 --> 00:24:11,399
possible to earth you could modify the
city history for user to be enterprise

323
00:24:11,400 --> 00:24:16,440
admins then you became an enterprise
admin within the forest but in order to

324
00:24:16,440 --> 00:24:21,180
do this previously you had to like hard
modify stuff in the NTS dat it's a super

325
00:24:21,180 --> 00:24:25,650
super super protective attribute as john
Payne he asked modified but with the

326
00:24:25,650 --> 00:24:27,070
golden ticket component

327
00:24:27,070 --> 00:24:32,320
that figured out you can set this
history the golden ticket inject it and

328
00:24:32,320 --> 00:24:36,970
then just instantly hop-up so is finally
fully weaponized so the one bit of

329
00:24:36,970 --> 00:24:43,149
information we need last bit of
information we need is the the city of

330
00:24:43,149 --> 00:24:47,139
the root domain so we know the city of
our child domain but we want the city of

331
00:24:47,139 --> 00:24:52,658
ppl Corp an easy way to do this is with
the this user to sit functionality from

332
00:24:52,659 --> 00:24:56,470
power of your empire just take that
username and i'll translate it to the

333
00:24:56,470 --> 00:25:00,789
full security identifier so we know care
BTW always has to be there so that's the

334
00:25:00,789 --> 00:25:05,408
one i tend to use going to copy off the
domain said we need that to create thats

335
00:25:05,409 --> 00:25:11,320
it dash 519 is the city for enterprise
atoms for the forest now we're gonna

336
00:25:11,320 --> 00:25:13,240
create a golden ticket

337
00:25:13,240 --> 00:25:18,730
I mention that I credit the credit or so
you what's really nice is if any Empire

338
00:25:18,730 --> 00:25:23,470
modules have credit ID it all except
just a number of the credit or that will

339
00:25:23,470 --> 00:25:28,059
automatically auto-populate and fill in
the care of ETFs the domain of the

340
00:25:28,059 --> 00:25:32,289
domains original sin all those company
components so you can again use it kinda

341
00:25:32,289 --> 00:25:37,360
like a golden ticket catalog and i'll
scroll up the screen i'll do an info to

342
00:25:37,360 --> 00:25:42,668
kind of show you all the stuff over
setting the SIDS so the extra SIDS to be

343
00:25:42,669 --> 00:25:47,860
the fourth roots it dash 5 194
enterprise admins and also does anyone

344
00:25:47,860 --> 00:25:51,399
know about the 20 minute rule with
golden tickets a little bit it's a

345
00:25:51,399 --> 00:25:55,059
little bit on the more familiar for
people if you create a golden ticket

346
00:25:56,529 --> 00:26:00,159
you have 20 minutes to run around with
it before the domain controller verifies

347
00:26:00,159 --> 00:26:03,460
that account exists or not that's the
only validation that they do they don't

348
00:26:03,460 --> 00:26:07,090
verify like is this user in the right
groups or whatever they verify the

349
00:26:07,090 --> 00:26:12,158
account exists so if you create a golden
ticket for user that does not exist in

350
00:26:12,159 --> 00:26:15,370
the domain you have 20 minutes to run
around and then really have fun with

351
00:26:15,370 --> 00:26:20,289
event logs for with defenders so I've
known people that may or may not have a

352
00:26:20,289 --> 00:26:24,309
cross-site scripting defender sim
solutions by stuffing JavaScript into

353
00:26:24,309 --> 00:26:26,710
the user account names but on that's
another story

354
00:26:26,710 --> 00:26:35,889
so I root said Dash 5 19 right as soon
as we inject this we should essentially

355
00:26:35,889 --> 00:26:39,699
be common enterprise admin instantly
again showing that just kind of that

356
00:26:39,700 --> 00:26:41,679
trust graph this is a simple one

357
00:26:41,679 --> 00:26:44,799
if you have a really complex environment
you know it becomes a little easier to

358
00:26:44,799 --> 00:26:47,230
to navigate a bloodhound

359
00:26:47,230 --> 00:26:51,429
so we're going to execute it and it will
also do pass the ticket so it won't save

360
00:26:51,429 --> 00:26:55,690
anything out to disconnect the ticket
straight into memory which we can purge

361
00:26:55,690 --> 00:26:59,049
later if we need to come on

362
00:26:59,049 --> 00:27:04,179
alright and this in the back end this is
all using invoke mimic cats which was

363
00:27:04,179 --> 00:27:10,000
based off of work by Joby ellicott at
Microsoft so he was one of the guys are

364
00:27:10,000 --> 00:27:13,029
really introduced a lot of awesome
functionality into the power supply

365
00:27:13,029 --> 00:27:17,740
project so we see here we have that high
that user doesn't exist that followed

366
00:27:17,740 --> 00:27:22,090
the blue team and then we have extra
cities to be that dumb the forest route

367
00:27:22,090 --> 00:27:27,699
Sid dash 509 for enterprise advents so
now the last part we're going to do is

368
00:27:27,700 --> 00:27:34,419
we're just going to go ahead d sink the
forest group I know arm i don't know if

369
00:27:34,419 --> 00:27:38,470
you've had the advice to change your
care BTW account

370
00:27:38,470 --> 00:27:43,240
yes actually we rotate that
automatically every couple hours okay

371
00:27:43,240 --> 00:27:46,720
you just told me that would fix .
tickets you just do that in the forest

372
00:27:46,720 --> 00:27:47,409
route

373
00:27:47,409 --> 00:27:53,379
yes that's for production of our yet so
the really fun thing with the CID

374
00:27:53,379 --> 00:27:59,559
hopping kind of attack is in order to
ensure that you're not compromise

375
00:27:59,559 --> 00:28:00,309
forever

376
00:28:00,309 --> 00:28:07,059
you would have to rotate the kar bt
account on every domain and every domain

377
00:28:07,059 --> 00:28:12,820
in your entire forest all at the same
time because essentially any care BTW

378
00:28:12,820 --> 00:28:17,019
account in any child domain controller
in the forest can be used to compromise

379
00:28:17,019 --> 00:28:21,279
the forest route and anything else so
and this is hopping attack it doesn't

380
00:28:21,279 --> 00:28:24,940
matter of the Caribbean TGT rotates we
just got it within a minute we get you

381
00:28:24,940 --> 00:28:31,480
know hop up in DC but yet you have to
rotate it for every single domain in

382
00:28:31,480 --> 00:28:35,649
your entire force at the same time
repeatedly on a regular basis if you

383
00:28:35,649 --> 00:28:38,379
want to ensure that you're not gonna
completely compromise because it

384
00:28:38,379 --> 00:28:39,830
comprises a child domain

385
00:28:39,830 --> 00:28:43,760
and then you rotate up few other things
they forgot one of the children domains

386
00:28:43,760 --> 00:28:49,850
then you can just hop back in not get
your exs again and go down ok so from my

387
00:28:49,850 --> 00:28:55,428
rd domain in my active directory forest
you compromise that the then jump to my

388
00:28:55,429 --> 00:28:59,990
production environment and now have full
domain admin rights of my to name my

389
00:28:59,990 --> 00:29:03,169
forest you okay that's pretty awful

390
00:29:04,700 --> 00:29:11,809
I so the thing I don't get is I spend
millions of dollars every year and

391
00:29:11,809 --> 00:29:17,090
security tools i mean i have vendors
coming in all the time and they say that

392
00:29:17,090 --> 00:29:24,740
they have the best security and i've got
i showed you got trucks are wolves and I

393
00:29:24,740 --> 00:29:30,679
mean the web content filtering didn't
matter an email didn't matter none of

394
00:29:30,679 --> 00:29:34,340
these things seem to matter in and like
we we detect many cats like we have

395
00:29:34,340 --> 00:29:40,340
antivirus but you said use PowerShell a
lot so it's it seems like you're a very

396
00:29:40,340 --> 00:29:43,399
smart guy and I've got great security
people

397
00:29:43,399 --> 00:29:48,110
what am I supposed to do I mean you know
obviously come like these fine people

398
00:29:48,110 --> 00:29:51,918
come to conferences come to things like
the Recon you know go have conversations

399
00:29:51,919 --> 00:29:55,130
with people in hallway con you go to
trainings there's a lot of you know

400
00:29:55,130 --> 00:29:58,549
really good kind of 80 type stuff out
there so people are starting to pay more

401
00:29:58,549 --> 00:30:02,929
attention zat Active Directory
exploitation in the last couple years so

402
00:30:02,929 --> 00:30:05,870
we're we're happy about this and there's
a lot of information out there for

403
00:30:05,870 --> 00:30:09,439
people 14 ok so it sounds like maybe I
need to invest more in my people instead

404
00:30:09,440 --> 00:30:13,639
of the products and focus one give me
all the money

405
00:30:16,650 --> 00:30:26,400
so I learned a lot today and and I
appreciate your help with as well and

406
00:30:26,400 --> 00:30:31,260
and if I I i guess i need to send my
people the more conferences they keep

407
00:30:31,260 --> 00:30:34,260
asking me and I'm like yeah you're just
going to party and drink and and it

408
00:30:34,260 --> 00:30:38,610
seems like that's part of the experience
but apparently there's a lot of good

409
00:30:38,610 --> 00:30:42,179
things to be learned conferences and in
going to training and this is the real

410
00:30:42,180 --> 00:30:46,200
thing that's going to help security as I
thought we had some pretty good security

411
00:30:46,200 --> 00:30:56,460
place it and seen

412
00:31:04,940 --> 00:31:07,760
yeah

413
00:31:07,760 --> 00:31:13,280
so let's talk some mitigations arm the
initial foothold was pretty intense

414
00:31:13,280 --> 00:31:17,720
right there's a lot of different things
you can do to mitigate these sort of

415
00:31:17,720 --> 00:31:23,840
attacks not specifically this kind of
oily functionality within an email that

416
00:31:23,840 --> 00:31:28,399
comes to the user but deploy Emmett
because that will help prevent and

417
00:31:28,400 --> 00:31:33,710
mitigate those memory attacks that they
can use AppLocker can block executable

418
00:31:33,710 --> 00:31:38,060
content from running and user locations
like home directory profile path and

419
00:31:38,060 --> 00:31:42,320
often ransomware takes advantage of this
user runs download something and they

420
00:31:42,320 --> 00:31:46,490
executed and runs so you can use
whitelisting this is more like

421
00:31:46,490 --> 00:31:50,480
blacklisting you block certain locations
so they can't actually execute the

422
00:31:50,480 --> 00:31:54,410
content you can manage car show
execution using a blocker or constrain

423
00:31:54,410 --> 00:31:55,880
language mode

424
00:31:55,880 --> 00:31:59,870
Matt next door's probably has some ways
around that but again these are all

425
00:31:59,870 --> 00:32:04,040
layers and your security just because
one layer can be defeated doesn't mean

426
00:32:04,040 --> 00:32:08,360
you shouldn't put in flakes as engineers
we often want a hundred percent solution

427
00:32:08,960 --> 00:32:13,370
you do not need a hundred percent
solution forty fifty sixty percent is

428
00:32:13,370 --> 00:32:17,989
better than nothing and it forces the
attacker to change their methodology and

429
00:32:17,990 --> 00:32:21,800
makes it more expensive so you want to
enable logging like PowerShell command

430
00:32:21,800 --> 00:32:25,460
process obviously block office macros
were possible

431
00:32:25,460 --> 00:32:31,010
microsoft is back for it functionality
from 2016 and 2013 so any macros that

432
00:32:31,010 --> 00:32:34,129
come from the internet or automatically
blocking the user can actually execute

433
00:32:34,130 --> 00:32:37,370
and then you want to deploy some sort of
security tooling that looks for

434
00:32:37,370 --> 00:32:42,229
suspicion this is behavior if the user
has word that's calling powershell or

435
00:32:42,230 --> 00:32:47,180
some other executable or doing something
else back it's probably back we can also

436
00:32:47,180 --> 00:32:50,450
limit this capability as far as
executables that get onto the system

437
00:32:50,450 --> 00:32:55,850
executable tight content blocking email
and download capability for certain

438
00:32:55,850 --> 00:33:00,320
types of files you can also change the
default program for scripting languages

439
00:33:00,320 --> 00:33:05,330
javascript can actually be double click
on and executed by a user we don't want

440
00:33:05,330 --> 00:33:10,790
that change that to notepad please test
first recon is a tough solution tough

441
00:33:10,790 --> 00:33:15,560
problem the saw 80 recon active
directory is an LDAP directory so that

442
00:33:15,560 --> 00:33:18,440
means you can pull pretty much
everything from at any given time

443
00:33:18,440 --> 00:33:23,120
but there are ways to kind of limit this
if you increase the security on

444
00:33:23,120 --> 00:33:27,979
sensitive gpo's like security group to
group policies than the attacker doesn't

445
00:33:27,980 --> 00:33:30,409
have an advantage of just pulling
everything that's in those group

446
00:33:30,409 --> 00:33:34,730
policies opening them up and knowing how
your security tools like AppLocker amat

447
00:33:34,730 --> 00:33:38,120
and others are configured as well as
what you have out there and certainly

448
00:33:38,120 --> 00:33:42,918
evaluate some sort of behavior analytics
tool like a TA we're talking about

449
00:33:42,919 --> 00:33:46,820
lateral movement attackers moving from
place to place within your environment

450
00:33:46,820 --> 00:33:51,769
we want to make sure that the attacker
isn't able to just run free if they drop

451
00:33:51,769 --> 00:33:55,970
on a workstation if you block
workstation workstation communication or

452
00:33:55,970 --> 00:34:01,100
just allow specific ports then they are
constrained into a specific computer or

453
00:34:01,100 --> 00:34:05,149
environment and it's very difficult to
jump out of that look at laughs look at

454
00:34:05,149 --> 00:34:10,429
trusted second ships ways to change your
local admin passwords that are out there

455
00:34:10,429 --> 00:34:14,300
do not try to roll your own there are
some good solutions out there that work

456
00:34:14,300 --> 00:34:20,000
very well privilege escalation i still
find some passwords insist ball please

457
00:34:20,000 --> 00:34:23,270
make sure that you don't have a suite
consists all and we're talking about

458
00:34:23,270 --> 00:34:26,839
kerberos ting the simple solution of
this is make sure your service account

459
00:34:26,839 --> 00:34:31,639
passwords or at least 25 characters
preferably 30 or use managed service

460
00:34:31,639 --> 00:34:35,480
accounts or get a password tool that
will automatically change those

461
00:34:35,480 --> 00:34:39,440
passwords for you make them super long
and complex the longer they are the more

462
00:34:39,440 --> 00:34:45,319
difficult it is to be craft and if we
make sure our computers running ntlm v2

463
00:34:45,319 --> 00:34:50,239
or kerberos it's a lot more difficult
for passive credential theft like

464
00:34:50,239 --> 00:34:55,638
responder to actually work which brings
me to admin creds if we make sure that

465
00:34:55,639 --> 00:35:01,550
all of our admins only log onto specific
authorized admin systems we can raise

466
00:35:01,550 --> 00:35:05,060
the bar and make it more difficult for
those credentials to be stolen if you

467
00:35:05,060 --> 00:35:09,529
add your admin accounts protected users
which comes available in 2012

468
00:35:09,530 --> 00:35:14,450
then they are not able to be delegated
and they don't support insecure ntlm

469
00:35:14,450 --> 00:35:20,029
authentication you also want to reduce
the surface the attack surface of your

470
00:35:20,030 --> 00:35:23,569
workstations and servers that are used
for admin accounts so control access

471
00:35:23,569 --> 00:35:26,080
remove netbios probably doesn't need it

472
00:35:26,080 --> 00:35:31,870
get rid of LM and r get rid of double
pad and this rolls over into legacy

473
00:35:31,870 --> 00:35:35,680
audit and restrict your ntlm
authentication environment you don't

474
00:35:35,680 --> 00:35:36,850
know what's being used

475
00:35:36,850 --> 00:35:43,120
there's no way that you can control it
enforce ldap signing use ldap as for any

476
00:35:43,120 --> 00:35:48,250
non microsoft windows type applications
in its unique see it's going to bind if

477
00:35:48,250 --> 00:35:53,710
it's finding / l doubt that's clear text
that is that enable ldap signing and

478
00:35:53,710 --> 00:35:57,550
encryption where possible we want to
disable these older protocols

479
00:35:57,550 --> 00:36:01,930
I mean who has seen w pad use
legitimately environment right a couple

480
00:36:01,930 --> 00:36:06,310
of times but it's enabled everywhere in
responder takes advantage of it and pen

481
00:36:06,310 --> 00:36:11,230
testers and attackers can just drop on a
system and ask for credit effectively in

482
00:36:11,230 --> 00:36:16,870
windows 10 pls uncheck smb1 and
powershell version too if you don't do

483
00:36:16,870 --> 00:36:21,520
this arm certain tools like PS attack
and leverage the power shell version 2

484
00:36:21,520 --> 00:36:24,520
and bypass all your fancy powershell
version 5 logging

485
00:36:25,030 --> 00:36:29,890
so in summary once an attacker gets a
foothold in your network admin access is

486
00:36:29,890 --> 00:36:32,710
often quickly obtain you showed a couple
of examples

487
00:36:32,710 --> 00:36:36,340
this is all fictional but these are
things that are being done in real life

488
00:36:36,340 --> 00:36:41,170
and you want to make sure that you
identify and Molly's defenses based on

489
00:36:41,170 --> 00:36:44,650
typical attacker activity if you read
about what's being done

490
00:36:44,650 --> 00:36:48,520
look to see what the mitigations and
defenses are focusing on detection first

491
00:36:48,520 --> 00:36:52,150
and then moving into mitigation and
prevention and then you can model those

492
00:36:52,150 --> 00:36:56,440
defenses and then questioned how good
your current defenses are do we have

493
00:36:56,440 --> 00:37:00,430
visibility into the right places are we
seeing lots of our workstations can we

494
00:37:00,430 --> 00:37:03,730
see when some of these things that will
showed are actually happening in our

495
00:37:03,730 --> 00:37:07,240
environment but if we measure our
environment like Carlos was talking

496
00:37:07,240 --> 00:37:10,930
about measure the environment document
the environment understand what you have

497
00:37:10,930 --> 00:37:14,950
so that way you can figure out how its
tighten it up and lock it down because

498
00:37:14,950 --> 00:37:19,000
ultimately effective defense limits the
attacker capability and their options

499
00:37:19,000 --> 00:37:20,680
increases their costs

500
00:37:20,680 --> 00:37:23,470
thank you very much

501
00:37:23,470 --> 00:37:29,919
yeah

502
00:37:31,850 --> 00:37:37,970
so go because I was there it was awesome
wasn't it was really high it was like

503
00:37:37,970 --> 00:37:39,950
one of the highlights of my trip so far

504
00:37:39,950 --> 00:37:43,490
his method man here haha

505
00:37:44,000 --> 00:37:56,420
because I tweeted him last night so good
morning derby con yeah that's that's a

506
00:37:56,420 --> 00:37:59,090
good response for having been up so late

507
00:37:59,090 --> 00:38:04,610
this is attacking evil Corp anatomy of a
corporate hat i'm sean and I'm we'll

508
00:38:04,610 --> 00:38:11,120
just a little bit about us i get my more
straighter my handle on Twitter's arm

509
00:38:11,120 --> 00:38:15,799
joy I'm a security researcher and
contesta red team her for various groups

510
00:38:15,800 --> 00:38:17,360
adapted threat division

511
00:38:17,360 --> 00:38:21,170
I've written a lot of code developed a
lot of our tool set some kind of a

512
00:38:21,170 --> 00:38:26,210
co-founder was one of the big developers
on the veil framework powershell Empire

513
00:38:26,210 --> 00:38:32,300
python Empire hydropower up our view
helped with bloodhound which are going

514
00:38:32,300 --> 00:38:35,660
to cover a bit during this presentation
along with a few other for the work

515
00:38:35,660 --> 00:38:37,009
needs to work on that with me

516
00:38:37,010 --> 00:38:42,950
Microsoft power shown DP on spoken a few
conferences spoke yesterday at a derby

517
00:38:42,950 --> 00:38:46,129
khan had a great time I spoke a couple
years ago so one of my favorite

518
00:38:46,130 --> 00:38:51,110
conferences for sure but show of hands
who uses either Empire veil framework

519
00:38:51,110 --> 00:38:55,280
power of your power up on a regular
basis all that's what makes me happy so

520
00:38:55,280 --> 00:39:01,370
awesome lots of pwnage so I'm Sean
metcalf founder Trimark a security

521
00:39:01,370 --> 00:39:05,240
company Microsoft Certified Master in
Active Directory what about a hundred

522
00:39:05,240 --> 00:39:06,350
the world

523
00:39:06,350 --> 00:39:12,770
microsoft MVP like my good friend will
hear focus black hat defcon b-sides and

524
00:39:12,770 --> 00:39:17,030
Derby con really happy to be here and we
can love derby con I'm a security

525
00:39:17,030 --> 00:39:21,200
consultant researcher and I own and
operate 80 security toward who's heard

526
00:39:21,200 --> 00:39:23,060
of are used 80 security at work

527
00:39:23,060 --> 00:39:28,490
awesome so I the setup for this is gonna
be a little different than your standard

528
00:39:28,490 --> 00:39:35,270
conference talk I we're gonna put on a
skit for the next 30 minutes so we're

529
00:39:35,270 --> 00:39:39,500
actually going to shift from being Sean
and will the nice guys

530
00:39:39,500 --> 00:39:43,880
that you like to hang out with and I'm
gonna turn into convert myself into the

531
00:39:43,880 --> 00:39:49,250
CIO of ecor evil court right and i'm
going to talk about how perfect our

532
00:39:49,250 --> 00:39:52,490
security is how we have great security

533
00:39:52,490 --> 00:39:56,629
it's huge right and then we'll is going
to come up and he's gonna go

534
00:39:56,630 --> 00:39:59,630
no no not actually kind of sucks and I'm
gonna show you why

535
00:40:00,350 --> 00:40:03,440
so then after the skit we're going to
switch back to a standard slide

536
00:40:03,440 --> 00:40:08,330
presentation and we're going to show you
the mitigations that should have been in

537
00:40:08,330 --> 00:40:11,870
place for could have been a place to
resolve those issues that were about

538
00:40:11,870 --> 00:40:14,870
show so this is where we switch

539
00:40:24,830 --> 00:40:37,400
hello gone how are you today i am the
CEO of igor the most secure Network ever

540
00:40:37,400 --> 00:40:43,010
we have a very large global Active
Directory environment with lots of

541
00:40:43,010 --> 00:40:46,940
domains we do lots of security with
active directory to make sure everything

542
00:40:46,940 --> 00:40:51,680
is in good shape got hundreds of domain
controllers we've got hundreds of

543
00:40:51,680 --> 00:40:56,750
thousands of endpoints thousands of
servers all over the world we have data

544
00:40:56,750 --> 00:41:00,680
centers to make sure things are
physically secure and we have offices

545
00:41:00,680 --> 00:41:05,359
all over and these are well connected
but we also have executives and other

546
00:41:05,360 --> 00:41:08,660
people at work from home and have mobile
devices so we have challenges with that

547
00:41:08,660 --> 00:41:12,319
so we make sure we have really great
security and of course we have a

548
00:41:12,320 --> 00:41:15,470
perimeter network for our customers and
our suppliers much like any other

549
00:41:15,470 --> 00:41:21,049
network and we ever internal corporate
network protected by firewalls not just

550
00:41:21,050 --> 00:41:24,290
any firewalls these are next-gen
firewalls

551
00:41:27,210 --> 00:41:33,119
we have web content filters that filter
out all of the bad code in fact it looks

552
00:41:33,119 --> 00:41:38,460
for the evil bit goes know we've got
email security appliances that say

553
00:41:38,460 --> 00:41:44,580
viruses not today we have VPN security
using two-factor authentication so

554
00:41:44,580 --> 00:41:49,020
there's no way that anyone who's not
authorized that I haven't signed a form

555
00:41:49,020 --> 00:41:56,339
for can get on our network we have
endpoint security antivirus kids hip

556
00:41:56,339 --> 00:42:02,580
sees we've got all those things
ultimately a corp security is the best

557
00:42:02,580 --> 00:42:05,670
and we're unhackable

558
00:42:06,390 --> 00:42:14,040
I'm sorry gentlemen up here you are you
saying that you don't think were awesome

559
00:42:14,040 --> 00:42:18,210
and ok when you come up here let's see
what you can do on what's your name sir

560
00:42:19,050 --> 00:42:24,330
hey well come on up yeah I going to do
you part so here's my here's my computer

561
00:42:24,330 --> 00:42:27,390
let's let's see what we're talking about
here

562
00:42:27,390 --> 00:42:30,480
alright so we're going to have kind of
five different sections with this so the

563
00:42:30,480 --> 00:42:33,780
first one of the first things you
mentioned was kind of like

564
00:42:33,780 --> 00:42:37,980
categorization web filter any kind of
next-gen expo yeah absolutely we have

565
00:42:37,980 --> 00:42:42,570
web categorization with our web content
filtering and so that way users can't go

566
00:42:42,570 --> 00:42:46,650
to any bad sites sure so this is
essentially a solved problem by the

567
00:42:46,650 --> 00:42:50,760
search engine optimization community so
we have a kind of a proof-of-concept

568
00:42:50,760 --> 00:42:55,349
tool that will be releasing later in the
year after its cleaned up called eminent

569
00:42:55,349 --> 00:42:59,790
domain it will search a number of
different sites like one of the our

570
00:42:59,790 --> 00:43:05,670
favorites are down calm so it will look
for domains that have just expired

571
00:43:05,670 --> 00:43:09,750
within the last couple of days that are
already aged out and categorized so

572
00:43:09,750 --> 00:43:13,980
beyond just the categorization issue we
see domain age is normally like a pretty

573
00:43:13,980 --> 00:43:18,150
big pretty big problem sometimes for
forgetting exhale out but in general for

574
00:43:18,150 --> 00:43:22,140
the last year-and-a-half first Oh giving
characterization exhale hasn't been an

575
00:43:22,140 --> 00:43:23,129
issue for us

576
00:43:23,130 --> 00:43:27,780
I'm you see down here the eminent domain
will actually search for wild card type

577
00:43:27,780 --> 00:43:32,310
terms that are similar to whatever your
targeted so you're evil corporation com

578
00:43:32,310 --> 00:43:34,480
we actually purchased that

579
00:43:34,480 --> 00:43:38,350
oh wait a second you you purchase one of
my domain names can you do that

580
00:43:38,350 --> 00:43:41,950
sorry you purchase one of my domain
names oh no it's just a similar kind of

581
00:43:41,950 --> 00:43:46,419
Snarf's domain but it was a child but it
wasn't categorized so this is a

582
00:43:46,420 --> 00:43:50,680
theoretical categorization page that we
absolutely did not actually submit to

583
00:43:50,680 --> 00:43:57,730
arm and this is actually a response
email that totally doesn't have the site

584
00:43:57,730 --> 00:44:00,970
categorize for your evil corporation com

585
00:44:00,970 --> 00:44:05,290
so you know this came in about two days
ago so normally turnaround time is only

586
00:44:05,290 --> 00:44:08,320
about a day or so for these types of
things if you set up legitimate looking

587
00:44:08,320 --> 00:44:12,520
content or if you want to be really
sneaky after you buy a domain that had

588
00:44:12,520 --> 00:44:16,930
just expired go to archive.org slow down
the old content and set it up on what

589
00:44:16,930 --> 00:44:21,040
whatever the existing thing is so
doesn't skip a beat you know you have

590
00:44:21,040 --> 00:44:23,800
the site went down for one day at
transfer donors and then you just

591
00:44:23,800 --> 00:44:27,490
resubmit to whatever categorization you
want saying like oh my gosh what i don't

592
00:44:27,490 --> 00:44:35,740
understand I've been around for 10 years
on goal so that's pretty much the

593
00:44:35,740 --> 00:44:40,270
categorization so hold on a second
you're saying that you can get around my

594
00:44:40,270 --> 00:44:43,300
web content filtering and get the
categorization that we do all the time

595
00:44:43,300 --> 00:44:47,680
by either buying a domain that's already
categorized or setting one up and then

596
00:44:47,680 --> 00:44:52,149
just yet getting knocked off the next
one of the next things you mentioned as

597
00:44:52,150 --> 00:44:56,320
far as a next-gen kind of next-gen email
filtering you have oh right

598
00:44:56,920 --> 00:45:02,710
absolutely yeah that's great you have to
have a on or externally are not yet but

599
00:45:02,710 --> 00:45:03,730
it's in the works

600
00:45:03,730 --> 00:45:08,080
so it's it's one of our favorite things
that hit to wear if we see any kind of

601
00:45:08,080 --> 00:45:12,460
external interface if you guys aren't
doing this you absolutely should is just

602
00:45:12,460 --> 00:45:17,619
do a cyclone or just do a press stealer
social engineering tool can do this we

603
00:45:17,619 --> 00:45:21,970
tend to do it manually so just having
like really simple PHP snippet that will

604
00:45:21,970 --> 00:45:26,240
clone you know save off whatever the
creds are when people go through to the

605
00:45:26,240 --> 00:45:30,410
kinda spoofed login page and then we
actually redirected with legitimate

606
00:45:30,410 --> 00:45:36,109
login information so really really easy
and efficient email out if you if you

607
00:45:36,110 --> 00:45:38,750
get through with the with a couple of
people with the domain you don't

608
00:45:38,750 --> 00:45:42,890
actually have to get your payloads by
just have to get your creds login 20 and

609
00:45:42,890 --> 00:45:46,339
then we spear fish internally can
actually craft a lot of your messages

610
00:45:46,340 --> 00:45:50,780
much more kind of targeted because you
can read through these in the email

611
00:45:50,780 --> 00:45:54,890
correspondence so you don't kind of hit
that security uncanny valley to or maybe

612
00:45:54,890 --> 00:45:57,830
the signature is just a bit off or you
know if you address somebody a little

613
00:45:57,830 --> 00:46:02,270
bit differently and people kind of
freaked out so effectively you purchased

614
00:46:02,270 --> 00:46:03,290
this domain

615
00:46:03,290 --> 00:46:10,190
you gotta categorize one of my domains i
started and then you send an email to my

616
00:46:10,190 --> 00:46:13,640
one of my users are a bunch of my users
and say go to this o.o page and they go

617
00:46:13,640 --> 00:46:18,500
there they log in and then they don't
get in they get refreshed to our actual

618
00:46:18,500 --> 00:46:20,780
lepage it and then you steal their
credentials

619
00:46:20,780 --> 00:46:26,990
that's the same thing as far as as far
as payloads go are kind of standard

620
00:46:26,990 --> 00:46:30,680
right now that we like to use are
malicious shortcut on k files embedded

621
00:46:30,680 --> 00:46:36,470
within all a's in kind of office
documents so shortcuts you can create

622
00:46:36,470 --> 00:46:42,410
these maliciously pretty easily with a
few paths embarrass my friends that's a

623
00:46:42,410 --> 00:46:45,770
really cool project that applies graph
theory to active directory attack pass

624
00:46:45,770 --> 00:46:50,540
if you guys haven't checked it out like
so is his name is Waldo yeah his novel

625
00:46:50,540 --> 00:46:52,290
always right there I found you

626
00:46:52,290 --> 00:46:57,330
yeah so basically we can take three
pieces of information of whose login

627
00:46:57,330 --> 00:47:01,830
where who has admin rights where what
users and groups along to what groups

628
00:47:01,830 --> 00:47:06,240
and that's it we can collect all this
information as a non-privileged user we

629
00:47:06,240 --> 00:47:10,259
just need domain authentication or we
need a domain authenticated user but we

630
00:47:10,260 --> 00:47:14,820
need no elevated privileges in the
domain with this we can run a powershell

631
00:47:14,820 --> 00:47:18,630
and gesture which is essentially a
customized version of power of you that

632
00:47:18,630 --> 00:47:22,020
will numerate all this information as
fast as they can and then spit it out

633
00:47:22,020 --> 00:47:26,640
either to a RESTful API interface or a
bunch of CSVs that then we can adjust

634
00:47:26,640 --> 00:47:30,569
down then it's I've got a really really
nice dashboard for pathfinding and all

635
00:47:30,570 --> 00:47:36,360
this so i have a question about this so
you go through this email convoluted

636
00:47:36,360 --> 00:47:40,470
thing and somehow I code running on one
of my workstation sigh i don't quite get

637
00:47:40,470 --> 00:47:45,569
but ok fine and then is a regular user
you can get all this information from

638
00:47:45,570 --> 00:47:49,260
the environment with without any admin
rights whatsoever you and then pull this

639
00:47:49,260 --> 00:47:54,930
into some snipping tool knapper dog so
the from the pivot we're going to show

640
00:47:54,930 --> 00:47:58,319
this user does not have local
administrative access in the Machine and

641
00:47:58,320 --> 00:48:02,100
there Justin domain users they have no
elevated domain access so for the two

642
00:48:02,100 --> 00:48:05,430
different attack past we're going to
show kind of starting with recon and

643
00:48:05,430 --> 00:48:09,089
we'll move into the to pass keep in mind
that this is a completely on privileged

644
00:48:09,090 --> 00:48:16,290
user so i don't know how ordinary this
is re the can actually see all right

645
00:48:16,290 --> 00:48:27,810
just tell me what state Kennedy had seen
it all right okay i'm gonna try to click

646
00:48:27,810 --> 00:48:33,330
this video and then move right here and
she was one alright so we're gonna start

647
00:48:33,330 --> 00:48:39,720
up in part we have our fish user on this
is the really . evil . for domain and

648
00:48:39,720 --> 00:48:45,000
all the Machine names and users are
named after evil characters so we have

649
00:48:45,000 --> 00:48:48,000
we fished Ramsay Bolton on the co-state
machine

650
00:48:48,720 --> 00:48:51,720
absolutely is a good guy or bad

651
00:48:53,250 --> 00:48:57,270
ok and we're going to run the Bloodhound
adjuster so we're going to kick this off

652
00:48:57,270 --> 00:49:00,060
and that there's a couple different
collection methods by default it's going

653
00:49:00,060 --> 00:49:04,500
to rain all the groups are all the group
group memberships and like using

654
00:49:04,500 --> 00:49:07,619
memberships and everything is also going
to enumerate all the systems that can

655
00:49:07,619 --> 00:49:11,340
find on the domain and then running
numeration threads to figure out the

656
00:49:11,340 --> 00:49:15,720
local administrators in session
information for each it that now that

657
00:49:15,720 --> 00:49:19,500
touches every single machine is kind of
normal a t-type traffic but it's you

658
00:49:19,500 --> 00:49:23,580
know one workstation conspiring out and
touching a lot of stuff if you want to

659
00:49:23,580 --> 00:49:26,819
be a bit more stealthy you can use the
stealth collection which will do just

660
00:49:26,820 --> 00:49:30,300
held up in numeration to domain
controller and then try to numerate

661
00:49:30,300 --> 00:49:34,920
commonly traffic servers by checking
your home directory path and stuff

662
00:49:34,920 --> 00:49:38,099
through user objects and then i'll do
the remote session and local admin

663
00:49:38,099 --> 00:49:43,020
enumeration against just that has those
handfuls of commonly traffic servers and

664
00:49:43,020 --> 00:49:47,369
then it doesn't gpo correlation tricks
for local admin so stealth collection

665
00:49:47,369 --> 00:49:50,369
not as accurate but a lot faster and a
lot quieter

666
00:49:51,780 --> 00:49:55,740
oh ok we're gonna kick off the new
bloodhound module that's an empire to do

667
00:49:55,740 --> 00:50:01,080
beta was released yesterday this is
going to send in jester down and it's

668
00:50:01,080 --> 00:50:04,200
going to be a going to start kicking all
the enumeration threads and everything

669
00:50:04,200 --> 00:50:07,379
off in the back end and the videos

670
00:50:07,380 --> 00:50:12,570
ok cool so you can see there it did all
the enumeration is saved all the CSVs

671
00:50:12,570 --> 00:50:18,330
off so now we are going to actually just
download the CSV names and we're going

672
00:50:18,330 --> 00:50:21,240
to switch over to our bloodhound analyst
machine

673
00:50:21,240 --> 00:50:26,399
cool so all these pulled down

674
00:50:27,540 --> 00:50:31,740
alright so we're going to start a
bloodhound it is cross-platform it's

675
00:50:31,740 --> 00:50:32,819
written the front end

