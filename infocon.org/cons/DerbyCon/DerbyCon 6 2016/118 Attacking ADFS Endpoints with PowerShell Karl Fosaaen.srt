1
00:00:00,000 --> 00:00:11,880
alright guess we'll get started here so
just a quick thanks for everybody that's

2
00:00:11,880 --> 00:00:15,750
showing up at six o'clock on saturday
and everybody's probably need to get to

3
00:00:15,750 --> 00:00:20,850
the bar and or have supper sometime soon
so I appreciate everybody coming in to

4
00:00:20,850 --> 00:00:25,619
see the talk so we're gonna be talking
about attacking adfs endpoints with

5
00:00:25,619 --> 00:00:32,460
powershell today I kind of a high-level
overview if you're an external pentester

6
00:00:32,460 --> 00:00:37,410
this could be great for you because from
an external standpoint adfs is once it's

7
00:00:37,410 --> 00:00:42,089
completely untapped resource but we see
a lot of organizations kind of ignoring

8
00:00:42,090 --> 00:00:47,489
it in terms of things like single
sign-on what ad FS can do so hopefully

9
00:00:47,489 --> 00:00:50,849
this gives some of the external pen
testers in the room good targets to go

10
00:00:50,850 --> 00:00:58,170
after an internal people good targets to
secure so a little bit about me I my

11
00:00:58,170 --> 00:01:02,160
name is Carl Fossen I'm a managing
consultant / it nets by our company

12
00:01:02,160 --> 00:01:06,990
based in Minneapolis i'm personally out
of the Portland office I wear lots of

13
00:01:06,990 --> 00:01:12,390
hats as a managing consultant I kind of
spend my time managing clients managing

14
00:01:12,390 --> 00:01:19,979
a handful of consultants at nets by so
do a little bit of everything during my

15
00:01:19,979 --> 00:01:24,450
consulting time primarily doing network
and web app pen testing on the network

16
00:01:24,450 --> 00:01:30,119
side internal and external and red team
do a little bit of password cracking

17
00:01:30,119 --> 00:01:32,700
Eric Gruber's down here

18
00:01:32,700 --> 00:01:37,049
he also helps with managing the password
cracking boxes that we have you may have

19
00:01:37,049 --> 00:01:40,950
seen some of the blogpost we've done
about all of the missteps we've taken

20
00:01:40,950 --> 00:01:47,759
trying to create those password cracking
boxes so it's kind of fun stuff i also

21
00:01:47,759 --> 00:01:49,020
do social engineering

22
00:01:49,020 --> 00:01:52,860
I'm the person responsible for the
methodologies for on-site and phone

23
00:01:52,860 --> 00:01:57,119
based social engineering firm wants to
swap war stories about on-site social

24
00:01:57,119 --> 00:01:59,670
engineering stuff that's always fun

25
00:01:59,670 --> 00:02:05,729
additionally you might find me on the
nets by blog relatively active there the

26
00:02:05,729 --> 00:02:09,508
stuff that we're going to cover today
almost all of its going to be on my blog

27
00:02:09,508 --> 00:02:10,699
already

28
00:02:10,699 --> 00:02:13,940
the post came out within the last couple
of months covering some of that stuff

29
00:02:13,940 --> 00:02:16,609
and then little bit more on top of that

30
00:02:16,610 --> 00:02:22,310
additionally i got one more after this
promise i def con sweat goon if anybody

31
00:02:22,310 --> 00:02:27,290
in here is wearing a DEFCON t-shirt from
last five or six years I probably sold

32
00:02:27,290 --> 00:02:32,989
the two so you can frequently find me at
the defcon swag area over here and the

33
00:02:32,989 --> 00:02:38,299
very last one here a pinball repair we
have an old twilight zone machine at the

34
00:02:38,299 --> 00:02:42,860
net by office that if anyone is familiar
with older pinball machines they're kind

35
00:02:42,860 --> 00:02:46,640
of like an expensive sports car you can
use them for a couple hours and then

36
00:02:46,640 --> 00:02:48,980
something might break down you have to
fix it

37
00:02:48,980 --> 00:02:52,488
that's kind of how it is with the
twilight zone machine do a lot of

38
00:02:52,489 --> 00:02:57,140
pinball repair which is actually a lot
of fun for those that weren't hacker

39
00:02:57,140 --> 00:02:59,119
jeopardy last night huh

40
00:02:59,120 --> 00:03:03,380
Scott's gonna kill me for having this
photo out I we were hacker jeopardy

41
00:03:03,380 --> 00:03:10,069
champions last night so that was a lot
of fun so from an overall overview here

42
00:03:10,069 --> 00:03:16,730
we're gonna do just kind of a heads up
as to what ad FS is and then go through

43
00:03:16,730 --> 00:03:20,660
different walkthroughs for you know how
you want to test things how you want to

44
00:03:20,660 --> 00:03:24,170
set up an environment how you can go
about actually attacking this kind of

45
00:03:24,170 --> 00:03:29,988
stuff we're gonna detour into can escape
message fishing the Federated skype for

46
00:03:29,989 --> 00:03:36,230
business stuff has some underlying adfs
stuff it's not pure attacking adfs but I

47
00:03:36,230 --> 00:03:38,510
think it's really cool and hopefully you
do too

48
00:03:38,510 --> 00:03:42,620
so what kind of detour into that and
then wrap things up with couple other

49
00:03:42,620 --> 00:03:46,489
attacks attack mitigations and questions
I'm good

50
00:03:47,150 --> 00:03:55,519
so from an ad FS overview standpoint
adfs is because edit score is really a

51
00:03:55,519 --> 00:04:04,040
way to expose Active Directory out to
the internet or the extranet by opening

52
00:04:04,040 --> 00:04:10,760
up kind of a single sign-on type of
interface I which doesn't use kerberos I

53
00:04:10,760 --> 00:04:16,760
think the exact definition was opening
up to the extranet without exposing

54
00:04:16,760 --> 00:04:18,389
kerberos to the Internet

55
00:04:18,389 --> 00:04:22,259
I'm sure gross on the internet would be
really cool and really interesting to

56
00:04:22,259 --> 00:04:27,240
mess around with but it's not really
built for that so adfs is really that

57
00:04:27,240 --> 00:04:33,389
internet-facing replacement for kerberos
480 authentication I we're going to talk

58
00:04:33,389 --> 00:04:36,779
about a couple of different terms here
that probably will come up throughout

59
00:04:36,779 --> 00:04:43,110
the course of this talk I DP is an
identity provider if you have a DFS

60
00:04:43,110 --> 00:04:47,669
hosted from somebody else or some kind
of single sign-on that would be an IDP

61
00:04:47,669 --> 00:04:52,080
or an identity provider are actually
going to see one of them later on in

62
00:04:52,080 --> 00:04:52,710
here

63
00:04:52,710 --> 00:05:00,000
saml ws-federation WS trust and ATL ATL
are all kind of different standards for

64
00:05:00,000 --> 00:05:08,610
authenticating 2i adfs we're not going
to dive too deep into each of these just

65
00:05:08,610 --> 00:05:15,210
know that they're kind of involved with
a DFS and the ADL is your ad

66
00:05:15,210 --> 00:05:16,560
authentication library

67
00:05:16,560 --> 00:05:20,460
we're going to talk about it when we get
to the graph api stuff was actually

68
00:05:20,460 --> 00:05:25,888
pretty cool stuff but that's further on
here so Federation can mean a lot of

69
00:05:25,889 --> 00:05:26,819
different things

70
00:05:26,819 --> 00:05:33,389
I you know it's we're looking at active
directory federation services start

71
00:05:33,389 --> 00:05:37,080
looking for windows Federation
information you get a lot of different

72
00:05:37,080 --> 00:05:41,669
information I think of it from a couple
different ways federating from domain to

73
00:05:41,669 --> 00:05:47,099
domain so I work for nets by if it's by
wants to talk to derby con . com we can

74
00:05:47,099 --> 00:05:50,819
set up some kind of Federation to
communicate or share things across the

75
00:05:50,819 --> 00:05:55,409
Federation ignores do the same thing
from a domain to Microsoft have a

76
00:05:55,409 --> 00:06:01,020
wonderful Microsoft Paint diagram of I
how some organizations are no shipping

77
00:06:01,020 --> 00:06:06,359
accounts up to Microsoft to manage
things like manure or doing things like

78
00:06:06,360 --> 00:06:10,500
office 365 so you can think of
Federation in a couple of different ways

79
00:06:10,500 --> 00:06:16,379
there or just arbitrary means based off
of forum posts like i said if you google

80
00:06:16,379 --> 00:06:20,849
for windows Federation stuff unless
you're really specifically looking for

81
00:06:20,849 --> 00:06:24,569
something like a DFS Federation
information or skype for business

82
00:06:24,569 --> 00:06:28,500
Federation you're going to go down a
bunch of different rabbit holes so i

83
00:06:28,500 --> 00:06:31,770
spent a fair amount of time digging into
a lot of this stuff

84
00:06:31,770 --> 00:06:38,878
hopefully it's all clear makes sense
here so some frequently federated

85
00:06:38,879 --> 00:06:43,020
services now these are services that
would allow for federated authentication

86
00:06:43,020 --> 00:06:47,909
either through a DFS or they have some
kind of Federation that you could set up

87
00:06:47,909 --> 00:06:51,780
so things like skype for business
businesses can communicate to each other

88
00:06:51,780 --> 00:06:56,250
if derby khan had their own skype for
business setup internally and we had met

89
00:06:56,250 --> 00:06:59,280
by wanted to chat over skype for
business with them we could set up

90
00:06:59,280 --> 00:07:03,508
federation with them things like
exchange you can federated calendars

91
00:07:03,509 --> 00:07:07,979
between organizations and really see
much of the exchange Federation out

92
00:07:07,979 --> 00:07:12,060
there I your Active Directory we're
going to dive into a little bit later

93
00:07:12,750 --> 00:07:19,680
sure . apps in general probably talk
about it later but in terms of

94
00:07:19,680 --> 00:07:23,699
federating apps you can setup Federation
to do authentication for web apps with

95
00:07:23,699 --> 00:07:30,210
the caps things like that so going into
the actual attack walkthroughs this is

96
00:07:30,210 --> 00:07:33,180
how we're kind of going to go through
this whole process we're going to

97
00:07:33,180 --> 00:07:36,569
identify the actual federated end . so
you've got a domain you want to see if

98
00:07:36,569 --> 00:07:40,500
it's got Federation or a DFS set up
somewhere will show you how to set up a

99
00:07:40,500 --> 00:07:44,400
test environment which is partly focused
on the state fishing stuff but there are

100
00:07:44,400 --> 00:07:49,590
some benefits to having a domain with
Federation stuff set up Irene show you

101
00:07:49,590 --> 00:07:54,599
once lied about user enumeration do
recon and figure out where you can find

102
00:07:54,599 --> 00:07:59,880
users and then validating those users
social engineering recon and kind of

103
00:07:59,880 --> 00:08:02,909
moving into more of the actual
escalating trying to get into the

104
00:08:02,909 --> 00:08:08,340
internal network and finishing with
pivoting to the internal network so

105
00:08:08,340 --> 00:08:12,989
certain things off I identifying
federated endpoints is kind of an

106
00:08:12,990 --> 00:08:20,460
interesting thing we can actually ask
microsoft I so in office 365 they had an

107
00:08:20,460 --> 00:08:24,090
authentication bypass issue and the
person who wrote up the whole thing is

108
00:08:24,090 --> 00:08:28,739
actually well you'll see here in the
second they actually wrote up this whole

109
00:08:28,740 --> 00:08:33,510
method in that off bypass blog post and
it was like a week before I was

110
00:08:33,510 --> 00:08:38,578
completely block out about this but I
was a really cool sam'l assertions bug

111
00:08:38,578 --> 00:08:43,380
where they basically could get access to
any federated office 365 com and i've

112
00:08:43,380 --> 00:08:44,779
got the link down here at the bar

113
00:08:44,779 --> 00:08:49,279
if you get a chance to actually read it
its economy of mechanism i think it's

114
00:08:49,279 --> 00:08:54,379
the road to hell is paved with sam'l
assertions I think that's the title of

115
00:08:54,379 --> 00:08:58,370
it it was really really interesting the
work that they were doing with Sam old

116
00:08:58,370 --> 00:09:02,569
little bit deeper than we're going to go
into today it was really interesting

117
00:09:02,569 --> 00:09:08,719
stuff so anyways I i put together all of
this stuff roundabout the same time they

118
00:09:08,720 --> 00:09:12,230
were working on the same thing so credit
to them for posting on at first but

119
00:09:12,230 --> 00:09:17,959
we'll talk about here so I'm i said you
can just go to Microsoft that asked for

120
00:09:17,959 --> 00:09:22,670
Federation info it's pretty simple if
you go out to login . microsoft online

121
00:09:22,670 --> 00:09:29,149
com or portal . your . com or portals
office.com any of those you can be

122
00:09:29,149 --> 00:09:33,740
prompted by a login prompt to log into
whatever service are going to so here we

123
00:09:33,740 --> 00:09:41,629
see office 365 if you put an email
address into the email or phone can

124
00:09:41,629 --> 00:09:45,170
really highlight anything over here but
into that box there

125
00:09:45,170 --> 00:09:49,639
it sends out this request so you can see
here that i sent out the request for

126
00:09:49,639 --> 00:09:56,899
Carl example.com and it just makes a
simple get requests and Microsoft's

127
00:09:56,899 --> 00:10:00,649
going to have one of two responses so if
it's a federated dome and you're going

128
00:10:00,649 --> 00:10:05,149
to get the Federation info going to say
hey its federated got a highlighted in

129
00:10:05,149 --> 00:10:05,930
red

130
00:10:05,930 --> 00:10:10,128
it's going to give you an off URL which
is the adfs endpoint that you're going

131
00:10:10,129 --> 00:10:16,490
to authenticate to to create that token
to access office 365 so really with the

132
00:10:16,490 --> 00:10:21,680
Federated you hit office 365 to say Oh
actually we want you to go talk to this

133
00:10:21,680 --> 00:10:27,319
ad FS server somewhere else if it's a
managed domain as in Azure Active

134
00:10:27,319 --> 00:10:32,870
Directory accounts hosted in Microsoft
or potentially if somebody shipping

135
00:10:32,870 --> 00:10:36,860
their accounts up to microsoft for this
manage domain you just authenticate

136
00:10:36,860 --> 00:10:40,189
directly gets microsoft at that point i
will talk about ways that you can root

137
00:10:40,189 --> 00:10:41,929
for spreads against that later

138
00:10:41,929 --> 00:10:47,569
so just kind of a picture diagram for
people that are more visual here's what

139
00:10:47,569 --> 00:10:51,019
the manager Federation looks like you're
looking at a DC sync between the

140
00:10:51,019 --> 00:10:53,590
Microsoft Azure Active Directory

141
00:10:53,590 --> 00:11:02,290
the Acme company so yeah Thank You
Microsoft Paint home I so anyways in the

142
00:11:02,290 --> 00:11:08,349
office 365 user goes to authenticate to
microsoft for office 365 they go out to

143
00:11:08,350 --> 00:11:13,690
the azure ad authenticating it's that
we're going it's federated microsoft hey

144
00:11:13,690 --> 00:11:17,410
actually I want you get the token from
the adfs server at the Acme company

145
00:11:17,410 --> 00:11:22,600
who's talking to their DC internally
then you get the token enough microsoft

146
00:11:22,600 --> 00:11:31,330
pretty simple took two minutes to draw
that up and paint so yeah um so I like

147
00:11:31,330 --> 00:11:35,860
things to go quickly and have automation
so I just wrap this in powershell it's a

148
00:11:35,860 --> 00:11:40,090
simple get requests and you parse the
JSON response that's maybe what 20 lines

149
00:11:40,090 --> 00:11:44,950
of code but i also like tables data
tables really easier to work with

150
00:11:45,700 --> 00:11:50,680
so here we can see the results for
federated domain not to pick on Fox News

151
00:11:50,680 --> 00:11:56,260
or paypal but there in like the top 10
of the alexa top 1 million so they were

152
00:11:56,260 --> 00:12:02,020
easy to pull out of a first few results
so um I actually do have a link for the

153
00:12:02,020 --> 00:12:07,689
power till script as well as the blog
about this but basically you give it an

154
00:12:07,690 --> 00:12:11,710
email you could just give it a domain
and probably go change that because it's

155
00:12:11,710 --> 00:12:15,640
simpler but it goes and does the
submission for you

156
00:12:15,640 --> 00:12:19,810
horses all that JSON and puts out to a
table so in this case we can see that

157
00:12:19,810 --> 00:12:25,359
fox news are using octa as their IDP can
see brand-name Federation kind of info

158
00:12:25,360 --> 00:12:31,690
paypal we can see it's managed we also
do multiple domains at once I just

159
00:12:31,690 --> 00:12:39,430
didn't get content on the list of other
domains and just for sake of privacy I

160
00:12:39,430 --> 00:12:42,699
guess on their part i mean anybody can
do this with the alexa top million get

161
00:12:42,700 --> 00:12:47,620
the same thing but i did a handful just
kind of show the variances between

162
00:12:47,620 --> 00:12:53,380
manage federated or na if technically
that's the third response to get if

163
00:12:53,380 --> 00:12:56,740
they're not manager federated if they
don't have any kind of connection to

164
00:12:56,740 --> 00:13:06,740
Microsoft you get a so anyways I see
here so an alternative method to do

165
00:13:06,740 --> 00:13:11,930
doing this and i'm quite found a benefit
of this over the method i just showed

166
00:13:11,930 --> 00:13:15,260
but it's kind of some neat
information-gathering that you can do I

167
00:13:15,260 --> 00:13:21,140
when you go to claim a domain within the
microsoft portal you have to prove that

168
00:13:21,140 --> 00:13:26,000
you own that domain so here I tried to
prove that i owned office.com and they

169
00:13:26,000 --> 00:13:30,800
prompted me to put something in my txt
record in my dns so once this ms equals

170
00:13:30,800 --> 00:13:35,689
$OPERAND m/s 49 whatever value and wants
me to put that into my txt records they

171
00:13:35,690 --> 00:13:38,750
can validate that actually own that
makes sense good thing

172
00:13:39,410 --> 00:13:45,350
well we can go ahead and query for that
so in fox news's case they've got the MS

173
00:13:45,350 --> 00:13:48,470
equals $OPERAND m/s 402 blah blah so its
a good indication that they're

174
00:13:48,470 --> 00:13:53,839
federating with Microsoft or at some
point they were chances are if they

175
00:13:53,839 --> 00:13:57,860
decided to move away from office 365
something like that maybe they forgot in

176
00:13:57,860 --> 00:14:01,339
txt record who knows

177
00:14:01,339 --> 00:14:06,920
additionally you could just go to the
portal website login is probably should

178
00:14:06,920 --> 00:14:11,959
talk about that instead of using the
script or instead of your portion

179
00:14:11,959 --> 00:14:16,579
everything you could just go to the log
in and get redirected but that's kind of

180
00:14:16,579 --> 00:14:23,390
the sidetrack anyways so i'm looking
through the top million txt records for

181
00:14:23,390 --> 00:14:29,810
the alexa sites found that 40 7455 had
the MS equals $OPERAND m/s Star Records

182
00:14:29,810 --> 00:14:33,589
so that's kind of the footprint we're
dealing with here out of the top million

183
00:14:33,589 --> 00:14:38,839
i may not be the best sample set to look
for for this kind of info but seems like

184
00:14:38,839 --> 00:14:42,470
there's pretty good adoption for
federating with microsoft for having

185
00:14:42,470 --> 00:14:45,470
some kind of connection out there

186
00:14:45,980 --> 00:14:50,450
dns is kind of a pain doing a million
record lookup it's better than sending a

187
00:14:50,450 --> 00:14:55,730
million webrequest out to Microsoft so
is your welcome microsoft didn't want to

188
00:14:55,730 --> 00:14:59,029
get in trouble with them for sending a
whole bunch of requests to see who's

189
00:14:59,029 --> 00:15:04,010
federated who's not other options if
you're going against domain.com chances

190
00:15:04,010 --> 00:15:10,370
are they're IDP is probably a DFS
domain.com or sts domain.com most of the

191
00:15:10,370 --> 00:15:13,370
implementations we've seen that's what's
coming back

192
00:15:14,040 --> 00:15:17,040
so setting up your test environment

193
00:15:17,639 --> 00:15:21,389
I we're gonna be focusing a little bit
on the skype for business stuff at this

194
00:15:21,389 --> 00:15:25,980
point I think it's kind of cool but I
was kind of an overview

195
00:15:26,670 --> 00:15:29,729
I didn't realize that was an animated
gift when i initially put it in here but

196
00:15:29,730 --> 00:15:36,810
kinda works out so first things first
you probably want to have a domain ready

197
00:15:36,810 --> 00:15:41,040
to do some of the stuff with in my case
I was able to pick up microsoft support

198
00:15:41,040 --> 00:15:47,279
. online for 88 cents pretty handy as
couple other options that you might want

199
00:15:47,279 --> 00:15:51,089
to use in our examples here we're going
to be dealing with microsoft support .

200
00:15:51,089 --> 00:15:58,920
online seems pretty legit especially if
we're talking to people over skype so I

201
00:15:58,920 --> 00:16:03,360
getting office 365 hosted services i'm
currently just doing the skype for

202
00:16:03,360 --> 00:16:08,040
business online plan which gets me
federated skype for business setup for

203
00:16:08,040 --> 00:16:13,500
five bucks a month pretty reasonable and
if you're doing some kind of assessment

204
00:16:13,500 --> 00:16:17,819
where you want to be able to fire this
up quickly the Microsoft cloud services

205
00:16:17,819 --> 00:16:22,860
are actually really good for this so
once you purchase the service you go

206
00:16:22,860 --> 00:16:28,139
ahead and add that ms record your txt
record claim the domain get it setup and

207
00:16:28,139 --> 00:16:32,279
what we want to do is set up a user and
enable Federation for that domain at

208
00:16:32,279 --> 00:16:35,430
this choir for all of our demos going
forward we're going to be dealing with

209
00:16:35,430 --> 00:16:41,069
support at microsoft support . online
seems pretty legitimate display name is

210
00:16:41,069 --> 00:16:44,670
going to escape support and we want to
turn on this little checkbox over here

211
00:16:44,670 --> 00:16:49,949
for I allowing other people in other
organizations to contact people in our

212
00:16:49,949 --> 00:16:54,719
organizations that enables the
Federation between the different domains

213
00:16:54,720 --> 00:17:00,389
it's actually really kind of crucial in
the next few steps here so little bit

214
00:17:00,389 --> 00:17:04,290
further on the same for business stuff
i'm getting the link which skype for

215
00:17:04,290 --> 00:17:10,649
business is the new link link just had a
rebrand to skype for business underlying

216
00:17:10,650 --> 00:17:14,520
technologies pretty much the same stuff
but it just has different name now the

217
00:17:14,520 --> 00:17:18,179
easiest way I've found to get that SDK
installed this to actually have visual

218
00:17:18,179 --> 00:17:23,280
studio 2010 installed it's kind of a
pain and the SDKs kind of have a date

219
00:17:23,280 --> 00:17:24,619
but

220
00:17:24,619 --> 00:17:29,030
if you've got a visual studio 2010
that's about the easiest way to get that

221
00:17:29,030 --> 00:17:34,220
setup create some people joining us here

222
00:17:36,530 --> 00:17:42,350
alright I so once you've got all that
setup go ahead and login for your skype

223
00:17:42,350 --> 00:17:45,379
for business user again we're using
skype support I've got a pretty

224
00:17:45,380 --> 00:17:49,490
legitimate looking icon here seems like
it's pretty trustworthy

225
00:17:50,090 --> 00:17:53,300
additionally I've got the powershell
modules i would hear this is on the nets

226
00:17:53,300 --> 00:17:57,440
by get hub i should be under the
powershell folder out on that space get

227
00:17:57,440 --> 00:18:05,030
hub so it's both the get ad FS m . and
the power skype and finally the last

228
00:18:05,030 --> 00:18:08,840
thing and kind of final step of getting
all over test environment setup I

229
00:18:08,840 --> 00:18:12,020
promise we'll get into the more
interesting stuff right after that is

230
00:18:12,020 --> 00:18:15,920
installing the as your ad powershell
module we're going to do a little bit of

231
00:18:15,920 --> 00:18:20,780
powerful stuff that wrap some of the
functionality of this ad powershell

232
00:18:20,780 --> 00:18:25,940
module to go in query Azure Active
Directory so that's a pretty handy thing

233
00:18:25,940 --> 00:18:26,929
to have

234
00:18:26,929 --> 00:18:32,809
so user enumeration i think most people
in the room have pretty good targets

235
00:18:32,809 --> 00:18:37,370
that they go after to enumerate first
name last name email address that kind

236
00:18:37,370 --> 00:18:43,010
of stuff there's a million different
frameworks out there just choose the one

237
00:18:43,010 --> 00:18:47,150
that you like to use personal like
enumerated users off of LinkedIn page

238
00:18:47,150 --> 00:18:51,470
for a company that's pretty handy i just
use one of the many recon frameworks

239
00:18:51,470 --> 00:18:57,050
Knicks Kiki's here it's really cool user
enumeration work for link / skype for

240
00:18:57,050 --> 00:19:00,980
business so take a look at his recording
from yesterday some pretty cool stuff

241
00:19:00,980 --> 00:19:08,090
there so once we've got some users that
we want to go after well how do we

242
00:19:08,090 --> 00:19:11,990
validate those how do we how do we know
that they're real well we can use

243
00:19:11,990 --> 00:19:17,150
federated skype for business instances
to validate these emails you'll see it

244
00:19:17,150 --> 00:19:23,179
in just a second here but once we've got
that full list we want to be able to

245
00:19:23,179 --> 00:19:29,240
check if they're legitimate emails so in
this case my my emails not Carl . Fossen

246
00:19:29,240 --> 00:19:34,550
one and that's buy.com so when we put
that into the skype for business client

247
00:19:34,550 --> 00:19:38,040
try to open up a message with that email
address we get this presence on

248
00:19:38,040 --> 00:19:42,720
phone doesn't seem like anything is
there if i put in my correct email

249
00:19:42,720 --> 00:19:48,150
address actually shows my job title it
shows if i'm available or if i'm away or

250
00:19:48,150 --> 00:19:53,610
out office and also shows that video
capable so we have a webcam so this is

251
00:19:53,610 --> 00:20:00,629
really good info I we actually kind of
stumbled on this I one of our project

252
00:20:00,630 --> 00:20:05,520
managers I brought us two overs we're
trying to set up a project with one of

253
00:20:05,520 --> 00:20:12,510
our clients and she's like should I be
able to skype message this client i know

254
00:20:12,510 --> 00:20:13,800
that doesn't seem right

255
00:20:13,800 --> 00:20:18,000
and sure enough we figured out that we
had Federation setup they had Federation

256
00:20:18,000 --> 00:20:21,780
setup and we could instant message
between them so that's kind of where a

257
00:20:21,780 --> 00:20:26,730
lot of this stuff started research wise
for me I got kind of interested in that

258
00:20:26,730 --> 00:20:32,730
Federation which ended up leading to
more the adfs stuff so I'm the

259
00:20:32,730 --> 00:20:38,130
Federation stuff is really cool we can
just start talking to CEOs there's four

260
00:20:38,130 --> 00:20:43,080
different CEO's that they can pull up
and verify on skype for business and the

261
00:20:43,080 --> 00:20:46,679
others some very interesting potential
impact here let's say you're an angry

262
00:20:46,680 --> 00:20:51,240
customer and you happen to hear this
talk i can go ahead and set up your own

263
00:20:51,240 --> 00:20:54,240
federated skype for business and go
ahead and tell the CEO how you feel

264
00:20:54,750 --> 00:21:00,360
I additional functionality I mean you
can do skype for business phone calls on

265
00:21:00,360 --> 00:21:03,449
here for video chats or send them
whenever you want

266
00:21:03,450 --> 00:21:07,200
we'll get a little more into that a
little bit but you have been CEOs

267
00:21:07,200 --> 00:21:09,600
exposed kinda scary

268
00:21:09,600 --> 00:21:17,699
so um and I have it in a note here if
you talk to salespeople about this they

269
00:21:17,700 --> 00:21:22,440
get really excited to go whole i can
know when the director of IT is seated

270
00:21:22,440 --> 00:21:23,670
at their desk

271
00:21:23,670 --> 00:21:27,660
oh I can see if they're available and
get a phone call and talk about sales

272
00:21:27,660 --> 00:21:33,900
it's always kind of fun to talk to those
people so I so again since I like

273
00:21:33,900 --> 00:21:37,410
automation like to be able to do this
stuff quickly we're just gonna wrap this

274
00:21:37,410 --> 00:21:43,290
in powershell I this is where it's handy
to have the skype / link SDK installed

275
00:21:43,290 --> 00:21:48,830
we're actually using that sdk to make
all of these queries and

276
00:21:48,830 --> 00:21:52,970
get everything kind of set out so again
if you've got the powershell module from

277
00:21:52,970 --> 00:21:58,340
github it's get dash skype status and in
this case and the demo that we're gonna

278
00:21:58,340 --> 00:22:02,209
do we're just going to feed it an input
of test emails

279
00:22:02,210 --> 00:22:05,210
here's a screenshot of what its gonna
look like

280
00:22:05,210 --> 00:22:10,820
so we get job titles these are a bunch
of emails that purposefully redacted I

281
00:22:10,820 --> 00:22:15,799
get full name with their statuses all
that good stuff so we'll do a quick demo

282
00:22:15,799 --> 00:22:20,480
here so I what I did and I'm gonna talk
about it here in a second in terms of

283
00:22:20,480 --> 00:22:26,090
statistics and exposure but i wouldn't
try to look up you know what domains

284
00:22:26,090 --> 00:22:30,918
were federated for skype for business
it's kinda hard to find some of the

285
00:22:30,919 --> 00:22:33,889
information from the info that's already
out there there's a technically a

286
00:22:33,889 --> 00:22:38,360
database of it that's a website that was
a good starting point but I went through

287
00:22:38,360 --> 00:22:42,769
and try to enumerate all of the
administrator accounts with those to see

288
00:22:42,769 --> 00:22:46,669
who was active in online so we've got
this live admins that txt that we're

289
00:22:46,669 --> 00:22:51,049
going to use and it also helps if we run
this a couple of times sometimes the

290
00:22:51,049 --> 00:22:53,840
Federation is a little bit slow to catch
up

291
00:22:53,840 --> 00:22:58,010
we'll see if it is slow in the demo or
not sometimes it is sometimes it's not

292
00:22:58,010 --> 00:23:02,600
actually skip back

293
00:23:08,990 --> 00:23:14,990
yeah that's that is something else but
me two seconds here

294
00:23:17,750 --> 00:23:24,139
alright everybody see that because I
can't

295
00:23:24,139 --> 00:23:28,580
ah so I'm going to try and projects and
mike picks it up

296
00:23:28,580 --> 00:23:34,129
I what we see here is a login as skype
support in state for business

297
00:23:34,130 --> 00:23:44,419
we've got power shell in the background
here with the this is really tricky with

298
00:23:44,419 --> 00:23:49,610
the power state module loaded up and
we're going to use that test emails i'm

299
00:23:49,610 --> 00:23:51,360
actually going to hop down here

300
00:23:51,360 --> 00:24:07,889
so sighs hopefully it'll list of
statuses it's going to take a second to

301
00:24:07,890 --> 00:24:13,770
run but really the core functionality
that's happening the backend is we start

302
00:24:13,770 --> 00:24:17,490
a conversation with some of these email
address never actually send them

303
00:24:17,490 --> 00:24:22,770
anything so in the state for link sdk
you could start a conversation but you

304
00:24:22,770 --> 00:24:26,730
don't actually have to send anything so
we start off the conversation get the

305
00:24:26,730 --> 00:24:31,020
current status of a user her and just
close out the conversation so they never

306
00:24:31,020 --> 00:24:35,400
seen anything on their end we just get
their status information and we output

307
00:24:35,400 --> 00:24:38,640
that to a table right there

308
00:24:38,640 --> 00:24:48,570
cool so this might be a little difficult
to see but I'm gonna try this i

309
00:24:48,570 --> 00:24:52,290
apologize i really like the presenter
mode so i can still see my notes

310
00:24:52,290 --> 00:24:55,049
otherwise it'd be mirroring everything
and I don't switch between the two

311
00:24:55,049 --> 00:24:57,690
sounds like we have a question

312
00:24:57,690 --> 00:25:02,669
so the question was where did I get the
domain name so what actually did is I

313
00:25:02,669 --> 00:25:07,710
went through the alexa top 1 million and
try to see which one's had federated

314
00:25:07,710 --> 00:25:10,860
escape kind of work down from there

315
00:25:11,490 --> 00:25:17,130
so these are all the default
administrator domain admin accounts i'm

316
00:25:17,130 --> 00:25:21,299
not trying to target any of these people
specifically but we get all this

317
00:25:21,299 --> 00:25:22,980
information back in the table there

318
00:25:22,980 --> 00:25:28,290
alright so let's return to this

319
00:25:28,950 --> 00:25:35,850
alright cool so um yeah that's really
handy info to have right being able to

320
00:25:35,850 --> 00:25:40,409
look up status invalidate the actual
email addresses we know that they're

321
00:25:40,410 --> 00:25:41,370
real

322
00:25:41,370 --> 00:25:46,770
we can use them for authentication so of
the top million your way that 47,000

323
00:25:46,770 --> 00:25:52,139
with ms equals $OPERAND m/s star I
didn't do very broad sweeping checks

324
00:25:52,140 --> 00:25:58,049
outside of the administrator account but
45 of the domains had administrator

325
00:25:58,049 --> 00:25:58,610
available

326
00:25:58,610 --> 00:26:03,260
and there may be a few more than that
people may be changing their default

327
00:26:03,260 --> 00:26:06,650
domain admins username something like
that or they may just not have an actual

328
00:26:06,650 --> 00:26:12,320
federated skype for business account for
it but it doesn't really like opening a

329
00:26:12,320 --> 00:26:17,780
ton of skype conversations so once he
hit around 2,000 conversations the

330
00:26:17,780 --> 00:26:22,370
client itself starts crashing so if
anybody wants to dive deeper into that

331
00:26:22,370 --> 00:26:28,520
for bug bounty let me know I get you the
info on that uh but anyways I'm trying

332
00:26:28,520 --> 00:26:32,480
to go through these top million you know
keep crashing the client and you know

333
00:26:32,480 --> 00:26:34,790
having to restart so there may be more
than 45

334
00:26:34,790 --> 00:26:39,799
I don't I but I got some good
information from nicks key again you

335
00:26:39,799 --> 00:26:47,150
should go back and watch that talk I but
there were 30,000 658 link discover .

336
00:26:47,150 --> 00:26:52,820
domain.com so link discovers what you
would use to kind of identify that link

337
00:26:52,820 --> 00:26:56,750
or skype server out on the internet you
can use it for things like conferences

338
00:26:56,750 --> 00:27:00,590
things like that but that's a pretty
good surface area there so you might

339
00:27:00,590 --> 00:27:06,049
have missed a little bit of those kinda
hard to tell how many federated so

340
00:27:06,049 --> 00:27:12,980
that's kind of a surface attack that
we're looking at their so what we're

341
00:27:12,980 --> 00:27:17,990
going to move forward into next is skype
message fishing it's kind of a little

342
00:27:17,990 --> 00:27:24,110
bit further than just getting status so
I we've got a fairly legitimate looking

343
00:27:24,110 --> 00:27:28,639
skype for business account that we're
using looks like scape support with

344
00:27:28,640 --> 00:27:33,230
Microsoft if we send them something
saying hey what's your password we need

345
00:27:33,230 --> 00:27:38,419
to fix skype on your machine or some
better pretext than that we can cue all

346
00:27:38,419 --> 00:27:42,380
of this up with powershell and send it
out to an entire domain so if we

347
00:27:42,380 --> 00:27:47,630
validate your entire LinkedIn's list of
email address or addresses we can just

348
00:27:47,630 --> 00:27:50,780
go ahead and spam out to everybody over
skype for business

349
00:27:50,780 --> 00:27:55,910
so let's see here uh the second
commandment shown here specifically is

350
00:27:55,910 --> 00:27:57,740
selecting people that are available

351
00:27:57,740 --> 00:28:00,680
you probably want to try and send skype
for business message out to somebody

352
00:28:00,680 --> 00:28:05,900
that's busy your out of office something
like that so

353
00:28:06,650 --> 00:28:11,510
oh here in this case we're gonna send a
message to me and we're also going to

354
00:28:11,510 --> 00:28:15,140
send 10 messages to me if you really
want to annoy somebody you can send them

355
00:28:15,140 --> 00:28:20,840
a thousand messages you'll see here
hopefully if everything gets squared

356
00:28:20,840 --> 00:28:22,070
away properly

357
00:28:22,070 --> 00:28:33,800
ok it's gonna be difficult so I have to
do a little back and forth lyrics I'm

358
00:28:33,800 --> 00:28:53,090
not mirroring screens here Mouse there

359
00:28:53,090 --> 00:29:09,860
alright so the first thing we're going
to do is we're going to check my status

360
00:29:09,860 --> 00:29:14,810
is my email adress pretty easily i'm not
too worried

361
00:29:14,810 --> 00:29:23,300
so we see that I'm available online i
believe i'm busy but I'm around so what

362
00:29:23,300 --> 00:29:30,680
we want to do I apologize that this
demos struggling a little bit we're

363
00:29:30,680 --> 00:29:39,260
going to send a message to me saying
hello from Derby County alright did

364
00:29:39,260 --> 00:29:52,129
something except that Littlefinger begun
fun stuff and you know from from the

365
00:29:52,130 --> 00:29:56,930
perspective of the user we don't have an
icon or any real information here but it

366
00:29:56,930 --> 00:30:00,710
says skype support and that looks pretty
legitimate somewhat believable

367
00:30:01,490 --> 00:30:08,660
you know for phishing protection program
to say hello from Derby con let's see

368
00:30:08,660 --> 00:30:29,059
here and then the last command we're
gonna do here is to send 10 messages i

369
00:30:29,059 --> 00:30:30,410
erase that

370
00:30:30,410 --> 00:30:35,809
so we're going to do a for loop here to
send a skype message to my email with

371
00:30:35,809 --> 00:30:43,280
the hello dollar sign whatever my
iterator is so see loading up here and

372
00:30:43,280 --> 00:30:47,420
you can't see it on my end but skype for
business keeps flashing down over here

373
00:30:47,420 --> 00:30:51,710
it like i said if you do like a hundred
or thousand it will keep going for a

374
00:30:51,710 --> 00:30:56,000
long time I did the practice front of
this back the nest by office make it a

375
00:30:56,000 --> 00:31:01,400
hundred and it was still flashing on my
screen like 20 minutes later so it it

376
00:31:01,400 --> 00:31:04,760
may take a while

377
00:31:04,760 --> 00:31:10,309
alright perfect

378
00:31:10,910 --> 00:31:15,500
so that was kind of fun we've got a
video demo of it to which we can skip

379
00:31:15,500 --> 00:31:17,150
because we just did this

380
00:31:17,150 --> 00:31:24,110
another fun thing is exercising unc
paths who's familiar with unc baths good

381
00:31:24,110 --> 00:31:25,070
number hands

382
00:31:25,070 --> 00:31:29,480
awesome I so if you're already on the
internal demand let's say I'm doing an

383
00:31:29,480 --> 00:31:34,220
on-site pentest somewhere I've got
domain creds i can log into their skype

384
00:31:34,220 --> 00:31:36,559
instance directly from my box

385
00:31:36,559 --> 00:31:41,690
I just load up a powershell here and
listen entire list of email addresses

386
00:31:41,690 --> 00:31:46,400
for the internal demand and send them at
UNC path there's a fair number of people

387
00:31:46,400 --> 00:31:50,150
are probably going to click on it
because i already have domain creds and

388
00:31:50,150 --> 00:31:55,340
this is coming from an internal domain
user shuttling unc paths and SMB

389
00:31:55,340 --> 00:31:59,720
connections out of the internet probably
not getting as much mileage over that I

390
00:31:59,720 --> 00:32:03,590
haven't had a whole lot testing that in
our lot of testing that in my

391
00:32:03,590 --> 00:32:09,230
environment but internally this should
work just fine so i guess on your end

392
00:32:09,230 --> 00:32:13,730
from attack structure you would have an
SMB listener waiting so when they click

393
00:32:13,730 --> 00:32:14,820
on that link

394
00:32:14,820 --> 00:32:18,899
go ahead and authenticate to you have
credentials you can either relay those

395
00:32:18,899 --> 00:32:21,120
try and crack come cetera

396
00:32:21,120 --> 00:32:26,250
additionally if your external HD p links
work as well so trying to fish somebody

397
00:32:26,250 --> 00:32:29,250
that way is pretty handy

398
00:32:30,120 --> 00:32:33,120
yeah they covered everything there

399
00:32:33,899 --> 00:32:44,549
well really the only demo here I can
show you just for sake of demo is just

400
00:32:44,549 --> 00:32:59,850
sending that UNC path so you can see
what it looks like here that pop up over

401
00:32:59,850 --> 00:33:00,299
there

402
00:33:00,299 --> 00:33:03,299
there we are so you can see the UNC path
shows up just fine

403
00:33:04,649 --> 00:33:13,918
alright so there's a little bit more
further work to do with this

404
00:33:13,919 --> 00:33:18,389
I've got some more stuff i want to add
like specifically sending files

405
00:33:18,389 --> 00:33:22,080
it's nice to send messages but much
rather sent files this link SDKs a

406
00:33:22,080 --> 00:33:23,970
little difficult to deal with the times

407
00:33:23,970 --> 00:33:29,340
so getting the file setup is a little
bit little bit tricky but you can also

408
00:33:29,340 --> 00:33:35,820
pull down sip endpoints I don't have any
of that in this demo here I but if you

409
00:33:35,820 --> 00:33:39,120
want to pull down a domains with phone
numbers including cell phone numbers

410
00:33:39,120 --> 00:33:41,908
which are frequently stored in Active
Directory you can pull that down to

411
00:33:41,909 --> 00:33:49,289
additionally brute fight brute-forcing
skype creds using the link sdk it's kind

412
00:33:49,289 --> 00:33:52,350
of a pain trying to get the
authentication process set up with that

413
00:33:52,350 --> 00:33:57,990
link sdk can be a little bit tedious so
Nikki had some great methods in terms of

414
00:33:57,990 --> 00:34:04,230
using the ntlm off for the link
autodiscover that stuff i'm going to add

415
00:34:04,230 --> 00:34:11,099
in our skype within the next couple
weeks here so I dictionary attacks

416
00:34:11,099 --> 00:34:14,700
against federated accounts so we've got
a domain that's federated we know it

417
00:34:14,699 --> 00:34:18,178
microsoft told us so how do we start
brute-forcing credits right we're on the

418
00:34:18,179 --> 00:34:22,109
external side we don't have a whole lot
of options other than maybe fishing

419
00:34:22,109 --> 00:34:24,629
skype credentials or anything like that

420
00:34:24,629 --> 00:34:29,549
I we want to try and brute force creds
well it's probably not totally clear the

421
00:34:29,550 --> 00:34:36,899
screen shot here but that get ad FS m .
PowerShell command that i have here if

422
00:34:36,899 --> 00:34:41,759
you do the dash CMD flag you actually
get a command that comes back with this

423
00:34:41,760 --> 00:34:47,460
invoke DFS security token request for
federated domains i can get that

424
00:34:47,460 --> 00:34:52,319
directly from Microsoft was from one of
their blog post here and should give you

425
00:34:52,319 --> 00:34:56,399
all of the information that you need to
create that request in this case we're

426
00:34:56,399 --> 00:35:01,078
going against a DFS . example.com going
to use Carl . faucet as the username

427
00:35:01,079 --> 00:35:07,829
password is winter 2016's I changed a
little early from summer 2016 and you

428
00:35:07,829 --> 00:35:13,740
have to have the domain to so in terms
of enumerated the domain no skype for

429
00:35:13,740 --> 00:35:21,720
business or link i if it has a ntlm HTTP
interface on the autodiscover you can go

430
00:35:21,720 --> 00:35:25,890
ahead and try to I pull the domain
information from that just hit with a

431
00:35:25,890 --> 00:35:30,328
map back with the domain info is there
the true the really tricky part here is

432
00:35:30,329 --> 00:35:33,569
you have to have the correct username
and how many of you've been in

433
00:35:33,569 --> 00:35:37,319
environments where they rename the
Active Directory accounts from you know

434
00:35:37,319 --> 00:35:44,400
k Fossen to a 123456 if I wanted to
authenticate as somebody who's like that

435
00:35:44,400 --> 00:35:47,760
i would have to have that a 123456

436
00:35:47,760 --> 00:35:53,579
so if you're renaming things different
from what the what the email address is

437
00:35:53,579 --> 00:36:00,450
so i get the internal email address is
carl at Fossen and the user name is Carl

438
00:36:00,450 --> 00:36:03,720
Fossen that's pretty easy but if they
rename it something else you have to

439
00:36:03,720 --> 00:36:08,220
have that correct username in there so
small caveat there we pick our sample

440
00:36:08,220 --> 00:36:12,959
version all of that I since this was
direct from Microsoft for my own

441
00:36:12,960 --> 00:36:17,010
personal use of just wrapped it with a
try-catch a little red texture that you

442
00:36:17,010 --> 00:36:23,640
see authentication successful arm /
their software licensing model I can't

443
00:36:23,640 --> 00:36:27,210
be packaged any of this so we may end up
just rewriting it in a different way

444
00:36:27,210 --> 00:36:32,160
we'll see but right now I'm just been
wrapping it with a try-catch block and

445
00:36:32,160 --> 00:36:34,618
if i'm able to successfully authenticate
it

446
00:36:34,619 --> 00:36:38,880
it's out so that blog post is pretty
handy to figure out how this

447
00:36:38,880 --> 00:36:41,880
authentication process works

448
00:36:43,470 --> 00:36:47,098
so if it's a Microsoft management man
we've just been looking at federated

449
00:36:47,099 --> 00:36:51,420
domains I we can actually just directly
authenticate to Microsoft now they

450
00:36:51,420 --> 00:36:56,369
probably don't appreciate a ton of
failed authentication request i'm just

451
00:36:56,369 --> 00:36:59,880
i'm guessing i don't know haven't heard
anything directly from them but i'm just

452
00:36:59,880 --> 00:37:01,049
guessing

453
00:37:01,049 --> 00:37:05,970
I so we can wrap this connect em cell
service with kind of a try-catch thing

454
00:37:05,970 --> 00:37:11,339
to see if we can actually authenticate
to the microsoft online services now

455
00:37:11,339 --> 00:37:14,970
this is coming directly from the issuer
Active Directory powershell modules i

456
00:37:14,970 --> 00:37:21,629
talked about earlier so in this case the
command here is just get credential for

457
00:37:21,630 --> 00:37:25,920
a credit to pass a credential in to
connect em cell service if you really

458
00:37:25,920 --> 00:37:29,549
want to put clear-text credits in your
script to do that whatever basically you

459
00:37:29,549 --> 00:37:33,990
can wrap this connect em cell service to
try and brute force creds the tricky

460
00:37:33,990 --> 00:37:40,979
thing is killing that connection after
you've successfully guest potential so

461
00:37:40,980 --> 00:37:46,109
from halfway through the users list i
guess a summer 2016 password that keeps

462
00:37:46,109 --> 00:37:50,369
that M Saul service connection open
there's no easy way to kill that other

463
00:37:50,369 --> 00:37:54,329
than killing powershell so one of my
co-workers at nets by Ryan can Drew's

464
00:37:54,329 --> 00:37:57,749
kind of working on some workarounds for
that to try and brute force as microsoft

465
00:37:57,749 --> 00:38:00,450
online creds sorry

466
00:38:00,450 --> 00:38:09,180
microsoft so um you know once we've got
those credentials you a couple users

467
00:38:09,180 --> 00:38:13,049
with weak passwords is nice but we want
to have a full list of the domain users

468
00:38:13,049 --> 00:38:17,249
because at this point we're still on the
external network we want to be able to

469
00:38:17,249 --> 00:38:22,649
serve pivoting internally so we can use
some other AD FS services to enumerate

470
00:38:22,650 --> 00:38:27,660
the rest of the domain users so it's
pretty easy if you're on Azure Active

471
00:38:27,660 --> 00:38:33,779
Directory once we have that ms all
connection we just do get em sell user

472
00:38:33,779 --> 00:38:39,180
dash all and that should list out
everybody that's been shipped out to the

473
00:38:39,180 --> 00:38:43,140
Microsoft Azure Active Directory it's
pretty handy get all the great

474
00:38:43,140 --> 00:38:46,230
information here we can see here support
at microsoft support online

475
00:38:47,030 --> 00:38:50,240
it's pretty simple it's easy to listen
to users

476
00:38:50,840 --> 00:38:56,390
I this also works for apps that are
using Azure Active Directory so if

477
00:38:56,390 --> 00:39:00,259
there's any application testers in the
room are primarily application testers

478
00:39:00,260 --> 00:39:04,520
this would be a good takeaway for you if
the application either web app or thick

479
00:39:04,520 --> 00:39:09,230
client app is using Azure Active
Directory for its authentication make

480
00:39:09,230 --> 00:39:13,010
sure that you're using your credit for
the app to connect to this msel user or

481
00:39:13,010 --> 00:39:17,720
the m cell service online because you
can just list out all the other users in

482
00:39:17,720 --> 00:39:22,009
the application typically I've done a
couple of web apps now that use as your

483
00:39:22,010 --> 00:39:25,100
active directory for their
authentication i just use the

484
00:39:25,100 --> 00:39:29,029
credentials that the client has given me
to connect to the m cell service and

485
00:39:29,030 --> 00:39:33,110
list out all of the other users for that
application which can be really handy

486
00:39:33,110 --> 00:39:37,220
and get a web app and you're able to
guess you know the administrators

487
00:39:37,220 --> 00:39:45,109
password that's a nice nice little
bypass their so this was this was kind

488
00:39:45,110 --> 00:39:49,610
of a work in progress i discovered the
graph api probably two weeks ago I just

489
00:39:49,610 --> 00:39:54,440
was kind of wrapping up these slides
here the graph api is a web service that

490
00:39:54,440 --> 00:39:59,570
you can use that Microsoft host or that
you can kind of work through to get

491
00:39:59,570 --> 00:40:04,430
domain information we can do a quick
demo of it here the code for this is

492
00:40:04,430 --> 00:40:11,359
really beta at the moment but basically
you create a graph token when you do

493
00:40:11,360 --> 00:40:14,390
that you can see it here it pops up this
little sign into your account

494
00:40:15,170 --> 00:40:20,720
I it's managed domain it will go and
authenticate to microsoft and if it's a

495
00:40:20,720 --> 00:40:25,189
federated domain it will just forward
you onto that a TFS server for that oh

496
00:40:25,190 --> 00:40:27,800
man this is really handy

497
00:40:27,800 --> 00:40:31,250
we've had a couple of domains that I've
done this for where they have pretty

498
00:40:31,250 --> 00:40:36,350
limited limited federated services or a
DFS services on the internet but they

499
00:40:36,350 --> 00:40:42,470
still allow access to the radio if a
server through the graph api we just

500
00:40:42,470 --> 00:40:48,529
create the token list the tenant the
domain goes here part it's the azure ad

501
00:40:48,530 --> 00:40:49,700
tenant

502
00:40:49,700 --> 00:40:54,859
we're basically pulling down a list of
users here you can pull this from the

503
00:40:54,860 --> 00:41:01,700
powershell get hub from that's by here
pull up the demo here we do have a video

504
00:41:01,700 --> 00:41:06,470
demo this i'm going to play the video
instead assuming it's playing here

505
00:41:06,470 --> 00:41:13,220
because this one has a tendency to crash
on my box right now we're gonna sign in

506
00:41:13,220 --> 00:41:17,629
and support at microsoft support .
online just paste the password in there

507
00:41:17,630 --> 00:41:25,580
and we can see here that we listed out
the domain users right here it's kind of

508
00:41:25,580 --> 00:41:32,480
handy so this is kind of a last of the
items here are if everything is really

509
00:41:32,480 --> 00:41:37,580
limited you're just really trying to
find ten ok find the last of the users

510
00:41:37,580 --> 00:41:41,060
you can connect to exchange online
assuming that setup is actually come in

511
00:41:41,060 --> 00:41:45,200
really handy for one of our assessments
I'm gonna leave this stuff in here

512
00:41:45,200 --> 00:41:50,060
slides we post on SlideShare probably
later today so you can get that info

513
00:41:50,060 --> 00:41:56,330
from here it's not know that someone
interesting but we've already covered

514
00:41:56,330 --> 00:42:01,040
couple other methods already so we'll
bounce pass this here real quick

515
00:42:01,040 --> 00:42:06,500
really it's just using the exchange
powershell live ID stuff on office 365

516
00:42:06,500 --> 00:42:08,990
to go ahead and get a list of all the
mailboxes

517
00:42:08,990 --> 00:42:14,479
so here's the fun part pivoting to the
internal network this is probably what

518
00:42:14,480 --> 00:42:18,380
you're waiting for ok we guess default
credit against these adfs interfaces how

519
00:42:18,380 --> 00:42:22,040
do we get to the internal network as an
external pentester that's really what we

520
00:42:22,040 --> 00:42:24,380
want to do so on

521
00:42:24,380 --> 00:42:28,790
believe it or not I've found
single-factor VPN on three different

522
00:42:28,790 --> 00:42:33,680
client networks from external tests
already this year could do a decent

523
00:42:33,680 --> 00:42:38,149
number of external pentest but it's not
like every every day it's a new web apps

524
00:42:38,150 --> 00:42:41,960
are you internal I'm not constantly
doing external three already this year's

525
00:42:41,960 --> 00:42:46,970
kind of concerning kind of surprising so
I with one of these clients we

526
00:42:46,970 --> 00:42:52,580
enumerated some emails on linkedin when
head and guests against ms online with

527
00:42:52,580 --> 00:42:57,710
powershell those passwords we got full
list of all of their users got default

528
00:42:57,710 --> 00:43:00,700
creds enumerated their VPN interfaces as
part of the

529
00:43:00,700 --> 00:43:06,339
yeah external pentest login with single
factor EPN cool we're in this great

530
00:43:07,810 --> 00:43:13,930
I they had group policy with Chad local
admin on all their boxes found da went

531
00:43:13,930 --> 00:43:15,460
ahead and did the DC sink

532
00:43:15,460 --> 00:43:19,119
I know how many internal pen testers in
here have gotten run into this yet but

533
00:43:19,119 --> 00:43:24,040
the store passwords using reversible
encryption this is fantastic

534
00:43:24,910 --> 00:43:28,930
so when you do a DC sync against the
domain controller that has this flag set

535
00:43:28,930 --> 00:43:31,720
up the client didn't actually know that
they had this flag set

536
00:43:31,720 --> 00:43:34,930
I there's a pretty good chance that
you're going to get most of the

537
00:43:34,930 --> 00:43:40,029
passwords back in clear-text Eric Gruber
was helping out on this one is sitting

538
00:43:40,030 --> 00:43:45,190
down here and he couldn't believe it
like he did the DC sink is like was

539
00:43:45,190 --> 00:43:50,260
gonna get you some hashes to crack but
here's all of the internal passwords

540
00:43:50,260 --> 00:43:57,970
this is all clear text so that was that
was kinda handy so there's other routes

541
00:43:57,970 --> 00:44:00,970
are you know you're not gonna run into
single factor BP and everywhere you go

542
00:44:01,630 --> 00:44:06,700
I just got lucky and found a handful
client so far this year i know there's

543
00:44:06,700 --> 00:44:09,730
other single factor services that are
out there and that's kind of what we're

544
00:44:09,730 --> 00:44:12,849
highlighting on with the multiple
different areas that we can try to

545
00:44:12,849 --> 00:44:16,030
authenticate against there's multiple
different services and you know you may

546
00:44:16,030 --> 00:44:22,300
have dual factor set up directly on the
adfs server but it may not be for the I

547
00:44:22,300 --> 00:44:26,349
you know the exchange interface or you
know the is your Active Directory

548
00:44:26,349 --> 00:44:31,150
anything like that so we still
surprisingly see a fair amount of rdp

549
00:44:31,150 --> 00:44:35,589
ssh with Active Directory cred
sharepoint internal services etc etc

550
00:44:35,589 --> 00:44:41,319
lots of single factor routes available
so one of the ways to pivot outside of

551
00:44:41,319 --> 00:44:48,730
just using one of those services or VPN
is just one draft documents so you're

552
00:44:48,730 --> 00:44:52,450
coming from the internet if they've got
office 365 set up with some kind of

553
00:44:52,450 --> 00:44:57,040
Federation you just drop the malicious
mack road word document into their

554
00:44:57,040 --> 00:45:00,040
onedrive now this kind of assume that
they're using onedrive

555
00:45:00,720 --> 00:45:04,709
a lot of people that we know that have
office 365 they're actually realize they

556
00:45:04,710 --> 00:45:09,060
have one drive its kind of oh I can put
stuff on the cloud and then people

557
00:45:09,060 --> 00:45:13,080
figure out that you shouldn't be putting
that stuff out loud anyways so your

558
00:45:13,080 --> 00:45:16,259
mileage may vary with that as well but I
was kind of surprised i kind of assumed

559
00:45:16,260 --> 00:45:20,220
that the macros would have gotten
stripped out when you put them up in

560
00:45:20,220 --> 00:45:25,680
onedrive that you persist if you open up
the document in word on the web portal

561
00:45:25,680 --> 00:45:29,940
like the word or the the web version of
word your macros are really going to

562
00:45:29,940 --> 00:45:36,870
help you out there Melissa sharepoint I
i missed the sharepoint talk and kind of

563
00:45:36,870 --> 00:45:40,200
bummed out that wasn't able to make it i
but there's plenty of attacks you can do

564
00:45:40,200 --> 00:45:43,680
against sharepoint we do frequently see
that exposed to the internet so

565
00:45:43,680 --> 00:45:48,120
potentially just editing audio content
on the actual sharepoint page or

566
00:45:48,120 --> 00:45:53,100
backdooring shared documents that's kind
of an attack vector that I really like

567
00:45:53,100 --> 00:45:57,690
is you were able to access and share .
we're sharing documents / that you know

568
00:45:57,690 --> 00:46:02,310
that you know domain admin or privileged
account is opening up that document you

569
00:46:02,310 --> 00:46:08,190
go ahead and back to that document i
sent messages directly from outlook web

570
00:46:08,190 --> 00:46:12,360
access or exchange online I or skype for
business

571
00:46:12,360 --> 00:46:15,330
once you've got two main credits you can
pretend to be somebody from the dome and

572
00:46:15,330 --> 00:46:21,240
say you know people look at this word
doc for me seems somewhat trustworthy

573
00:46:21,240 --> 00:46:27,779
this is especially good on the internal
side of things I so I think Nick left

574
00:46:27,780 --> 00:46:30,810
because I think he had to get a flight
but i was able to talk to him by this

575
00:46:30,810 --> 00:46:32,460
malicious outlook rule stuff

576
00:46:32,460 --> 00:46:38,010
Nick Landers from silent break security
i came up with his way of executing

577
00:46:38,010 --> 00:46:41,130
programs with malicious rules

578
00:46:41,130 --> 00:46:46,200
you definitely have it i retweeted it on
twitter at five left or right

579
00:46:46,200 --> 00:46:52,200
I go and check out his talk from
yesterday really good stuff I little

580
00:46:52,200 --> 00:46:56,669
further word to kind of programmatically
do this the mapi interface over HTTP

581
00:46:56,670 --> 00:47:02,070
since posted a really cool post about
this check that out as well I basically

582
00:47:02,070 --> 00:47:05,700
you're creating malicious rule to run a
program and get a show on somebody's box

583
00:47:05,700 --> 00:47:09,600
i tried to do this programmatically with
powershell I was trying to make about

584
00:47:09,600 --> 00:47:12,848
this earlier using the PowerShell
command list

585
00:47:12,849 --> 00:47:18,190
for outlook you can't really do this you
can't do the running program rule for

586
00:47:18,190 --> 00:47:22,210
some reason they don't allow that for
real creation from those commandments so

587
00:47:22,210 --> 00:47:26,920
kind of annoying so I was happy to see
this map over HTTP thing because that

588
00:47:26,920 --> 00:47:29,529
that helps get past that

589
00:47:29,529 --> 00:47:35,109
so in terms of attack mitigations set up
dual factor on as many authentication

590
00:47:35,109 --> 00:47:37,690
and points as you can

591
00:47:37,690 --> 00:47:43,779
here's one that was from the alexa top 1
million just went to the office 365

592
00:47:43,779 --> 00:47:47,799
logging get redirected to their ad FS
server and they've got RSA security

593
00:47:47,799 --> 00:47:52,720
passcode right there that's great that's
gonna stop me for that interface they

594
00:47:52,720 --> 00:47:56,109
may have five other interfaces they're
all single factor and we can try

595
00:47:56,109 --> 00:48:01,660
brute-force creds and find other ways in
but enabling dual factor as much too can

596
00:48:02,289 --> 00:48:09,039
that's great I limiting Federation to
trusted domains only this is

597
00:48:09,039 --> 00:48:13,630
particularly important for the skype for
business if you only need to skype chat

598
00:48:13,630 --> 00:48:17,349
with one other company only open up
Federation to that one other company

599
00:48:17,349 --> 00:48:20,680
there are ways you can limit it is good

600
00:48:20,680 --> 00:48:25,118
personally I don't really see much of a
benefit to widely federating skype for

601
00:48:25,119 --> 00:48:25,809
business

602
00:48:25,809 --> 00:48:31,269
I i like talking my clients not problem
there but I it does kind of open up this

603
00:48:31,269 --> 00:48:34,689
large surface area of people being able
to chat with each other that kind of

604
00:48:34,690 --> 00:48:36,579
thing

605
00:48:36,579 --> 00:48:41,170
ah let's see here monitoring any
federated or is your endpoints the is

606
00:48:41,170 --> 00:48:44,979
your Active Directory cloud stuff is
great for monitoring they have a ton of

607
00:48:44,979 --> 00:48:49,509
monitoring tools you can use i actually
took a look at some of the cloud

608
00:48:49,509 --> 00:48:53,499
monitoring stuff for my own accounts as
i was doing some of this testing really

609
00:48:53,499 --> 00:48:58,930
good information and feedback in there
and everybody says he can't get rid of

610
00:48:58,930 --> 00:49:02,078
weak passwords but setting stronger
password requirements is at least gonna

611
00:49:02,079 --> 00:49:07,299
make me do you know summer 2016 ! or
something

612
00:49:07,299 --> 00:49:11,200
I mean you'd be surprised at how
frequently see this and I don't mean to

613
00:49:11,200 --> 00:49:15,489
call out anybody in the room that may
have summer 2016 is their password you

614
00:49:15,489 --> 00:49:18,109
should really change that right now if
that's your password

615
00:49:18,109 --> 00:49:21,200
one of the first things that we're going
to guess what we're guessing passwords

616
00:49:21,200 --> 00:49:27,680
that's about all i have i just want to
do a quick special thanks to my

617
00:49:27,680 --> 00:49:31,098
co-workers and that's by who put up with
the constant barrage of skype messages

618
00:49:31,099 --> 00:49:39,980
sorry guys but I was not bounce dattani
ideas off of your internal team here

619
00:49:39,980 --> 00:49:44,150
everybody's given really good
suggestions so thanks my co-workers

620
00:49:44,150 --> 00:49:47,809
management team for giving me time to
work on this and Jerry I'm sure you

621
00:49:47,809 --> 00:49:51,380
might see this eventually my friend
Jared actually suggest looking

622
00:49:51,380 --> 00:49:57,109
Federation like five years ago and it
kind of certain me down this path so

623
00:49:57,109 --> 00:50:01,549
thanks to Jarrod for that so i guess if
anybody has any questions will stick

624
00:50:01,549 --> 00:50:02,390
around here

625
00:50:02,390 --> 00:50:07,038
i'm at $MONEY k faucet on Twitter those
links to the blog get hub and SlideShare

626
00:50:07,039 --> 00:50:08,599
any questions

