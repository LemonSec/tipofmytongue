1
00:00:00,000 --> 00:00:03,000
so first things first

2
00:00:03,000 --> 00:00:07,529
thanks for showing up at ten o'clock on
a sunday i can only imagine the caliber

3
00:00:07,529 --> 00:00:12,389
of hangovers everybody is suffering from
today so i'll try to speak nice and

4
00:00:12,389 --> 00:00:16,108
softly and you know if you guys want to
take a little nap during this that's

5
00:00:16,109 --> 00:00:23,279
totally fine to just appreciate that
you're here so we're here to talk about

6
00:00:23,279 --> 00:00:27,840
powershell incorporated it into your
arsenal using a tool i wrote called PS

7
00:00:27,840 --> 00:00:33,180
attack my name is Jared 8 i'm a security
engineer with gotten digital

8
00:00:33,180 --> 00:00:39,660
science-based at their office in
charlotte with my wife i am the co-owner

9
00:00:39,660 --> 00:00:44,279
of the medias dog on the face of the
earth with just no sense of personal

10
00:00:44,280 --> 00:00:51,329
space whatsoever and a broken bunny
bruiser had a really bad weekend while

11
00:00:51,329 --> 00:00:58,710
ago and now his head is stuck crooked so
he looks really curious all the time and

12
00:00:58,710 --> 00:01:08,700
super cute so there have been at least
know like three dozen powershell toxic

13
00:01:08,700 --> 00:01:13,560
Derby this year so it's somehow you have
made it to sunday and you still don't

14
00:01:13,560 --> 00:01:16,409
know what powershell is the sections for
you

15
00:01:16,409 --> 00:01:22,229
alright so powershell is a command line
shell and scripting language that

16
00:01:22,229 --> 00:01:28,470
microsoft created about 10 years ago and
they created it to basically you these

17
00:01:28,470 --> 00:01:34,829
were configuration and automation I its
built-in to.net so it provides super

18
00:01:34,829 --> 00:01:38,908
easy access to like all the powerful
stuff that . has had four years and kind

19
00:01:38,909 --> 00:01:44,100
of built up and also provides really
easy access common wmi so some of the

20
00:01:44,100 --> 00:01:49,110
legacy or long-term API is that you have
for managing windows super easy to use

21
00:01:49,110 --> 00:01:51,810
with in powershell

22
00:01:51,810 --> 00:01:56,250
it's gained a lot of popularity because
it's a really awesome language it's

23
00:01:56,250 --> 00:02:00,840
really well-designed microsoft had the
benefit of kind of approaching this

24
00:02:00,840 --> 00:02:06,060
blank slate of a scripting language and
looking at what is work for other

25
00:02:06,060 --> 00:02:10,769
scripting languages in the past what
hasn't and kinda built powershell to be

26
00:02:10,769 --> 00:02:16,140
kind of a best-of-breed modern language
some of the cool things that they've

27
00:02:16,140 --> 00:02:20,130
been able to do is kind of enforce these
conventions throughout powershell that

28
00:02:20,130 --> 00:02:25,470
make it really intuitive so the
commandments are all in this like verb

29
00:02:25,470 --> 00:02:29,580
now in the format which kinda makes
things a little bit verbose but it makes

30
00:02:29,580 --> 00:02:33,000
it really easy to understand what's
going on and figure out what it is you

31
00:02:33,000 --> 00:02:38,310
need to do so you have commands like you
know get content or asset content you

32
00:02:38,310 --> 00:02:44,910
know instead of like caps or you know
what have you there is also the switches

33
00:02:44,910 --> 00:02:48,239
throughout all of the Prague
commandments are very similar they're

34
00:02:48,239 --> 00:02:51,480
all kind of speak the same language if
you're going to be talking to another

35
00:02:51,480 --> 00:02:56,399
computer you're going to use the
computer name parameter hmm

36
00:02:56,400 --> 00:03:00,209
the other really cool thing is from the
very beginning that this big focus on

37
00:03:00,209 --> 00:03:04,980
building a usable help system which i
think is the first time Microsoft is not

38
00:03:04,980 --> 00:03:12,060
to do that what they ended up with is
kind of like man pages if man pages were

39
00:03:12,060 --> 00:03:18,480
written by normal people instead of like
computer science doctorates the other

40
00:03:18,480 --> 00:03:22,888
great thing about it is that it's
object-oriented now this is where

41
00:03:22,889 --> 00:03:26,370
developers in the room and like
manifestation maybe mumbling to

42
00:03:26,370 --> 00:03:30,420
themselves that like a powershell is an
object-oriented because of you know blah

43
00:03:30,420 --> 00:03:31,470
blah

44
00:03:31,470 --> 00:03:36,569
well I'm not a developer bitrate i'm
actually assist that man who just keeps

45
00:03:36,569 --> 00:03:42,000
developing things and pushing them out
and so my take on this whole object

46
00:03:42,000 --> 00:03:47,340
oriented thing is like powershell uses
objects the language is oriented around

47
00:03:47,340 --> 00:03:52,920
the objects so as far as I'm concerned
it's an object-oriented language sure

48
00:03:52,920 --> 00:03:56,458
there's developer minutiae in there that
people love to argue about but I really

49
00:03:56,459 --> 00:03:57,160
don't care

50
00:03:57,160 --> 00:04:04,450
so it's being used for pretty much
exactly what Microsoft a lot of what

51
00:04:04,450 --> 00:04:09,160
Microsoft intended to be used for a lot
of administration so a lot of the modern

52
00:04:09,160 --> 00:04:14,170
like the exchange management console for
the new version of active directory

53
00:04:14,170 --> 00:04:18,250
administrative center which is the new
version of users and computers

54
00:04:19,060 --> 00:04:22,990
those are really just these gooeys that
sit in front of PowerShell and just run

55
00:04:22,990 --> 00:04:26,560
PowerShell commands in the background
and what's cool about those you can

56
00:04:26,560 --> 00:04:28,870
actually enable the view where you can
see all the commands that they're

57
00:04:28,870 --> 00:04:32,680
running in the background makes it
really easy to script out whatever it is

58
00:04:32,680 --> 00:04:37,210
you're trying to do being used a lot for
automation so Microsoft has been pushing

59
00:04:37,210 --> 00:04:41,469
this this thing called DSC its desired
state config and its kind of their

60
00:04:41,470 --> 00:04:47,170
approach to the whole like
configurations code you know movement so

61
00:04:47,170 --> 00:04:52,750
can similar like your chefs or animals
or what have you and actually those

62
00:04:52,750 --> 00:04:58,000
chefs and ansibles a lot of those their
windows clients rely a lot on powershell

63
00:04:58,000 --> 00:05:03,400
for configuration so real powerful tool
really like used in the industry it's

64
00:05:03,400 --> 00:05:09,010
also seen a lot of pickup in infosec so
lot of great projects for data forensics

65
00:05:09,010 --> 00:05:12,700
instant response if that is your cup of
tea

66
00:05:13,210 --> 00:05:19,060
you really need to hit up invoked a shy
r dot com site by Jared Addison I it's a

67
00:05:19,060 --> 00:05:22,870
project that he's created and also it's
just a lot of tools and stuff up there

68
00:05:22,870 --> 00:05:28,570
and do does a lot of really cool work
with data forensics and is really where

69
00:05:28,570 --> 00:05:32,950
the big names out there just pushing
power show as a ir platform so really

70
00:05:32,950 --> 00:05:39,760
cool stuff up there but I'm a red team
er I i like to break things and

71
00:05:39,760 --> 00:05:47,140
occasionally fix them so for us our
shell is really really cool it is

72
00:05:47,140 --> 00:05:52,479
notoriously hard to block because power
show isn't actually powershell that exe

73
00:05:52,480 --> 00:05:58,450
it's a dll that's provided by dotnet and
powershell daddy exceeds kind of serves

74
00:05:58,450 --> 00:06:02,599
as a rapper for that that provides input
so you can execute commands off of it

75
00:06:02,600 --> 00:06:08,330
blocking powershell DXE doesn't actually
achieve a whole lot if your goal is to

76
00:06:08,330 --> 00:06:11,330
block powershell execution within your
environment

77
00:06:11,330 --> 00:06:16,099
the other cool thing about the
powershell community are the infosec

78
00:06:16,100 --> 00:06:19,970
powershell is the community that's come
up around it

79
00:06:19,970 --> 00:06:27,500
there are a lot of incredibly talented
developers and security researchers

80
00:06:27,500 --> 00:06:33,020
creating tools in powershell I really
think that he worked the powershell the

81
00:06:33,020 --> 00:06:37,640
offensive powershell community is doing
is really at the forefront of red

82
00:06:37,640 --> 00:06:43,580
teaming and pushing tactics and kind of
just driving the industry forward on and

83
00:06:43,580 --> 00:06:48,500
a lot of that comes from they the people
that develop this stuff they are very

84
00:06:48,500 --> 00:06:51,680
mature methodology they've been doing
red seeming for a long time they've been

85
00:06:51,680 --> 00:06:56,030
doing development for a long time so the
benefit that is you'll see a big focus

86
00:06:56,030 --> 00:07:01,820
on like not leaving forensic evidence
with your powershell tools and you know

87
00:07:01,820 --> 00:07:07,099
using like wmi using existing api's
within windows to achieve whatever it is

88
00:07:07,100 --> 00:07:10,280
they're trying to achieve as opposed to
calling like binaries which could

89
00:07:10,280 --> 00:07:17,090
possibly be logged or monitor the other
great thing is as mature developers the

90
00:07:17,090 --> 00:07:21,979
tools that the offensive powershell
community creates can really be like

91
00:07:21,980 --> 00:07:26,390
looked at as like the gold standard of
like how to write a proper powershell

92
00:07:26,390 --> 00:07:32,090
script arm their tools a fully integrate
with para shells health system they use

93
00:07:32,090 --> 00:07:37,640
all right parameters they feel like
native PowerShell commands so just a

94
00:07:37,640 --> 00:07:42,020
really lot of great stuff coming out of
there obviously infosec has really

95
00:07:42,020 --> 00:07:50,810
embraced powershell but i think a lot of
us know that our shells really cool and

96
00:07:50,810 --> 00:07:55,760
it's really powerful but if you SAT most
pen testers at a console they wouldn't

97
00:07:55,760 --> 00:08:02,180
know the first thing to do and so I
think a lot of that has to do with it's

98
00:08:02,180 --> 00:08:06,620
kind of hard to stay up on all that's
happening all the exciting stuff that's

99
00:08:06,620 --> 00:08:10,220
going on with you know the office
community there's kind of this like

100
00:08:10,220 --> 00:08:12,080
click like and

101
00:08:12,080 --> 00:08:16,698
good dozen 15 people that like you
really have to follow them on twitter

102
00:08:16,699 --> 00:08:20,569
and like to stay up on all the cool
stuff that's going on and the other

103
00:08:20,569 --> 00:08:26,389
thing is like pen testers we don't use
windows we use linux and use OS X we

104
00:08:26,389 --> 00:08:30,139
attack windows like Windows is a target
it's not like a development platform

105
00:08:30,139 --> 00:08:34,579
where we can make tools and stuff and so
there's that

106
00:08:34,578 --> 00:08:39,078
getting people excited about Windows is
a really really hard thing to do no

107
00:08:39,078 --> 00:08:43,458
matter how cool the tools are that are
out there so that let me to create PS

108
00:08:43,458 --> 00:08:50,630
attack so yes attack is a custom console
that's designed to emulate powershell

109
00:08:50,630 --> 00:08:54,620
and so if you are familiar with
powershell you can sit down you can get

110
00:08:54,620 --> 00:08:59,570
to work and you know do some wrexham
havoc if you're not familiar with

111
00:08:59,570 --> 00:09:03,560
parachutes really easy to get started
using PS attack and the things that you

112
00:09:03,560 --> 00:09:09,500
learn using PS attack should translate
over to an actual powershell console the

113
00:09:09,500 --> 00:09:13,250
great thing about it is I build it's not
it's a single executable

114
00:09:13,250 --> 00:09:19,579
super-lightweight you just download it
run it and it's ready to go inside PS

115
00:09:19,579 --> 00:09:24,410
tag are a hundred some-odd commands that
cover really like the whole range of an

116
00:09:24,410 --> 00:09:30,709
engagement and it includes a lot of like
modules from popular framework set you

117
00:09:30,709 --> 00:09:36,410
might have heard of like power tools and
power supply and a shame as well as some

118
00:09:36,410 --> 00:09:39,620
lesser tools i just think are really
awesome but just haven't gotten that

119
00:09:39,620 --> 00:09:47,329
like wide awareness so in May is a great
tool that basically implements responder

120
00:09:47,329 --> 00:09:53,029
button powershell the same developer
Kevin Robertson did an implementation of

121
00:09:53,029 --> 00:09:58,850
the hot potato attack called tater and
pn ps1 Fallon powershell so a lot of

122
00:09:58,850 --> 00:10:02,750
great work being done by the community
that just um trying to kind surface out

123
00:10:02,750 --> 00:10:09,949
the thing i added to PS tag is I
realized with a hundred and ten commands

124
00:10:09,949 --> 00:10:13,790
you know probably more now it's kind of
overwhelming like you're back at that

125
00:10:13,790 --> 00:10:17,410
where do I start like I just want to
hack shit where's the hack shit button

126
00:10:17,410 --> 00:10:22,300
so I included a command called get
attack and get attacked serves is

127
00:10:22,300 --> 00:10:27,040
basically a search engine for attacks
within PS attack so here you can see

128
00:10:27,040 --> 00:10:31,870
we're searching for passwords it's gonna
come back with mimic ads get gps gps

129
00:10:31,870 --> 00:10:35,829
password and you know other tools within
basically if you're looking to do

130
00:10:35,829 --> 00:10:39,189
something you can use get attacked to
figure out what commands you need to run

131
00:10:39,189 --> 00:10:45,160
and then I also i wanted to build
something that wasn't just a training

132
00:10:45,160 --> 00:10:48,610
tools not something we're just using lat
something that can actually be

133
00:10:48,610 --> 00:10:54,910
beneficial on engagements so I tried to
play around it to make sure that it is

134
00:10:54,910 --> 00:11:00,759
helps to evade I are in a B and one of
the things i do there is the modules

135
00:11:00,759 --> 00:11:05,649
that are part of PS attack all those
offensive tools are actually encrypted

136
00:11:05,649 --> 00:11:10,480
before they're bundled into the PS
attack binary and then PS attack starts

137
00:11:10,480 --> 00:11:16,240
those modules are decrypted into ram and
then run from there so the plaintext

138
00:11:16,240 --> 00:11:22,120
payloads never actually touch disc the
other cool thing is and it works just

139
00:11:22,120 --> 00:11:28,750
out of the box on windows 7 all the way
up to the latest version windows 10 and

140
00:11:28,750 --> 00:11:33,819
since it is powershell it does support
power shells awesome help system so all

141
00:11:33,819 --> 00:11:37,089
those great commands that you know use
get attacked to figure out what command

142
00:11:37,089 --> 00:11:40,660
you want to use you can use get help to
figure out how to use it

143
00:11:40,660 --> 00:11:51,399
so let's do a little demo here that
hopefully doesn't fall apart so in this

144
00:11:51,399 --> 00:11:57,519
scenario we have a desktop that either
we come across it's an unlocked desktop

145
00:11:57,519 --> 00:12:02,980
or maybe we got a similar level user
creds to an rdp instance so we're gonna

146
00:12:02,980 --> 00:12:11,019
go ahead and start out PS tag and the
first thing i want to do is fix this

147
00:12:11,019 --> 00:12:15,189
whole level user privileges thing right
so we're gonna run get attacked we're

148
00:12:15,189 --> 00:12:20,559
gonna look for what we can do for
escalation and a whole lot comes back a

149
00:12:20,559 --> 00:12:26,500
lot of its provided by power up which is
a great collection of the common

150
00:12:26,500 --> 00:12:29,410
misconfigurations in windows that allow
for print

151
00:12:29,410 --> 00:12:35,469
escalation so service service agencies
that have real loose permissions that we

152
00:12:35,470 --> 00:12:40,120
go ahead and overwrite restart and stuff
like that you know unattended install

153
00:12:40,120 --> 00:12:42,610
files that may have passwords in them

154
00:12:42,610 --> 00:12:48,430
the 1i want to run here though is invoke
ms 16 or 32 so if you're not familiar

155
00:12:48,430 --> 00:12:54,008
with them as 16 or 32 it's obviously a
relatively recent exploit that is a

156
00:12:54,009 --> 00:12:58,360
privilege escalation based off the
secondary logon service and windows

157
00:12:58,360 --> 00:13:03,430
there's a problem the way it holds
handles handles so what we can do is

158
00:13:03,430 --> 00:13:12,128
just roll in invoking has 16 or 32 and
that drops this into a system command

159
00:13:12,129 --> 00:13:16,449
prompt so we're running the system now
let's go ahead and start the attack

160
00:13:16,449 --> 00:13:17,439
again

161
00:13:17,439 --> 00:13:24,430
so now that we have system privileges we
can run mccants if you're not familiar

162
00:13:24,430 --> 00:13:31,239
with many cats many cats is like a Swiss
Army knife of credential scraping and

163
00:13:31,240 --> 00:13:34,329
memory scraping windows it does a whole
lot of really cool stuff

164
00:13:35,170 --> 00:13:39,910
the main thing people use it for those
dumping creds so let's go ahead not see

165
00:13:39,910 --> 00:13:47,050
what our options are for many many cats
so one option invoke mimic ats let's go

166
00:13:47,050 --> 00:13:54,339
and look at the help function for this
so I said the help system in Paris shows

167
00:13:54,339 --> 00:13:58,480
great so we have a synopsis of what it
actually does we have are you know

168
00:13:58,480 --> 00:14:03,370
credits to the authors and links all the
parameters that you know the command

169
00:14:03,370 --> 00:14:09,009
takes what we're interested in is the
dump creds program so let's go and do

170
00:14:09,009 --> 00:14:17,769
that and hopefully this works because
I've run this demo like one in five

171
00:14:17,769 --> 00:14:22,720
times like I don't actually get the
credit that i wanted to so hopefully

172
00:14:22,720 --> 00:14:25,720
that has not happened

173
00:14:26,960 --> 00:14:30,530
of course it does

174
00:14:30,530 --> 00:14:33,530
alright we're going to cheat here

175
00:14:55,970 --> 00:14:58,970
alright let's try that again

176
00:15:00,890 --> 00:15:17,990
hey what you know we have . x credits in
here now so this counter this audit nom

177
00:15:17,990 --> 00:15:23,000
account we see that it's a member of the
domain and his password is changed me

178
00:15:23,000 --> 00:15:29,480
one so we're gonna go back to our domain
user instance the PS attack we're gonna

179
00:15:29,480 --> 00:15:34,970
do some investigation see what this
audit nom account is all about always

180
00:15:34,970 --> 00:15:39,980
get attacked again and we'll search for
stuff involving users so a lot of recon

181
00:15:39,980 --> 00:15:44,330
is provided by a module called power
view which is this great collection of

182
00:15:44,330 --> 00:15:49,910
just like domain enumeration scripts and
stuff like that the command that we're

183
00:15:49,910 --> 00:15:55,699
interested in is getting that user which
is really just a replacement for the net

184
00:15:55,700 --> 00:16:02,840
users domain command so let's go ahead
and run that getting a user groups that

185
00:16:02,840 --> 00:16:09,830
is all the users let's run just against
audit nominal alright so a couple more

186
00:16:09,830 --> 00:16:13,160
interesting things come back here right
so we can see that it's a service count

187
00:16:13,160 --> 00:16:17,839
at least it's in the service account so
you can also see that he is a member of

188
00:16:17,840 --> 00:16:23,060
domain admins because he's a service
account so we'll just make him a domain

189
00:16:23,060 --> 00:16:28,609
admin he probably needs access to
something I'm sure let's go ahead and

190
00:16:28,610 --> 00:16:30,830
start PS attack though as audit nominal

191
00:16:30,830 --> 00:16:44,210
alright so we have a DA creds the next
thing you want to do because we're just

192
00:16:44,210 --> 00:16:47,840
sitting in some boots cube-like he may
be coming back from lunch or whatever so

193
00:16:47,840 --> 00:16:55,910
let's set up some persistence right so
we'll do a good attack persist and there

194
00:16:55,910 --> 00:17:00,589
is currently one utility and the reason
there is one utility is when I was

195
00:17:00,590 --> 00:17:03,050
putting this demo together for derby
Connor really want to demonstrate

196
00:17:03,050 --> 00:17:07,369
persistence that looked in via stagnate
didn't have any commands for persistence

197
00:17:07,369 --> 00:17:11,000
that looked around for commands that
like did for assistance kind of way I

198
00:17:11,000 --> 00:17:14,750
wanted to which is just like hey I want
to set up a schedule tasks that runs

199
00:17:14,750 --> 00:17:19,670
this command and give it some trams and
there's really nothing out there there's

200
00:17:19,670 --> 00:17:23,839
some native Commandments in powershell
but they're only available in I think 30

201
00:17:23,839 --> 00:17:29,270
and up for a scheduled task since we're
on windows seven were into datos like we

202
00:17:29,270 --> 00:17:33,410
have nothing so I wrote a real simple
command-line that basically just lets

203
00:17:33,410 --> 00:17:38,210
you set up schedule test so let's go and
look at some examples of that the

204
00:17:38,210 --> 00:17:42,140
examples which is my favorite thing
about get help

205
00:17:42,140 --> 00:17:48,050
so let's do that and then examples and
here we have like three examples of hey

206
00:17:48,050 --> 00:17:52,879
here's how you can actually use whatever
tool you're trying to use most of the

207
00:17:52,880 --> 00:17:57,800
tools provided by the offense community
have examples built-in memory cats is a

208
00:17:57,800 --> 00:18:02,180
great example I think they have 4427
just different you know here's how to

209
00:18:02,180 --> 00:18:07,880
use many cats so real helpful what we're
going to do is we're into a time-based

210
00:18:07,880 --> 00:18:16,820
scheduled tasks like it's going to start
at a certain time so time we're going to

211
00:18:16,820 --> 00:18:23,780
name this update or we're gonna have
this run under our audit nominal user

212
00:18:26,029 --> 00:18:40,820
we're going to set this up to repeat
three-peat every 90 minutes and see

213
00:18:40,820 --> 00:18:46,968
we're gonna run power show and the
arguments were going to provide i'm

214
00:18:46,969 --> 00:18:56,179
going to sheet here so if you have seen
any powershell before you've probably

215
00:18:56,179 --> 00:19:00,139
seen this this is a simple download
cradle

216
00:19:01,369 --> 00:19:05,269
so what this is going to do let's get
that on screen for you guys

217
00:19:07,429 --> 00:19:12,589
alright so what that's going to do it
creates a new dotnet object a web client

218
00:19:12,589 --> 00:19:18,678
object it's going to download the
contents of this file its going to call

219
00:19:18,679 --> 00:19:23,029
invoke expression on the contents of
that file so it's going to load it into

220
00:19:23,029 --> 00:19:28,249
the powershell instance and then we're
gonna run in this case it's downloading

221
00:19:28,249 --> 00:19:32,509
a command called invoke metasploit
payload so we're going to run invoke

222
00:19:32,509 --> 00:19:35,359
metasploit payload and pointed out a URL

223
00:19:35,359 --> 00:19:41,119
now what I've done is gone ahead and
basics before this powershell natively

224
00:19:41,119 --> 00:19:47,599
supports commands sent to it as basics
before screen screens and it's just a

225
00:19:47,599 --> 00:19:52,968
good way to get around any sort of like
you know issues within the shell so you

226
00:19:52,969 --> 00:19:57,109
know extra quoting or you know special
characters what have you it's just a

227
00:19:57,109 --> 00:20:02,449
good reliable way to get around all that
so go ahead and copy this and we will

228
00:20:02,450 --> 00:20:05,450
send that ends our argument

229
00:20:12,360 --> 00:20:21,780
alright so it returns some XML that
means that we successfully created are

230
00:20:21,780 --> 00:20:27,899
scheduled task if we look over at our
cali instance we should get a show

231
00:20:35,040 --> 00:20:40,590
alright so we should see it come in here
soon and download the high mascot ps1

232
00:20:40,590 --> 00:20:46,350
file the schedule test commandment if
you do a time-based scheduled task at

233
00:20:46,350 --> 00:20:50,699
least the one that I created it unless
you if you don't specify a start time it

234
00:20:50,700 --> 00:20:54,390
just starts in 30 seconds so hopefully
we should see it come across here

235
00:20:54,390 --> 00:21:20,790
shortly hopefully this part of the demo
has never failed as far as like me

236
00:21:20,790 --> 00:21:23,790
tested out so this would be first

237
00:21:31,620 --> 00:21:42,899
yeah well that is a complete shame i I'm
not going to troubleshoot this live on

238
00:21:42,900 --> 00:21:48,660
stage so I'm sorry just so here's like
what would happen you would see you know

239
00:21:48,660 --> 00:21:53,640
little request come into python over
here and then in our metasploit instance

240
00:21:53,640 --> 00:22:01,020
we would see a shell come in and
everybody would applaud I can't believe

241
00:22:01,020 --> 00:22:04,020
that didn't work

242
00:22:05,730 --> 00:22:15,690
just the bottom half that copy the whole
damn thing ya know that should've been

243
00:22:15,690 --> 00:22:19,860
right all right well demo fail

244
00:22:19,860 --> 00:22:22,860
yeah we'll see if we can run it manually
went on

245
00:22:38,010 --> 00:22:52,350
okay well yeah that's definitely demo
fail we're not gonna be able to fix that

246
00:22:52,350 --> 00:22:55,678
one life anyway so we'll pretend that
work and move on

247
00:22:56,610 --> 00:23:05,250
yeah that was awesome you guys are the
best

248
00:23:05,790 --> 00:23:13,379
alright so i think this attack is pretty
cool when it works and but i know that

249
00:23:13,380 --> 00:23:18,000
there are obviously some shortcomings
right so all the versions if you go to

250
00:23:18,000 --> 00:23:22,860
get out com you download the source code
you can palette or even if you download

251
00:23:22,860 --> 00:23:27,689
the binaries that releases their up
there they all use the same encrypted

252
00:23:27,690 --> 00:23:32,910
files right so those are signature is
that a bee can pick up on as they're the

253
00:23:32,910 --> 00:23:39,480
same and has really started happening
people keep uploading PS tag to

254
00:23:39,480 --> 00:23:44,400
virustotal which is a pain for me but I
totally understand why people would do

255
00:23:44,400 --> 00:23:49,440
it if PS attack ends up on your network
you probably should know there's like

256
00:23:49,440 --> 00:23:54,150
there's no good reason PS attack should
be on your network so i totally get

257
00:23:54,150 --> 00:23:57,150
people uploading virus total getting
that information out there

258
00:23:58,200 --> 00:24:03,690
the other thing is with the modules
being built into PS attack

259
00:24:03,690 --> 00:24:08,340
it's kind of a point-in-time snapshot of
those scripts right and the partial

260
00:24:08,340 --> 00:24:13,129
community is incredibly active so
everyday like new scripts are coming out

261
00:24:13,130 --> 00:24:19,010
updates are happening I and those aren't
being incorporated into PS text always

262
00:24:19,010 --> 00:24:23,150
going to be a little bit behind the
other thing is our shows incredibly

263
00:24:23,150 --> 00:24:27,290
awesome and you should be writing your
own stuff or maybe you have like this

264
00:24:27,290 --> 00:24:32,600
you know obfuscate version of Emma cats
that you want to rely on so I want to

265
00:24:32,600 --> 00:24:36,379
make it easy to incorporate your own
tools you don't get around all this so i

266
00:24:36,380 --> 00:24:42,050
created the PS attack build tool and
what the Stech build tool does is it

267
00:24:42,050 --> 00:24:46,669
downloads the latest release of PS
attack it downloads all the modules and

268
00:24:46,670 --> 00:24:52,640
stuff that it depends on encrypts those
with a unique key and then it this is

269
00:24:52,640 --> 00:24:57,050
new it goes through the PS attack source
code and looks for common strings like

270
00:24:57,050 --> 00:25:02,780
BS attack and replaces those with like
random strings now so kind of trying to

271
00:25:02,780 --> 00:25:08,780
get rid of the static you know signature
is that a bee might be picking up on

272
00:25:08,780 --> 00:25:13,610
that compiles all this for you you don't
need a built environment you just run

273
00:25:13,610 --> 00:25:16,820
the exe and it just compiled everything
for it's pretty great

274
00:25:17,330 --> 00:25:21,800
and at the end you get your own copy of
PS attack that is custom-made for you

275
00:25:22,460 --> 00:25:28,880
so here's demo of his-tagged running I
yeah sure

276
00:25:31,130 --> 00:25:53,180
yep that is coming up my French why
aren't you playing mr. video man this is

277
00:25:53,180 --> 00:25:56,180
like the worst like demo I've ever given

278
00:26:04,060 --> 00:26:12,159
also coming

279
00:26:12,160 --> 00:26:15,430
yes it is actually the same answer to
his question

280
00:26:15,430 --> 00:26:19,840
all right you know what the BS attack
build tool when you double-click it does

281
00:26:19,840 --> 00:26:22,449
all that stuff I said on the previous
slide

282
00:26:22,450 --> 00:26:32,590
man this so the dependencies are super
light for the build tool you need . 3 .

283
00:26:32,590 --> 00:26:37,959
by a full to build actually build PS
stagnates that actually what provides ms

284
00:26:37,960 --> 00:26:41,740
build which is what we're using to
compile everything and you also need

285
00:26:41,740 --> 00:26:45,430
don't have 45 or higher because of some
of the dependencies within the village

286
00:26:45,430 --> 00:26:50,290
school now to answer the questions of
how do I incorporate Mountain trolls how

287
00:26:50,290 --> 00:26:56,260
do i see you know what tools can stack
is downloading a build tool relies on a

288
00:26:56,260 --> 00:27:02,170
file called modules . json so it's a
simple JSON Val basically you gave it

289
00:27:02,170 --> 00:27:06,400
your all your thing a name and pointed
to a URL and it's going to go down with

290
00:27:06,400 --> 00:27:12,640
that ps1 file build it into a PS attack
so this is where like said if you know

291
00:27:12,640 --> 00:27:16,420
you have these obfuscate versions of
many cats are you know different for

292
00:27:16,420 --> 00:27:20,860
whatever you want to use easy to update
it here and I incorporated into your

293
00:27:20,860 --> 00:27:28,510
version of PS attack so both PS stack
and build tool available on my getup

294
00:27:28,510 --> 00:27:33,430
getup comms last year hate they both
have freaked about binary is available

295
00:27:33,430 --> 00:27:37,420
on the releases town so super easy to
just download and run

296
00:27:37,420 --> 00:27:46,270
um and yeah i encourage everybody to go
out and do that but I want to take kind

297
00:27:46,270 --> 00:27:48,400
of a break here and do a little story
time

298
00:27:48,400 --> 00:27:56,560
alright so a while ago i gave a talk at
bsides Charleston and the talk was an

299
00:27:56,560 --> 00:28:02,200
intro to powershell and how to use it
for evil which coincidentally happens to

300
00:28:02,200 --> 00:28:05,710
be the name of the class and giving next
month if you're interested in learning

301
00:28:05,710 --> 00:28:07,420
about power show

302
00:28:07,420 --> 00:28:15,310
so I give this talk and it was pretty
well it was a just a real simple

303
00:28:15,310 --> 00:28:19,990
introduction like hey you would never
scripted before here's how does you know

304
00:28:19,990 --> 00:28:22,750
here's what all the scripting
terminology is and here's some of the

305
00:28:22,750 --> 00:28:28,660
cool stuff you do with powershell the
the one mistake I made

306
00:28:28,660 --> 00:28:32,410
I you know that the one regret I have
about the talk is that during the Q&A

307
00:28:32,410 --> 00:28:36,400
somebody asked me like how would you
defend against all these powershell

308
00:28:36,400 --> 00:28:42,580
attacks and in my head what I meant to
say was something to the effect of like

309
00:28:42,580 --> 00:28:45,820
you know hey I'm I've been very focused
on the office side

310
00:28:45,820 --> 00:28:48,939
I you know I'm not really familiar them
on the defense side

311
00:28:48,940 --> 00:28:52,690
I you know so that's something I'm gonna
look into and you know I leave that as

312
00:28:52,690 --> 00:28:59,320
an exercise to the you know audience
what actually came out of my mouth was I

313
00:28:59,320 --> 00:29:04,659
break things I don't fix them which is
like as those words were queuing up and

314
00:29:04,660 --> 00:29:08,860
like man that is know that do not say
that that's like the worst possible

315
00:29:08,860 --> 00:29:11,350
thing to say like you're an idiot

316
00:29:11,350 --> 00:29:17,020
so the good thing was you knows besides
Charleston is a smaller environment so

317
00:29:17,020 --> 00:29:20,740
you know the impact was you know
relatively limited i learned my lesson

318
00:29:20,740 --> 00:29:27,730
and you know we all move on so then
security tube retweeted my video and

319
00:29:27,730 --> 00:29:32,860
that was kinda cool right and then
Jeffrey Snover retweeted my video if

320
00:29:32,860 --> 00:29:36,370
you're not familiar with jeffrey stone
over he was the keynote speaker here he

321
00:29:36,370 --> 00:29:40,540
is the he's a technical fellow at
Microsoft which is the highest

322
00:29:40,540 --> 00:29:46,840
engineering position microsoft has he
created Power show and is now over like

323
00:29:46,840 --> 00:29:50,620
windows server $YEAR and windows cloud
and all this stuff so like that was

324
00:29:50,620 --> 00:29:54,939
mind-blowing like oh my god jeffrey
stone over like not only retweeted it

325
00:29:54,940 --> 00:29:58,420
but apparently watched like some of the
video enough to make a quote of

326
00:29:58,420 --> 00:30:04,030
something i said like that was awesome
and then manifestation tweeted

327
00:30:04,650 --> 00:30:15,030
and so I've looked up to Matt for a long
time he is definitely one of those guys

328
00:30:15,030 --> 00:30:21,180
that's just leading like offensive like
research and like they do it's awesomely

329
00:30:21,180 --> 00:30:25,680
so it's seen this like that was a punch
in the stomach play as like there's this

330
00:30:25,680 --> 00:30:32,010
dude that I look up to like telling me
that I'm an asshole so but yeah so I

331
00:30:32,010 --> 00:30:36,240
like I tweeted madam like oh my god dude
i know i was you were right like I as

332
00:30:36,240 --> 00:30:39,090
soon as I was saying that you know and
then I like tweeted out to my 10

333
00:30:39,090 --> 00:30:42,870
followers and like yeah you know you
should totally need like we need to fix

334
00:30:42,870 --> 00:30:48,600
things that's what security is about
right so then that actually DME and as

335
00:30:48,600 --> 00:30:54,840
you see in this light completely
unedited DM I we made up and now we're

336
00:30:54,840 --> 00:30:59,790
like bffs which is really great like you
know where we're always hanging out now

337
00:30:59,790 --> 00:31:04,020
and you know it's just there's some
really good stuff going on between me

338
00:31:04,020 --> 00:31:11,550
and matt like real bromance going on but
with all that said I need to atone for

339
00:31:11,550 --> 00:31:17,580
b-sides Charleston write it for if for
no other reason then like everybody I

340
00:31:17,580 --> 00:31:21,540
talked to in the like offensive
powershell community will not let go

341
00:31:21,540 --> 00:31:24,889
this fucking like I break things I don't
fix them that

342
00:31:24,890 --> 00:31:30,710
like at least once a day I hear some
joke about it so let's talk about

343
00:31:30,710 --> 00:31:33,710
defending against PS attack her

344
00:31:39,230 --> 00:31:43,940
so here's the big secret about
powershell it's not special

345
00:31:43,940 --> 00:31:56,840
it's not doing anything that separately
it's special that not in you know say so

346
00:32:01,820 --> 00:32:11,030
well now i'm going to hear about that
for another six months so really parish

347
00:32:11,030 --> 00:32:16,100
shows a post exploitation language right
so it's using existing exploits its

348
00:32:16,100 --> 00:32:20,389
using existing problems in the
environment and just leveraging that so

349
00:32:20,390 --> 00:32:24,200
really the best thing you can do to
defend against our show attacks is just

350
00:32:24,200 --> 00:32:32,330
basic security I gene so the best thing
you can do right is you know start

351
00:32:32,330 --> 00:32:37,010
protecting your privileged access
accounts that includes local admins if

352
00:32:37,010 --> 00:32:42,379
your local admins are all using the same
password and they can all log into any

353
00:32:42,380 --> 00:32:46,910
computer on the domain over the network
that is ninety percent of the reason why

354
00:32:46,910 --> 00:32:49,850
I would need two main admin to hack your
stuff right

355
00:32:49,850 --> 00:32:53,689
those are basically you basically give
me all the function of the domain admin

356
00:32:53,690 --> 00:32:58,460
that I would need to run throughout your
network so implement something like laps

357
00:32:58,460 --> 00:33:03,500
implement something like ships from a
trusted sec laughs is super cool for

358
00:33:03,500 --> 00:33:09,290
microsoft and I wish it was advertised
better it's a fully supported tool for

359
00:33:09,290 --> 00:33:12,409
randomly changing local admin passwords
in your network

360
00:33:12,950 --> 00:33:17,810
what it does is it pushes out this agent
sits on the computers and it just

361
00:33:17,810 --> 00:33:23,030
changes the password and then uploads it
to a protected attribute in ad and then

362
00:33:23,030 --> 00:33:27,620
you can give access to that attributes
you like your help desk and monitor its

363
00:33:27,620 --> 00:33:32,929
access and reset passwords once a
password has been accessed so really

364
00:33:32,930 --> 00:33:36,800
great solution because it's fully
supported by microsoft definitely

365
00:33:36,800 --> 00:33:41,510
something you should be looking into the
other thing is there is probably no

366
00:33:41,510 --> 00:33:45,290
reason your local admins need to be able
to log into other machines over the

367
00:33:45,290 --> 00:33:49,340
network so fix that there's a simple
group policy change that you can push

368
00:33:49,340 --> 00:33:53,300
out that will prevent your local admins
from you know migrating throughout the

369
00:33:53,300 --> 00:33:58,610
network it cuts off that lateral
movement the other cool thing that you

370
00:33:58,610 --> 00:34:03,500
know that's kind of come up recently is
a lot of times when we think about

371
00:34:03,500 --> 00:34:09,139
protecting access throughout the network
we think about protecting lower user low

372
00:34:09,139 --> 00:34:13,100
privileged users from accessing like
high privilege or sensitive and

373
00:34:13,100 --> 00:34:21,380
mation the way we should also add to
that is protecting I privileged accounts

374
00:34:21,380 --> 00:34:25,820
from accessing lower privileged
workstations like your domain admin

375
00:34:25,820 --> 00:34:30,500
accounts domain admin is so much more
than like I just need to be an

376
00:34:30,500 --> 00:34:34,100
administrator on all the boxes in the
domain and if you're using your domain

377
00:34:34,100 --> 00:34:38,509
admin accounts that way you're really
abusing those accounts and their way

378
00:34:38,510 --> 00:34:41,210
over privilege for what you need

379
00:34:41,210 --> 00:34:45,170
so consider like do your domain admins
actually need to login to end-user

380
00:34:45,170 --> 00:34:48,380
workstations they're probably don't you
can probably create a separate air of

381
00:34:48,380 --> 00:34:52,340
admins to handle that domain admin
account should be used for administering

382
00:34:52,340 --> 00:34:54,080
the domain

383
00:34:54,080 --> 00:34:57,620
same thing goes for service accounts
right your service counters probably

384
00:34:57,620 --> 00:35:02,390
don't need da rights no matter what the
vendors are telling you and I've been

385
00:35:02,390 --> 00:35:06,770
that lazy susan well I've been that
overworks this admin who you know

386
00:35:06,770 --> 00:35:12,920
there's like i've been lazy sysadmin to
that's why I like powershell so but you

387
00:35:12,920 --> 00:35:16,610
know i have like 20 things on my plate I
the students screaming at me that like

388
00:35:16,610 --> 00:35:20,330
our voice server isn't working like
fucking give voice service County a

389
00:35:20,330 --> 00:35:22,040
rights will visit it later

390
00:35:22,040 --> 00:35:25,790
that's a terrible approach and i
understand it happens but you know we

391
00:35:25,790 --> 00:35:29,900
need to go back and fix that and really
provisioning service accounts to have

392
00:35:29,900 --> 00:35:33,560
the privileges that they need and only
be able to access the resources that

393
00:35:33,560 --> 00:35:34,250
they need

394
00:35:34,250 --> 00:35:37,760
does your voice service county to be
able to login to end-user workstations

395
00:35:37,760 --> 00:35:45,650
probably not Jessica pain going on to
you know case we have our are privileged

396
00:35:45,650 --> 00:35:47,420
access we know what we need to do there

397
00:35:47,420 --> 00:35:51,110
we also need to be aware of what's going
on in the environment and Jessica pain

398
00:35:51,110 --> 00:35:56,690
published a great article about this i
really wish that this article was out

399
00:35:56,690 --> 00:36:02,150
when I was this admin because there are
so many event logs there's so many of

400
00:36:02,150 --> 00:36:05,240
them Heidi's like where do you start

401
00:36:05,240 --> 00:36:08,720
and this article tells you that like
here are the 5 things you need to

402
00:36:08,720 --> 00:36:13,189
monitor in like right now start
monitoring this in your domain it also

403
00:36:13,190 --> 00:36:17,090
covers how to roll out centralized event
14 using just existing windows tools

404
00:36:17,090 --> 00:36:21,980
it's all built into windows so a lot of
great information there like highly

405
00:36:21,980 --> 00:36:23,360
recommend you read that article

406
00:36:23,360 --> 00:36:29,300
for powershell specifically the best
thing you can do is update power show

407
00:36:29,300 --> 00:36:35,270
every release of PowerShell comes with
new security features enhanced logging

408
00:36:35,270 --> 00:36:43,670
so it you get up to like powershell b5
you get like basically over-the-shoulder

409
00:36:43,670 --> 00:36:47,480
transaction logging like you can see
everything that was typed into the

410
00:36:47,480 --> 00:36:49,580
console it's amazing

411
00:36:49,580 --> 00:36:54,560
for example when you start PS attack on
box that just as psv five and walking

412
00:36:54,560 --> 00:36:59,840
cranked all the way up it generates
something like 420 event blogs and that

413
00:36:59,840 --> 00:37:03,800
includes the plaintext loading as you
can see here of mimic at so any script

414
00:37:03,800 --> 00:37:08,480
even though it's decrypted it's coming
across ram that the event log so you can

415
00:37:08,480 --> 00:37:14,480
actually alert on the counter v addendum
to this is that when you update

416
00:37:14,480 --> 00:37:18,860
powershell make sure to remove our
shelter . oh because if both are

417
00:37:18,860 --> 00:37:19,910
available

418
00:37:19,910 --> 00:37:24,710
PS taxes just going to use to . oh and
none of that transaction log n is

419
00:37:24,710 --> 00:37:29,960
supported their has some logging but
nowhere near the depth DP sv5 supports

420
00:37:29,960 --> 00:37:37,610
and to kind of leave you guys with some
stuff to read I goatee PFE did a great

421
00:37:37,610 --> 00:37:42,050
its kind of this this post is also a
collection of links called who's afraid

422
00:37:42,050 --> 00:37:48,590
of PowerShell security definitely a
great read on many resources in there

423
00:37:48,590 --> 00:37:55,190
and Sean metcalf did and as for usually
great post on detecting our shelter

424
00:37:55,190 --> 00:38:00,560
actual and he actually includes vs
attack in there and just a very succinct

425
00:38:00,560 --> 00:38:06,200
if you're not reading Sean's blog it is
a treasure trove of information i-80

426
00:38:06,200 --> 00:38:12,379
security . work everything that dude
publishes is just very succinct into .

427
00:38:12,380 --> 00:38:17,570
like his ability to just like info dump
on a page is amazing so definitely

428
00:38:17,570 --> 00:38:20,990
suggest that last thing I would
recommend is following Jessica pain on

429
00:38:20,990 --> 00:38:26,899
Twitter and just do whatever it is she
says she is an awesome incident

430
00:38:26,900 --> 00:38:28,430
responders at Microsoft

431
00:38:28,430 --> 00:38:33,319
and same Sean just this incredibly low
signal-to-noise ratio like everything

432
00:38:33,320 --> 00:38:38,270
she tweets is like gold and should like
instantly be like researched and jumped

433
00:38:38,270 --> 00:38:46,580
on so wrapping up to remind you I talked
about PS attack earlier now that we've

434
00:38:46,580 --> 00:38:50,720
talked about the defense stuff had
created it to make it easy for people to

435
00:38:50,720 --> 00:38:56,089
start using powershell offensively and
to learn about it i use the build tool

436
00:38:56,090 --> 00:39:01,640
because it's awesome and that's where a
lot of my work is going into and really

437
00:39:01,640 --> 00:39:05,480
just I would really love any sort of
feedback that you guys have like if you

438
00:39:05,480 --> 00:39:09,590
run into issues if something's broken or
it doesn't work the way you expected to

439
00:39:09,590 --> 00:39:15,890
submit an issue let me know if you know
how to write C sharp i would greatly

440
00:39:15,890 --> 00:39:19,370
benefit benefit from that because i
don't know how to write C sharp

441
00:39:19,370 --> 00:39:23,630
I'm just figuring this out as I go along
as you can probably tell by like the

442
00:39:23,630 --> 00:39:29,360
massive code and possible stability
issues that he s tak has so if you know

443
00:39:29,360 --> 00:39:33,650
C sharp and quick fix like submit a pull
request i would love it but really just

444
00:39:33,650 --> 00:39:36,890
any sort of feedback like I love hearing
about people using PS attack on

445
00:39:36,890 --> 00:39:40,910
engagements that makes me so happy to
hear about or like hey you know I'm new

446
00:39:40,910 --> 00:39:44,930
to this powershell thing PS tackle super
helpful love hearing about that and if

447
00:39:44,930 --> 00:39:47,960
you want to tell me my tool socks like
as long as it's instructive that's fine

448
00:39:47,960 --> 00:39:50,030
too

449
00:39:50,030 --> 00:39:55,580
last thing I want to do is really give a
shout-out to the the real VP's PS attack

450
00:39:55,580 --> 00:40:00,140
without these guys would just be PS and
that wouldn't be super impressive

451
00:40:00,680 --> 00:40:04,609
these guys are really the guys that
created all the offensive modules that

452
00:40:04,610 --> 00:40:10,250
PS tak relies on and i mentioned earlier
that you know Twitter click that you

453
00:40:10,250 --> 00:40:15,020
know you can follow to kind of stay up
on what's going out this is really your

454
00:40:15,020 --> 00:40:19,070
starting point for that like follow
these people they're they're all really

455
00:40:19,070 --> 00:40:25,940
solid people so I let's see I'm Jade on
Twitter like comment subscribe

456
00:40:27,760 --> 00:40:37,900
I fuck outta here we probably have audio
on this video to the very in some some

457
00:40:37,900 --> 00:40:42,280
kind of a crash w of a media so I
apologize for the inconvenience

458
00:40:42,280 --> 00:40:45,280
it's

459
00:41:53,860 --> 00:41:58,300
yes

