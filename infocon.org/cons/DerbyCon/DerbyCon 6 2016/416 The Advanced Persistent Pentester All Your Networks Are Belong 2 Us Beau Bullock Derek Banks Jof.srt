1
00:00:00,000 --> 00:00:05,790
everybody it is good to see you a lot of
people i know get to Sunday morning all

2
00:00:05,790 --> 00:00:07,170
the way guys cute

3
00:00:07,170 --> 00:00:11,730
a lot of people get the sunday morning
and like you look like I'm an idiot so I

4
00:00:11,730 --> 00:00:17,160
am so happy to see everybody here is one
full one . so look just some

5
00:00:17,160 --> 00:00:20,640
introductions here we're going to do
this thing called advanced persistent

6
00:00:20,640 --> 00:00:29,039
pentester thinking like it act TM right
and we're going to try to cram three

7
00:00:29,039 --> 00:00:34,559
talks in the void five minutes okay
which means i would probably not going

8
00:00:34,559 --> 00:00:38,968
to do each section as much justice as we
would like to do let's be honest but

9
00:00:38,969 --> 00:00:45,840
we'll do it anyway so right here next to
me my fellow colleagues at Black Hills

10
00:00:45,840 --> 00:00:48,930
information security give it up for
Bullock and Derek banks

11
00:00:51,090 --> 00:00:58,800
my name is John some of you may know me
who is a security weekly fan in the

12
00:00:58,800 --> 00:00:59,940
water

13
00:00:59,940 --> 00:01:04,170
yeah love it ok so there's the alphabet
soup

14
00:01:04,170 --> 00:01:09,630
well we test things we break things we
do security weekly on a regular basis

15
00:01:09,630 --> 00:01:11,548
except this week

16
00:01:11,549 --> 00:01:16,409
well somebody what about it i would like
to do a hackney TV which is really

17
00:01:16,409 --> 00:01:21,570
awesome ends up yeah we are nice people
we like what we do we have a good time

18
00:01:21,570 --> 00:01:27,960
together we bring things alright so he
was wearing this is a slide out of the

19
00:01:27,960 --> 00:01:33,030
sand incident response survey earlier
this year and it's pretty obvious what

20
00:01:33,030 --> 00:01:38,460
the trends are between 2015 2016 right
we're talking about unauthorized access

21
00:01:38,460 --> 00:01:43,979
big data breaches we're talking about
you know an uptick in unauthorized sorry

22
00:01:43,979 --> 00:01:48,509
offers privilege escalation and you know
we're talking about crafted malware

23
00:01:48,509 --> 00:01:50,790
right we're not talking about
exploitation anymore

24
00:01:50,790 --> 00:01:56,759
this is about custom-crafted targeted my
way so let's talk about that okay

25
00:01:56,759 --> 00:01:59,790
traditional pentesting yeah traditional
testing

26
00:01:59,790 --> 00:02:04,320
let's ball scan let's explore the
highest criticals let's escalate pivot

27
00:02:04,320 --> 00:02:07,320
grab a beer to celebrate done right

28
00:02:08,910 --> 00:02:14,220
three times anymore does that actually
work right not a spot right maybe maybe

29
00:02:14,220 --> 00:02:18,210
in some environments where people are
just not securing things this

30
00:02:18,210 --> 00:02:22,830
traditional kind of approach works great
behind criticals all their you grab

31
00:02:22,830 --> 00:02:28,560
stuff your village rob steal take data
go home and write a pretty report and

32
00:02:28,560 --> 00:02:32,550
everybody's happy but really are you
doing that your organization of service

33
00:02:32,550 --> 00:02:35,250
if they're more mature and they're
actually patching things you may not

34
00:02:35,250 --> 00:02:40,080
find any ice and criticals more than
likely you won't find any nice and

35
00:02:40,080 --> 00:02:42,720
criticals so we're going to try harder

36
00:02:42,720 --> 00:02:47,400
it's not just about traditional approach
this level and repeat we need to go deep

37
00:02:47,400 --> 00:02:52,620
in some cases when we go deep we need to
think in terms of developers and think

38
00:02:52,620 --> 00:02:57,360
like it's 1999 again like old-school
hacking forget about just the

39
00:02:57,360 --> 00:03:02,820
traditional methodology right go to a
goal-driven mode explore those

40
00:03:02,820 --> 00:03:06,989
information low and medium findings
right the tough side defense

41
00:03:06,990 --> 00:03:12,900
scientifically like being really
rigorous about this right we obtained

42
00:03:12,900 --> 00:03:17,790
and demonstrate access to sensitive data
we might not even need to escalate in a

43
00:03:17,790 --> 00:03:18,630
pen test

44
00:03:18,630 --> 00:03:23,190
what's it really about for the customers
right it's really about us demonstrating

45
00:03:23,190 --> 00:03:27,329
that they have business risk do you
always need domain administrator to

46
00:03:27,330 --> 00:03:29,310
demonstrate that right

47
00:03:29,310 --> 00:03:33,690
your daughter ok you don't necessarily
have to you can demonstrate business

48
00:03:33,690 --> 00:03:40,410
risk in so many other ways right so the
point is this talk is the appt food

49
00:03:40,410 --> 00:03:46,950
system testing food don't just use the
training invent things right let's

50
00:03:46,950 --> 00:03:48,030
inventing things

51
00:03:48,030 --> 00:03:52,800
let's talk about the fund frustration of
inventing new things and sort of going

52
00:03:52,800 --> 00:03:56,760
off the reservation from traditional
training so here's the agenda

53
00:03:57,690 --> 00:04:00,959
i'm going to start out by talking about
some java serialization and

54
00:04:00,959 --> 00:04:07,860
deserialization work I've actually up to
20 days i found this year in penn tests

55
00:04:07,860 --> 00:04:11,970
one night we can talk about anybody's
John strands for yesterday was talked

56
00:04:11,970 --> 00:04:15,870
about the other one I cannot talk about
but i'll talk about insult

57
00:04:15,870 --> 00:04:20,220
generalization terms right there are
still talking about a black box case

58
00:04:20,220 --> 00:04:21,620
study as

59
00:04:21,620 --> 00:04:26,030
out of a pen test and then bow is going
to bring you some goodness that you're

60
00:04:26,030 --> 00:04:30,739
going to love I promise but likes the
release tools so i was going to release

61
00:04:30,740 --> 00:04:33,979
some stuff that's really going to be
awesome but I won't steal another and

62
00:04:33,979 --> 00:04:37,880
let let go do that and then we're gonna
cap it off with some summary and

63
00:04:37,880 --> 00:04:43,669
conclusion so that sounds like fun right
we ready yeah let's do it

64
00:04:43,669 --> 00:04:50,120
alright so java simulation of the
serialization here's the thing with java

65
00:04:50,120 --> 00:04:55,760
it likes to serialize objects everywhere
and it likes to transmit them between

66
00:04:55,760 --> 00:04:58,550
clients and servers and serialized form

67
00:04:58,550 --> 00:05:03,139
ok this can be a very bad thing

68
00:05:03,710 --> 00:05:08,090
gay couple of things here first of all
little serialize remote method

69
00:05:08,090 --> 00:05:12,560
invocation it'll serialize that over
whatever custom communication method

70
00:05:12,560 --> 00:05:19,280
wants to it will also see realize that
the arrest PS traffic and there is a wot

71
00:05:19,280 --> 00:05:25,580
of implicit trust built into serious
serialization and deserialization ok

72
00:05:25,580 --> 00:05:29,750
what you have on the screen here is a
simple Java program

73
00:05:30,440 --> 00:05:34,969
don't don't hate me i'm not a good job
program ok it's a very simple java

74
00:05:34,970 --> 00:05:39,050
program that is a serialize test object

75
00:05:39,050 --> 00:05:44,090
ok have my name in it as a couple
attributes and then i wrote this object

76
00:05:44,090 --> 00:05:49,549
out to a file that is C realized object
it can be stored on disk it can be

77
00:05:49,550 --> 00:05:53,030
transmitted across the network and when
it received its received at the other

78
00:05:53,030 --> 00:05:58,309
end it will be deserialized and a new
job object will be created sir in the

79
00:05:58,310 --> 00:06:07,610
back we see this question was how often
do you see this in java applications all

80
00:06:07,610 --> 00:06:13,729
the time it is damaged in job
applications that are splitting into

81
00:06:13,729 --> 00:06:16,760
client-server entities it's everywhere

82
00:06:16,760 --> 00:06:20,030
ok what's the problem with this

83
00:06:20,030 --> 00:06:23,570
well let's talk about reading the object
first we'll talk about the problem isn't

84
00:06:23,570 --> 00:06:24,139
it

85
00:06:24,139 --> 00:06:27,260
so here I read the object back very
simple

86
00:06:27,260 --> 00:06:32,570
I've got class here that is creating a
cereal again creating an object up

87
00:06:32,570 --> 00:06:35,120
reading that binary blog from this

88
00:06:35,120 --> 00:06:37,820
that I just worked in the last program
and they just printing out the

89
00:06:37,820 --> 00:06:41,659
attributes right so we'll all I've got
there is two programs won the rights to

90
00:06:41,660 --> 00:06:46,220
write the disc of the object one that
reads it back ok pretty straightforward

91
00:06:46,220 --> 00:06:53,540
ok here's what you might see when you
have serializing objects going across

92
00:06:53,540 --> 00:06:55,550
the web

93
00:06:55,550 --> 00:07:02,210
ok this is straight-up boat sweet okay
first of all if I XD my new little

94
00:07:02,210 --> 00:07:09,500
object new thing . seer I see some
interesting stuff here i see a CED 0005

95
00:07:09,500 --> 00:07:14,360
as the first vice that is actually the
magic byte string to indicate to you

96
00:07:14,360 --> 00:07:19,280
that you're dealing with java object
serialization and deserialization ok you

97
00:07:19,280 --> 00:07:25,190
will see that if it's HTTP gas inside of
your other favorite inception proxy

98
00:07:25,190 --> 00:07:32,419
because just give up the world for Matt
you're going to see a CED 0005 ok that

99
00:07:32,419 --> 00:07:35,419
is just realized object coming over the
network

100
00:07:36,320 --> 00:07:40,669
nice so what can we do with this well
first of all we have a couple

101
00:07:40,669 --> 00:07:45,770
input/output classes we've got job by
output stream this thing has some very

102
00:07:45,770 --> 00:07:49,940
simple methods that right serialized
data to an output string right object

103
00:07:49,940 --> 00:07:54,469
right child right short and various
other data structure methods there's

104
00:07:54,470 --> 00:07:59,330
equivalent java.io.inputstream read
sterilized data readout reach I really

105
00:07:59,330 --> 00:07:59,990
short

106
00:07:59,990 --> 00:08:06,530
ok there is no saturday checking in
these methods in java if you read the

107
00:08:06,530 --> 00:08:09,799
object you can get red and created from
a string

108
00:08:10,550 --> 00:08:17,389
ok and less the developer actually puts
in specific code to check for things

109
00:08:17,389 --> 00:08:18,919
that are good or bad

110
00:08:18,919 --> 00:08:26,448
ok now you can see where this is going
right so we discovered my senior vs cost

111
00:08:26,449 --> 00:08:33,919
content we're going to c 0x acd 0005 in
the content and the things that can go

112
00:08:33,919 --> 00:08:39,110
wrong is the object input stream class
does not check which classes get

113
00:08:39,110 --> 00:08:44,270
deserialized ok there is no whitelist
and blacklist object checking unless the

114
00:08:44,270 --> 00:08:46,140
developer implements it

115
00:08:46,140 --> 00:08:53,520
arrives the real object called right the
user split input is likely going to be

116
00:08:53,520 --> 00:08:54,900
trusted

117
00:08:54,900 --> 00:09:00,660
right and about what I found some recent
test client-side objects are often

118
00:09:00,660 --> 00:09:08,490
trusted completely with no validation
that ball on the suicide and so how am I

119
00:09:08,490 --> 00:09:11,610
going to know what the object data
structure actually looks like it's easy

120
00:09:11,610 --> 00:09:15,720
for me to stand up here and say hey
here's a job soon realized object that i

121
00:09:15,720 --> 00:09:20,670
created in job right but if I feel like
an application that i'm testing

122
00:09:21,330 --> 00:09:25,500
I need to know actually what that code
looks like outside of the context of

123
00:09:25,500 --> 00:09:33,330
fibroids write java decompiler is your
friend so JD GUI i just did this with my

124
00:09:33,330 --> 00:09:34,230
own class

125
00:09:34,230 --> 00:09:38,520
ok so let's imagine you're testing a
java application its serialize

126
00:09:38,520 --> 00:09:43,230
deserialize you spotted in book you know
it's a job at the pops up when you first

127
00:09:43,230 --> 00:09:44,700
use the application

128
00:09:44,700 --> 00:09:49,410
ok download the class jam with the job
file right

129
00:09:49,410 --> 00:09:55,770
unzip it run it through java decompiler
and in most cases save the source code

130
00:09:55,770 --> 00:10:02,130
ok so you can reverse it once you save
the source code you can go through it

131
00:10:02,130 --> 00:10:10,020
and specifically search for things like
object input stream object output stream

132
00:10:10,020 --> 00:10:13,230
read object and right object

133
00:10:13,920 --> 00:10:17,729
ok if you find those things look deeper

134
00:10:18,300 --> 00:10:22,920
there's likely to be d serialization
vulnerabilities in that application

135
00:10:23,760 --> 00:10:29,730
ok here's some methodology thoughts that
i put together and i'm telling you i'm

136
00:10:29,730 --> 00:10:33,090
giving this a really lightweight
treatment okay because we don't have too

137
00:10:33,090 --> 00:10:39,450
much time this book shows you the magic
fights 0x acd there's our survive

138
00:10:39,450 --> 00:10:45,600
ok and you see things like post requests
to $FULLPHONENUM / XYZ magic servlet

139
00:10:45,600 --> 00:10:49,170
then you've got java object
serialization in play

140
00:10:49,740 --> 00:10:55,110
ok couple things you can pick up go
ahead and grab super-cereal passive very

141
00:10:55,110 --> 00:10:58,640
useful a little plugin that you can get
into but

142
00:10:58,640 --> 00:11:03,380
from direct offense ok get in there you
only see the alone

143
00:11:04,850 --> 00:11:08,600
look for the Java Sea civilization
scanner and the app store that's a

144
00:11:08,600 --> 00:11:12,650
useful thing to have to at least try to
manipulate those objects there's not

145
00:11:12,650 --> 00:11:13,130
much

146
00:11:13,130 --> 00:11:17,000
comprehensive coverage with these tools
yet though so you've gotta be gotta be

147
00:11:17,000 --> 00:11:18,440
careful

148
00:11:18,440 --> 00:11:22,370
download the app directly absolutely
decompiled search for real object and

149
00:11:22,370 --> 00:11:28,850
right object in particular locate the
serial version uuid you ID field because

150
00:11:28,850 --> 00:11:33,350
most objects will not get serialize and
created back on the server side and less

151
00:11:33,350 --> 00:11:37,040
serial numbers correct that's the only
check upstairs but guess what

152
00:11:37,580 --> 00:11:42,260
you just pull that out of string right
it's not a big deal right then find your

153
00:11:42,260 --> 00:11:45,770
object classes like personal concept
code that creates the objects directly

154
00:11:45,770 --> 00:11:50,060
on this compare the objects with some
sort of binary diff until you get a

155
00:11:50,060 --> 00:11:56,449
correct change values in the object
remove fields from the object at fuels

156
00:11:56,450 --> 00:12:01,820
back to the object files hat profit
create brand new objects as you can ok

157
00:12:01,820 --> 00:12:05,450
there's all kinds of things you can do
that you just have to get into being

158
00:12:05,450 --> 00:12:10,550
able to write some basic java being able
to decompile the job and then start to

159
00:12:10,550 --> 00:12:12,410
manipulate the objects in the string

160
00:12:12,410 --> 00:12:17,839
ok so here's some resources

161
00:12:17,840 --> 00:12:21,290
first of all what I'm talking about is a
real zero-day case that have believed

162
00:12:21,290 --> 00:12:25,459
this year I'm not going to mention names
but the short version of the story is

163
00:12:25,460 --> 00:12:30,980
there was a servlet on the server side
of the application that trusted the

164
00:12:30,980 --> 00:12:34,460
pathname the scent from the client
object

165
00:12:35,570 --> 00:12:43,250
what could go wrong with that raising
the results i could read any file from

166
00:12:43,250 --> 00:12:50,120
that server not just any file in the
service java servlets object path any

167
00:12:50,120 --> 00:12:52,730
file from that sir

168
00:12:52,730 --> 00:12:57,410
okay one thing it's not that's talked
about before

169
00:12:57,920 --> 00:13:01,910
first of all this topic has a car up too
often in 2015 there's a couple of talks

170
00:13:01,910 --> 00:13:08,270
Matthias kaiser are in one of the German
comments to talk here is a youtube link

171
00:13:08,270 --> 00:13:10,480
take a picture of this if you're
interested in

172
00:13:10,480 --> 00:13:16,180
suing this further there's also the
Apache Collins collection library which

173
00:13:16,180 --> 00:13:21,670
is a known vulnerability that was
discovered by the the guys that ride

174
00:13:21,670 --> 00:13:26,889
buses cereal which if you're in here not
apologize that our names but watch

175
00:13:26,889 --> 00:13:31,269
serial is the last link here that helps
you exploit that one this one is

176
00:13:31,269 --> 00:13:37,540
particularly pernicious okay what
happened here is they found a way to

177
00:13:37,540 --> 00:13:42,730
gain remote code execution by
serializing an object back against the

178
00:13:42,730 --> 00:13:48,459
apache commons collection library in
multiple applications there's a serious

179
00:13:48,459 --> 00:13:54,279
serious problem in in that it would
think hey I can just patch that right if

180
00:13:54,279 --> 00:13:58,630
you dealt with java server based
applications what happens is you can

181
00:13:58,630 --> 00:14:03,730
have five or six different applications
that you have put on this server that

182
00:14:03,730 --> 00:14:09,040
have five or six discreet separate
copies of the same class path levers

183
00:14:09,040 --> 00:14:17,139
it's not like catching an SSL or ssh or
something you have to find every one of

184
00:14:17,139 --> 00:14:17,740
them

185
00:14:17,740 --> 00:14:20,829
ok very serious problem

186
00:14:20,829 --> 00:14:24,969
so why cereal in the apache commons
collection library is widely used and

187
00:14:24,970 --> 00:14:28,630
really vulnerable remote code execution
possible

188
00:14:29,260 --> 00:14:33,819
ok at that i'm going to leave it and
move on to black box case study because

189
00:14:33,819 --> 00:14:48,849
i'm taking up too much time here is
there a little bit more title story the

190
00:14:48,850 --> 00:14:56,199
story is a engagement that bone I wrong
earlier in the year and thank you

191
00:14:56,199 --> 00:15:03,910
so this black box test we had a client
who wanted us to start with their domain

192
00:15:03,910 --> 00:15:08,889
name only and get into their internal
network they went too far

193
00:15:08,889 --> 00:15:13,300
put a flag on the internal domain
controller and they gave us a week to do

194
00:15:13,300 --> 00:15:16,750
it so challenge accepted

195
00:15:17,709 --> 00:15:21,739
so how do you go about getting it well
the obvious thing

196
00:15:21,740 --> 00:15:27,320
fishing right we'll start with vision
and we got some good targets we thought

197
00:15:27,320 --> 00:15:31,940
we had some good ruses that just wasn't
really working turned out they were

198
00:15:31,940 --> 00:15:37,880
really catching our campaign as Spanish
jump couldn't get it through we

199
00:15:37,880 --> 00:15:41,689
ultimately did get one show and we were
able to start doing a little bit of

200
00:15:41,690 --> 00:15:46,400
sexual situational awareness inside the
network but the show by we later found

201
00:15:46,400 --> 00:15:51,110
out that the user actually took a long
weekend on Wednesday of the week so

202
00:15:51,110 --> 00:15:57,710
we're getting a little concerned we
don't like to lose right so we noticed

203
00:15:57,710 --> 00:16:03,650
very reconnaissance that they're there
MX record . into a discovered me that

204
00:16:03,650 --> 00:16:09,500
already discovered to mean was in the
microsoft is your cloud so we we started

205
00:16:09,500 --> 00:16:19,190
password spray and at first the password
screen wasn't working and the sake of

206
00:16:19,190 --> 00:16:24,500
brevity of we did get password spring
working if anyone's interested in how we

207
00:16:24,500 --> 00:16:29,960
went about doing that we ended up by
passing protection in your login process

208
00:16:29,960 --> 00:16:36,770
so we are able to access multiple email
accounts and if you have your email in a

209
00:16:36,770 --> 00:16:41,150
cloud provider and they're telling you
that there are safeguards in place for

210
00:16:41,150 --> 00:16:42,319
authentication

211
00:16:42,320 --> 00:16:46,010
you may want to double track what's
actually happening during the

212
00:16:46,010 --> 00:16:50,810
authentication process because it may
not be an adequate substitute for

213
00:16:50,810 --> 00:16:57,349
two-factor authentication in fact in
this case it definitely was not so we

214
00:16:57,350 --> 00:17:03,590
got into the email they were able to get
the address book and get every much the

215
00:17:03,590 --> 00:17:07,460
ones we had during reconnaissance so
we're bringing some of our targets like

216
00:17:07,460 --> 00:17:18,590
3,000 and we started using passwords
other than the summer 2016 spring 26-1

217
00:17:18,589 --> 00:17:21,829
turned out company name 123

218
00:17:23,299 --> 00:17:27,230
it was a really popular one so we
started reading it and everybody's email

219
00:17:27,230 --> 00:17:28,940
server got up

220
00:17:28,940 --> 00:17:34,369
sharepoint quality that have to all
two-factor authentication now did not

221
00:17:34,369 --> 00:17:40,070
and so with with access to sharepoint
now there's a search feature in

222
00:17:40,070 --> 00:17:41,989
sharepoint an hour in the email

223
00:17:41,989 --> 00:17:48,049
we're in sharepoint in the cloud so what
would you search for sharepoint research

224
00:17:48,049 --> 00:17:55,519
for VPN and turned out they had
instructions for how to be into their

225
00:17:55,519 --> 00:18:01,639
network and the ship one and then on top
of that they provide a download link .

226
00:18:01,639 --> 00:18:10,850
very helpful so we install the VPN a lot
of our systems were able to connect

227
00:18:10,850 --> 00:18:15,049
those their internal network then we
found in clear-text administrator

228
00:18:15,049 --> 00:18:21,830
password and says ball chair found a
place to remote desktop to with

229
00:18:21,830 --> 00:18:25,220
administrator account and from there

230
00:18:25,220 --> 00:18:34,190
well maybe cats and repeat soon we found
why so . all that was sometimes

231
00:18:34,190 --> 00:18:40,220
traditional things will work and then
getting into are actually traditional

232
00:18:40,220 --> 00:18:44,149
things don't work actually taking a look
at what's happening during the test and

233
00:18:44,149 --> 00:18:48,199
being a little creative with a long way
here and the other . with that I would

234
00:18:48,200 --> 00:18:53,090
like to make is that access to email is
something that that we tend to overlook

235
00:18:53,090 --> 00:18:59,629
and we had many conversations about how
how valuable email is every company

236
00:18:59,629 --> 00:19:04,189
everyone send all their data and email
right you just assume its internal email

237
00:19:04,190 --> 00:19:10,730
trusted attackers can't get into that
stuff right well I'll tell you about

238
00:19:10,730 --> 00:19:13,730
that right here

239
00:19:15,440 --> 00:19:20,690
yeah just to put questions to know what
the administrator password they were you

240
00:19:20,690 --> 00:19:26,060
top sorry was the problem with doing

241
00:19:27,530 --> 00:19:31,490
yeah that was widespread local admin
across all their clients and servers

242
00:19:32,180 --> 00:19:37,580
what is that possible yeah they're
setting they weren't using something

243
00:19:37,580 --> 00:19:46,100
like box or yeah they were there
basically send your actual name of the

244
00:19:46,100 --> 00:19:52,429
file please don't look here we ended up
leaving a file on the domain controller

245
00:19:52,430 --> 00:20:00,380
this mvhs was here just to close out of
lab so we have black so that's why you

246
00:20:00,380 --> 00:20:06,560
able to use the correct correct you got
you know i do not know the answer that I

247
00:20:06,560 --> 00:20:10,970
i would assume that they had day so it
was tired of their internal

248
00:20:10,970 --> 00:20:15,170
authentication so there goes their
domain accounts working across the board

249
00:20:15,170 --> 00:20:20,570
for the stuff that was in the cloud and
then this stuff internally as well that

250
00:20:20,570 --> 00:20:24,679
was kind of unique about 12 is you know
a lot of the extra last video we find

251
00:20:24,680 --> 00:20:30,650
VPN server dns services running
extremely pretty often this case we

252
00:20:30,650 --> 00:20:36,110
actually during our initial recon didn't
find where that we can stop was the tax

253
00:20:36,110 --> 00:20:40,399
service here is very very small was also
discover their website brochure we're

254
00:20:40,400 --> 00:20:47,570
obviously had taken some kind of level
pay lower tax service and typically you

255
00:20:47,570 --> 00:20:50,750
can you know find like a VPN .
domain.com rivodeaux may not cover

256
00:20:50,750 --> 00:20:54,530
whatever that was not the case this but
having access to sharepoint would search

257
00:20:54,530 --> 00:20:56,420
for VPN and shirt off

258
00:20:56,420 --> 00:21:02,510
here's a third-party service they were
using and the key taxes that all right

259
00:21:02,510 --> 00:21:07,250
we got our two there's always kind of
lead into we're on that I'm so you know

260
00:21:07,250 --> 00:21:12,320
at the point where you get doing that on
a network now which it doesn't

261
00:21:12,320 --> 00:21:16,909
there are you guys know it's not hard on
those customers it's it's a pretty

262
00:21:16,910 --> 00:21:19,910
simple straightforward process
especially like 10

263
00:21:19,910 --> 00:21:25,760
I mean it makes the process of pivoting
around so easy you know you're not aware

264
00:21:25,760 --> 00:21:29,360
of it it will go out to you know all the
systems and they were a tall group

265
00:21:29,360 --> 00:21:31,520
memberships and help you find that s
cool

266
00:21:31,520 --> 00:21:35,660
action so if you have like one potential
network you can i'll figure out your

267
00:21:35,660 --> 00:21:42,710
escalation about to do not end with a
simple script which is beautiful so is

268
00:21:42,710 --> 00:21:44,360
not gonna do not know if it

269
00:21:44,360 --> 00:21:48,919
are you on your penthouse just looking
to get a domain administrator access if

270
00:21:48,920 --> 00:21:51,110
that's the case you're doing it wrong

271
00:21:51,110 --> 00:21:56,389
most c-suite all the EEOC is they don't
care like yeah I don't know what does

272
00:21:56,390 --> 00:22:01,220
that mean you know but if you go to them
and say hey i was able to actually

273
00:22:01,220 --> 00:22:05,000
access all of your customer data or hey
I got access to your industrial control

274
00:22:05,000 --> 00:22:09,200
systems and I'm an addict and I can shut
down the power for a city that mean

275
00:22:09,200 --> 00:22:10,250
something

276
00:22:10,250 --> 00:22:13,250
so how do you go about finding that
stuff

277
00:22:14,900 --> 00:22:20,600
one of the things that you know I like
to point out is that last year

278
00:22:20,600 --> 00:22:24,439
mandame trends released a report that
said that it takes a hundred forty six

279
00:22:24,440 --> 00:22:30,320
days on average to detect an attacker
network we don't have L we have five

280
00:22:30,320 --> 00:22:36,860
days maybe right to regulate the same
low risk that an attacker who has that

281
00:22:36,860 --> 00:22:40,939
amount of time can get access to want to
know what you have to do with that so

282
00:22:40,940 --> 00:22:47,330
you're noisy but being able to do it
matters and a lot of times if you know

283
00:22:47,330 --> 00:22:51,949
nothing about organization how do you go
about like learning more about the

284
00:22:51,950 --> 00:22:56,690
internal aspects of what they do a day
today we're where they actually have the

285
00:22:56,690 --> 00:23:04,670
date on network that can be really tough
right so one of the things we use a lot

286
00:23:04,670 --> 00:23:10,700
is power view from our joint which has a
few modules built into finds the data

287
00:23:10,700 --> 00:23:15,410
network so one of them is invited which
basically we'll just go out to the

288
00:23:15,410 --> 00:23:19,160
network final network shares you have
access to your end up going out any find

289
00:23:19,160 --> 00:23:23,330
all the shares on network and then
there's another function that are built

290
00:23:23,330 --> 00:23:28,429
that basically looks at the names of
files for specific terms so you know

291
00:23:28,430 --> 00:23:33,320
finding passwords and documents you know
we'll run it and get like you know a ton

292
00:23:33,320 --> 00:23:37,610
of like where users have just straight
up with like passwords and txt file on

293
00:23:37,610 --> 00:23:38,340
the network

294
00:23:38,340 --> 00:23:44,010
which school but what if you're on a
network that's really large and you know

295
00:23:44,010 --> 00:23:49,140
maybe maybe there's you know a ton of
different or maybe maybe there's a not

296
00:23:49,140 --> 00:23:52,350
enough data there to help when you to
the exact right place

297
00:23:52,350 --> 00:23:57,059
another thing you know target databases
so like just straight up going after

298
00:23:57,059 --> 00:24:02,220
databases which you can query active
directory for the spss equal servers and

299
00:24:02,220 --> 00:24:05,820
just go straight to target more or even
what i like to do is get access to like

300
00:24:05,820 --> 00:24:09,990
Abby center server and that way you can
just like see where you're you're

301
00:24:09,990 --> 00:24:13,169
awesome admin has already like
categorize everything it's a beautiful

302
00:24:13,169 --> 00:24:18,179
list so like here's our extreme servers
here's our sequel servers you know he's

303
00:24:18,179 --> 00:24:21,929
all our ad infrastructure that's the
case that you know you just drop right

304
00:24:21,929 --> 00:24:26,010
down to the cool thing about the center
and any virtualized environment is that

305
00:24:26,010 --> 00:24:32,250
it's kind of a false sense of having
segmentation our network so I don't

306
00:24:32,250 --> 00:24:36,179
think like oh I got this this critical
server lockdown i can only access it

307
00:24:36,179 --> 00:24:41,520
through rdp on this one jump host at
five p.m. on friday and you dropping to

308
00:24:41,520 --> 00:24:45,299
be centered you have console access that
everything and completely bypassing all

309
00:24:45,299 --> 00:24:51,480
those restrictions which is pretty cool
so we started talking like what what

310
00:24:51,480 --> 00:24:56,549
else could we do to locate sensitive
data quickly on network is there is

311
00:24:56,549 --> 00:25:00,510
there anything that will help point us
in the right direction you're trying to

312
00:25:00,510 --> 00:25:07,350
like I said five days learn as much as
you can about organization is top so the

313
00:25:07,350 --> 00:25:15,149
thing we kind of cool conclusion of his
email email is the primary communication

314
00:25:15,149 --> 00:25:19,799
platform for pretty much every
organization so if your employee

315
00:25:19,799 --> 00:25:23,309
organization you inherently trust your
internal email you some things on a

316
00:25:23,309 --> 00:25:27,840
day-to-day basis to everyone did you
don't typically most boys on how to mind

317
00:25:27,840 --> 00:25:28,289
set up

318
00:25:28,289 --> 00:25:34,980
oh I am i'm sending something sensitive
and an email that's that you know we we

319
00:25:34,980 --> 00:25:39,750
see like general chit-chat internal
email backward between people and you

320
00:25:39,750 --> 00:25:43,529
also have like password resize got
people talking about just day-to-day

321
00:25:43,529 --> 00:25:47,020
business you might have your c-suite
just basically like doing there

322
00:25:47,020 --> 00:25:52,330
the critical business / email saying hey
you know where you know increasing the

323
00:25:52,330 --> 00:25:55,210
budget here or whatever on you know
where we need to implement these new

324
00:25:55,210 --> 00:26:02,560
systems to do X function for business so
what I did is I wrote tool to search

325
00:26:02,560 --> 00:26:08,020
everybody email on a domain so I'm
introducing male striper it's a powerful

326
00:26:08,020 --> 00:26:13,389
scripts that once you have elevated in a
domain now you know how that is to

327
00:26:13,390 --> 00:26:17,650
search everyone's email on the domain
for specific cards and the same way the

328
00:26:17,650 --> 00:26:22,120
power you searches the network for
shares of files that have specific terms

329
00:26:22,120 --> 00:26:29,110
now we can search everyone email the
body the subject and so there's a call

330
00:26:29,110 --> 00:26:35,469
functions within mail first one was
related which you have an exchange

331
00:26:35,470 --> 00:26:39,670
administrative account balance by
default actually don't have the ability

332
00:26:39,670 --> 00:26:44,800
to search your gmail automatic exchange
is you you have to specify who can

333
00:26:44,800 --> 00:26:49,030
actually access to email exchange
administrators the actually the either

334
00:26:49,030 --> 00:26:52,840
organization management group or the
exchange organization administrators

335
00:26:52,840 --> 00:26:57,370
group inherently have access to that so
you know what we're looking for

336
00:26:57,370 --> 00:27:01,149
elevating now we don't typically have to
go after da specifically you can go

337
00:27:01,150 --> 00:27:04,510
after exchange administrators and now
search everyone's email or passwords

338
00:27:04,510 --> 00:27:10,060
fine insider Intel you know look for
databases like where somebody's talking

339
00:27:10,060 --> 00:27:14,379
about a database our network you know
anything like if you want to search for

340
00:27:14,380 --> 00:27:20,260
let's say like industrial control system
for David I csr skata you're gonna get a

341
00:27:20,260 --> 00:27:24,550
full list of just all these emails that
were getting inside the organization was

342
00:27:24,550 --> 00:27:30,040
talking about this specific thing so
don't give up now the other thing too is

343
00:27:30,040 --> 00:27:35,050
so with it being powerful script I wrote
it under the the idea that I wanted to

344
00:27:35,050 --> 00:27:38,530
do it all from testing system you know
typically you know you're uncomfortable

345
00:27:38,530 --> 00:27:43,720
Empire your session on like a
workstation the environment this is

346
00:27:43,720 --> 00:27:47,710
where you would be able to run from so
you don't have to actually get access to

347
00:27:47,710 --> 00:27:51,880
the exchange server itself you can just
run it from any workstation powerful and

348
00:27:51,880 --> 00:27:54,550
connectivity to the domain

349
00:27:54,550 --> 00:28:00,490
so there's two functions like I said you
know what I want to start writing this I

350
00:28:00,490 --> 00:28:04,540
thought yes looking at everybody's email
with the awesome but like i said it does

351
00:28:04,540 --> 00:28:07,840
require administrative access but what
doesn't require administrative access is

352
00:28:07,840 --> 00:28:11,830
searching your own email which you know
if you have access to system you can

353
00:28:11,830 --> 00:28:16,419
always search for an email off of an
Outlook forever but using exchange web

354
00:28:16,420 --> 00:28:21,280
services is basically what I'm using to
connect to exchange exchange of services

355
00:28:21,280 --> 00:28:26,710
basically the web-based API that is
installed on exchange servers bball so

356
00:28:26,710 --> 00:28:31,300
now with my tool you can is as long as
you have credentials valid credentials

357
00:28:31,300 --> 00:28:36,460
for user you cannot search their own
email so why would that be important why

358
00:28:36,460 --> 00:28:40,060
would be able to search any particular
person's just you know their own you

359
00:28:40,060 --> 00:28:45,669
know like why would that matter so a lot
of times and agents we had a lot of

360
00:28:45,670 --> 00:28:51,130
friends password spraying you know right
now that's a random post but maybe we

361
00:28:51,130 --> 00:28:57,220
have escalated to da yet but we have
much press now all we have to do is run

362
00:28:57,220 --> 00:29:00,280
command to analyze any of those users
and you can search through their own

363
00:29:00,280 --> 00:29:05,320
email or passwords so it becomes another
privilege escalation vector so we

364
00:29:05,320 --> 00:29:08,139
haven't we don't have adventures of
access but we have some present work we

365
00:29:08,140 --> 00:29:16,030
can search for example actually bring
this on engagement last week and I just

366
00:29:16,030 --> 00:29:20,470
search for database i was looking for a
customer database and came back a lot of

367
00:29:20,470 --> 00:29:24,040
hits and others there's a ton of hits
for database but what I thought it was a

368
00:29:24,040 --> 00:29:29,139
systems administrator who was basically
telling his internal team where the

369
00:29:29,140 --> 00:29:33,670
location of their internal keepass
database was along with the key for

370
00:29:33,670 --> 00:29:39,610
accessing the investigative network and
showed up they didn't have to factor on

371
00:29:39,610 --> 00:29:44,139
that for some reason David facebook e
and a underground network with database

372
00:29:44,140 --> 00:29:49,120
downloaded open it up all the past you
would never want to make all the essay

373
00:29:49,120 --> 00:29:53,949
passwords all the databases all the
network device passwords pretty much all

374
00:29:53,950 --> 00:29:58,150
the local is everything and it was it
was ridiculous but search the email for

375
00:29:58,150 --> 00:30:00,920
one term

376
00:30:00,920 --> 00:30:07,970
so yeah probably distillation with the
cell search function is the larger

377
00:30:07,970 --> 00:30:12,350
researching everything box and I calling
both global mail search searches through

378
00:30:12,350 --> 00:30:16,580
all the locks on demand for specific
terms like it

379
00:30:16,580 --> 00:30:20,870
what you need is have what's called the
application of personation roll on

380
00:30:20,870 --> 00:30:25,399
exchange so having an exchange of
connector exchange great your own user

381
00:30:25,400 --> 00:30:30,620
the impersonation role you have access
to search everyone you know and it's all

382
00:30:30,620 --> 00:30:35,270
just fits in my script so basically
ground grab an early the mailboxes from

383
00:30:35,270 --> 00:30:42,290
the domain and searching through them
and write about UCSB in testing so far

384
00:30:42,290 --> 00:30:48,920
we did Adam and had about 2,000
mailboxes and about four hours so not

385
00:30:48,920 --> 00:30:52,250
too bad you know timewise and 2000
number

386
00:30:52,250 --> 00:31:00,260
yeah that's pretty much it so it's on
github here it's available now there is

387
00:31:00,260 --> 00:31:07,280
a blog post that we are really saying
about 15 minutes and yeah it's a couple

388
00:31:07,280 --> 00:31:08,389
questions

389
00:31:08,390 --> 00:31:13,250
what's this look like in autumn ball is
very noisy or just look like an idiot

390
00:31:14,510 --> 00:31:21,560
its standard uws calls for just the
apartment searching the email it's also

391
00:31:21,560 --> 00:31:25,730
right in order to get yourself the
application versus nature roll i'm

392
00:31:25,730 --> 00:31:30,290
actually is promoting to connect to
exchange connected with the exchange on

393
00:31:30,290 --> 00:31:36,230
potential branding the the allocation
personation one exchange and then from

394
00:31:36,230 --> 00:31:41,840
there is already WS call ya questions

395
00:31:48,140 --> 00:31:53,240
yeah yeah I i had a fairytale land it
removes the personal so ideally what you

396
00:31:53,240 --> 00:31:58,790
do is we're like run as your typical
user that you've been provided access to

397
00:31:58,790 --> 00:32:02,840
which is generally just like a normal
domain account that means nothing right

398
00:32:02,840 --> 00:32:07,909
so you go you connect to change with the
change out of credits but gratitude

399
00:32:07,910 --> 00:32:11,450
your your user who you don't really care
about you know like if something was

400
00:32:11,450 --> 00:32:14,930
residual with an opportunity to remove
something accidentally from somebody who

401
00:32:14,930 --> 00:32:20,990
was supposed to have their all but yeah
I mean it i did not make open up the

402
00:32:20,990 --> 00:32:29,420
inscription questions just gonna close
up

403
00:32:29,420 --> 00:32:34,160
sure is creating that access long

404
00:32:35,600 --> 00:32:39,320
oh I would imagine as i have not tested
but we can definitely check it out yep

405
00:32:39,320 --> 00:32:46,700
working out i would imagine can yes I'm
anything but at the same time your

406
00:32:46,700 --> 00:32:55,070
account already has that is ya know or
so if you have domain admin access you

407
00:32:55,070 --> 00:33:00,679
can just add whatever you want to change
the pattern that you know so you could

408
00:33:00,680 --> 00:33:04,910
add your own user to change advancement
which of course with which of course

409
00:33:04,910 --> 00:33:09,170
will probably generate a log you know
having giving yourself a new ad group

410
00:33:09,170 --> 00:33:17,240
right so drop any other questions just
generally on the content my haha very

411
00:33:17,240 --> 00:33:18,560
spot up anyone

412
00:33:18,560 --> 00:33:24,679
yeah question when you're going to sell
search it's gonna look very given that

413
00:33:24,680 --> 00:33:29,840
you're using like their outlook or way
so that really good way to just take

414
00:33:29,840 --> 00:33:30,830
somebody

415
00:33:30,830 --> 00:33:35,149
yes the question was when you're doing
yourself such as not going to look like

416
00:33:35,150 --> 00:33:40,250
any other users searching their matt
watson and i think the last part was

417
00:33:40,250 --> 00:33:43,610
when we might be a good sort of
generalized weight of one of the things

418
00:33:43,610 --> 00:33:50,689
that's the power of a lawyer brian
looking at three powers different right

419
00:33:50,690 --> 00:33:54,350
yes so it's actually like it's using a
change what services which is all HTTP

420
00:33:54,350 --> 00:34:00,649
request so you can see HTTP request to
exchange itself which . is actually

421
00:34:00,650 --> 00:34:05,660
something else that we haven't actually
1% verified yet but we have something

422
00:34:05,660 --> 00:34:10,610
very interesting we might be able to
completely verify tomorrow or tuesday in

423
00:34:10,610 --> 00:34:14,810
regards to how you connect to change
using web services and and being able to

424
00:34:14,810 --> 00:34:15,590
access running

425
00:34:15,590 --> 00:34:19,130
no matter anyway

426
00:34:19,130 --> 00:34:24,200
externally whatever right yeah or
externally so what we're kind of on the

427
00:34:24,199 --> 00:34:28,609
path of binary now is that so if you
have to factor in table on your own

428
00:34:28,610 --> 00:34:34,070
worlds right a lot of organizations have
that we're finding is that thats true

429
00:34:34,070 --> 00:34:39,500
factory mechanism is strictly lock down
to the OAuth authentication itself not

430
00:34:39,500 --> 00:34:44,000
necessarily all the other services like
web services so we're we're still

431
00:34:44,000 --> 00:34:49,190
validated but rather right now we think
that you possibly can bypass it was two

432
00:34:49,190 --> 00:34:53,389
factor authentication by connecting with
a change web services which this will

433
00:34:53,389 --> 00:34:54,859
this will do right

434
00:34:54,860 --> 00:35:11,330
yeah yeah oh ok validated it says yes
but we just lock it down slides changes

435
00:35:11,330 --> 00:35:16,190
are ya external access for us money

436
00:35:16,190 --> 00:35:22,250
ok any other questions yes on the
contest stories though the most common

437
00:35:22,250 --> 00:35:24,620
password was this thing

438
00:35:24,620 --> 00:35:29,720
what was that password again the most
common password its comedy 123 I believe

439
00:35:29,720 --> 00:35:32,720
whiskey was the company yeah

440
00:35:35,670 --> 00:35:38,670
we're not answering that question the
question

441
00:35:40,130 --> 00:35:48,890
the seasons were very well sir the right
answer is all of them all the things

442
00:35:48,890 --> 00:35:53,839
right any other questions yes sir

443
00:35:54,590 --> 00:36:04,610
jobs realization like so the question
was how I dealt with job civilization on

444
00:36:04,610 --> 00:36:10,730
google WebKit applications that great i
have not at this point but i don't

445
00:36:10,730 --> 00:36:13,610
imagine that it's going to be any
different

446
00:36:13,610 --> 00:36:19,130
sometimes the serialized objects might
be base64 encoded or other son some sort

447
00:36:19,130 --> 00:36:23,660
of you know cost of encoding and going
across the web across the wire

448
00:36:23,660 --> 00:36:27,680
certainly there might be a second step
involves there but the concept of the

449
00:36:27,680 --> 00:36:32,120
same underneath when that deserialized
they just do these realize the Dodgers

450
00:36:32,120 --> 00:36:38,660
right so the defense is if the
development is appropriately creating

451
00:36:38,660 --> 00:36:43,910
hierarchical class our object or right
object and putting additional method

452
00:36:43,910 --> 00:36:49,670
check in there to make sure that they're
only deserializing what they intend to

453
00:36:49,670 --> 00:36:55,880
deserialize as well as doing the normal
things with copper session and Lee and

454
00:36:55,880 --> 00:37:01,190
all the other things you might associate
with typical a web application then

455
00:37:01,190 --> 00:37:07,310
you're going to be up appropriately
defense right to help any other

456
00:37:07,310 --> 00:37:08,150
questions

457
00:37:08,150 --> 00:37:15,890
alright great so really the take home
message here just to close this out is

458
00:37:15,890 --> 00:37:22,040
if you want to be really good at
pentesting in this industry and

459
00:37:22,040 --> 00:37:28,220
defending frankly go out and learn a
programming language okay that is a big

460
00:37:28,220 --> 00:37:29,330
deal

461
00:37:29,330 --> 00:37:34,549
learn how to script powershell in the
windows world pick up any other language

462
00:37:34,550 --> 00:37:40,910
of choice either in the wind as well or
not i highly recommend python what I do

463
00:37:40,910 --> 00:37:48,830
teach python fantastic so I'm a little
bit biased ok but when the innards in

464
00:37:48,830 --> 00:37:52,430
the Windows domain world of the.net
framework and all the languages that can

465
00:37:52,430 --> 00:37:57,560
to its spend some time doing that it can
be seen shop could be Power show it can

466
00:37:57,560 --> 00:38:02,150
be a combination of see shop in Paris
show power show wrapped inside of the

467
00:38:02,150 --> 00:38:06,170
shop right there all kinds of things
that has been talks here all week that

468
00:38:06,170 --> 00:38:11,090
reference that this is how you go deeper
this is how you take things further and

469
00:38:11,090 --> 00:38:15,410
this is how you get away from
traditional methodology and get actually

470
00:38:15,410 --> 00:38:21,200
where you start to provide real value
for your customers real value in terms

471
00:38:21,200 --> 00:38:24,020
of emulating real threats

472
00:38:24,020 --> 00:38:29,450
ok that's what's gonna happen so here's
my contact information please by all

473
00:38:29,450 --> 00:38:31,609
means visit us on the web

474
00:38:31,610 --> 00:38:36,200
there's a twitter handles and we'd love
to hear from you we will absolutely

475
00:38:36,200 --> 00:38:41,960
respond to any questions or further and
thanks very much for happiness

