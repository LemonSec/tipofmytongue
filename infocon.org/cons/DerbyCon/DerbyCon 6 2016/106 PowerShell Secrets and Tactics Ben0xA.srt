1
00:00:00,000 --> 00:00:03,300
alright welcome to be kind you guys have
a good time

2
00:00:06,120 --> 00:00:09,990
awesome thank you guys so much for
coming my talk it's always great when i

3
00:00:09,990 --> 00:00:15,269
see so many people come it's always it's
it's it means a lot to me means that you

4
00:00:15,269 --> 00:00:18,720
guys appreciate a lot of the stuff that
we do but understand that

5
00:00:18,720 --> 00:00:24,150
hold on i'm going to be back there we go
that much better understand

6
00:00:24,150 --> 00:00:27,810
ok so now I'm going to say this but I'm
standing on the shoulders of giants

7
00:00:27,810 --> 00:00:35,010
which is just about everyone in my life
because I'm so short and you know but I

8
00:00:35,010 --> 00:00:39,149
jeffrey stone over and leave holes can
you to stand up real quick because I see

9
00:00:39,149 --> 00:00:42,149
you guys right there can you guys give
these guys a round of applause

10
00:00:48,660 --> 00:00:58,919
ok so without their work

11
00:00:58,920 --> 00:01:01,500
none of the stuff that I've been doing
you know the last couple years would

12
00:01:01,500 --> 00:01:05,309
actually be you know worth anything so i
have to come up with you know different

13
00:01:05,309 --> 00:01:08,910
attacks or whatever the case may be so
so I really appreciate everything that

14
00:01:08,910 --> 00:01:11,910
they've done I'm son of a

15
00:01:12,660 --> 00:01:16,830
I've got a bracelet i got a bracelet i'm
not doing

16
00:01:16,830 --> 00:01:19,830
I got a bracelet ah

17
00:01:21,000 --> 00:01:24,570
wait i'm not old enough to drink

18
00:01:24,570 --> 00:01:32,910
yeah I got that okay love you too Dave

19
00:01:32,910 --> 00:02:04,289
I quit I can't cope sep sep sep I hate
you sorta oh em I'm not getting through

20
00:02:04,290 --> 00:02:07,410
that talk if i finish that who have a
nasty

21
00:02:08,280 --> 00:02:16,260
yeah anyways a little bit about me i'm
ben ten been 0xa not been AXA 10 is not

22
00:02:16,260 --> 00:02:24,269
my age it was funny because they gave a
talk here last year and then shortly

23
00:02:24,270 --> 00:02:27,239
after Dave called me he's like hey we
want to bring on the trust sex so now

24
00:02:27,239 --> 00:02:28,290
i'm a senior

25
00:02:28,290 --> 00:02:31,290
excuse me

26
00:02:33,440 --> 00:02:39,590
hey you sorta senior security consultant

27
00:02:39,590 --> 00:02:43,790
I'm Way more professional and come on
site by the way i would try to sex so

28
00:02:43,790 --> 00:02:48,350
doing a pen testing and stuff with them
so even though I look really young I've

29
00:02:48,350 --> 00:02:51,350
been doing this for quite a while I
developer for over 20 years

30
00:02:51,860 --> 00:02:56,960
I actually did start programming when I
was 12 it wasn't last year you know so i

31
00:02:56,960 --> 00:03:00,830
actually started writing stuff I did IT
infrastructure for 13 years did you know

32
00:03:00,830 --> 00:03:04,820
defense for in a vice president for
eight and then for the last couple years

33
00:03:04,820 --> 00:03:10,700
I've been doing often side i've written
a few tools Patrick framework that's

34
00:03:10,700 --> 00:03:13,100
actually more people more and more
people i'm seeing actually are starting

35
00:03:13,100 --> 00:03:14,060
to use it

36
00:03:14,060 --> 00:03:18,830
I'm it's a defensive tool kind of like a
poor man's IDs not powershell i'm gonna

37
00:03:18,830 --> 00:03:23,930
show you guys a little about this super
fun and then invoke any creds I think

38
00:03:23,930 --> 00:03:28,160
I've shown some people that towards the
end if we have a little bit of time i'll

39
00:03:28,160 --> 00:03:31,730
show you guys that as well but before I
get any further

40
00:03:32,570 --> 00:03:43,010
jeez it's so bad i do have a special
introduction would you guys get up for

41
00:03:43,010 --> 00:03:46,010
my son Joe

42
00:03:47,780 --> 00:03:50,780
yeah

43
00:03:51,870 --> 00:03:57,989
so so I'm all about teaching right I
love teaching and so he gets really

44
00:03:57,989 --> 00:04:01,349
excited about what we do he came last
year went to the hardware hacking

45
00:04:01,349 --> 00:04:05,429
village completely torn up in there came
back and he's like yeah my hacker now

46
00:04:05,430 --> 00:04:08,909
and I'm like no you're not

47
00:04:08,909 --> 00:04:12,599
and then he's like well show me how to
do it so i use dave's unicorn and I

48
00:04:12,599 --> 00:04:16,019
should have to do it and so this is his
first shell where he not only got the

49
00:04:16,019 --> 00:04:20,608
shell he migrated to win login and then
got system with NT authority so that was

50
00:04:20,608 --> 00:04:35,760
his first shop so a lot of people say we
look alike and we use we like same

51
00:04:35,760 --> 00:04:40,139
technology we like same things but the
difference between me and dad that I'm

52
00:04:40,139 --> 00:04:43,139
supposed to be this short

53
00:04:46,449 --> 00:04:49,449
yeah

54
00:04:50,590 --> 00:05:00,549
you're grounded so anyways that's my
little guy somehow about this I so every

55
00:05:00,550 --> 00:05:04,630
year I up into this year I've been doing
a derby contest you guys anyone ever

56
00:05:04,630 --> 00:05:06,969
participate one of those where you guys
have to photoshop me into something

57
00:05:06,970 --> 00:05:11,950
crazy you know so like if you do ben10
meme you know I'm there's all sorts of

58
00:05:11,950 --> 00:05:15,760
fun things out there on but i decided
not to do that this year for two reasons

59
00:05:15,760 --> 00:05:21,219
1i you know super busy but to the
tickets went out so fast i would I felt

60
00:05:21,220 --> 00:05:25,210
bad not being able to you know to take
one of those but that doesn't mean that

61
00:05:25,210 --> 00:05:30,310
y'all haven't been messing around with
me so you know like you know here even

62
00:05:30,310 --> 00:05:36,400
14 hours ago I just I spall couplets
from recon aren't you are you old enough

63
00:05:36,400 --> 00:05:43,479
to do that here's Joe and me on our
first airplane ride how nice the

64
00:05:43,480 --> 00:05:46,480
airplane supplied you with a guardian
for your plate

65
00:05:52,930 --> 00:05:57,340
jerrika and here we come

66
00:05:57,850 --> 00:06:04,449
the guy in the striped shirt is bringing
his son awesome and it's so nice that

67
00:06:04,449 --> 00:06:10,509
today's you can fly without an adult
present safe travel kids so this next

68
00:06:10,509 --> 00:06:15,250
one is an actual perspective shot and it
was for those who are not tall you can

69
00:06:15,250 --> 00:06:20,530
understand like I go to the magazine
shop and I'm like I had actually asked

70
00:06:20,530 --> 00:06:25,690
the guy to get air space from the top
shelf for me and this was the only

71
00:06:25,690 --> 00:06:37,150
response i got so there was an issue in
my neighborhood where you know there was

72
00:06:37,150 --> 00:06:40,929
some real sketchy things going on this
car was like driving around this kid was

73
00:06:40,930 --> 00:06:44,680
middle school day the kids have been in
school like it just seemed off right and

74
00:06:44,680 --> 00:06:48,070
so like there wasn't anything bad going
on but I just wanted a police officer

75
00:06:48,070 --> 00:06:51,699
just come by see what was going on make
sure everything was okay because I mean

76
00:06:51,699 --> 00:06:57,580
it just seems odd for this kid to not be
in school so I call the police and you

77
00:06:57,580 --> 00:07:00,190
know I'm like hey cheese

78
00:07:00,190 --> 00:07:03,909
can I get an officer to come by whatever
like yeah sure so the officer pulls up

79
00:07:03,909 --> 00:07:08,469
and i'm in my running gear because i had
just gone for a run and I roll down so i

80
00:07:08,470 --> 00:07:11,500
go to walk over to tell him like the
whole situation looks amigos

81
00:07:11,500 --> 00:07:14,350
shouldn't you be in school

82
00:07:14,350 --> 00:07:20,200
so of course i post that is like I would
have thought is can I speak to your

83
00:07:20,200 --> 00:07:21,770
parents

84
00:07:21,770 --> 00:07:26,240
I mean so I got made fun of all the time
in fact we're here it really they're

85
00:07:26,240 --> 00:07:29,690
like they have it doesn't ever get old
might know it's fine I'm perfectly okay

86
00:07:29,690 --> 00:07:35,629
with it a lot of times i do act like a
kid so so anyways I I'm perfectly okay

87
00:07:35,629 --> 00:07:40,340
with you guys making fun of how older
how old they look how short I am but

88
00:07:40,340 --> 00:07:43,969
that's perfectly okay I'm big on
interaction

89
00:07:43,970 --> 00:07:47,870
ok so this is not just a keynote this is
not just for me to this talk to you and

90
00:07:47,870 --> 00:07:52,430
all for asking questions and I've got a
few extra drink tokens for non inane

91
00:07:52,430 --> 00:07:53,599
questions

92
00:07:53,599 --> 00:08:00,500
alright so the past few years we've been
talking a lot about powershell right

93
00:08:00,500 --> 00:08:03,620
in fact if you were just in here with
will by the way we'll have some awesome

94
00:08:03,620 --> 00:08:07,400
stickers so I'm gonna give away will
stickers warm for partial umpire you

95
00:08:07,400 --> 00:08:11,508
just heard about Empire you seen a lot
of the cool stuff that's come down the

96
00:08:11,509 --> 00:08:12,110
track

97
00:08:12,110 --> 00:08:16,909
Carlos Perez does a great a powershell
training there's been a lot of cool

98
00:08:16,909 --> 00:08:20,270
things matt grevers doesn't matter his
team will in his team and I know there's

99
00:08:20,270 --> 00:08:23,419
a lot more people they're doing awesome
powershell stuff and it's happening

100
00:08:23,419 --> 00:08:27,650
everywhere and a lot of technologies are
actually being very cognizant of that if

101
00:08:27,650 --> 00:08:31,068
you look at a lot of your detection
mechanisms there now flagging Empire

102
00:08:31,069 --> 00:08:36,409
there who's there you go back me bro

103
00:08:37,640 --> 00:08:41,569
the flagon Empire their flagging other
things are looking for all of this stuff

104
00:08:41,570 --> 00:08:44,120
you guys should actually start to see
that a lot of the different scenarios

105
00:08:44,120 --> 00:08:50,120
right so that's fine and that's great
but I'm gonna but part of what i'm going

106
00:08:50,120 --> 00:08:54,680
to talk about in this talk is how over
the last year as vendors have gotten

107
00:08:54,680 --> 00:08:58,459
smarter and people have come up with
defense methodologies to try and detect

108
00:08:58,459 --> 00:08:59,119
it

109
00:08:59,120 --> 00:09:01,970
I've come up with ways to get around it
and so that's part of what we're going

110
00:09:01,970 --> 00:09:04,640
to talk about today so I'm gonna start
with the one thing and I think

111
00:09:04,640 --> 00:09:11,959
unfortunately I was running security so
I didn't get to see Jefferson and leaves

112
00:09:11,959 --> 00:09:14,810
keynote but I i saw that was tweeted out
that they would talk about this a little

113
00:09:14,810 --> 00:09:16,459
bit about execution policy

114
00:09:16,459 --> 00:09:21,199
ok ok it's not a security control at all

115
00:09:22,220 --> 00:09:27,320
okay if that's what you're using to stop
powershell it's not gonna do you any

116
00:09:27,320 --> 00:09:28,279
good

117
00:09:28,279 --> 00:09:29,730
so let me show you

118
00:09:29,730 --> 00:09:40,769
so just to give an example here we'll go
ahead and run this administrator I

119
00:09:40,769 --> 00:10:02,639
always click yes no matter what the
execution policy default right

120
00:10:03,660 --> 00:10:16,529
yay so now if i do import module lets do
invoke any cards

121
00:10:16,529 --> 00:10:21,870
ok boo Oh execution running positive
just you know is disabled on the system

122
00:10:21,870 --> 00:10:24,630
hi got you no more bag

123
00:10:24,630 --> 00:10:55,050
oh yeah right okay whatever and I hit
tab that's right there and I can boom

124
00:10:55,050 --> 00:10:56,939
there you go

125
00:10:56,940 --> 00:11:00,870
obviously it's it's trying to do
something that I'm demonstrate later but

126
00:11:00,870 --> 00:11:13,710
that was so let me show you the command
again just here using

127
00:11:13,710 --> 00:11:17,880
string with file download string you
typically would put in HTTP or HTTPS

128
00:11:17,880 --> 00:11:20,880
address but file works just fine

129
00:11:22,350 --> 00:11:29,190
so if you are using execution policy as
a security control stop okay it's not

130
00:11:29,190 --> 00:11:31,980
doing you any good

131
00:11:31,980 --> 00:11:35,970
there's actually a shorter way of doing
this as well so there's other ways that

132
00:11:35,970 --> 00:11:40,200
you can actually get this now detection
obviously you're looking for IX download

133
00:11:40,200 --> 00:11:43,650
string with file colon forward slash
forward slash that's going to be a good

134
00:11:43,650 --> 00:11:48,449
indicator that someone's trying to
bypass some of those things right so but

135
00:11:48,450 --> 00:11:51,720
execution policy is not a security
control in fact

136
00:11:52,260 --> 00:11:56,760
microsoft has never said that it was a
it was to see security control i'm in

137
00:11:56,760 --> 00:12:01,710
fact they actually said that it wasn't
it wasn't designed to be that way so if

138
00:12:01,710 --> 00:12:04,350
you go to this blog and i'm not sure if
you guys talked about this get this

139
00:12:04,350 --> 00:12:09,330
morning or not but if you go to this
blog talks about it but that's the whole

140
00:12:09,330 --> 00:12:11,370
idea here right

141
00:12:11,370 --> 00:12:15,660
that's not a security control and a lot
of times what I see with a lot of with a

142
00:12:15,660 --> 00:12:20,189
lot of your defenses is you guys are
welcome all security you see one thing

143
00:12:20,190 --> 00:12:21,780
and you try and shut it down

144
00:12:21,780 --> 00:12:25,500
you see another thing and try to shut it
down and you only focus on those initial

145
00:12:25,500 --> 00:12:28,950
vectors instead of looking at the attack
from a bigger point of view because no

146
00:12:28,950 --> 00:12:33,030
matter what my vector is i still have to
do the same things that from on your

147
00:12:33,030 --> 00:12:38,010
system so relax a little bit like yes we
want to have those controls in place but

148
00:12:38,010 --> 00:12:41,640
your focus should be on those initial
vectors because every time that you shut

149
00:12:41,640 --> 00:12:46,439
something down I'm getting pissed off
and I'm gonna write something new so

150
00:12:46,440 --> 00:12:50,610
then this is this is what yalls kind of
reaction is you know when we're trying

151
00:12:50,610 --> 00:12:53,610
to do you know anything that comes to
security or whatever

152
00:12:59,379 --> 00:13:32,559
that was how you stop powershell this is
that the new full disk encryption

153
00:13:47,089 --> 00:13:49,939
yeah

154
00:13:49,939 --> 00:13:54,169
dude i have tried to take that the
screen off the laptop is taking me hours

155
00:13:54,169 --> 00:14:03,799
that woman just ripped it off this is
the best part it wasn't her laptop

156
00:14:13,139 --> 00:14:17,670
so so this next one this next one is
actually really cool because a lot of

157
00:14:17,670 --> 00:14:21,988
times like you guys think everything is
fine or I'll go to the post you know to

158
00:14:21,989 --> 00:14:25,410
a post-mortem or whatever and be like
how in the world did you get that now

159
00:14:25,410 --> 00:14:28,589
showing the attack path and this is
typically the reaction because they

160
00:14:28,589 --> 00:14:31,589
think everything is good like I got you

161
00:14:34,440 --> 00:14:37,950
everything's good

162
00:14:45,720 --> 00:14:57,330
ok it's not a security control

163
00:14:58,050 --> 00:15:03,449
ok so part of what i'm gonna show you
today is a lot of the things that you

164
00:15:03,450 --> 00:15:06,900
guys have done or that I've seen
organizations do in the middle of a pen

165
00:15:06,900 --> 00:15:11,069
test and it's it's pissed me off and
then I've had to write something new

166
00:15:11,070 --> 00:15:15,930
right and that's exactly what an
attacker is going to do if you are so

167
00:15:15,930 --> 00:15:19,530
focused on those initial vectors and you
whack them all your security they're

168
00:15:19,530 --> 00:15:22,170
just going to move someplace else

169
00:15:22,170 --> 00:15:38,430
yep you know that's a great question so
you get a token here so you're gonna

170
00:15:38,430 --> 00:15:40,439
block powershell that exe huh

171
00:15:40,440 --> 00:15:43,440
ok

172
00:15:45,939 --> 00:15:51,069
uh-huh alright let's see how that works
out for you

173
00:15:52,689 --> 00:15:59,679
alright okay sounds good let's go give
that when i try so let's come over here

174
00:15:59,679 --> 00:16:04,329
i think this requires a reboot
unfortunately it i'm gonna show you guys

175
00:16:04,329 --> 00:16:07,329
where to actually do this but I'm not
rebooted my system is under local

176
00:16:07,329 --> 00:16:13,719
security policy and it's not this you
think AppLocker is it but it's not

177
00:16:13,720 --> 00:16:18,039
unless you have Enterprise I found out
the hard way after doing a class that

178
00:16:18,039 --> 00:16:22,299
when you have a block around here it's
just so you can write the rules they

179
00:16:22,299 --> 00:16:26,889
don't enforce them so I'm like it's
there and there's even power show

180
00:16:26,889 --> 00:16:30,970
Commandments to test your rules and it
says past and I'm like yeah and then a

181
00:16:30,970 --> 00:16:33,970
powershell kept opening I'm it's
actually right here

182
00:16:34,539 --> 00:16:38,259
software restriction policies under
additional rules here you can come in

183
00:16:38,259 --> 00:16:44,259
and say new path rule go browse and will
point to you know obviously you put into

184
00:16:44,259 --> 00:16:51,129
the power show but all that being said I
decided that I was going to write

185
00:16:51,129 --> 00:17:00,699
something else so I wrote not powershell
understand you can whitelist that's fine

186
00:17:00,699 --> 00:17:09,699
whitelisting is fine i'll get there just
get there I'll get there all right I no

187
00:17:09,699 --> 00:17:10,509
good

188
00:17:10,509 --> 00:17:17,740
so this is not powershell and basically
it runs the exact same way as powershell

189
00:17:17,740 --> 00:17:22,388
does so if you're looking in your lot of
your logs and you're looking for

190
00:17:22,388 --> 00:17:24,849
powershot exe for a lot of your stuff

191
00:17:24,849 --> 00:17:28,539
yep this is what I got I was on an
engagement and I was in the middle of

192
00:17:28,539 --> 00:17:33,700
doing something now as a penetration
tester we obviously ask that like we've

193
00:17:33,700 --> 00:17:38,379
got a week right so we have a week to
get things done right so I'm i want your

194
00:17:38,379 --> 00:17:40,330
incident response plan to kick into
place

195
00:17:40,330 --> 00:17:45,070
cool fine just don't shut me down right
and I need to finish my test let me

196
00:17:45,070 --> 00:17:48,820
finish and that way you can know
everywhere else that you have to go so

197
00:17:48,820 --> 00:17:52,539
I'm in this test and all of a sudden I'm
I've got a command prompt open and I try

198
00:17:52,539 --> 00:17:56,259
and get a new one it said this app has
been blocked by your administrator I'm

199
00:17:56,259 --> 00:17:57,039
like all right

200
00:17:57,039 --> 00:17:58,129
fuck you

201
00:17:58,130 --> 00:18:02,480
so then I opened up our shell and
started doing some powershell powershell

202
00:18:02,480 --> 00:18:05,600
stuff and then 20 minutes later this app
has been blocked by your administrator

203
00:18:05,600 --> 00:18:08,600
I'm like all right it's on

204
00:18:08,600 --> 00:18:13,669
so then I grab NPS and I download it hit
whatever come back the next day and look

205
00:18:13,670 --> 00:18:18,590
how did you get access to the box there
like we found this binary called NPS it

206
00:18:18,590 --> 00:18:22,580
was written by this guy named ben 10 and
like me bro

207
00:18:25,970 --> 00:18:29,750
then work for you did it so then i got
access to their system they're like I

208
00:18:29,750 --> 00:18:32,330
hate you and like I love you too

209
00:18:32,330 --> 00:18:36,530
so NPS so if you're only looking for
power show that exe it's not gonna do

210
00:18:36,530 --> 00:18:37,490
you any good

211
00:18:37,490 --> 00:18:47,990
yep under 41 for GM mhm yeah 4104
eventid yep yep totally because it's

212
00:18:47,990 --> 00:18:52,820
actually just hooking into the
powershell library so any any of those

213
00:18:52,820 --> 00:18:55,760
types of things it will do now we're
going to go into some obfuscation things

214
00:18:55,760 --> 00:18:58,129
here in a little bit but it does still
log

215
00:18:58,130 --> 00:19:02,180
yep absolutely so you'll still catch it
but if that's what you're doing is

216
00:19:02,180 --> 00:19:07,640
trying to block powershell exe he is not
gonna work right and here's the thing

217
00:19:07,640 --> 00:19:11,180
don't go and grab NPS and you like i'm
going to write a navy signature for this

218
00:19:11,180 --> 00:19:14,930
guy because I released the full source
code anyone can just add a few lines or

219
00:19:14,930 --> 00:19:18,350
do whatever and you're back at square
zero that's whack Amole security stopped

220
00:19:18,350 --> 00:19:22,580
if how many of you guys actually thought
about blocking n PSI DX see before you

221
00:19:22,580 --> 00:19:23,720
got back

222
00:19:23,720 --> 00:19:31,070
good don't because I don't want AV
signatures that right it that's NPS sexy

223
00:19:31,070 --> 00:19:34,490
is it's it's benign it just runs
PowerShell commands and actually power

224
00:19:34,490 --> 00:19:38,870
show that exe is just a host application
it doesn't actually do the powershell

225
00:19:38,870 --> 00:19:39,800
heavy lifting

226
00:19:39,800 --> 00:19:44,300
it's just an interface between you and
the powershell right the power cells in

227
00:19:44,300 --> 00:19:49,550
the dll so blocking it doesn't quite
work so then you're like all right okay

228
00:19:49,550 --> 00:19:54,409
what about my block the ps1 fox

229
00:19:55,920 --> 00:20:00,150
right right I'm just gonna block all
those ps1 files if i see i'm going to

230
00:20:00,150 --> 00:20:01,020
delete them

231
00:20:01,020 --> 00:20:06,420
ok sounds good let's go back to my
previous example

232
00:20:07,140 --> 00:20:18,840
hold i'll make the font bigger don't
yell at me alright that's good man

233
00:20:18,840 --> 00:20:28,740
you did such an air I don't know what
the error message I just click ok ok so

234
00:20:28,740 --> 00:20:32,550
let's let's do this i'm going to create
new program

235
00:20:48,780 --> 00:20:55,740
ok and we will save this as a test at
ps1 right are loaded we'll just do this

236
00:20:55,740 --> 00:20:57,510
as test that text

237
00:20:57,510 --> 00:21:07,020
ok so if i try to import module invoke
that I say that the right spot

238
00:21:08,010 --> 00:21:23,100
yeah but they named it out test X did I
really good step for me did alright so

239
00:21:23,100 --> 00:21:30,030
if i do say go der here's my test text
right if I try and import a module test

240
00:21:30,030 --> 00:21:31,170
text

241
00:21:31,170 --> 00:21:34,170
oh it's not a valid file whatever okay

242
00:21:45,270 --> 00:21:58,530
boom

243
00:22:02,070 --> 00:22:05,070
let's think

244
00:22:11,550 --> 00:22:15,149
ok so if you're looking at ps1 files if
that's the way you're trying to stop

245
00:22:15,150 --> 00:22:17,850
things that's not gonna do you any good
either

246
00:22:17,850 --> 00:22:22,530
ok I can make this a WTF file I can make
this whatever file it doesn't make any

247
00:22:22,530 --> 00:22:23,820
difference

248
00:22:23,820 --> 00:22:26,820
ok so if you're only yep good

249
00:22:27,840 --> 00:22:36,060
what do you mean by the since what do
you mean can I do something else

250
00:22:36,690 --> 00:22:41,850
IEX invoke is it's an alias for invoke
expression and so that's all i'm doing

251
00:22:41,850 --> 00:22:45,330
is invoking the expression and creating
a new web client client object which is

252
00:22:45,330 --> 00:22:49,500
built into that net as part of dotnet
that's the way it is so if you've got

253
00:22:49,500 --> 00:22:52,710
that net basically you've got windows
seven or later or whatever like you've

254
00:22:52,710 --> 00:22:55,830
got this on there whether you like it or
not and then I just called the download

255
00:22:55,830 --> 00:22:59,490
string function and because i connect .
at a file it'll download whatever I want

256
00:22:59,490 --> 00:23:03,360
and then run it the file extension at
this point makes no difference

257
00:23:03,360 --> 00:23:06,419
you could have no file extension on this
and it'll run and it'll be just fine

258
00:23:06,420 --> 00:23:16,200
answer a question can you block this
don't know Jeff can we can be black

259
00:23:16,200 --> 00:23:21,150
invoke expression directly in powershell
yeah I didn't that

260
00:23:21,150 --> 00:23:24,780
yeah yeah you can come and grab a token
here

261
00:23:29,870 --> 00:23:35,989
ok you guys see that so blocking PS ones
doesn't really do any good

262
00:23:36,590 --> 00:23:45,080
right so we've got that so so let's talk
about powershell in some weird places

263
00:23:51,480 --> 00:24:00,510
come on I was good at it that's it
doesn't mean I don't know if I quite

264
00:24:00,510 --> 00:24:10,830
understand what that means no we've
already signed up for counseling after

265
00:24:10,830 --> 00:24:19,139
we get back right so I so a couple of
different things is you can actually put

266
00:24:19,140 --> 00:24:25,050
some power shell in some cool little
spots uh on different systems so one of

267
00:24:25,050 --> 00:24:31,770
them is in in asp file it's not really
the powershell it's calling powershell

268
00:24:31,770 --> 00:24:42,389
that exe but let's look at something
else here so let's look at this so let's

269
00:24:42,390 --> 00:24:54,060
look at some csharp code did you guys
know that you can puts that good good

270
00:24:55,559 --> 00:25:02,158
you good

271
00:25:03,539 --> 00:25:08,820
alright so did you guys are you can put
C sharp code directly in there so you

272
00:25:08,820 --> 00:25:12,509
can grab some sort of library like I
don't know and not powershell grab the

273
00:25:12,509 --> 00:25:16,440
code and put it right in here so this is
C sharp code so the way to do this is

274
00:25:16,440 --> 00:25:19,769
any type of assemblies that you're gonna
call you going to call that right here

275
00:25:19,769 --> 00:25:24,210
and then you're going to put your code
directly in here just like you would any

276
00:25:24,210 --> 00:25:27,749
type of C sharp code and so here we can
see that i'm looking into the powershell

277
00:25:27,749 --> 00:25:31,590
that create whatever command you're
getting i'm adding as a script i'm

278
00:25:31,590 --> 00:25:34,799
invoking it grabbing the output and
showing it to the screen i also added

279
00:25:34,799 --> 00:25:39,330
some base64 encode and decode function
and they're just for the fun of it then

280
00:25:39,330 --> 00:25:46,619
what you do is you check to see if your
type has been added and then if not then

281
00:25:46,619 --> 00:25:52,980
you go ahead and add it with ad type so
now if i ad type and I used basically

282
00:25:52,980 --> 00:25:57,210
and coding and decoding here which I'm
actually not going to do i'm just going

283
00:25:57,210 --> 00:26:04,320
to do this as because you guys made me
blow this up source

284
00:26:05,009 --> 00:26:08,879
I'm gonna make this a little bit smaller
there

285
00:26:08,879 --> 00:26:15,570
ok so once i do that then I can actually
call NPS c-sharp run and then get date

286
00:26:15,570 --> 00:26:20,009
so I'm its power shall within your power
show within your power show just because

287
00:26:20,009 --> 00:26:32,610
we can so i will import oh hold on my
execution policy set let's do it this

288
00:26:32,610 --> 00:26:36,990
way invoke see sure

289
00:26:37,799 --> 00:26:49,259
good vs 10 sorry i was messing around
with this yesterday

290
00:26:49,830 --> 00:27:05,340
yes it does we talked about tonight
change the right 1i got it here let's

291
00:27:05,340 --> 00:27:06,178
try this one

292
00:27:06,179 --> 00:27:10,230
let's do the what let's do though WTF
module and see if that works

293
00:27:10,230 --> 00:27:15,929
I have to close this out though so that
one key is if you use this ad type you

294
00:27:15,929 --> 00:27:18,629
actually have to close powershell to
clean everything out and let it back up

295
00:27:18,629 --> 00:27:22,350
again you can't read if you make a
change to the code it won't actually

296
00:27:22,350 --> 00:27:25,678
work

297
00:27:25,679 --> 00:27:43,679
oh there you have to run everything as
administrator

298
00:27:45,779 --> 00:27:48,779
it's just better to set your users up
that way

299
00:27:49,289 --> 00:27:55,049
let's try this again

300
00:27:58,679 --> 00:28:05,490
alright so now if I import my jewel
scripts invoke c-sharp code

301
00:28:06,119 --> 00:28:09,600
ok

302
00:28:09,600 --> 00:28:17,340
ps1 there you go so you guys can see it
ran might get date right that's all I

303
00:28:17,340 --> 00:28:22,769
did right there and to show that it
actually works i can do like right

304
00:28:22,769 --> 00:28:33,240
output right and again i have to close
any open it because i can't we add the

305
00:28:33,240 --> 00:28:34,019
same type

306
00:28:34,019 --> 00:28:39,179
it's just not the way it works so if I
go like this

307
00:28:39,809 --> 00:28:51,720
import a module C yes i have scripts
invoke c-sharp code and folksy charm

308
00:28:51,720 --> 00:28:54,269
code there we go

309
00:28:54,269 --> 00:29:00,330
oh my god the 110 I changed look I
change WTF is 10

310
00:29:01,259 --> 00:29:21,659
let's try to get as administrator module
cpss scripts and poor invoke c-sharp

311
00:29:21,659 --> 00:29:42,119
that cuz im doing the base64 encoding
that would be a good segue so we'll get

312
00:29:42,119 --> 00:29:53,668
there be kind of show up here we go

313
00:29:53,669 --> 00:30:00,000
hello Erica okay so no matter what's
going on we can we can run c-sharp good

314
00:30:00,000 --> 00:30:09,990
so let's see what this looks like in the
event log boobs right so now we've got

315
00:30:09,990 --> 00:30:15,929
two thousand events we look through here
these are 41 of fours if you haven't

316
00:30:15,929 --> 00:30:18,539
done powershell logging you should
really look into that

317
00:30:18,539 --> 00:30:25,440
let's see if we can find where r
injection . was it was too there's a ton

318
00:30:25,440 --> 00:30:28,799
of logs in here

319
00:30:28,799 --> 00:30:38,369
yeah see it's us if you're doing this
manually it's super awesome so kind of

320
00:30:38,369 --> 00:30:42,059
difficult to find but there are things
that will actually pull that up and so

321
00:30:42,059 --> 00:30:46,769
you can see all of that but so let's
talk about so we've got our C sharp code

322
00:30:46,769 --> 00:30:52,259
and you can maybe see that and see what
everything goes on but what happens if I

323
00:30:52,259 --> 00:30:55,259
do something a little bit crazier

324
00:30:55,830 --> 00:30:58,830
what happens if i go

325
00:31:04,860 --> 00:31:17,639
like this and what I do is I base64
encode my C sharp code view or grab

326
00:31:17,640 --> 00:31:20,549
where are you

327
00:31:20,549 --> 00:31:25,379
so now here's my stats my C sharp code
now everyone's going to say oh a

328
00:31:25,380 --> 00:31:31,200
powershell decodes the encoded command
well this isn't an encoded command this

329
00:31:31,200 --> 00:31:36,900
is the c-sharp code that's it's in there
so when you're looking at this and when

330
00:31:36,900 --> 00:31:42,120
you're expecting files you actually have
nothing to hook into so when you go to

331
00:31:42,120 --> 00:31:46,590
run this is still going to run because
it's going to base64 and decode that

332
00:31:46,590 --> 00:31:49,590
code but the ps1 when you load it

333
00:31:49,590 --> 00:31:54,870
it's only going to show this in the oven
4104 logs so the 4100 fallen logs have

334
00:31:54,870 --> 00:32:01,918
no idea what you're seeing sharp code
looks like none none now you can

335
00:32:01,919 --> 00:32:06,179
manually go through and decode that what
are you gonna do that in 40,000 assets

336
00:32:06,179 --> 00:32:10,020
I don't think so so that means a lot of
your tools and everything you've got

337
00:32:10,020 --> 00:32:13,350
going on right now that are inspecting
these things in the 4100 fours I load my

338
00:32:13,350 --> 00:32:18,750
C sharp code you have no clue what my C
sharp code is going to do nun

339
00:32:22,290 --> 00:32:28,740
this is another . understand at the base
level what I'm trying to communicate

340
00:32:28,740 --> 00:32:34,740
with you guys stop whack-a-mole if your
job is to try and stop the initial

341
00:32:34,740 --> 00:32:37,860
vector and you're not looking at the
bigger picture that's a problem

342
00:32:38,549 --> 00:32:42,570
I'm not saying don't take means to stop
it but understand there's always gonna

343
00:32:42,570 --> 00:32:45,659
be someone who's going to come up with
something else to bypass that you're not

344
00:32:45,660 --> 00:32:51,660
going to have that insight you guys read
Casey's blog about ms build oh you guys

345
00:32:51,660 --> 00:32:56,429
you need to google that so ms build is
actually pretty awesome its installed on

346
00:32:56,429 --> 00:33:00,510
just about every windows box if not
every windows box and you can actually

347
00:33:00,510 --> 00:33:04,379
take C sharp code time I said hi

348
00:33:05,149 --> 00:33:15,379
you can actually take C sharp code and
actually run it and it'll adrian has

349
00:33:15,379 --> 00:33:18,379
going

350
00:33:21,220 --> 00:33:24,669
boy

351
00:33:24,669 --> 00:33:29,620
so you can actually so you can I Adrian
so you can actually take C sharp code

352
00:33:29,620 --> 00:33:33,070
and put in ms build so that's something
that you'll want to look at as well

353
00:33:33,070 --> 00:33:51,549
I what I want to do next is you know
talk about antivirus right right yes no

354
00:33:51,549 --> 00:33:55,809
it's just that once you close but
everything's gone

355
00:33:55,809 --> 00:34:00,309
it's there's nothing there it's all
within this namespace that it's created

356
00:34:00,309 --> 00:34:05,530
not the name sweet but the run space so
it's all within that self-contained

357
00:34:05,530 --> 00:34:07,299
situation

358
00:34:07,299 --> 00:34:15,520
yep so I haven't looked into that it's
the question was is there any other

359
00:34:15,520 --> 00:34:19,418
opportunity for DLL injection I don't
know so i actually just wrote what I'm

360
00:34:19,418 --> 00:34:22,658
about to show you guys here in a little
bit last night my hotel room so i'm

361
00:34:22,659 --> 00:34:25,810
gonna show you guys something that I
think is actually really cool but let me

362
00:34:25,810 --> 00:34:28,179
talk about a be as well

363
00:34:28,179 --> 00:34:31,210
antivirus . it right that's awesome

364
00:34:32,500 --> 00:34:36,550
Matt greater stuff even will show
there's a lot of their stuff we're

365
00:34:36,550 --> 00:34:41,889
getting picked up Dave's stuff got
picked up and it was it was like

366
00:34:41,889 --> 00:34:49,179
powershell that exe no profile and Cody
command right this right right you know

367
00:34:49,179 --> 00:35:00,760
what he did to that bypass AV he did
this done he just changed DNC to encode

368
00:35:00,760 --> 00:35:06,130
command right so and i'm not saying
don't have a baby i'm not saying that's

369
00:35:06,130 --> 00:35:09,640
a great control but that's not the
control that you need to be focusing on

370
00:35:09,640 --> 00:35:11,740
with these types of attacks

371
00:35:11,740 --> 00:35:16,839
ok it's too easy to do the apps
obfuscation and look like you're not

372
00:35:16,839 --> 00:35:21,070
going to inspect this there's no I mean
unless you're going to hire someone to

373
00:35:21,070 --> 00:35:25,089
go through and monitor all the event
logs looking for base64 encoded stuff

374
00:35:25,089 --> 00:35:28,270
and then reverse engineering and looking
through the c-sharp code of which will

375
00:35:28,270 --> 00:35:31,480
probably be obvious cated anyways that's
going to be a problem right

376
00:35:32,170 --> 00:35:36,430
so that's not gonna do you guys that's
not going to be the focus that you guys

377
00:35:36,430 --> 00:35:39,669
need it need to need to go about because
we're gonna come up with different ways

378
00:35:39,670 --> 00:35:48,549
to bypass that so let me show you
another cool little thing so a lot of

379
00:35:48,549 --> 00:35:54,430
you guys are looking for this like this
system that reflection like if we call

380
00:35:54,430 --> 00:35:58,450
these libraries right you guys have seen
these right these are some basic

381
00:35:58,450 --> 00:36:03,640
indicators of PowerShell Empire power
supply and everything else like that so

382
00:36:03,640 --> 00:36:10,420
if you look for you know system .
convert you know to base64 string you

383
00:36:10,420 --> 00:36:16,089
know whatever you know it basically will
give you the binaries and that and so

384
00:36:16,089 --> 00:36:23,140
what you're doing isn't a lot of your
searching you're looking for you get

385
00:36:23,140 --> 00:36:33,009
okay you're looking for this right so
let me show you something cool you can

386
00:36:33,010 --> 00:36:36,010
actually do something like this

387
00:36:37,540 --> 00:36:45,130
so what you do is you build your string
system . text encoding and then you use

388
00:36:45,130 --> 00:36:51,819
type with the type name then you can
call the library which is t1 so now

389
00:36:51,819 --> 00:36:54,970
instead of me calling those libraries of
what you're looking for

390
00:36:54,970 --> 00:37:03,220
I'm calling t1 and t2 so you guys are
checking it so let me show you what this

391
00:37:03,220 --> 00:37:03,819
looks like

392
00:37:03,819 --> 00:37:12,640
I know some people taking pictures so
waiting so if I import module invoke

393
00:37:12,640 --> 00:37:16,150
type if I invoke type

394
00:37:17,230 --> 00:37:20,950
there we go and if we look at the event
log

395
00:37:30,779 --> 00:37:38,729
there's are invoked type if we look at
this this is what we're looking for so

396
00:37:38,729 --> 00:37:42,479
we loaded our code it didn't change that
it didn't change it to the actual

397
00:37:42,479 --> 00:37:45,928
library so even when you're looking at
your 10 fours it's not pulling up those

398
00:37:45,929 --> 00:37:48,959
libraries you can do the same thing with
reflection you can do the same thing

399
00:37:48,959 --> 00:37:54,239
with any . netlibrary you do the string
cast type you're not looking for those

400
00:37:54,239 --> 00:37:58,049
libraries it's gone you don't have
inside any longer

401
00:37:58,709 --> 00:38:07,319
right now I'm a defender at heart i love
being able to defend so what's my point

402
00:38:07,319 --> 00:38:08,579
right

403
00:38:08,579 --> 00:38:12,689
why am i doing all of this stuff to yet
you know further along you're weakening

404
00:38:12,689 --> 00:38:19,529
our ability to detect things the problem
is you guys are still whack Amole you

405
00:38:19,529 --> 00:38:22,829
focus out no matter what what way I get
into your system

406
00:38:22,829 --> 00:38:25,829
I'll get you in just a second no matter
how I get on your system I still have to

407
00:38:25,829 --> 00:38:31,439
do the same things I still have to pivot
i still have to get users i still have

408
00:38:31,439 --> 00:38:34,288
to inspect the traffic that's not going
to change

409
00:38:34,289 --> 00:38:37,709
you're still gonna be able to see all of
that there are other ways of blocking

410
00:38:37,709 --> 00:38:41,219
all of the or detecting a lot of the
other stuff that I'm that I'm doing

411
00:38:41,219 --> 00:38:45,839
after the effect but i see so many
people focusing on these individual

412
00:38:45,839 --> 00:38:48,719
attack vectors that they're missing the
bigger picture

413
00:38:48,719 --> 00:38:53,369
they're missing the bigger idea that the
debt if i use PowerShell to get on your

414
00:38:53,369 --> 00:38:54,089
system

415
00:38:54,089 --> 00:38:58,229
ok so what I might use outlook tomorrow
who knows

416
00:38:59,099 --> 00:39:11,039
I'm sorry who had a question back there
yeah yet so it's just blanks getting

417
00:39:11,039 --> 00:39:14,039
this

418
00:39:17,790 --> 00:39:25,710
but i didn't use encoded oh you're
saying the a B and C nc2 encoded right

419
00:39:25,710 --> 00:39:33,260
well right

420
00:39:33,260 --> 00:39:37,490
but if you look at empire so i can I do
a lot of my Empire and I don't use the

421
00:39:37,490 --> 00:39:40,640
uncoated i just use a straight function
and that's what I love about empires

422
00:39:40,640 --> 00:39:43,549
that gives me that straight function
that I can copy and paste in there now

423
00:39:43,550 --> 00:39:46,700
there are tools that are actually
picking that up and its really cool but

424
00:39:46,700 --> 00:39:50,870
again it doesn't take much to just
obvious get that that the point is I'm

425
00:39:50,870 --> 00:39:54,799
not trying to say don't try and detect
this stuff i'm trying to say change your

426
00:39:54,800 --> 00:39:59,300
defensive methodology and i'm showing
you new techniques need ideas things

427
00:39:59,300 --> 00:40:02,870
that I've been doing for the last year
that i haven't shared with anyone right

428
00:40:02,870 --> 00:40:06,470
and there might be other people that are
already doing these types of things it's

429
00:40:06,470 --> 00:40:10,430
just this is the way that I've done them
and I've got around a lot of different

430
00:40:10,430 --> 00:40:14,180
systems and it's pissed a lot of people
off but i don't like to lose

431
00:40:14,840 --> 00:40:25,460
so you can do that so I'm going to skip
ahead i just want to show you that

432
00:40:25,460 --> 00:40:34,610
picture so what I did last night i was
really excited last night I know ya go

433
00:40:34,610 --> 00:40:35,630
i'm sorry go ahead

434
00:40:35,630 --> 00:41:03,530
yep yep yep yep so his point was if I go
in using easy attacks and you know just

435
00:41:03,530 --> 00:41:07,040
start using like cut-and-paste like I'm
blasting and you're absolutely right and

436
00:41:07,040 --> 00:41:09,830
that's a great indicator problem eyes
and I'm not saying don't use those tools

437
00:41:09,830 --> 00:41:11,870
we have great vendors out there right

438
00:41:11,870 --> 00:41:14,750
I've been on some systems where y'all
have pissed me off because you keep

439
00:41:14,750 --> 00:41:19,310
shutting things down or you get detected
and I take it personally so I write new

440
00:41:19,310 --> 00:41:22,850
tools right so if you want a new tool
just pissed me off and i'll write

441
00:41:22,850 --> 00:41:26,140
something new and we'll talk about it
after become next year

442
00:41:26,140 --> 00:41:32,828
right and that's great and you might but
here's the thing if my goal is to get in

443
00:41:32,829 --> 00:41:35,049
there my goal is not to get detected

444
00:41:35,049 --> 00:41:39,099
I'm not going to go the path that you're
expecting me to go right I'm gonna go

445
00:41:39,099 --> 00:41:43,839
through and I'm gonna base64 encode my
base64 encoded stuff right and you're

446
00:41:43,839 --> 00:41:46,808
not gonna catch that on the stream
because your watch list that you've got

447
00:41:46,809 --> 00:41:50,109
four carbon black and all of your other
things you're not picking up on it

448
00:41:50,109 --> 00:41:53,109
because it's not gonna match any of your
regex queries that you've got going on

449
00:41:53,109 --> 00:41:55,930
there unless you're inspecting every
single PowerShell command that you're

450
00:41:55,930 --> 00:41:57,308
running on your system

451
00:41:57,309 --> 00:42:01,900
it's not gonna happen right and that's
the whole idea you can use the MS build

452
00:42:01,900 --> 00:42:06,339
to run the powershell code itself as
well or I can just use ms builder do a

453
00:42:06,339 --> 00:42:09,430
c-sharp code which does the next thing
i'm about to show you

454
00:42:10,000 --> 00:42:15,970
so one of my problems was on an
engagement was you know getting access

455
00:42:15,970 --> 00:42:19,598
to the machine and getting that
persistence and getting things to run so

456
00:42:19,599 --> 00:42:24,640
i got not powershell but the the point
was i didn't want anyone to know that

457
00:42:24,640 --> 00:42:32,470
not powershell was there I had to get it
to the system to run it but I didn't

458
00:42:32,470 --> 00:42:35,379
want to touch disk so here's what I did

459
00:42:35,380 --> 00:42:39,460
here's what i did last night and
literally i'm sitting in the hotel room

460
00:42:39,460 --> 00:42:43,329
after I got here i'm sitting in the
hotel room and all the Sun was oh my

461
00:42:43,329 --> 00:42:47,559
goodness and just like what Dad I'm like
oh my goodness he's like that are you

462
00:42:47,559 --> 00:42:49,960
okay let me go oh my goodness it worked

463
00:42:49,960 --> 00:42:59,109
he's like you're weird so i want to show
you something cool invoke memory not

464
00:42:59,109 --> 00:43:00,690
powershell

465
00:43:00,690 --> 00:43:09,390
I'm able to download NPS from my remote
resource and run it directly from memory

466
00:43:09,390 --> 00:43:12,390
without a touching disk

467
00:43:17,740 --> 00:43:22,750
so let me show you how this works so
this is again this is just using that C

468
00:43:22,750 --> 00:43:27,010
sharp code that i showed you earlier
again I could base64 encode this as i

469
00:43:27,010 --> 00:43:31,540
showed you earlier right so you guys are
gonna be able to see this code this is

470
00:43:31,540 --> 00:43:34,360
my payload so this is from unicorn

471
00:43:34,360 --> 00:43:40,690
okay now I'm gonna double-check my
shells I've got going on here and I will

472
00:43:40,690 --> 00:43:45,640
be putting this out on my github later
so we look at options to make sure my IP

473
00:43:45,640 --> 00:43:49,210
hasn't changed by the way that stinks
when you're trying to like doing exploit

474
00:43:49,210 --> 00:43:52,000
and your IP changes in your be that's
really annoying

475
00:43:52,000 --> 00:43:59,440
okay so I'm gonna exploit this hold on
one second okay cool so that's running

476
00:43:59,440 --> 00:44:06,520
so if this works and i'm gonna run this
not from an administrator just normal

477
00:44:06,520 --> 00:44:13,509
powershell ok and I'm going to open up
the task manager I'm gonna leave it

478
00:44:13,510 --> 00:44:18,340
running on top we're going to look and
make sure that NPS isn't on here

479
00:44:18,940 --> 00:44:25,060
ok so no NPS right you guys are with me
and PSD XD doesn't exist but i will show

480
00:44:25,060 --> 00:44:29,049
you that it's sitting right here on my
web server

481
00:44:29,050 --> 00:44:38,859
I've got Apache running so so there's my
apache server running right there

482
00:44:38,859 --> 00:44:43,000
ok you guys are all with me right you
understand so if we look at my IP here

483
00:44:43,000 --> 00:44:49,210
to 137 and in my code i'm pulling down
from hoops because it's on time sorry

484
00:44:49,210 --> 00:44:55,180
hold on i'm pulling down from here you
guys with me so that I load the binary

485
00:44:55,180 --> 00:44:56,950
oops

486
00:44:56,950 --> 00:45:00,160
oh my goodness stop it

487
00:45:00,160 --> 00:45:05,589
so I load the binary and then I inject
the payload so here's so you can look

488
00:45:05,590 --> 00:45:11,890
here's my hyphen enc which is part of NP
SDXC and then I give it the payload so

489
00:45:11,890 --> 00:45:14,890
if this works we should get a shell

490
00:45:16,300 --> 00:45:20,859
let's just do it the fun way

491
00:45:21,800 --> 00:45:44,150
ok so we're looking right here i'm gonna
put this down here you guys know you can

492
00:45:44,150 --> 00:45:48,620
turn sounds on a medically you get much
voice on there especially when it fails

493
00:45:48,620 --> 00:46:17,420
he goes dry hada let's see if this works
and our expert works and if we look no

494
00:46:17,420 --> 00:46:20,420
NP SDXC it's all a memory

495
00:46:28,270 --> 00:46:31,270
yes sir

496
00:46:38,320 --> 00:46:46,360
yes he said he might even mr. robot
attack absolutely he got that for me you

497
00:46:46,360 --> 00:46:50,140
guys see and you guys understand the
point I'm trying to tell you this is not

498
00:46:50,140 --> 00:46:54,460
be coming around saying its fuel to do
defense that is not what I'm saying at

499
00:46:54,460 --> 00:46:59,590
all in fact there's a lot of
organizations I've been to that I have

500
00:46:59,590 --> 00:47:04,300
been so frustrated because they did
defense well because they didn't care

501
00:47:04,300 --> 00:47:07,600
about my initial attack vector they
expected me to be there

502
00:47:07,600 --> 00:47:12,040
they're like yeah we know you're on the
Box it's okay keep going I'm like I'm

503
00:47:12,040 --> 00:47:21,880
not even my final form yet bro and then
they're like yeah we saw your pivot we

504
00:47:21,880 --> 00:47:25,750
saw you log into 47 different boxes
understand the attacking with that

505
00:47:25,750 --> 00:47:30,370
mentality when you understand the
attackers mentality you're not so

506
00:47:30,370 --> 00:47:33,759
focused on that initial vector you're
more concerned about what to do after it

507
00:47:33,760 --> 00:47:36,820
a lot of you guys are looking for the
right things

508
00:47:37,360 --> 00:47:41,020
some of you guys aren't don't even know
for some of the basic stuff you guys

509
00:47:41,020 --> 00:47:42,160
know about this one

510
00:47:42,160 --> 00:47:51,520
do you know that this is this is like
awesome for me to get this to anyone

511
00:47:51,520 --> 00:47:55,930
know what this does this download
everything from a system and tells me

512
00:47:55,930 --> 00:48:00,339
every kb that you have then what I do is
I use a tool called windows exploit

513
00:48:00,340 --> 00:48:06,670
suggest ER and it tells me which kb you
don't have and not only that it tells me

514
00:48:06,670 --> 00:48:12,640
if there's a Metasploit module or
exploit code available so ms 15-0 51 a

515
00:48:12,640 --> 00:48:15,400
lot of you guys haven't patched you know
what that is that's a privilege

516
00:48:15,400 --> 00:48:21,160
escalation and a lot of you guys on a
lot of systems that that's that we have

517
00:48:21,160 --> 00:48:24,670
it so when you're looking for things
understand i have to get around your

518
00:48:24,670 --> 00:48:25,420
network

519
00:48:25,420 --> 00:48:31,450
I need to know your users I need to know
what's going on so I shown us a couple

520
00:48:31,450 --> 00:48:33,970
of times but I know I don't think I've
shown it here at Derby but i want to

521
00:48:33,970 --> 00:48:39,100
show you guys real quick you got her a
responder right cool tool right I'm just

522
00:48:39,100 --> 00:48:42,069
gonna exit here quick responders are
really neat tool

523
00:48:42,070 --> 00:48:48,310
so for those who don't know responder is
basically a tool that if you do any type

524
00:48:48,310 --> 00:48:54,460
of request and it doesn't have a dns
entry it will actually respond to those

525
00:48:54,460 --> 00:48:59,620
hence the name responder it's just or
don't worry

526
00:49:03,430 --> 00:49:07,480
here we go and so exploitation responder

527
00:49:10,450 --> 00:49:30,220
oh I need to shut down patchy hold on
okay i don't care about the ssl port

528
00:49:30,220 --> 00:49:33,580
ok so basically it's just going to sit
there and respond so if i come over here

529
00:49:33,580 --> 00:49:40,270
and I type net use a snowbird at local
Lee homes

530
00:49:40,270 --> 00:49:43,390
that's his actual login ID

531
00:49:44,950 --> 00:49:58,240
let's see so you'll see that I get a
poison answer for snows in that local

532
00:49:58,240 --> 00:50:03,640
and when it does that i'm actually going
to grab at ash so you'll see that here

533
00:50:03,640 --> 00:50:13,120
in a second so you see that the command
completed successfully snowboard at

534
00:50:13,120 --> 00:50:17,589
local doesn't exist at least I don't
know unless Jeff is hacking me at the

535
00:50:17,590 --> 00:50:18,310
moment

536
00:50:18,310 --> 00:50:27,520
okay right so it's not there so so the
thing about it is is that this shows up

537
00:50:27,520 --> 00:50:32,440
and it basically shows the hash that
goes on and and obviously I have a

538
00:50:32,440 --> 00:50:38,170
previously captured captured cash for it
for some reason so what I want to do is

539
00:50:38,170 --> 00:50:43,060
I want to check to see if i have an
account here in fact let me do this

540
00:50:43,869 --> 00:50:49,420
remove responder DB and let's do it
again and that way i can actually show

541
00:50:49,420 --> 00:51:00,009
you that you can actually see here's a
hash it comes through

542
00:51:00,910 --> 00:51:03,910
don't worry you guys try and crack that
it's just password it's all good

543
00:51:04,869 --> 00:51:09,309
ok so i have to craft this I can't use
this in the past the hashtag attack i

544
00:51:09,309 --> 00:51:10,960
have to actually crack this

545
00:51:10,960 --> 00:51:16,930
so what I did is I wanted to know how i
can actually detect this because if I'm

546
00:51:16,930 --> 00:51:19,419
on your network on one of the first
thing I'm gonna do is I'm gonna see if I

547
00:51:19,420 --> 00:51:21,430
can get credentials from somebody else

548
00:51:21,430 --> 00:51:25,749
so what I did is I wrote a tool called
invoke any creds and what honey creds

549
00:51:25,749 --> 00:51:30,339
are is credentials that actually get
injected into the network and it's in a

550
00:51:30,339 --> 00:51:37,569
completely different name space so what
I do import module invoke honey threads

551
00:51:37,569 --> 00:51:45,549
so when you say invoke honey creds it
will ask you for a password

552
00:51:45,549 --> 00:51:48,880
now this is actually hooked into the
windows 7 or the windows credentialing

553
00:51:48,880 --> 00:51:53,739
system so it's not some I didn't just
pop up a box this is actually good to do

554
00:51:53,739 --> 00:51:59,710
then what you do is you create valid
looking credentials not user-based

555
00:51:59,710 --> 00:52:10,599
service-based so if i do this and if i
do lead at local SCCM updater service

556
00:52:10,599 --> 00:52:13,359
and I gave it a decent-looking password

557
00:52:13,359 --> 00:52:17,440
maybe something that actually random you
know something like a lot of our service

558
00:52:17,440 --> 00:52:18,910
accounts look like

559
00:52:18,910 --> 00:52:22,239
yes no

560
00:52:22,239 --> 00:52:25,420
ok so as we can

561
00:52:25,420 --> 00:52:32,829
see there's our SCCM service update and
then look so I do two things with any

562
00:52:32,829 --> 00:52:37,299
creds the first thing i do is i send you
the hash but then i also sent in plain

563
00:52:37,299 --> 00:52:39,910
text because if your attacker and you've
got a hash that you have to crack or you

564
00:52:39,910 --> 00:52:44,440
get plain text which one you going to
use first plaintext and with the cool

565
00:52:44,440 --> 00:52:48,099
thing about honey Craig's is this
account does not have to exist and the

566
00:52:48,099 --> 00:52:55,839
moment that responder response you get a
200 ok on this side and you know you

567
00:52:55,839 --> 00:53:00,970
have somebody using responder on your
network and the best way to check for it

568
00:53:00,970 --> 00:53:05,709
is event ID log 4648 right down

569
00:53:07,089 --> 00:53:12,160
4648 that is how you detect somebody
using the set of credentials on your

570
00:53:12,160 --> 00:53:13,000
network

571
00:53:13,000 --> 00:53:16,000
what do you think cool

572
00:53:20,490 --> 00:53:25,169
alright so I know I'm running out of
time so you guys can get a lot of the

573
00:53:25,170 --> 00:53:25,560
stuff

574
00:53:25,560 --> 00:53:30,810
minot powershell and honey creds are on
github a full open source you guys can

575
00:53:30,810 --> 00:53:34,590
do whatever you want with that Jerry
Jackson has done some great stuff on the

576
00:53:34,590 --> 00:53:38,610
defense side i encourage you use his
stuff we also you have pot check with

577
00:53:38,610 --> 00:53:42,150
matt johnson myself some really neat
tools a lot of people have contributed

578
00:53:42,150 --> 00:53:45,869
to that i'll let you guys take some
pictures

579
00:53:45,869 --> 00:53:55,110
it is also on my Twitter it's a it's
pinned up there so you guys can do that

580
00:53:55,650 --> 00:54:03,330
so in conclusion that's it I'm done

581
00:54:03,330 --> 00:54:14,009
questions yes can I use PowerShell
bypass net nanny I think that's a

582
00:54:14,010 --> 00:54:15,720
conversation for us later

583
00:54:15,720 --> 00:54:25,589
alright guys thank you very much
appreciate it and i have i have free

584
00:54:25,590 --> 00:54:27,810
stuff up here so you guys want to come
talk to me going to be some way to

