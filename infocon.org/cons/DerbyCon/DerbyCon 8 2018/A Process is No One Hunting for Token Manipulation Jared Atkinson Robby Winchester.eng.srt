1
00:00:01,159 --> 00:00:06,569
<font color="#E5E5E5">cool</font><font color="#CCCCCC"> welcome everybody</font><font color="#E5E5E5"> to our talk it's</font>

2
00:00:04,650 --> 00:00:09,240
called a<font color="#CCCCCC"> processes</font><font color="#E5E5E5"> no</font><font color="#CCCCCC"> 1</font><font color="#E5E5E5"> hunting for</font>

3
00:00:06,569 --> 00:00:10,410
token manipulation<font color="#E5E5E5"> a little nod to the</font>

4
00:00:09,240 --> 00:00:12,330
house of black<font color="#E5E5E5"> and</font><font color="#CCCCCC"> white</font><font color="#E5E5E5"> from Game of</font>

5
00:00:10,410 --> 00:00:13,650
Thrones if you're a fan there's no

6
00:00:12,330 --> 00:00:14,910
<font color="#CCCCCC">spoiler well there actually</font><font color="#E5E5E5"> may be</font>

7
00:00:13,650 --> 00:00:16,800
spoilers like this but if you haven't

8
00:00:14,910 --> 00:00:19,470
<font color="#E5E5E5">watched that season yet then you know</font>

9
00:00:16,800 --> 00:00:21,029
yep so<font color="#E5E5E5"> I'm</font><font color="#CCCCCC"> jarred Hawkinson I'm the</font>

10
00:00:19,470 --> 00:00:23,698
adversary detection technical lead

11
00:00:21,029 --> 00:00:25,529
<font color="#CCCCCC">Spectre ups</font><font color="#E5E5E5"> I'm a I do a lot of</font>

12
00:00:23,699 --> 00:00:26,970
development<font color="#CCCCCC"> probably</font><font color="#E5E5E5"> most notably for</font>

13
00:00:25,529 --> 00:00:29,490
<font color="#E5E5E5">power forensics which is a forensics</font>

14
00:00:26,970 --> 00:00:31,919
based<font color="#E5E5E5"> tool kit for PowerShell contribute</font>

15
00:00:29,490 --> 00:00:33,360
to things like<font color="#CCCCCC"> OS query</font><font color="#E5E5E5"> previously I</font>

16
00:00:31,920 --> 00:00:34,590
worked<font color="#E5E5E5"> in the US Air Force</font><font color="#CCCCCC"> that's kind</font>

17
00:00:33,360 --> 00:00:36,570
of where I got<font color="#E5E5E5"> my start on their hunt</font>

18
00:00:34,590 --> 00:00:39,570
team<font color="#E5E5E5"> and then worked for various</font><font color="#CCCCCC"> groups</font>

19
00:00:36,570 --> 00:00:41,940
<font color="#CCCCCC">adaptive throat division after that I'm</font>

20
00:00:39,570 --> 00:00:44,219
<font color="#E5E5E5">Robbie Winchester I am the adversary</font>

21
00:00:41,940 --> 00:00:45,989
detection lead<font color="#E5E5E5"> Spectre ops work with</font>

22
00:00:44,219 --> 00:00:47,910
Jared for quite a while

23
00:00:45,989 --> 00:00:50,489
co-author<font color="#CCCCCC"> of ACE with him and have also</font>

24
00:00:47,910 --> 00:00:52,169
<font color="#E5E5E5">worked on Hulk I used to be in the Air</font>

25
00:00:50,489 --> 00:00:54,930
<font color="#CCCCCC">Force as well I was mainly on the other</font>

26
00:00:52,170 --> 00:00:56,940
side doing<font color="#CCCCCC"> Red Team physical security</font>

27
00:00:54,930 --> 00:00:58,350
and<font color="#E5E5E5"> penetration testing a lot of stuff</font>

28
00:00:56,940 --> 00:01:00,870
and then<font color="#E5E5E5"> came</font><font color="#CCCCCC"> over and</font><font color="#E5E5E5"> started hunting</font>

29
00:00:58,350 --> 00:01:03,870
<font color="#E5E5E5">and I was also at various groups</font>

30
00:01:00,870 --> 00:01:06,000
adaptive<font color="#CCCCCC"> fit division as well so we're</font>

31
00:01:03,870 --> 00:01:09,090
gonna start on our<font color="#E5E5E5"> quest just like</font><font color="#CCCCCC"> our</font>

32
00:01:06,000 --> 00:01:10,740
<font color="#CCCCCC">es starting at the beginning</font><font color="#E5E5E5"> so what are</font>

33
00:01:09,090 --> 00:01:12,030
we what are<font color="#CCCCCC"> we here to talk about</font><font color="#E5E5E5"> so the</font>

34
00:01:10,740 --> 00:01:14,369
first thing a little bit of background

35
00:01:12,030 --> 00:01:16,170
so hypothesis-driven hunting there's a

36
00:01:14,369 --> 00:01:17,430
lot of people who<font color="#CCCCCC"> talk about</font><font color="#E5E5E5"> hunting</font><font color="#CCCCCC"> and</font>

37
00:01:16,170 --> 00:01:19,369
<font color="#CCCCCC">it means a</font><font color="#E5E5E5"> lot of</font><font color="#CCCCCC"> different things</font><font color="#E5E5E5"> to a</font>

38
00:01:17,430 --> 00:01:21,270
lot of<font color="#E5E5E5"> different</font><font color="#CCCCCC"> people are kind of</font>

39
00:01:19,369 --> 00:01:24,450
perspective and<font color="#CCCCCC"> what we feel like</font>

40
00:01:21,270 --> 00:01:25,830
hunting should be<font color="#E5E5E5"> is ideally you come up</font>

41
00:01:24,450 --> 00:01:28,080
with hypothesis and you search<font color="#CCCCCC"> for that</font>

42
00:01:25,830 --> 00:01:29,939
in your<font color="#E5E5E5"> environment</font><font color="#CCCCCC"> it's ideally gonna</font>

43
00:01:28,080 --> 00:01:31,110
<font color="#E5E5E5">be some type of targeted activity and</font>

44
00:01:29,939 --> 00:01:33,408
you're looking for things<font color="#CCCCCC"> that have</font>

45
00:01:31,110 --> 00:01:35,700
<font color="#CCCCCC">evaded</font><font color="#E5E5E5"> your in place defense</font><font color="#CCCCCC"> so the</font>

46
00:01:33,409 --> 00:01:37,770
benefit of having a hypothesis rather

47
00:01:35,700 --> 00:01:39,600
than looking<font color="#CCCCCC"> for bad is it's gonna focus</font>

48
00:01:37,770 --> 00:01:41,520
your data<font color="#E5E5E5"> collection effort we've had a</font>

49
00:01:39,600 --> 00:01:42,960
lot of we're consultants so we go<font color="#E5E5E5"> to</font>

50
00:01:41,520 --> 00:01:44,729
client sites we had a lot<font color="#CCCCCC"> of clients who</font>

51
00:01:42,960 --> 00:01:46,048
go and<font color="#E5E5E5"> they're like you know we open up</font>

52
00:01:44,729 --> 00:01:48,149
<font color="#CCCCCC">salon can we have a billion events what</font>

53
00:01:46,049 --> 00:01:49,860
do we do<font color="#CCCCCC"> and if you look at that as a</font>

54
00:01:48,149 --> 00:01:52,290
whole aggregate of a billion events<font color="#E5E5E5"> and</font>

55
00:01:49,860 --> 00:01:53,909
then yes it's a<font color="#CCCCCC"> huge problem to</font><font color="#E5E5E5"> solve</font><font color="#CCCCCC"> if</font>

56
00:01:52,290 --> 00:01:55,110
you<font color="#E5E5E5"> break that down into you're looking</font>

57
00:01:53,909 --> 00:01:57,509
for a specific<font color="#CCCCCC"> thing and</font><font color="#E5E5E5"> you have a</font>

58
00:01:55,110 --> 00:01:59,430
<font color="#E5E5E5">specific purpose and you understand what</font>

59
00:01:57,509 --> 00:02:00,719
should be there and<font color="#E5E5E5"> what shouldn't it's</font>

60
00:01:59,430 --> 00:02:02,520
gonna make it<font color="#CCCCCC"> a lot</font><font color="#E5E5E5"> just can make</font><font color="#CCCCCC"> that a</font>

61
00:02:00,719 --> 00:02:04,710
million<font color="#CCCCCC"> events</font><font color="#E5E5E5"> maybe a hundred and 100</font>

62
00:02:02,520 --> 00:02:07,649
is a lot easier<font color="#CCCCCC"> to solve</font><font color="#E5E5E5"> and then a</font>

63
00:02:04,710 --> 00:02:11,579
<font color="#E5E5E5">million and it that's that analysis</font>

64
00:02:07,649 --> 00:02:12,940
<font color="#E5E5E5">paralysis that you you often see so what</font>

65
00:02:11,580 --> 00:02:14,680
are we<font color="#CCCCCC"> looking for when you're</font><font color="#E5E5E5"> bill</font>

66
00:02:12,940 --> 00:02:18,940
<font color="#E5E5E5">hypothesis so has everyone seen the</font>

67
00:02:14,680 --> 00:02:21,130
Pyramid of pain<font color="#CCCCCC"> so most</font><font color="#E5E5E5"> of the security</font>

68
00:02:18,940 --> 00:02:23,200
toolings that are in place<font color="#E5E5E5"> that</font><font color="#CCCCCC"> you have</font>

69
00:02:21,130 --> 00:02:25,299
an environment like<font color="#E5E5E5"> antivirus proxies</font>

70
00:02:23,200 --> 00:02:26,709
etc<font color="#CCCCCC"> they're typically</font><font color="#E5E5E5"> going to be</font>

71
00:02:25,300 --> 00:02:28,630
functioning kind<font color="#E5E5E5"> of at</font><font color="#CCCCCC"> that lower level</font>

72
00:02:26,710 --> 00:02:30,850
<font color="#CCCCCC">so they're gonna be taking care of the</font>

73
00:02:28,630 --> 00:02:33,670
<font color="#E5E5E5">the hash values looking at tools that</font>

74
00:02:30,850 --> 00:02:35,500
are known bad hashes IP addresses<font color="#CCCCCC"> of</font>

75
00:02:33,670 --> 00:02:38,140
things that have done malicious things

76
00:02:35,500 --> 00:02:41,530
in the past domain names<font color="#CCCCCC"> as you go up</font><font color="#E5E5E5"> it</font>

77
00:02:38,140 --> 00:02:43,899
gets<font color="#E5E5E5"> a little bit harder to to detect</font>

78
00:02:41,530 --> 00:02:45,370
<font color="#E5E5E5">but it's also harder to change</font><font color="#CCCCCC"> so how</font>

79
00:02:43,900 --> 00:02:48,670
difficult<font color="#CCCCCC"> is it for someone to recompile</font>

80
00:02:45,370 --> 00:02:50,860
<font color="#E5E5E5">a binary with a different hash pretty</font>

81
00:02:48,670 --> 00:02:53,019
easy<font color="#E5E5E5"> how difficult is it for someone to</font>

82
00:02:50,860 --> 00:02:55,870
<font color="#E5E5E5">change the actual mechanism in which</font>

83
00:02:53,020 --> 00:02:59,140
<font color="#CCCCCC">meanie Katz</font><font color="#E5E5E5"> is able to obtain</font>

84
00:02:55,870 --> 00:03:00,880
<font color="#E5E5E5">credentials from</font><font color="#CCCCCC"> Hell</font><font color="#E5E5E5"> SAS that's pretty</font>

85
00:02:59,140 --> 00:03:02,649
tough because<font color="#E5E5E5"> that's kind of fundamental</font>

86
00:03:00,880 --> 00:03:05,109
to it so I can write my<font color="#CCCCCC"> own Mimi</font><font color="#E5E5E5"> Katz</font>

87
00:03:02,650 --> 00:03:08,080
<font color="#E5E5E5">that's easy but the actual TTP that</font>

88
00:03:05,110 --> 00:03:12,430
<font color="#E5E5E5">technique</font><font color="#CCCCCC"> that's what that's where we</font>

89
00:03:08,080 --> 00:03:13,300
want to<font color="#CCCCCC"> be focusing</font><font color="#E5E5E5"> so I say techniques</font>

90
00:03:12,430 --> 00:03:16,750
<font color="#E5E5E5">what are they</font>

91
00:03:13,300 --> 00:03:19,060
we're former military for<font color="#E5E5E5"> us TTP's it</font>

92
00:03:16,750 --> 00:03:21,010
means a<font color="#E5E5E5"> very specific thing</font><font color="#CCCCCC"> so</font>

93
00:03:19,060 --> 00:03:22,840
throughout<font color="#E5E5E5"> the course of this or</font><font color="#CCCCCC"> any</font>

94
00:03:21,010 --> 00:03:24,130
<font color="#E5E5E5">time hopefully</font><font color="#CCCCCC"> you hear anyone</font><font color="#E5E5E5"> from</font>

95
00:03:22,840 --> 00:03:26,050
spectra ops<font color="#E5E5E5"> talking they should use</font><font color="#CCCCCC"> it</font>

96
00:03:24,130 --> 00:03:28,000
this way<font color="#CCCCCC"> so tactics techniques and</font>

97
00:03:26,050 --> 00:03:29,560
procedures<font color="#E5E5E5"> they mean specific things so</font>

98
00:03:28,000 --> 00:03:33,220
this<font color="#E5E5E5"> is</font><font color="#CCCCCC"> out of DoD like joint</font>

99
00:03:29,560 --> 00:03:35,920
publication applied<font color="#E5E5E5"> to cyber as well</font><font color="#CCCCCC"> so</font>

100
00:03:33,220 --> 00:03:37,930
a tactic is the highest level that's<font color="#E5E5E5"> the</font>

101
00:03:35,920 --> 00:03:39,250
<font color="#E5E5E5">big big group so</font><font color="#CCCCCC"> that's</font><font color="#E5E5E5"> the employment</font>

102
00:03:37,930 --> 00:03:41,470
and ordered arrangement of<font color="#CCCCCC"> Forces</font>

103
00:03:39,250 --> 00:03:44,019
relative in relation<font color="#CCCCCC"> to</font><font color="#E5E5E5"> each other so</font>

104
00:03:41,470 --> 00:03:45,459
like to use an analogy of<font color="#E5E5E5"> car ownership</font>

105
00:03:44,019 --> 00:03:47,380
you want to take care<font color="#E5E5E5"> of your car</font><font color="#CCCCCC"> a</font>

106
00:03:45,459 --> 00:03:48,850
tactic of<font color="#E5E5E5"> collar ownership would be</font>

107
00:03:47,380 --> 00:03:50,709
<font color="#CCCCCC">preventive maintenance it's a huge</font>

108
00:03:48,850 --> 00:03:52,620
<font color="#E5E5E5">category it covers a lot</font><font color="#CCCCCC"> of stuff but</font>

109
00:03:50,709 --> 00:03:55,180
it's kind of like<font color="#E5E5E5"> one specific focus</font>

110
00:03:52,620 --> 00:03:58,180
then you have techniques<font color="#CCCCCC"> and</font><font color="#E5E5E5"> that's the</font>

111
00:03:55,180 --> 00:04:00,160
non-prescriptive<font color="#E5E5E5"> methods or</font><font color="#CCCCCC"> ways to</font>

112
00:03:58,180 --> 00:04:01,989
perform<font color="#CCCCCC"> a mission or</font><font color="#E5E5E5"> task so in the case</font>

113
00:04:00,160 --> 00:04:04,480
of<font color="#CCCCCC"> preventative maintenance that would</font>

114
00:04:01,989 --> 00:04:07,209
be changing<font color="#CCCCCC"> your oil it's a specific</font>

115
00:04:04,480 --> 00:04:09,220
<font color="#E5E5E5">task that has other things underneath it</font>

116
00:04:07,209 --> 00:04:10,989
<font color="#E5E5E5">but it's like one specific area there's</font>

117
00:04:09,220 --> 00:04:12,250
also other things<font color="#E5E5E5"> that you would do</font><font color="#CCCCCC"> that</font>

118
00:04:10,989 --> 00:04:12,610
would<font color="#E5E5E5"> be underneath that preventive</font>

119
00:04:12,250 --> 00:04:15,250
maintenance

120
00:04:12,610 --> 00:04:16,739
tactic<font color="#E5E5E5"> but that's the technique and then</font>

121
00:04:15,250 --> 00:04:19,089
finally are the procedures<font color="#CCCCCC"> and</font>

122
00:04:16,738 --> 00:04:21,519
procedures is where a lot<font color="#CCCCCC"> of times we</font>

123
00:04:19,089 --> 00:04:23,169
see<font color="#CCCCCC"> people</font><font color="#E5E5E5"> like targeting that's those</font>

124
00:04:21,519 --> 00:04:25,630
hashes<font color="#CCCCCC"> and IP addresses so that's the</font>

125
00:04:23,169 --> 00:04:26,889
very specific<font color="#E5E5E5"> standard detailed steps on</font>

126
00:04:25,630 --> 00:04:29,080
how<font color="#E5E5E5"> to do it</font><font color="#CCCCCC"> so like</font>

127
00:04:26,889 --> 00:04:30,550
this is the oil<font color="#E5E5E5"> that you should use this</font>

128
00:04:29,080 --> 00:04:34,030
is the filter<font color="#CCCCCC"> you should use this</font><font color="#E5E5E5"> is how</font>

129
00:04:30,550 --> 00:04:35,919
<font color="#E5E5E5">often</font><font color="#CCCCCC"> so as as you go down</font><font color="#E5E5E5"> you get more</font>

130
00:04:34,030 --> 00:04:37,599
<font color="#E5E5E5">specific but it's also going to be more</font>

131
00:04:35,919 --> 00:04:39,310
varied and<font color="#CCCCCC"> so</font><font color="#E5E5E5"> that's where when you're</font>

132
00:04:37,599 --> 00:04:40,599
building<font color="#E5E5E5"> these hunt hypotheses ideally</font>

133
00:04:39,310 --> 00:04:42,039
you want<font color="#E5E5E5"> to focus at</font><font color="#CCCCCC"> that</font><font color="#E5E5E5"> technique</font>

134
00:04:40,599 --> 00:04:44,620
level and that's<font color="#E5E5E5"> we're going to talk</font>

135
00:04:42,039 --> 00:04:47,050
<font color="#E5E5E5">about with our case study</font><font color="#CCCCCC"> so how does</font>

136
00:04:44,620 --> 00:04:48,539
this apply<font color="#E5E5E5"> has everyone in here heard of</font>

137
00:04:47,050 --> 00:04:50,949
<font color="#E5E5E5">mitre attack</font>

138
00:04:48,539 --> 00:04:53,949
hopefully<font color="#E5E5E5"> okay awesome</font><font color="#CCCCCC"> so to</font><font color="#E5E5E5"> kind of</font>

139
00:04:50,949 --> 00:04:55,509
break it<font color="#CCCCCC"> down mitre attack is built</font><font color="#E5E5E5"> out</font>

140
00:04:53,949 --> 00:04:57,580
as tactics techniques and procedures

141
00:04:55,509 --> 00:05:00,099
already<font color="#E5E5E5"> if</font><font color="#CCCCCC"> you did not know that</font>

142
00:04:57,580 --> 00:05:02,229
so the tactics essentially are that that

143
00:05:00,099 --> 00:05:05,050
top column each of those<font color="#E5E5E5"> categories</font><font color="#CCCCCC"> is a</font>

144
00:05:02,229 --> 00:05:09,219
tactic that can<font color="#CCCCCC"> be used</font><font color="#E5E5E5"> each of the</font>

145
00:05:05,050 --> 00:05:10,240
actual entries is a technique that<font color="#CCCCCC"> would</font>

146
00:05:09,219 --> 00:05:12,099
be implemented<font color="#E5E5E5"> so as you're building</font>

147
00:05:10,240 --> 00:05:13,509
hypotheses the techniques<font color="#E5E5E5"> or where</font>

148
00:05:12,099 --> 00:05:15,520
you're gonna<font color="#E5E5E5"> be wanting</font><font color="#CCCCCC"> to focus</font><font color="#E5E5E5"> and</font>

149
00:05:13,509 --> 00:05:16,719
then finally when you actually<font color="#CCCCCC"> kind of</font>

150
00:05:15,520 --> 00:05:18,520
click<font color="#CCCCCC"> and zoom in you'll</font><font color="#E5E5E5"> get to the</font>

151
00:05:16,719 --> 00:05:21,009
procedures which is that detail it's

152
00:05:18,520 --> 00:05:23,620
gonna say you know<font color="#CCCCCC"> apt 29 did this with</font>

153
00:05:21,009 --> 00:05:25,210
this tool<font color="#CCCCCC"> this command was run these</font>

154
00:05:23,620 --> 00:05:27,310
accounts were added like all of those

155
00:05:25,210 --> 00:05:29,830
types of things<font color="#CCCCCC"> if that</font><font color="#E5E5E5"> tactic technique</font>

156
00:05:27,310 --> 00:05:33,069
and procedures break down<font color="#CCCCCC"> so we want to</font>

157
00:05:29,830 --> 00:05:35,080
<font color="#E5E5E5">focus on that technique now that</font><font color="#CCCCCC"> we got</font>

158
00:05:33,069 --> 00:05:37,599
<font color="#CCCCCC">the background let's talk through</font><font color="#E5E5E5"> our</font>

159
00:05:35,080 --> 00:05:40,479
hunt hypothesis that we were gonna go

160
00:05:37,599 --> 00:05:43,029
<font color="#E5E5E5">through here so what's our process we</font>

161
00:05:40,479 --> 00:05:45,520
talked<font color="#CCCCCC"> about this in a lot of depth</font><font color="#E5E5E5"> last</font>

162
00:05:43,029 --> 00:05:46,719
year at our<font color="#E5E5E5"> Derby con talk but we're</font>

163
00:05:45,520 --> 00:05:48,310
just<font color="#E5E5E5"> gonna cover it now and then go</font>

164
00:05:46,719 --> 00:05:51,250
through a practical<font color="#E5E5E5"> implementation</font><font color="#CCCCCC"> of</font>

165
00:05:48,310 --> 00:05:53,529
<font color="#E5E5E5">that so we found it's really hard a lot</font>

166
00:05:51,250 --> 00:05:55,149
<font color="#E5E5E5">of</font><font color="#CCCCCC"> times</font><font color="#E5E5E5"> to actually create a hypothesis</font>

167
00:05:53,529 --> 00:05:57,039
people say hypothesis<font color="#CCCCCC"> driven</font><font color="#E5E5E5"> hunting but</font>

168
00:05:55,149 --> 00:05:58,599
then what do<font color="#E5E5E5"> you make a hypothesis of</font>

169
00:05:57,039 --> 00:06:00,849
and how are you consistent and how do

170
00:05:58,599 --> 00:06:03,069
you<font color="#E5E5E5"> track that</font><font color="#CCCCCC"> so we kind</font><font color="#E5E5E5"> of break it</font>

171
00:06:00,849 --> 00:06:04,300
<font color="#CCCCCC">down into these five steps</font><font color="#E5E5E5"> so identify</font>

172
00:06:03,069 --> 00:06:06,129
the tactic and technique you want<font color="#CCCCCC"> to</font>

173
00:06:04,300 --> 00:06:07,599
focus on identify the procedures

174
00:06:06,129 --> 00:06:09,550
identify<font color="#CCCCCC"> what the collection</font>

175
00:06:07,599 --> 00:06:12,069
<font color="#CCCCCC">requirements are in</font><font color="#E5E5E5"> order to detect that</font>

176
00:06:09,550 --> 00:06:14,229
behavior<font color="#E5E5E5"> and then identify the scope and</font>

177
00:06:12,069 --> 00:06:15,839
finally identify the excluded factors

178
00:06:14,229 --> 00:06:18,370
which is what stuff did<font color="#CCCCCC"> you knowingly</font>

179
00:06:15,839 --> 00:06:20,680
<font color="#E5E5E5">ignore because you're trying to solve a</font>

180
00:06:18,370 --> 00:06:22,509
<font color="#CCCCCC">problem so</font><font color="#E5E5E5"> the goal</font><font color="#CCCCCC"> here is you make a</font>

181
00:06:20,680 --> 00:06:24,939
hypothesis targeted for a<font color="#CCCCCC"> one-week</font>

182
00:06:22,509 --> 00:06:27,250
execution window and you solve<font color="#CCCCCC"> that</font>

183
00:06:24,939 --> 00:06:29,050
small problem<font color="#E5E5E5"> and it's your environment</font>

184
00:06:27,250 --> 00:06:30,939
you're there so iteratively over<font color="#E5E5E5"> time</font>

185
00:06:29,050 --> 00:06:32,889
you're<font color="#E5E5E5"> gonna slowly knock out some of</font>

186
00:06:30,939 --> 00:06:35,139
those techniques<font color="#E5E5E5"> knock out those</font>

187
00:06:32,889 --> 00:06:36,940
techniques<font color="#E5E5E5"> and that's going to allow</font>

188
00:06:35,139 --> 00:06:39,740
your your environment<font color="#E5E5E5"> to get more robust</font>

189
00:06:36,940 --> 00:06:41,210
<font color="#CCCCCC">on the alternative if</font><font color="#E5E5E5"> you</font>

190
00:06:39,740 --> 00:06:42,410
just try<font color="#E5E5E5"> and solve random problems like</font>

191
00:06:41,210 --> 00:06:43,849
you<font color="#E5E5E5"> don't have an approach you're kind</font>

192
00:06:42,410 --> 00:06:45,259
<font color="#E5E5E5">of letting the adversary dictate what</font>

193
00:06:43,849 --> 00:06:48,530
you're doing and you're<font color="#E5E5E5"> going from</font>

194
00:06:45,259 --> 00:06:49,610
report to threat<font color="#E5E5E5"> report so now we're</font>

195
00:06:48,530 --> 00:06:51,318
gonna actually get into the<font color="#CCCCCC"> meat of</font><font color="#E5E5E5"> it</font>

196
00:06:49,610 --> 00:06:54,949
so<font color="#E5E5E5"> this</font><font color="#CCCCCC"> is our case study of detecting</font>

197
00:06:51,319 --> 00:06:57,080
access token manipulation<font color="#E5E5E5"> this the</font>

198
00:06:54,949 --> 00:06:58,520
scenario situations that I'm sure no one

199
00:06:57,080 --> 00:07:00,440
can relate<font color="#E5E5E5"> to you have a small security</font>

200
00:06:58,520 --> 00:07:02,508
<font color="#CCCCCC">budget</font><font color="#E5E5E5"> you don't</font><font color="#CCCCCC"> have any</font><font color="#E5E5E5"> EDR because</font>

201
00:07:00,440 --> 00:07:04,940
that cost money<font color="#E5E5E5"> you have basically no</font>

202
00:07:02,509 --> 00:07:06,380
lateral<font color="#E5E5E5"> network visibility</font><font color="#CCCCCC"> and people</font>

203
00:07:04,940 --> 00:07:09,520
have to install their own<font color="#E5E5E5"> printers so</font>

204
00:07:06,380 --> 00:07:12,919
everyone's a local admin<font color="#E5E5E5"> because why not</font>

205
00:07:09,520 --> 00:07:14,120
<font color="#CCCCCC">so your CSO went to DEFCON and saw this</font>

206
00:07:12,919 --> 00:07:15,770
<font color="#E5E5E5">building</font><font color="#CCCCCC"> an empire with</font><font color="#E5E5E5"> PowerShell</font>

207
00:07:14,120 --> 00:07:18,110
<font color="#CCCCCC">talked and they come home and they say</font>

208
00:07:15,770 --> 00:07:19,609
can<font color="#E5E5E5"> we detect PowerShell can you detect</font>

209
00:07:18,110 --> 00:07:22,819
PowerShell Empire like we want<font color="#E5E5E5"> to detect</font>

210
00:07:19,610 --> 00:07:24,169
<font color="#E5E5E5">this</font><font color="#CCCCCC"> so our task is you know can we</font>

211
00:07:22,819 --> 00:07:26,900
<font color="#E5E5E5">detect it can we stop</font><font color="#CCCCCC"> at</font><font color="#E5E5E5"> have we been</font>

212
00:07:24,169 --> 00:07:29,150
affected by<font color="#E5E5E5"> it but really when we get</font>

213
00:07:26,900 --> 00:07:30,650
down to it<font color="#E5E5E5"> it that we're not wanting to</font>

214
00:07:29,150 --> 00:07:33,409
<font color="#E5E5E5">just detect PowerShell Empire right</font>

215
00:07:30,650 --> 00:07:35,568
we're wanting to detect that entire

216
00:07:33,409 --> 00:07:37,940
family of<font color="#E5E5E5"> things so if someone goes</font><font color="#CCCCCC"> and</font>

217
00:07:35,569 --> 00:07:40,130
<font color="#E5E5E5">makes a new tool set our</font><font color="#CCCCCC"> detections are</font>

218
00:07:37,940 --> 00:07:44,150
able to<font color="#E5E5E5"> translate</font><font color="#CCCCCC"> across multiple</font>

219
00:07:40,130 --> 00:07:45,620
different<font color="#E5E5E5"> tools</font><font color="#CCCCCC"> so high</font><font color="#E5E5E5"> level again the</font>

220
00:07:44,150 --> 00:07:48,169
first<font color="#E5E5E5"> step</font><font color="#CCCCCC"> tactic into think what</font><font color="#E5E5E5"> are we</font>

221
00:07:45,620 --> 00:07:49,460
going<font color="#CCCCCC"> to</font><font color="#E5E5E5"> look for</font><font color="#CCCCCC"> Empire uses</font><font color="#E5E5E5"> a ton</font><font color="#CCCCCC"> of</font>

222
00:07:48,169 --> 00:07:52,130
tactics and<font color="#CCCCCC"> techniques it's a full</font>

223
00:07:49,460 --> 00:07:53,840
feature<font color="#E5E5E5"> remote access tool so in this</font>

224
00:07:52,130 --> 00:07:55,580
situation rather than<font color="#E5E5E5"> trying</font><font color="#CCCCCC"> to focus on</font>

225
00:07:53,840 --> 00:07:57,650
<font color="#E5E5E5">everything and probably getting nothing</font>

226
00:07:55,580 --> 00:07:59,780
<font color="#E5E5E5">we're gonna focus on one specific thing</font>

227
00:07:57,650 --> 00:08:01,429
<font color="#E5E5E5">so Empire used for all of these</font>

228
00:07:59,780 --> 00:08:02,989
<font color="#E5E5E5">different things privilege escalation</font>

229
00:08:01,430 --> 00:08:05,060
defense evasion credential access

230
00:08:02,990 --> 00:08:07,280
lateral movement<font color="#CCCCCC"> we happen to be doing</font>

231
00:08:05,060 --> 00:08:08,990
some<font color="#CCCCCC"> research into</font><font color="#E5E5E5"> the privilege</font>

232
00:08:07,280 --> 00:08:10,280
escalation access token manipulation so

233
00:08:08,990 --> 00:08:13,310
that's the<font color="#E5E5E5"> only thing we're gonna focus</font>

234
00:08:10,280 --> 00:08:15,500
on here is<font color="#E5E5E5"> the</font><font color="#CCCCCC"> tactic</font><font color="#E5E5E5"> of privilege</font>

235
00:08:13,310 --> 00:08:17,539
escalation and the technique of access

236
00:08:15,500 --> 00:08:19,190
token manipulation<font color="#CCCCCC"> that's not to</font><font color="#E5E5E5"> say</font>

237
00:08:17,539 --> 00:08:21,289
that<font color="#CCCCCC"> it's</font><font color="#E5E5E5"> not valuable</font><font color="#CCCCCC"> other</font><font color="#E5E5E5"> hunts to</font>

238
00:08:19,190 --> 00:08:22,729
happen but this<font color="#CCCCCC"> is this</font><font color="#E5E5E5"> is what we're</font>

239
00:08:21,289 --> 00:08:24,169
gonna<font color="#E5E5E5"> focus on so that we can solve this</font>

240
00:08:22,729 --> 00:08:28,280
problem<font color="#E5E5E5"> we'll deal</font><font color="#CCCCCC"> with all that</font><font color="#E5E5E5"> other</font>

241
00:08:24,169 --> 00:08:33,789
<font color="#E5E5E5">stuff</font><font color="#CCCCCC"> and another time</font><font color="#E5E5E5"> who is run</font><font color="#CCCCCC"> git</font>

242
00:08:28,280 --> 00:08:37,098
system in<font color="#CCCCCC"> Metasploit anyone okay</font><font color="#E5E5E5"> so</font>

243
00:08:33,789 --> 00:08:38,270
that's<font color="#CCCCCC"> actually access token</font>

244
00:08:37,099 --> 00:08:39,919
manipulation that's<font color="#E5E5E5"> going to be that</font>

245
00:08:38,270 --> 00:08:41,208
token impersonation where you're<font color="#E5E5E5"> using</font>

246
00:08:39,919 --> 00:08:43,429
this<font color="#E5E5E5"> year impersonating the system token</font>

247
00:08:41,208 --> 00:08:45,589
doing token theft<font color="#CCCCCC"> so that's what we're</font>

248
00:08:43,429 --> 00:08:48,650
looking<font color="#CCCCCC"> for</font><font color="#E5E5E5"> that's built into tons of</font>

249
00:08:45,589 --> 00:08:50,570
<font color="#CCCCCC">security tools</font><font color="#E5E5E5"> so what are the</font>

250
00:08:48,650 --> 00:08:52,939
<font color="#E5E5E5">procedures</font><font color="#CCCCCC"> this</font><font color="#E5E5E5"> is that those specific</font>

251
00:08:50,570 --> 00:08:53,570
<font color="#CCCCCC">examples</font><font color="#E5E5E5"> right we talked</font><font color="#CCCCCC"> about how it's</font>

252
00:08:52,940 --> 00:08:54,680
used<font color="#E5E5E5"> so</font>

253
00:08:53,570 --> 00:08:56,930
this is where we're gonna want<font color="#E5E5E5"> to go and</font>

254
00:08:54,680 --> 00:08:58,939
do the research<font color="#E5E5E5"> go and find what are the</font>

255
00:08:56,930 --> 00:09:02,270
different<font color="#CCCCCC"> mechanisms how our access</font>

256
00:08:58,940 --> 00:09:04,970
tokens being manipulated<font color="#CCCCCC"> by different by</font>

257
00:09:02,270 --> 00:09:06,020
<font color="#E5E5E5">different tools</font><font color="#CCCCCC"> to kind of understand</font>

258
00:09:04,970 --> 00:09:07,820
<font color="#CCCCCC">that we have to go</font><font color="#E5E5E5"> through and</font>

259
00:09:06,020 --> 00:09:10,069
understand<font color="#E5E5E5"> Windows authentication</font><font color="#CCCCCC"> so</font>

260
00:09:07,820 --> 00:09:11,590
when you log in there's more than<font color="#E5E5E5"> just</font>

261
00:09:10,070 --> 00:09:13,400
you put<font color="#E5E5E5"> in credentials and then</font>

262
00:09:11,590 --> 00:09:16,100
something happens and<font color="#E5E5E5"> you get an access</font>

263
00:09:13,400 --> 00:09:17,600
<font color="#CCCCCC">token so essentially the process is once</font>

264
00:09:16,100 --> 00:09:19,730
you<font color="#E5E5E5"> log in you provide your credentials</font>

265
00:09:17,600 --> 00:09:21,530
<font color="#E5E5E5">and then</font><font color="#CCCCCC"> windows is going to create</font><font color="#E5E5E5"> a</font>

266
00:09:19,730 --> 00:09:24,170
logon session<font color="#E5E5E5"> once you've completed that</font>

267
00:09:21,530 --> 00:09:26,270
<font color="#E5E5E5">authentication and then the credentials</font>

268
00:09:24,170 --> 00:09:29,000
can<font color="#E5E5E5"> be reused later like that can be</font>

269
00:09:26,270 --> 00:09:30,680
ntlm<font color="#CCCCCC"> hash Kerberos tickets passwords</font>

270
00:09:29,000 --> 00:09:32,570
whatever but it's<font color="#E5E5E5"> gonna create a logon</font>

271
00:09:30,680 --> 00:09:33,920
session now that<font color="#E5E5E5"> one session is gonna be</font>

272
00:09:32,570 --> 00:09:35,330
what's<font color="#E5E5E5"> gonna</font><font color="#CCCCCC"> allow for you</font><font color="#E5E5E5"> to not have</font>

273
00:09:33,920 --> 00:09:38,510
<font color="#CCCCCC">to put in</font><font color="#E5E5E5"> your</font><font color="#CCCCCC"> password every</font><font color="#E5E5E5"> single</font>

274
00:09:35,330 --> 00:09:39,740
time<font color="#E5E5E5"> access tokens are to the kernel</font>

275
00:09:38,510 --> 00:09:41,780
objects that are associated<font color="#E5E5E5"> with</font>

276
00:09:39,740 --> 00:09:43,460
processing<font color="#E5E5E5"> threads that</font><font color="#CCCCCC"> are derived from</font>

277
00:09:41,780 --> 00:09:45,740
<font color="#E5E5E5">your logon session so that's gonna let</font><font color="#CCCCCC"> a</font>

278
00:09:43,460 --> 00:09:48,650
process or thread know what level it

279
00:09:45,740 --> 00:09:51,650
needs<font color="#E5E5E5"> to</font><font color="#CCCCCC"> execute at for logon session</font>

280
00:09:48,650 --> 00:09:53,480
types there's really two that matter not

281
00:09:51,650 --> 00:09:56,120
<font color="#E5E5E5">network and non network so the network</font>

282
00:09:53,480 --> 00:09:57,710
logon types like<font color="#E5E5E5"> WM I win RM if you've</font>

283
00:09:56,120 --> 00:09:59,180
heard talk about<font color="#E5E5E5"> like exposing current</font>

284
00:09:57,710 --> 00:10:02,540
shalls'<font color="#E5E5E5"> they do not load you remember</font>

285
00:09:59,180 --> 00:10:05,870
your credentials into else ass

286
00:10:02,540 --> 00:10:08,569
<font color="#E5E5E5">they're all in</font><font color="#CCCCCC"> I talk</font><font color="#E5E5E5"> to my hands a lot</font>

287
00:10:05,870 --> 00:10:11,060
<font color="#E5E5E5">I have to like hold them they talk or</font>

288
00:10:08,570 --> 00:10:12,080
they<font color="#E5E5E5"> they're in memory or they're not in</font>

289
00:10:11,060 --> 00:10:14,000
memory<font color="#E5E5E5"> so you don't have to worry about</font>

290
00:10:12,080 --> 00:10:15,590
<font color="#E5E5E5">exposing them whereas the non network</font>

291
00:10:14,000 --> 00:10:17,360
like console RDP when you<font color="#CCCCCC"> actually</font>

292
00:10:15,590 --> 00:10:19,670
interactive logon those are gonna expose

293
00:10:17,360 --> 00:10:21,260
your credentials<font color="#CCCCCC"> so we're</font><font color="#E5E5E5"> not worried</font>

294
00:10:19,670 --> 00:10:24,530
about<font color="#E5E5E5"> those type</font><font color="#CCCCCC"> 3 log ons those</font><font color="#E5E5E5"> Network</font>

295
00:10:21,260 --> 00:10:27,050
log ons<font color="#E5E5E5"> and then finally the token types</font>

296
00:10:24,530 --> 00:10:29,030
<font color="#E5E5E5">and impersonation levels so there's two</font>

297
00:10:27,050 --> 00:10:31,609
<font color="#E5E5E5">general types of tokens there's a</font>

298
00:10:29,030 --> 00:10:33,560
process token<font color="#E5E5E5"> the primary token which is</font>

299
00:10:31,610 --> 00:10:35,180
a<font color="#CCCCCC"> process token</font><font color="#E5E5E5"> and then there's</font>

300
00:10:33,560 --> 00:10:38,359
impersonation tokens which is a thread

301
00:10:35,180 --> 00:10:39,739
token essentially each thread has each

302
00:10:38,360 --> 00:10:42,320
thread<font color="#E5E5E5"> can have can't have an</font>

303
00:10:39,740 --> 00:10:45,020
impersonation token now it might use the

304
00:10:42,320 --> 00:10:47,030
primary<font color="#CCCCCC"> token</font><font color="#E5E5E5"> but it also could</font>

305
00:10:45,020 --> 00:10:48,380
potentially use an impersonation token

306
00:10:47,030 --> 00:10:51,170
and<font color="#CCCCCC"> they're legitimate reasons for</font><font color="#E5E5E5"> that</font>

307
00:10:48,380 --> 00:10:52,970
which<font color="#CCCCCC"> jurors gonna get into in a little</font>

308
00:10:51,170 --> 00:10:55,579
bit<font color="#E5E5E5"> so I'll hand it over to Jared yep</font>

309
00:10:52,970 --> 00:10:57,650
<font color="#E5E5E5">okay so to kind of recap the little</font>

310
00:10:55,580 --> 00:11:01,570
research piece that<font color="#E5E5E5"> are all be discussed</font>

311
00:10:57,650 --> 00:11:05,540
every process has<font color="#CCCCCC"> a primary token right</font>

312
00:11:01,570 --> 00:11:07,120
<font color="#CCCCCC">threads can can't have their own token</font>

313
00:11:05,540 --> 00:11:09,520
called an impersonation token

314
00:11:07,120 --> 00:11:11,640
but by<font color="#E5E5E5"> default they will</font><font color="#CCCCCC"> inherit the</font>

315
00:11:09,520 --> 00:11:13,900
primary token from<font color="#E5E5E5"> the process right</font>

316
00:11:11,640 --> 00:11:16,060
<font color="#CCCCCC">attackers of course can manipulate the</font>

317
00:11:13,900 --> 00:11:17,529
tokens apply different tokens<font color="#CCCCCC"> to the</font>

318
00:11:16,060 --> 00:11:19,630
<font color="#E5E5E5">thread that they're executing</font><font color="#CCCCCC"> from</font><font color="#E5E5E5"> and</font>

319
00:11:17,529 --> 00:11:21,100
then they're able<font color="#CCCCCC"> to operate kind of</font>

320
00:11:19,630 --> 00:11:23,589
under<font color="#E5E5E5"> the context of a different user or</font>

321
00:11:21,100 --> 00:11:24,940
maybe a<font color="#E5E5E5"> more privileged user</font><font color="#CCCCCC"> kind of</font>

322
00:11:23,589 --> 00:11:26,910
going<font color="#CCCCCC"> through and talking</font><font color="#E5E5E5"> with maybe</font>

323
00:11:24,940 --> 00:11:29,230
some red team or some of our some of our

324
00:11:26,910 --> 00:11:31,449
offensive research guys<font color="#E5E5E5"> we've kind of</font>

325
00:11:29,230 --> 00:11:33,390
broken<font color="#CCCCCC"> this up into three different kind</font>

326
00:11:31,450 --> 00:11:36,820
of procedures<font color="#CCCCCC"> that you</font><font color="#E5E5E5"> might</font><font color="#CCCCCC"> use</font><font color="#E5E5E5"> to</font>

327
00:11:33,390 --> 00:11:38,589
accomplish<font color="#CCCCCC"> access token manipulation</font><font color="#E5E5E5"> one</font>

328
00:11:36,820 --> 00:11:40,810
is token impersonation or token theft

329
00:11:38,589 --> 00:11:42,940
<font color="#CCCCCC">another one would be create a</font><font color="#E5E5E5"> process</font>

330
00:11:40,810 --> 00:11:44,229
with a<font color="#E5E5E5"> token and then third is make and</font>

331
00:11:42,940 --> 00:11:46,900
impersonate token and<font color="#E5E5E5"> so I'll kind</font><font color="#CCCCCC"> of</font>

332
00:11:44,230 --> 00:11:48,610
talk about<font color="#E5E5E5"> how those work right so token</font>

333
00:11:46,900 --> 00:11:50,860
theft<font color="#E5E5E5"> this is that kind of get system</font>

334
00:11:48,610 --> 00:11:53,920
attack where you directly steal a token

335
00:11:50,860 --> 00:11:56,050
from<font color="#E5E5E5"> a running process right</font><font color="#CCCCCC"> so</font><font color="#E5E5E5"> your</font>

336
00:11:53,920 --> 00:11:57,729
<font color="#E5E5E5">target user has a non-network logon</font>

337
00:11:56,050 --> 00:11:59,740
session on the system<font color="#E5E5E5"> and so this could</font>

338
00:11:57,730 --> 00:12:01,210
<font color="#CCCCCC">be</font><font color="#E5E5E5"> like a process</font><font color="#CCCCCC"> running a</font><font color="#E5E5E5"> system like</font>

339
00:11:59,740 --> 00:12:03,040
when log on<font color="#CCCCCC"> or something like that</font>

340
00:12:01,210 --> 00:12:04,480
or can be<font color="#E5E5E5"> maybe a domain admin already</font>

341
00:12:03,040 --> 00:12:07,180
peed into<font color="#E5E5E5"> a system and you want to steal</font>

342
00:12:04,480 --> 00:12:09,370
their token<font color="#CCCCCC"> and you you call duplicate</font>

343
00:12:07,180 --> 00:12:10,810
token<font color="#E5E5E5"> DX open process to the process</font>

344
00:12:09,370 --> 00:12:13,330
that<font color="#E5E5E5"> you're interested in duplicate</font>

345
00:12:10,810 --> 00:12:14,979
token get a second<font color="#E5E5E5"> secondary token and</font>

346
00:12:13,330 --> 00:12:16,720
then you can apply<font color="#CCCCCC"> that token to your</font>

347
00:12:14,980 --> 00:12:18,790
thread using impersonate logged on user

348
00:12:16,720 --> 00:12:20,440
or set thread token<font color="#E5E5E5"> and so to kind of</font>

349
00:12:18,790 --> 00:12:21,550
show<font color="#E5E5E5"> how this works</font><font color="#CCCCCC"> we have PowerShell</font>

350
00:12:20,440 --> 00:12:24,130
and<font color="#CCCCCC"> we're running to impersonate one</font>

351
00:12:21,550 --> 00:12:26,979
<font color="#CCCCCC">logon</font><font color="#E5E5E5"> we call open process get a hand</font>

352
00:12:24,130 --> 00:12:29,110
handle the win logon<font color="#CCCCCC"> and then we call</font>

353
00:12:26,980 --> 00:12:31,029
duplicate token<font color="#E5E5E5"> so we get a duplicate</font>

354
00:12:29,110 --> 00:12:33,070
system token and then<font color="#E5E5E5"> we can go ahead</font>

355
00:12:31,029 --> 00:12:34,839
and<font color="#CCCCCC"> apply that</font><font color="#E5E5E5"> to</font><font color="#CCCCCC"> our specific thread so</font>

356
00:12:33,070 --> 00:12:36,610
now any code that's running<font color="#E5E5E5"> in that</font>

357
00:12:34,839 --> 00:12:38,290
thread<font color="#E5E5E5"> is</font><font color="#CCCCCC"> going to operate as the system</font>

358
00:12:36,610 --> 00:12:40,930
user<font color="#E5E5E5"> right so that's that's</font><font color="#CCCCCC"> kind of how</font>

359
00:12:38,290 --> 00:12:42,730
that's<font color="#E5E5E5"> working under the hood</font>

360
00:12:40,930 --> 00:12:45,219
the second is create a process<font color="#E5E5E5"> with a</font>

361
00:12:42,730 --> 00:12:47,800
<font color="#E5E5E5">token so for one reason or another the</font>

362
00:12:45,220 --> 00:12:49,330
attacker<font color="#E5E5E5"> wants to run a second process</font>

363
00:12:47,800 --> 00:12:51,550
right outside of<font color="#E5E5E5"> kind of</font><font color="#CCCCCC"> their current</font>

364
00:12:49,330 --> 00:12:53,290
context<font color="#E5E5E5"> but that second process they</font>

365
00:12:51,550 --> 00:12:54,880
want<font color="#E5E5E5"> to run it as a different user than</font>

366
00:12:53,290 --> 00:12:57,130
who they<font color="#E5E5E5"> currently are operating</font><font color="#CCCCCC"> us and</font>

367
00:12:54,880 --> 00:12:58,930
so similarly<font color="#CCCCCC"> they're going to call open</font>

368
00:12:57,130 --> 00:13:00,580
process<font color="#E5E5E5"> duplicate token and get a copy</font>

369
00:12:58,930 --> 00:13:03,550
<font color="#E5E5E5">of</font><font color="#CCCCCC"> that token</font><font color="#E5E5E5"> but then they could call</font>

370
00:13:00,580 --> 00:13:05,500
create process with token W or create

371
00:13:03,550 --> 00:13:07,240
process with token<font color="#CCCCCC"> and</font><font color="#E5E5E5"> so this kind</font><font color="#CCCCCC"> of</font>

372
00:13:05,500 --> 00:13:09,070
looks<font color="#CCCCCC"> like</font><font color="#E5E5E5"> this so explore we have</font>

373
00:13:07,240 --> 00:13:10,870
domain admin logged in we can<font color="#E5E5E5"> open</font>

374
00:13:09,070 --> 00:13:12,880
process then we<font color="#E5E5E5"> could call duplicate</font>

375
00:13:10,870 --> 00:13:15,339
token and that will get<font color="#CCCCCC"> us a duplicate</font>

376
00:13:12,880 --> 00:13:16,930
domain admin token and then we could

377
00:13:15,339 --> 00:13:18,520
call create process with token and

378
00:13:16,930 --> 00:13:19,760
<font color="#E5E5E5">that's going</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> create malicious dot exe</font>

379
00:13:18,520 --> 00:13:21,770
<font color="#E5E5E5">running as</font>

380
00:13:19,760 --> 00:13:24,200
and I want you to<font color="#E5E5E5"> notice</font><font color="#CCCCCC"> that malicious</font>

381
00:13:21,770 --> 00:13:25,610
<font color="#CCCCCC">dot exe the primary token is that domain</font>

382
00:13:24,200 --> 00:13:27,770
admin token right<font color="#E5E5E5"> so that's maybe a</font>

383
00:13:25,610 --> 00:13:30,440
interesting<font color="#E5E5E5"> differentiation when we're</font>

384
00:13:27,770 --> 00:13:32,600
<font color="#CCCCCC">developing our hypothesis here alright</font>

385
00:13:30,440 --> 00:13:34,700
<font color="#CCCCCC">so and the third is making impersonate</font>

386
00:13:32,600 --> 00:13:37,040
token so this is where you have a

387
00:13:34,700 --> 00:13:38,480
<font color="#E5E5E5">username and a username and</font><font color="#CCCCCC"> password for</font>

388
00:13:37,040 --> 00:13:39,949
<font color="#CCCCCC">a user that</font><font color="#E5E5E5"> you</font><font color="#CCCCCC"> want to target</font><font color="#E5E5E5"> but maybe</font>

389
00:13:38,480 --> 00:13:41,990
they're<font color="#E5E5E5"> not logged into the system that</font>

390
00:13:39,950 --> 00:13:43,580
you're on and so<font color="#E5E5E5"> you want to somehow</font>

391
00:13:41,990 --> 00:13:45,920
impersonate<font color="#E5E5E5"> them but you can't just</font>

392
00:13:43,580 --> 00:13:48,620
steal<font color="#E5E5E5"> a token directly</font><font color="#CCCCCC"> and so you call</font>

393
00:13:45,920 --> 00:13:50,780
<font color="#CCCCCC">logon user with a specific logon</font><font color="#E5E5E5"> type</font>

394
00:13:48,620 --> 00:13:52,370
called<font color="#E5E5E5"> login</font><font color="#CCCCCC"> 32</font><font color="#E5E5E5"> logon new credential and</font>

395
00:13:50,780 --> 00:13:54,650
<font color="#E5E5E5">so this is a type 9 if anybody's ever</font>

396
00:13:52,370 --> 00:13:56,380
<font color="#CCCCCC">used run as slash net only that's</font>

397
00:13:54,650 --> 00:13:58,340
exactly what that's<font color="#CCCCCC"> doing right and so</font>

398
00:13:56,380 --> 00:14:00,620
attackers realize that they can do this

399
00:13:58,340 --> 00:14:02,390
create a new logon session for the user

400
00:14:00,620 --> 00:14:03,830
that<font color="#CCCCCC"> they want</font><font color="#E5E5E5"> to impersonate using that</font>

401
00:14:02,390 --> 00:14:05,750
username and password and then<font color="#CCCCCC"> they</font>

402
00:14:03,830 --> 00:14:08,030
<font color="#E5E5E5">could call set thread token and apply it</font>

403
00:14:05,750 --> 00:14:11,270
to<font color="#CCCCCC"> themselves</font><font color="#E5E5E5"> and so that kind of looks</font>

404
00:14:08,030 --> 00:14:14,089
like this so<font color="#E5E5E5"> I pass in the domain</font>

405
00:14:11,270 --> 00:14:16,189
username<font color="#E5E5E5"> password type 9</font><font color="#CCCCCC"> logon create a</font>

406
00:14:14,090 --> 00:14:18,080
<font color="#E5E5E5">new vlog on session locally I'll be</font>

407
00:14:16,190 --> 00:14:20,030
running as my current user John Doe<font color="#E5E5E5"> but</font>

408
00:14:18,080 --> 00:14:21,860
<font color="#CCCCCC">on the network I'll be</font><font color="#E5E5E5"> running as this</font>

409
00:14:20,030 --> 00:14:23,689
domain admin and then I could<font color="#E5E5E5"> call set</font>

410
00:14:21,860 --> 00:14:25,580
thread token to apply that to my<font color="#CCCCCC"> current</font>

411
00:14:23,690 --> 00:14:27,320
thread and now I'm<font color="#E5E5E5"> operating again</font>

412
00:14:25,580 --> 00:14:29,390
locally<font color="#E5E5E5"> as John Doe but</font><font color="#CCCCCC"> on the network</font>

413
00:14:27,320 --> 00:14:30,740
as domain admin<font color="#E5E5E5"> and so that's kind of</font>

414
00:14:29,390 --> 00:14:32,270
interesting<font color="#CCCCCC"> one of the</font><font color="#E5E5E5"> one</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> the</font>

415
00:14:30,740 --> 00:14:34,190
interesting things about<font color="#CCCCCC"> that is</font><font color="#E5E5E5"> when I</font>

416
00:14:32,270 --> 00:14:36,140
queried<font color="#E5E5E5"> the primary token or that</font>

417
00:14:34,190 --> 00:14:37,940
impersonation token<font color="#E5E5E5"> it's going to appear</font>

418
00:14:36,140 --> 00:14:40,100
as if<font color="#E5E5E5"> John Doe is the user that it's</font>

419
00:14:37,940 --> 00:14:41,690
running<font color="#E5E5E5"> as but as we mentioned on the</font>

420
00:14:40,100 --> 00:14:43,190
network<font color="#CCCCCC"> I'll be</font><font color="#E5E5E5"> running as domain admin</font>

421
00:14:41,690 --> 00:14:44,510
so we<font color="#E5E5E5"> we might want</font><font color="#CCCCCC"> to like think about</font>

422
00:14:43,190 --> 00:14:48,230
how we might<font color="#E5E5E5"> detect that type of</font>

423
00:14:44,510 --> 00:14:49,490
relationship<font color="#CCCCCC"> alright so we've kind of</font>

424
00:14:48,230 --> 00:14:51,620
identified that<font color="#E5E5E5"> we have three different</font>

425
00:14:49,490 --> 00:14:53,810
procedures but remember for create

426
00:14:51,620 --> 00:14:56,360
creative process with token W or create

427
00:14:53,810 --> 00:14:58,160
process with a token<font color="#CCCCCC"> that's creating a</font>

428
00:14:56,360 --> 00:15:00,230
primary token right so we're

429
00:14:58,160 --> 00:15:02,000
impersonating using a primary token and

430
00:15:00,230 --> 00:15:03,860
<font color="#E5E5E5">so maybe that's a</font><font color="#CCCCCC"> little</font><font color="#E5E5E5"> bit different</font>

431
00:15:02,000 --> 00:15:05,210
of<font color="#E5E5E5"> how we might detect the activity</font><font color="#CCCCCC"> and</font>

432
00:15:03,860 --> 00:15:06,800
so we're going to go ahead and drop<font color="#CCCCCC"> that</font>

433
00:15:05,210 --> 00:15:08,210
out<font color="#E5E5E5"> for this hypothesis otherwise we're</font>

434
00:15:06,800 --> 00:15:09,920
gonna<font color="#E5E5E5"> have</font><font color="#CCCCCC"> like scope creep and</font><font color="#E5E5E5"> get a</font>

435
00:15:08,210 --> 00:15:11,150
little bit<font color="#E5E5E5"> out of control</font><font color="#CCCCCC"> and so we want</font>

436
00:15:09,920 --> 00:15:14,020
to<font color="#CCCCCC"> kind of narrow it in so we could</font>

437
00:15:11,150 --> 00:15:16,579
<font color="#E5E5E5">actually focus on a</font><font color="#CCCCCC"> problem alright so</font>

438
00:15:14,020 --> 00:15:18,290
<font color="#E5E5E5">identify collection requirements so this</font>

439
00:15:16,580 --> 00:15:20,540
is kind of the third phase<font color="#CCCCCC"> the idea here</font>

440
00:15:18,290 --> 00:15:22,040
would<font color="#E5E5E5"> be to maybe find some proof of</font>

441
00:15:20,540 --> 00:15:25,040
concepts for this attack<font color="#E5E5E5"> these attack</font>

442
00:15:22,040 --> 00:15:27,050
techniques<font color="#CCCCCC"> kind</font><font color="#E5E5E5"> of use them in a lab and</font>

443
00:15:25,040 --> 00:15:28,339
start getting an<font color="#E5E5E5"> idea for how this how</font>

444
00:15:27,050 --> 00:15:29,839
<font color="#E5E5E5">this might</font><font color="#CCCCCC"> work and</font><font color="#E5E5E5"> how you might detect</font>

445
00:15:28,340 --> 00:15:32,150
<font color="#CCCCCC">it what data do you need to collect</font><font color="#E5E5E5"> that</font>

446
00:15:29,840 --> 00:15:33,110
kind<font color="#CCCCCC"> of thing so we might use real</font>

447
00:15:32,150 --> 00:15:35,930
malware or

448
00:15:33,110 --> 00:15:40,010
of concept<font color="#E5E5E5"> malware</font><font color="#CCCCCC"> open-source things</font>

449
00:15:35,930 --> 00:15:42,920
like<font color="#E5E5E5"> incognito and</font><font color="#CCCCCC"> Metasploit we can use</font>

450
00:15:40,010 --> 00:15:44,779
<font color="#CCCCCC">Empire has invoked token manipulation</font>

451
00:15:42,920 --> 00:15:46,160
there's tons of different<font color="#E5E5E5"> options</font><font color="#CCCCCC"> but we</font>

452
00:15:44,779 --> 00:15:49,130
<font color="#CCCCCC">we kind of want to go through that</font>

453
00:15:46,160 --> 00:15:50,300
<font color="#CCCCCC">process</font><font color="#E5E5E5"> and</font><font color="#CCCCCC"> so here we go through and</font>

454
00:15:49,130 --> 00:15:53,510
start<font color="#E5E5E5"> interacting with different tools</font>

455
00:15:50,300 --> 00:15:55,910
<font color="#E5E5E5">collect relevant data points ultimately</font>

456
00:15:53,510 --> 00:15:57,709
we found that access tokens for every

457
00:15:55,910 --> 00:16:00,110
process<font color="#E5E5E5"> and thread are very valuable for</font>

458
00:15:57,709 --> 00:16:02,268
identifying<font color="#E5E5E5"> this type</font><font color="#CCCCCC"> of activity and</font>

459
00:16:00,110 --> 00:16:04,040
then we<font color="#E5E5E5"> found out that Kerberos tickets</font>

460
00:16:02,269 --> 00:16:05,540
for each logon session might be

461
00:16:04,040 --> 00:16:08,959
interesting and<font color="#E5E5E5"> I'll show I'll show why</font>

462
00:16:05,540 --> 00:16:11,209
in a second<font color="#CCCCCC"> and so collecting access</font>

463
00:16:08,959 --> 00:16:12,829
tokens we end up writing<font color="#E5E5E5"> a PowerShell</font>

464
00:16:11,209 --> 00:16:14,540
<font color="#E5E5E5">script that's</font><font color="#CCCCCC"> going to do this</font><font color="#E5E5E5"> you</font>

465
00:16:12,829 --> 00:16:16,699
numerate every process you open every

466
00:16:14,540 --> 00:16:18,410
process query<font color="#E5E5E5"> it's query</font><font color="#CCCCCC"> it's token and</font>

467
00:16:16,700 --> 00:16:20,750
then<font color="#E5E5E5"> you enumerate</font><font color="#CCCCCC"> every</font><font color="#E5E5E5"> thread and then</font>

468
00:16:18,410 --> 00:16:22,490
query query<font color="#CCCCCC"> it's token if the thread</font><font color="#E5E5E5"> has</font>

469
00:16:20,750 --> 00:16:24,170
an impersonation token it will return if

470
00:16:22,490 --> 00:16:25,880
not it<font color="#E5E5E5"> will it will say hey nothing</font>

471
00:16:24,170 --> 00:16:28,370
nothing here<font color="#CCCCCC"> to find go ahead and</font>

472
00:16:25,880 --> 00:16:30,500
reference the process token and so

473
00:16:28,370 --> 00:16:32,120
ultimately<font color="#E5E5E5"> we have get access token and</font>

474
00:16:30,500 --> 00:16:34,130
we have a bunch of<font color="#E5E5E5"> information like</font>

475
00:16:32,120 --> 00:16:36,410
what's the<font color="#CCCCCC"> process name you know who's</font>

476
00:16:34,130 --> 00:16:37,820
the user for<font color="#CCCCCC"> that token what groups are</font>

477
00:16:36,410 --> 00:16:41,390
<font color="#E5E5E5">they a part of what privileges do they</font>

478
00:16:37,820 --> 00:16:42,160
have this is a<font color="#E5E5E5"> primary token all that</font>

479
00:16:41,390 --> 00:16:44,990
kind of<font color="#E5E5E5"> stuff</font>

480
00:16:42,160 --> 00:16:47,300
here's what benign impersonation ends up

481
00:16:44,990 --> 00:16:50,570
looking like from from the perspective

482
00:16:47,300 --> 00:16:52,399
of get get<font color="#E5E5E5"> token get access token and so</font>

483
00:16:50,570 --> 00:16:55,010
the<font color="#E5E5E5"> process name here is SVC host which</font>

484
00:16:52,399 --> 00:16:56,510
SVC host for those that know is the

485
00:16:55,010 --> 00:16:58,970
service host process<font color="#CCCCCC"> its whole purpose</font>

486
00:16:56,510 --> 00:17:01,730
<font color="#CCCCCC">is to</font><font color="#E5E5E5"> host other services right other</font>

487
00:16:58,970 --> 00:17:05,720
processes and<font color="#CCCCCC"> so the idea here is it's</font>

488
00:17:01,730 --> 00:17:07,549
<font color="#E5E5E5">running as a normal user but</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> it's</font>

489
00:17:05,720 --> 00:17:10,429
impersonating a normal user this tester

490
00:17:07,549 --> 00:17:12,918
user here but it's originally running a

491
00:17:10,429 --> 00:17:14,959
system<font color="#CCCCCC"> and so we go from system level</font>

492
00:17:12,919 --> 00:17:17,179
user and we're impersonating a lower

493
00:17:14,959 --> 00:17:18,559
just normal local admin user and so in

494
00:17:17,179 --> 00:17:20,209
that case<font color="#E5E5E5"> we have what I call like kind</font>

495
00:17:18,559 --> 00:17:21,589
<font color="#CCCCCC">of downward</font><font color="#E5E5E5"> impersonation right so</font>

496
00:17:20,209 --> 00:17:23,179
you're<font color="#CCCCCC"> impersonating a less privileged</font>

497
00:17:21,589 --> 00:17:25,609
user and in that case we're<font color="#CCCCCC"> not</font>

498
00:17:23,179 --> 00:17:27,410
necessarily quite<font color="#E5E5E5"> as worried</font><font color="#CCCCCC"> about it as</font>

499
00:17:25,609 --> 00:17:29,418
opposed to kind<font color="#E5E5E5"> of this impersonating</font>

500
00:17:27,410 --> 00:17:31,700
system token we have<font color="#CCCCCC"> PowerShell who's</font>

501
00:17:29,419 --> 00:17:34,309
the<font color="#E5E5E5"> primary user for the primary token</font>

502
00:17:31,700 --> 00:17:35,510
<font color="#E5E5E5">is tester</font><font color="#CCCCCC"> right a normal local admin</font><font color="#E5E5E5"> but</font>

503
00:17:34,309 --> 00:17:37,730
the<font color="#E5E5E5"> user name that</font><font color="#CCCCCC"> they're impersonating</font>

504
00:17:35,510 --> 00:17:39,049
<font color="#CCCCCC">a system right so this is like an upward</font>

505
00:17:37,730 --> 00:17:40,669
impersonation<font color="#CCCCCC"> and this might be</font>

506
00:17:39,049 --> 00:17:43,010
<font color="#E5E5E5">something that we're</font><font color="#CCCCCC"> interested</font><font color="#E5E5E5"> in and</font>

507
00:17:40,669 --> 00:17:45,800
that's in fact<font color="#E5E5E5"> PowerShell empire doing</font>

508
00:17:43,010 --> 00:17:46,910
<font color="#E5E5E5">impersonation</font><font color="#CCCCCC"> and then for ticket</font>

509
00:17:45,800 --> 00:17:49,010
granting ticket<font color="#CCCCCC"> s-- we're going</font>

510
00:17:46,910 --> 00:17:50,420
<font color="#E5E5E5">to numerate the logon sessions</font><font color="#CCCCCC"> ticket</font>

511
00:17:49,010 --> 00:17:52,190
granting ticket SAR associated with

512
00:17:50,420 --> 00:17:53,870
<font color="#E5E5E5">every logon session that's performing</font>

513
00:17:52,190 --> 00:17:55,130
Kerberos authentication<font color="#CCCCCC"> and</font><font color="#E5E5E5"> then we're</font>

514
00:17:53,870 --> 00:17:57,290
<font color="#E5E5E5">going to go ahead and just query the</font>

515
00:17:55,130 --> 00:17:58,700
ticket itself<font color="#CCCCCC"> and so we have get</font>

516
00:17:57,290 --> 00:18:00,460
Kerberos ticket granting ticket<font color="#CCCCCC"> which</font>

517
00:17:58,700 --> 00:18:02,810
gives us a bunch of information<font color="#E5E5E5"> such as</font>

518
00:18:00,460 --> 00:18:04,370
what type of<font color="#E5E5E5"> ticket it is krbtgt</font>

519
00:18:02,810 --> 00:18:07,070
indicates that it's a ticket granting

520
00:18:04,370 --> 00:18:10,129
ticket<font color="#CCCCCC"> we see the client local admin and</font>

521
00:18:07,070 --> 00:18:13,220
the domain and then here's<font color="#E5E5E5"> a benign take</font>

522
00:18:10,130 --> 00:18:15,320
a<font color="#CCCCCC"> grant ticket so again we have a logon</font>

523
00:18:13,220 --> 00:18:17,090
for local admin at<font color="#CCCCCC"> citadel and we have a</font>

524
00:18:15,320 --> 00:18:18,710
ticket<font color="#E5E5E5"> for local admin at citadel which</font>

525
00:18:17,090 --> 00:18:20,750
is kind of what you would expect<font color="#CCCCCC"> and</font>

526
00:18:18,710 --> 00:18:22,790
then here's a situation<font color="#CCCCCC"> where we have a</font>

527
00:18:20,750 --> 00:18:25,280
negotiate logon session for a user John

528
00:18:22,790 --> 00:18:27,800
local user who's<font color="#E5E5E5"> requesting Mike Wright</font>

529
00:18:25,280 --> 00:18:29,930
underscore a at<font color="#E5E5E5"> Citadel the</font><font color="#CCCCCC"> ticket</font><font color="#E5E5E5"> and</font>

530
00:18:27,800 --> 00:18:31,460
so generally<font color="#E5E5E5"> you want to like probably</font>

531
00:18:29,930 --> 00:18:33,350
request a ticket for the user<font color="#E5E5E5"> that the</font>

532
00:18:31,460 --> 00:18:34,640
logon session belongs to and if<font color="#E5E5E5"> that's</font>

533
00:18:33,350 --> 00:18:36,620
<font color="#E5E5E5">not the case</font><font color="#CCCCCC"> that might be something</font>

534
00:18:34,640 --> 00:18:39,800
<font color="#CCCCCC">that</font><font color="#E5E5E5"> indicates something strange is</font>

535
00:18:36,620 --> 00:18:41,959
going<font color="#CCCCCC"> on alright</font><font color="#E5E5E5"> so we kind of have</font>

536
00:18:39,800 --> 00:18:44,389
identified what we're looking<font color="#CCCCCC"> for</font><font color="#E5E5E5"> how we</font>

537
00:18:41,960 --> 00:18:46,070
might<font color="#E5E5E5"> gather data to help us derive that</font>

538
00:18:44,390 --> 00:18:48,320
hypothesis but then we want<font color="#E5E5E5"> to scope</font>

539
00:18:46,070 --> 00:18:50,060
like identify the scope<font color="#E5E5E5"> right so how</font>

540
00:18:48,320 --> 00:18:51,409
<font color="#E5E5E5">much how like do we want to run this</font>

541
00:18:50,060 --> 00:18:52,669
across<font color="#CCCCCC"> the entire network</font><font color="#E5E5E5"> is</font><font color="#CCCCCC"> that</font>

542
00:18:51,410 --> 00:18:54,500
feasible<font color="#E5E5E5"> like where do we have</font>

543
00:18:52,670 --> 00:18:56,450
collection all that kind of stuff<font color="#CCCCCC"> and</font><font color="#E5E5E5"> so</font>

544
00:18:54,500 --> 00:18:58,820
and so<font color="#CCCCCC"> that's kind of what this identify</font>

545
00:18:56,450 --> 00:19:01,370
scope phase is and so we want<font color="#E5E5E5"> to do this</font>

546
00:18:58,820 --> 00:19:04,040
over<font color="#E5E5E5"> one week we have three domains</font><font color="#CCCCCC"> with</font>

547
00:19:01,370 --> 00:19:06,530
one<font color="#E5E5E5"> Linux server which doesn't have</font>

548
00:19:04,040 --> 00:19:08,690
access<font color="#E5E5E5"> tokens nine windows workstations</font>

549
00:19:06,530 --> 00:19:09,889
two<font color="#E5E5E5"> windows servers and no sensitive</font>

550
00:19:08,690 --> 00:19:11,390
system so we're just going<font color="#CCCCCC"> to hit all</font>

551
00:19:09,890 --> 00:19:13,520
the basically<font color="#E5E5E5"> all the windows systems</font>

552
00:19:11,390 --> 00:19:14,960
and then we want<font color="#E5E5E5"> a document excluded</font>

553
00:19:13,520 --> 00:19:17,480
factors so what<font color="#CCCCCC"> did we</font><font color="#E5E5E5"> what do we</font>

554
00:19:14,960 --> 00:19:20,240
expressly exclude throughout our

555
00:19:17,480 --> 00:19:22,190
hypothesis<font color="#E5E5E5"> and so for</font><font color="#CCCCCC"> instance other</font>

556
00:19:20,240 --> 00:19:23,840
privilege escalation<font color="#E5E5E5"> techniques that</font>

557
00:19:22,190 --> 00:19:26,450
maybe we want<font color="#E5E5E5"> to</font><font color="#CCCCCC"> circle back</font><font color="#E5E5E5"> to later</font><font color="#CCCCCC"> on</font>

558
00:19:23,840 --> 00:19:28,250
<font color="#CCCCCC">maybe credential access techniques like</font>

559
00:19:26,450 --> 00:19:31,340
credential dumping lateral<font color="#E5E5E5"> movement</font>

560
00:19:28,250 --> 00:19:33,410
<font color="#CCCCCC">maybe there's a couple situations where</font>

561
00:19:31,340 --> 00:19:34,879
we're not able to<font color="#E5E5E5"> elevate the system to</font>

562
00:19:33,410 --> 00:19:36,800
<font color="#CCCCCC">actually</font><font color="#E5E5E5"> gather the data that we need</font>

563
00:19:34,880 --> 00:19:38,210
<font color="#CCCCCC">and so that might be something that we</font>

564
00:19:36,800 --> 00:19:40,010
want<font color="#CCCCCC"> to circle</font><font color="#E5E5E5"> back on it as well so</font>

565
00:19:38,210 --> 00:19:42,380
<font color="#E5E5E5">like the</font><font color="#CCCCCC"> the point</font><font color="#E5E5E5"> of this this part of</font>

566
00:19:40,010 --> 00:19:44,390
the process is to really<font color="#CCCCCC"> identify what</font>

567
00:19:42,380 --> 00:19:45,770
did we leave out and what do we<font color="#CCCCCC"> need to</font>

568
00:19:44,390 --> 00:19:47,870
do in the<font color="#CCCCCC"> future or think</font><font color="#E5E5E5"> about in the</font>

569
00:19:45,770 --> 00:19:50,570
<font color="#E5E5E5">future to really</font><font color="#CCCCCC"> answer the the</font><font color="#E5E5E5"> initial</font>

570
00:19:47,870 --> 00:19:52,790
question<font color="#E5E5E5"> all right so we have</font><font color="#CCCCCC"> a we have</font>

571
00:19:50,570 --> 00:19:54,889
a demo this<font color="#E5E5E5"> is from a</font><font color="#CCCCCC"> Red Team</font><font color="#E5E5E5"> training</font>

572
00:19:52,790 --> 00:19:55,940
class lab so it's a little<font color="#E5E5E5"> the network's</font>

573
00:19:54,890 --> 00:19:58,190
a little dirtier than what a normal

574
00:19:55,940 --> 00:20:00,559
<font color="#E5E5E5">network would be surprisingly yeah</font>

575
00:19:58,190 --> 00:20:05,749
<font color="#E5E5E5">hopefully so</font>

576
00:20:00,559 --> 00:20:07,789
<font color="#CCCCCC">I think it's alright so generally</font>

577
00:20:05,749 --> 00:20:09,110
<font color="#E5E5E5">speaking I created a PowerShell</font><font color="#CCCCCC"> remoting</font>

578
00:20:07,789 --> 00:20:10,490
session so<font color="#CCCCCC"> that I could</font><font color="#E5E5E5"> run this</font>

579
00:20:09,110 --> 00:20:12,918
PowerShell script across all these

580
00:20:10,490 --> 00:20:15,559
<font color="#E5E5E5">systems there's 12 systems in total here</font>

581
00:20:12,919 --> 00:20:17,090
I'm collecting<font color="#E5E5E5"> tokens</font><font color="#CCCCCC"> one</font><font color="#E5E5E5"> system</font><font color="#CCCCCC"> returns</font>

582
00:20:15,559 --> 00:20:19,039
saying hey you're<font color="#CCCCCC"> not able</font><font color="#E5E5E5"> to elevate</font>

583
00:20:17,090 --> 00:20:21,049
<font color="#E5E5E5">the system a kind of interesting trick</font>

584
00:20:19,039 --> 00:20:23,059
<font color="#E5E5E5">to collecting tokens is that you have to</font>

585
00:20:21,049 --> 00:20:26,749
impersonate system in order<font color="#E5E5E5"> to collect</font>

586
00:20:23,059 --> 00:20:29,418
<font color="#E5E5E5">tokens for all the processes</font><font color="#CCCCCC"> similarly I</font>

587
00:20:26,749 --> 00:20:32,450
collected<font color="#E5E5E5"> Kerberos tickets and so we end</font>

588
00:20:29,419 --> 00:20:34,490
<font color="#E5E5E5">up with show here in a second quite a</font>

589
00:20:32,450 --> 00:20:36,679
number of<font color="#E5E5E5"> tokens and this is what a</font>

590
00:20:34,490 --> 00:20:38,149
token looks like so we have a<font color="#E5E5E5"> process</font>

591
00:20:36,679 --> 00:20:40,309
name that's associated<font color="#E5E5E5"> with the process</font>

592
00:20:38,149 --> 00:20:42,139
<font color="#E5E5E5">ID we have the user name for the token</font>

593
00:20:40,309 --> 00:20:43,700
<font color="#CCCCCC">itself</font><font color="#E5E5E5"> and then we have information on</font>

594
00:20:42,139 --> 00:20:45,258
<font color="#E5E5E5">the primary token which in this case</font>

595
00:20:43,700 --> 00:20:46,909
it's a primary token<font color="#E5E5E5"> itself so it's</font>

596
00:20:45,259 --> 00:20:48,740
going<font color="#CCCCCC"> to</font><font color="#E5E5E5"> match</font><font color="#CCCCCC"> up but</font><font color="#E5E5E5"> in the case of</font>

597
00:20:46,909 --> 00:20:50,179
<font color="#E5E5E5">impersonation tokens that information</font>

598
00:20:48,740 --> 00:20:52,639
will<font color="#E5E5E5"> be different and allow us to really</font>

599
00:20:50,179 --> 00:20:55,700
kind of identify what's<font color="#CCCCCC"> going on and so</font>

600
00:20:52,639 --> 00:20:57,559
<font color="#E5E5E5">initially we have 633 tokens but we'll</font>

601
00:20:55,700 --> 00:20:59,480
start kind of narrowing<font color="#E5E5E5"> in on the tokens</font>

602
00:20:57,559 --> 00:21:02,509
<font color="#CCCCCC">that actually matter to us particularly</font>

603
00:20:59,480 --> 00:21:03,710
impersonation tokens<font color="#E5E5E5"> and so here we're</font>

604
00:21:02,509 --> 00:21:06,049
looking<font color="#E5E5E5"> for tokens</font><font color="#CCCCCC"> that</font><font color="#E5E5E5"> aren't</font>

605
00:21:03,710 --> 00:21:09,289
<font color="#E5E5E5">impersonation so or not primary so we</font>

606
00:21:06,049 --> 00:21:10,879
have 104 impersonation<font color="#E5E5E5"> tokens and then</font>

607
00:21:09,289 --> 00:21:13,309
we're<font color="#E5E5E5"> going to start narrowing in and</font>

608
00:21:10,879 --> 00:21:14,748
say hey we<font color="#CCCCCC"> want</font><font color="#E5E5E5"> to look at impersonation</font>

609
00:21:13,309 --> 00:21:16,700
tokens where they're not<font color="#E5E5E5"> impersonating</font>

610
00:21:14,749 --> 00:21:18,470
themselves right so any impersonation

611
00:21:16,700 --> 00:21:19,999
token where the primary<font color="#CCCCCC"> user name and</font>

612
00:21:18,470 --> 00:21:22,429
the user name are not the same and we

613
00:21:19,999 --> 00:21:24,740
get<font color="#E5E5E5"> down to 49 and so usually this is a</font>

614
00:21:22,429 --> 00:21:27,889
lot smaller<font color="#CCCCCC"> but because</font><font color="#E5E5E5"> this was a</font><font color="#CCCCCC"> Red</font>

615
00:21:24,740 --> 00:21:33,860
<font color="#CCCCCC">Team</font><font color="#E5E5E5"> lab there's some craziness going on</font>

616
00:21:27,889 --> 00:21:35,330
and so there's a lot<font color="#CCCCCC"> of bad stuff</font><font color="#E5E5E5"> all</font>

617
00:21:33,860 --> 00:21:36,918
<font color="#CCCCCC">right so now I'm</font><font color="#E5E5E5"> going to show kind of</font>

618
00:21:35,330 --> 00:21:39,860
like the<font color="#E5E5E5"> actual output the process name</font>

619
00:21:36,919 --> 00:21:41,899
process ID<font color="#CCCCCC"> primary user name and user</font>

620
00:21:39,860 --> 00:21:44,508
name and then I think the computer name

621
00:21:41,899 --> 00:21:46,248
<font color="#CCCCCC">that it's on and</font><font color="#E5E5E5"> so we we can throw</font><font color="#CCCCCC"> that</font>

622
00:21:44,509 --> 00:21:49,309
out<font color="#E5E5E5"> and so we start</font><font color="#CCCCCC"> looking through</font><font color="#E5E5E5"> this</font>

623
00:21:46,249 --> 00:21:50,899
right and so first things first I start

624
00:21:49,309 --> 00:21:52,460
<font color="#CCCCCC">identifying that you know it looks</font>

625
00:21:50,899 --> 00:21:54,498
fairly consistent so on the right<font color="#E5E5E5"> you</font>

626
00:21:52,460 --> 00:21:57,619
see the<font color="#E5E5E5"> computer</font><font color="#CCCCCC"> name and you see</font><font color="#E5E5E5"> that</font>

627
00:21:54,499 --> 00:21:58,909
there's like one<font color="#E5E5E5"> it's all SVC host you</font>

628
00:21:57,619 --> 00:22:00,860
see that there's like one system

629
00:21:58,909 --> 00:22:02,090
impersonating a user and then there's a

630
00:22:00,860 --> 00:22:03,740
bunch<font color="#E5E5E5"> of network service impersonating</font>

631
00:22:02,090 --> 00:22:06,649
user it's pretty<font color="#CCCCCC"> consistent but it's</font>

632
00:22:03,740 --> 00:22:09,289
also all downward downward<font color="#CCCCCC"> impersonation</font>

633
00:22:06,649 --> 00:22:12,199
so it ended up that<font color="#E5E5E5"> there was no actual</font>

634
00:22:09,289 --> 00:22:13,970
<font color="#CCCCCC">like system system token theft</font><font color="#E5E5E5"> in this</font>

635
00:22:12,200 --> 00:22:16,190
in this lab

636
00:22:13,970 --> 00:22:18,590
that we ran this and so we're<font color="#E5E5E5"> gonna go</font>

637
00:22:16,190 --> 00:22:20,030
ahead<font color="#CCCCCC"> and look at tickets right so again</font>

638
00:22:18,590 --> 00:22:21,770
we have<font color="#E5E5E5"> those tickets</font><font color="#CCCCCC"> we have seventy</font>

639
00:22:20,030 --> 00:22:24,260
<font color="#CCCCCC">six tickets total</font><font color="#E5E5E5"> throughout the 12</font>

640
00:22:21,770 --> 00:22:26,120
systems and we're going<font color="#E5E5E5"> to start kind of</font>

641
00:22:24,260 --> 00:22:27,710
narrowing<font color="#E5E5E5"> in again where the session</font>

642
00:22:26,120 --> 00:22:29,570
<font color="#E5E5E5">username is not equal</font><font color="#CCCCCC"> to the client name</font>

643
00:22:27,710 --> 00:22:31,550
right so I have a<font color="#E5E5E5"> logon session for</font>

644
00:22:29,570 --> 00:22:33,470
<font color="#E5E5E5">Jared I'm probably going to request a</font>

645
00:22:31,550 --> 00:22:34,820
Kerberos ticket for Jared<font color="#E5E5E5"> and in cases</font>

646
00:22:33,470 --> 00:22:37,900
where that's<font color="#E5E5E5"> not the</font><font color="#CCCCCC"> case I</font><font color="#E5E5E5"> might be</font>

647
00:22:34,820 --> 00:22:39,950
interested<font color="#E5E5E5"> in investigating that and so</font>

648
00:22:37,900 --> 00:22:41,630
again I<font color="#E5E5E5"> think we narrowed it down to</font>

649
00:22:39,950 --> 00:22:44,180
<font color="#E5E5E5">like 26 but we can start looking at the</font>

650
00:22:41,630 --> 00:22:46,760
<font color="#CCCCCC">actual information here and so we see</font>

651
00:22:44,180 --> 00:22:48,290
for<font color="#CCCCCC"> instance</font><font color="#E5E5E5"> a bunch of a bunch of use</font>

652
00:22:46,760 --> 00:22:50,300
cases so<font color="#E5E5E5"> we have like this John user</font>

653
00:22:48,290 --> 00:22:52,310
again<font color="#E5E5E5"> who's impersonating a bunch of</font>

654
00:22:50,300 --> 00:22:54,290
<font color="#E5E5E5">people we have</font><font color="#CCCCCC"> andy robbins da</font>

655
00:22:52,310 --> 00:22:56,030
<font color="#CCCCCC">impersonating Matt Nelson da from a</font>

656
00:22:54,290 --> 00:22:58,060
<font color="#CCCCCC">different domain we have</font><font color="#E5E5E5"> John</font>

657
00:22:56,030 --> 00:23:00,230
impersonating Mike<font color="#CCCCCC"> right underscore a</font>

658
00:22:58,060 --> 00:23:02,600
<font color="#E5E5E5">there's a bunch of crazy stuff</font><font color="#CCCCCC"> going on</font>

659
00:23:00,230 --> 00:23:04,550
<font color="#E5E5E5">and so we're just</font><font color="#CCCCCC"> gonna pick out a</font>

660
00:23:02,600 --> 00:23:06,320
couple things<font color="#CCCCCC"> but these these John users</font>

661
00:23:04,550 --> 00:23:08,930
ended up being anybody familiar with

662
00:23:06,320 --> 00:23:10,879
<font color="#E5E5E5">power up the privilege escalation tool</font>

663
00:23:08,930 --> 00:23:12,950
<font color="#E5E5E5">so the</font><font color="#CCCCCC"> default user that power up will</font>

664
00:23:10,880 --> 00:23:15,680
create is John and so that's what<font color="#CCCCCC"> that</font>

665
00:23:12,950 --> 00:23:18,140
<font color="#E5E5E5">ended up being and so we'll kind</font><font color="#CCCCCC"> of go</font>

666
00:23:15,680 --> 00:23:19,400
in and start investigating<font color="#E5E5E5"> some of</font><font color="#CCCCCC"> this</font>

667
00:23:18,140 --> 00:23:21,770
<font color="#E5E5E5">activity and one of the ways that</font><font color="#CCCCCC"> I like</font>

668
00:23:19,400 --> 00:23:23,270
<font color="#CCCCCC">to</font><font color="#E5E5E5"> do it is you have a logon session ID</font>

669
00:23:21,770 --> 00:23:25,580
<font color="#E5E5E5">associated with it and you could use</font>

670
00:23:23,270 --> 00:23:28,070
PowerShell<font color="#E5E5E5"> to query the processes that</font>

671
00:23:25,580 --> 00:23:29,540
were that<font color="#E5E5E5"> are spawned within that logon</font>

672
00:23:28,070 --> 00:23:31,480
session<font color="#E5E5E5"> and so you can start kind of</font>

673
00:23:29,540 --> 00:23:34,879
identifying what's going on there and<font color="#E5E5E5"> so</font>

674
00:23:31,480 --> 00:23:37,670
here I'm going<font color="#E5E5E5"> to look for these</font><font color="#CCCCCC"> Andy</font>

675
00:23:34,880 --> 00:23:38,870
<font color="#CCCCCC">Robins da the top ones</font><font color="#E5E5E5"> I'm gonna start</font>

676
00:23:37,670 --> 00:23:40,430
looking<font color="#CCCCCC"> through them</font><font color="#E5E5E5"> and seeing if any</font>

677
00:23:38,870 --> 00:23:42,939
of them show any signs of like malicious

678
00:23:40,430 --> 00:23:45,260
or suspicious process that he's going<font color="#CCCCCC"> on</font>

679
00:23:42,940 --> 00:23:47,720
<font color="#CCCCCC">that kind of the</font><font color="#E5E5E5"> initial thing is we're</font>

680
00:23:45,260 --> 00:23:49,160
saying okay well it's weird<font color="#E5E5E5"> for</font><font color="#CCCCCC"> like one</font>

681
00:23:47,720 --> 00:23:50,750
person to request a ticket<font color="#CCCCCC"> for another</font>

682
00:23:49,160 --> 00:23:52,520
person<font color="#E5E5E5"> but it's not necessarily bad</font>

683
00:23:50,750 --> 00:23:54,080
right so there's tons<font color="#E5E5E5"> of weird things</font>

684
00:23:52,520 --> 00:23:55,940
security products all kinds<font color="#CCCCCC"> of weird</font>

685
00:23:54,080 --> 00:23:57,949
things<font color="#CCCCCC"> that are doing doing stuff and</font><font color="#E5E5E5"> so</font>

686
00:23:55,940 --> 00:23:59,390
<font color="#E5E5E5">we want to like that gives us a point to</font>

687
00:23:57,950 --> 00:24:00,710
start investigating<font color="#E5E5E5"> but it doesn't mean</font>

688
00:23:59,390 --> 00:24:02,240
that<font color="#E5E5E5"> we should immediately call it</font>

689
00:24:00,710 --> 00:24:04,430
malicious<font color="#E5E5E5"> and so we start rolling</font>

690
00:24:02,240 --> 00:24:05,930
through and<font color="#E5E5E5"> eventually we find that</font>

691
00:24:04,430 --> 00:24:08,030
there's this<font color="#E5E5E5"> powershell with an encoded</font>

692
00:24:05,930 --> 00:24:10,820
command<font color="#E5E5E5"> running within one of</font><font color="#CCCCCC"> those</font>

693
00:24:08,030 --> 00:24:13,250
logon sessions and so<font color="#E5E5E5"> I'll save you the</font>

694
00:24:10,820 --> 00:24:14,870
<font color="#CCCCCC">effort you could decode</font><font color="#E5E5E5"> that base64 and</font>

695
00:24:13,250 --> 00:24:17,210
it ends up being<font color="#CCCCCC"> an empire agent right</font>

696
00:24:14,870 --> 00:24:19,669
so we were able<font color="#E5E5E5"> to detect Empire without</font>

697
00:24:17,210 --> 00:24:20,450
<font color="#E5E5E5">actually like directly trying to detect</font>

698
00:24:19,670 --> 00:24:22,400
<font color="#E5E5E5">Empire</font>

699
00:24:20,450 --> 00:24:25,100
through a more<font color="#CCCCCC"> technique-driven kind of</font>

700
00:24:22,400 --> 00:24:26,060
focus<font color="#CCCCCC"> all right so that's</font><font color="#E5E5E5"> the end of our</font>

701
00:24:25,100 --> 00:24:28,790
time and that's the end<font color="#E5E5E5"> of our</font>

702
00:24:26,060 --> 00:24:30,379
presentation<font color="#CCCCCC"> we're</font><font color="#E5E5E5"> happy to stay outside</font>

703
00:24:28,790 --> 00:24:33,280
and<font color="#CCCCCC"> chat with anybody that</font><font color="#E5E5E5"> wants to talk</font>

704
00:24:30,380 --> 00:24:33,280
so thank you guys

