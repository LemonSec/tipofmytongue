1
00:00:00,500 --> 00:00:07,069
yep all<font color="#CCCCCC"> right so this is protect your</font>

2
00:00:04,080 --> 00:00:09,120
payloads modern<font color="#E5E5E5"> King techniques</font><font color="#CCCCCC"> I'm Leo</font>

3
00:00:07,069 --> 00:00:11,010
<font color="#E5E5E5">quick about me I'm a senior consultant</font>

4
00:00:09,120 --> 00:00:13,799
<font color="#CCCCCC">with per tippity executed more on the OP</font>

5
00:00:11,010 --> 00:00:15,928
the offensive<font color="#CCCCCC"> side so pen testing that</font>

6
00:00:13,799 --> 00:00:18,150
<font color="#E5E5E5">teaming that sort</font><font color="#CCCCCC"> of thing I really</font>

7
00:00:15,929 --> 00:00:20,250
enjoy<font color="#CCCCCC"> command and control</font><font color="#E5E5E5"> so I tend to</font>

8
00:00:18,150 --> 00:00:22,320
<font color="#E5E5E5">focus a lot</font><font color="#CCCCCC"> of my research</font><font color="#E5E5E5"> around custom</font>

9
00:00:20,250 --> 00:00:24,779
implant and<font color="#E5E5E5"> tooling around you know kind</font>

10
00:00:22,320 --> 00:00:27,300
<font color="#CCCCCC">of command and control casually blog at</font>

11
00:00:24,779 --> 00:00:29,070
<font color="#CCCCCC">adaptive</font><font color="#E5E5E5"> attack calm and just a warning</font>

12
00:00:27,300 --> 00:00:31,260
I'm not a crypto expert you don't have

13
00:00:29,070 --> 00:00:34,020
to worry<font color="#CCCCCC"> about any crazy math but what</font>

14
00:00:31,260 --> 00:00:34,890
<font color="#E5E5E5">we do have on</font><font color="#CCCCCC"> the docket today we're</font>

15
00:00:34,020 --> 00:00:36,239
<font color="#E5E5E5">basically looking at the current</font>

16
00:00:34,890 --> 00:00:38,790
landscape<font color="#E5E5E5"> of payload delivery and</font>

17
00:00:36,239 --> 00:00:41,218
development<font color="#CCCCCC"> kind of see where where King</font>

18
00:00:38,790 --> 00:00:43,230
fits in or<font color="#E5E5E5"> view how that works</font>

19
00:00:41,219 --> 00:00:45,300
you know<font color="#CCCCCC"> where</font><font color="#E5E5E5"> where the advantages are</font>

20
00:00:43,230 --> 00:00:47,099
then we'll add remote<font color="#CCCCCC"> resources to are</font>

21
00:00:45,300 --> 00:00:50,760
<font color="#E5E5E5">keyed payloads and I'll try</font><font color="#CCCCCC"> and tie it</font>

22
00:00:47,100 --> 00:00:51,960
together all at the<font color="#CCCCCC"> end here so I think</font>

23
00:00:50,760 --> 00:00:54,599
we can all agree that defense<font color="#CCCCCC"> is really</font>

24
00:00:51,960 --> 00:00:55,949
<font color="#E5E5E5">getting better</font><font color="#CCCCCC"> you</font><font color="#E5E5E5"> know - for me I think</font>

25
00:00:54,600 --> 00:00:57,840
it really<font color="#CCCCCC"> starts with</font><font color="#E5E5E5"> those endpoint</font>

26
00:00:55,949 --> 00:00:59,339
security products those er solutions

27
00:00:57,840 --> 00:01:01,230
like your crowd strikes your carbon

28
00:00:59,340 --> 00:01:03,660
blacks really<font color="#E5E5E5"> adding a lot of visibility</font>

29
00:01:01,230 --> 00:01:05,789
<font color="#CCCCCC">- two defenders being able to</font><font color="#E5E5E5"> pick off</font>

30
00:01:03,660 --> 00:01:07,920
things<font color="#E5E5E5"> that you know wasn't</font><font color="#CCCCCC"> I was</font>

31
00:01:05,790 --> 00:01:08,970
working<font color="#E5E5E5"> really well even a year ago and</font>

32
00:01:07,920 --> 00:01:11,280
you know that even rolls<font color="#E5E5E5"> into just</font>

33
00:01:08,970 --> 00:01:13,229
detection capabilities as a whole<font color="#E5E5E5"> you</font>

34
00:01:11,280 --> 00:01:15,299
know really like again like<font color="#CCCCCC"> a year ago I</font>

35
00:01:13,229 --> 00:01:16,798
felt like I was<font color="#CCCCCC"> very comfortable getting</font>

36
00:01:15,299 --> 00:01:18,960
<font color="#CCCCCC">a payload in an environment and</font><font color="#E5E5E5"> being</font>

37
00:01:16,799 --> 00:01:21,180
able to lie really<font color="#E5E5E5"> move around but we're</font>

38
00:01:18,960 --> 00:01:22,140
really getting detected<font color="#CCCCCC"> more and more</font><font color="#E5E5E5"> so</font>

39
00:01:21,180 --> 00:01:25,439
something that<font color="#E5E5E5"> we have to start</font>

40
00:01:22,140 --> 00:01:27,360
considering and<font color="#CCCCCC"> thinking about sandbox</font>

41
00:01:25,439 --> 00:01:29,399
<font color="#CCCCCC">saying we can argue</font><font color="#E5E5E5"> about whether you</font>

42
00:01:27,360 --> 00:01:31,110
know<font color="#E5E5E5"> it's easy to get around sandboxing</font>

43
00:01:29,400 --> 00:01:32,159
or not<font color="#E5E5E5"> but it's still</font><font color="#CCCCCC"> something you have</font>

44
00:01:31,110 --> 00:01:34,200
<font color="#E5E5E5">to consider when you're</font><font color="#CCCCCC"> trying to get</font>

45
00:01:32,159 --> 00:01:36,720
<font color="#CCCCCC">your payload down to</font><font color="#E5E5E5"> Donna be on target</font>

46
00:01:34,200 --> 00:01:38,509
so still increases more cost and more

47
00:01:36,720 --> 00:01:40,979
and<font color="#E5E5E5"> more time</font><font color="#CCCCCC"> on the attacker side</font>

48
00:01:38,509 --> 00:01:43,680
there's<font color="#CCCCCC"> virustotal</font><font color="#E5E5E5"> there's things in the</font>

49
00:01:40,979 --> 00:01:45,420
<font color="#E5E5E5">cloud there's machine learning it's just</font>

50
00:01:43,680 --> 00:01:46,590
<font color="#E5E5E5">super easy now to just throw a file up</font>

51
00:01:45,420 --> 00:01:49,140
in the cloud and it tells you if<font color="#E5E5E5"> the</font>

52
00:01:46,590 --> 00:01:50,729
file is good or bad<font color="#CCCCCC"> it'll also tell you</font>

53
00:01:49,140 --> 00:01:55,020
you know different execution behaviors

54
00:01:50,729 --> 00:01:56,610
what<font color="#CCCCCC"> servers</font><font color="#E5E5E5"> is calling back</font><font color="#CCCCCC"> to its ret</font>

55
00:01:55,020 --> 00:01:58,860
<font color="#E5E5E5">hunting is getting more prevalent</font><font color="#CCCCCC"> now</font><font color="#E5E5E5"> I</font>

56
00:01:56,610 --> 00:02:00,869
feel like<font color="#E5E5E5"> you know defenders are going</font>

57
00:01:58,860 --> 00:02:03,240
<font color="#CCCCCC">into</font><font color="#E5E5E5"> their environment</font><font color="#CCCCCC"> and like</font>

58
00:02:00,869 --> 00:02:05,159
expecting<font color="#E5E5E5"> you to be there so I feel like</font>

59
00:02:03,240 --> 00:02:06,600
<font color="#E5E5E5">you know if I get in you know get past</font>

60
00:02:05,159 --> 00:02:08,280
those<font color="#CCCCCC"> four</font><font color="#E5E5E5"> things you pass all the</font>

61
00:02:06,600 --> 00:02:09,929
detection capabilities get a foothold<font color="#E5E5E5"> in</font>

62
00:02:08,280 --> 00:02:11,459
the environment and<font color="#E5E5E5"> then a threat hunter</font>

63
00:02:09,929 --> 00:02:13,140
comes by and picks<font color="#E5E5E5"> off my</font><font color="#CCCCCC"> payload and</font>

64
00:02:11,459 --> 00:02:13,800
then kicks me out I think<font color="#CCCCCC"> that's</font>

65
00:02:13,140 --> 00:02:14,940
<font color="#E5E5E5">something that we're</font><font color="#CCCCCC"> going</font>

66
00:02:13,800 --> 00:02:17,730
<font color="#CCCCCC">have to start</font><font color="#E5E5E5"> running into you as well a</font>

67
00:02:14,940 --> 00:02:19,260
little<font color="#E5E5E5"> bit more innovative</font><font color="#CCCCCC"> tooling I</font>

68
00:02:17,730 --> 00:02:20,369
think blue<font color="#E5E5E5"> teams don't</font><font color="#CCCCCC"> grit and get</font>

69
00:02:19,260 --> 00:02:22,230
enough credit

70
00:02:20,370 --> 00:02:23,820
you know they identify their gas with

71
00:02:22,230 --> 00:02:26,489
detection capabilities then use three

72
00:02:23,820 --> 00:02:28,260
tools like sysinternals<font color="#CCCCCC"> or you know</font>

73
00:02:26,490 --> 00:02:29,670
<font color="#CCCCCC">Windows Event</font><font color="#E5E5E5"> porting to kind of close</font>

74
00:02:28,260 --> 00:02:32,190
those gaps<font color="#E5E5E5"> and still be able to detect</font>

75
00:02:29,670 --> 00:02:35,369
on things that<font color="#CCCCCC"> maybe</font><font color="#E5E5E5"> their current you</font>

76
00:02:32,190 --> 00:02:36,870
<font color="#E5E5E5">know paid for</font><font color="#CCCCCC"> product scan and that</font><font color="#E5E5E5"> kind</font>

77
00:02:35,370 --> 00:02:39,060
of<font color="#E5E5E5"> rolls into improved methodologies</font>

78
00:02:36,870 --> 00:02:39,810
<font color="#E5E5E5">mitre attack is really</font><font color="#CCCCCC"> a good</font><font color="#E5E5E5"> step in</font>

79
00:02:39,060 --> 00:02:42,000
the<font color="#E5E5E5"> right</font><font color="#CCCCCC"> direction</font>

80
00:02:39,810 --> 00:02:43,740
<font color="#E5E5E5">companies like red canary are releasing</font>

81
00:02:42,000 --> 00:02:46,350
<font color="#E5E5E5">all the ways they write robust</font>

82
00:02:43,740 --> 00:02:48,420
detections to essentially detect<font color="#E5E5E5"> you</font>

83
00:02:46,350 --> 00:02:49,590
know a little<font color="#E5E5E5"> bit better</font><font color="#CCCCCC"> and you know I</font>

84
00:02:48,420 --> 00:02:51,600
think that just<font color="#E5E5E5"> rolled in there just</font>

85
00:02:49,590 --> 00:02:53,850
general research there's more<font color="#E5E5E5"> blue team</font>

86
00:02:51,600 --> 00:02:55,980
talks there's more researchers on on

87
00:02:53,850 --> 00:02:57,780
<font color="#E5E5E5">Twitter they're talking about defense</font>

88
00:02:55,980 --> 00:02:59,399
and<font color="#E5E5E5"> you know they're grabbing pale it's</font>

89
00:02:57,780 --> 00:03:01,110
from virustotal and you know tweeting

90
00:02:59,400 --> 00:03:03,390
about<font color="#CCCCCC"> and analyzing those and sharing it</font>

91
00:03:01,110 --> 00:03:05,090
with everyone<font color="#E5E5E5"> so then this really</font><font color="#CCCCCC"> just</font>

92
00:03:03,390 --> 00:03:07,470
rolls into<font color="#E5E5E5"> my main first point</font>

93
00:03:05,090 --> 00:03:09,120
<font color="#E5E5E5">eventually doesn't</font><font color="#CCCCCC"> matter how elite you</font>

94
00:03:07,470 --> 00:03:10,470
are<font color="#E5E5E5"> you're gonna get caught</font><font color="#CCCCCC"> and your</font>

95
00:03:09,120 --> 00:03:12,420
code is gonna<font color="#E5E5E5"> be analyzed if you're</font>

96
00:03:10,470 --> 00:03:14,490
<font color="#E5E5E5">doing anything interesting and you know</font>

97
00:03:12,420 --> 00:03:15,869
why that<font color="#CCCCCC"> matters is like defenders have</font>

98
00:03:14,490 --> 00:03:18,060
ground rules<font color="#CCCCCC"> I think attackers have</font>

99
00:03:15,870 --> 00:03:20,550
crown jewels as well<font color="#E5E5E5"> you know first and</font>

100
00:03:18,060 --> 00:03:22,080
<font color="#E5E5E5">most obvious is command and control</font><font color="#CCCCCC"> so</font>

101
00:03:20,550 --> 00:03:24,000
<font color="#E5E5E5">the method that that payload is calling</font>

102
00:03:22,080 --> 00:03:26,040
<font color="#E5E5E5">back along with</font><font color="#CCCCCC"> what you know what</font>

103
00:03:24,000 --> 00:03:28,080
server<font color="#E5E5E5"> it's communicating to the moment</font>

104
00:03:26,040 --> 00:03:29,730
the<font color="#E5E5E5"> blue team finds that</font><font color="#CCCCCC"> you know</font>

105
00:03:28,080 --> 00:03:30,750
there's a good<font color="#E5E5E5"> chance</font><font color="#CCCCCC"> they</font><font color="#E5E5E5"> might be able</font>

106
00:03:29,730 --> 00:03:34,709
<font color="#CCCCCC">to</font><font color="#E5E5E5"> just get you out</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> their environment</font>

107
00:03:30,750 --> 00:03:36,300
entirely initial execution behavior<font color="#CCCCCC"> you</font>

108
00:03:34,709 --> 00:03:38,730
know<font color="#E5E5E5"> we're no longer just dropping a</font>

109
00:03:36,300 --> 00:03:40,739
<font color="#CCCCCC">single file or executing one process</font>

110
00:03:38,730 --> 00:03:42,540
<font color="#CCCCCC">that calls back to our situ seems to</font><font color="#E5E5E5"> be</font>

111
00:03:40,739 --> 00:03:44,520
there's a lot more links in the chain so

112
00:03:42,540 --> 00:03:46,500
you<font color="#CCCCCC"> know you're maybe</font><font color="#E5E5E5"> using process</font>

113
00:03:44,520 --> 00:03:48,630
hollowing and you're executing<font color="#E5E5E5"> that with</font>

114
00:03:46,500 --> 00:03:50,430
a scheduled<font color="#E5E5E5"> task and that and you know</font>

115
00:03:48,630 --> 00:03:51,840
with<font color="#E5E5E5"> that sort of execution behavior you</font>

116
00:03:50,430 --> 00:03:54,480
feel<font color="#CCCCCC"> comfortable getting</font><font color="#E5E5E5"> around</font><font color="#CCCCCC"> an ADR</font>

117
00:03:51,840 --> 00:03:55,950
<font color="#E5E5E5">solution and then you know there's some</font>

118
00:03:54,480 --> 00:03:57,988
individuals or teams that are even going

119
00:03:55,950 --> 00:03:59,100
<font color="#E5E5E5">the more custom implant route and that's</font>

120
00:03:57,989 --> 00:04:00,630
<font color="#E5E5E5">something you want</font><font color="#CCCCCC"> to keep</font><font color="#E5E5E5"> close to your</font>

121
00:03:59,100 --> 00:04:04,200
<font color="#CCCCCC">chest during</font><font color="#E5E5E5"> your red team engagement</font>

122
00:04:00,630 --> 00:04:05,430
you know<font color="#E5E5E5"> the whole way through you know</font>

123
00:04:04,200 --> 00:04:07,049
what I'm talking about

124
00:04:05,430 --> 00:04:09,570
you know like remote access code or

125
00:04:07,050 --> 00:04:11,670
payloads<font color="#E5E5E5"> the scope of this talks really</font>

126
00:04:09,570 --> 00:04:13,109
<font color="#E5E5E5">around</font><font color="#CCCCCC"> phishing and I think we're really</font>

127
00:04:11,670 --> 00:04:14,940
going you know<font color="#E5E5E5"> we're going with more</font>

128
00:04:13,110 --> 00:04:17,220
<font color="#CCCCCC">text-based</font><font color="#E5E5E5"> or scripting languages or</font>

129
00:04:14,940 --> 00:04:19,918
c-sharp to kind of execute<font color="#E5E5E5"> that first</font>

130
00:04:17,220 --> 00:04:22,049
stage<font color="#CCCCCC"> of</font><font color="#E5E5E5"> that payload</font><font color="#CCCCCC"> you know VBA</font>

131
00:04:19,918 --> 00:04:23,250
macros is obvious<font color="#E5E5E5"> you</font><font color="#CCCCCC"> know</font><font color="#E5E5E5"> something</font>

132
00:04:22,048 --> 00:04:25,289
<font color="#E5E5E5">that we've been</font><font color="#CCCCCC"> using it seems like for</font>

133
00:04:23,250 --> 00:04:27,660
<font color="#CCCCCC">almost 10 years or probably</font>

134
00:04:25,290 --> 00:04:29,550
longer<font color="#E5E5E5"> PowerShell is always popular and</font>

135
00:04:27,660 --> 00:04:30,750
<font color="#E5E5E5">obviously the technique there is just</font>

136
00:04:29,550 --> 00:04:32,130
<font color="#CCCCCC">stick that powershell one-liner</font>

137
00:04:30,750 --> 00:04:34,440
everywhere and anywhere<font color="#CCCCCC"> and hope it</font>

138
00:04:32,130 --> 00:04:37,890
executes somewhere<font color="#CCCCCC"> now we're getting</font>

139
00:04:34,440 --> 00:04:40,320
<font color="#E5E5E5">into JavaScript and</font><font color="#CCCCCC"> VB script</font><font color="#E5E5E5"> HTA's SCT</font>

140
00:04:37,890 --> 00:04:41,849
files extended style sheets<font color="#E5E5E5"> that's</font>

141
00:04:40,320 --> 00:04:44,370
allowing those those single commands

142
00:04:41,850 --> 00:04:46,470
still those<font color="#E5E5E5"> SIL one-liners that are</font>

143
00:04:44,370 --> 00:04:48,360
pulling the code down and executing

144
00:04:46,470 --> 00:04:51,540
another<font color="#E5E5E5"> c-sharp but that seems to be the</font>

145
00:04:48,360 --> 00:04:53,340
rage now so msbuild<font color="#E5E5E5"> dotnet to jscript to</font>

146
00:04:51,540 --> 00:04:55,530
get the power C sharp<font color="#CCCCCC"> within the</font>

147
00:04:53,340 --> 00:04:56,940
<font color="#CCCCCC">javascript payload but eventually we</font>

148
00:04:55,530 --> 00:04:58,650
<font color="#E5E5E5">want to get into memory right so that</font>

149
00:04:56,940 --> 00:05:00,719
would<font color="#CCCCCC"> be where we</font><font color="#E5E5E5"> we maybe use those</font>

150
00:04:58,650 --> 00:05:03,120
first<font color="#E5E5E5"> for bold items and then try</font><font color="#CCCCCC"> and</font>

151
00:05:00,720 --> 00:05:06,180
injector deal<font color="#CCCCCC"> our</font><font color="#E5E5E5"> shell code so we can</font>

152
00:05:03,120 --> 00:05:07,200
<font color="#E5E5E5">start doing some interesting things you</font>

153
00:05:06,180 --> 00:05:08,880
know one thing I've been thinking<font color="#CCCCCC"> about</font>

154
00:05:07,200 --> 00:05:10,170
lately and something I always<font color="#E5E5E5"> think</font>

155
00:05:08,880 --> 00:05:12,210
about<font color="#E5E5E5"> when I send that person first</font>

156
00:05:10,170 --> 00:05:14,160
<font color="#E5E5E5">phishing email is like what he data</font>

157
00:05:12,210 --> 00:05:15,870
<font color="#CCCCCC">point so</font><font color="#E5E5E5"> am I really losing the moment I</font>

158
00:05:14,160 --> 00:05:18,230
send<font color="#E5E5E5"> that phishing email and you know</font>

159
00:05:15,870 --> 00:05:21,030
who's gonna<font color="#E5E5E5"> see those key data points</font>

160
00:05:18,230 --> 00:05:24,450
<font color="#E5E5E5">and you</font><font color="#CCCCCC"> know this</font><font color="#E5E5E5"> kind</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> a you know one</font>

161
00:05:21,030 --> 00:05:26,669
one<font color="#CCCCCC"> illustration</font><font color="#E5E5E5"> to come up with is a</font>

162
00:05:24,450 --> 00:05:28,830
guy<font color="#CCCCCC"> on my team bases like</font><font color="#E5E5E5"> a that's my</font>

163
00:05:26,670 --> 00:05:31,770
macro and what he was<font color="#CCCCCC"> referring to</font><font color="#E5E5E5"> was a</font>

164
00:05:28,830 --> 00:05:33,210
tweet<font color="#E5E5E5"> by John Lambert basically he</font>

165
00:05:31,770 --> 00:05:33,900
pulled<font color="#CCCCCC"> down a file that he found in</font>

166
00:05:33,210 --> 00:05:35,849
virustotal

167
00:05:33,900 --> 00:05:39,000
<font color="#E5E5E5">and then he ended up analyzing and</font>

168
00:05:35,850 --> 00:05:39,930
throwing it<font color="#E5E5E5"> on his github and he went</font>

169
00:05:39,000 --> 00:05:42,390
through everything and he went through

170
00:05:39,930 --> 00:05:43,920
<font color="#CCCCCC">the</font><font color="#E5E5E5"> VBA so the VBA was pulling out like</font>

171
00:05:42,390 --> 00:05:46,140
a<font color="#E5E5E5"> payload from a text box within</font><font color="#CCCCCC"> the</font>

172
00:05:43,920 --> 00:05:48,210
word document<font color="#CCCCCC"> writing it to a temp file</font>

173
00:05:46,140 --> 00:05:50,460
and then executing it with register<font color="#E5E5E5"> for</font>

174
00:05:48,210 --> 00:05:52,799
32 but<font color="#E5E5E5"> here then he goes further he</font>

175
00:05:50,460 --> 00:05:55,049
pulls the the base64<font color="#E5E5E5"> encoded string</font>

176
00:05:52,800 --> 00:05:56,340
within<font color="#E5E5E5"> that file decodes it and if</font>

177
00:05:55,050 --> 00:05:58,590
you're<font color="#E5E5E5"> familiar with</font><font color="#CCCCCC"> Empire is pretty</font>

178
00:05:56,340 --> 00:06:01,679
<font color="#CCCCCC">obvious at this</font><font color="#E5E5E5"> point</font><font color="#CCCCCC"> it might</font><font color="#E5E5E5"> have been</font>

179
00:05:58,590 --> 00:06:02,760
<font color="#E5E5E5">doing some sort of Empire execution then</font>

180
00:06:01,680 --> 00:06:05,640
if you scroll down<font color="#CCCCCC"> further I mean</font>

181
00:06:02,760 --> 00:06:07,289
there's the domain<font color="#CCCCCC"> the</font><font color="#E5E5E5"> c2 host that it</font>

182
00:06:05,640 --> 00:06:08,909
was calling<font color="#E5E5E5"> back</font><font color="#CCCCCC"> to and some other</font>

183
00:06:07,290 --> 00:06:10,980
<font color="#E5E5E5">information so you know</font><font color="#CCCCCC"> I don't think</font>

184
00:06:08,910 --> 00:06:12,660
<font color="#E5E5E5">the guy</font><font color="#CCCCCC"> on my team</font><font color="#E5E5E5"> you know thought that</font>

185
00:06:10,980 --> 00:06:14,520
you know this payload would be seen by

186
00:06:12,660 --> 00:06:15,930
<font color="#CCCCCC">you know everyone when John Lambert you</font>

187
00:06:14,520 --> 00:06:20,909
didn't think of being a presentation at

188
00:06:15,930 --> 00:06:23,070
Derby<font color="#CCCCCC"> cons</font><font color="#E5E5E5"> so in like so not only it did</font>

189
00:06:20,910 --> 00:06:24,690
he you know did the the scope of who was

190
00:06:23,070 --> 00:06:26,610
able<font color="#CCCCCC"> to see</font><font color="#E5E5E5"> the payload kind of expand</font>

191
00:06:24,690 --> 00:06:28,560
but also he lost a lot<font color="#CCCCCC"> of key</font><font color="#E5E5E5"> data</font>

192
00:06:26,610 --> 00:06:30,330
points<font color="#CCCCCC"> just not</font><font color="#E5E5E5"> only the c2 server</font>

193
00:06:28,560 --> 00:06:32,610
it was obviously<font color="#CCCCCC"> is using</font><font color="#E5E5E5"> PowerShell</font>

194
00:06:30,330 --> 00:06:33,840
<font color="#E5E5E5">Empire so if the blue team saw that</font><font color="#CCCCCC"> on</font>

195
00:06:32,610 --> 00:06:35,250
they<font color="#E5E5E5"> can maybe start looking out</font>

196
00:06:33,840 --> 00:06:37,020
<font color="#E5E5E5">throughout their environment looking for</font>

197
00:06:35,250 --> 00:06:38,879
Empire<font color="#E5E5E5"> on they found out you know where</font>

198
00:06:37,020 --> 00:06:40,438
the macro is writing it<font color="#CCCCCC"> so</font>

199
00:06:38,879 --> 00:06:42,749
lots of<font color="#E5E5E5"> different things</font><font color="#CCCCCC"> that we're</font><font color="#E5E5E5"> just</font>

200
00:06:40,439 --> 00:06:43,949
kind of<font color="#E5E5E5"> sending in the clear</font><font color="#CCCCCC"> text and</font>

201
00:06:42,749 --> 00:06:46,080
you<font color="#E5E5E5"> can find a lot</font><font color="#CCCCCC"> more on</font><font color="#E5E5E5"> daily</font>

202
00:06:43,949 --> 00:06:47,429
scriptlet it's not just him<font color="#E5E5E5"> it's you</font>

203
00:06:46,080 --> 00:06:50,008
know<font color="#E5E5E5"> that it seems like every</font><font color="#CCCCCC"> day</font>

204
00:06:47,429 --> 00:06:51,958
there's<font color="#E5E5E5"> some sort of SCT or some other</font>

205
00:06:50,009 --> 00:06:55,830
<font color="#E5E5E5">site some or some other kind of file</font>

206
00:06:51,959 --> 00:06:56,939
<font color="#E5E5E5">that</font><font color="#CCCCCC"> Namah</font><font color="#E5E5E5"> being analyzed you know I</font>

207
00:06:55,830 --> 00:06:59,219
definitely<font color="#CCCCCC"> I definitely think</font>

208
00:06:56,939 --> 00:07:00,689
obfuscation fits in here<font color="#E5E5E5"> you know I</font>

209
00:06:59,219 --> 00:07:02,099
think that it's a it's a<font color="#E5E5E5"> really</font><font color="#CCCCCC"> great</font>

210
00:07:00,689 --> 00:07:04,110
technique<font color="#CCCCCC"> to defeat</font><font color="#E5E5E5"> those automated</font>

211
00:07:02,099 --> 00:07:06,270
solutions that are detecting on certain

212
00:07:04,110 --> 00:07:08,580
strings<font color="#E5E5E5"> can definitely slow down</font>

213
00:07:06,270 --> 00:07:09,839
defender analysis<font color="#CCCCCC"> you</font><font color="#E5E5E5"> know real-world</font>

214
00:07:08,580 --> 00:07:11,789
attackers are using the heck out of

215
00:07:09,839 --> 00:07:13,860
obfuscation so definitely<font color="#E5E5E5"> something you</font>

216
00:07:11,789 --> 00:07:15,628
want<font color="#CCCCCC"> to use on every</font><font color="#E5E5E5"> payload</font><font color="#CCCCCC"> you that</font>

217
00:07:13,860 --> 00:07:17,429
you're sending<font color="#E5E5E5"> obviously the</font>

218
00:07:15,629 --> 00:07:18,719
disadvantages<font color="#E5E5E5"> is if they understand how</font>

219
00:07:17,429 --> 00:07:20,489
the obfuscation works they're<font color="#E5E5E5"> going to</font>

220
00:07:18,719 --> 00:07:22,830
be able<font color="#E5E5E5"> to reverse it</font><font color="#CCCCCC"> get back to</font><font color="#E5E5E5"> that</font>

221
00:07:20,490 --> 00:07:24,689
original source<font color="#CCCCCC"> code and the other thing</font>

222
00:07:22,830 --> 00:07:26,998
is if you're<font color="#CCCCCC"> not adding</font><font color="#E5E5E5"> any anti</font>

223
00:07:24,689 --> 00:07:28,259
analysis code before you<font color="#E5E5E5"> obfuscate and</font>

224
00:07:26,999 --> 00:07:31,229
that pail gets thrown up to like

225
00:07:28,259 --> 00:07:32,459
<font color="#E5E5E5">virustotal those execution behaviors the</font>

226
00:07:31,229 --> 00:07:33,779
c2 connection they're still going to

227
00:07:32,459 --> 00:07:35,330
<font color="#CCCCCC">show up because</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> pail is still</font><font color="#E5E5E5"> gonna</font>

228
00:07:33,779 --> 00:07:38,099
<font color="#E5E5E5">actually cute as expected</font>

229
00:07:35,330 --> 00:07:39,568
so<font color="#E5E5E5"> Daniel Bohannon</font><font color="#CCCCCC"> doesn't have done a</font>

230
00:07:38,099 --> 00:07:41,369
lot<font color="#CCCCCC"> of great work around obfuscation</font>

231
00:07:39,569 --> 00:07:44,069
<font color="#CCCCCC">saying with Ryan</font><font color="#E5E5E5"> Cobb so definitely some</font>

232
00:07:41,369 --> 00:07:45,959
good guys to<font color="#E5E5E5"> follow around obfuscation</font>

233
00:07:44,069 --> 00:07:47,099
but what kind<font color="#CCCCCC"> of switch gears on into</font>

234
00:07:45,959 --> 00:07:50,699
keying you kind<font color="#CCCCCC"> of see where</font><font color="#E5E5E5"> that</font><font color="#CCCCCC"> were</font>

235
00:07:47,099 --> 00:07:52,769
that<font color="#E5E5E5"> fits in as well so</font><font color="#CCCCCC"> how would I kind</font>

236
00:07:50,699 --> 00:07:54,689
of describe keying<font color="#E5E5E5"> is basically you're</font>

237
00:07:52,769 --> 00:07:56,490
you're<font color="#CCCCCC"> encrypting your payloads</font><font color="#E5E5E5"> so that</font>

238
00:07:54,689 --> 00:07:58,469
they only execute on a specific<font color="#E5E5E5"> target</font>

239
00:07:56,490 --> 00:08:00,659
or only execute when you want them to

240
00:07:58,469 --> 00:08:02,969
and if<font color="#CCCCCC"> they don't it's</font><font color="#E5E5E5"> it's stayed</font>

241
00:08:00,659 --> 00:08:04,319
within an encrypted blob<font color="#E5E5E5"> so it's really</font>

242
00:08:02,969 --> 00:08:05,939
the idea<font color="#CCCCCC"> of encrypting your payloads</font>

243
00:08:04,319 --> 00:08:08,639
using local and remote<font color="#E5E5E5"> resources to</font>

244
00:08:05,939 --> 00:08:10,769
build<font color="#E5E5E5"> a decryption key on the target the</font>

245
00:08:08,639 --> 00:08:12,959
main downside<font color="#E5E5E5"> is the attacker might have</font>

246
00:08:10,769 --> 00:08:14,789
to figure out<font color="#E5E5E5"> some of this</font><font color="#CCCCCC"> information</font>

247
00:08:12,959 --> 00:08:16,289
ahead of<font color="#E5E5E5"> time so</font><font color="#CCCCCC"> if you want to</font><font color="#E5E5E5"> do</font>

248
00:08:14,789 --> 00:08:19,110
encrypt<font color="#E5E5E5"> your payload based on like an</font>

249
00:08:16,289 --> 00:08:19,829
<font color="#E5E5E5">environmental variable on the target you</font>

250
00:08:19,110 --> 00:08:21,419
would have to<font color="#CCCCCC"> know what that</font>

251
00:08:19,829 --> 00:08:25,019
environmental<font color="#E5E5E5"> variable was or your</font>

252
00:08:21,419 --> 00:08:26,339
payload wouldn't execute this sounds

253
00:08:25,019 --> 00:08:29,429
familiar<font color="#CCCCCC"> that's because</font><font color="#E5E5E5"> it definitely</font><font color="#CCCCCC"> is</font>

254
00:08:26,339 --> 00:08:31,169
it's not new back in 2016 Josh Pitts and

255
00:08:29,429 --> 00:08:33,598
<font color="#E5E5E5">Travis</font><font color="#CCCCCC"> Morrow presented exactly</font><font color="#E5E5E5"> about</font>

256
00:08:31,169 --> 00:08:35,880
this technique they really<font color="#E5E5E5"> brought this</font>

257
00:08:33,599 --> 00:08:38,430
technique to a more<font color="#CCCCCC"> practical use case</font>

258
00:08:35,880 --> 00:08:40,019
<font color="#E5E5E5">by releasing a tool like Ebola that</font><font color="#CCCCCC"> they</font>

259
00:08:38,429 --> 00:08:42,179
talked about different<font color="#E5E5E5"> research dating</font>

260
00:08:40,019 --> 00:08:44,459
all the way back to 1998<font color="#CCCCCC"> kind</font><font color="#E5E5E5"> of around</font>

261
00:08:42,179 --> 00:08:46,620
this but you know Ebola<font color="#E5E5E5"> was the first</font>

262
00:08:44,459 --> 00:08:49,829
you know real example that brought you

263
00:08:46,620 --> 00:08:52,410
know the<font color="#E5E5E5"> technique to us really</font><font color="#CCCCCC"> Gauss</font>

264
00:08:49,829 --> 00:08:55,500
was a<font color="#CCCCCC"> real-world</font><font color="#E5E5E5"> example</font><font color="#CCCCCC"> of our that</font><font color="#E5E5E5"> you</font>

265
00:08:52,410 --> 00:08:57,389
peeing back in 2012 and<font color="#E5E5E5"> that's</font><font color="#CCCCCC"> this one</font>

266
00:08:55,500 --> 00:08:58,949
<font color="#E5E5E5">if you're familiar Kaspersky actually</font>

267
00:08:57,389 --> 00:09:00,899
reached out to<font color="#E5E5E5"> the industry and said hey</font>

268
00:08:58,949 --> 00:09:03,300
can anybody please help us to quit this

269
00:09:00,899 --> 00:09:04,160
<font color="#E5E5E5">Paylor because we can so it's definitely</font>

270
00:09:03,300 --> 00:09:07,139
super<font color="#E5E5E5"> useful</font>

271
00:09:04,160 --> 00:09:09,029
<font color="#CCCCCC">ebolas still super awesome works</font><font color="#E5E5E5"> really</font>

272
00:09:07,139 --> 00:09:12,300
great<font color="#CCCCCC"> I actually use</font><font color="#E5E5E5"> it a couple</font><font color="#CCCCCC"> months</font>

273
00:09:09,029 --> 00:09:13,949
ago<font color="#E5E5E5"> and it did hit up on virustotal</font>

274
00:09:12,300 --> 00:09:16,170
I'm still not<font color="#E5E5E5"> a whole lot of detections</font>

275
00:09:13,949 --> 00:09:17,639
I think it was still 0<font color="#E5E5E5"> so antivirus is</font>

276
00:09:16,170 --> 00:09:19,800
still having<font color="#CCCCCC"> a tough time detecting the</font>

277
00:09:17,639 --> 00:09:21,720
payloads<font color="#E5E5E5"> does a great job encrypting</font>

278
00:09:19,800 --> 00:09:23,339
your dll's your<font color="#CCCCCC"> exeed your shellcode and</font>

279
00:09:21,720 --> 00:09:25,319
<font color="#CCCCCC">then it kind of gives</font><font color="#E5E5E5"> you an output</font><font color="#CCCCCC"> in a</font>

280
00:09:23,339 --> 00:09:28,829
binary<font color="#E5E5E5"> that's produced</font><font color="#CCCCCC"> by a NGO or</font>

281
00:09:25,319 --> 00:09:30,449
Python<font color="#E5E5E5"> or our PowerShell</font><font color="#CCCCCC"> script so huge</font>

282
00:09:28,829 --> 00:09:32,609
thanks<font color="#CCCCCC"> to Josh and</font><font color="#E5E5E5"> Travis for kind</font><font color="#CCCCCC"> of</font>

283
00:09:30,449 --> 00:09:35,758
<font color="#E5E5E5">giving us a really first good practical</font>

284
00:09:32,610 --> 00:09:37,709
<font color="#E5E5E5">use case for for keying you</font><font color="#CCCCCC"> probably</font>

285
00:09:35,759 --> 00:09:39,839
<font color="#E5E5E5">wondering well why am</font><font color="#CCCCCC"> I here you know I</font>

286
00:09:37,709 --> 00:09:41,339
know given the<font color="#E5E5E5"> spongebob slide in</font>

287
00:09:39,839 --> 00:09:43,319
particular<font color="#CCCCCC"> I think Kings needed now more</font>

288
00:09:41,339 --> 00:09:45,689
than ever<font color="#CCCCCC"> we really need to protect our</font>

289
00:09:43,319 --> 00:09:47,819
code that we're<font color="#E5E5E5"> sending down to</font><font color="#CCCCCC"> tor</font>

290
00:09:45,689 --> 00:09:49,230
targets<font color="#E5E5E5"> and you know I just</font><font color="#CCCCCC"> kind of when</font>

291
00:09:47,819 --> 00:09:50,670
using<font color="#E5E5E5"> this now for about a year and a</font>

292
00:09:49,230 --> 00:09:53,069
half so I just figured<font color="#E5E5E5"> I'd kind of share</font>

293
00:09:50,670 --> 00:09:54,329
some experiences use<font color="#E5E5E5"> cases most you guys</font>

294
00:09:53,069 --> 00:09:56,099
are<font color="#CCCCCC"> probably smarter than I am</font><font color="#E5E5E5"> so</font>

295
00:09:54,329 --> 00:09:58,170
hopefully this will<font color="#CCCCCC"> help</font><font color="#E5E5E5"> you guys come</font>

296
00:09:56,100 --> 00:09:59,399
up<font color="#CCCCCC"> with ways you can use it you know</font>

297
00:09:58,170 --> 00:10:02,160
just<font color="#CCCCCC"> with talking with people</font><font color="#E5E5E5"> as well</font>

298
00:09:59,399 --> 00:10:03,449
<font color="#E5E5E5">about using keying</font><font color="#CCCCCC"> I feel like a lot of</font>

299
00:10:02,160 --> 00:10:04,829
<font color="#E5E5E5">the common responses are you know they</font>

300
00:10:03,449 --> 00:10:06,899
<font color="#E5E5E5">only understand that it gets around</font>

301
00:10:04,829 --> 00:10:09,420
<font color="#CCCCCC">sandboxes might not understand other use</font>

302
00:10:06,899 --> 00:10:12,149
cases<font color="#E5E5E5"> it's a cool idea but it seems like</font>

303
00:10:09,420 --> 00:10:13,319
a lot of work they don't<font color="#E5E5E5"> get it or you</font>

304
00:10:12,149 --> 00:10:14,670
know they're<font color="#E5E5E5"> using they're using it a</font>

305
00:10:13,319 --> 00:10:16,380
lot<font color="#E5E5E5"> and they're just not really talking</font>

306
00:10:14,670 --> 00:10:19,170
about<font color="#E5E5E5"> it publicly so I just kind of want</font>

307
00:10:16,380 --> 00:10:21,149
<font color="#CCCCCC">to bring it back out</font><font color="#E5E5E5"> here so I'm gonna</font>

308
00:10:19,170 --> 00:10:22,589
<font color="#CCCCCC">hit King at a kind of</font><font color="#E5E5E5"> a more</font><font color="#CCCCCC"> high level</font>

309
00:10:21,149 --> 00:10:24,990
if you kind of want more of an in-depth

310
00:10:22,589 --> 00:10:27,389
understanding of kind<font color="#CCCCCC"> of how he</font><font color="#E5E5E5"> works at</font>

311
00:10:24,990 --> 00:10:29,069
<font color="#E5E5E5">the the payload and code level</font>

312
00:10:27,389 --> 00:10:32,250
<font color="#E5E5E5">I'm definitely take a look at the slides</font>

313
00:10:29,069 --> 00:10:33,599
from<font color="#E5E5E5"> Josh and Travis the Ebola project</font>

314
00:10:32,250 --> 00:10:36,660
<font color="#E5E5E5">they have their slides and then there's</font>

315
00:10:33,600 --> 00:10:39,779
a<font color="#E5E5E5"> YouTube video as well</font>

316
00:10:36,660 --> 00:10:41,850
so we'll go<font color="#CCCCCC"> ahead and go with an</font><font color="#E5E5E5"> example</font>

317
00:10:39,779 --> 00:10:44,459
here let's say you're trying<font color="#E5E5E5"> to target a</font>

318
00:10:41,850 --> 00:10:45,959
specific VP of ecore and<font color="#CCCCCC"> 300 cent you</font>

319
00:10:44,459 --> 00:10:48,119
discovered<font color="#CCCCCC"> that he uses</font><font color="#E5E5E5"> Microsoft</font>

320
00:10:45,959 --> 00:10:50,489
Project<font color="#E5E5E5"> and you know what office version</font>

321
00:10:48,120 --> 00:10:52,889
so you know that that that file path

322
00:10:50,490 --> 00:10:56,250
will exist<font color="#E5E5E5"> on the target you also know</font>

323
00:10:52,889 --> 00:10:57,660
<font color="#CCCCCC">that his user name</font><font color="#E5E5E5"> is</font><font color="#CCCCCC"> J doe so basically</font>

324
00:10:56,250 --> 00:11:00,559
the attackers can<font color="#E5E5E5"> encrypt his</font><font color="#CCCCCC"> pail it's</font>

325
00:10:57,660 --> 00:11:03,209
what<font color="#E5E5E5"> only</font><font color="#CCCCCC"> executes on that system</font>

326
00:11:00,559 --> 00:11:05,339
so first the attacker would go ahead<font color="#E5E5E5"> and</font>

327
00:11:03,209 --> 00:11:06,040
<font color="#CCCCCC">create</font><font color="#E5E5E5"> the encrypted data on his side</font><font color="#CCCCCC"> so</font>

328
00:11:05,339 --> 00:11:07,540
I'm

329
00:11:06,040 --> 00:11:09,310
<font color="#E5E5E5">you can't use that string as a key</font>

330
00:11:07,540 --> 00:11:11,769
<font color="#E5E5E5">because you're gonna need 32 characters</font>

331
00:11:09,310 --> 00:11:14,018
so<font color="#E5E5E5"> you hash the key data and use the</font>

332
00:11:11,769 --> 00:11:17,199
first<font color="#E5E5E5"> 32 characters because AES</font>

333
00:11:14,019 --> 00:11:18,970
encryption<font color="#E5E5E5"> 32 characters key length then</font>

334
00:11:17,199 --> 00:11:22,420
you<font color="#E5E5E5"> encrypt the payload with that first</font>

335
00:11:18,970 --> 00:11:24,339
<font color="#E5E5E5">32 characters of the hash now that you</font>

336
00:11:22,420 --> 00:11:25,630
<font color="#CCCCCC">have it the encrypted data</font><font color="#E5E5E5"> you can</font>

337
00:11:24,339 --> 00:11:27,790
<font color="#E5E5E5">create the key</font><font color="#CCCCCC"> field that</font><font color="#E5E5E5"> you want to</font>

338
00:11:25,630 --> 00:11:29,740
execute<font color="#CCCCCC"> I'm J</font><font color="#E5E5E5"> Dilla's workstation so</font>

339
00:11:27,790 --> 00:11:31,449
basically<font color="#E5E5E5"> I'll create functions on the</font>

340
00:11:29,740 --> 00:11:33,940
host that<font color="#E5E5E5"> will basically pull that key</font>

341
00:11:31,449 --> 00:11:36,040
data out so get<font color="#E5E5E5"> the value for the</font>

342
00:11:33,940 --> 00:11:37,569
environmental variable<font color="#E5E5E5"> username and then</font>

343
00:11:36,040 --> 00:11:39,370
let's<font color="#E5E5E5"> just get all the paths underneath</font>

344
00:11:37,569 --> 00:11:41,410
<font color="#CCCCCC">C program files all the</font><font color="#E5E5E5"> recursive</font>

345
00:11:39,370 --> 00:11:43,959
passing<font color="#E5E5E5"> our needs and then the payload</font>

346
00:11:41,410 --> 00:11:45,040
<font color="#E5E5E5">when it executes it'll basically you'll</font>

347
00:11:43,959 --> 00:11:47,560
loop through<font color="#CCCCCC"> every single thing</font>

348
00:11:45,040 --> 00:11:50,110
underneath<font color="#E5E5E5"> C program files tack on the</font>

349
00:11:47,560 --> 00:11:51,670
value for username<font color="#E5E5E5"> try to decrypt</font><font color="#CCCCCC"> if it</font>

350
00:11:50,110 --> 00:11:54,040
doesn't work<font color="#E5E5E5"> it'll just move on to</font><font color="#CCCCCC"> the</font>

351
00:11:51,670 --> 00:11:55,240
<font color="#E5E5E5">next</font><font color="#CCCCCC"> one</font><font color="#E5E5E5"> so if that what that</font><font color="#CCCCCC"> would</font><font color="#E5E5E5"> kind</font>

352
00:11:54,040 --> 00:11:56,920
of look<font color="#E5E5E5"> like is you know let's say</font>

353
00:11:55,240 --> 00:11:59,560
application<font color="#E5E5E5"> verify</font><font color="#CCCCCC"> is the first folder</font>

354
00:11:56,920 --> 00:12:01,300
path underneath C program files attack

355
00:11:59,560 --> 00:12:03,969
on<font color="#CCCCCC"> jeido if this was execute</font><font color="#E5E5E5"> on Jada's</font>

356
00:12:01,300 --> 00:12:05,979
workstation trying to crypt<font color="#E5E5E5"> doesn't work</font>

357
00:12:03,970 --> 00:12:08,639
<font color="#E5E5E5">keeps bumping down the list</font><font color="#CCCCCC"> until you</font>

358
00:12:05,980 --> 00:12:11,829
<font color="#CCCCCC">finally find the Microsoft</font><font color="#E5E5E5"> Project file</font>

359
00:12:08,639 --> 00:12:13,779
<font color="#E5E5E5">hash that with</font><font color="#CCCCCC"> jeido</font><font color="#E5E5E5"> use the pursuit</font>

360
00:12:11,829 --> 00:12:16,420
<font color="#E5E5E5">characters it decrypts and executes sand</font>

361
00:12:13,779 --> 00:12:19,300
and the decrypted payload works<font color="#CCCCCC"> so</font>

362
00:12:16,420 --> 00:12:20,500
<font color="#E5E5E5">that's kind of keying in a nutshell</font><font color="#CCCCCC"> you</font>

363
00:12:19,300 --> 00:12:22,810
know the<font color="#E5E5E5"> information disclosed in the</font>

364
00:12:20,500 --> 00:12:25,420
<font color="#E5E5E5">final payload is the methods to retrieve</font>

365
00:12:22,810 --> 00:12:26,829
the key values but<font color="#E5E5E5"> not the actual values</font>

366
00:12:25,420 --> 00:12:29,949
themselves<font color="#E5E5E5"> and obviously not the</font>

367
00:12:26,829 --> 00:12:31,300
original payload<font color="#CCCCCC"> you know the main</font>

368
00:12:29,949 --> 00:12:33,459
takeaways here<font color="#CCCCCC"> is</font><font color="#E5E5E5"> that pail is very</font>

369
00:12:31,300 --> 00:12:35,920
target specific<font color="#CCCCCC"> it's not going to</font>

370
00:12:33,459 --> 00:12:38,079
execute<font color="#CCCCCC"> in virus Toller and sandboxing</font>

371
00:12:35,920 --> 00:12:40,689
it might<font color="#E5E5E5"> even have difficulty</font><font color="#CCCCCC"> in the</font>

372
00:12:38,079 --> 00:12:42,310
incident responders system and then also

373
00:12:40,690 --> 00:12:44,019
<font color="#CCCCCC">from an attribution perspective which is</font>

374
00:12:42,310 --> 00:12:46,689
<font color="#E5E5E5">kind of interesting</font><font color="#CCCCCC"> if you sent that</font>

375
00:12:44,019 --> 00:12:50,560
<font color="#E5E5E5">same payload to all VPS of ecore or say</font>

376
00:12:46,690 --> 00:12:51,970
all VPS of the fortune 50 and<font color="#CCCCCC"> eek or it</font>

377
00:12:50,560 --> 00:12:53,439
would be<font color="#E5E5E5"> difficult to</font><font color="#CCCCCC"> attribute who the</font>

378
00:12:51,970 --> 00:12:54,910
actual<font color="#CCCCCC"> target was because it's only</font>

379
00:12:53,439 --> 00:12:58,719
executing on<font color="#CCCCCC"> the one person</font><font color="#E5E5E5"> that you</font>

380
00:12:54,910 --> 00:13:01,060
<font color="#E5E5E5">were</font><font color="#CCCCCC"> we were targeting so</font><font color="#E5E5E5"> I think a</font>

381
00:12:58,720 --> 00:13:02,800
necessary discussion with keying is you

382
00:13:01,060 --> 00:13:05,829
know kind of<font color="#E5E5E5"> around compiled</font><font color="#CCCCCC"> versus</font>

383
00:13:02,800 --> 00:13:07,810
scripting so Ebola outputs to a compiled

384
00:13:05,829 --> 00:13:10,300
binary generator<font color="#E5E5E5"> from Python your goal</font>

385
00:13:07,810 --> 00:13:12,849
which is<font color="#CCCCCC"> really ideal</font><font color="#E5E5E5"> because</font><font color="#CCCCCC"> you know</font>

386
00:13:10,300 --> 00:13:14,529
if you execute<font color="#E5E5E5"> a binary some XE file and</font>

387
00:13:12,850 --> 00:13:15,850
it does nothing<font color="#E5E5E5"> well then you're gonna</font>

388
00:13:14,529 --> 00:13:17,680
<font color="#E5E5E5">have to</font><font color="#CCCCCC"> figure out</font><font color="#E5E5E5"> you're gonna have to</font>

389
00:13:15,850 --> 00:13:19,390
pull<font color="#E5E5E5"> off some analysis tools you might</font>

390
00:13:17,680 --> 00:13:20,920
<font color="#E5E5E5">have to pull out some</font><font color="#CCCCCC"> reverse-engineer</font>

391
00:13:19,390 --> 00:13:22,660
tools<font color="#E5E5E5"> and figure out what's going on and</font>

392
00:13:20,920 --> 00:13:24,610
<font color="#E5E5E5">then you might add your chairman that</font>

393
00:13:22,660 --> 00:13:25,930
<font color="#CCCCCC">Kings in play then</font><font color="#E5E5E5"> you might</font><font color="#CCCCCC"> have to you</font>

394
00:13:24,610 --> 00:13:27,700
<font color="#E5E5E5">know so you have to keep going down</font><font color="#CCCCCC"> that</font>

395
00:13:25,930 --> 00:13:30,099
road<font color="#CCCCCC"> where with if you're King a</font>

396
00:13:27,700 --> 00:13:32,980
<font color="#CCCCCC">text-based build like a</font><font color="#E5E5E5"> c-sharp or a</font>

397
00:13:30,100 --> 00:13:34,540
JavaScript<font color="#CCCCCC"> Caleb it's pretty</font><font color="#E5E5E5"> obvious</font>

398
00:13:32,980 --> 00:13:37,360
right away<font color="#E5E5E5"> if you're not using any</font>

399
00:13:34,540 --> 00:13:39,069
<font color="#E5E5E5">obfuscation that Kings being used</font><font color="#CCCCCC"> um you</font>

400
00:13:37,360 --> 00:13:40,780
can find the encryption<font color="#E5E5E5"> functions so you</font>

401
00:13:39,070 --> 00:13:43,330
<font color="#CCCCCC">know taking that a step further if you</font>

402
00:13:40,780 --> 00:13:45,819
saw that<font color="#E5E5E5"> in</font><font color="#CCCCCC"> PowerShell script</font><font color="#E5E5E5"> that you</font>

403
00:13:43,330 --> 00:13:47,110
were creating a keyed payload<font color="#E5E5E5"> and you're</font>

404
00:13:45,820 --> 00:13:49,300
basically<font color="#E5E5E5"> decrypting on those three</font>

405
00:13:47,110 --> 00:13:50,890
environmental variables well and you saw

406
00:13:49,300 --> 00:13:52,719
<font color="#CCCCCC">the sent through fishing</font><font color="#E5E5E5"> from the blue</font>

407
00:13:50,890 --> 00:13:53,890
<font color="#CCCCCC">team side</font><font color="#E5E5E5"> well you could</font><font color="#CCCCCC"> just go on each</font>

408
00:13:52,720 --> 00:13:55,420
one<font color="#E5E5E5"> of those systems</font><font color="#CCCCCC"> pull</font><font color="#E5E5E5"> those</font>

409
00:13:53,890 --> 00:13:57,640
environmental<font color="#E5E5E5"> variables down try</font><font color="#CCCCCC"> each</font>

410
00:13:55,420 --> 00:14:00,040
<font color="#CCCCCC">one and so</font><font color="#E5E5E5"> if</font><font color="#CCCCCC"> they like decrypt</font><font color="#E5E5E5"> and</font>

411
00:13:57,640 --> 00:14:01,240
you'd<font color="#E5E5E5"> have that decrypted payload if you</font>

412
00:14:00,040 --> 00:14:02,560
find<font color="#E5E5E5"> its persistence would be even</font>

413
00:14:01,240 --> 00:14:04,300
easier<font color="#E5E5E5"> you just go to that system that</font>

414
00:14:02,560 --> 00:14:05,619
<font color="#E5E5E5">has persistence on pull those</font>

415
00:14:04,300 --> 00:14:07,150
environmental<font color="#E5E5E5"> variables off and you'd</font>

416
00:14:05,620 --> 00:14:09,760
<font color="#CCCCCC">easily you know be able to decrypt</font><font color="#E5E5E5"> that</font>

417
00:14:07,150 --> 00:14:12,160
payload so this is kind of where you got

418
00:14:09,760 --> 00:14:13,600
<font color="#E5E5E5">to add a little tomfoolery in there so</font>

419
00:14:12,160 --> 00:14:16,180
basically we're gonna get all the

420
00:14:13,600 --> 00:14:18,910
combinations of<font color="#E5E5E5"> username computer name</font>

421
00:14:16,180 --> 00:14:20,199
<font color="#E5E5E5">and user</font><font color="#CCCCCC"> dns domain</font><font color="#E5E5E5"> so from those those</font>

422
00:14:18,910 --> 00:14:22,240
<font color="#E5E5E5">three values that was really just</font>

423
00:14:20,200 --> 00:14:24,700
<font color="#E5E5E5">looking like one key now it turns out to</font>

424
00:14:22,240 --> 00:14:26,290
those<font color="#E5E5E5"> seven</font><font color="#CCCCCC"> possible</font><font color="#E5E5E5"> keys and what's</font>

425
00:14:24,700 --> 00:14:28,240
really<font color="#E5E5E5"> nice is you can</font><font color="#CCCCCC"> use blank values</font>

426
00:14:26,290 --> 00:14:29,530
so let's say I only knew the<font color="#CCCCCC"> user name</font>

427
00:14:28,240 --> 00:14:31,840
<font color="#CCCCCC">and the</font><font color="#E5E5E5"> computer name but I did not know</font>

428
00:14:29,530 --> 00:14:33,339
<font color="#CCCCCC">the user</font><font color="#E5E5E5"> DNS domain</font><font color="#CCCCCC"> I could just encrypt</font>

429
00:14:31,840 --> 00:14:35,620
those two but blue team<font color="#E5E5E5"> would think</font><font color="#CCCCCC"> I</font>

430
00:14:33,340 --> 00:14:37,960
cryptid with all three<font color="#E5E5E5"> and this was a</font>

431
00:14:35,620 --> 00:14:40,270
really really really<font color="#E5E5E5"> bad example what if</font>

432
00:14:37,960 --> 00:14:41,500
a corpse saw this<font color="#E5E5E5"> payload that was</font>

433
00:14:40,270 --> 00:14:43,480
encrypted with two<font color="#E5E5E5"> environmental</font>

434
00:14:41,500 --> 00:14:45,280
variables<font color="#E5E5E5"> getting the time getting the</font>

435
00:14:43,480 --> 00:14:47,410
sit of<font color="#E5E5E5"> the user and getting the IP</font>

436
00:14:45,280 --> 00:14:48,610
address<font color="#E5E5E5"> of some post name on there you</font>

437
00:14:47,410 --> 00:14:49,839
<font color="#CCCCCC">bait you're</font><font color="#E5E5E5"> basically</font><font color="#CCCCCC"> sending them on</font>

438
00:14:48,610 --> 00:14:50,860
like an Easter egg hunt because<font color="#E5E5E5"> they're</font>

439
00:14:49,840 --> 00:14:51,340
gonna<font color="#E5E5E5"> have to track</font><font color="#CCCCCC"> down all those</font>

440
00:14:50,860 --> 00:14:53,440
things

441
00:14:51,340 --> 00:14:54,640
- hopefully decrypt the payload<font color="#E5E5E5"> when</font>

442
00:14:53,440 --> 00:14:55,990
<font color="#CCCCCC">really the attacker just knew the</font>

443
00:14:54,640 --> 00:14:58,180
username<font color="#E5E5E5"> and the city of the user</font><font color="#CCCCCC"> from</font>

444
00:14:55,990 --> 00:15:00,940
<font color="#CCCCCC">something and</font><font color="#E5E5E5"> basically</font><font color="#CCCCCC"> only use that</font><font color="#E5E5E5"> to</font>

445
00:14:58,180 --> 00:15:02,739
decrypt<font color="#E5E5E5"> on top of that you can</font><font color="#CCCCCC"> just</font>

446
00:15:00,940 --> 00:15:04,060
<font color="#CCCCCC">throw on a bunch</font><font color="#E5E5E5"> of bogus information I</font>

447
00:15:02,740 --> 00:15:06,280
mean<font color="#E5E5E5"> we're getting the</font><font color="#CCCCCC"> hostname of</font>

448
00:15:04,060 --> 00:15:07,959
<font color="#E5E5E5">Internet peso comm so maybe</font><font color="#CCCCCC"> e Corp would</font>

449
00:15:06,280 --> 00:15:09,640
be like well maybe<font color="#E5E5E5"> this target wasn't</font>

450
00:15:07,960 --> 00:15:13,900
<font color="#E5E5E5">even for us we don't have that host here</font>

451
00:15:09,640 --> 00:15:15,730
maybe they're targeting Tesla so so kind

452
00:15:13,900 --> 00:15:18,819
<font color="#CCCCCC">of building</font><font color="#E5E5E5"> on the combinations idea</font>

453
00:15:15,730 --> 00:15:20,560
<font color="#CCCCCC">I built a tool called</font><font color="#E5E5E5"> keyring</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> what I</font>

454
00:15:18,820 --> 00:15:23,020
really like<font color="#CCCCCC"> about it</font><font color="#E5E5E5"> is allowing</font><font color="#CCCCCC"> for</font>

455
00:15:20,560 --> 00:15:24,670
more<font color="#E5E5E5"> custom keying functions</font><font color="#CCCCCC"> so</font>

456
00:15:23,020 --> 00:15:26,170
sometimes you know when you when you're

457
00:15:24,670 --> 00:15:27,640
<font color="#E5E5E5">doing OSINT you might not find the</font>

458
00:15:26,170 --> 00:15:29,800
information<font color="#CCCCCC"> that you could use for like</font>

459
00:15:27,640 --> 00:15:31,480
Ebola<font color="#CCCCCC"> I wanted</font><font color="#E5E5E5"> to make it a little bit</font>

460
00:15:29,800 --> 00:15:32,109
more efficient fast for red teamers to

461
00:15:31,480 --> 00:15:33,370
get creative

462
00:15:32,110 --> 00:15:35,620
<font color="#E5E5E5">create their</font><font color="#CCCCCC"> own</font>

463
00:15:33,370 --> 00:15:36,940
keying<font color="#E5E5E5"> encryption decryption functions</font>

464
00:15:35,620 --> 00:15:38,950
and not have to worry<font color="#E5E5E5"> about the</font>

465
00:15:36,940 --> 00:15:41,020
encryption itself<font color="#E5E5E5"> and I currently</font>

466
00:15:38,950 --> 00:15:42,100
<font color="#E5E5E5">support c-sharp JavaScript and</font>

467
00:15:41,020 --> 00:15:43,810
PowerShell and<font color="#CCCCCC"> I just feel like I should</font>

468
00:15:42,100 --> 00:15:46,570
<font color="#E5E5E5">note that the JavaScript uses</font>

469
00:15:43,810 --> 00:15:48,729
self-contained<font color="#CCCCCC"> Kham Kham objects</font><font color="#E5E5E5"> not</font><font color="#CCCCCC"> dot</font>

470
00:15:46,570 --> 00:15:51,000
<font color="#E5E5E5">not</font><font color="#CCCCCC"> to jscript so</font><font color="#E5E5E5"> you don't have to</font>

471
00:15:48,730 --> 00:15:54,220
worry about<font color="#E5E5E5"> any signatures around that</font>

472
00:15:51,000 --> 00:15:56,080
there is some<font color="#CCCCCC"> vocabulary so a keen</font>

473
00:15:54,220 --> 00:15:57,970
<font color="#E5E5E5">function that returns only one string</font>

474
00:15:56,080 --> 00:16:00,160
would<font color="#E5E5E5"> be called a combo so that would be</font>

475
00:15:57,970 --> 00:16:01,300
like<font color="#E5E5E5"> your environmental variables</font><font color="#CCCCCC"> and</font>

476
00:16:00,160 --> 00:16:03,670
then your<font color="#CCCCCC"> king function that would</font>

477
00:16:01,300 --> 00:16:05,740
<font color="#E5E5E5">return a chain like a string of arrays</font>

478
00:16:03,670 --> 00:16:06,969
one or more<font color="#E5E5E5"> strings</font><font color="#CCCCCC"> would</font><font color="#E5E5E5"> be called a</font>

479
00:16:05,740 --> 00:16:09,160
chain so that<font color="#E5E5E5"> might be like your</font>

480
00:16:06,970 --> 00:16:12,120
directory listings<font color="#E5E5E5"> and currently keyring</font>

481
00:16:09,160 --> 00:16:13,930
supports one chain<font color="#CCCCCC"> and unlimited combos</font>

482
00:16:12,120 --> 00:16:15,850
kind<font color="#E5E5E5"> of how that decryption process</font>

483
00:16:13,930 --> 00:16:18,279
<font color="#CCCCCC">would look like</font><font color="#E5E5E5"> basically</font><font color="#CCCCCC"> it</font><font color="#E5E5E5"> just builds</font>

484
00:16:15,850 --> 00:16:20,350
two arrays and<font color="#CCCCCC"> then we</font><font color="#E5E5E5"> basically</font><font color="#CCCCCC"> just</font>

485
00:16:18,279 --> 00:16:22,210
add on all the combo functions then<font color="#E5E5E5"> we</font>

486
00:16:20,350 --> 00:16:24,010
generate<font color="#E5E5E5"> all combinations so you know we</font>

487
00:16:22,210 --> 00:16:26,440
get<font color="#E5E5E5"> that</font><font color="#CCCCCC"> longer</font><font color="#E5E5E5"> list of possible</font>

488
00:16:24,010 --> 00:16:28,270
combinations<font color="#E5E5E5"> and then we we add our</font>

489
00:16:26,440 --> 00:16:30,760
<font color="#E5E5E5">chain as well so in this</font><font color="#CCCCCC"> example we're</font>

490
00:16:28,270 --> 00:16:32,140
<font color="#CCCCCC">using get running</font><font color="#E5E5E5"> processes so basically</font>

491
00:16:30,760 --> 00:16:33,400
we're just running<font color="#CCCCCC"> through you know for</font>

492
00:16:32,140 --> 00:16:35,920
each<font color="#E5E5E5"> running process we're</font><font color="#CCCCCC"> going to try</font>

493
00:16:33,400 --> 00:16:37,480
each<font color="#CCCCCC"> combination and decrypt</font><font color="#E5E5E5"> each time</font>

494
00:16:35,920 --> 00:16:39,550
<font color="#E5E5E5">and if none of</font><font color="#CCCCCC"> it works they'll just</font>

495
00:16:37,480 --> 00:16:41,140
move on<font color="#CCCCCC"> to the next</font><font color="#E5E5E5"> running process try</font>

496
00:16:39,550 --> 00:16:44,079
each<font color="#CCCCCC"> combination and you know until</font><font color="#E5E5E5"> it</font>

497
00:16:41,140 --> 00:16:45,339
either finds it or it doesn't<font color="#E5E5E5"> this is a</font>

498
00:16:44,080 --> 00:16:47,320
good point<font color="#E5E5E5"> to just talk about</font><font color="#CCCCCC"> some</font><font color="#E5E5E5"> key</font>

499
00:16:45,339 --> 00:16:50,110
considerations<font color="#E5E5E5"> you know more</font>

500
00:16:47,320 --> 00:16:52,120
combinations<font color="#E5E5E5"> larger chains you know more</font>

501
00:16:50,110 --> 00:16:55,150
possible decryption values is going to

502
00:16:52,120 --> 00:16:57,310
be longer execution<font color="#E5E5E5"> the CPU may spike</font>

503
00:16:55,150 --> 00:16:58,449
that they might<font color="#E5E5E5"> even hear fan noise but</font>

504
00:16:57,310 --> 00:16:59,739
on the other hand<font color="#CCCCCC"> it'd be harder to</font>

505
00:16:58,450 --> 00:17:01,420
determine<font color="#E5E5E5"> the final</font><font color="#CCCCCC"> key because there's</font>

506
00:16:59,740 --> 00:17:02,620
so many possibilities<font color="#E5E5E5"> the key could</font><font color="#CCCCCC"> be</font>

507
00:17:01,420 --> 00:17:03,819
so that's<font color="#E5E5E5"> just something you have to</font>

508
00:17:02,620 --> 00:17:05,730
<font color="#CCCCCC">consider when you're building these pay</font>

509
00:17:03,820 --> 00:17:07,689
let's go<font color="#E5E5E5"> with something</font><font color="#CCCCCC"> comfortable with</font>

510
00:17:05,730 --> 00:17:11,230
so we'll just go ahead and do a quick

511
00:17:07,689 --> 00:17:18,089
hearing demo here<font color="#E5E5E5"> everything's going</font>

512
00:17:11,230 --> 00:17:21,040
live here<font color="#E5E5E5"> today you can</font><font color="#CCCCCC"> rot alright so</font>

513
00:17:18,089 --> 00:17:23,290
yeah<font color="#E5E5E5"> so I basically built hearing it's</font>

514
00:17:21,040 --> 00:17:25,420
very similar kind of<font color="#E5E5E5"> Ebola it's config</font>

515
00:17:23,290 --> 00:17:27,220
file based and I'll hop<font color="#CCCCCC"> in that second</font>

516
00:17:25,420 --> 00:17:29,830
<font color="#E5E5E5">I'm also kind of built it around MSF</font>

517
00:17:27,220 --> 00:17:31,690
venom so basically what I like about MSF

518
00:17:29,830 --> 00:17:33,280
venom is you just<font color="#CCCCCC"> run a simple one-liner</font>

519
00:17:31,690 --> 00:17:34,840
<font color="#E5E5E5">and it generates a payload or you can</font>

520
00:17:33,280 --> 00:17:36,790
just run other one-liners to determine

521
00:17:34,840 --> 00:17:39,220
more information<font color="#E5E5E5"> to build the</font><font color="#CCCCCC"> payloads</font>

522
00:17:36,790 --> 00:17:40,960
so for example you<font color="#E5E5E5"> can use like</font><font color="#CCCCCC"> the</font>

523
00:17:39,220 --> 00:17:43,390
<font color="#CCCCCC">slangs and i would show you</font><font color="#E5E5E5"> the</font>

524
00:17:40,960 --> 00:17:48,960
supported languages but yeah let's have

525
00:17:43,390 --> 00:17:48,960
let's hop<font color="#CCCCCC"> into we</font><font color="#E5E5E5"> can</font><font color="#CCCCCC"> fit by</font>

526
00:17:50,130 --> 00:17:55,540
so with<font color="#CCCCCC"> wit weird we're just gonna do a</font>

527
00:17:53,950 --> 00:17:57,460
<font color="#CCCCCC">simple</font><font color="#E5E5E5"> JavaScript payload and</font><font color="#CCCCCC"> kind</font><font color="#E5E5E5"> of</font>

528
00:17:55,540 --> 00:17:59,290
like I<font color="#E5E5E5"> said you know it's it's very situ</font>

529
00:17:57,460 --> 00:18:00,280
agnostic doesn't matter what<font color="#CCCCCC"> situ but</font>

530
00:17:59,290 --> 00:18:02,379
we're just<font color="#E5E5E5"> gonna use Empire since</font>

531
00:18:00,280 --> 00:18:03,730
<font color="#E5E5E5">everyone's familiar</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> then basically</font>

532
00:18:02,380 --> 00:18:05,560
<font color="#E5E5E5">just kind of we</font><font color="#CCCCCC"> just kind of</font><font color="#E5E5E5"> add all our</font>

533
00:18:03,730 --> 00:18:08,230
keys afterwards so we're doing<font color="#CCCCCC"> two</font>

534
00:18:05,560 --> 00:18:09,909
<font color="#E5E5E5">environmental variable</font><font color="#CCCCCC"> tiers</font><font color="#E5E5E5"> one based</font>

535
00:18:08,230 --> 00:18:11,800
on<font color="#CCCCCC"> user name one based</font><font color="#E5E5E5"> on the computer</font>

536
00:18:09,910 --> 00:18:13,300
name<font color="#CCCCCC"> and then we're also going to do a</font>

537
00:18:11,800 --> 00:18:17,530
custom chain I'll show you that<font color="#E5E5E5"> in</font><font color="#CCCCCC"> a</font>

538
00:18:13,300 --> 00:18:24,100
second<font color="#CCCCCC"> called get processes so if we</font>

539
00:18:17,530 --> 00:18:25,270
were<font color="#E5E5E5"> taking a look at hearing so if you</font>

540
00:18:24,100 --> 00:18:27,490
do list gears<font color="#E5E5E5"> they'll kind of show you</font>

541
00:18:25,270 --> 00:18:30,220
all the<font color="#CCCCCC"> keys that</font><font color="#E5E5E5"> hearing currently</font>

542
00:18:27,490 --> 00:18:32,020
supports so in you know it supports

543
00:18:30,220 --> 00:18:33,760
directory listing environmental variable

544
00:18:32,020 --> 00:18:36,760
<font color="#E5E5E5">so if we wanted to know</font><font color="#CCCCCC"> more</font><font color="#E5E5E5"> about the</font>

545
00:18:33,760 --> 00:18:43,870
environmental<font color="#E5E5E5"> variable we could do</font><font color="#CCCCCC"> help</font>

546
00:18:36,760 --> 00:18:46,000
here so<font color="#CCCCCC"> it</font><font color="#E5E5E5"> just tells you a</font><font color="#CCCCCC"> bit more</font>

547
00:18:43,870 --> 00:18:46,989
<font color="#E5E5E5">like what what are</font><font color="#CCCCCC"> the inputs which is</font>

548
00:18:46,000 --> 00:18:56,050
basically just<font color="#E5E5E5"> you know the</font>

549
00:18:46,990 --> 00:18:58,000
<font color="#E5E5E5">environmental variable name</font><font color="#CCCCCC"> so and</font><font color="#E5E5E5"> at</font>

550
00:18:56,050 --> 00:19:01,090
<font color="#E5E5E5">the end it's a combo function so they</font>

551
00:18:58,000 --> 00:19:03,700
get processes so as you saw<font color="#CCCCCC"> if you can</font>

552
00:19:01,090 --> 00:19:05,830
see you know there's not<font color="#E5E5E5"> a get process</font>

553
00:19:03,700 --> 00:19:08,740
is<font color="#CCCCCC"> king function but let's say we knew</font>

554
00:19:05,830 --> 00:19:10,659
the target is running<font color="#CCCCCC"> cisco VPN</font><font color="#E5E5E5"> any</font>

555
00:19:08,740 --> 00:19:12,700
<font color="#E5E5E5">connect and we know that process is</font>

556
00:19:10,660 --> 00:19:13,870
<font color="#E5E5E5">going to be in there so we're</font><font color="#CCCCCC"> just</font><font color="#E5E5E5"> going</font>

557
00:19:12,700 --> 00:19:15,670
<font color="#CCCCCC">to add that we're gonna add that</font>

558
00:19:13,870 --> 00:19:17,110
function but there's no<font color="#E5E5E5"> support at here</font>

559
00:19:15,670 --> 00:19:18,940
so we'll use what's called a custom

560
00:19:17,110 --> 00:19:20,790
<font color="#E5E5E5">change since it's a sense of the chain</font>

561
00:19:18,940 --> 00:19:24,250
through turning one or more<font color="#E5E5E5"> processes</font>

562
00:19:20,790 --> 00:19:26,080
<font color="#CCCCCC">will throw that</font><font color="#E5E5E5"> in</font><font color="#CCCCCC"> a config file so</font><font color="#E5E5E5"> just</font>

563
00:19:24,250 --> 00:19:29,680
taking a<font color="#E5E5E5"> look at it again</font><font color="#CCCCCC"> we have our</font>

564
00:19:26,080 --> 00:19:31,240
<font color="#CCCCCC">custom chain</font><font color="#E5E5E5"> the only input would</font><font color="#CCCCCC"> be the</font>

565
00:19:29,680 --> 00:19:33,610
<font color="#E5E5E5">name</font><font color="#CCCCCC"> of the</font><font color="#E5E5E5"> font of the custom function</font>

566
00:19:31,240 --> 00:19:39,000
<font color="#E5E5E5">and then that's the</font><font color="#CCCCCC"> Cisco</font><font color="#E5E5E5"> anyconnect VPN</font>

567
00:19:33,610 --> 00:19:39,000
process name so at<font color="#CCCCCC"> that</font><font color="#E5E5E5"> point we're</font><font color="#CCCCCC"> just</font>

568
00:19:40,320 --> 00:19:45,490
<font color="#E5E5E5">and it outputs it out to shows you the</font>

569
00:19:43,090 --> 00:19:47,830
<font color="#CCCCCC">Rakhi so the username and</font><font color="#E5E5E5"> the VPN</font>

570
00:19:45,490 --> 00:19:49,150
process<font color="#CCCCCC"> and then kind of gives</font><font color="#E5E5E5"> you the</font>

571
00:19:47,830 --> 00:19:51,070
final key hash we're gonna be<font color="#CCCCCC"> using that</font>

572
00:19:49,150 --> 00:19:54,970
<font color="#E5E5E5">the first 32 characters what</font><font color="#CCCCCC"> would be</font>

573
00:19:51,070 --> 00:19:58,000
used<font color="#E5E5E5"> for the to decrypt the payload so</font>

574
00:19:54,970 --> 00:20:00,880
and and it puts it<font color="#E5E5E5"> back out to result</font>

575
00:19:58,000 --> 00:20:03,940
<font color="#E5E5E5">such a yes so as in all the all</font>

576
00:20:00,880 --> 00:20:07,060
<font color="#E5E5E5">funky encryption stuff combination stuff</font>

577
00:20:03,940 --> 00:20:08,710
and then as you see here it<font color="#E5E5E5"> just kind of</font>

578
00:20:07,060 --> 00:20:10,720
has<font color="#E5E5E5"> our built this is where we're kind</font>

579
00:20:08,710 --> 00:20:12,100
of building<font color="#E5E5E5"> those arrays</font><font color="#CCCCCC"> so</font><font color="#E5E5E5"> we have the</font>

580
00:20:10,720 --> 00:20:13,480
right nose<font color="#E5E5E5"> two combos remember we're</font>

581
00:20:12,100 --> 00:20:14,709
just<font color="#CCCCCC"> using</font><font color="#E5E5E5"> user name</font><font color="#CCCCCC"> here but</font><font color="#E5E5E5"> it looks</font>

582
00:20:13,480 --> 00:20:17,530
<font color="#E5E5E5">like we're also using computer name and</font>

583
00:20:14,710 --> 00:20:19,000
<font color="#CCCCCC">then we're adding to get processes</font><font color="#E5E5E5"> but</font>

584
00:20:17,530 --> 00:20:21,610
because it's a custom<font color="#CCCCCC"> function it just</font>

585
00:20:19,000 --> 00:20:27,910
throws in an empty<font color="#E5E5E5"> function so I've kind</font>

586
00:20:21,610 --> 00:20:29,500
of already<font color="#E5E5E5"> done the kind already done</font>

587
00:20:27,910 --> 00:20:30,910
the legwork<font color="#E5E5E5"> there just went out on</font>

588
00:20:29,500 --> 00:20:31,960
Google and found<font color="#E5E5E5"> an easy JavaScript</font>

589
00:20:30,910 --> 00:20:37,240
payload that<font color="#E5E5E5"> would pull the running</font>

590
00:20:31,960 --> 00:20:39,280
processes<font color="#CCCCCC"> so just just so basically you</font>

591
00:20:37,240 --> 00:20:41,140
can just<font color="#CCCCCC"> you know test it all you</font><font color="#E5E5E5"> want</font>

592
00:20:39,280 --> 00:20:42,639
<font color="#CCCCCC">you see that</font><font color="#E5E5E5"> it</font><font color="#CCCCCC"> returns all the running</font>

593
00:20:41,140 --> 00:20:51,610
<font color="#E5E5E5">processes so we'll just go ahead and</font>

594
00:20:42,640 --> 00:20:52,840
<font color="#E5E5E5">throw</font><font color="#CCCCCC"> that and clipboard and</font><font color="#E5E5E5"> then</font>

595
00:20:51,610 --> 00:20:54,100
obviously we don't<font color="#E5E5E5"> want</font><font color="#CCCCCC"> to write it to</font>

596
00:20:52,840 --> 00:20:57,300
the screen we just want to return that

597
00:20:54,100 --> 00:20:59,649
array so we'll just do<font color="#E5E5E5"> return result</font>

598
00:20:57,300 --> 00:21:01,690
save it and then so this<font color="#E5E5E5"> is a JavaScript</font>

599
00:20:59,650 --> 00:21:03,130
<font color="#CCCCCC">payload you can throw in</font><font color="#E5E5E5"> your</font><font color="#CCCCCC"> HT s your</font>

600
00:21:01,690 --> 00:21:05,200
<font color="#E5E5E5">your you know your su T's or wherever</font>

601
00:21:03,130 --> 00:21:08,110
<font color="#E5E5E5">you want well just just for example</font>

602
00:21:05,200 --> 00:21:13,480
we'll go ahead and<font color="#CCCCCC"> execute it just with</font>

603
00:21:08,110 --> 00:21:15,159
with<font color="#E5E5E5"> C script so it decrypted actually</font>

604
00:21:13,480 --> 00:21:17,410
pretty quickly and<font color="#E5E5E5"> we see the</font><font color="#CCCCCC"> PowerShell</font>

605
00:21:15,160 --> 00:21:27,250
<font color="#E5E5E5">execute and then I'll just pop that on</font>

606
00:21:17,410 --> 00:21:29,530
over<font color="#E5E5E5"> to</font><font color="#CCCCCC"> RM here cool so our</font><font color="#E5E5E5"> Empire and</font>

607
00:21:27,250 --> 00:21:30,850
then it did end up<font color="#E5E5E5"> executing and ended</font>

608
00:21:29,530 --> 00:21:35,980
<font color="#E5E5E5">up calling back when I'll just go ahead</font>

609
00:21:30,850 --> 00:21:37,840
and kill it here<font color="#E5E5E5"> all right so a really</font>

610
00:21:35,980 --> 00:21:39,250
<font color="#E5E5E5">simple example</font><font color="#CCCCCC"> just to</font><font color="#E5E5E5"> just kind of want</font>

611
00:21:37,840 --> 00:21:41,379
to show how<font color="#E5E5E5"> easy it is to</font><font color="#CCCCCC"> just throw</font><font color="#E5E5E5"> in</font>

612
00:21:39,250 --> 00:21:43,990
a custom<font color="#CCCCCC"> King function that may be the</font>

613
00:21:41,380 --> 00:21:45,220
<font color="#E5E5E5">the</font><font color="#CCCCCC"> current</font><font color="#E5E5E5"> toolkit doesn't support so</font>

614
00:21:43,990 --> 00:21:46,720
hopefully you guys can<font color="#E5E5E5"> get creative</font><font color="#CCCCCC"> and</font>

615
00:21:45,220 --> 00:21:49,240
<font color="#E5E5E5">come up with with whatever</font><font color="#CCCCCC"> king</font><font color="#E5E5E5"> guys</font>

616
00:21:46,720 --> 00:21:51,190
want but you know<font color="#E5E5E5"> could this be better</font>

617
00:21:49,240 --> 00:21:52,390
<font color="#CCCCCC">you</font><font color="#E5E5E5"> know obviously we were talking about</font>

618
00:21:51,190 --> 00:21:54,700
<font color="#E5E5E5">how the blue team could potentially</font>

619
00:21:52,390 --> 00:21:56,380
<font color="#CCCCCC">encrypt the payloads we also</font><font color="#E5E5E5"> don't</font><font color="#CCCCCC"> have</font>

620
00:21:54,700 --> 00:21:57,880
a whole<font color="#E5E5E5"> lot of control</font><font color="#CCCCCC"> on you know when</font>

621
00:21:56,380 --> 00:21:59,110
it is decrypting and whatnot would be

622
00:21:57,880 --> 00:22:01,290
nice if we<font color="#E5E5E5"> could have a little bit of</font>

623
00:21:59,110 --> 00:22:04,179
control<font color="#CCCCCC"> but</font><font color="#E5E5E5"> can we improve this at all</font>

624
00:22:01,290 --> 00:22:06,240
this<font color="#E5E5E5"> is kind of</font><font color="#CCCCCC"> we're</font><font color="#E5E5E5"> keen we're using</font>

625
00:22:04,180 --> 00:22:08,410
remote resources kind of comes into play

626
00:22:06,240 --> 00:22:09,820
<font color="#E5E5E5">so basically if the</font><font color="#CCCCCC"> payloads reaching</font>

627
00:22:08,410 --> 00:22:11,590
out to some remote resource to get<font color="#E5E5E5"> its</font>

628
00:22:09,820 --> 00:22:13,179
key and<font color="#E5E5E5"> that resource is something that</font>

629
00:22:11,590 --> 00:22:14,770
<font color="#E5E5E5">I can control</font><font color="#CCCCCC"> well then I can</font>

630
00:22:13,180 --> 00:22:16,870
effectively decide one

631
00:22:14,770 --> 00:22:20,139
send down<font color="#CCCCCC"> the decryption key or not</font><font color="#E5E5E5"> so</font>

632
00:22:16,870 --> 00:22:21,429
let's say you know it<font color="#E5E5E5"> with HTTP</font><font color="#CCCCCC"> the</font>

633
00:22:20,140 --> 00:22:22,720
payload<font color="#E5E5E5"> would make a web request out to</font>

634
00:22:21,430 --> 00:22:25,180
<font color="#CCCCCC">a web server</font><font color="#E5E5E5"> that I own</font>

635
00:22:22,720 --> 00:22:27,610
<font color="#CCCCCC">I'll either decide to</font><font color="#E5E5E5"> return the key or</font>

636
00:22:25,180 --> 00:22:29,380
<font color="#E5E5E5">not to</font><font color="#CCCCCC"> on so that brings</font><font color="#E5E5E5"> me</font><font color="#CCCCCC"> back</font><font color="#E5E5E5"> in</font>

637
00:22:27,610 --> 00:22:32,620
<font color="#E5E5E5">control when that payload execute and</font>

638
00:22:29,380 --> 00:22:35,920
<font color="#CCCCCC">Andy Krypton execute and basically I can</font>

639
00:22:32,620 --> 00:22:37,570
turn<font color="#CCCCCC"> on and off so this also is</font><font color="#E5E5E5"> it new</font>

640
00:22:35,920 --> 00:22:39,910
<font color="#E5E5E5">back in 2015</font>

641
00:22:37,570 --> 00:22:42,070
Alex and Chris transfer created an HTTP

642
00:22:39,910 --> 00:22:43,840
key module for<font color="#CCCCCC"> Vail</font><font color="#E5E5E5"> and</font><font color="#CCCCCC"> basically how</font>

643
00:22:42,070 --> 00:22:45,429
<font color="#CCCCCC">that worked is it was basically beacon</font>

644
00:22:43,840 --> 00:22:48,129
back to the<font color="#CCCCCC"> peel of a beacon back to a</font>

645
00:22:45,430 --> 00:22:50,020
web server would grab<font color="#CCCCCC"> the HTML hash the</font>

646
00:22:48,130 --> 00:22:51,850
HTML then try<font color="#E5E5E5"> and use</font><font color="#CCCCCC"> that as</font><font color="#E5E5E5"> the key</font><font color="#CCCCCC"> to</font>

647
00:22:50,020 --> 00:22:54,070
the crypt<font color="#E5E5E5"> if it didn't work it would</font>

648
00:22:51,850 --> 00:22:55,629
sleep and then you know<font color="#E5E5E5"> basically make</font>

649
00:22:54,070 --> 00:22:58,060
another request<font color="#E5E5E5"> no it was useful for</font>

650
00:22:55,630 --> 00:23:00,580
<font color="#CCCCCC">getting around sandboxing unfortunately</font>

651
00:22:58,060 --> 00:23:02,980
is no longer in Vail and<font color="#CCCCCC"> Alex's original</font>

652
00:23:00,580 --> 00:23:04,510
blog post is no longer up either<font color="#CCCCCC"> so I</font>

653
00:23:02,980 --> 00:23:05,500
<font color="#E5E5E5">kind of wanted to resurrect this out and</font>

654
00:23:04,510 --> 00:23:09,730
<font color="#E5E5E5">you know kind</font><font color="#CCCCCC"> of see where I could use</font>

655
00:23:05,500 --> 00:23:11,800
<font color="#E5E5E5">it how I could use it so the HTTP key</font>

656
00:23:09,730 --> 00:23:13,840
<font color="#E5E5E5">again you know and</font><font color="#CCCCCC"> actually a</font>

657
00:23:11,800 --> 00:23:16,149
<font color="#CCCCCC">communication here on</font><font color="#E5E5E5"> the on the slide</font>

658
00:23:13,840 --> 00:23:17,709
on the key server domain is different

659
00:23:16,150 --> 00:23:19,960
than the<font color="#E5E5E5"> c2 server domain obviously you</font>

660
00:23:17,710 --> 00:23:21,160
want to<font color="#CCCCCC"> keep that c2 server domain</font><font color="#E5E5E5"> close</font>

661
00:23:19,960 --> 00:23:22,840
to the chest<font color="#CCCCCC"> we don't want anyone</font><font color="#E5E5E5"> to</font>

662
00:23:21,160 --> 00:23:24,640
<font color="#CCCCCC">know it so the key you on your keister</font>

663
00:23:22,840 --> 00:23:26,350
around a<font color="#E5E5E5"> different domain and then</font>

664
00:23:24,640 --> 00:23:28,150
basically<font color="#E5E5E5"> the payload let's say was it</font>

665
00:23:26,350 --> 00:23:28,750
was<font color="#CCCCCC"> encrypted with a key</font><font color="#E5E5E5"> on HTTP keep</font>

666
00:23:28,150 --> 00:23:31,390
payload

667
00:23:28,750 --> 00:23:34,660
makes a web<font color="#CCCCCC"> request out responds with</font>

668
00:23:31,390 --> 00:23:37,210
the<font color="#CCCCCC"> right</font><font color="#E5E5E5"> HTML hash is that HTML uses it</font>

669
00:23:34,660 --> 00:23:39,580
<font color="#E5E5E5">and decrypt and that c2 session</font>

670
00:23:37,210 --> 00:23:43,120
establishes but if you<font color="#CCCCCC"> send back down</font>

671
00:23:39,580 --> 00:23:44,649
some sort<font color="#CCCCCC"> of benign</font><font color="#E5E5E5"> HTML that that</font><font color="#CCCCCC"> might</font>

672
00:23:43,120 --> 00:23:47,320
look legitimate<font color="#E5E5E5"> but isn't the expected</font>

673
00:23:44,650 --> 00:23:50,350
HTML nothing happens it can't decrypt

674
00:23:47,320 --> 00:23:53,889
the the site to<font color="#E5E5E5"> comm domain isn't shown</font>

675
00:23:50,350 --> 00:23:56,050
up<font color="#E5E5E5"> and it's a good way to you know if</font>

676
00:23:53,890 --> 00:23:58,390
the defenders<font color="#E5E5E5"> don't get that that</font>

677
00:23:56,050 --> 00:24:00,520
expected response will never essentially

678
00:23:58,390 --> 00:24:01,990
be able<font color="#CCCCCC"> to</font><font color="#E5E5E5"> decrypt your payload unless</font>

679
00:24:00,520 --> 00:24:05,530
if they're like<font color="#CCCCCC"> group</font><font color="#E5E5E5"> forcing 32</font>

680
00:24:01,990 --> 00:24:08,740
characters<font color="#CCCCCC"> so DNS key works the exact</font>

681
00:24:05,530 --> 00:24:11,050
<font color="#E5E5E5">same way</font><font color="#CCCCCC"> obviously you just</font><font color="#E5E5E5"> have the</font>

682
00:24:08,740 --> 00:24:13,420
payload make a<font color="#E5E5E5"> DNS txt request</font><font color="#CCCCCC"> hit the</font>

683
00:24:11,050 --> 00:24:17,470
response<font color="#CCCCCC"> hash the response</font><font color="#E5E5E5"> use that as</font>

684
00:24:13,420 --> 00:24:19,690
the key so use<font color="#CCCCCC"> cases</font><font color="#E5E5E5"> you know similar</font><font color="#CCCCCC"> to</font>

685
00:24:17,470 --> 00:24:21,370
<font color="#E5E5E5">the HTTP key module prevail</font><font color="#CCCCCC"> you could</font>

686
00:24:19,690 --> 00:24:23,800
use it to<font color="#E5E5E5"> get around sandboxing you</font>

687
00:24:21,370 --> 00:24:26,729
basically encrypt your payload<font color="#E5E5E5"> you set</font>

688
00:24:23,800 --> 00:24:28,720
<font color="#E5E5E5">up your your HTTP sees your HTTP server</font>

689
00:24:26,730 --> 00:24:31,330
<font color="#E5E5E5">to always send back</font><font color="#CCCCCC"> that</font>

690
00:24:28,720 --> 00:24:33,250
<font color="#CCCCCC">ix response</font><font color="#E5E5E5"> so you'd send the fish wait</font>

691
00:24:31,330 --> 00:24:34,658
an hour that's the sandbox is<font color="#E5E5E5"> gonna be</font>

692
00:24:33,250 --> 00:24:36,070
making<font color="#E5E5E5"> requests all these different</font>

693
00:24:34,659 --> 00:24:38,110
analysis tools<font color="#E5E5E5"> you're making requests</font>

694
00:24:36,070 --> 00:24:41,020
and then<font color="#E5E5E5"> hopefully you know after an</font>

695
00:24:38,110 --> 00:24:42,520
hour<font color="#E5E5E5"> the user clicked on it you and it's</font>

696
00:24:41,020 --> 00:24:44,260
been pulling back<font color="#CCCCCC"> you know the whole</font>

697
00:24:42,520 --> 00:24:46,090
time you replace that<font color="#E5E5E5"> with the expected</font>

698
00:24:44,260 --> 00:24:47,350
<font color="#E5E5E5">response and the pay little actually</font>

699
00:24:46,090 --> 00:24:49,840
cute and hopefully you know<font color="#CCCCCC"> that'll get</font>

700
00:24:47,350 --> 00:24:52,270
you around<font color="#E5E5E5"> sandboxing you know the way</font>

701
00:24:49,840 --> 00:24:54,789
<font color="#E5E5E5">I'll use it a lot is I'll just keep the</font>

702
00:24:52,270 --> 00:24:56,379
expected page up let the payload decrypt

703
00:24:54,789 --> 00:24:59,919
and immediately switch it over to<font color="#E5E5E5"> the</font>

704
00:24:56,380 --> 00:25:01,450
<font color="#E5E5E5">benign page so</font><font color="#CCCCCC"> that way if you know if</font>

705
00:24:59,919 --> 00:25:03,820
anyone<font color="#CCCCCC"> else tries to execute</font><font color="#E5E5E5"> it</font>

706
00:25:01,450 --> 00:25:05,470
obviously<font color="#E5E5E5"> it won't work</font><font color="#CCCCCC"> but you know an</font>

707
00:25:03,820 --> 00:25:07,928
interesting<font color="#CCCCCC"> side effect is you can</font>

708
00:25:05,470 --> 00:25:10,929
monitor logs for those<font color="#CCCCCC"> that H those</font><font color="#E5E5E5"> URLs</font>

709
00:25:07,929 --> 00:25:12,429
are those DNS records and you know if

710
00:25:10,929 --> 00:25:14,830
you see them being requested<font color="#E5E5E5"> at a</font>

711
00:25:12,429 --> 00:25:16,450
certain time<font color="#CCCCCC"> you might</font><font color="#E5E5E5"> be able to detect</font>

712
00:25:14,830 --> 00:25:18,039
incident response so<font color="#E5E5E5"> that your</font><font color="#CCCCCC"> payload</font>

713
00:25:16,450 --> 00:25:22,419
<font color="#E5E5E5">might be executing that</font><font color="#CCCCCC"> well when you're</font>

714
00:25:18,039 --> 00:25:23,679
<font color="#CCCCCC">not expecting it</font><font color="#E5E5E5"> to so I</font><font color="#CCCCCC"> figured you</font>

715
00:25:22,419 --> 00:25:26,020
<font color="#CCCCCC">know some tooling around this would</font><font color="#E5E5E5"> also</font>

716
00:25:23,679 --> 00:25:29,320
<font color="#E5E5E5">be nice</font><font color="#CCCCCC"> you know</font><font color="#E5E5E5"> being able to turn keys</font>

717
00:25:26,020 --> 00:25:31,900
on and off more easily<font color="#CCCCCC"> so I wrote</font><font color="#E5E5E5"> key</font>

718
00:25:29,320 --> 00:25:34,450
server basically<font color="#CCCCCC"> it</font><font color="#E5E5E5"> just makes those DNS</font>

719
00:25:31,900 --> 00:25:36,159
<font color="#E5E5E5">and HTTP keying a lot easier</font><font color="#CCCCCC"> you can</font>

720
00:25:34,450 --> 00:25:37,659
<font color="#E5E5E5">turn the keys on and off a couple</font><font color="#CCCCCC"> logs</font>

721
00:25:36,159 --> 00:25:40,240
you can<font color="#E5E5E5"> see every single</font><font color="#CCCCCC"> time</font><font color="#E5E5E5"> the keys</font>

722
00:25:37,659 --> 00:25:41,530
been requested<font color="#E5E5E5"> alerts so you don't want</font>

723
00:25:40,240 --> 00:25:43,630
to keep<font color="#E5E5E5"> being</font><font color="#CCCCCC"> requested and you're not</font>

724
00:25:41,530 --> 00:25:46,000
<font color="#CCCCCC">expecting</font><font color="#E5E5E5"> it sends it to slack your</font>

725
00:25:43,630 --> 00:25:49,110
email and<font color="#E5E5E5"> also built it so I could still</font>

726
00:25:46,000 --> 00:25:52,030
<font color="#CCCCCC">use</font><font color="#E5E5E5"> those nice Apache mod rewrite rules</font>

727
00:25:49,110 --> 00:25:53,979
<font color="#CCCCCC">you know the constraints is my favorite</font>

728
00:25:52,030 --> 00:25:56,139
piece<font color="#E5E5E5"> with key server</font><font color="#CCCCCC"> so basically it</font>

729
00:25:53,980 --> 00:25:57,460
automates switching the key status so

730
00:25:56,140 --> 00:25:59,890
let's say you have scheduled<font color="#CCCCCC"> tasks for</font>

731
00:25:57,460 --> 00:26:01,539
<font color="#CCCCCC">assistance for</font><font color="#E5E5E5"> 10</font><font color="#CCCCCC"> a.m. on you could set</font>

732
00:25:59,890 --> 00:26:03,520
the the<font color="#CCCCCC"> key server to only</font><font color="#E5E5E5"> return with</font>

733
00:26:01,539 --> 00:26:05,500
<font color="#CCCCCC">that valid response between that time</font>

734
00:26:03,520 --> 00:26:07,240
interval so<font color="#CCCCCC"> that matches</font><font color="#E5E5E5"> the scheduled</font>

735
00:26:05,500 --> 00:26:08,880
<font color="#E5E5E5">tasks and it won't ever execute other</font>

736
00:26:07,240 --> 00:26:11,230
than when that scheduled<font color="#E5E5E5"> tasks execute</font>

737
00:26:08,880 --> 00:26:13,659
or let's say you had persistence in

738
00:26:11,230 --> 00:26:15,010
<font color="#E5E5E5">autorun key after it's been accessed</font>

739
00:26:13,659 --> 00:26:17,169
once for the day let's just

740
00:26:15,010 --> 00:26:18,490
<font color="#E5E5E5">automatically turn it off and any other</font>

741
00:26:17,169 --> 00:26:21,520
request that comes<font color="#E5E5E5"> in the rest of</font><font color="#CCCCCC"> the</font>

742
00:26:18,490 --> 00:26:22,990
day<font color="#E5E5E5"> we're gonna know</font><font color="#CCCCCC"> about it or you</font><font color="#E5E5E5"> can</font>

743
00:26:21,520 --> 00:26:25,030
automate that sandbox<font color="#E5E5E5"> by passing</font>

744
00:26:22,990 --> 00:26:27,190
behavior<font color="#E5E5E5"> by saying hey let's wait till</font>

745
00:26:25,030 --> 00:26:30,428
<font color="#E5E5E5">the keys been attempted 20 times and</font>

746
00:26:27,190 --> 00:26:32,470
then we'll go ahead<font color="#E5E5E5"> and turn</font><font color="#CCCCCC"> it on so I</font>

747
00:26:30,429 --> 00:26:34,150
threw it<font color="#E5E5E5"> I threw together code in key</font>

748
00:26:32,470 --> 00:26:36,370
<font color="#E5E5E5">ring as well so basically keyring will</font>

749
00:26:34,150 --> 00:26:39,880
generate the HTTP<font color="#E5E5E5"> King for a c-sharp</font>

750
00:26:36,370 --> 00:26:42,428
<font color="#E5E5E5">PowerShell</font><font color="#CCCCCC"> in</font><font color="#E5E5E5"> JavaScript we do DNS King</font>

751
00:26:39,880 --> 00:26:43,590
for c-sharp<font color="#E5E5E5"> that's the only other three</font>

752
00:26:42,429 --> 00:26:46,330
that's the<font color="#E5E5E5"> only one I could do without</font>

753
00:26:43,590 --> 00:26:48,369
<font color="#E5E5E5">spawning nslookup</font><font color="#CCCCCC"> and I just didn't want</font>

754
00:26:46,330 --> 00:26:50,559
to spawn<font color="#CCCCCC"> another process so we can</font>

755
00:26:48,369 --> 00:26:52,240
actually<font color="#E5E5E5"> use pin</font><font color="#CCCCCC"> vote</font><font color="#E5E5E5"> and some some code</font>

756
00:26:50,559 --> 00:26:54,970
<font color="#CCCCCC">to programmatically request with txt</font>

757
00:26:52,240 --> 00:26:58,450
record<font color="#E5E5E5"> huge things</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> are known</font><font color="#CCCCCC"> as DNS</font>

758
00:26:54,970 --> 00:27:00,399
<font color="#E5E5E5">sexual</font><font color="#CCCCCC"> trigger tool and so DNS and HTTP</font>

759
00:26:58,450 --> 00:27:04,659
keying<font color="#E5E5E5"> are considered combos and</font><font color="#CCCCCC"> king</font>

760
00:27:00,399 --> 00:27:08,168
hearing vocabulary so we'll hop into our

761
00:27:04,659 --> 00:27:11,440
first key server demo<font color="#E5E5E5"> so we'll go</font>

762
00:27:08,169 --> 00:27:12,820
fishing with an HTTP key<font color="#CCCCCC"> I need a nice</font>

763
00:27:11,440 --> 00:27:14,740
way to kind<font color="#E5E5E5"> of save on infrastructure</font>

764
00:27:12,820 --> 00:27:16,570
<font color="#E5E5E5">you can throw your payload and key</font>

765
00:27:14,740 --> 00:27:18,070
server on the<font color="#E5E5E5"> same domain obviously we</font>

766
00:27:16,570 --> 00:27:20,889
still want to keep<font color="#E5E5E5"> our c2 server on its</font>

767
00:27:18,070 --> 00:27:23,590
own so<font color="#E5E5E5"> what we'll do a fishing scenario</font>

768
00:27:20,889 --> 00:27:24,908
<font color="#E5E5E5">on that would probably</font><font color="#CCCCCC"> work free</font><font color="#E5E5E5"> tickets</font>

769
00:27:23,590 --> 00:27:27,369
<font color="#CCCCCC">for</font><font color="#E5E5E5"> Derby</font><font color="#CCCCCC"> Khan's</font><font color="#E5E5E5"> so it would basically</font>

770
00:27:24,909 --> 00:27:29,799
make<font color="#E5E5E5"> a request out to pre</font><font color="#CCCCCC"> tix and then</font>

771
00:27:27,369 --> 00:27:30,999
after that the the payload is going to

772
00:27:29,799 --> 00:27:51,549
be making requests to Dave Kennedy

773
00:27:30,999 --> 00:27:53,289
trying to decrypt the payload<font color="#CCCCCC"> alright so</font>

774
00:27:51,549 --> 00:27:56,080
I just<font color="#E5E5E5"> kind of just to save some</font><font color="#CCCCCC"> time I</font>

775
00:27:53,289 --> 00:27:57,789
<font color="#CCCCCC">just threw up an HTTP key</font><font color="#E5E5E5"> similar how I</font>

776
00:27:56,080 --> 00:28:00,220
just explained so<font color="#E5E5E5"> it's off of Dave</font>

777
00:27:57,789 --> 00:28:02,649
Kennedy<font color="#E5E5E5"> shows that it's been access zero</font>

778
00:28:00,220 --> 00:28:04,960
times today<font color="#E5E5E5"> I'm not doing any alerting</font>

779
00:28:02,649 --> 00:28:06,459
or anything<font color="#E5E5E5"> crazy</font><font color="#CCCCCC"> if you wanted</font><font color="#E5E5E5"> to see</font>

780
00:28:04,960 --> 00:28:09,820
more<font color="#E5E5E5"> information on it you can just type</font>

781
00:28:06,460 --> 00:28:12,190
<font color="#E5E5E5">info</font><font color="#CCCCCC"> so basically I'm sending down a Fah</font>

782
00:28:09,820 --> 00:28:13,360
this key dot HTML which is<font color="#E5E5E5"> like HTML</font>

783
00:28:12,190 --> 00:28:15,610
that includes a<font color="#CCCCCC"> picture of Dave Kennedy</font>

784
00:28:13,360 --> 00:28:17,740
<font color="#E5E5E5">which will decrypt our payload hopefully</font>

785
00:28:15,610 --> 00:28:20,080
it also shows you the hash of<font color="#CCCCCC"> that</font>

786
00:28:17,740 --> 00:28:21,309
response so if you weren't using keyring

787
00:28:20,080 --> 00:28:23,158
or something else<font color="#E5E5E5"> you can easily just</font>

788
00:28:21,309 --> 00:28:25,149
grab that<font color="#CCCCCC"> and use it however you'd like</font>

789
00:28:23,159 --> 00:28:28,899
and<font color="#E5E5E5"> then there's obviously no</font>

790
00:28:25,149 --> 00:28:32,168
constraints so we'll<font color="#E5E5E5"> take a look at the</font>

791
00:28:28,899 --> 00:28:34,570
config file<font color="#E5E5E5"> that long so I'm just gonna</font>

792
00:28:32,169 --> 00:28:36,759
use a c-sharp Empire launcher similar to

793
00:28:34,570 --> 00:28:40,240
kind<font color="#CCCCCC"> of the first</font><font color="#E5E5E5"> demo I'm just with</font>

794
00:28:36,759 --> 00:28:45,009
c-sharp we're using<font color="#E5E5E5"> this HTTP key here</font>

795
00:28:40,240 --> 00:28:47,529
takes in a<font color="#E5E5E5"> URL and the user agent and</font>

796
00:28:45,009 --> 00:28:50,110
then obviously<font color="#E5E5E5"> that key data matches</font>

797
00:28:47,529 --> 00:28:53,289
that's<font color="#E5E5E5"> the same</font><font color="#CCCCCC"> fdf sha-512 hash of the</font>

798
00:28:50,110 --> 00:28:54,850
<font color="#E5E5E5">four but let's say you weren't using key</font>

799
00:28:53,289 --> 00:28:56,440
server you're using some<font color="#CCCCCC"> third-party</font>

800
00:28:54,850 --> 00:28:58,629
<font color="#E5E5E5">tool keyring</font>

801
00:28:56,440 --> 00:29:00,670
actually request<font color="#CCCCCC"> and grab that hash for</font>

802
00:28:58,630 --> 00:29:02,290
you<font color="#E5E5E5"> and I'll just turn that on</font>

803
00:29:00,670 --> 00:29:05,380
turn on the heat here quick just<font color="#E5E5E5"> so I</font>

804
00:29:02,290 --> 00:29:06,580
can<font color="#E5E5E5"> show</font><font color="#CCCCCC"> you</font><font color="#E5E5E5"> guys let's say didn't you</font>

805
00:29:05,380 --> 00:29:15,910
know you didn't have<font color="#E5E5E5"> key server running</font>

806
00:29:06,580 --> 00:29:17,980
<font color="#E5E5E5">you can do that request</font><font color="#CCCCCC"> so</font><font color="#E5E5E5"> we'll go out</font>

807
00:29:15,910 --> 00:29:19,540
<font color="#CCCCCC">and just make a request to</font><font color="#E5E5E5"> some</font><font color="#CCCCCC"> webpage</font>

808
00:29:17,980 --> 00:29:20,890
<font color="#CCCCCC">pull down and give you the hash so if</font>

809
00:29:19,540 --> 00:29:23,379
you don't want to use key server<font color="#CCCCCC"> Tillie</font>

810
00:29:20,890 --> 00:29:28,060
understand you can still<font color="#E5E5E5"> use you know</font>

811
00:29:23,380 --> 00:29:33,010
whatever<font color="#E5E5E5"> HTTP server you want</font><font color="#CCCCCC"> so go</font>

812
00:29:28,060 --> 00:29:34,510
ahead<font color="#E5E5E5"> and just turn this off</font><font color="#CCCCCC"> for now so</font>

813
00:29:33,010 --> 00:29:36,940
and<font color="#E5E5E5"> it shows up that one hit so I</font>

814
00:29:34,510 --> 00:29:38,980
<font color="#E5E5E5">already kind of set us up with</font><font color="#CCCCCC"> our fish</font>

815
00:29:36,940 --> 00:29:47,410
it's going to be out to<font color="#CCCCCC"> that</font><font color="#E5E5E5"> that pre</font>

816
00:29:38,980 --> 00:29:50,070
<font color="#E5E5E5">ticks URL excusing a click once anybody</font>

817
00:29:47,410 --> 00:29:53,520
like click once payloads I'm a huge fan

818
00:29:50,070 --> 00:29:57,189
<font color="#E5E5E5">basically you only have to click once so</font>

819
00:29:53,520 --> 00:29:59,050
then this<font color="#CCCCCC"> execute c-sharp</font><font color="#E5E5E5"> so that should</font>

820
00:29:57,190 --> 00:30:00,330
<font color="#CCCCCC">execute our payload here and we're</font><font color="#E5E5E5"> going</font>

821
00:29:59,050 --> 00:30:02,620
<font color="#CCCCCC">to see that we're getting a bunch</font><font color="#E5E5E5"> of</font>

822
00:30:00,330 --> 00:30:05,500
beacons and we're responding<font color="#E5E5E5"> with off so</font>

823
00:30:02,620 --> 00:30:08,139
it's not<font color="#E5E5E5"> going to execute Empire hasn't</font>

824
00:30:05,500 --> 00:30:11,470
received anything yet so we'll just go

825
00:30:08,140 --> 00:30:13,960
<font color="#E5E5E5">ahead and manually turn it on here and</font>

826
00:30:11,470 --> 00:30:15,850
so<font color="#E5E5E5"> quickly</font><font color="#CCCCCC"> it's pinging every</font><font color="#E5E5E5"> two</font>

827
00:30:13,960 --> 00:30:20,040
seconds<font color="#E5E5E5"> so we respond with the on and</font>

828
00:30:15,850 --> 00:30:20,040
then our payload<font color="#CCCCCC"> called back</font>

829
00:30:21,770 --> 00:30:25,889
[Applause]

830
00:30:26,409 --> 00:30:31,369
so the<font color="#E5E5E5"> manual switching</font><font color="#CCCCCC"> on and</font><font color="#E5E5E5"> off is</font>

831
00:30:29,450 --> 00:30:33,889
great<font color="#E5E5E5"> but what I've really been using</font>

832
00:30:31,369 --> 00:30:36,439
this a<font color="#CCCCCC"> lot for is IR detection</font><font color="#E5E5E5"> so</font>

833
00:30:33,889 --> 00:30:37,908
basically<font color="#CCCCCC"> we'll let's give</font><font color="#E5E5E5"> this scenario</font>

834
00:30:36,440 --> 00:30:40,340
<font color="#CCCCCC">let's say you've had some success you're</font>

835
00:30:37,909 --> 00:30:41,960
you're<font color="#E5E5E5"> on a server you're in memory with</font>

836
00:30:40,340 --> 00:30:44,809
a high delay it's calling back<font color="#E5E5E5"> to some</font>

837
00:30:41,960 --> 00:30:46,399
<font color="#E5E5E5">c2 and then you but you also need</font>

838
00:30:44,809 --> 00:30:48,710
<font color="#E5E5E5">persistence on user workstation let's</font>

839
00:30:46,399 --> 00:30:51,768
say you<font color="#E5E5E5"> just use an auto</font><font color="#CCCCCC"> one registry</font>

840
00:30:48,710 --> 00:30:52,850
key<font color="#E5E5E5"> out over</font><font color="#CCCCCC"> run</font><font color="#E5E5E5"> register key so</font>

841
00:30:51,769 --> 00:30:55,159
basically we're going to<font color="#E5E5E5"> use that we're</font>

842
00:30:52,850 --> 00:31:01,449
going<font color="#E5E5E5"> to key</font><font color="#CCCCCC"> to we're using a DNS key or</font>

843
00:30:55,159 --> 00:31:01,450
<font color="#CCCCCC">an Akita</font><font color="#E5E5E5"> DocuSign key server dot</font><font color="#CCCCCC"> site so</font>

844
00:31:05,049 --> 00:31:13,249
I'll just show<font color="#CCCCCC"> you the so DNS king</font><font color="#E5E5E5"> very</font>

845
00:31:11,779 --> 00:31:15,019
similar<font color="#E5E5E5"> just takes in one input though</font>

846
00:31:13,249 --> 00:31:17,960
<font color="#E5E5E5">and we're just going</font><font color="#CCCCCC"> to be using the</font>

847
00:31:15,019 --> 00:31:19,190
<font color="#E5E5E5">DocuSign key server dot site and then</font>

848
00:31:17,960 --> 00:31:36,649
you know I've<font color="#E5E5E5"> already got the hash</font>

849
00:31:19,190 --> 00:31:38,929
loaded in here so<font color="#E5E5E5"> I again save some time</font>

850
00:31:36,649 --> 00:31:42,289
I've<font color="#CCCCCC"> already thrown</font><font color="#E5E5E5"> it in there so we</font>

851
00:31:38,929 --> 00:31:43,759
have<font color="#E5E5E5"> our DNS key here waiting if</font><font color="#CCCCCC"> your</font>

852
00:31:42,289 --> 00:31:45,408
show info<font color="#E5E5E5"> I'm bitch basically responding</font>

853
00:31:43,759 --> 00:31:46,970
<font color="#E5E5E5">with some DocuSign</font><font color="#CCCCCC"> queue it's something</font>

854
00:31:45,409 --> 00:31:49,580
I've seen<font color="#E5E5E5"> in other environments so</font>

855
00:31:46,970 --> 00:31:51,080
hopefully it kind of blends<font color="#E5E5E5"> in and then</font>

856
00:31:49,580 --> 00:31:53,658
you know we have<font color="#CCCCCC"> that hatch the response</font>

857
00:31:51,080 --> 00:31:55,279
<font color="#E5E5E5">that matched the the keyring config but</font>

858
00:31:53,659 --> 00:31:57,799
I did set up a constraint here so

859
00:31:55,279 --> 00:31:59,749
<font color="#E5E5E5">basically whenever it sees</font><font color="#CCCCCC"> one hit it's</font>

860
00:31:57,799 --> 00:32:01,700
automatically<font color="#E5E5E5"> going</font><font color="#CCCCCC"> to turn off so as</font>

861
00:31:59,749 --> 00:32:03,950
you see<font color="#CCCCCC"> here it's saying it's active</font>

862
00:32:01,700 --> 00:32:05,869
<font color="#E5E5E5">because of that hit limit constraints so</font>

863
00:32:03,950 --> 00:32:13,549
the moment<font color="#CCCCCC"> that it hits one it should</font>

864
00:32:05,869 --> 00:32:18,709
<font color="#E5E5E5">hopefully turn off so just</font><font color="#CCCCCC"> set</font><font color="#E5E5E5"> up like a</font>

865
00:32:13,549 --> 00:32:20,749
simple msbuild payload so just you<font color="#E5E5E5"> know</font>

866
00:32:18,710 --> 00:32:22,159
the<font color="#CCCCCC"> c-sharp just threw it in msbuild so</font>

867
00:32:20,749 --> 00:32:26,599
let's say you're<font color="#E5E5E5"> actually doing</font><font color="#CCCCCC"> on</font><font color="#E5E5E5"> s</font>

868
00:32:22,159 --> 00:32:28,190
build so and I should<font color="#E5E5E5"> tell you</font><font color="#CCCCCC"> I</font>

869
00:32:26,599 --> 00:32:29,678
actually set up<font color="#E5E5E5"> alerts on this one as</font>

870
00:32:28,190 --> 00:32:33,529
<font color="#E5E5E5">well</font>

871
00:32:29,679 --> 00:32:35,090
<font color="#E5E5E5">so I ever seen</font><font color="#CCCCCC"> a</font><font color="#E5E5E5"> alert that says hey we</font>

872
00:32:33,529 --> 00:32:36,600
just responded with an active DNS key to

873
00:32:35,090 --> 00:32:38,370
slack

874
00:32:36,600 --> 00:32:41,250
you know<font color="#E5E5E5"> a key server says that as well</font>

875
00:32:38,370 --> 00:32:45,000
you should have<font color="#CCCCCC"> our empire payload so</font>

876
00:32:41,250 --> 00:32:46,530
our Empire pill is in there and then if

877
00:32:45,000 --> 00:32:48,750
you see<font color="#E5E5E5"> status it's automatically been</font>

878
00:32:46,530 --> 00:32:51,570
turned<font color="#E5E5E5"> off to active so let's say</font><font color="#CCCCCC"> for</font>

879
00:32:48,750 --> 00:32:53,700
example<font color="#E5E5E5"> you know somebody maybe saw that</font>

880
00:32:51,570 --> 00:32:55,439
<font color="#E5E5E5">that payload for whatever reason they're</font>

881
00:32:53,700 --> 00:32:56,670
you know threat hunting or whatever<font color="#E5E5E5"> they</font>

882
00:32:55,440 --> 00:32:58,679
they caught<font color="#CCCCCC"> that payload</font><font color="#E5E5E5"> they throw it</font>

883
00:32:56,670 --> 00:33:00,120
on their own system<font color="#CCCCCC"> and you know they're</font>

884
00:32:58,679 --> 00:33:02,580
they're either going<font color="#E5E5E5"> to analyze it maybe</font>

885
00:33:00,120 --> 00:33:05,189
they throw it up on virustotal<font color="#E5E5E5"> but they</font>

886
00:33:02,580 --> 00:33:08,250
you<font color="#E5E5E5"> know they they screw up basically</font>

887
00:33:05,190 --> 00:33:10,530
<font color="#E5E5E5">and they execute that file again as we</font>

888
00:33:08,250 --> 00:33:12,300
see that the<font color="#E5E5E5"> payload doesn't</font><font color="#CCCCCC"> execute and</font>

889
00:33:10,530 --> 00:33:14,730
we<font color="#E5E5E5"> get an alert</font><font color="#CCCCCC"> that says</font><font color="#E5E5E5"> hey an access</font>

890
00:33:12,300 --> 00:33:16,770
attempt that<font color="#CCCCCC"> inactive</font><font color="#E5E5E5"> DNS key so we</font>

891
00:33:14,730 --> 00:33:18,630
maintain<font color="#CCCCCC"> access to that that system and</font>

892
00:33:16,770 --> 00:33:20,190
now we know that<font color="#E5E5E5"> IR</font><font color="#CCCCCC"> detection is on to</font>

893
00:33:18,630 --> 00:33:23,309
us so maybe we can do something<font color="#E5E5E5"> else on</font>

894
00:33:20,190 --> 00:33:25,230
like<font color="#E5E5E5"> that server for example</font><font color="#CCCCCC"> you know so</font>

895
00:33:23,309 --> 00:33:28,350
a good way to<font color="#CCCCCC"> a good way to</font><font color="#E5E5E5"> monitor for</font>

896
00:33:25,230 --> 00:33:30,870
<font color="#E5E5E5">our detection</font><font color="#CCCCCC"> luckily and this came in</font>

897
00:33:28,350 --> 00:33:33,780
<font color="#E5E5E5">at the right</font><font color="#CCCCCC"> time this actually</font><font color="#E5E5E5"> I got</font>

898
00:33:30,870 --> 00:33:35,370
caught doing this<font color="#E5E5E5"> in the wild</font><font color="#CCCCCC"> so code</font>

899
00:33:33,780 --> 00:33:38,010
inject basically sent out a<font color="#E5E5E5"> tweet saying</font>

900
00:33:35,370 --> 00:33:40,320
<font color="#E5E5E5">you know hey interesting file this</font>

901
00:33:38,010 --> 00:33:42,150
msbuild thing it's<font color="#E5E5E5"> making a DNS txt</font>

902
00:33:40,320 --> 00:33:44,669
request out to<font color="#E5E5E5"> some some domain that</font>

903
00:33:42,150 --> 00:33:46,020
<font color="#E5E5E5">some DNS server I actually already knew</font>

904
00:33:44,670 --> 00:33:49,590
about<font color="#E5E5E5"> this because I was running key</font>

905
00:33:46,020 --> 00:33:50,490
server<font color="#E5E5E5"> and I knew the exact time</font><font color="#CCCCCC"> I was</font>

906
00:33:49,590 --> 00:33:52,740
thrown<font color="#E5E5E5"> on virustotal</font>

907
00:33:50,490 --> 00:33:55,020
because I saw a bunch<font color="#E5E5E5"> of</font><font color="#CCCCCC"> traffic started</font>

908
00:33:52,740 --> 00:33:56,880
hitting that key<font color="#E5E5E5"> server so nobody ended</font>

909
00:33:55,020 --> 00:33:59,639
up getting like<font color="#E5E5E5"> a custom implant I was</font>

910
00:33:56,880 --> 00:34:01,650
using<font color="#E5E5E5"> and this poor guy that would talk</font>

911
00:33:59,640 --> 00:34:03,179
he<font color="#E5E5E5"> was like you know I just</font><font color="#CCCCCC"> got</font><font color="#E5E5E5"> my hands</font>

912
00:34:01,650 --> 00:34:05,220
on<font color="#E5E5E5"> it the domain</font><font color="#CCCCCC"> isn't answering any</font>

913
00:34:03,179 --> 00:34:07,080
more<font color="#E5E5E5"> I really want to see that decrypted</font>

914
00:34:05,220 --> 00:34:09,000
dive function code<font color="#E5E5E5"> does anybody have the</font>

915
00:34:07,080 --> 00:34:10,739
response<font color="#CCCCCC"> and</font><font color="#E5E5E5"> obviously no one's gonna</font>

916
00:34:09,000 --> 00:34:12,270
have the response and<font color="#CCCCCC"> Porvoo talk</font><font color="#E5E5E5"> is</font>

917
00:34:10,739 --> 00:34:18,799
never going<font color="#E5E5E5"> to get</font><font color="#CCCCCC"> to see all the the</font>

918
00:34:12,270 --> 00:34:18,800
cool<font color="#E5E5E5"> stuff I was using but you know I</font>

919
00:34:20,080 --> 00:34:26,319
<font color="#CCCCCC">I could have</font><font color="#E5E5E5"> done</font><font color="#CCCCCC"> better though</font><font color="#E5E5E5"> you know</font>

920
00:34:22,870 --> 00:34:28,690
that<font color="#CCCCCC"> that health services domain I still</font>

921
00:34:26,320 --> 00:34:31,240
lost that<font color="#CCCCCC"> I really can't use it anymore</font>

922
00:34:28,690 --> 00:34:32,830
<font color="#CCCCCC">mom so how</font><font color="#E5E5E5"> could I do it better well you</font>

923
00:34:31,239 --> 00:34:35,290
know I could<font color="#E5E5E5"> encrypt it</font><font color="#CCCCCC"> with that DNS</font>

924
00:34:32,830 --> 00:34:37,000
key and then use then re-encrypt it with

925
00:34:35,290 --> 00:34:38,170
using like environmental<font color="#E5E5E5"> variables and</font>

926
00:34:37,000 --> 00:34:41,350
stuff so that<font color="#CCCCCC"> should keep like the</font>

927
00:34:38,170 --> 00:34:43,090
<font color="#E5E5E5">Twitter guys that they and actually with</font>

928
00:34:41,350 --> 00:34:44,980
with<font color="#E5E5E5"> JavaScript this is pretty easy with</font>

929
00:34:43,090 --> 00:34:47,350
<font color="#CCCCCC">keyring so basically you could create</font>

930
00:34:44,980 --> 00:34:49,270
<font color="#E5E5E5">one config file that would take in that</font>

931
00:34:47,350 --> 00:34:52,150
<font color="#E5E5E5">you know that that payload you're using</font>

932
00:34:49,270 --> 00:34:54,130
your<font color="#CCCCCC"> Empire</font><font color="#E5E5E5"> outputs it to some HTTP</font>

933
00:34:52,150 --> 00:34:55,540
<font color="#E5E5E5">keyed file and then your second file</font>

934
00:34:54,130 --> 00:34:57,550
your second config would basically take

935
00:34:55,540 --> 00:34:58,810
that<font color="#E5E5E5"> in and then re encrypt it with with</font>

936
00:34:57,550 --> 00:35:00,670
<font color="#E5E5E5">other things then you just</font><font color="#CCCCCC"> got a run</font>

937
00:34:58,810 --> 00:35:03,250
hearing twice and you should have that

938
00:35:00,670 --> 00:35:04,630
that<font color="#E5E5E5"> doubly encrypted file and not to</font>

939
00:35:03,250 --> 00:35:07,360
brag or anything<font color="#E5E5E5"> but right now we're at</font>

940
00:35:04,630 --> 00:35:08,860
zero<font color="#CCCCCC"> so on virustotal</font><font color="#E5E5E5"> but I'm sure</font>

941
00:35:07,360 --> 00:35:10,150
that'll<font color="#E5E5E5"> change so definitely still want</font>

942
00:35:08,860 --> 00:35:13,690
to<font color="#E5E5E5"> still you know look at using</font>

943
00:35:10,150 --> 00:35:16,150
obfuscation<font color="#CCCCCC"> and just you</font><font color="#E5E5E5"> know this might</font>

944
00:35:13,690 --> 00:35:19,270
seem<font color="#CCCCCC"> obvious but if the blue team found</font>

945
00:35:16,150 --> 00:35:21,730
that that DNS key or<font color="#E5E5E5"> that</font><font color="#CCCCCC"> Hupp</font><font color="#E5E5E5"> payload</font>

946
00:35:19,270 --> 00:35:23,560
<font color="#E5E5E5">and they block that that key server IP</font>

947
00:35:21,730 --> 00:35:25,630
or domain through through whatever means

948
00:35:23,560 --> 00:35:27,580
<font color="#E5E5E5">you're pale is not gonna execute so</font>

949
00:35:25,630 --> 00:35:30,340
don't get<font color="#E5E5E5"> mad at me but you know your</font>

950
00:35:27,580 --> 00:35:33,069
your decrypted<font color="#E5E5E5"> payload still say but</font>

951
00:35:30,340 --> 00:35:34,780
<font color="#E5E5E5">just</font><font color="#CCCCCC"> something</font><font color="#E5E5E5"> to consider HTTP and DNS</font>

952
00:35:33,070 --> 00:35:38,590
<font color="#CCCCCC">king is</font><font color="#E5E5E5"> really useful if you have</font><font color="#CCCCCC"> a</font>

953
00:35:34,780 --> 00:35:40,450
couple<font color="#E5E5E5"> methods</font><font color="#CCCCCC"> into an environment so as</font>

954
00:35:38,590 --> 00:35:41,320
we close to<font color="#E5E5E5"> closing up here I just kinda</font>

955
00:35:40,450 --> 00:35:43,120
want<font color="#CCCCCC"> to talk about some of my</font>

956
00:35:41,320 --> 00:35:45,730
motivations and why and<font color="#CCCCCC"> how I've been</font>

957
00:35:43,120 --> 00:35:47,770
<font color="#CCCCCC">using keying over the past year so I</font>

958
00:35:45,730 --> 00:35:49,630
know I<font color="#CCCCCC"> just you know</font><font color="#E5E5E5"> really building on</font>

959
00:35:47,770 --> 00:35:51,040
<font color="#E5E5E5">that</font><font color="#CCCCCC"> spongebob's I just feel like</font><font color="#E5E5E5"> the</font>

960
00:35:49,630 --> 00:35:52,750
odds are really<font color="#E5E5E5"> in the defenders favor</font>

961
00:35:51,040 --> 00:35:54,400
like<font color="#E5E5E5"> I'm gonna get caught and things</font>

962
00:35:52,750 --> 00:35:56,320
<font color="#E5E5E5">like you know improvements to in-memory</font>

963
00:35:54,400 --> 00:35:58,360
detection capabilities finding things

964
00:35:56,320 --> 00:35:58,860
<font color="#E5E5E5">like create remote thread is getting a</font>

965
00:35:58,360 --> 00:36:01,570
lot better

966
00:35:58,860 --> 00:36:02,290
<font color="#CCCCCC">finding abnormal binaries making network</font>

967
00:36:01,570 --> 00:36:04,090
connections

968
00:36:02,290 --> 00:36:06,180
you know<font color="#CCCCCC"> suit like system on event ID</font>

969
00:36:04,090 --> 00:36:08,980
<font color="#CCCCCC">III is</font><font color="#E5E5E5"> really good command line logging</font>

970
00:36:06,180 --> 00:36:10,690
and you know finally<font color="#CCCCCC"> these</font><font color="#E5E5E5"> in-memory</font>

971
00:36:08,980 --> 00:36:11,830
techniques and these<font color="#E5E5E5"> Red Team techniques</font>

972
00:36:10,690 --> 00:36:12,250
are finally<font color="#E5E5E5"> getting the</font><font color="#CCCCCC"> attention they</font>

973
00:36:11,830 --> 00:36:13,750
<font color="#CCCCCC">deserve</font>

974
00:36:12,250 --> 00:36:15,400
<font color="#E5E5E5">and you know I really think that's</font>

975
00:36:13,750 --> 00:36:17,740
because all<font color="#E5E5E5"> tradecraft</font><font color="#CCCCCC"> is about</font>

976
00:36:15,400 --> 00:36:18,730
in-memory techniques and you know Justin

977
00:36:17,740 --> 00:36:20,560
Warner brings up a<font color="#CCCCCC"> really</font><font color="#E5E5E5"> good point</font>

978
00:36:18,730 --> 00:36:22,540
<font color="#E5E5E5">that you</font><font color="#CCCCCC"> know the side effect of</font>

979
00:36:20,560 --> 00:36:25,090
releasing tradecraft is funneling actors

980
00:36:22,540 --> 00:36:26,680
too predictable behaviors and then that

981
00:36:25,090 --> 00:36:28,840
lures<font color="#E5E5E5"> those threats to predictable</font>

982
00:36:26,680 --> 00:36:30,310
detection points<font color="#E5E5E5"> so while we're</font><font color="#CCCCCC"> all</font>

983
00:36:28,840 --> 00:36:32,440
<font color="#E5E5E5">doing all these these new latest</font><font color="#CCCCCC"> and</font>

984
00:36:30,310 --> 00:36:33,970
greatest things<font color="#E5E5E5"> it's basically you know</font>

985
00:36:32,440 --> 00:36:36,730
pushing<font color="#E5E5E5"> us all to try</font>

986
00:36:33,970 --> 00:36:37,629
<font color="#E5E5E5">do these in memory techniques so I went</font>

987
00:36:36,730 --> 00:36:39,280
ahead<font color="#E5E5E5"> and said you know what I'm just</font>

988
00:36:37,630 --> 00:36:40,450
<font color="#CCCCCC">gonna start dropping files to disk you</font>

989
00:36:39,280 --> 00:36:42,820
know what he I feel comfortable<font color="#CCCCCC"> doing</font>

990
00:36:40,450 --> 00:36:44,890
<font color="#CCCCCC">that again I might not</font><font color="#E5E5E5"> drop an</font><font color="#CCCCCC"> X ee or</font>

991
00:36:42,820 --> 00:36:47,590
<font color="#CCCCCC">dll right away but</font><font color="#E5E5E5"> you</font><font color="#CCCCCC"> know dropping</font>

992
00:36:44,890 --> 00:36:49,180
<font color="#E5E5E5">those those different SCT or HTA files I</font>

993
00:36:47,590 --> 00:36:52,000
feel<font color="#CCCCCC"> comfortable</font><font color="#E5E5E5"> doing that with with</font>

994
00:36:49,180 --> 00:36:53,529
keying now and this is where<font color="#E5E5E5"> kind of</font>

995
00:36:52,000 --> 00:36:55,570
<font color="#CCCCCC">obfuscation is definitely still needed</font>

996
00:36:53,530 --> 00:36:57,760
what I'll do is I'll typically obfuscate

997
00:36:55,570 --> 00:37:00,130
the<font color="#E5E5E5"> original payload I'll encrypt it and</font>

998
00:36:57,760 --> 00:37:01,570
then I'll get that encrypted<font color="#CCCCCC"> paila</font><font color="#E5E5E5"> just</font>

999
00:37:00,130 --> 00:37:03,220
to make sure no brittle detection is

1000
00:37:01,570 --> 00:37:06,910
like you know checking on certain

1001
00:37:03,220 --> 00:37:08,890
strings is<font color="#E5E5E5"> gonna get them caught and you</font>

1002
00:37:06,910 --> 00:37:10,330
know here's just one of my reliable go

1003
00:37:08,890 --> 00:37:12,040
twos that<font color="#E5E5E5"> I've been using kind of on and</font>

1004
00:37:10,330 --> 00:37:14,770
off for a year<font color="#E5E5E5"> that's been super</font><font color="#CCCCCC"> EDI</font>

1005
00:37:12,040 --> 00:37:17,140
friendly<font color="#CCCCCC"> so basically I'll prepare some</font>

1006
00:37:14,770 --> 00:37:19,570
sort<font color="#CCCCCC"> of c-sharp dropper</font><font color="#E5E5E5"> and the implant</font>

1007
00:37:17,140 --> 00:37:22,270
overall<font color="#CCCCCC"> will use the the IE comm object</font>

1008
00:37:19,570 --> 00:37:23,680
<font color="#E5E5E5">that basically is programmatically</font><font color="#CCCCCC"> using</font>

1009
00:37:22,270 --> 00:37:25,990
Internet Explorer and the Internet

1010
00:37:23,680 --> 00:37:28,690
Explorer plot process to call back to

1011
00:37:25,990 --> 00:37:31,029
<font color="#CCCCCC">different web servers and</font><font color="#E5E5E5"> then I'm</font><font color="#CCCCCC"> gonna</font>

1012
00:37:28,690 --> 00:37:32,440
<font color="#E5E5E5">try</font><font color="#CCCCCC"> and get an</font><font color="#E5E5E5"> HT a file on a disk I'll</font>

1013
00:37:31,030 --> 00:37:34,780
use done<font color="#CCCCCC"> that to jscript you get that</font>

1014
00:37:32,440 --> 00:37:36,730
<font color="#CCCCCC">c-sharp</font><font color="#E5E5E5"> in the JavaScript and then I'll</font>

1015
00:37:34,780 --> 00:37:38,830
<font color="#CCCCCC">basically use keying to encrypt that</font>

1016
00:37:36,730 --> 00:37:40,359
that<font color="#E5E5E5"> output and then all that that's</font>

1017
00:37:38,830 --> 00:37:41,859
what's<font color="#CCCCCC"> going to be within my HT a</font><font color="#E5E5E5"> file</font>

1018
00:37:40,359 --> 00:37:43,869
then I'm going<font color="#E5E5E5"> to drop to</font><font color="#CCCCCC"> disk somewhere</font>

1019
00:37:41,859 --> 00:37:46,029
<font color="#E5E5E5">and try and find a</font><font color="#CCCCCC"> way some some</font>

1020
00:37:43,869 --> 00:37:49,030
interesting<font color="#CCCCCC"> way to</font><font color="#E5E5E5"> execute MSHDA and</font>

1021
00:37:46,030 --> 00:37:51,160
then the full path to the file<font color="#CCCCCC"> and some</font>

1022
00:37:49,030 --> 00:37:52,810
advantages around that like no network

1023
00:37:51,160 --> 00:37:55,990
connections are being<font color="#E5E5E5"> initiated anywhere</font>

1024
00:37:52,810 --> 00:37:58,359
besides Internet Explorer or<font color="#CCCCCC"> edge MSHDA</font>

1025
00:37:55,990 --> 00:37:59,770
<font color="#E5E5E5">is assigned binary</font><font color="#CCCCCC"> um all of the</font>

1026
00:37:58,359 --> 00:38:03,069
interesting<font color="#E5E5E5"> stuff is still</font><font color="#CCCCCC"> happening in</font>

1027
00:37:59,770 --> 00:38:05,109
memory everyone's looking for<font color="#CCCCCC"> MSHDA</font><font color="#E5E5E5"> with</font>

1028
00:38:03,070 --> 00:38:07,180
a<font color="#E5E5E5"> URL and from a command line logging</font>

1029
00:38:05,109 --> 00:38:09,160
perspective not to pick on miter attack

1030
00:38:07,180 --> 00:38:11,230
but if you just hop on there MSHDA page

1031
00:38:09,160 --> 00:38:13,990
though the<font color="#E5E5E5"> only examples they show are</font>

1032
00:38:11,230 --> 00:38:16,690
using MSHDA to retrieve a remote<font color="#E5E5E5"> HT a</font>

1033
00:38:13,990 --> 00:38:18,250
file and<font color="#E5E5E5"> a bonus for me</font><font color="#CCCCCC"> I do like</font>

1034
00:38:16,690 --> 00:38:20,619
scheduled tasks so it fit<font color="#E5E5E5"> really nicely</font>

1035
00:38:18,250 --> 00:38:24,070
<font color="#CCCCCC">descriptive</font><font color="#E5E5E5"> task but obviously MSHDA</font>

1036
00:38:20,619 --> 00:38:26,109
gets a lot of a lot of<font color="#CCCCCC"> interest so just</font>

1037
00:38:24,070 --> 00:38:30,240
execution<font color="#E5E5E5"> in and of itself may set off</font>

1038
00:38:26,109 --> 00:38:32,319
<font color="#E5E5E5">some alarm so just some closing thoughts</font>

1039
00:38:30,240 --> 00:38:33,790
<font color="#CCCCCC">you know</font><font color="#E5E5E5"> defense I don't want to tell</font>

1040
00:38:32,320 --> 00:38:34,990
you<font color="#E5E5E5"> guys what</font><font color="#CCCCCC"> to do you guys are</font>

1041
00:38:33,790 --> 00:38:37,089
definitely probably<font color="#E5E5E5"> much more smarter</font>

1042
00:38:34,990 --> 00:38:38,290
<font color="#CCCCCC">than I am</font><font color="#E5E5E5"> on the defensive side and I</font>

1043
00:38:37,089 --> 00:38:39,549
<font color="#E5E5E5">think some</font><font color="#CCCCCC"> of these recommendations are</font>

1044
00:38:38,290 --> 00:38:41,529
probably<font color="#E5E5E5"> kind of elementary but</font>

1045
00:38:39,550 --> 00:38:43,300
nonetheless<font color="#E5E5E5"> I definitely want to</font>

1046
00:38:41,530 --> 00:38:44,619
understand the<font color="#E5E5E5"> whole files behaviors</font>

1047
00:38:43,300 --> 00:38:46,720
maybe look for<font color="#E5E5E5"> encryption decryption</font>

1048
00:38:44,619 --> 00:38:47,440
functions<font color="#E5E5E5"> might give you an idea that</font>

1049
00:38:46,720 --> 00:38:50,348
<font color="#CCCCCC">you know key</font>

1050
00:38:47,440 --> 00:38:51,490
as being<font color="#E5E5E5"> used</font><font color="#CCCCCC"> you</font><font color="#E5E5E5"> definitely want to be</font>

1051
00:38:50,349 --> 00:38:53,680
<font color="#CCCCCC">careful interacting with attacker</font>

1052
00:38:51,490 --> 00:38:56,140
infrastructure<font color="#E5E5E5"> not that it might get you</font>

1053
00:38:53,680 --> 00:38:58,598
your pwned but it might set them off and

1054
00:38:56,140 --> 00:39:00,730
understand that you're<font color="#CCCCCC"> onto them</font><font color="#E5E5E5"> along</font>

1055
00:38:58,599 --> 00:39:02,619
<font color="#E5E5E5">with you know running a file you know</font>

1056
00:39:00,730 --> 00:39:04,150
with<font color="#E5E5E5"> internet access maybe you want to</font>

1057
00:39:02,619 --> 00:39:06,010
<font color="#E5E5E5">look</font><font color="#CCCCCC"> at using something like fake</font><font color="#E5E5E5"> net to</font>

1058
00:39:04,150 --> 00:39:08,349
understand you know what<font color="#E5E5E5"> network</font>

1059
00:39:06,010 --> 00:39:09,490
connections is attempting and you know I

1060
00:39:08,349 --> 00:39:10,839
think<font color="#E5E5E5"> we really</font><font color="#CCCCCC"> need</font><font color="#E5E5E5"> to start</font><font color="#CCCCCC"> talking</font>

1061
00:39:09,490 --> 00:39:12,279
about whether<font color="#E5E5E5"> we want to upload</font>

1062
00:39:10,839 --> 00:39:14,290
<font color="#E5E5E5">everything the</font><font color="#CCCCCC"> virustotal</font>

1063
00:39:12,280 --> 00:39:16,089
<font color="#E5E5E5">I know I'm always looking at virustotal</font>

1064
00:39:14,290 --> 00:39:18,220
waiting for things to go up there so I

1065
00:39:16,089 --> 00:39:19,480
know when somebody's<font color="#E5E5E5"> on to me so just</font>

1066
00:39:18,220 --> 00:39:21,759
<font color="#E5E5E5">something as an organization you might</font>

1067
00:39:19,480 --> 00:39:25,030
want to think<font color="#E5E5E5"> about you know how and</font>

1068
00:39:21,760 --> 00:39:27,099
when you're using virustotal<font color="#E5E5E5"> you know it</font>

1069
00:39:25,030 --> 00:39:28,480
kind of<font color="#CCCCCC"> in conclusion I hope that you</font>

1070
00:39:27,099 --> 00:39:30,430
<font color="#CCCCCC">know some</font><font color="#E5E5E5"> of the use</font><font color="#CCCCCC"> cases in some</font><font color="#E5E5E5"> of</font>

1071
00:39:28,480 --> 00:39:31,660
the ways I've been using keying<font color="#E5E5E5"> I'm kind</font>

1072
00:39:30,430 --> 00:39:33,848
<font color="#E5E5E5">of spurred some interest from it from</font>

1073
00:39:31,660 --> 00:39:35,980
everyone else<font color="#CCCCCC"> would definitely say</font><font color="#E5E5E5"> to</font>

1074
00:39:33,849 --> 00:39:37,270
please key responsibly<font color="#CCCCCC"> I've just been</font>

1075
00:39:35,980 --> 00:39:38,890
talking<font color="#E5E5E5"> about hiding things</font><font color="#CCCCCC"> from the</font>

1076
00:39:37,270 --> 00:39:41,170
blue team all and you're like<font color="#CCCCCC"> for 45</font>

1077
00:39:38,890 --> 00:39:42,670
<font color="#E5E5E5">minutes or so obviously after the</font>

1078
00:39:41,170 --> 00:39:44,829
exercise we would still<font color="#CCCCCC"> want</font><font color="#E5E5E5"> to share</font>

1079
00:39:42,670 --> 00:39:47,500
those those indicators those behaviors

1080
00:39:44,829 --> 00:39:48,670
<font color="#E5E5E5">and maybe even code because you know at</font>

1081
00:39:47,500 --> 00:39:51,670
the end<font color="#E5E5E5"> that's that's really</font><font color="#CCCCCC"> what it's</font>

1082
00:39:48,670 --> 00:39:53,290
all<font color="#E5E5E5"> about so you know I do have</font><font color="#CCCCCC"> some</font>

1083
00:39:51,670 --> 00:39:57,130
<font color="#E5E5E5">tools they'll be up on github here soon</font>

1084
00:39:53,290 --> 00:40:00,190
<font color="#CCCCCC">I can take questions now yeah</font><font color="#E5E5E5"> definitely</font>

1085
00:39:57,130 --> 00:40:01,859
can take<font color="#E5E5E5"> questions now</font><font color="#CCCCCC"> or you guys can</font>

1086
00:40:00,190 --> 00:40:12,940
<font color="#E5E5E5">catch up with</font><font color="#CCCCCC"> me sometime afterwards so</font>

1087
00:40:01,859 --> 00:40:16,109
any specific questions all<font color="#CCCCCC"> right well</font>

1088
00:40:12,940 --> 00:40:16,109
thanks this<font color="#CCCCCC"> is a really</font><font color="#E5E5E5"> good</font><font color="#CCCCCC"> experience</font>

