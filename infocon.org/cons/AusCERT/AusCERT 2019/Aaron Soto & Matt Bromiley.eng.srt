1
00:00:00,030 --> 00:00:05,910
we'll get underway so got Aaron Soto and

2
00:00:02,700 --> 00:00:08,370
Matt Bromley they've they're from rapid7

3
00:00:05,910 --> 00:00:11,000
in sans so if everyone could kindly

4
00:00:08,370 --> 00:00:14,399
welcome them of the round of applause

5
00:00:11,000 --> 00:00:16,109
they're gonna be talking about purple

6
00:00:14,400 --> 00:00:18,359
packets effective network defense

7
00:00:16,109 --> 00:00:20,789
against real-word attacks and we'll talk

8
00:00:18,359 --> 00:00:22,289
about some of it recently so I'm really

9
00:00:20,789 --> 00:00:25,260
looking forward to these one this one

10
00:00:22,289 --> 00:00:26,369
guys excellent thanks everyone thanks

11
00:00:25,260 --> 00:00:28,140
for coming out today hopefully everyone

12
00:00:26,369 --> 00:00:31,800
enjoyed their morning tea as you can

13
00:00:28,140 --> 00:00:32,850
tell I am NOT from Australia so that

14
00:00:31,800 --> 00:00:35,700
part should be pretty obvious

15
00:00:32,850 --> 00:00:37,920
neither is aaron here but we're super

16
00:00:35,700 --> 00:00:39,570
excited to be here with everyone you

17
00:00:37,920 --> 00:00:40,920
know I'm not gonna lie someone reaches

18
00:00:39,570 --> 00:00:42,090
out and says hey we're having a

19
00:00:40,920 --> 00:00:43,820
conference at the Gold Coast would you

20
00:00:42,090 --> 00:00:47,460
like to come speak our answer usually is

21
00:00:43,820 --> 00:00:49,530
without a down now yeah for sure

22
00:00:47,460 --> 00:00:51,000
absolutely but it's been an absolutely

23
00:00:49,530 --> 00:00:52,620
amazing few days so thank you everyone

24
00:00:51,000 --> 00:00:54,449
for joining us and I'm gonna do my best

25
00:00:52,620 --> 00:00:55,919
to stay within range of talking into the

26
00:00:54,449 --> 00:00:58,739
mic we usually have a stage which is

27
00:00:55,920 --> 00:01:00,539
like a walking we're we're logging miles

28
00:00:58,739 --> 00:01:01,739
as we walk through this one but we're

29
00:01:00,539 --> 00:01:02,969
gonna stand next to each other and

30
00:01:01,739 --> 00:01:05,700
hopefully not kill each other in the

31
00:01:02,969 --> 00:01:09,560
process all right so welcome to purple

32
00:01:05,700 --> 00:01:11,700
packets this is a really a labor of

33
00:01:09,560 --> 00:01:13,860
passion and interest between Aaron and

34
00:01:11,700 --> 00:01:15,630
myself I guess traditionally you could

35
00:01:13,860 --> 00:01:17,640
say we've both sat in kind of red or

36
00:01:15,630 --> 00:01:19,289
blue roles which means we bring really

37
00:01:17,640 --> 00:01:21,000
really awesome perspectives to solving

38
00:01:19,290 --> 00:01:22,530
various problems and we were like hey we

39
00:01:21,000 --> 00:01:24,180
wonder if other folks are you know

40
00:01:22,530 --> 00:01:25,470
looking at these the same way we're

41
00:01:24,180 --> 00:01:26,759
gonna talk very very brief about who we

42
00:01:25,470 --> 00:01:28,200
are and we're gonna get into why we're

43
00:01:26,759 --> 00:01:29,520
doing this but we really want to get to

44
00:01:28,200 --> 00:01:31,710
the heart of the matter which is

45
00:01:29,520 --> 00:01:34,048
starting to analyze traffic starting to

46
00:01:31,710 --> 00:01:35,939
analyze at a core activity and we also

47
00:01:34,049 --> 00:01:37,860
have a nice little surprise built up at

48
00:01:35,939 --> 00:01:39,869
the end of this for everyone as well we

49
00:01:37,860 --> 00:01:43,229
have some pretty groundbreaking how old

50
00:01:39,869 --> 00:01:45,799
now 36 hours about that yeah 36 hour old

51
00:01:43,229 --> 00:01:49,110
research that is hopefully going to

52
00:01:45,799 --> 00:01:50,430
never be needed absolutely which is the

53
00:01:49,110 --> 00:01:51,600
worst type of research you can do but

54
00:01:50,430 --> 00:01:54,090
also the best ever research so we'll

55
00:01:51,600 --> 00:01:55,919
talk about that in any event sure thing

56
00:01:54,090 --> 00:01:57,630
yeah so let's get started just very very

57
00:01:55,920 --> 00:02:00,719
briefly who we are my name is Aaron soda

58
00:01:57,630 --> 00:02:02,640
I'm an exploit developer I've kind of as

59
00:02:00,719 --> 00:02:03,689
matt said we kind of have have walked

60
00:02:02,640 --> 00:02:05,460
the red and blue lines a little bit

61
00:02:03,689 --> 00:02:07,529
separately and so I'm a little bit more

62
00:02:05,460 --> 00:02:08,848
traditionally towards the red side for

63
00:02:07,530 --> 00:02:10,590
those of you who are familiar with

64
00:02:08,848 --> 00:02:11,790
there's a competition called CCDC the

65
00:02:10,590 --> 00:02:13,530
cyber collegiate defense competition

66
00:02:11,790 --> 00:02:15,000
working with college students to tee

67
00:02:13,530 --> 00:02:17,490
to them how to protect themselves

68
00:02:15,000 --> 00:02:18,630
against hackers there's a competition of

69
00:02:17,490 --> 00:02:20,250
DEFCON just out of curiosity how many

70
00:02:18,630 --> 00:02:22,350
folks have been to Def Con before just

71
00:02:20,250 --> 00:02:23,760
to get a feel so if you if you're if

72
00:02:22,350 --> 00:02:25,019
you're going this year there's a the

73
00:02:23,760 --> 00:02:27,359
blue team village which Matt and I are

74
00:02:25,020 --> 00:02:28,980
both part of and there's a capture the

75
00:02:27,360 --> 00:02:31,020
flag competition called open sock where

76
00:02:28,980 --> 00:02:33,690
we talk about or we we get as much

77
00:02:31,020 --> 00:02:36,180
hands-on experience with some of these

78
00:02:33,690 --> 00:02:38,040
attacks as possible and then also just

79
00:02:36,180 --> 00:02:40,590
you know a cuz I'm a nerd I'm a ham

80
00:02:38,040 --> 00:02:42,929
radio guy but but fundamentally I love

81
00:02:40,590 --> 00:02:45,060
open source I love the exploits side of

82
00:02:42,930 --> 00:02:46,890
things awesome and I'm Matt obviously I

83
00:02:45,060 --> 00:02:48,570
got us started off this afternoon I am

84
00:02:46,890 --> 00:02:50,850
an instant responder by trade practice

85
00:02:48,570 --> 00:02:52,530
free time spare time whatever maybe I

86
00:02:50,850 --> 00:02:54,480
also happen to be an instructor with

87
00:02:52,530 --> 00:02:56,190
sans I teach our advanced host forensics

88
00:02:54,480 --> 00:02:57,720
and advanced network forensics if any

89
00:02:56,190 --> 00:02:59,489
I've had you any of you in class it's

90
00:02:57,720 --> 00:03:01,620
really bright up here so I apologize for

91
00:02:59,489 --> 00:03:03,569
not recognizing you here and last but

92
00:03:01,620 --> 00:03:05,280
not least Erin likes to play with ham

93
00:03:03,569 --> 00:03:07,859
radios I like to put nerd stuff on my

94
00:03:05,280 --> 00:03:10,980
body and I have nerdy pink tattoos on

95
00:03:07,860 --> 00:03:12,480
that's what that's wrong as well let's

96
00:03:10,980 --> 00:03:15,959
talk a little bit about the importance

97
00:03:12,480 --> 00:03:19,018
of this why this is crucial why we're

98
00:03:15,959 --> 00:03:21,030
talking about this if you will I will

99
00:03:19,019 --> 00:03:24,660
start out by really saying that there's

100
00:03:21,030 --> 00:03:26,160
a lot a lot a lot of focus on the way

101
00:03:24,660 --> 00:03:27,870
that attackers do what they do from the

102
00:03:26,160 --> 00:03:29,489
hosts perspective and that's nice

103
00:03:27,870 --> 00:03:31,320
because there's a lot of way an attacker

104
00:03:29,489 --> 00:03:32,790
can launch a piece of executable code

105
00:03:31,320 --> 00:03:34,890
can escalate privileges can establish

106
00:03:32,790 --> 00:03:36,480
persistence maintain persistence defeat

107
00:03:34,890 --> 00:03:38,429
different operating systems that's all

108
00:03:36,480 --> 00:03:39,899
cool and great but what we found during

109
00:03:38,430 --> 00:03:42,060
a lot of our research is that attackers

110
00:03:39,900 --> 00:03:43,440
tend to really ignore the one area where

111
00:03:42,060 --> 00:03:45,359
it's easiest to catch them was inside of

112
00:03:43,440 --> 00:03:47,220
the network protocol and what you'll see

113
00:03:45,359 --> 00:03:49,140
and no offense to you know Metasploit

114
00:03:47,220 --> 00:03:51,150
aaron standing up here on stage wow look

115
00:03:49,140 --> 00:03:52,559
at this amazing thing I can craft and

116
00:03:51,150 --> 00:03:54,900
create oh cool

117
00:03:52,560 --> 00:03:57,570
how does it talk oh it talks over HTTP

118
00:03:54,900 --> 00:03:58,859
really like you worked all this time to

119
00:03:57,570 --> 00:04:01,350
make this amazing thing and then sent it

120
00:03:58,859 --> 00:04:03,060
over a plaintext protocol so we really

121
00:04:01,350 --> 00:04:05,549
wanted to kind of hinge off of that and

122
00:04:03,060 --> 00:04:07,140
take the kind of unique approach of is

123
00:04:05,549 --> 00:04:08,130
there a way that we can look at the

124
00:04:07,140 --> 00:04:11,040
network side of things to identify

125
00:04:08,130 --> 00:04:12,900
traffic a lot faster than perhaps

126
00:04:11,040 --> 00:04:15,000
waiting for the hoax to be compromised

127
00:04:12,900 --> 00:04:17,728
or waiting for a time further on down

128
00:04:15,000 --> 00:04:19,470
the road the importance of red-and-blue

129
00:04:17,728 --> 00:04:22,440
really we think exists in our working

130
00:04:19,470 --> 00:04:24,570
together so from a blu perspective we

131
00:04:22,440 --> 00:04:26,190
often think of ourselves as defenders

132
00:04:24,570 --> 00:04:27,840
were the ones that are

133
00:04:26,190 --> 00:04:28,800
resort to responding to attacks and

134
00:04:27,840 --> 00:04:30,150
we're the ones that are having to deal

135
00:04:28,800 --> 00:04:32,250
with these things later on down the line

136
00:04:30,150 --> 00:04:33,810
and unfortunately in my career I've seen

137
00:04:32,250 --> 00:04:35,490
way too many times where the red team is

138
00:04:33,810 --> 00:04:37,500
just pushed off to the side as these

139
00:04:35,490 --> 00:04:40,440
annoying kids who pop up once a quarter

140
00:04:37,500 --> 00:04:42,810
and I mean well I'm not saying they're

141
00:04:40,440 --> 00:04:45,150
wrong I'm just saying that's the that's

142
00:04:42,810 --> 00:04:47,160
the wrong approach as a blue team er you

143
00:04:45,150 --> 00:04:48,780
should be actively looking to learn from

144
00:04:47,160 --> 00:04:50,430
how red does what they do because

145
00:04:48,780 --> 00:04:51,630
they're going to find the novel ways

146
00:04:50,430 --> 00:04:53,640
into your environment they're gonna find

147
00:04:51,630 --> 00:04:55,469
the things that you never thought of and

148
00:04:53,640 --> 00:04:57,180
to be completely Frank and I'll let

149
00:04:55,470 --> 00:04:59,040
Aaron talk about the red side here in a

150
00:04:57,180 --> 00:05:01,140
second but to be completely Frank I

151
00:04:59,040 --> 00:05:03,000
would rather he find it because I'm

152
00:05:01,140 --> 00:05:05,340
asking him to find it as opposed to I

153
00:05:03,000 --> 00:05:06,990
discovered that China found it four

154
00:05:05,340 --> 00:05:08,789
years ago that's the other side of the

155
00:05:06,990 --> 00:05:10,020
equation we don't want to be in now sure

156
00:05:08,790 --> 00:05:12,690
I think he can benefits from us -

157
00:05:10,020 --> 00:05:14,370
absolutely yeah so it's easy from a red

158
00:05:12,690 --> 00:05:15,750
teamers perspective to say well this is

159
00:05:14,370 --> 00:05:16,860
the glamorous side right this is well

160
00:05:15,750 --> 00:05:18,720
this is the side there he's talking

161
00:05:16,860 --> 00:05:21,900
about the latest exploits the newest

162
00:05:18,720 --> 00:05:24,330
attacks this is what what is easy to

163
00:05:21,900 --> 00:05:26,969
sensationalize no one in Hollywood makes

164
00:05:24,330 --> 00:05:29,150
a blue team or a Hollywood you know that

165
00:05:26,970 --> 00:05:31,830
the character of a hacker maybe sorry

166
00:05:29,150 --> 00:05:32,340
you know I got a fantastic face for

167
00:05:31,830 --> 00:05:35,940
radio

168
00:05:32,340 --> 00:05:37,830
but I have to admit that if I want to be

169
00:05:35,940 --> 00:05:39,390
a good red teamer I need to understand

170
00:05:37,830 --> 00:05:41,400
the tactics the blue team on and need to

171
00:05:39,390 --> 00:05:42,900
understand how to challenge them by

172
00:05:41,400 --> 00:05:44,520
looking by going to places that they are

173
00:05:42,900 --> 00:05:46,140
in looking by introducing techniques

174
00:05:44,520 --> 00:05:47,969
that they're not ready for and so I

175
00:05:46,140 --> 00:05:49,140
can't just say oh you know I love

176
00:05:47,970 --> 00:05:51,360
exploit development I'm gonna write

177
00:05:49,140 --> 00:05:52,830
exploits all day I mean I can but I'm

178
00:05:51,360 --> 00:05:54,720
not gonna be as good of a red teamers I

179
00:05:52,830 --> 00:05:57,270
can be and so that's what we're focusing

180
00:05:54,720 --> 00:05:59,640
on is we're gonna make this case that we

181
00:05:57,270 --> 00:06:02,039
we can learn from each other we do learn

182
00:05:59,640 --> 00:06:04,380
from each other and Matt and I are very

183
00:06:02,040 --> 00:06:05,760
big into giving you examples we're not

184
00:06:04,380 --> 00:06:07,830
gonna stand here and talk about it we're

185
00:06:05,760 --> 00:06:09,480
gonna show you how yeah that's really it

186
00:06:07,830 --> 00:06:10,909
on the discussion side the only thing

187
00:06:09,480 --> 00:06:13,860
I'll add to what Aaron just said is

188
00:06:10,910 --> 00:06:15,000
there was one thing I heard as this was

189
00:06:13,860 --> 00:06:16,800
probably in the past three months or so

190
00:06:15,000 --> 00:06:18,540
there was one thing I heard that really

191
00:06:16,800 --> 00:06:19,669
kind of strengthened this talk from me

192
00:06:18,540 --> 00:06:21,870
which was I was helping an organization

193
00:06:19,669 --> 00:06:23,430
respond to an incident they had just

194
00:06:21,870 --> 00:06:24,450
gone under a legitimate pen test meaning

195
00:06:23,430 --> 00:06:26,310
they were paying for it was their

196
00:06:24,450 --> 00:06:28,169
quarterly whatever and the pen test

197
00:06:26,310 --> 00:06:29,730
report came back and one of the active

198
00:06:28,169 --> 00:06:31,770
directory administrators said out loud

199
00:06:29,730 --> 00:06:34,320
after reading the report thank God they

200
00:06:31,770 --> 00:06:36,780
didn't find system XYZ and I'm thinking

201
00:06:34,320 --> 00:06:38,550
in my head like why

202
00:06:36,780 --> 00:06:40,349
is that a good thing and he's like

203
00:06:38,550 --> 00:06:42,930
because that system would have made this

204
00:06:40,350 --> 00:06:44,400
so much easier for them and I'm like I

205
00:06:42,930 --> 00:06:46,650
would have loved to for the red team to

206
00:06:44,400 --> 00:06:48,120
have known that because as a blue team I

207
00:06:46,650 --> 00:06:49,979
mean there's the obvious question let's

208
00:06:48,120 --> 00:06:52,500
patch that vulnerability but the other

209
00:06:49,980 --> 00:06:53,940
side of it is they found a way that was

210
00:06:52,500 --> 00:06:55,710
not the easy and I'm not saying Aaron

211
00:06:53,940 --> 00:06:58,290
directly but the red side found a way in

212
00:06:55,710 --> 00:07:00,510
which was not the easiest way that's a

213
00:06:58,290 --> 00:07:01,860
true test of Defense's so it keeps being

214
00:07:00,510 --> 00:07:03,480
solidified as we work with more and

215
00:07:01,860 --> 00:07:04,830
Morgana's ations they keep having this

216
00:07:03,480 --> 00:07:05,910
stance of all thank god this thing

217
00:07:04,830 --> 00:07:07,859
didn't happen or i can't believe how

218
00:07:05,910 --> 00:07:09,450
easy that was and we don't want teams to

219
00:07:07,860 --> 00:07:11,730
be confounded anymore so there we go

220
00:07:09,450 --> 00:07:13,469
that's our discussion on why now let's

221
00:07:11,730 --> 00:07:14,460
talk about the what the interesting part

222
00:07:13,470 --> 00:07:15,740
absolutely we're gonna get us some

223
00:07:14,460 --> 00:07:17,609
examples now we're gonna have some fun

224
00:07:15,740 --> 00:07:19,770
by the way I hope you're all paying

225
00:07:17,610 --> 00:07:21,870
attention you're gonna need it very very

226
00:07:19,770 --> 00:07:23,669
shortly for sure so let's talk about a

227
00:07:21,870 --> 00:07:25,080
pretty textbook scenario from a Red Team

228
00:07:23,669 --> 00:07:26,490
perspective so I'm an attacker I'm

229
00:07:25,080 --> 00:07:28,409
outside a network I want to get inside

230
00:07:26,490 --> 00:07:30,240
the network step one the thing that's

231
00:07:28,410 --> 00:07:31,620
probably the easiest most reliable least

232
00:07:30,240 --> 00:07:33,390
sophisticated I don't have to have a no

233
00:07:31,620 --> 00:07:35,639
day or anything spear phishing attack

234
00:07:33,390 --> 00:07:37,500
right send up some emails if I craft

235
00:07:35,639 --> 00:07:39,479
them particularly well I can get a user

236
00:07:37,500 --> 00:07:42,360
to click on a link open an email execute

237
00:07:39,479 --> 00:07:44,969
a payload it will happen eventually it's

238
00:07:42,360 --> 00:07:46,500
it's a tried-and-true tactic so who

239
00:07:44,970 --> 00:07:47,910
doesn't want a new friend on Facebook

240
00:07:46,500 --> 00:07:51,510
I'm just saying

241
00:07:47,910 --> 00:07:53,520
who doesn't so we get we get our access

242
00:07:51,510 --> 00:07:56,219
into the network as a red teamer from

243
00:07:53,520 --> 00:07:59,039
there obviously the the traditional red

244
00:07:56,220 --> 00:08:00,539
team perspective is I want I want domain

245
00:07:59,039 --> 00:08:01,919
control I want to be a domain

246
00:08:00,539 --> 00:08:03,990
administrator I want to dump credentials

247
00:08:01,919 --> 00:08:05,460
I want access to everything obviously

248
00:08:03,990 --> 00:08:07,530
there might be some steps in between but

249
00:08:05,460 --> 00:08:09,930
that's that's my goal is to pivot inside

250
00:08:07,530 --> 00:08:10,890
the network laterally move escalate up

251
00:08:09,930 --> 00:08:13,169
until the point of a domain

252
00:08:10,890 --> 00:08:14,580
administrator once I get either those

253
00:08:13,169 --> 00:08:15,690
credentials once I get the sensitive

254
00:08:14,580 --> 00:08:16,950
information I'm after I'm at actual

255
00:08:15,690 --> 00:08:18,150
trade obviously there's a lot of

256
00:08:16,950 --> 00:08:20,039
flourish that can happen in here but the

257
00:08:18,150 --> 00:08:21,750
workflow is generally the same right and

258
00:08:20,039 --> 00:08:24,060
that's our talk have a great afternoon

259
00:08:21,750 --> 00:08:26,400
there you go it's easy so just stop

260
00:08:24,060 --> 00:08:28,410
there well okay so let's walk through

261
00:08:26,400 --> 00:08:30,210
these steps I want to get initial access

262
00:08:28,410 --> 00:08:31,590
there's a lot of tools to do this how

263
00:08:30,210 --> 00:08:32,699
many folks have used like a social

264
00:08:31,590 --> 00:08:34,439
engineering toolkit any kind of these

265
00:08:32,700 --> 00:08:36,180
tools that generate social engineering

266
00:08:34,440 --> 00:08:38,250
campaigns they're pretty common for sure

267
00:08:36,179 --> 00:08:40,199
and and so then you know how easy this

268
00:08:38,250 --> 00:08:41,490
is they're they're constantly tools

269
00:08:40,200 --> 00:08:42,810
being released all the time everybody

270
00:08:41,490 --> 00:08:44,670
kind of has their own techniques their

271
00:08:42,809 --> 00:08:46,619
own tools but they're they're how their

272
00:08:44,670 --> 00:08:47,969
handful out there for for this just to

273
00:08:46,620 --> 00:08:49,260
kind of introduce something a little bit

274
00:08:47,970 --> 00:08:50,240
different how many folks have used go

275
00:08:49,260 --> 00:08:54,300
fish before

276
00:08:50,240 --> 00:08:55,830
okay a couple okay yeah excellent so for

277
00:08:54,300 --> 00:08:58,469
those of you who haven't go fish ISM is

278
00:08:55,830 --> 00:09:00,000
a very simple web web-based fishing tool

279
00:08:58,470 --> 00:09:01,890
so it's very easy to craft a campaign

280
00:09:00,000 --> 00:09:04,140
here here I have a campaign I'm sending

281
00:09:01,890 --> 00:09:06,180
that is impersonating Dropbox and I'm

282
00:09:04,140 --> 00:09:08,640
saying hey there's a new iOS iOS device

283
00:09:06,180 --> 00:09:10,530
that just signed in it's from China was

284
00:09:08,640 --> 00:09:14,640
that you and obviously I'm trying to

285
00:09:10,530 --> 00:09:16,319
entice a user to go no that was not me I

286
00:09:14,640 --> 00:09:18,960
need to click this no button as fast as

287
00:09:16,320 --> 00:09:20,190
humanly possible and so I can I can

288
00:09:18,960 --> 00:09:22,590
target this to a single user I can

289
00:09:20,190 --> 00:09:24,450
target this to a group of users in this

290
00:09:22,590 --> 00:09:26,370
case I might just pick one and I can

291
00:09:24,450 --> 00:09:27,690
track the progress of that campaign when

292
00:09:26,370 --> 00:09:29,550
it was created if the email has been

293
00:09:27,690 --> 00:09:31,140
opened if the link has been clicked what

294
00:09:29,550 --> 00:09:33,630
the user has done in response to that

295
00:09:31,140 --> 00:09:35,100
and so from users perspective they are

296
00:09:33,630 --> 00:09:37,740
looking at their email they get this to

297
00:09:35,100 --> 00:09:39,510
come in they have this fairly convincing

298
00:09:37,740 --> 00:09:41,880
looking email that says it's from

299
00:09:39,510 --> 00:09:43,590
Dropbox security it's got the Dropbox

300
00:09:41,880 --> 00:09:45,930
logo it's actually using the same style

301
00:09:43,590 --> 00:09:47,370
the Dropbox itself uses and if they go

302
00:09:45,930 --> 00:09:48,599
ahead and click on that link they're

303
00:09:47,370 --> 00:09:51,390
gonna get transported to a page that

304
00:09:48,600 --> 00:09:53,400
looks very convincingly like Dropbox has

305
00:09:51,390 --> 00:09:57,540
anyone seen this page before look

306
00:09:53,400 --> 00:10:00,620
familiar right so let's talk afterwards

307
00:09:57,540 --> 00:10:02,099
if it does yeah what about this page

308
00:10:00,620 --> 00:10:05,280
seen that one before

309
00:10:02,100 --> 00:10:07,680
well quick pop quiz which is the real

310
00:10:05,280 --> 00:10:09,420
page come on secure people you're asking

311
00:10:07,680 --> 00:10:11,520
your users I do this in five seconds via

312
00:10:09,420 --> 00:10:13,110
email let's go one two three four all

313
00:10:11,520 --> 00:10:14,430
right you gotta make a decision somebody

314
00:10:13,110 --> 00:10:16,260
is sliding into your Dropbox account

315
00:10:14,430 --> 00:10:17,489
right now from China and you need to get

316
00:10:16,260 --> 00:10:18,030
your password in here as quickly as

317
00:10:17,490 --> 00:10:22,260
possible

318
00:10:18,030 --> 00:10:23,939
well we have the legit page and we have

319
00:10:22,260 --> 00:10:25,950
the fake page and obviously you can make

320
00:10:23,940 --> 00:10:28,290
these look as realistic as you want this

321
00:10:25,950 --> 00:10:29,730
took just a matter of minutes but if you

322
00:10:28,290 --> 00:10:30,990
look closely on this fake page it says

323
00:10:29,730 --> 00:10:32,460
to unlock your account you need to log

324
00:10:30,990 --> 00:10:33,990
in and download our secure desktop

325
00:10:32,460 --> 00:10:36,150
scanning software so we're just gonna

326
00:10:33,990 --> 00:10:38,190
make sure your machines okay before we

327
00:10:36,150 --> 00:10:39,480
reopen access to your Dropbox account

328
00:10:38,190 --> 00:10:40,740
but first obviously I need your

329
00:10:39,480 --> 00:10:42,240
credentials to do that I would actually

330
00:10:40,740 --> 00:10:44,340
need the credentials I just want them to

331
00:10:42,240 --> 00:10:45,870
download my scanner but by presenting

332
00:10:44,340 --> 00:10:47,070
myself as Dropbox by asking for

333
00:10:45,870 --> 00:10:48,930
credentials number one it's an easier

334
00:10:47,070 --> 00:10:50,190
whim and number two maybe I'm even

335
00:10:48,930 --> 00:10:51,569
convincing the user that this is a

336
00:10:50,190 --> 00:10:54,870
little bit more legit by looking like

337
00:10:51,570 --> 00:10:56,220
the page that they're used to so how

338
00:10:54,870 --> 00:10:58,650
many folks have used a meterpreter shell

339
00:10:56,220 --> 00:11:00,600
before Metasploit interpreter that it's

340
00:10:58,650 --> 00:11:03,060
very simple so you know how easy this is

341
00:11:00,600 --> 00:11:03,450
to create in this case for instance an

342
00:11:03,060 --> 00:11:04,890
Exe

343
00:11:03,450 --> 00:11:06,510
phile I'm calling at Dropbox security

344
00:11:04,890 --> 00:11:07,860
scanner and it's a very simple payload

345
00:11:06,510 --> 00:11:09,750
to call me back on an IP address

346
00:11:07,860 --> 00:11:11,910
obviously this is by way of example

347
00:11:09,750 --> 00:11:14,100
there are many tools to do this but now

348
00:11:11,910 --> 00:11:16,650
I have an encrypted connection to a user

349
00:11:14,100 --> 00:11:18,300
to a user's workstation and I have my

350
00:11:16,650 --> 00:11:19,709
initial foothold into that network right

351
00:11:18,300 --> 00:11:21,930
for anyone who's taking notes here by

352
00:11:19,710 --> 00:11:23,460
the way we do own packets dev but this

353
00:11:21,930 --> 00:11:25,319
has been taken down so sorry there's no

354
00:11:23,460 --> 00:11:27,780
fishing link up there in case you wanted

355
00:11:25,320 --> 00:11:29,520
some creds sure all right

356
00:11:27,780 --> 00:11:31,439
so at this point Aaron thinks he's all

357
00:11:29,520 --> 00:11:33,990
sneaky he's got his initial access in

358
00:11:31,440 --> 00:11:36,210
he's got a shell talking back now from

359
00:11:33,990 --> 00:11:38,550
an email perspective this really is a

360
00:11:36,210 --> 00:11:40,650
tougher area I'll admit a tougher area

361
00:11:38,550 --> 00:11:42,660
sometimes for Network introspection I'm

362
00:11:40,650 --> 00:11:43,860
going to remove email examination

363
00:11:42,660 --> 00:11:45,480
clients outside of this because we're

364
00:11:43,860 --> 00:11:47,160
gonna pull that into content examination

365
00:11:45,480 --> 00:11:49,230
but my email could be in a third party

366
00:11:47,160 --> 00:11:50,699
my email could be in some sort of an

367
00:11:49,230 --> 00:11:52,560
encrypted traffic it just depends on how

368
00:11:50,700 --> 00:11:54,570
our setup is if we're using node 365

369
00:11:52,560 --> 00:11:54,959
versus on-prem exchange so on and so

370
00:11:54,570 --> 00:11:56,640
forth

371
00:11:54,960 --> 00:11:57,900
so at this point he still may have a

372
00:11:56,640 --> 00:12:00,240
little bit of an advantage from the

373
00:11:57,900 --> 00:12:02,189
initial access but it's that initial

374
00:12:00,240 --> 00:12:04,590
user call out that I can start to pivot

375
00:12:02,190 --> 00:12:06,360
for so I can look for suspicious HTTP I

376
00:12:04,590 --> 00:12:08,370
can look for so let's see suspicious DNS

377
00:12:06,360 --> 00:12:09,930
requests because he may not always use a

378
00:12:08,370 --> 00:12:12,660
legitimate domain I could look for

379
00:12:09,930 --> 00:12:14,459
things not Dropbox but Dropbox com so on

380
00:12:12,660 --> 00:12:15,839
and so forth I could also pivot through

381
00:12:14,460 --> 00:12:17,700
some of his user agents because

382
00:12:15,840 --> 00:12:19,890
unfortunately once again he's in the

383
00:12:17,700 --> 00:12:22,260
world of I'm gonna send you an email I'm

384
00:12:19,890 --> 00:12:24,000
gonna craft something in HTTP that HTTP

385
00:12:22,260 --> 00:12:25,830
usually has some sort of a structure to

386
00:12:24,000 --> 00:12:27,480
it the absence of a structure is

387
00:12:25,830 --> 00:12:28,710
something I can look for structure is

388
00:12:27,480 --> 00:12:30,060
going to become very crucial for us

389
00:12:28,710 --> 00:12:31,800
defenders as we walk through some of

390
00:12:30,060 --> 00:12:33,300
these examples here but I'll give Aaron

391
00:12:31,800 --> 00:12:34,439
a little bit of advantage here and I'll

392
00:12:33,300 --> 00:12:36,180
say you know what you came in with a

393
00:12:34,440 --> 00:12:37,770
phishing email I'm gonna ask my users to

394
00:12:36,180 --> 00:12:40,050
be a little bit better but depending on

395
00:12:37,770 --> 00:12:41,730
where our email is I may not have every

396
00:12:40,050 --> 00:12:43,890
opportunity to detect him here and there

397
00:12:41,730 --> 00:12:46,080
again we're removing host based

398
00:12:43,890 --> 00:12:47,790
examination we're removing email content

399
00:12:46,080 --> 00:12:50,190
examination from this I want to catch

400
00:12:47,790 --> 00:12:52,560
him a different way at that packet level

401
00:12:50,190 --> 00:12:54,270
so we'll let him continue on thinking

402
00:12:52,560 --> 00:12:56,880
he's won this round all right well

403
00:12:54,270 --> 00:12:59,579
obviously I have so I have my initial

404
00:12:56,880 --> 00:13:01,230
access right and so now I want to go

405
00:12:59,580 --> 00:13:03,300
ahead and acquire some credentials as

406
00:13:01,230 --> 00:13:05,700
matt said there are a number of

407
00:13:03,300 --> 00:13:06,990
protocols that I'm taking advantage of

408
00:13:05,700 --> 00:13:08,850
that might be leaving some traces behind

409
00:13:06,990 --> 00:13:10,950
but if I have the credit credentials of

410
00:13:08,850 --> 00:13:12,570
a legitimate user now things can get

411
00:13:10,950 --> 00:13:14,070
much more difficult for them so let's

412
00:13:12,570 --> 00:13:16,280
talk about how I could do that how many

413
00:13:14,070 --> 00:13:18,980
folks have used me me cats before

414
00:13:16,280 --> 00:13:20,270
yeah all right so for those of you who

415
00:13:18,980 --> 00:13:22,430
are unaware Mimi Katz is a tool that

416
00:13:20,270 --> 00:13:25,069
lets me dump credentials from local

417
00:13:22,430 --> 00:13:26,510
workstations from various credential

418
00:13:25,070 --> 00:13:28,490
caches on a local machine and

419
00:13:26,510 --> 00:13:29,960
potentially even over a network but

420
00:13:28,490 --> 00:13:31,190
there's there's actually a really cool

421
00:13:29,960 --> 00:13:32,600
tool so there's obviously several

422
00:13:31,190 --> 00:13:33,920
methods but there's one that I really

423
00:13:32,600 --> 00:13:38,380
like to focus on for just a moment and

424
00:13:33,920 --> 00:13:41,510
it's called DC sync and so DC sync is a

425
00:13:38,380 --> 00:13:43,760
module built into Mimi Katz that allows

426
00:13:41,510 --> 00:13:45,140
me to effectively impersonate a domain

427
00:13:43,760 --> 00:13:46,460
controller so damn it there you have

428
00:13:45,140 --> 00:13:47,720
multiple domain controllers they talk

429
00:13:46,460 --> 00:13:50,690
using this thing called the Directory

430
00:13:47,720 --> 00:13:52,820
replication service DRS and Mimi Katz

431
00:13:50,690 --> 00:13:54,490
has the ability to act as though it were

432
00:13:52,820 --> 00:13:56,330
a domain controller and with

433
00:13:54,490 --> 00:13:59,150
administrative credentials lets me

434
00:13:56,330 --> 00:14:00,950
download everything in that credential

435
00:13:59,150 --> 00:14:03,110
store and so that includes things like

436
00:14:00,950 --> 00:14:04,520
the security idea of the users things

437
00:14:03,110 --> 00:14:06,770
like password hashes including previous

438
00:14:04,520 --> 00:14:08,030
password hashes fundamentally I get to

439
00:14:06,770 --> 00:14:09,290
pretend I'm on the main controller and

440
00:14:08,030 --> 00:14:10,910
say yeah I need these things to do my

441
00:14:09,290 --> 00:14:12,349
job please give them to me now

442
00:14:10,910 --> 00:14:13,699
now as a defender I'm gonna point out

443
00:14:12,350 --> 00:14:14,900
two things Aaron's not done walking

444
00:14:13,700 --> 00:14:15,860
through this part yet but as a defender

445
00:14:14,900 --> 00:14:17,569
I want to point out two things that he

446
00:14:15,860 --> 00:14:18,920
said number one some of you may have

447
00:14:17,570 --> 00:14:19,670
also heard of this attack referred to as

448
00:14:18,920 --> 00:14:20,990
dcpromo

449
00:14:19,670 --> 00:14:22,250
that's another term that it goes by so

450
00:14:20,990 --> 00:14:23,510
if you're like I haven't heard of DC

451
00:14:22,250 --> 00:14:24,980
sync you may have it's just something

452
00:14:23,510 --> 00:14:26,240
else but there's another point I want to

453
00:14:24,980 --> 00:14:27,740
point out if you notice Aaron said

454
00:14:26,240 --> 00:14:28,130
there's a preferred way I have of doing

455
00:14:27,740 --> 00:14:29,810
things

456
00:14:28,130 --> 00:14:32,060
defenders when you hear or see the word

457
00:14:29,810 --> 00:14:34,069
preferred that starts to border into

458
00:14:32,060 --> 00:14:35,900
thread Intel and behavior development so

459
00:14:34,070 --> 00:14:37,820
now based on the way he's doing things I

460
00:14:35,900 --> 00:14:39,140
can start to say hmm I noticed this is

461
00:14:37,820 --> 00:14:40,880
his preferred technique of doing things

462
00:14:39,140 --> 00:14:42,650
so let's let him walk through it and

463
00:14:40,880 --> 00:14:44,240
then see if there's a way I can cut that

464
00:14:42,650 --> 00:14:46,370
preference off before it goes too far

465
00:14:44,240 --> 00:14:48,740
sure sure so I've got my meterpreter

466
00:14:46,370 --> 00:14:50,900
session here I can look at get UID I'm

467
00:14:48,740 --> 00:14:54,170
in Maps domain which he's named Gotham

468
00:14:50,900 --> 00:14:57,260
and obviously he is Batman and so I can

469
00:14:54,170 --> 00:14:59,810
that's right I can use this DC sync tool

470
00:14:57,260 --> 00:15:02,450
to dump all the information associated

471
00:14:59,810 --> 00:15:04,489
with that account from the his his

472
00:15:02,450 --> 00:15:07,250
domain controller and so this includes

473
00:15:04,490 --> 00:15:10,010
as I said user names security IDs

474
00:15:07,250 --> 00:15:12,650
password including previous passwords

475
00:15:10,010 --> 00:15:14,630
all those hashes that give me access

476
00:15:12,650 --> 00:15:17,030
when I can either crack them or pass

477
00:15:14,630 --> 00:15:18,830
them to move further into his network

478
00:15:17,030 --> 00:15:20,630
and just to be clear this particular

479
00:15:18,830 --> 00:15:22,130
part of the attack here this is

480
00:15:20,630 --> 00:15:23,780
essentially the same procedure as

481
00:15:22,130 --> 00:15:25,189
elevating a system to a domain

482
00:15:23,780 --> 00:15:26,959
controller however we didn't actually

483
00:15:25,190 --> 00:15:28,400
elevate a system to dominguez role what

484
00:15:26,959 --> 00:15:30,018
we did is we sent out the right signals

485
00:15:28,400 --> 00:15:31,790
that said hey we're going to BL

486
00:15:30,019 --> 00:15:33,170
hey we'd like domain replication and

487
00:15:31,790 --> 00:15:34,488
that makes the domain controller

488
00:15:33,170 --> 00:15:36,319
immediately speak up and say hey up

489
00:15:34,489 --> 00:15:38,029
buddy cool here buddy here's everything

490
00:15:36,319 --> 00:15:39,498
you need to make it work so to be clear

491
00:15:38,029 --> 00:15:41,059
this is from a regular Windows 10

492
00:15:39,499 --> 00:15:44,899
workstation this isn't from some

493
00:15:41,059 --> 00:15:47,868
sensitive server inside the network okay

494
00:15:44,899 --> 00:15:49,699
so I let's talk about a little bit about

495
00:15:47,869 --> 00:15:51,230
what this looks like on the wire yeah so

496
00:15:49,699 --> 00:15:52,459
on the network Aaron now thinks he's all

497
00:15:51,230 --> 00:15:54,079
crafty because he's got his nice little

498
00:15:52,459 --> 00:15:56,258
shell built in and he's all inside of

499
00:15:54,079 --> 00:15:58,399
encrypted tunnels and so on and so forth

500
00:15:56,259 --> 00:15:59,929
what does this even mean yeah but

501
00:15:58,399 --> 00:16:02,119
there's a problem here notice what I

502
00:15:59,929 --> 00:16:04,670
just said I just said out loud that this

503
00:16:02,119 --> 00:16:05,779
particular technique makes a system look

504
00:16:04,670 --> 00:16:07,368
like a domain controller yelling

505
00:16:05,779 --> 00:16:09,319
outbound if any of you in this room

506
00:16:07,369 --> 00:16:10,579
right now stood up ripped your shirt off

507
00:16:09,319 --> 00:16:11,988
and started screaming out some

508
00:16:10,579 --> 00:16:13,219
unintelligible language guess what

509
00:16:11,989 --> 00:16:14,809
that's an alert for the rest of us

510
00:16:13,220 --> 00:16:17,540
because that's not how I hope normal

511
00:16:14,809 --> 00:16:18,769
behavior I hope now if there's someone

512
00:16:17,540 --> 00:16:20,660
over here he's like yeah he does that

513
00:16:18,769 --> 00:16:21,709
all the time then okay well we're not

514
00:16:20,660 --> 00:16:23,660
from around here so we're not from

515
00:16:21,709 --> 00:16:25,309
around them but unfortunately what Aaron

516
00:16:23,660 --> 00:16:27,649
may not have realized is that the packet

517
00:16:25,309 --> 00:16:30,799
level he threw out a very very specific

518
00:16:27,649 --> 00:16:32,720
request and if we take this protocol and

519
00:16:30,799 --> 00:16:34,459
we actually put this in the d'art

520
00:16:32,720 --> 00:16:37,279
directory remain replication services

521
00:16:34,459 --> 00:16:40,489
API call I can actually see what's known

522
00:16:37,279 --> 00:16:43,670
as a DC get and see changes and this

523
00:16:40,490 --> 00:16:45,139
particular call says I am a domain

524
00:16:43,670 --> 00:16:47,299
controller and I would like to initiate

525
00:16:45,139 --> 00:16:49,610
some sort of synchronization the problem

526
00:16:47,299 --> 00:16:51,860
here is that this particular API call

527
00:16:49,610 --> 00:16:54,470
that one package should never originate

528
00:16:51,860 --> 00:16:55,999
outside of anything I expect it should

529
00:16:54,470 --> 00:16:57,709
never originate from a host name it

530
00:16:55,999 --> 00:16:58,759
should never originate from a non server

531
00:16:57,709 --> 00:17:00,679
cluster and I'd say it should never

532
00:16:58,759 --> 00:17:02,899
originate from a non privileged this

533
00:17:00,679 --> 00:17:05,119
system is a domain controller so he just

534
00:17:02,899 --> 00:17:08,209
gave me an awesome alert because now I

535
00:17:05,119 --> 00:17:09,739
can throw that API call against all my

536
00:17:08,209 --> 00:17:11,750
underprivileged subnets or my least

537
00:17:09,740 --> 00:17:14,059
privileged users and I can use that to

538
00:17:11,750 --> 00:17:15,529
my advantage as well now did you want to

539
00:17:14,059 --> 00:17:18,740
talk about what meme cats in the next

540
00:17:15,529 --> 00:17:20,569
step here sure well sure so it's well

541
00:17:18,740 --> 00:17:22,069
actually know what I'll keep going I'll

542
00:17:20,569 --> 00:17:23,240
keep going because will say again he

543
00:17:22,069 --> 00:17:24,289
thinks he's crafty and now he's starting

544
00:17:23,240 --> 00:17:26,299
to shake a little bit because now I'm

545
00:17:24,289 --> 00:17:28,908
detecting this activity here so in any

546
00:17:26,299 --> 00:17:30,830
event the problem here is that when he

547
00:17:28,909 --> 00:17:32,690
ran that particular module he did get

548
00:17:30,830 --> 00:17:34,039
access to all of the accounts on the

549
00:17:32,690 --> 00:17:35,149
domain controller he got access to

550
00:17:34,039 --> 00:17:37,429
everything that comes back and that's

551
00:17:35,149 --> 00:17:41,239
with that /all option and what that does

552
00:17:37,429 --> 00:17:42,620
is it brings back that NTDs did well

553
00:17:41,240 --> 00:17:43,850
what if you're stuck in the position of

554
00:17:42,620 --> 00:17:44,989
wait I see that API

555
00:17:43,850 --> 00:17:47,330
I call that I wouldn't expect to see

556
00:17:44,990 --> 00:17:49,760
what happened after that API call the

557
00:17:47,330 --> 00:17:52,970
question I'm really asking here is Aaron

558
00:17:49,760 --> 00:17:54,470
ran DC sync was it successful cool I'll

559
00:17:52,970 --> 00:17:55,760
use what I know then about packet size

560
00:17:54,470 --> 00:17:58,100
to come back and I'll say hey everyone

561
00:17:55,760 --> 00:18:00,860
there's your API call followed by a

562
00:17:58,100 --> 00:18:01,370
whole bunch of packets with all you'll

563
00:18:00,860 --> 00:18:03,678
take a look

564
00:18:01,370 --> 00:18:04,969
14 18 bytes as part of them so

565
00:18:03,679 --> 00:18:06,620
essentially let's look at this from a

566
00:18:04,970 --> 00:18:08,780
network perspective without any context

567
00:18:06,620 --> 00:18:10,039
whatsoever an API call originated from a

568
00:18:08,780 --> 00:18:12,770
system that should not have had it

569
00:18:10,039 --> 00:18:15,169
followed by a successive amount of data

570
00:18:12,770 --> 00:18:16,940
transfer from that system in response to

571
00:18:15,169 --> 00:18:18,919
that API call that's what that call

572
00:18:16,940 --> 00:18:20,690
looks like on the network level that's

573
00:18:18,919 --> 00:18:22,940
when an attacker who kicks off DC sync

574
00:18:20,690 --> 00:18:24,679
so his preferred method easily

575
00:18:22,940 --> 00:18:26,780
detectable because he came in from a

576
00:18:24,679 --> 00:18:28,280
user workstation now if he had Spearfish

577
00:18:26,780 --> 00:18:30,620
the server which were never reading

578
00:18:28,280 --> 00:18:32,030
email from right if he Spearfish the

579
00:18:30,620 --> 00:18:34,280
server maybe he would have subverted

580
00:18:32,030 --> 00:18:36,980
that subnet rule but I caught him in

581
00:18:34,280 --> 00:18:37,490
this particular case here because there

582
00:18:36,980 --> 00:18:39,080
we go

583
00:18:37,490 --> 00:18:40,520
I should never see this call being made

584
00:18:39,080 --> 00:18:42,199
from that particular system so here's a

585
00:18:40,520 --> 00:18:44,090
nice little summary that sums up those

586
00:18:42,200 --> 00:18:45,890
API calls where I would and where I

587
00:18:44,090 --> 00:18:47,629
would not expect to see them so

588
00:18:45,890 --> 00:18:49,370
defensively we can use this to our

589
00:18:47,630 --> 00:18:52,429
advantage and now I can start to build

590
00:18:49,370 --> 00:18:54,649
an active directory or where rules now I

591
00:18:52,429 --> 00:18:57,710
will offer one defensive caveat here

592
00:18:54,650 --> 00:18:59,720
first off we are inside the network I

593
00:18:57,710 --> 00:19:01,659
did if you all noticed let the Spearfish

594
00:18:59,720 --> 00:19:03,500
happen I let that take place

595
00:19:01,659 --> 00:19:05,030
argumentatively we could say were

596
00:19:03,500 --> 00:19:06,440
collecting intelligence I'm learning how

597
00:19:05,030 --> 00:19:07,700
Aaron does would be Doug area I'm

598
00:19:06,440 --> 00:19:09,350
learning you're letting me win now I'm

599
00:19:07,700 --> 00:19:10,789
letting him win right you all are

600
00:19:09,350 --> 00:19:12,260
familiar with stages of containment and

601
00:19:10,789 --> 00:19:13,669
active defense where we let the attacker

602
00:19:12,260 --> 00:19:15,169
believe they're winning and then we

603
00:19:13,669 --> 00:19:17,360
close that tunnel tunnel tunnel tunnel

604
00:19:15,169 --> 00:19:19,610
until finally smack them out and they're

605
00:19:17,360 --> 00:19:21,949
done like the pesky flies they are but

606
00:19:19,610 --> 00:19:23,418
nonetheless we let him go but we started

607
00:19:21,950 --> 00:19:26,570
to build some Intel now I have a better

608
00:19:23,419 --> 00:19:28,010
development but now I'm gonna upset the

609
00:19:26,570 --> 00:19:29,480
initial part of his game and I'm gonna

610
00:19:28,010 --> 00:19:31,400
go back to the beginning and I'm gonna

611
00:19:29,480 --> 00:19:33,500
say I let you get so far so at this

612
00:19:31,400 --> 00:19:35,210
point now I've shut down DC sync he

613
00:19:33,500 --> 00:19:36,860
still got that she'll beginning out and

614
00:19:35,210 --> 00:19:39,740
he stuck at the point of oh no my

615
00:19:36,860 --> 00:19:41,240
preferred method and another HTTP and it

616
00:19:39,740 --> 00:19:42,500
was HTTP so it's encrypted so what do

617
00:19:41,240 --> 00:19:43,940
you do yeah of course it's encrypted

618
00:19:42,500 --> 00:19:45,350
there's nothing I can do HTTPS

619
00:19:43,940 --> 00:19:47,419
encryption we can't do anything with

620
00:19:45,350 --> 00:19:48,530
encryption right talks over talks over

621
00:19:47,419 --> 00:19:49,250
that's it have a wonderful afternoon

622
00:19:48,530 --> 00:19:50,750
everyone

623
00:19:49,250 --> 00:19:53,030
yeah right come on are you kidding me

624
00:19:50,750 --> 00:19:54,860
encryption what a joke unbelievable by

625
00:19:53,030 --> 00:19:55,920
the way I'm not going to say again the

626
00:19:54,860 --> 00:19:57,360
words man in the middle

627
00:19:55,920 --> 00:19:59,520
I am NOT gonna look at this particular

628
00:19:57,360 --> 00:20:01,139
traffic you know why I don't need to I

629
00:19:59,520 --> 00:20:03,240
don't need to we're gonna talk about

630
00:20:01,140 --> 00:20:06,720
looking for that anyone recognize this

631
00:20:03,240 --> 00:20:09,270
traffic up here of course we do yeah

632
00:20:06,720 --> 00:20:11,850
yeah this is his shell over port eight

633
00:20:09,270 --> 00:20:13,770
443 there's my first indicator port

634
00:20:11,850 --> 00:20:15,600
eight 443 if I'm pushing everything over

635
00:20:13,770 --> 00:20:17,610
a proxy or if I'm limiting everything to

636
00:20:15,600 --> 00:20:19,230
specific ports here we go I'll have that

637
00:20:17,610 --> 00:20:20,850
port to pivot off of okay if it was four

638
00:20:19,230 --> 00:20:22,320
four three though okay if it was yeah

639
00:20:20,850 --> 00:20:23,669
all right all right he'll blend into the

640
00:20:22,320 --> 00:20:25,230
noise all right yeah most red teamers

641
00:20:23,670 --> 00:20:26,880
take this stance of like if I blend in

642
00:20:25,230 --> 00:20:29,660
you can't find me that's cool fair

643
00:20:26,880 --> 00:20:31,440
enough I will say that at the very onset

644
00:20:29,660 --> 00:20:32,669
encrypted traffic may present a

645
00:20:31,440 --> 00:20:34,230
particular problem but then we talk

646
00:20:32,669 --> 00:20:36,030
about learning how to fingerprint

647
00:20:34,230 --> 00:20:37,320
encrypted traffic and there's a couple

648
00:20:36,030 --> 00:20:39,360
different things we can pivot off of to

649
00:20:37,320 --> 00:20:40,770
fingerprint them there was a fantastic

650
00:20:39,360 --> 00:20:42,090
talk yesterday that talked about the fad

651
00:20:40,770 --> 00:20:43,770
tool fingerprint all the things that

652
00:20:42,090 --> 00:20:45,510
also mentioned ja3 so if this looks

653
00:20:43,770 --> 00:20:47,400
familiar to you you may have seen this

654
00:20:45,510 --> 00:20:49,830
yesterday in Adele's great talk but we

655
00:20:47,400 --> 00:20:51,840
can pivot our SSL and TLS connections we

656
00:20:49,830 --> 00:20:53,820
can pivot SSH activities sorry not pivot

657
00:20:51,840 --> 00:20:55,709
but fingerprint we can also fingerprint

658
00:20:53,820 --> 00:20:58,049
using the certificates because here's

659
00:20:55,710 --> 00:20:59,910
what Aaron admitted to I made my show

660
00:20:58,049 --> 00:21:02,129
with meterpreter the way that

661
00:20:59,910 --> 00:21:04,860
meterpreter talks is very very different

662
00:21:02,130 --> 00:21:06,480
from the way google.com talks very very

663
00:21:04,860 --> 00:21:08,159
different from the way Windows talks

664
00:21:06,480 --> 00:21:10,169
we're gonna talk about what that looks

665
00:21:08,160 --> 00:21:11,549
like here so the first one is our ja3

666
00:21:10,169 --> 00:21:13,049
hash if you haven't heard about this

667
00:21:11,549 --> 00:21:14,790
before this came over from a team that I

668
00:21:13,049 --> 00:21:15,840
think used to be all Salesforce but I

669
00:21:14,790 --> 00:21:18,299
think one of these gentlemen has left

670
00:21:15,840 --> 00:21:20,129
Salesforce now and what they did is they

671
00:21:18,299 --> 00:21:22,559
wanted to start to profile the client

672
00:21:20,130 --> 00:21:23,970
hello and the client hello for all

673
00:21:22,559 --> 00:21:26,040
intents and purposes is a way that a

674
00:21:23,970 --> 00:21:28,260
client says hello I would like to start

675
00:21:26,040 --> 00:21:29,879
a TLS connection please let's start

676
00:21:28,260 --> 00:21:31,350
talking encrypted believe it or not

677
00:21:29,880 --> 00:21:33,240
clients have very different ways of

678
00:21:31,350 --> 00:21:34,379
talking to each other when I say clients

679
00:21:33,240 --> 00:21:35,610
by the way everyone I don't mean like

680
00:21:34,380 --> 00:21:39,419
Windows versus Linux

681
00:21:35,610 --> 00:21:41,850
I mean Python URL Lib version 1 vs curl

682
00:21:39,419 --> 00:21:44,130
version 2 those things have very

683
00:21:41,850 --> 00:21:46,080
definitive ways of saying hello which by

684
00:21:44,130 --> 00:21:48,360
the way my meterpreter session says

685
00:21:46,080 --> 00:21:50,159
hello says hello totally the same way

686
00:21:48,360 --> 00:21:52,649
allegedly that's what he said Oh

687
00:21:50,160 --> 00:21:54,390
allegedly it says the same way as what

688
00:21:52,650 --> 00:21:54,900
as those tools or it says hello the same

689
00:21:54,390 --> 00:21:57,120
way every time

690
00:21:54,900 --> 00:21:59,610
well we'll find out we'll find out in

691
00:21:57,120 --> 00:22:01,949
just a second here it says it the same

692
00:21:59,610 --> 00:22:04,649
way every time just in case there's also

693
00:22:01,950 --> 00:22:06,840
the j-3 yes the JD 3s is how the server

694
00:22:04,650 --> 00:22:08,370
responds so there is a client hello and

695
00:22:06,840 --> 00:22:08,668
then there's a server hey what's up it's

696
00:22:08,370 --> 00:22:09,689
actually

697
00:22:08,669 --> 00:22:12,809
server a little bit it's a server hey

698
00:22:09,690 --> 00:22:14,460
what's up hey you you gave me a selected

699
00:22:12,809 --> 00:22:15,450
list of protocols here's the report of

700
00:22:14,460 --> 00:22:17,580
calls that I would like to establish

701
00:22:15,450 --> 00:22:21,059
this session in now from my perspective

702
00:22:17,580 --> 00:22:22,918
I'm the server he's the client j3s may

703
00:22:21,059 --> 00:22:25,200
not give me much in this case but let's

704
00:22:22,919 --> 00:22:26,669
flip that situation let's say I see who

705
00:22:25,200 --> 00:22:29,609
he's beaconing out - and he's beaconing

706
00:22:26,669 --> 00:22:31,019
out over HTTP to a situ somewhere a

707
00:22:29,609 --> 00:22:33,059
domain a system out there that

708
00:22:31,019 --> 00:22:35,249
established connectivity I now have a

709
00:22:33,059 --> 00:22:38,039
way to profile the way his server says

710
00:22:35,249 --> 00:22:39,480
hello back to his client so I can take

711
00:22:38,039 --> 00:22:41,639
that analysis and use it to pivot

712
00:22:39,480 --> 00:22:43,919
through nasty dirty malicious clients

713
00:22:41,639 --> 00:22:45,899
talking to potentially suspicious hosts

714
00:22:43,919 --> 00:22:47,159
I now have two fingerprints we didn't

715
00:22:45,899 --> 00:22:48,209
look at any encrypted traffic we didn't

716
00:22:47,159 --> 00:22:50,159
man in the middle anything we literally

717
00:22:48,210 --> 00:22:51,629
took the first two packets on the client

718
00:22:50,159 --> 00:22:53,850
and server-side and said give me some

719
00:22:51,629 --> 00:22:55,168
details inside of these the other thing

720
00:22:53,850 --> 00:22:57,090
that took place after this hello

721
00:22:55,169 --> 00:22:59,429
exchange is a certificate well that's

722
00:22:57,090 --> 00:23:00,928
our x.509 standard that gives us some

723
00:22:59,429 --> 00:23:03,419
information we can pivot off of as well

724
00:23:00,929 --> 00:23:05,669
because once again he is using an

725
00:23:03,419 --> 00:23:07,739
automated tool he is using a tool that

726
00:23:05,669 --> 00:23:10,379
tries to abstract away the complications

727
00:23:07,739 --> 00:23:12,539
of forging your own TLS connection for

728
00:23:10,379 --> 00:23:14,189
an attacker therefore some things have

729
00:23:12,539 --> 00:23:15,929
to be standardized hard-coded in or

730
00:23:14,190 --> 00:23:17,249
randomized within very very easily

731
00:23:15,929 --> 00:23:19,320
predictable values because that's not

732
00:23:17,249 --> 00:23:20,609
the fun part well I mean could you

733
00:23:19,320 --> 00:23:22,619
imagine if creating a reverse shell

734
00:23:20,609 --> 00:23:24,689
involved registering a domain picking

735
00:23:22,619 --> 00:23:26,369
your own username and our organizational

736
00:23:24,690 --> 00:23:27,720
unit and writing my own TLS and writing

737
00:23:26,369 --> 00:23:29,399
your own TLS stack and that would just

738
00:23:27,720 --> 00:23:31,019
be absolutely boring although oddly

739
00:23:29,399 --> 00:23:32,219
enough we've examined enough exploits in

740
00:23:31,019 --> 00:23:33,659
the past four days that a lot of people

741
00:23:32,220 --> 00:23:34,919
try to write their own TLS stack but

742
00:23:33,659 --> 00:23:37,049
we'll come to that in just a second get

743
00:23:34,919 --> 00:23:38,489
there a few X 5 or 9 details I can get

744
00:23:37,049 --> 00:23:40,049
and if anyone here is done certificate

745
00:23:38,489 --> 00:23:42,119
analysis before you know that there are

746
00:23:40,049 --> 00:23:44,249
very very crucial fields I can pivot off

747
00:23:42,119 --> 00:23:46,678
of here because these fields are all

748
00:23:44,249 --> 00:23:49,259
arbitrary they can be forged they can be

749
00:23:46,679 --> 00:23:50,549
empty but think again I'm looking for

750
00:23:49,259 --> 00:23:53,039
suspicious or potentially malicious

751
00:23:50,549 --> 00:23:55,109
traffic inside of legitimate Microsoft

752
00:23:53,039 --> 00:23:56,850
Google Facebook Apple so on and so forth

753
00:23:55,109 --> 00:23:59,189
your big name hitters have no need to

754
00:23:56,850 --> 00:24:01,139
forge any information inside of here at

755
00:23:59,190 --> 00:24:02,159
least so we thought and then we realized

756
00:24:01,139 --> 00:24:03,689
that companies are man-in-the-middle

757
00:24:02,159 --> 00:24:05,519
that's it sorry another day the other

758
00:24:03,690 --> 00:24:07,379
day we'll come back to that yeah but I

759
00:24:05,519 --> 00:24:08,970
can take that x.509 certain I can pivot

760
00:24:07,379 --> 00:24:10,769
through some of these details now we

761
00:24:08,970 --> 00:24:12,629
spend a lot of time talking about a lot

762
00:24:10,769 --> 00:24:14,460
of different artifacts and I can go

763
00:24:12,629 --> 00:24:16,379
through and pivot through rj3 rj3

764
00:24:14,460 --> 00:24:17,849
essence I can pivot through x.509 s

765
00:24:16,379 --> 00:24:19,408
there's a bunch of information up here

766
00:24:17,849 --> 00:24:20,519
hopefully as I'm bringing all these up

767
00:24:19,409 --> 00:24:21,750
by the way you all were looking at this

768
00:24:20,519 --> 00:24:25,320
and you're like wait these domains make

769
00:24:21,750 --> 00:24:28,200
no sense whatsoever no because his tool

770
00:24:25,320 --> 00:24:29,460
is randomizing all of these values so

771
00:24:28,200 --> 00:24:30,810
therefore I can come back and I can do

772
00:24:29,460 --> 00:24:32,070
analysis and all I need to do analysis

773
00:24:30,810 --> 00:24:33,780
are two different things

774
00:24:32,070 --> 00:24:35,399
the top part of this screenshot is

775
00:24:33,780 --> 00:24:36,990
actually the certificate that was

776
00:24:35,400 --> 00:24:39,470
exchanged back and forth during that

777
00:24:36,990 --> 00:24:42,810
initial TLS setup the bottom part is

778
00:24:39,470 --> 00:24:44,280
output from bro or now known as Zeke

779
00:24:42,810 --> 00:24:46,440
which goes through and automatically

780
00:24:44,280 --> 00:24:48,510
calculates the j-3 for us so on the

781
00:24:46,440 --> 00:24:50,130
screen right here I've got the x.509

782
00:24:48,510 --> 00:24:52,020
details that detail Aaron's connection

783
00:24:50,130 --> 00:24:53,910
reaching out and I've got a J III hash

784
00:24:52,020 --> 00:24:54,629
now you can take that seventy to a five

785
00:24:53,910 --> 00:24:57,210
eight nine

786
00:24:54,630 --> 00:24:59,010
that is a meterpreter J a three hash

787
00:24:57,210 --> 00:25:02,790
reaching out wait it gets better

788
00:24:59,010 --> 00:25:04,320
over sorry connecting from Windows 10 so

789
00:25:02,790 --> 00:25:06,149
I can even get operating system specific

790
00:25:04,320 --> 00:25:08,340
and what this means for the record I

791
00:25:06,150 --> 00:25:09,900
didn't believe him and he was a jerk and

792
00:25:08,340 --> 00:25:11,730
he just sent me the screenshot I had to

793
00:25:09,900 --> 00:25:14,160
manually type in that whole stupid hash

794
00:25:11,730 --> 00:25:15,630
into Google and sure enough there's

795
00:25:14,160 --> 00:25:17,190
posted like yep that's totally

796
00:25:15,630 --> 00:25:19,110
meterpreter yep this finally Windows 10

797
00:25:17,190 --> 00:25:19,920
I went underground for the brief second

798
00:25:19,110 --> 00:25:21,060
he asked me for the house though

799
00:25:19,920 --> 00:25:23,250
screenshot was it that's all we had

800
00:25:21,060 --> 00:25:26,399
available so there are we going reverse

801
00:25:23,250 --> 00:25:29,490
HTTPS easy our fingerprint it I'll find

802
00:25:26,400 --> 00:25:30,690
it it's gonna stand out even if I can't

803
00:25:29,490 --> 00:25:32,100
tell you definitively that each one of

804
00:25:30,690 --> 00:25:34,170
those hashes is bad I can tell you that

805
00:25:32,100 --> 00:25:35,909
right after a fish this ja3 showed up

806
00:25:34,170 --> 00:25:37,440
that's a nice little temporal

807
00:25:35,910 --> 00:25:39,420
correlation I have didn't look at a

808
00:25:37,440 --> 00:25:41,070
single encrypted packet just started out

809
00:25:39,420 --> 00:25:42,780
at the very beginning okay you happy now

810
00:25:41,070 --> 00:25:45,899
well alright everything you just talked

811
00:25:42,780 --> 00:25:48,570
about was focused on TLS on HTTPS on

812
00:25:45,900 --> 00:25:49,890
certificates what if I take that away

813
00:25:48,570 --> 00:25:51,389
from you red teamers always having these

814
00:25:49,890 --> 00:25:53,130
absolute right yeah well just let's make

815
00:25:51,390 --> 00:25:54,510
a more wait get harder yeah by the way

816
00:25:53,130 --> 00:25:56,280
what are you gonna do this is blood

817
00:25:54,510 --> 00:25:57,180
pressure so this picture by the way is

818
00:25:56,280 --> 00:25:59,430
meant to raise your blood pressure

819
00:25:57,180 --> 00:26:01,590
that's my house case anyone's curious

820
00:25:59,430 --> 00:26:03,600
that's what my it's all my server closet

821
00:26:01,590 --> 00:26:05,820
looks like all right so this is this is

822
00:26:03,600 --> 00:26:08,010
trivial for me right because I'm using a

823
00:26:05,820 --> 00:26:10,139
simple framework that lets me with a

824
00:26:08,010 --> 00:26:13,470
single keystroke change this from a

825
00:26:10,140 --> 00:26:15,120
reverse HTTPS to reverse HTTP cool all

826
00:26:13,470 --> 00:26:16,890
right so why would you drop encryption

827
00:26:15,120 --> 00:26:20,399
well all the things you were just

828
00:26:16,890 --> 00:26:22,170
fingerprinting me on are now gone okay

829
00:26:20,400 --> 00:26:24,180
now I just blend in with HTTP traffic

830
00:26:22,170 --> 00:26:25,560
all that work you had to put into it

831
00:26:24,180 --> 00:26:27,030
deploying all these tools one-time

832
00:26:25,560 --> 00:26:29,190
stroke and I will give them a plus who

833
00:26:27,030 --> 00:26:31,920
here's not capturing eighty

834
00:26:29,190 --> 00:26:34,170
I like how no one wants to raise their

835
00:26:31,920 --> 00:26:35,530
hand that's fantastic well done you did

836
00:26:34,170 --> 00:26:37,690
not fall into that trap

837
00:26:35,530 --> 00:26:39,129
well then okay fine so you want to blend

838
00:26:37,690 --> 00:26:41,050
in with the noise that's alright because

839
00:26:39,130 --> 00:26:42,550
now I have what you just took away from

840
00:26:41,050 --> 00:26:43,960
me oh I don't want you to be able to

841
00:26:42,550 --> 00:26:45,490
fingerprint my encrypted traffic that's

842
00:26:43,960 --> 00:26:47,200
cool I'll fingerprint the plaintext

843
00:26:45,490 --> 00:26:49,000
traffic this is what meterpreter looks

844
00:26:47,200 --> 00:26:50,740
like calling out now if any of you work

845
00:26:49,000 --> 00:26:52,210
for CDN networks or anything like that

846
00:26:50,740 --> 00:26:53,890
you're probably used to really strong

847
00:26:52,210 --> 00:26:54,280
dynamic strings being sent out and

848
00:26:53,890 --> 00:26:56,110
whatnot

849
00:26:54,280 --> 00:26:58,060
but ones that equal the download of an

850
00:26:56,110 --> 00:26:59,649
MZ header is one that I'm obviously

851
00:26:58,060 --> 00:27:01,179
going to pivot off of and be very very

852
00:26:59,650 --> 00:27:02,260
concerned about that just does not look

853
00:27:01,180 --> 00:27:04,240
right to me whatsoever

854
00:27:02,260 --> 00:27:05,950
another point inside of there which

855
00:27:04,240 --> 00:27:08,920
we'll look at take right here this is

856
00:27:05,950 --> 00:27:10,030
the binary this is the HTTP shell that

857
00:27:08,920 --> 00:27:12,010
Aaron brought down into that particular

858
00:27:10,030 --> 00:27:13,899
system does anyone recognize anything

859
00:27:12,010 --> 00:27:15,610
inside of there hopefully you do because

860
00:27:13,900 --> 00:27:17,020
it's all bytes and we all know we can

861
00:27:15,610 --> 00:27:19,240
read bytes without needing any sort of

862
00:27:17,020 --> 00:27:21,129
translation but in case you are a little

863
00:27:19,240 --> 00:27:23,110
groggy after last night's fireworks on a

864
00:27:21,130 --> 00:27:25,480
jet ski show and take a look at the very

865
00:27:23,110 --> 00:27:28,120
bottom there's a user agent so once

866
00:27:25,480 --> 00:27:29,860
again even by subverting HTTP and giving

867
00:27:28,120 --> 00:27:31,929
me a very very noisy protocol you've

868
00:27:29,860 --> 00:27:34,000
still given me hard-coded credentials or

869
00:27:31,930 --> 00:27:35,710
NOC credentials hard-coded user agent

870
00:27:34,000 --> 00:27:37,210
hard code strings things that I can look

871
00:27:35,710 --> 00:27:38,170
for so on you're not gonna get the

872
00:27:37,210 --> 00:27:40,150
credentials cuz I'm gonna catch it

873
00:27:38,170 --> 00:27:42,040
earlier on than that now could you

874
00:27:40,150 --> 00:27:43,360
change that value sure sure

875
00:27:42,040 --> 00:27:44,920
you could you could change that value

876
00:27:43,360 --> 00:27:46,360
easily that's okay because I'm still

877
00:27:44,920 --> 00:27:49,030
gonna have an MZ header that has your

878
00:27:46,360 --> 00:27:51,340
callback baked inside of it that's gonna

879
00:27:49,030 --> 00:27:52,510
be in plain text as well an MZ that gets

880
00:27:51,340 --> 00:27:54,610
downloaded on the network via a

881
00:27:52,510 --> 00:27:55,960
super-long HTTP requests with built-in

882
00:27:54,610 --> 00:27:57,909
user agent strings and built-in

883
00:27:55,960 --> 00:27:59,740
callbacks I'm gonna detect that pretty

884
00:27:57,910 --> 00:28:02,200
easily so sorry your HTTP is gonna take

885
00:27:59,740 --> 00:28:03,550
you so far all right and here's an

886
00:28:02,200 --> 00:28:05,230
example of his beaconing activity I'm

887
00:28:03,550 --> 00:28:08,050
just gonna leave that as duh this is

888
00:28:05,230 --> 00:28:10,080
obviously bad we all know why all right

889
00:28:08,050 --> 00:28:13,480
fair enough fair enough all right so

890
00:28:10,080 --> 00:28:16,750
yeah sorry it's your house again so even

891
00:28:13,480 --> 00:28:19,570
more difficult now again I had a cheapy

892
00:28:16,750 --> 00:28:21,310
okay fine I'll make it a proprietary

893
00:28:19,570 --> 00:28:24,399
protocol I'll come up with my own thing

894
00:28:21,310 --> 00:28:26,620
so you don't have any tools and I can

895
00:28:24,400 --> 00:28:28,810
add my own I can add my own encryption I

896
00:28:26,620 --> 00:28:30,310
can add my own encoding how do you gonna

897
00:28:28,810 --> 00:28:30,700
figure finally the red teamer does some

898
00:28:30,310 --> 00:28:34,240
work

899
00:28:30,700 --> 00:28:37,420
finally there we go there's the reverse

900
00:28:34,240 --> 00:28:39,760
TCP I got no headers it's gone strings

901
00:28:37,420 --> 00:28:41,320
this no encrypted no strings getting one

902
00:28:39,760 --> 00:28:45,850
see any strings they want to read this

903
00:28:41,320 --> 00:28:48,550
stuff you can now guess what even

904
00:28:45,850 --> 00:28:48,909
reverse TCP comes with a signature built

905
00:28:48,550 --> 00:28:51,430
into

906
00:28:48,910 --> 00:28:54,070
the way that retur preform packets is

907
00:28:51,430 --> 00:28:55,210
once again predictable and once we start

908
00:28:54,070 --> 00:28:56,560
to analyze the way that they use the

909
00:28:55,210 --> 00:28:58,660
protocol I can all of a sudden say wait

910
00:28:56,560 --> 00:29:00,520
a second there's a signature in here yes

911
00:28:58,660 --> 00:29:02,950
you are using raw TCP over port 80

912
00:29:00,520 --> 00:29:04,960
fantastic guess what you're leaving

913
00:29:02,950 --> 00:29:06,130
another trace that by itself would be

914
00:29:04,960 --> 00:29:07,810
something maybe potentially suspicious

915
00:29:06,130 --> 00:29:09,580
depends on what's in the environment you

916
00:29:07,810 --> 00:29:11,050
never know but you're leaving a

917
00:29:09,580 --> 00:29:12,669
signature for me you're leaving a

918
00:29:11,050 --> 00:29:14,139
structure that I can go in parson I can

919
00:29:12,670 --> 00:29:16,120
go and analyze and this right here

920
00:29:14,140 --> 00:29:18,580
everyone actually is the structure of a

921
00:29:16,120 --> 00:29:20,560
meterpreter reverse TCP packet as it

922
00:29:18,580 --> 00:29:22,389
gets sent out it starts out with an XOR

923
00:29:20,560 --> 00:29:23,860
key followed by a session good that is

924
00:29:22,390 --> 00:29:25,480
unique to that particular session

925
00:29:23,860 --> 00:29:26,560
obviously then there's even flags that

926
00:29:25,480 --> 00:29:28,000
says whether or not this is encrypted

927
00:29:26,560 --> 00:29:29,440
this is how the server and the client

928
00:29:28,000 --> 00:29:32,050
continue to communicate with each other

929
00:29:29,440 --> 00:29:34,330
I can even take that structure further

930
00:29:32,050 --> 00:29:36,430
down the line look at a pcap and say

931
00:29:34,330 --> 00:29:38,679
there's a repeated structure inside of

932
00:29:36,430 --> 00:29:40,300
here I can parse it out have an examine

933
00:29:38,680 --> 00:29:41,620
the encrypted traffic just yet there are

934
00:29:40,300 --> 00:29:42,970
ways we could talk about doing that

935
00:29:41,620 --> 00:29:44,320
later on but it would involve us getting

936
00:29:42,970 --> 00:29:45,970
on the host and that's come on that's

937
00:29:44,320 --> 00:29:48,879
cheating let's not get there so at the

938
00:29:45,970 --> 00:29:50,470
network level I can simply say you have

939
00:29:48,880 --> 00:29:52,060
a structure here now I can't read the

940
00:29:50,470 --> 00:29:53,290
content so if you go and kick off DC

941
00:29:52,060 --> 00:29:55,270
sync I'm gonna be stuck with I don't

942
00:29:53,290 --> 00:29:56,620
know what he did but I am gonna know

943
00:29:55,270 --> 00:29:58,330
where you're coming from I'm gonna know

944
00:29:56,620 --> 00:30:00,820
it's suspicious and I'm likely gonna

945
00:29:58,330 --> 00:30:03,220
have an idea of lots of bytes versus

946
00:30:00,820 --> 00:30:05,830
little bytes beacons versus exfill

947
00:30:03,220 --> 00:30:08,140
interaction server to client versus

948
00:30:05,830 --> 00:30:09,490
response client to server so I can start

949
00:30:08,140 --> 00:30:11,050
to pivot through some of my normal

950
00:30:09,490 --> 00:30:13,150
Network heuristics to figure out what's

951
00:30:11,050 --> 00:30:14,800
happening by identifying things with

952
00:30:13,150 --> 00:30:16,450
this particular structure so there you

953
00:30:14,800 --> 00:30:18,010
go so I'm not gonna lie this is getting

954
00:30:16,450 --> 00:30:19,930
a little bit frustrating well that's the

955
00:30:18,010 --> 00:30:25,480
point and I may actually have to put

956
00:30:19,930 --> 00:30:28,120
down my beer okay and go oday oh all

957
00:30:25,480 --> 00:30:29,890
right so I'm gonna come at you with some

958
00:30:28,120 --> 00:30:32,649
protocol sample and you don't you aren't

959
00:30:29,890 --> 00:30:34,570
prepared for okay yikes this one's tough

960
00:30:32,650 --> 00:30:38,260
all right hopefully have one recognises

961
00:30:34,570 --> 00:30:39,760
what this is if not if not we'll educate

962
00:30:38,260 --> 00:30:41,950
you really really quickly here quick

963
00:30:39,760 --> 00:30:43,210
summary quick summary blue key was a

964
00:30:41,950 --> 00:30:44,950
vulnerability that came out within the

965
00:30:43,210 --> 00:30:46,510
past what two weeks now I think that

966
00:30:44,950 --> 00:30:48,130
yeah past two weeks vulnerability came

967
00:30:46,510 --> 00:30:49,570
out it was named blue key by someone who

968
00:30:48,130 --> 00:30:50,920
was watching Game of Thrones for anyone

969
00:30:49,570 --> 00:30:52,840
who's wondering yes it is a pivot off of

970
00:30:50,920 --> 00:30:54,820
red keep which is perfect for this talk

971
00:30:52,840 --> 00:30:56,020
far as I'm concerned and any event it

972
00:30:54,820 --> 00:30:57,909
was a vulnerability that came out for

973
00:30:56,020 --> 00:31:00,250
all intents and purposes allows for an

974
00:30:57,910 --> 00:31:01,300
authenticated remote code execution via

975
00:31:00,250 --> 00:31:03,910
RDP

976
00:31:01,300 --> 00:31:05,830
to system by the way to system you will

977
00:31:03,910 --> 00:31:07,210
run into system privileges let's just

978
00:31:05,830 --> 00:31:08,500
say for me for anyone looking for

979
00:31:07,210 --> 00:31:10,030
severity if you have not heard about

980
00:31:08,500 --> 00:31:12,550
this yet if you're looking for how

981
00:31:10,030 --> 00:31:14,530
severe is this Microsoft patched XP

982
00:31:12,550 --> 00:31:16,180
hopefully that means enough where you're

983
00:31:14,530 --> 00:31:17,980
like oh I should pay attention to this

984
00:31:16,180 --> 00:31:19,570
because this unsupported operating

985
00:31:17,980 --> 00:31:21,760
system that like one organ the world

986
00:31:19,570 --> 00:31:23,080
pays for support for everyone got it for

987
00:31:21,760 --> 00:31:23,560
free at this point and I'll do you one

988
00:31:23,080 --> 00:31:26,620
better

989
00:31:23,560 --> 00:31:28,780
RDP supports encryption it does types of

990
00:31:26,620 --> 00:31:29,919
encryption it does so so now we're

991
00:31:28,780 --> 00:31:31,600
taking a lot of lessons and stacking

992
00:31:29,920 --> 00:31:33,750
them on top of each other believe it or

993
00:31:31,600 --> 00:31:34,870
not ladies and gentlemen this is not

994
00:31:33,750 --> 00:31:36,640
undetectable

995
00:31:34,870 --> 00:31:38,800
despite being a zero day we're gonna

996
00:31:36,640 --> 00:31:40,030
talk about how and why that is now we do

997
00:31:38,800 --> 00:31:41,409
not have a working exploit we're not

998
00:31:40,030 --> 00:31:42,850
going to demo working exploit so if

999
00:31:41,410 --> 00:31:45,340
anyone's like can I have a copy of your

1000
00:31:42,850 --> 00:31:46,719
exploit the answer is no because that's

1001
00:31:45,340 --> 00:31:48,100
not our game here we're not here to give

1002
00:31:46,720 --> 00:31:49,300
away exploits but let's just say that

1003
00:31:48,100 --> 00:31:51,730
it's only a matter of time before

1004
00:31:49,300 --> 00:31:53,919
hopefully this thing never reaches

1005
00:31:51,730 --> 00:31:55,690
infamy never let's see if we can stop it

1006
00:31:53,920 --> 00:31:57,160
a little bit earlier on so alright a

1007
00:31:55,690 --> 00:31:59,290
couple things to know our DP is an

1008
00:31:57,160 --> 00:32:01,240
extremely complex protocol before we had

1009
00:31:59,290 --> 00:32:03,790
it easy we were only talking about TLS

1010
00:32:01,240 --> 00:32:05,530
HTTP raw TCP so on and so forth those

1011
00:32:03,790 --> 00:32:08,350
are easy packets very very predictable

1012
00:32:05,530 --> 00:32:11,139
RTP is this massive complex stack of

1013
00:32:08,350 --> 00:32:15,070
things that take place and it's always

1014
00:32:11,140 --> 00:32:17,770
encrypted almost almost always encrypted

1015
00:32:15,070 --> 00:32:20,080
almost when an RDP connection is

1016
00:32:17,770 --> 00:32:22,150
initiated the very very first thing that

1017
00:32:20,080 --> 00:32:23,770
takes place is a client and a server say

1018
00:32:22,150 --> 00:32:25,240
hello now it's not literally a hello

1019
00:32:23,770 --> 00:32:27,100
it's actually called a connection

1020
00:32:25,240 --> 00:32:29,170
initiation and a connection response

1021
00:32:27,100 --> 00:32:30,610
this is part of an initial X 2 to 4

1022
00:32:29,170 --> 00:32:32,800
packet series that gets sent out one

1023
00:32:30,610 --> 00:32:34,959
packet back sorry one packet out one

1024
00:32:32,800 --> 00:32:37,810
packet back did you all hear what I just

1025
00:32:34,960 --> 00:32:40,150
said there are a couple details inside

1026
00:32:37,810 --> 00:32:43,570
of here one packet out one packet back

1027
00:32:40,150 --> 00:32:46,120
the request includes a cookie and a

1028
00:32:43,570 --> 00:32:48,700
requested security protocol aka I would

1029
00:32:46,120 --> 00:32:52,899
like to connect over this the response

1030
00:32:48,700 --> 00:32:55,270
includes a success or failure this

1031
00:32:52,900 --> 00:32:57,220
traffic is always unencrypted I don't

1032
00:32:55,270 --> 00:32:59,620
care what RDP turns into after this

1033
00:32:57,220 --> 00:33:01,570
exchange this exchange is always an

1034
00:32:59,620 --> 00:33:03,370
unencrypted so we took a look at that

1035
00:33:01,570 --> 00:33:05,080
and we said hold on a second here we

1036
00:33:03,370 --> 00:33:07,389
just talked about j-3 a few moments ago

1037
00:33:05,080 --> 00:33:08,679
there are now some of the same details

1038
00:33:07,390 --> 00:33:10,270
that we can work off of and that we can

1039
00:33:08,680 --> 00:33:12,760
pivot through I've got an unencrypted

1040
00:33:10,270 --> 00:33:14,200
space I've got parameters that should be

1041
00:33:12,760 --> 00:33:15,660
included inside of a connection request

1042
00:33:14,200 --> 00:33:18,060
very similar to a

1043
00:33:15,660 --> 00:33:20,220
hello so we started doing some testing

1044
00:33:18,060 --> 00:33:22,080
would be fine yeah and so we were

1045
00:33:20,220 --> 00:33:24,960
actually surprised to see that this it

1046
00:33:22,080 --> 00:33:26,879
is possible and in fact very possible to

1047
00:33:24,960 --> 00:33:29,130
identify what is legitimate and

1048
00:33:26,880 --> 00:33:32,100
illegitimate activity and so obviously

1049
00:33:29,130 --> 00:33:34,980
as matt said we don't have a POC we

1050
00:33:32,100 --> 00:33:36,449
don't have a working version of this but

1051
00:33:34,980 --> 00:33:37,770
we can make some pretty good assumptions

1052
00:33:36,450 --> 00:33:39,360
based off the scanners that are out

1053
00:33:37,770 --> 00:33:42,000
there and based off what we were able to

1054
00:33:39,360 --> 00:33:43,409
learn from our DP both from legitimate

1055
00:33:42,000 --> 00:33:45,090
clients and from some that scanner

1056
00:33:43,410 --> 00:33:47,370
activity and just working through all

1057
00:33:45,090 --> 00:33:50,370
the possibilities so if we take our

1058
00:33:47,370 --> 00:33:52,139
standard gamut of Windows clients we can

1059
00:33:50,370 --> 00:33:53,729
look and see is there a cookie present

1060
00:33:52,140 --> 00:33:54,900
and remember that that cookie there's

1061
00:33:53,730 --> 00:33:57,660
some information that might be able to

1062
00:33:54,900 --> 00:33:59,040
glean be gleaned off of that yep the but

1063
00:33:57,660 --> 00:34:00,330
then we can also look at the requested

1064
00:33:59,040 --> 00:34:01,590
security protocols and obviously as

1065
00:34:00,330 --> 00:34:03,000
versions of Windows have got nearer

1066
00:34:01,590 --> 00:34:04,439
they've added more and more support and

1067
00:34:03,000 --> 00:34:06,600
as you progress through those versions

1068
00:34:04,440 --> 00:34:08,040
of Windows they will indicate to the

1069
00:34:06,600 --> 00:34:09,929
server that they want to go ahead and

1070
00:34:08,040 --> 00:34:11,699
step up that encryption level now the

1071
00:34:09,929 --> 00:34:13,830
problem is from an attackers perspective

1072
00:34:11,699 --> 00:34:15,239
well first off dealing with TLS is a

1073
00:34:13,830 --> 00:34:17,130
pain in the butt so I'd much rather turn

1074
00:34:15,239 --> 00:34:18,959
that sort of thing off that would make

1075
00:34:17,130 --> 00:34:21,030
it make it easier to write an attack

1076
00:34:18,960 --> 00:34:23,490
tool but even if I do have an attack

1077
00:34:21,030 --> 00:34:25,200
tool I can turn on something like the

1078
00:34:23,489 --> 00:34:26,489
low-level the TLS encryption like you

1079
00:34:25,199 --> 00:34:29,189
see down at the bottom that some tools

1080
00:34:26,489 --> 00:34:30,839
do but there's an issue with this

1081
00:34:29,190 --> 00:34:33,240
particular vulnerability which is that

1082
00:34:30,840 --> 00:34:34,950
as you step up at least from our from

1083
00:34:33,239 --> 00:34:37,379
what we've you know been what's been

1084
00:34:34,949 --> 00:34:39,418
published so far that as you step up to

1085
00:34:37,380 --> 00:34:42,000
higher levels of encryption it becomes

1086
00:34:39,418 --> 00:34:43,710
actually a not vulnerable scenario and

1087
00:34:42,000 --> 00:34:46,440
so there's an advantage for the attacker

1088
00:34:43,710 --> 00:34:48,900
both from ease but also for a necessity

1089
00:34:46,440 --> 00:34:50,700
to stay at a lower tier but before we

1090
00:34:48,900 --> 00:34:52,470
even get to that stage we can see from

1091
00:34:50,699 --> 00:34:54,779
the cookie and from that requested

1092
00:34:52,469 --> 00:34:56,310
security protocol whether this is

1093
00:34:54,780 --> 00:34:57,780
legitimate or not is this behaving like

1094
00:34:56,310 --> 00:34:59,250
a normal version of Windows and let's

1095
00:34:57,780 --> 00:35:01,230
make one more mention Aaron talked about

1096
00:34:59,250 --> 00:35:02,670
it's easier to go this certain route so

1097
00:35:01,230 --> 00:35:04,320
we're gonna hopefully see our attackers

1098
00:35:02,670 --> 00:35:05,700
choose to go that easier route one thing

1099
00:35:04,320 --> 00:35:07,050
I will note about this is you can see

1100
00:35:05,700 --> 00:35:08,549
the Mora the more newer you get an

1101
00:35:07,050 --> 00:35:10,500
operating systems the more advanced it

1102
00:35:08,550 --> 00:35:11,760
tends to get there has been and again we

1103
00:35:10,500 --> 00:35:13,350
have not been able to prove this because

1104
00:35:11,760 --> 00:35:15,180
we don't have that working park but for

1105
00:35:13,350 --> 00:35:17,190
everyone who has one there the rumor out

1106
00:35:15,180 --> 00:35:18,720
there is that NLA does mitigate this

1107
00:35:17,190 --> 00:35:20,340
network level authentication so

1108
00:35:18,720 --> 00:35:22,560
obviously that would stand to reason

1109
00:35:20,340 --> 00:35:24,720
then the more I increase in security and

1110
00:35:22,560 --> 00:35:26,279
authentication the earlier on in the

1111
00:35:24,720 --> 00:35:28,649
process that takes place therefore

1112
00:35:26,280 --> 00:35:29,369
higher security vulnerability is

1113
00:35:28,650 --> 00:35:31,079
mitigated

1114
00:35:29,369 --> 00:35:32,700
that's a nice funnel for us defenders

1115
00:35:31,079 --> 00:35:34,859
because it funnels my attackers into

1116
00:35:32,700 --> 00:35:36,779
potentially unencrypted or lightly

1117
00:35:34,859 --> 00:35:38,700
encrypted space which we can use to our

1118
00:35:36,779 --> 00:35:39,960
advantage for sure now we've got a few

1119
00:35:38,700 --> 00:35:40,919
screenshots that we'll take a look

1120
00:35:39,960 --> 00:35:43,410
through here for various operating

1121
00:35:40,920 --> 00:35:45,089
systems each screenshot is going to take

1122
00:35:43,410 --> 00:35:46,170
a look a little bit like this look right

1123
00:35:45,089 --> 00:35:47,490
here we're not asking you to obviously

1124
00:35:46,170 --> 00:35:49,259
memorize these structures or anything

1125
00:35:47,490 --> 00:35:50,970
this is just to give you some insight in

1126
00:35:49,259 --> 00:35:53,730
what this initial packet looks like

1127
00:35:50,970 --> 00:35:55,558
Windows XP for example we'll come over

1128
00:35:53,730 --> 00:35:57,180
with a cookie but it will not come over

1129
00:35:55,559 --> 00:35:59,339
with an encryption request a default of

1130
00:35:57,180 --> 00:36:01,319
zero that really that resorts to RDP

1131
00:35:59,339 --> 00:36:04,499
security which allows for a fantastic

1132
00:36:01,319 --> 00:36:06,089
visibility Windows seven will not give a

1133
00:36:04,499 --> 00:36:08,098
cookie but it will come across with a

1134
00:36:06,089 --> 00:36:10,890
security request of cred SSP which by

1135
00:36:08,099 --> 00:36:13,109
default also includes TLS windows 10 in

1136
00:36:10,890 --> 00:36:14,460
2016 will come with a cookie but they

1137
00:36:13,109 --> 00:36:17,430
also roll in with a security protocol

1138
00:36:14,460 --> 00:36:19,019
request of B and B is cred SSP all the

1139
00:36:17,430 --> 00:36:22,069
way up credits SP with early user

1140
00:36:19,019 --> 00:36:24,689
authorization cred SSP as well as TLS

1141
00:36:22,069 --> 00:36:26,400
our desktop where Gabe breaking outside

1142
00:36:24,690 --> 00:36:28,529
of Windows now this comes across with a

1143
00:36:26,400 --> 00:36:29,519
cookie and a protocol request but let's

1144
00:36:28,529 --> 00:36:31,049
take a look at some of the more

1145
00:36:29,519 --> 00:36:31,950
important tools because notice how now

1146
00:36:31,049 --> 00:36:34,380
all of a sudden when we get into

1147
00:36:31,950 --> 00:36:36,299
Metasploit our DP scan hoops re

1148
00:36:34,380 --> 00:36:38,130
Metasploit and our DP skin take a look

1149
00:36:36,299 --> 00:36:40,859
at that security protocol request they

1150
00:36:38,130 --> 00:36:43,109
come to the door requesting TLS and only

1151
00:36:40,859 --> 00:36:44,279
tell us that is an absolute anomaly

1152
00:36:43,109 --> 00:36:45,930
compared to the rest of your operating

1153
00:36:44,279 --> 00:36:47,400
systems for sure so we had a few

1154
00:36:45,930 --> 00:36:49,140
observations yeah out of this as well

1155
00:36:47,400 --> 00:36:50,099
and so from this we mentioned cookie

1156
00:36:49,140 --> 00:36:52,170
names you'll notice through those

1157
00:36:50,099 --> 00:36:53,579
through the screenshots that we had

1158
00:36:52,170 --> 00:36:54,989
there that you can get some username

1159
00:36:53,579 --> 00:36:56,309
information off of there and potentially

1160
00:36:54,989 --> 00:36:57,960
if you know what's the legitimate

1161
00:36:56,309 --> 00:36:59,700
username you can key off of that and say

1162
00:36:57,960 --> 00:37:01,380
this is this is a user that's actually

1163
00:36:59,700 --> 00:37:03,149
on my domain alternatively if you see a

1164
00:37:01,380 --> 00:37:05,069
randomized string obviously it's not

1165
00:37:03,150 --> 00:37:05,999
very easy to key off of that but this is

1166
00:37:05,069 --> 00:37:09,299
there's some useful information there

1167
00:37:05,999 --> 00:37:11,519
it's seeing a very low request or the

1168
00:37:09,299 --> 00:37:14,400
absence specifically of a request is

1169
00:37:11,519 --> 00:37:15,660
indicative of Windows XP but keep in

1170
00:37:14,400 --> 00:37:17,609
mind that when you do that

1171
00:37:15,660 --> 00:37:20,519
you are you're accepting no encryption

1172
00:37:17,609 --> 00:37:23,249
so I can so really from the attack

1173
00:37:20,519 --> 00:37:25,319
perspective the best I can do is behave

1174
00:37:23,249 --> 00:37:27,450
like a Windows XP client would but in

1175
00:37:25,319 --> 00:37:29,279
doing so I'm allowing that to see

1176
00:37:27,450 --> 00:37:31,618
everything that's inside of that traffic

1177
00:37:29,279 --> 00:37:33,809
so even doing so is anomalous so if he

1178
00:37:31,619 --> 00:37:35,130
steps down I'm still gonna see what's

1179
00:37:33,809 --> 00:37:36,839
taking place in that case right there

1180
00:37:35,130 --> 00:37:38,009
um there was one other scenario or two

1181
00:37:36,839 --> 00:37:39,569
other scenarios where we saw a double

1182
00:37:38,009 --> 00:37:40,799
tak take place and we've got just a

1183
00:37:39,569 --> 00:37:42,750
couple more summary points here and then

1184
00:37:40,799 --> 00:37:43,950
we're all set when a downgrade

1185
00:37:42,750 --> 00:37:45,930
takes place meaning if I'm an attacker

1186
00:37:43,950 --> 00:37:46,980
and I try to force from high to low you

1187
00:37:45,930 --> 00:37:48,870
will see a double tap where the

1188
00:37:46,980 --> 00:37:51,420
connection gets forcibly reset that

1189
00:37:48,870 --> 00:37:53,279
gives us another anomalous alert and as

1190
00:37:51,420 --> 00:37:55,200
we mentioned as well there is a POC that

1191
00:37:53,280 --> 00:37:56,520
does that and it gives you a double tap

1192
00:37:55,200 --> 00:37:59,279
but once again it comes through with a

1193
00:37:56,520 --> 00:38:01,050
TLS request so either way our TLS or

1194
00:37:59,280 --> 00:38:03,060
absence of encryption would still catch

1195
00:38:01,050 --> 00:38:04,320
either of those taking place there and

1196
00:38:03,060 --> 00:38:06,840
here's an example of that particular

1197
00:38:04,320 --> 00:38:08,310
screenshot and that double tap now

1198
00:38:06,840 --> 00:38:09,390
seeing as we are almost just about out

1199
00:38:08,310 --> 00:38:10,620
of time we want to give everyone an

1200
00:38:09,390 --> 00:38:11,970
opportunity to kind of catch the next

1201
00:38:10,620 --> 00:38:13,740
session and whatnot I think we'll hop to

1202
00:38:11,970 --> 00:38:16,319
our conclusion slide sure and just say

1203
00:38:13,740 --> 00:38:17,549
that from a host-based perspective there

1204
00:38:16,320 --> 00:38:19,320
are a lot of artifacts you could dig

1205
00:38:17,550 --> 00:38:20,670
into but the host is not the only place

1206
00:38:19,320 --> 00:38:22,500
where I can catch what Aaron is doing

1207
00:38:20,670 --> 00:38:23,910
and what the red teamers are doing I can

1208
00:38:22,500 --> 00:38:25,440
usually catch them earlier at the

1209
00:38:23,910 --> 00:38:27,450
network level because there's sometimes

1210
00:38:25,440 --> 00:38:28,830
very definitive signals that say they're

1211
00:38:27,450 --> 00:38:30,240
doing what they're doing at that case

1212
00:38:28,830 --> 00:38:32,400
for sure and and I've been very

1213
00:38:30,240 --> 00:38:34,020
impressed and throughout this process to

1214
00:38:32,400 --> 00:38:35,520
see that even when you rely on things

1215
00:38:34,020 --> 00:38:37,320
like encryption as an attacker trying to

1216
00:38:35,520 --> 00:38:40,290
hide in with what is considered best

1217
00:38:37,320 --> 00:38:42,270
practices and normal HTTP and HTTPS and

1218
00:38:40,290 --> 00:38:44,190
TLS that you still leave a lot of those

1219
00:38:42,270 --> 00:38:45,660
fingerprints behind and so there's a lot

1220
00:38:44,190 --> 00:38:47,460
of value to be gleaned from that that

1221
00:38:45,660 --> 00:38:49,560
sort of information and lastly we'll

1222
00:38:47,460 --> 00:38:51,210
just say that you know any deviation

1223
00:38:49,560 --> 00:38:52,980
from standard protocol is yet another

1224
00:38:51,210 --> 00:38:54,060
anomaly itself as you notice as we walk

1225
00:38:52,980 --> 00:38:55,890
through these things I was looking for

1226
00:38:54,060 --> 00:38:57,840
areas where Aaron's tools broke out of

1227
00:38:55,890 --> 00:38:59,609
what I expected to see or when I had to

1228
00:38:57,840 --> 00:39:00,960
break or when he had to start catching

1229
00:38:59,610 --> 00:39:02,550
too much absolutely but with that

1230
00:39:00,960 --> 00:39:04,080
everyone I think we are just that time

1231
00:39:02,550 --> 00:39:05,400
am i right we're just at time so thank

1232
00:39:04,080 --> 00:39:06,480
you all very much for coming this after

1233
00:39:05,400 --> 00:39:08,310
or this morning I think it is still

1234
00:39:06,480 --> 00:39:09,330
still this morning so this morning thank

1235
00:39:08,310 --> 00:39:10,920
you all for coming this morning it was

1236
00:39:09,330 --> 00:39:12,720
awesome having you in here we'd love to

1237
00:39:10,920 --> 00:39:13,770
entertain questions outside if we need

1238
00:39:12,720 --> 00:39:15,330
to move off the stage but otherwise

1239
00:39:13,770 --> 00:39:17,160
thank you all very much have an awesome

1240
00:39:15,330 --> 00:39:19,580
day - of all sir thank you so much for

1241
00:39:17,160 --> 00:39:19,580
having very much

1242
00:39:19,900 --> 00:39:21,960
you

