1
00:00:01,040 --> 00:00:05,920
hello today i'm going to talk

2
00:00:03,040 --> 00:00:07,279
about a well-known smell some of you

3
00:00:05,920 --> 00:00:09,920
might remember my talk

4
00:00:07,279 --> 00:00:12,639
at both 2018 in which i presented the

5
00:00:09,920 --> 00:00:15,759
evolution of snake which is another name

6
00:00:12,639 --> 00:00:17,759
for the infamous chola apt group

7
00:00:15,759 --> 00:00:20,240
and i'm back to present what changed

8
00:00:17,760 --> 00:00:22,400
since 2018.

9
00:00:20,240 --> 00:00:23,599
in the past two years we investigated

10
00:00:22,400 --> 00:00:25,439
several incidents

11
00:00:23,600 --> 00:00:26,640
involving two online high-profile

12
00:00:25,439 --> 00:00:28,840
organization

13
00:00:26,640 --> 00:00:30,000
i'm matu faux a mario researcher at

14
00:00:28,840 --> 00:00:32,960
essex

15
00:00:30,000 --> 00:00:35,920
and my day-to-day job is to track apts

16
00:00:32,960 --> 00:00:39,280
using the reset telemetry

17
00:00:35,920 --> 00:00:42,480
first who is tiola according to this

18
00:00:39,280 --> 00:00:46,960
recent tweet from the us cybercom

19
00:00:42,480 --> 00:00:48,879
she lies injuredly a russian sponsor apt

20
00:00:46,960 --> 00:00:51,199
they have been known for more than 10

21
00:00:48,879 --> 00:00:53,440
years with for example the compromise of

22
00:00:51,199 --> 00:00:56,640
the u.s military in 2008

23
00:00:53,440 --> 00:00:58,640
using the infamous agenda ptz1

24
00:00:56,640 --> 00:01:00,480
more recently they have compromised the

25
00:00:58,640 --> 00:01:02,800
german foreign office

26
00:01:00,480 --> 00:01:04,479
and several mailboxes belonging to the

27
00:01:02,800 --> 00:01:07,439
french military

28
00:01:04,479 --> 00:01:08,479
these are just a few public examples but

29
00:01:07,439 --> 00:01:11,439
most of their attacks

30
00:01:08,479 --> 00:01:13,439
are not public because jonah mainly

31
00:01:11,439 --> 00:01:13,839
target organizations that don't talk

32
00:01:13,439 --> 00:01:17,119
about

33
00:01:13,840 --> 00:01:19,520
cyber security issues

34
00:01:17,119 --> 00:01:20,400
in the past years the main target we

35
00:01:19,520 --> 00:01:23,119
observe

36
00:01:20,400 --> 00:01:24,000
are ministry of foreign affairs in

37
00:01:23,119 --> 00:01:27,200
europe

38
00:01:24,000 --> 00:01:30,320
government in central asia diplomats

39
00:01:27,200 --> 00:01:33,360
in in the middle east

40
00:01:30,320 --> 00:01:34,720
uh diplomats in south south america and

41
00:01:33,360 --> 00:01:37,119
some private companies in

42
00:01:34,720 --> 00:01:38,560
asia so for asia we don't have

43
00:01:37,119 --> 00:01:41,200
first-team information but

44
00:01:38,560 --> 00:01:43,840
this is based on submissions i saw on

45
00:01:41,200 --> 00:01:45,920
various total

46
00:01:43,840 --> 00:01:48,079
attackers motives is important when it

47
00:01:45,920 --> 00:01:50,320
comes to defending against a specific

48
00:01:48,079 --> 00:01:52,399
threat actually

49
00:01:50,320 --> 00:01:53,758
to our knowledge chola conducts

50
00:01:52,399 --> 00:01:56,399
espionage

51
00:01:53,759 --> 00:01:57,200
operations and is interested in private

52
00:01:56,399 --> 00:02:00,960
documents

53
00:01:57,200 --> 00:02:04,240
of his targets contrary to other group

54
00:02:00,960 --> 00:02:07,600
they do not push miners or run somewhere

55
00:02:04,240 --> 00:02:09,038
thus it is likely that chola will stay

56
00:02:07,600 --> 00:02:12,000
undetected for months

57
00:02:09,038 --> 00:02:12,000
or even years

58
00:02:12,080 --> 00:02:16,640
the generally collect document in bulk

59
00:02:15,280 --> 00:02:19,200
meaning that it's not possible to

60
00:02:16,640 --> 00:02:23,839
determine the subject of interest

61
00:02:19,200 --> 00:02:23,839
just by looking at the accelerated data

62
00:02:24,000 --> 00:02:28,319
this is an example of a mysql query that

63
00:02:27,120 --> 00:02:30,400
your operators were

64
00:02:28,319 --> 00:02:31,920
performing at regular interval to

65
00:02:30,400 --> 00:02:35,120
collect recent documents

66
00:02:31,920 --> 00:02:35,679
in the central database they show that

67
00:02:35,120 --> 00:02:37,920
they were

68
00:02:35,680 --> 00:02:40,959
interesting in doc docks and some

69
00:02:37,920 --> 00:02:43,839
specific pdf files

70
00:02:40,959 --> 00:02:46,480
this is another example that we found on

71
00:02:43,840 --> 00:02:48,720
another organization

72
00:02:46,480 --> 00:02:49,599
in that example they use the winrar

73
00:02:48,720 --> 00:02:51,920
application

74
00:02:49,599 --> 00:02:54,079
and they are collecting documents such

75
00:02:51,920 --> 00:02:58,799
as dot pdf for excel files

76
00:02:54,080 --> 00:02:58,800
from specific folder and the recycle bin

77
00:03:00,080 --> 00:03:03,760
when it comes to compromise the target

78
00:03:02,000 --> 00:03:06,959
the first step is to get

79
00:03:03,760 --> 00:03:08,720
in in the machine over the past years

80
00:03:06,959 --> 00:03:10,879
children have used techniques such as

81
00:03:08,720 --> 00:03:12,800
spearfishing emails or money the middle

82
00:03:10,879 --> 00:03:16,799
attack probably at the isp level

83
00:03:12,800 --> 00:03:16,800
but this is not what we have observed

84
00:03:16,840 --> 00:03:20,640
recently

85
00:03:18,319 --> 00:03:21,518
since season 18 the main cause of

86
00:03:20,640 --> 00:03:23,679
compromise are

87
00:03:21,519 --> 00:03:25,120
importantly clean network and watering

88
00:03:23,680 --> 00:03:28,159
all attacks

89
00:03:25,120 --> 00:03:29,840
the former is quite common as it is

90
00:03:28,159 --> 00:03:33,359
it is a challenge to totally clean a

91
00:03:29,840 --> 00:03:35,280
network owns compromise with jola

92
00:03:33,360 --> 00:03:38,000
watarimal attacks also known as

93
00:03:35,280 --> 00:03:40,879
strategic web compromise

94
00:03:38,000 --> 00:03:42,319
consists in compromising websites that

95
00:03:40,879 --> 00:03:45,120
are visited by the

96
00:03:42,319 --> 00:03:46,720
person you you want to infect in the

97
00:03:45,120 --> 00:03:48,640
case of tyola

98
00:03:46,720 --> 00:03:50,400
selected visitors are redirected to a

99
00:03:48,640 --> 00:03:52,399
fake flash update page controlled by the

100
00:03:50,400 --> 00:03:55,040
attacker

101
00:03:52,400 --> 00:03:56,080
this is the summary of the last watery

102
00:03:55,040 --> 00:04:00,720
mall attack

103
00:03:56,080 --> 00:04:03,519
that happened in 2019

104
00:04:00,720 --> 00:04:05,040
they compromised several websites

105
00:04:03,519 --> 00:04:07,280
related to armenia

106
00:04:05,040 --> 00:04:08,720
and the second one is interesting

107
00:04:07,280 --> 00:04:09,439
because this is a ministry of the

108
00:04:08,720 --> 00:04:12,159
republic of

109
00:04:09,439 --> 00:04:12,879
artsakh and this is a region where war

110
00:04:12,159 --> 00:04:16,959
took place

111
00:04:12,879 --> 00:04:21,680
this fall between armenia and azerbaijan

112
00:04:16,959 --> 00:04:24,720
on those websites they added a

113
00:04:21,680 --> 00:04:27,680
piece of obfuscated javascript code

114
00:04:24,720 --> 00:04:28,720
that is responsible for loading a

115
00:04:27,680 --> 00:04:31,919
fingerprint script

116
00:04:28,720 --> 00:04:34,960
from the cnc server so this fingerprint

117
00:04:31,919 --> 00:04:38,080
script will send back to the cnc server

118
00:04:34,960 --> 00:04:40,159
some information about the visitor

119
00:04:38,080 --> 00:04:42,159
then if the visitor is deemed

120
00:04:40,160 --> 00:04:44,639
interesting we believe that

121
00:04:42,160 --> 00:04:47,040
this is a manual choice by the attacker

122
00:04:44,639 --> 00:04:50,160
they will be redirected to a fake flash

123
00:04:47,040 --> 00:04:53,199
update webpage then

124
00:04:50,160 --> 00:04:54,960
the visitor need to manually click on

125
00:04:53,199 --> 00:04:56,080
the link to download the fake flash

126
00:04:54,960 --> 00:04:59,039
update and manually

127
00:04:56,080 --> 00:05:01,198
execute it so there was no exploit

128
00:04:59,040 --> 00:05:04,160
involved

129
00:05:01,199 --> 00:05:05,199
then once you has executed the fake

130
00:05:04,160 --> 00:05:09,280
adobe flash

131
00:05:05,199 --> 00:05:11,440
update application

132
00:05:09,280 --> 00:05:12,400
uh uh malware will be installed before

133
00:05:11,440 --> 00:05:15,280
september

134
00:05:12,400 --> 00:05:15,919
2019 it was skipper which is a

135
00:05:15,280 --> 00:05:18,159
well-known

136
00:05:15,919 --> 00:05:19,039
jolla first stage and then they switched

137
00:05:18,160 --> 00:05:21,360
to a

138
00:05:19,039 --> 00:05:22,800
newer malware families we called

139
00:05:21,360 --> 00:05:25,919
netflash and pie flash

140
00:05:22,800 --> 00:05:28,400
by flash being a custom python

141
00:05:25,919 --> 00:05:28,400
background

142
00:05:30,880 --> 00:05:34,479
as the main goal of tool is to stay

143
00:05:32,720 --> 00:05:36,639
undetected for a long time

144
00:05:34,479 --> 00:05:38,080
generally months or years there are a

145
00:05:36,639 --> 00:05:40,560
few implants dedicated

146
00:05:38,080 --> 00:05:42,240
to this task today i choose to present

147
00:05:40,560 --> 00:05:45,520
three of them

148
00:05:42,240 --> 00:05:47,440
the first one is light neuron

149
00:05:45,520 --> 00:05:48,639
it persists as a microsoft exchange

150
00:05:47,440 --> 00:05:51,280
transfer agent

151
00:05:48,639 --> 00:05:52,400
which is a plug-in system for the

152
00:05:51,280 --> 00:05:54,880
microsoft exchange

153
00:05:52,400 --> 00:05:56,318
mail server and it's generally used by

154
00:05:54,880 --> 00:06:00,080
anti-spam products

155
00:05:56,319 --> 00:06:03,360
it allows full access on the uh

156
00:06:00,080 --> 00:06:05,680
email traffic as uh it allows

157
00:06:03,360 --> 00:06:07,360
to set up callback on events such as

158
00:06:05,680 --> 00:06:09,680
when an email is received by the mail

159
00:06:07,360 --> 00:06:09,680
server

160
00:06:11,199 --> 00:06:16,560
so this is a summary of how the

161
00:06:14,479 --> 00:06:18,240
backdoor part of lanyard works so this

162
00:06:16,560 --> 00:06:20,400
is a passive backdoor

163
00:06:18,240 --> 00:06:22,560
and in that case i will present a case

164
00:06:20,400 --> 00:06:24,318
where the exchange server is already

165
00:06:22,560 --> 00:06:26,880
compromised by like you know this is not

166
00:06:24,319 --> 00:06:27,680
how they first enter the network and

167
00:06:26,880 --> 00:06:30,400
compromise the

168
00:06:27,680 --> 00:06:31,360
mesa i'm presenting how they can execute

169
00:06:30,400 --> 00:06:34,719
command

170
00:06:31,360 --> 00:06:35,840
on the server so turtle operator will

171
00:06:34,720 --> 00:06:38,639
send an email to

172
00:06:35,840 --> 00:06:39,758
any email address of the compromise

173
00:06:38,639 --> 00:06:42,400
organization

174
00:06:39,759 --> 00:06:44,880
and they will add a specially crafted

175
00:06:42,400 --> 00:06:44,880
attachment

176
00:06:46,000 --> 00:06:49,360
then this email will be received by the

177
00:06:48,240 --> 00:06:51,599
exchange server

178
00:06:49,360 --> 00:06:52,400
as like iran is installed as a transfer

179
00:06:51,599 --> 00:06:54,960
agent

180
00:06:52,400 --> 00:06:56,799
uh the one of its callback will be

181
00:06:54,960 --> 00:07:00,400
called

182
00:06:56,800 --> 00:07:03,120
so latvian will process the email check

183
00:07:00,400 --> 00:07:04,880
the attachment if it's a pdf or a jpeg

184
00:07:03,120 --> 00:07:07,280
it will check if

185
00:07:04,880 --> 00:07:09,039
there is a specific signature if the

186
00:07:07,280 --> 00:07:11,758
signature is there in main exact

187
00:07:09,039 --> 00:07:12,719
it's an email that was created by a tool

188
00:07:11,759 --> 00:07:16,160
operator

189
00:07:12,720 --> 00:07:19,280
so it will extract encrypted data

190
00:07:16,160 --> 00:07:21,199
decrypted and this decrypted data is

191
00:07:19,280 --> 00:07:22,318
a command to execute and the command

192
00:07:21,199 --> 00:07:24,800
will be executed

193
00:07:22,319 --> 00:07:27,120
so it is a passive backdoor meaning that

194
00:07:24,800 --> 00:07:29,360
black neuron is never reaching out

195
00:07:27,120 --> 00:07:31,759
to a cnc server but this is the

196
00:07:29,360 --> 00:07:33,360
controller actual operators is directly

197
00:07:31,759 --> 00:07:35,919
sending commands and commands are

198
00:07:33,360 --> 00:07:35,919
executed

199
00:07:37,759 --> 00:07:42,800
the other function of live neuron is to

200
00:07:40,319 --> 00:07:44,800
modify legitimate emails

201
00:07:42,800 --> 00:07:46,720
so as i said before it has access to the

202
00:07:44,800 --> 00:07:48,319
full email traffic of the compromise

203
00:07:46,720 --> 00:07:50,879
exchange server

204
00:07:48,319 --> 00:07:53,199
so let's imagine that someone is sending

205
00:07:50,879 --> 00:07:56,720
a legitimate email

206
00:07:53,199 --> 00:07:57,680
to to anyone in the in the compromise

207
00:07:56,720 --> 00:07:59,280
organization

208
00:07:57,680 --> 00:08:01,759
so the email will be received by the

209
00:07:59,280 --> 00:08:04,239
exchange server uh as before it will be

210
00:08:01,759 --> 00:08:06,560
processed by life neuron

211
00:08:04,240 --> 00:08:07,680
then you will apply some it will apply

212
00:08:06,560 --> 00:08:10,879
some rules

213
00:08:07,680 --> 00:08:13,759
so this will define

214
00:08:10,879 --> 00:08:15,599
xml and they are tailored for each

215
00:08:13,759 --> 00:08:18,160
victim

216
00:08:15,599 --> 00:08:18,800
so there is a rule enzyme in in line

217
00:08:18,160 --> 00:08:21,840
neuron

218
00:08:18,800 --> 00:08:25,440
and it uses a logic operator such as n

219
00:08:21,840 --> 00:08:28,400
or and conditions

220
00:08:25,440 --> 00:08:29,120
on specific fields of the email can be

221
00:08:28,400 --> 00:08:32,079
specified

222
00:08:29,120 --> 00:08:32,959
for example two-field or form field and

223
00:08:32,080 --> 00:08:36,080
based on that

224
00:08:32,958 --> 00:08:38,319
uh let me one will take some actions so

225
00:08:36,080 --> 00:08:40,080
actions can be modify the email block

226
00:08:38,320 --> 00:08:42,640
the email do nothing and

227
00:08:40,080 --> 00:08:43,279
also dump the email on disk so in case

228
00:08:42,640 --> 00:08:46,480
of modi

229
00:08:43,279 --> 00:08:49,439
modification it's quite powerful as

230
00:08:46,480 --> 00:08:52,160
we can imagine that um like neon can be

231
00:08:49,440 --> 00:08:55,040
used to add some zero day in an existing

232
00:08:52,160 --> 00:08:55,920
world or i don't know excel document and

233
00:08:55,040 --> 00:09:00,959
then it will be

234
00:08:55,920 --> 00:09:00,959
delivered to to the final receiver

235
00:09:02,640 --> 00:09:07,279
finally there is another version of

236
00:09:05,200 --> 00:09:09,440
knight neuron called netruns it's

237
00:09:07,279 --> 00:09:10,720
fully in.net later on there is a one

238
00:09:09,440 --> 00:09:14,399
module in dotnet

239
00:09:10,720 --> 00:09:17,680
and also one module in cyprus plus for

240
00:09:14,399 --> 00:09:21,120
for uh such things

241
00:09:17,680 --> 00:09:23,439
things such as the rule enzyme but in

242
00:09:21,120 --> 00:09:24,959
in netruns it's fully.net and it

243
00:09:23,440 --> 00:09:27,600
implements only a subset of

244
00:09:24,959 --> 00:09:27,599
functionality

245
00:09:28,240 --> 00:09:31,360
so if you want more information please

246
00:09:30,080 --> 00:09:34,560
check our whitepaper

247
00:09:31,360 --> 00:09:34,560
you have the link here

248
00:09:34,959 --> 00:09:39,518
now let's jump to the second long-term

249
00:09:37,920 --> 00:09:43,079
implant which is comrades

250
00:09:39,519 --> 00:09:44,240
version four this is the descendant of

251
00:09:43,080 --> 00:09:46,320
legend.btz

252
00:09:44,240 --> 00:09:48,160
which was the one we used against the us

253
00:09:46,320 --> 00:09:50,720
military in 2008.

254
00:09:48,160 --> 00:09:52,000
it has been extensively analyzed for

255
00:09:50,720 --> 00:09:54,800
example the

256
00:09:52,000 --> 00:09:56,640
publication by g data uh from several

257
00:09:54,800 --> 00:09:58,800
years ago

258
00:09:56,640 --> 00:10:02,240
this version four is in full sequence

259
00:09:58,800 --> 00:10:03,760
plus and it uses several design patterns

260
00:10:02,240 --> 00:10:07,600
it so it shows the level of

261
00:10:03,760 --> 00:10:10,160
professionalism of its developer

262
00:10:07,600 --> 00:10:10,880
it persists using a portion loader based

263
00:10:10,160 --> 00:10:14,399
on the

264
00:10:10,880 --> 00:10:17,279
open source project power supply

265
00:10:14,399 --> 00:10:18,000
one of this is distinctive feature is

266
00:10:17,279 --> 00:10:21,040
its virtual

267
00:10:18,000 --> 00:10:21,839
file system in fact 16. this is not the

268
00:10:21,040 --> 00:10:24,640
first time

269
00:10:21,839 --> 00:10:26,399
taller use uses a virtual file system

270
00:10:24,640 --> 00:10:28,480
for example there is one in the snake

271
00:10:26,399 --> 00:10:32,320
root kit

272
00:10:28,480 --> 00:10:34,560
but so in that case on this this is a

273
00:10:32,320 --> 00:10:38,079
regular file but once this decrypted

274
00:10:34,560 --> 00:10:40,399
it's it's a fat 16 partition

275
00:10:38,079 --> 00:10:41,599
it contains several folders in for

276
00:10:40,399 --> 00:10:44,880
example there is a

277
00:10:41,600 --> 00:10:47,920
configuration for the command control

278
00:10:44,880 --> 00:10:49,040
channel that uses email in slash etc

279
00:10:47,920 --> 00:10:53,599
slash transport

280
00:10:49,040 --> 00:10:56,880
slash main and if we open the cookie.str

281
00:10:53,600 --> 00:10:58,640
file we have access to

282
00:10:56,880 --> 00:11:01,680
the cookies that will be used to connect

283
00:10:58,640 --> 00:11:05,279
to the gmail wave interface

284
00:11:01,680 --> 00:11:08,319
there is also configuration for the http

285
00:11:05,279 --> 00:11:11,680
network protocol and also log files

286
00:11:08,320 --> 00:11:15,760
there is one called working.c4 log

287
00:11:11,680 --> 00:11:17,680
c4 standing for change4

288
00:11:15,760 --> 00:11:19,760
change being the internal name of

289
00:11:17,680 --> 00:11:22,640
comrades

290
00:11:19,760 --> 00:11:24,160
so in this working dot c4 log there is a

291
00:11:22,640 --> 00:11:26,959
lot of interesting information

292
00:11:24,160 --> 00:11:29,839
such as the last commands executed by

293
00:11:26,959 --> 00:11:29,839
the background

294
00:11:30,000 --> 00:11:33,040
the second distinctive feature of

295
00:11:32,160 --> 00:11:37,279
comrades

296
00:11:33,040 --> 00:11:40,560
if it is are its cnc communications

297
00:11:37,279 --> 00:11:43,600
so the the first cnc channel is

298
00:11:40,560 --> 00:11:44,000
called legacy and it is an exact copy of

299
00:11:43,600 --> 00:11:46,880
the

300
00:11:44,000 --> 00:11:48,800
combat version three protocol we believe

301
00:11:46,880 --> 00:11:51,839
it is intended to be compatible

302
00:11:48,800 --> 00:11:53,439
with old cnc server overdue the need for

303
00:11:51,839 --> 00:11:55,279
the operator to redeploy your full

304
00:11:53,440 --> 00:11:57,440
network infrastructure

305
00:11:55,279 --> 00:11:59,360
the second command control channel uses

306
00:11:57,440 --> 00:12:02,560
the gmail web ui and it is

307
00:11:59,360 --> 00:12:05,519
an asynchronous email protocol

308
00:12:02,560 --> 00:12:07,279
but in synchronous i mean that operators

309
00:12:05,519 --> 00:12:11,360
are sending commands that are

310
00:12:07,279 --> 00:12:13,920
that can stay on in the gmail inbox

311
00:12:11,360 --> 00:12:14,880
waiting for the backdoor to connect to

312
00:12:13,920 --> 00:12:18,000
the gmail

313
00:12:14,880 --> 00:12:18,880
inbox to to retrieve it also what's

314
00:12:18,000 --> 00:12:21,120
quite funny

315
00:12:18,880 --> 00:12:25,839
is that it embeds the html parser called

316
00:12:21,120 --> 00:12:25,839
gumbo which is also developed by google

317
00:12:27,120 --> 00:12:30,720
so first the chiller operator sends an

318
00:12:29,120 --> 00:12:31,440
email with a specially crafted

319
00:12:30,720 --> 00:12:33,920
attachment

320
00:12:31,440 --> 00:12:35,519
to a dedicated gmail mailbox so these

321
00:12:33,920 --> 00:12:36,959
mailboxes are created and

322
00:12:35,519 --> 00:12:39,360
under the full control of child

323
00:12:36,959 --> 00:12:40,319
operators and are not compromising main

324
00:12:39,360 --> 00:12:44,000
boxes

325
00:12:40,320 --> 00:12:47,839
however they generally mimic the name of

326
00:12:44,000 --> 00:12:50,839
an employee of the of the

327
00:12:47,839 --> 00:12:52,639
compromise organization in order to to

328
00:12:50,839 --> 00:12:55,360
be

329
00:12:52,639 --> 00:12:55,360
more stealthy

330
00:12:55,680 --> 00:12:59,839
then the compromise machine will connect

331
00:12:58,959 --> 00:13:02,319
to this

332
00:12:59,839 --> 00:13:05,600
mailbox using the cookies i showed you

333
00:13:02,320 --> 00:13:07,920
earlier it will check for new emails

334
00:13:05,600 --> 00:13:09,440
so this is an example of an email for

335
00:13:07,920 --> 00:13:11,920
the second the example is

336
00:13:09,440 --> 00:13:14,240
displaying outlook but directly it's in

337
00:13:11,920 --> 00:13:16,479
the gmail web interface

338
00:13:14,240 --> 00:13:17,600
we can see that the email was sent from

339
00:13:16,480 --> 00:13:21,120
another

340
00:13:17,600 --> 00:13:24,160
free email provider called gmx

341
00:13:21,120 --> 00:13:27,440
and there is also an attachment

342
00:13:24,160 --> 00:13:27,920
uh it is actually not excel files there

343
00:13:27,440 --> 00:13:30,320
is

344
00:13:27,920 --> 00:13:35,279
just the extension but it's actually

345
00:13:30,320 --> 00:13:38,880
encrypted robots

346
00:13:35,279 --> 00:13:41,360
then comrade will pass the html of

347
00:13:38,880 --> 00:13:42,639
gmail in order to retrieve the link to

348
00:13:41,360 --> 00:13:45,040
download the attachment

349
00:13:42,639 --> 00:13:49,360
it will download the attachments decrypt

350
00:13:45,040 --> 00:13:51,199
the content and execute the commands

351
00:13:49,360 --> 00:13:53,360
so this is an example of a set of

352
00:13:51,199 --> 00:13:56,399
commands

353
00:13:53,360 --> 00:14:00,959
sent by the attacker to comrade

354
00:13:56,399 --> 00:14:02,639
in this case the application acpvt2.txc

355
00:14:00,959 --> 00:14:06,800
is a winrar application

356
00:14:02,639 --> 00:14:09,760
so first they will compress some data

357
00:14:06,800 --> 00:14:12,479
then they will mount a cloud storage a

358
00:14:09,760 --> 00:14:15,279
onedrive cloud storage

359
00:14:12,480 --> 00:14:16,800
and then they will copy the compressed

360
00:14:15,279 --> 00:14:19,040
data to this cloud storage

361
00:14:16,800 --> 00:14:20,079
so it is quite interesting to see that

362
00:14:19,040 --> 00:14:23,279
they are using

363
00:14:20,079 --> 00:14:25,519
uh another network channel to

364
00:14:23,279 --> 00:14:26,959
to transfer stolen data and they are not

365
00:14:25,519 --> 00:14:30,880
using the command control

366
00:14:26,959 --> 00:14:34,560
channel gmail

367
00:14:30,880 --> 00:14:35,120
this second example this is very similar

368
00:14:34,560 --> 00:14:37,680
but

369
00:14:35,120 --> 00:14:39,199
this term they are using rpc backdoor

370
00:14:37,680 --> 00:14:41,199
which is containing the powershell

371
00:14:39,199 --> 00:14:43,680
loader kcl.ps1

372
00:14:41,199 --> 00:14:45,599
so rpc backdoor it's used to execute

373
00:14:43,680 --> 00:14:46,560
comments on another machine of the local

374
00:14:45,600 --> 00:14:48,720
network

375
00:14:46,560 --> 00:14:50,239
and this the name of the local machine

376
00:14:48,720 --> 00:14:54,079
is specifying the

377
00:14:50,240 --> 00:14:57,040
iv key variable so

378
00:14:54,079 --> 00:14:59,040
as before they will compress some data

379
00:14:57,040 --> 00:15:02,480
then they will mount

380
00:14:59,040 --> 00:15:03,519
the the cloud storage and then they will

381
00:15:02,480 --> 00:15:06,560
copy

382
00:15:03,519 --> 00:15:09,120
the archive user so

383
00:15:06,560 --> 00:15:10,479
in that case the storing data isn't even

384
00:15:09,120 --> 00:15:12,720
going through

385
00:15:10,480 --> 00:15:14,000
the machine compromise with comrade but

386
00:15:12,720 --> 00:15:16,880
it is directly

387
00:15:14,000 --> 00:15:19,440
going from the other local machine to

388
00:15:16,880 --> 00:15:19,439
one drive

389
00:15:21,279 --> 00:15:24,560
if you want more details for example

390
00:15:24,079 --> 00:15:26,479
about

391
00:15:24,560 --> 00:15:28,079
the command control protocol please

392
00:15:26,480 --> 00:15:32,160
check our white paper

393
00:15:28,079 --> 00:15:35,839
again on our blog withifsecurity.com

394
00:15:32,160 --> 00:15:39,120
and now let's jump to the last

395
00:15:35,839 --> 00:15:41,920
long-term implant which is scratch

396
00:15:39,120 --> 00:15:42,480
it was previously undocumented as this

397
00:15:41,920 --> 00:15:44,160
talk

398
00:15:42,480 --> 00:15:45,839
is recording i'm not sure if the white

399
00:15:44,160 --> 00:15:48,480
paper will be available

400
00:15:45,839 --> 00:15:50,639
uh before or after botcoms but you can

401
00:15:48,480 --> 00:15:53,040
check on our blog

402
00:15:50,639 --> 00:15:54,320
so crotch is a tool set mainly used to

403
00:15:53,040 --> 00:15:56,880
collect documents

404
00:15:54,320 --> 00:15:58,000
and it used plotbox as a command control

405
00:15:56,880 --> 00:16:00,000
server

406
00:15:58,000 --> 00:16:03,360
according to our visibility it was

407
00:16:00,000 --> 00:16:06,079
active from 2015 to early 2020

408
00:16:03,360 --> 00:16:06,720
and as you can see at the bottom of this

409
00:16:06,079 --> 00:16:09,040
slide

410
00:16:06,720 --> 00:16:11,600
crotch is the name given by by its

411
00:16:09,040 --> 00:16:11,599
developer

412
00:16:11,759 --> 00:16:15,279
so crouch was never publicly attributed

413
00:16:13,920 --> 00:16:18,079
to chola

414
00:16:15,279 --> 00:16:20,839
when we found it so we had to identify a

415
00:16:18,079 --> 00:16:22,160
few elements that allowed us to make the

416
00:16:20,839 --> 00:16:24,959
attribution

417
00:16:22,160 --> 00:16:25,519
first on the same machine and had five

418
00:16:24,959 --> 00:16:29,119
days

419
00:16:25,519 --> 00:16:32,160
five days of interval in september 2017

420
00:16:29,120 --> 00:16:34,240
gazer which is another chola backdoor

421
00:16:32,160 --> 00:16:35,279
which was attributed several years ago

422
00:16:34,240 --> 00:16:37,120
to chola

423
00:16:35,279 --> 00:16:38,560
was dropped at the same location as

424
00:16:37,120 --> 00:16:42,880
scratch in c intel

425
00:16:38,560 --> 00:16:45,040
intel upd.exe secondly

426
00:16:42,880 --> 00:16:46,880
the dropper and loaders of crouch and

427
00:16:45,040 --> 00:16:49,759
geyser are very similar

428
00:16:46,880 --> 00:16:50,160
so pdb packs are very similar they both

429
00:16:49,759 --> 00:16:53,600
use

430
00:16:50,160 --> 00:16:57,360
a cap file and their loaders are using

431
00:16:53,600 --> 00:17:02,240
the same encryption key or a se4 key

432
00:16:57,360 --> 00:17:04,319
to load the final payload in memory

433
00:17:02,240 --> 00:17:05,520
it's also interesting to note that

434
00:17:04,319 --> 00:17:08,480
another group

435
00:17:05,520 --> 00:17:10,559
the dukes or apt-29 were also there and

436
00:17:08,480 --> 00:17:14,240
the malware components are linked to

437
00:17:10,559 --> 00:17:14,240
what we call operation ghost

438
00:17:15,359 --> 00:17:19,760
so crotch persists using dll jacking

439
00:17:17,760 --> 00:17:21,119
this is not something we see often with

440
00:17:19,760 --> 00:17:23,520
stroller

441
00:17:21,119 --> 00:17:24,559
so they are chrome firefox one drive and

442
00:17:23,520 --> 00:17:28,639
more recently

443
00:17:24,559 --> 00:17:30,480
an old outlook finder executable

444
00:17:28,640 --> 00:17:32,080
also there are several versions the last

445
00:17:30,480 --> 00:17:35,760
one the v4 having

446
00:17:32,080 --> 00:17:37,760
been released in july 2019

447
00:17:35,760 --> 00:17:41,600
and in that new versions for some reason

448
00:17:37,760 --> 00:17:41,600
they removed the backdoor function on it

449
00:17:43,600 --> 00:17:47,280
so this is a summary of crotch

450
00:17:45,120 --> 00:17:49,120
functionalities so first the backdoor

451
00:17:47,280 --> 00:17:52,320
part which is available from

452
00:17:49,120 --> 00:17:52,959
version one to three social operators

453
00:17:52,320 --> 00:17:56,000
they can

454
00:17:52,960 --> 00:17:59,120
upload comment to the dropbox accounts

455
00:17:56,000 --> 00:18:00,720
in the form of a fake zip archive so

456
00:17:59,120 --> 00:18:04,159
only the few first bytes

457
00:18:00,720 --> 00:18:04,799
are the zpeder but the remaining part of

458
00:18:04,160 --> 00:18:08,000
the file

459
00:18:04,799 --> 00:18:09,840
are custom formats of crutch

460
00:18:08,000 --> 00:18:11,840
so they will upload it to a dedicated

461
00:18:09,840 --> 00:18:14,959
robot second which is

462
00:18:11,840 --> 00:18:16,639
as the gmail accounts they are created

463
00:18:14,960 --> 00:18:19,360
under control of the attacker they are

464
00:18:16,640 --> 00:18:22,000
not compromised accounts

465
00:18:19,360 --> 00:18:23,039
so on this on the second we can see

466
00:18:22,000 --> 00:18:26,160
there are a lot of

467
00:18:23,039 --> 00:18:29,440
fake zip files with the very

468
00:18:26,160 --> 00:18:30,559
generic file names so the compromise

469
00:18:29,440 --> 00:18:34,400
meshing with scratch

470
00:18:30,559 --> 00:18:34,399
where you reach out to the dropbox

471
00:18:35,360 --> 00:18:41,120
storage and then download this

472
00:18:38,400 --> 00:18:43,840
fake zip decrypt them and execute the

473
00:18:41,120 --> 00:18:43,840
command

474
00:18:43,919 --> 00:18:48,400
so this is an example of a decrypted

475
00:18:46,780 --> 00:18:51,678
[Music]

476
00:18:48,400 --> 00:18:55,200
zip fake zip so the first bike is

477
00:18:51,679 --> 00:18:55,760
the common id in that case it's three it

478
00:18:55,200 --> 00:18:58,799
means

479
00:18:55,760 --> 00:19:01,919
drop the file on disk we now have

480
00:18:58,799 --> 00:19:02,879
the the path where the file will be

481
00:19:01,919 --> 00:19:05,200
written

482
00:19:02,880 --> 00:19:06,559
and we can see the content of the file

483
00:19:05,200 --> 00:19:09,200
in the beginning of the context

484
00:19:06,559 --> 00:19:09,600
uh the two first bytes are in z which

485
00:19:09,200 --> 00:19:13,520
means

486
00:19:09,600 --> 00:19:13,520
that it is a windows executable

487
00:19:13,919 --> 00:19:19,679
so now uh the documentary resting part

488
00:19:18,080 --> 00:19:21,918
which has

489
00:19:19,679 --> 00:19:22,960
in all versions of crotch including the

490
00:19:21,919 --> 00:19:25,200
last one

491
00:19:22,960 --> 00:19:26,000
so it monitors local drive but also

492
00:19:25,200 --> 00:19:29,039
every time

493
00:19:26,000 --> 00:19:31,679
a removable

494
00:19:29,039 --> 00:19:33,679
storage such as a usb key is plugging

495
00:19:31,679 --> 00:19:36,960
the computer

496
00:19:33,679 --> 00:19:40,400
so it choose a window application

497
00:19:36,960 --> 00:19:43,280
it's called eslp.exe on disk

498
00:19:40,400 --> 00:19:43,600
they will compress files that are newer

499
00:19:43,280 --> 00:19:46,720
than

500
00:19:43,600 --> 00:19:49,678
seven days from this usb key

501
00:19:46,720 --> 00:19:51,760
so for example pdf file doc file excel

502
00:19:49,679 --> 00:19:53,919
etc

503
00:19:51,760 --> 00:19:57,360
so once they have this archive they will

504
00:19:53,919 --> 00:20:00,720
upload it to dropbox

505
00:19:57,360 --> 00:20:03,280
in so in case of uh

506
00:20:00,720 --> 00:20:04,240
the crotch restaurant 4 it is directly

507
00:20:03,280 --> 00:20:07,280
uploaded

508
00:20:04,240 --> 00:20:10,480
on dropbox and in case of version 3

509
00:20:07,280 --> 00:20:12,480
it's first being put in a

510
00:20:10,480 --> 00:20:13,840
fake wire archive so there is a second

511
00:20:12,480 --> 00:20:16,000
layer of

512
00:20:13,840 --> 00:20:17,120
of encryption and this fake raw is very

513
00:20:16,000 --> 00:20:20,640
similar to

514
00:20:17,120 --> 00:20:23,918
the fake zip it used the official

515
00:20:20,640 --> 00:20:27,200
dropbox http api

516
00:20:23,919 --> 00:20:28,799
to upload the file there is a token to

517
00:20:27,200 --> 00:20:31,440
authenticate

518
00:20:28,799 --> 00:20:34,080
to dropbox and it's all coded in the

519
00:20:31,440 --> 00:20:36,480
malware samples

520
00:20:34,080 --> 00:20:37,199
then the actual operators can just

521
00:20:36,480 --> 00:20:41,679
download

522
00:20:37,200 --> 00:20:41,679
this this idea from from dropbox

523
00:20:43,039 --> 00:20:48,720
so we monitor

524
00:20:46,720 --> 00:20:50,159
we had access to some of the command

525
00:20:48,720 --> 00:20:52,240
executed by uh

526
00:20:50,159 --> 00:20:53,520
by crotch and we noticed that at some

527
00:20:52,240 --> 00:20:55,760
point they drop

528
00:20:53,520 --> 00:20:57,520
a recovery bad door we call service dns

529
00:20:55,760 --> 00:20:59,760
it's a simple bat script that persists

530
00:20:57,520 --> 00:21:03,039
using a windows sidebar gadget

531
00:20:59,760 --> 00:21:03,679
so this is the main code of this bat

532
00:21:03,039 --> 00:21:07,200
file

533
00:21:03,679 --> 00:21:07,679
you can see that it does a dns query of

534
00:21:07,200 --> 00:21:10,799
type

535
00:21:07,679 --> 00:21:13,840
hm4 to the cnc server dns query of type

536
00:21:10,799 --> 00:21:15,840
hm4 sold

537
00:21:13,840 --> 00:21:18,320
written address information about the

538
00:21:15,840 --> 00:21:19,760
server but in that case we try and it

539
00:21:18,320 --> 00:21:22,129
returns a url

540
00:21:19,760 --> 00:21:23,280
so that's kind of interesting

541
00:21:22,130 --> 00:21:25,600
[Music]

542
00:21:23,280 --> 00:21:26,399
we create this url and it returns a

543
00:21:25,600 --> 00:21:30,240
command

544
00:21:26,400 --> 00:21:33,120
so it means that the dns hm4 is

545
00:21:30,240 --> 00:21:35,840
the command control channel to to

546
00:21:33,120 --> 00:21:38,399
receive commands

547
00:21:35,840 --> 00:21:39,360
for this recovery backdoor and this is

548
00:21:38,400 --> 00:21:43,520
not a technique

549
00:21:39,360 --> 00:21:47,330
i saw before so it was it was new for me

550
00:21:43,520 --> 00:21:49,039
so finally some recommendation

551
00:21:47,330 --> 00:21:53,039
[Music]

552
00:21:49,039 --> 00:21:54,400
so use complex unique password and

553
00:21:53,039 --> 00:21:57,760
two-factor authentication

554
00:21:54,400 --> 00:22:00,240
it may assume that very simple but

555
00:21:57,760 --> 00:22:02,320
this is using stolen credentials in the

556
00:22:00,240 --> 00:22:04,480
main way chola used to uh

557
00:22:02,320 --> 00:22:05,439
move laterally on the network they also

558
00:22:04,480 --> 00:22:08,080
use a lot of

559
00:22:05,440 --> 00:22:09,039
powershell so whenever possible you

560
00:22:08,080 --> 00:22:12,480
limit or

561
00:22:09,039 --> 00:22:14,960
forbid partial execution and finally

562
00:22:12,480 --> 00:22:15,520
they have several tools such as rpc

563
00:22:14,960 --> 00:22:17,440
backdoor

564
00:22:15,520 --> 00:22:18,799
or hyperstack that is used with the

565
00:22:17,440 --> 00:22:21,280
carbon framework

566
00:22:18,799 --> 00:22:22,639
to manage matching the local network

567
00:22:21,280 --> 00:22:24,399
using pipes so

568
00:22:22,640 --> 00:22:26,000
if it's possible it's better to limit

569
00:22:24,400 --> 00:22:29,600
communication between the

570
00:22:26,000 --> 00:22:31,520
local machines then after compromise

571
00:22:29,600 --> 00:22:34,320
make sure to clean and reinstall all

572
00:22:31,520 --> 00:22:38,240
machines as i said at the beginning

573
00:22:34,320 --> 00:22:41,120
the the generally just keep a foothold

574
00:22:38,240 --> 00:22:42,240
on the compromise network and they won't

575
00:22:41,120 --> 00:22:44,639
need to

576
00:22:42,240 --> 00:22:46,720
to to use the exploit or anything to

577
00:22:44,640 --> 00:22:49,120
reinfect the network they just reconnect

578
00:22:46,720 --> 00:22:50,080
using credentials they've stolen before

579
00:22:49,120 --> 00:22:52,399
so change

580
00:22:50,080 --> 00:22:54,080
all the password review the list of

581
00:22:52,400 --> 00:22:54,880
accounts because they generally create

582
00:22:54,080 --> 00:22:58,000
new accounts

583
00:22:54,880 --> 00:23:01,360
that they can and they can then

584
00:22:58,000 --> 00:23:04,080
come back using for example ldp

585
00:23:01,360 --> 00:23:04,799
finally they are generally moved to the

586
00:23:04,080 --> 00:23:07,918
active

587
00:23:04,799 --> 00:23:09,918
directory server and also mail server so

588
00:23:07,919 --> 00:23:12,640
this is the first thing

589
00:23:09,919 --> 00:23:13,520
to clean because if you change all

590
00:23:12,640 --> 00:23:15,840
passwords but

591
00:23:13,520 --> 00:23:19,440
there are mimikats on your activity

592
00:23:15,840 --> 00:23:21,918
directory it's kind of useless

593
00:23:19,440 --> 00:23:24,080
so to conclude there are very few

594
00:23:21,919 --> 00:23:26,000
headlines about tula compromise but

595
00:23:24,080 --> 00:23:27,840
a lot of high profile organizations such

596
00:23:26,000 --> 00:23:30,240
as governments

597
00:23:27,840 --> 00:23:31,280
were are targeted or were compromised by

598
00:23:30,240 --> 00:23:34,480
this group

599
00:23:31,280 --> 00:23:35,200
also they tend to attack always the same

600
00:23:34,480 --> 00:23:37,039
targets

601
00:23:35,200 --> 00:23:39,840
and can stay in the same network for

602
00:23:37,039 --> 00:23:42,480
months or even years

603
00:23:39,840 --> 00:23:44,000
and basic arguing can complicate much of

604
00:23:42,480 --> 00:23:47,760
their operations

605
00:23:44,000 --> 00:23:50,799
and they will make more mistakes if

606
00:23:47,760 --> 00:23:51,679
it's harder for them thanks for your

607
00:23:50,799 --> 00:23:55,918
attentions

608
00:23:51,679 --> 00:23:55,919
feel free to ask questions

