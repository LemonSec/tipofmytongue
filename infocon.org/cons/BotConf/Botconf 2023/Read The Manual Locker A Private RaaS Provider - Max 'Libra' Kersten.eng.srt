1
00:00:01,140 --> 00:00:04,200
is the microphone good like this I have

2
00:00:04,200 --> 00:00:06,540
no audible feedback so should be good

3
00:00:06,540 --> 00:00:08,940
all right

4
00:00:08,940 --> 00:00:11,519
so welcome everybody uh today I'll be

5
00:00:11,519 --> 00:00:14,340
talking about the RTM Locker which is uh

6
00:00:14,340 --> 00:00:18,000
created by the RTM gang and as of this

7
00:00:18,000 --> 00:00:19,859
far I've only seen a few mentions on

8
00:00:19,859 --> 00:00:22,619
Twitter about the group itself and some

9
00:00:22,619 --> 00:00:24,720
of the stuff they've done last year

10
00:00:24,720 --> 00:00:27,060
there was a talk here at botcom as well

11
00:00:27,060 --> 00:00:28,680
about the same gang but not about their

12
00:00:28,680 --> 00:00:32,579
ransomware sample and in this case a

13
00:00:32,579 --> 00:00:34,980
source tipped me with a sample and that

14
00:00:34,980 --> 00:00:36,719
was fun to analyze contains some

15
00:00:36,719 --> 00:00:39,239
interesting parts and I'm here to share

16
00:00:39,239 --> 00:00:41,100
that with you

17
00:00:41,100 --> 00:00:44,460
so first of all a slight bit about me my

18
00:00:44,460 --> 00:00:46,140
name is Max Kirsten go by the nickname

19
00:00:46,140 --> 00:00:48,420
of Libra and I'm a Muller analyst and

20
00:00:48,420 --> 00:00:50,520
reverse engineer for trellix work in the

21
00:00:50,520 --> 00:00:53,100
advanced Research Center we publish

22
00:00:53,100 --> 00:00:55,320
reports such as this there will be a

23
00:00:55,320 --> 00:00:57,120
Blog on this on the corporate website as

24
00:00:57,120 --> 00:00:58,460
well somewhere

25
00:00:58,460 --> 00:01:02,760
either this week or early next week we

26
00:01:02,760 --> 00:01:04,760
also publish tools such as an automated

27
00:01:04,760 --> 00:01:07,200
unbeckerfer.net malware which is called

28
00:01:07,200 --> 00:01:09,600
dot damper and in my spare time I do

29
00:01:09,600 --> 00:01:11,280
write some blogs about the same topics

30
00:01:11,280 --> 00:01:13,640
as well

31
00:01:13,860 --> 00:01:16,799
so I want to give a shout out and thank

32
00:01:16,799 --> 00:01:19,799
you to the user not a bolt which is the

33
00:01:19,799 --> 00:01:22,140
same name as the Twitter handle if

34
00:01:22,140 --> 00:01:24,840
memory serves me well I'll be publish

35
00:01:24,840 --> 00:01:27,119
the slides later on as well so clickable

36
00:01:27,119 --> 00:01:29,460
links should be easy to find

37
00:01:29,460 --> 00:01:33,479
and in here the title says lifting rtm's

38
00:01:33,479 --> 00:01:35,340
Veil which is

39
00:01:35,340 --> 00:01:38,520
they're not too known and they strive

40
00:01:38,520 --> 00:01:40,740
not to be known which was part of the

41
00:01:40,740 --> 00:01:42,600
reason for me to submit it to a

42
00:01:42,600 --> 00:01:45,299
conference and let's see what happens if

43
00:01:45,299 --> 00:01:47,880
we do put them in the spotlight and make

44
00:01:47,880 --> 00:01:48,840
them known

45
00:01:48,840 --> 00:01:50,579
so they have a nice login page for the

46
00:01:50,579 --> 00:01:52,799
panel for affiliates with their username

47
00:01:52,799 --> 00:01:55,680
and password and a captcha so probably

48
00:01:55,680 --> 00:01:58,079
against brute forcing as normal people

49
00:01:58,079 --> 00:02:01,039
use this as well

50
00:02:01,079 --> 00:02:04,079
and once inside the panel I have to

51
00:02:04,079 --> 00:02:06,479
credit all screenshots are from the

52
00:02:06,479 --> 00:02:08,699
mentioned Source once you're in the

53
00:02:08,699 --> 00:02:11,160
panel you can add a victim so let's say

54
00:02:11,160 --> 00:02:13,260
you found a company and you intruded it

55
00:02:13,260 --> 00:02:15,959
you bought access or whatever malicious

56
00:02:15,959 --> 00:02:18,180
action you've done you can put in the

57
00:02:18,180 --> 00:02:20,280
name of the target you have the ID so

58
00:02:20,280 --> 00:02:22,260
you get per build that you generate on

59
00:02:22,260 --> 00:02:25,200
the panel you get an ID the revenue

60
00:02:25,200 --> 00:02:27,239
offset company contact data and the

61
00:02:27,239 --> 00:02:30,120
description but note that they don't

62
00:02:30,120 --> 00:02:32,760
publish their victims right so the whole

63
00:02:32,760 --> 00:02:34,500
goal they have is to stay out of the

64
00:02:34,500 --> 00:02:35,420
spotlight

65
00:02:35,420 --> 00:02:38,700
and therefore we can only guess as to

66
00:02:38,700 --> 00:02:40,340
what their use is for

67
00:02:40,340 --> 00:02:43,140
one assumption we have is that the

68
00:02:43,140 --> 00:02:45,180
operator is using this to check

69
00:02:45,180 --> 00:02:47,040
affiliates

70
00:02:47,040 --> 00:02:48,780
and checking the Affiliates is required

71
00:02:48,780 --> 00:02:50,459
if you have rules and there are rules

72
00:02:50,459 --> 00:02:51,959
for this group

73
00:02:51,959 --> 00:02:54,420
very strict ones actually so first off

74
00:02:54,420 --> 00:02:56,879
the text on the screenshot is slightly

75
00:02:56,879 --> 00:02:58,680
hard to read on the Beamer but the

76
00:02:58,680 --> 00:03:00,239
bullet points highlight the major parts

77
00:03:00,239 --> 00:03:03,360
no targets within the Cs region under

78
00:03:03,360 --> 00:03:05,640
any circumstance well this is not unique

79
00:03:05,640 --> 00:03:08,580
for malware but it might give us a clue

80
00:03:08,580 --> 00:03:11,819
as to potentially where the actors are

81
00:03:11,819 --> 00:03:14,760
located though it's not definitive proof

82
00:03:14,760 --> 00:03:17,040
now their goal is as I said before to

83
00:03:17,040 --> 00:03:18,900
stay out of the spotlight they want to

84
00:03:18,900 --> 00:03:21,420
avoid attacking companies that get you

85
00:03:21,420 --> 00:03:22,860
in the spotlight so they're not looking

86
00:03:22,860 --> 00:03:27,200
for your AAA brands or some government

87
00:03:27,200 --> 00:03:30,180
sections that they want to extort and

88
00:03:30,180 --> 00:03:33,480
leak data of in fact we have no evidence

89
00:03:33,480 --> 00:03:36,840
that they do double extortion so we only

90
00:03:36,840 --> 00:03:38,700
think that they do the ransomware and

91
00:03:38,700 --> 00:03:41,099
try to make money that way and as long

92
00:03:41,099 --> 00:03:42,720
as you stay out of the spotlight you

93
00:03:42,720 --> 00:03:44,760
don't get targeted by law enforcement

94
00:03:44,760 --> 00:03:47,459
and less likely to be targeted by

95
00:03:47,459 --> 00:03:50,940
researchers and therefore you can well

96
00:03:50,940 --> 00:03:54,060
casually make your criminal money and

97
00:03:54,060 --> 00:03:55,860
walk away with it

98
00:03:55,860 --> 00:03:58,379
now they do also adhere to some more

99
00:03:58,379 --> 00:03:59,580
rules they don't want to attack

100
00:03:59,580 --> 00:04:03,000
hospitals but there's some doubt in that

101
00:04:03,000 --> 00:04:04,920
as well as to hitting hospitals

102
00:04:04,920 --> 00:04:07,920
generally causes you to hit the news and

103
00:04:07,920 --> 00:04:09,720
they don't want to hit the news so the

104
00:04:09,720 --> 00:04:11,580
question is is this purely because of

105
00:04:11,580 --> 00:04:14,640
delaying low strategy or is this because

106
00:04:14,640 --> 00:04:16,560
of the fact that they are morally

107
00:04:16,560 --> 00:04:20,040
against targeting hospitals or both we

108
00:04:20,040 --> 00:04:21,000
don't know

109
00:04:21,000 --> 00:04:23,940
and Affiliates need to be active as well

110
00:04:23,940 --> 00:04:26,840
inactivity will result in a ban so

111
00:04:26,840 --> 00:04:30,720
researchers trying to enter in here will

112
00:04:30,720 --> 00:04:32,699
need to somehow remain active if they

113
00:04:32,699 --> 00:04:35,940
want to be in the panel or just assume

114
00:04:35,940 --> 00:04:40,040
that one-time access is sufficient

115
00:04:40,199 --> 00:04:42,979
now moving on to the technical analysis

116
00:04:42,979 --> 00:04:46,560
I've made a nice flowchart my graphical

117
00:04:46,560 --> 00:04:48,120
skills are

118
00:04:48,120 --> 00:04:51,240
luckily at least readable unlike my

119
00:04:51,240 --> 00:04:53,580
handwriting but the first goal here is

120
00:04:53,580 --> 00:04:55,500
to elevate privilege

121
00:04:55,500 --> 00:04:58,259
and then it will initialize the debug

122
00:04:58,259 --> 00:05:00,120
console which is optionally could be

123
00:05:00,120 --> 00:05:02,580
turned off could be turned on and it

124
00:05:02,580 --> 00:05:04,199
will shut down selected processes and

125
00:05:04,199 --> 00:05:06,660
services it will empty the recycle bin

126
00:05:06,660 --> 00:05:09,720
delete Shadow copies and so forth now

127
00:05:09,720 --> 00:05:12,600
this is a brief look ahead as to what

128
00:05:12,600 --> 00:05:14,040
the next part of the presentation will

129
00:05:14,040 --> 00:05:14,880
like

130
00:05:14,880 --> 00:05:17,280
so the privilege escalation is nothing

131
00:05:17,280 --> 00:05:19,680
too fancy it's not as if they're looking

132
00:05:19,680 --> 00:05:21,960
for a CV or exploiting and vulnerability

133
00:05:21,960 --> 00:05:24,300
what they're simply doing is constantly

134
00:05:24,300 --> 00:05:27,419
nagging the user with the UAC dialogue

135
00:05:27,419 --> 00:05:31,380
simply running the same process again as

136
00:05:31,380 --> 00:05:34,039
admin so they'll continue to do that

137
00:05:34,039 --> 00:05:37,320
until you press continue

138
00:05:37,320 --> 00:05:39,900
cases where let's say you're in a

139
00:05:39,900 --> 00:05:41,340
corporate environment and you're not

140
00:05:41,340 --> 00:05:42,660
able to run something with

141
00:05:42,660 --> 00:05:44,940
administrative privileges assuming the

142
00:05:44,940 --> 00:05:46,800
corporate environment is set up like

143
00:05:46,800 --> 00:05:49,560
that that will actually mean

144
00:05:49,560 --> 00:05:52,680
that the mower hasn't it hasn't taken

145
00:05:52,680 --> 00:05:55,380
this into account it just tries it again

146
00:05:55,380 --> 00:05:57,360
and again and again so if you press

147
00:05:57,360 --> 00:05:59,460
cancel the next pop-up will come and

148
00:05:59,460 --> 00:06:02,239
again and again

149
00:06:02,759 --> 00:06:04,860
once it has the administrative

150
00:06:04,860 --> 00:06:06,479
privileges which is a must for the

151
00:06:06,479 --> 00:06:10,259
malware which allows us to assume that

152
00:06:10,259 --> 00:06:12,120
the operators will take control of the

153
00:06:12,120 --> 00:06:14,759
systems prior to running it meaning that

154
00:06:14,759 --> 00:06:16,620
they're not sending this out in a Spam

155
00:06:16,620 --> 00:06:19,259
campaign in a massive wave which would

156
00:06:19,259 --> 00:06:21,360
also tie in with their modus operandi of

157
00:06:21,360 --> 00:06:23,699
laying low don't get in the spotlight if

158
00:06:23,699 --> 00:06:25,639
you only use this

159
00:06:25,639 --> 00:06:27,720
ransomware once you're already in a

160
00:06:27,720 --> 00:06:29,699
system chances of the ransomware getting

161
00:06:29,699 --> 00:06:32,340
detected is much lower obviously now the

162
00:06:32,340 --> 00:06:34,380
debug console is probably to help them

163
00:06:34,380 --> 00:06:37,800
and if you pass the dash debug flag then

164
00:06:37,800 --> 00:06:39,479
you get a nice message during the

165
00:06:39,479 --> 00:06:42,240
runtime as to what it does and what help

166
00:06:42,240 --> 00:06:45,120
there is as you'll notice in the jedra

167
00:06:45,120 --> 00:06:45,850
screenshots

168
00:06:45,850 --> 00:06:46,979
[Music]

169
00:06:46,979 --> 00:06:49,440
there's no obfuscation in this binary

170
00:06:49,440 --> 00:06:52,199
other than some decompiled code which

171
00:06:52,199 --> 00:06:53,639
doesn't necessarily look exactly like

172
00:06:53,639 --> 00:06:56,520
source code but that's about it

173
00:06:56,520 --> 00:06:57,960
and then we move over to the

174
00:06:57,960 --> 00:07:01,440
environmental awareness so it was a nice

175
00:07:01,440 --> 00:07:03,180
play on words

176
00:07:03,180 --> 00:07:05,220
wait iterates overall running processes

177
00:07:05,220 --> 00:07:07,800
and then it has a list internally of

178
00:07:07,800 --> 00:07:12,539
processes that it deems to not run as in

179
00:07:12,539 --> 00:07:13,919
it will actually terminate those

180
00:07:13,919 --> 00:07:16,860
processes once encountered

181
00:07:16,860 --> 00:07:18,319
now

182
00:07:18,319 --> 00:07:21,120
this is pretty common as well but their

183
00:07:21,120 --> 00:07:24,360
list is relatively extensive for some of

184
00:07:24,360 --> 00:07:27,960
the malware and most of the files are or

185
00:07:27,960 --> 00:07:30,539
processes are simply terminated because

186
00:07:30,539 --> 00:07:34,080
of the fact that they want to make more

187
00:07:34,080 --> 00:07:36,660
impact on the victimized system if Excel

188
00:07:36,660 --> 00:07:39,840
or Windward or any of these processes is

189
00:07:39,840 --> 00:07:41,759
open that means that any of your

190
00:07:41,759 --> 00:07:43,919
documents that you have open is in use

191
00:07:43,919 --> 00:07:46,620
if you close the processes documents are

192
00:07:46,620 --> 00:07:48,599
not in use and can be overwritten during

193
00:07:48,599 --> 00:07:51,960
the encryption phase so maximizing

194
00:07:51,960 --> 00:07:55,159
damage in this case

195
00:07:55,560 --> 00:07:57,479
not only do they do this for the

196
00:07:57,479 --> 00:07:59,699
processes they only do this they also do

197
00:07:59,699 --> 00:08:03,060
this for the services and iterate over a

198
00:08:03,060 --> 00:08:06,000
specific list and

199
00:08:06,000 --> 00:08:07,319
this is actually one of the things we'll

200
00:08:07,319 --> 00:08:09,240
see more often in the code they iterate

201
00:08:09,240 --> 00:08:12,000
over it backwards so for those with Keen

202
00:08:12,000 --> 00:08:15,780
eyes in the while loop on top it will

203
00:08:15,780 --> 00:08:18,300
say plus minus one which is G Drive

204
00:08:18,300 --> 00:08:19,919
kindly telling us that this is a

205
00:08:19,919 --> 00:08:22,800
negative value rather than the weird

206
00:08:22,800 --> 00:08:25,500
notation and it will simply stop all the

207
00:08:25,500 --> 00:08:28,379
selected Services now the same can be

208
00:08:28,379 --> 00:08:31,259
said here you can see SQL for example

209
00:08:31,259 --> 00:08:34,200
which will probably stop your SQL

210
00:08:34,200 --> 00:08:37,020
related service and thereby free up the

211
00:08:37,020 --> 00:08:39,719
database maximizing impact but in this

212
00:08:39,719 --> 00:08:41,279
case you also have more way we can see

213
00:08:41,279 --> 00:08:45,480
sofos which is a AV company

214
00:08:45,480 --> 00:08:47,940
whose service is to be terminated so

215
00:08:47,940 --> 00:08:49,920
apparently they had either trouble with

216
00:08:49,920 --> 00:08:54,979
sofas or just uh personal feelings

217
00:08:56,339 --> 00:08:58,200
next they will take out the trash for

218
00:08:58,200 --> 00:09:01,320
you a very kindly empty empties the

219
00:09:01,320 --> 00:09:04,380
recycle bin and it does days without a

220
00:09:04,380 --> 00:09:08,100
confirmation or progress UI nor a sound

221
00:09:08,100 --> 00:09:10,560
which you can kindly specify in the win

222
00:09:10,560 --> 00:09:14,399
API so without notice your recycle bin

223
00:09:14,399 --> 00:09:18,600
will be empty this is not so much as a

224
00:09:18,600 --> 00:09:21,540
Ransom case it will just delete your

225
00:09:21,540 --> 00:09:23,580
files and then it will remove all your

226
00:09:23,580 --> 00:09:26,399
Shadow copies to avoid the restoration

227
00:09:26,399 --> 00:09:28,740
of those Shadow copies in case of an

228
00:09:28,740 --> 00:09:30,660
infection

229
00:09:30,660 --> 00:09:31,860
then

230
00:09:31,860 --> 00:09:35,339
they have some more Curious Parts till

231
00:09:35,339 --> 00:09:38,240
iterate overall drives that are attached

232
00:09:38,240 --> 00:09:41,880
and they do that in a QWERTY order

233
00:09:41,880 --> 00:09:43,620
so if you go over your keyboard and you

234
00:09:43,620 --> 00:09:45,300
use a normal query you go from left to

235
00:09:45,300 --> 00:09:47,940
right from top to bottom to or iterate

236
00:09:47,940 --> 00:09:50,760
over everything and they'll save each

237
00:09:50,760 --> 00:09:54,420
unused Drive letter for later use

238
00:09:54,420 --> 00:09:55,920
um because what they're going to do next

239
00:09:55,920 --> 00:09:58,740
is they're going to mount all volumes so

240
00:09:58,740 --> 00:10:01,980
usually you have your C drive on Windows

241
00:10:01,980 --> 00:10:03,899
where you have your operating system Etc

242
00:10:03,899 --> 00:10:06,120
maybe you have a D drive maybe you have

243
00:10:06,120 --> 00:10:07,380
some network drives if you're in a

244
00:10:07,380 --> 00:10:09,360
corporate environment but in here

245
00:10:09,360 --> 00:10:12,060
anything that is not not mounted will be

246
00:10:12,060 --> 00:10:15,300
mounted and each Mount will get a nice

247
00:10:15,300 --> 00:10:18,000
drive ladder which you do with the ones

248
00:10:18,000 --> 00:10:21,680
that aren't used yet

249
00:10:21,899 --> 00:10:26,700
as such it will try to harvest potential

250
00:10:26,700 --> 00:10:28,740
areas as to what can be encrypted

251
00:10:28,740 --> 00:10:32,519
furthermore and then encrypt this but do

252
00:10:32,519 --> 00:10:35,399
know that in here the iteration is

253
00:10:35,399 --> 00:10:38,700
backwards again so your first drive

254
00:10:38,700 --> 00:10:43,080
letter will be speaking here the M if

255
00:10:43,080 --> 00:10:45,660
not already taken so on my VM that was

256
00:10:45,660 --> 00:10:49,459
the drive M that is created

257
00:10:50,100 --> 00:10:54,060
they also kindly help you handle remote

258
00:10:54,060 --> 00:10:56,220
drives so not the ones physically

259
00:10:56,220 --> 00:10:57,899
attached to your machine but remote ones

260
00:10:57,899 --> 00:11:00,660
and they make sure that this is handled

261
00:11:00,660 --> 00:11:02,940
correctly so that their encryption

262
00:11:02,940 --> 00:11:06,420
services are smoothly provided without

263
00:11:06,420 --> 00:11:09,360
errors and it will then parse your

264
00:11:09,360 --> 00:11:11,579
folders and encrypt your files

265
00:11:11,579 --> 00:11:13,860
now during the file traversal there are

266
00:11:13,860 --> 00:11:15,420
some checks as well so more sanity

267
00:11:15,420 --> 00:11:16,920
checks

268
00:11:16,920 --> 00:11:19,920
um excluded folders and file names are

269
00:11:19,920 --> 00:11:22,940
included in the binary to avoid

270
00:11:22,940 --> 00:11:25,440
crippling the machine so they make sure

271
00:11:25,440 --> 00:11:27,000
the machine still works so for example

272
00:11:27,000 --> 00:11:29,760
the windows folder is excluded from

273
00:11:29,760 --> 00:11:32,700
targeting and any subfolder therein

274
00:11:32,700 --> 00:11:35,640
and the file extension itself is

275
00:11:35,640 --> 00:11:37,980
including adult 65 characters which is

276
00:11:37,980 --> 00:11:39,420
one of the checks you can see in the

277
00:11:39,420 --> 00:11:43,079
code at the length at the bottom

278
00:11:43,079 --> 00:11:45,600
it's pretty unique to have such a long

279
00:11:45,600 --> 00:11:47,519
file extension and since it's random

280
00:11:47,519 --> 00:11:49,620
data your files will have random

281
00:11:49,620 --> 00:11:52,200
extensions meaning that for each run but

282
00:11:52,200 --> 00:11:54,899
also for each file you have a lot of

283
00:11:54,899 --> 00:11:56,940
different characters unlike some of the

284
00:11:56,940 --> 00:11:58,860
other ransomware such as the Royal

285
00:11:58,860 --> 00:12:01,140
ransomware which uses the aptly named

286
00:12:01,140 --> 00:12:05,040
dot Royal has a extension in here they

287
00:12:05,040 --> 00:12:07,920
don't really focus on that which could

288
00:12:07,920 --> 00:12:09,660
be part of their technique to also say

289
00:12:09,660 --> 00:12:11,279
we want to stay out of the spotlight we

290
00:12:11,279 --> 00:12:14,240
want to lay low

291
00:12:14,399 --> 00:12:18,540
now the excluded folder names are shown

292
00:12:18,540 --> 00:12:21,060
here they'll make sure that some tools

293
00:12:21,060 --> 00:12:22,920
are still working and that you can

294
00:12:22,920 --> 00:12:24,959
access your system to pay their Ransom

295
00:12:24,959 --> 00:12:27,779
to them later on

296
00:12:27,779 --> 00:12:30,720
but obviously they want to uh not make

297
00:12:30,720 --> 00:12:32,820
it too easy for you now as I said before

298
00:12:32,820 --> 00:12:35,399
the random data that is generated for

299
00:12:35,399 --> 00:12:39,300
the extension is 64 characters 65

300
00:12:39,300 --> 00:12:42,060
including the dot but they do this by

301
00:12:42,060 --> 00:12:45,260
generating a random buffer of 32 bytes

302
00:12:45,260 --> 00:12:49,220
using the unofficial system function

303
00:12:49,220 --> 00:12:54,420
36 which is also known as RTL gen random

304
00:12:54,420 --> 00:12:56,760
this function is there just for you to

305
00:12:56,760 --> 00:12:59,700
Generate random data and each byte is

306
00:12:59,700 --> 00:13:01,980
two characters in size so you have zero

307
00:13:01,980 --> 00:13:04,980
one for example as one byte but these

308
00:13:04,980 --> 00:13:06,779
become two characters in The Conversion

309
00:13:06,779 --> 00:13:08,940
process later on when they convert the

310
00:13:08,940 --> 00:13:12,839
bytes into characters so 32 bytes become

311
00:13:12,839 --> 00:13:15,680
64 characters

312
00:13:16,200 --> 00:13:17,579
now

313
00:13:17,579 --> 00:13:20,399
they were in a they are in a hurry to

314
00:13:20,399 --> 00:13:22,079
encrypt your machine because

315
00:13:22,079 --> 00:13:24,959
the sooner it's done the sooner their

316
00:13:24,959 --> 00:13:27,779
goal is accomplished and in here they

317
00:13:27,779 --> 00:13:30,180
use multi-traded encryption but they

318
00:13:30,180 --> 00:13:31,639
also use

319
00:13:31,639 --> 00:13:35,220
ioctl completion ports and they connect

320
00:13:35,220 --> 00:13:38,579
these two where the I see a few people

321
00:13:38,579 --> 00:13:41,399
in the audience looking very confused as

322
00:13:41,399 --> 00:13:42,839
was I when I was doing this because

323
00:13:42,839 --> 00:13:45,240
there's no need for this whole extra

324
00:13:45,240 --> 00:13:49,740
layer of fakeness so they create some

325
00:13:49,740 --> 00:13:52,079
threads they map them to the ports and

326
00:13:52,079 --> 00:13:54,779
then for each file they then

327
00:13:54,779 --> 00:13:57,779
discover that qualifies according to all

328
00:13:57,779 --> 00:13:59,100
of the checks that they've done before

329
00:13:59,100 --> 00:14:01,920
the file names the folder names you name

330
00:14:01,920 --> 00:14:02,940
it

331
00:14:02,940 --> 00:14:04,560
they'll make sure that it's mapped and

332
00:14:04,560 --> 00:14:07,079
then the i o completion Port has a

333
00:14:07,079 --> 00:14:09,180
function which actually handles your

334
00:14:09,180 --> 00:14:11,399
file but even that is split up in

335
00:14:11,399 --> 00:14:13,500
several parts so you need to open the

336
00:14:13,500 --> 00:14:15,959
file with the overlapped flag in order

337
00:14:15,959 --> 00:14:18,060
to make this work and they're only

338
00:14:18,060 --> 00:14:21,540
targeting files larger than 512 bytes in

339
00:14:21,540 --> 00:14:23,779
size

340
00:14:24,120 --> 00:14:27,120
now you have custom structure that

341
00:14:27,120 --> 00:14:28,800
they're using internally with what I

342
00:14:28,800 --> 00:14:31,320
call an action key and this action key

343
00:14:31,320 --> 00:14:33,959
is either of three values is hexadecimal

344
00:14:33,959 --> 00:14:38,579
A1 A2 or A3 and based on this action key

345
00:14:38,579 --> 00:14:41,940
a specific action is performed

346
00:14:41,940 --> 00:14:46,199
now first you handle the file meaning

347
00:14:46,199 --> 00:14:48,959
you read it then you write your

348
00:14:48,959 --> 00:14:52,079
encrypted data to that file which is

349
00:14:52,079 --> 00:14:54,779
step two and then step three is you

350
00:14:54,779 --> 00:14:57,480
rename the file and by renaming it you

351
00:14:57,480 --> 00:14:59,820
make sure that you put the new extension

352
00:14:59,820 --> 00:15:01,920
in which is part of the rename and each

353
00:15:01,920 --> 00:15:03,899
of the action keys will the first two

354
00:15:03,899 --> 00:15:06,360
they actually set the next action key so

355
00:15:06,360 --> 00:15:08,579
they have a loop where they first start

356
00:15:08,579 --> 00:15:12,779
with well if it's always A1

357
00:15:12,779 --> 00:15:15,720
I'm gonna do this and then they sent the

358
00:15:15,720 --> 00:15:18,240
next action key as you can see in the

359
00:15:18,240 --> 00:15:20,480
second line in the screenshot

360
00:15:20,480 --> 00:15:23,820
then the Ender Loop they repeat it again

361
00:15:23,820 --> 00:15:26,040
and they check again oh now my key is A2

362
00:15:26,040 --> 00:15:29,339
I'm gonna move over and do step two and

363
00:15:29,339 --> 00:15:30,600
then they're gonna do step three and

364
00:15:30,600 --> 00:15:32,220
since step three is the last one there

365
00:15:32,220 --> 00:15:34,440
is no step four there's no need to

366
00:15:34,440 --> 00:15:37,139
up the number again they just complete

367
00:15:37,139 --> 00:15:40,260
it and move on to the next file

368
00:15:40,260 --> 00:15:41,880
now

369
00:15:41,880 --> 00:15:44,040
in case you had a wallpaper that you had

370
00:15:44,040 --> 00:15:46,980
no backup of and you lost the file don't

371
00:15:46,980 --> 00:15:48,000
run this

372
00:15:48,000 --> 00:15:49,620
also don't run it for other reasons

373
00:15:49,620 --> 00:15:52,440
obviously but what it will do is it will

374
00:15:52,440 --> 00:15:54,480
change the wallpaper once it's done with

375
00:15:54,480 --> 00:15:56,279
the encryption so once everything is

376
00:15:56,279 --> 00:16:01,440
handled and everything is is ready to uh

377
00:16:01,440 --> 00:16:03,839
wait essentially before you pay the

378
00:16:03,839 --> 00:16:06,000
ransom or restore your backups

379
00:16:06,000 --> 00:16:07,800
and what it will do is we'll change the

380
00:16:07,800 --> 00:16:09,180
wallpaper

381
00:16:09,180 --> 00:16:10,980
and

382
00:16:10,980 --> 00:16:14,040
that looks like this with a nice

383
00:16:14,040 --> 00:16:16,920
mask next to it warning with a lot of

384
00:16:16,920 --> 00:16:20,519
exclamation marks and you have 48 hours

385
00:16:20,519 --> 00:16:22,920
to contact them they do drop some Ransom

386
00:16:22,920 --> 00:16:24,779
nodes in folders so you should have a

387
00:16:24,779 --> 00:16:28,199
way to communicate with them and they

388
00:16:28,199 --> 00:16:30,480
only want to make this known to you

389
00:16:30,480 --> 00:16:32,459
other than your very slow machine during

390
00:16:32,459 --> 00:16:34,980
the encryption once they're done because

391
00:16:34,980 --> 00:16:36,779
otherwise you might pull the plug and

392
00:16:36,779 --> 00:16:39,000
save half your files so the encryption

393
00:16:39,000 --> 00:16:41,579
is first finished then they change the

394
00:16:41,579 --> 00:16:44,699
wallpaper to maximize their impact again

395
00:16:44,699 --> 00:16:48,959
now the encryption threads are based on

396
00:16:48,959 --> 00:16:52,560
the number of logical cores based on the

397
00:16:52,560 --> 00:16:55,019
system info that it obtained earlier and

398
00:16:55,019 --> 00:16:56,100
for each

399
00:16:56,100 --> 00:16:59,220
tread that finishes it's deducted by one

400
00:16:59,220 --> 00:17:00,740
so

401
00:17:00,740 --> 00:17:05,220
this check is simply to await while the

402
00:17:05,220 --> 00:17:07,740
encryption goes on and if your number of

403
00:17:07,740 --> 00:17:09,540
processes is not zero it's going to

404
00:17:09,540 --> 00:17:13,500
sleep and if it is zero that means that

405
00:17:13,500 --> 00:17:15,119
all of the encryption threads have

406
00:17:15,119 --> 00:17:18,839
finished and therefore it's time to move

407
00:17:18,839 --> 00:17:21,959
on so once this function returns

408
00:17:21,959 --> 00:17:25,579
we were going to clear the event logs

409
00:17:25,579 --> 00:17:27,660
because we don't want to leave any

410
00:17:27,660 --> 00:17:30,120
traces in this case

411
00:17:30,120 --> 00:17:32,640
and we can see the log names that they

412
00:17:32,640 --> 00:17:35,400
clear they open them clear them and very

413
00:17:35,400 --> 00:17:37,200
straightforward just straight up delete

414
00:17:37,200 --> 00:17:40,740
them and there's not too uh too much to

415
00:17:40,740 --> 00:17:43,380
be added here

416
00:17:43,380 --> 00:17:46,020
as a last part and this again is in line

417
00:17:46,020 --> 00:17:47,760
with the modus operandi that they have

418
00:17:47,760 --> 00:17:49,200
they want to lay low they don't want

419
00:17:49,200 --> 00:17:52,020
their samples to be found their name is

420
00:17:52,020 --> 00:17:55,799
in the ransom note so it could leak or

421
00:17:55,799 --> 00:17:58,679
spread if you will like that but they'll

422
00:17:58,679 --> 00:18:01,679
try and remove the sample to ransomware

423
00:18:01,679 --> 00:18:03,600
sample from the disk and the way that

424
00:18:03,600 --> 00:18:05,280
they do this is by creating a race

425
00:18:05,280 --> 00:18:07,620
condition so they're starting a command

426
00:18:07,620 --> 00:18:11,400
prompt where they first issue five pings

427
00:18:11,400 --> 00:18:12,900
to the Local Host

428
00:18:12,900 --> 00:18:15,419
and afterward they pipe that actually

429
00:18:15,419 --> 00:18:19,260
into nothing so there's no output and

430
00:18:19,260 --> 00:18:21,660
what you also see is that if this

431
00:18:21,660 --> 00:18:24,600
completes which it will because logos is

432
00:18:24,600 --> 00:18:27,480
always reachable they'll delete their

433
00:18:27,480 --> 00:18:31,080
own file from disk and directly after

434
00:18:31,080 --> 00:18:33,840
this the mower rules shut down so the

435
00:18:33,840 --> 00:18:36,000
time it takes for those five pings is

436
00:18:36,000 --> 00:18:38,039
longer than it takes the malware to shut

437
00:18:38,039 --> 00:18:40,500
down meaning that the command prompt is

438
00:18:40,500 --> 00:18:41,880
still running in the background with the

439
00:18:41,880 --> 00:18:44,820
pings the malware is not on anymore by

440
00:18:44,820 --> 00:18:47,100
the time the pings finish

441
00:18:47,100 --> 00:18:48,900
you can simply delete the file because

442
00:18:48,900 --> 00:18:51,000
it's not in use anymore because if you

443
00:18:51,000 --> 00:18:52,980
just try to delete your own process you

444
00:18:52,980 --> 00:18:55,980
are doing that to yourself thereby still

445
00:18:55,980 --> 00:18:57,780
running and since your process is still

446
00:18:57,780 --> 00:18:59,039
running it cannot be deleted because

447
00:18:59,039 --> 00:19:01,620
it's currently running it gives you a

448
00:19:01,620 --> 00:19:02,820
nice

449
00:19:02,820 --> 00:19:04,020
Circle

450
00:19:04,020 --> 00:19:06,059
So to avoid that Circle and break it

451
00:19:06,059 --> 00:19:08,000
they

452
00:19:08,000 --> 00:19:11,520
use this race condition that they induce

453
00:19:11,520 --> 00:19:12,480
here

454
00:19:12,480 --> 00:19:14,640
remove the sample your files are now

455
00:19:14,640 --> 00:19:17,340
encrypted and you should restore a

456
00:19:17,340 --> 00:19:20,520
backup and or contact incident response

457
00:19:20,520 --> 00:19:23,160
people in that case hopefully that

458
00:19:23,160 --> 00:19:27,240
doesn't happen and the sample itself was

459
00:19:27,240 --> 00:19:30,299
and is not public if I find some time

460
00:19:30,299 --> 00:19:32,039
tonight I'll do that otherwise I'll do

461
00:19:32,039 --> 00:19:33,600
that tomorrow morning I'll upload it to

462
00:19:33,600 --> 00:19:35,179
various sharing size

463
00:19:35,179 --> 00:19:37,740
including non-premium ones so that

464
00:19:37,740 --> 00:19:39,840
everybody has access to the sample

465
00:19:39,840 --> 00:19:41,240
itself

466
00:19:41,240 --> 00:19:43,860
as I said there will also be a Blog

467
00:19:43,860 --> 00:19:45,559
going live with detailed information

468
00:19:45,559 --> 00:19:48,539
that is also in this talk for

469
00:19:48,539 --> 00:19:52,740
later reading if you so desire

470
00:19:52,740 --> 00:19:55,860
then that leaves time for Q a if you

471
00:19:55,860 --> 00:19:57,960
have any questions then now is the time

472
00:19:57,960 --> 00:20:00,120
to ask if something pops in your mind

473
00:20:00,120 --> 00:20:02,220
which usually is the case for me you

474
00:20:02,220 --> 00:20:04,260
wake up tomorrow morning and you're like

475
00:20:04,260 --> 00:20:06,539
this is what I wanted to ask feel free

476
00:20:06,539 --> 00:20:10,020
to reach out on any of these or if you

477
00:20:10,020 --> 00:20:13,080
see me at the conference just say hi

478
00:20:13,080 --> 00:20:16,280
here so

479
00:20:18,850 --> 00:20:26,990
[Applause]

480
00:20:27,500 --> 00:20:32,360
okay the first question

481
00:20:34,559 --> 00:20:37,620
thank you for the tool great analysis I

482
00:20:37,620 --> 00:20:39,419
like the beautifying of the code indeed

483
00:20:39,419 --> 00:20:42,660
runs on uh what about anti-debugging

484
00:20:42,660 --> 00:20:44,700
techniques or did you find something

485
00:20:44,700 --> 00:20:46,620
special because you covered the aspect

486
00:20:46,620 --> 00:20:48,600
of the ransomware in itself but about

487
00:20:48,600 --> 00:20:51,059
the protection against what you did on

488
00:20:51,059 --> 00:20:53,400
these bugging technique what was it was

489
00:20:53,400 --> 00:20:55,860
it packed or no nothing nothing so this

490
00:20:55,860 --> 00:20:59,100
is uh this is the sample there's nothing

491
00:20:59,100 --> 00:21:00,720
else in it

492
00:21:00,720 --> 00:21:03,419
I and this is just an assumption right I

493
00:21:03,419 --> 00:21:06,900
don't have facts on this if you already

494
00:21:06,900 --> 00:21:09,299
own the complete infrastructure and

495
00:21:09,299 --> 00:21:11,400
you've become domain admin and you can

496
00:21:11,400 --> 00:21:12,539
just do what you want on the system

497
00:21:12,539 --> 00:21:14,160
let's say you turned off the AV as well

498
00:21:14,160 --> 00:21:16,200
you can just push this via Group Policy

499
00:21:16,200 --> 00:21:19,440
run it on all machines

500
00:21:19,440 --> 00:21:21,600
that's it really afterwards the file is

501
00:21:21,600 --> 00:21:23,400
deleted so

502
00:21:23,400 --> 00:21:27,000
they could add it but I think based on

503
00:21:27,000 --> 00:21:28,919
the way I assume they operate there's no

504
00:21:28,919 --> 00:21:31,520
need for this

505
00:21:32,159 --> 00:21:34,320
hi nice presentation I've got a couple

506
00:21:34,320 --> 00:21:36,960
of questions so let's see how we will

507
00:21:36,960 --> 00:21:39,059
get uh what's the prevalence of this

508
00:21:39,059 --> 00:21:41,580
sample based on your Telemetry and is it

509
00:21:41,580 --> 00:21:43,799
mostly targeting consumer segment

510
00:21:43,799 --> 00:21:45,980
Enterprise

511
00:21:45,980 --> 00:21:48,900
they have been successful in laying low

512
00:21:48,900 --> 00:21:52,620
we have no information

513
00:21:52,620 --> 00:21:56,100
okay next one about the encryption

514
00:21:56,100 --> 00:21:58,919
schema do you see any glitches in it any

515
00:21:58,919 --> 00:22:01,460
chances for decryption for free

516
00:22:01,460 --> 00:22:05,760
so I think decryption is often only

517
00:22:05,760 --> 00:22:09,240
shared in back channels if possible but

518
00:22:09,240 --> 00:22:12,840
having said that I am not great in

519
00:22:12,840 --> 00:22:15,960
encryption in general so I left it as

520
00:22:15,960 --> 00:22:18,360
encrypted in my analysis also in the

521
00:22:18,360 --> 00:22:20,940
blog I tried it in my local machine the

522
00:22:20,940 --> 00:22:22,860
files do get encrypted if it's

523
00:22:22,860 --> 00:22:24,720
recoverable and what kind of specific

524
00:22:24,720 --> 00:22:26,820
scheme is used

525
00:22:26,820 --> 00:22:29,220
how do I put this best it's left as an

526
00:22:29,220 --> 00:22:32,039
exercise for the reader I don't know if

527
00:22:32,039 --> 00:22:33,120
somebody here is really into

528
00:22:33,120 --> 00:22:34,799
cryptography the file will be available

529
00:22:34,799 --> 00:22:36,200
soon so

530
00:22:36,200 --> 00:22:40,580
yeah go for it okay thank you

531
00:22:44,400 --> 00:22:48,080
last question over there okay

532
00:22:55,740 --> 00:22:59,580
thank you do you know on average what

533
00:22:59,580 --> 00:23:01,980
they charge as far as ransoms go and do

534
00:23:01,980 --> 00:23:04,919
you know where they recruit affiliates

535
00:23:04,919 --> 00:23:07,320
uh with regards to the underground

536
00:23:07,320 --> 00:23:10,799
information as to how they recruit uh I

537
00:23:10,799 --> 00:23:13,260
have no information I was approached by

538
00:23:13,260 --> 00:23:15,960
the Twitter user that I linked who

539
00:23:15,960 --> 00:23:17,580
shared some screenshots with me in the

540
00:23:17,580 --> 00:23:20,580
samples along with some let's say

541
00:23:20,580 --> 00:23:22,260
additional information so that I know

542
00:23:22,260 --> 00:23:25,020
it's not made up or some

543
00:23:25,020 --> 00:23:27,299
fairy tale story that somebody produced

544
00:23:27,299 --> 00:23:30,000
so I'm confident of the of the data but

545
00:23:30,000 --> 00:23:31,380
I I don't know how they do the

546
00:23:31,380 --> 00:23:33,539
recruitment there is a recruitment post

547
00:23:33,539 --> 00:23:36,120
that was shared but I'm not sure on

548
00:23:36,120 --> 00:23:39,900
which Forum that was but I think there

549
00:23:39,900 --> 00:23:42,000
are a lot of people here who are

550
00:23:42,000 --> 00:23:45,539
following those forums so I think if you

551
00:23:45,539 --> 00:23:47,760
ask around a bit then people will know

552
00:23:47,760 --> 00:23:51,360
and I think if you search for RTM or RTM

553
00:23:51,360 --> 00:23:53,100
Locker on Twitter you'll find the

554
00:23:53,100 --> 00:23:55,740
advertisement post

555
00:23:55,740 --> 00:23:57,900
so that should probably give you enough

556
00:23:57,900 --> 00:24:00,179
information to uh to take it from there

557
00:24:00,179 --> 00:24:04,280
and your first question was

558
00:24:04,919 --> 00:24:07,980
how much do they charge for ransoms

559
00:24:07,980 --> 00:24:10,020
um don't know on top of my head if

560
00:24:10,020 --> 00:24:12,179
that's in the note

561
00:24:12,179 --> 00:24:14,159
and if it's not on a note then I don't

562
00:24:14,159 --> 00:24:15,539
know then it's probably up to the

563
00:24:15,539 --> 00:24:17,700
negotiations or I don't know the weather

564
00:24:17,700 --> 00:24:19,200
outside the temperature and some other

565
00:24:19,200 --> 00:24:20,880
random variables what they base it on

566
00:24:20,880 --> 00:24:23,720
but

567
00:24:24,320 --> 00:24:27,850
okay thank you thank you

568
00:24:27,850 --> 00:24:32,320
[Applause]

