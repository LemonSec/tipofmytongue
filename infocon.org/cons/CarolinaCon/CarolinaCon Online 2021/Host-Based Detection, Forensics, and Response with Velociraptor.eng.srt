1
00:00:11,120 --> 00:00:12,639
all right

2
00:00:12,639 --> 00:00:14,920
welcome everyone and thank you for

3
00:00:14,920 --> 00:00:16,480
attending host

4
00:00:16,480 --> 00:00:18,480
based detection forensics in response

5
00:00:18,480 --> 00:00:19,920
with velociraptor

6
00:00:19,920 --> 00:00:22,400
my name is wes lambert and i am the

7
00:00:22,400 --> 00:00:23,439
director

8
00:00:23,439 --> 00:00:25,680
of support and professional services at

9
00:00:25,680 --> 00:00:27,840
security and in solutions

10
00:00:27,840 --> 00:00:29,199
i don't necessarily work with

11
00:00:29,199 --> 00:00:30,960
velociraptor every day but whenever i

12
00:00:30,960 --> 00:00:32,640
get the chance i like to

13
00:00:32,640 --> 00:00:35,440
dabble in a good bit and i love to play

14
00:00:35,440 --> 00:00:36,160
around with it

15
00:00:36,160 --> 00:00:39,280
and think it's a really amazing tool

16
00:00:39,280 --> 00:00:41,280
so just wanted to share that with you

17
00:00:41,280 --> 00:00:42,399
today

18
00:00:42,399 --> 00:00:43,440
you know just share all of its

19
00:00:43,440 --> 00:00:45,440
capabilities go over

20
00:00:45,440 --> 00:00:47,280
uh kind of an introduction to its

21
00:00:47,280 --> 00:00:48,960
features and how you can leverage it

22
00:00:48,960 --> 00:00:50,719
from a deeper perspective

23
00:00:50,719 --> 00:00:53,520
uh you know from a detection perspective

24
00:00:53,520 --> 00:00:54,640
and monitoring

25
00:00:54,640 --> 00:00:56,480
uh for monitoring hosts in your

26
00:00:56,480 --> 00:00:58,800
environment and your enterprise

27
00:00:58,800 --> 00:01:01,280
and then also just kind of understanding

28
00:01:01,280 --> 00:01:02,320
how you can use it

29
00:01:02,320 --> 00:01:04,879
to perform you know other types of

30
00:01:04,879 --> 00:01:06,960
response actions and automate actions

31
00:01:06,960 --> 00:01:08,880
maybe via the api

32
00:01:08,880 --> 00:01:11,119
and things like that so without further

33
00:01:11,119 --> 00:01:14,320
ado we'll go ahead and get into it

34
00:01:14,320 --> 00:01:17,200
again about a velociraptor it is an open

35
00:01:17,200 --> 00:01:17,680
source

36
00:01:17,680 --> 00:01:19,360
endpoint monitoring and response

37
00:01:19,360 --> 00:01:20,960
platform so it's

38
00:01:20,960 --> 00:01:23,520
very awesome uh to be able to use

39
00:01:23,520 --> 00:01:24,960
something that's that's free

40
00:01:24,960 --> 00:01:28,159
and available uh to do all this work and

41
00:01:28,159 --> 00:01:28,560
it's

42
00:01:28,560 --> 00:01:31,360
and mike cohen the the primary developer

43
00:01:31,360 --> 00:01:32,079
for the project

44
00:01:32,079 --> 00:01:35,680
has really done an amazing job at making

45
00:01:35,680 --> 00:01:37,119
all of these great features available

46
00:01:37,119 --> 00:01:37,600
for

47
00:01:37,600 --> 00:01:39,520
velociraptor i'll talk about here in

48
00:01:39,520 --> 00:01:40,799
just a minute

49
00:01:40,799 --> 00:01:43,840
now velociraptor is built on v cool

50
00:01:43,840 --> 00:01:45,360
and you might have heard of sql you

51
00:01:45,360 --> 00:01:46,799
might have heard kql you know all these

52
00:01:46,799 --> 00:01:47,680
query languages

53
00:01:47,680 --> 00:01:50,159
um there's certainly a lot out there but

54
00:01:50,159 --> 00:01:51,040
vehicle is great

55
00:01:51,040 --> 00:01:53,119
in that it's this very flexible language

56
00:01:53,119 --> 00:01:54,720
that has a

57
00:01:54,720 --> 00:01:58,240
fairly similar familiar syntax

58
00:01:58,240 --> 00:01:59,680
and this is really what drives

59
00:01:59,680 --> 00:02:01,840
velociraptor and makes it

60
00:02:01,840 --> 00:02:03,759
so flexible and so powerful and we'll

61
00:02:03,759 --> 00:02:06,000
talk about that here in just a minute

62
00:02:06,000 --> 00:02:08,800
it's written in go uh it's supported on

63
00:02:08,800 --> 00:02:10,560
linux mac os and windows so

64
00:02:10,560 --> 00:02:12,720
it's it's really easy to get going on

65
00:02:12,720 --> 00:02:14,000
you know if you have folks that are

66
00:02:14,000 --> 00:02:15,920
running any of those types of systems

67
00:02:15,920 --> 00:02:17,280
uh it's great to be able to get that

68
00:02:17,280 --> 00:02:19,440
going quickly and easily and it is very

69
00:02:19,440 --> 00:02:21,840
lightweight and very uh you know

70
00:02:21,840 --> 00:02:22,800
scalable and

71
00:02:22,800 --> 00:02:24,640
easy to use and and i think you know

72
00:02:24,640 --> 00:02:26,080
with a single server

73
00:02:26,080 --> 00:02:28,000
if i remember correctly it can be around

74
00:02:28,000 --> 00:02:30,480
10 to 15 000 endpoints so

75
00:02:30,480 --> 00:02:33,280
um it's very very cool to be able to

76
00:02:33,280 --> 00:02:34,959
have that level of scale and

77
00:02:34,959 --> 00:02:37,280
have that to be easily deployed in that

78
00:02:37,280 --> 00:02:39,440
manner

79
00:02:39,440 --> 00:02:41,680
now mike cohen also worked at google

80
00:02:41,680 --> 00:02:43,040
where he worked on

81
00:02:43,040 --> 00:02:45,120
google gur some of you might be familiar

82
00:02:45,120 --> 00:02:47,599
with ger google rapid response

83
00:02:47,599 --> 00:02:50,720
now velociraptor is similar to gur in

84
00:02:50,720 --> 00:02:51,760
the sense of

85
00:02:51,760 --> 00:02:54,080
the host-based detection and forensics

86
00:02:54,080 --> 00:02:55,519
perspective

87
00:02:55,519 --> 00:02:58,000
however you know one of the key things i

88
00:02:58,000 --> 00:03:00,080
think that sets velociraptor apart and

89
00:03:00,080 --> 00:03:01,440
mike has spoken to

90
00:03:01,440 --> 00:03:03,519
is really that flexibility that makes it

91
00:03:03,519 --> 00:03:04,800
so powerful

92
00:03:04,800 --> 00:03:06,879
um you know in the past at least ger has

93
00:03:06,879 --> 00:03:07,920
been kind of

94
00:03:07,920 --> 00:03:10,239
um you know tied to to the way that

95
00:03:10,239 --> 00:03:11,680
maybe google is

96
00:03:11,680 --> 00:03:13,519
as uh you know wanted to drive the

97
00:03:13,519 --> 00:03:14,879
project um

98
00:03:14,879 --> 00:03:16,640
and you know some things are kind of

99
00:03:16,640 --> 00:03:19,200
locked down and maybe not as flexible as

100
00:03:19,200 --> 00:03:20,239
we would like them to

101
00:03:20,239 --> 00:03:23,280
uh just in some regards but velociraptor

102
00:03:23,280 --> 00:03:24,400
just completely

103
00:03:24,400 --> 00:03:26,720
decouples that and makes it a lot easier

104
00:03:26,720 --> 00:03:28,000
to extend

105
00:03:28,000 --> 00:03:29,920
and make the the platform itself more

106
00:03:29,920 --> 00:03:31,680
powerful so we'll talk about that here

107
00:03:31,680 --> 00:03:34,319
in just a moment

108
00:03:35,760 --> 00:03:38,319
so i spoke about vehicle velociraptor

109
00:03:38,319 --> 00:03:40,000
query language which is what

110
00:03:40,000 --> 00:03:44,080
really drives velociraptor right so

111
00:03:44,080 --> 00:03:47,120
what vehicle allows us to do is

112
00:03:47,120 --> 00:03:49,120
pretty much anything uh because it's so

113
00:03:49,120 --> 00:03:50,720
flexible we use

114
00:03:50,720 --> 00:03:53,120
vehicle to collect data from endpoints

115
00:03:53,120 --> 00:03:54,959
uh we can use it to

116
00:03:54,959 --> 00:03:57,040
perform uh you know collect artifacts

117
00:03:57,040 --> 00:03:58,959
and and perform that monitoring and

118
00:03:58,959 --> 00:04:00,799
those response actions and just manage

119
00:04:00,799 --> 00:04:02,959
the velociraptor server in general

120
00:04:02,959 --> 00:04:04,959
right we can use velocira i'm sorry

121
00:04:04,959 --> 00:04:06,000
vehicle

122
00:04:06,000 --> 00:04:09,040
to to manage the the data on the server

123
00:04:09,040 --> 00:04:09,439
we can

124
00:04:09,439 --> 00:04:10,959
use it to manage the clients we use it

125
00:04:10,959 --> 00:04:13,439
to upgrade clients right to delete them

126
00:04:13,439 --> 00:04:15,439
it's very flexible again and i keep

127
00:04:15,439 --> 00:04:17,759
saying flexible but it is

128
00:04:17,759 --> 00:04:19,519
in the way that you can use that for so

129
00:04:19,519 --> 00:04:21,680
many things and extend velociraptor in

130
00:04:21,680 --> 00:04:23,919
so many ways

131
00:04:23,919 --> 00:04:25,600
so we have right here just a basic

132
00:04:25,600 --> 00:04:28,240
example of the syntax here where

133
00:04:28,240 --> 00:04:29,440
i mean really we're just grabbing the

134
00:04:29,440 --> 00:04:31,040
time right here right so we're just

135
00:04:31,040 --> 00:04:33,120
selecting utc time stamp from clock and

136
00:04:33,120 --> 00:04:34,800
that's what we see right here

137
00:04:34,800 --> 00:04:37,840
again a very simple example here but uh

138
00:04:37,840 --> 00:04:39,360
hopefully it'll help to kind of

139
00:04:39,360 --> 00:04:43,680
introduce you to the concept there

140
00:04:43,680 --> 00:04:46,720
now vql most of what drives what what

141
00:04:46,720 --> 00:04:48,000
you do with the vehicle

142
00:04:48,000 --> 00:04:50,160
and inside of velociraptor is really

143
00:04:50,160 --> 00:04:51,680
going to be that concept of

144
00:04:51,680 --> 00:04:54,240
functions and plug-ins with those

145
00:04:54,240 --> 00:04:56,000
functions being things like select

146
00:04:56,000 --> 00:04:58,880
or or i'm sorry following select aware

147
00:04:58,880 --> 00:05:01,680
keywords and we're acting on

148
00:05:01,680 --> 00:05:04,320
the data right that that we're trying to

149
00:05:04,320 --> 00:05:06,240
get from the data source which in this

150
00:05:06,240 --> 00:05:08,080
case is going to be info the plugin

151
00:05:08,080 --> 00:05:09,520
and that plug-in is going to generate

152
00:05:09,520 --> 00:05:11,680
rows so bits of data right

153
00:05:11,680 --> 00:05:14,560
so so different pieces of data um which

154
00:05:14,560 --> 00:05:16,320
we'll go through in just a minute

155
00:05:16,320 --> 00:05:17,919
uh and then we're acting on that data

156
00:05:17,919 --> 00:05:19,360
with those functions so you can kind of

157
00:05:19,360 --> 00:05:20,800
see the difference there and we'll see

158
00:05:20,800 --> 00:05:25,280
that more in just a bit

159
00:05:25,280 --> 00:05:28,479
now the architecture velociraptor um

160
00:05:28,479 --> 00:05:30,240
you have the gui which is where the

161
00:05:30,240 --> 00:05:32,080
analyst will interact

162
00:05:32,080 --> 00:05:33,919
you have the front end and that's where

163
00:05:33,919 --> 00:05:35,600
the clients are are going to check in

164
00:05:35,600 --> 00:05:37,039
and perform their

165
00:05:37,039 --> 00:05:38,720
kind of command to control uh

166
00:05:38,720 --> 00:05:40,080
communication right

167
00:05:40,080 --> 00:05:42,960
that's where they're going to be issued

168
00:05:42,960 --> 00:05:43,759
tasks

169
00:05:43,759 --> 00:05:44,560
that's where they're going to

170
00:05:44,560 --> 00:05:47,280
communicate with the velociraptor server

171
00:05:47,280 --> 00:05:49,360
so we don't necessarily as analysts or

172
00:05:49,360 --> 00:05:50,960
as deferred practitioners

173
00:05:50,960 --> 00:05:52,960
we don't communicate with that front end

174
00:05:52,960 --> 00:05:55,680
directly but

175
00:05:55,680 --> 00:05:57,440
but that's that's kind of you know a

176
00:05:57,440 --> 00:05:58,880
sense of the architecture there

177
00:05:58,880 --> 00:06:00,160
and then of course you have the file

178
00:06:00,160 --> 00:06:01,919
store and the data store where

179
00:06:01,919 --> 00:06:03,600
we're going to store information about

180
00:06:03,600 --> 00:06:04,960
the different artifacts that we're

181
00:06:04,960 --> 00:06:06,000
looking for and then

182
00:06:06,000 --> 00:06:08,479
other files or artifacts that we've

183
00:06:08,479 --> 00:06:09,360
collected

184
00:06:09,360 --> 00:06:15,199
right pieces of data or or those files

185
00:06:17,199 --> 00:06:19,039
now as far as deployment modes

186
00:06:19,039 --> 00:06:20,560
velociraptor has

187
00:06:20,560 --> 00:06:23,120
a few different deployment modes and

188
00:06:23,120 --> 00:06:24,000
it's really

189
00:06:24,000 --> 00:06:26,080
easy to get started by deploying

190
00:06:26,080 --> 00:06:28,240
velociraptor if you want to evaluate it

191
00:06:28,240 --> 00:06:30,240
by just running the velociraptor gui

192
00:06:30,240 --> 00:06:32,000
command and you'll see that right here

193
00:06:32,000 --> 00:06:34,000
in the slide

194
00:06:34,000 --> 00:06:37,039
let me go back sorry about that and you

195
00:06:37,039 --> 00:06:38,800
can grab the latest binary here

196
00:06:38,800 --> 00:06:41,759
from velociraptor releases and you can

197
00:06:41,759 --> 00:06:43,039
see that there

198
00:06:43,039 --> 00:06:45,759
and so from there you just grab that

199
00:06:45,759 --> 00:06:48,080
binary and make sure it's executable and

200
00:06:48,080 --> 00:06:50,240
then run that velociraptor do a command

201
00:06:50,240 --> 00:06:51,199
right there

202
00:06:51,199 --> 00:06:53,680
and you can get started there just just

203
00:06:53,680 --> 00:06:54,479
going through

204
00:06:54,479 --> 00:06:56,720
and experimenting and trying out

205
00:06:56,720 --> 00:06:58,319
different artifacts and

206
00:06:58,319 --> 00:06:59,840
creating queries and seeing what

207
00:06:59,840 --> 00:07:03,360
velociraptor has to offer there

208
00:07:03,360 --> 00:07:08,000
check something real quick about that

209
00:07:08,720 --> 00:07:11,840
okay let me let me check this slide

210
00:07:11,840 --> 00:07:13,919
window real quick

211
00:07:13,919 --> 00:07:15,759
i'm just going to take the webcam off

212
00:07:15,759 --> 00:07:17,520
here should make things a little bit

213
00:07:17,520 --> 00:07:19,840
better

214
00:07:19,919 --> 00:07:21,759
sorry about that thanks for the heads up

215
00:07:21,759 --> 00:07:22,960
on that

216
00:07:22,960 --> 00:07:25,120
so again it makes it very easy to run

217
00:07:25,120 --> 00:07:26,880
velociraptor right

218
00:07:26,880 --> 00:07:28,960
um so we can run velociraptor otherwise

219
00:07:28,960 --> 00:07:30,720
in a standalone mode

220
00:07:30,720 --> 00:07:32,639
well like this with the velociraptor gui

221
00:07:32,639 --> 00:07:34,880
command we can run it in the cloud we

222
00:07:34,880 --> 00:07:35,680
can

223
00:07:35,680 --> 00:07:39,520
scale it across multiple front ends now

224
00:07:39,520 --> 00:07:42,000
we can upload files to the cloud right

225
00:07:42,000 --> 00:07:43,680
if we want to collect those locally and

226
00:07:43,680 --> 00:07:44,960
send those up

227
00:07:44,960 --> 00:07:47,199
from a local collector instance so we

228
00:07:47,199 --> 00:07:49,599
have this triage and offline collector

229
00:07:49,599 --> 00:07:52,479
and with that we can build a custom

230
00:07:52,479 --> 00:07:53,440
collector as well

231
00:07:53,440 --> 00:07:55,280
and we can package in different binaries

232
00:07:55,280 --> 00:07:57,520
and tools and other things

233
00:07:57,520 --> 00:07:59,199
different default artifacts that we want

234
00:07:59,199 --> 00:08:00,960
to collect and we'll get into artifacts

235
00:08:00,960 --> 00:08:02,960
in just a minute here

236
00:08:02,960 --> 00:08:04,720
but we can have all that pre-packaged

237
00:08:04,720 --> 00:08:06,800
into that compiled binary

238
00:08:06,800 --> 00:08:08,960
packed into the velociraptor binary and

239
00:08:08,960 --> 00:08:10,560
then go off and hand that to somebody

240
00:08:10,560 --> 00:08:12,240
else and they can go off and

241
00:08:12,240 --> 00:08:13,680
and run that and collect the data and

242
00:08:13,680 --> 00:08:15,360
bring it back or if we're

243
00:08:15,360 --> 00:08:17,039
working a case we can go take that

244
00:08:17,039 --> 00:08:19,280
binary and we can run that get the data

245
00:08:19,280 --> 00:08:20,800
and send it up to the cloud if we want

246
00:08:20,800 --> 00:08:21,440
to right

247
00:08:21,440 --> 00:08:24,319
import it to the server so it's it's

248
00:08:24,319 --> 00:08:26,560
really again flexible in that manner

249
00:08:26,560 --> 00:08:29,039
that it allows you to do these things

250
00:08:29,039 --> 00:08:30,879
and then again uh if we're developing

251
00:08:30,879 --> 00:08:32,799
artifacts if we're testing certain

252
00:08:32,799 --> 00:08:34,399
things certain queries

253
00:08:34,399 --> 00:08:36,399
uh we can spend this up say with

254
00:08:36,399 --> 00:08:38,640
velociraptor gui and then go through and

255
00:08:38,640 --> 00:08:39,599
maybe

256
00:08:39,599 --> 00:08:42,240
start with a notebook or start with

257
00:08:42,240 --> 00:08:45,760
developing those artifacts in that way

258
00:08:48,640 --> 00:08:51,760
now artifacts are really going to be a

259
00:08:51,760 --> 00:08:54,160
a compilation of queries it may be one

260
00:08:54,160 --> 00:08:54,880
query

261
00:08:54,880 --> 00:08:57,200
right if it's just uh it may be a very

262
00:08:57,200 --> 00:08:58,880
simple artifact

263
00:08:58,880 --> 00:09:00,320
where you're returning a query maybe

264
00:09:00,320 --> 00:09:02,560
you're looking up the process listing

265
00:09:02,560 --> 00:09:05,839
for uh for a box maybe you're looking

266
00:09:05,839 --> 00:09:06,320
for the

267
00:09:06,320 --> 00:09:08,640
you know the mft or whatnot it may

268
00:09:08,640 --> 00:09:09,519
consist of one

269
00:09:09,519 --> 00:09:12,800
or multiple queries and so we we see

270
00:09:12,800 --> 00:09:15,279
here uh this particular artifact right

271
00:09:15,279 --> 00:09:16,640
here at the bottom where

272
00:09:16,640 --> 00:09:18,480
at line 16 we'll see that select all

273
00:09:18,480 --> 00:09:20,240
from info limit 10.

274
00:09:20,240 --> 00:09:22,399
um it's really just a very basic uh

275
00:09:22,399 --> 00:09:24,560
selecting from the server info

276
00:09:24,560 --> 00:09:28,000
um plug-in there so that's a very

277
00:09:28,000 --> 00:09:29,760
very basic artifact right and that's

278
00:09:29,760 --> 00:09:31,120
that's just how you get started doing

279
00:09:31,120 --> 00:09:32,080
that

280
00:09:32,080 --> 00:09:34,000
and what these artifacts are intended to

281
00:09:34,000 --> 00:09:36,080
do is really encapsulate

282
00:09:36,080 --> 00:09:38,480
that expert knowledge that uh you know

283
00:09:38,480 --> 00:09:40,399
deeper practitioners and infrastruct

284
00:09:40,399 --> 00:09:41,760
practitioners have

285
00:09:41,760 --> 00:09:45,120
um have gathered right so um

286
00:09:45,120 --> 00:09:46,880
these guys can share these artifacts

287
00:09:46,880 --> 00:09:48,560
with us these ways that they've

288
00:09:48,560 --> 00:09:50,240
determined they can find these artifacts

289
00:09:50,240 --> 00:09:51,920
on the host file system

290
00:09:51,920 --> 00:09:53,279
so they've written these queries and

291
00:09:53,279 --> 00:09:55,200
they put them into these artifacts and

292
00:09:55,200 --> 00:09:57,360
velociraptor and we can take those

293
00:09:57,360 --> 00:09:59,120
and we can just go run that artifact

294
00:09:59,120 --> 00:10:00,880
right we don't need to learn

295
00:10:00,880 --> 00:10:03,200
a whole bunch about the mft we don't

296
00:10:03,200 --> 00:10:05,680
need to learn a whole bunch about i30

297
00:10:05,680 --> 00:10:07,279
we don't need to learn about usn

298
00:10:07,279 --> 00:10:08,800
although it's useful to have that

299
00:10:08,800 --> 00:10:09,680
knowledge

300
00:10:09,680 --> 00:10:12,079
it's very useful also to be able to run

301
00:10:12,079 --> 00:10:13,440
and get the data you need

302
00:10:13,440 --> 00:10:14,959
without having to do a bunch of

303
00:10:14,959 --> 00:10:17,760
background research

304
00:10:17,760 --> 00:10:20,000
and these artifacts they run kind of in

305
00:10:20,000 --> 00:10:21,440
different modes or or

306
00:10:21,440 --> 00:10:23,279
they're different types and you have

307
00:10:23,279 --> 00:10:24,959
this client artifact here

308
00:10:24,959 --> 00:10:26,640
and the client artifact is is kind of

309
00:10:26,640 --> 00:10:28,480
like a one-shot artifact you might run

310
00:10:28,480 --> 00:10:30,000
whenever you're collecting data from a

311
00:10:30,000 --> 00:10:30,880
client

312
00:10:30,880 --> 00:10:32,800
client event artifact might be whenever

313
00:10:32,800 --> 00:10:34,240
you're trying to watch for certain

314
00:10:34,240 --> 00:10:34,720
events

315
00:10:34,720 --> 00:10:36,880
and so this is running at an interval

316
00:10:36,880 --> 00:10:39,200
right it's pulling continuously

317
00:10:39,200 --> 00:10:41,920
and and you know maybe producing rows

318
00:10:41,920 --> 00:10:45,040
whenever it hits those

319
00:10:45,040 --> 00:10:47,120
it says conditions where it gets results

320
00:10:47,120 --> 00:10:48,480
from the artifacts

321
00:10:48,480 --> 00:10:49,680
and the same thing with the server

322
00:10:49,680 --> 00:10:52,240
artifact assert our server artifact

323
00:10:52,240 --> 00:10:54,480
might be to manage the server

324
00:10:54,480 --> 00:10:57,600
a server artifact might be to

325
00:10:57,600 --> 00:11:00,320
look across completed flows right

326
00:11:00,320 --> 00:11:01,920
artifact flows so if we run a bunch of

327
00:11:01,920 --> 00:11:03,360
artifacts on clients

328
00:11:03,360 --> 00:11:05,040
and we're looking for certain results or

329
00:11:05,040 --> 00:11:06,560
look and see if there was a successful

330
00:11:06,560 --> 00:11:07,360
result

331
00:11:07,360 --> 00:11:09,440
from the server perspective we can also

332
00:11:09,440 --> 00:11:11,680
run

333
00:11:11,760 --> 00:11:13,600
run that ad hoc or through a server

334
00:11:13,600 --> 00:11:16,720
event artifact to notify us of that

335
00:11:16,720 --> 00:11:18,480
so again very useful to be able to have

336
00:11:18,480 --> 00:11:22,160
that capability with these artifacts

337
00:11:22,880 --> 00:11:25,839
now we talked about artifacts and and

338
00:11:25,839 --> 00:11:26,640
kind of

339
00:11:26,640 --> 00:11:29,440
in a basic fashion what they are now you

340
00:11:29,440 --> 00:11:31,040
can hunt for artifacts right that's the

341
00:11:31,040 --> 00:11:31,920
whole point

342
00:11:31,920 --> 00:11:34,079
of really uh you know having these

343
00:11:34,079 --> 00:11:35,200
admins queries

344
00:11:35,200 --> 00:11:37,839
of these contained queries is to be able

345
00:11:37,839 --> 00:11:39,519
to hunt across host

346
00:11:39,519 --> 00:11:41,279
right so we can schedule a hunt in

347
00:11:41,279 --> 00:11:42,560
velociraptor

348
00:11:42,560 --> 00:11:43,680
and we'll go through this in just a

349
00:11:43,680 --> 00:11:45,920
little bit uh we can schedule a hunt

350
00:11:45,920 --> 00:11:47,600
across all of our clients

351
00:11:47,600 --> 00:11:49,360
maybe we have a subset of clients maybe

352
00:11:49,360 --> 00:11:51,200
they you know they have a specific label

353
00:11:51,200 --> 00:11:52,079
like they're

354
00:11:52,079 --> 00:11:54,320
um you know they're a certain group of

355
00:11:54,320 --> 00:11:56,240
servers maybe

356
00:11:56,240 --> 00:11:57,600
they're all windows hosts maybe they're

357
00:11:57,600 --> 00:11:59,279
all mac os host

358
00:11:59,279 --> 00:12:00,959
and then clients will enroll in the hunt

359
00:12:00,959 --> 00:12:03,120
as they come online you might have folks

360
00:12:03,120 --> 00:12:03,519
that are

361
00:12:03,519 --> 00:12:04,880
in remote offices right they're not

362
00:12:04,880 --> 00:12:07,040
connected or something

363
00:12:07,040 --> 00:12:09,600
whenever those clients come online

364
00:12:09,600 --> 00:12:11,680
they'll enroll in that hunt and then

365
00:12:11,680 --> 00:12:13,519
you know you may get results as they

366
00:12:13,519 --> 00:12:16,240
start start rolling in

367
00:12:16,240 --> 00:12:19,120
so that in general the hunt concept is

368
00:12:19,120 --> 00:12:21,760
going to be when you're hunting across

369
00:12:21,760 --> 00:12:24,880
you know various hosts or

370
00:12:24,880 --> 00:12:26,000
you know all of the hosts in your

371
00:12:26,000 --> 00:12:28,000
enterprise for maybe a specific file

372
00:12:28,000 --> 00:12:29,920
hash maybe a specific executable and

373
00:12:29,920 --> 00:12:30,560
maybe you're

374
00:12:30,560 --> 00:12:33,440
doing a differential query lots of

375
00:12:33,440 --> 00:12:36,639
different things there that you can do

376
00:12:37,360 --> 00:12:39,120
and then you also have the targeted

377
00:12:39,120 --> 00:12:40,959
collection for example

378
00:12:40,959 --> 00:12:43,120
maybe there's an incident or there's an

379
00:12:43,120 --> 00:12:44,880
alert that comes from your ids

380
00:12:44,880 --> 00:12:46,480
or something else and you want to look

381
00:12:46,480 --> 00:12:48,399
at a specific host you want to look at a

382
00:12:48,399 --> 00:12:50,000
specific client

383
00:12:50,000 --> 00:12:52,160
and these artifacts you can target these

384
00:12:52,160 --> 00:12:53,760
clients and you know

385
00:12:53,760 --> 00:12:55,839
select which artifacts you want to run

386
00:12:55,839 --> 00:12:58,160
here for example the ps list

387
00:12:58,160 --> 00:12:59,680
we can select those artifacts and then

388
00:12:59,680 --> 00:13:02,240
run those on an ad-hoc basis

389
00:13:02,240 --> 00:13:03,600
for that client and then get those

390
00:13:03,600 --> 00:13:05,440
results back we can then go look at

391
00:13:05,440 --> 00:13:06,240
those results

392
00:13:06,240 --> 00:13:07,839
maybe there's some files uploaded with

393
00:13:07,839 --> 00:13:11,440
that that we want to go triage further

394
00:13:11,440 --> 00:13:14,639
you know lots of stuff we can do there

395
00:13:14,639 --> 00:13:16,399
again that's going to be for that

396
00:13:16,399 --> 00:13:21,120
targeted single host collection

397
00:13:21,120 --> 00:13:23,120
and then once we've run these hunts once

398
00:13:23,120 --> 00:13:24,320
we've run the

399
00:13:24,320 --> 00:13:26,720
targeted collections maybe we want to

400
00:13:26,720 --> 00:13:29,200
filter the data down a little more

401
00:13:29,200 --> 00:13:32,000
so velociraptor has this great concept

402
00:13:32,000 --> 00:13:32,320
of

403
00:13:32,320 --> 00:13:34,240
notebooks which are similar to jupiter

404
00:13:34,240 --> 00:13:36,399
notebooks you might be familiar with

405
00:13:36,399 --> 00:13:38,800
and it allows you to you know test your

406
00:13:38,800 --> 00:13:40,399
queries whatever you're trying to look

407
00:13:40,399 --> 00:13:41,360
for

408
00:13:41,360 --> 00:13:42,959
you can test those before you implement

409
00:13:42,959 --> 00:13:45,519
those in an artifact that you use later

410
00:13:45,519 --> 00:13:49,279
you can also post process results for um

411
00:13:49,279 --> 00:13:51,440
for your hunts or for your collections

412
00:13:51,440 --> 00:13:53,360
right so whenever you get something back

413
00:13:53,360 --> 00:13:55,040
that result set maybe you want to filter

414
00:13:55,040 --> 00:13:55,440
it down

415
00:13:55,440 --> 00:13:57,360
maybe you want to look for a certain

416
00:13:57,360 --> 00:13:59,920
file name maybe you want to look for

417
00:13:59,920 --> 00:14:02,160
a certain executable right certain

418
00:14:02,160 --> 00:14:03,920
things like that you can post process

419
00:14:03,920 --> 00:14:04,800
that

420
00:14:04,800 --> 00:14:07,040
and it's very useful whenever you're

421
00:14:07,040 --> 00:14:10,560
trying to sift through that data quickly

422
00:14:12,480 --> 00:14:14,720
now from the detection perspective

423
00:14:14,720 --> 00:14:16,160
there's client event artifacts that i

424
00:14:16,160 --> 00:14:16,639
mentioned

425
00:14:16,639 --> 00:14:18,720
is where you'll you know a lot of times

426
00:14:18,720 --> 00:14:20,320
if you're setting up detection from the

427
00:14:20,320 --> 00:14:21,120
perspective

428
00:14:21,120 --> 00:14:24,399
of enterprise monitoring and

429
00:14:24,399 --> 00:14:26,000
and things like that if you think about

430
00:14:26,000 --> 00:14:28,320
maybe you know things like monitoring

431
00:14:28,320 --> 00:14:29,680
windows event logs

432
00:14:29,680 --> 00:14:32,639
things like monitoring um you know

433
00:14:32,639 --> 00:14:34,160
certain process creations like things

434
00:14:34,160 --> 00:14:35,519
like sysmon and where you might be

435
00:14:35,519 --> 00:14:37,040
sending logs back or data

436
00:14:37,040 --> 00:14:38,240
that you want to alert on in a

437
00:14:38,240 --> 00:14:40,160
consistent manner and you can set up

438
00:14:40,160 --> 00:14:41,519
those client event artifacts and those

439
00:14:41,519 --> 00:14:43,120
server event artifacts

440
00:14:43,120 --> 00:14:44,800
and they'll notify you similar to that

441
00:14:44,800 --> 00:14:46,880
of an ids alert or something else

442
00:14:46,880 --> 00:14:48,560
right you can set up an alert for right

443
00:14:48,560 --> 00:14:50,880
here we've got an example for the hive

444
00:14:50,880 --> 00:14:53,199
you can send that off when an artifact

445
00:14:53,199 --> 00:14:54,560
with results

446
00:14:54,560 --> 00:14:57,040
completes and you know you want to be

447
00:14:57,040 --> 00:14:58,320
alerted on that there's

448
00:14:58,320 --> 00:15:00,160
server alerts to hide alert there's

449
00:15:00,160 --> 00:15:02,160
slack alerts you can do this for

450
00:15:02,160 --> 00:15:03,600
pretty much anything that you can think

451
00:15:03,600 --> 00:15:05,360
of that you know you could

452
00:15:05,360 --> 00:15:08,720
reach via an api or http

453
00:15:08,720 --> 00:15:10,800
um lots of different ways to extend that

454
00:15:10,800 --> 00:15:12,639
there to alert on that

455
00:15:12,639 --> 00:15:14,560
when you have those detection mechanisms

456
00:15:14,560 --> 00:15:16,959
in place

457
00:15:19,680 --> 00:15:21,680
now aside from the detection and the

458
00:15:21,680 --> 00:15:22,800
monitoring

459
00:15:22,800 --> 00:15:24,480
when you're in the middle of a case or

460
00:15:24,480 --> 00:15:26,079
in the middle of an incident and you

461
00:15:26,079 --> 00:15:28,000
want to triage a host and analyze all

462
00:15:28,000 --> 00:15:28,480
the

463
00:15:28,480 --> 00:15:30,639
all the stuff all the artifacts and all

464
00:15:30,639 --> 00:15:32,800
the data sources on that host

465
00:15:32,800 --> 00:15:34,160
you can do stuff like start a packet

466
00:15:34,160 --> 00:15:36,079
capture you can examine process memory

467
00:15:36,079 --> 00:15:38,560
search for process injections right it

468
00:15:38,560 --> 00:15:40,560
just depending on where you are in that

469
00:15:40,560 --> 00:15:41,920
in that response

470
00:15:41,920 --> 00:15:44,160
and in that case um you know you can

471
00:15:44,160 --> 00:15:45,199
search for mft

472
00:15:45,199 --> 00:15:47,519
for a file right see if it exists on the

473
00:15:47,519 --> 00:15:49,120
host see if it ever existed

474
00:15:49,120 --> 00:15:50,720
maybe it got ever written in mft maybe

475
00:15:50,720 --> 00:15:52,639
it's in usn

476
00:15:52,639 --> 00:15:54,560
you know maybe you want to see the usage

477
00:15:54,560 --> 00:15:56,240
and and activity from

478
00:15:56,240 --> 00:15:58,720
srum uh there's lots of stuff that you

479
00:15:58,720 --> 00:16:00,079
can gather here

480
00:16:00,079 --> 00:16:02,399
and we'll go through in just a minute

481
00:16:02,399 --> 00:16:04,240
and uh and it's really just

482
00:16:04,240 --> 00:16:05,920
lots of useful data that you can get

483
00:16:05,920 --> 00:16:07,680
quickly and easily from these hosts

484
00:16:07,680 --> 00:16:09,519
whether hunting or via a targeted

485
00:16:09,519 --> 00:16:12,000
collection

486
00:16:14,240 --> 00:16:16,160
now i want to talk about tools a little

487
00:16:16,160 --> 00:16:18,720
bit so velociraptor has this concept of

488
00:16:18,720 --> 00:16:19,839
tools

489
00:16:19,839 --> 00:16:23,120
and using external tools to augment its

490
00:16:23,120 --> 00:16:24,480
capabilities

491
00:16:24,480 --> 00:16:25,759
and i spoke a little bit about the

492
00:16:25,759 --> 00:16:28,320
flexibility of equal and how we can

493
00:16:28,320 --> 00:16:30,800
integrate and extend velociraptor and

494
00:16:30,800 --> 00:16:32,639
this is one of those ways that we can

495
00:16:32,639 --> 00:16:33,279
use the

496
00:16:33,279 --> 00:16:36,880
tools concept from the velociraptor to

497
00:16:36,880 --> 00:16:38,800
deploy additional tools to help us with

498
00:16:38,800 --> 00:16:40,399
our investigation

499
00:16:40,399 --> 00:16:43,279
maybe you know for some reason we want

500
00:16:43,279 --> 00:16:45,040
to use uh sharkpound right we want to

501
00:16:45,040 --> 00:16:47,279
include that with our velociraptor

502
00:16:47,279 --> 00:16:50,320
collector exe and maybe we want to be

503
00:16:50,320 --> 00:16:50,880
able to

504
00:16:50,880 --> 00:16:53,360
trigger as the host with that binary we

505
00:16:53,360 --> 00:16:54,000
can do that

506
00:16:54,000 --> 00:16:56,399
we can wrap those tools in there and you

507
00:16:56,399 --> 00:16:57,199
know things like

508
00:16:57,199 --> 00:16:59,199
if we want to install sysmon on a host

509
00:16:59,199 --> 00:17:00,320
and

510
00:17:00,320 --> 00:17:01,600
deploy that out to a bunch of different

511
00:17:01,600 --> 00:17:03,279
hosts or deploy it during an engagement

512
00:17:03,279 --> 00:17:04,240
where we don't have

513
00:17:04,240 --> 00:17:06,480
you know a bunch of visibility we can do

514
00:17:06,480 --> 00:17:08,400
that we can wrap that in and have that

515
00:17:08,400 --> 00:17:09,599
additional visibility

516
00:17:09,599 --> 00:17:11,359
and have that additional capability

517
00:17:11,359 --> 00:17:12,400
whenever we're performing that

518
00:17:12,400 --> 00:17:13,919
investigation

519
00:17:13,919 --> 00:17:15,679
and help us get closer to the ground

520
00:17:15,679 --> 00:17:19,839
truth right

521
00:17:21,520 --> 00:17:22,959
i want to talk a little bit about

522
00:17:22,959 --> 00:17:25,679
remediation maybe after we've triaged

523
00:17:25,679 --> 00:17:28,000
and and we're looking at stuff

524
00:17:28,000 --> 00:17:29,200
you know maybe want to take a

525
00:17:29,200 --> 00:17:31,440
semi-automated approach

526
00:17:31,440 --> 00:17:34,160
we can kill processes with velociraptor

527
00:17:34,160 --> 00:17:34,880
we can

528
00:17:34,880 --> 00:17:36,559
pretty much do anything that you can do

529
00:17:36,559 --> 00:17:38,480
with arbitrary power shell

530
00:17:38,480 --> 00:17:41,760
or other shell commands we can integrate

531
00:17:41,760 --> 00:17:42,559
that in

532
00:17:42,559 --> 00:17:45,200
with our you know kind of our triage or

533
00:17:45,200 --> 00:17:46,559
response pipeline

534
00:17:46,559 --> 00:17:50,880
and maybe there are certain servers or

535
00:17:50,880 --> 00:17:52,640
certain hosts that if we see this

536
00:17:52,640 --> 00:17:54,400
particular scheduled task

537
00:17:54,400 --> 00:17:57,440
or we see this particular service

538
00:17:57,440 --> 00:17:58,880
we want to kill it immediately or we

539
00:17:58,880 --> 00:18:00,960
want to remove it maybe we want to

540
00:18:00,960 --> 00:18:03,440
isolate the host as soon as we see that

541
00:18:03,440 --> 00:18:06,960
you know maybe we have a sore solution

542
00:18:06,960 --> 00:18:10,080
and you know out of for some reason

543
00:18:10,080 --> 00:18:11,520
whatever context we've gathered we

544
00:18:11,520 --> 00:18:12,320
wanted to do this

545
00:18:12,320 --> 00:18:14,960
we can tie into this and achieve this

546
00:18:14,960 --> 00:18:16,559
remediation

547
00:18:16,559 --> 00:18:20,080
action right so it's very cool very very

548
00:18:20,080 --> 00:18:21,760
very useful to be able to do this as

549
00:18:21,760 --> 00:18:24,000
well

550
00:18:25,760 --> 00:18:27,200
and i spoke a little bit about the soar

551
00:18:27,200 --> 00:18:29,360
and the automation velociraptor

552
00:18:29,360 --> 00:18:32,480
comes with a grpc based api

553
00:18:32,480 --> 00:18:34,960
it's acl based so you know there are

554
00:18:34,960 --> 00:18:36,320
certain permissions with

555
00:18:36,320 --> 00:18:38,320
things you can do with it with api kind

556
00:18:38,320 --> 00:18:39,520
of similar to

557
00:18:39,520 --> 00:18:41,280
what you would be doing in the web

558
00:18:41,280 --> 00:18:43,280
interface or the gui

559
00:18:43,280 --> 00:18:44,799
for example maybe you can only read

560
00:18:44,799 --> 00:18:46,960
artifacts or maybe you can only

561
00:18:46,960 --> 00:18:49,679
uh you know add artifacts or maybe you

562
00:18:49,679 --> 00:18:50,559
can do everything

563
00:18:50,559 --> 00:18:53,440
right so there's apple based access to

564
00:18:53,440 --> 00:18:55,280
that grpc based api

565
00:18:55,280 --> 00:18:57,280
and you can install pi velociraptor the

566
00:18:57,280 --> 00:18:59,440
client if you want to interact with that

567
00:18:59,440 --> 00:19:01,840
um you know add a user and then you can

568
00:19:01,840 --> 00:19:04,000
perform those automated response actions

569
00:19:04,000 --> 00:19:07,280
or context gathering right via soar tool

570
00:19:07,280 --> 00:19:08,720
maybe something like

571
00:19:08,720 --> 00:19:12,160
shuffle or n or node red or

572
00:19:12,160 --> 00:19:14,080
whatever you're fancy right there's lots

573
00:19:14,080 --> 00:19:15,760
of things you can do there

574
00:19:15,760 --> 00:19:17,200
and again just to run a simple query

575
00:19:17,200 --> 00:19:18,880
here we have an example

576
00:19:18,880 --> 00:19:20,960
uh pi velociraptor right here at the

577
00:19:20,960 --> 00:19:22,799
bottom just supply the config file for

578
00:19:22,799 --> 00:19:24,240
the api

579
00:19:24,240 --> 00:19:26,000
and that's just again a very simple

580
00:19:26,000 --> 00:19:28,080
command just to select the server info

581
00:19:28,080 --> 00:19:29,679
but it gives you an idea of how to start

582
00:19:29,679 --> 00:19:31,919
leveraging that once you

583
00:19:31,919 --> 00:19:34,320
once you want to go that way there's

584
00:19:34,320 --> 00:19:35,039
lots of

585
00:19:35,039 --> 00:19:36,640
great documentation sorry about that

586
00:19:36,640 --> 00:19:38,080
there's lots of great documentation

587
00:19:38,080 --> 00:19:40,559
as well uh for that api here and then i

588
00:19:40,559 --> 00:19:41,200
also have

589
00:19:41,200 --> 00:19:43,360
a blog article that i i did with

590
00:19:43,360 --> 00:19:44,240
security in in

591
00:19:44,240 --> 00:19:47,840
and velociraptor and it nade in here

592
00:19:47,840 --> 00:19:49,360
that you can take a look at that kind of

593
00:19:49,360 --> 00:19:53,840
illustrates that concept

594
00:19:55,840 --> 00:19:58,799
aside from enriching those i'm sorry

595
00:19:58,799 --> 00:20:00,559
aside from the automation

596
00:20:00,559 --> 00:20:02,799
you can also enrich other data sets

597
00:20:02,799 --> 00:20:04,000
right maybe use

598
00:20:04,000 --> 00:20:06,880
splunk maybe you use elasticsearch or

599
00:20:06,880 --> 00:20:08,240
the elastic stack

600
00:20:08,240 --> 00:20:10,720
maybe you use security ending you can

601
00:20:10,720 --> 00:20:11,280
use

602
00:20:11,280 --> 00:20:13,840
either the elastic flows upload or the

603
00:20:13,840 --> 00:20:15,360
splunk upload

604
00:20:15,360 --> 00:20:17,760
to upload any relevant events this will

605
00:20:17,760 --> 00:20:18,480
run as a

606
00:20:18,480 --> 00:20:21,440
server event artifact so you can run

607
00:20:21,440 --> 00:20:22,240
this

608
00:20:22,240 --> 00:20:23,919
and it will watch for whatever you want

609
00:20:23,919 --> 00:20:25,280
to watch for if

610
00:20:25,280 --> 00:20:28,320
you know maybe a it's a certain file

611
00:20:28,320 --> 00:20:30,480
hash that was found or

612
00:20:30,480 --> 00:20:33,600
it's you know just whatever kind of

613
00:20:33,600 --> 00:20:34,240
event

614
00:20:34,240 --> 00:20:36,480
that you want to watch for you can then

615
00:20:36,480 --> 00:20:38,240
send those events over to splunk over to

616
00:20:38,240 --> 00:20:39,600
elastic or security

617
00:20:39,600 --> 00:20:42,000
and then be able to correlate that with

618
00:20:42,000 --> 00:20:44,240
other data sets right maybe you want to

619
00:20:44,240 --> 00:20:46,720
correlate this host-based activity with

620
00:20:46,720 --> 00:20:48,400
some other network based activity from

621
00:20:48,400 --> 00:20:50,080
zeek or sword coda

622
00:20:50,080 --> 00:20:52,480
and security enemy right and it's very

623
00:20:52,480 --> 00:20:54,080
it's awesome to be able to do that to

624
00:20:54,080 --> 00:20:55,600
have that kind of visibility where

625
00:20:55,600 --> 00:20:56,720
you're talking from the host

626
00:20:56,720 --> 00:20:59,360
the network and everything else and just

627
00:20:59,360 --> 00:21:00,840
tying that all together is really

628
00:21:00,840 --> 00:21:03,840
powerful

629
00:21:05,840 --> 00:21:07,679
all right well enough about the slides

630
00:21:07,679 --> 00:21:10,080
and enough about me talking

631
00:21:10,080 --> 00:21:12,880
now i just really want to go through how

632
00:21:12,880 --> 00:21:14,640
you know how velociraptor looks

633
00:21:14,640 --> 00:21:16,640
how you might use it you know some

634
00:21:16,640 --> 00:21:18,240
useful features

635
00:21:18,240 --> 00:21:21,440
and you know maybe a slight use case

636
00:21:21,440 --> 00:21:23,280
where we can go over how we can leverage

637
00:21:23,280 --> 00:21:25,120
velociraptor to

638
00:21:25,120 --> 00:21:27,440
increase our visibility and to be able

639
00:21:27,440 --> 00:21:29,039
to

640
00:21:29,039 --> 00:21:30,559
you know increase our forensics or

641
00:21:30,559 --> 00:21:32,240
detection capability

642
00:21:32,240 --> 00:21:34,799
so that's what we'll go through now and

643
00:21:34,799 --> 00:21:36,640
i'll switch from the slides

644
00:21:36,640 --> 00:21:40,000
whoops let me get out of that not bad

645
00:21:40,000 --> 00:21:43,280
okay so if we can get this

646
00:21:43,280 --> 00:21:46,880
and just let me know if there's any

647
00:21:46,880 --> 00:21:49,520
issue there just

648
00:21:49,520 --> 00:21:52,000
you should be able to see now we have a

649
00:21:52,000 --> 00:21:52,880
windows 10

650
00:21:52,880 --> 00:21:55,600
vm and what we're going to do here is

651
00:21:55,600 --> 00:21:57,280
we're going to run

652
00:21:57,280 --> 00:21:59,200
the velociraptor gui command and what

653
00:21:59,200 --> 00:22:01,120
that's going to do is it's going to set

654
00:22:01,120 --> 00:22:04,320
up a velociraptor server it's going to

655
00:22:04,320 --> 00:22:05,919
set up a velociraptor client

656
00:22:05,919 --> 00:22:09,120
locally on the box and what we'll be

657
00:22:09,120 --> 00:22:10,000
able to do with that

658
00:22:10,000 --> 00:22:12,000
is go through and evaluate those

659
00:22:12,000 --> 00:22:13,039
different artifacts

660
00:22:13,039 --> 00:22:14,960
and kind of see what velociraptor is all

661
00:22:14,960 --> 00:22:16,159
about

662
00:22:16,159 --> 00:22:17,760
so without further ado we'll go ahead

663
00:22:17,760 --> 00:22:19,919
and run that command

664
00:22:19,919 --> 00:22:22,960
and i know it's probably kind of hard to

665
00:22:22,960 --> 00:22:24,080
see but we're not going to be running

666
00:22:24,080 --> 00:22:26,480
too many commands here let me just go

667
00:22:26,480 --> 00:22:27,200
ahead and

668
00:22:27,200 --> 00:22:29,440
grab that if i can get the input in

669
00:22:29,440 --> 00:22:31,600
there

670
00:22:31,679 --> 00:22:34,320
oh my god

671
00:22:35,840 --> 00:22:39,120
there we go all right all right so

672
00:22:39,120 --> 00:22:41,200
velociraptor's starting up

673
00:22:41,200 --> 00:22:43,440
right it's starting up the client and

674
00:22:43,440 --> 00:22:44,799
the server process right now

675
00:22:44,799 --> 00:22:46,320
and then it's going to take us over to

676
00:22:46,320 --> 00:22:48,400
the web interface here in just a second

677
00:22:48,400 --> 00:22:50,960
it's going to pop up a browser tab there

678
00:22:50,960 --> 00:22:52,840
it goes

679
00:22:52,840 --> 00:22:57,520
okay let's take just a second here

680
00:23:02,400 --> 00:23:04,240
all right so we're at the velociraptor

681
00:23:04,240 --> 00:23:05,679
landing page here

682
00:23:05,679 --> 00:23:07,679
and we can see just the you know kind of

683
00:23:07,679 --> 00:23:08,720
the the home

684
00:23:08,720 --> 00:23:10,080
here where it talks about we can do

685
00:23:10,080 --> 00:23:11,760
various things here

686
00:23:11,760 --> 00:23:13,120
but it's going to go ahead and show you

687
00:23:13,120 --> 00:23:16,000
the client that it spun up over here

688
00:23:16,000 --> 00:23:18,559
you can see if we hit enter here just

689
00:23:18,559 --> 00:23:19,919
give it a second to update

690
00:23:19,919 --> 00:23:22,799
oops i think i hit refresh by accident

691
00:23:22,799 --> 00:23:23,280
all right

692
00:23:23,280 --> 00:23:25,679
we can see that we now have our client

693
00:23:25,679 --> 00:23:27,200
connected right so it's going to be the

694
00:23:27,200 --> 00:23:29,039
same local windows 10 box

695
00:23:29,039 --> 00:23:31,520
as the server is running after we run

696
00:23:31,520 --> 00:23:33,200
our velociraptor gui command

697
00:23:33,200 --> 00:23:34,960
you can see the client id the hostname

698
00:23:34,960 --> 00:23:37,520
and some os version information

699
00:23:37,520 --> 00:23:39,120
we can see some other stuff over here on

700
00:23:39,120 --> 00:23:40,720
the left again the home

701
00:23:40,720 --> 00:23:44,000
tab the section if we want to start a

702
00:23:44,000 --> 00:23:44,480
hunt

703
00:23:44,480 --> 00:23:47,840
for any of our clients we can see the

704
00:23:47,840 --> 00:23:49,919
different artifacts that velociraptor

705
00:23:49,919 --> 00:23:52,000
has to offer here

706
00:23:52,000 --> 00:23:53,600
and we'll talk about that there in just

707
00:23:53,600 --> 00:23:55,840
a second obviously there are quite a few

708
00:23:55,840 --> 00:23:57,200
here

709
00:23:57,200 --> 00:23:59,360
there's various linux commands generic

710
00:23:59,360 --> 00:24:00,320
ones

711
00:24:00,320 --> 00:24:02,159
so we have a forensics local hashes

712
00:24:02,159 --> 00:24:04,159
query so we can maintain

713
00:24:04,159 --> 00:24:06,559
a local file database from sorry hash

714
00:24:06,559 --> 00:24:08,640
database on the client if we like

715
00:24:08,640 --> 00:24:10,880
and it will crawl we can have that

716
00:24:10,880 --> 00:24:12,000
updated

717
00:24:12,000 --> 00:24:15,120
and then we can query across our grid

718
00:24:15,120 --> 00:24:17,039
across all of our clients and then see

719
00:24:17,039 --> 00:24:18,640
if that hash is found on any of our

720
00:24:18,640 --> 00:24:21,360
boxes or was it one time on the box

721
00:24:21,360 --> 00:24:24,240
and then it kind of gives us a place to

722
00:24:24,240 --> 00:24:25,679
go whenever we're trying to scope an

723
00:24:25,679 --> 00:24:27,039
incident or scope

724
00:24:27,039 --> 00:24:28,559
you know a file being in a particular

725
00:24:28,559 --> 00:24:30,640
location

726
00:24:30,640 --> 00:24:32,799
there's lots and lots of other mac os

727
00:24:32,799 --> 00:24:33,840
server

728
00:24:33,840 --> 00:24:35,520
and then lots of windows stuff if we

729
00:24:35,520 --> 00:24:38,480
filter on windows right here

730
00:24:38,480 --> 00:24:40,159
lots of stuff which we'll go through in

731
00:24:40,159 --> 00:24:41,679
just a minute um

732
00:24:41,679 --> 00:24:43,679
but real quick i just want to pivot back

733
00:24:43,679 --> 00:24:46,880
over here so this would be your server

734
00:24:46,880 --> 00:24:49,919
events or server alerts kind of page and

735
00:24:49,919 --> 00:24:51,919
this would

736
00:24:51,919 --> 00:24:55,039
generate rows and information for

737
00:24:55,039 --> 00:24:55,840
example

738
00:24:55,840 --> 00:24:58,880
if we've modified artifacts if we've

739
00:24:58,880 --> 00:25:01,919
had a client enroll right

740
00:25:01,919 --> 00:25:03,520
just various things that we can set up

741
00:25:03,520 --> 00:25:04,960
here

742
00:25:04,960 --> 00:25:06,080
we'll go through that in just a little

743
00:25:06,080 --> 00:25:08,640
bit and then we have

744
00:25:08,640 --> 00:25:10,640
right here just a server collection tab

745
00:25:10,640 --> 00:25:12,840
and then the

746
00:25:12,840 --> 00:25:15,840
notebooks

747
00:25:15,840 --> 00:25:17,760
so these notebooks i have a sample one

748
00:25:17,760 --> 00:25:19,760
here event logs modification

749
00:25:19,760 --> 00:25:21,039
uh something we're going to go over here

750
00:25:21,039 --> 00:25:23,440
in just a minute and

751
00:25:23,440 --> 00:25:25,520
so again these notebooks are are pretty

752
00:25:25,520 --> 00:25:26,480
cool and

753
00:25:26,480 --> 00:25:29,279
in that they are a way that you can test

754
00:25:29,279 --> 00:25:31,120
those queries

755
00:25:31,120 --> 00:25:32,720
expand it here you can test those

756
00:25:32,720 --> 00:25:34,880
queries and uh kind of iterate while

757
00:25:34,880 --> 00:25:37,679
you're building those artifacts

758
00:25:37,679 --> 00:25:39,919
so real quick so i don't bore y'all too

759
00:25:39,919 --> 00:25:41,200
much i'll get into an

760
00:25:41,200 --> 00:25:44,080
actual artifact collection and we'll

761
00:25:44,080 --> 00:25:45,440
click on this client id this client

762
00:25:45,440 --> 00:25:46,960
that's enrolled right now and again you

763
00:25:46,960 --> 00:25:47,760
have that

764
00:25:47,760 --> 00:25:50,000
kind of basic high-level information you

765
00:25:50,000 --> 00:25:51,520
can see if anything was collected

766
00:25:51,520 --> 00:25:54,559
already for this client

767
00:25:55,039 --> 00:25:57,840
and nothing yet just the basic generic

768
00:25:57,840 --> 00:25:58,320
client

769
00:25:58,320 --> 00:26:01,679
info which we get when we're enrolled so

770
00:26:01,679 --> 00:26:04,640
real quick maybe um you know i want to

771
00:26:04,640 --> 00:26:06,320
go through a use case

772
00:26:06,320 --> 00:26:09,520
so let's do this how about

773
00:26:09,520 --> 00:26:12,559
i want to see what happens

774
00:26:12,559 --> 00:26:14,880
when we mess with the event logs on this

775
00:26:14,880 --> 00:26:16,400
box right so maybe we can use

776
00:26:16,400 --> 00:26:18,159
velociraptor for

777
00:26:18,159 --> 00:26:21,360
for checking the modification or the

778
00:26:21,360 --> 00:26:24,320
disabling of event logs

779
00:26:24,320 --> 00:26:27,279
so let's see

780
00:26:31,039 --> 00:26:33,039
now one of the things that you know i

781
00:26:33,039 --> 00:26:34,320
want to illustrate here

782
00:26:34,320 --> 00:26:37,600
is is just one of the things that

783
00:26:37,600 --> 00:26:39,679
attackers might use maybe so an example

784
00:26:39,679 --> 00:26:40,640
for

785
00:26:40,640 --> 00:26:43,120
um staging malicious payloads or

786
00:26:43,120 --> 00:26:44,799
managing malicious payloads

787
00:26:44,799 --> 00:26:46,320
um you know an attacker maybe would use

788
00:26:46,320 --> 00:26:49,200
something like bits admin i think

789
00:26:49,200 --> 00:26:52,320
to maybe live off the land and to

790
00:26:52,320 --> 00:26:55,600
um not alert uh you know all the

791
00:26:55,600 --> 00:26:58,799
nrs or ids i'm sorry um

792
00:26:58,799 --> 00:27:01,440
edr tools right so maybe we want to try

793
00:27:01,440 --> 00:27:03,039
to blend in and use something like bits

794
00:27:03,039 --> 00:27:04,640
admin and maybe you want to try to cover

795
00:27:04,640 --> 00:27:05,440
our tracks

796
00:27:05,440 --> 00:27:09,440
right so let's run this as administrator

797
00:27:09,440 --> 00:27:11,440
and just get another powershell prompt

798
00:27:11,440 --> 00:27:12,799
here

799
00:27:12,799 --> 00:27:14,960
so i just want to walk through maybe how

800
00:27:14,960 --> 00:27:16,559
we can use velociraptor to

801
00:27:16,559 --> 00:27:21,840
detect event log modification

802
00:27:23,200 --> 00:27:25,200
first i just want to walk through how we

803
00:27:25,200 --> 00:27:26,960
might see these event logs in

804
00:27:26,960 --> 00:27:29,279
just a second so let's run in just a

805
00:27:29,279 --> 00:27:32,240
little sluggish here

806
00:27:32,480 --> 00:27:35,840
all right let's just get that

807
00:27:39,760 --> 00:27:49,840
just get event viewer open here

808
00:27:58,399 --> 00:28:04,479
alrighty taking the time to do the demo

809
00:28:04,960 --> 00:28:10,240
all right and it's loading up here

810
00:28:12,960 --> 00:28:16,320
maybe not well i thought i did

811
00:28:16,320 --> 00:28:18,720
all right

812
00:28:21,919 --> 00:28:24,399
come on

813
00:28:25,520 --> 00:28:28,080
there it goes

814
00:28:29,120 --> 00:28:31,840
all right

815
00:28:32,240 --> 00:28:35,360
okay so we got that

816
00:28:35,360 --> 00:28:38,799
place and so i spoke about bits admin

817
00:28:38,799 --> 00:28:41,679
let's let's go into the application

818
00:28:41,679 --> 00:28:42,960
services log directory

819
00:28:42,960 --> 00:28:48,240
and narrow in on the bits plant log

820
00:28:51,039 --> 00:28:54,480
give it just a second here

821
00:28:55,679 --> 00:28:59,840
curious if obs is slow me down just a

822
00:28:59,840 --> 00:29:13,840
little bit

823
00:29:19,679 --> 00:29:23,520
all right so we'll wait on that let's

824
00:29:24,840 --> 00:29:26,320
see

825
00:29:26,320 --> 00:29:29,520
out of here real quick

826
00:29:32,880 --> 00:29:41,840
come on

827
00:29:43,120 --> 00:29:44,640
all right i think we're back now i think

828
00:29:44,640 --> 00:29:47,279
all right cool

829
00:29:49,520 --> 00:29:55,840
come on

830
00:30:02,799 --> 00:30:05,919
all right we'll do that second here

831
00:30:05,919 --> 00:30:09,840
the demo gods are not kind today

832
00:30:15,039 --> 00:30:17,440
all right

833
00:30:30,880 --> 00:30:37,840
all right

834
00:30:38,399 --> 00:30:40,320
let's pop out of here here click this

835
00:30:40,320 --> 00:30:41,520
guy

836
00:30:41,520 --> 00:30:51,840
all right let's expand microsoft here

837
00:30:52,880 --> 00:30:54,640
go ahead and grab the command we'll use

838
00:30:54,640 --> 00:31:05,840
to stage this

839
00:31:07,120 --> 00:31:09,200
all right so we're going to use bits

840
00:31:09,200 --> 00:31:10,799
admin real quick and

841
00:31:10,799 --> 00:31:12,799
so mike cohen actually walked through

842
00:31:12,799 --> 00:31:14,159
this uh in a

843
00:31:14,159 --> 00:31:17,120
blog post on on the velociraptor blog i

844
00:31:17,120 --> 00:31:18,000
wrote an article about

845
00:31:18,000 --> 00:31:20,559
this and so i just like to step you know

846
00:31:20,559 --> 00:31:22,880
kind of step through this procedure here

847
00:31:22,880 --> 00:31:25,519
um now what we're going to do here is

848
00:31:25,519 --> 00:31:27,279
we're just going to use bits admin to

849
00:31:27,279 --> 00:31:30,799
just curl google basically and

850
00:31:30,799 --> 00:31:33,600
pull that down into a pretend evil file

851
00:31:33,600 --> 00:31:34,480
evil ps1

852
00:31:34,480 --> 00:31:36,080
for example an attacker might do this

853
00:31:36,080 --> 00:31:37,679
with an actual evil file

854
00:31:37,679 --> 00:31:41,039
so i'll just pull that down and

855
00:31:41,039 --> 00:31:43,200
ensure that successful and then what

856
00:31:43,200 --> 00:31:44,840
we'll do here

857
00:31:44,840 --> 00:31:47,679
is all right go ahead and complete

858
00:31:47,679 --> 00:31:49,919
and then we'll go ahead and pull down

859
00:31:49,919 --> 00:31:52,799
the windows here

860
00:31:58,559 --> 00:32:01,440
all right and bits client all right so

861
00:32:01,440 --> 00:32:02,559
typically

862
00:32:02,559 --> 00:32:05,360
let's see here

863
00:32:05,600 --> 00:32:07,679
let me just give it a second here so

864
00:32:07,679 --> 00:32:09,120
we'll see this activity right to the

865
00:32:09,120 --> 00:32:11,679
bits client windows event log

866
00:32:11,679 --> 00:32:13,200
we're going to see the transfer activity

867
00:32:13,200 --> 00:32:15,679
that just occurred right here

868
00:32:15,679 --> 00:32:18,000
it's going to be the 16 403 event right

869
00:32:18,000 --> 00:32:18,799
here

870
00:32:18,799 --> 00:32:23,039
and if we drill into the details

871
00:32:23,440 --> 00:32:24,880
see this right here just give it just a

872
00:32:24,880 --> 00:32:26,799
second all right we'll see down

873
00:32:26,799 --> 00:32:28,399
we'll see that we pull from that remote

874
00:32:28,399 --> 00:32:30,720
site in our case just google.com

875
00:32:30,720 --> 00:32:33,200
and then into the local file users user

876
00:32:33,200 --> 00:32:34,880
evil ps1

877
00:32:34,880 --> 00:32:37,120
right so we see that there and we're

878
00:32:37,120 --> 00:32:38,720
checking that activity and that's cool

879
00:32:38,720 --> 00:32:42,399
um but you know what if you know what if

880
00:32:42,399 --> 00:32:43,519
an attacker

881
00:32:43,519 --> 00:32:45,600
wants to obscure their intentions or

882
00:32:45,600 --> 00:32:46,640
cover their tracks

883
00:32:46,640 --> 00:32:49,519
and um you know a lot of tools like

884
00:32:49,519 --> 00:32:50,960
maybe like when log beat or

885
00:32:50,960 --> 00:32:53,600
other log shippers we watch windows logs

886
00:32:53,600 --> 00:32:54,799
we watch windows events

887
00:32:54,799 --> 00:32:58,240
right um so maybe in an effort to

888
00:32:58,240 --> 00:32:59,600
subvert some of that

889
00:32:59,600 --> 00:33:01,679
ability to monitor that maybe an

890
00:33:01,679 --> 00:33:03,360
attacker might disable an event log

891
00:33:03,360 --> 00:33:06,240
right so that's fairly trivial to to be

892
00:33:06,240 --> 00:33:06,799
able to do

893
00:33:06,799 --> 00:33:08,960
here right we can an attacker can do

894
00:33:08,960 --> 00:33:11,200
that here just disable the log

895
00:33:11,200 --> 00:33:15,039
right so with that maybe

896
00:33:15,039 --> 00:33:17,760
you know if we if we refresh or get out

897
00:33:17,760 --> 00:33:18,720
of here

898
00:33:18,720 --> 00:33:24,000
um and try running that again

899
00:33:24,000 --> 00:33:26,720
just refresh

900
00:33:27,919 --> 00:33:30,399
there it is

901
00:33:31,120 --> 00:33:33,760
okay well let's see it's 335 and i just

902
00:33:33,760 --> 00:33:36,399
ran that command

903
00:33:36,399 --> 00:33:39,840
okay not seeing it

904
00:33:40,799 --> 00:33:42,240
let's refresh again and make sure we're

905
00:33:42,240 --> 00:33:45,039
not getting other any other new events

906
00:33:45,039 --> 00:33:46,960
hmm yeah it seems like it would be a

907
00:33:46,960 --> 00:33:48,080
problem right

908
00:33:48,080 --> 00:33:52,399
for for those log shippers to

909
00:33:52,399 --> 00:33:54,559
you know to kind of subvert that that

910
00:33:54,559 --> 00:33:55,519
mechanism

911
00:33:55,519 --> 00:33:57,600
and kind of fly under the radar right

912
00:33:57,600 --> 00:33:59,200
yeah i think that would that would

913
00:33:59,200 --> 00:34:00,240
definitely be a problem

914
00:34:00,240 --> 00:34:01,840
and you know something that would be

915
00:34:01,840 --> 00:34:04,240
useful to be able to to detect

916
00:34:04,240 --> 00:34:06,159
and you know we can detect that with

917
00:34:06,159 --> 00:34:07,919
velociraptor right we can

918
00:34:07,919 --> 00:34:09,839
hone in on these these event files maybe

919
00:34:09,839 --> 00:34:10,960
we're watching

920
00:34:10,960 --> 00:34:13,599
uh certain event log files maybe we're

921
00:34:13,599 --> 00:34:14,079
um

922
00:34:14,079 --> 00:34:16,000
watching you know various event log

923
00:34:16,000 --> 00:34:17,440
files and we want to be

924
00:34:17,440 --> 00:34:18,480
we want to know about those

925
00:34:18,480 --> 00:34:20,639
modifications that have taken place i'm

926
00:34:20,639 --> 00:34:21,760
going to see that maybe those event

927
00:34:21,760 --> 00:34:22,480
lines were maybe

928
00:34:22,480 --> 00:34:25,199
enabled or disabled and so this actually

929
00:34:25,199 --> 00:34:26,960
correlates and and mike points out in

930
00:34:26,960 --> 00:34:28,079
his post

931
00:34:28,079 --> 00:34:31,199
this correlates to a registry key for

932
00:34:31,199 --> 00:34:32,159
the event log

933
00:34:32,159 --> 00:34:35,199
obviously that it's going to be the

934
00:34:35,199 --> 00:34:38,320
htlm question here

935
00:34:38,320 --> 00:34:40,239
that's not what i want it's going to be

936
00:34:40,239 --> 00:34:41,679
hklm software

937
00:34:41,679 --> 00:34:43,599
uh microsoft windows current version win

938
00:34:43,599 --> 00:34:45,359
event channels microsoft windows bitcoin

939
00:34:45,359 --> 00:34:47,359
operational enabled and so that sets a

940
00:34:47,359 --> 00:34:49,119
flag there

941
00:34:49,119 --> 00:34:50,719
i'm going to avoid just because of the

942
00:34:50,719 --> 00:34:52,560
the vm selections here uh trying to

943
00:34:52,560 --> 00:34:53,839
navigate through all that

944
00:34:53,839 --> 00:34:55,760
but it does set that flag there and so

945
00:34:55,760 --> 00:34:57,119
we can monitor for that flag with

946
00:34:57,119 --> 00:34:58,079
velociraptor

947
00:34:58,079 --> 00:35:00,480
and see uh if any of those event logs

948
00:35:00,480 --> 00:35:02,000
were disabled right so i think that

949
00:35:02,000 --> 00:35:02,800
would be

950
00:35:02,800 --> 00:35:06,240
pretty useful so let's go back over here

951
00:35:06,240 --> 00:35:07,839
to velociraptor

952
00:35:07,839 --> 00:35:09,440
and you know maybe we want to start out

953
00:35:09,440 --> 00:35:11,680
in a notebook and you know make that

954
00:35:11,680 --> 00:35:14,960
a test our query um

955
00:35:14,960 --> 00:35:16,480
you know see if there's been anything

956
00:35:16,480 --> 00:35:18,160
going on with the event logs and that's

957
00:35:18,160 --> 00:35:20,240
where we have this notebook here

958
00:35:20,240 --> 00:35:22,400
and it's basically equal sample here

959
00:35:22,400 --> 00:35:23,599
right so

960
00:35:23,599 --> 00:35:25,359
right now what we're looking for is

961
00:35:25,359 --> 00:35:27,440
really just

962
00:35:27,440 --> 00:35:30,720
any we're going to set a key a field

963
00:35:30,720 --> 00:35:32,800
or i'm sorry a variable called key and

964
00:35:32,800 --> 00:35:33,760
we're going to look for

965
00:35:33,760 --> 00:35:35,280
that that register key we're going to

966
00:35:35,280 --> 00:35:36,640
search for all those channels and then

967
00:35:36,640 --> 00:35:38,400
we're going to see

968
00:35:38,400 --> 00:35:41,040
filtering on in this case the bits

969
00:35:41,040 --> 00:35:42,400
client software

970
00:35:42,400 --> 00:35:44,800
or the event log and then we're going to

971
00:35:44,800 --> 00:35:46,160
you know check and see what the channel

972
00:35:46,160 --> 00:35:47,680
name is the the publisher or the

973
00:35:47,680 --> 00:35:48,480
provider

974
00:35:48,480 --> 00:35:50,079
i'm going to check and see uh the

975
00:35:50,079 --> 00:35:51,839
enabled status right so

976
00:35:51,839 --> 00:35:54,560
in this case uh previously we had a zero

977
00:35:54,560 --> 00:35:55,680
and one here

978
00:35:55,680 --> 00:35:58,079
for the analytic not being enabled and

979
00:35:58,079 --> 00:36:00,079
the operational being enabled

980
00:36:00,079 --> 00:36:03,280
but we'll go ahead and save that

981
00:36:04,640 --> 00:36:07,680
and it doesn't like that's changed so

982
00:36:07,680 --> 00:36:10,000
you know it'd be very useful to be able

983
00:36:10,000 --> 00:36:11,280
to

984
00:36:11,280 --> 00:36:14,160
you know to take that and to pump that

985
00:36:14,160 --> 00:36:16,240
into something like a client event our

986
00:36:16,240 --> 00:36:18,400
monitoring artifact and then alert us

987
00:36:18,400 --> 00:36:19,760
whenever something like that happened

988
00:36:19,760 --> 00:36:20,800
right

989
00:36:20,800 --> 00:36:22,560
it would be super useful to be able to

990
00:36:22,560 --> 00:36:23,839
do something like that and

991
00:36:23,839 --> 00:36:25,680
we can do something similar to that with

992
00:36:25,680 --> 00:36:27,599
the div plugin

993
00:36:27,599 --> 00:36:30,560
so if we take this right here the

994
00:36:30,560 --> 00:36:32,320
original query that we have

995
00:36:32,320 --> 00:36:34,079
and then we just add a few more things

996
00:36:34,079 --> 00:36:36,720
here so i'll just add a select

997
00:36:36,720 --> 00:36:40,079
all from diff and then i'm going to

998
00:36:40,079 --> 00:36:41,839
define the query

999
00:36:41,839 --> 00:36:43,680
so we're just basically saying that our

1000
00:36:43,680 --> 00:36:45,920
query for this df is going to be

1001
00:36:45,920 --> 00:36:49,040
whatever we are looking for for

1002
00:36:49,040 --> 00:36:51,280
the uh the event log there right see if

1003
00:36:51,280 --> 00:36:53,440
this stuff was

1004
00:36:53,440 --> 00:36:54,880
so enabled select that as a query we'll

1005
00:36:54,880 --> 00:36:58,079
select a period uh we'll do five seconds

1006
00:36:58,079 --> 00:37:03,040
right and then we'll do a key of

1007
00:37:06,320 --> 00:37:09,119
let's see where was it yes enabled

1008
00:37:09,119 --> 00:37:10,640
that's right

1009
00:37:10,640 --> 00:37:12,079
all right we'll do a key of enable

1010
00:37:12,079 --> 00:37:14,400
because we want to key off of this

1011
00:37:14,400 --> 00:37:17,920
column here um enabled so this is gonna

1012
00:37:17,920 --> 00:37:19,280
you can see this creates this enable

1013
00:37:19,280 --> 00:37:20,720
column here which tells us if it's

1014
00:37:20,720 --> 00:37:21,599
enabled or not

1015
00:37:21,599 --> 00:37:23,119
we're going to key off of that and then

1016
00:37:23,119 --> 00:37:24,480
we're going to basically show any

1017
00:37:24,480 --> 00:37:26,560
results for every five seconds

1018
00:37:26,560 --> 00:37:29,040
uh if there's any change in that right

1019
00:37:29,040 --> 00:37:31,200
whoops i'm gonna get a syntax over there

1020
00:37:31,200 --> 00:37:35,359
all right so keep it enabled

1021
00:37:35,680 --> 00:37:38,000
okay

1022
00:37:40,160 --> 00:37:42,079
all right so right now what it's doing

1023
00:37:42,079 --> 00:37:43,920
is it's going through and it's looking

1024
00:37:43,920 --> 00:37:45,839
to see if there are any changes

1025
00:37:45,839 --> 00:37:48,800
uh than when it last ran right so if we

1026
00:37:48,800 --> 00:37:49,520
go in

1027
00:37:49,520 --> 00:37:53,359
now and we go ahead and change this

1028
00:37:53,359 --> 00:37:55,759
again

1029
00:37:58,800 --> 00:38:01,680
sorry 11 is here there we go a little

1030
00:38:01,680 --> 00:38:02,480
bit lag

1031
00:38:02,480 --> 00:38:04,640
all right let me enable again we should

1032
00:38:04,640 --> 00:38:06,560
see a result pop here

1033
00:38:06,560 --> 00:38:09,759
just a few seconds

1034
00:38:14,240 --> 00:38:17,359
all right so in this case

1035
00:38:17,359 --> 00:38:19,119
we detected that i was actually enabled

1036
00:38:19,119 --> 00:38:20,560
so it's a little bit in the opposite

1037
00:38:20,560 --> 00:38:21,520
sense right

1038
00:38:21,520 --> 00:38:23,200
but it gives you an idea of how you can

1039
00:38:23,200 --> 00:38:25,119
use that to schedule

1040
00:38:25,119 --> 00:38:26,720
you know to check for the differential

1041
00:38:26,720 --> 00:38:28,720
there right to write a query to see

1042
00:38:28,720 --> 00:38:30,640
if this event if those have been

1043
00:38:30,640 --> 00:38:32,079
tampered with

1044
00:38:32,079 --> 00:38:34,160
and so we actually take it a step

1045
00:38:34,160 --> 00:38:35,359
further

1046
00:38:35,359 --> 00:38:37,119
with another artifact there is an

1047
00:38:37,119 --> 00:38:40,079
artifact called

1048
00:38:40,400 --> 00:38:44,240
event logs modification

1049
00:38:45,040 --> 00:38:47,920
and this is built into velociraptor

1050
00:38:47,920 --> 00:38:48,320
right

1051
00:38:48,320 --> 00:38:51,040
and so what this allows you to do is

1052
00:38:51,040 --> 00:38:51,760
basically

1053
00:38:51,760 --> 00:38:53,920
check not only the channel name to see

1054
00:38:53,920 --> 00:38:55,839
if it's been disabled but the provider

1055
00:38:55,839 --> 00:38:56,960
name as well

1056
00:38:56,960 --> 00:38:59,440
because all we're looking at here when

1057
00:38:59,440 --> 00:39:00,320
we look at

1058
00:39:00,320 --> 00:39:02,640
this is we're looking at the channel

1059
00:39:02,640 --> 00:39:03,680
right so

1060
00:39:03,680 --> 00:39:05,440
we see it's enabled here and we have the

1061
00:39:05,440 --> 00:39:08,160
option to disable the log here

1062
00:39:08,160 --> 00:39:11,200
but we really want to know right

1063
00:39:11,200 --> 00:39:13,359
it'd be more useful if we can check the

1064
00:39:13,359 --> 00:39:14,400
provider

1065
00:39:14,400 --> 00:39:16,480
because if we don't check the provider

1066
00:39:16,480 --> 00:39:19,359
and it still says the channel is enabled

1067
00:39:19,359 --> 00:39:20,800
then i wonder if we could be missing

1068
00:39:20,800 --> 00:39:22,560
something right let's

1069
00:39:22,560 --> 00:39:29,119
let's try that out so if we do

1070
00:39:29,119 --> 00:39:43,839
look at it

1071
00:39:45,920 --> 00:39:49,280
alrighty yes

1072
00:39:50,000 --> 00:39:51,680
all righty so let's just open up the

1073
00:39:51,680 --> 00:39:53,440
registry editor here and

1074
00:39:53,440 --> 00:39:55,040
let's see what that provider

1075
00:39:55,040 --> 00:39:57,040
configuration actually looks like

1076
00:39:57,040 --> 00:40:00,720
because again that

1077
00:40:00,720 --> 00:40:02,720
is actually going to be what controls

1078
00:40:02,720 --> 00:40:04,079
the underlying

1079
00:40:04,079 --> 00:40:07,119
production of events for that channel so

1080
00:40:07,119 --> 00:40:09,200
if we go in here and go under system

1081
00:40:09,200 --> 00:40:13,040
current control set control

1082
00:40:13,040 --> 00:40:16,720
and let me double check my path here

1083
00:40:16,720 --> 00:40:20,319
to be my whoops

1084
00:40:20,319 --> 00:40:25,839
come on

1085
00:40:27,200 --> 00:40:31,839
all right wmi auto logger should be

1086
00:40:31,839 --> 00:40:35,280
where is its uh event log

1087
00:40:35,280 --> 00:40:38,319
there it is right

1088
00:40:38,319 --> 00:40:40,000
now so what this is going to be

1089
00:40:40,000 --> 00:40:41,680
referenced by the squid it's going to be

1090
00:40:41,680 --> 00:40:44,560
relative to bits clients right so

1091
00:40:44,560 --> 00:40:46,319
whatever we saw when we were looking in

1092
00:40:46,319 --> 00:40:47,839
velociraptor

1093
00:40:47,839 --> 00:40:51,440
um in the notebook right whatever we saw

1094
00:40:51,440 --> 00:40:53,839
here

1095
00:40:53,839 --> 00:40:55,760
we saw this publisher right here this

1096
00:40:55,760 --> 00:40:59,119
grid so ef1 cc15b

1097
00:40:59,119 --> 00:41:02,240
if we find the equivalent in here this

1098
00:41:02,240 --> 00:41:03,520
would be down here since these are

1099
00:41:03,520 --> 00:41:06,800
alphabetical or alphanumerical

1100
00:41:06,800 --> 00:41:10,079
and if we look in here

1101
00:41:10,880 --> 00:41:14,240
this will be the

1102
00:41:14,240 --> 00:41:15,839
the enable property here will actually

1103
00:41:15,839 --> 00:41:17,280
be telling us if this

1104
00:41:17,280 --> 00:41:19,359
provider is enabled this is the bits

1105
00:41:19,359 --> 00:41:20,720
client provider

1106
00:41:20,720 --> 00:41:22,319
right so if we actually modify this

1107
00:41:22,319 --> 00:41:24,720
value

1108
00:41:26,240 --> 00:41:28,959
change that

1109
00:41:29,839 --> 00:41:33,280
now we will have to do a quick reboot

1110
00:41:33,280 --> 00:41:38,319
but i have no fear

1111
00:41:39,920 --> 00:41:42,160
and so in an adversary an attacker might

1112
00:41:42,160 --> 00:41:42,960
do this right

1113
00:41:42,960 --> 00:41:45,119
um obviously you know an unscheduled

1114
00:41:45,119 --> 00:41:46,880
reboot might be

1115
00:41:46,880 --> 00:41:49,359
kind of out of the ordinary um so they

1116
00:41:49,359 --> 00:41:50,160
may you know

1117
00:41:50,160 --> 00:41:52,079
may choose to do this and lay low for a

1118
00:41:52,079 --> 00:41:53,200
minute while

1119
00:41:53,200 --> 00:41:55,359
um you know while you receive windows

1120
00:41:55,359 --> 00:41:56,400
updates and it

1121
00:41:56,400 --> 00:41:58,079
updates from that right so there are

1122
00:41:58,079 --> 00:41:59,760
lots of opportunities here

1123
00:41:59,760 --> 00:42:02,640
um where this this could still come into

1124
00:42:02,640 --> 00:42:04,400
play

1125
00:42:04,400 --> 00:42:07,119
so we'll get this just a second here and

1126
00:42:07,119 --> 00:42:08,160
um

1127
00:42:08,160 --> 00:42:10,400
and just wait for this box to to reboot

1128
00:42:10,400 --> 00:42:11,520
it won't take too long

1129
00:42:11,520 --> 00:42:14,319
and then we'll see the effect of the

1130
00:42:14,319 --> 00:42:17,359
provider specific disablement

1131
00:42:17,359 --> 00:42:19,760
and see what we can do with from the

1132
00:42:19,760 --> 00:42:22,720
velociraptor perspective

1133
00:42:22,720 --> 00:42:31,839
give it just a second here

1134
00:42:43,119 --> 00:42:44,480
and while we're waiting on that i'm just

1135
00:42:44,480 --> 00:42:46,240
going to

1136
00:42:46,240 --> 00:42:50,240
go back over to the slides here

1137
00:42:50,560 --> 00:42:52,880
and

1138
00:42:54,240 --> 00:42:57,440
so i just want to to point this out real

1139
00:42:57,440 --> 00:42:58,000
quick just

1140
00:42:58,000 --> 00:43:01,440
um that's why we're here um again

1141
00:43:01,440 --> 00:43:03,040
you know while we wait for this if you

1142
00:43:03,040 --> 00:43:04,720
want to test velociraptor just

1143
00:43:04,720 --> 00:43:06,560
try that velociraptor gui command once

1144
00:43:06,560 --> 00:43:08,079
you pull down that binary

1145
00:43:08,079 --> 00:43:10,560
um there's a velociraptor docker project

1146
00:43:10,560 --> 00:43:11,520
as well

1147
00:43:11,520 --> 00:43:13,920
that i've been working on and then i

1148
00:43:13,920 --> 00:43:14,880
know jason

1149
00:43:14,880 --> 00:43:18,560
jason ostrom he's at sans he also has a

1150
00:43:18,560 --> 00:43:20,880
blue cloud and purple cloud

1151
00:43:20,880 --> 00:43:22,560
terraform deployment option so if you

1152
00:43:22,560 --> 00:43:25,599
want to spin velociraptor up

1153
00:43:25,599 --> 00:43:28,000
in the cloud there and experiment with

1154
00:43:28,000 --> 00:43:29,680
some you know some host-based forensics

1155
00:43:29,680 --> 00:43:30,400
and detection

1156
00:43:30,400 --> 00:43:32,560
and that sort of thing um it's pretty

1157
00:43:32,560 --> 00:43:33,599
awesome so definitely

1158
00:43:33,599 --> 00:43:36,800
definitely check that out and then also

1159
00:43:36,800 --> 00:43:38,480
this blog article and the blog in

1160
00:43:38,480 --> 00:43:39,280
general

1161
00:43:39,280 --> 00:43:42,079
velociraptors uh i'm sorry velocidex's

1162
00:43:42,079 --> 00:43:42,720
blog

1163
00:43:42,720 --> 00:43:45,359
for velociraptors is really great for

1164
00:43:45,359 --> 00:43:46,160
being able to

1165
00:43:46,160 --> 00:43:48,079
really understand uh even more what

1166
00:43:48,079 --> 00:43:49,839
velociraptor has to offer

1167
00:43:49,839 --> 00:43:51,040
because again this is really only

1168
00:43:51,040 --> 00:43:53,040
scratching the surface it's very hard to

1169
00:43:53,040 --> 00:43:54,800
to kind of go through all that

1170
00:43:54,800 --> 00:43:57,359
that functionality again um you know in

1171
00:43:57,359 --> 00:43:58,640
such a short amount of time so

1172
00:43:58,640 --> 00:44:00,240
definitely do check that out and do play

1173
00:44:00,240 --> 00:44:02,000
around with it

1174
00:44:02,000 --> 00:44:05,040
so let's check back and see our host all

1175
00:44:05,040 --> 00:44:05,520
right

1176
00:44:05,520 --> 00:44:09,839
it's coming up here

1177
00:44:12,240 --> 00:44:15,680
good just a little longer

1178
00:44:18,640 --> 00:44:21,280
and again uh you know i'll go ahead and

1179
00:44:21,280 --> 00:44:22,000
do this for

1180
00:44:22,000 --> 00:44:23,599
the the best use of time here because i

1181
00:44:23,599 --> 00:44:25,280
know we are are coming up at the

1182
00:44:25,280 --> 00:44:28,240
at the end of this here um feel free to

1183
00:44:28,240 --> 00:44:30,640
contact me at the real w lambert if

1184
00:44:30,640 --> 00:44:32,720
uh if you enjoyed the presentation or if

1185
00:44:32,720 --> 00:44:34,079
you want to learn anything else about

1186
00:44:34,079 --> 00:44:35,440
velociraptor or

1187
00:44:35,440 --> 00:44:36,960
or anything if i can answer any

1188
00:44:36,960 --> 00:44:39,720
questions my github is at

1189
00:44:39,720 --> 00:44:40,960
github.comwestlambert

1190
00:44:40,960 --> 00:44:43,440
and please be sure to feel free i'm

1191
00:44:43,440 --> 00:44:44,079
sorry

1192
00:44:44,079 --> 00:44:47,119
be sure to tweet at and follow

1193
00:44:47,119 --> 00:44:49,839
velocidex mike cohen again is doing some

1194
00:44:49,839 --> 00:44:51,520
really awesome stuff with the project

1195
00:44:51,520 --> 00:44:55,119
so uh please do give him a shout out at

1196
00:44:55,119 --> 00:44:56,880
how awesome the tool is and

1197
00:44:56,880 --> 00:45:00,480
and if you have any other ideas there

1198
00:45:00,880 --> 00:45:05,359
all right so our box is back up

1199
00:45:05,359 --> 00:45:07,760
all right so we disable that from the

1200
00:45:07,760 --> 00:45:08,960
provider specific

1201
00:45:08,960 --> 00:45:12,960
uh you know registry key and

1202
00:45:12,960 --> 00:45:14,960
we want to go back into velociraptor

1203
00:45:14,960 --> 00:45:17,119
real quick so i'm just going to launch a

1204
00:45:17,119 --> 00:45:20,319
powershell session real quick

1205
00:45:21,920 --> 00:45:25,920
powershell not power settings

1206
00:45:25,920 --> 00:45:28,240
all right

1207
00:45:29,359 --> 00:45:33,839
get that going

1208
00:45:51,600 --> 00:45:54,710
[Applause]

1209
00:45:55,040 --> 00:45:56,480
all right so that guy'll spin up here in

1210
00:45:56,480 --> 00:45:58,079
just a minute and then we'll also

1211
00:45:58,079 --> 00:46:01,839
spin up event viewer real quick

1212
00:46:06,319 --> 00:46:15,839
what's that guy

1213
00:46:26,839 --> 00:46:29,839
alrighty

1214
00:46:51,680 --> 00:46:57,839
alrighty don't need that

1215
00:47:02,240 --> 00:47:03,760
all right now real quick what i want to

1216
00:47:03,760 --> 00:47:05,520
demonstrate again

1217
00:47:05,520 --> 00:47:07,359
before we go here i know running up

1218
00:47:07,359 --> 00:47:10,079
against time

1219
00:47:10,079 --> 00:47:25,839
one more powershell session

1220
00:47:40,559 --> 00:47:44,480
and again your demo gods

1221
00:47:45,119 --> 00:47:53,839
all right expand that

1222
00:48:00,720 --> 00:48:07,839
come on chugging along

1223
00:48:33,680 --> 00:48:38,240
all right that's all right back here

1224
00:48:38,240 --> 00:48:41,680
okay now again if we run the bits admin

1225
00:48:41,680 --> 00:48:42,640
command

1226
00:48:42,640 --> 00:48:45,839
uh let me go ahead and expand the bits

1227
00:48:45,839 --> 00:48:46,839
clients

1228
00:48:46,839 --> 00:48:49,839
log just a second here keep

1229
00:48:49,839 --> 00:48:52,799
doing that by accident

1230
00:48:57,839 --> 00:49:00,079
severely underestimated i guess the the

1231
00:49:00,079 --> 00:49:02,079
streaming impact on the

1232
00:49:02,079 --> 00:49:05,599
performance here the vm okay

1233
00:49:05,599 --> 00:49:09,119
all right so if we go into twelve passer

1234
00:49:09,119 --> 00:49:12,400
all right bids client all right so

1235
00:49:12,400 --> 00:49:15,599
we see here once this loads we'll take a

1236
00:49:15,599 --> 00:49:16,000
look here

1237
00:49:16,000 --> 00:49:17,680
if we right click we can still see the

1238
00:49:17,680 --> 00:49:19,359
disable log function

1239
00:49:19,359 --> 00:49:21,760
so the log from our perspective still

1240
00:49:21,760 --> 00:49:22,960
looks like it's enabled

1241
00:49:22,960 --> 00:49:24,880
right but however we've disabled that

1242
00:49:24,880 --> 00:49:26,400
provider option

1243
00:49:26,400 --> 00:49:30,480
in the registry so we see this last

1244
00:49:30,480 --> 00:49:34,240
um this last invocation here at 349

1245
00:49:34,240 --> 00:49:35,680
which was just from the the updater

1246
00:49:35,680 --> 00:49:36,319
itself

1247
00:49:36,319 --> 00:49:38,640
since bits bits client is used for uh

1248
00:49:38,640 --> 00:49:39,839
you know windows update

1249
00:49:39,839 --> 00:49:42,720
kind of thing so we're going to run our

1250
00:49:42,720 --> 00:49:44,079
command again

1251
00:49:44,079 --> 00:49:46,160
the bits admin command to download our

1252
00:49:46,160 --> 00:49:47,920
evil powershell script

1253
00:49:47,920 --> 00:49:51,040
and we'll let that complete

1254
00:49:51,599 --> 00:49:53,280
and now we saw that this operational log

1255
00:49:53,280 --> 00:49:56,079
was enabled right so if we double check

1256
00:49:56,079 --> 00:50:00,400
all right it's enabled but if we refresh

1257
00:50:00,400 --> 00:50:02,640
here

1258
00:50:04,960 --> 00:50:08,079
[Music]

1259
00:50:10,839 --> 00:50:13,839
okay

1260
00:50:14,000 --> 00:50:16,160
well i think i i accidentally did the

1261
00:50:16,160 --> 00:50:18,800
wrong key there so

1262
00:50:18,800 --> 00:50:21,680
regard suffice it to say that um if you

1263
00:50:21,680 --> 00:50:22,960
actually disable the

1264
00:50:22,960 --> 00:50:26,160
the correct key there and the registry

1265
00:50:26,160 --> 00:50:28,319
the intention there is that the provider

1266
00:50:28,319 --> 00:50:30,400
itself can be disabled and it can appear

1267
00:50:30,400 --> 00:50:31,359
as though the

1268
00:50:31,359 --> 00:50:34,000
channel is enabled still but you will no

1269
00:50:34,000 --> 00:50:35,599
longer get those events

1270
00:50:35,599 --> 00:50:37,839
and we can use velociraptor to to get

1271
00:50:37,839 --> 00:50:40,400
that unfortunately i think we're

1272
00:50:40,400 --> 00:50:43,119
um out of i'm time here unless you guys

1273
00:50:43,119 --> 00:50:43,520
think

1274
00:50:43,520 --> 00:50:45,040
i can go a few more minutes uh it's

1275
00:50:45,040 --> 00:50:48,319
completely up to you guys but um

1276
00:50:48,319 --> 00:50:49,920
but that was really one of what i wanted

1277
00:50:49,920 --> 00:50:51,359
to demonstrate there was just the

1278
00:50:51,359 --> 00:50:53,920
the power of being able to to correlate

1279
00:50:53,920 --> 00:50:54,800
that and

1280
00:50:54,800 --> 00:50:57,280
and pull that information in so let me

1281
00:50:57,280 --> 00:50:58,160
let me

1282
00:50:58,160 --> 00:51:03,040
go ahead and double check the

1283
00:51:06,839 --> 00:51:09,839
registry

1284
00:51:16,240 --> 00:51:18,559
oh you know what i'm sorry i completely

1285
00:51:18,559 --> 00:51:20,240
skipped over it was actually the enabled

1286
00:51:20,240 --> 00:51:20,559
one

1287
00:51:20,559 --> 00:51:21,680
i guess that's what i get for doing a

1288
00:51:21,680 --> 00:51:23,760
live demo um so

1289
00:51:23,760 --> 00:51:26,000
so again it would be this this key here

1290
00:51:26,000 --> 00:51:27,599
and then so what we can do

1291
00:51:27,599 --> 00:51:30,800
with velociraptor is then um pull that

1292
00:51:30,800 --> 00:51:32,720
in

1293
00:51:32,720 --> 00:51:36,079
use this i'll show you the artifacts

1294
00:51:36,079 --> 00:51:38,240
here

1295
00:51:38,559 --> 00:51:42,000
oh did i kill it

1296
00:51:42,000 --> 00:51:45,760
oh no wrong one i killed it

1297
00:51:45,760 --> 00:51:50,079
right here i think

1298
00:51:50,079 --> 00:51:52,319
nope

1299
00:51:59,760 --> 00:52:02,160
surprising to say i won't take a tick up

1300
00:52:02,160 --> 00:52:03,440
anymore you guys this time

1301
00:52:03,440 --> 00:52:05,920
but um i will show you right here the

1302
00:52:05,920 --> 00:52:07,920
artifact that you can use to detect that

1303
00:52:07,920 --> 00:52:08,480
and mike

1304
00:52:08,480 --> 00:52:11,599
explains it uh much better and his

1305
00:52:11,599 --> 00:52:15,040
opposed to where he disables the correct

1306
00:52:15,040 --> 00:52:18,880
registry key i apologize for that um

1307
00:52:18,880 --> 00:52:21,839
notifications

1308
00:52:31,839 --> 00:52:35,839
right here okay so yeah so so basically

1309
00:52:35,839 --> 00:52:36,880
what you would do here

1310
00:52:36,880 --> 00:52:38,960
is you can search within a specific time

1311
00:52:38,960 --> 00:52:39,920
frame

1312
00:52:39,920 --> 00:52:42,960
or uh you know just of a specific log in

1313
00:52:42,960 --> 00:52:43,520
general

1314
00:52:43,520 --> 00:52:45,839
and uh then you can kind of correlate if

1315
00:52:45,839 --> 00:52:47,440
that provider is actually disabled or if

1316
00:52:47,440 --> 00:52:49,040
that channel has been disabled

1317
00:52:49,040 --> 00:52:50,800
then again monitor for that with

1318
00:52:50,800 --> 00:52:53,359
velociraptor and alert on that

1319
00:52:53,359 --> 00:52:55,359
so i'm not going to go back through

1320
00:52:55,359 --> 00:52:57,520
since we don't have much time left here

1321
00:52:57,520 --> 00:52:59,200
but feel free again if you have any

1322
00:52:59,200 --> 00:53:00,640
other questions and

1323
00:53:00,640 --> 00:53:03,280
or any comments about my failed demo

1324
00:53:03,280 --> 00:53:04,160
here

1325
00:53:04,160 --> 00:53:07,040
feel free to let me know and i will be

1326
00:53:07,040 --> 00:53:09,040
glad to respond and help you out as best

1327
00:53:09,040 --> 00:53:11,359
i can

1328
00:53:13,200 --> 00:53:16,079
once again uh feel free to contact me at

1329
00:53:16,079 --> 00:53:17,520
the real w lambert

1330
00:53:17,520 --> 00:53:20,480
and then follow at velocidex uh mike i

1331
00:53:20,480 --> 00:53:29,839
apologize for the failed demo

1332
00:53:31,200 --> 00:53:33,279
you

