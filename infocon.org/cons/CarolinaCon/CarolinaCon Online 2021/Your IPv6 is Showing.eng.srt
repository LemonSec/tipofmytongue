1
00:00:00,960 --> 00:00:02,399
hello everybody and thank you for

2
00:00:02,399 --> 00:00:04,319
virtually tuning in to my talk my name

3
00:00:04,319 --> 00:00:05,279
is matt schmidt

4
00:00:05,279 --> 00:00:07,120
first off i'd like to thank carolinacon

5
00:00:07,120 --> 00:00:08,639
for putting this all together virtually

6
00:00:08,639 --> 00:00:10,400
i'm sure it was not easy

7
00:00:10,400 --> 00:00:13,200
um and i can't wait till we get back in

8
00:00:13,200 --> 00:00:14,719
person and can all nerd out again

9
00:00:14,719 --> 00:00:15,759
together

10
00:00:15,759 --> 00:00:17,440
but until then i'm just happy that i

11
00:00:17,440 --> 00:00:19,279
have a platform where i can share

12
00:00:19,279 --> 00:00:20,240
something that i found

13
00:00:20,240 --> 00:00:22,000
very interesting i think others will as

14
00:00:22,000 --> 00:00:24,320
well there's actually a talk

15
00:00:24,320 --> 00:00:26,080
that i submitted last year which was

16
00:00:26,080 --> 00:00:27,680
approved but unfortunately due to the

17
00:00:27,680 --> 00:00:29,359
pandemic was cancelled

18
00:00:29,359 --> 00:00:31,519
fortunately however this talk has

19
00:00:31,519 --> 00:00:33,280
greatly improved since then so this is a

20
00:00:33,280 --> 00:00:34,640
much better version of what would have

21
00:00:34,640 --> 00:00:36,719
been presented last year

22
00:00:36,719 --> 00:00:38,640
but anyway i do have some bad news for

23
00:00:38,640 --> 00:00:42,079
some people your ipv6 is showing

24
00:00:42,079 --> 00:00:44,640
so before we jump into the content do a

25
00:00:44,640 --> 00:00:45,200
little who

26
00:00:45,200 --> 00:00:48,000
am i uh on that previous slide there uh

27
00:00:48,000 --> 00:00:50,000
my official title is security engineer

28
00:00:50,000 --> 00:00:51,360
but i'm essentially just a penetration

29
00:00:51,360 --> 00:00:52,079
tester

30
00:00:52,079 --> 00:00:54,000
at triaxium security which is a company

31
00:00:54,000 --> 00:00:56,239
here in charlotte north carolina

32
00:00:56,239 --> 00:00:57,920
i'm meet-up founder and organizer of

33
00:00:57,920 --> 00:00:59,520
queen city skitties which is a once a

34
00:00:59,520 --> 00:01:00,480
month uh

35
00:01:00,480 --> 00:01:02,239
group where we like to meet up and kind

36
00:01:02,239 --> 00:01:04,559
of uh talk about offensive security

37
00:01:04,559 --> 00:01:06,560
related topics however

38
00:01:06,560 --> 00:01:08,560
since we're all nerds we like to just

39
00:01:08,560 --> 00:01:10,880
talk tech in general so we've had

40
00:01:10,880 --> 00:01:13,040
some pretty cool talks like home

41
00:01:13,040 --> 00:01:14,320
automation

42
00:01:14,320 --> 00:01:16,960
hacking hospitals uh defending uh

43
00:01:16,960 --> 00:01:18,960
hospitals against adversaries

44
00:01:18,960 --> 00:01:20,560
and we just have a lot of people come

45
00:01:20,560 --> 00:01:22,320
from all different backgrounds like

46
00:01:22,320 --> 00:01:24,560
hobbyists students professionals

47
00:01:24,560 --> 00:01:26,560
entrepreneurs so definitely encourage

48
00:01:26,560 --> 00:01:29,040
anyone to come on out to that

49
00:01:29,040 --> 00:01:30,799
i am a military veteran i was in the

50
00:01:30,799 --> 00:01:32,320
united states marine corps for four

51
00:01:32,320 --> 00:01:34,240
years as a mortarman

52
00:01:34,240 --> 00:01:36,159
i am a future cyber truck owner and i

53
00:01:36,159 --> 00:01:37,600
throw this in there because i used to

54
00:01:37,600 --> 00:01:38,320
think it was

55
00:01:38,320 --> 00:01:40,880
super ugly and now it's grown on me and

56
00:01:40,880 --> 00:01:42,479
i like to talk to anyone who

57
00:01:42,479 --> 00:01:44,240
is considering getting one or has a

58
00:01:44,240 --> 00:01:46,320
reservation for one

59
00:01:46,320 --> 00:01:48,399
i am a bourbon enthusiast i have a

60
00:01:48,399 --> 00:01:50,079
little collection going on here that you

61
00:01:50,079 --> 00:01:51,520
can see

62
00:01:51,520 --> 00:01:53,439
uh and then on to the boring stuff i

63
00:01:53,439 --> 00:01:55,360
have a bachelor's in information

64
00:01:55,360 --> 00:01:56,799
technology

65
00:01:56,799 --> 00:02:01,600
my oscp ewpt and sec plus

66
00:02:01,600 --> 00:02:03,200
so let's talk about what we're going to

67
00:02:03,200 --> 00:02:04,799
see here in a little bit we're going to

68
00:02:04,799 --> 00:02:06,960
do a quick ipv6 overview

69
00:02:06,960 --> 00:02:08,800
a story time which kind of prompted this

70
00:02:08,800 --> 00:02:10,720
entire talk to exist

71
00:02:10,720 --> 00:02:12,879
uh and then we'll do some considerations

72
00:02:12,879 --> 00:02:14,560
for an external pen test

73
00:02:14,560 --> 00:02:16,400
on the for both the attack and defense

74
00:02:16,400 --> 00:02:18,000
side of things as well as for an

75
00:02:18,000 --> 00:02:19,599
internal penetration test when dealing

76
00:02:19,599 --> 00:02:21,360
with ipv6

77
00:02:21,360 --> 00:02:22,879
uh and then we'll wrap everything up

78
00:02:22,879 --> 00:02:25,760
with the conclusion at the end

79
00:02:25,760 --> 00:02:29,120
so very brief ipv6 overview the ip

80
00:02:29,120 --> 00:02:31,200
address space is managed globally by the

81
00:02:31,200 --> 00:02:33,120
internet assigned numbers authority or

82
00:02:33,120 --> 00:02:34,640
the iana

83
00:02:34,640 --> 00:02:36,239
and there were five regional internet

84
00:02:36,239 --> 00:02:38,080
registries which you can see here on the

85
00:02:38,080 --> 00:02:39,120
map

86
00:02:39,120 --> 00:02:41,920
uh one of these being the ripe ncc which

87
00:02:41,920 --> 00:02:44,480
is officially run out of ipv4 addresses

88
00:02:44,480 --> 00:02:46,640
in november of 2019.

89
00:02:46,640 --> 00:02:48,400
now there should be a little asterisk

90
00:02:48,400 --> 00:02:50,160
there because

91
00:02:50,160 --> 00:02:52,800
while they have officially run out each

92
00:02:52,800 --> 00:02:53,519
rir

93
00:02:53,519 --> 00:02:55,920
can still allocate recovered ip

94
00:02:55,920 --> 00:02:56,560
addresses

95
00:02:56,560 --> 00:02:59,760
and addresses reserved for a special

96
00:02:59,760 --> 00:03:00,640
purpose

97
00:03:00,640 --> 00:03:02,720
and additionally individual internet

98
00:03:02,720 --> 00:03:04,080
service providers

99
00:03:04,080 --> 00:03:06,640
still have pools of unassigned ips and

100
00:03:06,640 --> 00:03:09,280
they have the ability to recycle

101
00:03:09,280 --> 00:03:11,840
old ip addresses that are no longer used

102
00:03:11,840 --> 00:03:13,280
by subscribers so

103
00:03:13,280 --> 00:03:15,200
while they have run out they can still

104
00:03:15,200 --> 00:03:16,400
allocate ips

105
00:03:16,400 --> 00:03:19,440
um but this does uh

106
00:03:19,440 --> 00:03:21,519
present as a concern and which is why

107
00:03:21,519 --> 00:03:23,200
ipv6 was created

108
00:03:23,200 --> 00:03:27,120
to begin with so let's do a a little

109
00:03:27,120 --> 00:03:31,760
breakdown of ipv6 versus ipv4

110
00:03:31,760 --> 00:03:35,280
ipv6 uses 128 bits format and

111
00:03:35,280 --> 00:03:36,959
hexadecimal

112
00:03:36,959 --> 00:03:38,400
grouped in four is giving eight groups

113
00:03:38,400 --> 00:03:40,560
or blocks and it can be shortened

114
00:03:40,560 --> 00:03:42,640
so you can see here while it can be

115
00:03:42,640 --> 00:03:43,920
shortened

116
00:03:43,920 --> 00:03:46,400
still very confusing and long but

117
00:03:46,400 --> 00:03:47,920
because of that

118
00:03:47,920 --> 00:03:51,680
it allows for a ton of ipv6 addresses to

119
00:03:51,680 --> 00:03:53,120
be available and i

120
00:03:53,120 --> 00:03:55,280
encourage anyone to go on google and

121
00:03:55,280 --> 00:03:56,480
just look up the

122
00:03:56,480 --> 00:03:59,519
sheer number of ipv6 addresses that are

123
00:03:59,519 --> 00:04:00,400
possible

124
00:04:00,400 --> 00:04:01,840
it's a lot and we're not going to run

125
00:04:01,840 --> 00:04:04,879
out now ipv4

126
00:04:04,879 --> 00:04:07,599
uses 32 bits format and dotted decimal

127
00:04:07,599 --> 00:04:09,519
and will likely eventually run out so

128
00:04:09,519 --> 00:04:12,080
that is why we have ipv6

129
00:04:12,080 --> 00:04:14,720
i think people would be very surprised

130
00:04:14,720 --> 00:04:15,120
to

131
00:04:15,120 --> 00:04:17,279
know that organizations are starting to

132
00:04:17,279 --> 00:04:18,880
roll out ipv6

133
00:04:18,880 --> 00:04:21,358
so um it is something that you should

134
00:04:21,358 --> 00:04:22,639
not be afraid of you should be

135
00:04:22,639 --> 00:04:24,320
comfortable with seeing one

136
00:04:24,320 --> 00:04:25,600
and we're going to kind of talk a little

137
00:04:25,600 --> 00:04:28,479
bit about that so let's do a little

138
00:04:28,479 --> 00:04:30,720
story time it was 2019 just got hired as

139
00:04:30,720 --> 00:04:32,960
a pen tester i'm feeling really cool at

140
00:04:32,960 --> 00:04:33,840
the time

141
00:04:33,840 --> 00:04:37,199
uh just got done with my oscp and some

142
00:04:37,199 --> 00:04:38,720
other courses so i feel like i could

143
00:04:38,720 --> 00:04:39,919
take on the world

144
00:04:39,919 --> 00:04:41,440
i just got assigned an external

145
00:04:41,440 --> 00:04:43,040
penetration test and i'm ready to rock

146
00:04:43,040 --> 00:04:44,400
and roll there

147
00:04:44,400 --> 00:04:47,120
uh reviewing the scope provided by the

148
00:04:47,120 --> 00:04:48,320
client and i see

149
00:04:48,320 --> 00:04:51,360
this uh and

150
00:04:51,360 --> 00:04:53,600
that's basically my face at that point

151
00:04:53,600 --> 00:04:55,840
never seen ipv6 addresses used in the

152
00:04:55,840 --> 00:04:56,560
wild

153
00:04:56,560 --> 00:04:58,400
didn't know what to do with that don't

154
00:04:58,400 --> 00:05:00,560
know how to test against one

155
00:05:00,560 --> 00:05:02,080
the courses that i took didn't really

156
00:05:02,080 --> 00:05:03,600
talk about how to do that from

157
00:05:03,600 --> 00:05:06,880
an external penetration test standpoint

158
00:05:06,880 --> 00:05:10,000
so i'm dumbfounded so this leads me into

159
00:05:10,000 --> 00:05:13,520
our next kind of uh you know topic here

160
00:05:13,520 --> 00:05:15,919
research um if you want to be a

161
00:05:15,919 --> 00:05:17,600
penetration tester let alone just a

162
00:05:17,600 --> 00:05:18,320
professional

163
00:05:18,320 --> 00:05:21,680
in the infosec world continuous learning

164
00:05:21,680 --> 00:05:23,039
and research is vital

165
00:05:23,039 --> 00:05:24,960
you need to always be learning new

166
00:05:24,960 --> 00:05:26,560
topics tools techniques

167
00:05:26,560 --> 00:05:28,639
um plus it's a lot of fun to learn new

168
00:05:28,639 --> 00:05:30,160
ways to hack people

169
00:05:30,160 --> 00:05:31,759
but a good penetration tester should

170
00:05:31,759 --> 00:05:33,360
always understand what they're doing

171
00:05:33,360 --> 00:05:34,720
before they do it

172
00:05:34,720 --> 00:05:36,560
so what that kind of you know can look

173
00:05:36,560 --> 00:05:38,000
like one way i

174
00:05:38,000 --> 00:05:40,320
learn really well is by someone

175
00:05:40,320 --> 00:05:42,080
explaining things to me and breaking it

176
00:05:42,080 --> 00:05:43,680
down and doing whiteboarding

177
00:05:43,680 --> 00:05:45,280
where we get up walk over to a

178
00:05:45,280 --> 00:05:46,960
whiteboard and literally draw everything

179
00:05:46,960 --> 00:05:47,840
out

180
00:05:47,840 --> 00:05:50,960
talk about it step by step great way

181
00:05:50,960 --> 00:05:53,919
to understand every step of the way why

182
00:05:53,919 --> 00:05:54,639
things work

183
00:05:54,639 --> 00:05:57,680
and how they work um always ask ask

184
00:05:57,680 --> 00:05:58,479
someone with

185
00:05:58,479 --> 00:06:00,560
experience um for an explanation on

186
00:06:00,560 --> 00:06:01,600
something

187
00:06:01,600 --> 00:06:04,400
in my case for these ipv6 addresses i

188
00:06:04,400 --> 00:06:05,680
asked some of my

189
00:06:05,680 --> 00:06:07,840
more experienced co-workers and nobody

190
00:06:07,840 --> 00:06:09,280
has ever seen them

191
00:06:09,280 --> 00:06:12,560
everyone said i have no idea good luck

192
00:06:12,560 --> 00:06:15,919
um so this led me to creating a lab

193
00:06:15,919 --> 00:06:17,039
environment

194
00:06:17,039 --> 00:06:20,080
aws is awesome for quick lab building

195
00:06:20,080 --> 00:06:21,360
and breakdown

196
00:06:21,360 --> 00:06:24,639
uh i'm i was able to create a whole a

197
00:06:24,639 --> 00:06:26,800
little ipv6 network

198
00:06:26,800 --> 00:06:28,720
some victim machines and attacking

199
00:06:28,720 --> 00:06:32,319
machine and it was perfect for that

200
00:06:32,319 --> 00:06:35,919
so let's talk about what works um

201
00:06:35,919 --> 00:06:37,919
how things work and then we'll talk

202
00:06:37,919 --> 00:06:39,280
about what doesn't work

203
00:06:39,280 --> 00:06:42,160
so some tools work with ipv6 and some do

204
00:06:42,160 --> 00:06:42,960
not

205
00:06:42,960 --> 00:06:45,600
um additionally you are gonna have to

206
00:06:45,600 --> 00:06:47,120
have your equipment configured

207
00:06:47,120 --> 00:06:49,039
for ipv6 so that you can even

208
00:06:49,039 --> 00:06:51,599
communicate with other ipv6 addresses

209
00:06:51,599 --> 00:06:53,280
so that might look like configuring your

210
00:06:53,280 --> 00:06:54,800
router

211
00:06:54,800 --> 00:06:56,880
and switches and other networking gear

212
00:06:56,880 --> 00:06:58,160
and if you don't want to go through all

213
00:06:58,160 --> 00:07:01,360
that or you kind of can't do all that

214
00:07:01,360 --> 00:07:04,639
then like i used consider doing aws

215
00:07:04,639 --> 00:07:05,440
where you can

216
00:07:05,440 --> 00:07:08,720
create ipv6 public addresses super easy

217
00:07:08,720 --> 00:07:12,720
um and figure out how that all works

218
00:07:12,720 --> 00:07:16,080
um so tools that do work out of the box

219
00:07:16,080 --> 00:07:19,199
nmap and wordpress scan work great

220
00:07:19,199 --> 00:07:22,080
nmap you can simply do the dash 6

221
00:07:22,080 --> 00:07:24,000
provided that ip address

222
00:07:24,000 --> 00:07:25,599
with wp scan it's a little different

223
00:07:25,599 --> 00:07:27,759
you're going to have to provide that url

224
00:07:27,759 --> 00:07:28,560
flag

225
00:07:28,560 --> 00:07:30,800
and then you need to put your ipv6

226
00:07:30,800 --> 00:07:33,440
around in brackets when you do that

227
00:07:33,440 --> 00:07:36,080
so uh let's look at you'll see what that

228
00:07:36,080 --> 00:07:37,840
looks like so wp scan again

229
00:07:37,840 --> 00:07:39,280
got that url flag that you're going to

230
00:07:39,280 --> 00:07:40,800
provide to it and then you're going to

231
00:07:40,800 --> 00:07:42,479
provide the ipv6

232
00:07:42,479 --> 00:07:44,080
in those brackets it looks a little

233
00:07:44,080 --> 00:07:46,000
weird but it works

234
00:07:46,000 --> 00:07:48,639
you can go ahead and scan some wordpress

235
00:07:48,639 --> 00:07:49,280
sites

236
00:07:49,280 --> 00:07:53,039
just fine doing that uh nmap

237
00:07:53,039 --> 00:07:55,440
very easy just provided that dash six

238
00:07:55,440 --> 00:07:56,080
flag

239
00:07:56,080 --> 00:07:57,280
and all the other flags that you would

240
00:07:57,280 --> 00:07:59,599
normally do on your nmap scan

241
00:07:59,599 --> 00:08:01,039
and you do not need to put it around

242
00:08:01,039 --> 00:08:02,800
brackets it knows how uh

243
00:08:02,800 --> 00:08:04,879
it knows what an ipv6 address looks like

244
00:08:04,879 --> 00:08:06,160
and how uh

245
00:08:06,160 --> 00:08:09,280
to make that work

246
00:08:09,280 --> 00:08:12,080
so let's talk about what doesn't work so

247
00:08:12,080 --> 00:08:13,840
options for tools that don't natively

248
00:08:13,840 --> 00:08:14,560
support

249
00:08:14,560 --> 00:08:17,919
ipv6 uh one great way is find somebody

250
00:08:17,919 --> 00:08:19,360
who already did it

251
00:08:19,360 --> 00:08:22,639
um you know there's a lot of people who

252
00:08:22,639 --> 00:08:23,840
are starting to stumble across

253
00:08:23,840 --> 00:08:26,960
ipv6 addresses and because of that

254
00:08:26,960 --> 00:08:28,960
they are finding the same thing some

255
00:08:28,960 --> 00:08:30,479
tools don't work and they're creating

256
00:08:30,479 --> 00:08:32,320
their own version so go on github

257
00:08:32,320 --> 00:08:34,958
or go on google or github and search for

258
00:08:34,958 --> 00:08:37,679
example a new for linux ipv6

259
00:08:37,679 --> 00:08:40,958
somebody made an ipv6 ready version of

260
00:08:40,958 --> 00:08:43,919
that which is linked right there

261
00:08:43,919 --> 00:08:45,839
if it does not exist consider making

262
00:08:45,839 --> 00:08:47,760
your own ipv6 enabled tool

263
00:08:47,760 --> 00:08:49,200
if you have the time knowledge and

264
00:08:49,200 --> 00:08:52,480
resources go ahead and make a tool

265
00:08:52,480 --> 00:08:54,320
share it on github and help everybody

266
00:08:54,320 --> 00:08:56,640
out and even if you don't have the

267
00:08:56,640 --> 00:08:58,240
knowledge for it consider

268
00:08:58,240 --> 00:08:59,680
making it anyway because you're going to

269
00:08:59,680 --> 00:09:01,360
learn how

270
00:09:01,360 --> 00:09:04,480
uh you know to make it uh from that so

271
00:09:04,480 --> 00:09:07,600
great learning experience you can use a

272
00:09:07,600 --> 00:09:09,519
tool like socat to forward and receive

273
00:09:09,519 --> 00:09:12,320
ipv6 requests through your localhost

274
00:09:12,320 --> 00:09:13,680
and this is going to look really

275
00:09:13,680 --> 00:09:15,040
confusing but i'm going to go on to the

276
00:09:15,040 --> 00:09:17,360
next slide and kind of explain that

277
00:09:17,360 --> 00:09:20,160
so essentially what we're doing here is

278
00:09:20,160 --> 00:09:21,360
we're using socat

279
00:09:21,360 --> 00:09:23,760
to which establishes two bi-directional

280
00:09:23,760 --> 00:09:25,760
byte streams and transfers data between

281
00:09:25,760 --> 00:09:26,560
them

282
00:09:26,560 --> 00:09:30,000
so what we're essentially doing is

283
00:09:30,000 --> 00:09:33,680
we can scan an ipv6 address by scanning

284
00:09:33,680 --> 00:09:34,399
ourself

285
00:09:34,399 --> 00:09:37,519
so looking at this over here

286
00:09:37,519 --> 00:09:40,399
uh we can see we're setting up a tcp for

287
00:09:40,399 --> 00:09:41,040
listen

288
00:09:41,040 --> 00:09:44,399
on port 80 which is us and we are going

289
00:09:44,399 --> 00:09:45,440
to

290
00:09:45,440 --> 00:09:47,839
transfer any traffic between that ipv6

291
00:09:47,839 --> 00:09:50,399
address through ourself so then you can

292
00:09:50,399 --> 00:09:51,760
go ahead and run nicto

293
00:09:51,760 --> 00:09:53,120
and you're literally just scanning

294
00:09:53,120 --> 00:09:55,519
yourself on port 80.

295
00:09:55,519 --> 00:09:57,839
it works it's weird not all tools will

296
00:09:57,839 --> 00:09:59,279
work with it i believe

297
00:09:59,279 --> 00:10:02,880
uh you know durbuster wasn't working too

298
00:10:02,880 --> 00:10:03,519
well

299
00:10:03,519 --> 00:10:06,160
with that but um some tools will work

300
00:10:06,160 --> 00:10:08,320
and if you need to use that you can

301
00:10:08,320 --> 00:10:11,920
um keep in mind you were gonna see a lot

302
00:10:11,920 --> 00:10:13,440
of traffic spitting out

303
00:10:13,440 --> 00:10:15,760
through that socat command and that's

304
00:10:15,760 --> 00:10:17,760
just a big eye opener of how loud and

305
00:10:17,760 --> 00:10:20,320
noisy your tools are

306
00:10:20,320 --> 00:10:23,040
another tool is hydra hydra supports

307
00:10:23,040 --> 00:10:24,800
ipv6 out of the box which kind of

308
00:10:24,800 --> 00:10:27,440
surprised me with uh the dash six flag

309
00:10:27,440 --> 00:10:29,040
you can see an example here of me

310
00:10:29,040 --> 00:10:32,079
password spraying and rdp login

311
00:10:32,079 --> 00:10:34,880
against the demo admin account and their

312
00:10:34,880 --> 00:10:36,880
password was password123

313
00:10:36,880 --> 00:10:39,040
um not uncommon to see weak passwords in

314
00:10:39,040 --> 00:10:40,560
the wild and then i went ahead and

315
00:10:40,560 --> 00:10:43,440
logged into that server

316
00:10:43,440 --> 00:10:46,160
so let's talk why this all matters

317
00:10:46,160 --> 00:10:47,440
attack surface might be

318
00:10:47,440 --> 00:10:50,800
wildly different between ipv4 and ipv6

319
00:10:50,800 --> 00:10:53,680
addresses on the same exact host

320
00:10:53,680 --> 00:10:56,480
very important as a penetration tester

321
00:10:56,480 --> 00:10:58,079
to cover all your bases

322
00:10:58,079 --> 00:10:59,600
because you do not want to fail your

323
00:10:59,600 --> 00:11:00,959
client you want to give them full

324
00:11:00,959 --> 00:11:01,600
coverage

325
00:11:01,600 --> 00:11:03,360
because if you miss it someone else

326
00:11:03,360 --> 00:11:04,640
might catch it and then

327
00:11:04,640 --> 00:11:06,480
they can get uh you know hacked or

328
00:11:06,480 --> 00:11:07,839
compromised potentially

329
00:11:07,839 --> 00:11:10,480
so we do not want that we want full

330
00:11:10,480 --> 00:11:11,600
coverage so

331
00:11:11,600 --> 00:11:14,240
looking at this a mess uh enumeration

332
00:11:14,240 --> 00:11:15,360
here

333
00:11:15,360 --> 00:11:19,000
we are gonna output the ip on the domain

334
00:11:19,000 --> 00:11:20,880
hacker1.com

335
00:11:20,880 --> 00:11:23,519
uh you can see here they have ipv4 and

336
00:11:23,519 --> 00:11:25,120
ipv6 addresses i'm

337
00:11:25,120 --> 00:11:27,760
the same exact host and then let's look

338
00:11:27,760 --> 00:11:29,519
at this nmap scan below

339
00:11:29,519 --> 00:11:33,120
so what we're looking at here is a ipv6

340
00:11:33,120 --> 00:11:34,320
version on the top

341
00:11:34,320 --> 00:11:38,320
ipv4 version on the bottom uh this ipv6

342
00:11:38,320 --> 00:11:40,560
scan is showing ports 80 445

343
00:11:40,560 --> 00:11:44,079
3389 and fifty nine eighty five open

344
00:11:44,079 --> 00:11:47,680
uh very bad and the uh scan below that

345
00:11:47,680 --> 00:11:48,959
is only showing port 80.

346
00:11:48,959 --> 00:11:51,920
so this is very similar to what i saw on

347
00:11:51,920 --> 00:11:52,399
uh

348
00:11:52,399 --> 00:11:55,519
my assessment uh i scanned a host and

349
00:11:55,519 --> 00:11:56,000
all i saw

350
00:11:56,000 --> 00:11:59,040
was i believe 80 and 443 i scanned it

351
00:11:59,040 --> 00:12:01,279
again and i saw a whole lot of more

352
00:12:01,279 --> 00:12:04,399
uh ports and services including 445

353
00:12:04,399 --> 00:12:07,760
uh being smb and 3389 being rdp

354
00:12:07,760 --> 00:12:09,279
you should never be exposed to the

355
00:12:09,279 --> 00:12:12,000
internet so very bad

356
00:12:12,000 --> 00:12:13,920
this client was not aware that they had

357
00:12:13,920 --> 00:12:15,519
all these extra uh

358
00:12:15,519 --> 00:12:17,120
ports and services exposed to the

359
00:12:17,120 --> 00:12:19,120
internet on their ipv6 host

360
00:12:19,120 --> 00:12:22,639
or ip address rather so let's talk some

361
00:12:22,639 --> 00:12:24,240
key takeaways so not all

362
00:12:24,240 --> 00:12:27,279
tools support ipv6 addresses

363
00:12:27,279 --> 00:12:29,120
you might need to find a workaround or

364
00:12:29,120 --> 00:12:30,320
make a tool that uh

365
00:12:30,320 --> 00:12:33,440
you know works with ipv6 um

366
00:12:33,440 --> 00:12:35,120
these addresses are for men in such a

367
00:12:35,120 --> 00:12:36,560
way that you'll often need to put them

368
00:12:36,560 --> 00:12:37,680
in brackets

369
00:12:37,680 --> 00:12:39,279
here's an example of what that would

370
00:12:39,279 --> 00:12:41,440
look like if you were accessing it in a

371
00:12:41,440 --> 00:12:43,760
web browser

372
00:12:43,760 --> 00:12:46,880
an ipv6 may be revealing more ports than

373
00:12:46,880 --> 00:12:48,480
intended and necessary versus

374
00:12:48,480 --> 00:12:51,519
its ipv4 address on the same exact host

375
00:12:51,519 --> 00:12:53,360
so like this iceberg you want to keep

376
00:12:53,360 --> 00:12:54,959
all those ports and services

377
00:12:54,959 --> 00:12:57,760
below the surface behind that firewall

378
00:12:57,760 --> 00:12:59,839
and really limit your exposure

379
00:12:59,839 --> 00:13:02,800
you do not need to be exposing smb and

380
00:13:02,800 --> 00:13:06,399
rdp open

381
00:13:06,399 --> 00:13:08,000
really important to check your firewall

382
00:13:08,000 --> 00:13:09,440
rules as i just mentioned what are you

383
00:13:09,440 --> 00:13:10,000
aligning

384
00:13:10,000 --> 00:13:11,920
in and out on ipv6 so that you're not

385
00:13:11,920 --> 00:13:14,000
allowing in and out on ipv4

386
00:13:14,000 --> 00:13:16,160
you want to eliminate that low hanging

387
00:13:16,160 --> 00:13:18,720
fruit and make it harder for an attacker

388
00:13:18,720 --> 00:13:22,320
if you're using aws it is super easy i

389
00:13:22,320 --> 00:13:23,360
think i learned

390
00:13:23,360 --> 00:13:26,160
aws security rules in probably five

391
00:13:26,160 --> 00:13:26,959
minutes

392
00:13:26,959 --> 00:13:30,639
um it is incredibly easy to just

393
00:13:30,639 --> 00:13:32,639
set all of that up and block things that

394
00:13:32,639 --> 00:13:35,839
should not be getting in and out

395
00:13:36,000 --> 00:13:39,120
okay so let's move forward on the

396
00:13:39,120 --> 00:13:39,920
internal pen

397
00:13:39,920 --> 00:13:42,000
side of things what is an internal

398
00:13:42,000 --> 00:13:43,600
penetration test though

399
00:13:43,600 --> 00:13:45,440
uh we're essentially looking at what an

400
00:13:45,440 --> 00:13:47,199
attacker can do from inside of your

401
00:13:47,199 --> 00:13:48,079
network

402
00:13:48,079 --> 00:13:49,600
what can an attacker do if they simply

403
00:13:49,600 --> 00:13:51,760
connect a laptop or a dropbox with no

404
00:13:51,760 --> 00:13:52,800
privileges

405
00:13:52,800 --> 00:13:54,399
uh what kind of information can they

406
00:13:54,399 --> 00:13:56,399
exfiltrate essentially what can an

407
00:13:56,399 --> 00:13:57,279
attacker

408
00:13:57,279 --> 00:13:59,199
a hacker do inside of your corporate

409
00:13:59,199 --> 00:14:01,440
network

410
00:14:01,440 --> 00:14:03,920
so ipv6 you know let me back up and

411
00:14:03,920 --> 00:14:04,560
explain

412
00:14:04,560 --> 00:14:08,160
what windows did with ipv6 um it makes

413
00:14:08,160 --> 00:14:09,519
sense however

414
00:14:09,519 --> 00:14:13,600
uh windows machines since windows vista

415
00:14:13,600 --> 00:14:16,639
have ips ipv6 enabled by default and it

416
00:14:16,639 --> 00:14:18,560
is favored by default

417
00:14:18,560 --> 00:14:21,600
um windows saw an opportunity

418
00:14:21,600 --> 00:14:24,160
uh that ipv6 would be rolling out

419
00:14:24,160 --> 00:14:25,440
eventually and they wanted to get ahead

420
00:14:25,440 --> 00:14:27,199
of the game so that all of their devices

421
00:14:27,199 --> 00:14:29,519
would be ready for that big switch

422
00:14:29,519 --> 00:14:31,680
um however because of that a lot of

423
00:14:31,680 --> 00:14:33,120
people are not aware

424
00:14:33,120 --> 00:14:35,600
that ipv6 is actually enabled and

425
00:14:35,600 --> 00:14:37,839
favored by default on their machines

426
00:14:37,839 --> 00:14:41,120
which leaves a big security gap um

427
00:14:41,120 --> 00:14:45,600
so responder uh which does llm and r and

428
00:14:45,600 --> 00:14:46,800
nbns spoofing

429
00:14:46,800 --> 00:14:48,800
is more and more starting to get uh

430
00:14:48,800 --> 00:14:50,880
increasingly remediated by companies

431
00:14:50,880 --> 00:14:52,720
because they are doing penetration tests

432
00:14:52,720 --> 00:14:54,240
uh year in and year out and they are

433
00:14:54,240 --> 00:14:56,399
learning that this is a very easy win

434
00:14:56,399 --> 00:14:58,079
for attackers so they're starting to

435
00:14:58,079 --> 00:14:59,600
button up their security

436
00:14:59,600 --> 00:15:01,920
and remediate that so while responder

437
00:15:01,920 --> 00:15:04,000
might not work anymore for you

438
00:15:04,000 --> 00:15:05,920
man the middlesex is to the rescue and

439
00:15:05,920 --> 00:15:08,160
will likely work

440
00:15:08,160 --> 00:15:10,480
so before we talk about what it can do

441
00:15:10,480 --> 00:15:11,360
let's talk about

442
00:15:11,360 --> 00:15:14,079
how does it work man the middle 6 will

443
00:15:14,079 --> 00:15:16,639
advertise ipv6 is available across the

444
00:15:16,639 --> 00:15:17,519
network

445
00:15:17,519 --> 00:15:21,040
or domain it will respond to dhcp

446
00:15:21,040 --> 00:15:23,760
version 6 requests and assign victims an

447
00:15:23,760 --> 00:15:24,639
ipv6

448
00:15:24,639 --> 00:15:26,959
address from there it will make the

449
00:15:26,959 --> 00:15:28,000
attacking machine

450
00:15:28,000 --> 00:15:31,519
the dns server and again uh

451
00:15:31,519 --> 00:15:35,040
ipv6 is favored on all windows machines

452
00:15:35,040 --> 00:15:37,040
so it's going to favor that favor that

453
00:15:37,040 --> 00:15:39,199
ipv6 dns server which is

454
00:15:39,199 --> 00:15:41,839
the attacker and then it will serve a

455
00:15:41,839 --> 00:15:43,759
fake wpad file which requires

456
00:15:43,759 --> 00:15:45,120
authentication

457
00:15:45,120 --> 00:15:48,639
from there using ntlm relay we can relay

458
00:15:48,639 --> 00:15:50,320
those credentials

459
00:15:50,320 --> 00:15:54,160
so what can we do with all of that

460
00:15:54,160 --> 00:15:56,720
paired with in packets and tlm relay it

461
00:15:56,720 --> 00:15:58,639
is a dangerous force

462
00:15:58,639 --> 00:16:01,839
attackers again can advertise ipv6 is

463
00:16:01,839 --> 00:16:03,600
available and reply to those requests

464
00:16:03,600 --> 00:16:04,959
and dns queries

465
00:16:04,959 --> 00:16:08,160
it can then relay ntl and to a victim

466
00:16:08,160 --> 00:16:09,199
machine

467
00:16:09,199 --> 00:16:11,600
capture those hashes dump active

468
00:16:11,600 --> 00:16:14,160
directory information in great detail

469
00:16:14,160 --> 00:16:17,519
impersonate users add users and elevate

470
00:16:17,519 --> 00:16:20,079
them to enterprise admin and more

471
00:16:20,079 --> 00:16:21,759
essentially what you have here as an

472
00:16:21,759 --> 00:16:23,600
attacker is that infinity gauntlet

473
00:16:23,600 --> 00:16:26,880
it is a powerful force um so

474
00:16:26,880 --> 00:16:28,880
let's look at let's see what that looks

475
00:16:28,880 --> 00:16:30,399
like i'm going to

476
00:16:30,399 --> 00:16:32,800
uh do a quick demo but before we do i

477
00:16:32,800 --> 00:16:34,320
just wanted to put these slides up so

478
00:16:34,320 --> 00:16:34,880
that

479
00:16:34,880 --> 00:16:36,399
if anyone needed to they could go ahead

480
00:16:36,399 --> 00:16:38,160
and pause this and look at it

481
00:16:38,160 --> 00:16:39,360
but essentially what we're going to do

482
00:16:39,360 --> 00:16:40,800
is we're going to run man in the middle

483
00:16:40,800 --> 00:16:41,759
6

484
00:16:41,759 --> 00:16:45,120
alongside ntlm relay and this is what we

485
00:16:45,120 --> 00:16:46,880
can reasonably expect to see

486
00:16:46,880 --> 00:16:48,320
so let me go ahead and pause and i'll

487
00:16:48,320 --> 00:16:49,839
get that demo environment set up and

488
00:16:49,839 --> 00:16:51,440
we'll see what this looks like

489
00:16:51,440 --> 00:16:55,199
uh in real time okay so let's walk

490
00:16:55,199 --> 00:16:57,680
through the basic command usage of

491
00:16:57,680 --> 00:16:59,839
uh man in the middle six used along with

492
00:16:59,839 --> 00:17:01,759
ntlm relay

493
00:17:01,759 --> 00:17:03,519
and then a little bit we'll talk about

494
00:17:03,519 --> 00:17:05,520
some kind of information that an

495
00:17:05,520 --> 00:17:07,439
attacker can find useful

496
00:17:07,439 --> 00:17:10,160
as well as some follow-on attacks that

497
00:17:10,160 --> 00:17:11,919
will break out in another demo right

498
00:17:11,919 --> 00:17:13,520
after this

499
00:17:13,520 --> 00:17:15,439
so first off we're going to use python 3

500
00:17:15,439 --> 00:17:16,799
with man in the middle 6.

501
00:17:16,799 --> 00:17:19,039
we're going to use the dash d flag

502
00:17:19,039 --> 00:17:20,400
specifying the

503
00:17:20,400 --> 00:17:22,720
victim domain and in this case we're

504
00:17:22,720 --> 00:17:24,720
using westeros.local

505
00:17:24,720 --> 00:17:26,400
so i'll go ahead and hit enter and run

506
00:17:26,400 --> 00:17:27,760
that

507
00:17:27,760 --> 00:17:29,440
and then with ntlm relay we're going to

508
00:17:29,440 --> 00:17:33,039
use the dash 6 flag for ipv6

509
00:17:33,039 --> 00:17:35,280
we're going to use the dash t flag for

510
00:17:35,280 --> 00:17:36,320
target and we're going to be

511
00:17:36,320 --> 00:17:37,600
authenticating against

512
00:17:37,600 --> 00:17:41,039
ldaps on our domain controller

513
00:17:41,039 --> 00:17:44,240
and then tech wh is going to be the fake

514
00:17:44,240 --> 00:17:47,200
wpad file that will be serving

515
00:17:47,200 --> 00:17:50,080
the dash l will be our uh where we want

516
00:17:50,080 --> 00:17:51,200
our loop to go

517
00:17:51,200 --> 00:17:52,559
where we're going to be dumping that

518
00:17:52,559 --> 00:17:55,520
active dom active directory information

519
00:17:55,520 --> 00:17:58,480
and then finally the dash of is where we

520
00:17:58,480 --> 00:18:00,240
want to output those

521
00:18:00,240 --> 00:18:03,120
captured ntlm v2 hashes so i'll go ahead

522
00:18:03,120 --> 00:18:05,840
and run this

523
00:18:05,919 --> 00:18:07,760
and then we will switch over to our

524
00:18:07,760 --> 00:18:09,520
windows machines

525
00:18:09,520 --> 00:18:11,120
and as you can see here there's our

526
00:18:11,120 --> 00:18:12,880
domain controller with our users

527
00:18:12,880 --> 00:18:14,960
and then we've got a windows machine

528
00:18:14,960 --> 00:18:16,799
here and i'm going to go ahead and speed

529
00:18:16,799 --> 00:18:18,640
up the process by restarting this

530
00:18:18,640 --> 00:18:19,840
machine

531
00:18:19,840 --> 00:18:22,000
so as i restart this we're going to

532
00:18:22,000 --> 00:18:23,760
start to see some more traffic and i'm

533
00:18:23,760 --> 00:18:25,440
going to go ahead and pause and once we

534
00:18:25,440 --> 00:18:26,640
start getting that traffic coming

535
00:18:26,640 --> 00:18:27,440
through

536
00:18:27,440 --> 00:18:30,480
i will switch back over to cali and

537
00:18:30,480 --> 00:18:32,640
show you what we'll be seeing once we

538
00:18:32,640 --> 00:18:35,120
start relaying credentials

539
00:18:35,120 --> 00:18:36,320
okay so we're starting to get a little

540
00:18:36,320 --> 00:18:37,600
bit traffic here i'm going to go ahead

541
00:18:37,600 --> 00:18:39,440
and log back into that windows machine

542
00:18:39,440 --> 00:18:43,840
which is just out of view

543
00:18:45,360 --> 00:18:46,880
okay we're starting to get a little

544
00:18:46,880 --> 00:18:49,440
traffic in here

545
00:18:49,440 --> 00:18:52,880
went ahead and logged in

546
00:18:53,360 --> 00:18:54,880
and we'll let this go just a little bit

547
00:18:54,880 --> 00:18:57,200
longer

548
00:18:57,200 --> 00:18:59,039
okay so i'm going to go ahead and pause

549
00:18:59,039 --> 00:19:00,400
this here

550
00:19:00,400 --> 00:19:03,200
shut these these commands down and we'll

551
00:19:03,200 --> 00:19:05,360
go ahead and just kind of dissect what

552
00:19:05,360 --> 00:19:08,720
came through here so we can see that we

553
00:19:08,720 --> 00:19:10,559
authenticated against ldaps

554
00:19:10,559 --> 00:19:12,720
on the domain controller with the user

555
00:19:12,720 --> 00:19:14,480
paul k

556
00:19:14,480 --> 00:19:17,039
and then if we go down here we'll see it

557
00:19:17,039 --> 00:19:18,960
attempted to create a user

558
00:19:18,960 --> 00:19:21,760
and it actually ended up making two uh

559
00:19:21,760 --> 00:19:23,840
ideally we would want one we don't need

560
00:19:23,840 --> 00:19:24,960
two but we got

561
00:19:24,960 --> 00:19:29,120
two users here with a unique and random

562
00:19:29,120 --> 00:19:32,160
strings along with passwords and then

563
00:19:32,160 --> 00:19:34,080
additionally there's a little blurb down

564
00:19:34,080 --> 00:19:34,720
here

565
00:19:34,720 --> 00:19:36,840
that says try using dc sync with

566
00:19:36,840 --> 00:19:38,160
secretstump.pi

567
00:19:38,160 --> 00:19:40,799
and this user so we're going to talk a

568
00:19:40,799 --> 00:19:41,840
little bit about that

569
00:19:41,840 --> 00:19:43,760
in a bit here but first let's kind of

570
00:19:43,760 --> 00:19:46,160
talk about what we just saw

571
00:19:46,160 --> 00:19:49,600
so ntlm relay with man in the middle 6

572
00:19:49,600 --> 00:19:51,200
relayed credentials to the domain

573
00:19:51,200 --> 00:19:52,720
controller and was able to

574
00:19:52,720 --> 00:19:55,120
dump out some information for us in this

575
00:19:55,120 --> 00:19:56,720
loop folder

576
00:19:56,720 --> 00:19:58,320
so let's look at some of this

577
00:19:58,320 --> 00:19:59,840
information real quick

578
00:19:59,840 --> 00:20:02,000
go ahead and look at the domain users

579
00:20:02,000 --> 00:20:03,360
we're able to see

580
00:20:03,360 --> 00:20:05,200
these domain users and the accounts that

581
00:20:05,200 --> 00:20:06,799
they created

582
00:20:06,799 --> 00:20:10,080
we can look at domain users by group

583
00:20:10,080 --> 00:20:11,520
and additionally we can look at the

584
00:20:11,520 --> 00:20:14,240
domain groups so let's look back on

585
00:20:14,240 --> 00:20:17,360
the domain users by group we can see

586
00:20:17,360 --> 00:20:20,400
this paul uh cake account that we

587
00:20:20,400 --> 00:20:23,280
authenticated against they're a member

588
00:20:23,280 --> 00:20:24,480
of the it

589
00:20:24,480 --> 00:20:26,960
user group which happens to be domain

590
00:20:26,960 --> 00:20:29,039
admins

591
00:20:29,039 --> 00:20:31,520
and interestingly enough if you look in

592
00:20:31,520 --> 00:20:33,520
the description you'll see the password

593
00:20:33,520 --> 00:20:35,720
for the jsno account

594
00:20:35,720 --> 00:20:38,960
ghost123 it is

595
00:20:38,960 --> 00:20:40,960
possible and it has happened in

596
00:20:40,960 --> 00:20:43,200
penetration tests in the past where

597
00:20:43,200 --> 00:20:45,520
people and companies will set the

598
00:20:45,520 --> 00:20:47,760
password in the description field

599
00:20:47,760 --> 00:20:50,240
so this can be very very helpful to an

600
00:20:50,240 --> 00:20:52,880
attacker to look and review at those

601
00:20:52,880 --> 00:20:56,720
description fields and additionally

602
00:20:56,720 --> 00:20:58,880
there's a little uh easter egg here

603
00:20:58,880 --> 00:21:01,360
reset all user passwords to westeros one

604
00:21:01,360 --> 00:21:02,240
when necessary

605
00:21:02,240 --> 00:21:05,360
a direction to the it group um

606
00:21:05,360 --> 00:21:07,039
another common trend with some

607
00:21:07,039 --> 00:21:08,480
organizations so they'll

608
00:21:08,480 --> 00:21:11,919
reset user passwords when necessary

609
00:21:11,919 --> 00:21:15,760
to company name with 2021 or just one

610
00:21:15,760 --> 00:21:18,559
after it or just the company name

611
00:21:18,559 --> 00:21:20,960
really giving a lot of users weak

612
00:21:20,960 --> 00:21:22,159
passwords who have

613
00:21:22,159 --> 00:21:23,919
no intention of changing them because

614
00:21:23,919 --> 00:21:25,600
it's easy to remember

615
00:21:25,600 --> 00:21:27,919
so again looking at these descriptions

616
00:21:27,919 --> 00:21:31,200
can be very helpful to an attacker

617
00:21:31,200 --> 00:21:33,360
so looking at some other loop that we've

618
00:21:33,360 --> 00:21:36,000
got here let's open up that

619
00:21:36,000 --> 00:21:39,280
those captured ntlm v2 hashes and we can

620
00:21:39,280 --> 00:21:40,000
see

621
00:21:40,000 --> 00:21:43,120
that we captured a few hashes here which

622
00:21:43,120 --> 00:21:44,000
we can go ahead

623
00:21:44,000 --> 00:21:46,159
and then take offline and crack and

624
00:21:46,159 --> 00:21:47,440
attempt to get those

625
00:21:47,440 --> 00:21:50,559
in their clear text versions all right

626
00:21:50,559 --> 00:21:51,200
we're back

627
00:21:51,200 --> 00:21:54,240
so what let's unpack what we just saw uh

628
00:21:54,240 --> 00:21:55,760
we used man in the middle six

629
00:21:55,760 --> 00:21:58,799
in conjunction with ntlm relay we

630
00:21:58,799 --> 00:22:00,960
authenticated against the ldaps on the

631
00:22:00,960 --> 00:22:02,320
domain controller

632
00:22:02,320 --> 00:22:05,360
we created a new user

633
00:22:05,360 --> 00:22:08,080
uh we dumped the active directory

634
00:22:08,080 --> 00:22:08,720
information

635
00:22:08,720 --> 00:22:10,640
and saw some pretty cool loop we

636
00:22:10,640 --> 00:22:13,280
captured some ntlm v2 hashes

637
00:22:13,280 --> 00:22:15,200
uh which we can go ahead and try to take

638
00:22:15,200 --> 00:22:17,039
offline and crack

639
00:22:17,039 --> 00:22:20,480
um and then we saw a password leak in

640
00:22:20,480 --> 00:22:22,400
the description field from one of the

641
00:22:22,400 --> 00:22:23,039
loop uh

642
00:22:23,039 --> 00:22:27,440
files so let's take it a step further

643
00:22:27,440 --> 00:22:29,120
now what we're going to do is we already

644
00:22:29,120 --> 00:22:30,960
created a user account

645
00:22:30,960 --> 00:22:32,400
we're going to take that user account

646
00:22:32,400 --> 00:22:34,080
that's been created and try to escalate

647
00:22:34,080 --> 00:22:35,200
their privileges to an

648
00:22:35,200 --> 00:22:38,400
enterprise admin and then from there

649
00:22:38,400 --> 00:22:40,559
we are going to go ahead confirm that

650
00:22:40,559 --> 00:22:43,520
and try to dump the ntds.dip file

651
00:22:43,520 --> 00:22:46,799
the ntbs.dip file is a file

652
00:22:46,799 --> 00:22:50,000
that contains all the um

653
00:22:50,000 --> 00:22:52,000
account hat password hashes on the

654
00:22:52,000 --> 00:22:53,919
domain which you can then try to take

655
00:22:53,919 --> 00:22:55,760
offline and crack

656
00:22:55,760 --> 00:22:58,000
so let's go ahead i'll jump back over

657
00:22:58,000 --> 00:22:59,200
and we'll see what this looks like in

658
00:22:59,200 --> 00:23:00,320
real time

659
00:23:00,320 --> 00:23:02,240
okay so going back to things we're gonna

660
00:23:02,240 --> 00:23:04,000
run man the middle six again

661
00:23:04,000 --> 00:23:07,280
against the westeros dot local domain

662
00:23:07,280 --> 00:23:09,679
we have ntlm relay and only thing we're

663
00:23:09,679 --> 00:23:11,120
kind of changing here is getting rid of

664
00:23:11,120 --> 00:23:13,520
that loot directory flag as well as the

665
00:23:13,520 --> 00:23:15,440
output file flag

666
00:23:15,440 --> 00:23:17,679
we're good with the hashes that we got

667
00:23:17,679 --> 00:23:19,200
we can go ahead and crack those

668
00:23:19,200 --> 00:23:21,200
paul k is a domain admin so if we can

669
00:23:21,200 --> 00:23:22,640
crack his hash

670
00:23:22,640 --> 00:23:24,400
and get that clear text password we're

671
00:23:24,400 --> 00:23:25,919
pretty much good but let's go ahead and

672
00:23:25,919 --> 00:23:26,320
try to

673
00:23:26,320 --> 00:23:28,640
escalate the user privileges of this one

674
00:23:28,640 --> 00:23:30,159
account that we created

675
00:23:30,159 --> 00:23:32,480
so before we do that i'm going to switch

676
00:23:32,480 --> 00:23:34,960
back over to the domain controller view

677
00:23:34,960 --> 00:23:36,240
and we're going to go ahead and look at

678
00:23:36,240 --> 00:23:38,240
this user so this is a user we're going

679
00:23:38,240 --> 00:23:39,760
to try to elevate the privileges

680
00:23:39,760 --> 00:23:41,840
you can see there's a regular domain

681
00:23:41,840 --> 00:23:43,600
user

682
00:23:43,600 --> 00:23:45,279
so switching back to cali we're going to

683
00:23:45,279 --> 00:23:46,640
run that

684
00:23:46,640 --> 00:23:50,159
and very similarly i'm going to restart

685
00:23:50,159 --> 00:23:52,640
uh this windows machine just to kind of

686
00:23:52,640 --> 00:23:53,600
get things uh

687
00:23:53,600 --> 00:23:55,200
moving a little bit faster here and i'm

688
00:23:55,200 --> 00:23:57,440
gonna pause and start it back up once we

689
00:23:57,440 --> 00:24:00,240
get that traffic

690
00:24:00,240 --> 00:24:02,480
okay so we're gonna walk back in with

691
00:24:02,480 --> 00:24:05,039
that user account on the windows machine

692
00:24:05,039 --> 00:24:08,159
that is just out of view

693
00:24:08,159 --> 00:24:11,840
and we are getting that success message

694
00:24:11,840 --> 00:24:14,400
we're getting a little bit more traffic

695
00:24:14,400 --> 00:24:17,039
i'm going to go ahead and stop this and

696
00:24:17,039 --> 00:24:18,000
let's dissect this

697
00:24:18,000 --> 00:24:21,520
one again okay so we were able to

698
00:24:21,520 --> 00:24:23,520
authenticate against ldaps on the domain

699
00:24:23,520 --> 00:24:24,720
controller with

700
00:24:24,720 --> 00:24:27,919
uh user paul k yet again

701
00:24:27,919 --> 00:24:31,120
we were able to successfully

702
00:24:31,120 --> 00:24:34,159
add this user to enterprise admins

703
00:24:34,159 --> 00:24:36,720
so let's double check just to make sure

704
00:24:36,720 --> 00:24:38,159
that actually worked

705
00:24:38,159 --> 00:24:39,760
going to the domain controller we're

706
00:24:39,760 --> 00:24:44,000
going to refresh our user list

707
00:24:44,559 --> 00:24:47,200
open this up and he is a member of

708
00:24:47,200 --> 00:24:49,919
enterprise admins

709
00:24:49,919 --> 00:24:52,480
so that did work we were able to

710
00:24:52,480 --> 00:24:54,720
successfully use ntlm relay

711
00:24:54,720 --> 00:24:57,279
with man in the middle 6 to elevate a

712
00:24:57,279 --> 00:24:59,279
user that we created

713
00:24:59,279 --> 00:25:02,400
through the same tool to an enterprise

714
00:25:02,400 --> 00:25:03,200
admin

715
00:25:03,200 --> 00:25:06,400
enterprise admin is an admin of

716
00:25:06,400 --> 00:25:09,200
all domains which is higher than domain

717
00:25:09,200 --> 00:25:11,520
admin so it's a pretty big deal

718
00:25:11,520 --> 00:25:14,480
a very powerful tool again so now we're

719
00:25:14,480 --> 00:25:15,279
going to switch back

720
00:25:15,279 --> 00:25:19,039
over to cali and another example of an

721
00:25:19,039 --> 00:25:20,640
attack i want to display

722
00:25:20,640 --> 00:25:23,840
was let's look back at this try using dc

723
00:25:23,840 --> 00:25:26,159
sync with secret stump dot pi and this

724
00:25:26,159 --> 00:25:26,960
user

725
00:25:26,960 --> 00:25:28,400
so what does that mean we're going to

726
00:25:28,400 --> 00:25:30,240
use secretsdump.pi

727
00:25:30,240 --> 00:25:33,039
part of impact and we're going to use

728
00:25:33,039 --> 00:25:33,440
that

729
00:25:33,440 --> 00:25:37,520
new account that we created

730
00:25:38,080 --> 00:25:40,679
and we're going to try to dump the

731
00:25:40,679 --> 00:25:42,320
ntds.dip file

732
00:25:42,320 --> 00:25:45,919
which will allow us to get

733
00:25:45,919 --> 00:25:50,159
all the domain users hashes

734
00:25:50,159 --> 00:25:52,880
we have hashes of the whole domain which

735
00:25:52,880 --> 00:25:53,840
we can go ahead

736
00:25:53,840 --> 00:25:56,640
take offline and attempt to crack this

737
00:25:56,640 --> 00:25:58,559
is very bad very powerful

738
00:25:58,559 --> 00:26:00,799
and this is just a yet another way that

739
00:26:00,799 --> 00:26:02,960
an attacker can get full control over

740
00:26:02,960 --> 00:26:06,400
your domain and your network

741
00:26:06,640 --> 00:26:09,679
okay so like we just saw we were able to

742
00:26:09,679 --> 00:26:10,559
successfully

743
00:26:10,559 --> 00:26:12,720
authenticate against ldaps yet again

744
00:26:12,720 --> 00:26:14,480
with the user paul k

745
00:26:14,480 --> 00:26:16,720
created that user made them an

746
00:26:16,720 --> 00:26:17,840
enterprise admin

747
00:26:17,840 --> 00:26:20,480
we verified that and then we went ahead

748
00:26:20,480 --> 00:26:22,960
and dumped the ntds.dip file

749
00:26:22,960 --> 00:26:25,679
very bad very impactful and like i said

750
00:26:25,679 --> 00:26:28,000
infinity gauntlet

751
00:26:28,000 --> 00:26:29,520
all right so let's talk a little defense

752
00:26:29,520 --> 00:26:31,200
here um

753
00:26:31,200 --> 00:26:34,080
first one being consider disabling ipv6

754
00:26:34,080 --> 00:26:35,520
across the network if it is not

755
00:26:35,520 --> 00:26:36,559
necessary

756
00:26:36,559 --> 00:26:37,919
let me speak on that a little bit

757
00:26:37,919 --> 00:26:40,480
however um i would consider

758
00:26:40,480 --> 00:26:42,480
i would recommend testing this out

759
00:26:42,480 --> 00:26:43,600
before um

760
00:26:43,600 --> 00:26:46,400
actually doing this um and monitor any

761
00:26:46,400 --> 00:26:46,960
network

762
00:26:46,960 --> 00:26:49,440
traffic uh or any issues that it might

763
00:26:49,440 --> 00:26:50,240
cause

764
00:26:50,240 --> 00:26:52,640
in the research that i did um i've read

765
00:26:52,640 --> 00:26:54,400
that there can be unintended

766
00:26:54,400 --> 00:26:56,320
consequences however i don't know what

767
00:26:56,320 --> 00:26:57,039
those are

768
00:26:57,039 --> 00:26:59,600
because i have never disabled ipv6

769
00:26:59,600 --> 00:27:01,679
across a large corporate network

770
00:27:01,679 --> 00:27:04,960
um however it is it can be a good

771
00:27:04,960 --> 00:27:06,960
remediation and i would consider

772
00:27:06,960 --> 00:27:08,799
testing it out first or if you are going

773
00:27:08,799 --> 00:27:10,000
to roll that out

774
00:27:10,000 --> 00:27:12,480
monitor your network for any issues it

775
00:27:12,480 --> 00:27:14,640
could cause

776
00:27:14,640 --> 00:27:17,520
next require smb signing on all hosts

777
00:27:17,520 --> 00:27:18,960
through gpo

778
00:27:18,960 --> 00:27:20,720
um there's a bullet that should be in

779
00:27:20,720 --> 00:27:22,240
here but uh

780
00:27:22,240 --> 00:27:25,120
consider setting a dns entry for wpad to

781
00:27:25,120 --> 00:27:26,799
black hole that traffic

782
00:27:26,799 --> 00:27:29,520
um if wpad is not in use internally

783
00:27:29,520 --> 00:27:31,679
disable it via group policy and disable

784
00:27:31,679 --> 00:27:33,120
the win http auto

785
00:27:33,120 --> 00:27:36,240
proxy svc enable both

786
00:27:36,240 --> 00:27:39,360
ldap signing and ldap channel binding

787
00:27:39,360 --> 00:27:41,919
and then lastly add administrative users

788
00:27:41,919 --> 00:27:43,520
to the protected users group

789
00:27:43,520 --> 00:27:45,120
to prevent their account from being used

790
00:27:45,120 --> 00:27:47,120
in an impersonation attack

791
00:27:47,120 --> 00:27:49,520
um more can be found in these links here

792
00:27:49,520 --> 00:27:52,000
both these two uh blogs have a lot of

793
00:27:52,000 --> 00:27:53,360
knowledge and wealth

794
00:27:53,360 --> 00:27:56,799
on uh men in the middle six and using

795
00:27:56,799 --> 00:27:58,000
that

796
00:27:58,000 --> 00:28:00,240
and then there's a great uh video by the

797
00:28:00,240 --> 00:28:02,799
cyber mentor on domain admin via

798
00:28:02,799 --> 00:28:05,279
ipv6 takeover which kind of shows

799
00:28:05,279 --> 00:28:07,039
everything and going back full circle

800
00:28:07,039 --> 00:28:09,360
again

801
00:28:09,679 --> 00:28:13,120
so to conclude ipv6 is being used more

802
00:28:13,120 --> 00:28:15,120
than many people might think

803
00:28:15,120 --> 00:28:17,360
uh organizations are starting to roll it

804
00:28:17,360 --> 00:28:19,200
out

805
00:28:19,200 --> 00:28:21,279
and organizations are using it by

806
00:28:21,279 --> 00:28:22,640
default and they don't know

807
00:28:22,640 --> 00:28:25,840
how most people are because of the

808
00:28:25,840 --> 00:28:28,799
what windows did so additional attack

809
00:28:28,799 --> 00:28:30,640
surface may be available that you're not

810
00:28:30,640 --> 00:28:31,760
aware of and this

811
00:28:31,760 --> 00:28:34,480
uh is applicable to both attackers and

812
00:28:34,480 --> 00:28:36,399
defenders

813
00:28:36,399 --> 00:28:38,799
man and middlesex attacks with ipv6 are

814
00:28:38,799 --> 00:28:40,240
becoming increasingly

815
00:28:40,240 --> 00:28:43,279
more common one of my buddies actually

816
00:28:43,279 --> 00:28:44,159
was just uh

817
00:28:44,159 --> 00:28:46,480
talking about how he got record domain

818
00:28:46,480 --> 00:28:48,320
admin for him in 20 minutes

819
00:28:48,320 --> 00:28:51,679
using men in the middle six so um

820
00:28:51,679 --> 00:28:53,600
uh penetration test figures and hackers

821
00:28:53,600 --> 00:28:55,279
are starting to use this tool and is

822
00:28:55,279 --> 00:28:56,320
becoming a

823
00:28:56,320 --> 00:28:58,480
quick and easy win for them uh and

824
00:28:58,480 --> 00:29:00,640
lastly do not fear the ipv6

825
00:29:00,640 --> 00:29:03,919
it is happening it is here um

826
00:29:03,919 --> 00:29:07,360
it is not scary so become familiar with

827
00:29:07,360 --> 00:29:07,840
it

828
00:29:07,840 --> 00:29:10,320
again set up a lab environment get it

829
00:29:10,320 --> 00:29:12,320
configured play around with it learn

830
00:29:12,320 --> 00:29:15,760
how to use tools with ipv6 and enjoy it

831
00:29:15,760 --> 00:29:16,240
it is

832
00:29:16,240 --> 00:29:18,320
very helpful for an attacker to know all

833
00:29:18,320 --> 00:29:20,399
this

834
00:29:20,399 --> 00:29:22,880
lastly i have some references here i

835
00:29:22,880 --> 00:29:24,720
will be posting these slides

836
00:29:24,720 --> 00:29:27,279
um and all of these links on my website

837
00:29:27,279 --> 00:29:28,960
i'll probably make a post on linkedin as

838
00:29:28,960 --> 00:29:29,679
well

839
00:29:29,679 --> 00:29:32,880
um but a lot of great references and

840
00:29:32,880 --> 00:29:35,039
resources that help me build out this

841
00:29:35,039 --> 00:29:36,159
talk

842
00:29:36,159 --> 00:29:38,559
additionally i've posted some of these

843
00:29:38,559 --> 00:29:40,080
githubs for all the tools that you can

844
00:29:40,080 --> 00:29:42,320
go ahead and use so

845
00:29:42,320 --> 00:29:44,559
with that i'd like to thank carolinacon

846
00:29:44,559 --> 00:29:47,520
for allowing me to have this talk

847
00:29:47,520 --> 00:29:49,600
i want to thank everybody for listening

848
00:29:49,600 --> 00:29:50,880
and i look forward to

849
00:29:50,880 --> 00:29:53,520
playing in the ctf and listening to all

850
00:29:53,520 --> 00:29:55,520
the other talks after me so thank you

851
00:29:55,520 --> 00:29:57,279
very much for tuning in

852
00:29:57,279 --> 00:29:59,679
and again looking forward to the rest of

853
00:29:59,679 --> 00:30:03,039
the conference

