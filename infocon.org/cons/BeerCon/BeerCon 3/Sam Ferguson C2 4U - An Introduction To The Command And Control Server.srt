1
00:00:00,719 --> 00:00:03,199
hey sam

2
00:00:03,280 --> 00:00:05,680
welcome back

3
00:00:05,680 --> 00:00:07,839
you'll miss me

4
00:00:07,839 --> 00:00:09,679
well you have the honor it could be a

5
00:00:09,679 --> 00:00:11,360
dubious honor but it's an honor

6
00:00:11,360 --> 00:00:13,920
nonetheless of closing our wonderful

7
00:00:13,920 --> 00:00:15,679
conference

8
00:00:15,679 --> 00:00:16,720
so

9
00:00:16,720 --> 00:00:20,800
you have a talk entitled c2 for you

10
00:00:20,800 --> 00:00:22,560
and you're going to talk to us about

11
00:00:22,560 --> 00:00:24,800
command and control infrastructure

12
00:00:24,800 --> 00:00:26,800
so we'd love to hear about that and the

13
00:00:26,800 --> 00:00:28,640
floor is now yours and i can see your

14
00:00:28,640 --> 00:00:30,880
slides perfect awesome all right hello

15
00:00:30,880 --> 00:00:33,280
again everyone you're stuck with me for

16
00:00:33,280 --> 00:00:36,800
another 30 to 45 minutes so uh i'm so

17
00:00:36,800 --> 00:00:38,719
sorry and but hopefully you at least

18
00:00:38,719 --> 00:00:41,440
enjoy your time here uh so before this

19
00:00:41,440 --> 00:00:43,440
presentation starts again i'm going to

20
00:00:43,440 --> 00:00:45,200
go through my nice disclaimer uh the

21
00:00:45,200 --> 00:00:47,120
opinions expressed in this presentation

22
00:00:47,120 --> 00:00:48,719
and in any corresponding comments are

23
00:00:48,719 --> 00:00:50,399
the personal opinions of the original

24
00:00:50,399 --> 00:00:52,719
authors not those of cbs health i like

25
00:00:52,719 --> 00:00:54,320
cbs a lot they let me come to this

26
00:00:54,320 --> 00:00:56,480
conference during the work day so i

27
00:00:56,480 --> 00:00:59,120
don't want to get fired anyway

28
00:00:59,120 --> 00:01:02,239
for those of you who are new here um

29
00:01:02,239 --> 00:01:04,239
let me introduce myself talk a little

30
00:01:04,239 --> 00:01:07,040
bit more about what i do um

31
00:01:07,040 --> 00:01:09,840
i my name is sam ferguson i'm also known

32
00:01:09,840 --> 00:01:12,560
as a fine security on the interwebs

33
00:01:12,560 --> 00:01:14,479
and i work for ces health in their it

34
00:01:14,479 --> 00:01:16,000
leadership development program i'm an

35
00:01:16,000 --> 00:01:17,360
ideal leadership development

36
00:01:17,360 --> 00:01:19,439
professional it's a rotational program i

37
00:01:19,439 --> 00:01:20,799
get to work in a bunch of different

38
00:01:20,799 --> 00:01:22,720
areas in the company my focus is in

39
00:01:22,720 --> 00:01:24,720
security so right now i'm working with

40
00:01:24,720 --> 00:01:26,320
our awesome orchestration and content

41
00:01:26,320 --> 00:01:28,640
engineering team uh learning kind of

42
00:01:28,640 --> 00:01:30,799
defensive side of things uh how to you

43
00:01:30,799 --> 00:01:32,640
know create detections do sections all

44
00:01:32,640 --> 00:01:34,079
that kind of stuff

45
00:01:34,079 --> 00:01:35,119
but

46
00:01:35,119 --> 00:01:38,840
my heart truly belongs to the red and

47
00:01:38,840 --> 00:01:41,759
purple i don't see his purple shirt so

48
00:01:41,759 --> 00:01:43,759
purple team uh that's that's right

49
00:01:43,759 --> 00:01:45,119
that's where i specialize uh that's

50
00:01:45,119 --> 00:01:47,040
where i'm at specialist um

51
00:01:47,040 --> 00:01:49,920
i like anything from tradecraft tactics

52
00:01:49,920 --> 00:01:52,240
development anything related to red

53
00:01:52,240 --> 00:01:54,159
teaming in those kinds of areas i'm a

54
00:01:54,159 --> 00:01:56,159
big fan of i've only been doing it since

55
00:01:56,159 --> 00:01:58,640
probably about june early july so i'm

56
00:01:58,640 --> 00:02:00,240
really new to it but it's been a lot of

57
00:02:00,240 --> 00:02:02,320
fun learning it so far i'm also a recent

58
00:02:02,320 --> 00:02:03,840
college grad i'm new to the workforce i

59
00:02:03,840 --> 00:02:05,759
graduated with a bachelor's of science

60
00:02:05,759 --> 00:02:07,520
computer technology from ball state

61
00:02:07,520 --> 00:02:08,399
university

62
00:02:08,399 --> 00:02:10,160
in muncie indiana

63
00:02:10,160 --> 00:02:10,959
which

64
00:02:10,959 --> 00:02:12,800
was a fun time and learned a lot of

65
00:02:12,800 --> 00:02:14,400
great stuff there but enough about me

66
00:02:14,400 --> 00:02:15,599
you don't care about me you're here to

67
00:02:15,599 --> 00:02:17,360
learn about csus so before we get

68
00:02:17,360 --> 00:02:18,959
started let's do a quick overview of

69
00:02:18,959 --> 00:02:20,319
what we're going to be covering today

70
00:02:20,319 --> 00:02:22,000
we're going to talk about the what y of

71
00:02:22,000 --> 00:02:25,200
c2s we'll be breaking down a c2 and then

72
00:02:25,200 --> 00:02:27,599
we'll be going beyond the basics

73
00:02:27,599 --> 00:02:29,360
a little bit and see how you can further

74
00:02:29,360 --> 00:02:31,040
your knowledge of commanding control

75
00:02:31,040 --> 00:02:32,560
servers outside of this presentation

76
00:02:32,560 --> 00:02:34,720
because there is no way i'm covering

77
00:02:34,720 --> 00:02:36,239
everything about a c2 in this entire

78
00:02:36,239 --> 00:02:37,760
presentation

79
00:02:37,760 --> 00:02:39,280
with that being said let's get started

80
00:02:39,280 --> 00:02:43,280
with the what why and how of c2 servers

81
00:02:43,280 --> 00:02:44,879
by the way also i will mention i got

82
00:02:44,879 --> 00:02:46,640
chat open on the side so if you want to

83
00:02:46,640 --> 00:02:48,239
throw any questions in there i also see

84
00:02:48,239 --> 00:02:49,920
everyone shout out to the roh homies

85
00:02:49,920 --> 00:02:51,519
let's go um

86
00:02:51,519 --> 00:02:52,560
if you want to throw anything in there

87
00:02:52,560 --> 00:02:53,920
i'll be happy to try and answer some

88
00:02:53,920 --> 00:02:55,040
questions if i got time in the middle of

89
00:02:55,040 --> 00:02:56,480
the presentation or i'll just come back

90
00:02:56,480 --> 00:02:57,680
to them at the end

91
00:02:57,680 --> 00:03:01,120
anyway what exactly is a ct server well

92
00:03:01,120 --> 00:03:02,480
i mean the title kind of spoiled it a

93
00:03:02,480 --> 00:03:04,000
little bit but pretend you didn't see

94
00:03:04,000 --> 00:03:07,280
that c2 uh actually stands for command

95
00:03:07,280 --> 00:03:09,680
and control obviously c2 for short it

96
00:03:09,680 --> 00:03:12,159
can also be referred to as c and c

97
00:03:12,159 --> 00:03:14,319
sometimes uh which i don't like because

98
00:03:14,319 --> 00:03:16,640
i always hear it as cnc like the cnc

99
00:03:16,640 --> 00:03:18,640
machine from engineering but people call

100
00:03:18,640 --> 00:03:21,680
it cnc sometimes as well so a c2 server

101
00:03:21,680 --> 00:03:24,000
is a centralized management for a

102
00:03:24,000 --> 00:03:26,400
centralized management of communications

103
00:03:26,400 --> 00:03:29,519
with compromised device devices if i had

104
00:03:29,519 --> 00:03:31,440
to pick one sentence subscribe c2 that

105
00:03:31,440 --> 00:03:34,560
would probably be it um c2s establish

106
00:03:34,560 --> 00:03:36,080
encrypted connections that are not

107
00:03:36,080 --> 00:03:38,400
viewable by defenders and provide

108
00:03:38,400 --> 00:03:40,959
capabilities to blend in with an

109
00:03:40,959 --> 00:03:42,879
environment

110
00:03:42,879 --> 00:03:44,560
so um

111
00:03:44,560 --> 00:03:47,440
why do cts exist why exactly should we

112
00:03:47,440 --> 00:03:49,440
have them why are why is anyone using

113
00:03:49,440 --> 00:03:53,120
them i have nc lvnp44444

114
00:03:53,120 --> 00:03:55,280
why can't i just do that

115
00:03:55,280 --> 00:03:56,159
um

116
00:03:56,159 --> 00:03:58,879
there's a few reasons that cpts exist

117
00:03:58,879 --> 00:04:00,640
and why you're you see them used not

118
00:04:00,640 --> 00:04:03,840
only by red team professionals but also

119
00:04:03,840 --> 00:04:05,760
by threat actors out there

120
00:04:05,760 --> 00:04:07,599
um first of all of course as i mentioned

121
00:04:07,599 --> 00:04:09,680
centralized management especially when

122
00:04:09,680 --> 00:04:12,560
you're working with a proper red team um

123
00:04:12,560 --> 00:04:15,120
the c2 setup you have some sort of

124
00:04:15,120 --> 00:04:16,399
centralized having a centralized

125
00:04:16,399 --> 00:04:19,279
location to manage pretty much any part

126
00:04:19,279 --> 00:04:21,358
of your red teaming process any of the

127
00:04:21,358 --> 00:04:23,280
beacons that you have open all those

128
00:04:23,280 --> 00:04:25,520
kinds of things um is really really nice

129
00:04:25,520 --> 00:04:27,360
and it's a big benefit to having ct's

130
00:04:27,360 --> 00:04:30,080
server uh centralized utilities c2s have

131
00:04:30,080 --> 00:04:31,840
a lot of functionality built into many

132
00:04:31,840 --> 00:04:33,919
of these frameworks uh again we'll go

133
00:04:33,919 --> 00:04:35,680
into more details on all this later but

134
00:04:35,680 --> 00:04:37,520
you're uh for now just understand that

135
00:04:37,520 --> 00:04:38,880
there's a lot of utilities that are

136
00:04:38,880 --> 00:04:41,040
centralized in there um easy

137
00:04:41,040 --> 00:04:44,479
collaboration uh c2s again a lot of them

138
00:04:44,479 --> 00:04:46,720
are designed uh with collaboration in

139
00:04:46,720 --> 00:04:49,199
mind you know with a proper red team uh

140
00:04:49,199 --> 00:04:51,680
working together and you know you know

141
00:04:51,680 --> 00:04:54,080
have some people work on you know this

142
00:04:54,080 --> 00:04:56,400
uh this engagement at one time so people

143
00:04:56,400 --> 00:04:58,160
join in later you know things along

144
00:04:58,160 --> 00:04:59,759
those lines the c2 frameworks make it

145
00:04:59,759 --> 00:05:02,080
really easy for members to collaborate

146
00:05:02,080 --> 00:05:03,600
and also logging and reporting

147
00:05:03,600 --> 00:05:06,639
capabilities uh it's really easy uh for

148
00:05:06,639 --> 00:05:08,880
c2s to log the kind of actions that are

149
00:05:08,880 --> 00:05:10,720
taken and especially you know when

150
00:05:10,720 --> 00:05:12,800
you're doing documentation because red

151
00:05:12,800 --> 00:05:15,280
teaming documentation is king uh if you

152
00:05:15,280 --> 00:05:17,600
don't document it it didn't happen uh

153
00:05:17,600 --> 00:05:19,440
having logs available so you know if you

154
00:05:19,440 --> 00:05:20,800
forget to write something down that you

155
00:05:20,800 --> 00:05:22,320
did or you want to go back and verify

156
00:05:22,320 --> 00:05:24,080
exactly when something is run uh you

157
00:05:24,080 --> 00:05:25,199
have access to logs and then

158
00:05:25,199 --> 00:05:27,360
everything's a lot easier and see some

159
00:05:27,360 --> 00:05:29,440
cqs even have like custom reports that

160
00:05:29,440 --> 00:05:31,280
you can generate built into them so

161
00:05:31,280 --> 00:05:33,919
there's a lot from a kind of a

162
00:05:33,919 --> 00:05:35,840
more corporate uh

163
00:05:35,840 --> 00:05:36,639
uh

164
00:05:36,639 --> 00:05:38,400
i guess core export with the right word

165
00:05:38,400 --> 00:05:40,720
well i guess more professional um

166
00:05:40,720 --> 00:05:42,479
organized setting uh there's a lot of

167
00:05:42,479 --> 00:05:46,000
benefits that come um from c2

168
00:05:46,000 --> 00:05:47,039
so

169
00:05:47,039 --> 00:05:48,960
let's start peeling back the layers and

170
00:05:48,960 --> 00:05:51,840
getting into how exactly these c tubes

171
00:05:51,840 --> 00:05:52,720
work

172
00:05:52,720 --> 00:05:54,960
um so i want to start off by talking a

173
00:05:54,960 --> 00:05:56,880
little bit about c2 communication and

174
00:05:56,880 --> 00:06:00,560
generically how c2s communicate with uh

175
00:06:00,560 --> 00:06:02,240
with between the compromised device and

176
00:06:02,240 --> 00:06:04,080
the actual server itself so i got a nice

177
00:06:04,080 --> 00:06:05,680
little diagram for my visual folks out

178
00:06:05,680 --> 00:06:08,400
there um but a quick uh explanation of

179
00:06:08,400 --> 00:06:11,759
it is that c2s use a beaconing approach

180
00:06:11,759 --> 00:06:12,960
so that means they communicate

181
00:06:12,960 --> 00:06:14,639
intermittently if you've done any sort

182
00:06:14,639 --> 00:06:16,319
of ctfs before where you have you know

183
00:06:16,319 --> 00:06:18,560
your netcat reverse listener you're

184
00:06:18,560 --> 00:06:19,919
working in what we like to call an

185
00:06:19,919 --> 00:06:21,759
interactive shell where you send an

186
00:06:21,759 --> 00:06:23,440
action the response happens immediately

187
00:06:23,440 --> 00:06:26,240
you get the data back um instantaneously

188
00:06:26,240 --> 00:06:28,880
but see it's c2s uh we don't like to do

189
00:06:28,880 --> 00:06:31,199
that and i'll explain why a little later

190
00:06:31,199 --> 00:06:34,479
but um basically they can communicate at

191
00:06:34,479 --> 00:06:37,680
a more inter a set intermittent variable

192
00:06:37,680 --> 00:06:40,720
um where you know maybe every 60 seconds

193
00:06:40,720 --> 00:06:42,880
you'll have your compromised device um

194
00:06:42,880 --> 00:06:44,720
request out a job as you can see down

195
00:06:44,720 --> 00:06:46,560
here and the ct will send that job and

196
00:06:46,560 --> 00:06:48,080
the compromise device will send back the

197
00:06:48,080 --> 00:06:50,400
output and they happen on a regular

198
00:06:50,400 --> 00:06:52,160
cadence but of course this can be

199
00:06:52,160 --> 00:06:53,759
adjusted and we'll talk more about that

200
00:06:53,759 --> 00:06:54,800
later

201
00:06:54,800 --> 00:06:56,800
and the data that is transmitted is

202
00:06:56,800 --> 00:06:59,280
likely obfuscated and encrypted if

203
00:06:59,280 --> 00:07:01,039
you're working with any c2 worth its

204
00:07:01,039 --> 00:07:03,360
salt so you know cts are not leaving

205
00:07:03,360 --> 00:07:05,440
them a wide open unencrypted tcp

206
00:07:05,440 --> 00:07:07,759
connections where have strong encrypted

207
00:07:07,759 --> 00:07:10,240
connections uh that are being utilized

208
00:07:10,240 --> 00:07:11,840
so that you know our defenders can't get

209
00:07:11,840 --> 00:07:13,599
a peek inside to see what exactly is

210
00:07:13,599 --> 00:07:17,120
going on with that uh c2 traffic

211
00:07:17,120 --> 00:07:18,720
a quick bit more about the c2

212
00:07:18,720 --> 00:07:20,720
communication as well there's various

213
00:07:20,720 --> 00:07:22,639
different protocols um that are and

214
00:07:22,639 --> 00:07:25,919
platforms that might be used uh by c2s

215
00:07:25,919 --> 00:07:28,720
because again using just a one ccp

216
00:07:28,720 --> 00:07:31,840
connection is not necessarily very

217
00:07:31,840 --> 00:07:34,240
common to see in an enterprise but there

218
00:07:34,240 --> 00:07:35,840
are some things that are more common to

219
00:07:35,840 --> 00:07:41,199
see like http specifically https um dns

220
00:07:41,199 --> 00:07:44,160
smb um you might you'll probably see

221
00:07:44,160 --> 00:07:46,800
those being used as channels for data to

222
00:07:46,800 --> 00:07:49,199
be communicated from a compromised

223
00:07:49,199 --> 00:07:52,080
device over to a c2 server

224
00:07:52,080 --> 00:07:53,840
but you can also get a little creative

225
00:07:53,840 --> 00:07:56,000
and people out there have done that

226
00:07:56,000 --> 00:07:58,160
you can use something like discord to

227
00:07:58,160 --> 00:08:00,160
host a c2 i've seen implementations that

228
00:08:00,160 --> 00:08:02,000
utilize that i see implementations that

229
00:08:02,000 --> 00:08:04,800
use onedrive and lots more there's tons

230
00:08:04,800 --> 00:08:06,960
of people coming up with crazy ways to

231
00:08:06,960 --> 00:08:09,759
you know turn something into a c2 uh

232
00:08:09,759 --> 00:08:11,919
which is just absolutely mind-blowing

233
00:08:11,919 --> 00:08:14,240
but uh so if you want to try with some

234
00:08:14,240 --> 00:08:16,479
of these more quirky um i will say

235
00:08:16,479 --> 00:08:17,759
useless because there definitely are

236
00:08:17,759 --> 00:08:19,840
uses to them especially you know if

237
00:08:19,840 --> 00:08:21,360
organizations aren't necessarily aware

238
00:08:21,360 --> 00:08:24,080
of them but you know these more uh niche

239
00:08:24,080 --> 00:08:27,440
c2 platforms uh that communication might

240
00:08:27,440 --> 00:08:29,440
occur over

241
00:08:29,440 --> 00:08:30,160
so

242
00:08:30,160 --> 00:08:32,320
we got a bit of the basics of the c2 and

243
00:08:32,320 --> 00:08:33,599
you might kind of have a general

244
00:08:33,599 --> 00:08:34,799
understanding of you know how they

245
00:08:34,799 --> 00:08:36,479
communicate kind of you saw a little bit

246
00:08:36,479 --> 00:08:38,080
back in the setup as well with the

247
00:08:38,080 --> 00:08:40,719
server and the compromised device um but

248
00:08:40,719 --> 00:08:42,000
we're going to start diving into the

249
00:08:42,000 --> 00:08:45,040
nitty-gritty down into the technical um

250
00:08:45,040 --> 00:08:47,680
and for this uh deep dive into technical

251
00:08:47,680 --> 00:08:50,399
we're going to be utilizing empire c2

252
00:08:50,399 --> 00:08:53,040
which is a powershell focus c2 that is

253
00:08:53,040 --> 00:08:56,000
written in python um now

254
00:08:56,000 --> 00:08:57,680
calling it a power i'm calling

255
00:08:57,680 --> 00:08:59,519
powershell focus and not strictly a

256
00:08:59,519 --> 00:09:03,920
powershell c2 um because they start uh

257
00:09:03,920 --> 00:09:07,120
the empire project uh people bc security

258
00:09:07,120 --> 00:09:08,880
who's now maintaining it uh they've

259
00:09:08,880 --> 00:09:10,000
started to add an additional

260
00:09:10,000 --> 00:09:12,080
functionality beyond powershell things

261
00:09:12,080 --> 00:09:14,800
like iron python and c-sharp uh love to

262
00:09:14,800 --> 00:09:18,399
see g-sharp in there um it's uh

263
00:09:18,399 --> 00:09:19,440
it's a

264
00:09:19,440 --> 00:09:21,360
really really nice to see those things

265
00:09:21,360 --> 00:09:23,920
added in and kind of moving away from a

266
00:09:23,920 --> 00:09:26,000
powershell focus c2 for those who maybe

267
00:09:26,000 --> 00:09:27,040
aren't familiar in red teaming

268
00:09:27,040 --> 00:09:28,320
powershell used to be kind of the king

269
00:09:28,320 --> 00:09:30,160
of red team but nowadays a lot of people

270
00:09:30,160 --> 00:09:32,399
like c sharp a lot more so because

271
00:09:32,399 --> 00:09:34,320
powershell is a lot easier to detect and

272
00:09:34,320 --> 00:09:36,480
uh defenders are much more aware of

273
00:09:36,480 --> 00:09:38,240
malicious powershell activity so it's

274
00:09:38,240 --> 00:09:39,920
nice to see those kinds of things

275
00:09:39,920 --> 00:09:41,200
and empire is really cool because it

276
00:09:41,200 --> 00:09:43,680
comes with both a cli and a gui the

277
00:09:43,680 --> 00:09:45,120
starkiller gui i'll show it off a little

278
00:09:45,120 --> 00:09:46,560
bit but we're mostly going to be uh

279
00:09:46,560 --> 00:09:48,320
chilling in cli

280
00:09:48,320 --> 00:09:49,680
um so

281
00:09:49,680 --> 00:09:52,320
without further ado we're going to jump

282
00:09:52,320 --> 00:09:54,640
right in to the technical breakdown of

283
00:09:54,640 --> 00:09:57,839
how ct's work but before that i want to

284
00:09:57,839 --> 00:10:00,240
make a quick note on opsec because i

285
00:10:00,240 --> 00:10:02,000
would be remiss if i didn't mention

286
00:10:02,000 --> 00:10:04,959
opsec in a red teaming uh sort of

287
00:10:04,959 --> 00:10:07,600
presentation uh so operation security or

288
00:10:07,600 --> 00:10:10,640
offset is a very critical part of red tv

289
00:10:10,640 --> 00:10:12,560
the goal is basically to prolong and

290
00:10:12,560 --> 00:10:14,880
evade discovery by appearing as

291
00:10:14,880 --> 00:10:17,040
legitimate or non-malicious so you might

292
00:10:17,040 --> 00:10:18,480
have wondered like hey why do we use

293
00:10:18,480 --> 00:10:20,800
https or dns for our communication

294
00:10:20,800 --> 00:10:22,720
channels and why do we have beacon why

295
00:10:22,720 --> 00:10:24,480
don't we get everything information back

296
00:10:24,480 --> 00:10:27,360
just instantaneously this is why because

297
00:10:27,360 --> 00:10:29,360
we want to look like legitimate traffic

298
00:10:29,360 --> 00:10:31,519
in the environment we want to blend in

299
00:10:31,519 --> 00:10:33,600
evade detection and things along those

300
00:10:33,600 --> 00:10:36,959
lines so object's not a focus of this

301
00:10:36,959 --> 00:10:38,320
presentation of course we're focused on

302
00:10:38,320 --> 00:10:40,560
c2 but it's going to be brought into the

303
00:10:40,560 --> 00:10:44,000
context of how opsec fits in with uh c2

304
00:10:44,000 --> 00:10:45,440
infrastructure

305
00:10:45,440 --> 00:10:47,360
so yeah it's it's it's gotta be

306
00:10:47,360 --> 00:10:48,880
mentioned it's gotta be brought up and

307
00:10:48,880 --> 00:10:50,720
uh the whole goal of upset of course is

308
00:10:50,720 --> 00:10:53,360
to bring your sneak up to level 100 uh

309
00:10:53,360 --> 00:10:55,360
because if you've done any red teammate

310
00:10:55,360 --> 00:10:58,160
before you know that um if you use

311
00:10:58,160 --> 00:10:59,360
defaults

312
00:10:59,360 --> 00:11:01,519
you're gonna have a bad time so we gotta

313
00:11:01,519 --> 00:11:03,360
make some changes because you can be

314
00:11:03,360 --> 00:11:05,120
sure that a lot of ct platforms are

315
00:11:05,120 --> 00:11:07,440
highly signatured out of the box um and

316
00:11:07,440 --> 00:11:08,640
you're probably gonna get caught if you

317
00:11:08,640 --> 00:11:10,720
don't make any changes

318
00:11:10,720 --> 00:11:13,040
all right let's jump into it let's talk

319
00:11:13,040 --> 00:11:15,440
some nitty-gritty c2 stuff

320
00:11:15,440 --> 00:11:17,760
so first thing i want to talk about is

321
00:11:17,760 --> 00:11:20,640
the listeners the ct listeners

322
00:11:20,640 --> 00:11:23,920
so listeners um as the name might imply

323
00:11:23,920 --> 00:11:26,640
listen for incoming connections

324
00:11:26,640 --> 00:11:28,720
so you know you can think of this like

325
00:11:28,720 --> 00:11:31,360
you're not cat your net cat lvmp um this

326
00:11:31,360 --> 00:11:33,120
is this is the guy that kind of manages

327
00:11:33,120 --> 00:11:34,640
that part but also defines the

328
00:11:34,640 --> 00:11:36,800
expectations for inbound connections

329
00:11:36,800 --> 00:11:38,240
things like ports that it's going to be

330
00:11:38,240 --> 00:11:39,519
listening on and that that connection

331
00:11:39,519 --> 00:11:42,320
should be reaching out to ip addresses

332
00:11:42,320 --> 00:11:43,920
things along those lines

333
00:11:43,920 --> 00:11:45,680
and there's various types of different

334
00:11:45,680 --> 00:11:47,279
listeners that exist you can kind of see

335
00:11:47,279 --> 00:11:49,519
in the cc communication section usually

336
00:11:49,519 --> 00:11:51,120
listeners are going to be bound to a

337
00:11:51,120 --> 00:11:53,519
particular type of protocol so you might

338
00:11:53,519 --> 00:11:57,440
have an http https listener dns listener

339
00:11:57,440 --> 00:11:59,360
things along those lines so let's

340
00:11:59,360 --> 00:12:02,079
actually hop into powershell real quick

341
00:12:02,079 --> 00:12:04,000
or powershell empire real quick let me

342
00:12:04,000 --> 00:12:07,040
pull up my c2 here we'll full screen so

343
00:12:07,040 --> 00:12:09,200
you guys can see oh and before actually

344
00:12:09,200 --> 00:12:10,639
we can show this a little bit this is a

345
00:12:10,639 --> 00:12:12,720
little quick look at uh powershell and

346
00:12:12,720 --> 00:12:14,880
uh starkiller the front end for

347
00:12:14,880 --> 00:12:17,519
powershell empire so nice cool platform

348
00:12:17,519 --> 00:12:19,440
pretty clean easy to look at if you're

349
00:12:19,440 --> 00:12:21,040
not super comfortable with cli just yet

350
00:12:21,040 --> 00:12:22,240
you want to kind of get your bearings

351
00:12:22,240 --> 00:12:24,000
this is a great way to do it so you can

352
00:12:24,000 --> 00:12:26,800
see for example we have a listener here

353
00:12:26,800 --> 00:12:29,200
set up um which is http

354
00:12:29,200 --> 00:12:31,760
um sue we've set that particular type

355
00:12:31,760 --> 00:12:33,200
the host address that it's going to be

356
00:12:33,200 --> 00:12:34,480
reaching out on

357
00:12:34,480 --> 00:12:36,560
yes cycling inside where we are doing

358
00:12:36,560 --> 00:12:38,320
kind of like don't we don't worry all

359
00:12:38,320 --> 00:12:39,920
the sacrifices been made we're good demo

360
00:12:39,920 --> 00:12:42,720
gods will bless me in this um

361
00:12:42,720 --> 00:12:44,240
so you know you'll set things like the

362
00:12:44,240 --> 00:12:47,360
port the bind ip um and things like that

363
00:12:47,360 --> 00:12:49,600
to get you know your basic functionality

364
00:12:49,600 --> 00:12:52,320
out of the way um you know what's going

365
00:12:52,320 --> 00:12:54,639
to be launched staging key more on this

366
00:12:54,639 --> 00:12:56,399
later um

367
00:12:56,399 --> 00:12:57,760
but yeah this is kind of like your

368
00:12:57,760 --> 00:12:59,920
generic listener and they just kind of

369
00:12:59,920 --> 00:13:03,040
chill in here and also note that you

370
00:13:03,040 --> 00:13:06,000
know unlike um unlike in the netcat

371
00:13:06,000 --> 00:13:08,320
situation um you can actually have

372
00:13:08,320 --> 00:13:10,160
multiple listeners connect back or

373
00:13:10,160 --> 00:13:12,800
multiple uh one of our beacons connect

374
00:13:12,800 --> 00:13:15,600
back to a same listener so if you have

375
00:13:15,600 --> 00:13:18,480
multiple um beacons using the same port

376
00:13:18,480 --> 00:13:20,320
80 that'll work just fine and we'll see

377
00:13:20,320 --> 00:13:22,959
how that works out later um so this is

378
00:13:22,959 --> 00:13:25,440
kind of a quick look over here about uh

379
00:13:25,440 --> 00:13:28,480
the http listener uh let's move on back

380
00:13:28,480 --> 00:13:30,959
actually now to presentation and we're

381
00:13:30,959 --> 00:13:33,120
going to take a look at some offset

382
00:13:33,120 --> 00:13:35,839
considerations for listener operational

383
00:13:35,839 --> 00:13:38,480
security is offset or operation security

384
00:13:38,480 --> 00:13:41,040
sorry offset's important

385
00:13:41,040 --> 00:13:43,040
so how do we take our traffic from you

386
00:13:43,040 --> 00:13:45,120
know functional like c2 provides you

387
00:13:45,120 --> 00:13:47,279
know with port ip all that stuff and how

388
00:13:47,279 --> 00:13:49,680
do we make it look more legitimate

389
00:13:49,680 --> 00:13:52,120
first thing of course is certificates

390
00:13:52,120 --> 00:13:55,199
https better than http probably not

391
00:13:55,199 --> 00:13:57,279
going to see a ton of http traffic in an

392
00:13:57,279 --> 00:13:59,120
organization especially something that's

393
00:13:59,120 --> 00:14:02,959
reaching out externally um that's not

394
00:14:02,959 --> 00:14:05,040
going to be very likely so

395
00:14:05,040 --> 00:14:06,880
probably want to have an https cert um

396
00:14:06,880 --> 00:14:08,800
set up but we might need to put it

397
00:14:08,800 --> 00:14:09,920
directly on the server and you'll see

398
00:14:09,920 --> 00:14:12,399
why later cookies as well um unique

399
00:14:12,399 --> 00:14:14,240
value that can add complexity and

400
00:14:14,240 --> 00:14:15,360
there's some things we can play around

401
00:14:15,360 --> 00:14:17,600
with those as well um which is really

402
00:14:17,600 --> 00:14:18,399
cool

403
00:14:18,399 --> 00:14:20,720
delay and jitter probably one of the

404
00:14:20,720 --> 00:14:23,680
more important opsec opportunities um

405
00:14:23,680 --> 00:14:26,880
delay and jitter uh define how often an

406
00:14:26,880 --> 00:14:29,600
agent beacons back so how how long

407
00:14:29,600 --> 00:14:32,000
between a you know request for jobs like

408
00:14:32,000 --> 00:14:34,399
you saw that communication slide happens

409
00:14:34,399 --> 00:14:36,320
and the percentage of variance of each

410
00:14:36,320 --> 00:14:38,079
interval and i highly recommend that you

411
00:14:38,079 --> 00:14:40,399
utilize both of those because you know

412
00:14:40,399 --> 00:14:42,720
if you just put on delay and leave it at

413
00:14:42,720 --> 00:14:44,639
that you know beak it out every 60

414
00:14:44,639 --> 00:14:45,600
seconds

415
00:14:45,600 --> 00:14:47,120
someone's gonna notice that hey this

416
00:14:47,120 --> 00:14:49,360
thing is reaching out at exactly 60

417
00:14:49,360 --> 00:14:51,120
second intervals and that's very

418
00:14:51,120 --> 00:14:53,040
suspicious that someone you know a user

419
00:14:53,040 --> 00:14:54,720
might be programmatically reaching out

420
00:14:54,720 --> 00:14:56,399
at that time that looks kind of odd so

421
00:14:56,399 --> 00:14:57,920
adding in jitter means that you know

422
00:14:57,920 --> 00:14:59,839
it'll fluctuate maybe it goes down to 49

423
00:14:59,839 --> 00:15:01,600
and then it's up to like 67 and then

424
00:15:01,600 --> 00:15:03,760
like 58 and stuff like that so you get a

425
00:15:03,760 --> 00:15:06,399
little bit of of play in that area

426
00:15:06,399 --> 00:15:08,240
and user agent it's another thing that

427
00:15:08,240 --> 00:15:10,240
isn't mentioned i think a lot in in

428
00:15:10,240 --> 00:15:11,440
listeners

429
00:15:11,440 --> 00:15:12,639
that i think is really important to

430
00:15:12,639 --> 00:15:14,000
mention because it could be an easy way

431
00:15:14,000 --> 00:15:15,680
to catch yourself up you know if you

432
00:15:15,680 --> 00:15:17,839
have an endpoint in an organization that

433
00:15:17,839 --> 00:15:19,440
heavily utilize maybe your organization

434
00:15:19,440 --> 00:15:21,440
heavily utilizes google chrome and you

435
00:15:21,440 --> 00:15:24,800
see in your blogs that hey this endpoint

436
00:15:24,800 --> 00:15:27,120
just reached out from firefox we don't

437
00:15:27,120 --> 00:15:29,360
allow firefox in our organization you're

438
00:15:29,360 --> 00:15:30,959
pretty much getting your cod yourself

439
00:15:30,959 --> 00:15:33,279
caught out instantly so be a bit aware

440
00:15:33,279 --> 00:15:35,279
of the user agent that you're utilizing

441
00:15:35,279 --> 00:15:37,360
um in in your environment and just

442
00:15:37,360 --> 00:15:39,199
taking a look at that in here again we

443
00:15:39,199 --> 00:15:42,079
can kind of see if i go into uh into the

444
00:15:42,079 --> 00:15:44,639
into the subject here we can see uh

445
00:15:44,639 --> 00:15:46,000
you've got the default jitter the

446
00:15:46,000 --> 00:15:48,079
default delay things like that i'm not

447
00:15:48,079 --> 00:15:49,360
going to change this for the sake of the

448
00:15:49,360 --> 00:15:51,360
presentation uh to keep things smooth

449
00:15:51,360 --> 00:15:54,000
but you can see uh what's good with that

450
00:15:54,000 --> 00:15:56,240
um also we've got cert paths here you

451
00:15:56,240 --> 00:15:58,320
got your cookies here um things like

452
00:15:58,320 --> 00:16:00,560
kill dates can also be nice as well um

453
00:16:00,560 --> 00:16:03,600
in here uh and then where else is it the

454
00:16:03,600 --> 00:16:05,839
user agent here obviously default uh you

455
00:16:05,839 --> 00:16:07,519
just basically copy paste the string in

456
00:16:07,519 --> 00:16:09,040
there and boom you're pretty much good

457
00:16:09,040 --> 00:16:11,279
to go um from that perspective so those

458
00:16:11,279 --> 00:16:12,639
are some operational security

459
00:16:12,639 --> 00:16:14,880
considerations you can make within a c2

460
00:16:14,880 --> 00:16:16,000
server

461
00:16:16,000 --> 00:16:17,600
so that's kind of the first step that

462
00:16:17,600 --> 00:16:19,759
you're going to be taking with a c2 and

463
00:16:19,759 --> 00:16:20,959
uh and

464
00:16:20,959 --> 00:16:23,680
and getting that set up

465
00:16:23,680 --> 00:16:25,360
now there's one more thing i want to

466
00:16:25,360 --> 00:16:27,199
mention about listeners before you move

467
00:16:27,199 --> 00:16:30,800
on and that's malleable sk2 so malleable

468
00:16:30,800 --> 00:16:33,759
c2 was created by raphael mudge for

469
00:16:33,759 --> 00:16:35,440
cobalt strike and if you're not familiar

470
00:16:35,440 --> 00:16:37,680
with cobalt strike it's pretty much the

471
00:16:37,680 --> 00:16:40,959
industry standard when it comes to um c2

472
00:16:40,959 --> 00:16:44,320
servers um and c2 solutions so it's it's

473
00:16:44,320 --> 00:16:47,920
used heavily heavily heavily um and they

474
00:16:47,920 --> 00:16:49,440
made a rough amount created something

475
00:16:49,440 --> 00:16:52,160
for it called a malleable c2 profile and

476
00:16:52,160 --> 00:16:54,079
it's basically a centralized place to

477
00:16:54,079 --> 00:16:56,959
manage operational operation security

478
00:16:56,959 --> 00:16:59,519
for um that particular server now this

479
00:16:59,519 --> 00:17:01,519
is much more expansive in cobalt strike

480
00:17:01,519 --> 00:17:05,199
um the example i'll show in uh in empire

481
00:17:05,199 --> 00:17:07,439
doesn't take as much of

482
00:17:07,439 --> 00:17:10,160
of the utility that malleable provides

483
00:17:10,160 --> 00:17:12,000
but it still provides a lot of det of

484
00:17:12,000 --> 00:17:14,319
interesting uh useful little tidbits so

485
00:17:14,319 --> 00:17:15,839
you can see here you can find everything

486
00:17:15,839 --> 00:17:18,319
from sleep and jitter initial stage repo

487
00:17:18,319 --> 00:17:20,640
activity http requests and response

488
00:17:20,640 --> 00:17:23,839
activity tns activity memory indicators

489
00:17:23,839 --> 00:17:27,119
which is much more um kind of on the uh

490
00:17:27,119 --> 00:17:29,600
on the cobalt strike side of things and

491
00:17:29,600 --> 00:17:31,360
a lot more so i want to take a look at a

492
00:17:31,360 --> 00:17:33,520
malleable c2 profile so you guys can get

493
00:17:33,520 --> 00:17:36,320
kind of an idea of what it looks like

494
00:17:36,320 --> 00:17:38,320
let me go over to my terminal here and

495
00:17:38,320 --> 00:17:41,520
let's pull up uh this uh comfort profile

496
00:17:41,520 --> 00:17:44,400
which is in the defaults here so let's

497
00:17:44,400 --> 00:17:47,200
take a look um yeah gj chester yeah

498
00:17:47,200 --> 00:17:48,720
cobblestone's so good bad guys use crack

499
00:17:48,720 --> 00:17:51,039
copies yes cobalt strike is that good

500
00:17:51,039 --> 00:17:54,480
that the uh the uh actual threat actors

501
00:17:54,480 --> 00:17:56,000
are utilizing it so it's good enough for

502
00:17:56,000 --> 00:17:57,760
them uh definitely good enough for red

503
00:17:57,760 --> 00:17:59,600
teamers so you can see here we've got a

504
00:17:59,600 --> 00:18:01,280
bunch of values being set in this

505
00:18:01,280 --> 00:18:02,799
profile here so we've got you know our

506
00:18:02,799 --> 00:18:04,960
sleep time set 3000

507
00:18:04,960 --> 00:18:07,280
um our jit which is just 30 seconds our

508
00:18:07,280 --> 00:18:09,520
jitter we've got our max dns request our

509
00:18:09,520 --> 00:18:11,440
specific user agent that we're utilizing

510
00:18:11,440 --> 00:18:14,799
here um this http get request so when

511
00:18:14,799 --> 00:18:17,280
the communication happens over http

512
00:18:17,280 --> 00:18:19,520
where that uh endpoint reaches out to

513
00:18:19,520 --> 00:18:21,760
the server uh this is kind of the action

514
00:18:21,760 --> 00:18:24,080
it's gonna take that url that it's gonna

515
00:18:24,080 --> 00:18:26,320
query um you know the headers it's gonna

516
00:18:26,320 --> 00:18:29,200
add how the data that is being sent back

517
00:18:29,200 --> 00:18:31,600
to the server is going to be um modified

518
00:18:31,600 --> 00:18:33,360
so using netbios and then appending this

519
00:18:33,360 --> 00:18:35,280
path and then appending it to the uri

520
00:18:35,280 --> 00:18:37,039
and things along those lines so it's

521
00:18:37,039 --> 00:18:38,880
really easy to set things up and if

522
00:18:38,880 --> 00:18:41,440
you're really new to operational or

523
00:18:41,440 --> 00:18:43,360
operation security and you're not that

524
00:18:43,360 --> 00:18:45,120
familiar with uh how do i set up the

525
00:18:45,120 --> 00:18:46,880
malleable c2 what's the optimal thing to

526
00:18:46,880 --> 00:18:49,440
do you know you can look at things like

527
00:18:49,440 --> 00:18:51,440
these you know particular apts that you

528
00:18:51,440 --> 00:18:52,960
want to emulate you can pull their

529
00:18:52,960 --> 00:18:54,799
valuable c2 profiles someone's probably

530
00:18:54,799 --> 00:18:56,640
made it where you can use something like

531
00:18:56,640 --> 00:18:59,120
uh 40 north securities uh

532
00:18:59,120 --> 00:19:00,799
concealer tool which will generate

533
00:19:00,799 --> 00:19:02,720
custom malleable c2 profiles and you can

534
00:19:02,720 --> 00:19:05,840
pull that in um so really pretty easy to

535
00:19:05,840 --> 00:19:07,520
implement overall and i think it's

536
00:19:07,520 --> 00:19:08,720
really important to mention even though

537
00:19:08,720 --> 00:19:10,320
it's more of a call strike thing it can

538
00:19:10,320 --> 00:19:12,080
be utilized by the powershell empire

539
00:19:12,080 --> 00:19:14,480
platform as well and i i do believe

540
00:19:14,480 --> 00:19:16,000
there's other c2 platforms that take

541
00:19:16,000 --> 00:19:17,919
advantage of this as well

542
00:19:17,919 --> 00:19:20,240
so let's keep moving on and talk a

543
00:19:20,240 --> 00:19:23,600
little bit about uh stagers so stagers

544
00:19:23,600 --> 00:19:25,840
are our initial point of beacon creation

545
00:19:25,840 --> 00:19:27,600
you can think of these

546
00:19:27,600 --> 00:19:31,760
as the actual malicious uh binary or dll

547
00:19:31,760 --> 00:19:33,120
or whatever it is that's going to get

548
00:19:33,120 --> 00:19:35,360
executed on the endpoints to create our

549
00:19:35,360 --> 00:19:36,720
connection

550
00:19:36,720 --> 00:19:38,080
now with stations there's two different

551
00:19:38,080 --> 00:19:41,840
types of stagers there is staged and

552
00:19:41,840 --> 00:19:43,120
stageless

553
00:19:43,120 --> 00:19:46,480
um so staged is

554
00:19:46,480 --> 00:19:47,760
utilized

555
00:19:47,760 --> 00:19:50,400
uh kind of uses small payloads it's

556
00:19:50,400 --> 00:19:53,039
focused the initial actual binary that

557
00:19:53,039 --> 00:19:54,160
you're generating that's getting

558
00:19:54,160 --> 00:19:56,799
executed initially is much smaller

559
00:19:56,799 --> 00:19:59,760
versus the stageless as larger payload

560
00:19:59,760 --> 00:20:01,600
the problem with stage is that it's very

561
00:20:01,600 --> 00:20:04,000
prone to detection because they are

562
00:20:04,000 --> 00:20:07,280
heavily signatured and um there's

563
00:20:07,280 --> 00:20:10,640
part of the staging process is not fully

564
00:20:10,640 --> 00:20:13,840
encrypted so it's easy for uh easy for

565
00:20:13,840 --> 00:20:16,880
uh endpoint detection uh solutions to

566
00:20:16,880 --> 00:20:19,600
realize hey this is not good um we

567
00:20:19,600 --> 00:20:21,200
should probably stop this or in the

568
00:20:21,200 --> 00:20:23,120
words of the great olivia guard stop

569
00:20:23,120 --> 00:20:25,120
right there criminal scum and your

570
00:20:25,120 --> 00:20:26,400
recession will just die and then you'll

571
00:20:26,400 --> 00:20:28,240
be sad because you'll have no beacon and

572
00:20:28,240 --> 00:20:29,840
that that that makes that would make me

573
00:20:29,840 --> 00:20:30,640
sad

574
00:20:30,640 --> 00:20:31,440
um

575
00:20:31,440 --> 00:20:33,360
but with stageless um even though you

576
00:20:33,360 --> 00:20:34,880
have a bit larger of a payload you have

577
00:20:34,880 --> 00:20:37,200
a much lower detection rate and what

578
00:20:37,200 --> 00:20:39,039
happens is basically it will immediately

579
00:20:39,039 --> 00:20:41,280
call back um instantly and you'll be

580
00:20:41,280 --> 00:20:42,799
pretty much good to go

581
00:20:42,799 --> 00:20:43,760
um

582
00:20:43,760 --> 00:20:46,080
now as far as setting up stage stagers

583
00:20:46,080 --> 00:20:47,200
on

584
00:20:47,200 --> 00:20:49,120
partial empire we'll go ahead and take a

585
00:20:49,120 --> 00:20:50,960
look at that um i'll actually keep using

586
00:20:50,960 --> 00:20:52,720
star killer here i think it's pretty

587
00:20:52,720 --> 00:20:55,679
easy to use now fortunately for me um

588
00:20:55,679 --> 00:20:56,880
umpire

589
00:20:56,880 --> 00:20:58,720
started off with powershell and much

590
00:20:58,720 --> 00:21:01,280
more focused on stage payloads there are

591
00:21:01,280 --> 00:21:04,000
stage less payload options shout out to

592
00:21:04,000 --> 00:21:06,159
redskull for pointing that out to me um

593
00:21:06,159 --> 00:21:07,760
but i didn't really have the time

594
00:21:07,760 --> 00:21:08,880
unfortunately to mess around with them

595
00:21:08,880 --> 00:21:10,320
too much to get them functioning as i

596
00:21:10,320 --> 00:21:12,559
would like them to um so actually

597
00:21:12,559 --> 00:21:15,440
building a proper stager um is we're

598
00:21:15,440 --> 00:21:17,200
going to focus more on the stage one at

599
00:21:17,200 --> 00:21:20,080
this time so i'll go in here and let's

600
00:21:20,080 --> 00:21:21,919
make a c sharp one because i'm a red

601
00:21:21,919 --> 00:21:24,480
teamer and i love sure um so basically

602
00:21:24,480 --> 00:21:26,240
you just go in you're gonna pick your

603
00:21:26,240 --> 00:21:27,520
listener whatever you want to do let's

604
00:21:27,520 --> 00:21:29,600
do this http

605
00:21:29,600 --> 00:21:31,760
it'll generate you know an out file

606
00:21:31,760 --> 00:21:34,240
sharp language all these kinds of things

607
00:21:34,240 --> 00:21:36,960
uh and then you can set other values uh

608
00:21:36,960 --> 00:21:39,440
proxy we'll get to that in a bit um

609
00:21:39,440 --> 00:21:41,679
more details like that um

610
00:21:41,679 --> 00:21:43,520
and of course your user agent so things

611
00:21:43,520 --> 00:21:45,039
along those lines you can set all these

612
00:21:45,039 --> 00:21:46,960
details in here and then all you do is

613
00:21:46,960 --> 00:21:49,600
just hit submit

614
00:21:49,600 --> 00:21:51,280
and boom it goes and you can click the

615
00:21:51,280 --> 00:21:53,280
action and you can download your uh your

616
00:21:53,280 --> 00:21:54,960
stager just from right there and it's

617
00:21:54,960 --> 00:21:56,960
usually that straightforward um stages

618
00:21:56,960 --> 00:21:58,880
are pretty easy to generate

619
00:21:58,880 --> 00:22:00,159
um

620
00:22:00,159 --> 00:22:01,679
so

621
00:22:01,679 --> 00:22:03,280
this is pretty easy in powershell empire

622
00:22:03,280 --> 00:22:04,400
it's pretty easy and a lot of other

623
00:22:04,400 --> 00:22:06,720
platforms as well so cool stuff cool

624
00:22:06,720 --> 00:22:08,000
stuff from that

625
00:22:08,000 --> 00:22:10,880
let's again jump into offset for stagers

626
00:22:10,880 --> 00:22:13,200
um try to be like spiderman and say you

627
00:22:13,200 --> 00:22:14,720
know if we have this shirt maybe no one

628
00:22:14,720 --> 00:22:16,799
will know that i'm spiderman uh so the

629
00:22:16,799 --> 00:22:18,720
first thing for stagers is obviously

630
00:22:18,720 --> 00:22:21,200
code obfuscation because obfuscating

631
00:22:21,200 --> 00:22:24,080
code is almost always helpful sometimes

632
00:22:24,080 --> 00:22:27,440
edr solutions will have uh things where

633
00:22:27,440 --> 00:22:28,880
they'll check the entropy of the code so

634
00:22:28,880 --> 00:22:30,640
if you get something that's super super

635
00:22:30,640 --> 00:22:32,640
obfuscated you're maybe like that's

636
00:22:32,640 --> 00:22:33,919
suspect because nothing's supposed to be

637
00:22:33,919 --> 00:22:36,480
that obfuscated and they'll mark it as

638
00:22:36,480 --> 00:22:38,559
potentially malicious but for the most

639
00:22:38,559 --> 00:22:40,480
part objection is generally helpful an

640
00:22:40,480 --> 00:22:42,960
empire if you do a powershell uh base

641
00:22:42,960 --> 00:22:44,559
stager then you can actually get

642
00:22:44,559 --> 00:22:47,440
obfuscation built in there um but two

643
00:22:47,440 --> 00:22:49,840
other tools which focus mainly on.net

644
00:22:49,840 --> 00:22:53,360
with c sharp uh mainly because again i

645
00:22:53,360 --> 00:22:54,799
love c sharp and most of our teamers

646
00:22:54,799 --> 00:22:56,640
nowadays let's start so i'm gonna mainly

647
00:22:56,640 --> 00:22:59,280
plug c sharp um is computer x2 and

648
00:22:59,280 --> 00:23:01,120
logic.net so you can usually throw

649
00:23:01,120 --> 00:23:03,280
things like shell code into there and

650
00:23:03,280 --> 00:23:04,799
generate um

651
00:23:04,799 --> 00:23:08,159
generate uh kind of uh encrypted in or

652
00:23:08,159 --> 00:23:11,200
uh you know obfuscated code um from that

653
00:23:11,200 --> 00:23:13,039
which is really cool um and

654
00:23:13,039 --> 00:23:14,880
anti-detection tools as well optive

655
00:23:14,880 --> 00:23:17,840
scarecrow i love this tool so much it's

656
00:23:17,840 --> 00:23:20,000
so good you basically pass it in shell

657
00:23:20,000 --> 00:23:23,360
code and it will create a binary that is

658
00:23:23,360 --> 00:23:25,919
going to patch out both amsi the

659
00:23:25,919 --> 00:23:28,960
anti-malware scanning interface and um

660
00:23:28,960 --> 00:23:31,600
uh and also etw event tracing for

661
00:23:31,600 --> 00:23:33,360
windows which if you're in red team you

662
00:23:33,360 --> 00:23:35,039
know those if you're not those are like

663
00:23:35,039 --> 00:23:36,559
two main things that endpoint detection

664
00:23:36,559 --> 00:23:38,159
and response are going to be using to

665
00:23:38,159 --> 00:23:39,520
get their data about what's going on in

666
00:23:39,520 --> 00:23:41,039
the system and if you can patch those

667
00:23:41,039 --> 00:23:43,200
out and run stuff you're absolutely

668
00:23:43,200 --> 00:23:45,200
chilling so optim's freaking awesome

669
00:23:45,200 --> 00:23:48,320
also red skull get out with goblin uh

670
00:23:48,320 --> 00:23:50,559
golang c sharp slander with go i know

671
00:23:50,559 --> 00:23:53,039
you love go everyone knows you'll go

672
00:23:53,039 --> 00:23:56,000
so um anyway so and if you're wondering

673
00:23:56,000 --> 00:23:57,600
how shell code exactly works and how to

674
00:23:57,600 --> 00:24:00,000
generate that in uh in in powershell

675
00:24:00,000 --> 00:24:02,320
empire um really quick go search it up

676
00:24:02,320 --> 00:24:04,720
um shell code uh you can see windows

677
00:24:04,720 --> 00:24:06,880
shell code right here you just pick your

678
00:24:06,880 --> 00:24:08,960
listener boom you got yourself some

679
00:24:08,960 --> 00:24:11,200
shell code and you can save it as a dot

680
00:24:11,200 --> 00:24:13,440
bin shell code file so really easy and

681
00:24:13,440 --> 00:24:14,960
it's pretty much that simple in a lot of

682
00:24:14,960 --> 00:24:17,120
other c2 solutions as well

683
00:24:17,120 --> 00:24:19,200
so yeah cool stuff from opsec for the

684
00:24:19,200 --> 00:24:21,440
stager perspective

685
00:24:21,440 --> 00:24:23,360
now there's something that i'm not going

686
00:24:23,360 --> 00:24:25,360
to exactly demo in this presentation but

687
00:24:25,360 --> 00:24:27,279
i do want to talk about it because it's

688
00:24:27,279 --> 00:24:29,440
kind of an offset thing to a degree but

689
00:24:29,440 --> 00:24:31,200
it's also part of a cpu infrastructure i

690
00:24:31,200 --> 00:24:33,919
feel um and that is redirectors

691
00:24:33,919 --> 00:24:36,240
redirectors provide additional layers of

692
00:24:36,240 --> 00:24:38,400
abstraction between

693
00:24:38,400 --> 00:24:40,880
your server and the actual endpoint that

694
00:24:40,880 --> 00:24:42,400
you've compromised because it hides your

695
00:24:42,400 --> 00:24:44,240
main infrastructure if it's discovered

696
00:24:44,240 --> 00:24:45,760
by defenders

697
00:24:45,760 --> 00:24:47,360
so how exactly does this work well

698
00:24:47,360 --> 00:24:49,520
you'll have something like a web server

699
00:24:49,520 --> 00:24:53,360
or a cdn endpoint or serverless um or

700
00:24:53,360 --> 00:24:54,880
you know it's maybe something like socat

701
00:24:54,880 --> 00:24:56,960
set up on a server and basically what it

702
00:24:56,960 --> 00:24:58,000
will do

703
00:24:58,000 --> 00:24:59,679
is you will configure in your c2

704
00:24:59,679 --> 00:25:00,960
settings you saw those settings about

705
00:25:00,960 --> 00:25:03,600
proxy uh um i think there's proxy

706
00:25:03,600 --> 00:25:04,960
settings in there um i haven't messed

707
00:25:04,960 --> 00:25:06,480
around with it too much on empire but i

708
00:25:06,480 --> 00:25:07,919
know in other c2 platforms there's

709
00:25:07,919 --> 00:25:09,919
usually like proxy settings you modify

710
00:25:09,919 --> 00:25:12,000
and basically you set the prop you set

711
00:25:12,000 --> 00:25:12,720
the

712
00:25:12,720 --> 00:25:16,159
uh your you know created stager to point

713
00:25:16,159 --> 00:25:19,120
actually back towards that proxy server

714
00:25:19,120 --> 00:25:21,520
that will sit in between your

715
00:25:21,520 --> 00:25:23,760
uh your proxy server redirector in this

716
00:25:23,760 --> 00:25:26,960
case that will sit in between um your

717
00:25:26,960 --> 00:25:29,200
actual compromised endpoint and of

718
00:25:29,200 --> 00:25:31,120
course your uh

719
00:25:31,120 --> 00:25:33,279
your actual c2 server and what will

720
00:25:33,279 --> 00:25:35,120
happen is basically

721
00:25:35,120 --> 00:25:37,760
that traffic will get sent over to that

722
00:25:37,760 --> 00:25:39,279
uh redirector and then it will get

723
00:25:39,279 --> 00:25:40,799
redirected to your c2 and it will go

724
00:25:40,799 --> 00:25:42,799
back and forth through that

725
00:25:42,799 --> 00:25:44,880
through that system so if defenders

726
00:25:44,880 --> 00:25:46,480
actually discover you they're only going

727
00:25:46,480 --> 00:25:48,240
to ever take down your redirector your

728
00:25:48,240 --> 00:25:50,159
entire back-end c2 infrastructure is

729
00:25:50,159 --> 00:25:52,240
completely fine and that's awesome we

730
00:25:52,240 --> 00:25:53,760
really like to see that

731
00:25:53,760 --> 00:25:54,960
so

732
00:25:54,960 --> 00:25:56,720
that's it free directors are just

733
00:25:56,720 --> 00:25:59,039
absolutely um they i think they're a

734
00:25:59,039 --> 00:26:02,000
must-have when it comes to uh red to ct

735
00:26:02,000 --> 00:26:03,279
infrastructure

736
00:26:03,279 --> 00:26:04,960
now a few offset things that i want to

737
00:26:04,960 --> 00:26:06,159
talk about

738
00:26:06,159 --> 00:26:08,080
remember when i mentioned cookies back

739
00:26:08,080 --> 00:26:10,000
with back with listeners about data

740
00:26:10,000 --> 00:26:11,840
that's being sent over um yeah this is

741
00:26:11,840 --> 00:26:14,320
where they can kind of come in so if an

742
00:26:14,320 --> 00:26:16,400
analyst is doing a cursory analysis of a

743
00:26:16,400 --> 00:26:18,080
domain um

744
00:26:18,080 --> 00:26:20,240
and you want to kind of fool them and

745
00:26:20,240 --> 00:26:21,760
trick them a little bit you can make a

746
00:26:21,760 --> 00:26:24,000
dynamic response based on a request so

747
00:26:24,000 --> 00:26:25,440
you know your c2 traffic is going to

748
00:26:25,440 --> 00:26:28,000
have that particular cookie in the http

749
00:26:28,000 --> 00:26:28,960
header

750
00:26:28,960 --> 00:26:30,240
well say someone goes to the site

751
00:26:30,240 --> 00:26:32,080
without that maybe you have the

752
00:26:32,080 --> 00:26:34,799
redirector say oh if it goes to this if

753
00:26:34,799 --> 00:26:36,480
it goes to this page without this

754
00:26:36,480 --> 00:26:38,559
particular header and this value in that

755
00:26:38,559 --> 00:26:40,559
header send it back over to somewhere

756
00:26:40,559 --> 00:26:42,240
else or send it to a non-malicious

757
00:26:42,240 --> 00:26:44,559
looking page which is huge so if an

758
00:26:44,559 --> 00:26:46,400
analyst you know maybe it's just a sock

759
00:26:46,400 --> 00:26:48,080
analyst who's doing a quick check and

760
00:26:48,080 --> 00:26:49,840
they see oh this page looks totally fine

761
00:26:49,840 --> 00:26:50,960
i guess we don't really have to worry

762
00:26:50,960 --> 00:26:52,320
about that you're kind of home free from

763
00:26:52,320 --> 00:26:54,880
that perspective super nice um some more

764
00:26:54,880 --> 00:26:57,120
specific things for for web servers and

765
00:26:57,120 --> 00:26:58,559
serverless solutions like cloud

766
00:26:58,559 --> 00:27:00,080
fireworkers or something along those

767
00:27:00,080 --> 00:27:03,039
lines um obviously use https that's kind

768
00:27:03,039 --> 00:27:05,120
of a given um and obviously use a

769
00:27:05,120 --> 00:27:08,000
recently expired domain name as well uh

770
00:27:08,000 --> 00:27:09,600
if you're trying to consider proxy

771
00:27:09,600 --> 00:27:11,360
connections uh

772
00:27:11,360 --> 00:27:13,039
because a lot of organizations have a

773
00:27:13,039 --> 00:27:16,559
proxy uh sitting in between uh their

774
00:27:16,559 --> 00:27:18,799
their users and the internet um a lot of

775
00:27:18,799 --> 00:27:20,480
proxies are going to be

776
00:27:20,480 --> 00:27:22,720
a little bit suspect about any sort of

777
00:27:22,720 --> 00:27:24,480
new domain so go find a recently expired

778
00:27:24,480 --> 00:27:27,360
domain name um

779
00:27:28,320 --> 00:27:29,679
the processing will probably say oh this

780
00:27:29,679 --> 00:27:31,039
domain has been around for a while it's

781
00:27:31,039 --> 00:27:33,520
okay and for cdns you can take advantage

782
00:27:33,520 --> 00:27:35,760
of something called domain fronting um

783
00:27:35,760 --> 00:27:37,520
so basically you know a cdn content

784
00:27:37,520 --> 00:27:39,039
delivery network thinking of something

785
00:27:39,039 --> 00:27:41,919
like fastly or cloudflare um what you

786
00:27:41,919 --> 00:27:44,320
can do is basically have it make a

787
00:27:44,320 --> 00:27:45,600
request

788
00:27:45,600 --> 00:27:47,520
to what looks like a legitimate website

789
00:27:47,520 --> 00:27:50,000
that is served on that cdn uh that

790
00:27:50,000 --> 00:27:52,720
that's or that cdn rather serves for um

791
00:27:52,720 --> 00:27:54,880
but actually you put in the http host

792
00:27:54,880 --> 00:27:57,360
header uh your actual endpoint so when

793
00:27:57,360 --> 00:27:59,039
it kind of decrypts when the cpi

794
00:27:59,039 --> 00:28:00,880
decrypts that tls packet you'll actually

795
00:28:00,880 --> 00:28:02,399
see the host header ended up forwarding

796
00:28:02,399 --> 00:28:04,720
over so it'll even look better because

797
00:28:04,720 --> 00:28:06,240
now it looks like some user's just

798
00:28:06,240 --> 00:28:08,080
reaching out to a super legit website

799
00:28:08,080 --> 00:28:10,159
like google or something like that and

800
00:28:10,159 --> 00:28:12,559
now no one's gonna bat an eye at that so

801
00:28:12,559 --> 00:28:13,919
incredible stuff i won't go more into it

802
00:28:13,919 --> 00:28:15,200
but you can look it up it's really

803
00:28:15,200 --> 00:28:17,919
really sick it's super awesome

804
00:28:17,919 --> 00:28:19,679
so that's redirectors um and again i'm

805
00:28:19,679 --> 00:28:22,480
not going to break it down so agents

806
00:28:22,480 --> 00:28:24,480
let's talk about agents we are finally

807
00:28:24,480 --> 00:28:26,960
getting to the actual control or command

808
00:28:26,960 --> 00:28:28,640
and control portion of the command and

809
00:28:28,640 --> 00:28:31,039
control server agents are your gateway

810
00:28:31,039 --> 00:28:33,200
to interaction with compromised devices

811
00:28:33,200 --> 00:28:34,960
um you can assign them tasks to be

812
00:28:34,960 --> 00:28:36,559
executed there

813
00:28:36,559 --> 00:28:38,480
it's just basically your main hub for

814
00:28:38,480 --> 00:28:40,080
actually running things on it on a

815
00:28:40,080 --> 00:28:42,880
device um so the execution methods a few

816
00:28:42,880 --> 00:28:45,200
that i want to kind of mention um then

817
00:28:45,200 --> 00:28:46,960
they vary depending on the c2

818
00:28:46,960 --> 00:28:49,120
implementation of what method is used a

819
00:28:49,120 --> 00:28:51,679
method called fork and run basically

820
00:28:51,679 --> 00:28:53,440
your process spawns the sacrificial

821
00:28:53,440 --> 00:28:56,240
process injects shell code or injects

822
00:28:56,240 --> 00:28:58,880
code into it runs the code kills process

823
00:28:58,880 --> 00:29:01,120
um process injection is injecting into

824
00:29:01,120 --> 00:29:02,640
another process so you're running in a

825
00:29:02,640 --> 00:29:04,960
different context which is kind of cool

826
00:29:04,960 --> 00:29:06,880
so if you're maybe you've compromised

827
00:29:06,880 --> 00:29:08,320
just you're in your process and you want

828
00:29:08,320 --> 00:29:09,840
to move into like google chrome that's

829
00:29:09,840 --> 00:29:12,000
open you inject into that process and

830
00:29:12,000 --> 00:29:15,120
then inline execution which is

831
00:29:15,120 --> 00:29:16,720
uh direct

832
00:29:16,720 --> 00:29:18,720
how should i say injecting into the

833
00:29:18,720 --> 00:29:21,360
existing process um which empire

834
00:29:21,360 --> 00:29:23,440
actually does a really great job of

835
00:29:23,440 --> 00:29:25,600
in their modules which i will get into a

836
00:29:25,600 --> 00:29:26,960
little bit later but yeah these first

837
00:29:26,960 --> 00:29:28,720
two techniques are pretty much let's

838
00:29:28,720 --> 00:29:31,120
take the shell code and put it over here

839
00:29:31,120 --> 00:29:32,799
um so thank you patrick starr for

840
00:29:32,799 --> 00:29:34,080
explaining that

841
00:29:34,080 --> 00:29:37,520
all right uh let's take a look and uh

842
00:29:37,520 --> 00:29:39,520
we can i can kind of show off a little

843
00:29:39,520 --> 00:29:40,559
bit of

844
00:29:40,559 --> 00:29:43,679
um the asian let's get this started

845
00:29:43,679 --> 00:29:45,200
here while that's starting well i will

846
00:29:45,200 --> 00:29:47,520
jump over and kind of show uh talk a

847
00:29:47,520 --> 00:29:49,840
little bit about agent opsec so for

848
00:29:49,840 --> 00:29:51,600
ancient opsec um you're gonna want to

849
00:29:51,600 --> 00:29:54,720
look at the context of command execution

850
00:29:54,720 --> 00:29:56,880
um so you know what you know what

851
00:29:56,880 --> 00:29:58,799
process am i running under

852
00:29:58,799 --> 00:30:01,120
and the command that i'm executing in um

853
00:30:01,120 --> 00:30:02,480
those are kind of things that you want

854
00:30:02,480 --> 00:30:05,279
to consider because you know if you're

855
00:30:05,279 --> 00:30:08,320
running um you know who am i whack priv

856
00:30:08,320 --> 00:30:10,000
as some process that should never

857
00:30:10,000 --> 00:30:11,760
interact with command line ever

858
00:30:11,760 --> 00:30:13,919
something to be a bit suspect also the

859
00:30:13,919 --> 00:30:15,679
types of commands that are being run and

860
00:30:15,679 --> 00:30:17,279
especially the order of commands that

861
00:30:17,279 --> 00:30:19,360
are being run so for example if you run

862
00:30:19,360 --> 00:30:21,840
like who am i what grid

863
00:30:21,840 --> 00:30:25,600
pwd to dir some uh edr solutions may

864
00:30:25,600 --> 00:30:27,840
look at that process tree and say hmm

865
00:30:27,840 --> 00:30:30,559
that looks like enumeration activity i'm

866
00:30:30,559 --> 00:30:32,000
going to kill this process that's

867
00:30:32,000 --> 00:30:34,559
running it stuff like that so um another

868
00:30:34,559 --> 00:30:36,240
thing of course is operation hours

869
00:30:36,240 --> 00:30:37,679
that's another thing that you want to be

870
00:30:37,679 --> 00:30:39,360
aware of because you don't want your uh

871
00:30:39,360 --> 00:30:42,080
your beacon your agent um operating

872
00:30:42,080 --> 00:30:43,840
outside of you know normal user hours

873
00:30:43,840 --> 00:30:45,840
because that would look kind of weird um

874
00:30:45,840 --> 00:30:48,480
so actually let me go into my empire

875
00:30:48,480 --> 00:30:50,640
here ah if i can click the right dang

876
00:30:50,640 --> 00:30:52,480
thing um i'm really quickly going to

877
00:30:52,480 --> 00:30:54,000
show this because geez i'm taking a lot

878
00:30:54,000 --> 00:30:55,200
more time than i thought i was going to

879
00:30:55,200 --> 00:30:57,120
sorry about your promise apologies for

880
00:30:57,120 --> 00:30:59,840
that um but let's actually go and jump

881
00:30:59,840 --> 00:31:01,760
into here i'm going to

882
00:31:01,760 --> 00:31:05,840
go into the arena i'm going to go log in

883
00:31:06,640 --> 00:31:07,600
and

884
00:31:07,600 --> 00:31:10,080
i'm going to

885
00:31:10,080 --> 00:31:11,600
log in

886
00:31:11,600 --> 00:31:13,679
maybe

887
00:31:13,679 --> 00:31:15,120
all right cool first thing i'm going to

888
00:31:15,120 --> 00:31:17,279
do is disable the fender because i don't

889
00:31:17,279 --> 00:31:18,640
want to deal with the fender right now i

890
00:31:18,640 --> 00:31:20,320
didn't have time to figure out bypasses

891
00:31:20,320 --> 00:31:22,399
please don't um no

892
00:31:22,399 --> 00:31:24,480
uh please don't uh please don't shame me

893
00:31:24,480 --> 00:31:26,799
for uh you know not figuring out

894
00:31:26,799 --> 00:31:28,880
defender bypasses in time i'm not smart

895
00:31:28,880 --> 00:31:29,840
enough

896
00:31:29,840 --> 00:31:30,840
just

897
00:31:30,840 --> 00:31:33,840
yet cool all right so if we go in here

898
00:31:33,840 --> 00:31:35,039
you can see that i have stager

899
00:31:35,039 --> 00:31:36,799
pre-generated because i planned ahead

900
00:31:36,799 --> 00:31:40,799
for this talk so i'll run sharpfire.exe

901
00:31:40,799 --> 00:31:42,799
and if we go back

902
00:31:42,799 --> 00:31:44,399
we should see

903
00:31:44,399 --> 00:31:46,399
that we have our nice little agent over

904
00:31:46,399 --> 00:31:48,480
here hooray

905
00:31:48,480 --> 00:31:50,880
chat um we got our agent here yeah i

906
00:31:50,880 --> 00:31:53,279
have very secure password by the way um

907
00:31:53,279 --> 00:31:54,880
so we got our agent over here so you can

908
00:31:54,880 --> 00:31:58,000
see um we've got um

909
00:31:58,000 --> 00:31:59,120
we've got our

910
00:31:59,120 --> 00:32:00,799
interaction spot so i can run like who

911
00:32:00,799 --> 00:32:04,799
am i the shell command gets queued

912
00:32:04,799 --> 00:32:08,399
and we should get some data back oh

913
00:32:08,399 --> 00:32:10,719
pause

914
00:32:10,880 --> 00:32:13,120
hello

915
00:32:13,120 --> 00:32:16,000
mr region

916
00:32:16,720 --> 00:32:17,600
uh

917
00:32:17,600 --> 00:32:19,039
maybe it's because i'm too small screen

918
00:32:19,039 --> 00:32:21,840
let's go actually into the command line

919
00:32:21,840 --> 00:32:24,720
real quick um

920
00:32:24,720 --> 00:32:27,120
agents

921
00:32:27,120 --> 00:32:29,600
that's

922
00:32:29,840 --> 00:32:31,200
also the command line i think for this

923
00:32:31,200 --> 00:32:33,679
is super easy

924
00:32:33,679 --> 00:32:35,519
um i really i really like it yeah so

925
00:32:35,519 --> 00:32:36,880
here we go we can see the who am i

926
00:32:36,880 --> 00:32:41,279
results here so we're executing commands

927
00:32:41,279 --> 00:32:43,840
we can run hooray uh super awesome uh

928
00:32:43,840 --> 00:32:45,360
super easy to use and this is basically

929
00:32:45,360 --> 00:32:46,399
where you're gonna play it once you got

930
00:32:46,399 --> 00:32:48,480
a beacon which is great

931
00:32:48,480 --> 00:32:51,440
uh let's move on now to our bunches of

932
00:32:51,440 --> 00:32:54,080
plugins um so modules and plugins um

933
00:32:54,080 --> 00:32:56,000
these are what they're called in uh

934
00:32:56,000 --> 00:32:58,480
partial empire but there are other names

935
00:32:58,480 --> 00:33:00,080
under different 62 frameworks but they

936
00:33:00,080 --> 00:33:01,440
basically extend the capabilities of

937
00:33:01,440 --> 00:33:03,120
what they see to you and they can be a

938
00:33:03,120 --> 00:33:04,880
wide range of things of adding in new

939
00:33:04,880 --> 00:33:06,960
functionalities actually this c-sharp

940
00:33:06,960 --> 00:33:08,080
stuff that we generated over on

941
00:33:08,080 --> 00:33:10,159
powershell is through their plug-in

942
00:33:10,159 --> 00:33:12,960
c-sharp server um so that's kind of

943
00:33:12,960 --> 00:33:14,880
adding that extending that functionality

944
00:33:14,880 --> 00:33:16,480
there um you can also expand upon

945
00:33:16,480 --> 00:33:19,039
existing functionalities or integrate

946
00:33:19,039 --> 00:33:20,880
existing tools into the platform and

947
00:33:20,880 --> 00:33:22,480
we'll show that in just a minute here

948
00:33:22,480 --> 00:33:23,760
with the modules

949
00:33:23,760 --> 00:33:25,120
and they're different between platforms

950
00:33:25,120 --> 00:33:27,120
so for empire you have yaml for module

951
00:33:27,120 --> 00:33:28,720
tools and python for plugins a lot of

952
00:33:28,720 --> 00:33:31,440
the stuff built in um and then cobalt

953
00:33:31,440 --> 00:33:34,320
strike is uh utilizing aggressive script

954
00:33:34,320 --> 00:33:37,120
which is uh roughness own custom pearl s

955
00:33:37,120 --> 00:33:38,799
scripting language some really cool

956
00:33:38,799 --> 00:33:40,960
stuff has been built out there um so

957
00:33:40,960 --> 00:33:43,440
it's really really interesting

958
00:33:43,440 --> 00:33:45,120
and as far as module offset goes you

959
00:33:45,120 --> 00:33:47,519
know obviously eating our insight into

960
00:33:47,519 --> 00:33:49,360
activities you want to be aware of that

961
00:33:49,360 --> 00:33:50,960
you know if your epr can see what you're

962
00:33:50,960 --> 00:33:52,559
doing probably don't want to run seat

963
00:33:52,559 --> 00:33:54,399
belt because you're going to get

964
00:33:54,399 --> 00:33:56,159
something like that um the types of

965
00:33:56,159 --> 00:33:58,000
modules that are being used as well uh

966
00:33:58,000 --> 00:33:59,679
again kind of follows along similar to

967
00:33:59,679 --> 00:34:01,519
that point and also not really offset

968
00:34:01,519 --> 00:34:02,799
but i want to bring this up module

969
00:34:02,799 --> 00:34:05,200
functionality because sometimes modules

970
00:34:05,200 --> 00:34:06,399
act really weird

971
00:34:06,399 --> 00:34:08,239
um like i've had issues where you know

972
00:34:08,239 --> 00:34:09,440
like if you run seat belt with no

973
00:34:09,440 --> 00:34:12,000
parameters and it's uh through a module

974
00:34:12,000 --> 00:34:14,879
uh it just doesn't work for any or some

975
00:34:14,879 --> 00:34:16,159
reason you think it's broken but if you

976
00:34:16,159 --> 00:34:19,199
add um yeah parameters it runs just fine

977
00:34:19,199 --> 00:34:21,918
so i'll go in here let's kind of display

978
00:34:21,918 --> 00:34:24,239
um modules here so hopefully everyone

979
00:34:24,239 --> 00:34:25,918
can see uh

980
00:34:25,918 --> 00:34:28,480
okay there it goes inside okay so if i

981
00:34:28,480 --> 00:34:30,800
do use module here i'm gonna use the

982
00:34:30,800 --> 00:34:32,879
command line for this and i wanna look

983
00:34:32,879 --> 00:34:35,599
for let's look for seatbelt here so

984
00:34:35,599 --> 00:34:40,000
we'll do c sharp goes past seatbelt

985
00:34:40,239 --> 00:34:43,359
and we now need to set our options so

986
00:34:43,359 --> 00:34:47,040
we're going to set commands

987
00:34:47,040 --> 00:34:49,280
going to do the um i'm going to do

988
00:34:49,280 --> 00:34:50,800
actually the antivirus because that's

989
00:34:50,800 --> 00:34:52,239
the typical one i like to do and then

990
00:34:52,239 --> 00:34:54,960
we'll go execute also you see uh empire

991
00:34:54,960 --> 00:34:57,280
has the command completion so again if

992
00:34:57,280 --> 00:34:58,800
you're scared of cli this is really easy

993
00:34:58,800 --> 00:34:59,680
to use

994
00:34:59,680 --> 00:35:03,118
um here's a c sharp server player

995
00:35:05,920 --> 00:35:08,079
i forgot to do this last time and i did

996
00:35:08,079 --> 00:35:10,160
it again turn on your plug-ins because

997
00:35:10,160 --> 00:35:11,839
c-sharp server might look like it's on

998
00:35:11,839 --> 00:35:14,560
but it's really not now it's on so now

999
00:35:14,560 --> 00:35:17,920
if i go to use module this is good

1000
00:35:17,920 --> 00:35:22,079
execute now we should be able to run

1001
00:35:24,000 --> 00:35:26,240
and

1002
00:35:26,320 --> 00:35:28,320
test it to run

1003
00:35:28,320 --> 00:35:29,440
pause

1004
00:35:29,440 --> 00:35:32,079
pause champ

1005
00:35:32,079 --> 00:35:34,000
gonna get the call back

1006
00:35:34,000 --> 00:35:35,440
uh

1007
00:35:35,440 --> 00:35:36,880
maybe

1008
00:35:36,880 --> 00:35:39,839
you want to work today or no

1009
00:35:39,839 --> 00:35:43,599
oh wait i forget i didn't change this uh

1010
00:35:43,599 --> 00:35:45,599
options

1011
00:35:45,599 --> 00:35:48,079
oh shoot use module

1012
00:35:48,079 --> 00:35:51,520
use module um

1013
00:35:52,160 --> 00:35:53,920
did they use module

1014
00:35:53,920 --> 00:35:56,560
i'm so sorry i totally forgot this uh

1015
00:35:56,560 --> 00:35:59,440
seatbelt

1016
00:35:59,440 --> 00:36:00,240
um

1017
00:36:00,240 --> 00:36:01,359
set

1018
00:36:01,359 --> 00:36:03,839
agent

1019
00:36:07,839 --> 00:36:09,760
xp all right let's try this now maybe

1020
00:36:09,760 --> 00:36:11,040
this will work

1021
00:36:11,040 --> 00:36:13,520
if not uh there's demos what do you

1022
00:36:13,520 --> 00:36:15,759
think

1023
00:36:20,000 --> 00:36:21,839
can you get the call back

1024
00:36:21,839 --> 00:36:23,520
uh maybe not today i guess we didn't

1025
00:36:23,520 --> 00:36:24,960
sacrifice enough cyber votes to the

1026
00:36:24,960 --> 00:36:28,079
demogods unfortunate it is what it is

1027
00:36:28,079 --> 00:36:30,079
though um but yeah that's pretty much

1028
00:36:30,079 --> 00:36:33,119
how you use mutuals again

1029
00:36:35,680 --> 00:36:36,480
um

1030
00:36:36,480 --> 00:36:38,160
i know i don't have a lot of time left

1031
00:36:38,160 --> 00:36:39,520
so beer farmers i promise i'm going to

1032
00:36:39,520 --> 00:36:41,040
finish this up please don't uh please

1033
00:36:41,040 --> 00:36:42,079
open it about it

1034
00:36:42,079 --> 00:36:44,000
we're going to get this done uh very

1035
00:36:44,000 --> 00:36:46,079
soon so um we're going to move on just

1036
00:36:46,079 --> 00:36:47,440
kind of go to going further you kind of

1037
00:36:47,440 --> 00:36:48,880
saw the modules work and stuff like that

1038
00:36:48,880 --> 00:36:50,400
oh actually before i move on i do want

1039
00:36:50,400 --> 00:36:52,240
to mention uh empire specifically their

1040
00:36:52,240 --> 00:36:54,880
modules actually execute inline which as

1041
00:36:54,880 --> 00:36:57,280
a retainer is freaking amazing because

1042
00:36:57,280 --> 00:36:59,040
if you get are able to you know if your

1043
00:36:59,040 --> 00:37:01,760
initial access of the agent that you

1044
00:37:01,760 --> 00:37:03,839
utilize they'll execute on the system it

1045
00:37:03,839 --> 00:37:06,160
wasn't caught by edr and you've got edr

1046
00:37:06,160 --> 00:37:07,760
patched out something like you know

1047
00:37:07,760 --> 00:37:10,079
scarecrow um executing inline means all

1048
00:37:10,079 --> 00:37:11,520
that stuff is also probably not going to

1049
00:37:11,520 --> 00:37:12,800
get caught so you're kind of chilling at

1050
00:37:12,800 --> 00:37:15,359
that point uh so anyway going further um

1051
00:37:15,359 --> 00:37:16,880
i want to give you a quick example of a

1052
00:37:16,880 --> 00:37:18,640
full-scale c2 infrastructure that we've

1053
00:37:18,640 --> 00:37:20,640
got here so you can see we've got three

1054
00:37:20,640 --> 00:37:23,760
c2 servers um two two of our redirectors

1055
00:37:23,760 --> 00:37:25,200
our actual compromise endpoint in our

1056
00:37:25,200 --> 00:37:27,280
internal server so on the left you'll

1057
00:37:27,280 --> 00:37:28,960
see you know these are just kind of c2

1058
00:37:28,960 --> 00:37:30,480
servers that you are used at different

1059
00:37:30,480 --> 00:37:32,640
stages your initial access your post

1060
00:37:32,640 --> 00:37:35,280
exploitation and your recovery system um

1061
00:37:35,280 --> 00:37:37,359
initial access is where obviously you're

1062
00:37:37,359 --> 00:37:38,800
gonna get initial access and it's

1063
00:37:38,800 --> 00:37:40,160
probably the one that's gonna get caught

1064
00:37:40,160 --> 00:37:42,640
um most often post exploitation is you

1065
00:37:42,640 --> 00:37:44,480
know any of you know your lateral

1066
00:37:44,480 --> 00:37:46,320
movement or your privilege escalation

1067
00:37:46,320 --> 00:37:48,079
kind of uh beacons that you might be

1068
00:37:48,079 --> 00:37:49,839
able to get those kind of go to the post

1069
00:37:49,839 --> 00:37:51,839
exploitation server um so the whole

1070
00:37:51,839 --> 00:37:53,680
point is you know initial access servers

1071
00:37:53,680 --> 00:37:55,119
then your post exploitation server

1072
00:37:55,119 --> 00:37:56,720
chillin and then you have your recovery

1073
00:37:56,720 --> 00:37:59,520
server which is basically gonna have a

1074
00:37:59,520 --> 00:38:03,119
crazy long beacon interval um which

1075
00:38:03,119 --> 00:38:04,800
basically means if all else fails if

1076
00:38:04,800 --> 00:38:06,800
initial access and post exploitation

1077
00:38:06,800 --> 00:38:08,480
both get all of their beacons killed you

1078
00:38:08,480 --> 00:38:10,640
can go back to recovery get back some

1079
00:38:10,640 --> 00:38:12,320
shells onto those other servers and

1080
00:38:12,320 --> 00:38:13,599
you'll kind of be chilling not have to

1081
00:38:13,599 --> 00:38:15,119
worry about it

1082
00:38:15,119 --> 00:38:16,400
all right

1083
00:38:16,400 --> 00:38:17,760
a couple more slides then we'll be good

1084
00:38:17,760 --> 00:38:19,839
to go um a couple other c2 options i

1085
00:38:19,839 --> 00:38:21,839
want to bring up and show off here uh

1086
00:38:21,839 --> 00:38:24,320
sliver by bishop fox silent trinity bite

1087
00:38:24,320 --> 00:38:26,960
bleeder sharp c2 by rasta mouse uh

1088
00:38:26,960 --> 00:38:28,800
mythic bite it's a feature covenant by

1089
00:38:28,800 --> 00:38:31,359
cotter and cp3 by f secure these are all

1090
00:38:31,359 --> 00:38:33,040
really awesome platforms there's so many

1091
00:38:33,040 --> 00:38:34,880
options out there there's ct frameworks

1092
00:38:34,880 --> 00:38:36,880
everywhere um these all actually are

1093
00:38:36,880 --> 00:38:38,640
free so you can go try them out right

1094
00:38:38,640 --> 00:38:40,960
now and i highly recommend you do so

1095
00:38:40,960 --> 00:38:42,400
if you're interested in learning more

1096
00:38:42,400 --> 00:38:43,920
because my talk certainly didn't cover

1097
00:38:43,920 --> 00:38:45,520
all of it maybe i did a terrible job

1098
00:38:45,520 --> 00:38:47,200
explaining some things you want some

1099
00:38:47,200 --> 00:38:49,359
someone better to explain um first two

1100
00:38:49,359 --> 00:38:51,200
videos red team operations with global

1101
00:38:51,200 --> 00:38:52,960
strike fighter rafael mudge yes it's

1102
00:38:52,960 --> 00:38:56,160
focused on cobalt strike but it is the

1103
00:38:56,160 --> 00:38:58,160
noob's guide to how to red team and

1104
00:38:58,160 --> 00:38:59,839
there's so much value get out of it even

1105
00:38:59,839 --> 00:39:01,040
if you don't use football strikes so

1106
00:39:01,040 --> 00:39:03,280
yeah gotta watch that series in memory

1107
00:39:03,280 --> 00:39:05,280
of asian by rafael mudge another series

1108
00:39:05,280 --> 00:39:07,200
i haven't watched but i love mud i trust

1109
00:39:07,200 --> 00:39:09,920
his work i'm sure it's a fantastic fit

1110
00:39:09,920 --> 00:39:11,520
um and a deep dive into cobalt strike

1111
00:39:11,520 --> 00:39:14,160
malleable c2 by joe vest i actually read

1112
00:39:14,160 --> 00:39:15,680
that to help prep for this conference

1113
00:39:15,680 --> 00:39:18,000
because i wasn't super duper familiar

1114
00:39:18,000 --> 00:39:20,400
with malibu c2 uh knew the basics but

1115
00:39:20,400 --> 00:39:22,240
not some more detailed information so i

1116
00:39:22,240 --> 00:39:23,920
highly recommend you read that it's it's

1117
00:39:23,920 --> 00:39:27,520
incredible it's super super awesome

1118
00:39:27,520 --> 00:39:28,800
and before we end i do want to give a

1119
00:39:28,800 --> 00:39:30,400
few special thanks to some people out

1120
00:39:30,400 --> 00:39:33,680
there um dan lucier uh for a manager

1121
00:39:33,680 --> 00:39:35,520
that i worked with um giving me a chance

1122
00:39:35,520 --> 00:39:37,119
to learn red teaming just i was just a

1123
00:39:37,119 --> 00:39:38,160
kid he was like hey i really like

1124
00:39:38,160 --> 00:39:39,520
hacking i want to work with your team

1125
00:39:39,520 --> 00:39:41,200
he's like all right sure um so thanks

1126
00:39:41,200 --> 00:39:42,320
for your means to start dan i really

1127
00:39:42,320 --> 00:39:44,160
appreciate it uh red skull for his

1128
00:39:44,160 --> 00:39:45,680
empire knowledge and testing random

1129
00:39:45,680 --> 00:39:47,920
defender bypasses uh with me or testing

1130
00:39:47,920 --> 00:39:49,920
them for me in discord uh appreciate you

1131
00:39:49,920 --> 00:39:52,320
a lot raven uh for being a great the

1132
00:39:52,320 --> 00:39:53,920
ravens being a great mentor especially

1133
00:39:53,920 --> 00:39:55,440
for red teaming and of course they're

1134
00:39:55,440 --> 00:39:58,079
wonderful beer farmers for a great con

1135
00:39:58,079 --> 00:39:59,920
and that brings me to the end finally

1136
00:39:59,920 --> 00:40:02,480
he's going to shut up chat i'm going to

1137
00:40:02,480 --> 00:40:04,880
shut up now um that's all for me of

1138
00:40:04,880 --> 00:40:07,119
course connect with me twitter linkedin

1139
00:40:07,119 --> 00:40:09,839
discord all that kind of stuff um feel

1140
00:40:09,839 --> 00:40:12,160
free uh to connect with me there i love

1141
00:40:12,160 --> 00:40:14,079
talking to red team love talking general

1142
00:40:14,079 --> 00:40:16,560
security um whatever you want uh but

1143
00:40:16,560 --> 00:40:18,640
that's it for me i think i guess

1144
00:40:18,640 --> 00:40:23,640
question time i think question time

1145
00:40:26,000 --> 00:40:28,000
okay sam

1146
00:40:28,000 --> 00:40:29,359
fantastic

1147
00:40:29,359 --> 00:40:30,960
so you're i think the only person that's

1148
00:40:30,960 --> 00:40:33,119
spent an hour and a half speaking at the

1149
00:40:33,119 --> 00:40:34,880
conference today

1150
00:40:34,880 --> 00:40:37,040
so you win the you win the uh endurance

1151
00:40:37,040 --> 00:40:40,400
award so very well done

1152
00:40:40,960 --> 00:40:42,720
could you turn off your screen share so

1153
00:40:42,720 --> 00:40:43,760
we can get

1154
00:40:43,760 --> 00:40:45,920
because we've got uh

1155
00:40:45,920 --> 00:40:47,599
we want to

1156
00:40:47,599 --> 00:40:49,920
do a few things at the end a fascinating

1157
00:40:49,920 --> 00:40:52,720
talk and i have to admire the energy

1158
00:40:52,720 --> 00:40:54,640
in which you deliver it's really

1159
00:40:54,640 --> 00:40:57,440
infectious and you clearly like everyone

1160
00:40:57,440 --> 00:40:59,119
else that's been around today you

1161
00:40:59,119 --> 00:41:00,640
clearly understand your subject matter

1162
00:41:00,640 --> 00:41:02,480
very well indeed

1163
00:41:02,480 --> 00:41:04,240
so

1164
00:41:04,240 --> 00:41:06,240
yeah on behalf of everybody and

1165
00:41:06,240 --> 00:41:07,280
obviously the people that have been

1166
00:41:07,280 --> 00:41:09,200
watching listening in today's thank you

1167
00:41:09,200 --> 00:41:12,240
very much indeed cheers for that thanks

1168
00:41:12,240 --> 00:41:13,119
thanks

1169
00:41:13,119 --> 00:41:15,520
okay

