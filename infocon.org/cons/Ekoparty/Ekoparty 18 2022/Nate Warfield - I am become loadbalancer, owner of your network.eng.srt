1
00:00:04,520 --> 00:00:07,319
it's my first time in Argentina my first

2
00:00:07,319 --> 00:00:09,840
time at Echo party it's been amazing I

3
00:00:09,840 --> 00:00:11,460
wish I spoke better Spanish so I could

4
00:00:11,460 --> 00:00:13,920
deliver this in Spanish to you but you

5
00:00:13,920 --> 00:00:16,139
would be embarrassed if I tried

6
00:00:16,139 --> 00:00:18,300
um so I'm Nate Warfield I am the

7
00:00:18,300 --> 00:00:20,939
director of research and threat Intel at

8
00:00:20,939 --> 00:00:23,160
this company called eclipsium and today

9
00:00:23,160 --> 00:00:25,439
I'm going to teach you how to hack load

10
00:00:25,439 --> 00:00:27,240
balancers better than a Russian threat

11
00:00:27,240 --> 00:00:29,419
group

12
00:00:29,580 --> 00:00:30,779
um the agenda that we're going to go

13
00:00:30,779 --> 00:00:32,700
here is I want to give you a little bit

14
00:00:32,700 --> 00:00:34,980
about my background somewhat of the

15
00:00:34,980 --> 00:00:36,719
motivation that got me to do this

16
00:00:36,719 --> 00:00:39,300
research I'm going to talk about some of

17
00:00:39,300 --> 00:00:41,040
the recent exploits that have been used

18
00:00:41,040 --> 00:00:43,320
against load balancers including one

19
00:00:43,320 --> 00:00:45,960
that came out this year I'm gonna start

20
00:00:45,960 --> 00:00:48,239
talking about a Russian group that has

21
00:00:48,239 --> 00:00:49,800
been documented of attacking these

22
00:00:49,800 --> 00:00:51,899
things and then we're going to get into

23
00:00:51,899 --> 00:00:54,059
some of the actual like deep research

24
00:00:54,059 --> 00:00:55,260
that I did we're going to figure out

25
00:00:55,260 --> 00:00:57,239
we're going to talk about how I really

26
00:00:57,239 --> 00:00:58,860
I'm not I'm not finding exploits in

27
00:00:58,860 --> 00:01:00,180
these devices what I'm doing is I'm

28
00:01:00,180 --> 00:01:02,699
abusing by Design functionality kind of

29
00:01:02,699 --> 00:01:04,619
like Andy was talking about this morning

30
00:01:04,619 --> 00:01:06,299
with Azure where he's just finding

31
00:01:06,299 --> 00:01:09,000
vendor created systems to use in bad

32
00:01:09,000 --> 00:01:10,680
ways

33
00:01:10,680 --> 00:01:13,799
um I have some demos mixed inside here

34
00:01:13,799 --> 00:01:15,060
um yeah actually I've got three three

35
00:01:15,060 --> 00:01:17,640
Demos in here for you and uh with that I

36
00:01:17,640 --> 00:01:19,500
think we'll get going

37
00:01:19,500 --> 00:01:22,740
so I um Nate one of the things that I

38
00:01:22,740 --> 00:01:25,500
would say I'm proudest about doing is in

39
00:01:25,500 --> 00:01:28,439
2020 uh myself my friend Mark Rogers

40
00:01:28,439 --> 00:01:31,320
another gentleman oh hot in Israel as

41
00:01:31,320 --> 00:01:33,900
the pandemic started we saw this need

42
00:01:33,900 --> 00:01:35,579
and this risk of hospitals getting hit

43
00:01:35,579 --> 00:01:37,439
with ransomware

44
00:01:37,439 --> 00:01:39,299
um and the thing that I was looking at

45
00:01:39,299 --> 00:01:41,880
was basically network attack surface in

46
00:01:41,880 --> 00:01:43,619
the specifically a Citrix uh

47
00:01:43,619 --> 00:01:45,619
vulnerability that had come out in

48
00:01:45,619 --> 00:01:48,360
2019. through this we ended up building

49
00:01:48,360 --> 00:01:51,479
a volunteer group of infosec

50
00:01:51,479 --> 00:01:54,840
professionals about 1500 of them across

51
00:01:54,840 --> 00:01:56,159
all of them there's like 100 different

52
00:01:56,159 --> 00:01:58,380
countries I couldn't tell you how many

53
00:01:58,380 --> 00:02:00,060
folks we had in Latin America I'm sorry

54
00:02:00,060 --> 00:02:01,979
but we did have a lot of people from the

55
00:02:01,979 --> 00:02:03,600
US from Europe most of the law

56
00:02:03,600 --> 00:02:05,100
enforcement agencies across those

57
00:02:05,100 --> 00:02:07,439
continents we were written up in Wired

58
00:02:07,439 --> 00:02:09,780
Magazine so it was kind of the one of

59
00:02:09,780 --> 00:02:11,280
the things that we did for good who we

60
00:02:11,280 --> 00:02:12,300
only you know there was no money

61
00:02:12,300 --> 00:02:13,980
involved we were just spending our spare

62
00:02:13,980 --> 00:02:16,020
time trying to defend you know those

63
00:02:16,020 --> 00:02:17,400
people that were trying to you know on

64
00:02:17,400 --> 00:02:18,599
the front lines trying to help through

65
00:02:18,599 --> 00:02:20,340
the pandemic

66
00:02:20,340 --> 00:02:22,319
um I've been hacking networks in and out

67
00:02:22,319 --> 00:02:24,840
since I was about 12 years old for those

68
00:02:24,840 --> 00:02:26,640
old people like me I was over at dial-up

69
00:02:26,640 --> 00:02:28,800
modem at 2400 baud has anybody else used

70
00:02:28,800 --> 00:02:30,360
a dial-up modem at that speed in this

71
00:02:30,360 --> 00:02:33,000
room oh sweet way more than I thought

72
00:02:33,000 --> 00:02:34,920
that's awesome

73
00:02:34,920 --> 00:02:36,780
um I do security research

74
00:02:36,780 --> 00:02:38,220
um a lot of what I do is mostly kind of

75
00:02:38,220 --> 00:02:40,560
network stuff I've been doing a bunch of

76
00:02:40,560 --> 00:02:42,239
talks in the last few years mostly on

77
00:02:42,239 --> 00:02:44,580
the defensive side of the house I did

78
00:02:44,580 --> 00:02:45,959
have the illustrious honor of working

79
00:02:45,959 --> 00:02:47,940
for F5 Networks who is one of the

80
00:02:47,940 --> 00:02:49,379
vendors we're going to completely

81
00:02:49,379 --> 00:02:51,720
destroy today I worked there for about

82
00:02:51,720 --> 00:02:54,420
10 years I spent seven of those years

83
00:02:54,420 --> 00:02:56,459
attached to the Microsoft account so

84
00:02:56,459 --> 00:02:59,099
I've helped deploy thousands of these

85
00:02:59,099 --> 00:03:01,019
things in every configuration you can

86
00:03:01,019 --> 00:03:03,300
imagine I've also overseen the largest

87
00:03:03,300 --> 00:03:05,340
outage in Microsoft DNS history was

88
00:03:05,340 --> 00:03:06,780
caused by one of these things you can

89
00:03:06,780 --> 00:03:09,060
ask me about that later

90
00:03:09,060 --> 00:03:10,440
um then when I went to Microsoft I

91
00:03:10,440 --> 00:03:12,599
worked for the msrc I was on the Patch

92
00:03:12,599 --> 00:03:14,819
Tuesday team I have the dubious honor of

93
00:03:14,819 --> 00:03:16,319
being one of the people that shipped the

94
00:03:16,319 --> 00:03:19,080
wannacry patch if anybody had installed

95
00:03:19,080 --> 00:03:20,519
it I could brag about it but I just kind

96
00:03:20,519 --> 00:03:22,260
of tell it now

97
00:03:22,260 --> 00:03:24,420
um and then I worked for Defender and I

98
00:03:24,420 --> 00:03:25,440
want to point out that I'm not a red

99
00:03:25,440 --> 00:03:27,300
teamer so there's probably better ways

100
00:03:27,300 --> 00:03:28,680
to do what I'm going to show you that

101
00:03:28,680 --> 00:03:30,480
I'm doing the point is in that the point

102
00:03:30,480 --> 00:03:31,980
is that it took me a couple of weeks to

103
00:03:31,980 --> 00:03:33,300
figure this out

104
00:03:33,300 --> 00:03:34,800
um and it's like I said better than the

105
00:03:34,800 --> 00:03:37,379
Russians uh my Twitter handle is here

106
00:03:37,379 --> 00:03:39,000
that's probably the easiest way to reach

107
00:03:39,000 --> 00:03:42,000
me and that's enough about me let's talk

108
00:03:42,000 --> 00:03:43,440
about why I did this

109
00:03:43,440 --> 00:03:45,120
so like I mentioned the Citrix

110
00:03:45,120 --> 00:03:48,900
vulnerability is what started CTI League

111
00:03:48,900 --> 00:03:50,819
um I ended up through that summer doing

112
00:03:50,819 --> 00:03:52,980
getting pulled into do incident response

113
00:03:52,980 --> 00:03:55,019
there was a vulnerability in the summer

114
00:03:55,019 --> 00:03:58,319
of 2020 that came out that we basically

115
00:03:58,319 --> 00:04:00,480
spent the entire in the Fourth of July

116
00:04:00,480 --> 00:04:01,860
holiday in the United States our

117
00:04:01,860 --> 00:04:03,959
independence day we worked the entire

118
00:04:03,959 --> 00:04:05,400
three-day weekend trying to protect

119
00:04:05,400 --> 00:04:08,580
people from this come Monday the exploit

120
00:04:08,580 --> 00:04:10,560
code was dropped hundreds and hundreds

121
00:04:10,560 --> 00:04:11,939
and hundreds of systems across the world

122
00:04:11,939 --> 00:04:14,459
started getting hacked Microsoft's

123
00:04:14,459 --> 00:04:15,959
system started getting hacked so they

124
00:04:15,959 --> 00:04:17,579
pulled me in to try to do incident

125
00:04:17,579 --> 00:04:20,220
responses apparently out of a 225 000

126
00:04:20,220 --> 00:04:21,600
person company I was still the only

127
00:04:21,600 --> 00:04:22,860
person that knew these things well

128
00:04:22,860 --> 00:04:26,340
enough to like try to do IR on them

129
00:04:26,340 --> 00:04:28,320
um and I also wanted a chance to do some

130
00:04:28,320 --> 00:04:29,699
sort of offensive research right I've

131
00:04:29,699 --> 00:04:31,259
mostly done

132
00:04:31,259 --> 00:04:33,060
um defensive things and try to protect

133
00:04:33,060 --> 00:04:34,560
things but this was an opportunity for

134
00:04:34,560 --> 00:04:36,360
me to say hey these things are becoming

135
00:04:36,360 --> 00:04:37,800
attacked more and more I have that

136
00:04:37,800 --> 00:04:39,360
hacker mindset I know these things

137
00:04:39,360 --> 00:04:41,340
really well I'll bet people don't know

138
00:04:41,340 --> 00:04:43,020
them that well so let me see if I can

139
00:04:43,020 --> 00:04:44,880
develop some stuff that at least I can

140
00:04:44,880 --> 00:04:46,860
warn people about

141
00:04:46,860 --> 00:04:51,419
and fortunately for me back in May right

142
00:04:51,419 --> 00:04:52,919
before the F5 exploit we're going to

143
00:04:52,919 --> 00:04:55,139
talk about uh came out mandian did this

144
00:04:55,139 --> 00:04:56,759
really interesting report that we're

145
00:04:56,759 --> 00:04:58,620
going to get into so it was sort of um

146
00:04:58,620 --> 00:05:01,380
it was sort of uh gave me some light

147
00:05:01,380 --> 00:05:02,580
like

148
00:05:02,580 --> 00:05:05,280
trying to think of the word here it

149
00:05:05,280 --> 00:05:06,960
validated what I was doing right I was

150
00:05:06,960 --> 00:05:08,100
like okay this is actually useful

151
00:05:08,100 --> 00:05:09,660
information because mandian's talking

152
00:05:09,660 --> 00:05:11,160
about a threat actor abusing these

153
00:05:11,160 --> 00:05:13,500
things people will actually care

154
00:05:13,500 --> 00:05:15,540
and nobody understands this space right

155
00:05:15,540 --> 00:05:16,620
like I said I was the one guy at

156
00:05:16,620 --> 00:05:18,180
Microsoft that knew it

157
00:05:18,180 --> 00:05:20,340
um does anybody here run like F5 or

158
00:05:20,340 --> 00:05:23,659
Citrix devices in their Network

159
00:05:24,000 --> 00:05:25,919
not us oh one

160
00:05:25,919 --> 00:05:27,180
two

161
00:05:27,180 --> 00:05:29,280
three four okay cool well this might be

162
00:05:29,280 --> 00:05:30,720
really useful for you does anybody like

163
00:05:30,720 --> 00:05:32,340
to hack into Network Hardware in this

164
00:05:32,340 --> 00:05:33,660
room

165
00:05:33,660 --> 00:05:35,520
oh come on there's got to be more of you

166
00:05:35,520 --> 00:05:37,199
than that all right well either way

167
00:05:37,199 --> 00:05:38,580
you're going to have fun

168
00:05:38,580 --> 00:05:41,160
all right so the brief history of load

169
00:05:41,160 --> 00:05:43,259
balancing exploits they're having fun

170
00:05:43,259 --> 00:05:44,639
out there

171
00:05:44,639 --> 00:05:48,180
um so in 2012 when I worked for F5 uh

172
00:05:48,180 --> 00:05:50,639
there was an exploit that came out that

173
00:05:50,639 --> 00:05:53,100
damn

174
00:05:53,100 --> 00:05:55,080
there's an exploit that came out that I

175
00:05:55,080 --> 00:05:57,479
have a microphone they don't uh it was

176
00:05:57,479 --> 00:05:59,759
basically they left a root SSH key pair

177
00:05:59,759 --> 00:06:02,039
in an ISO image somebody figured out how

178
00:06:02,039 --> 00:06:04,620
to unpack it pull the try the private

179
00:06:04,620 --> 00:06:06,000
key off of it and then they were able to

180
00:06:06,000 --> 00:06:08,160
SSH into any of these F5s management

181
00:06:08,160 --> 00:06:10,860
sides as root so that was the first real

182
00:06:10,860 --> 00:06:12,600
vulnerability that actually was reported

183
00:06:12,600 --> 00:06:16,560
to F5 the first one they ever gave a cve

184
00:06:16,560 --> 00:06:18,479
um in 2019 as I mentioned the Citrix

185
00:06:18,479 --> 00:06:20,340
vulnerability came out

186
00:06:20,340 --> 00:06:21,840
um it was actually the technique that

187
00:06:21,840 --> 00:06:23,940
was used as a path traversal which is

188
00:06:23,940 --> 00:06:25,740
kind of common knowledge now it wasn't

189
00:06:25,740 --> 00:06:27,660
in 2019 but it should have been because

190
00:06:27,660 --> 00:06:30,479
in 2018 orange Psy who if you don't know

191
00:06:30,479 --> 00:06:32,580
who he is I suggest you go look up proxy

192
00:06:32,580 --> 00:06:33,419
shell and all the exchange

193
00:06:33,419 --> 00:06:35,100
vulnerabilities he's the guy that found

194
00:06:35,100 --> 00:06:37,500
those he voted at a black hat talk

195
00:06:37,500 --> 00:06:39,360
talking about past traversals and how

196
00:06:39,360 --> 00:06:41,580
you could do all these evil things so 18

197
00:06:41,580 --> 00:06:44,460
months or so later this comes out nobody

198
00:06:44,460 --> 00:06:46,620
paid attention the POC for the Citrix

199
00:06:46,620 --> 00:06:48,360
vulnerability was quite literally in his

200
00:06:48,360 --> 00:06:49,680
slides

201
00:06:49,680 --> 00:06:51,360
uh not to be outdone by their biggest

202
00:06:51,360 --> 00:06:53,639
competitor a few months later F5 decided

203
00:06:53,639 --> 00:06:54,900
to have their own past traversal

204
00:06:54,900 --> 00:06:56,100
vulnerability

205
00:06:56,100 --> 00:06:58,020
um this would give you access to a the

206
00:06:58,020 --> 00:07:00,120
Java servlet page implementation of

207
00:07:00,120 --> 00:07:02,819
their API which is actually completely

208
00:07:02,819 --> 00:07:04,259
undocumented on their website nobody

209
00:07:04,259 --> 00:07:06,240
knows really why it's there

210
00:07:06,240 --> 00:07:07,800
uh and then like I said this beautiful

211
00:07:07,800 --> 00:07:09,720
one came out in May this year

212
00:07:09,720 --> 00:07:11,100
um I was going to originally do this

213
00:07:11,100 --> 00:07:13,080
talk with the 2020 vulnerability and I

214
00:07:13,080 --> 00:07:14,759
kind of died a little inside because

215
00:07:14,759 --> 00:07:16,380
it's extremely complicated and it

216
00:07:16,380 --> 00:07:18,479
doesn't work very well this new one

217
00:07:18,479 --> 00:07:20,580
quite literally gives you Json output it

218
00:07:20,580 --> 00:07:22,080
looks just like the shell so it made a

219
00:07:22,080 --> 00:07:23,660
lot of this a lot more fun

220
00:07:23,660 --> 00:07:26,160
these things wide scale exploitation

221
00:07:26,160 --> 00:07:28,560
happens quickly with Citrix with

222
00:07:28,560 --> 00:07:30,660
actually with the first F5 one nobody

223
00:07:30,660 --> 00:07:32,280
really knew it was there we don't know

224
00:07:32,280 --> 00:07:33,900
if anybody exploited it F5 certainly

225
00:07:33,900 --> 00:07:36,599
isn't going to tell you with Citrix I

226
00:07:36,599 --> 00:07:38,160
did a talk about this a couple years ago

227
00:07:38,160 --> 00:07:40,319
it was about four days from when the POC

228
00:07:40,319 --> 00:07:42,120
was dropped on the internet to when wide

229
00:07:42,120 --> 00:07:44,940
scale exploitation started the 2020 F5

230
00:07:44,940 --> 00:07:47,400
vulnerability it was about a day or so

231
00:07:47,400 --> 00:07:49,380
from when POC came out this most recent

232
00:07:49,380 --> 00:07:51,539
F5 vulnerability is a matter of hours so

233
00:07:51,539 --> 00:07:52,979
like the window to get these things

234
00:07:52,979 --> 00:07:54,840
fixed keeps getting smaller and smaller

235
00:07:54,840 --> 00:07:56,520
and smaller

236
00:07:56,520 --> 00:07:57,599
um and I also have this thing about

237
00:07:57,599 --> 00:07:59,280
exploits that fit in tweets like it's a

238
00:07:59,280 --> 00:08:01,080
90 000 piece of equipment and you can

239
00:08:01,080 --> 00:08:04,199
hack it with a tweet so that's fun

240
00:08:04,199 --> 00:08:06,120
so we're going to go into the one from

241
00:08:06,120 --> 00:08:08,220
um from this this year this 2021 so

242
00:08:08,220 --> 00:08:10,139
you'll get a little bit more of the

243
00:08:10,139 --> 00:08:12,419
architecture here in a minute but the

244
00:08:12,419 --> 00:08:13,740
long and short of it is what you do is

245
00:08:13,740 --> 00:08:16,740
you send a request to the management IP

246
00:08:16,740 --> 00:08:18,780
address and I'm highlighting and red the

247
00:08:18,780 --> 00:08:21,240
stuff that's bad so this management path

248
00:08:21,240 --> 00:08:23,699
is essentially an implementation of the

249
00:08:23,699 --> 00:08:25,800
bash shell that can be reached from

250
00:08:25,800 --> 00:08:28,560
their own proprietary TM shell

251
00:08:28,560 --> 00:08:31,020
what you do next is you forge the

252
00:08:31,020 --> 00:08:33,120
referrer and the host to be localhost

253
00:08:33,120 --> 00:08:35,520
the reason for this is that when this is

254
00:08:35,520 --> 00:08:37,919
working as designed you're supposed to

255
00:08:37,919 --> 00:08:39,659
be authenticated against the system so

256
00:08:39,659 --> 00:08:41,700
there's an authenticated token in the UI

257
00:08:41,700 --> 00:08:46,140
that the um the the Java Tomcat engine

258
00:08:46,140 --> 00:08:48,600
then forwards this request inside to the

259
00:08:48,600 --> 00:08:49,980
database that runs all of their

260
00:08:49,980 --> 00:08:51,779
configuration and says hey can I run

261
00:08:51,779 --> 00:08:54,060
this command so when we say referrer is

262
00:08:54,060 --> 00:08:55,860
localhost and host is localhost it's

263
00:08:55,860 --> 00:08:57,300
just spoofing that where this request is

264
00:08:57,300 --> 00:08:58,680
coming you know the call is coming from

265
00:08:58,680 --> 00:09:00,240
inside the house

266
00:09:00,240 --> 00:09:02,459
but here's the worst part what they did

267
00:09:02,459 --> 00:09:04,200
was they allowed it so that you could

268
00:09:04,200 --> 00:09:06,240
you can maybe see there's a comma after

269
00:09:06,240 --> 00:09:08,339
this connection closed what it allowed

270
00:09:08,339 --> 00:09:10,080
you to do was it allowed you to stick an

271
00:09:10,080 --> 00:09:12,600
i5 authentication token into the end of

272
00:09:12,600 --> 00:09:14,459
the connection close header and the F5

273
00:09:14,459 --> 00:09:16,140
would be like okay cool you're

274
00:09:16,140 --> 00:09:18,720
authenticated that authorization basic

275
00:09:18,720 --> 00:09:20,760
string is literally admin Horizon 3

276
00:09:20,760 --> 00:09:22,740
Horizon 3 was the company that actually

277
00:09:22,740 --> 00:09:25,320
wrote the first POC for this and then

278
00:09:25,320 --> 00:09:26,760
you'll notice that on the bottom of that

279
00:09:26,760 --> 00:09:28,440
header the F5 off header is basically

280
00:09:28,440 --> 00:09:30,720
blank so all it needed to do was say hey

281
00:09:30,720 --> 00:09:32,459
if it comes from localhost if it has

282
00:09:32,459 --> 00:09:34,200
this F5 auth token inside the request

283
00:09:34,200 --> 00:09:36,420
cool it's authenticated the lesson here

284
00:09:36,420 --> 00:09:38,100
is don't authenticate Things based on a

285
00:09:38,100 --> 00:09:39,839
header value like this is literally 20

286
00:09:39,839 --> 00:09:41,820
year old bugs right

287
00:09:41,820 --> 00:09:44,519
uh and then once you do that you just

288
00:09:44,519 --> 00:09:46,080
pass in the data command that says Okay

289
00:09:46,080 --> 00:09:48,060
I want to run whatever you know bash

290
00:09:48,060 --> 00:09:50,820
command I want in this instance you're

291
00:09:50,820 --> 00:09:53,220
basically saying run the ID command on

292
00:09:53,220 --> 00:09:54,540
the command line of the device to tell

293
00:09:54,540 --> 00:09:56,600
you that hey you're root

294
00:09:56,600 --> 00:09:59,279
so that was the sort of exploitation

295
00:09:59,279 --> 00:10:01,380
thing and then this mandian report comes

296
00:10:01,380 --> 00:10:02,459
out in May

297
00:10:02,459 --> 00:10:03,600
um and I'm going to let you kind of read

298
00:10:03,600 --> 00:10:04,920
some of these details but some of the

299
00:10:04,920 --> 00:10:06,000
things that I thought was interesting

300
00:10:06,000 --> 00:10:07,680
when I read this was you know they talk

301
00:10:07,680 --> 00:10:09,240
about going after these Network

302
00:10:09,240 --> 00:10:11,820
appliances putting back doors on Santa

303
00:10:11,820 --> 00:10:13,920
arrays load balancers

304
00:10:13,920 --> 00:10:16,380
um you know things with BSD and Centos

305
00:10:16,380 --> 00:10:18,600
operating systems they even say would

306
00:10:18,600 --> 00:10:20,640
require considerable planning to compile

307
00:10:20,640 --> 00:10:22,260
functional malware for them which is

308
00:10:22,260 --> 00:10:25,260
like uh yes and no then they start

309
00:10:25,260 --> 00:10:26,940
talking about their their back door

310
00:10:26,940 --> 00:10:28,800
which is basically a modified drop bear

311
00:10:28,800 --> 00:10:30,959
SSH client with hard-coded credentials

312
00:10:30,959 --> 00:10:32,880
inside it that didn't actually run that

313
00:10:32,880 --> 00:10:35,220
well and it wasn't persistent so if the

314
00:10:35,220 --> 00:10:36,899
thing got rebooted and for sure if it

315
00:10:36,899 --> 00:10:38,339
ever got upgraded or patched their

316
00:10:38,339 --> 00:10:41,040
access is going to go away

317
00:10:41,040 --> 00:10:42,300
um they even tried to make this thing

318
00:10:42,300 --> 00:10:43,440
persistent right they said they are

319
00:10:43,440 --> 00:10:44,880
going to put it into cron but it didn't

320
00:10:44,880 --> 00:10:46,200
actually do it right or it tries to

321
00:10:46,200 --> 00:10:47,760
change itself named a cron it didn't

322
00:10:47,760 --> 00:10:48,779
work

323
00:10:48,779 --> 00:10:50,279
um it was so bad that they actually had

324
00:10:50,279 --> 00:10:52,260
to put a web shell on these some some of

325
00:10:52,260 --> 00:10:53,459
these systems so they could use the web

326
00:10:53,459 --> 00:10:55,140
shell to restart their implant which is

327
00:10:55,140 --> 00:10:58,440
just apt I don't think so

328
00:10:58,440 --> 00:10:59,459
um and they're going but they're doing

329
00:10:59,459 --> 00:11:00,300
the right thing they're going after

330
00:11:00,300 --> 00:11:01,980
devices that are hard to monitor right

331
00:11:01,980 --> 00:11:04,079
they don't have AV they don't have EDR

332
00:11:04,079 --> 00:11:05,700
they're these big expensive Network

333
00:11:05,700 --> 00:11:07,260
switches that nobody wants to touch

334
00:11:07,260 --> 00:11:08,700
because it's like you don't touch a core

335
00:11:08,700 --> 00:11:09,899
router unless you have to you don't

336
00:11:09,899 --> 00:11:11,779
touch a load balancer unless you have to

337
00:11:11,779 --> 00:11:14,399
Mandy believes that these are attributed

338
00:11:14,399 --> 00:11:15,779
to a Russian threat group more of a

339
00:11:15,779 --> 00:11:17,579
cyber Espionage than like a you know

340
00:11:17,579 --> 00:11:20,220
sand worm or any of those folks but they

341
00:11:20,220 --> 00:11:22,260
do have techniques that overlap apt 28

342
00:11:22,260 --> 00:11:24,540
and 29 right attribute attribution is

343
00:11:24,540 --> 00:11:26,579
hard in this industry

344
00:11:26,579 --> 00:11:28,079
so I didn't really think this is very

345
00:11:28,079 --> 00:11:29,760
impressive I said you need a web shelf

346
00:11:29,760 --> 00:11:31,440
to restart your implant like that's

347
00:11:31,440 --> 00:11:34,079
that's like script Kitty stuff right

348
00:11:34,079 --> 00:11:35,459
um it was also weird that they were

349
00:11:35,459 --> 00:11:36,839
going to go and use all this Custom

350
00:11:36,839 --> 00:11:38,100
Design drop bear and they're going to

351
00:11:38,100 --> 00:11:39,360
compile it with credentials it's like

352
00:11:39,360 --> 00:11:41,040
why go to all this work like if you're

353
00:11:41,040 --> 00:11:42,660
not going to write something cool like

354
00:11:42,660 --> 00:11:45,240
in Destroyer or you know stuxnet like

355
00:11:45,240 --> 00:11:46,800
don't waste your time if you're like

356
00:11:46,800 --> 00:11:48,779
custom code is crap

357
00:11:48,779 --> 00:11:50,339
um there was no persistence right I was

358
00:11:50,339 --> 00:11:51,959
like okay this is cute but if you reboot

359
00:11:51,959 --> 00:11:53,579
the box or maybe if you just let it sit

360
00:11:53,579 --> 00:11:54,959
long enough it turns off right this

361
00:11:54,959 --> 00:11:57,420
isn't very Advanced and I was like I can

362
00:11:57,420 --> 00:11:58,620
do better right and I kind of wanted to

363
00:11:58,620 --> 00:11:59,940
say hey can I do better than a Russian

364
00:11:59,940 --> 00:12:01,440
threat actor like I don't have a leopard

365
00:12:01,440 --> 00:12:02,760
print Lamborghini but I can probably

366
00:12:02,760 --> 00:12:05,040
hack a computer better than them

367
00:12:05,040 --> 00:12:07,800
so the reconnaissance phase this really

368
00:12:07,800 --> 00:12:10,560
boils down to I read the docs I RTF end

369
00:12:10,560 --> 00:12:12,120
and I figured this out like if I can do

370
00:12:12,120 --> 00:12:13,440
this you can do this and the scary thing

371
00:12:13,440 --> 00:12:15,720
is is the Russians can too there's going

372
00:12:15,720 --> 00:12:17,040
to come a day when somebody's going to

373
00:12:17,040 --> 00:12:18,360
refer to this talk and they'll be like

374
00:12:18,360 --> 00:12:19,980
this guy told those guys how to do this

375
00:12:19,980 --> 00:12:21,839
thing we should be mad at that guy not

376
00:12:21,839 --> 00:12:23,820
the vendor but that guy

377
00:12:23,820 --> 00:12:25,920
uh you hit her here first so load

378
00:12:25,920 --> 00:12:27,540
bouncers what are they

379
00:12:27,540 --> 00:12:28,980
um these are basically just big of them

380
00:12:28,980 --> 00:12:30,839
as big pieces of networking equipment I

381
00:12:30,839 --> 00:12:32,339
could have put a photo in there it

382
00:12:32,339 --> 00:12:33,540
doesn't really matter if you've ever

383
00:12:33,540 --> 00:12:35,339
seen a gigantic network switch or a

384
00:12:35,339 --> 00:12:37,320
thing with a hundred ethernet jacks on

385
00:12:37,320 --> 00:12:38,880
it that's all they look like you know

386
00:12:38,880 --> 00:12:40,680
they they come in everything from a 1u

387
00:12:40,680 --> 00:12:44,100
to a for you like they cost starting at

388
00:12:44,100 --> 00:12:45,600
around ninety thousand dollars up to

389
00:12:45,600 --> 00:12:46,860
about three quarters of a million

390
00:12:46,860 --> 00:12:49,260
dollars a piece and they believe they

391
00:12:49,260 --> 00:12:51,000
generally buy them in pairs of devices

392
00:12:51,000 --> 00:12:52,800
so if one fails then they can flip it

393
00:12:52,800 --> 00:12:54,180
over to the other one

394
00:12:54,180 --> 00:12:55,320
um if you've done any sort of network

395
00:12:55,320 --> 00:12:57,600
engineering that was one of my things I

396
00:12:57,600 --> 00:13:00,420
did most of my career hsrp or hot

397
00:13:00,420 --> 00:13:01,980
standby router protocol is a very

398
00:13:01,980 --> 00:13:04,079
similar technology where the gateway

399
00:13:04,079 --> 00:13:05,700
address that all of your resources are

400
00:13:05,700 --> 00:13:07,620
talking to never goes away just sort of

401
00:13:07,620 --> 00:13:09,420
switches from one ethernet port to the

402
00:13:09,420 --> 00:13:12,540
next and the servers have no idea

403
00:13:12,540 --> 00:13:15,839
these things do layer four layer 7 load

404
00:13:15,839 --> 00:13:17,579
balancing they're used as web

405
00:13:17,579 --> 00:13:20,459
application firewalls sometimes because

406
00:13:20,459 --> 00:13:22,200
these companies like to sort of uh

407
00:13:22,200 --> 00:13:23,880
shoehorn every piece of functionality

408
00:13:23,880 --> 00:13:26,160
into them they also do VPN endpoint

409
00:13:26,160 --> 00:13:29,899
stuff their load balanced DNS

410
00:13:31,019 --> 00:13:33,440
they will also do SSL and TLS offloading

411
00:13:33,440 --> 00:13:35,700
one of the big selling points was these

412
00:13:35,700 --> 00:13:38,040
things had really powerful SSL chips so

413
00:13:38,040 --> 00:13:39,720
you could you know buy one certificate

414
00:13:39,720 --> 00:13:42,480
process lots of SSL

415
00:13:42,480 --> 00:13:44,040
um the generally are deployed in places

416
00:13:44,040 --> 00:13:46,079
where they have full network access a

417
00:13:46,079 --> 00:13:47,339
common way they do this is you plug it

418
00:13:47,339 --> 00:13:49,260
in you put a big ethernet trunk tag a

419
00:13:49,260 --> 00:13:50,820
bunch of vlans and then you can just

420
00:13:50,820 --> 00:13:52,139
talk to whatever networks you need to

421
00:13:52,139 --> 00:13:53,459
load balance or you need to if you've

422
00:13:53,459 --> 00:13:54,839
got database servers you need to talk to

423
00:13:54,839 --> 00:13:56,700
these servers it all goes through the

424
00:13:56,700 --> 00:13:58,800
load balancer

425
00:13:58,800 --> 00:14:00,180
um they technically people will say we

426
00:14:00,180 --> 00:14:01,680
say they run a firmware technically it's

427
00:14:01,680 --> 00:14:03,959
a full-blown operating system and as I

428
00:14:03,959 --> 00:14:05,459
mentioned before they're proprietary

429
00:14:05,459 --> 00:14:07,019
there's no EDR that runs here nobody

430
00:14:07,019 --> 00:14:09,180
makes one there's no antivirus you mean

431
00:14:09,180 --> 00:14:11,339
ndr stuff you can put it upstream or

432
00:14:11,339 --> 00:14:13,200
Downstream but none of these Solutions

433
00:14:13,200 --> 00:14:14,880
have a system that supports any of this

434
00:14:14,880 --> 00:14:16,019
stuff so you basically have remote

435
00:14:16,019 --> 00:14:17,940
syslog

436
00:14:17,940 --> 00:14:19,800
and remote syslog

437
00:14:19,800 --> 00:14:22,560
um so internally and this is the idea

438
00:14:22,560 --> 00:14:23,760
here is if you're going to go hacking

439
00:14:23,760 --> 00:14:25,380
these things part of this is to teach

440
00:14:25,380 --> 00:14:27,120
you what they are and how I hacked them

441
00:14:27,120 --> 00:14:28,560
but if you're going to go and hack these

442
00:14:28,560 --> 00:14:30,660
things as say a red team engagement this

443
00:14:30,660 --> 00:14:32,700
is how to do it and not get caught so we

444
00:14:32,700 --> 00:14:34,139
understand these devices have what they

445
00:14:34,139 --> 00:14:35,760
call a data plane and then they have

446
00:14:35,760 --> 00:14:37,380
what's called a control plane the data

447
00:14:37,380 --> 00:14:39,000
plane is where all of the load balancing

448
00:14:39,000 --> 00:14:41,880
proprietary vendor magic next-gen super

449
00:14:41,880 --> 00:14:44,220
gen whatever they call it stuff that

450
00:14:44,220 --> 00:14:46,079
they sell it for happens and the control

451
00:14:46,079 --> 00:14:48,360
plane is literally a Linux or a BSD

452
00:14:48,360 --> 00:14:50,880
operating system it's stripped down like

453
00:14:50,880 --> 00:14:52,380
they take all the compilers out they

454
00:14:52,380 --> 00:14:54,360
take out Python 3 so all the fun tools

455
00:14:54,360 --> 00:14:56,600
like impact it and responder don't work

456
00:14:56,600 --> 00:14:58,620
and but they do have some stuff like

457
00:14:58,620 --> 00:15:02,100
ldap tools SMB you've got KRON TCP dump

458
00:15:02,100 --> 00:15:04,199
and that cat some of the standard

459
00:15:04,199 --> 00:15:05,639
command line stuff but it's more than

460
00:15:05,639 --> 00:15:07,320
like a busy box installation you'll find

461
00:15:07,320 --> 00:15:09,420
on an iot router right

462
00:15:09,420 --> 00:15:11,760
uh and the nice thing about these things

463
00:15:11,760 --> 00:15:14,339
is for us most people manage these via a

464
00:15:14,339 --> 00:15:15,839
GUI right it's got this big sexy web

465
00:15:15,839 --> 00:15:17,519
interface nobody wants to deal with a

466
00:15:17,519 --> 00:15:18,660
command line that's where most of your

467
00:15:18,660 --> 00:15:19,920
admins live

468
00:15:19,920 --> 00:15:21,360
um but the full show access is what we

469
00:15:21,360 --> 00:15:23,040
get to abuse as hackers

470
00:15:23,040 --> 00:15:25,320
uh and then because of these things

471
00:15:25,320 --> 00:15:27,480
having SSL termination they keep SSL

472
00:15:27,480 --> 00:15:29,459
certs and keys on the file system not in

473
00:15:29,459 --> 00:15:30,959
an encrypted Vault not in a Hardware

474
00:15:30,959 --> 00:15:32,940
security module by default

475
00:15:32,940 --> 00:15:35,820
um just as a text file and this is for

476
00:15:35,820 --> 00:15:37,800
example what an f5's config directory

477
00:15:37,800 --> 00:15:39,600
looks like there's this is just from my

478
00:15:39,600 --> 00:15:41,100
VM like this isn't a machine that's been

479
00:15:41,100 --> 00:15:42,720
running for that long so there's inside

480
00:15:42,720 --> 00:15:45,480
this directory structure what 1032 files

481
00:15:45,480 --> 00:15:46,980
like tell me you're going to find my two

482
00:15:46,980 --> 00:15:49,560
bad files out of 1032.

483
00:15:49,560 --> 00:15:50,880
so

484
00:15:50,880 --> 00:15:53,220
the capabilities of these things if

485
00:15:53,220 --> 00:15:54,660
you're hacking into one of these what

486
00:15:54,660 --> 00:15:55,740
you don't want to do is you don't want

487
00:15:55,740 --> 00:15:57,720
to touch the data plane it's all used as

488
00:15:57,720 --> 00:15:59,279
very proprietary configuration stuff

489
00:15:59,279 --> 00:16:01,440
it's handling production traffic you

490
00:16:01,440 --> 00:16:02,940
know if you screw something up here and

491
00:16:02,940 --> 00:16:04,500
knock a website offline or knock a

492
00:16:04,500 --> 00:16:05,940
server pool offline like it's going to

493
00:16:05,940 --> 00:16:07,320
set off alarms people are going to come

494
00:16:07,320 --> 00:16:09,839
looking you're going to get caught now

495
00:16:09,839 --> 00:16:11,160
there is some stuff you'll see in the

496
00:16:11,160 --> 00:16:12,839
long form demo where I know how what I'm

497
00:16:12,839 --> 00:16:14,279
doing and I'm going to hack into I'm

498
00:16:14,279 --> 00:16:16,320
going to hack the data plane to do some

499
00:16:16,320 --> 00:16:18,420
evil things and you'll see that later

500
00:16:18,420 --> 00:16:19,860
but the control plane is pretty much

501
00:16:19,860 --> 00:16:21,839
safe right it's just a Linux vsd system

502
00:16:21,839 --> 00:16:23,639
you can screw around in here as long as

503
00:16:23,639 --> 00:16:24,839
you don't do something so they like run

504
00:16:24,839 --> 00:16:27,360
a gigantic logic bomb and crash the

505
00:16:27,360 --> 00:16:29,459
control plane you'll be good to go most

506
00:16:29,459 --> 00:16:30,959
of these things the apples on their like

507
00:16:30,959 --> 00:16:32,459
device interfaces can be changed

508
00:16:32,459 --> 00:16:34,920
nobody's going to notice it

509
00:16:34,920 --> 00:16:35,880
um the only thing you really have to

510
00:16:35,880 --> 00:16:36,959
worry about is if they're doing remote

511
00:16:36,959 --> 00:16:38,699
logging and if they're using remote

512
00:16:38,699 --> 00:16:40,980
authentication because if you maybe try

513
00:16:40,980 --> 00:16:42,300
to brute force it they'll see it if

514
00:16:42,300 --> 00:16:43,560
you're doing something bad they might

515
00:16:43,560 --> 00:16:45,060
pick it up in their log server or their

516
00:16:45,060 --> 00:16:46,440
you know Splunk or whatever they've got

517
00:16:46,440 --> 00:16:47,519
going

518
00:16:47,519 --> 00:16:49,920
uh and they also have capabilities for

519
00:16:49,920 --> 00:16:51,839
most they basically just keep slapping

520
00:16:51,839 --> 00:16:53,399
functionality on these so F5 when I

521
00:16:53,399 --> 00:16:55,740
started working there in 2001 basically

522
00:16:55,740 --> 00:16:58,980
did HTTP and SSL load balancing now the

523
00:16:58,980 --> 00:17:00,240
last time I heard of them they actually

524
00:17:00,240 --> 00:17:02,339
can run they're running inside 5G cell

525
00:17:02,339 --> 00:17:03,660
networks they're doing all these crazy

526
00:17:03,660 --> 00:17:05,760
protocol things that the 5G networks use

527
00:17:05,760 --> 00:17:07,980
they will continue to add functionality

528
00:17:07,980 --> 00:17:09,839
to provide to support network providers

529
00:17:09,839 --> 00:17:11,880
regardless of what it is which is also

530
00:17:11,880 --> 00:17:13,679
where they get in trouble

531
00:17:13,679 --> 00:17:15,359
and the other fun thing that we're going

532
00:17:15,359 --> 00:17:16,859
to talk about a little later in the demo

533
00:17:16,859 --> 00:17:20,400
F5s let you manipulate HTTP headers with

534
00:17:20,400 --> 00:17:21,959
cookies to do persistence but you can

535
00:17:21,959 --> 00:17:24,780
also do tcltk inspection of traffic and

536
00:17:24,780 --> 00:17:27,359
manipulation in real time that is a very

537
00:17:27,359 --> 00:17:29,640
complex thing to do but it's all sorts

538
00:17:29,640 --> 00:17:32,160
of evil things you can do if you know it

539
00:17:32,160 --> 00:17:33,299
now

540
00:17:33,299 --> 00:17:35,039
to their questionable design decisions

541
00:17:35,039 --> 00:17:37,559
they decided to enable the GUI in SSH on

542
00:17:37,559 --> 00:17:39,179
every single device IP when you turn

543
00:17:39,179 --> 00:17:41,760
this box on now those of us that use

544
00:17:41,760 --> 00:17:43,799
networks or network devices are used to

545
00:17:43,799 --> 00:17:45,179
having you know a switch and then

546
00:17:45,179 --> 00:17:46,799
there's an actual port a physical Port

547
00:17:46,799 --> 00:17:48,600
that you plug in to your management

548
00:17:48,600 --> 00:17:50,100
backplane right and that's the only

549
00:17:50,100 --> 00:17:51,720
place the management can people can

550
00:17:51,720 --> 00:17:54,240
connect to F5 on the other hand says

551
00:17:54,240 --> 00:17:55,799
well we'll do that but then all of the

552
00:17:55,799 --> 00:17:57,840
other device IPS those sort of hsrp

553
00:17:57,840 --> 00:17:59,760
addresses we're going to put the

554
00:17:59,760 --> 00:18:01,440
management on enable it by default on

555
00:18:01,440 --> 00:18:02,940
all of those too and they don't really

556
00:18:02,940 --> 00:18:05,940
tell you this and you can get all of

557
00:18:05,940 --> 00:18:07,260
these things get the GUI all of these

558
00:18:07,260 --> 00:18:08,520
things get the fully interactive bash

559
00:18:08,520 --> 00:18:10,679
shell if you can get into the box

560
00:18:10,679 --> 00:18:12,720
the other fun thing is that because

561
00:18:12,720 --> 00:18:13,980
they're Linux based and they haven't

562
00:18:13,980 --> 00:18:16,559
figured it out yet the data plane and

563
00:18:16,559 --> 00:18:18,120
the control plane share a routing table

564
00:18:18,120 --> 00:18:19,799
which may not seem like that interesting

565
00:18:19,799 --> 00:18:22,200
Until you realize well if I can get into

566
00:18:22,200 --> 00:18:23,880
the management network from say you know

567
00:18:23,880 --> 00:18:25,140
somebody's desktop and some

568
00:18:25,140 --> 00:18:26,940
administrator desktop and I can see the

569
00:18:26,940 --> 00:18:28,320
management interface but it doesn't have

570
00:18:28,320 --> 00:18:30,179
an internet gateway you can still hack

571
00:18:30,179 --> 00:18:31,440
in through the management and you can

572
00:18:31,440 --> 00:18:32,700
talk out through the internet from that

573
00:18:32,700 --> 00:18:34,200
side right there's no separation of

574
00:18:34,200 --> 00:18:36,299
those two planes

575
00:18:36,299 --> 00:18:37,679
um and then my favorite part and what's

576
00:18:37,679 --> 00:18:39,000
going to be really fun is they have

577
00:18:39,000 --> 00:18:41,100
multiple by Design documented ways to

578
00:18:41,100 --> 00:18:43,440
run scripts on these things it's all in

579
00:18:43,440 --> 00:18:44,880
the command line You'll never see any of

580
00:18:44,880 --> 00:18:46,440
this stuff in the GUI you can run it

581
00:18:46,440 --> 00:18:48,059
when they boot you can run it when they

582
00:18:48,059 --> 00:18:50,039
fail over you can run it on a syslog

583
00:18:50,039 --> 00:18:51,720
message fires and you can just configure

584
00:18:51,720 --> 00:18:53,700
all these things in a script there is

585
00:18:53,700 --> 00:18:55,080
literally no way to see this stuff if

586
00:18:55,080 --> 00:18:56,580
you're a GUI administrator you have to

587
00:18:56,580 --> 00:18:57,900
go on the command line and you have to

588
00:18:57,900 --> 00:18:59,640
know what you're looking for

589
00:18:59,640 --> 00:19:01,500
and the other fun thing too is like I

590
00:19:01,500 --> 00:19:02,760
showed you the screenshot of that

591
00:19:02,760 --> 00:19:04,260
configuration directory it's huge

592
00:19:04,260 --> 00:19:05,880
there's tons of places we can hide

593
00:19:05,880 --> 00:19:07,799
there's no Integrity checking on any of

594
00:19:07,799 --> 00:19:09,600
the files they don't have a list of like

595
00:19:09,600 --> 00:19:11,400
specifically only these files can be

596
00:19:11,400 --> 00:19:13,860
backed up like they just basically zip

597
00:19:13,860 --> 00:19:15,900
the whole thing up

598
00:19:15,900 --> 00:19:18,840
which is where we're going to go next so

599
00:19:18,840 --> 00:19:21,480
what they do when you upgrade these

600
00:19:21,480 --> 00:19:23,880
things let's click that in so their

601
00:19:23,880 --> 00:19:25,320
backup file is essentially just a

602
00:19:25,320 --> 00:19:27,539
tarball and when these devices are

603
00:19:27,539 --> 00:19:28,919
upgraded you know you've got two of them

604
00:19:28,919 --> 00:19:30,840
the process is essentially you take the

605
00:19:30,840 --> 00:19:32,400
one that's not processing traffic what

606
00:19:32,400 --> 00:19:34,380
they call the standby device you say I'm

607
00:19:34,380 --> 00:19:35,940
going to install the latest and greatest

608
00:19:35,940 --> 00:19:37,440
version or I'm just going to install a

609
00:19:37,440 --> 00:19:38,760
security patch for the vulnerability

610
00:19:38,760 --> 00:19:40,860
that Nate exploited what it does is it

611
00:19:40,860 --> 00:19:42,539
lays down the operating system into a

612
00:19:42,539 --> 00:19:43,980
new boot location if you think of like

613
00:19:43,980 --> 00:19:45,720
multi-booting Windows and Linux exact

614
00:19:45,720 --> 00:19:48,240
same thing so it lays it down puts all

615
00:19:48,240 --> 00:19:49,679
of the operating system files in there

616
00:19:49,679 --> 00:19:51,120
and then what it does is it says okay

617
00:19:51,120 --> 00:19:52,500
I'm going to zip up all of my

618
00:19:52,500 --> 00:19:54,480
configuration on this installation I'm

619
00:19:54,480 --> 00:19:55,440
going to copy it over to that

620
00:19:55,440 --> 00:19:57,900
installation I'm going to unpack it no

621
00:19:57,900 --> 00:19:59,640
Integrity checking

622
00:19:59,640 --> 00:20:01,020
um the same file is what's used for

623
00:20:01,020 --> 00:20:02,760
device backups right this is the thing

624
00:20:02,760 --> 00:20:04,260
that it's it's sort of the master file

625
00:20:04,260 --> 00:20:06,179
for you restore your FIS back up your

626
00:20:06,179 --> 00:20:08,280
F5s take configuration snapshots you use

627
00:20:08,280 --> 00:20:10,140
this thing too and then they have

628
00:20:10,140 --> 00:20:11,820
another fun thing which is there is one

629
00:20:11,820 --> 00:20:14,160
partition that is shared between all

630
00:20:14,160 --> 00:20:15,900
bootable operating system versions right

631
00:20:15,900 --> 00:20:18,059
because they're not patching it on that

632
00:20:18,059 --> 00:20:19,559
running system so every time you install

633
00:20:19,559 --> 00:20:21,299
it basically lays down a brand new fresh

634
00:20:21,299 --> 00:20:23,760
copy so they do need a place to keep

635
00:20:23,760 --> 00:20:25,140
stuff that they might want to persist

636
00:20:25,140 --> 00:20:26,640
across different installs like your

637
00:20:26,640 --> 00:20:28,380
statistic stuff like how much traffic is

638
00:20:28,380 --> 00:20:29,700
this thing processed in 30 days so

639
00:20:29,700 --> 00:20:31,260
there's actually a partition where you

640
00:20:31,260 --> 00:20:32,640
can drop things and it'll stay

641
00:20:32,640 --> 00:20:34,380
regardless of which boot version you're

642
00:20:34,380 --> 00:20:36,000
in

643
00:20:36,000 --> 00:20:38,940
so persistence the easy way the first

644
00:20:38,940 --> 00:20:40,799
thing I started doing was looking at how

645
00:20:40,799 --> 00:20:43,380
can I just get this stuff to run on

646
00:20:43,380 --> 00:20:45,960
either failover State change or logging

647
00:20:45,960 --> 00:20:49,080
messages so this paths and I will post

648
00:20:49,080 --> 00:20:50,940
these slides to GitHub probably tomorrow

649
00:20:50,940 --> 00:20:52,799
so if you want to follow me on Twitter I

650
00:20:52,799 --> 00:20:55,080
always tweet the link out I realize now

651
00:20:55,080 --> 00:20:56,400
looking at them this might be a little

652
00:20:56,400 --> 00:20:58,620
hard to read in the back but this config

653
00:20:58,620 --> 00:21:00,660
failover and then there's five files in

654
00:21:00,660 --> 00:21:02,220
there's an activist standby and then

655
00:21:02,220 --> 00:21:03,780
five three different files that start

656
00:21:03,780 --> 00:21:06,140
with TG which is a traffic group thing

657
00:21:06,140 --> 00:21:08,220
this string underneath it is all you

658
00:21:08,220 --> 00:21:09,480
need to put into one of those files

659
00:21:09,480 --> 00:21:11,340
basically you'll notice that there's

660
00:21:11,340 --> 00:21:13,320
that minus C like we saw in the exploit

661
00:21:13,320 --> 00:21:15,780
tmsh is their shell we sell it run util

662
00:21:15,780 --> 00:21:18,720
bash with a command of I also hide my

663
00:21:18,720 --> 00:21:20,400
job of my Runner script inside this

664
00:21:20,400 --> 00:21:22,260
failover directory we'll get to that in

665
00:21:22,260 --> 00:21:23,940
a minute so it just says okay run the

666
00:21:23,940 --> 00:21:25,380
script when the device goes standby when

667
00:21:25,380 --> 00:21:26,880
is goes active when the traffic group

668
00:21:26,880 --> 00:21:29,039
any of these changes of state it'll run

669
00:21:29,039 --> 00:21:31,380
the script the next one is the syslog

670
00:21:31,380 --> 00:21:33,360
message where I say okay if you see a

671
00:21:33,360 --> 00:21:35,039
monitor status down like when a web

672
00:21:35,039 --> 00:21:39,020
server goes up or down run the script

673
00:21:39,480 --> 00:21:41,280
so the script

674
00:21:41,280 --> 00:21:43,919
what I did obviously I used their

675
00:21:43,919 --> 00:21:45,840
exploit and then the script that I wrote

676
00:21:45,840 --> 00:21:48,299
I took from their website I didn't

677
00:21:48,299 --> 00:21:49,679
actually have to do much with this I was

678
00:21:49,679 --> 00:21:50,880
like well how do I write a script that

679
00:21:50,880 --> 00:21:52,140
runs after the device starts up they're

680
00:21:52,140 --> 00:21:53,400
like here's a solution that shows you

681
00:21:53,400 --> 00:21:56,159
how to do it it's like thank you F5 and

682
00:21:56,159 --> 00:21:57,960
then I use sliver C2 and if you have

683
00:21:57,960 --> 00:21:59,400
made anybody here's heard of sliversity

684
00:21:59,400 --> 00:22:00,360
too

685
00:22:00,360 --> 00:22:02,820
I know you have Andy okay a few of you

686
00:22:02,820 --> 00:22:04,380
so sliver is actually really cool you've

687
00:22:04,380 --> 00:22:05,580
probably okay how many here people have

688
00:22:05,580 --> 00:22:07,260
heard of cobalt strike

689
00:22:07,260 --> 00:22:09,840
okay yes so sliver is like a Cobalt

690
00:22:09,840 --> 00:22:11,400
strike but it's free it's written in go

691
00:22:11,400 --> 00:22:13,200
it's awesome um I actually got to meet

692
00:22:13,200 --> 00:22:14,820
the developer of it from Bishop Fox a

693
00:22:14,820 --> 00:22:15,960
couple months ago

694
00:22:15,960 --> 00:22:18,600
um it's a really solid robust uh C2

695
00:22:18,600 --> 00:22:20,159
framework now I have never used Cobalt

696
00:22:20,159 --> 00:22:21,539
strike or brute Mattel or any of those

697
00:22:21,539 --> 00:22:22,980
so I couldn't tell you how it Compares

698
00:22:22,980 --> 00:22:24,720
but I think it's great because like I

699
00:22:24,720 --> 00:22:26,340
said it's free

700
00:22:26,340 --> 00:22:28,140
and then I wrote a script

701
00:22:28,140 --> 00:22:30,480
um this script essentially the parts you

702
00:22:30,480 --> 00:22:32,039
care about are sort of below the

703
00:22:32,039 --> 00:22:33,900
comments about a secured rest Java D

704
00:22:33,900 --> 00:22:35,880
does not exist and what it does is when

705
00:22:35,880 --> 00:22:37,799
it's run it sleeps for a few seconds a

706
00:22:37,799 --> 00:22:39,299
random number of seconds and this is to

707
00:22:39,299 --> 00:22:40,500
prevent

708
00:22:40,500 --> 00:22:41,880
um I don't want this thing to start more

709
00:22:41,880 --> 00:22:44,039
than one copy of the C2 right if it goes

710
00:22:44,039 --> 00:22:46,020
crazy if I run it from KRON maybe I'm

711
00:22:46,020 --> 00:22:47,640
going to get 50 copies of this process

712
00:22:47,640 --> 00:22:48,900
running and if someone says well there's

713
00:22:48,900 --> 00:22:50,400
a weird activity happening and they find

714
00:22:50,400 --> 00:22:52,080
50 copies of the same process they're

715
00:22:52,080 --> 00:22:54,000
gonna be like well that's not good so

716
00:22:54,000 --> 00:22:55,380
basically just checks and says hey is

717
00:22:55,380 --> 00:22:58,200
anybody running no cool I'll run if it's

718
00:22:58,200 --> 00:23:00,120
not on the device it says okay well if

719
00:23:00,120 --> 00:23:02,220
it's not here I'm gonna go grab it now

720
00:23:02,220 --> 00:23:04,860
F5 tries to mount their slash user file

721
00:23:04,860 --> 00:23:06,419
system as read-only it's a security

722
00:23:06,419 --> 00:23:09,059
thing so we just remounted to read write

723
00:23:09,059 --> 00:23:11,940
we grab it and then we time stomp it by

724
00:23:11,940 --> 00:23:13,140
essentially saying okay I'm gonna go

725
00:23:13,140 --> 00:23:15,059
pull the time stamp off of a binary in

726
00:23:15,059 --> 00:23:18,600
user bin like sis CTL or systemctl time

727
00:23:18,600 --> 00:23:20,940
Stomp the implant binary with that time

728
00:23:20,940 --> 00:23:23,340
stamp mount it to read only again start

729
00:23:23,340 --> 00:23:24,960
it the idea is if somebody goes in and

730
00:23:24,960 --> 00:23:26,280
says what's this process running user

731
00:23:26,280 --> 00:23:28,020
being arrested Java D what is that oh

732
00:23:28,020 --> 00:23:29,700
well it came it's the same time stamp as

733
00:23:29,700 --> 00:23:33,240
everything on my device it must be fine

734
00:23:33,240 --> 00:23:35,280
and also we could if we wanted to oh

735
00:23:35,280 --> 00:23:36,780
hold on a second let me go back before I

736
00:23:36,780 --> 00:23:40,320
before this goes uh go there we go uh if

737
00:23:40,320 --> 00:23:41,580
we wanted to we could put the implant

738
00:23:41,580 --> 00:23:43,140
into the backup like we could store it

739
00:23:43,140 --> 00:23:45,120
in the config file system the problem is

740
00:23:45,120 --> 00:23:47,880
is go implants are like 16 Megs so it's

741
00:23:47,880 --> 00:23:49,440
a little big and you might get noticed

742
00:23:49,440 --> 00:23:51,059
if all of a sudden like one day their

743
00:23:51,059 --> 00:23:53,159
backup goes from five Megs to 21 Megs

744
00:23:53,159 --> 00:23:54,419
that's weird

745
00:23:54,419 --> 00:23:57,240
so here is the first demo this is

746
00:23:57,240 --> 00:23:59,520
persistence via syslog this you'll see

747
00:23:59,520 --> 00:24:00,780
the sliver screen

748
00:24:00,780 --> 00:24:02,460
you're going to see me start tailing the

749
00:24:02,460 --> 00:24:04,740
log files on the F5 or actually first

750
00:24:04,740 --> 00:24:06,900
I'm going to show you that config that I

751
00:24:06,900 --> 00:24:08,460
wrote and then we're going to watch the

752
00:24:08,460 --> 00:24:10,440
log files and then the screen below this

753
00:24:10,440 --> 00:24:12,299
is my Apache web server that's just set

754
00:24:12,299 --> 00:24:13,559
up you'll notice sliver has nothing

755
00:24:13,559 --> 00:24:15,720
going we're going to turn off Apache

756
00:24:15,720 --> 00:24:17,520
you're going to see some log messages

757
00:24:17,520 --> 00:24:21,299
spew up here on this F5 screen now it's

758
00:24:21,299 --> 00:24:24,559
sleeping for the random seconds

759
00:24:26,400 --> 00:24:28,799
and then there comes the C2 right so it

760
00:24:28,799 --> 00:24:30,240
just popped back and now I have a shell

761
00:24:30,240 --> 00:24:32,460
on this F5 right just all it did was do

762
00:24:32,460 --> 00:24:33,840
it's what it's supposed to do and we're

763
00:24:33,840 --> 00:24:35,100
in

764
00:24:35,100 --> 00:24:36,600
so

765
00:24:36,600 --> 00:24:38,820
the other fun thing about these devices

766
00:24:38,820 --> 00:24:41,400
is that their architecture allows you an

767
00:24:41,400 --> 00:24:43,320
ability to Pivot

768
00:24:43,320 --> 00:24:44,940
um what they don't the way these are

769
00:24:44,940 --> 00:24:46,500
designed is when you when you deploy

770
00:24:46,500 --> 00:24:48,419
them you've got you know the devices and

771
00:24:48,419 --> 00:24:50,580
a bunch of vlans it's acting as the

772
00:24:50,580 --> 00:24:51,840
default gateway for all of your web

773
00:24:51,840 --> 00:24:54,179
servers traffic will say come in from

774
00:24:54,179 --> 00:24:55,799
the Internet it's passed through the

775
00:24:55,799 --> 00:24:57,780
device it passes it along to the web

776
00:24:57,780 --> 00:24:59,520
server the web server says okay it's an

777
00:24:59,520 --> 00:25:00,780
internet machine I'm going to pass it to

778
00:25:00,780 --> 00:25:03,600
my default gateway everything works now

779
00:25:03,600 --> 00:25:05,700
if you you have to manually configure

780
00:25:05,700 --> 00:25:07,260
the device to say I want to let this web

781
00:25:07,260 --> 00:25:09,179
server initiate a connection on its own

782
00:25:09,179 --> 00:25:11,220
out to the internet right and so unless

783
00:25:11,220 --> 00:25:13,260
you go and say specifically let these

784
00:25:13,260 --> 00:25:14,820
servers talk to the internet it won't

785
00:25:14,820 --> 00:25:16,500
let them do it right this is a secure by

786
00:25:16,500 --> 00:25:18,419
default thing that they talk about

787
00:25:18,419 --> 00:25:21,600
except it's not sliver allows you to do

788
00:25:21,600 --> 00:25:25,320
uh pivoting so essentially I can drop a

789
00:25:25,320 --> 00:25:27,059
sliver implant on an F5

790
00:25:27,059 --> 00:25:28,740
and then I can drop an implant on a

791
00:25:28,740 --> 00:25:31,140
Windows Server say and that Windows

792
00:25:31,140 --> 00:25:32,880
Server can't get to the internet but if

793
00:25:32,880 --> 00:25:35,340
my sliver implant can talk to my C2 and

794
00:25:35,340 --> 00:25:37,080
my server can talk to my sliver implant

795
00:25:37,080 --> 00:25:38,760
I can now get that server out to the

796
00:25:38,760 --> 00:25:40,980
internet and the F5 is none the wiser I

797
00:25:40,980 --> 00:25:42,960
couldn't believe that I was able to bind

798
00:25:42,960 --> 00:25:46,919
a Daemon to a port on a networking piece

799
00:25:46,919 --> 00:25:48,539
of Hardware I was for sure this wasn't

800
00:25:48,539 --> 00:25:50,640
going to work it turned out all I needed

801
00:25:50,640 --> 00:25:52,320
to do was open up the axle on the port

802
00:25:52,320 --> 00:25:54,360
and it was perfectly fine like it kind

803
00:25:54,360 --> 00:25:56,159
of blew my mind

804
00:25:56,159 --> 00:25:58,080
yes like I said it lets you bind these

805
00:25:58,080 --> 00:26:00,240
listeners to the failover addresses

806
00:26:00,240 --> 00:26:02,940
um you can find as many as you want

807
00:26:02,940 --> 00:26:05,460
um you can the the changing of the

808
00:26:05,460 --> 00:26:08,159
device apples will never show up uh in a

809
00:26:08,159 --> 00:26:10,200
configuration right so what I mentioned

810
00:26:10,200 --> 00:26:12,299
don't touch the the device configs I

811
00:26:12,299 --> 00:26:14,279
left out a part which is that the F5s

812
00:26:14,279 --> 00:26:16,559
and I think the Citrix is as well what

813
00:26:16,559 --> 00:26:18,419
they do is they they have a process that

814
00:26:18,419 --> 00:26:19,919
kind of checks you know hey do we have

815
00:26:19,919 --> 00:26:21,120
the same config to make sure if

816
00:26:21,120 --> 00:26:22,260
something happens they're not going to

817
00:26:22,260 --> 00:26:23,880
like all of a sudden fail over to the

818
00:26:23,880 --> 00:26:26,100
old and last month's configuration

819
00:26:26,100 --> 00:26:27,900
so they're smart enough that if you go

820
00:26:27,900 --> 00:26:30,000
and change part of the load balancing or

821
00:26:30,000 --> 00:26:32,039
the the data plane configuration on one

822
00:26:32,039 --> 00:26:34,200
device the other device will pop up with

823
00:26:34,200 --> 00:26:35,940
a warning saying hey configurations are

824
00:26:35,940 --> 00:26:38,400
out of sync right and if your admins are

825
00:26:38,400 --> 00:26:39,840
paying attention and if they're logged

826
00:26:39,840 --> 00:26:41,880
into the console or if they have some

827
00:26:41,880 --> 00:26:44,400
sort of a SNMP trap setup they might

828
00:26:44,400 --> 00:26:46,440
notice this that's not true when you're

829
00:26:46,440 --> 00:26:47,760
touching the device specific

830
00:26:47,760 --> 00:26:49,980
configuration I can add routes I can add

831
00:26:49,980 --> 00:26:52,559
DNS servers I can like open apples on

832
00:26:52,559 --> 00:26:54,419
the device I can open up if the device

833
00:26:54,419 --> 00:26:55,620
isn't allowed to talk to the internet

834
00:26:55,620 --> 00:26:57,059
because it has an apple saying this

835
00:26:57,059 --> 00:26:58,500
device can't go to the internet if I'm

836
00:26:58,500 --> 00:26:59,940
rude I can get rid of that Apple like

837
00:26:59,940 --> 00:27:01,679
this will never show up and it will all

838
00:27:01,679 --> 00:27:04,140
get saved it'll be in the backup files

839
00:27:04,140 --> 00:27:05,640
it's just it's kind of amazing that

840
00:27:05,640 --> 00:27:07,380
there's so little oversight into like

841
00:27:07,380 --> 00:27:10,200
the most important part of these things

842
00:27:10,200 --> 00:27:12,240
and like I said any of these default

843
00:27:12,240 --> 00:27:15,179
gateways or router C2 now In fairness to

844
00:27:15,179 --> 00:27:17,159
F5 into Citrix I went and started

845
00:27:17,159 --> 00:27:19,140
looking like is this a common

846
00:27:19,140 --> 00:27:20,700
um is this common right is it like is

847
00:27:20,700 --> 00:27:22,440
this just these two vendors implemented

848
00:27:22,440 --> 00:27:24,659
it stupidly uh it turns out not um

849
00:27:24,659 --> 00:27:27,000
Juniper routers do the same thing by

850
00:27:27,000 --> 00:27:29,159
default the control plane and the data

851
00:27:29,159 --> 00:27:30,480
plane will share routes if somebody

852
00:27:30,480 --> 00:27:32,580
needs a default gateway and one side has

853
00:27:32,580 --> 00:27:34,500
it it gets used

854
00:27:34,500 --> 00:27:37,140
um A10 does the same thing A10 is an

855
00:27:37,140 --> 00:27:39,059
interesting case they were actually one

856
00:27:39,059 --> 00:27:41,880
of f5's bigger competitors and I grabbed

857
00:27:41,880 --> 00:27:43,620
a virtual machine of their stuff they

858
00:27:43,620 --> 00:27:46,140
don't let you have a full shell they

859
00:27:46,140 --> 00:27:47,940
only give you a restricted shell and as

860
00:27:47,940 --> 00:27:51,120
it turns out these techniques are very

861
00:27:51,120 --> 00:27:53,820
very difficult darn near impossible if

862
00:27:53,820 --> 00:27:55,140
you don't have an interactive shell when

863
00:27:55,140 --> 00:27:56,640
they restrict you to only the specific

864
00:27:56,640 --> 00:27:58,620
set of commands that you're allowed to

865
00:27:58,620 --> 00:28:00,419
run you can't get into the file system

866
00:28:00,419 --> 00:28:01,919
like I did you can't figure out okay

867
00:28:01,919 --> 00:28:04,020
what can I run um you know how can I

868
00:28:04,020 --> 00:28:05,760
hide things

869
00:28:05,760 --> 00:28:08,159
um Citrix has initially what looks to be

870
00:28:08,159 --> 00:28:09,659
a restricted shell when you log in

871
00:28:09,659 --> 00:28:10,919
except that they have have a command

872
00:28:10,919 --> 00:28:13,020
called literally shell that gives you a

873
00:28:13,020 --> 00:28:14,880
bash shell so that's how we're able to

874
00:28:14,880 --> 00:28:16,380
do what we'll talk about with Citrix a

875
00:28:16,380 --> 00:28:18,539
little later

876
00:28:18,539 --> 00:28:21,000
so I'm going to let you this this is

877
00:28:21,000 --> 00:28:23,100
going to run in a loop so this is

878
00:28:23,100 --> 00:28:25,140
basically an example of what happens if

879
00:28:25,140 --> 00:28:28,740
you infect a backup file on this F5

880
00:28:28,740 --> 00:28:30,419
now like I mentioned these full archives

881
00:28:30,419 --> 00:28:32,940
are dangerous and what's going to happen

882
00:28:32,940 --> 00:28:34,919
here just so I'm going to talk over this

883
00:28:34,919 --> 00:28:36,779
right now it's loading a configuration

884
00:28:36,779 --> 00:28:39,900
on an F5 that has this malware inside it

885
00:28:39,900 --> 00:28:41,640
and it takes a little while because it

886
00:28:41,640 --> 00:28:43,380
takes a long time to initialize and

887
00:28:43,380 --> 00:28:45,419
other things but

888
00:28:45,419 --> 00:28:46,740
the thing about these that it's

889
00:28:46,740 --> 00:28:48,179
interesting and why these archives are

890
00:28:48,179 --> 00:28:50,640
dangerous is that like both of these

891
00:28:50,640 --> 00:28:52,860
devices do support what we call a flat

892
00:28:52,860 --> 00:28:54,840
configuration file

893
00:28:54,840 --> 00:28:56,340
um they use like a Cisco router if

894
00:28:56,340 --> 00:28:58,500
you've ever used one of those it'll

895
00:28:58,500 --> 00:28:59,820
actually just you know you copy you can

896
00:28:59,820 --> 00:29:01,500
copy the thing off put it in notepad

897
00:29:01,500 --> 00:29:03,480
paste it back on you see the C2 just

898
00:29:03,480 --> 00:29:06,000
popped up after the config install we're

899
00:29:06,000 --> 00:29:07,140
going to let that run while I keep

900
00:29:07,140 --> 00:29:08,760
talking through this

901
00:29:08,760 --> 00:29:10,380
um so they have these flat configs and

902
00:29:10,380 --> 00:29:11,700
those are safer right because you go to

903
00:29:11,700 --> 00:29:13,559
a Cisco router you show running config

904
00:29:13,559 --> 00:29:15,240
you copy it off there's no way there's

905
00:29:15,240 --> 00:29:16,440
going to be any malware in there and

906
00:29:16,440 --> 00:29:17,820
even if there was something malicious

907
00:29:17,820 --> 00:29:20,220
you'd be able to see it right that five

908
00:29:20,220 --> 00:29:21,840
and Citrix have been basically required

909
00:29:21,840 --> 00:29:23,460
by their customers to do the same thing

910
00:29:23,460 --> 00:29:25,620
but it kind of works but it doesn't

911
00:29:25,620 --> 00:29:27,539
really work so most customers at least

912
00:29:27,539 --> 00:29:30,419
when I worked at F5 the 30 000 customers

913
00:29:30,419 --> 00:29:32,220
we had at the time nobody used the flat

914
00:29:32,220 --> 00:29:33,960
configuration everybody used the archive

915
00:29:33,960 --> 00:29:35,340
version

916
00:29:35,340 --> 00:29:37,620
so these view scripts are of course

917
00:29:37,620 --> 00:29:39,480
included in the config backup which is

918
00:29:39,480 --> 00:29:41,480
why we're able to do this

919
00:29:41,480 --> 00:29:43,799
and then the reason that this is

920
00:29:43,799 --> 00:29:46,140
happening you'll notice that the startup

921
00:29:46,140 --> 00:29:47,880
there's failover and there's syslog

922
00:29:47,880 --> 00:29:50,179
right now none of these actions say

923
00:29:50,179 --> 00:29:52,980
installation but what happens is that

924
00:29:52,980 --> 00:29:55,020
when you install this configuration on a

925
00:29:55,020 --> 00:29:56,340
device it says okay I'm going to take

926
00:29:56,340 --> 00:29:57,720
all this stuff I'm going to load it up

927
00:29:57,720 --> 00:30:00,059
and then as as it starts to come online

928
00:30:00,059 --> 00:30:01,980
it goes and looks and it says do I have

929
00:30:01,980 --> 00:30:03,600
a failover partner because I need to

930
00:30:03,600 --> 00:30:05,220
figure out whether I should go active or

931
00:30:05,220 --> 00:30:07,020
standby and you see where I'm going with

932
00:30:07,020 --> 00:30:08,880
this and then once it figures out what

933
00:30:08,880 --> 00:30:10,799
to do it says okay cool run the failover

934
00:30:10,799 --> 00:30:12,419
script for active or run the failover

935
00:30:12,419 --> 00:30:14,700
script for standby and that's what kicks

936
00:30:14,700 --> 00:30:18,179
this off and so the I use this failover

937
00:30:18,179 --> 00:30:20,940
star because then the the long form demo

938
00:30:20,940 --> 00:30:22,679
we're going to go through I basically

939
00:30:22,679 --> 00:30:24,240
just spray that payload at all of the

940
00:30:24,240 --> 00:30:25,620
scripts inside that directory just to

941
00:30:25,620 --> 00:30:27,240
make sure you know it's the only way to

942
00:30:27,240 --> 00:30:28,620
you know infect them all from orbit it's

943
00:30:28,620 --> 00:30:31,260
the only way to be sure

944
00:30:31,260 --> 00:30:33,779
all right so this is the actual long

945
00:30:33,779 --> 00:30:35,580
form demo this is the longest number

946
00:30:35,580 --> 00:30:37,260
I've ever seen at like four four now

947
00:30:37,260 --> 00:30:38,820
four minutes um and I'm going to talk

948
00:30:38,820 --> 00:30:40,679
you through this I'm going to try not to

949
00:30:40,679 --> 00:30:41,760
go too fast

950
00:30:41,760 --> 00:30:44,100
um but it is complex so bear with me

951
00:30:44,100 --> 00:30:46,340
here

952
00:30:46,799 --> 00:30:50,340
let me give you before we do this the in

953
00:30:50,340 --> 00:30:52,200
for the architecture of this lab network

954
00:30:52,200 --> 00:30:54,059
is essentially this

955
00:30:54,059 --> 00:30:55,980
um there's two F5 devices they're a

956
00:30:55,980 --> 00:30:58,080
failover pair behind them is a Windows

957
00:30:58,080 --> 00:30:59,580
Server these things are talking through

958
00:30:59,580 --> 00:31:01,860
a router that goes out to the internet

959
00:31:01,860 --> 00:31:03,179
um and my attack is coming from

960
00:31:03,179 --> 00:31:04,559
essentially A system that would be

961
00:31:04,559 --> 00:31:06,419
inside the network they can talk on the

962
00:31:06,419 --> 00:31:07,740
management side the management

963
00:31:07,740 --> 00:31:09,360
interfaces cannot talk to the Internet

964
00:31:09,360 --> 00:31:11,159
so this is that design scenario I was

965
00:31:11,159 --> 00:31:12,720
telling you about where you'd secure

966
00:31:12,720 --> 00:31:14,520
management it can talk to the Internet

967
00:31:14,520 --> 00:31:16,320
so it can pass web traffic and that's

968
00:31:16,320 --> 00:31:18,240
that's what I just need you to know

969
00:31:18,240 --> 00:31:21,179
before we go into this all right so what

970
00:31:21,179 --> 00:31:22,799
I'm doing here is kind of showing this

971
00:31:22,799 --> 00:31:25,440
stuff right these are the two F5 guis

972
00:31:25,440 --> 00:31:27,899
this is our you know goodguy.com website

973
00:31:27,899 --> 00:31:29,159
that our customers go to and they're

974
00:31:29,159 --> 00:31:31,799
like oh these guys are so good

975
00:31:31,799 --> 00:31:32,820
um and then what we're going to start

976
00:31:32,820 --> 00:31:35,039
doing on the F5 here is I'm showing you

977
00:31:35,039 --> 00:31:36,659
this is watching the logs right we're

978
00:31:36,659 --> 00:31:37,980
gonna there's a few things I didn't get

979
00:31:37,980 --> 00:31:40,260
into for time constraints but what I'm

980
00:31:40,260 --> 00:31:41,760
going to show you is keeping stealthy

981
00:31:41,760 --> 00:31:43,679
the export will let you turn off syslog

982
00:31:43,679 --> 00:31:46,020
so you'll notice when I do this it shows

983
00:31:46,020 --> 00:31:47,520
me that a configuration a command was

984
00:31:47,520 --> 00:31:49,860
actually right this is okay an admin's

985
00:31:49,860 --> 00:31:51,899
on the box doing something right if I'm

986
00:31:51,899 --> 00:31:53,399
trying to hack in I want to be stealthy

987
00:31:53,399 --> 00:31:54,779
so I'm going to go and turn off syslog

988
00:31:54,779 --> 00:31:56,399
and see how nice it is it even tells me

989
00:31:56,399 --> 00:31:57,720
it echoes back the command line

990
00:31:57,720 --> 00:32:00,419
prompting shutting down syslog and now

991
00:32:00,419 --> 00:32:01,860
you'll notice as I'm basically looking

992
00:32:01,860 --> 00:32:03,600
to find the other device that nothing's

993
00:32:03,600 --> 00:32:05,700
going to show up in the F5 logs

994
00:32:05,700 --> 00:32:07,260
so what I have to do is I have to figure

995
00:32:07,260 --> 00:32:09,779
out where the other device is because

996
00:32:09,779 --> 00:32:11,100
I'm going to do some stuff that's going

997
00:32:11,100 --> 00:32:12,659
to change the configuration of the load

998
00:32:12,659 --> 00:32:13,980
balancer so I need to know how do I

999
00:32:13,980 --> 00:32:15,480
synchronize this to the other one so

1000
00:32:15,480 --> 00:32:17,159
that nobody notices I'm doing what I'm

1001
00:32:17,159 --> 00:32:19,320
doing and I'm using the exploit here

1002
00:32:19,320 --> 00:32:23,039
with just basically F5 commands to give

1003
00:32:23,039 --> 00:32:24,480
me all this information that I need to

1004
00:32:24,480 --> 00:32:26,100
know and I've only hacked into one of

1005
00:32:26,100 --> 00:32:27,360
them right I'm only hacking into one of

1006
00:32:27,360 --> 00:32:29,520
them right now I found the second one I

1007
00:32:29,520 --> 00:32:31,620
turned off syslog on that one

1008
00:32:31,620 --> 00:32:33,000
and now what I'm going to do is throw

1009
00:32:33,000 --> 00:32:35,399
the exploit payload that takes my

1010
00:32:35,399 --> 00:32:37,620
implant puts it on the first one and it

1011
00:32:37,620 --> 00:32:39,360
starts it on that side so it's the

1012
00:32:39,360 --> 00:32:41,520
implants running on the second one I'm

1013
00:32:41,520 --> 00:32:42,539
just going to install it I'm not

1014
00:32:42,539 --> 00:32:44,340
starting it yet so you'll see that this

1015
00:32:44,340 --> 00:32:46,020
has an actual shell to the first device

1016
00:32:46,020 --> 00:32:47,700
that I'm on

1017
00:32:47,700 --> 00:32:49,380
I'm going to use this shell in sliver

1018
00:32:49,380 --> 00:32:50,820
and then what I'm going to do is I'm

1019
00:32:50,820 --> 00:32:52,380
going to set up my Pivot listener right

1020
00:32:52,380 --> 00:32:55,320
so it starts it up I need to go and open

1021
00:32:55,320 --> 00:32:58,140
that Port so I execute this axle that

1022
00:32:58,140 --> 00:33:00,360
opens up the pivot port

1023
00:33:00,360 --> 00:33:02,700
and now I'm going to go hack into a

1024
00:33:02,700 --> 00:33:04,320
Windows Server so it's the same machine

1025
00:33:04,320 --> 00:33:06,419
that hacked the F5 is now going to go

1026
00:33:06,419 --> 00:33:09,059
use metasplate so first I need to hack

1027
00:33:09,059 --> 00:33:11,159
into the F5 again because I need a place

1028
00:33:11,159 --> 00:33:13,740
to Pivot my eternal blue exploit back

1029
00:33:13,740 --> 00:33:15,419
into the back end and network with this

1030
00:33:15,419 --> 00:33:16,679
Windows server

1031
00:33:16,679 --> 00:33:17,940
so

1032
00:33:17,940 --> 00:33:20,580
we get onto the F5

1033
00:33:20,580 --> 00:33:22,140
we're going to pretend I didn't know and

1034
00:33:22,140 --> 00:33:23,340
didn't build this network myself so

1035
00:33:23,340 --> 00:33:24,299
we're going to go ahead and we're going

1036
00:33:24,299 --> 00:33:26,279
to port scan that back-end Network and

1037
00:33:26,279 --> 00:33:28,740
see if we can find some windows servers

1038
00:33:28,740 --> 00:33:30,360
and like

1039
00:33:30,360 --> 00:33:31,919
oh my God there's a Windows Server back

1040
00:33:31,919 --> 00:33:34,500
there who would have thunk right so we

1041
00:33:34,500 --> 00:33:36,720
find our Windows Server we're going to

1042
00:33:36,720 --> 00:33:38,159
assume that they didn't listen to Nate

1043
00:33:38,159 --> 00:33:39,480
and they didn't install the wannacry

1044
00:33:39,480 --> 00:33:40,559
patch so we're just going to go ahead

1045
00:33:40,559 --> 00:33:42,299
and throw Eternal blue at it and see

1046
00:33:42,299 --> 00:33:45,419
what happens right and lo and behold

1047
00:33:45,419 --> 00:33:47,399
they didn't

1048
00:33:47,399 --> 00:33:48,720
so

1049
00:33:48,720 --> 00:33:51,120
Eternal blue runs gorgeous exploit by

1050
00:33:51,120 --> 00:33:52,440
the way

1051
00:33:52,440 --> 00:33:54,120
um and now we've got a shell on the

1052
00:33:54,120 --> 00:33:57,360
Windows machine for time constraints I

1053
00:33:57,360 --> 00:33:58,559
didn't upload the implant it was already

1054
00:33:58,559 --> 00:34:00,419
there and now you can see I've got a

1055
00:34:00,419 --> 00:34:01,919
pivoting account I've got this Windows

1056
00:34:01,919 --> 00:34:04,200
server has now pivoted through my F5 to

1057
00:34:04,200 --> 00:34:06,480
the internet on my system

1058
00:34:06,480 --> 00:34:08,580
now this is what I love about slipper it

1059
00:34:08,580 --> 00:34:09,899
says this is bad offsec are you sure you

1060
00:34:09,899 --> 00:34:11,520
want to do this so I'm dropping to a

1061
00:34:11,520 --> 00:34:13,080
full interactive shell on the F5 because

1062
00:34:13,080 --> 00:34:14,639
now we're going to go and actually mess

1063
00:34:14,639 --> 00:34:17,159
with the load balancing config and this

1064
00:34:17,159 --> 00:34:18,540
is the eye roll stuff I was telling you

1065
00:34:18,540 --> 00:34:19,980
about so what I'm doing is I'm creating

1066
00:34:19,980 --> 00:34:21,780
basically a traffic redirection rule

1067
00:34:21,780 --> 00:34:23,940
this is extremely basic type of thing

1068
00:34:23,940 --> 00:34:25,080
where it's going to say when I get a

1069
00:34:25,080 --> 00:34:26,760
request to the website I'm going to send

1070
00:34:26,760 --> 00:34:29,280
it somewhere else right and notice that

1071
00:34:29,280 --> 00:34:30,839
the top the F5s are going to say see

1072
00:34:30,839 --> 00:34:32,520
that says changes pending at the top

1073
00:34:32,520 --> 00:34:34,139
that's because the config is changed on

1074
00:34:34,139 --> 00:34:36,960
one device this is where you get caught

1075
00:34:36,960 --> 00:34:38,879
um I'm also modifying the virtual server

1076
00:34:38,879 --> 00:34:40,619
to say use this traffic Rule and people

1077
00:34:40,619 --> 00:34:42,418
hit this website and now I'm going to

1078
00:34:42,418 --> 00:34:44,159
say run the configuration and sync it up

1079
00:34:44,159 --> 00:34:45,540
and all of a sudden they go back to oh

1080
00:34:45,540 --> 00:34:47,580
everything's in sync situation normal

1081
00:34:47,580 --> 00:34:50,520
everything's normal how are you

1082
00:34:50,520 --> 00:34:52,139
um so what we do is we drop out of that

1083
00:34:52,139 --> 00:34:53,699
and we're going to go say let's go to

1084
00:34:53,699 --> 00:34:57,240
this website and lo and behold it's bad

1085
00:34:57,240 --> 00:34:59,099
now like our traffic is going somewhere

1086
00:34:59,099 --> 00:35:00,720
else now I could be putting a JavaScript

1087
00:35:00,720 --> 00:35:02,460
like keylogger in here if I knew

1088
00:35:02,460 --> 00:35:03,420
JavaScript

1089
00:35:03,420 --> 00:35:05,339
but you know somebody calls the sock and

1090
00:35:05,339 --> 00:35:06,960
they're like oh my God something went

1091
00:35:06,960 --> 00:35:09,060
wrong so you know Good Old Sock guy goes

1092
00:35:09,060 --> 00:35:10,680
oh man we better we better fail that F5

1093
00:35:10,680 --> 00:35:12,180
over because it's now handling out like

1094
00:35:12,180 --> 00:35:13,980
bad traffic to people so he puts that

1095
00:35:13,980 --> 00:35:16,140
thing into standby mode and the second

1096
00:35:16,140 --> 00:35:17,520
one connects

1097
00:35:17,520 --> 00:35:19,380
and now I have both your F5s talking to

1098
00:35:19,380 --> 00:35:20,880
me I've owned your customers I've got

1099
00:35:20,880 --> 00:35:22,680
your Windows server and that took all of

1100
00:35:22,680 --> 00:35:24,240
four minutes now granted the preparation

1101
00:35:24,240 --> 00:35:25,619
time for this video did take a little

1102
00:35:25,619 --> 00:35:27,300
longer than four minutes

1103
00:35:27,300 --> 00:35:29,339
um but that's how easy this can be

1104
00:35:29,339 --> 00:35:30,839
right

1105
00:35:30,839 --> 00:35:33,540
So In fairness so I did all this work

1106
00:35:33,540 --> 00:35:35,220
and I was like okay F5 is pretty busted

1107
00:35:35,220 --> 00:35:38,099
I can do all these evil things to F5

1108
00:35:38,099 --> 00:35:40,440
Citrix was my next Target

1109
00:35:40,440 --> 00:35:42,240
um and Citrix doesn't have quite as many

1110
00:35:42,240 --> 00:35:44,640
design flaws but they do give you a

1111
00:35:44,640 --> 00:35:46,859
fully interactive shell they do have the

1112
00:35:46,859 --> 00:35:48,599
ability to backup files in an archive

1113
00:35:48,599 --> 00:35:50,520
they also don't have interactive or

1114
00:35:50,520 --> 00:35:53,460
Integrity checks and once again because

1115
00:35:53,460 --> 00:35:55,020
they're zipping up a directory I could

1116
00:35:55,020 --> 00:35:57,240
if I wanted to store my implant in that

1117
00:35:57,240 --> 00:36:00,060
config directory this would be useful in

1118
00:36:00,060 --> 00:36:01,440
situations where maybe you know the

1119
00:36:01,440 --> 00:36:03,180
admins you can see the admins aren't

1120
00:36:03,180 --> 00:36:04,680
really paying any attention you're like

1121
00:36:04,680 --> 00:36:06,839
I don't I don't want to risk this thing

1122
00:36:06,839 --> 00:36:08,220
not getting into the internet or maybe

1123
00:36:08,220 --> 00:36:09,540
you just want to have it talk to your

1124
00:36:09,540 --> 00:36:11,880
you know the somebody in accounting's

1125
00:36:11,880 --> 00:36:13,380
like desktop that you've already got a

1126
00:36:13,380 --> 00:36:15,180
sliver implant you could chain these

1127
00:36:15,180 --> 00:36:16,740
things through you could have a pivot

1128
00:36:16,740 --> 00:36:18,900
implant on an F5 talking to a sliver

1129
00:36:18,900 --> 00:36:20,760
implant here like you could just keep

1130
00:36:20,760 --> 00:36:23,160
going as far back as you want

1131
00:36:23,160 --> 00:36:25,920
um but I needed to install some way to

1132
00:36:25,920 --> 00:36:28,339
infuse a built-in service right because

1133
00:36:28,339 --> 00:36:30,960
once again if you if I was to drop

1134
00:36:30,960 --> 00:36:32,400
something into like an internet script

1135
00:36:32,400 --> 00:36:34,260
in Etsy that's going to get wiped when

1136
00:36:34,260 --> 00:36:36,960
it gets reinstalled I can't really it's

1137
00:36:36,960 --> 00:36:38,820
BSD so there's a little this a few less

1138
00:36:38,820 --> 00:36:40,680
ways to run code and I also don't know

1139
00:36:40,680 --> 00:36:43,200
BSD as well as I know Linux but I want

1140
00:36:43,200 --> 00:36:44,400
to make sure that this is invisible to

1141
00:36:44,400 --> 00:36:45,900
GUI users so I don't want to have it as

1142
00:36:45,900 --> 00:36:48,180
like a like a Time an official job or

1143
00:36:48,180 --> 00:36:51,540
official scheduled task in Citrix so I

1144
00:36:51,540 --> 00:36:54,000
went digging around it turns out there's

1145
00:36:54,000 --> 00:36:56,700
not that much to play with right they

1146
00:36:56,700 --> 00:36:58,200
have this in how to install a custom

1147
00:36:58,200 --> 00:37:00,540
file solution once again vendor website

1148
00:37:00,540 --> 00:37:03,359
wealth of knowledge for this stuff and

1149
00:37:03,359 --> 00:37:04,800
they're like okay you can configure you

1150
00:37:04,800 --> 00:37:06,359
can tweak the Daemon configurations like

1151
00:37:06,359 --> 00:37:08,820
SSH and web and the syslog but the thing

1152
00:37:08,820 --> 00:37:10,619
is is none of these are executable these

1153
00:37:10,619 --> 00:37:12,839
are just configuration files and I think

1154
00:37:12,839 --> 00:37:14,400
cront tab is kind of a I don't know I

1155
00:37:14,400 --> 00:37:16,320
think that's kind of like like being too

1156
00:37:16,320 --> 00:37:17,820
easy I mean the first place anybody's

1157
00:37:17,820 --> 00:37:19,200
going to look on a Linux machine for bad

1158
00:37:19,200 --> 00:37:23,040
stuff is cron right so as I dug around I

1159
00:37:23,040 --> 00:37:24,839
came across this weird thing buried in

1160
00:37:24,839 --> 00:37:26,880
the manual that they're like yeah if you

1161
00:37:26,880 --> 00:37:28,859
need to get your ntpd service to do

1162
00:37:28,859 --> 00:37:30,420
these things go and make this file and

1163
00:37:30,420 --> 00:37:31,619
do this thing and then to the bottom I

1164
00:37:31,619 --> 00:37:32,880
was like this process runs every time

1165
00:37:32,880 --> 00:37:35,579
the load and the ADC is restarted okay

1166
00:37:35,579 --> 00:37:37,020
interesting

1167
00:37:37,020 --> 00:37:40,560
so as it turns out their solution that

1168
00:37:40,560 --> 00:37:41,880
they gave me have put things in this

1169
00:37:41,880 --> 00:37:44,640
rc.net scalar file didn't really work I

1170
00:37:44,640 --> 00:37:46,020
tried sticking everything I could think

1171
00:37:46,020 --> 00:37:48,119
of in there I tried copying the format

1172
00:37:48,119 --> 00:37:50,400
everything nothing ever worked so I was

1173
00:37:50,400 --> 00:37:52,079
like okay where does this ntpd control

1174
00:37:52,079 --> 00:37:54,180
thing so I started digging around

1175
00:37:54,180 --> 00:37:55,800
um on in their Etsy directory and I

1176
00:37:55,800 --> 00:37:57,000
found there's a whole bunch of these

1177
00:37:57,000 --> 00:37:59,700
underscore CTL files

1178
00:37:59,700 --> 00:38:01,920
some more digging around and it turns

1179
00:38:01,920 --> 00:38:03,300
out that they use this package that I'd

1180
00:38:03,300 --> 00:38:05,400
never heard of called monit which is a

1181
00:38:05,400 --> 00:38:07,800
BSD package for managing services and

1182
00:38:07,800 --> 00:38:10,320
keeping them running and its

1183
00:38:10,320 --> 00:38:11,640
configuration file is one of the ones

1184
00:38:11,640 --> 00:38:13,140
you can configure and it'll get backed

1185
00:38:13,140 --> 00:38:15,619
up so at this point I was like sweet

1186
00:38:15,619 --> 00:38:19,020
it's not quite as easy as just uh

1187
00:38:19,020 --> 00:38:20,460
starting the script though so I ended up

1188
00:38:20,460 --> 00:38:22,140
having to write like a actually a full

1189
00:38:22,140 --> 00:38:24,540
service wrapper for sliver to make it

1190
00:38:24,540 --> 00:38:26,220
sort of run like a Daemon like I had to

1191
00:38:26,220 --> 00:38:27,780
create a PID file and I do all these

1192
00:38:27,780 --> 00:38:29,099
other things so I could actually accent

1193
00:38:29,099 --> 00:38:31,380
like basically implant start implant

1194
00:38:31,380 --> 00:38:34,320
stop implant restart but I use the same

1195
00:38:34,320 --> 00:38:37,440
logic in this script and what it does is

1196
00:38:37,440 --> 00:38:39,780
now it allows monit to manage my C2 for

1197
00:38:39,780 --> 00:38:41,400
me it starts on boot and the funniest

1198
00:38:41,400 --> 00:38:43,020
part about this is it makes the implant

1199
00:38:43,020 --> 00:38:45,540
completely unkillable so when you're in

1200
00:38:45,540 --> 00:38:46,859
sliver and you're connected to an

1201
00:38:46,859 --> 00:38:48,240
implant if you decide that you're done

1202
00:38:48,240 --> 00:38:50,040
with it you can say a kill and it kills

1203
00:38:50,040 --> 00:38:51,720
the implant and it stops the process on

1204
00:38:51,720 --> 00:38:53,099
the remote system right the implant's

1205
00:38:53,099 --> 00:38:55,680
gone if I do that on a Citrix device it

1206
00:38:55,680 --> 00:38:57,480
can it says okay session died it goes

1207
00:38:57,480 --> 00:38:58,800
away and then a couple seconds later it

1208
00:38:58,800 --> 00:39:00,599
connects right back because Monica's

1209
00:39:00,599 --> 00:39:01,980
like oh this went down I better turn it

1210
00:39:01,980 --> 00:39:03,660
back on again so it's kind of funny

1211
00:39:03,660 --> 00:39:04,980
because you can't make it go away once

1212
00:39:04,980 --> 00:39:06,720
you've done this

1213
00:39:06,720 --> 00:39:08,700
and so these are the scripts right so

1214
00:39:08,700 --> 00:39:10,859
this big block right here

1215
00:39:10,859 --> 00:39:12,780
um is basically what I had to do you

1216
00:39:12,780 --> 00:39:14,099
know you could see start I called this

1217
00:39:14,099 --> 00:39:15,660
NS support

1218
00:39:15,660 --> 00:39:17,160
um that's another detail I forgot to

1219
00:39:17,160 --> 00:39:20,040
mention what I did to hide my implant on

1220
00:39:20,040 --> 00:39:21,900
the F5 and on the netscaler as I go and

1221
00:39:21,900 --> 00:39:25,079
find daemons that look innocuous in F5

1222
00:39:25,079 --> 00:39:26,820
they use the Run service and so they had

1223
00:39:26,820 --> 00:39:29,400
a run service for rest Java D but there

1224
00:39:29,400 --> 00:39:31,320
was no actual binary named that it

1225
00:39:31,320 --> 00:39:33,540
called a long Tomcat in the

1226
00:39:33,540 --> 00:39:35,760
initialization string so I'm like hmm if

1227
00:39:35,760 --> 00:39:37,740
I name my binary rest Java D and so even

1228
00:39:37,740 --> 00:39:39,240
an admin who knows what he's doing looks

1229
00:39:39,240 --> 00:39:40,260
he's gonna be like well that's a service

1230
00:39:40,260 --> 00:39:41,400
and that's the thing that started it

1231
00:39:41,400 --> 00:39:42,599
we're good to go

1232
00:39:42,599 --> 00:39:44,339
for netscaler I just said they have a

1233
00:39:44,339 --> 00:39:46,140
bunch of stuff that's just NSS something

1234
00:39:46,140 --> 00:39:47,760
so I'm just going to call this NS

1235
00:39:47,760 --> 00:39:50,520
support like netscaler support Damon and

1236
00:39:50,520 --> 00:39:52,380
then you can see here on the screen uh

1237
00:39:52,380 --> 00:39:54,000
this is when the boot it's a console

1238
00:39:54,000 --> 00:39:55,380
boot up process

1239
00:39:55,380 --> 00:39:56,579
um it basically says hey your your

1240
00:39:56,579 --> 00:39:58,020
implant's not running I'm going to start

1241
00:39:58,020 --> 00:39:59,160
it for you

1242
00:39:59,160 --> 00:40:00,660
um and all these scripts I'm actually

1243
00:40:00,660 --> 00:40:02,700
putting a Blog out eclipsia my company

1244
00:40:02,700 --> 00:40:04,619
I'm writing a Blog to detail all of this

1245
00:40:04,619 --> 00:40:06,900
all of the code will be made public it's

1246
00:40:06,900 --> 00:40:10,500
not that hard but I figured hey why not

1247
00:40:10,500 --> 00:40:13,500
so kind of getting yeah include getting

1248
00:40:13,500 --> 00:40:15,420
towards closing here

1249
00:40:15,420 --> 00:40:17,099
um it's dangerous tact alone right if

1250
00:40:17,099 --> 00:40:18,540
you're interested in doing this I really

1251
00:40:18,540 --> 00:40:20,700
encourage you to because

1252
00:40:20,700 --> 00:40:23,099
um uh as like even Andy said this

1253
00:40:23,099 --> 00:40:25,020
morning like Azure is a sort of a wild

1254
00:40:25,020 --> 00:40:26,400
west people aren't really looking at it

1255
00:40:26,400 --> 00:40:27,839
so there's all sorts of things to find

1256
00:40:27,839 --> 00:40:29,520
load balancers people aren't really

1257
00:40:29,520 --> 00:40:31,260
looking at them that much either right

1258
00:40:31,260 --> 00:40:32,880
the vulnerabilities that came out in the

1259
00:40:32,880 --> 00:40:36,140
last couple years are trivial

1260
00:40:37,020 --> 00:40:40,380
so my entire lab is running on proxmox

1261
00:40:40,380 --> 00:40:42,660
which is a free like KVM management

1262
00:40:42,660 --> 00:40:45,240
thing it uses the KVM hypervisor I have

1263
00:40:45,240 --> 00:40:47,339
a little desktop little little box thing

1264
00:40:47,339 --> 00:40:49,440
that's you know cost I don't know 800

1265
00:40:49,440 --> 00:40:50,880
bucks it wasn't much

1266
00:40:50,880 --> 00:40:52,920
um and I run VMS on everything the fun

1267
00:40:52,920 --> 00:40:55,200
thing about F5 is that you can just use

1268
00:40:55,200 --> 00:40:56,880
a throwaway email like go to throw email

1269
00:40:56,880 --> 00:40:58,740
get an email address register for their

1270
00:40:58,740 --> 00:41:00,119
support site and you can download

1271
00:41:00,119 --> 00:41:01,680
everything you want

1272
00:41:01,680 --> 00:41:04,320
um the great thing about them too is the

1273
00:41:04,320 --> 00:41:05,820
reason that exploit worked is you can

1274
00:41:05,820 --> 00:41:07,859
download vulnerable VMS like when they

1275
00:41:07,859 --> 00:41:09,540
patch a vulnerability they don't remove

1276
00:41:09,540 --> 00:41:11,640
the old vulnerable code off the website

1277
00:41:11,640 --> 00:41:13,500
you can still go and download things

1278
00:41:13,500 --> 00:41:15,000
that are have vulnerabilities in them

1279
00:41:15,000 --> 00:41:16,920
which kind of blows my mind but hey I'll

1280
00:41:16,920 --> 00:41:18,540
take it

1281
00:41:18,540 --> 00:41:20,040
um and then you can actually get trial

1282
00:41:20,040 --> 00:41:22,020
licenses so you could use that same

1283
00:41:22,020 --> 00:41:23,579
throwaway mail and go and say Hey I want

1284
00:41:23,579 --> 00:41:25,740
a I want a 30-day eval license and

1285
00:41:25,740 --> 00:41:27,960
they'll send you three eval licenses so

1286
00:41:27,960 --> 00:41:29,940
you can have a fully like running pair

1287
00:41:29,940 --> 00:41:32,280
of devices like I had in there then you

1288
00:41:32,280 --> 00:41:34,380
can also download isos

1289
00:41:34,380 --> 00:41:36,540
um so I think it was a Silvio before was

1290
00:41:36,540 --> 00:41:38,220
talking about downloading firmware stuff

1291
00:41:38,220 --> 00:41:40,200
if that's your jam you can download an

1292
00:41:40,200 --> 00:41:41,760
ISO you can unpack it you can look at

1293
00:41:41,760 --> 00:41:43,320
everything in there right you can figure

1294
00:41:43,320 --> 00:41:45,000
out all the binaries all the versions of

1295
00:41:45,000 --> 00:41:46,920
everything they're doing I don't have

1296
00:41:46,920 --> 00:41:48,960
the time or the motivation to do that

1297
00:41:48,960 --> 00:41:51,000
and actually try to find volumes I like

1298
00:41:51,000 --> 00:41:52,200
that just people that are smarter than

1299
00:41:52,200 --> 00:41:53,700
me I just like to abuse things after

1300
00:41:53,700 --> 00:41:55,140
they find them

1301
00:41:55,140 --> 00:41:57,000
Citrix has the same stuff you can get

1302
00:41:57,000 --> 00:41:58,920
VMS from them they don't really give you

1303
00:41:58,920 --> 00:42:00,540
the vulnerable versions but the cool

1304
00:42:00,540 --> 00:42:01,740
thing is is they don't need a trial

1305
00:42:01,740 --> 00:42:03,660
license so you set up an account they'll

1306
00:42:03,660 --> 00:42:05,460
give you the VM you turn it on and they

1307
00:42:05,460 --> 00:42:07,440
get a 30 or a great limited but

1308
00:42:07,440 --> 00:42:11,160
unlimited time license for it

1309
00:42:11,160 --> 00:42:13,380
all right and with that some key

1310
00:42:13,380 --> 00:42:14,700
takeaways for this

1311
00:42:14,700 --> 00:42:16,200
um these techniques will work on any

1312
00:42:16,200 --> 00:42:18,300
device that has a full shell

1313
00:42:18,300 --> 00:42:20,099
um I add my spare time we'll probably go

1314
00:42:20,099 --> 00:42:21,780
and try to get more VMS maybe I'll do

1315
00:42:21,780 --> 00:42:24,060
Juno for um for the gate doesn't give me

1316
00:42:24,060 --> 00:42:25,260
a full shell I was playing with that

1317
00:42:25,260 --> 00:42:27,359
exploit a couple weeks ago but

1318
00:42:27,359 --> 00:42:28,680
theoretically anybody that gives you a

1319
00:42:28,680 --> 00:42:30,599
full shell this is probably possible

1320
00:42:30,599 --> 00:42:32,220
Advanced actors I don't think have

1321
00:42:32,220 --> 00:42:33,599
really gotten to the point I mean

1322
00:42:33,599 --> 00:42:35,220
obviously where I'm at

1323
00:42:35,220 --> 00:42:37,320
um that may change as I said

1324
00:42:37,320 --> 00:42:38,820
um but this is an area that's going to

1325
00:42:38,820 --> 00:42:40,800
continue to be abused and you know some

1326
00:42:40,800 --> 00:42:42,900
people may say well but everybody if

1327
00:42:42,900 --> 00:42:44,520
they patch you're fine and the thing the

1328
00:42:44,520 --> 00:42:45,960
truth of the matter is is that these

1329
00:42:45,960 --> 00:42:47,880
devices don't get patched that often

1330
00:42:47,880 --> 00:42:49,740
right they're complex they run in the

1331
00:42:49,740 --> 00:42:51,180
middle of networks people may think well

1332
00:42:51,180 --> 00:42:52,560
this thing is secure because it's not

1333
00:42:52,560 --> 00:42:54,480
exposed to the internet but if you can

1334
00:42:54,480 --> 00:42:56,040
get in through some other path you can

1335
00:42:56,040 --> 00:42:57,660
get to these devices when I worked at F5

1336
00:42:57,660 --> 00:42:59,400
people couldn't stand upgrading these

1337
00:42:59,400 --> 00:43:01,440
things because more often than not they

1338
00:43:01,440 --> 00:43:03,180
put the new code on it was super buggy

1339
00:43:03,180 --> 00:43:04,500
they'd take an outage so they were like

1340
00:43:04,500 --> 00:43:06,300
I'm only upgrading if I absolutely have

1341
00:43:06,300 --> 00:43:07,920
to so these things will run for years

1342
00:43:07,920 --> 00:43:10,319
without being patched

1343
00:43:10,319 --> 00:43:12,000
um they're complex like I said most of

1344
00:43:12,000 --> 00:43:13,680
these people are using the GUI we get on

1345
00:43:13,680 --> 00:43:15,060
the command line nobody knows what we're

1346
00:43:15,060 --> 00:43:16,319
doing

1347
00:43:16,319 --> 00:43:17,640
um and then they're design flaws right

1348
00:43:17,640 --> 00:43:19,140
these are these vendors have basically

1349
00:43:19,140 --> 00:43:20,760
shoehorned all of this functionality

1350
00:43:20,760 --> 00:43:22,560
into these things at the request of some

1351
00:43:22,560 --> 00:43:24,960
customer some time ago and it never goes

1352
00:43:24,960 --> 00:43:26,280
away and they're never going to take it

1353
00:43:26,280 --> 00:43:27,540
away right in the same sense with

1354
00:43:27,540 --> 00:43:29,160
Microsoft and some of the bone-headed

1355
00:43:29,160 --> 00:43:30,660
stuff like ntlm that's going to be

1356
00:43:30,660 --> 00:43:32,400
around for the end of time they can't

1357
00:43:32,400 --> 00:43:34,740
get rid of it once it's there so

1358
00:43:34,740 --> 00:43:37,619
what can you do patch them firewall them

1359
00:43:37,619 --> 00:43:40,800
turn on syslog start maybe looking at

1360
00:43:40,800 --> 00:43:42,480
your config snapshots look for size

1361
00:43:42,480 --> 00:43:44,040
changes I don't have a lot of great

1362
00:43:44,040 --> 00:43:45,599
advice for you here because it's not

1363
00:43:45,599 --> 00:43:48,000
easy to catch this stuff you might be

1364
00:43:48,000 --> 00:43:49,319
able to run something where you you know

1365
00:43:49,319 --> 00:43:50,819
hash all the files in the file system

1366
00:43:50,819 --> 00:43:52,440
and say hey if anything changes you know

1367
00:43:52,440 --> 00:43:53,940
if all of a sudden one of these startup

1368
00:43:53,940 --> 00:43:57,180
files gets bigger I want to know or if

1369
00:43:57,180 --> 00:43:58,380
you're going to go and deploy these

1370
00:43:58,380 --> 00:44:00,119
things try to find boxes that have more

1371
00:44:00,119 --> 00:44:02,040
restrictive shells right yes they can

1372
00:44:02,040 --> 00:44:03,599
still get hacked pulse I have one of

1373
00:44:03,599 --> 00:44:05,040
those two doesn't really have a good

1374
00:44:05,040 --> 00:44:06,960
shell I can hack into it but I was never

1375
00:44:06,960 --> 00:44:09,000
able to get these implants to run right

1376
00:44:09,000 --> 00:44:10,740
something about how those things are

1377
00:44:10,740 --> 00:44:12,119
designed I could never actually get an

1378
00:44:12,119 --> 00:44:13,920
implant to run now yes you could drop a

1379
00:44:13,920 --> 00:44:16,500
web shell but once again you wipe the

1380
00:44:16,500 --> 00:44:18,060
box and reinstall and restore it from a

1381
00:44:18,060 --> 00:44:20,339
backup you're done so

1382
00:44:20,339 --> 00:44:22,319
put some thought into the devices you

1383
00:44:22,319 --> 00:44:24,300
buy like try to make sure you know hey

1384
00:44:24,300 --> 00:44:25,680
if you're going to go buy an F5 like hey

1385
00:44:25,680 --> 00:44:27,119
did you see that guy's talk like should

1386
00:44:27,119 --> 00:44:28,380
I really spend the money with you guys

1387
00:44:28,380 --> 00:44:31,859
they would love it if you did that uh

1388
00:44:31,859 --> 00:44:33,540
um yeah so it's it's like I said it's

1389
00:44:33,540 --> 00:44:35,819
it's it's the wild west I hope that you

1390
00:44:35,819 --> 00:44:37,740
can all stay safe I hope that you've

1391
00:44:37,740 --> 00:44:40,380
enjoyed this talk um I have like less

1392
00:44:40,380 --> 00:44:41,880
than a minute for questions I don't I

1393
00:44:41,880 --> 00:44:43,560
want to be respectful so maybe just find

1394
00:44:43,560 --> 00:44:44,940
me afterwards if you're interested

1395
00:44:44,940 --> 00:44:46,920
things and thank you again Echo party

1396
00:44:46,920 --> 00:44:48,720
for having me and thank you for being

1397
00:44:48,720 --> 00:44:49,130
here

1398
00:44:49,130 --> 00:44:54,269
[Applause]

