1
00:00:01,120 --> 00:00:03,679
hello and welcome to offensive azure

2
00:00:03,679 --> 00:00:05,200
security session

3
00:00:05,200 --> 00:00:06,960
um my name is sergey and i will be

4
00:00:06,960 --> 00:00:10,160
presenter for the next 45 around that

5
00:00:10,160 --> 00:00:12,719
minute uh this session will be taken in

6
00:00:12,719 --> 00:00:14,160
english so

7
00:00:14,160 --> 00:00:17,199
i hope you are pretty well with that um

8
00:00:17,199 --> 00:00:18,240
and

9
00:00:18,240 --> 00:00:18,960
but

10
00:00:18,960 --> 00:00:20,160
because of them

11
00:00:20,160 --> 00:00:22,400
because i'm not going to talk a lot uh

12
00:00:22,400 --> 00:00:24,240
this session will be based on live demos

13
00:00:24,240 --> 00:00:25,199
so

14
00:00:25,199 --> 00:00:26,080
um

15
00:00:26,080 --> 00:00:28,000
even my english will not be a problem i

16
00:00:28,000 --> 00:00:28,880
guess

17
00:00:28,880 --> 00:00:30,560
oh by the way which is important about

18
00:00:30,560 --> 00:00:34,000
my english i'm russian so um they you

19
00:00:34,000 --> 00:00:36,640
might find that by by my accent um and

20
00:00:36,640 --> 00:00:38,640
what i usually do in that country for

21
00:00:38,640 --> 00:00:41,360
other other countries um i run

22
00:00:41,360 --> 00:00:43,520
penetration tests um

23
00:00:43,520 --> 00:00:45,120
different assessment security assessment

24
00:00:45,120 --> 00:00:47,039
and after that implement security

25
00:00:47,039 --> 00:00:50,320
services to fix those problems we found

26
00:00:50,320 --> 00:00:53,440
also i'm an instructor so i usually

27
00:00:53,440 --> 00:00:55,120
deliver training courses for my

28
00:00:55,120 --> 00:00:57,520
customers custom trainings or whatever

29
00:00:57,520 --> 00:00:59,440
speak at conferences like this one as

30
00:00:59,440 --> 00:01:02,160
well um if you want to contact me after

31
00:01:02,160 --> 00:01:03,840
this session or during the session or

32
00:01:03,840 --> 00:01:07,520
whatever um here's my linkedin

33
00:01:07,520 --> 00:01:10,000
um there you may find what other set

34
00:01:10,000 --> 00:01:12,240
whether other conference i'm talking or

35
00:01:12,240 --> 00:01:13,920
or something now or just send me

36
00:01:13,920 --> 00:01:15,360
personal message

37
00:01:15,360 --> 00:01:18,080
um because we're talking about azure um

38
00:01:18,080 --> 00:01:20,799
or azure how some some people call that

39
00:01:20,799 --> 00:01:22,479
um

40
00:01:22,479 --> 00:01:26,000
uh i have i'm microsoft mvp so that's

41
00:01:26,000 --> 00:01:27,680
most valuable professional in this

42
00:01:27,680 --> 00:01:29,600
microsoft azure area

43
00:01:29,600 --> 00:01:32,880
i'm also oecp osap

44
00:01:32,880 --> 00:01:35,040
ca spend many other security

45
00:01:35,040 --> 00:01:36,880
certifications which is not that

46
00:01:36,880 --> 00:01:38,560
important i think the most important

47
00:01:38,560 --> 00:01:40,640
part is not how smart i am but what i

48
00:01:40,640 --> 00:01:42,880
can give you in the in this session and

49
00:01:42,880 --> 00:01:44,399
so and because we have lots of content

50
00:01:44,399 --> 00:01:46,720
to discuss i'm not going to talk a lot

51
00:01:46,720 --> 00:01:49,280
about myself so let's let's let's better

52
00:01:49,280 --> 00:01:52,079
talk about what i'm going to present so

53
00:01:52,079 --> 00:01:54,960
in this session you will see uh agenda

54
00:01:54,960 --> 00:01:56,640
like this so so

55
00:01:56,640 --> 00:01:59,280
things like this uh you may say what the

56
00:01:59,280 --> 00:02:01,040
hell is that like this doesn't look like

57
00:02:01,040 --> 00:02:02,960
a normal agenda it's like

58
00:02:02,960 --> 00:02:04,719
three figures

59
00:02:04,719 --> 00:02:08,239
uh yes that's my agenda um so i'm going

60
00:02:08,239 --> 00:02:09,758
in this session i'm going to show you

61
00:02:09,758 --> 00:02:11,680
this will be based on live demos i'm

62
00:02:11,680 --> 00:02:13,680
going to show you how i can compromise

63
00:02:13,680 --> 00:02:18,480
three environment um more or less um

64
00:02:18,480 --> 00:02:20,400
exist when you when you when you work

65
00:02:20,400 --> 00:02:22,319
with cloud services in

66
00:02:22,319 --> 00:02:24,400
azure cloud services so first of all i'm

67
00:02:24,400 --> 00:02:26,239
going to compromise hybrid active

68
00:02:26,239 --> 00:02:28,400
directory so when you have on-prem id

69
00:02:28,400 --> 00:02:30,480
and you almost all every company has

70
00:02:30,480 --> 00:02:34,400
on-prem id um and you have cloud id

71
00:02:34,400 --> 00:02:36,720
quite often those active directories are

72
00:02:36,720 --> 00:02:39,280
integrated so how we can compromise that

73
00:02:39,280 --> 00:02:41,680
environment then i'm going to show you

74
00:02:41,680 --> 00:02:44,160
what if you have uh application deployed

75
00:02:44,160 --> 00:02:45,680
in virtual machines how those virtual

76
00:02:45,680 --> 00:02:48,080
machines may be may be compromised as

77
00:02:48,080 --> 00:02:50,560
well and finally we're application with

78
00:02:50,560 --> 00:02:52,160
sql server so here we're going to talk

79
00:02:52,160 --> 00:02:54,400
about pass services

80
00:02:54,400 --> 00:02:56,480
like managed services

81
00:02:56,480 --> 00:02:59,200
where we don't go uh beyond virtual

82
00:02:59,200 --> 00:03:00,159
machines

83
00:03:00,159 --> 00:03:02,480
all right so let's get started i promise

84
00:03:02,480 --> 00:03:04,640
you it will be a lot of live demos so

85
00:03:04,640 --> 00:03:07,200
slides will be they will just show where

86
00:03:07,200 --> 00:03:09,680
we are so from here i'm i want to say

87
00:03:09,680 --> 00:03:12,879
that we are starting the first

88
00:03:12,879 --> 00:03:16,879
uh first objective our first um part

89
00:03:16,879 --> 00:03:19,599
first you may say module or scenario

90
00:03:19,599 --> 00:03:22,080
where i'm going to have active directory

91
00:03:22,080 --> 00:03:24,959
and azure ad connect so azure ad connect

92
00:03:24,959 --> 00:03:26,799
that's the tool if you haven't worked

93
00:03:26,799 --> 00:03:28,799
with that before that's the tool that

94
00:03:28,799 --> 00:03:31,200
will allow me to synchronize identity

95
00:03:31,200 --> 00:03:34,720
identities from on-premises to the cloud

96
00:03:34,720 --> 00:03:36,640
so i'm going to jump to demo

97
00:03:36,640 --> 00:03:38,959
i promise you

98
00:03:38,959 --> 00:03:41,280
and first let me show you 80 connect

99
00:03:41,280 --> 00:03:43,519
itself a

100
00:03:43,519 --> 00:03:46,000
few things important about ad connect

101
00:03:46,000 --> 00:03:48,640
for import for my demos and then i'm

102
00:03:48,640 --> 00:03:50,640
going to show you how those things may

103
00:03:50,640 --> 00:03:52,640
be compromised so here on the screen you

104
00:03:52,640 --> 00:03:54,720
may see ad connect and the part of

105
00:03:54,720 --> 00:03:57,439
configuration of ad connect is a

106
00:03:57,439 --> 00:03:59,920
creation of account that will have

107
00:03:59,920 --> 00:04:03,760
permissions to read from on-premises id

108
00:04:03,760 --> 00:04:05,519
so here you can see that i must add

109
00:04:05,519 --> 00:04:06,560
forest

110
00:04:06,560 --> 00:04:08,400
that's my forest

111
00:04:08,400 --> 00:04:11,040
and i click add directory and here this

112
00:04:11,040 --> 00:04:13,439
account must be created you may cr you

113
00:04:13,439 --> 00:04:15,200
may allow a connect create account for

114
00:04:15,200 --> 00:04:16,798
you which is the most recommended option

115
00:04:16,798 --> 00:04:18,079
so this first

116
00:04:18,079 --> 00:04:20,079
recommended and so it will be created

117
00:04:20,079 --> 00:04:22,240
this account will be created for you

118
00:04:22,240 --> 00:04:24,720
uh or you may pre-create account and

119
00:04:24,720 --> 00:04:26,479
delegate all permissions manually i'm

120
00:04:26,479 --> 00:04:28,320
not going to work i'm not going to

121
00:04:28,320 --> 00:04:30,720
follow that direct that path let me just

122
00:04:30,720 --> 00:04:32,320
stick on the recommended option so

123
00:04:32,320 --> 00:04:35,280
create new account um so duplicate

124
00:04:35,280 --> 00:04:38,160
automatically um

125
00:04:38,160 --> 00:04:40,560
by 80 connect let me show you this

126
00:04:40,560 --> 00:04:44,320
account that was created already

127
00:04:44,320 --> 00:04:46,560
uh this account will call uh will be

128
00:04:46,560 --> 00:04:49,440
called ms oil underscore and something

129
00:04:49,440 --> 00:04:51,840
else like different numbers

130
00:04:51,840 --> 00:04:53,520
digits and letters

131
00:04:53,520 --> 00:04:56,479
so my case is called 9cc and so on uh

132
00:04:56,479 --> 00:04:58,080
i'm going to i'm going to properties of

133
00:04:58,080 --> 00:05:00,080
this account going to check properties

134
00:05:00,080 --> 00:05:03,199
uh and membership group membership it

135
00:05:03,199 --> 00:05:05,520
seems like it's like a regular user so

136
00:05:05,520 --> 00:05:08,000
this account even if someone owes this

137
00:05:08,000 --> 00:05:10,000
account it's this account is quite it's

138
00:05:10,000 --> 00:05:12,000
just a simple user without any special

139
00:05:12,000 --> 00:05:13,520
privileges right

140
00:05:13,520 --> 00:05:14,320
um

141
00:05:14,320 --> 00:05:17,039
yes by default that's correct but let's

142
00:05:17,039 --> 00:05:20,160
take a look on something else

143
00:05:20,160 --> 00:05:23,639
let's take a look

144
00:05:25,520 --> 00:05:26,560
if

145
00:05:26,560 --> 00:05:28,880
in my ad connect wizard when i configure

146
00:05:28,880 --> 00:05:31,360
ad connect i enable different different

147
00:05:31,360 --> 00:05:32,479
options

148
00:05:32,479 --> 00:05:35,039
account will have more permissions so

149
00:05:35,039 --> 00:05:36,639
look at this on the right you may find

150
00:05:36,639 --> 00:05:39,199
options on the left permissions

151
00:05:39,199 --> 00:05:39,919
um

152
00:05:39,919 --> 00:05:42,000
very popular option and very recommended

153
00:05:42,000 --> 00:05:43,919
by microsoft as well by the way

154
00:05:43,919 --> 00:05:46,400
uh password hash sync so this option

155
00:05:46,400 --> 00:05:48,720
allows you not just a synchronized

156
00:05:48,720 --> 00:05:51,120
account itself but also synchronize

157
00:05:51,120 --> 00:05:52,400
password hash

158
00:05:52,400 --> 00:05:54,639
so users will have the same passwords on

159
00:05:54,639 --> 00:05:56,960
premises and in the cloud it's very

160
00:05:56,960 --> 00:05:59,039
convenient and by the way in this case

161
00:05:59,039 --> 00:06:00,639
also you will get like a disaster

162
00:06:00,639 --> 00:06:02,319
recovery solution because cloud will

163
00:06:02,319 --> 00:06:04,720
have all the password hashes and if you

164
00:06:04,720 --> 00:06:07,840
lose your on-prem connectivity um users

165
00:06:07,840 --> 00:06:09,039
will be able to come to connect the

166
00:06:09,039 --> 00:06:10,880
cloud anyway it will be able to log in

167
00:06:10,880 --> 00:06:12,800
because all password hash is stored

168
00:06:12,800 --> 00:06:13,840
there

169
00:06:13,840 --> 00:06:15,759
so this is very very commanded by

170
00:06:15,759 --> 00:06:17,039
microsoft

171
00:06:17,039 --> 00:06:17,919
but

172
00:06:17,919 --> 00:06:19,520
if you if you have the if you enable

173
00:06:19,520 --> 00:06:21,840
this past hashing what will happen

174
00:06:21,840 --> 00:06:23,840
account will have permission called

175
00:06:23,840 --> 00:06:26,560
replicate directory changes

176
00:06:26,560 --> 00:06:28,800
electric directory change changes all

177
00:06:28,800 --> 00:06:31,600
uh maybe you know what is that maybe not

178
00:06:31,600 --> 00:06:33,759
i will show you that anyway so let me

179
00:06:33,759 --> 00:06:36,000
jump back to demo let me jump to demo

180
00:06:36,000 --> 00:06:38,240
and show you those permissions

181
00:06:38,240 --> 00:06:41,199
if i go to properties of my domain

182
00:06:41,199 --> 00:06:43,680
and click security

183
00:06:43,680 --> 00:06:47,120
and click on srl

184
00:06:47,120 --> 00:06:48,400
so here

185
00:06:48,400 --> 00:06:50,160
those

186
00:06:50,160 --> 00:06:52,160
permissions

187
00:06:52,160 --> 00:06:53,840
they are delegate delegated

188
00:06:53,840 --> 00:06:55,759
automatically

189
00:06:55,759 --> 00:06:57,520
all right now

190
00:06:57,520 --> 00:07:00,000
uh two questions first of all

191
00:07:00,000 --> 00:07:03,120
uh how to compare how to own account

192
00:07:03,120 --> 00:07:04,400
because account was created

193
00:07:04,400 --> 00:07:07,039
automatically i don't know password for

194
00:07:07,039 --> 00:07:10,000
this account so how to own this account

195
00:07:10,000 --> 00:07:11,680
and second question all right if i own

196
00:07:11,680 --> 00:07:14,240
this account uh how privileges may be

197
00:07:14,240 --> 00:07:15,360
used

198
00:07:15,360 --> 00:07:18,080
let me show you the both answers

199
00:07:18,080 --> 00:07:20,720
uh i will switch to adconnect server

200
00:07:20,720 --> 00:07:21,919
i can

201
00:07:21,919 --> 00:07:24,960
go open sql server by sql server

202
00:07:24,960 --> 00:07:26,240
management studio

203
00:07:26,240 --> 00:07:27,919
and so let me answer the question about

204
00:07:27,919 --> 00:07:30,800
you the password for msl so password

205
00:07:30,800 --> 00:07:32,960
will be stored in the sql server

206
00:07:32,960 --> 00:07:35,680
database because adconnect has database

207
00:07:35,680 --> 00:07:37,199
behind the scenes

208
00:07:37,199 --> 00:07:38,960
and if you go to

209
00:07:38,960 --> 00:07:40,720
program files

210
00:07:40,720 --> 00:07:43,599
uh sql server oh not sorry not sql

211
00:07:43,599 --> 00:07:44,479
server

212
00:07:44,479 --> 00:07:45,280
um

213
00:07:45,280 --> 00:07:46,879
adsync

214
00:07:46,879 --> 00:07:50,000
data and here you may find database mdf

215
00:07:50,000 --> 00:07:52,160
of the database associated with ad

216
00:07:52,160 --> 00:07:53,520
connect

217
00:07:53,520 --> 00:07:55,680
now let me connect to this database

218
00:07:55,680 --> 00:07:59,479
using sql management studio

219
00:08:00,080 --> 00:08:03,759
um expand databases ad sync

220
00:08:03,759 --> 00:08:04,960
tables

221
00:08:04,960 --> 00:08:06,400
and if i look at the table called

222
00:08:06,400 --> 00:08:08,240
management sorry first let me show you

223
00:08:08,240 --> 00:08:10,400
the name of the table management agent

224
00:08:10,400 --> 00:08:12,240
so this this table should contain the

225
00:08:12,240 --> 00:08:13,680
data i want

226
00:08:13,680 --> 00:08:18,160
uh let me say select top thousand rows

227
00:08:20,400 --> 00:08:22,800
uh also to make it more convenient i'm

228
00:08:22,800 --> 00:08:25,759
going to get rid of some of the columns

229
00:08:25,759 --> 00:08:28,720
do it like this

230
00:08:28,720 --> 00:08:31,840
and let's run again

231
00:08:33,200 --> 00:08:36,320
and let's find

232
00:08:37,760 --> 00:08:39,679
this one this one

233
00:08:39,679 --> 00:08:42,880
so look at this msrl underscore 9cc in

234
00:08:42,880 --> 00:08:45,200
my case and so account is stored

235
00:08:45,200 --> 00:08:46,399
somewhere there i mean information about

236
00:08:46,399 --> 00:08:47,519
account

237
00:08:47,519 --> 00:08:50,480
and the password that says password

238
00:08:50,480 --> 00:08:52,800
uh is encrypted

239
00:08:52,800 --> 00:08:55,360
so password exists but

240
00:08:55,360 --> 00:08:56,640
it's not that straightforward so you

241
00:08:56,640 --> 00:08:59,040
can't just find you know the plain text

242
00:08:59,040 --> 00:09:01,519
values so password will be encrypted and

243
00:09:01,519 --> 00:09:04,880
now the most interesting thing which is

244
00:09:04,880 --> 00:09:07,279
quite commonly we find in when

245
00:09:07,279 --> 00:09:10,320
i find when we when i work with customer

246
00:09:10,320 --> 00:09:12,160
environments and run assessment

247
00:09:12,160 --> 00:09:15,360
so who can decrypt this password and the

248
00:09:15,360 --> 00:09:16,640
answer is

249
00:09:16,640 --> 00:09:20,240
local administrator so the user

250
00:09:20,240 --> 00:09:24,080
who has access to ad connect server um

251
00:09:24,080 --> 00:09:26,160
admin access to 380 connect server so

252
00:09:26,160 --> 00:09:27,839
this user may be local administrator on

253
00:09:27,839 --> 00:09:30,640
the server or adsync admin

254
00:09:30,640 --> 00:09:33,920
um so user with those permissions will

255
00:09:33,920 --> 00:09:35,120
be able

256
00:09:35,120 --> 00:09:38,240
to decrypt this password

257
00:09:38,240 --> 00:09:40,000
and unfortunately in the real world

258
00:09:40,000 --> 00:09:41,760
that's very common case

259
00:09:41,760 --> 00:09:43,519
because you know 80 connect not the main

260
00:09:43,519 --> 00:09:44,959
controller so

261
00:09:44,959 --> 00:09:46,720
uh middle level administrators quite

262
00:09:46,720 --> 00:09:49,360
often has have access to this

263
00:09:49,360 --> 00:09:50,399
to the server

264
00:09:50,399 --> 00:09:52,160
so let me show you how decryption may be

265
00:09:52,160 --> 00:09:53,200
done

266
00:09:53,200 --> 00:09:54,880
i can do it manually but that will take

267
00:09:54,880 --> 00:09:56,399
a while

268
00:09:56,399 --> 00:09:58,880
a while or i can use tool called ad

269
00:09:58,880 --> 00:10:01,040
connect dump so that's available freely

270
00:10:01,040 --> 00:10:02,480
on github

271
00:10:02,480 --> 00:10:05,760
i use this tool and just run

272
00:10:05,760 --> 00:10:06,959
script

273
00:10:06,959 --> 00:10:10,399
all right now i can see msol and crazy

274
00:10:10,399 --> 00:10:12,320
alone password

275
00:10:12,320 --> 00:10:15,600
so now i own the account

276
00:10:15,600 --> 00:10:17,920
from here let me copy this account

277
00:10:17,920 --> 00:10:20,399
this this password and jump to different

278
00:10:20,399 --> 00:10:23,040
workstation

279
00:10:23,040 --> 00:10:25,760
open cmd

280
00:10:25,920 --> 00:10:28,399
and open cmd as different as a different

281
00:10:28,399 --> 00:10:30,800
user

282
00:10:30,880 --> 00:10:33,600
so with this password and

283
00:10:33,600 --> 00:10:36,560
uh this username okay

284
00:10:36,560 --> 00:10:38,000
all right so

285
00:10:38,000 --> 00:10:39,440
now let's take a look on the first

286
00:10:39,440 --> 00:10:41,680
command prompt who i am

287
00:10:41,680 --> 00:10:44,399
i am user jdo and if i look at my

288
00:10:44,399 --> 00:10:46,959
permissions related domain controller so

289
00:10:46,959 --> 00:10:48,880
i'm going to try to list a c drive under

290
00:10:48,880 --> 00:10:50,560
my controller

291
00:10:50,560 --> 00:10:53,040
uh access the knight so this user jdom

292
00:10:53,040 --> 00:10:55,279
it maybe this user's local admin on this

293
00:10:55,279 --> 00:10:57,680
specific workstation but this user is

294
00:10:57,680 --> 00:10:59,680
not a domain administrator so just a

295
00:10:59,680 --> 00:11:01,600
regular user with local admin

296
00:11:01,600 --> 00:11:03,680
permissions now let's see

297
00:11:03,680 --> 00:11:05,360
where am i here

298
00:11:05,360 --> 00:11:07,680
uh this user m is a messerial let's see

299
00:11:07,680 --> 00:11:09,040
if i have permissions on domain

300
00:11:09,040 --> 00:11:11,519
controller access denied

301
00:11:11,519 --> 00:11:12,640
um

302
00:11:12,640 --> 00:11:15,200
no permissions

303
00:11:15,200 --> 00:11:16,800
okay

304
00:11:16,800 --> 00:11:18,240
um so

305
00:11:18,240 --> 00:11:19,440
what i can do

306
00:11:19,440 --> 00:11:22,079
uh with those permissions in that case

307
00:11:22,079 --> 00:11:24,800
if i open a very well-known tool

308
00:11:24,800 --> 00:11:26,880
mimikatz and probably you know that

309
00:11:26,880 --> 00:11:29,040
mimikatz maybe affiscated to to evade

310
00:11:29,040 --> 00:11:30,320
antiviruses

311
00:11:30,320 --> 00:11:32,640
uh so with mimikats i can run command

312
00:11:32,640 --> 00:11:35,760
called lsa dump dc sync so the idea of

313
00:11:35,760 --> 00:11:36,959
this is scene we will run the

314
00:11:36,959 --> 00:11:39,120
replication so we'll replicate

315
00:11:39,120 --> 00:11:41,600
information about any user we want

316
00:11:41,600 --> 00:11:43,600
if we have permissions

317
00:11:43,600 --> 00:11:45,680
i do have permission i mean not not me

318
00:11:45,680 --> 00:11:47,040
but this account has permissions to

319
00:11:47,040 --> 00:11:48,959
replicate right so i can replicate

320
00:11:48,959 --> 00:11:50,880
information about the my administrator

321
00:11:50,880 --> 00:11:53,040
in my case it's called trainer

322
00:11:53,040 --> 00:11:54,880
let's do it

323
00:11:54,880 --> 00:11:58,959
and now i have uh the password hash

324
00:11:58,959 --> 00:12:00,320
and if i

325
00:12:00,320 --> 00:12:02,800
run mimikatz on a different machine on a

326
00:12:02,800 --> 00:12:04,639
different command prompt so mimic that's

327
00:12:04,639 --> 00:12:05,440
here

328
00:12:05,440 --> 00:12:06,639
and let's

329
00:12:06,639 --> 00:12:08,800
elevate and run command call pass the

330
00:12:08,800 --> 00:12:13,279
hash and copy this hash paste here

331
00:12:13,279 --> 00:12:14,880
and now i have

332
00:12:14,880 --> 00:12:16,320
another command prompt with the main

333
00:12:16,320 --> 00:12:19,519
admin permissions so that's the

334
00:12:19,519 --> 00:12:21,279
that's what may happen that's what may

335
00:12:21,279 --> 00:12:24,720
happen if you allow

336
00:12:24,959 --> 00:12:28,079
users with um you know middle level

337
00:12:28,079 --> 00:12:29,680
administrator

338
00:12:29,680 --> 00:12:32,079
have access to ad connect server have a

339
00:12:32,079 --> 00:12:34,800
admin access to

340
00:12:35,360 --> 00:12:37,279
ad connect server

341
00:12:37,279 --> 00:12:39,680
so now we compromised um our active

342
00:12:39,680 --> 00:12:42,399
directory because of ad connect but not

343
00:12:42,399 --> 00:12:44,560
we're not yet in the cloud so we just

344
00:12:44,560 --> 00:12:47,600
here locally now we i'm a god locally

345
00:12:47,600 --> 00:12:49,279
but if i want to move on if i want to

346
00:12:49,279 --> 00:12:50,160
move

347
00:12:50,160 --> 00:12:50,959
and

348
00:12:50,959 --> 00:12:52,880
and test virtual machines or web

349
00:12:52,880 --> 00:12:55,200
application i must have some extra

350
00:12:55,200 --> 00:12:57,360
permissions right so now i i i'm just

351
00:12:57,360 --> 00:12:59,040
the main administrator which is like an

352
00:12:59,040 --> 00:13:01,600
on-prem user uh but if i want to test

353
00:13:01,600 --> 00:13:03,040
something in the cloud

354
00:13:03,040 --> 00:13:04,720
uh that's not enough

355
00:13:04,720 --> 00:13:05,600
so

356
00:13:05,600 --> 00:13:08,079
um let's continue our journey and let's

357
00:13:08,079 --> 00:13:10,880
try to get into the cloud

358
00:13:10,880 --> 00:13:15,040
to get get into the cloud we must

359
00:13:15,360 --> 00:13:18,880
do it somehow um if i'm administrator

360
00:13:18,880 --> 00:13:20,720
and i can control ad connect so what i

361
00:13:20,720 --> 00:13:21,440
can

362
00:13:21,440 --> 00:13:23,120
one option i can do

363
00:13:23,120 --> 00:13:25,839
uh i can create a user locally this user

364
00:13:25,839 --> 00:13:27,839
will be synchronized and then this user

365
00:13:27,839 --> 00:13:29,040
will become the

366
00:13:29,040 --> 00:13:31,360
cloud user but the problem is this user

367
00:13:31,360 --> 00:13:33,920
will be like a regular user maybe of

368
00:13:33,920 --> 00:13:35,839
course we can add this user to the group

369
00:13:35,839 --> 00:13:37,680
and this group may have some permissions

370
00:13:37,680 --> 00:13:39,279
so there are a number of ways to do that

371
00:13:39,279 --> 00:13:41,360
to achieve that but let me show you how

372
00:13:41,360 --> 00:13:43,440
we can play with tokens

373
00:13:43,440 --> 00:13:46,079
um and get into the cloud using tokens

374
00:13:46,079 --> 00:13:47,360
so i'm going back

375
00:13:47,360 --> 00:13:48,480
to to

376
00:13:48,480 --> 00:13:50,399
demo

377
00:13:50,399 --> 00:13:52,399
and so if i'm a domain administrator i

378
00:13:52,399 --> 00:13:54,399
can connect to literally any workstation

379
00:13:54,399 --> 00:13:57,519
right so any workstation on the network

380
00:13:57,519 --> 00:13:59,360
most of the time that's correct and so

381
00:13:59,360 --> 00:14:01,920
let me uh open one command prompt on one

382
00:14:01,920 --> 00:14:03,839
on one machine and let's say i want to

383
00:14:03,839 --> 00:14:07,120
list virtual machines in the cloud

384
00:14:07,120 --> 00:14:08,079
and

385
00:14:08,079 --> 00:14:10,160
that's working now let's do the same on

386
00:14:10,160 --> 00:14:12,800
a different machine

387
00:14:15,040 --> 00:14:16,720
and it should fail

388
00:14:16,720 --> 00:14:17,680
here

389
00:14:17,680 --> 00:14:19,279
to fail

390
00:14:19,279 --> 00:14:22,000
yeah it says you must run ac login so

391
00:14:22,000 --> 00:14:24,000
wait a second why i

392
00:14:24,000 --> 00:14:27,040
um why i must run ac login here

393
00:14:27,040 --> 00:14:27,839
but

394
00:14:27,839 --> 00:14:31,680
just easily get every all formation here

395
00:14:31,680 --> 00:14:34,240
the reason is after you after you run

396
00:14:34,240 --> 00:14:37,360
easy login the token will be cached

397
00:14:37,360 --> 00:14:40,720
locally so if i go to users

398
00:14:40,720 --> 00:14:42,639
find my folder here's the folder called

399
00:14:42,639 --> 00:14:45,600
that azure in my profile

400
00:14:45,600 --> 00:14:47,199
and in in this folder by the way that's

401
00:14:47,199 --> 00:14:49,440
the previous one in this folder

402
00:14:49,440 --> 00:14:51,680
some tokens will be cached um access

403
00:14:51,680 --> 00:14:54,560
token a refresh token and access token

404
00:14:54,560 --> 00:14:56,079
has expiration date but the refresh

405
00:14:56,079 --> 00:14:58,800
token will be on my disk for a long time

406
00:14:58,800 --> 00:15:00,880
and there's if if i'm using if i use

407
00:15:00,880 --> 00:15:02,800
that by default it will not expire at

408
00:15:02,800 --> 00:15:03,839
all

409
00:15:03,839 --> 00:15:06,000
so let me take all of these files let me

410
00:15:06,000 --> 00:15:07,120
zip them

411
00:15:07,120 --> 00:15:11,160
just to speed things up

412
00:15:12,160 --> 00:15:13,040
uh

413
00:15:13,040 --> 00:15:14,399
copy this

414
00:15:14,399 --> 00:15:16,800
and let's try to

415
00:15:16,800 --> 00:15:21,040
paste that to different workstation

416
00:15:24,160 --> 00:15:27,560
remove this

417
00:15:31,040 --> 00:15:35,199
all right let's extract here

418
00:15:35,360 --> 00:15:37,680
and let's repeat this the same attack i

419
00:15:37,680 --> 00:15:40,720
mean not attack but the same command uh

420
00:15:40,720 --> 00:15:43,199
fingers crossed it should work now

421
00:15:43,199 --> 00:15:46,320
yep that's working that's working so uh

422
00:15:46,320 --> 00:15:47,440
because i

423
00:15:47,440 --> 00:15:49,360
because i got a refresh token this

424
00:15:49,360 --> 00:15:52,000
refresh token gave me new access token

425
00:15:52,000 --> 00:15:55,519
and i bypass mfa i bypassed uh all the

426
00:15:55,519 --> 00:15:57,360
password prompts just because i have

427
00:15:57,360 --> 00:15:58,560
this token

428
00:15:58,560 --> 00:16:00,800
all right so now let me jump back to

429
00:16:00,800 --> 00:16:02,639
slides

430
00:16:02,639 --> 00:16:03,600
and

431
00:16:03,600 --> 00:16:06,160
now i can connect to the cloud

432
00:16:06,160 --> 00:16:08,800
and so what i and in the cloud first i

433
00:16:08,800 --> 00:16:10,800
want to show you how we can pen test and

434
00:16:10,800 --> 00:16:12,880
how we can play with virtual machines

435
00:16:12,880 --> 00:16:14,800
uh i have two virtual machines and

436
00:16:14,800 --> 00:16:16,560
jenkins which is you know very well

437
00:16:16,560 --> 00:16:20,079
known cicd uh server and jenkins deploy

438
00:16:20,079 --> 00:16:21,440
on those those virtual machines to be

439
00:16:21,440 --> 00:16:22,800
fair it's not really important for

440
00:16:22,800 --> 00:16:24,800
jenkins or something else my goal is to

441
00:16:24,800 --> 00:16:27,519
show you virtual machine pen test for

442
00:16:27,519 --> 00:16:29,519
when when we have linux and windows as

443
00:16:29,519 --> 00:16:30,560
well

444
00:16:30,560 --> 00:16:33,600
so first let me jump to

445
00:16:33,600 --> 00:16:34,839
two to

446
00:16:34,839 --> 00:16:36,560
two

447
00:16:36,560 --> 00:16:37,839
portal

448
00:16:37,839 --> 00:16:39,680
azure portal

449
00:16:39,680 --> 00:16:42,240
and i just want to show you oh i didn't

450
00:16:42,240 --> 00:16:44,480
sign in let me quickly quickly sign in

451
00:16:44,480 --> 00:16:47,800
wait a second

452
00:16:50,240 --> 00:16:52,320
fine now

453
00:16:52,320 --> 00:16:55,040
so let me quickly show you

454
00:16:55,040 --> 00:16:57,279
my virtual machines

455
00:16:57,279 --> 00:16:59,120
on the portal

456
00:16:59,120 --> 00:17:01,040
so there are virtual machines jenkins

457
00:17:01,040 --> 00:17:03,759
master and jenkins slave that's my goal

458
00:17:03,759 --> 00:17:05,520
to work with those machines jenkins

459
00:17:05,520 --> 00:17:07,599
master

460
00:17:07,599 --> 00:17:09,119
is windows

461
00:17:09,119 --> 00:17:10,000
so

462
00:17:10,000 --> 00:17:14,079
windows where it says window windows

463
00:17:14,319 --> 00:17:16,480
and jenkins slave

464
00:17:16,480 --> 00:17:20,000
is linux so if i wanna if if i want to

465
00:17:20,000 --> 00:17:22,079
connect the virtual machine

466
00:17:22,079 --> 00:17:23,359
um

467
00:17:23,359 --> 00:17:25,039
let's let's say i know the ap address

468
00:17:25,039 --> 00:17:26,959
let me copy this ap address

469
00:17:26,959 --> 00:17:29,440
uh openms oh

470
00:17:29,440 --> 00:17:32,440
dms

471
00:17:34,080 --> 00:17:37,440
it was notepad with file name ms

472
00:17:37,440 --> 00:17:40,160
mstsc

473
00:17:40,160 --> 00:17:42,080
and let's connect to this

474
00:17:42,080 --> 00:17:44,480
machine

475
00:17:44,880 --> 00:17:46,640
it was connected but i must know the

476
00:17:46,640 --> 00:17:48,640
password so what if i don't know the

477
00:17:48,640 --> 00:17:49,919
password

478
00:17:49,919 --> 00:17:52,400
um and i don't so now i don't know the

479
00:17:52,400 --> 00:17:53,440
password

480
00:17:53,440 --> 00:17:56,960
um so maybe there's a way somehow bypass

481
00:17:56,960 --> 00:17:59,039
this password prompt and get into

482
00:17:59,039 --> 00:18:01,600
virtual machine without password prompt

483
00:18:01,600 --> 00:18:03,039
the same problem by the way maybe on

484
00:18:03,039 --> 00:18:06,720
linux maybe i need to have a sh key or

485
00:18:06,720 --> 00:18:09,760
or root password to log in i don't have

486
00:18:09,760 --> 00:18:11,600
any all of this

487
00:18:11,600 --> 00:18:12,720
so

488
00:18:12,720 --> 00:18:15,360
how we can try to bypass that

489
00:18:15,360 --> 00:18:18,240
there is a feature called run command

490
00:18:18,240 --> 00:18:20,480
so the idea of this run command that you

491
00:18:20,480 --> 00:18:24,880
may run any command inside of virtual

492
00:18:24,880 --> 00:18:25,760
and

493
00:18:25,760 --> 00:18:29,200
it will run with the highest privileges

494
00:18:29,200 --> 00:18:31,520
so the the idea of that is like when you

495
00:18:31,520 --> 00:18:32,960
have virtual machines in the cloud you

496
00:18:32,960 --> 00:18:34,240
don't need to log into each machine

497
00:18:34,240 --> 00:18:35,760
individually if you want to manage them

498
00:18:35,760 --> 00:18:37,440
you just you can you can do that right

499
00:18:37,440 --> 00:18:38,799
from here you don't need to log into

500
00:18:38,799 --> 00:18:40,000
machine

501
00:18:40,000 --> 00:18:41,919
but at the same time what if we run some

502
00:18:41,919 --> 00:18:43,600
commands that give me access like a

503
00:18:43,600 --> 00:18:45,440
reverse shell

504
00:18:45,440 --> 00:18:47,120
let's try that

505
00:18:47,120 --> 00:18:48,960
by the way to run command you must have

506
00:18:48,960 --> 00:18:51,919
permission for that of course

507
00:18:51,919 --> 00:18:53,760
so if i go to roles

508
00:18:53,760 --> 00:18:55,600
there's a number of roles and the role

509
00:18:55,600 --> 00:18:58,400
that you must have is called contributor

510
00:18:58,400 --> 00:19:00,320
or maybe customer role that has those

511
00:19:00,320 --> 00:19:02,880
permissions so this role but usually if

512
00:19:02,880 --> 00:19:05,440
we we're still talking of developer or

513
00:19:05,440 --> 00:19:08,400
can or administrator those that role

514
00:19:08,400 --> 00:19:11,200
will be available to me so that's that

515
00:19:11,200 --> 00:19:13,919
role will be assigned all right so let's

516
00:19:13,919 --> 00:19:17,039
try that i'm gonna jump back to demo

517
00:19:17,039 --> 00:19:18,320
and let's continue from here where we

518
00:19:18,320 --> 00:19:19,679
left off

519
00:19:19,679 --> 00:19:23,120
um so let's try to establish uh linux

520
00:19:23,120 --> 00:19:25,280
and windows shells so on my attacker

521
00:19:25,280 --> 00:19:28,080
machine i have netcat

522
00:19:28,080 --> 00:19:29,360
who did it

523
00:19:29,360 --> 00:19:30,960
uh i don't know

524
00:19:30,960 --> 00:19:32,960
uh i have netcat

525
00:19:32,960 --> 00:19:35,280
i have netcat

526
00:19:35,280 --> 00:19:37,520
and i'm listening on port 444 and five

527
00:19:37,520 --> 00:19:39,200
five five five so one for windows

528
00:19:39,200 --> 00:19:41,200
another one for linux so let me try to

529
00:19:41,200 --> 00:19:44,720
run command for linux

530
00:19:45,280 --> 00:19:46,799
so that's just

531
00:19:46,799 --> 00:19:49,280
just a reverse shell

532
00:19:49,280 --> 00:19:51,039
and the same time i wanna do the same

533
00:19:51,039 --> 00:19:53,840
for windows

534
00:19:57,039 --> 00:19:58,080
alright

535
00:19:58,080 --> 00:20:01,120
so let's see what's going on

536
00:20:01,120 --> 00:20:03,919
oh i have a shell on linux let's see

537
00:20:03,919 --> 00:20:06,400
let's click id and that that's rude

538
00:20:06,400 --> 00:20:08,320
because all run commands they work on

539
00:20:08,320 --> 00:20:09,919
behalf of the most privileged users so

540
00:20:09,919 --> 00:20:12,400
let's root and on windows it will be

541
00:20:12,400 --> 00:20:14,880
system otherwise

542
00:20:14,880 --> 00:20:16,880
it takes a bit more time oh here we go

543
00:20:16,880 --> 00:20:18,559
so who am i

544
00:20:18,559 --> 00:20:20,880
um and so on local system so generally

545
00:20:20,880 --> 00:20:23,679
speaking that was my goal to to uh get

546
00:20:23,679 --> 00:20:25,760
into virtual machines and let's see who

547
00:20:25,760 --> 00:20:27,760
am i uh last name

548
00:20:27,760 --> 00:20:29,039
last name

549
00:20:29,039 --> 00:20:31,440
uh jenkins master and of course jenkins

550
00:20:31,440 --> 00:20:35,200
slave as well uh host name here jenkins

551
00:20:35,200 --> 00:20:36,000
slave

552
00:20:36,000 --> 00:20:36,799
um

553
00:20:36,799 --> 00:20:39,039
all right so let's because i'm i'm here

554
00:20:39,039 --> 00:20:41,520
on virtual machine so on master it must

555
00:20:41,520 --> 00:20:42,960
it must have

556
00:20:42,960 --> 00:20:45,760
a default password in airlock let me try

557
00:20:45,760 --> 00:20:47,760
to find that

558
00:20:47,760 --> 00:20:50,080
jenkins error log

559
00:20:50,080 --> 00:20:51,600
default password this should be here

560
00:20:51,600 --> 00:20:53,200
yeah it's here

561
00:20:53,200 --> 00:20:56,640
so let me copy this

562
00:20:58,559 --> 00:21:01,039
paste into notepad

563
00:21:01,039 --> 00:21:05,280
and let's just go to

564
00:21:05,280 --> 00:21:07,760
uh jenkins master

565
00:21:07,760 --> 00:21:09,520
um

566
00:21:09,520 --> 00:21:12,720
copy ip address

567
00:21:12,960 --> 00:21:14,559
and go to

568
00:21:14,559 --> 00:21:15,360
this

569
00:21:15,360 --> 00:21:16,640
address

570
00:21:16,640 --> 00:21:19,440
admin user and this

571
00:21:19,440 --> 00:21:23,440
crazy alone passport work

572
00:21:23,440 --> 00:21:25,120
yep that's working it doesn't really

573
00:21:25,120 --> 00:21:27,360
matter if it's working or not my goal

574
00:21:27,360 --> 00:21:29,120
was to compromise virtual machines get

575
00:21:29,120 --> 00:21:31,200
into virtual machines and bypass

576
00:21:31,200 --> 00:21:33,760
password prompts that's that was my goal

577
00:21:33,760 --> 00:21:35,039
and i did that

578
00:21:35,039 --> 00:21:37,520
uh so

579
00:21:37,520 --> 00:21:38,799
compromised

580
00:21:38,799 --> 00:21:39,919
and so

581
00:21:39,919 --> 00:21:41,919
from here let's jump to the next

582
00:21:41,919 --> 00:21:43,440
scenario which is going to be the last

583
00:21:43,440 --> 00:21:45,520
one and the longest one

584
00:21:45,520 --> 00:21:47,440
where i'm going to show you how we can

585
00:21:47,440 --> 00:21:48,720
play with

586
00:21:48,720 --> 00:21:51,520
uh pass services so now we don't have

587
00:21:51,520 --> 00:21:54,159
virtual machines now we use native azure

588
00:21:54,159 --> 00:21:56,880
services like web application

589
00:21:56,880 --> 00:21:59,919
sql server database so

590
00:21:59,919 --> 00:22:01,360
here is going to be like a next

591
00:22:01,360 --> 00:22:03,520
challenge so what do we have here

592
00:22:03,520 --> 00:22:05,360
i have web app

593
00:22:05,360 --> 00:22:07,600
web app has backend it's like a front

594
00:22:07,600 --> 00:22:09,200
end and back end

595
00:22:09,200 --> 00:22:12,640
front end on the app service backend on

596
00:22:12,640 --> 00:22:15,360
sql server uh to connect from

597
00:22:15,360 --> 00:22:17,039
front end to back end we need to have

598
00:22:17,039 --> 00:22:19,280
username username and password right

599
00:22:19,280 --> 00:22:22,720
so uh but we will not store those few

600
00:22:22,720 --> 00:22:26,320
those credentials uh on actual web host

601
00:22:26,320 --> 00:22:29,039
that's a bad practice so what we can do

602
00:22:29,039 --> 00:22:30,880
and what we did here i'm storing

603
00:22:30,880 --> 00:22:33,440
credentials in key vault so that's the

604
00:22:33,440 --> 00:22:36,240
special service to store secrets keys

605
00:22:36,240 --> 00:22:37,360
and so on

606
00:22:37,360 --> 00:22:39,120
um and there's no recommendation if you

607
00:22:39,120 --> 00:22:40,640
have key vaults with when you store

608
00:22:40,640 --> 00:22:42,799
secrets and keys in the keyboard you

609
00:22:42,799 --> 00:22:45,760
should also rotate them periodically and

610
00:22:45,760 --> 00:22:47,600
so for this purpose i have here a

611
00:22:47,600 --> 00:22:50,159
rotation credential rotation function

612
00:22:50,159 --> 00:22:51,919
that will periodically

613
00:22:51,919 --> 00:22:54,640
change credentials in a key vault and

614
00:22:54,640 --> 00:22:57,440
change them in a back end as well

615
00:22:57,440 --> 00:22:58,320
so

616
00:22:58,320 --> 00:23:00,640
that is my scenario and let me show you

617
00:23:00,640 --> 00:23:03,840
first this scenario and we'll talk then

618
00:23:03,840 --> 00:23:05,840
what may be the entry point

619
00:23:05,840 --> 00:23:08,400
i'm going to i'm going to jump to demo

620
00:23:08,400 --> 00:23:10,640
again

621
00:23:11,039 --> 00:23:15,760
so let's click on the keyboard

622
00:23:19,200 --> 00:23:20,880
let's say

623
00:23:20,880 --> 00:23:23,840
secrets

624
00:23:24,080 --> 00:23:25,840
it says i don't have permissions to list

625
00:23:25,840 --> 00:23:27,039
them

626
00:23:27,039 --> 00:23:29,120
so

627
00:23:29,120 --> 00:23:30,720
it doesn't work

628
00:23:30,720 --> 00:23:33,200
i mean i can't see them so my user that

629
00:23:33,200 --> 00:23:34,640
current user doesn't have permissions to

630
00:23:34,640 --> 00:23:36,880
list credentials let's

631
00:23:36,880 --> 00:23:38,640
list those secrets let me quickly give

632
00:23:38,640 --> 00:23:40,159
permission to myself just to show you

633
00:23:40,159 --> 00:23:41,760
that they exist

634
00:23:41,760 --> 00:23:44,879
uh they are not empty

635
00:23:45,360 --> 00:23:46,960
now let's click select

636
00:23:46,960 --> 00:23:49,039
and click add

637
00:23:49,039 --> 00:23:51,360
uh so click save

638
00:23:51,360 --> 00:23:52,640
all right and now if i go back to

639
00:23:52,640 --> 00:23:55,440
secrets i can see there is a passport

640
00:23:55,440 --> 00:23:58,000
and username pass and username

641
00:23:58,000 --> 00:23:59,600
so let me remove those credentials real

642
00:23:59,600 --> 00:24:00,720
quick

643
00:24:00,720 --> 00:24:02,080
and let's click save

644
00:24:02,080 --> 00:24:03,840
and click

645
00:24:03,840 --> 00:24:05,679
all right so

646
00:24:05,679 --> 00:24:06,559
uh

647
00:24:06,559 --> 00:24:08,720
that's that's key vault let's check web

648
00:24:08,720 --> 00:24:10,880
application

649
00:24:10,880 --> 00:24:13,840
so web up here uh let me open this web

650
00:24:13,840 --> 00:24:15,120
application

651
00:24:15,120 --> 00:24:16,480
it will take some time before it will

652
00:24:16,480 --> 00:24:19,039
open for the first time um and also what

653
00:24:19,039 --> 00:24:21,919
is important uh my sql ser my sql

654
00:24:21,919 --> 00:24:23,360
database

655
00:24:23,360 --> 00:24:26,240
uh will also need some time to to to

656
00:24:26,240 --> 00:24:28,159
resume because now it's paused

657
00:24:28,159 --> 00:24:30,559
uh but so that but it will start to work

658
00:24:30,559 --> 00:24:32,480
soon for our demo

659
00:24:32,480 --> 00:24:34,960
all right so looks like all of this look

660
00:24:34,960 --> 00:24:36,240
pretty fine

661
00:24:36,240 --> 00:24:38,320
where maybe an entry point so first of

662
00:24:38,320 --> 00:24:40,240
all maybe we'll application

663
00:24:40,240 --> 00:24:42,880
but from applications will be hard to

664
00:24:42,880 --> 00:24:46,080
move from to other uh to other parts

665
00:24:46,080 --> 00:24:48,320
another entry point

666
00:24:48,320 --> 00:24:50,559
is um

667
00:24:50,559 --> 00:24:53,360
a rotation this function to rotate

668
00:24:53,360 --> 00:24:54,480
secrets

669
00:24:54,480 --> 00:24:56,400
uh i don't wanna say it's

670
00:24:56,400 --> 00:24:59,520
i i saw that uh very common it's very

671
00:24:59,520 --> 00:25:02,000
common but sometimes we saw that uh one

672
00:25:02,000 --> 00:25:03,600
one of the problem

673
00:25:03,600 --> 00:25:06,480
one one of the problem of key volts um

674
00:25:06,480 --> 00:25:07,279
um

675
00:25:07,279 --> 00:25:10,240
is that by default we have what's called

676
00:25:10,240 --> 00:25:11,120
uh

677
00:25:11,120 --> 00:25:13,919
volt access policy and this world access

678
00:25:13,919 --> 00:25:16,400
policy is separate from other

679
00:25:16,400 --> 00:25:17,760
permissions

680
00:25:17,760 --> 00:25:19,360
what they mean by this separate from

681
00:25:19,360 --> 00:25:20,640
other permissions

682
00:25:20,640 --> 00:25:22,080
um so

683
00:25:22,080 --> 00:25:23,360
you configure

684
00:25:23,360 --> 00:25:25,840
world access policy here

685
00:25:25,840 --> 00:25:29,520
uh and it's not uh connected with other

686
00:25:29,520 --> 00:25:30,960
configurations like subscription

687
00:25:30,960 --> 00:25:33,200
permissions or resource group permission

688
00:25:33,200 --> 00:25:35,440
and so on um there's a new model called

689
00:25:35,440 --> 00:25:37,279
azure role group which is a bit better

690
00:25:37,279 --> 00:25:39,600
but more companies use this vault access

691
00:25:39,600 --> 00:25:43,039
policy so quite often quite often

692
00:25:43,039 --> 00:25:43,840
um

693
00:25:43,840 --> 00:25:46,640
the the permissions here on the function

694
00:25:46,640 --> 00:25:48,640
and on the keyboard are not very

695
00:25:48,640 --> 00:25:50,720
synchronized so

696
00:25:50,720 --> 00:25:52,960
they are configured differently

697
00:25:52,960 --> 00:25:54,559
and you may not have permissions on the

698
00:25:54,559 --> 00:25:56,960
keyboard level so no permissions here on

699
00:25:56,960 --> 00:25:59,679
the keyboard level at the same time you

700
00:25:59,679 --> 00:26:02,640
have permissions on the function level

701
00:26:02,640 --> 00:26:04,799
because they are configured differently

702
00:26:04,799 --> 00:26:06,880
and so like for example you have you

703
00:26:06,880 --> 00:26:08,159
have contributor role on the

704
00:26:08,159 --> 00:26:10,640
subscription level and that's why and it

705
00:26:10,640 --> 00:26:13,840
will be inherited by function itself

706
00:26:13,840 --> 00:26:14,640
so

707
00:26:14,640 --> 00:26:16,799
what we found periodically not often but

708
00:26:16,799 --> 00:26:18,720
sometimes when companies use this

709
00:26:18,720 --> 00:26:21,279
function function to rotate credentials

710
00:26:21,279 --> 00:26:23,279
permission is not configured

711
00:26:23,279 --> 00:26:24,880
in the same manner

712
00:26:24,880 --> 00:26:27,120
and so if we can control function we can

713
00:26:27,120 --> 00:26:28,799
try to

714
00:26:28,799 --> 00:26:31,760
run our own code in this function

715
00:26:31,760 --> 00:26:34,480
and extract secrets from keyword because

716
00:26:34,480 --> 00:26:36,480
function has permissions to

717
00:26:36,480 --> 00:26:38,880
to access keyboard so let's do it let me

718
00:26:38,880 --> 00:26:41,200
switch back to demo

719
00:26:41,200 --> 00:26:43,840
and let's go to two to two

720
00:26:43,840 --> 00:26:46,080
akb rotation it's called

721
00:26:46,080 --> 00:26:47,360
and this function by the way from

722
00:26:47,360 --> 00:26:50,159
microsoft so i i did not create myself i

723
00:26:50,159 --> 00:26:52,480
just took it from from from the github

724
00:26:52,480 --> 00:26:55,120
and um in on this github function we

725
00:26:55,120 --> 00:26:57,279
have i mean it's all it's so it's called

726
00:26:57,279 --> 00:26:58,960
function application and we have two

727
00:26:58,960 --> 00:27:01,440
functions there with different triggers

728
00:27:01,440 --> 00:27:03,520
so if i'm do it that means you may like

729
00:27:03,520 --> 00:27:05,279
create custom trigger with event grid

730
00:27:05,279 --> 00:27:07,279
with special service rendered

731
00:27:07,279 --> 00:27:10,000
or http trigger so that means i can send

732
00:27:10,000 --> 00:27:12,159
it as edge send http request and the

733
00:27:12,159 --> 00:27:13,679
function will be triggered that's what i

734
00:27:13,679 --> 00:27:16,960
want for my demo let's let's click here

735
00:27:16,960 --> 00:27:20,520
click code and test

736
00:27:23,039 --> 00:27:25,760
and here is my code to be fair i already

737
00:27:25,760 --> 00:27:28,960
configured this so initial code was uh

738
00:27:28,960 --> 00:27:31,440
this one

739
00:27:32,000 --> 00:27:35,440
but i changed this code somehow hmm

740
00:27:35,440 --> 00:27:37,039
how i did that

741
00:27:37,039 --> 00:27:38,720
uh the problem with what when the

742
00:27:38,720 --> 00:27:40,399
problem with functions are the problem

743
00:27:40,399 --> 00:27:41,600
with functions

744
00:27:41,600 --> 00:27:44,480
um by default by default

745
00:27:44,480 --> 00:27:46,840
ftp access is

746
00:27:46,840 --> 00:27:49,840
allowed come on code configuration

747
00:27:49,840 --> 00:27:52,960
so when you create function ftp state is

748
00:27:52,960 --> 00:27:56,080
all allowed it's it's default

749
00:27:56,080 --> 00:27:58,640
um and companies they don't use that

750
00:27:58,640 --> 00:28:00,480
they don't use ftp usually they deploy

751
00:28:00,480 --> 00:28:03,200
using you know continuous deployment

752
00:28:03,200 --> 00:28:05,760
devops process at the same time ftp is

753
00:28:05,760 --> 00:28:08,000
enabled by default and not everyone

754
00:28:08,000 --> 00:28:11,120
disable ftp so what i can do i can

755
00:28:11,120 --> 00:28:12,559
connect

756
00:28:12,559 --> 00:28:15,200
to the function using ftp and add my own

757
00:28:15,200 --> 00:28:16,720
files there and

758
00:28:16,720 --> 00:28:18,720
and make my make modification so i'm

759
00:28:18,720 --> 00:28:22,000
going to jump back to demo and let let's

760
00:28:22,000 --> 00:28:24,559
do it from here

761
00:28:24,559 --> 00:28:26,720
i will open filezilla

762
00:28:26,720 --> 00:28:28,399
ftp client

763
00:28:28,399 --> 00:28:31,520
and now now let's try to first find ftp

764
00:28:31,520 --> 00:28:34,960
address ftp url

765
00:28:40,480 --> 00:28:44,399
and let's extract credentials

766
00:28:46,880 --> 00:28:48,559
so let me show you where you can find

767
00:28:48,559 --> 00:28:49,600
them

768
00:28:49,600 --> 00:28:52,320
if you go to to do deployment center i

769
00:28:52,320 --> 00:28:53,360
mean where you can find them on the

770
00:28:53,360 --> 00:28:54,720
portal

771
00:28:54,720 --> 00:28:56,880
here's ftp credentials and so you may

772
00:28:56,880 --> 00:28:59,520
you may show show them here

773
00:28:59,520 --> 00:29:04,559
so uh let me copy those credentials

774
00:29:05,679 --> 00:29:07,279
and let's copy

775
00:29:07,279 --> 00:29:11,080
password as well

776
00:29:14,080 --> 00:29:16,159
copy this

777
00:29:16,159 --> 00:29:18,320
and yeah i was able to connect here's my

778
00:29:18,320 --> 00:29:20,080
function function

779
00:29:20,080 --> 00:29:22,640
go here and so i what i did i took

780
00:29:22,640 --> 00:29:24,000
initial function

781
00:29:24,000 --> 00:29:27,600
rename that to run.all.ps1 and place my

782
00:29:27,600 --> 00:29:28,960
own code

783
00:29:28,960 --> 00:29:30,960
and this code will extract

784
00:29:30,960 --> 00:29:32,960
data from keyvault

785
00:29:32,960 --> 00:29:36,799
so now i'm going to run powershell

786
00:29:36,799 --> 00:29:40,159
and send http trigger

787
00:29:40,159 --> 00:29:41,919
i mean the same http request

788
00:29:41,919 --> 00:29:43,679
to trigger the function by the way it

789
00:29:43,679 --> 00:29:45,440
may take it might take some time before

790
00:29:45,440 --> 00:29:47,760
function gives me

791
00:29:47,760 --> 00:29:50,399
an answer it may might take 30 seconds

792
00:29:50,399 --> 00:29:52,240
it might take a few minutes

793
00:29:52,240 --> 00:29:55,520
um so let me wait for a few seconds um

794
00:29:55,520 --> 00:29:58,960
let me just jump the slides um

795
00:29:58,960 --> 00:30:00,399
jump the slides

796
00:30:00,399 --> 00:30:02,720
um so we can compromise this function

797
00:30:02,720 --> 00:30:05,200
and now we're trying to uh using this

798
00:30:05,200 --> 00:30:07,039
function we're trying to get secret from

799
00:30:07,039 --> 00:30:09,200
key vault we're trying to do it

800
00:30:09,200 --> 00:30:11,039
uh it might take some time

801
00:30:11,039 --> 00:30:12,720
i

802
00:30:12,720 --> 00:30:15,760
i i know those credentials anyway so if

803
00:30:15,760 --> 00:30:18,399
it's it will they take too long i will

804
00:30:18,399 --> 00:30:19,760
keep this step

805
00:30:19,760 --> 00:30:23,279
but let's check maybe we already have

806
00:30:23,279 --> 00:30:25,840
maybe we already have an answer yeah so

807
00:30:25,840 --> 00:30:27,840
well the username is webapp and the

808
00:30:27,840 --> 00:30:31,760
password is password all right now so

809
00:30:31,760 --> 00:30:33,120
what i want to do let me just by the way

810
00:30:33,120 --> 00:30:36,480
in parallel open sql management studio

811
00:30:36,480 --> 00:30:39,200
to machines

812
00:30:40,240 --> 00:30:43,039
and jump back to slide so now

813
00:30:43,039 --> 00:30:46,320
i i got credentials from keyboard and

814
00:30:46,320 --> 00:30:47,919
with those credentials i can try to

815
00:30:47,919 --> 00:30:50,240
connect to sql backend

816
00:30:50,240 --> 00:30:51,679
so

817
00:30:51,679 --> 00:30:54,240
uh usually backend should not have

818
00:30:54,240 --> 00:30:55,919
they don't have access to should not

819
00:30:55,919 --> 00:30:58,159
have access to public access to to this

820
00:30:58,159 --> 00:31:00,080
database but let's check that first

821
00:31:00,080 --> 00:31:01,840
because that's in the cloud maybe it's

822
00:31:01,840 --> 00:31:04,480
public we'll see we'll see

823
00:31:04,480 --> 00:31:06,600
so let's let's do it

824
00:31:06,600 --> 00:31:07,840
[Music]

825
00:31:07,840 --> 00:31:09,440
um so

826
00:31:09,440 --> 00:31:12,720
let me copy this url

827
00:31:12,720 --> 00:31:14,320
paste here

828
00:31:14,320 --> 00:31:16,639
one

829
00:31:16,960 --> 00:31:18,720
web app

830
00:31:18,720 --> 00:31:21,679
and password

831
00:31:21,679 --> 00:31:24,720
and it says hey if you want to connect

832
00:31:24,720 --> 00:31:27,039
you your your ip address must be

833
00:31:27,039 --> 00:31:29,360
whitelisted because there is a firewall

834
00:31:29,360 --> 00:31:32,240
that does not allow you to connect let's

835
00:31:32,240 --> 00:31:34,240
check that let's show that on the on the

836
00:31:34,240 --> 00:31:38,799
portal if i go to sql server

837
00:31:38,799 --> 00:31:39,679
um

838
00:31:39,679 --> 00:31:40,799
and

839
00:31:40,799 --> 00:31:42,880
click firewall

840
00:31:42,880 --> 00:31:45,360
so we can see here that

841
00:31:45,360 --> 00:31:48,880
yeah my so there's no rules

842
00:31:48,880 --> 00:31:51,360
for ap addresses so that's why i cannot

843
00:31:51,360 --> 00:31:52,240
connect

844
00:31:52,240 --> 00:31:54,399
to

845
00:31:55,679 --> 00:31:57,840
this database but at the same time we

846
00:31:57,840 --> 00:32:00,720
have very very dangerous

847
00:32:00,720 --> 00:32:02,320
settings enabled

848
00:32:02,320 --> 00:32:04,799
allow azure services and the resources

849
00:32:04,799 --> 00:32:07,200
to access this server

850
00:32:07,200 --> 00:32:08,960
so what does it mean

851
00:32:08,960 --> 00:32:11,440
it looks like if you enable this your

852
00:32:11,440 --> 00:32:13,039
azure services like

853
00:32:13,039 --> 00:32:14,559
what you have in the cloud

854
00:32:14,559 --> 00:32:17,200
will be able to connect to to sql so it

855
00:32:17,200 --> 00:32:19,120
sounds sounds pretty good right so you

856
00:32:19,120 --> 00:32:21,360
just enable this you say yes and all of

857
00:32:21,360 --> 00:32:23,519
your services that you run in the cloud

858
00:32:23,519 --> 00:32:25,600
will have access cool

859
00:32:25,600 --> 00:32:27,360
but the problem is it's not only about

860
00:32:27,360 --> 00:32:28,880
your services

861
00:32:28,880 --> 00:32:31,840
that's about any ip address belongs to

862
00:32:31,840 --> 00:32:33,039
azure

863
00:32:33,039 --> 00:32:34,320
so

864
00:32:34,320 --> 00:32:36,640
for example i have sql server

865
00:32:36,640 --> 00:32:38,640
you have virtual machine in a different

866
00:32:38,640 --> 00:32:40,080
part of the world in a different

867
00:32:40,080 --> 00:32:42,880
subscription but you can bypass my

868
00:32:42,880 --> 00:32:45,840
firewall if if i enable this option if i

869
00:32:45,840 --> 00:32:47,519
enable this setting

870
00:32:47,519 --> 00:32:49,440
so this one's pretty dangerous of course

871
00:32:49,440 --> 00:32:51,039
attacker must know username must not

872
00:32:51,039 --> 00:32:52,799
must know password but if you enable

873
00:32:52,799 --> 00:32:53,840
this

874
00:32:53,840 --> 00:32:56,080
they can bypass firewall if they connect

875
00:32:56,080 --> 00:32:58,000
from any virtual machine that they

876
00:32:58,000 --> 00:32:59,840
deploy in azure they can just create a

877
00:32:59,840 --> 00:33:01,440
trial subscription

878
00:33:01,440 --> 00:33:04,240
and run virtual machine there

879
00:33:04,240 --> 00:33:06,159
so pretty dangerous i would say let's

880
00:33:06,159 --> 00:33:07,279
say no

881
00:33:07,279 --> 00:33:09,519
let's try to check this rule first

882
00:33:09,519 --> 00:33:11,279
if i try to connect from this time i'm

883
00:33:11,279 --> 00:33:13,519
trying to connect from azure machine

884
00:33:13,519 --> 00:33:16,080
and yes i was able to connect

885
00:33:16,080 --> 00:33:16,880
so

886
00:33:16,880 --> 00:33:19,039
let me remove this setting

887
00:33:19,039 --> 00:33:23,240
and let's say i want to

888
00:33:24,080 --> 00:33:26,399
i want to

889
00:33:26,399 --> 00:33:29,519
deny public network access

890
00:33:29,519 --> 00:33:33,039
so this time this time

891
00:33:33,039 --> 00:33:35,600
only access

892
00:33:35,600 --> 00:33:39,200
internal access from virtual network

893
00:33:39,200 --> 00:33:41,039
will be allowed

894
00:33:41,039 --> 00:33:43,519
let's check that i'm going back

895
00:33:43,519 --> 00:33:45,760
here disconnect

896
00:33:45,760 --> 00:33:48,080
connect again

897
00:33:48,080 --> 00:33:50,559
type password

898
00:33:50,559 --> 00:33:52,880
no i can't connect anymore now this this

899
00:33:52,880 --> 00:33:55,600
server is really a backhand

900
00:33:55,600 --> 00:33:57,840
um all right so this this server is

901
00:33:57,840 --> 00:33:58,799
backend

902
00:33:58,799 --> 00:34:00,799
but um

903
00:34:00,799 --> 00:34:03,200
now there's a question which resource

904
00:34:03,200 --> 00:34:05,679
may access the server and the answer is

905
00:34:05,679 --> 00:34:07,600
any sir any resource connected to

906
00:34:07,600 --> 00:34:09,440
virtual network and of course my front

907
00:34:09,440 --> 00:34:10,239
end

908
00:34:10,239 --> 00:34:12,159
uh yeah yeah of course in the real world

909
00:34:12,159 --> 00:34:13,760
may not only be front end but maybe some

910
00:34:13,760 --> 00:34:15,520
middle tiers in my case it's only two

911
00:34:15,520 --> 00:34:18,079
tiers front and back end so in my case

912
00:34:18,079 --> 00:34:19,199
front end

913
00:34:19,199 --> 00:34:20,960
may access

914
00:34:20,960 --> 00:34:23,520
um this back end

915
00:34:23,520 --> 00:34:26,639
so if i if i try to compromise somehow

916
00:34:26,639 --> 00:34:28,320
front-end

917
00:34:28,320 --> 00:34:29,280
i will be

918
00:34:29,280 --> 00:34:31,760
i may maybe just maybe maybe i will be

919
00:34:31,760 --> 00:34:34,239
able to access sql server so let's try

920
00:34:34,239 --> 00:34:37,440
that as usual back to demo

921
00:34:37,440 --> 00:34:39,760
uh let's first show you

922
00:34:39,760 --> 00:34:41,440
the actual front end so that's it's very

923
00:34:41,440 --> 00:34:44,000
simple application just just one pager

924
00:34:44,000 --> 00:34:49,679
um register here and name an email so

925
00:34:49,679 --> 00:34:52,000
let's let's call let's let's give a name

926
00:34:52,000 --> 00:34:53,199
echo

927
00:34:53,199 --> 00:34:55,440
party

928
00:34:55,440 --> 00:34:57,200
and let's say it will be emailed the

929
00:34:57,200 --> 00:35:00,560
echo party at

930
00:35:00,960 --> 00:35:05,280
com argentina.com so let's click submit

931
00:35:06,480 --> 00:35:08,240
and you are registered so your record

932
00:35:08,240 --> 00:35:10,320
was added now

933
00:35:10,320 --> 00:35:12,400
so what i can do if i wanna try to

934
00:35:12,400 --> 00:35:13,920
compromise of course i can try to run

935
00:35:13,920 --> 00:35:15,920
different sql injections and try to get

936
00:35:15,920 --> 00:35:17,200
into

937
00:35:17,200 --> 00:35:18,880
but i but at the same time i have full

938
00:35:18,880 --> 00:35:20,880
application firewall here in the front

939
00:35:20,880 --> 00:35:23,359
so it will be quite hard to do it

940
00:35:23,359 --> 00:35:25,520
another approach

941
00:35:25,520 --> 00:35:27,280
is to

942
00:35:27,280 --> 00:35:29,760
is to to

943
00:35:29,760 --> 00:35:32,960
do the same trick we did with functions

944
00:35:32,960 --> 00:35:37,040
ftp is enabled by default

945
00:35:37,359 --> 00:35:41,920
command wake up so ftp is enabled

946
00:35:41,920 --> 00:35:45,359
so let's repeat the same steps

947
00:35:45,359 --> 00:35:47,440
we did with function

948
00:35:47,440 --> 00:35:49,920
i'm going to extract credentials i mean

949
00:35:49,920 --> 00:35:53,440
ftp url first

950
00:35:54,079 --> 00:35:56,240
url

951
00:35:56,240 --> 00:36:00,959
copy this a new tab

952
00:36:01,839 --> 00:36:06,200
next i'm going to take credentials

953
00:36:12,880 --> 00:36:15,440
um and the password

954
00:36:15,440 --> 00:36:17,760
wow

955
00:36:18,880 --> 00:36:20,320
all right now i was able to connect and

956
00:36:20,320 --> 00:36:23,200
you can see that's just one pager um php

957
00:36:23,200 --> 00:36:26,880
page php page

958
00:36:26,880 --> 00:36:28,720
so

959
00:36:28,720 --> 00:36:31,040
a red team conference probably it's not

960
00:36:31,040 --> 00:36:32,320
surprising

961
00:36:32,320 --> 00:36:34,160
if i can upload

962
00:36:34,160 --> 00:36:36,240
something to application

963
00:36:36,240 --> 00:36:39,359
and this application is based on php or

964
00:36:39,359 --> 00:36:42,960
whatever i can upload my own uh

965
00:36:42,960 --> 00:36:46,240
my own file my own php or specs whatever

966
00:36:46,240 --> 00:36:48,320
not our php

967
00:36:48,320 --> 00:36:50,480
and i can execute commands on the server

968
00:36:50,480 --> 00:36:52,960
side and so i'm gonna upload

969
00:36:52,960 --> 00:36:54,000
shell

970
00:36:54,000 --> 00:36:55,440
web shell

971
00:36:55,440 --> 00:36:59,520
and so what i can do now i can say

972
00:36:59,520 --> 00:37:02,560
my shell.php

973
00:37:02,560 --> 00:37:05,040
look at this

974
00:37:07,760 --> 00:37:09,680
i i'm there

975
00:37:09,680 --> 00:37:12,160
i'm inside of this app service so let me

976
00:37:12,160 --> 00:37:14,079
jump back to just live so now i'm

977
00:37:14,079 --> 00:37:16,560
locally here on web application on the

978
00:37:16,560 --> 00:37:19,599
actual server where this application

979
00:37:19,599 --> 00:37:20,839
is

980
00:37:20,839 --> 00:37:22,800
running so

981
00:37:22,800 --> 00:37:24,079
what i can do

982
00:37:24,079 --> 00:37:25,520
what i want to do i want to connect to

983
00:37:25,520 --> 00:37:27,760
the to the sql server

984
00:37:27,760 --> 00:37:29,440
uh let me check who am i first let's

985
00:37:29,440 --> 00:37:32,800
click id i'm dubbed up data so just just

986
00:37:32,800 --> 00:37:35,440
a low privileged user and i will not be

987
00:37:35,440 --> 00:37:37,280
able to install anything because i don't

988
00:37:37,280 --> 00:37:40,480
have enough permissions for that

989
00:37:40,720 --> 00:37:42,320
all right

990
00:37:42,320 --> 00:37:44,160
what else i can do

991
00:37:44,160 --> 00:37:45,839
uh what if i

992
00:37:45,839 --> 00:37:49,280
uh find a tool that maybe may be used

993
00:37:49,280 --> 00:37:51,200
without installation

994
00:37:51,200 --> 00:37:53,680
so tool to connect to sql without

995
00:37:53,680 --> 00:37:56,480
installation and this tool exists

996
00:37:56,480 --> 00:37:59,200
this tool called usql

997
00:37:59,200 --> 00:38:01,440
is equal you may you may find that in

998
00:38:01,440 --> 00:38:04,560
the um on the web so just on github use

999
00:38:04,560 --> 00:38:06,000
equals so it does not require

1000
00:38:06,000 --> 00:38:08,079
installation but it will not work

1001
00:38:08,079 --> 00:38:10,079
through web shell so let me just

1002
00:38:10,079 --> 00:38:16,280
establish the full netcat shell um

1003
00:38:16,590 --> 00:38:18,720
[Music]

1004
00:38:18,720 --> 00:38:20,720
let me quickly

1005
00:38:20,720 --> 00:38:23,040
establish the file

1006
00:38:23,040 --> 00:38:26,320
um all right now i i have ucl uploaded

1007
00:38:26,320 --> 00:38:27,760
and now i just want to connect real

1008
00:38:27,760 --> 00:38:29,680
quick

1009
00:38:29,680 --> 00:38:31,440
um

1010
00:38:31,440 --> 00:38:35,280
so let's list tables

1011
00:38:36,880 --> 00:38:38,320
and i can see here there's a table

1012
00:38:38,320 --> 00:38:40,800
called registration tbl

1013
00:38:40,800 --> 00:38:43,240
good let's get table

1014
00:38:43,240 --> 00:38:46,079
content um

1015
00:38:46,079 --> 00:38:49,760
and i can see here echo party

1016
00:38:50,720 --> 00:38:52,160
is there

1017
00:38:52,160 --> 00:38:53,200
so

1018
00:38:53,200 --> 00:38:55,280
i was able to

1019
00:38:55,280 --> 00:38:56,400
[Music]

1020
00:38:56,400 --> 00:38:59,280
get access to sql server back-end to

1021
00:38:59,280 --> 00:39:00,720
database

1022
00:39:00,720 --> 00:39:02,640
in a minute in a few different manners

1023
00:39:02,640 --> 00:39:04,160
in few different cases when there's

1024
00:39:04,160 --> 00:39:05,839
allowed public access denied public

1025
00:39:05,839 --> 00:39:08,160
access so

1026
00:39:08,160 --> 00:39:11,879
depends on your configuration

1027
00:39:14,320 --> 00:39:17,920
ways to to get into exists um the last

1028
00:39:17,920 --> 00:39:19,359
one the last last thing that i want to

1029
00:39:19,359 --> 00:39:21,920
mention here is application gateway

1030
00:39:21,920 --> 00:39:24,240
um i think it's quite obvious for you

1031
00:39:24,240 --> 00:39:27,119
that that this this tool exists um the

1032
00:39:27,119 --> 00:39:29,040
only one question can you use them in

1033
00:39:29,040 --> 00:39:30,480
azure and which one will be used in

1034
00:39:30,480 --> 00:39:33,200
azure and so on so generally speaking a

1035
00:39:33,200 --> 00:39:35,280
different wav web application firewalls

1036
00:39:35,280 --> 00:39:36,880
may be used in azure

1037
00:39:36,880 --> 00:39:39,599
and microsoft has built in i mean the

1038
00:39:39,599 --> 00:39:41,359
the service that the you may manage

1039
00:39:41,359 --> 00:39:43,440
service manage buff

1040
00:39:43,440 --> 00:39:46,400
that you may use from microsoft they use

1041
00:39:46,400 --> 00:39:49,599
uh open source uh mod security but their

1042
00:39:49,599 --> 00:39:52,880
rules are pretty fine so

1043
00:39:52,880 --> 00:39:53,839
they're

1044
00:39:53,839 --> 00:39:56,079
let me just quickly show you i i run

1045
00:39:56,079 --> 00:39:58,960
fuzzer against that with waft ninja

1046
00:39:58,960 --> 00:40:00,079
and

1047
00:40:00,079 --> 00:40:02,400
all input that i sent

1048
00:40:02,400 --> 00:40:04,160
did not work so on the right hand side

1049
00:40:04,160 --> 00:40:07,119
you can see there is all red doesn't

1050
00:40:07,119 --> 00:40:09,119
work at all

1051
00:40:09,119 --> 00:40:10,480
um so

1052
00:40:10,480 --> 00:40:13,040
so so so let me jump back to slider to

1053
00:40:13,040 --> 00:40:13,920
slide

1054
00:40:13,920 --> 00:40:14,960
and so

1055
00:40:14,960 --> 00:40:18,079
we saw three scenarios now

1056
00:40:18,079 --> 00:40:21,359
one slide with mitigations i'm not going

1057
00:40:21,359 --> 00:40:22,160
to

1058
00:40:22,160 --> 00:40:24,800
um talk a lot here because that's an

1059
00:40:24,800 --> 00:40:26,800
offensive session but let's just give

1060
00:40:26,800 --> 00:40:29,599
you some advices what you can do to fix

1061
00:40:29,599 --> 00:40:32,000
uh to make your configuration better

1062
00:40:32,000 --> 00:40:33,839
first of all my first attack was

1063
00:40:33,839 --> 00:40:37,440
compromised a deforest account

1064
00:40:37,440 --> 00:40:40,800
here's the idea 84 is like 80 connect

1065
00:40:40,800 --> 00:40:43,520
not vertical but 80 connect must be tier

1066
00:40:43,520 --> 00:40:45,200
0

1067
00:40:45,200 --> 00:40:49,680
tier 0 means it must be accessed by the

1068
00:40:49,680 --> 00:40:52,960
most privileged users only um do not

1069
00:40:52,960 --> 00:40:55,280
allow like because because the logic is

1070
00:40:55,280 --> 00:40:57,200
like at connect is the regular server

1071
00:40:57,200 --> 00:40:59,680
right it's not the main controller so um

1072
00:40:59,680 --> 00:41:02,640
that's why we allow server admin or help

1073
00:41:02,640 --> 00:41:03,920
desk with you

1074
00:41:03,920 --> 00:41:05,119
help desk

1075
00:41:05,119 --> 00:41:07,440
administrators have full access to this

1076
00:41:07,440 --> 00:41:12,319
server no way don't do it tier zero

1077
00:41:12,319 --> 00:41:14,160
uh i'll always try to follow principle

1078
00:41:14,160 --> 00:41:15,760
of this privilege that's that's that's i

1079
00:41:15,760 --> 00:41:18,000
can i can say that in any session in any

1080
00:41:18,000 --> 00:41:18,800
case

1081
00:41:18,800 --> 00:41:21,280
uh and there's one also one tool one

1082
00:41:21,280 --> 00:41:23,440
service called azure ad connect cloud

1083
00:41:23,440 --> 00:41:25,760
sync that's the feature when we have ad

1084
00:41:25,760 --> 00:41:28,079
connect 80 connect like in the cloud so

1085
00:41:28,079 --> 00:41:30,560
sync engine in the cloud it also has

1086
00:41:30,560 --> 00:41:32,880
number of ways it may be compromised in

1087
00:41:32,880 --> 00:41:35,760
similar manner but the biggest benefit

1088
00:41:35,760 --> 00:41:38,240
of 80 kind of cloud sync is this is the

1089
00:41:38,240 --> 00:41:41,440
engine and all configurations as well

1090
00:41:41,440 --> 00:41:42,880
in the cloud

1091
00:41:42,880 --> 00:41:43,760
so

1092
00:41:43,760 --> 00:41:46,079
um

1093
00:41:46,400 --> 00:41:49,359
in that case um smaller amount of

1094
00:41:49,359 --> 00:41:51,359
small number of people may have access

1095
00:41:51,359 --> 00:41:54,240
to these configurations at least

1096
00:41:54,240 --> 00:41:55,440
uh but cloud sync also may be

1097
00:41:55,440 --> 00:41:57,359
compromised and i have a separate

1098
00:41:57,359 --> 00:41:59,839
session about this as well so next one

1099
00:41:59,839 --> 00:42:02,160
stealing cash credentials

1100
00:42:02,160 --> 00:42:03,680
uh cash credentials so that's when i

1101
00:42:03,680 --> 00:42:05,680
when i took token from the machine and

1102
00:42:05,680 --> 00:42:07,280
and reused that

1103
00:42:07,280 --> 00:42:09,680
first of all consider to use separate

1104
00:42:09,680 --> 00:42:11,599
machines for administration so that's

1105
00:42:11,599 --> 00:42:15,280
called paw privilege access workstation

1106
00:42:15,280 --> 00:42:17,440
and have the make this machine

1107
00:42:17,440 --> 00:42:18,880
restricted

1108
00:42:18,880 --> 00:42:21,040
and

1109
00:42:21,520 --> 00:42:23,280
and don't don't use this machine in any

1110
00:42:23,280 --> 00:42:25,280
other cases than other cases than

1111
00:42:25,280 --> 00:42:26,560
administration

1112
00:42:26,560 --> 00:42:28,319
always keep always always try to follow

1113
00:42:28,319 --> 00:42:30,160
pizza police privileges of course even

1114
00:42:30,160 --> 00:42:32,319
so in this in this case even even if

1115
00:42:32,319 --> 00:42:33,920
token was stolen

1116
00:42:33,920 --> 00:42:37,119
um the permission that the the actual

1117
00:42:37,119 --> 00:42:39,119
permissions will be lower than

1118
00:42:39,119 --> 00:42:40,800
privileges will be lower

1119
00:42:40,800 --> 00:42:43,359
and also what what you can do you may

1120
00:42:43,359 --> 00:42:44,640
configure

1121
00:42:44,640 --> 00:42:46,400
token policies

1122
00:42:46,400 --> 00:42:49,680
so token by default not expired it will

1123
00:42:49,680 --> 00:42:51,440
be it will expire only in 90 days of

1124
00:42:51,440 --> 00:42:54,000
inactivity so

1125
00:42:54,000 --> 00:42:56,240
you may think about like like an explo

1126
00:42:56,240 --> 00:42:57,920
but you may you may change that you may

1127
00:42:57,920 --> 00:42:59,760
change that so if

1128
00:42:59,760 --> 00:43:00,800
um

1129
00:43:00,800 --> 00:43:02,960
so that that may be changed also by the

1130
00:43:02,960 --> 00:43:05,440
way you may revoke token manually that's

1131
00:43:05,440 --> 00:43:07,119
the special powerful command the revoked

1132
00:43:07,119 --> 00:43:08,640
token manually

1133
00:43:08,640 --> 00:43:09,760
next one

1134
00:43:09,760 --> 00:43:12,400
iranian commands against virtual machine

1135
00:43:12,400 --> 00:43:14,640
so only one thing you can do here is to

1136
00:43:14,640 --> 00:43:17,040
control permissions uh control

1137
00:43:17,040 --> 00:43:19,359
permissions because if you don't allow

1138
00:43:19,359 --> 00:43:21,280
contributor permissions on the virtual

1139
00:43:21,280 --> 00:43:23,359
machine they will not be um they will

1140
00:43:23,359 --> 00:43:25,200
they will not have permissions to run

1141
00:43:25,200 --> 00:43:27,040
command

1142
00:43:27,040 --> 00:43:28,720
shell upload function modification

1143
00:43:28,720 --> 00:43:31,520
disable ftp you don't need ftp right you

1144
00:43:31,520 --> 00:43:32,800
don't use that

1145
00:43:32,800 --> 00:43:34,319
disable this

1146
00:43:34,319 --> 00:43:36,880
next one with sql server first of all

1147
00:43:36,880 --> 00:43:39,280
make it private

1148
00:43:39,280 --> 00:43:42,079
why do you need to allow public access

1149
00:43:42,079 --> 00:43:43,760
to sql server

1150
00:43:43,760 --> 00:43:45,920
um allow azure services to have a public

1151
00:43:45,920 --> 00:43:46,960
access

1152
00:43:46,960 --> 00:43:48,480
that's not the best practice to be fair

1153
00:43:48,480 --> 00:43:51,200
so try to disable yeah this option is

1154
00:43:51,200 --> 00:43:54,400
quite convenient um but not the most

1155
00:43:54,400 --> 00:43:55,520
secure

1156
00:43:55,520 --> 00:43:57,119
so much better is to use private link

1157
00:43:57,119 --> 00:43:58,560
service which is which make the

1158
00:43:58,560 --> 00:43:59,839
connectivity

1159
00:43:59,839 --> 00:44:01,520
uh private

1160
00:44:01,520 --> 00:44:05,520
and i mean out only through

1161
00:44:05,520 --> 00:44:07,359
virtual network of course it may be

1162
00:44:07,359 --> 00:44:09,359
compromised as well but it's much better

1163
00:44:09,359 --> 00:44:12,160
than make it public and finally web

1164
00:44:12,160 --> 00:44:13,280
attacks

1165
00:44:13,280 --> 00:44:14,160
vaf

1166
00:44:14,160 --> 00:44:16,960
also available to you

1167
00:44:16,960 --> 00:44:19,040
um of course it costs additional money

1168
00:44:19,040 --> 00:44:20,480
by the way if you already have bob that

1169
00:44:20,480 --> 00:44:22,880
you like like barracuda you may use that

1170
00:44:22,880 --> 00:44:24,800
nick in azure as well not not a problem

1171
00:44:24,800 --> 00:44:26,720
at all

1172
00:44:26,720 --> 00:44:28,400
you don't have to use the

1173
00:44:28,400 --> 00:44:30,079
from microsoft

1174
00:44:30,079 --> 00:44:31,839
um all right so

1175
00:44:31,839 --> 00:44:34,720
here um i can finish my session and say

1176
00:44:34,720 --> 00:44:36,720
that um

1177
00:44:36,720 --> 00:44:38,720
in this session i show you three

1178
00:44:38,720 --> 00:44:40,800
different scenarios so first of all

1179
00:44:40,800 --> 00:44:44,240
hybrid id then virtual machines and pass

1180
00:44:44,240 --> 00:44:47,280
they somehow interconnected um

1181
00:44:47,280 --> 00:44:50,400
not fully so they have the so second two

1182
00:44:50,400 --> 00:44:51,920
scenarios they have dependency on the

1183
00:44:51,920 --> 00:44:54,000
first scenario so because in the

1184
00:44:54,000 --> 00:44:55,520
beginning i have some

1185
00:44:55,520 --> 00:44:57,119
level of access to the cloud and then

1186
00:44:57,119 --> 00:45:00,160
after this i was able to do other things

1187
00:45:00,160 --> 00:45:02,640
um but if you wanna if you found

1188
00:45:02,640 --> 00:45:05,440
something that configured in your way in

1189
00:45:05,440 --> 00:45:07,359
a similar manner in your environment in

1190
00:45:07,359 --> 00:45:10,560
a similar similar manner

1191
00:45:11,440 --> 00:45:13,920
maybe it's time to change that would be

1192
00:45:13,920 --> 00:45:16,720
very nice uh of course choice is yours

1193
00:45:16,720 --> 00:45:19,040
but that's that's what i found um in

1194
00:45:19,040 --> 00:45:20,400
different companies and combined

1195
00:45:20,400 --> 00:45:23,040
together so that's all this from from

1196
00:45:23,040 --> 00:45:24,640
reality it's not

1197
00:45:24,640 --> 00:45:25,520
it's

1198
00:45:25,520 --> 00:45:26,800
really companies configure the

1199
00:45:26,800 --> 00:45:28,480
environment like this maybe not all of

1200
00:45:28,480 --> 00:45:30,560
those configurations but some of them

1201
00:45:30,560 --> 00:45:32,000
are constantly see in different

1202
00:45:32,000 --> 00:45:33,359
environments

1203
00:45:33,359 --> 00:45:36,560
if you are pentester red teamer um you

1204
00:45:36,560 --> 00:45:38,240
may find those

1205
00:45:38,240 --> 00:45:40,640
configurations or misconfigurations and

1206
00:45:40,640 --> 00:45:43,920
check if your customer your company um

1207
00:45:43,920 --> 00:45:46,640
has them and tried to

1208
00:45:46,640 --> 00:45:48,560
try to use them as well

1209
00:45:48,560 --> 00:45:50,400
so thank you very much for your

1210
00:45:50,400 --> 00:45:53,520
participation here um

1211
00:45:53,520 --> 00:45:56,000
any questions always appreciate if you

1212
00:45:56,000 --> 00:45:59,760
want to chat with me after this session

1213
00:45:59,760 --> 00:46:02,160
go ahead and find me you know how to do

1214
00:46:02,160 --> 00:46:03,920
it via social network

1215
00:46:03,920 --> 00:46:06,079
so thank you very much and bye bye have

1216
00:46:06,079 --> 00:46:09,880
a good conference as well

