1
00:00:00,030 --> 00:00:04,620
Louie teon Marcille<font color="#CCCCCC"> and he'll be talking</font>

2
00:00:02,790 --> 00:00:14,460
<font color="#CCCCCC">about exploiting</font><font color="#E5E5E5"> caching servers</font><font color="#CCCCCC"> please</font>

3
00:00:04,620 --> 00:00:17,130
welcome to the stage<font color="#CCCCCC"> all right</font>

4
00:00:14,460 --> 00:00:19,740
so hi everyone will come to blackhat<font color="#CCCCCC"> and</font>

5
00:00:17,130 --> 00:00:21,840
thanks<font color="#E5E5E5"> for attending this talk so the</font>

6
00:00:19,740 --> 00:00:23,698
title of<font color="#E5E5E5"> this talk is</font><font color="#CCCCCC"> edges I'll include</font>

7
00:00:21,840 --> 00:00:25,259
injection<font color="#CCCCCC"> amusing caching servers into</font>

8
00:00:23,699 --> 00:00:27,840
server side request forgery and

9
00:00:25,260 --> 00:00:30,060
transparent session hijacking<font color="#CCCCCC"> so that's</font>

10
00:00:27,840 --> 00:00:31,560
a pretty long title it's meant to

11
00:00:30,060 --> 00:00:32,729
mention some of<font color="#E5E5E5"> the many things</font><font color="#CCCCCC"> that</font><font color="#E5E5E5"> you</font>

12
00:00:31,560 --> 00:00:34,980
<font color="#E5E5E5">can do with edge</font><font color="#CCCCCC"> that</font><font color="#E5E5E5"> includes</font>

13
00:00:32,729 --> 00:00:36,360
especially when you're injecting it so

14
00:00:34,980 --> 00:00:38,940
for the<font color="#E5E5E5"> rest of this talk I'll be</font>

15
00:00:36,360 --> 00:00:40,050
<font color="#CCCCCC">referring to</font><font color="#E5E5E5"> ESI when I mean edge table</font>

16
00:00:38,940 --> 00:00:42,718
<font color="#E5E5E5">includes because it's much more</font>

17
00:00:40,050 --> 00:00:45,030
convenient<font color="#E5E5E5"> so during this talk we'll be</font>

18
00:00:42,719 --> 00:00:47,579
talking about ESI and the problem that

19
00:00:45,030 --> 00:00:49,410
<font color="#CCCCCC">it was created</font><font color="#E5E5E5"> to solve we'll talk about</font>

20
00:00:47,579 --> 00:00:51,149
the problem<font color="#CCCCCC"> that it created</font><font color="#E5E5E5"> and how we</font>

21
00:00:49,410 --> 00:00:54,179
can<font color="#CCCCCC"> abuse that and then we'll</font><font color="#E5E5E5"> talk</font>

22
00:00:51,149 --> 00:00:56,460
<font color="#E5E5E5">mitigation and migration so my name is</font>

23
00:00:54,180 --> 00:00:58,739
<font color="#CCCCCC">Louis Jamison</font><font color="#E5E5E5"> I work at go secure in</font>

24
00:00:56,460 --> 00:01:01,079
Montreal and this is where we initially

25
00:00:58,739 --> 00:01:04,048
<font color="#E5E5E5">discovered ESI</font><font color="#CCCCCC"> so to give a bit</font><font color="#E5E5E5"> more</font>

26
00:01:01,079 --> 00:01:07,350
context<font color="#E5E5E5"> ESI is basically a new class of</font>

27
00:01:04,049 --> 00:01:10,110
<font color="#E5E5E5">attacks which is targeting ESI enabled</font>

28
00:01:07,350 --> 00:01:12,500
caching servers so we<font color="#E5E5E5"> discovered this</font>

29
00:01:10,110 --> 00:01:15,420
vulnerability<font color="#CCCCCC"> or this class of attacks</font>

30
00:01:12,500 --> 00:01:18,119
on site a decline so it's actually<font color="#E5E5E5"> my</font>

31
00:01:15,420 --> 00:01:20,460
colleague<font color="#CCCCCC"> the Honda Sonia who was doing</font>

32
00:01:18,119 --> 00:01:22,560
a caching<font color="#E5E5E5"> server configuration review</font>

33
00:01:20,460 --> 00:01:25,320
for one of our largest clients<font color="#CCCCCC"> basically</font>

34
00:01:22,560 --> 00:01:26,610
a large is<font color="#E5E5E5"> be back in Montreal and they</font>

35
00:01:25,320 --> 00:01:28,649
wanted<font color="#E5E5E5"> a security overview of their</font>

36
00:01:26,610 --> 00:01:30,299
caching efforts<font color="#E5E5E5"> so basically every edge</font>

37
00:01:28,650 --> 00:01:31,650
server on their infrastructure<font color="#CCCCCC"> they</font>

38
00:01:30,299 --> 00:01:34,680
wanted<font color="#E5E5E5"> us</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> look at the</font><font color="#CCCCCC"> configuration</font>

39
00:01:31,650 --> 00:01:37,530
<font color="#E5E5E5">and we kept seeing references to edge</font>

40
00:01:34,680 --> 00:01:38,880
<font color="#E5E5E5">side includes now all of our team is</font>

41
00:01:37,530 --> 00:01:40,710
<font color="#E5E5E5">pretty experienced</font><font color="#CCCCCC"> with web app and</font>

42
00:01:38,880 --> 00:01:42,780
<font color="#E5E5E5">testing and security stuff and no one</font>

43
00:01:40,710 --> 00:01:45,960
<font color="#E5E5E5">has ever heard about that so we started</font>

44
00:01:42,780 --> 00:01:48,180
looking<font color="#E5E5E5"> about what is the SI and we</font>

45
00:01:45,960 --> 00:01:50,039
found<font color="#E5E5E5"> the first and last</font>

46
00:01:48,180 --> 00:01:52,470
so the<font color="#E5E5E5"> initial and last specification</font>

47
00:01:50,040 --> 00:01:55,320
for<font color="#CCCCCC"> ESI which dates from</font><font color="#E5E5E5"> 2001 which is</font>

48
00:01:52,470 --> 00:01:58,590
17<font color="#CCCCCC"> years ago and every single</font><font color="#E5E5E5"> vendor</font>

49
00:01:55,320 --> 00:02:02,008
<font color="#CCCCCC">that we analyzed had</font><font color="#E5E5E5"> always some weird</font>

50
00:01:58,590 --> 00:02:03,210
screenshots<font color="#E5E5E5"> predating from when I wasn't</font>

51
00:02:02,009 --> 00:02:04,649
<font color="#CCCCCC">even in high school when someone made</font>

52
00:02:03,210 --> 00:02:06,089
this so you<font color="#CCCCCC"> have word art</font><font color="#E5E5E5"> in</font>

53
00:02:04,649 --> 00:02:07,439
documentation<font color="#E5E5E5"> so</font><font color="#CCCCCC"> we had a pretty bad</font>

54
00:02:06,090 --> 00:02:09,509
<font color="#E5E5E5">feeling</font><font color="#CCCCCC"> because I don't know if you were</font>

55
00:02:07,439 --> 00:02:11,500
<font color="#E5E5E5">doing web development 20 years ago but</font>

56
00:02:09,508 --> 00:02:15,130
<font color="#E5E5E5">security was the least of every</font>

57
00:02:11,500 --> 00:02:16,770
<font color="#E5E5E5">concerned so let's describe</font><font color="#CCCCCC"> yes</font><font color="#E5E5E5"> thought</font>

58
00:02:15,130 --> 00:02:19,269
<font color="#CCCCCC">before talking about exploiting it so</font>

59
00:02:16,770 --> 00:02:21,340
<font color="#E5E5E5">due</font><font color="#CCCCCC"> to a brief</font><font color="#E5E5E5"> overview let's look at a</font>

60
00:02:19,270 --> 00:02:24,280
<font color="#E5E5E5">very primitive</font><font color="#CCCCCC"> webpage example</font><font color="#E5E5E5"> so you</font>

61
00:02:21,340 --> 00:02:27,100
have a weather website<font color="#E5E5E5"> now to the</font>

62
00:02:24,280 --> 00:02:29,620
<font color="#CCCCCC">end-user this is a single HTTP response</font>

63
00:02:27,100 --> 00:02:31,930
<font color="#E5E5E5">there's nothing to it but to the ESI</font>

64
00:02:29,620 --> 00:02:34,660
enabled engine<font color="#E5E5E5"> this might be multiple</font>

65
00:02:31,930 --> 00:02:38,230
<font color="#E5E5E5">fragments now these fragments are there</font>

66
00:02:34,660 --> 00:02:39,940
for<font color="#CCCCCC"> one reason only which is</font><font color="#E5E5E5"> you're able</font>

67
00:02:38,230 --> 00:02:42,250
<font color="#E5E5E5">when you use ESI to invalidate</font>

68
00:02:39,940 --> 00:02:44,980
<font color="#E5E5E5">individual elements of your</font><font color="#CCCCCC"> webpage so</font>

69
00:02:42,250 --> 00:02:46,630
<font color="#E5E5E5">here for example the website</font><font color="#CCCCCC"> has a</font>

70
00:02:44,980 --> 00:02:48,700
graphical interface<font color="#CCCCCC"> so</font><font color="#E5E5E5"> you have the</font>

71
00:02:46,630 --> 00:02:50,290
labels but<font color="#E5E5E5"> when you think about it these</font>

72
00:02:48,700 --> 00:02:52,060
<font color="#E5E5E5">labels don't have to be invalidated</font>

73
00:02:50,290 --> 00:02:54,280
<font color="#E5E5E5">they're not likely to change</font><font color="#CCCCCC"> anytime</font>

74
00:02:52,060 --> 00:02:56,170
<font color="#E5E5E5">soon</font><font color="#CCCCCC"> whereas the actual forecast</font><font color="#E5E5E5"> data</font>

75
00:02:54,280 --> 00:02:58,780
might change within<font color="#E5E5E5"> the hour</font>

76
00:02:56,170 --> 00:03:00,760
so using ESI<font color="#E5E5E5"> you're able to</font><font color="#CCCCCC"> invalidate</font>

77
00:02:58,780 --> 00:03:02,830
the cache entry for subsets of a<font color="#CCCCCC"> webpage</font>

78
00:03:00,760 --> 00:03:04,149
<font color="#CCCCCC">now of</font><font color="#E5E5E5"> course if you leverage ESI</font>

79
00:03:02,830 --> 00:03:05,770
properly you're gonna have a major

80
00:03:04,150 --> 00:03:07,720
<font color="#E5E5E5">increase in</font><font color="#CCCCCC"> performance and</font><font color="#E5E5E5"> of course</font>

81
00:03:05,770 --> 00:03:10,870
you have now the ability to caching<font color="#E5E5E5"> so</font>

82
00:03:07,720 --> 00:03:12,910
it's<font color="#E5E5E5"> pretty good</font><font color="#CCCCCC"> technology however</font>

83
00:03:10,870 --> 00:03:14,770
there has to be a way<font color="#E5E5E5"> for the</font>

84
00:03:12,910 --> 00:03:17,079
application server<font color="#CCCCCC"> to</font><font color="#E5E5E5"> tell the caching</font>

85
00:03:14,770 --> 00:03:19,150
server where individual fragments<font color="#CCCCCC"> begin</font>

86
00:03:17,080 --> 00:03:21,519
and where the end and this<font color="#CCCCCC"> is done</font>

87
00:03:19,150 --> 00:03:23,500
<font color="#CCCCCC">through fragment markers so fragment</font>

88
00:03:21,519 --> 00:03:26,739
markers are basically XML tags which are

89
00:03:23,500 --> 00:03:28,060
prefixed with ESI<font color="#E5E5E5"> now as you can see in</font>

90
00:03:26,739 --> 00:03:30,730
the<font color="#E5E5E5"> middle of the slide you have a</font>

91
00:03:28,060 --> 00:03:32,170
simple ESI tag<font color="#E5E5E5"> so your action would go</font>

92
00:03:30,730 --> 00:03:34,720
after<font color="#E5E5E5"> the column and then you sometimes</font>

93
00:03:32,170 --> 00:03:37,420
<font color="#E5E5E5">have attributes shown in the mix these</font>

94
00:03:34,720 --> 00:03:39,340
tags<font color="#E5E5E5"> are in the HTTP response meaning</font>

95
00:03:37,420 --> 00:03:41,230
that they're gonna be parsed by<font color="#CCCCCC"> the ESI</font>

96
00:03:39,340 --> 00:03:43,810
engine<font color="#E5E5E5"> that is sitting on the caching</font>

97
00:03:41,230 --> 00:03:47,619
server<font color="#E5E5E5"> when this response goes to the</font>

98
00:03:43,810 --> 00:03:49,150
server<font color="#E5E5E5"> so</font><font color="#CCCCCC"> your</font><font color="#E5E5E5"> HCP surrogate which is</font>

99
00:03:47,620 --> 00:03:51,390
your ESI engine it could<font color="#E5E5E5"> be a load</font>

100
00:03:49,150 --> 00:03:53,829
balancer<font color="#E5E5E5"> a proxy</font><font color="#CCCCCC"> or any cache server</font>

101
00:03:51,390 --> 00:03:56,619
will often require that you send

102
00:03:53,829 --> 00:03:59,860
specific HTTP<font color="#CCCCCC"> handlers</font><font color="#E5E5E5"> to say hey I have</font>

103
00:03:56,620 --> 00:04:01,630
ESI tags please parse them<font color="#E5E5E5"> however</font><font color="#CCCCCC"> we</font>

104
00:03:59,860 --> 00:04:03,220
<font color="#E5E5E5">found that if your website is leveraging</font>

105
00:04:01,630 --> 00:04:05,519
<font color="#E5E5E5">es</font><font color="#CCCCCC"> I'll then</font><font color="#E5E5E5"> it's probably enabled</font>

106
00:04:03,220 --> 00:04:08,290
everywhere<font color="#E5E5E5"> so injection is pretty easy</font>

107
00:04:05,519 --> 00:04:09,790
so we'll say two features before<font color="#E5E5E5"> talking</font>

108
00:04:08,290 --> 00:04:12,040
<font color="#E5E5E5">about exploitation just because it's a</font>

109
00:04:09,790 --> 00:04:14,679
bit<font color="#E5E5E5"> obscure right now so the first one</font>

110
00:04:12,040 --> 00:04:16,570
is<font color="#E5E5E5"> ESI includes ESI includes here you</font>

111
00:04:14,680 --> 00:04:17,950
have a very<font color="#E5E5E5"> brief example so you have</font>

112
00:04:16,570 --> 00:04:20,168
two<font color="#E5E5E5"> pages</font><font color="#CCCCCC"> sitting on two</font><font color="#E5E5E5"> different</font>

113
00:04:17,950 --> 00:04:22,479
servers<font color="#E5E5E5"> so you have page</font><font color="#CCCCCC"> one that HTML</font>

114
00:04:20,168 --> 00:04:24,430
and<font color="#E5E5E5"> then page two that HTML you can</font><font color="#CCCCCC"> see</font>

115
00:04:22,479 --> 00:04:24,919
in page<font color="#CCCCCC"> one</font><font color="#E5E5E5"> you have an</font><font color="#CCCCCC"> ESI include</font>

116
00:04:24,430 --> 00:04:27,800
point

117
00:04:24,920 --> 00:04:30,350
<font color="#E5E5E5">to page</font><font color="#CCCCCC"> 2 that</font><font color="#E5E5E5"> HTML now here two things</font>

118
00:04:27,800 --> 00:04:31,610
<font color="#E5E5E5">can</font><font color="#CCCCCC"> happen you can have a cache miss or</font>

119
00:04:30,350 --> 00:04:34,310
you can have a cache<font color="#CCCCCC"> hit</font>

120
00:04:31,610 --> 00:04:37,070
so if page<font color="#CCCCCC"> two is already known</font><font color="#E5E5E5"> to the</font>

121
00:04:34,310 --> 00:04:39,140
<font color="#CCCCCC">est engine it's just going</font><font color="#E5E5E5"> to replace</font><font color="#CCCCCC"> it</font>

122
00:04:37,070 --> 00:04:40,880
as is<font color="#E5E5E5"> by filling the blank</font><font color="#CCCCCC"> so it's</font><font color="#E5E5E5"> gonna</font>

123
00:04:39,140 --> 00:04:42,800
remove the<font color="#E5E5E5"> ESI inclu tag and it's gonna</font>

124
00:04:40,880 --> 00:04:45,020
replace it<font color="#E5E5E5"> with the entry of the cache</font>

125
00:04:42,800 --> 00:04:47,300
the cache entry for page<font color="#CCCCCC"> two</font><font color="#E5E5E5"> if it's a</font>

126
00:04:45,020 --> 00:04:49,520
cache miss meaning the content of page

127
00:04:47,300 --> 00:04:52,010
<font color="#E5E5E5">two is invalid or if the caching servers</font>

128
00:04:49,520 --> 00:04:54,919
never seen that<font color="#E5E5E5"> file it's gonna request</font>

129
00:04:52,010 --> 00:04:57,020
this file<font color="#E5E5E5"> it's gonna gonna do a get</font>

130
00:04:54,920 --> 00:04:59,060
request on slash API slash

131
00:04:57,020 --> 00:05:00,680
page<font color="#E5E5E5"> two of HTML so when you request</font>

132
00:04:59,060 --> 00:05:02,690
page<font color="#CCCCCC"> one</font><font color="#E5E5E5"> either way you're gonna have</font>

133
00:05:00,680 --> 00:05:04,550
<font color="#E5E5E5">the content of page two</font><font color="#CCCCCC"> and the HTTP</font>

134
00:05:02,690 --> 00:05:06,650
response<font color="#E5E5E5"> now to illustrate</font><font color="#CCCCCC"> how</font><font color="#E5E5E5"> this</font>

135
00:05:04,550 --> 00:05:07,760
works<font color="#CCCCCC"> let's look</font><font color="#E5E5E5"> at a very brief diagram</font>

136
00:05:06,650 --> 00:05:09,440
so<font color="#E5E5E5"> you have your clients your load</font>

137
00:05:07,760 --> 00:05:13,250
balancers and<font color="#E5E5E5"> your application servers</font>

138
00:05:09,440 --> 00:05:15,230
so your clients is<font color="#CCCCCC"> gonna send one that</font>

139
00:05:13,250 --> 00:05:17,690
HTML and the caching server since we're

140
00:05:15,230 --> 00:05:19,640
looking<font color="#CCCCCC"> at a cache miss is gonna send</font>

141
00:05:17,690 --> 00:05:21,170
<font color="#E5E5E5">their requests upstream now the</font>

142
00:05:19,640 --> 00:05:23,810
application<font color="#CCCCCC"> server is gonna respond with</font>

143
00:05:21,170 --> 00:05:27,110
<font color="#E5E5E5">a ESI tag and the HTTP response the</font>

144
00:05:23,810 --> 00:05:29,750
application server<font color="#E5E5E5"> since it's an issue</font>

145
00:05:27,110 --> 00:05:31,640
since<font color="#CCCCCC"> the ESI tags are in</font><font color="#E5E5E5"> the HTTP</font>

146
00:05:29,750 --> 00:05:33,650
response<font color="#E5E5E5"> the load balancer knows to</font>

147
00:05:31,640 --> 00:05:36,320
parse them and the side<font color="#CCCCCC"> requests for</font>

148
00:05:33,650 --> 00:05:39,409
<font color="#E5E5E5">page two</font><font color="#CCCCCC"> is sent to the API server now</font>

149
00:05:36,320 --> 00:05:41,060
API response<font color="#E5E5E5"> now step five and three can</font>

150
00:05:39,410 --> 00:05:43,580
be<font color="#E5E5E5"> concatenated together before sending</font>

151
00:05:41,060 --> 00:05:45,230
it back to<font color="#CCCCCC"> the client</font><font color="#E5E5E5"> so this is ESI</font>

152
00:05:43,580 --> 00:05:46,430
<font color="#E5E5E5">foods now let's</font><font color="#CCCCCC"> look at our second</font>

153
00:05:45,230 --> 00:05:49,340
features<font color="#E5E5E5"> before delving into</font>

154
00:05:46,430 --> 00:05:51,230
exploitation<font color="#E5E5E5"> you have ESI variables so</font>

155
00:05:49,340 --> 00:05:53,359
ESI variables are also pretty<font color="#E5E5E5"> easy to</font>

156
00:05:51,230 --> 00:05:56,420
understand they're basically attribute

157
00:05:53,360 --> 00:05:58,520
less ESI tags which will allow you<font color="#E5E5E5"> to</font>

158
00:05:56,420 --> 00:06:01,100
expand<font color="#E5E5E5"> information about the current</font>

159
00:05:58,520 --> 00:06:03,710
metadata of<font color="#CCCCCC"> the HTTP transaction so you</font>

160
00:06:01,100 --> 00:06:06,470
usually<font color="#CCCCCC"> have these sort of variables we</font>

161
00:06:03,710 --> 00:06:09,289
have access<font color="#E5E5E5"> to</font><font color="#CCCCCC"> HTTP user agent the query</font>

162
00:06:06,470 --> 00:06:11,090
string the cookies and basically this<font color="#E5E5E5"> is</font>

163
00:06:09,290 --> 00:06:12,740
<font color="#E5E5E5">going to give you access to all</font><font color="#CCCCCC"> of the</font>

164
00:06:11,090 --> 00:06:14,869
metadata in order to take decisions on

165
00:06:12,740 --> 00:06:17,750
<font color="#CCCCCC">your caching efforts so for example if</font>

166
00:06:14,870 --> 00:06:20,270
you have a<font color="#E5E5E5"> cookie for which the name is</font>

167
00:06:17,750 --> 00:06:22,220
language and its value<font color="#CCCCCC"> is</font><font color="#E5E5E5"> French</font><font color="#CCCCCC"> then</font>

168
00:06:20,270 --> 00:06:24,200
you should probably do a<font color="#CCCCCC"> es I include of</font>

169
00:06:22,220 --> 00:06:26,900
the<font color="#E5E5E5"> French level of your organization</font><font color="#CCCCCC"> so</font>

170
00:06:24,200 --> 00:06:29,330
that's<font color="#E5E5E5"> just</font><font color="#CCCCCC"> bravery for example</font><font color="#E5E5E5"> so with</font>

171
00:06:26,900 --> 00:06:32,030
this knowledge we<font color="#CCCCCC"> can start seeing where</font>

172
00:06:29,330 --> 00:06:33,770
the<font color="#E5E5E5"> Bolar vulnerability is lie so we</font>

173
00:06:32,030 --> 00:06:35,450
know two<font color="#E5E5E5"> things right now we know that</font>

174
00:06:33,770 --> 00:06:37,830
<font color="#E5E5E5">ESI tags are</font><font color="#CCCCCC"> sent by the application</font>

175
00:06:35,450 --> 00:06:40,349
server<font color="#CCCCCC"> we also know that they're sent</font>

176
00:06:37,830 --> 00:06:41,909
through the<font color="#E5E5E5"> HTTP surrogate and that</font><font color="#CCCCCC"> this</font>

177
00:06:40,349 --> 00:06:44,400
<font color="#E5E5E5">surrogate is going to parse those and</font>

178
00:06:41,910 --> 00:06:46,020
this leaves us with<font color="#CCCCCC"> a very</font><font color="#E5E5E5"> interesting</font>

179
00:06:44,400 --> 00:06:48,568
and dangerous<font color="#E5E5E5"> question which is how can</font>

180
00:06:46,020 --> 00:06:50,099
<font color="#CCCCCC">the esight</font><font color="#E5E5E5"> engine tell which tags are</font>

181
00:06:48,569 --> 00:06:52,530
legitimate<font color="#E5E5E5"> and which tags are being</font>

182
00:06:50,099 --> 00:06:54,300
injected<font color="#E5E5E5"> by a malicious user just like</font>

183
00:06:52,530 --> 00:06:56,940
cross-site scripting and that's<font color="#CCCCCC"> a</font>

184
00:06:54,300 --> 00:06:59,250
<font color="#E5E5E5">problem</font><font color="#CCCCCC"> it can't and that's a pretty</font><font color="#E5E5E5"> big</font>

185
00:06:56,940 --> 00:07:01,860
design<font color="#E5E5E5"> flaw so if you think about ESI</font>

186
00:06:59,250 --> 00:07:03,360
injection this<font color="#E5E5E5"> snippet is vulnerable</font><font color="#CCCCCC"> to</font>

187
00:07:01,860 --> 00:07:05,250
it because everything<font color="#CCCCCC"> that</font><font color="#E5E5E5"> is in the</font>

188
00:07:03,360 --> 00:07:08,550
city get parameter<font color="#CCCCCC"> gets added to the</font>

189
00:07:05,250 --> 00:07:10,590
HTTP response<font color="#E5E5E5"> so if someone puts ESI</font>

190
00:07:08,550 --> 00:07:11,580
variable pointing to the HTTP<font color="#CCCCCC"> cookie</font>

191
00:07:10,590 --> 00:07:14,489
session ID

192
00:07:11,580 --> 00:07:16,139
well the HTTP<font color="#E5E5E5"> surrogate is going to look</font>

193
00:07:14,490 --> 00:07:18,930
at this<font color="#E5E5E5"> and expand it and you're</font><font color="#CCCCCC"> gonna</font>

194
00:07:16,139 --> 00:07:20,580
<font color="#E5E5E5">get</font><font color="#CCCCCC"> that rated that answer back that's</font>

195
00:07:18,930 --> 00:07:22,940
pretty dangerous<font color="#E5E5E5"> considering that PHP</font>

196
00:07:20,580 --> 00:07:26,520
session ID<font color="#E5E5E5"> if you've done any PHP</font><font color="#CCCCCC"> is</font>

197
00:07:22,940 --> 00:07:30,240
HTTP only cooking meaning you can

198
00:07:26,520 --> 00:07:31,650
probably do session theft<font color="#E5E5E5"> so to do that</font>

199
00:07:30,240 --> 00:07:34,650
we'll look at<font color="#CCCCCC"> our</font><font color="#E5E5E5"> first ESI</font>

200
00:07:31,650 --> 00:07:36,659
implementation<font color="#CCCCCC"> Apache traffic server so</font>

201
00:07:34,650 --> 00:07:37,520
<font color="#E5E5E5">I looked at</font><font color="#CCCCCC"> Apache traffic server for</font>

202
00:07:36,659 --> 00:07:39,479
two reasons

203
00:07:37,520 --> 00:07:41,159
<font color="#CCCCCC">first</font><font color="#E5E5E5"> of all because it's used by</font>

204
00:07:39,479 --> 00:07:43,289
high-profile organizations<font color="#CCCCCC"> so that's</font>

205
00:07:41,159 --> 00:07:45,599
always a<font color="#E5E5E5"> plus so I know for</font><font color="#CCCCCC"> a</font><font color="#E5E5E5"> fact that</font>

206
00:07:43,289 --> 00:07:48,150
<font color="#E5E5E5">yeah we'll use it</font><font color="#CCCCCC"> and show them</font><font color="#E5E5E5"> also</font>

207
00:07:45,599 --> 00:07:51,979
talked about<font color="#CCCCCC"> Apple</font><font color="#E5E5E5"> and Comcast that's</font>

208
00:07:48,150 --> 00:07:54,960
yet to<font color="#CCCCCC"> be confirmed</font><font color="#E5E5E5"> so I looked also at</font>

209
00:07:51,979 --> 00:07:57,599
<font color="#CCCCCC">80s</font><font color="#E5E5E5"> for another reason which</font><font color="#CCCCCC"> is they</font>

210
00:07:54,960 --> 00:08:00,180
<font color="#E5E5E5">added all of the ESI specification and</font>

211
00:07:57,599 --> 00:08:02,159
the added<font color="#CCCCCC"> bonus features some</font><font color="#E5E5E5"> of her</font>

212
00:08:00,180 --> 00:08:04,020
interesting and one of it one<font color="#E5E5E5"> of the</font>

213
00:08:02,159 --> 00:08:06,539
feature is cookie<font color="#CCCCCC"> whitelisting which</font>

214
00:08:04,020 --> 00:08:08,639
might sound like a great<font color="#CCCCCC"> idea because</font><font color="#E5E5E5"> if</font>

215
00:08:06,539 --> 00:08:10,590
you have ESI injection<font color="#CCCCCC"> you can just</font>

216
00:08:08,639 --> 00:08:13,259
refer<font color="#CCCCCC"> to the</font><font color="#E5E5E5"> PHP session I mean it's</font>

217
00:08:10,590 --> 00:08:14,638
going<font color="#E5E5E5"> to return nothing</font><font color="#CCCCCC"> however by</font>

218
00:08:13,259 --> 00:08:16,169
looking at the documentation<font color="#E5E5E5"> you'll also</font>

219
00:08:14,639 --> 00:08:19,530
see that<font color="#E5E5E5"> there's a new variable called</font>

220
00:08:16,169 --> 00:08:22,198
<font color="#E5E5E5">HTTP header which allows you</font><font color="#CCCCCC"> to refer to</font>

221
00:08:19,530 --> 00:08:23,940
the HTTP header cookie<font color="#E5E5E5"> meaning</font><font color="#CCCCCC"> that you</font>

222
00:08:22,199 --> 00:08:25,289
can effectively bypass they quickly

223
00:08:23,940 --> 00:08:29,009
<font color="#E5E5E5">whitelist thing altogether</font>

224
00:08:25,289 --> 00:08:31,020
so that's a pretty<font color="#E5E5E5"> big</font><font color="#CCCCCC"> oversight so that</font>

225
00:08:29,009 --> 00:08:33,360
was report and fix two<font color="#E5E5E5"> months ago</font><font color="#CCCCCC"> and it</font>

226
00:08:31,020 --> 00:08:35,838
basically allows<font color="#E5E5E5"> you</font><font color="#CCCCCC"> to do the SI</font>

227
00:08:33,360 --> 00:08:38,399
<font color="#E5E5E5">injection leveraging could</font><font color="#CCCCCC"> keep</font>

228
00:08:35,839 --> 00:08:40,110
basically<font color="#E5E5E5"> stealing cookies</font><font color="#CCCCCC"> so for</font><font color="#E5E5E5"> that</font>

229
00:08:38,399 --> 00:08:43,380
let's do a proof of concept with<font color="#CCCCCC"> Apache</font>

230
00:08:40,110 --> 00:08:44,970
traffic server so I built the following

231
00:08:43,380 --> 00:08:46,650
payload however you can<font color="#CCCCCC"> use multiple</font>

232
00:08:44,970 --> 00:08:48,660
pills they're all<font color="#E5E5E5"> going to work so I</font>

233
00:08:46,650 --> 00:08:50,560
built an image<font color="#E5E5E5"> tag that is pointing to</font>

234
00:08:48,660 --> 00:08:53,499
my attacker<font color="#CCCCCC"> enable server so</font><font color="#E5E5E5"> a</font>

235
00:08:50,560 --> 00:08:54,939
local for which the<font color="#CCCCCC"> filename that</font><font color="#E5E5E5"> is</font>

236
00:08:53,499 --> 00:08:57,699
going to be requested<font color="#E5E5E5"> by the</font><font color="#CCCCCC"> victim's</font>

237
00:08:54,939 --> 00:09:00,009
browser<font color="#E5E5E5"> is</font><font color="#CCCCCC"> an ESI tag this tag of course</font>

238
00:08:57,699 --> 00:09:02,800
is basically<font color="#E5E5E5"> going to</font><font color="#CCCCCC"> reference to the</font>

239
00:09:00,009 --> 00:09:04,509
victims cookies<font color="#E5E5E5"> now once this tag is</font>

240
00:09:02,800 --> 00:09:06,579
sent by the<font color="#E5E5E5"> application server to the</font>

241
00:09:04,509 --> 00:09:08,139
<font color="#E5E5E5">traffic server the traffic server is</font>

242
00:09:06,579 --> 00:09:10,359
<font color="#CCCCCC">going to expand it to</font><font color="#E5E5E5"> the user session</font>

243
00:09:08,139 --> 00:09:12,550
cookie<font color="#E5E5E5"> and so the browser is</font><font color="#CCCCCC"> gonna</font>

244
00:09:10,360 --> 00:09:15,730
request this file<font color="#E5E5E5"> thinking an image is</font>

245
00:09:12,550 --> 00:09:17,589
sitting there<font color="#E5E5E5"> so let's look at our</font><font color="#CCCCCC"> first</font>

246
00:09:15,730 --> 00:09:22,240
demonstration<font color="#CCCCCC"> so about the videos</font><font color="#E5E5E5"> it's</font>

247
00:09:17,589 --> 00:09:24,970
safer so we have a very<font color="#E5E5E5"> basic website</font>

248
00:09:22,240 --> 00:09:26,529
<font color="#CCCCCC">that I built</font><font color="#E5E5E5"> you</font><font color="#CCCCCC"> have two browsers</font><font color="#E5E5E5"> so on</font>

249
00:09:24,970 --> 00:09:27,790
the<font color="#E5E5E5"> left hand side you</font><font color="#CCCCCC"> have your victim</font>

250
00:09:26,529 --> 00:09:30,279
on<font color="#E5E5E5"> the right hand side you have the</font>

251
00:09:27,790 --> 00:09:32,050
<font color="#E5E5E5">attacker</font><font color="#CCCCCC"> in the middle you have</font><font color="#E5E5E5"> all of</font>

252
00:09:30,279 --> 00:09:33,759
the database content for the messages

253
00:09:32,050 --> 00:09:35,079
because<font color="#E5E5E5"> it's a message board so you can</font>

254
00:09:33,759 --> 00:09:37,209
<font color="#E5E5E5">see what the data looks before</font>

255
00:09:35,079 --> 00:09:39,579
transiting through the cache server on

256
00:09:37,209 --> 00:09:41,290
the bottom side<font color="#CCCCCC"> you have evil the local</font>

257
00:09:39,579 --> 00:09:44,319
so basically<font color="#E5E5E5"> all</font><font color="#CCCCCC"> of the get requests are</font>

258
00:09:41,290 --> 00:09:45,879
<font color="#CCCCCC">gonna be printed there so now our</font><font color="#E5E5E5"> victim</font>

259
00:09:44,319 --> 00:09:49,689
is gonna use the<font color="#E5E5E5"> website just</font><font color="#CCCCCC"> to show</font><font color="#E5E5E5"> it</font>

260
00:09:45,879 --> 00:09:53,110
looks the victim<font color="#CCCCCC"> sent message now the</font>

261
00:09:49,689 --> 00:09:56,319
attacker is gonna put the payload that

262
00:09:53,110 --> 00:09:58,990
<font color="#E5E5E5">we just looked at so basically our image</font>

263
00:09:56,319 --> 00:10:00,969
tag that<font color="#E5E5E5"> is pointing to evil the local</font>

264
00:09:58,990 --> 00:10:04,329
for which the file name is gonna<font color="#E5E5E5"> be</font>

265
00:10:00,970 --> 00:10:07,870
anyone's<font color="#E5E5E5"> session cookie so we refer</font><font color="#CCCCCC"> to</font>

266
00:10:04,329 --> 00:10:13,329
the HTTP header cookie and we send the

267
00:10:07,870 --> 00:10:15,309
payload<font color="#E5E5E5"> and you can see and the database</font>

268
00:10:13,329 --> 00:10:16,420
wants<font color="#CCCCCC"> it sent</font><font color="#E5E5E5"> you have the ESI variable</font>

269
00:10:15,309 --> 00:10:19,269
that is going to be stored<font color="#E5E5E5"> in the</font>

270
00:10:16,420 --> 00:10:20,800
<font color="#E5E5E5">database as expected now by sending the</font>

271
00:10:19,269 --> 00:10:22,360
payload<font color="#E5E5E5"> the attacker effectively</font>

272
00:10:20,800 --> 00:10:25,089
attacked themselves so we're gonna

273
00:10:22,360 --> 00:10:27,819
receive<font color="#CCCCCC"> a CPA</font><font color="#E5E5E5"> request right here with</font>

274
00:10:25,089 --> 00:10:30,100
<font color="#E5E5E5">our own session cookie now we're gonna</font>

275
00:10:27,819 --> 00:10:35,709
wait<font color="#CCCCCC"> for</font><font color="#E5E5E5"> the victim</font><font color="#CCCCCC"> to refresh the</font><font color="#E5E5E5"> page</font>

276
00:10:30,100 --> 00:10:39,429
<font color="#E5E5E5">so that they attack themselves and we're</font>

277
00:10:35,709 --> 00:10:41,199
gonna get a response<font color="#CCCCCC"> back</font><font color="#E5E5E5"> so now we have</font>

278
00:10:39,429 --> 00:10:43,209
the<font color="#E5E5E5"> session cookie for the victim and</font>

279
00:10:41,199 --> 00:10:44,740
we're able to take<font color="#E5E5E5"> over their session so</font>

280
00:10:43,209 --> 00:10:46,719
we're gonna look<font color="#E5E5E5"> at all of our cookies</font>

281
00:10:44,740 --> 00:10:48,550
right now and we confirm that<font color="#E5E5E5"> session</font>

282
00:10:46,720 --> 00:10:49,929
<font color="#E5E5E5">cookie is HTTP only meaning that</font>

283
00:10:48,550 --> 00:10:53,258
<font color="#CCCCCC">javascript could not have accessed that</font>

284
00:10:49,929 --> 00:10:57,459
cookie we're gonna replace our own value

285
00:10:53,259 --> 00:11:04,329
with the one that<font color="#E5E5E5"> we</font><font color="#CCCCCC"> just stole we're</font>

286
00:10:57,459 --> 00:11:06,160
gonna save and refresh and<font color="#CCCCCC"> there you go</font>

287
00:11:04,329 --> 00:11:11,618
we just did<font color="#CCCCCC"> JavaScript last session</font>

288
00:11:06,160 --> 00:11:16,629
hijacking<font color="#E5E5E5"> using ESI injection okay</font><font color="#CCCCCC"> let's</font>

289
00:11:11,619 --> 00:11:18,160
just go<font color="#E5E5E5"> back here okay so yeah so we now</font>

290
00:11:16,629 --> 00:11:20,019
<font color="#E5E5E5">we can now</font><font color="#CCCCCC"> we know we can inject ESI</font>

291
00:11:18,160 --> 00:11:22,420
tags we can<font color="#CCCCCC"> leak HTTP only cookies and</font>

292
00:11:20,019 --> 00:11:25,720
we don't even need<font color="#CCCCCC"> JavaScript</font><font color="#E5E5E5"> but just</font>

293
00:11:22,420 --> 00:11:27,790
like XSS it's a bit<font color="#E5E5E5"> boring because well</font>

294
00:11:25,720 --> 00:11:30,369
we have to wait<font color="#E5E5E5"> until the victim reaches</font>

295
00:11:27,790 --> 00:11:32,319
a<font color="#E5E5E5"> very specific</font><font color="#CCCCCC"> webpage</font><font color="#E5E5E5"> for</font><font color="#CCCCCC"> example if</font>

296
00:11:30,369 --> 00:11:34,299
you<font color="#E5E5E5"> find an XSS on an obscure web pages</font>

297
00:11:32,319 --> 00:11:36,670
which<font color="#E5E5E5"> is a feature</font><font color="#CCCCCC"> that no one uses well</font>

298
00:11:34,299 --> 00:11:39,459
you can't exactly leverage this so let's

299
00:11:36,670 --> 00:11:41,349
try to<font color="#CCCCCC"> crack the impact up a notch</font><font color="#E5E5E5"> so</font>

300
00:11:39,459 --> 00:11:44,498
the second feature that<font color="#CCCCCC"> I looked at is</font>

301
00:11:41,350 --> 00:11:46,709
<font color="#E5E5E5">our cold web cache</font><font color="#CCCCCC"> or Club cache is also</font>

302
00:11:44,499 --> 00:11:49,119
a<font color="#E5E5E5"> high profile target</font><font color="#CCCCCC"> to me</font><font color="#E5E5E5"> Oracle and</font>

303
00:11:46,709 --> 00:11:52,089
they also<font color="#E5E5E5"> implemented bonus features</font>

304
00:11:49,119 --> 00:11:54,309
some of<font color="#CCCCCC"> which are singly dangerous so</font>

305
00:11:52,089 --> 00:11:56,529
the first one that<font color="#CCCCCC"> I am</font><font color="#E5E5E5"> that was</font>

306
00:11:54,309 --> 00:11:59,439
interested<font color="#CCCCCC"> in interested in is the ESI</font>

307
00:11:56,529 --> 00:12:01,749
<font color="#CCCCCC">online time the e-sign line tag allows</font>

308
00:11:59,439 --> 00:12:04,059
you to take an arbitrary cache entry and

309
00:12:01,749 --> 00:12:07,959
replace its content<font color="#E5E5E5"> what could go wrong</font>

310
00:12:04,059 --> 00:12:09,699
<font color="#E5E5E5">so here you have jQuery the</font><font color="#CCCCCC"> jas that is</font>

311
00:12:07,959 --> 00:12:11,979
going to be sent<font color="#E5E5E5"> in</font><font color="#CCCCCC"> the ESI online tag</font>

312
00:12:09,699 --> 00:12:13,660
and the content of<font color="#E5E5E5"> the tags is the</font>

313
00:12:11,980 --> 00:12:15,610
content that<font color="#E5E5E5"> you want</font><font color="#CCCCCC"> inside of that</font>

314
00:12:13,660 --> 00:12:17,319
<font color="#E5E5E5">entry so here two things are gonna</font>

315
00:12:15,610 --> 00:12:19,360
<font color="#E5E5E5">happen right so</font><font color="#CCCCCC"> you have jquery.js</font>

316
00:12:17,319 --> 00:12:20,919
<font color="#E5E5E5">it's gonna get overwritten with the</font>

317
00:12:19,360 --> 00:12:22,419
content here<font color="#E5E5E5"> and as you can</font><font color="#CCCCCC"> see the</font>

318
00:12:20,919 --> 00:12:23,230
<font color="#E5E5E5">highlighted payload is basically</font><font color="#CCCCCC"> just an</font>

319
00:12:22,419 --> 00:12:26,019
ajax<font color="#E5E5E5"> request</font>

320
00:12:23,230 --> 00:12:28,360
so an a synchronous get request<font color="#E5E5E5"> to my</font>

321
00:12:26,019 --> 00:12:29,649
server which is<font color="#CCCCCC"> able</font><font color="#E5E5E5"> to local and then</font>

322
00:12:28,360 --> 00:12:31,509
the second thing<font color="#E5E5E5"> that's gonna happen is</font>

323
00:12:29,649 --> 00:12:33,879
<font color="#E5E5E5">that every time someone requests a query</font>

324
00:12:31,509 --> 00:12:35,919
that<font color="#CCCCCC"> j/s this ESI variable is going</font><font color="#E5E5E5"> to</font>

325
00:12:33,879 --> 00:12:38,439
<font color="#E5E5E5">be</font><font color="#CCCCCC"> expended which is</font><font color="#E5E5E5"> going to be sending</font>

326
00:12:35,919 --> 00:12:40,899
their<font color="#CCCCCC"> own session cookie now we don't</font>

327
00:12:38,439 --> 00:12:43,149
have any white listing on this vendor so

328
00:12:40,899 --> 00:12:45,489
don't have<font color="#E5E5E5"> to find any tricks to refer</font>

329
00:12:43,149 --> 00:12:47,559
<font color="#CCCCCC">to the cookie</font><font color="#E5E5E5"> so this is gonna be</font><font color="#CCCCCC"> the</font>

330
00:12:45,489 --> 00:12:50,499
URL<font color="#CCCCCC"> that</font><font color="#E5E5E5"> every single browser using</font>

331
00:12:47,559 --> 00:12:52,749
their<font color="#CCCCCC"> website is gonna</font><font color="#E5E5E5"> send me this is</font>

332
00:12:50,499 --> 00:12:54,790
their session cookie which is HTTP only

333
00:12:52,749 --> 00:12:57,579
once again<font color="#E5E5E5"> so let's look at our</font>

334
00:12:54,790 --> 00:12:59,618
demonstration<font color="#E5E5E5"> so we basically have the</font>

335
00:12:57,579 --> 00:13:03,758
<font color="#CCCCCC">same</font><font color="#E5E5E5"> website</font><font color="#CCCCCC"> right but now it's super</font>

336
00:12:59,619 --> 00:13:07,059
safe<font color="#E5E5E5"> because the system in added HTML</font>

337
00:13:03,759 --> 00:13:09,199
encoding and since it's<font color="#E5E5E5"> the same sites</font>

338
00:13:07,059 --> 00:13:12,139
are the same<font color="#E5E5E5"> char set the</font>

339
00:13:09,199 --> 00:13:14,959
ESI<font color="#E5E5E5"> is no longer</font><font color="#CCCCCC"> violent</font><font color="#E5E5E5"> now you can see</font>

340
00:13:12,139 --> 00:13:16,699
in the<font color="#CCCCCC"> Dom</font><font color="#E5E5E5"> we also have jquery.js that</font>

341
00:13:14,959 --> 00:13:18,589
is being requested<font color="#E5E5E5"> on every</font><font color="#CCCCCC"> single page</font>

342
00:13:16,699 --> 00:13:20,389
<font color="#E5E5E5">meaning that if I'm able</font><font color="#CCCCCC"> to replace this</font>

343
00:13:18,589 --> 00:13:22,879
file<font color="#E5E5E5"> I'm going</font><font color="#CCCCCC"> to attack every single</font>

344
00:13:20,389 --> 00:13:25,459
user of the website<font color="#CCCCCC"> so</font><font color="#E5E5E5"> jQuery is working</font>

345
00:13:22,879 --> 00:13:28,660
fine<font color="#CCCCCC"> now our attacker is going to</font><font color="#E5E5E5"> look</font>

346
00:13:25,459 --> 00:13:31,219
to<font color="#E5E5E5"> see</font><font color="#CCCCCC"> if the HTML char set is available</font>

347
00:13:28,660 --> 00:13:34,969
<font color="#E5E5E5">notice is that now their</font><font color="#CCCCCC"> HTML encoding</font>

348
00:13:31,220 --> 00:13:36,410
so they basically mitigated<font color="#CCCCCC"> es I now our</font>

349
00:13:34,970 --> 00:13:38,959
user is going to<font color="#E5E5E5"> see</font><font color="#CCCCCC"> that there's a new</font>

350
00:13:36,410 --> 00:13:40,939
feature<font color="#CCCCCC"> called the user list</font><font color="#E5E5E5"> so the user</font>

351
00:13:38,959 --> 00:13:42,858
list has a search feature for which

352
00:13:40,939 --> 00:13:45,679
everything that is put into the search

353
00:13:42,859 --> 00:13:47,299
is echoed<font color="#E5E5E5"> in</font><font color="#CCCCCC"> the HTTP response so that</font>

354
00:13:45,679 --> 00:13:48,350
could<font color="#CCCCCC"> be a good vector for</font><font color="#E5E5E5"> ESI injection</font>

355
00:13:47,299 --> 00:13:50,559
because<font color="#CCCCCC"> it's going</font><font color="#E5E5E5"> to go through the</font>

356
00:13:48,350 --> 00:13:53,149
caching server so we're gonna test for

357
00:13:50,559 --> 00:13:54,980
<font color="#E5E5E5">HTML entities and they're not escape</font><font color="#CCCCCC"> so</font>

358
00:13:53,149 --> 00:13:55,910
that's<font color="#E5E5E5"> pretty a pretty good example</font><font color="#CCCCCC"> of</font>

359
00:13:54,980 --> 00:13:58,399
where I<font color="#E5E5E5"> can do</font>

360
00:13:55,910 --> 00:13:59,809
<font color="#E5E5E5">ESI</font><font color="#CCCCCC"> injection so we're gonna take</font><font color="#E5E5E5"> our</font>

361
00:13:58,399 --> 00:14:02,059
<font color="#E5E5E5">payload which is the same one</font><font color="#CCCCCC"> that we</font>

362
00:13:59,809 --> 00:14:04,608
<font color="#CCCCCC">just looked</font><font color="#E5E5E5"> at so jQuery digest is gonna</font>

363
00:14:02,059 --> 00:14:07,730
be overwritten<font color="#E5E5E5"> we put it there</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> then</font>

364
00:14:04,609 --> 00:14:09,619
<font color="#CCCCCC">we press submit and it should be good</font>

365
00:14:07,730 --> 00:14:11,389
now jQuery digest should be overwritten

366
00:14:09,619 --> 00:14:14,389
<font color="#CCCCCC">so now our</font><font color="#E5E5E5"> victim is</font><font color="#CCCCCC"> going to refresh</font>

367
00:14:11,389 --> 00:14:16,160
the<font color="#CCCCCC"> page and you can</font><font color="#E5E5E5"> see the files been</font>

368
00:14:14,389 --> 00:14:18,799
overwritten with the<font color="#CCCCCC"> ajax query that we</font>

369
00:14:16,160 --> 00:14:21,219
just looked at now we're gonna make<font color="#E5E5E5"> the</font>

370
00:14:18,799 --> 00:14:24,079
victim refresh<font color="#E5E5E5"> any page on the website</font>

371
00:14:21,220 --> 00:14:25,669
<font color="#CCCCCC">jquery the JS has now changed so the</font>

372
00:14:24,079 --> 00:14:28,128
cache is invalidated so the user is

373
00:14:25,669 --> 00:14:30,309
<font color="#CCCCCC">going</font><font color="#E5E5E5"> to request the file and we</font>

374
00:14:28,129 --> 00:14:32,360
<font color="#CCCCCC">obtained their cookie</font><font color="#E5E5E5"> so now we can do</font>

375
00:14:30,309 --> 00:14:33,949
basically<font color="#E5E5E5"> we can</font><font color="#CCCCCC"> overwrite any file on</font>

376
00:14:32,360 --> 00:14:35,569
<font color="#CCCCCC">the web server</font><font color="#E5E5E5"> and now we just so</font>

377
00:14:33,949 --> 00:14:38,118
basically the recession<font color="#CCCCCC"> i'm not</font><font color="#E5E5E5"> going</font><font color="#CCCCCC"> to</font>

378
00:14:35,569 --> 00:14:39,378
go through<font color="#E5E5E5"> the whole stealing</font>

379
00:14:38,119 --> 00:14:41,119
<font color="#CCCCCC">intercession changing the cookie because</font>

380
00:14:39,379 --> 00:14:45,410
you saw<font color="#E5E5E5"> that</font><font color="#CCCCCC"> already but</font><font color="#E5E5E5"> basically we</font>

381
00:14:41,119 --> 00:14:49,299
just did<font color="#CCCCCC"> arbitrary right</font><font color="#E5E5E5"> of</font><font color="#CCCCCC"> caching</font>

382
00:14:45,410 --> 00:14:51,769
trees and<font color="#E5E5E5"> also we can leave HTTP cookies</font>

383
00:14:49,299 --> 00:14:53,509
so javascript helped here<font color="#E5E5E5"> it's not</font>

384
00:14:51,769 --> 00:14:56,689
required<font color="#E5E5E5"> you</font><font color="#CCCCCC"> can use</font><font color="#E5E5E5"> anything basically</font>

385
00:14:53,509 --> 00:14:59,839
<font color="#E5E5E5">you can</font><font color="#CCCCCC"> just do like rewrite index.html</font>

386
00:14:56,689 --> 00:15:03,618
that works<font color="#E5E5E5"> fine</font><font color="#CCCCCC"> alright so that's pretty</font>

387
00:14:59,839 --> 00:15:05,359
<font color="#E5E5E5">dangerous</font><font color="#CCCCCC"> so how do you mitigate this so</font>

388
00:15:03,619 --> 00:15:07,429
if you're using<font color="#E5E5E5"> not security which</font>

389
00:15:05,359 --> 00:15:09,949
you're<font color="#E5E5E5"> probably already using</font><font color="#CCCCCC"> some of</font>

390
00:15:07,429 --> 00:15:12,079
<font color="#E5E5E5">you be sure to have</font><font color="#CCCCCC"> the core rule set</font>

391
00:15:09,949 --> 00:15:14,419
from<font color="#CCCCCC"> OS</font><font color="#E5E5E5"> so this is gonna leverage</font>

392
00:15:12,079 --> 00:15:16,099
basically<font color="#CCCCCC"> Mott</font><font color="#E5E5E5"> security in order to</font>

393
00:15:14,419 --> 00:15:18,040
escape HTML so

394
00:15:16,100 --> 00:15:21,079
any HTML<font color="#E5E5E5"> tag is going</font><font color="#CCCCCC"> to be escaped</font><font color="#E5E5E5"> and</font>

395
00:15:18,040 --> 00:15:24,319
since it's the<font color="#E5E5E5"> same</font><font color="#CCCCCC"> char set as</font><font color="#E5E5E5"> ESI well</font>

396
00:15:21,079 --> 00:15:26,989
you're good<font color="#E5E5E5"> however</font><font color="#CCCCCC"> you also have to do</font>

397
00:15:24,320 --> 00:15:30,709
proactive escaping<font color="#E5E5E5"> when you think</font><font color="#CCCCCC"> about</font>

398
00:15:26,990 --> 00:15:34,490
it<font color="#CCCCCC"> a</font><font color="#E5E5E5"> JSON response has no real reason</font><font color="#CCCCCC"> to</font>

399
00:15:30,709 --> 00:15:36,258
have their HTML<font color="#CCCCCC"> encoded or escaped</font>

400
00:15:34,490 --> 00:15:38,389
<font color="#E5E5E5">because the browser already knows</font>

401
00:15:36,259 --> 00:15:41,180
<font color="#CCCCCC">through the content type not to</font><font color="#E5E5E5"> evaluate</font>

402
00:15:38,389 --> 00:15:42,709
it but<font color="#E5E5E5"> I'm not attacking web servers I'm</font>

403
00:15:41,180 --> 00:15:45,138
not attacking clients I mean I'm

404
00:15:42,709 --> 00:15:47,660
attacking<font color="#E5E5E5"> caching servers so I'm able to</font>

405
00:15:45,139 --> 00:15:49,579
put ESI tags in there and some ESI

406
00:15:47,660 --> 00:15:51,529
implementations will let me do that

407
00:15:49,579 --> 00:15:54,709
now here of<font color="#CCCCCC"> course have a small problem</font>

408
00:15:51,529 --> 00:15:57,860
<font color="#E5E5E5">meaning I have invalid</font><font color="#CCCCCC"> asi tags because</font>

409
00:15:54,709 --> 00:16:00,040
double quotes right<font color="#E5E5E5"> however ESI</font>

410
00:15:57,860 --> 00:16:02,329
implementations have<font color="#CCCCCC"> a flexible syntax</font>

411
00:16:00,040 --> 00:16:03,980
<font color="#E5E5E5">so for example how</font><font color="#CCCCCC"> about your traffic</font>

412
00:16:02,329 --> 00:16:06,859
server will allow me<font color="#CCCCCC"> to just drop</font><font color="#E5E5E5"> the</font>

413
00:16:03,980 --> 00:16:08,509
<font color="#CCCCCC">little codes and it's just fine so you</font>

414
00:16:06,860 --> 00:16:11,089
<font color="#CCCCCC">can do server side request forgery right</font>

415
00:16:08,509 --> 00:16:13,490
so here's effective<font color="#E5E5E5"> arrest API so we</font>

416
00:16:11,089 --> 00:16:16,009
have API slash<font color="#CCCCCC"> me for which my full name</font>

417
00:16:13,490 --> 00:16:18,649
has a response is<font color="#CCCCCC"> Luigi amatsu</font>

418
00:16:16,009 --> 00:16:20,779
now<font color="#E5E5E5"> I can change that</font><font color="#CCCCCC"> value for ESI</font>

419
00:16:18,649 --> 00:16:22,639
include tag without<font color="#E5E5E5"> double quotes and</font>

420
00:16:20,779 --> 00:16:25,519
that server<font color="#CCCCCC"> is gonna</font><font color="#E5E5E5"> send it back in the</font>

421
00:16:22,639 --> 00:16:27,440
response<font color="#E5E5E5"> now since there's a ESI engine</font>

422
00:16:25,519 --> 00:16:29,569
sitting<font color="#E5E5E5"> on top of that it's gonna go</font>

423
00:16:27,440 --> 00:16:32,720
fetch this<font color="#E5E5E5"> file for me because it thinks</font>

424
00:16:29,569 --> 00:16:36,529
the web cache is being instructed to

425
00:16:32,720 --> 00:16:38,420
query this<font color="#E5E5E5"> file mmm so I changed the</font>

426
00:16:36,529 --> 00:16:39,800
<font color="#CCCCCC">content type to HTML</font><font color="#E5E5E5"> just to better</font>

427
00:16:38,420 --> 00:16:41,449
<font color="#E5E5E5">illustrate how that works so you have</font>

428
00:16:39,800 --> 00:16:43,279
the green the green area which<font color="#E5E5E5"> is</font>

429
00:16:41,449 --> 00:16:45,079
basically the JSON payload and then the

430
00:16:43,279 --> 00:16:46,730
reddish area is the es I include for

431
00:16:45,079 --> 00:16:48,859
which we<font color="#CCCCCC"> use to</font><font color="#E5E5E5"> do</font><font color="#CCCCCC"> server side request</font>

432
00:16:46,730 --> 00:16:50,630
forgery so to reuse the<font color="#E5E5E5"> same graphic</font>

433
00:16:48,860 --> 00:16:52,910
<font color="#E5E5E5">this is basically what happened right so</font>

434
00:16:50,630 --> 00:16:55,819
we have<font color="#E5E5E5"> slash</font><font color="#CCCCCC"> mean for which we had a</font>

435
00:16:52,910 --> 00:16:57,920
response with a ESI<font color="#E5E5E5"> tag in there the</font>

436
00:16:55,819 --> 00:16:59,870
caching server saw that and requested

437
00:16:57,920 --> 00:17:01,910
server status status on a different

438
00:16:59,870 --> 00:17:04,069
<font color="#E5E5E5">server</font><font color="#CCCCCC"> we got the response</font><font color="#E5E5E5"> back step</font>

439
00:17:01,910 --> 00:17:06,139
<font color="#CCCCCC">five and three get concatenated and sent</font>

440
00:17:04,069 --> 00:17:10,040
to the user<font color="#CCCCCC"> now you have to keep in mind</font>

441
00:17:06,140 --> 00:17:13,850
<font color="#E5E5E5">that almost what most ESI engines will</font>

442
00:17:10,040 --> 00:17:16,639
only do ESI<font color="#E5E5E5"> request for preemptively</font>

443
00:17:13,849 --> 00:17:19,219
<font color="#E5E5E5">whitelist at</font><font color="#CCCCCC"> hosts</font><font color="#E5E5E5"> meaning that when you</font>

444
00:17:16,640 --> 00:17:22,459
configure ESI you're gonna have to say

445
00:17:19,220 --> 00:17:25,610
I'm allowed to do a<font color="#E5E5E5"> assign cludes of XYZ</font>

446
00:17:22,459 --> 00:17:26,559
server so if you're not requesting XYZ

447
00:17:25,609 --> 00:17:28,329
<font color="#E5E5E5">you're not going to</font>

448
00:17:26,559 --> 00:17:30,549
anything back however<font color="#CCCCCC"> a lot of them are</font>

449
00:17:28,329 --> 00:17:33,158
also going to allow<font color="#CCCCCC"> you to just do ESI</font>

450
00:17:30,549 --> 00:17:35,320
include<font color="#E5E5E5"> basically anything such as squid</font>

451
00:17:33,159 --> 00:17:38,049
and<font color="#CCCCCC"> language specific implementations</font>

452
00:17:35,320 --> 00:17:40,330
like<font color="#E5E5E5"> no Jess implementations of ESI so</font>

453
00:17:38,049 --> 00:17:41,860
to perform manual detection someone on

454
00:17:40,330 --> 00:17:43,570
Twitter called<font color="#CCCCCC"> addicts myths non came up</font>

455
00:17:41,860 --> 00:17:46,120
with a<font color="#E5E5E5"> pretty smart solution so he's</font>

456
00:17:43,570 --> 00:17:48,519
leveraging<font color="#E5E5E5"> ESI comments so if you</font><font color="#CCCCCC"> sent</font>

457
00:17:46,120 --> 00:17:50,918
to ESI payload<font color="#E5E5E5"> which is a Yi si comment</font>

458
00:17:48,519 --> 00:17:53,169
and it gets removed<font color="#E5E5E5"> that's a pretty big</font>

459
00:17:50,919 --> 00:17:55,149
<font color="#CCCCCC">indication that you're</font><font color="#E5E5E5"> doing with ESI if</font>

460
00:17:53,169 --> 00:17:57,190
you want to really confirm that it's an

461
00:17:55,149 --> 00:17:58,989
actual<font color="#E5E5E5"> ESI server you can do the same</font>

462
00:17:57,190 --> 00:18:01,570
thing<font color="#E5E5E5"> but instead of</font><font color="#CCCCCC"> ESI but</font><font color="#E5E5E5"> something</font>

463
00:17:58,990 --> 00:18:03,610
else<font color="#CCCCCC"> you are</font><font color="#E5E5E5"> it doesn't matter if this</font>

464
00:18:01,570 --> 00:18:05,439
does come back<font color="#E5E5E5"> then you're probably</font>

465
00:18:03,610 --> 00:18:07,869
messing with the ESI server and you

466
00:18:05,440 --> 00:18:09,039
should start fingerprinting it if you

467
00:18:07,869 --> 00:18:10,570
don't want to mess with metal detection

468
00:18:09,039 --> 00:18:13,269
you<font color="#E5E5E5"> can use either of these three tools</font>

469
00:18:10,570 --> 00:18:14,860
<font color="#CCCCCC">I know for a fact that active active</font>

470
00:18:13,269 --> 00:18:16,659
scan plus plus in the uploads counter

471
00:18:14,860 --> 00:18:18,908
<font color="#E5E5E5">are</font><font color="#CCCCCC"> gonna use</font><font color="#E5E5E5"> this heuristic</font><font color="#CCCCCC"> I can it</font>

472
00:18:16,659 --> 00:18:20,590
takes however<font color="#CCCCCC"> I don't know how they find</font>

473
00:18:18,909 --> 00:18:25,149
<font color="#E5E5E5">it I just know that they claim that they</font>

474
00:18:20,590 --> 00:18:28,090
do<font color="#CCCCCC"> if you want to</font><font color="#E5E5E5"> use something like ESI</font>

475
00:18:25,149 --> 00:18:30,340
<font color="#E5E5E5">but you're not</font><font color="#CCCCCC"> exactly sure that</font><font color="#E5E5E5"> this is</font>

476
00:18:28,090 --> 00:18:32,499
a safe solution<font color="#CCCCCC"> you can use something</font>

477
00:18:30,340 --> 00:18:35,408
<font color="#CCCCCC">that</font><font color="#E5E5E5"> Lucas</font><font color="#CCCCCC"> Rider on</font><font color="#E5E5E5"> Twitter came up with</font>

478
00:18:32,499 --> 00:18:37,389
so<font color="#CCCCCC"> basically he leveraged clout pair</font>

479
00:18:35,409 --> 00:18:39,249
<font color="#E5E5E5">workers clapping workers are a</font>

480
00:18:37,389 --> 00:18:40,689
<font color="#E5E5E5">JavaScript file sitting on edge servers</font>

481
00:18:39,249 --> 00:18:43,119
<font color="#CCCCCC">of course you have to use</font><font color="#E5E5E5"> cloud</font><font color="#CCCCCC"> player</font>

482
00:18:40,690 --> 00:18:45,999
to use<font color="#E5E5E5"> this and</font><font color="#CCCCCC"> you can</font><font color="#E5E5E5"> use</font><font color="#CCCCCC"> fragments as</font>

483
00:18:43,119 --> 00:18:47,799
well<font color="#CCCCCC"> so in your response</font><font color="#E5E5E5"> you're allowed</font>

484
00:18:45,999 --> 00:18:49,749
<font color="#E5E5E5">to have</font><font color="#CCCCCC"> fragments</font><font color="#E5E5E5"> so here you have a</font>

485
00:18:47,799 --> 00:18:52,119
fragment pointing to footer but the

486
00:18:49,749 --> 00:18:54,700
source is not<font color="#CCCCCC"> in the response its sent</font>

487
00:18:52,119 --> 00:18:56,709
<font color="#E5E5E5">and the HTTP header now if you've done</font>

488
00:18:54,700 --> 00:18:58,559
any sort<font color="#E5E5E5"> of web app and testing in the</font>

489
00:18:56,710 --> 00:19:01,720
past five<font color="#E5E5E5"> to ten years you'll know</font><font color="#CCCCCC"> that</font>

490
00:18:58,559 --> 00:19:03,999
<font color="#E5E5E5">HTTP response injection is not exactly</font>

491
00:19:01,720 --> 00:19:05,440
<font color="#E5E5E5">common it's much harder to do so</font><font color="#CCCCCC"> this is</font>

492
00:19:03,999 --> 00:19:08,860
a much safer alternative and it's

493
00:19:05,440 --> 00:19:10,419
probably<font color="#E5E5E5"> even faster so modern ESI I</font>

494
00:19:08,860 --> 00:19:12,549
would call this a modern<font color="#E5E5E5"> ESI</font>

495
00:19:10,419 --> 00:19:15,970
implementation and it's just a whole lot

496
00:19:12,549 --> 00:19:18,850
<font color="#E5E5E5">safer like you can inject variables that</font>

497
00:19:15,970 --> 00:19:21,059
<font color="#CCCCCC">leaks</font><font color="#E5E5E5"> your cookies so basically this is</font>

498
00:19:18,850 --> 00:19:23,080
a brief<font color="#CCCCCC"> introduction to what ESI is</font>

499
00:19:21,059 --> 00:19:25,240
<font color="#E5E5E5">obviously there's still a lot of</font>

500
00:19:23,080 --> 00:19:26,559
<font color="#E5E5E5">research</font><font color="#CCCCCC"> to be done</font><font color="#E5E5E5"> on the topic</font><font color="#CCCCCC"> you can</font>

501
00:19:25,240 --> 00:19:29,350
check our blog<font color="#CCCCCC"> post</font><font color="#E5E5E5"> for which we</font>

502
00:19:26,559 --> 00:19:30,940
<font color="#E5E5E5">released in April none of this material</font>

503
00:19:29,350 --> 00:19:33,820
was<font color="#CCCCCC"> covered in the blog post this is</font>

504
00:19:30,940 --> 00:19:34,330
merely an extension<font color="#CCCCCC"> of</font><font color="#E5E5E5"> this research in</font>

505
00:19:33,820 --> 00:19:35,980
our

506
00:19:34,330 --> 00:19:38,019
<font color="#CCCCCC">cause</font><font color="#E5E5E5"> I think we looked at six</font>

507
00:19:35,980 --> 00:19:41,380
implementations of ESI and<font color="#E5E5E5"> some of which</font>

508
00:19:38,019 --> 00:19:43,630
are Akamai<font color="#CCCCCC"> websphere fastly squid-like</font>

509
00:19:41,380 --> 00:19:46,299
<font color="#CCCCCC">hold on to them we found a lot</font><font color="#E5E5E5"> of</font>

510
00:19:43,630 --> 00:19:48,659
crashes like null defer answers for

511
00:19:46,299 --> 00:19:53,080
squid that we found a header injection

512
00:19:48,659 --> 00:19:54,429
<font color="#CCCCCC">for all</font><font color="#E5E5E5"> mitosis filter bypass</font><font color="#CCCCCC"> so there's</font>

513
00:19:53,080 --> 00:19:58,720
a lot<font color="#CCCCCC"> of interesting</font><font color="#E5E5E5"> stuff</font><font color="#CCCCCC"> to be found</font>

514
00:19:54,429 --> 00:20:00,279
with<font color="#E5E5E5"> there with this</font><font color="#CCCCCC"> also please</font>

515
00:19:58,720 --> 00:20:02,110
remember<font color="#E5E5E5"> that if you like exploiting</font>

516
00:20:00,279 --> 00:20:03,100
caching servers<font color="#CCCCCC"> James</font><font color="#E5E5E5"> kettle is gonna</font>

517
00:20:02,110 --> 00:20:06,149
give<font color="#E5E5E5"> it a really good talk tomorrow</font>

518
00:20:03,100 --> 00:20:09,250
about<font color="#E5E5E5"> that so keep that in mind</font>

519
00:20:06,149 --> 00:20:12,370
<font color="#CCCCCC">otherwise</font><font color="#E5E5E5"> I could probably close with</font>

520
00:20:09,250 --> 00:20:14,799
where we found ESI so it's we found a

521
00:20:12,370 --> 00:20:16,809
lot of ESI testing our own<font color="#E5E5E5"> clients</font><font color="#CCCCCC"> so I</font>

522
00:20:14,799 --> 00:20:20,470
<font color="#E5E5E5">can't exactly talk about that publicly</font>

523
00:20:16,809 --> 00:20:24,010
<font color="#CCCCCC">but a lot of newspaper</font><font color="#E5E5E5"> or organizations</font>

524
00:20:20,470 --> 00:20:26,860
<font color="#E5E5E5">that became</font><font color="#CCCCCC"> web enabled and like early</font>

525
00:20:24,010 --> 00:20:28,450
2000<font color="#E5E5E5"> are still diverging ESI not to say</font>

526
00:20:26,860 --> 00:20:30,850
that some<font color="#E5E5E5"> are not employing ESI right</font>

527
00:20:28,450 --> 00:20:32,769
now it's<font color="#E5E5E5"> still</font><font color="#CCCCCC"> fairly</font><font color="#E5E5E5"> popular</font><font color="#CCCCCC"> but like</font>

528
00:20:30,850 --> 00:20:36,309
newspaper are usually leveraging<font color="#CCCCCC"> yes</font><font color="#E5E5E5"> I</font>

529
00:20:32,769 --> 00:20:39,460
for some<font color="#CCCCCC"> reason we</font><font color="#E5E5E5"> found IBM commerce</font>

530
00:20:36,309 --> 00:20:43,330
leveraging<font color="#CCCCCC"> yet side the internals of</font>

531
00:20:39,460 --> 00:20:45,549
some<font color="#E5E5E5"> Oracle products also use ESI if you</font>

532
00:20:43,330 --> 00:20:47,199
go on Twitter<font color="#E5E5E5"> some people usually put</font>

533
00:20:45,549 --> 00:20:49,750
screenshots of<font color="#E5E5E5"> where they find ESI</font>

534
00:20:47,200 --> 00:20:51,760
injections<font color="#E5E5E5"> also</font><font color="#CCCCCC"> I've had</font><font color="#E5E5E5"> people that</font>

535
00:20:49,750 --> 00:20:53,789
work for<font color="#CCCCCC"> a major bug Monty's company</font>

536
00:20:51,760 --> 00:20:56,139
told me that they've seen ESI injection

537
00:20:53,789 --> 00:20:57,789
<font color="#E5E5E5">bug reports coming true so it's out</font>

538
00:20:56,139 --> 00:21:00,010
there it's<font color="#CCCCCC"> just not exactly</font><font color="#E5E5E5"> popular</font>

539
00:20:57,789 --> 00:21:02,679
enough<font color="#CCCCCC"> to have a clear picture of</font><font color="#E5E5E5"> where</font>

540
00:21:00,010 --> 00:21:04,929
<font color="#E5E5E5">si is used right</font><font color="#CCCCCC"> now so I think we have</font>

541
00:21:02,679 --> 00:21:07,330
maybe four<font color="#CCCCCC"> or three</font><font color="#E5E5E5"> minutes for</font>

542
00:21:04,929 --> 00:21:08,710
questions<font color="#CCCCCC"> otherwise</font><font color="#E5E5E5"> if you want</font><font color="#CCCCCC"> to talk</font>

543
00:21:07,330 --> 00:21:11,370
to me afterwards I'll be at the<font color="#CCCCCC"> concert</font>

544
00:21:08,710 --> 00:21:15,580
<font color="#CCCCCC">AG go secure booths in</font><font color="#E5E5E5"> the vendor area</font>

545
00:21:11,370 --> 00:21:18,370
so<font color="#CCCCCC"> yeah questions there's microphones</font>

546
00:21:15,580 --> 00:21:19,600
<font color="#E5E5E5">right there or you can say it out loud</font>

547
00:21:18,370 --> 00:21:24,370
and<font color="#E5E5E5"> I'll repeat but I'd much prefer you</font>

548
00:21:19,600 --> 00:21:26,459
<font color="#CCCCCC">use the microphone</font><font color="#E5E5E5"> okay I'm not sure</font><font color="#CCCCCC"> if</font>

549
00:21:24,370 --> 00:21:29,289
yeah<font color="#E5E5E5"> if nginx</font>

550
00:21:26,460 --> 00:21:30,990
<font color="#E5E5E5">if I test nginx I'm not sure if and our</font>

551
00:21:29,289 --> 00:21:33,100
next largest yes I have no idea<font color="#CCCCCC"> I</font>

552
00:21:30,990 --> 00:21:34,690
<font color="#CCCCCC">wouldn't be surprised that</font><font color="#E5E5E5"> someone came</font>

553
00:21:33,100 --> 00:21:38,610
<font color="#CCCCCC">up with a</font><font color="#E5E5E5"> module to leverage</font><font color="#CCCCCC"> ESI on</font>

554
00:21:34,690 --> 00:21:38,610
nginx but I know I didn't look at

555
00:21:40,690 --> 00:21:47,960
yes yeah

556
00:21:45,950 --> 00:21:52,360
so there's burp<font color="#CCCCCC"> active</font><font color="#E5E5E5"> scan plus plus</font>

557
00:21:47,960 --> 00:21:52,360
<font color="#CCCCCC">burp uploads counter and</font><font color="#E5E5E5"> a kinetics</font>

558
00:21:54,280 --> 00:22:02,039
think that's it

559
00:21:57,680 --> 00:22:02,039
[Applause]

