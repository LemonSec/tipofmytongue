1
00:00:00,000 --> 00:00:04,110
good morning everyone welcome to

2
00:00:01,979 --> 00:00:07,020
attacking and defending the Microsoft

3
00:00:04,110 --> 00:00:09,780
cloud office 365 and Azure Active

4
00:00:07,020 --> 00:00:11,489
Directory in South Pacific with Sean

5
00:00:09,780 --> 00:00:13,469
Metcalfe and Mark porzinski

6
00:00:11,490 --> 00:00:15,839
before we begin we have a few brief

7
00:00:13,469 --> 00:00:17,669
announcements for you please stop by the

8
00:00:15,839 --> 00:00:20,130
business hall located in the Mandalay

9
00:00:17,670 --> 00:00:22,230
Bay Oceanside and shoreline ballrooms on

10
00:00:20,130 --> 00:00:25,470
level 2 during the day and for the

11
00:00:22,230 --> 00:00:27,060
Welcome Reception at 5:30 tonight the

12
00:00:25,470 --> 00:00:29,279
blackhat arsenals in the business hall

13
00:00:27,060 --> 00:00:31,529
on level 2 and please join us for the

14
00:00:29,279 --> 00:00:35,130
pony Awards which correction to prior

15
00:00:31,529 --> 00:00:37,710
announcements are in lagoon JKL at 6:30

16
00:00:35,130 --> 00:00:39,570
today lunch will be served in Bayside a

17
00:00:37,710 --> 00:00:41,700
B immediately after this session until

18
00:00:39,570 --> 00:00:43,680
1:30 and don't forget the merchandise

19
00:00:41,700 --> 00:00:45,180
store on level 2 and session recordings

20
00:00:43,680 --> 00:00:46,350
from a source of knowledge they have a

21
00:00:45,180 --> 00:00:48,539
desk on every level

22
00:00:46,350 --> 00:00:50,550
now please ensure that your phones have

23
00:00:48,539 --> 00:00:52,199
been placed on vibrate or silent to

24
00:00:50,550 --> 00:00:55,940
avoid interrupting the presentation and

25
00:00:52,199 --> 00:00:59,239
welcome Shawn Metcalf and Marc Mezvinsky

26
00:00:55,940 --> 00:00:59,239
[Applause]

27
00:01:00,829 --> 00:01:05,850
hello and welcome blackhat I'm Shawn

28
00:01:03,780 --> 00:01:07,380
that cat I'm the founder of Trimark

29
00:01:05,850 --> 00:01:09,600
security company we help organizations

30
00:01:07,380 --> 00:01:11,640
better secure their Microsoft platform

31
00:01:09,600 --> 00:01:13,229
both on Prem and in the cloud I'm a

32
00:01:11,640 --> 00:01:17,400
Microsoft Certified Master in Active

33
00:01:13,229 --> 00:01:18,979
Directory Microsoft MVP yes and I'm back

34
00:01:17,400 --> 00:01:21,750
at blackhat so I'm very happy to be here

35
00:01:18,979 --> 00:01:23,549
I've spoken a number of conferences and

36
00:01:21,750 --> 00:01:25,619
I'm very happy to be back I'm also a

37
00:01:23,549 --> 00:01:27,299
security consultant and researcher and I

38
00:01:25,619 --> 00:01:29,250
post some interesting security stuff on

39
00:01:27,299 --> 00:01:32,400
80 security org the slides will be

40
00:01:29,250 --> 00:01:33,689
posted there after this talk and I'm

41
00:01:32,400 --> 00:01:35,340
mark Ward's insky I'm a principal

42
00:01:33,689 --> 00:01:37,229
program manager in the identity division

43
00:01:35,340 --> 00:01:38,579
at Microsoft we're responsible for

44
00:01:37,229 --> 00:01:40,439
Active Directory Active Directory

45
00:01:38,579 --> 00:01:42,570
Federation services and Azure Active

46
00:01:40,439 --> 00:01:43,949
Directory and I work on the customer

47
00:01:42,570 --> 00:01:45,449
experience team I work with customers on

48
00:01:43,950 --> 00:01:47,009
their deployments of adjectives

49
00:01:45,450 --> 00:01:48,240
directory we provide guidance but also

50
00:01:47,009 --> 00:01:49,860
take some of the learnings and the

51
00:01:48,240 --> 00:01:51,089
feedback from those deployments and work

52
00:01:49,860 --> 00:01:53,420
it back into the product to make it

53
00:01:51,090 --> 00:01:57,119
easier for everybody else to the Play so

54
00:01:53,420 --> 00:02:00,360
this talk started based on a Twitter

55
00:01:57,119 --> 00:02:02,670
conversation last year at blackhat Sean

56
00:02:00,360 --> 00:02:04,200
did a really good session around moving

57
00:02:02,670 --> 00:02:05,549
from a workstation to domain admin I

58
00:02:04,200 --> 00:02:07,920
thought oh wow that'd be really good we

59
00:02:05,549 --> 00:02:10,140
should do something like that for Azure

60
00:02:07,920 --> 00:02:11,819
Active Directory and Sean said yeah

61
00:02:10,139 --> 00:02:14,160
let's do that let's do it so we

62
00:02:11,819 --> 00:02:14,519
submitted our talk it got accepted which

63
00:02:14,160 --> 00:02:15,630
was great

64
00:02:14,520 --> 00:02:16,680
I've never been the black hat before

65
00:02:15,630 --> 00:02:18,000
this is my first time this has been

66
00:02:16,680 --> 00:02:19,950
excellent so this is what we're going to

67
00:02:18,000 --> 00:02:21,870
talk about today first we're gonna give

68
00:02:19,950 --> 00:02:23,220
you a sample customer about how

69
00:02:21,870 --> 00:02:25,440
customers have moved to the cloud

70
00:02:23,220 --> 00:02:26,970
Shawn's going to cover some attacker

71
00:02:25,440 --> 00:02:28,770
recon as well as some attacking the

72
00:02:26,970 --> 00:02:30,450
cloud I'm gonna cover defending the

73
00:02:28,770 --> 00:02:32,190
cloud and then the last part is gonna be

74
00:02:30,450 --> 00:02:34,589
a bunch of go dudes I'll be the time to

75
00:02:32,190 --> 00:02:35,910
get out your camera take a picture send

76
00:02:34,590 --> 00:02:37,290
it back to the mothership making sure

77
00:02:35,910 --> 00:02:39,240
that we're doing best practices and

78
00:02:37,290 --> 00:02:41,010
following the proper guidance so let's

79
00:02:39,240 --> 00:02:45,030
go ahead and meet that customer the

80
00:02:41,010 --> 00:02:46,829
customer is Acme they are the largest

81
00:02:45,030 --> 00:02:47,730
manufacturer and distributor of anvils

82
00:02:46,830 --> 00:02:49,620
in the world

83
00:02:47,730 --> 00:02:52,859
they are headquartered right here in Las

84
00:02:49,620 --> 00:02:54,780
Vegas Nevada they have 500,000 employees

85
00:02:52,860 --> 00:02:56,400
and they operated in 140 countries and

86
00:02:54,780 --> 00:02:57,630
they're starting to think about maybe

87
00:02:56,400 --> 00:02:58,890
they should move their business to the

88
00:02:57,630 --> 00:03:00,420
cloud they're not sure if this is the

89
00:02:58,890 --> 00:03:02,339
right thing for them to do or how to get

90
00:03:00,420 --> 00:03:05,160
started they're kind of lacking some

91
00:03:02,340 --> 00:03:09,960
direction but the good news is they just

92
00:03:05,160 --> 00:03:13,109
hired a new visionary CIO that CIO is

93
00:03:09,960 --> 00:03:15,600
Wiley coyote a longtime customer now

94
00:03:13,110 --> 00:03:16,290
employee get that sweet sweet employee

95
00:03:15,600 --> 00:03:19,380
discount

96
00:03:16,290 --> 00:03:21,450
he has surveyed the desert he has his

97
00:03:19,380 --> 00:03:25,079
priorities and his number one priority

98
00:03:21,450 --> 00:03:26,609
is we're going to the cloud okay so Acme

99
00:03:25,080 --> 00:03:27,959
puts together a project team this may

100
00:03:26,610 --> 00:03:29,540
look like some of the similar project

101
00:03:27,959 --> 00:03:33,390
teams that you've worked on we have our

102
00:03:29,540 --> 00:03:35,519
identity architect who really is excited

103
00:03:33,390 --> 00:03:37,859
about this project they want to fix all

104
00:03:35,520 --> 00:03:39,060
of the previous 10 to 15 years identity

105
00:03:37,860 --> 00:03:41,280
access management problems they've had

106
00:03:39,060 --> 00:03:44,310
because this time we're gonna do it

107
00:03:41,280 --> 00:03:46,830
right and then we have our collaboration

108
00:03:44,310 --> 00:03:48,300
architect who is kind of excited about

109
00:03:46,830 --> 00:03:49,709
this they're not too sure what does this

110
00:03:48,300 --> 00:03:51,390
mean from a job performance perspective

111
00:03:49,709 --> 00:03:52,770
going forward they're still gonna be

112
00:03:51,390 --> 00:03:54,989
employed after this projects done so

113
00:03:52,770 --> 00:03:56,880
they're a little kind of standoffish we

114
00:03:54,990 --> 00:03:58,350
have the identity engineering team who

115
00:03:56,880 --> 00:04:00,269
is actually going to go push all the

116
00:03:58,350 --> 00:04:01,320
buttons on this stuff and they don't

117
00:04:00,270 --> 00:04:04,860
want to really get started on anything

118
00:04:01,320 --> 00:04:07,590
until we have all these use cases sorted

119
00:04:04,860 --> 00:04:08,940
out entirely okay then we have our

120
00:04:07,590 --> 00:04:10,170
collaboration engineering team and

121
00:04:08,940 --> 00:04:12,600
they're pretty much looking for any

122
00:04:10,170 --> 00:04:13,679
reason to not do anything does anyone

123
00:04:12,600 --> 00:04:17,190
work with anyone like that or is that

124
00:04:13,680 --> 00:04:18,690
just shot at I just check in and then we

125
00:04:17,190 --> 00:04:20,430
have our security engineering team the

126
00:04:18,690 --> 00:04:22,108
answer is absolutely not not quite sure

127
00:04:20,430 --> 00:04:23,790
what the question is and then lastly we

128
00:04:22,108 --> 00:04:25,950
have a key component which is our

129
00:04:23,790 --> 00:04:28,030
desktop engineering team who is not

130
00:04:25,950 --> 00:04:30,820
present in any of these meetings

131
00:04:28,030 --> 00:04:31,690
okay I love the desktop stuff come on

132
00:04:30,820 --> 00:04:35,320
come on all right but they're never

133
00:04:31,690 --> 00:04:37,000
there okay so acme get started they

134
00:04:35,320 --> 00:04:38,889
decide office 365 what they're gonna do

135
00:04:37,000 --> 00:04:39,910
they move their first workload it's

136
00:04:38,889 --> 00:04:41,740
going to be email and they're going to

137
00:04:39,910 --> 00:04:43,210
deploy as your MFA because they want to

138
00:04:41,740 --> 00:04:45,250
increase your security posture which is

139
00:04:43,210 --> 00:04:47,680
great they do their pilot group which is

140
00:04:45,250 --> 00:04:48,460
usually IT they sync them over and now

141
00:04:47,680 --> 00:04:49,840
they're starting to look at all the

142
00:04:48,460 --> 00:04:50,979
different use cases they have in their

143
00:04:49,840 --> 00:04:52,510
environment they're different employees

144
00:04:50,980 --> 00:04:53,470
and this is where Acme starts to get in

145
00:04:52,510 --> 00:04:55,630
a little bit of trouble they start

146
00:04:53,470 --> 00:04:57,070
getting some analysis paralysis right

147
00:04:55,630 --> 00:04:58,389
and right now the scenario they're

148
00:04:57,070 --> 00:05:01,000
trying to work out is a user was

149
00:04:58,389 --> 00:05:03,700
registered for as your MFA they lost

150
00:05:01,000 --> 00:05:05,890
their phone they got a new phone they

151
00:05:03,700 --> 00:05:07,030
immediately got on a plane and while

152
00:05:05,890 --> 00:05:09,310
they were on that plane they were

153
00:05:07,030 --> 00:05:12,369
registering for a MFA the Wi-Fi on the

154
00:05:09,310 --> 00:05:14,200
plane went down how in the world is this

155
00:05:12,370 --> 00:05:16,840
person going to access their email on

156
00:05:14,200 --> 00:05:18,820
the plane so while Acme is working

157
00:05:16,840 --> 00:05:21,909
through this hypothetical situation that

158
00:05:18,820 --> 00:05:23,890
may never happen it's probably never

159
00:05:21,910 --> 00:05:25,930
gonna happen something is much more

160
00:05:23,890 --> 00:05:31,060
sinister a foot and that sinister thing

161
00:05:25,930 --> 00:05:34,450
is Shawn this is kind of cool I get to

162
00:05:31,060 --> 00:05:35,680
play the attacker while acne is going

163
00:05:34,450 --> 00:05:37,000
through this process and figuring out

164
00:05:35,680 --> 00:05:38,200
what they're gonna do in the cloud and

165
00:05:37,000 --> 00:05:39,669
how they're gonna configure everything

166
00:05:38,200 --> 00:05:41,469
and they've already moved some people in

167
00:05:39,669 --> 00:05:44,460
there they really haven't looked at the

168
00:05:41,470 --> 00:05:46,660
security of it yet so what's happening

169
00:05:44,460 --> 00:05:48,760
meanwhile there's an attacker that is

170
00:05:46,660 --> 00:05:51,490
looking at this environment let's see

171
00:05:48,760 --> 00:05:53,680
what we can find one of the first things

172
00:05:51,490 --> 00:05:55,240
that I usually look at is DNS because

173
00:05:53,680 --> 00:05:57,190
it's easy to look at no one knows that

174
00:05:55,240 --> 00:05:59,350
I'm looking at it in fact I scan the

175
00:05:57,190 --> 00:06:01,060
Fortune 1000 companies to see what MX

176
00:05:59,350 --> 00:06:02,919
records they have to see what their mail

177
00:06:01,060 --> 00:06:04,720
exchangers are this gives you a good

178
00:06:02,919 --> 00:06:07,479
idea as an attacker to figure out what

179
00:06:04,720 --> 00:06:11,169
sort of security posture their emails is

180
00:06:07,479 --> 00:06:12,909
what they have and so we can see that

181
00:06:11,169 --> 00:06:16,359
organizations will have proof point or

182
00:06:12,910 --> 00:06:19,630
office 365 or Cisco or a number of other

183
00:06:16,360 --> 00:06:21,880
type systems so if I as the attacker I'm

184
00:06:19,630 --> 00:06:23,500
designing an email campaign I'm going to

185
00:06:21,880 --> 00:06:25,600
figure out what they have so that way I

186
00:06:23,500 --> 00:06:26,860
can test it against something similar so

187
00:06:25,600 --> 00:06:29,800
I can have a better idea of what might

188
00:06:26,860 --> 00:06:31,360
work and what might not but often more

189
00:06:29,800 --> 00:06:33,039
interesting are the text records that

190
00:06:31,360 --> 00:06:34,840
are in DNS these can be pretty much

191
00:06:33,039 --> 00:06:37,750
whatever you want them to be and a lot

192
00:06:34,840 --> 00:06:39,190
of time organizations need to set a

193
00:06:37,750 --> 00:06:42,040
main verification or site verification

194
00:06:39,190 --> 00:06:43,870
record this is usually because they want

195
00:06:42,040 --> 00:06:45,430
to go with a third-party app or SAS app

196
00:06:43,870 --> 00:06:47,620
and they have to prove that they own

197
00:06:45,430 --> 00:06:49,330
this domain and in doing so they have

198
00:06:47,620 --> 00:06:52,060
this record in DNS which again is

199
00:06:49,330 --> 00:06:55,030
visible to everyone so this means that

200
00:06:52,060 --> 00:06:56,260
through a DNS query I can get some

201
00:06:55,030 --> 00:06:58,119
really good information about what kind

202
00:06:56,260 --> 00:07:01,360
of enterprise apps that an organization

203
00:06:58,120 --> 00:07:03,430
they have so where's that meow well we

204
00:07:01,360 --> 00:07:05,290
see they just went to office 365 so if

205
00:07:03,430 --> 00:07:07,900
I'm an attacker and I'm very intent on

206
00:07:05,290 --> 00:07:10,960
stealing the secret envel manufacturing

207
00:07:07,900 --> 00:07:12,789
process that acne has I can look to see

208
00:07:10,960 --> 00:07:15,430
what they have in their environment just

209
00:07:12,790 --> 00:07:17,320
by doing some DNS queries possibly these

210
00:07:15,430 --> 00:07:19,240
don't need to persist very often these

211
00:07:17,320 --> 00:07:21,610
can be removed soon after they've been

212
00:07:19,240 --> 00:07:23,650
verified and then just clean them up out

213
00:07:21,610 --> 00:07:26,410
of DNS so we know they have it last year

214
00:07:23,650 --> 00:07:27,039
and they are cisco Citrix Dropbox and

215
00:07:26,410 --> 00:07:29,320
WebEx

216
00:07:27,040 --> 00:07:31,090
why is this interesting because if I'm

217
00:07:29,320 --> 00:07:33,580
an attacker and I want to put together a

218
00:07:31,090 --> 00:07:35,080
phishing campaign what I want to do is

219
00:07:33,580 --> 00:07:37,479
target it to something that they may

220
00:07:35,080 --> 00:07:39,370
feel relevant so I may send an email to

221
00:07:37,480 --> 00:07:41,140
all Acme or all the email addresses I

222
00:07:39,370 --> 00:07:43,330
have it acne at 7 a.m. on a Monday

223
00:07:41,140 --> 00:07:45,159
morning say there has been a web act

224
00:07:43,330 --> 00:07:46,960
security issue you need to update your

225
00:07:45,160 --> 00:07:48,940
WebEx or you will not be able to connect

226
00:07:46,960 --> 00:07:53,200
to your meetings today it could be

227
00:07:48,940 --> 00:07:56,050
pretty successful or since I said alas

228
00:07:53,200 --> 00:07:57,909
en Avinash realized recently that JIRA

229
00:07:56,050 --> 00:08:00,340
had a potential Mis configuration for a

230
00:07:57,910 --> 00:08:01,750
large number of companies that could

231
00:08:00,340 --> 00:08:03,849
leak some information about their

232
00:08:01,750 --> 00:08:05,560
internal environment so I could look at

233
00:08:03,850 --> 00:08:08,620
to see if acne has JIRA because they

234
00:08:05,560 --> 00:08:11,110
have an Alaskan Tex record here and see

235
00:08:08,620 --> 00:08:12,340
what else I could find through that the

236
00:08:11,110 --> 00:08:15,010
other thing that's pretty interesting is

237
00:08:12,340 --> 00:08:16,299
the Federation configuration so I want

238
00:08:15,010 --> 00:08:18,789
to see if acne has some sort of

239
00:08:16,300 --> 00:08:20,800
Federation do they have a DFS on site

240
00:08:18,790 --> 00:08:22,150
what are they doing with that how are

241
00:08:20,800 --> 00:08:24,520
they handling their authentication flow

242
00:08:22,150 --> 00:08:27,549
and there's no real good naming standard

243
00:08:24,520 --> 00:08:30,760
for Federation so I can try FS SSO STS

244
00:08:27,550 --> 00:08:32,680
etc and at Def Con a couple years ago I

245
00:08:30,760 --> 00:08:34,510
talked about if you could pull this

246
00:08:32,679 --> 00:08:36,549
token signing certificate off of the

247
00:08:34,510 --> 00:08:38,710
Federation server then you could use

248
00:08:36,549 --> 00:08:41,140
that potentially to spoof and create

249
00:08:38,710 --> 00:08:44,470
your own forged sam'l tokens to then get

250
00:08:41,140 --> 00:08:47,290
access to all of those federated apps so

251
00:08:44,470 --> 00:08:49,660
think work day think Salesforce think

252
00:08:47,290 --> 00:08:50,839
other big-name company that sensitive

253
00:08:49,660 --> 00:08:53,480
data could be in

254
00:08:50,840 --> 00:08:55,250
and a few months after that cyber-ark

255
00:08:53,480 --> 00:08:57,170
had a post about what they they called

256
00:08:55,250 --> 00:08:58,670
the golden sam'l attack and they

257
00:08:57,170 --> 00:09:00,680
released a tool they could actually do

258
00:08:58,670 --> 00:09:03,050
this once you have a token signing cert

259
00:09:00,680 --> 00:09:05,449
you can create these forged sam'l tokens

260
00:09:03,050 --> 00:09:07,490
and then access these federated

261
00:09:05,450 --> 00:09:10,670
resources as if you're that person and

262
00:09:07,490 --> 00:09:14,120
early this year at troopers Doug and

263
00:09:10,670 --> 00:09:16,910
release this tool called ATF spoof

264
00:09:14,120 --> 00:09:19,820
so Doug Bienstock from and Ian had done

265
00:09:16,910 --> 00:09:22,130
a talk there with Adam and they talked

266
00:09:19,820 --> 00:09:24,920
about how you could extract this data

267
00:09:22,130 --> 00:09:27,170
this certificate data from a DFS and

268
00:09:24,920 --> 00:09:29,750
then also right after you get that

269
00:09:27,170 --> 00:09:32,900
generate that sam'l token and get access

270
00:09:29,750 --> 00:09:35,060
to that application in that talk that

271
00:09:32,900 --> 00:09:38,689
they had called ima DFS and so can you

272
00:09:35,060 --> 00:09:40,609
Doug in Austin talked about a TFS

273
00:09:38,690 --> 00:09:42,920
adapters which is not all that

274
00:09:40,610 --> 00:09:44,570
well-known but a TFS has these adapters

275
00:09:42,920 --> 00:09:45,800
where you typically have the

276
00:09:44,570 --> 00:09:47,570
authentication flow where the user

277
00:09:45,800 --> 00:09:50,120
authenticates the ad and then they

278
00:09:47,570 --> 00:09:53,029
connect to a DFS which then will give

279
00:09:50,120 --> 00:09:54,560
them that token but an adapter says wait

280
00:09:53,029 --> 00:09:57,530
there's one more step that we have to do

281
00:09:54,560 --> 00:09:59,420
so for example you can have duo MFA that

282
00:09:57,530 --> 00:10:00,650
needs to happen next and when you have

283
00:09:59,420 --> 00:10:03,020
something like that you're going to have

284
00:10:00,650 --> 00:10:04,640
a DLL and they talked about cracking

285
00:10:03,020 --> 00:10:07,100
open this DLL and looking at the code

286
00:10:04,640 --> 00:10:08,930
inside of it and modifying this code so

287
00:10:07,100 --> 00:10:11,839
that way instead of just doing the MFA

288
00:10:08,930 --> 00:10:14,449
part if you submit it during that log on

289
00:10:11,839 --> 00:10:16,640
page beep-beep I'm a jeep it could run

290
00:10:14,450 --> 00:10:18,530
PowerShell or potentially something far

291
00:10:16,640 --> 00:10:20,480
more malicious this is some amazing

292
00:10:18,530 --> 00:10:23,300
persistence once someone gets on that ad

293
00:10:20,480 --> 00:10:26,180
FS server so it's critical to understand

294
00:10:23,300 --> 00:10:27,920
that once you have a Federation server

295
00:10:26,180 --> 00:10:29,569
you need to protect it like it's anime

296
00:10:27,920 --> 00:10:32,270
and controller like it's a tier 0 system

297
00:10:29,570 --> 00:10:33,440
protect those certificates and make sure

298
00:10:32,270 --> 00:10:35,600
you're pulling the logs out of your

299
00:10:33,440 --> 00:10:38,050
Federation system into your sim along

300
00:10:35,600 --> 00:10:40,250
with AD as well as your as your ad logs

301
00:10:38,050 --> 00:10:43,910
then you can correlate those to figure

302
00:10:40,250 --> 00:10:46,160
out what's going on what's interesting

303
00:10:43,910 --> 00:10:48,589
to me is that there are a number of

304
00:10:46,160 --> 00:10:51,350
different applications or cloud apps

305
00:10:48,589 --> 00:10:53,270
that often require some sort of

306
00:10:51,350 --> 00:10:54,950
synchronization from your on-prem ad and

307
00:10:53,270 --> 00:10:56,810
all that you really need is a user

308
00:10:54,950 --> 00:10:58,190
account in order to send that it gather

309
00:10:56,810 --> 00:11:01,430
that information and send it up to that

310
00:10:58,190 --> 00:11:03,290
cloud environment obviously if you have

311
00:11:01,430 --> 00:11:04,280
office 365 you're probably going to have

312
00:11:03,290 --> 00:11:07,880
as your ad can

313
00:11:04,280 --> 00:11:09,560
but IT doesn't necessarily know what

314
00:11:07,880 --> 00:11:12,140
else is in place because again all you

315
00:11:09,560 --> 00:11:14,660
need is a regular user account so I did

316
00:11:12,140 --> 00:11:21,470
some googling the figure oh sorry mark I

317
00:11:14,660 --> 00:11:25,040
use Bing - then I yeah I use Bing - then

318
00:11:21,470 --> 00:11:26,870
Google Active Directory sync tool and I

319
00:11:25,040 --> 00:11:29,599
found a number of synchronization

320
00:11:26,870 --> 00:11:31,430
engines that you could install and I put

321
00:11:29,600 --> 00:11:33,740
some of the more well-known ones here so

322
00:11:31,430 --> 00:11:35,510
if you're using these services it might

323
00:11:33,740 --> 00:11:37,400
be possible that you have a bunch of

324
00:11:35,510 --> 00:11:39,860
different systems that are sending user

325
00:11:37,400 --> 00:11:42,110
data up to that cloud environment and

326
00:11:39,860 --> 00:11:44,630
potentially group data so you want to be

327
00:11:42,110 --> 00:11:46,730
aware of that so let's focus on a

328
00:11:44,630 --> 00:11:47,960
non-prime environment again at Def Con a

329
00:11:46,730 --> 00:11:49,940
couple years ago I talked about

330
00:11:47,960 --> 00:11:53,120
attacking azure ad connect and the fact

331
00:11:49,940 --> 00:11:55,610
that 80 AD your ad connect using the

332
00:11:53,120 --> 00:11:57,620
Express install we configure itself to

333
00:11:55,610 --> 00:11:59,630
do password hashing which generally we

334
00:11:57,620 --> 00:12:01,700
think is a good idea but you have to

335
00:11:59,630 --> 00:12:03,140
understand the implications of what that

336
00:12:01,700 --> 00:12:05,450
means and what those rights are that are

337
00:12:03,140 --> 00:12:07,220
required for it an ID ridi Connect is

338
00:12:05,450 --> 00:12:10,160
not the only system that would send

339
00:12:07,220 --> 00:12:12,020
password hashes in this case hash of the

340
00:12:10,160 --> 00:12:13,730
hash but there are other systems that

341
00:12:12,020 --> 00:12:15,920
may send the password hash from AV

342
00:12:13,730 --> 00:12:17,810
directly to the cloud system so you want

343
00:12:15,920 --> 00:12:19,189
to be aware of those but let's take a

344
00:12:17,810 --> 00:12:21,199
look at what we can do to attack and

345
00:12:19,190 --> 00:12:23,720
Azure ad Connect system that has used

346
00:12:21,200 --> 00:12:25,010
the Express install it's going to have

347
00:12:23,720 --> 00:12:27,140
these rights configured it's going to

348
00:12:25,010 --> 00:12:28,550
create automatically an EM sol account

349
00:12:27,140 --> 00:12:30,199
it's going to put all this information

350
00:12:28,550 --> 00:12:32,150
in the description field which is great

351
00:12:30,200 --> 00:12:36,350
for me because then I know what its

352
00:12:32,150 --> 00:12:37,610
installed on then with this I can either

353
00:12:36,350 --> 00:12:38,900
check to see if there's additional

354
00:12:37,610 --> 00:12:41,330
rights that are configured for this

355
00:12:38,900 --> 00:12:43,459
account or I even better if there's not

356
00:12:41,330 --> 00:12:46,910
that information I can use power views

357
00:12:43,460 --> 00:12:48,620
invoke ACL scanner to see it what rights

358
00:12:46,910 --> 00:12:51,319
are actually configured at the domain

359
00:12:48,620 --> 00:12:53,360
root that provide or what accounts have

360
00:12:51,320 --> 00:12:56,180
des replication get changes das

361
00:12:53,360 --> 00:12:58,610
replication get changes all which are

362
00:12:56,180 --> 00:13:00,829
needed for a DC sync for many cats for

363
00:12:58,610 --> 00:13:03,560
an attack but ultimately as your ad can

364
00:13:00,830 --> 00:13:05,660
act would need that so here we see a yes

365
00:13:03,560 --> 00:13:08,089
or it's our MSO account so we're going

366
00:13:05,660 --> 00:13:10,490
to look at our addressing computer

367
00:13:08,089 --> 00:13:12,950
figure out where it is an ad it's in the

368
00:13:10,490 --> 00:13:14,570
root servers oh you so our next step is

369
00:13:12,950 --> 00:13:17,480
to figure out how can we get admin

370
00:13:14,570 --> 00:13:19,370
access to that server in that location

371
00:13:17,480 --> 00:13:21,350
so we use Power View again find GPO

372
00:13:19,370 --> 00:13:23,300
computer admin against that oh you and

373
00:13:21,350 --> 00:13:25,490
we can identify that there's a server

374
00:13:23,300 --> 00:13:28,459
admins group in Active Directory in the

375
00:13:25,490 --> 00:13:30,380
root group so you that is added to the

376
00:13:28,460 --> 00:13:32,540
local administrators group for that oh

377
00:13:30,380 --> 00:13:34,250
you which means that if I can compromise

378
00:13:32,540 --> 00:13:36,740
an account that's in this group I can

379
00:13:34,250 --> 00:13:38,600
control and administer that Adger 80

380
00:13:36,740 --> 00:13:41,060
connect server along with other servers

381
00:13:38,600 --> 00:13:43,040
which could be interesting but there's

382
00:13:41,060 --> 00:13:45,800
also a second GPO they're called server

383
00:13:43,040 --> 00:13:48,560
config and server config I'm not too

384
00:13:45,800 --> 00:13:50,060
concerned about what settings it has I'm

385
00:13:48,560 --> 00:13:52,339
really interested in the delegation

386
00:13:50,060 --> 00:13:53,719
there's three different server tier

387
00:13:52,340 --> 00:13:56,270
groups that are configured to with

388
00:13:53,720 --> 00:13:58,160
modify rights of this GPL it's a little

389
00:13:56,270 --> 00:14:00,189
odd but we see that a lot when we do

390
00:13:58,160 --> 00:14:03,079
security assessments at Trimark and

391
00:14:00,190 --> 00:14:05,030
again all I need to do is compromise one

392
00:14:03,080 --> 00:14:06,920
account that's in one of these groups to

393
00:14:05,030 --> 00:14:10,160
be able to modify this GPO that then

394
00:14:06,920 --> 00:14:12,290
applies to that servers are you so I can

395
00:14:10,160 --> 00:14:13,699
add a member to administrators I can run

396
00:14:12,290 --> 00:14:18,560
code I can pretty much do whatever I

397
00:14:13,700 --> 00:14:19,940
want at that point so this is a slide

398
00:14:18,560 --> 00:14:22,010
that kind of summarizes what I just

399
00:14:19,940 --> 00:14:23,420
talked about the key takeaway here is

400
00:14:22,010 --> 00:14:25,130
that you want to treat your add ready

401
00:14:23,420 --> 00:14:26,630
connect server as if it's a domain

402
00:14:25,130 --> 00:14:29,540
controller especially if it's doing that

403
00:14:26,630 --> 00:14:31,430
password hash thing and any other system

404
00:14:29,540 --> 00:14:33,319
that is doing something similar you want

405
00:14:31,430 --> 00:14:35,449
to protect it very closely because

406
00:14:33,320 --> 00:14:36,590
compromise of a regular server admin

407
00:14:35,450 --> 00:14:38,990
account which may not look that

408
00:14:36,590 --> 00:14:40,940
important could ultimately prove

409
00:14:38,990 --> 00:14:43,790
disastrous and compromise your on-prem

410
00:14:40,940 --> 00:14:45,560
ad environment so we're pretty well

411
00:14:43,790 --> 00:14:47,510
understood about how the on-prem ad

412
00:14:45,560 --> 00:14:50,030
works are for recon of that ad

413
00:14:47,510 --> 00:14:51,710
environment you have an ad account you

414
00:14:50,030 --> 00:14:53,930
can look at users you can enumerate

415
00:14:51,710 --> 00:14:55,100
group membership typically everything as

416
00:14:53,930 --> 00:14:57,439
long as you can connect to a domain

417
00:14:55,100 --> 00:14:59,090
controller in that domain as your ad is

418
00:14:57,440 --> 00:15:00,890
a little bit different it's the same you

419
00:14:59,090 --> 00:15:02,750
need a Adger ad user account

420
00:15:00,890 --> 00:15:04,400
but now you don't need to be on prep you

421
00:15:02,750 --> 00:15:06,770
just need to be able to connect to an

422
00:15:04,400 --> 00:15:09,920
office 365 service which usually means

423
00:15:06,770 --> 00:15:12,439
the entire internet also very

424
00:15:09,920 --> 00:15:16,069
interesting is we can also ideally

425
00:15:12,440 --> 00:15:19,160
identify email addresses for that tenant

426
00:15:16,070 --> 00:15:22,460
or within a sure ad without having an

427
00:15:19,160 --> 00:15:25,370
account in the first place so office 365

428
00:15:22,460 --> 00:15:27,110
creeper or o365 creeper is a tool that's

429
00:15:25,370 --> 00:15:29,090
very interesting because you give it a

430
00:15:27,110 --> 00:15:30,780
list of email addresses and it will

431
00:15:29,090 --> 00:15:32,970
attempt to authenticate

432
00:15:30,780 --> 00:15:35,040
the office365 authentication page and

433
00:15:32,970 --> 00:15:37,980
based on the result code will say this

434
00:15:35,040 --> 00:15:40,170
is valid or this is not valid so simply

435
00:15:37,980 --> 00:15:41,850
by doing this we can identify what email

436
00:15:40,170 --> 00:15:43,740
accounts are valid logins for that a

437
00:15:41,850 --> 00:15:45,750
charade the environment and then the

438
00:15:43,740 --> 00:15:47,640
last three that are here enable us to do

439
00:15:45,750 --> 00:15:49,800
some user and group enumeration once we

440
00:15:47,640 --> 00:15:51,930
have a valid user name and password for

441
00:15:49,800 --> 00:15:53,250
that environment because of course once

442
00:15:51,930 --> 00:15:54,750
we have a user list we'll do something

443
00:15:53,250 --> 00:15:56,310
called password sprang I think most

444
00:15:54,750 --> 00:15:58,440
people here know what that is so I'll

445
00:15:56,310 --> 00:16:00,300
cover it very briefly we have a list of

446
00:15:58,440 --> 00:16:02,130
passwords that we know people tend to

447
00:16:00,300 --> 00:16:03,839
use we're gonna try those against our

448
00:16:02,130 --> 00:16:05,250
user list and then we're going to sleep

449
00:16:03,840 --> 00:16:08,100
for a little while and then we're gonna

450
00:16:05,250 --> 00:16:09,630
try another one and this avoids lockout

451
00:16:08,100 --> 00:16:11,580
because we're trying one password

452
00:16:09,630 --> 00:16:14,250
against all the users and then we wait

453
00:16:11,580 --> 00:16:16,650
before we try the next one but Shawn we

454
00:16:14,250 --> 00:16:21,000
use symbols in our passwords yeah I got

455
00:16:16,650 --> 00:16:22,890
you covered everyone knows this so then

456
00:16:21,000 --> 00:16:24,240
we just continue on and we continue

457
00:16:22,890 --> 00:16:25,410
iterating through this until we get

458
00:16:24,240 --> 00:16:27,960
username and passwords for that

459
00:16:25,410 --> 00:16:29,640
environment here are a bunch of tools

460
00:16:27,960 --> 00:16:32,490
that are available that will do pastors

461
00:16:29,640 --> 00:16:35,130
praying against office 365 this works

462
00:16:32,490 --> 00:16:37,260
because of legacy authentication legacy

463
00:16:35,130 --> 00:16:40,560
means all of the old stuff that is still

464
00:16:37,260 --> 00:16:42,600
in use on the Internet so pop IMAP SMTP

465
00:16:40,560 --> 00:16:44,640
if people are using pop clients like

466
00:16:42,600 --> 00:16:46,110
Thunderbird or if they're using apps on

467
00:16:44,640 --> 00:16:48,780
their phone they're using legacy

468
00:16:46,110 --> 00:16:51,210
authentication but legacy authentication

469
00:16:48,780 --> 00:16:53,640
these old protocols don't support MFA so

470
00:16:51,210 --> 00:16:55,620
even if you've enforced MFA on these

471
00:16:53,640 --> 00:16:57,330
accounts I can still use legacy

472
00:16:55,620 --> 00:16:59,760
authentication to pass or spray these

473
00:16:57,330 --> 00:17:01,350
accounts and authenticate as them so

474
00:16:59,760 --> 00:17:02,850
let's use mail sniper and do some

475
00:17:01,350 --> 00:17:05,220
password spraying against this acne

476
00:17:02,850 --> 00:17:06,839
environment that's in the cloud but they

477
00:17:05,220 --> 00:17:08,160
put a bunch of people in there but

478
00:17:06,839 --> 00:17:10,589
really didn't do a whole lot of security

479
00:17:08,160 --> 00:17:12,839
around it they forgot to disable or

480
00:17:10,589 --> 00:17:15,359
decided not to disable legacy off just

481
00:17:12,839 --> 00:17:17,458
because and we are able to find

482
00:17:15,359 --> 00:17:18,750
passwords for a bunch of users okay

483
00:17:17,459 --> 00:17:21,449
let's put that to the side for right now

484
00:17:18,750 --> 00:17:23,880
and let's focus on how we can detect

485
00:17:21,449 --> 00:17:25,560
this well unfortunately by default in

486
00:17:23,880 --> 00:17:27,660
order to look at these as rating sign-in

487
00:17:25,560 --> 00:17:30,690
logs we need to have an azure ad premium

488
00:17:27,660 --> 00:17:33,120
subscription which i think is not a

489
00:17:30,690 --> 00:17:35,040
great solution so Microsoft is actually

490
00:17:33,120 --> 00:17:36,270
going to be changing this soon you'll be

491
00:17:35,040 --> 00:17:37,980
able to have access to the azure ad

492
00:17:36,270 --> 00:17:40,040
sign-in logs without requiring the

493
00:17:37,980 --> 00:17:42,450
subscriptions the subscription will

494
00:17:40,040 --> 00:17:44,030
control what your retention period is

495
00:17:42,450 --> 00:17:45,830
for those logs but

496
00:17:44,030 --> 00:17:48,290
be pulling those logs into a cemani way

497
00:17:45,830 --> 00:17:50,449
so if we look at these logs we can see

498
00:17:48,290 --> 00:17:51,950
that there obviously is a password spray

499
00:17:50,450 --> 00:17:53,570
attack occurring it's coming from a

500
00:17:51,950 --> 00:17:55,280
single IP address attemping

501
00:17:53,570 --> 00:17:57,439
authentication of a bunch of different

502
00:17:55,280 --> 00:17:59,629
users in a row and so we see that

503
00:17:57,440 --> 00:18:02,390
there's a specific user bobba fett whose

504
00:17:59,630 --> 00:18:05,350
account is fail fail fail and then

505
00:18:02,390 --> 00:18:07,640
success probably a password sprite

506
00:18:05,350 --> 00:18:08,780
okay so that's nice to look at visually

507
00:18:07,640 --> 00:18:10,400
but what if they're doing some other

508
00:18:08,780 --> 00:18:12,710
interesting thing around that we need to

509
00:18:10,400 --> 00:18:15,110
dig into the details a bit more well we

510
00:18:12,710 --> 00:18:18,530
can look at the sign-in error code 501

511
00:18:15,110 --> 00:18:20,360
to 6 and the client app as all other

512
00:18:18,530 --> 00:18:22,370
clients older office clients

513
00:18:20,360 --> 00:18:23,899
this means legacy authentication so we

514
00:18:22,370 --> 00:18:26,239
can build a password sprang rule around

515
00:18:23,900 --> 00:18:29,000
this now keep in mind what I just did

516
00:18:26,240 --> 00:18:31,190
was i password sprayed office 365 as

517
00:18:29,000 --> 00:18:33,650
your ad so that means if the

518
00:18:31,190 --> 00:18:34,850
organization is federated these logs are

519
00:18:33,650 --> 00:18:36,620
not going to be there they're going to

520
00:18:34,850 --> 00:18:38,659
be on there Federation system so if you

521
00:18:36,620 --> 00:18:39,949
have a DFS those logs are going to be

522
00:18:38,660 --> 00:18:41,660
there so that's where you have to look

523
00:18:39,950 --> 00:18:44,060
to figure out what the passer spraying

524
00:18:41,660 --> 00:18:45,350
is if it's occurring and mark has some

525
00:18:44,060 --> 00:18:48,409
in more information about that when he

526
00:18:45,350 --> 00:18:50,600
covers defense shortly so a year ago I

527
00:18:48,410 --> 00:18:52,370
talked about attacking ad administration

528
00:18:50,600 --> 00:18:54,139
on how to fix it so let's talk a little

529
00:18:52,370 --> 00:18:55,489
bit about our cloud administration and

530
00:18:54,140 --> 00:18:58,130
the potential problems with how it's

531
00:18:55,490 --> 00:18:59,870
being done today Active Directory well

532
00:18:58,130 --> 00:19:02,300
known how to administer we have an MMC

533
00:18:59,870 --> 00:19:04,159
but now we shift over to this Azure ad

534
00:19:02,300 --> 00:19:05,960
world where we have to use a web portal

535
00:19:04,160 --> 00:19:07,340
or PowerShell it's very different

536
00:19:05,960 --> 00:19:10,610
it means we're using a web browser now

537
00:19:07,340 --> 00:19:12,139
and not the NCC client MMC client we

538
00:19:10,610 --> 00:19:14,449
have a bunch of global admins for some

539
00:19:12,140 --> 00:19:15,890
reason Acme is added a bunch of people

540
00:19:14,450 --> 00:19:18,110
to global admins which isn't the best

541
00:19:15,890 --> 00:19:19,400
idea but a lot of times organizations

542
00:19:18,110 --> 00:19:21,620
when they're going into the cloud they

543
00:19:19,400 --> 00:19:24,020
just put everyone in global admins but

544
00:19:21,620 --> 00:19:26,750
global admins in Azure ad pretty much

545
00:19:24,020 --> 00:19:28,580
has as much if not more rights than what

546
00:19:26,750 --> 00:19:31,640
Enterprise admins domain admins

547
00:19:28,580 --> 00:19:34,399
administrators schema admins etc has an

548
00:19:31,640 --> 00:19:36,050
ad it controls the subscription so it's

549
00:19:34,400 --> 00:19:38,150
very powerful so you really want to pull

550
00:19:36,050 --> 00:19:40,070
people out of that if possible because

551
00:19:38,150 --> 00:19:41,600
you don't want a situation where like

552
00:19:40,070 --> 00:19:44,210
acne there's people that shouldn't be

553
00:19:41,600 --> 00:19:45,860
there and have bad passwords so the

554
00:19:44,210 --> 00:19:47,510
password spray that I just did I found

555
00:19:45,860 --> 00:19:49,159
that there's two passwords associated

556
00:19:47,510 --> 00:19:50,750
with these user accounts and their

557
00:19:49,160 --> 00:19:53,210
global admin so now I own this

558
00:19:50,750 --> 00:19:54,560
environment probably but let's say if

559
00:19:53,210 --> 00:19:56,400
this didn't work let's say that you they

560
00:19:54,560 --> 00:20:00,240
use pretty good passwords

561
00:19:56,400 --> 00:20:01,140
maybe like that would happen and so I go

562
00:20:00,240 --> 00:20:02,850
ahead and do a fish

563
00:20:01,140 --> 00:20:04,350
well bleeping computer a couple weeks

564
00:20:02,850 --> 00:20:06,480
ago had a really interesting article

565
00:20:04,350 --> 00:20:08,760
about fishing against officer 65 and

566
00:20:06,480 --> 00:20:11,310
what I find really fascinating about

567
00:20:08,760 --> 00:20:13,770
this fish is that it says your office

568
00:20:11,310 --> 00:20:16,260
365 licenses expired update your payment

569
00:20:13,770 --> 00:20:19,830
now or you'll be cut off no one will

570
00:20:16,260 --> 00:20:23,400
have email anymore call to action very

571
00:20:19,830 --> 00:20:26,070
likely and admins gonna click on this so

572
00:20:23,400 --> 00:20:27,690
I'm very happy to be able to state as a

573
00:20:26,070 --> 00:20:30,300
person that doesn't work at Microsoft

574
00:20:27,690 --> 00:20:32,340
that Microsoft has a private preview

575
00:20:30,300 --> 00:20:34,080
going on for a roll called global reader

576
00:20:32,340 --> 00:20:36,689
I'm really excited about this because

577
00:20:34,080 --> 00:20:38,790
this provides read access to all of the

578
00:20:36,690 --> 00:20:41,250
office 365 services and their

579
00:20:38,790 --> 00:20:43,980
configuration information with no admin

580
00:20:41,250 --> 00:20:46,650
or modify rights this has been sorely

581
00:20:43,980 --> 00:20:49,350
lacking in office 465 for too long and

582
00:20:46,650 --> 00:20:53,550
now it's there or at least it will be

583
00:20:49,350 --> 00:20:54,659
soon talk to Microsoft your tan so what

584
00:20:53,550 --> 00:20:56,879
this means is you can get these people

585
00:20:54,660 --> 00:20:58,680
out of global admin because they just

586
00:20:56,880 --> 00:21:00,090
need to look at config info you can pull

587
00:20:58,680 --> 00:21:01,500
these service counts out that may be

588
00:21:00,090 --> 00:21:04,590
running PowerShell scripts are doing

589
00:21:01,500 --> 00:21:06,810
reporting and add them into global ad I

590
00:21:04,590 --> 00:21:08,610
saw a global reader it's still being

591
00:21:06,810 --> 00:21:11,460
expanded to cover all the office 365

592
00:21:08,610 --> 00:21:14,310
services to support read only only read

593
00:21:11,460 --> 00:21:15,780
only only yeah sounds good there is an

594
00:21:14,310 --> 00:21:17,460
article here at the bottom that I link

595
00:21:15,780 --> 00:21:19,200
it's included in the slides it has more

596
00:21:17,460 --> 00:21:20,430
information about global reader and why

597
00:21:19,200 --> 00:21:22,140
it's going to be more helpful than just

598
00:21:20,430 --> 00:21:23,940
security reader the security reader

599
00:21:22,140 --> 00:21:27,020
doesn't give you read only configuration

600
00:21:23,940 --> 00:21:29,160
information for a number of the services

601
00:21:27,020 --> 00:21:30,660
so let's look at this cloud

602
00:21:29,160 --> 00:21:32,760
administration thing and how we can go

603
00:21:30,660 --> 00:21:34,460
after that well we have our workstation

604
00:21:32,760 --> 00:21:37,590
well we've talked about that before

605
00:21:34,460 --> 00:21:39,150
compromised and admin in a group that

606
00:21:37,590 --> 00:21:41,639
has admin rights on a workstation

607
00:21:39,150 --> 00:21:44,090
compromised the agent compromised the

608
00:21:41,640 --> 00:21:47,700
management system compromised the

609
00:21:44,090 --> 00:21:50,129
traffic HTTP hopefully HTTPS traffic to

610
00:21:47,700 --> 00:21:52,800
the cloud website we influence that

611
00:21:50,130 --> 00:21:54,660
traffic through DNS if we can get

612
00:21:52,800 --> 00:21:57,149
control of DNS maybe for some reason

613
00:21:54,660 --> 00:21:59,280
there's a 300 people indecent DNS admins

614
00:21:57,150 --> 00:22:00,990
and we can modify the DNS record and

615
00:21:59,280 --> 00:22:03,240
point them to somewhere else maybe we

616
00:22:00,990 --> 00:22:04,980
could get our admin to connect to our

617
00:22:03,240 --> 00:22:07,590
system instead of the microsoft system

618
00:22:04,980 --> 00:22:09,990
or the AWS system and then there's the

619
00:22:07,590 --> 00:22:10,139
web browser so in cloud administration

620
00:22:09,990 --> 00:22:12,060
the

621
00:22:10,140 --> 00:22:14,220
web-browser in what stores that token

622
00:22:12,060 --> 00:22:17,429
the proof of identity to the cloud

623
00:22:14,220 --> 00:22:19,740
environment and so what's interesting is

624
00:22:17,430 --> 00:22:21,450
Google Chrome is one of the most popular

625
00:22:19,740 --> 00:22:23,910
browsers in the enterprise because they

626
00:22:21,450 --> 00:22:26,760
provide group policy management so as an

627
00:22:23,910 --> 00:22:28,590
attacker if I can find a way to modify

628
00:22:26,760 --> 00:22:30,810
that group policy that controls Google

629
00:22:28,590 --> 00:22:35,909
Chrome and force install an extension

630
00:22:30,810 --> 00:22:38,750
that is well safe malicious that enables

631
00:22:35,910 --> 00:22:41,310
me to potentially split out that session

632
00:22:38,750 --> 00:22:43,530
where I can do something while the admin

633
00:22:41,310 --> 00:22:45,510
is still logged in to that in that

634
00:22:43,530 --> 00:22:48,210
environment or even extract that token

635
00:22:45,510 --> 00:22:50,490
and reuse it somewhere else that could

636
00:22:48,210 --> 00:22:51,990
be pretty interesting and certainly if

637
00:22:50,490 --> 00:22:54,510
I'm going to do something like that I

638
00:22:51,990 --> 00:22:58,350
wouldn't put a very obvious icon on the

639
00:22:54,510 --> 00:23:00,330
browser I could just hide it the other

640
00:22:58,350 --> 00:23:02,520
thing that's popular in enterprises is

641
00:23:00,330 --> 00:23:04,560
the SSL TLS decryption of Isis has been

642
00:23:02,520 --> 00:23:08,070
pretty standard recommendation since

643
00:23:04,560 --> 00:23:09,929
every website is encrypted now well what

644
00:23:08,070 --> 00:23:11,820
they do is they break the authentication

645
00:23:09,930 --> 00:23:14,580
they break that web traffic that SSL

646
00:23:11,820 --> 00:23:17,129
session TLS session from the web browser

647
00:23:14,580 --> 00:23:18,629
to the decryption device open it up look

648
00:23:17,130 --> 00:23:20,580
at all that traffic and then create a

649
00:23:18,630 --> 00:23:23,340
new one to the actual cloud website and

650
00:23:20,580 --> 00:23:25,590
then breaks the response back in order

651
00:23:23,340 --> 00:23:27,600
to send that back and forth that means

652
00:23:25,590 --> 00:23:29,159
that if this site is not whitelisted so

653
00:23:27,600 --> 00:23:31,800
that the decryption device doesn't open

654
00:23:29,160 --> 00:23:33,570
it the token could be stolen if the

655
00:23:31,800 --> 00:23:36,120
attacker is able to actually compromise

656
00:23:33,570 --> 00:23:37,560
that device the attacker could also

657
00:23:36,120 --> 00:23:39,090
change that whitelisting rule so you

658
00:23:37,560 --> 00:23:40,590
want to protect your decryption devices

659
00:23:39,090 --> 00:23:41,669
and that system to make sure that

660
00:23:40,590 --> 00:23:43,919
someone doesn't have access to it

661
00:23:41,670 --> 00:23:46,470
otherwise they could impersonate your

662
00:23:43,920 --> 00:23:49,290
director of HR they can impersonate your

663
00:23:46,470 --> 00:23:52,110
cloud admin and then it gets interesting

664
00:23:49,290 --> 00:23:54,720
because if somebody could fish the admin

665
00:23:52,110 --> 00:23:57,689
they could get them to go to the

666
00:23:54,720 --> 00:23:59,670
attackers evil proxy something like evil

667
00:23:57,690 --> 00:24:02,940
Gen X or something along those lines or

668
00:23:59,670 --> 00:24:04,230
if I can influence them to go to a

669
00:24:02,940 --> 00:24:05,820
different site and make it look like

670
00:24:04,230 --> 00:24:07,410
it's actually the Microsoft site or some

671
00:24:05,820 --> 00:24:09,419
other site I can proxy that

672
00:24:07,410 --> 00:24:11,970
authentication through my evil proxy and

673
00:24:09,420 --> 00:24:15,420
even if MFA is enabled I just show the

674
00:24:11,970 --> 00:24:17,910
user the MFA prompt the other thing

675
00:24:15,420 --> 00:24:19,830
that's interesting is another common

676
00:24:17,910 --> 00:24:21,930
attack is the password reuse replay

677
00:24:19,830 --> 00:24:23,189
we're usually search on Twitter or it's

678
00:24:21,930 --> 00:24:23,850
like hey there might be some stolen

679
00:24:23,190 --> 00:24:25,460
passwords

680
00:24:23,850 --> 00:24:27,928
then like a week later this shows up

681
00:24:25,460 --> 00:24:31,500
password um with something like a sha-1

682
00:24:27,929 --> 00:24:33,179
or clear text passwords we control this

683
00:24:31,500 --> 00:24:35,700
looking for the email addresses for the

684
00:24:33,179 --> 00:24:37,830
users in Acme and see what we can find

685
00:24:35,700 --> 00:24:39,630
and if we find a password for a user

686
00:24:37,830 --> 00:24:41,970
attacked me we can try that against the

687
00:24:39,630 --> 00:24:44,250
acne environment very likely it's going

688
00:24:41,970 --> 00:24:46,260
to work we can also look at the other

689
00:24:44,250 --> 00:24:48,090
passwords at then that's in that dump

690
00:24:46,260 --> 00:24:50,309
try those as part of our pasture

691
00:24:48,090 --> 00:24:51,720
spraying or in a situation where someone

692
00:24:50,309 --> 00:24:53,850
has a unique name that we noticed in

693
00:24:51,720 --> 00:24:55,140
acne we saw in the password breach even

694
00:24:53,850 --> 00:24:58,620
if it's a different email address it

695
00:24:55,140 --> 00:25:00,120
might have the same password so one of

696
00:24:58,620 --> 00:25:02,100
the ways to detect this have I been

697
00:25:00,120 --> 00:25:04,979
poned domain notification or the

698
00:25:02,100 --> 00:25:06,840
password hash sync for the marks going

699
00:25:04,980 --> 00:25:08,070
to talk about in a bit is going to

700
00:25:06,840 --> 00:25:09,959
provide this users with leaked

701
00:25:08,070 --> 00:25:12,960
credential report where you can look to

702
00:25:09,960 --> 00:25:15,090
see where these breaches have users with

703
00:25:12,960 --> 00:25:16,350
your email address in it and the last

704
00:25:15,090 --> 00:25:19,020
thing I want to talk about as far as

705
00:25:16,350 --> 00:25:22,020
this attack goes is illicit a consent

706
00:25:19,020 --> 00:25:24,900
grant attack where attackers are fishing

707
00:25:22,020 --> 00:25:26,940
users so that they can click and approve

708
00:25:24,900 --> 00:25:28,500
an app to have full control of their

709
00:25:26,940 --> 00:25:32,520
actual account their email in their

710
00:25:28,500 --> 00:25:34,140
files and it's not a true valid and then

711
00:25:32,520 --> 00:25:35,820
the second big one I'll mention it a

712
00:25:34,140 --> 00:25:38,490
little bit which is about Enterprise app

713
00:25:35,820 --> 00:25:40,049
permissions there's a couple toolkits

714
00:25:38,490 --> 00:25:43,710
have been released around this first one

715
00:25:40,049 --> 00:25:44,760
from fire I and MD set an MD SEC was

716
00:25:43,710 --> 00:25:46,710
nice enough to have this really nice

717
00:25:44,760 --> 00:25:48,629
write-up with graphic some user graphics

718
00:25:46,710 --> 00:25:50,039
and on the left side there's an

719
00:25:48,630 --> 00:25:51,780
architecture of how this works and how

720
00:25:50,039 --> 00:25:53,760
its configured but really what I care

721
00:25:51,780 --> 00:25:54,990
about is what's on the right this is

722
00:25:53,760 --> 00:25:56,789
what the user sees when they get the

723
00:25:54,990 --> 00:26:00,240
fish and if they're not paying attention

724
00:25:56,789 --> 00:26:02,400
they click accept then this app has full

725
00:26:00,240 --> 00:26:04,770
control of their account their email the

726
00:26:02,400 --> 00:26:06,780
files everything and it's persistent and

727
00:26:04,770 --> 00:26:09,629
the user is likely not going to go back

728
00:26:06,780 --> 00:26:11,970
and look at this this is not a Microsoft

729
00:26:09,630 --> 00:26:15,270
Office 365 thing this is a cloud allah

730
00:26:11,970 --> 00:26:16,770
thing so Trend Micro wrote a really

731
00:26:15,270 --> 00:26:19,320
interesting article about pawn storm

732
00:26:16,770 --> 00:26:22,918
where the attacker was spoofed ours was

733
00:26:19,320 --> 00:26:25,918
fishing Gmail users targeted and saying

734
00:26:22,919 --> 00:26:27,990
install Google defender that sounds like

735
00:26:25,919 --> 00:26:32,100
a thing sure yeah I want defender to

736
00:26:27,990 --> 00:26:34,530
protect my my gmail and my files and of

737
00:26:32,100 --> 00:26:36,510
course by clicking on this allow this

738
00:26:34,530 --> 00:26:37,620
attacker group was able to access the

739
00:26:36,510 --> 00:26:40,280
files and the email

740
00:26:37,620 --> 00:26:43,530
from anywhere through this malicious app

741
00:26:40,280 --> 00:26:45,809
and then the last one I want to talk

742
00:26:43,530 --> 00:26:47,430
about is enterprise app permissions so

743
00:26:45,809 --> 00:26:49,710
let's say that I was able to compromise

744
00:26:47,430 --> 00:26:52,740
and get a global admin account attacked

745
00:26:49,710 --> 00:26:53,850
me I have that account I want to use it

746
00:26:52,740 --> 00:26:55,200
for a short amount of time that I want

747
00:26:53,850 --> 00:26:57,480
to disappear while they're figuring out

748
00:26:55,200 --> 00:26:59,190
all their security stuff well I can

749
00:26:57,480 --> 00:27:00,780
create a malicious app then I'm going to

750
00:26:59,190 --> 00:27:02,430
call something very similar to what many

751
00:27:00,780 --> 00:27:05,309
organizations especially big ones will

752
00:27:02,430 --> 00:27:07,110
probably have but I made it out and this

753
00:27:05,309 --> 00:27:09,330
is a great persistence method because as

754
00:27:07,110 --> 00:27:10,979
long as I've created it I have an

755
00:27:09,330 --> 00:27:13,439
account in the environment that has

756
00:27:10,980 --> 00:27:15,540
owner rights to it I have some control

757
00:27:13,440 --> 00:27:17,429
of this app and all of the permissions

758
00:27:15,540 --> 00:27:18,570
that are associated with it once you're

759
00:27:17,429 --> 00:27:20,400
approved they persist in that

760
00:27:18,570 --> 00:27:23,189
environment this is why it's important

761
00:27:20,400 --> 00:27:24,900
for mobile admins or admins in a cloud

762
00:27:23,190 --> 00:27:26,190
environment to really review the

763
00:27:24,900 --> 00:27:28,170
enterprise applications and what

764
00:27:26,190 --> 00:27:29,700
permissions are requesting because very

765
00:27:28,170 --> 00:27:31,080
much like your phone you don't want to

766
00:27:29,700 --> 00:27:33,570
be in a situation where they have

767
00:27:31,080 --> 00:27:37,889
tremendous rights that aren't reviewed

768
00:27:33,570 --> 00:27:39,320
or checked for security issues so let's

769
00:27:37,890 --> 00:27:43,740
talk to the fence

770
00:27:39,320 --> 00:27:45,899
all right thanks Sean for that so just

771
00:27:43,740 --> 00:27:47,670
to kind of recap Sean talked really

772
00:27:45,900 --> 00:27:49,380
about six different types attacks right

773
00:27:47,670 --> 00:27:50,790
from consented views from breach replay

774
00:27:49,380 --> 00:27:51,960
to passwords great but I thought before

775
00:27:50,790 --> 00:27:53,940
we get into this this would be a good

776
00:27:51,960 --> 00:27:55,200
time to check in and how that acne

777
00:27:53,940 --> 00:27:57,990
project team is feeling after listened

778
00:27:55,200 --> 00:27:59,300
to Sean talk for about 20-25 minutes so

779
00:27:57,990 --> 00:28:01,980
the feel is like everything is on fire

780
00:27:59,300 --> 00:28:03,300
but this is going to be fine because it

781
00:28:01,980 --> 00:28:05,160
taught the things that Sean talked about

782
00:28:03,300 --> 00:28:06,270
a hypothetical nature I have some good

783
00:28:05,160 --> 00:28:08,580
news for you and I have some bad news

784
00:28:06,270 --> 00:28:10,410
the bad news is the three most common

785
00:28:08,580 --> 00:28:12,928
attacks we see at Microsoft are breach

786
00:28:10,410 --> 00:28:14,610
replay phishing and password spray but

787
00:28:12,929 --> 00:28:16,140
the good news is there's lots of really

788
00:28:14,610 --> 00:28:17,100
good fundamental things we can do that

789
00:28:16,140 --> 00:28:18,900
prevent these attacks from happening

790
00:28:17,100 --> 00:28:21,090
altogether or make them much more

791
00:28:18,900 --> 00:28:22,260
difficult to do throughout and Sean kind

792
00:28:21,090 --> 00:28:23,699
of sprinkled around some of these things

793
00:28:22,260 --> 00:28:25,140
throughout his talk and the first one I

794
00:28:23,700 --> 00:28:26,580
want to talk about here is compromising

795
00:28:25,140 --> 00:28:28,830
the ad FS or as your ad connect server

796
00:28:26,580 --> 00:28:30,960
and the key thing here is we want to

797
00:28:28,830 --> 00:28:33,178
treat this like a tier zero resource

798
00:28:30,960 --> 00:28:34,740
it's not news to anybody in this room

799
00:28:33,179 --> 00:28:36,300
I'm assuming that if an attacker gets

800
00:28:34,740 --> 00:28:38,160
onto your domain controller they can do

801
00:28:36,300 --> 00:28:40,290
horrible terrible things to your

802
00:28:38,160 --> 00:28:42,480
environment the same is true for a JD

803
00:28:40,290 --> 00:28:43,889
connect or whatever Federation service

804
00:28:42,480 --> 00:28:45,240
you're using like ping federate or a TFS

805
00:28:43,890 --> 00:28:47,580
the same is true for that we want to

806
00:28:45,240 --> 00:28:48,929
treat these like a tier zero resource

807
00:28:47,580 --> 00:28:50,110
you want to protect them like we protect

808
00:28:48,929 --> 00:28:52,000
don't make

809
00:28:50,110 --> 00:28:54,399
okay so let's take a look at another one

810
00:28:52,000 --> 00:28:56,200
so admin account takeover the first

811
00:28:54,400 --> 00:28:58,270
thing that everyone should be doing to

812
00:28:56,200 --> 00:29:01,510
protect their admin accounts is to turn

813
00:28:58,270 --> 00:29:02,590
on MFA for your admin accounts you're

814
00:29:01,510 --> 00:29:05,320
probably thinking why are you talking

815
00:29:02,590 --> 00:29:06,580
about this this seems pretty basic and I

816
00:29:05,320 --> 00:29:07,750
agree with you you're right I shouldn't

817
00:29:06,580 --> 00:29:10,510
have to keep talking about it but

818
00:29:07,750 --> 00:29:12,160
unfortunately we do so in the September

819
00:29:10,510 --> 00:29:13,420
of 2017 at our Microsoft ignite

820
00:29:12,160 --> 00:29:17,260
conference we look to see how many

821
00:29:13,420 --> 00:29:19,180
global admins had mfa enabled who things

822
00:29:17,260 --> 00:29:20,860
like give me a percentage you guess how

823
00:29:19,180 --> 00:29:23,470
many global admins have meme' fed just

824
00:29:20,860 --> 00:29:25,949
shout out to shout it out 50 percent

825
00:29:23,470 --> 00:29:30,130
that's pretty close it was actually 0.7

826
00:29:25,950 --> 00:29:31,930
so just like a little little off so we

827
00:29:30,130 --> 00:29:34,420
talked about it well like please go back

828
00:29:31,930 --> 00:29:36,220
and do this so ignite happen the same

829
00:29:34,420 --> 00:29:41,410
time next year September 2018 what do we

830
00:29:36,220 --> 00:29:42,790
think 2% at now another 50% you have way

831
00:29:41,410 --> 00:29:48,580
more faith in your fellow admins than I

832
00:29:42,790 --> 00:29:50,470
do we're at 21.7% right so I means 98%

833
00:29:48,580 --> 00:29:52,629
of admins global admins do not have MFA

834
00:29:50,470 --> 00:29:54,430
enabled so I asked our awesome data

835
00:29:52,630 --> 00:29:55,510
science team can you pull numbers for

836
00:29:54,430 --> 00:29:57,520
this talk specifically to have some

837
00:29:55,510 --> 00:30:01,990
fresh data for you and we are up to

838
00:29:57,520 --> 00:30:03,520
almost 8% yeah right don't clap that

839
00:30:01,990 --> 00:30:05,710
that's 92% they don't have it that's

840
00:30:03,520 --> 00:30:09,220
terrible that's terrible

841
00:30:05,710 --> 00:30:11,650
okay god all right stay with me okay so

842
00:30:09,220 --> 00:30:13,000
I don't get why we're not doing this but

843
00:30:11,650 --> 00:30:14,980
this is one of the best things that you

844
00:30:13,000 --> 00:30:16,090
can do to protect yourself so how can

845
00:30:14,980 --> 00:30:18,940
you go back and do this if you take one

846
00:30:16,090 --> 00:30:21,429
thing away from this talk do this go to

847
00:30:18,940 --> 00:30:23,590
your admin and click enable MFA that's

848
00:30:21,430 --> 00:30:25,510
all you got to do one thing it's so

849
00:30:23,590 --> 00:30:26,800
basic okay and the issue with this

850
00:30:25,510 --> 00:30:28,720
though is you have to remember to keep

851
00:30:26,800 --> 00:30:31,060
doing this for any people that get added

852
00:30:28,720 --> 00:30:32,920
to these admin roles so the better thing

853
00:30:31,060 --> 00:30:34,810
you can do is use conditional access or

854
00:30:32,920 --> 00:30:36,490
our baseline policies for admins which

855
00:30:34,810 --> 00:30:37,990
are in public preview this will apply

856
00:30:36,490 --> 00:30:40,600
imma fake to anyone that has that rule

857
00:30:37,990 --> 00:30:41,740
going forward on the baseline policies

858
00:30:40,600 --> 00:30:43,570
like I said are in public preview they

859
00:30:41,740 --> 00:30:44,500
are gonna change a little bit based on

860
00:30:43,570 --> 00:30:45,879
some feedback we've gotten from some

861
00:30:44,500 --> 00:30:47,740
customers already but take a look at

862
00:30:45,880 --> 00:30:49,450
that but the best thing you can do and

863
00:30:47,740 --> 00:30:51,160
Shaun kind of alluded to a little bit is

864
00:30:49,450 --> 00:30:54,070
use a feature we have called add ready

865
00:30:51,160 --> 00:30:56,290
privileged Identity Management this

866
00:30:54,070 --> 00:30:57,850
removes all standing admin access in

867
00:30:56,290 --> 00:30:59,800
order to do anything with admin rights

868
00:30:57,850 --> 00:31:01,600
you have to elevate yourself and do MFA

869
00:30:59,800 --> 00:31:03,040
and you can also build some workflows

870
00:31:01,600 --> 00:31:03,500
around this to say maybe to other global

871
00:31:03,040 --> 00:31:05,570
admins

872
00:31:03,500 --> 00:31:06,860
have to approve it you can do as part of

873
00:31:05,570 --> 00:31:08,540
a workflow if your change management

874
00:31:06,860 --> 00:31:10,729
that they can't elevate until like the

875
00:31:08,540 --> 00:31:12,230
change management window and because Tim

876
00:31:10,730 --> 00:31:14,060
becomes this admin Center for all of

877
00:31:12,230 --> 00:31:15,680
your management team will notify you

878
00:31:14,060 --> 00:31:18,530
when people are being added to roles

879
00:31:15,680 --> 00:31:20,180
outside of PIM and some of my customers

880
00:31:18,530 --> 00:31:22,070
have found some very interesting things

881
00:31:20,180 --> 00:31:23,600
in their environment this way and pin

882
00:31:22,070 --> 00:31:26,060
works great for a Dre B as well as

883
00:31:23,600 --> 00:31:27,740
office 365 but it also works for Azure

884
00:31:26,060 --> 00:31:29,510
resources so the people that have

885
00:31:27,740 --> 00:31:31,220
hyperedge accounts to VMs and things

886
00:31:29,510 --> 00:31:34,370
like that you can have them use pin as

887
00:31:31,220 --> 00:31:36,320
well and this is a p2 license

888
00:31:34,370 --> 00:31:37,969
requirement so like Acme they can't buy

889
00:31:36,320 --> 00:31:39,980
p2 licenses for five hundred thousand

890
00:31:37,970 --> 00:31:42,350
people to start with but you can buy p2

891
00:31:39,980 --> 00:31:44,690
for your admins so Acme can buy those

892
00:31:42,350 --> 00:31:46,610
thirty or forty or fifty admins p2

893
00:31:44,690 --> 00:31:47,990
licenses and start using it and to

894
00:31:46,610 --> 00:31:51,860
deploy PIM it's pretty straightforward

895
00:31:47,990 --> 00:31:53,480
if you go to aka.ms/offweb apply lots of

896
00:31:51,860 --> 00:31:55,850
azure ad features like SAS apps

897
00:31:53,480 --> 00:31:58,700
conditional access MFA but we have one

898
00:31:55,850 --> 00:32:00,409
for pin as well now forward thinking for

899
00:31:58,700 --> 00:32:02,210
your admins you want to start looking

900
00:32:00,410 --> 00:32:03,470
into Fido to Fido to is a

901
00:32:02,210 --> 00:32:05,030
standards-based password with

902
00:32:03,470 --> 00:32:07,910
authentication that's made up of two

903
00:32:05,030 --> 00:32:09,290
parts web off N and C tap I don't have

904
00:32:07,910 --> 00:32:10,640
enough time in the session to go over

905
00:32:09,290 --> 00:32:12,020
and vital to I believe there's a web off

906
00:32:10,640 --> 00:32:13,790
end session tomorrow morning if you're

907
00:32:12,020 --> 00:32:15,200
not familiar with this check it out but

908
00:32:13,790 --> 00:32:16,909
the high level is it's a public private

909
00:32:15,200 --> 00:32:18,710
key the private key is stored on the

910
00:32:16,910 --> 00:32:20,480
device you have to do some sort of like

911
00:32:18,710 --> 00:32:22,190
proof of president's either biometric or

912
00:32:20,480 --> 00:32:24,080
pin but the reason you want to do this

913
00:32:22,190 --> 00:32:25,130
is this is an extremely strong factor of

914
00:32:24,080 --> 00:32:26,659
authentication that make some of the

915
00:32:25,130 --> 00:32:28,760
attacks that Shawn showed you either

916
00:32:26,660 --> 00:32:30,470
impossible or much harder to complete

917
00:32:28,760 --> 00:32:32,720
and this is really exciting because you

918
00:32:30,470 --> 00:32:34,730
can actually go do this today and add

919
00:32:32,720 --> 00:32:36,350
your Active Directory so we just want

920
00:32:34,730 --> 00:32:38,060
public key with this a few weeks ago it

921
00:32:36,350 --> 00:32:39,620
works for your global admins as well as

922
00:32:38,060 --> 00:32:41,720
your authentication admins those are the

923
00:32:39,620 --> 00:32:43,669
people that control MFA you can scope

924
00:32:41,720 --> 00:32:46,370
this roll out to your users in groups

925
00:32:43,670 --> 00:32:47,960
and if you go to 8 KMS slash file to

926
00:32:46,370 --> 00:32:49,669
Doc's we cover more that stuff there and

927
00:32:47,960 --> 00:32:51,170
you can try this out go back and try

928
00:32:49,670 --> 00:32:54,170
this on your test everybody has a test

929
00:32:51,170 --> 00:32:56,570
tenant right the silence is just

930
00:32:54,170 --> 00:32:58,130
deafening okay we'll do it we'll do a

931
00:32:56,570 --> 00:33:00,050
live will do it in fraud right so try

932
00:32:58,130 --> 00:33:01,750
with a few counts

933
00:33:00,050 --> 00:33:04,430
we'll do a lot all right windows 10

934
00:33:01,750 --> 00:33:06,890
19:03 for your best experience on the

935
00:33:04,430 --> 00:33:09,950
works with edge and Firefox version 67

936
00:33:06,890 --> 00:33:13,010
and later all right the next thing Sean

937
00:33:09,950 --> 00:33:14,720
talked about was app consent so we're

938
00:33:13,010 --> 00:33:15,800
not seeing this attack too much at in

939
00:33:14,720 --> 00:33:16,880
Azure Active Directory but it's

940
00:33:15,800 --> 00:33:18,649
something too good to be taking a look

941
00:33:16,880 --> 00:33:19,700
at so how do I get to this in Azure

942
00:33:18,650 --> 00:33:21,530
Active Directory if you go to enterprise

943
00:33:19,700 --> 00:33:23,090
apps you click on the application you

944
00:33:21,530 --> 00:33:24,710
click permissions and you get to see all

945
00:33:23,090 --> 00:33:26,060
the permissions that the applications

946
00:33:24,710 --> 00:33:28,550
requiring and we can see here under

947
00:33:26,060 --> 00:33:29,600
admin consent and admin has consented to

948
00:33:28,550 --> 00:33:31,399
this application these are the

949
00:33:29,600 --> 00:33:32,899
permissions the application needs and we

950
00:33:31,400 --> 00:33:35,480
also will give you a permission level

951
00:33:32,900 --> 00:33:37,370
from low medium to high how like wide

952
00:33:35,480 --> 00:33:38,840
that permission is if you click on any

953
00:33:37,370 --> 00:33:40,399
of those we will tell you what that

954
00:33:38,840 --> 00:33:42,530
permission actually does that's when

955
00:33:40,400 --> 00:33:44,900
admin can send perspectives from a user

956
00:33:42,530 --> 00:33:46,220
can spend perspective if you click on

957
00:33:44,900 --> 00:33:48,290
that it will show you the same similar

958
00:33:46,220 --> 00:33:51,020
thing but you can see which users have

959
00:33:48,290 --> 00:33:52,250
consented to that application which is

960
00:33:51,020 --> 00:33:54,020
really pretty nice thing to look take a

961
00:33:52,250 --> 00:33:55,730
look at now some of my customers have

962
00:33:54,020 --> 00:33:56,930
like fifty a hundred I have a couple of

963
00:33:55,730 --> 00:33:58,580
customers that have over a thousand apps

964
00:33:56,930 --> 00:34:00,050
and Active Directory they can't be

965
00:33:58,580 --> 00:34:02,899
clicking through all this so we actually

966
00:34:00,050 --> 00:34:04,909
have a PowerShell script that will help

967
00:34:02,900 --> 00:34:06,890
you with this so this is written by

968
00:34:04,910 --> 00:34:08,450
Philippe he's a feature PM in Azure

969
00:34:06,890 --> 00:34:09,560
Active Directory team and we're trying

970
00:34:08,449 --> 00:34:10,759
to do a lot more work in this area to

971
00:34:09,560 --> 00:34:12,980
make this easier for everybody else but

972
00:34:10,760 --> 00:34:14,300
run this PowerShell script take a look

973
00:34:12,980 --> 00:34:15,409
at what the application permissions are

974
00:34:14,300 --> 00:34:17,480
and you want to look for things like

975
00:34:15,409 --> 00:34:19,399
Sean showed you earlier like anything

976
00:34:17,480 --> 00:34:20,510
has directory read/write all or any

977
00:34:19,399 --> 00:34:21,949
rewrite all that looks kind of

978
00:34:20,510 --> 00:34:23,990
suspicious we want to make sure we know

979
00:34:21,949 --> 00:34:25,699
what that is anything with like a kind

980
00:34:23,989 --> 00:34:28,219
of a weird name like Sean showed you

981
00:34:25,699 --> 00:34:30,439
like Oh Salesforce - looks probably ok

982
00:34:28,219 --> 00:34:32,270
and then anything that an admin has

983
00:34:30,440 --> 00:34:33,620
consented to we want to make sure that

984
00:34:32,270 --> 00:34:34,940
anyone that has consented to that we

985
00:34:33,620 --> 00:34:36,319
know what that application is used for

986
00:34:34,940 --> 00:34:39,770
and the permissions are ok so that's

987
00:34:36,320 --> 00:34:41,360
what we're on do about admin consent the

988
00:34:39,770 --> 00:34:42,949
other thing Sean talked about was breach

989
00:34:41,360 --> 00:34:44,570
replay right we find these clear text

990
00:34:42,949 --> 00:34:45,620
username passwords online and attackers

991
00:34:44,570 --> 00:34:47,990
we're trying to try them against

992
00:34:45,620 --> 00:34:49,520
different services to see if some end

993
00:34:47,989 --> 00:34:51,439
user has reused their credentials which

994
00:34:49,520 --> 00:34:53,090
I'm sure nobody has ever done but the

995
00:34:51,440 --> 00:34:55,070
best thing you can do for this Sean Lu -

996
00:34:53,090 --> 00:34:57,590
is turn on a Grady connect password

997
00:34:55,070 --> 00:34:59,210
hashing you get two big things with this

998
00:34:57,590 --> 00:35:01,250
the first thing you get is that leaked

999
00:34:59,210 --> 00:35:02,900
credential report so we find these clear

1000
00:35:01,250 --> 00:35:04,340
text username passwords we take those

1001
00:35:02,900 --> 00:35:06,500
passwords and we run them through the

1002
00:35:04,340 --> 00:35:07,310
same hashing algorithms as the hashes

1003
00:35:06,500 --> 00:35:07,970
that are stored in Azure Active

1004
00:35:07,310 --> 00:35:10,490
Directory

1005
00:35:07,970 --> 00:35:11,990
if the hashes match that means the same

1006
00:35:10,490 --> 00:35:13,129
username and password is being used

1007
00:35:11,990 --> 00:35:14,270
somewhere on the Internet

1008
00:35:13,130 --> 00:35:15,740
so we will tell you about that it shows

1009
00:35:14,270 --> 00:35:18,140
up as a leaked credential a high risk

1010
00:35:15,740 --> 00:35:20,540
user and if you have identity protection

1011
00:35:18,140 --> 00:35:21,470
you can actually block the user on that

1012
00:35:20,540 --> 00:35:23,270
or put them through a password reset

1013
00:35:21,470 --> 00:35:24,529
flow but that's the big thing you get

1014
00:35:23,270 --> 00:35:25,640
and you want to be taking a look at this

1015
00:35:24,530 --> 00:35:27,410
you want to reset these passwords

1016
00:35:25,640 --> 00:35:29,480
immediately when a leak potential shows

1017
00:35:27,410 --> 00:35:31,520
up but the second thing you get they may

1018
00:35:29,480 --> 00:35:33,350
not be obvious is when something

1019
00:35:31,520 --> 00:35:36,890
catastrophic happens in your environment

1020
00:35:33,350 --> 00:35:38,420
like I wanna cry or not Pecha you're

1021
00:35:36,890 --> 00:35:40,549
able to flip your authentication from

1022
00:35:38,420 --> 00:35:42,050
being federated to authenticate against

1023
00:35:40,550 --> 00:35:44,150
a Droid II directly this gives you two

1024
00:35:42,050 --> 00:35:46,190
really big benefits the first benefit is

1025
00:35:44,150 --> 00:35:47,360
anything in a Droid II will still

1026
00:35:46,190 --> 00:35:50,300
continue to work so your business can

1027
00:35:47,360 --> 00:35:51,770
still use office 365 and any fast apps

1028
00:35:50,300 --> 00:35:53,450
you've integrated with Azure ad like

1029
00:35:51,770 --> 00:35:55,970
Salesforce workday or whatever it is

1030
00:35:53,450 --> 00:35:57,710
those all continue to still work but

1031
00:35:55,970 --> 00:36:00,620
more importantly this will give you

1032
00:35:57,710 --> 00:36:01,940
corporate resources to start recovering

1033
00:36:00,620 --> 00:36:04,160
your environment with because if you

1034
00:36:01,940 --> 00:36:06,440
don't have something like this it is all

1035
00:36:04,160 --> 00:36:08,210
hands on deck all the rules go out the

1036
00:36:06,440 --> 00:36:09,740
window and people will be using personal

1037
00:36:08,210 --> 00:36:12,650
email addresses like hotmail Gmail

1038
00:36:09,740 --> 00:36:15,529
Comcast net or maybe whatsapp or

1039
00:36:12,650 --> 00:36:17,450
Facebook chat and in there without any

1040
00:36:15,530 --> 00:36:19,820
retention policies the only way to do a

1041
00:36:17,450 --> 00:36:22,160
discovery will probably server names

1042
00:36:19,820 --> 00:36:24,230
IP addresses and probably realistically

1043
00:36:22,160 --> 00:36:25,430
usernames and passwords in these other

1044
00:36:24,230 --> 00:36:26,390
things that you have no visibility into

1045
00:36:25,430 --> 00:36:28,190
so you want to make sure you have a way

1046
00:36:26,390 --> 00:36:29,629
for your IT department to start

1047
00:36:28,190 --> 00:36:30,650
recovering the environment and take a

1048
00:36:29,630 --> 00:36:32,450
look at this wire article if you haven't

1049
00:36:30,650 --> 00:36:35,020
read it already really good talks about

1050
00:36:32,450 --> 00:36:37,129
what happens just a couple customers now

1051
00:36:35,020 --> 00:36:38,270
one of the biggest things I hear against

1052
00:36:37,130 --> 00:36:39,620
password hashing because people just

1053
00:36:38,270 --> 00:36:41,600
really don't understand how it works

1054
00:36:39,620 --> 00:36:43,160
they think we're like taking the hash

1055
00:36:41,600 --> 00:36:44,900
we're reversing it to a clear text

1056
00:36:43,160 --> 00:36:47,029
password and storing that which we're

1057
00:36:44,900 --> 00:36:48,230
not or it's the MD for hash that's being

1058
00:36:47,030 --> 00:36:50,300
stored in Active Directory which it's

1059
00:36:48,230 --> 00:36:51,950
not so we cover all this here so take a

1060
00:36:50,300 --> 00:36:53,420
look at this this usually usually answer

1061
00:36:51,950 --> 00:36:54,890
pretty much anyone's questions around

1062
00:36:53,420 --> 00:36:56,240
how this password hash sync works so go

1063
00:36:54,890 --> 00:36:57,379
take a look at this for anyone it

1064
00:36:56,240 --> 00:37:00,350
doesn't feel like they need to turn this

1065
00:36:57,380 --> 00:37:03,320
on another thing that I shouldn't have

1066
00:37:00,350 --> 00:37:05,150
to talk about but I have to so we only

1067
00:37:03,320 --> 00:37:06,770
look for credentials that we find going

1068
00:37:05,150 --> 00:37:07,940
forward meaning that we don't keep clear

1069
00:37:06,770 --> 00:37:09,350
text username passwords that we found

1070
00:37:07,940 --> 00:37:11,240
six months ago eight months ago a year

1071
00:37:09,350 --> 00:37:12,560
ago something like that but these things

1072
00:37:11,240 --> 00:37:13,819
tend to get sliced and diced and

1073
00:37:12,560 --> 00:37:15,500
reposted so we continue to run through

1074
00:37:13,820 --> 00:37:17,450
them as we find them but a couple

1075
00:37:15,500 --> 00:37:19,340
customers have had this brilliant idea

1076
00:37:17,450 --> 00:37:22,370
where they're gonna leak their own

1077
00:37:19,340 --> 00:37:23,390
credential like oh you put it on paste

1078
00:37:22,370 --> 00:37:25,279
spin like is that what you're looking

1079
00:37:23,390 --> 00:37:26,960
for this stuff please do not do that I

1080
00:37:25,280 --> 00:37:29,270
assure you the service is working like

1081
00:37:26,960 --> 00:37:31,220
just turn it on and delete wrenches they

1082
00:37:29,270 --> 00:37:32,509
will come rolling on in like trust me

1083
00:37:31,220 --> 00:37:33,709
they always come rolling on it okay so

1084
00:37:32,510 --> 00:37:36,080
you'll need to leak your own credential

1085
00:37:33,710 --> 00:37:37,550
so I made this little chart here for

1086
00:37:36,080 --> 00:37:39,590
anyone that's kind of on the fence about

1087
00:37:37,550 --> 00:37:41,030
if they should do password hashing so we

1088
00:37:39,590 --> 00:37:42,740
have a pro's we have our con there which

1089
00:37:41,030 --> 00:37:45,680
is the security team does a want to do

1090
00:37:42,740 --> 00:37:47,000
it and then end of list but I spend a

1091
00:37:45,680 --> 00:37:48,799
lot of time talking about this with my

1092
00:37:47,000 --> 00:37:51,530
customer so if you feel like you can

1093
00:37:48,800 --> 00:37:53,360
convince me why you can't turn password

1094
00:37:51,530 --> 00:37:54,860
hashing con I would love to hear it I've

1095
00:37:53,360 --> 00:37:57,110
done this at several conferences no one

1096
00:37:54,860 --> 00:37:58,640
has been able to convince me if anyone

1097
00:37:57,110 --> 00:38:00,620
can convince me it will be the audience

1098
00:37:58,640 --> 00:38:02,359
here at blackhat so come find me after

1099
00:38:00,620 --> 00:38:03,560
our contact information was at the

1100
00:38:02,360 --> 00:38:05,240
beginning and it'll be at the end of the

1101
00:38:03,560 --> 00:38:06,560
deck email me on Twitter is fine

1102
00:38:05,240 --> 00:38:08,600
whatever else I want understand why do

1103
00:38:06,560 --> 00:38:11,720
you feel like you can't turn on password

1104
00:38:08,600 --> 00:38:13,009
hashtag okay so phishing Shawn show that

1105
00:38:11,720 --> 00:38:15,439
kind of an interesting phishing attack

1106
00:38:13,010 --> 00:38:17,390
what can we do we can require users to

1107
00:38:15,440 --> 00:38:18,950
do MFA and the thing we want them to do

1108
00:38:17,390 --> 00:38:20,390
is use the Authenticator app this will

1109
00:38:18,950 --> 00:38:22,160
give you a better performance but also

1110
00:38:20,390 --> 00:38:24,350
you'll get less prompts because this

1111
00:38:22,160 --> 00:38:25,940
acts as a token broker there's a few

1112
00:38:24,350 --> 00:38:28,130
ways to turn on MFA for users the first

1113
00:38:25,940 --> 00:38:29,960
way is you can do at a per user level

1114
00:38:28,130 --> 00:38:30,920
and it'll get prompted regardless of

1115
00:38:29,960 --> 00:38:32,600
what's happening or go that's what

1116
00:38:30,920 --> 00:38:34,160
applications are going to this might be

1117
00:38:32,600 --> 00:38:36,140
okay if you have a few apps like office

1118
00:38:34,160 --> 00:38:37,819
365 or something like that but as you

1119
00:38:36,140 --> 00:38:40,490
move to the cloud you'll probably want

1120
00:38:37,820 --> 00:38:41,960
to move to a more dynamic ability to do

1121
00:38:40,490 --> 00:38:43,580
this with conditional access you can say

1122
00:38:41,960 --> 00:38:45,620
if you're coming from this location or

1123
00:38:43,580 --> 00:38:48,350
you're coming from you know this type of

1124
00:38:45,620 --> 00:38:50,240
device you want to do MFA that way but

1125
00:38:48,350 --> 00:38:51,860
the best thing you can do is you can do

1126
00:38:50,240 --> 00:38:53,540
a risk-based policy so we only prompt

1127
00:38:51,860 --> 00:38:55,460
people for MFA when we think something

1128
00:38:53,540 --> 00:38:58,009
risky is going on but no matter how much

1129
00:38:55,460 --> 00:39:00,320
we do people are still going to fall for

1130
00:38:58,010 --> 00:39:01,790
phishing attacks internally at Microsoft

1131
00:39:00,320 --> 00:39:04,430
they'll be a mail that goes out that

1132
00:39:01,790 --> 00:39:07,340
says who would like to take home the

1133
00:39:04,430 --> 00:39:08,660
brand new secret Xbox to try at home Shh

1134
00:39:07,340 --> 00:39:10,340
we're only taking the first thousand

1135
00:39:08,660 --> 00:39:11,540
people and people leap at the keyboard

1136
00:39:10,340 --> 00:39:12,830
to give their credentials up to take

1137
00:39:11,540 --> 00:39:14,509
this Xbox home right so people are gonna

1138
00:39:12,830 --> 00:39:15,740
fall for this we need to be monitoring

1139
00:39:14,510 --> 00:39:17,660
for these types of things so you need to

1140
00:39:15,740 --> 00:39:18,919
be integrating your logs with your seen

1141
00:39:17,660 --> 00:39:20,420
system so it's a few ways to do this the

1142
00:39:18,920 --> 00:39:22,010
first way if you've been doing this for

1143
00:39:20,420 --> 00:39:23,300
a little bit time you might be pulling

1144
00:39:22,010 --> 00:39:24,560
from the graph and you have like a

1145
00:39:23,300 --> 00:39:26,150
couple endpoints you're hitting like the

1146
00:39:24,560 --> 00:39:27,529
sign-in logs or the auto logs which is

1147
00:39:26,150 --> 00:39:29,750
kind of painful because you have to give

1148
00:39:27,530 --> 00:39:31,190
the the time frame correctly but also

1149
00:39:29,750 --> 00:39:32,420
then the credentials sometimes get

1150
00:39:31,190 --> 00:39:34,280
stored in the script as people aren't

1151
00:39:32,420 --> 00:39:35,660
doing things they should be doing so

1152
00:39:34,280 --> 00:39:37,040
that's okay we want you to move to

1153
00:39:35,660 --> 00:39:38,569
something else anyways we want you to

1154
00:39:37,040 --> 00:39:40,880
use the azure event table which is part

1155
00:39:38,570 --> 00:39:42,739
of as your monitor now this

1156
00:39:40,880 --> 00:39:43,910
has some pre-built connectors so you

1157
00:39:42,739 --> 00:39:46,009
make a connection once either with like

1158
00:39:43,910 --> 00:39:49,129
Splunk or sumo logic there and then the

1159
00:39:46,009 --> 00:39:50,869
event hub will push this event to your

1160
00:39:49,130 --> 00:39:52,279
scene just straight push it's the

1161
00:39:50,869 --> 00:39:53,059
easiest thing you can do so go take a

1162
00:39:52,279 --> 00:39:55,099
look at this make sure you're

1163
00:39:53,059 --> 00:39:56,630
integrating those logs into your seam

1164
00:39:55,099 --> 00:39:58,700
solution now maybe if your seam solution

1165
00:39:56,630 --> 00:40:00,559
is more like a Hotel California right

1166
00:39:58,700 --> 00:40:02,390
like these events check-in but we never

1167
00:40:00,559 --> 00:40:03,589
get anything about it you can use as

1168
00:40:02,390 --> 00:40:05,779
your login oolitic switch has some

1169
00:40:03,589 --> 00:40:09,440
pre-built workbooks and also as your

1170
00:40:05,779 --> 00:40:11,029
sentinel now if you have a TFS one of

1171
00:40:09,440 --> 00:40:13,249
the best things you can do for this

1172
00:40:11,029 --> 00:40:14,420
issue's a 3d connect health for a TFS

1173
00:40:13,249 --> 00:40:16,279
this gives you a few things the first

1174
00:40:14,420 --> 00:40:18,410
thing is you'll get some alerts about

1175
00:40:16,279 --> 00:40:20,059
common ad FS issues like your certs

1176
00:40:18,410 --> 00:40:22,190
gonna expire there's some performance

1177
00:40:20,059 --> 00:40:23,809
issue but there's a bunch of really good

1178
00:40:22,190 --> 00:40:25,549
security benefits as well we will tell

1179
00:40:23,809 --> 00:40:28,039
you which accounts are having the most

1180
00:40:25,549 --> 00:40:29,599
invalid login attempts which may mean

1181
00:40:28,039 --> 00:40:30,799
someone has an old password and an iPad

1182
00:40:29,599 --> 00:40:33,229
somewhere that's just like banging away

1183
00:40:30,799 --> 00:40:34,700
on their mailbox or maybe this might be

1184
00:40:33,229 --> 00:40:36,589
a thing of password sprain we talked

1185
00:40:34,700 --> 00:40:38,359
about it in terms of risky IP so we will

1186
00:40:36,589 --> 00:40:39,589
show you those IP addresses that Sean

1187
00:40:38,359 --> 00:40:41,058
showed you how to do a password spray

1188
00:40:39,589 --> 00:40:43,249
which ones are attacking your

1189
00:40:41,059 --> 00:40:46,519
environment okay and then it's about

1190
00:40:43,249 --> 00:40:48,169
that if you have 85 2016 or 2019 make

1191
00:40:46,519 --> 00:40:49,788
sure you turn on smart lockout this

1192
00:40:48,170 --> 00:40:51,519
helps with this protection and we'll

1193
00:40:49,789 --> 00:40:53,960
come back to this here in a little bit

1194
00:40:51,519 --> 00:40:55,819
but as terms of password spray there's a

1195
00:40:53,960 --> 00:40:57,619
few big defenses we need to do the first

1196
00:40:55,819 --> 00:40:59,119
thing is it's time to modernize our

1197
00:40:57,619 --> 00:41:00,950
password policy as Sean showed you

1198
00:40:59,119 --> 00:41:02,569
people choose these strong but

1199
00:41:00,950 --> 00:41:03,710
predictable passwords right so if we

1200
00:41:02,569 --> 00:41:05,839
change it every 30 days

1201
00:41:03,710 --> 00:41:07,819
August 2019 with a last special

1202
00:41:05,839 --> 00:41:09,558
character all right oxidation point or

1203
00:41:07,819 --> 00:41:11,180
every quarter is going to be summer 2019

1204
00:41:09,559 --> 00:41:13,460
this is very predictable patterns that

1205
00:41:11,180 --> 00:41:16,098
people do so we have a white paper on

1206
00:41:13,460 --> 00:41:17,989
this take a look at this it's written by

1207
00:41:16,099 --> 00:41:19,339
a good PMI our team name Robin Hickok it

1208
00:41:17,989 --> 00:41:22,190
kinda explains this in a much more deep

1209
00:41:19,339 --> 00:41:25,849
deeper detail and it's also is aligned

1210
00:41:22,190 --> 00:41:27,920
to the guidance from NIST 863 B so what

1211
00:41:25,849 --> 00:41:30,559
can you do about this we have this

1212
00:41:27,920 --> 00:41:32,089
feature called the azure ad ban password

1213
00:41:30,559 --> 00:41:33,650
policy that doesn't let you put any of

1214
00:41:32,089 --> 00:41:35,509
these easily guessable passwords into

1215
00:41:33,650 --> 00:41:37,279
Azure Active Directory and we also give

1216
00:41:35,509 --> 00:41:39,619
you a custom banned password list as

1217
00:41:37,279 --> 00:41:41,210
well so put in here things that are

1218
00:41:39,619 --> 00:41:43,160
specific to your environment

1219
00:41:41,210 --> 00:41:45,170
don't put the iraq' list in here like

1220
00:41:43,160 --> 00:41:48,200
you don't need to do that but just put

1221
00:41:45,170 --> 00:41:49,819
in things like brands locations and

1222
00:41:48,200 --> 00:41:51,710
common passwords you know people are

1223
00:41:49,819 --> 00:41:53,180
using so one of my co-workers was in

1224
00:41:51,710 --> 00:41:54,470
South America and he was talking to a

1225
00:41:53,180 --> 00:41:56,060
customer and there

1226
00:41:54,470 --> 00:41:59,450
Red Team did an internal password spray

1227
00:41:56,060 --> 00:42:01,580
and they said over I think it was 60% of

1228
00:41:59,450 --> 00:42:03,230
the passwords in their environment had

1229
00:42:01,580 --> 00:42:05,060
one of the soccer teams in that region

1230
00:42:03,230 --> 00:42:05,930
in the name so you probably know that

1231
00:42:05,060 --> 00:42:07,369
you have similar things in your

1232
00:42:05,930 --> 00:42:10,220
environment that's what should go in

1233
00:42:07,369 --> 00:42:12,470
this custom band password list with the

1234
00:42:10,220 --> 00:42:14,540
best feature of this I promise you the

1235
00:42:12,470 --> 00:42:16,009
best feature of this is it works with

1236
00:42:14,540 --> 00:42:17,150
your on-prem Active Directory as well

1237
00:42:16,010 --> 00:42:19,010
you can deploy this for your domain

1238
00:42:17,150 --> 00:42:21,050
controllers and how that works is

1239
00:42:19,010 --> 00:42:23,150
there's an agent password filter on the

1240
00:42:21,050 --> 00:42:24,260
domain controller there's a member

1241
00:42:23,150 --> 00:42:25,520
server that's reaching out to the intern

1242
00:42:24,260 --> 00:42:27,920
to pull down these custom lists as well

1243
00:42:25,520 --> 00:42:28,880
as the globalist and that's what will

1244
00:42:27,920 --> 00:42:30,560
protect you against putting these

1245
00:42:28,880 --> 00:42:33,349
guessable passwords so in the azure ad

1246
00:42:30,560 --> 00:42:36,410
p1 you need to be on domain controllers

1247
00:42:33,349 --> 00:42:39,140
2012 or later but there is no domain or

1248
00:42:36,410 --> 00:42:40,700
forest functional level requirement and

1249
00:42:39,140 --> 00:42:42,379
your sis fall needs to be at the FS are

1250
00:42:40,700 --> 00:42:44,000
you should be at that anyways and you

1251
00:42:42,380 --> 00:42:46,460
want to put this in auto mode first

1252
00:42:44,000 --> 00:42:47,840
because you'll see how many passwords it

1253
00:42:46,460 --> 00:42:49,580
would have blocked and that's our

1254
00:42:47,840 --> 00:42:50,900
scoring system up there we have some

1255
00:42:49,580 --> 00:42:52,098
fuzzy matching and substring and all

1256
00:42:50,900 --> 00:42:54,050
that good stuff we document everything

1257
00:42:52,099 --> 00:42:55,190
take a look at that later but we'll show

1258
00:42:54,050 --> 00:42:56,780
you how many we don't you would have

1259
00:42:55,190 --> 00:42:58,820
blocked and you can take that to your

1260
00:42:56,780 --> 00:43:01,550
management say look we have 30 percent

1261
00:42:58,820 --> 00:43:03,290
forty percent maybe even more 50 percent

1262
00:43:01,550 --> 00:43:05,690
easily gets a little passwords our

1263
00:43:03,290 --> 00:43:06,920
environment you need to turn this on and

1264
00:43:05,690 --> 00:43:08,810
one of the things I've seen people do

1265
00:43:06,920 --> 00:43:10,130
that's very successful is when they

1266
00:43:08,810 --> 00:43:13,339
communicate this to their end users they

1267
00:43:10,130 --> 00:43:16,070
say ok you need to put in a very complex

1268
00:43:13,339 --> 00:43:17,270
password but after you do that you won't

1269
00:43:16,070 --> 00:43:19,609
have to change your password for six

1270
00:43:17,270 --> 00:43:22,130
months or nine months or maybe even a

1271
00:43:19,609 --> 00:43:26,330
year and people are very excited to go

1272
00:43:22,130 --> 00:43:28,339
do this and change the password ok so

1273
00:43:26,330 --> 00:43:30,348
last part here legacy authentication and

1274
00:43:28,339 --> 00:43:33,020
password spray almost a hundred percent

1275
00:43:30,349 --> 00:43:34,670
of the attacks we see using password

1276
00:43:33,020 --> 00:43:37,460
spray are using legacy authentication

1277
00:43:34,670 --> 00:43:39,200
this is the pop3 imap4 SMTP stuff that

1278
00:43:37,460 --> 00:43:41,270
Shan Chun talked about and how often is

1279
00:43:39,200 --> 00:43:43,759
this happening so in August of 2018 we

1280
00:43:41,270 --> 00:43:45,680
saw 200,000 accounts were falling to

1281
00:43:43,760 --> 00:43:47,060
password spray attacks so I asked that

1282
00:43:45,680 --> 00:43:48,830
same awesome data science team could you

1283
00:43:47,060 --> 00:43:51,790
pull me some data for this talk is it

1284
00:43:48,830 --> 00:43:58,730
still a real problem and from May it was

1285
00:43:51,790 --> 00:44:01,279
133,000 in June it was 212,000 and in

1286
00:43:58,730 --> 00:44:02,930
July it was 120 mm so this is still very

1287
00:44:01,280 --> 00:44:04,339
active attack that we need to make sure

1288
00:44:02,930 --> 00:44:05,569
we're defending against we want to make

1289
00:44:04,339 --> 00:44:06,710
sure our password policies are up and we

1290
00:44:05,570 --> 00:44:07,710
want to turn off these legacy protocols

1291
00:44:06,710 --> 00:44:08,880
which

1292
00:44:07,710 --> 00:44:10,170
however in a second but the last thing I

1293
00:44:08,880 --> 00:44:12,060
want to stress about this and Shawn kind

1294
00:44:10,170 --> 00:44:15,119
of talked about it a little bit if you

1295
00:44:12,060 --> 00:44:19,140
are federated the authentication takes

1296
00:44:15,119 --> 00:44:20,130
place at your IDP you have to take care

1297
00:44:19,140 --> 00:44:20,910
of this you have to look for this you

1298
00:44:20,130 --> 00:44:22,470
have to block it

1299
00:44:20,910 --> 00:44:24,210
the reason the invalid password attempt

1300
00:44:22,470 --> 00:44:25,859
in Shawn's pictures and the sign-in logs

1301
00:44:24,210 --> 00:44:29,010
it's because he's often and King in sad

1302
00:44:25,859 --> 00:44:30,779
radio if she's federated they will be in

1303
00:44:29,010 --> 00:44:32,040
these logs you want to make sure that we

1304
00:44:30,780 --> 00:44:33,780
are pulling these logs in our scene

1305
00:44:32,040 --> 00:44:37,710
system and we're taking a look at this

1306
00:44:33,780 --> 00:44:39,359
stuff yeah so how can I block this the

1307
00:44:37,710 --> 00:44:41,310
first thing you can block this at

1308
00:44:39,359 --> 00:44:44,310
exchange at the mailbox level you can

1309
00:44:41,310 --> 00:44:46,580
just turn this off if anyone's not using

1310
00:44:44,310 --> 00:44:48,599
these protocols turn it off

1311
00:44:46,580 --> 00:44:50,520
you can also block it from like a

1312
00:44:48,599 --> 00:44:53,280
service on your tenant out as using

1313
00:44:50,520 --> 00:44:55,530
authentication policy this is what Acme

1314
00:44:53,280 --> 00:44:58,380
should be doing they're starting this

1315
00:44:55,530 --> 00:44:59,910
project turn it off to begin with don't

1316
00:44:58,380 --> 00:45:01,230
let people add accounts that we

1317
00:44:59,910 --> 00:45:02,790
shouldn't be using you want to turn this

1318
00:45:01,230 --> 00:45:05,790
off so use authentication policies for

1319
00:45:02,790 --> 00:45:07,560
that and then we can actually block

1320
00:45:05,790 --> 00:45:10,500
specific client IP addresses as well

1321
00:45:07,560 --> 00:45:12,240
using the ATF us connect health logs we

1322
00:45:10,500 --> 00:45:13,230
see the risky IPs and that kind of stuff

1323
00:45:12,240 --> 00:45:14,990
you can actually just drop those

1324
00:45:13,230 --> 00:45:18,960
connections in exchange to start with

1325
00:45:14,990 --> 00:45:20,790
okay so if we are federated in a DFS we

1326
00:45:18,960 --> 00:45:22,260
have some authorization rules and the

1327
00:45:20,790 --> 00:45:24,750
key thing to know here is that one

1328
00:45:22,260 --> 00:45:26,490
author authorization rules are very rich

1329
00:45:24,750 --> 00:45:28,080
meaning that you can get very very

1330
00:45:26,490 --> 00:45:30,560
complex with your rules however you need

1331
00:45:28,080 --> 00:45:33,839
to be but this happens after

1332
00:45:30,560 --> 00:45:35,970
authentication and these authorization

1333
00:45:33,839 --> 00:45:38,430
rules will apply to the entire relying

1334
00:45:35,970 --> 00:45:40,980
party so meaning anything behind a

1335
00:45:38,430 --> 00:45:43,049
directive directory like office 365 or

1336
00:45:40,980 --> 00:45:47,339
any SAS apps those will be what's

1337
00:45:43,050 --> 00:45:49,530
applied to those rules okay and lastly

1338
00:45:47,339 --> 00:45:53,640
we can block this in a direct the

1339
00:45:49,530 --> 00:45:55,080
directory the first way again any users

1340
00:45:53,640 --> 00:45:57,990
that are not using these legacy

1341
00:45:55,080 --> 00:46:00,630
protocols today block it turn it off at

1342
00:45:57,990 --> 00:46:02,819
the mailbox block in an azure ad you can

1343
00:46:00,630 --> 00:46:04,380
do that using conditional access or we

1344
00:46:02,820 --> 00:46:05,430
have a baseline policy that's in public

1345
00:46:04,380 --> 00:46:06,480
preview but remember those are going to

1346
00:46:05,430 --> 00:46:08,009
change a little bit based on some

1347
00:46:06,480 --> 00:46:09,839
feedback but we want to make sure we're

1348
00:46:08,010 --> 00:46:12,180
blocking those that are not using it

1349
00:46:09,839 --> 00:46:14,549
today don't let it get any worse then

1350
00:46:12,180 --> 00:46:15,720
you want to work through anyone that is

1351
00:46:14,550 --> 00:46:17,430
using it so this is probably where

1352
00:46:15,720 --> 00:46:18,629
you're gonna find those older clients

1353
00:46:17,430 --> 00:46:20,669
Outlook 2010

1354
00:46:18,630 --> 00:46:21,960
maybe that Thunderbird client and you

1355
00:46:20,670 --> 00:46:23,460
need to tell people look we need to move

1356
00:46:21,960 --> 00:46:25,319
to the modern authentication protocols

1357
00:46:23,460 --> 00:46:27,150
or you need to move to OWA but we're

1358
00:46:25,319 --> 00:46:28,230
gonna turn those off and start with

1359
00:46:27,150 --> 00:46:29,940
those ones those like easier ones to

1360
00:46:28,230 --> 00:46:32,460
take care of first like the pop3 imap4

1361
00:46:29,940 --> 00:46:34,319
us then you can start working about

1362
00:46:32,460 --> 00:46:37,290
service accounts so these are gonna be

1363
00:46:34,319 --> 00:46:38,160
using SMTP or EWS we can start moving

1364
00:46:37,290 --> 00:46:39,329
those two modern authentication

1365
00:46:38,160 --> 00:46:40,920
protocols but you can use conditional

1366
00:46:39,329 --> 00:46:42,839
access to say these can only

1367
00:46:40,920 --> 00:46:43,950
authenticate from internal the internal

1368
00:46:42,839 --> 00:46:45,990
corporate network that's better than

1369
00:46:43,950 --> 00:46:48,210
nothing we can start with that and if

1370
00:46:45,990 --> 00:46:49,709
you're doing apps that use EWS just be

1371
00:46:48,210 --> 00:46:52,020
aware but that is going to be

1372
00:46:49,710 --> 00:46:54,000
decommissioned in October 2020 and if

1373
00:46:52,020 --> 00:46:57,660
you're doing any conditional access

1374
00:46:54,000 --> 00:46:59,579
policies based on device make sure that

1375
00:46:57,660 --> 00:47:00,779
your give all your matrix figured out so

1376
00:46:59,579 --> 00:47:02,099
you're not dropping anything that's

1377
00:47:00,780 --> 00:47:04,190
slipping through we topic cover this in

1378
00:47:02,099 --> 00:47:07,619
this blog post question 7 specifically

1379
00:47:04,190 --> 00:47:12,720
and with that Shawn is going to wrap it

1380
00:47:07,619 --> 00:47:14,609
up great well thank you Mark so now what

1381
00:47:12,720 --> 00:47:16,290
do you need to do I assemble the team

1382
00:47:14,609 --> 00:47:18,450
get everyone together talk about what

1383
00:47:16,290 --> 00:47:19,290
needs to get done next thankfully you

1384
00:47:18,450 --> 00:47:20,790
don't have to go through all these

1385
00:47:19,290 --> 00:47:22,259
slides to figure out what should really

1386
00:47:20,790 --> 00:47:24,960
be done because we put together some

1387
00:47:22,260 --> 00:47:26,309
checklists for you I hate it having to

1388
00:47:24,960 --> 00:47:27,750
do it through a slide deck and trying to

1389
00:47:26,309 --> 00:47:30,089
figure out okay what's all the stuff but

1390
00:47:27,750 --> 00:47:32,460
I need to do from this really like Mark

1391
00:47:30,089 --> 00:47:33,690
said MFA for cloud admin accounts

1392
00:47:32,460 --> 00:47:35,190
especially if you're gonna be in global

1393
00:47:33,690 --> 00:47:37,770
admin you're going to be in global admin

1394
00:47:35,190 --> 00:47:41,460
really PEM is the way to go you can

1395
00:47:37,770 --> 00:47:43,470
enforce MFA for global admins and and

1396
00:47:41,460 --> 00:47:45,450
privilege rolls through the baseline

1397
00:47:43,470 --> 00:47:47,700
policies that were in preview or

1398
00:47:45,450 --> 00:47:48,868
conditional access policies the other

1399
00:47:47,700 --> 00:47:50,759
thing that's really important is to make

1400
00:47:48,869 --> 00:47:52,650
sure that you isolate your cloud admins

1401
00:47:50,760 --> 00:47:54,420
as I talked about earlier if I can

1402
00:47:52,650 --> 00:47:56,839
control the web browser or the computer

1403
00:47:54,420 --> 00:47:59,280
itself then I can own that cloud

1404
00:47:56,839 --> 00:48:01,440
environment so we want to make sure that

1405
00:47:59,280 --> 00:48:03,000
you protect your cloud admins you get

1406
00:48:01,440 --> 00:48:06,599
them into either a cloud admin

1407
00:48:03,000 --> 00:48:08,760
workstation or push them into VDI or a

1408
00:48:06,599 --> 00:48:11,130
server for that administration so at

1409
00:48:08,760 --> 00:48:12,630
least that cloud admin account hopefully

1410
00:48:11,130 --> 00:48:15,089
they have a separate account not your

1411
00:48:12,630 --> 00:48:17,609
regular user account are there to be

1412
00:48:15,089 --> 00:48:18,930
protected there's a number of things

1413
00:48:17,609 --> 00:48:21,029
that we have in the deck that we've gone

1414
00:48:18,930 --> 00:48:21,868
over we put together the checklist for

1415
00:48:21,030 --> 00:48:24,390
you so you have some good information

1416
00:48:21,869 --> 00:48:28,619
about what you can do on your own

1417
00:48:24,390 --> 00:48:30,210
so in conclusion well really the cloud

1418
00:48:28,619 --> 00:48:33,690
is magic

1419
00:48:30,210 --> 00:48:35,100
I mean it can be very helpful for a

1420
00:48:33,690 --> 00:48:37,290
business it can be very useful but

1421
00:48:35,100 --> 00:48:38,700
obviously what is helpful and useful and

1422
00:48:37,290 --> 00:48:40,050
where's the date where the data is

1423
00:48:38,700 --> 00:48:50,129
that's what the attackers want to go

1424
00:48:40,050 --> 00:48:51,480
after so ultimately we are it's magic so

1425
00:48:50,130 --> 00:48:53,400
the cloud is a new paradigm that

1426
00:48:51,480 --> 00:48:54,960
requires special attention and it's not

1427
00:48:53,400 --> 00:48:57,150
inherently secure there is a

1428
00:48:54,960 --> 00:49:00,330
responsibility for security that split

1429
00:48:57,150 --> 00:49:02,070
between the provider and the customer so

1430
00:49:00,330 --> 00:49:03,840
as the customer you need to have a good

1431
00:49:02,070 --> 00:49:05,340
understanding of what the provider is

1432
00:49:03,840 --> 00:49:08,280
responsible for and what you need to do

1433
00:49:05,340 --> 00:49:10,290
as well so Microsoft provides office 365

1434
00:49:08,280 --> 00:49:12,180
with legacy authentication enabled by

1435
00:49:10,290 --> 00:49:14,190
default although at some point that will

1436
00:49:12,180 --> 00:49:16,350
change for new tenants so if you're

1437
00:49:14,190 --> 00:49:17,940
going in office 365 now just turn off

1438
00:49:16,350 --> 00:49:19,980
legacy authentication because it's not

1439
00:49:17,940 --> 00:49:21,810
in use if you're just going there now

1440
00:49:19,980 --> 00:49:24,080
there's things that you can do to lock

1441
00:49:21,810 --> 00:49:26,730
they lock this down and tighten them up

1442
00:49:24,080 --> 00:49:28,290
the security features and controls I

1443
00:49:26,730 --> 00:49:30,570
know they change all the time it's tough

1444
00:49:28,290 --> 00:49:32,880
to keep up with but just do a checkpoint

1445
00:49:30,570 --> 00:49:34,590
every at least every quarter with your

1446
00:49:32,880 --> 00:49:36,120
cloud provider to see what the updates

1447
00:49:34,590 --> 00:49:38,010
are and try to figure out what new

1448
00:49:36,120 --> 00:49:39,720
security controls are available either

1449
00:49:38,010 --> 00:49:41,070
in your subscription or maybe one above

1450
00:49:39,720 --> 00:49:42,450
that that might be useful for your

1451
00:49:41,070 --> 00:49:44,310
environment something that wasn't

1452
00:49:42,450 --> 00:49:47,069
possible six months ago may be possible

1453
00:49:44,310 --> 00:49:48,120
today and unfortunately securing the

1454
00:49:47,070 --> 00:49:49,980
cloud may cost extra

1455
00:49:48,120 --> 00:49:51,390
just like on prom there may be some

1456
00:49:49,980 --> 00:49:52,470
security features that you need to have

1457
00:49:51,390 --> 00:49:54,839
because you have a high security

1458
00:49:52,470 --> 00:49:57,089
environment it may cause some of the

1459
00:49:54,840 --> 00:49:58,590
additional money for that so make sure

1460
00:49:57,090 --> 00:49:59,850
you budget for that when you're going

1461
00:49:58,590 --> 00:50:07,620
through the negotiations with your cloud

1462
00:49:59,850 --> 00:50:09,420
provider so if you liked our talk please

1463
00:50:07,620 --> 00:50:11,339
submit an evaluation we will be going to

1464
00:50:09,420 --> 00:50:13,860
the choral room for wrap up right after

1465
00:50:11,340 --> 00:50:15,230
this and the presentations will be on 8e

1466
00:50:13,860 --> 00:50:17,820
security that'll work very shortly

1467
00:50:15,230 --> 00:50:19,210
that's been our time thank you very much

1468
00:50:17,820 --> 00:50:21,490
for yours

1469
00:50:19,210 --> 00:50:21,580
[Applause]

1470
00:50:21,490 --> 00:50:24,618
you

1471
00:50:21,580 --> 00:50:24,619
[Applause]

