1
00:00:00,060 --> 00:00:04,258
the next talk is hunting for bugs

2
00:00:01,890 --> 00:00:09,660
catching dragons with Nicholas

3
00:00:04,259 --> 00:00:12,000
julie:thanks believe in or not I am

4
00:00:09,660 --> 00:00:13,889
super excited to be here on the stage

5
00:00:12,000 --> 00:00:18,859
before you even if I don't sound that

6
00:00:13,889 --> 00:00:21,750
excited I am excited yes my name is Nico

7
00:00:18,859 --> 00:00:24,119
I'm French I work in the UK for

8
00:00:21,750 --> 00:00:26,189
Microsoft at the Microsoft Security

9
00:00:24,119 --> 00:00:28,230
Response Center I'm part of the

10
00:00:26,189 --> 00:00:31,340
variability and mitigation teams of the

11
00:00:28,230 --> 00:00:33,809
name team and to be sure I'm doing more

12
00:00:31,340 --> 00:00:36,809
vulnerability research than mitigation

13
00:00:33,809 --> 00:00:42,540
and that's surely one of the reason why

14
00:00:36,809 --> 00:00:46,559
I'm here today I'm here so I'm going to

15
00:00:42,540 --> 00:00:49,649
talk about email security today so by

16
00:00:46,559 --> 00:00:53,129
the end of that touch I'd like you to

17
00:00:49,649 --> 00:00:53,670
know much more about email security at

18
00:00:53,129 --> 00:00:55,860
all

19
00:00:53,670 --> 00:00:58,230
I'd like you to become experts in this

20
00:00:55,860 --> 00:01:00,559
area so hopefully you'll be learning

21
00:00:58,230 --> 00:01:03,660
things for those of you who have already

22
00:01:00,559 --> 00:01:06,360
hacked into outlook I'm sure you will be

23
00:01:03,660 --> 00:01:08,610
learning things new things and for those

24
00:01:06,360 --> 00:01:11,390
of you who have already written outlook

25
00:01:08,610 --> 00:01:14,189
exploits well I'd love to meet you

26
00:01:11,390 --> 00:01:16,259
so if this country see after come to see

27
00:01:14,189 --> 00:01:20,610
me after a talk I'm sure we've got lots

28
00:01:16,259 --> 00:01:24,680
of stuff to to talk together so here you

29
00:01:20,610 --> 00:01:28,860
go so I divide that talk into two parts

30
00:01:24,680 --> 00:01:31,740
first parts on Outlook so I'm probably

31
00:01:28,860 --> 00:01:34,320
going to spend 35 minutes on this and

32
00:01:31,740 --> 00:01:35,729
then I'm over 10 minutes roughly on

33
00:01:34,320 --> 00:01:39,479
exchange

34
00:01:35,729 --> 00:01:42,990
I have demos I have bugs I have exploits

35
00:01:39,479 --> 00:01:45,030
so hopefully you enjoy it and you know

36
00:01:42,990 --> 00:01:47,610
what for once I'm going to start my

37
00:01:45,030 --> 00:01:49,280
presentation with a table I assume that

38
00:01:47,610 --> 00:01:52,710
you guys are not too familiar with

39
00:01:49,280 --> 00:01:54,680
Outlook extracts so think about that for

40
00:01:52,710 --> 00:01:58,079
a second what do you think is the worst

41
00:01:54,680 --> 00:02:01,619
case scenario for out an attack in the

42
00:01:58,079 --> 00:02:04,949
preview pane maybe there's even worse

43
00:02:01,619 --> 00:02:07,740
than that guy's very attack your some

44
00:02:04,950 --> 00:02:09,780
attacks on the sync engine you send an

45
00:02:07,740 --> 00:02:11,950
email and you don't even need to read

46
00:02:09,780 --> 00:02:15,300
that email and you get down

47
00:02:11,950 --> 00:02:18,099
that's one example fried for example

48
00:02:15,300 --> 00:02:21,540
there's also dragons that I want to

49
00:02:18,099 --> 00:02:24,569
catch you know the big bugs a big issues

50
00:02:21,540 --> 00:02:28,090
so let's pretend for a second that

51
00:02:24,569 --> 00:02:31,329
you've never seen this demo let's say

52
00:02:28,090 --> 00:02:33,670
that that did happen let's come back to

53
00:02:31,330 --> 00:02:36,370
time if I mentioned how to exploit for

54
00:02:33,670 --> 00:02:40,540
you to you guys so that's some familiar

55
00:02:36,370 --> 00:02:43,360
probably not so in my opinion in my

56
00:02:40,540 --> 00:02:44,950
memories with last time we heard about

57
00:02:43,360 --> 00:02:46,780
something like that I mean something

58
00:02:44,950 --> 00:02:48,790
widespread something used in the white

59
00:02:46,780 --> 00:02:50,920
that was probably 20 years ago with

60
00:02:48,790 --> 00:02:53,260
there's I dove you bugs there's a I do

61
00:02:50,920 --> 00:02:54,910
view worms where somebody would send an

62
00:02:53,260 --> 00:02:56,440
email with an attachment a vbscript

63
00:02:54,910 --> 00:02:59,049
attachment you double-click that

64
00:02:56,440 --> 00:03:02,290
attachment and then you'd get out there

65
00:02:59,049 --> 00:03:05,830
are something interesting as well I

66
00:03:02,290 --> 00:03:07,840
think it was in 1990 97 something like

67
00:03:05,830 --> 00:03:10,900
that a various name catch it was

68
00:03:07,840 --> 00:03:13,209
spreading with JavaScript signatures am

69
00:03:10,900 --> 00:03:15,010
beginning to image that was good as well

70
00:03:13,209 --> 00:03:17,829
as probably where I started the injury

71
00:03:15,010 --> 00:03:20,340
in suicide by the way about that time so

72
00:03:17,829 --> 00:03:22,989
more recently exploits that we've seen

73
00:03:20,340 --> 00:03:26,829
we've got one interesting submission

74
00:03:22,989 --> 00:03:27,489
were interesting awesome submission by

75
00:03:26,829 --> 00:03:30,880
jefe

76
00:03:27,489 --> 00:03:34,570
about three four years ago so he managed

77
00:03:30,880 --> 00:03:38,410
to get codex action in an email by

78
00:03:34,570 --> 00:03:40,150
embedding your flash exploit in that

79
00:03:38,410 --> 00:03:42,430
emerge so he found a way to insert the

80
00:03:40,150 --> 00:03:45,670
flash control to send it and then he was

81
00:03:42,430 --> 00:03:48,510
using a known flash vulnerability to

82
00:03:45,670 --> 00:03:50,708
show codec section that was great

83
00:03:48,510 --> 00:03:56,290
there's a somebody else

84
00:03:50,709 --> 00:03:57,940
Orion and son about three years ago at

85
00:03:56,290 --> 00:04:01,060
that moment you know there are these

86
00:03:57,940 --> 00:04:03,609
days at the nsrc when suddenly you you

87
00:04:01,060 --> 00:04:05,799
receive an email and there is a they all

88
00:04:03,609 --> 00:04:08,799
right I remember that day we got three

89
00:04:05,799 --> 00:04:10,930
cases and I looked at them I checked the

90
00:04:08,799 --> 00:04:13,870
queue I was looking at this cases and a

91
00:04:10,930 --> 00:04:16,418
red banner I thought if only half of

92
00:04:13,870 --> 00:04:18,789
this is true well this is seriously bad

93
00:04:16,418 --> 00:04:21,459
it turns out that he was right on the

94
00:04:18,789 --> 00:04:24,820
few of em so kudos to our Ryan Hansen

95
00:04:21,459 --> 00:04:27,040
and more bugs like this piece

96
00:04:24,820 --> 00:04:29,200
I come back to some of them in a in a

97
00:04:27,040 --> 00:04:30,850
moment and there's and then they are

98
00:04:29,200 --> 00:04:34,870
also the last ones

99
00:04:30,850 --> 00:04:37,240
so once the des the exploits for which

100
00:04:34,870 --> 00:04:39,250
people don't really know that there is

101
00:04:37,240 --> 00:04:42,910
an l2 vector I'm thinking for example

102
00:04:39,250 --> 00:04:46,440
about these exploits that attacked the

103
00:04:42,910 --> 00:04:50,080
phone parser the EPS from parser back in

104
00:04:46,440 --> 00:04:53,920
2015-2016 so in that case V attackers we

105
00:04:50,080 --> 00:04:57,940
are using a word document to to spread

106
00:04:53,920 --> 00:05:00,130
their 1 to to attack people but nobody

107
00:04:57,940 --> 00:05:03,910
realized that you could carry this

108
00:05:00,130 --> 00:05:05,920
attack just over an email I can tell you

109
00:05:03,910 --> 00:05:09,160
now that it was actually possible to to

110
00:05:05,920 --> 00:05:10,540
do this so that leads us to think about

111
00:05:09,160 --> 00:05:12,790
the attack surface

112
00:05:10,540 --> 00:05:15,900
what's the attack surface for Outlook

113
00:05:12,790 --> 00:05:20,980
it's huge it's actually a warehouse

114
00:05:15,900 --> 00:05:26,429
think about email parsing or image like

115
00:05:20,980 --> 00:05:29,010
HTML emails calendars rich text image

116
00:05:26,430 --> 00:05:33,760
objects that you can embed in animal

117
00:05:29,010 --> 00:05:36,610
fonts pictures lots of things think also

118
00:05:33,760 --> 00:05:39,340
about protocols the SMTP protocols pop3

119
00:05:36,610 --> 00:05:41,260
IMAP I was taking a half a slight

120
00:05:39,340 --> 00:05:45,429
recently Atkins AK and she was

121
00:05:41,260 --> 00:05:48,039
mentioning that for example in 2013

122
00:05:45,430 --> 00:05:49,930
something that we fixed an integer

123
00:05:48,040 --> 00:05:52,330
overflow affecting the pop3 protocol

124
00:05:49,930 --> 00:05:55,090
that was interesting the doubt assume

125
00:05:52,330 --> 00:05:57,460
that your that your client health week

126
00:05:55,090 --> 00:05:59,049
is dealing with tampered server or that

127
00:05:57,460 --> 00:06:02,140
somebody is doing some money in the

128
00:05:59,050 --> 00:06:04,690
middle attack but still that's that's

129
00:06:02,140 --> 00:06:07,680
that's Reggie cat attack we've got also

130
00:06:04,690 --> 00:06:10,590
all everything that touches the

131
00:06:07,680 --> 00:06:13,660
cryptography like spoofing attacks

132
00:06:10,590 --> 00:06:16,090
anything that touchy certificates can

133
00:06:13,660 --> 00:06:19,090
you have the certificates can you can

134
00:06:16,090 --> 00:06:22,419
you can you attack view as a crypto yeah

135
00:06:19,090 --> 00:06:25,090
why not and then there is also what I

136
00:06:22,420 --> 00:06:27,010
could add the remaining parts so we are

137
00:06:25,090 --> 00:06:28,869
dealing here with an office application

138
00:06:27,010 --> 00:06:30,969
so of course there are macros involved

139
00:06:28,870 --> 00:06:33,790
so say for example that you've got an

140
00:06:30,970 --> 00:06:36,460
email that somehow manages to trigger

141
00:06:33,790 --> 00:06:37,490
macros I'm just inventing that guys I've

142
00:06:36,460 --> 00:06:40,120
never seen this

143
00:06:37,490 --> 00:06:43,280
and hopefully that won't happen but just

144
00:06:40,120 --> 00:06:46,490
like this I'm also thinking about sense

145
00:06:43,280 --> 00:06:47,299
post sense post ruler so here's a

146
00:06:46,490 --> 00:06:49,280
scenario

147
00:06:47,300 --> 00:06:51,349
who has that you've got an account that

148
00:06:49,280 --> 00:06:54,169
has been compromised and how can we

149
00:06:51,349 --> 00:06:57,080
leverage that to get code execution on

150
00:06:54,169 --> 00:07:00,650
on the client on Outlook interesting

151
00:06:57,080 --> 00:07:02,990
attacks today I've got 40 minutes left

152
00:07:00,650 --> 00:07:07,580
I'm only going to talk about there's a

153
00:07:02,990 --> 00:07:11,900
few points rich text attachments audio

154
00:07:07,580 --> 00:07:14,659
objects and of course TNF so before I

155
00:07:11,900 --> 00:07:17,440
started I started talking about that you

156
00:07:14,659 --> 00:07:20,870
might be wondering why I'm doing that

157
00:07:17,440 --> 00:07:22,490
I'm from Microsoft and I'm literally

158
00:07:20,870 --> 00:07:26,780
going to teach you how to add him to

159
00:07:22,490 --> 00:07:27,319
Outlook so you might think that that's a

160
00:07:26,780 --> 00:07:29,929
bit weird

161
00:07:27,319 --> 00:07:32,060
I've done my reasons I'm looking here

162
00:07:29,930 --> 00:07:34,400
I've mastered as dragons and the thing

163
00:07:32,060 --> 00:07:38,750
is we barely receive

164
00:07:34,400 --> 00:07:41,900
cases like astonishing cases we know

165
00:07:38,750 --> 00:07:45,110
that exploits exist in various that zero

166
00:07:41,900 --> 00:07:47,960
bug bounty at $200,000 for example for

167
00:07:45,110 --> 00:07:50,030
an exploit freaking out look I'm not

168
00:07:47,960 --> 00:07:53,719
getting the sky see so we are there so

169
00:07:50,030 --> 00:07:56,809
why don't researchers reporting test

170
00:07:53,719 --> 00:08:01,310
books to us because we are there I've

171
00:07:56,810 --> 00:08:03,650
seen so no is this because I don't know

172
00:08:01,310 --> 00:08:06,259
the reason that much of research out on

173
00:08:03,650 --> 00:08:08,810
the Internet is it because where there's

174
00:08:06,259 --> 00:08:13,639
no symbols in office sorry I can't help

175
00:08:08,810 --> 00:08:15,710
you on that but yeah things happen lack

176
00:08:13,639 --> 00:08:18,469
of interest in the area I don't know but

177
00:08:15,710 --> 00:08:21,409
how can we help for finders they just

178
00:08:18,469 --> 00:08:23,900
talk about one research and talk about

179
00:08:21,409 --> 00:08:26,449
some of the cases we got so quick

180
00:08:23,900 --> 00:08:27,770
disclaimer of course all the Bub's rare

181
00:08:26,449 --> 00:08:32,229
abilities that are discussed in the

182
00:08:27,770 --> 00:08:35,390
following slides and been fixed let's go

183
00:08:32,229 --> 00:08:39,740
TAF does that sound familiar to anyone

184
00:08:35,390 --> 00:08:42,649
I'm pretty sure that some time ago you

185
00:08:39,740 --> 00:08:45,079
received an email with weird an

186
00:08:42,649 --> 00:08:47,630
attachment and then we made that and

187
00:08:45,079 --> 00:08:50,930
you're like what is that thing

188
00:08:47,630 --> 00:08:53,779
what is this about and then you start

189
00:08:50,930 --> 00:08:56,060
googling a bit with that and you you

190
00:08:53,779 --> 00:08:58,459
find blog post saying idea is because

191
00:08:56,060 --> 00:09:01,099
out focus on well configure and also it

192
00:08:58,459 --> 00:09:04,399
is sending its proper area image and so

193
00:09:01,100 --> 00:09:07,009
you can decode them etc etc all of this

194
00:09:04,399 --> 00:09:10,100
is related to TNF I borrowed that slide

195
00:09:07,009 --> 00:09:12,800
from Haifa because when you look at TNF

196
00:09:10,100 --> 00:09:14,660
in Google that's one of the first pages

197
00:09:12,800 --> 00:09:17,060
that that appears

198
00:09:14,660 --> 00:09:19,430
what is this Jenny F so you read this

199
00:09:17,060 --> 00:09:22,339
and you see that it can contains the

200
00:09:19,430 --> 00:09:24,859
objects attachments and you know what

201
00:09:22,339 --> 00:09:27,019
special output features and you know

202
00:09:24,860 --> 00:09:30,380
what these are the ones that we are

203
00:09:27,019 --> 00:09:35,240
interested in today so what's a TNF yeah

204
00:09:30,380 --> 00:09:36,800
- the specs are there so come back to

205
00:09:35,240 --> 00:09:39,620
that in a second so let's say that you

206
00:09:36,800 --> 00:09:43,040
receive an email from Outlook you look

207
00:09:39,620 --> 00:09:51,529
at it you look at it on the server sorry

208
00:09:43,040 --> 00:09:53,420
one click to me where am I yeah so you

209
00:09:51,529 --> 00:09:55,209
look at it on the server and you see

210
00:09:53,420 --> 00:09:58,699
that there are some nine feeders

211
00:09:55,209 --> 00:10:02,149
followed by an attachment encoded in

212
00:09:58,699 --> 00:10:04,130
base64 the mime type is application and

213
00:10:02,149 --> 00:10:06,740
STN yes and you're wondering what what

214
00:10:04,130 --> 00:10:10,069
is this thing so you decode it base64

215
00:10:06,740 --> 00:10:15,019
decoded and do I have an issue in my

216
00:10:10,069 --> 00:10:18,170
clicker all right I do this yeah and

217
00:10:15,019 --> 00:10:21,230
then it turns out that no we are dealing

218
00:10:18,170 --> 00:10:24,709
with a file format so what's this file

219
00:10:21,230 --> 00:10:26,810
format so the specs are open you can

220
00:10:24,709 --> 00:10:28,819
find them and we internet so it's

221
00:10:26,810 --> 00:10:35,119
basically a sequence of objects

222
00:10:28,819 --> 00:10:37,969
containers on properties so I wrote I

223
00:10:35,120 --> 00:10:42,560
wrote I've written I know one Oh

224
00:10:37,970 --> 00:10:45,230
template for this it works am I going to

225
00:10:42,560 --> 00:10:48,018
publish that maybe so you know what guys

226
00:10:45,230 --> 00:10:51,019
here's the data you find me a good bug

227
00:10:48,019 --> 00:10:53,750
in the gif I blog about it and you'll

228
00:10:51,019 --> 00:10:54,050
get that that template dealer sounds

229
00:10:53,750 --> 00:10:55,840
good

230
00:10:54,050 --> 00:11:01,410
really do that

231
00:10:55,840 --> 00:11:04,750
tnf or rich text so often people well

232
00:11:01,410 --> 00:11:07,779
yeah often we tend to mix a bit desert

233
00:11:04,750 --> 00:11:09,850
as to these two things so when we say we

234
00:11:07,779 --> 00:11:11,980
are going to when you write when you

235
00:11:09,850 --> 00:11:13,870
compose a rich text email you've got the

236
00:11:11,980 --> 00:11:16,900
feeling that you're actually going to

237
00:11:13,870 --> 00:11:21,040
send rich text Docs document on the wire

238
00:11:16,900 --> 00:11:22,750
that is not and that is not entirely

239
00:11:21,040 --> 00:11:26,020
correct what you are doing that you're

240
00:11:22,750 --> 00:11:30,640
saying Enes email and one property

241
00:11:26,020 --> 00:11:31,839
inside is the RTF document so that

242
00:11:30,640 --> 00:11:33,790
special property

243
00:11:31,839 --> 00:11:36,190
so there are various techniques for this

244
00:11:33,790 --> 00:11:39,069
one the most common is a compressed one

245
00:11:36,190 --> 00:11:42,310
so it starts with lzdf you so that's a

246
00:11:39,070 --> 00:11:44,800
compressed compressed structure with a

247
00:11:42,310 --> 00:11:48,550
customer gorilla and the other one is

248
00:11:44,800 --> 00:11:50,740
the mirror so I'm not aware of any

249
00:11:48,550 --> 00:11:54,279
possibility in Outlook in the UI to

250
00:11:50,740 --> 00:11:57,339
generate decimals but just be aware that

251
00:11:54,279 --> 00:12:00,189
that this exists so why am I talking

252
00:11:57,339 --> 00:12:02,980
about that because we still receive

253
00:12:00,190 --> 00:12:05,650
cases far out with people for example

254
00:12:02,980 --> 00:12:07,630
choosing the MSG file formats and when

255
00:12:05,650 --> 00:12:10,900
we do that the first d'être with a

256
00:12:07,630 --> 00:12:12,880
shotgun trying to be flip bits it works

257
00:12:10,900 --> 00:12:16,510
because sometimes we've got interesting

258
00:12:12,880 --> 00:12:19,210
cases but it produces so many so many

259
00:12:16,510 --> 00:12:22,960
invalid files so if if you are

260
00:12:19,210 --> 00:12:24,880
interested in 2003 RTF part just do

261
00:12:22,960 --> 00:12:27,700
something else usually into a primary

262
00:12:24,880 --> 00:12:31,600
for example you can just build an email

263
00:12:27,700 --> 00:12:34,360
with C sharp and and just say that you

264
00:12:31,600 --> 00:12:38,730
are going to use your own corpus of RTF

265
00:12:34,360 --> 00:12:42,100
files and that will give you much less

266
00:12:38,730 --> 00:12:44,140
much less issues and pressure that

267
00:12:42,100 --> 00:12:50,890
you'll find new bugs and so you can

268
00:12:44,140 --> 00:12:54,459
report to us coming to the RTF issues so

269
00:12:50,890 --> 00:12:57,939
think think about it outlook is using

270
00:12:54,459 --> 00:13:00,459
the world core library to parse this RTF

271
00:12:57,940 --> 00:13:02,620
image so that means server things that

272
00:13:00,459 --> 00:13:05,469
means that if you have an issue that

273
00:13:02,620 --> 00:13:07,810
affects the RTF parser it probably

274
00:13:05,470 --> 00:13:09,640
affects outlook as well and that's the

275
00:13:07,810 --> 00:13:12,339
reason why we're still shipping

276
00:13:09,640 --> 00:13:14,140
jeans with a critical severity because

277
00:13:12,340 --> 00:13:16,480
sometimes you've got an issue that

278
00:13:14,140 --> 00:13:18,130
affects words and also effect you have

279
00:13:16,480 --> 00:13:20,050
to preview pane so here you've got

280
00:13:18,130 --> 00:13:23,200
another zero quick attack

281
00:13:20,050 --> 00:13:26,260
so think about now attacks that could

282
00:13:23,200 --> 00:13:30,100
potentially work on Outlook but could be

283
00:13:26,260 --> 00:13:34,150
legitimate scenarios in word and that's

284
00:13:30,100 --> 00:13:36,490
probably what Ryan Hansen felt at the

285
00:13:34,150 --> 00:13:38,949
beginning of his research he figured

286
00:13:36,490 --> 00:13:41,560
that since outlook was parsing the RTF

287
00:13:38,950 --> 00:13:44,560
file formats he was probably also

288
00:13:41,560 --> 00:13:48,010
parsing everything that word was parsing

289
00:13:44,560 --> 00:13:51,310
for example that template keyword I am

290
00:13:48,010 --> 00:13:54,490
not aware of any possibility in vui to

291
00:13:51,310 --> 00:13:56,589
generate an email that embed template

292
00:13:54,490 --> 00:13:59,170
file so what's the problem here

293
00:13:56,590 --> 00:14:02,290
well if you if you use a template

294
00:13:59,170 --> 00:14:05,469
keyword you're gonna you're gonna have

295
00:14:02,290 --> 00:14:08,500
out to a ward to load a template for you

296
00:14:05,470 --> 00:14:10,270
the problem here is that the file is the

297
00:14:08,500 --> 00:14:13,180
path to that file is controlled by the

298
00:14:10,270 --> 00:14:16,689
attacker so you can put an HTTP path you

299
00:14:13,180 --> 00:14:19,270
can put an SMB share link or you can

300
00:14:16,690 --> 00:14:21,670
even put a local file and that's what

301
00:14:19,270 --> 00:14:26,980
Brian and some abused so what he did

302
00:14:21,670 --> 00:14:29,770
that he put it an SMB link to the to an

303
00:14:26,980 --> 00:14:33,490
external file and if your lad that each

304
00:14:29,770 --> 00:14:35,800
by doing so he was still able to load

305
00:14:33,490 --> 00:14:38,650
flash so this attack was reported to us

306
00:14:35,800 --> 00:14:42,579
about a year after a say a fairly

307
00:14:38,650 --> 00:14:46,180
reported his bad win mail attack so he

308
00:14:42,580 --> 00:14:49,180
found like a miss variant so problem is

309
00:14:46,180 --> 00:14:50,949
that obviously when we got - attack we

310
00:14:49,180 --> 00:14:55,209
didn't realize that it was also possible

311
00:14:50,950 --> 00:14:59,080
to trigger the same issue with with this

312
00:14:55,210 --> 00:15:02,080
template keyword but sync also about all

313
00:14:59,080 --> 00:15:04,360
all this implies with for example

314
00:15:02,080 --> 00:15:06,640
disassemble its links if you do that

315
00:15:04,360 --> 00:15:10,300
then your chances are that you're going

316
00:15:06,640 --> 00:15:13,870
to send via ntlm ash for example over a

317
00:15:10,300 --> 00:15:16,270
wire and people know I've been known for

318
00:15:13,870 --> 00:15:18,940
years that this is a an interesting

319
00:15:16,270 --> 00:15:22,120
attack vector first even worse I think

320
00:15:18,940 --> 00:15:22,950
about all the supported file formats so

321
00:15:22,120 --> 00:15:25,529
all of a sudden

322
00:15:22,950 --> 00:15:27,839
everything that word parties becomes

323
00:15:25,529 --> 00:15:30,959
available in in Outlook which literally

324
00:15:27,839 --> 00:15:33,269
means that any variability that effect

325
00:15:30,959 --> 00:15:36,689
word will be trigger able from the

326
00:15:33,269 --> 00:15:39,029
preview pane so all our Berg's which are

327
00:15:36,690 --> 00:15:41,130
rated are important in word should then

328
00:15:39,029 --> 00:15:42,570
be considered a speaker I'll give you

329
00:15:41,130 --> 00:15:44,820
another example with the template

330
00:15:42,570 --> 00:15:47,579
keyword this one's a memory corruption

331
00:15:44,820 --> 00:15:50,730
so you just specify the template that

332
00:15:47,579 --> 00:15:52,949
refers to an over template which Indian

333
00:15:50,730 --> 00:15:54,959
will refer to and tap a template with

334
00:15:52,949 --> 00:15:57,510
the same name but with a path that is

335
00:15:54,959 --> 00:16:00,239
invalid and then you'll get UAF so you

336
00:15:57,510 --> 00:16:03,360
see all these issues with the template

337
00:16:00,240 --> 00:16:06,209
keyword and what do you think happened

338
00:16:03,360 --> 00:16:11,190
to that time that keyword support was

339
00:16:06,209 --> 00:16:13,859
dropped I'd come back now to video took

340
00:16:11,190 --> 00:16:16,769
interrupt library it's probably the best

341
00:16:13,860 --> 00:16:22,010
way if you want to play with outlooks

342
00:16:16,769 --> 00:16:24,240
custom functionalities it's very easy so

343
00:16:22,010 --> 00:16:26,639
everything is documented you can find

344
00:16:24,240 --> 00:16:30,350
that online and and you got some

345
00:16:26,639 --> 00:16:32,940
examples about sending a normal image

346
00:16:30,350 --> 00:16:36,470
varied image and if you look at the

347
00:16:32,940 --> 00:16:39,990
specs you'll see for example the

348
00:16:36,470 --> 00:16:42,529
submissives a message class property so

349
00:16:39,990 --> 00:16:45,870
this is just specifying the class of

350
00:16:42,529 --> 00:16:48,089
v-mail that you that your son so try

351
00:16:45,870 --> 00:16:52,079
something just send an email with that

352
00:16:48,089 --> 00:16:54,990
that library and use the IPM that

353
00:16:52,079 --> 00:16:57,479
contact class name and in the in this

354
00:16:54,990 --> 00:17:00,060
case what will happen is that instead of

355
00:16:57,480 --> 00:17:03,000
receiving your normal email you will get

356
00:17:00,060 --> 00:17:05,790
instead contact yeah in the preview pane

357
00:17:03,000 --> 00:17:09,869
and the first time I did that I was

358
00:17:05,790 --> 00:17:13,020
definitely not expecting this so you've

359
00:17:09,869 --> 00:17:16,079
got several classes all of them of their

360
00:17:13,020 --> 00:17:18,809
own properties for example this contact

361
00:17:16,079 --> 00:17:21,750
form it's interesting in a way you can

362
00:17:18,809 --> 00:17:25,139
see there is a picture on the top right

363
00:17:21,750 --> 00:17:26,849
corner image can embed pictures that's

364
00:17:25,140 --> 00:17:29,720
fine but this one is particularly this

365
00:17:26,849 --> 00:17:32,370
one is actually using the GDI stack

366
00:17:29,720 --> 00:17:34,920
outlook usually oh and it parses

367
00:17:32,370 --> 00:17:37,679
pictures is using the unnies

368
00:17:34,920 --> 00:17:40,680
isn't at CMS or stack but with this one

369
00:17:37,680 --> 00:17:42,450
if you find any an issue with the GDI

370
00:17:40,680 --> 00:17:44,340
stack then you'll be able to abuse it

371
00:17:42,450 --> 00:17:47,040
directly in the preview page so there's

372
00:17:44,340 --> 00:17:49,949
our things that can can be interesting

373
00:17:47,040 --> 00:17:54,659
when you want to build a tax I give you

374
00:17:49,950 --> 00:17:58,320
a short list of over classes like tasks

375
00:17:54,660 --> 00:18:00,330
calendars of course etc there are lots

376
00:17:58,320 --> 00:18:03,629
of them so here's our inquire you can

377
00:18:00,330 --> 00:18:06,780
find others we are even some that are

378
00:18:03,630 --> 00:18:08,850
undocumented how to find them where you

379
00:18:06,780 --> 00:18:11,070
guys are reverse engineer so you're

380
00:18:08,850 --> 00:18:14,040
probably a pretty good at doing that

381
00:18:11,070 --> 00:18:16,350
just fine string in binaries so I give

382
00:18:14,040 --> 00:18:19,920
you now an example of something that we

383
00:18:16,350 --> 00:18:23,310
received like quite some time ago the

384
00:18:19,920 --> 00:18:25,470
IPM remote message class so this was

385
00:18:23,310 --> 00:18:27,480
reported to us by a gentleman at that

386
00:18:25,470 --> 00:18:29,460
moment he was just generating a standard

387
00:18:27,480 --> 00:18:31,170
a normal email and she was changing a

388
00:18:29,460 --> 00:18:33,030
research class 12:00 p.m. remote and

389
00:18:31,170 --> 00:18:34,650
what happened is at a dominum at that

390
00:18:33,030 --> 00:18:36,389
moment when you loaded that nail in the

391
00:18:34,650 --> 00:18:38,040
preview pane when you saw that imagine

392
00:18:36,390 --> 00:18:41,130
it's approved when you trigger a null

393
00:18:38,040 --> 00:18:43,409
pointer so we are not really interested

394
00:18:41,130 --> 00:18:46,290
by that so that's why this was fixed

395
00:18:43,410 --> 00:18:48,300
Envy next but what still it made you

396
00:18:46,290 --> 00:18:51,720
sweat with to this plantation so it was

397
00:18:48,300 --> 00:18:52,110
quite cool that man I'm going I'm not

398
00:18:51,720 --> 00:18:54,150
going

399
00:18:52,110 --> 00:18:58,110
I'm now going to spend time on something

400
00:18:54,150 --> 00:19:01,800
else something that rang reported us VIP

401
00:18:58,110 --> 00:19:05,040
m dot document class so the attack that

402
00:19:01,800 --> 00:19:08,700
he reported us was a protected mode

403
00:19:05,040 --> 00:19:13,100
escape so in this case he was giving an

404
00:19:08,700 --> 00:19:17,970
example message dot miss AG file where

405
00:19:13,100 --> 00:19:21,330
female would have two attachments one

406
00:19:17,970 --> 00:19:24,650
was a regular RTF file and if you

407
00:19:21,330 --> 00:19:26,879
everyone was built from his shenanigans

408
00:19:24,650 --> 00:19:29,580
and it turns out that when you were

409
00:19:26,880 --> 00:19:32,490
opening the regular attachment

410
00:19:29,580 --> 00:19:34,889
world would open a within app container

411
00:19:32,490 --> 00:19:38,070
but if you are doing the same with your

412
00:19:34,890 --> 00:19:41,250
attachment then world would load with

413
00:19:38,070 --> 00:19:45,929
medium integrity and I'd like to mention

414
00:19:41,250 --> 00:19:47,610
anniversary where emails can just show

415
00:19:45,930 --> 00:19:49,980
by default of used okay

416
00:19:47,610 --> 00:19:54,689
so I'm now going to show you a demo with

417
00:19:49,980 --> 00:19:56,450
both CVS combine so this attack is just

418
00:19:54,690 --> 00:19:58,800
about sending an email

419
00:19:56,450 --> 00:20:00,750
the attacker sends you an email you

420
00:19:58,800 --> 00:20:02,970
receive that email and the war starts

421
00:20:00,750 --> 00:20:04,920
and if you look at it with process

422
00:20:02,970 --> 00:20:06,960
Explorer you'll see that words run with

423
00:20:04,920 --> 00:20:09,720
up container so now by default you've

424
00:20:06,960 --> 00:20:13,110
got all the word format all the world

425
00:20:09,720 --> 00:20:15,090
reliabilities available from the preview

426
00:20:13,110 --> 00:20:17,219
pane and the thing is if you open that

427
00:20:15,090 --> 00:20:19,439
mail manually you will see something

428
00:20:17,220 --> 00:20:22,260
different you see that were another word

429
00:20:19,440 --> 00:20:24,300
process started but this time it was

430
00:20:22,260 --> 00:20:27,980
started by the automation you can see

431
00:20:24,300 --> 00:20:30,659
that it was run by the services so

432
00:20:27,980 --> 00:20:35,460
automation makes you think about class

433
00:20:30,660 --> 00:20:39,060
IDs things like that so if you look at

434
00:20:35,460 --> 00:20:42,150
TNF details you'll see that varies in

435
00:20:39,060 --> 00:20:44,700
this particular case vo was the world

436
00:20:42,150 --> 00:20:47,700
class ID stored somewhere in an in a

437
00:20:44,700 --> 00:20:50,490
file so what happened if you change that

438
00:20:47,700 --> 00:20:53,340
class ID to something else let's say the

439
00:20:50,490 --> 00:20:55,590
class idea of the equation editor that's

440
00:20:53,340 --> 00:20:57,659
fine it doesn't run in the preview pane

441
00:20:55,590 --> 00:20:59,459
but what happens if you double click

442
00:20:57,660 --> 00:21:03,540
that tonight if you just open it very

443
00:20:59,460 --> 00:21:06,330
good so thing here now about VA question

444
00:21:03,540 --> 00:21:09,389
bugs that we got two years ago something

445
00:21:06,330 --> 00:21:11,730
a lot which were amazingly reliable yeah

446
00:21:09,390 --> 00:21:15,330
so this is something that was triggered

447
00:21:11,730 --> 00:21:18,990
or from the preview been as well going

448
00:21:15,330 --> 00:21:21,300
to touch more not from repeat from the

449
00:21:18,990 --> 00:21:24,720
preview pen sorry but just a click away

450
00:21:21,300 --> 00:21:30,659
going to talk more now about audio

451
00:21:24,720 --> 00:21:32,400
objects so first how to create message

452
00:21:30,660 --> 00:21:34,950
files the everything is all

453
00:21:32,400 --> 00:21:37,740
interconnected so you can ever use

454
00:21:34,950 --> 00:21:39,450
outlook click on paste on the on your

455
00:21:37,740 --> 00:21:42,030
desktop and that will generate yourself

456
00:21:39,450 --> 00:21:45,630
some some nice semi sacrifice or you can

457
00:21:42,030 --> 00:21:47,460
use the interrupt libraries I advise you

458
00:21:45,630 --> 00:21:51,030
to take that one because you can then

459
00:21:47,460 --> 00:21:53,330
get custom properties with this and then

460
00:21:51,030 --> 00:21:57,060
what happens that if you open that

461
00:21:53,330 --> 00:22:00,389
storage with another storage you'll see

462
00:21:57,060 --> 00:22:01,750
all the streams and substrate so what

463
00:22:00,390 --> 00:22:06,110
are

464
00:22:01,750 --> 00:22:08,360
so what's the relationship between those

465
00:22:06,110 --> 00:22:11,389
formats that outlook support dot email

466
00:22:08,360 --> 00:22:16,459
and dot MSG dot e mail we just saw it

467
00:22:11,390 --> 00:22:21,380
with Virginia so be aware that TANF

468
00:22:16,460 --> 00:22:24,650
property as like three characteristics

469
00:22:21,380 --> 00:22:32,120
so it's PID it's typed and of course its

470
00:22:24,650 --> 00:22:34,880
value you can see them also in message

471
00:22:32,120 --> 00:22:38,209
storage look for example for the

472
00:22:34,880 --> 00:22:40,550
property string this strain in this

473
00:22:38,210 --> 00:22:44,800
string you will see a list of properties

474
00:22:40,550 --> 00:22:47,720
over all of them included on ten bytes

475
00:22:44,800 --> 00:22:48,470
I'll give you one example here frozen or

476
00:22:47,720 --> 00:22:51,290
this one

477
00:22:48,470 --> 00:22:53,060
it turns with off reef that means we are

478
00:22:51,290 --> 00:22:55,850
dealing Vanna teacher so these are

479
00:22:53,060 --> 00:22:57,560
respecting to probe our types so if

480
00:22:55,850 --> 00:22:59,360
you're familiar with that there's no

481
00:22:57,560 --> 00:23:02,870
surprise there are three for integer

482
00:22:59,360 --> 00:23:06,379
eight for Strings nine for objects etc

483
00:23:02,870 --> 00:23:08,689
etcetera etcetera and here one F for

484
00:23:06,380 --> 00:23:11,060
Unicode strings and since that's

485
00:23:08,690 --> 00:23:13,580
properties are should only be stored on

486
00:23:11,060 --> 00:23:15,679
ten bytes if you've got a string or a

487
00:23:13,580 --> 00:23:19,220
byte array then obviously you need more

488
00:23:15,680 --> 00:23:20,930
space and that's where you see that's

489
00:23:19,220 --> 00:23:25,250
the reason why there are all the sub

490
00:23:20,930 --> 00:23:28,040
storages audio objects no everything is

491
00:23:25,250 --> 00:23:30,950
interconnected as I told you so if you

492
00:23:28,040 --> 00:23:32,990
embed an audio object in an email you'll

493
00:23:30,950 --> 00:23:36,020
see something like that roughly you will

494
00:23:32,990 --> 00:23:41,260
see a new sub storage which ends with OD

495
00:23:36,020 --> 00:23:44,360
which is a severe type for AVG unknown

496
00:23:41,260 --> 00:23:44,990
and then you'll see also the sub

497
00:23:44,360 --> 00:23:47,149
storages

498
00:23:44,990 --> 00:23:49,820
so you're curious you know about half a

499
00:23:47,150 --> 00:23:51,680
half is at a comedy the flash object and

500
00:23:49,820 --> 00:23:54,980
you know if you've seen his talk in cat

501
00:23:51,680 --> 00:23:57,830
sake it we in cats act 2017

502
00:23:54,980 --> 00:24:00,440
he said that after the fix something

503
00:23:57,830 --> 00:24:02,540
we're still happening she said that she

504
00:24:00,440 --> 00:24:05,180
was still able to load the flash library

505
00:24:02,540 --> 00:24:07,879
but for some reason his payload wasn't

506
00:24:05,180 --> 00:24:11,000
was unloaded so you want to you want

507
00:24:07,880 --> 00:24:13,250
permit to dig a bit this aria you want

508
00:24:11,000 --> 00:24:15,000
to see what's what's happening here so I

509
00:24:13,250 --> 00:24:16,560
prefer that you don't have the same

510
00:24:15,000 --> 00:24:19,020
for fees but you do have those and for

511
00:24:16,560 --> 00:24:21,659
windows so here just put your bike pants

512
00:24:19,020 --> 00:24:25,020
on the usual suspect Rick last name or

513
00:24:21,660 --> 00:24:27,720
they open storage etc etc and you see

514
00:24:25,020 --> 00:24:31,200
where I'm going in Vienna you will reach

515
00:24:27,720 --> 00:24:33,540
all yellowed and if you've looked at the

516
00:24:31,200 --> 00:24:34,020
exploits that we received in the past

517
00:24:33,540 --> 00:24:38,159
years

518
00:24:34,020 --> 00:24:39,780
those were invoking monikers and you see

519
00:24:38,160 --> 00:24:42,450
where I'm going now how to invoke

520
00:24:39,780 --> 00:24:45,750
monikers from an email just with oli

521
00:24:42,450 --> 00:24:49,890
dude anything modifying that's all you

522
00:24:45,750 --> 00:24:51,840
stream so when you do that you're going

523
00:24:49,890 --> 00:24:57,030
to reach one function R in moniker

524
00:24:51,840 --> 00:24:59,850
string which is just going to create an

525
00:24:57,030 --> 00:25:00,530
object for you and bend it to VI persist

526
00:24:59,850 --> 00:25:12,840
string

527
00:25:00,530 --> 00:25:14,730
yeah only load from stream sorry so I

528
00:25:12,840 --> 00:25:17,580
give you now a few examples of this

529
00:25:14,730 --> 00:25:20,370
moniker so you can abuse them in an

530
00:25:17,580 --> 00:25:23,760
Outlook so there's a friend will doorman

531
00:25:20,370 --> 00:25:26,909
who reported as a bug about two four

532
00:25:23,760 --> 00:25:29,820
years ago Santa got him way was doing he

533
00:25:26,910 --> 00:25:33,060
was using outlook I've seen 97 maybe

534
00:25:29,820 --> 00:25:36,210
2000 something very old he was inserting

535
00:25:33,060 --> 00:25:38,820
an object in that in his email and then

536
00:25:36,210 --> 00:25:41,670
she was linking that object to remote

537
00:25:38,820 --> 00:25:44,340
share so his concern was obviously that

538
00:25:41,670 --> 00:25:47,070
when this email was opening the preview

539
00:25:44,340 --> 00:25:49,350
pane then you would see some traffic you

540
00:25:47,070 --> 00:25:51,419
could capture Sun in and then GL Amash

541
00:25:49,350 --> 00:25:54,570
etcetera etcetera and then he figure out

542
00:25:51,420 --> 00:25:56,730
and what if I combine that to an SME

543
00:25:54,570 --> 00:26:00,300
vulnerability and this is what he what

544
00:25:56,730 --> 00:26:03,630
he did so I was cool he had his es Verde

545
00:26:00,300 --> 00:26:06,030
and oh yeah so this is not the best

546
00:26:03,630 --> 00:26:08,490
attack but that's still that's still a

547
00:26:06,030 --> 00:26:10,889
good attack a bit more with a fine

548
00:26:08,490 --> 00:26:13,850
moniker if you've ever reversed it

549
00:26:10,890 --> 00:26:16,020
varies assumption there that is cold

550
00:26:13,850 --> 00:26:18,929
whose name is restore

551
00:26:16,020 --> 00:26:22,680
shall link so things that with the five

552
00:26:18,930 --> 00:26:24,600
monitor you can even invoke windows chat

553
00:26:22,680 --> 00:26:26,850
links so if you've got variability

554
00:26:24,600 --> 00:26:27,270
affecting the shellings you can trigger

555
00:26:26,850 --> 00:26:29,730
it

556
00:26:27,270 --> 00:26:33,210
from the preview pane here's an example

557
00:26:29,730 --> 00:26:35,430
of something that I found a couple of

558
00:26:33,210 --> 00:26:38,030
years ago while doing some totally

559
00:26:35,430 --> 00:26:42,300
different research I was looking at

560
00:26:38,030 --> 00:26:45,770
links and especially specifically links

561
00:26:42,300 --> 00:26:48,810
generated by the windows research

562
00:26:45,770 --> 00:26:51,379
feature and it turns out that when I

563
00:26:48,810 --> 00:26:54,570
found a bug there and I realized that

564
00:26:51,380 --> 00:26:56,490
all of this was connected with the five

565
00:26:54,570 --> 00:26:59,399
monitor and so I realized that it was

566
00:26:56,490 --> 00:27:01,380
possible to embed that in an email as

567
00:26:59,400 --> 00:27:04,520
well and trigger it from the preview

568
00:27:01,380 --> 00:27:07,740
pane things that I haven't tried are

569
00:27:04,520 --> 00:27:11,430
this box that does load library issues

570
00:27:07,740 --> 00:27:15,300
that effect that were affecting the

571
00:27:11,430 --> 00:27:17,040
windows shell component I I'm wondering

572
00:27:15,300 --> 00:27:20,220
if this works in animal I haven't tried

573
00:27:17,040 --> 00:27:20,970
that but perhaps maybe I give you

574
00:27:20,220 --> 00:27:23,820
another example

575
00:27:20,970 --> 00:27:27,360
novio bref moniker so I did that

576
00:27:23,820 --> 00:27:30,929
research in summer 2016 and at that

577
00:27:27,360 --> 00:27:32,909
moment I wasn't aware of where or you

578
00:27:30,930 --> 00:27:35,160
could do with this moniker and thinking

579
00:27:32,910 --> 00:27:38,190
for example about gems attack with a new

580
00:27:35,160 --> 00:27:39,870
moniker I'm thinking about soap moniker

581
00:27:38,190 --> 00:27:42,240
exploits that we've seen I didn't know

582
00:27:39,870 --> 00:27:45,750
about that but I'm quite happy actually

583
00:27:42,240 --> 00:27:48,840
that I took this one as as a target you

584
00:27:45,750 --> 00:27:51,240
see so what's this one this one allows

585
00:27:48,840 --> 00:27:53,129
you to unmarshal an object from the

586
00:27:51,240 --> 00:27:57,900
stream an object that was marshaled

587
00:27:53,130 --> 00:28:05,610
with with a proper motor that's going

588
00:27:57,900 --> 00:28:07,620
down still far from calc so in this

589
00:28:05,610 --> 00:28:10,770
attack I know that I'm able to invoke

590
00:28:07,620 --> 00:28:13,610
sure something from my email but what I

591
00:28:10,770 --> 00:28:17,700
can call commercial interface on

592
00:28:13,610 --> 00:28:20,669
something I've got a list of unmarshal

593
00:28:17,700 --> 00:28:23,580
of objects of libraries that I know

594
00:28:20,670 --> 00:28:27,000
cannot mark her object so what I did was

595
00:28:23,580 --> 00:28:29,949
just go after them one by one and see if

596
00:28:27,000 --> 00:28:32,140
I could see something interesting and I

597
00:28:29,950 --> 00:28:34,450
and I stumbled upon this one it's a

598
00:28:32,140 --> 00:28:37,030
video controller and if you look at the

599
00:28:34,450 --> 00:28:40,480
C component types control you will see

600
00:28:37,030 --> 00:28:43,420
that on the load method it's taking a

601
00:28:40,480 --> 00:28:46,810
counter and then it's iterating in a for

602
00:28:43,420 --> 00:28:51,190
loop is just reading streams and cook

603
00:28:46,810 --> 00:28:54,820
treating an object on VI / C string in

604
00:28:51,190 --> 00:28:56,620
it this time interface and if you're

605
00:28:54,820 --> 00:28:59,950
familiar with flash you'll know that

606
00:28:56,620 --> 00:29:01,870
this is what flash used to be

607
00:28:59,950 --> 00:29:04,780
initialized so at that moment I knew

608
00:29:01,870 --> 00:29:06,250
that I was able to load a flash to load

609
00:29:04,780 --> 00:29:09,160
the flash controller and potentially

610
00:29:06,250 --> 00:29:12,940
find the flash here all day to get code

611
00:29:09,160 --> 00:29:15,850
acquisition I was at Microsoft for about

612
00:29:12,940 --> 00:29:18,580
a year and at that moment somebody told

613
00:29:15,850 --> 00:29:20,230
me Nico you add Microsoft now so you

614
00:29:18,580 --> 00:29:22,659
need to leave either be alone you have

615
00:29:20,230 --> 00:29:24,520
to find bugs in max of products all

616
00:29:22,660 --> 00:29:27,610
right fair enough so I did something

617
00:29:24,520 --> 00:29:30,220
else done I found another control I

618
00:29:27,610 --> 00:29:33,250
found the XML feed moniker how did I

619
00:29:30,220 --> 00:29:36,220
found that one where no secret actually

620
00:29:33,250 --> 00:29:39,280
very aware about like 7,000 controls on

621
00:29:36,220 --> 00:29:42,520
my machine I just loaded them or with

622
00:29:39,280 --> 00:29:45,639
some HTML with some scripts etc until

623
00:29:42,520 --> 00:29:48,670
this one popped up and I this way I

624
00:29:45,640 --> 00:29:52,030
managed to execute a VB script from my

625
00:29:48,670 --> 00:29:53,710
email I was still just a bit away from

626
00:29:52,030 --> 00:29:55,240
my card because I couldn't use for

627
00:29:53,710 --> 00:29:57,670
example to the fight system object or

628
00:29:55,240 --> 00:30:00,280
stuff like this so at that moment where

629
00:29:57,670 --> 00:30:05,170
where I used VB 0 because we're you know

630
00:30:00,280 --> 00:30:07,450
there are some so what's interesting in

631
00:30:05,170 --> 00:30:11,890
this attacks is all the bugs that have

632
00:30:07,450 --> 00:30:14,260
been fixed after so video control for

633
00:30:11,890 --> 00:30:17,680
example I've been told that bugs

634
00:30:14,260 --> 00:30:21,300
affecting vien Mosher are very important

635
00:30:17,680 --> 00:30:26,230
windows and so few of them got fixed

636
00:30:21,300 --> 00:30:28,870
also how come activation filter you will

637
00:30:26,230 --> 00:30:31,630
get we got rid of the XML feed a moniker

638
00:30:28,870 --> 00:30:34,120
one that I just mentioned and also via

639
00:30:31,630 --> 00:30:36,340
breath I think you can still load it

640
00:30:34,120 --> 00:30:38,699
from Visio but that's probably another

641
00:30:36,340 --> 00:30:38,699
story

642
00:30:39,260 --> 00:30:44,580
do not load the objects in the pain I'm

643
00:30:42,570 --> 00:30:46,260
not saying the preview panel here I'm

644
00:30:44,580 --> 00:30:48,360
just saying the pain because it turns

645
00:30:46,260 --> 00:30:50,550
out that when you reply to an email or

646
00:30:48,360 --> 00:30:53,479
when you forward an email you're going

647
00:30:50,550 --> 00:30:57,560
to hit a different code and there were

648
00:30:53,480 --> 00:31:00,900
cases where you could get cut Egyptian

649
00:30:57,560 --> 00:31:02,070
with and only object like for example by

650
00:31:00,900 --> 00:31:04,890
replying to an email

651
00:31:02,070 --> 00:31:07,080
knowing we open super six and a Verbier

652
00:31:04,890 --> 00:31:10,080
vbscript dog I don't have the CV but

653
00:31:07,080 --> 00:31:13,500
anyway but what's worth mentioning is

654
00:31:10,080 --> 00:31:15,000
that nowadays on c2 are it's no longer

655
00:31:13,500 --> 00:31:18,540
possible to load vbscript

656
00:31:15,000 --> 00:31:21,270
Vieira and also restrict objects loaded

657
00:31:18,540 --> 00:31:23,070
by the diagnostic service and if you

658
00:31:21,270 --> 00:31:26,660
followed this presentation so far it

659
00:31:23,070 --> 00:31:26,659
should be like what is he talking about

660
00:31:27,260 --> 00:31:33,320
think about the common marshalling this

661
00:31:31,020 --> 00:31:37,650
is extensively used by the system

662
00:31:33,320 --> 00:31:40,169
everywhere variants when they are sent

663
00:31:37,650 --> 00:31:42,390
from one processed whenever we are more

664
00:31:40,170 --> 00:31:45,660
short and then on marshaled that's the

665
00:31:42,390 --> 00:31:48,240
same force a phrase so now think about

666
00:31:45,660 --> 00:31:51,090
safer eyes when you use something like

667
00:31:48,240 --> 00:31:53,790
that in your code you're not specifying

668
00:31:51,090 --> 00:31:56,100
the type of VRA you're just saying that

669
00:31:53,790 --> 00:31:58,800
this method except a safe erase and then

670
00:31:56,100 --> 00:32:00,870
you do your check say that you have got

671
00:31:58,800 --> 00:32:03,300
a metered that that's going to parse an

672
00:32:00,870 --> 00:32:05,610
array of strings then you accept a safe

673
00:32:03,300 --> 00:32:08,460
array and then you check only intimated

674
00:32:05,610 --> 00:32:11,219
that safe array is actually actually

675
00:32:08,460 --> 00:32:14,780
contain strings the thing is at that

676
00:32:11,220 --> 00:32:17,490
moment the attacker can provide whatever

677
00:32:14,780 --> 00:32:20,540
you can provide integers can provide

678
00:32:17,490 --> 00:32:23,580
objects that that check is done after

679
00:32:20,540 --> 00:32:27,649
death objects have been loaded so the

680
00:32:23,580 --> 00:32:31,800
question is can I find an application

681
00:32:27,650 --> 00:32:34,200
that that is interesting for an attacker

682
00:32:31,800 --> 00:32:36,120
perspective that can load those objects

683
00:32:34,200 --> 00:32:39,030
it turns out that varies at least one

684
00:32:36,120 --> 00:32:41,300
exists very the first broker but any

685
00:32:39,030 --> 00:32:44,490
code don't do flash attack Adobe Flash

686
00:32:41,300 --> 00:32:47,340
this diagnostic service I didn't know

687
00:32:44,490 --> 00:32:48,840
about it a point when 2016 Loki heart he

688
00:32:47,340 --> 00:32:51,179
pops pops out

689
00:32:48,840 --> 00:32:51,669
was it ie edge don't remember but anyway

690
00:32:51,180 --> 00:32:53,620
so

691
00:32:51,670 --> 00:32:55,210
privileged desperation bugs was very

692
00:32:53,620 --> 00:32:57,729
interesting there it was just a load

693
00:32:55,210 --> 00:33:00,280
library to get system and when you look

694
00:32:57,730 --> 00:33:02,800
at that your right leg how am I supposed

695
00:33:00,280 --> 00:33:05,050
to know that this means exists so this

696
00:33:02,800 --> 00:33:07,840
is how I became aware of this component

697
00:33:05,050 --> 00:33:10,300
and you know what this component it

698
00:33:07,840 --> 00:33:14,409
implements one meter called dead graph

699
00:33:10,300 --> 00:33:19,300
data rate and these meters is quite cool

700
00:33:14,410 --> 00:33:21,610
because it accepts a safe array and we

701
00:33:19,300 --> 00:33:26,169
only think that that scepter safer makes

702
00:33:21,610 --> 00:33:29,409
it that so target that I was after so

703
00:33:26,170 --> 00:33:32,650
I've got a diamond for you so it just

704
00:33:29,410 --> 00:33:35,380
about sending an email and then viewing

705
00:33:32,650 --> 00:33:39,160
in viewing it in the preview pane to get

706
00:33:35,380 --> 00:33:44,350
your code execution it's not instantly

707
00:33:39,160 --> 00:33:46,810
because well when I did that Rob I was

708
00:33:44,350 --> 00:33:48,610
just after looking after create process

709
00:33:46,810 --> 00:33:55,260
something easy so it takes like a couple

710
00:33:48,610 --> 00:33:58,000
of seconds superb but still works is it

711
00:33:55,260 --> 00:34:00,640
an attack that works only on my box

712
00:33:58,000 --> 00:34:02,770
because it's memory corruption no it

713
00:34:00,640 --> 00:34:05,140
does works and I've experimented on a

714
00:34:02,770 --> 00:34:07,210
couple of my colleagues and I've been

715
00:34:05,140 --> 00:34:10,540
told not to do that again so I haven't

716
00:34:07,210 --> 00:34:13,210
done it again so that's it for for

717
00:34:10,540 --> 00:34:16,120
outlook so I hope that you enjoyed this

718
00:34:13,210 --> 00:34:19,150
part learn some things and hopefully

719
00:34:16,120 --> 00:34:24,040
that this part your curiosity I'm now

720
00:34:19,150 --> 00:34:26,320
going to talk about exchange so my main

721
00:34:24,040 --> 00:34:30,909
issue when I'm going after our new

722
00:34:26,320 --> 00:34:32,470
target is to find attacks that have been

723
00:34:30,909 --> 00:34:35,109
seen in the while

724
00:34:32,469 --> 00:34:37,389
how say that I'm unfamiliar with a

725
00:34:35,110 --> 00:34:39,190
target like exchange when I started to

726
00:34:37,389 --> 00:34:42,219
look at it I've never looked at it

727
00:34:39,190 --> 00:34:44,740
before so I'm like how am I going to

728
00:34:42,219 --> 00:34:47,409
approach that so first you try to look

729
00:34:44,739 --> 00:34:50,500
for attacks that exist dogs that have

730
00:34:47,409 --> 00:34:53,969
been previously fix learn that many I

731
00:34:50,500 --> 00:34:57,370
think it's worth quoting shadow brokers

732
00:34:53,969 --> 00:34:58,890
Englishmen dentists exploit this one was

733
00:34:57,370 --> 00:35:02,910
affecting

734
00:34:58,890 --> 00:35:05,750
exchange 2003 on Windows Server 2003 to

735
00:35:02,910 --> 00:35:08,850
earn 2019 here so you can see that dates

736
00:35:05,750 --> 00:35:09,900
but basically the attack was you were

737
00:35:08,850 --> 00:35:14,310
sending an email

738
00:35:09,900 --> 00:35:18,030
carrying weird attachment picture and

739
00:35:14,310 --> 00:35:21,180
then on Windows Server 2003 there were

740
00:35:18,030 --> 00:35:24,060
no d-32 and we are meted that was

741
00:35:21,180 --> 00:35:27,060
parsing much pictures and then there was

742
00:35:24,060 --> 00:35:29,250
I think Stack Overflow where and this is

743
00:35:27,060 --> 00:35:33,630
what we were exploiting well it works

744
00:35:29,250 --> 00:35:36,360
but on very former versions all versions

745
00:35:33,630 --> 00:35:38,730
I mentioned about something that Adi

746
00:35:36,360 --> 00:35:41,400
sent us last year was quite good

747
00:35:38,730 --> 00:35:43,920
unfortunately not email related but

748
00:35:41,400 --> 00:35:46,170
still direct that attack it's it's been

749
00:35:43,920 --> 00:35:48,540
blogged on their website so go have a

750
00:35:46,170 --> 00:35:52,950
look even at family are livid but it was

751
00:35:48,540 --> 00:35:55,860
involving voicemail message so it makes

752
00:35:52,950 --> 00:35:58,759
it quite quite cool as well but nothing

753
00:35:55,860 --> 00:36:01,680
are related to animal attack

754
00:35:58,760 --> 00:36:03,120
unfortunately so think about the

755
00:36:01,680 --> 00:36:06,779
scenarios here

756
00:36:03,120 --> 00:36:09,540
what are we targeting exactly are we are

757
00:36:06,780 --> 00:36:11,430
we playing authenticated do I know of my

758
00:36:09,540 --> 00:36:14,730
account and am I trying to ascribe my

759
00:36:11,430 --> 00:36:17,660
privilege or am I going completely on

760
00:36:14,730 --> 00:36:20,910
authenticated saying sending emails and

761
00:36:17,660 --> 00:36:23,430
triggering hopefully triggering a bug

762
00:36:20,910 --> 00:36:25,350
that will give me code execution am i

763
00:36:23,430 --> 00:36:31,470
replaying tokens playing with some web

764
00:36:25,350 --> 00:36:34,920
issues nowadays exchange is pretty much

765
00:36:31,470 --> 00:36:37,790
entirely coded in dotnet so that leaves

766
00:36:34,920 --> 00:36:40,590
a very small room for memory corruption

767
00:36:37,790 --> 00:36:42,150
is it still possible to do that well

768
00:36:40,590 --> 00:36:45,270
we're still a couple of components that

769
00:36:42,150 --> 00:36:47,820
were returning C C++ and for example X

770
00:36:45,270 --> 00:36:50,820
RPC 30 to come back to that in a second

771
00:36:47,820 --> 00:36:54,120
but first some tools of course MFC mappy

772
00:36:50,820 --> 00:36:56,310
if you've ever looked at that it's a

773
00:36:54,120 --> 00:36:58,950
real powerful tool that allows you to

774
00:36:56,310 --> 00:37:00,900
open your your mailbox

775
00:36:58,950 --> 00:37:03,000
an exchange so you can see all the

776
00:37:00,900 --> 00:37:06,480
properties for an email you can see

777
00:37:03,000 --> 00:37:08,840
objects you can even see hidden

778
00:37:06,480 --> 00:37:11,670
kontin tables and this is super useful

779
00:37:08,840 --> 00:37:15,570
because versiv on the feature where you

780
00:37:11,670 --> 00:37:17,700
can drop these objects as an email file

781
00:37:15,570 --> 00:37:20,340
where a teeny FL so if you're for

782
00:37:17,700 --> 00:37:23,580
example looking after a corpus or side

783
00:37:20,340 --> 00:37:26,670
you can use that tool and and drop

784
00:37:23,580 --> 00:37:28,860
there's the CNAs objects on your drive I

785
00:37:26,670 --> 00:37:32,430
found a couple of bugs just using that

786
00:37:28,860 --> 00:37:35,970
just using properties that had been

787
00:37:32,430 --> 00:37:37,649
written some by some application ever

788
00:37:35,970 --> 00:37:42,660
outlook on exchange and that we are

789
00:37:37,650 --> 00:37:44,970
available on the bait box but I I wasn't

790
00:37:42,660 --> 00:37:46,350
able to load them to create them just

791
00:37:44,970 --> 00:37:47,879
from animate but it turns out that they

792
00:37:46,350 --> 00:37:51,240
were of there so I just wrap them and

793
00:37:47,880 --> 00:37:53,340
then replay them and yeah that that was

794
00:37:51,240 --> 00:37:55,609
enough to to get some bugs so think

795
00:37:53,340 --> 00:37:59,340
about it if you if you look at it now

796
00:37:55,610 --> 00:38:01,980
let me come back to XR PCM so that's one

797
00:37:59,340 --> 00:38:08,370
of the very few libraries that are still

798
00:38:01,980 --> 00:38:10,260
coded in c++ c c++ when I looked at that

799
00:38:08,370 --> 00:38:11,730
when I started to reverse that code I

800
00:38:10,260 --> 00:38:15,390
quickly noticed that there are a couple

801
00:38:11,730 --> 00:38:17,640
of functions that we're parsing T n AF

802
00:38:15,390 --> 00:38:20,180
properties so I was like yeah this is

803
00:38:17,640 --> 00:38:23,400
exactly what I'm looking after and then

804
00:38:20,180 --> 00:38:25,890
what I'm looking for and then you start

805
00:38:23,400 --> 00:38:28,200
to realize how the code is formatted so

806
00:38:25,890 --> 00:38:30,330
basically we are doing checks on the

807
00:38:28,200 --> 00:38:32,040
properties like you've got properties

808
00:38:30,330 --> 00:38:35,520
like strength properties for example

809
00:38:32,040 --> 00:38:37,410
you're only accepting unci strings or

810
00:38:35,520 --> 00:38:40,290
unicode strings if you provide something

811
00:38:37,410 --> 00:38:42,330
like an integer it gets rejected and it

812
00:38:40,290 --> 00:38:45,990
gets done for premature old properties

813
00:38:42,330 --> 00:38:49,980
all the properties but - so first one

814
00:38:45,990 --> 00:38:54,839
I'm going to talk about is the one could

815
00:38:49,980 --> 00:38:57,180
conflict entry ID so on this one there

816
00:38:54,840 --> 00:38:59,280
was no type check on the property so

817
00:38:57,180 --> 00:39:02,549
this one this one is specifically

818
00:38:59,280 --> 00:39:06,000
accepting a byte array this is a battery

819
00:39:02,550 --> 00:39:09,180
property and you can see in in this code

820
00:39:06,000 --> 00:39:12,240
that it's coding easy parse entry ID and

821
00:39:09,180 --> 00:39:15,598
this function explicitly

822
00:39:12,240 --> 00:39:17,819
except bytearray in our grant so what

823
00:39:15,599 --> 00:39:20,010
happens if for Ag for example you give

824
00:39:17,820 --> 00:39:23,130
it an integer where do you get a type

825
00:39:20,010 --> 00:39:25,680
confusion can you exploit that

826
00:39:23,130 --> 00:39:28,800
I'm skeptical the reason is that

827
00:39:25,680 --> 00:39:32,190
variance on 64-bit are encoded on 18

828
00:39:28,800 --> 00:39:36,690
bytes in X and that first 10 bytes are

829
00:39:32,190 --> 00:39:38,940
well to bite so first 8 bytes are

830
00:39:36,690 --> 00:39:40,260
reserved for the type and then you you

831
00:39:38,940 --> 00:39:42,510
could potentially get a confusion

832
00:39:40,260 --> 00:39:46,140
between the bytes at offset 8 and that

833
00:39:42,510 --> 00:39:47,609
of say 10 but can you get an interest in

834
00:39:46,140 --> 00:39:50,629
confusion something that you can

835
00:39:47,609 --> 00:39:52,619
actually abuse and skeptical about that

836
00:39:50,630 --> 00:39:55,560
reason is that there are not that many

837
00:39:52,619 --> 00:39:58,380
types supported by by exchanges so I

838
00:39:55,560 --> 00:40:00,119
think it's at work so those and in that

839
00:39:58,380 --> 00:40:02,820
case what happens is that the delivery

840
00:40:00,119 --> 00:40:04,530
process just restarts so it's just a

841
00:40:02,820 --> 00:40:08,160
temporary dose but you can stack emails

842
00:40:04,530 --> 00:40:11,130
and it said that I send you like 24

843
00:40:08,160 --> 00:40:13,348
emails with this vulnerability see

844
00:40:11,130 --> 00:40:16,230
delivery process will crash and respond

845
00:40:13,349 --> 00:40:19,560
within like five six minutes so you send

846
00:40:16,230 --> 00:40:24,089
24 email like this and yeah you see you

847
00:40:19,560 --> 00:40:26,640
can get a cool device but still that's

848
00:40:24,089 --> 00:40:29,509
not what I was looking for I'm Joe very

849
00:40:26,640 --> 00:40:32,940
property was a post reply for the probe

850
00:40:29,510 --> 00:40:35,250
post reply folder entries now this one I

851
00:40:32,940 --> 00:40:36,930
thought maybe very so type confusion

852
00:40:35,250 --> 00:40:38,820
confusion here as well because I

853
00:40:36,930 --> 00:40:42,330
couldn't see as a check at the entry

854
00:40:38,820 --> 00:40:45,720
point when before it turns out that you

855
00:40:42,330 --> 00:40:49,290
can do that cuz Gary's check there but

856
00:40:45,720 --> 00:40:51,810
what caught my eyes was that loop there

857
00:40:49,290 --> 00:40:53,759
was a loop in that code and I could see

858
00:40:51,810 --> 00:40:57,630
that I could hear was trying to write

859
00:40:53,760 --> 00:41:00,530
data to that that property to the byte

860
00:40:57,630 --> 00:41:03,980
array that we provided to a function

861
00:41:00,530 --> 00:41:08,550
things that there was no bun check on

862
00:41:03,980 --> 00:41:12,470
one one bit so the attack that I had at

863
00:41:08,550 --> 00:41:17,040
that moment I was able to alter one bit

864
00:41:12,470 --> 00:41:20,770
ons on the last century of the least

865
00:41:17,040 --> 00:41:23,740
provided by laboratory so I've got

866
00:41:20,770 --> 00:41:26,530
seven minutes left so it must be like a

867
00:41:23,740 --> 00:41:31,118
complete gated exploits so why do you

868
00:41:26,530 --> 00:41:33,250
think I did anyone I did nothing I did

869
00:41:31,119 --> 00:41:38,520
nothing because it was just too hard

870
00:41:33,250 --> 00:41:42,280
I spent probably two two weeks on this

871
00:41:38,520 --> 00:41:44,200
so let me correct that - nsrc weeks that

872
00:41:42,280 --> 00:41:46,359
means that I'm not on sorry focused on

873
00:41:44,200 --> 00:41:46,899
that I'm also focused on saying saving

874
00:41:46,359 --> 00:41:50,109
the world

875
00:41:46,900 --> 00:41:52,150
this is that takes time but in Vienna I

876
00:41:50,109 --> 00:41:54,098
did I couldn't manage to get an expert

877
00:41:52,150 --> 00:41:57,520
for either I've only looked at it on the

878
00:41:54,099 --> 00:41:59,770
on the exchange 2016 so maybe it's

879
00:41:57,520 --> 00:42:02,680
possible to get an expert for your lower

880
00:41:59,770 --> 00:42:06,490
versions I don't know I'm again

881
00:42:02,680 --> 00:42:08,740
skeptical about this reason is some hip

882
00:42:06,490 --> 00:42:10,629
specifications but you know what I'd

883
00:42:08,740 --> 00:42:12,970
love to be proven wrong on this so if

884
00:42:10,630 --> 00:42:16,300
you guys want to look at it and tell me

885
00:42:12,970 --> 00:42:21,220
how to do it yeah I'd love to say to see

886
00:42:16,300 --> 00:42:22,780
this ready quick notes in conclusion can

887
00:42:21,220 --> 00:42:25,899
we steal through your memory corruption

888
00:42:22,780 --> 00:42:28,960
in exchange these days yes

889
00:42:25,900 --> 00:42:31,089
Thor was unable to exploit these bugs at

890
00:42:28,960 --> 00:42:33,640
least they prove the concept that this

891
00:42:31,089 --> 00:42:36,130
issue still exists I found some of her

892
00:42:33,640 --> 00:42:39,098
interesting issues for example while

893
00:42:36,130 --> 00:42:41,770
parsing the rules but this we're days we

894
00:42:39,099 --> 00:42:43,660
did V attacker weather so to know the

895
00:42:41,770 --> 00:42:45,520
credential of that account so you really

896
00:42:43,660 --> 00:42:47,680
to be authenticated so there was a bit

897
00:42:45,520 --> 00:42:50,200
of hope but I was convinced that at

898
00:42:47,680 --> 00:42:52,660
least one bag was exploitable didn't

899
00:42:50,200 --> 00:42:55,180
write an expert for it but firstly what

900
00:42:52,660 --> 00:42:56,970
else can you guys find I'm very looking

901
00:42:55,180 --> 00:43:00,009
forward to that couple of references

902
00:42:56,970 --> 00:43:01,868
you've got as a civilian question for

903
00:43:00,010 --> 00:43:05,549
the demo on slide free if you want to

904
00:43:01,869 --> 00:43:08,500
leave that and write for an exploit and

905
00:43:05,549 --> 00:43:08,920
and thank you guys thank you for your

906
00:43:08,500 --> 00:43:11,410
attention

907
00:43:08,920 --> 00:43:13,470
I hope you like this

908
00:43:11,410 --> 00:43:13,470
you

