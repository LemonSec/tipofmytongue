1
00:00:00,030 --> 00:00:06,930
good morning<font color="#E5E5E5"> our welcome to the session</font>

2
00:00:02,939 --> 00:00:08,639
<font color="#CCCCCC">evading</font><font color="#E5E5E5"> active directory evading</font>

3
00:00:06,930 --> 00:00:09,690
Microsoft<font color="#CCCCCC"> a da</font><font color="#E5E5E5"> for Active Directory</font>

4
00:00:08,639 --> 00:00:13,579
domination

5
00:00:09,690 --> 00:00:16,230
<font color="#CCCCCC">I am nickel-metal speaker for this talk</font>

6
00:00:13,580 --> 00:00:20,910
before<font color="#CCCCCC"> we begin couple of things about</font>

7
00:00:16,230 --> 00:00:23,490
me<font color="#E5E5E5"> I'm a red teamer</font><font color="#CCCCCC"> hacker</font><font color="#E5E5E5"> speak a lot</font>

8
00:00:20,910 --> 00:00:26,279
at conferences<font color="#E5E5E5"> trainer conferences I'm</font>

9
00:00:23,490 --> 00:00:29,220
with pentesteracademy.com<font color="#CCCCCC"> you can find</font>

10
00:00:26,279 --> 00:00:33,450
me on twitter as<font color="#CCCCCC"> nikhil underscore mi TT</font>

11
00:00:29,220 --> 00:00:36,690
so please go follow me<font color="#CCCCCC"> i blog on lab of</font>

12
00:00:33,450 --> 00:00:40,950
a penetration<font color="#CCCCCC"> tester calm which is my</font>

13
00:00:36,690 --> 00:00:43,589
home on the<font color="#E5E5E5"> interwebs and</font><font color="#CCCCCC"> all my</font><font color="#E5E5E5"> ongoing</font>

14
00:00:40,950 --> 00:00:46,980
projects works research<font color="#E5E5E5"> whatever</font><font color="#CCCCCC"> i like</font>

15
00:00:43,590 --> 00:00:49,170
<font color="#CCCCCC">to blog about it there I maintain to</font>

16
00:00:46,980 --> 00:00:51,180
<font color="#CCCCCC">open-source tool kits on github you can</font>

17
00:00:49,170 --> 00:00:54,270
find me as<font color="#CCCCCC"> Samrat ashok</font><font color="#E5E5E5"> on github</font>

18
00:00:51,180 --> 00:00:57,300
account<font color="#CCCCCC"> alia</font><font color="#E5E5E5"> and nishang</font><font color="#CCCCCC"> Caudill is a</font>

19
00:00:54,270 --> 00:01:00,719
<font color="#E5E5E5">toolkit which you can use to create</font>

20
00:00:57,300 --> 00:01:03,180
<font color="#CCCCCC">ready to use caches for arduino based</font>

21
00:01:00,719 --> 00:01:06,000
devices you burn it to a<font color="#CCCCCC"> unit device</font>

22
00:01:03,180 --> 00:01:09,270
plug it into<font color="#CCCCCC"> to a box and it will do</font>

23
00:01:06,000 --> 00:01:11,430
interesting<font color="#E5E5E5"> stuff</font><font color="#CCCCCC"> for you and nation is</font>

24
00:01:09,270 --> 00:01:15,720
there<font color="#E5E5E5"> are some there</font><font color="#CCCCCC"> are more users of</font>

25
00:01:11,430 --> 00:01:17,549
<font color="#CCCCCC">nishan it's a framework</font><font color="#E5E5E5"> or collection of</font>

26
00:01:15,720 --> 00:01:19,548
<font color="#E5E5E5">powershell scripts which we can use in</font>

27
00:01:17,549 --> 00:01:24,380
various<font color="#CCCCCC"> phases of</font><font color="#E5E5E5"> penetration test</font>

28
00:01:19,549 --> 00:01:26,790
<font color="#CCCCCC">alright I'm generally interested in</font>

29
00:01:24,380 --> 00:01:28,500
<font color="#E5E5E5">different ways of breaking into the</font>

30
00:01:26,790 --> 00:01:31,950
<font color="#E5E5E5">machines</font><font color="#CCCCCC"> where of course</font><font color="#E5E5E5"> I have the</font>

31
00:01:28,500 --> 00:01:35,329
permission<font color="#E5E5E5"> to do so</font><font color="#CCCCCC"> and if there</font><font color="#E5E5E5"> are</font>

32
00:01:31,950 --> 00:01:38,100
<font color="#CCCCCC">difference tools which come in my way</font>

33
00:01:35,329 --> 00:01:41,189
<font color="#CCCCCC">while doing that I would generally like</font>

34
00:01:38,100 --> 00:01:44,158
<font color="#CCCCCC">to find bypasses</font><font color="#E5E5E5"> I previously spoken at</font>

35
00:01:41,189 --> 00:01:46,199
<font color="#CCCCCC">Def Con</font><font color="#E5E5E5"> blackhat multiple times</font>

36
00:01:44,159 --> 00:01:49,409
<font color="#CCCCCC">trained</font><font color="#E5E5E5"> at cancer cursed and few more</font>

37
00:01:46,200 --> 00:01:52,530
conferences<font color="#E5E5E5"> so what we are going to</font>

38
00:01:49,409 --> 00:01:53,070
<font color="#E5E5E5">discuss here is we'll start with what a</font>

39
00:01:52,530 --> 00:01:56,280
<font color="#E5E5E5">TAS</font>

40
00:01:53,070 --> 00:01:59,189
if what is<font color="#E5E5E5"> the architecture if there are</font>

41
00:01:56,280 --> 00:02:01,439
there<font color="#CCCCCC"> are some</font><font color="#E5E5E5"> of you who have not</font><font color="#CCCCCC"> seen</font>

42
00:01:59,189 --> 00:02:03,839
it<font color="#CCCCCC"> or do not</font><font color="#E5E5E5"> know</font><font color="#CCCCCC"> about it we'll quickly</font>

43
00:02:01,439 --> 00:02:07,710
go<font color="#E5E5E5"> through it what are the detections</font>

44
00:02:03,840 --> 00:02:09,569
what are the kind of attacks which 8080

45
00:02:07,710 --> 00:02:12,200
detects what are the alerts how they are

46
00:02:09,568 --> 00:02:19,160
managed<font color="#CCCCCC"> etc then we'll</font>

47
00:02:12,200 --> 00:02:23,359
and see how we can as as a good attacker

48
00:02:19,160 --> 00:02:25,700
how it is possible<font color="#CCCCCC"> to bypass</font><font color="#E5E5E5"> 88 headline</font>

49
00:02:23,360 --> 00:02:28,340
attacks like and useful ones as well as

50
00:02:25,700 --> 00:02:31,970
<font color="#E5E5E5">one like</font><font color="#CCCCCC"> oh pass the hash golden</font><font color="#E5E5E5"> ticket</font>

51
00:02:28,340 --> 00:02:34,610
<font color="#E5E5E5">etc how is it possible to</font><font color="#CCCCCC"> use them</font><font color="#E5E5E5"> and</font>

52
00:02:31,970 --> 00:02:38,450
still not get<font color="#CCCCCC"> detected then we'll move</font>

53
00:02:34,610 --> 00:02:40,250
on see<font color="#E5E5E5"> how we can modify our attack</font>

54
00:02:38,450 --> 00:02:42,170
chains or<font color="#E5E5E5"> penetration testing</font>

55
00:02:40,250 --> 00:02:46,310
methodology or whatever you want<font color="#E5E5E5"> to call</font>

56
00:02:42,170 --> 00:02:49,760
it to simply<font color="#E5E5E5"> avoid talking to the domain</font>

57
00:02:46,310 --> 00:02:51,739
controller<font color="#E5E5E5"> and</font><font color="#CCCCCC"> the say TA then we'll</font>

58
00:02:49,760 --> 00:02:54,560
have a look<font color="#E5E5E5"> at couple of attack chains</font>

59
00:02:51,739 --> 00:02:57,049
or methodologies which assuming the

60
00:02:54,560 --> 00:03:00,620
domain<font color="#E5E5E5"> administration</font><font color="#CCCCCC"> domain admin</font>

61
00:02:57,049 --> 00:03:02,269
privileges are the goal and so domain

62
00:03:00,620 --> 00:03:05,030
dominance that<font color="#E5E5E5"> is once you have domain</font>

63
00:03:02,269 --> 00:03:08,690
<font color="#E5E5E5">admin privileges you can clearly have a</font>

64
00:03:05,030 --> 00:03:13,160
<font color="#E5E5E5">domination over</font><font color="#CCCCCC"> a domain then next comes</font>

65
00:03:08,690 --> 00:03:16,069
<font color="#E5E5E5">attacking a TA or once that we have</font>

66
00:03:13,160 --> 00:03:18,470
enough privileges<font color="#CCCCCC"> is it possible</font><font color="#E5E5E5"> to</font>

67
00:03:16,069 --> 00:03:22,160
attack a TA<font color="#E5E5E5"> in some sense or some method</font>

68
00:03:18,470 --> 00:03:25,220
<font color="#E5E5E5">then we'll conclude</font><font color="#CCCCCC"> with that so what is</font>

69
00:03:22,160 --> 00:03:27,829
Microsoft<font color="#E5E5E5"> a TA so I'll read out the</font>

70
00:03:25,220 --> 00:03:32,540
definition<font color="#E5E5E5"> advanced threat analytics</font><font color="#CCCCCC"> a</font>

71
00:03:27,829 --> 00:03:34,790
TA is an on-premises platform that helps

72
00:03:32,540 --> 00:03:37,010
<font color="#E5E5E5">protect your enterprise from multiple</font>

73
00:03:34,790 --> 00:03:39,828
types of advanced targeted cyber attacks

74
00:03:37,010 --> 00:03:44,260
and insider threats<font color="#E5E5E5"> pretty common when</font>

75
00:03:39,829 --> 00:03:44,260
the definition so how it works is

76
00:03:44,709 --> 00:03:49,280
whatever is the<font color="#E5E5E5"> traffic being sent to</font>

77
00:03:47,450 --> 00:03:51,410
<font color="#E5E5E5">your domain controller one of the domain</font>

78
00:03:49,280 --> 00:03:53,989
<font color="#E5E5E5">controls or all</font><font color="#CCCCCC"> of them depends on the</font>

79
00:03:51,410 --> 00:03:56,569
type<font color="#CCCCCC"> of implementation</font><font color="#E5E5E5"> you want it reads</font>

80
00:03:53,989 --> 00:04:01,700
certain protocols what protocols like

81
00:03:56,569 --> 00:04:03,738
Kerberos<font color="#E5E5E5"> DNS LDAP SMB etc the read this</font>

82
00:04:01,700 --> 00:04:07,358
<font color="#E5E5E5">tool or the</font><font color="#CCCCCC"> censors of this tool reads</font>

83
00:04:03,739 --> 00:04:13,639
those protocols<font color="#E5E5E5"> and then try to detect</font>

84
00:04:07,359 --> 00:04:16,370
an attacker<font color="#E5E5E5"> in two ways anomaly and user</font>

85
00:04:13,639 --> 00:04:18,109
behavior<font color="#CCCCCC"> UBA so in this talk</font><font color="#E5E5E5"> we</font><font color="#CCCCCC"> are</font>

86
00:04:16,370 --> 00:04:21,168
<font color="#E5E5E5">going to focus on the animal based</font>

87
00:04:18,108 --> 00:04:23,450
attacks which attack on day<font color="#E5E5E5"> 180 has I</font>

88
00:04:21,168 --> 00:04:25,880
<font color="#E5E5E5">think 21 days of learning period before</font>

89
00:04:23,450 --> 00:04:28,760
<font color="#E5E5E5">it can start</font>

90
00:04:25,880 --> 00:04:30,800
in this 21 days period<font color="#CCCCCC"> it builds a</font>

91
00:04:28,760 --> 00:04:34,820
<font color="#E5E5E5">profile of each and every user</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> box</font>

92
00:04:30,800 --> 00:04:38,390
<font color="#E5E5E5">and then it can</font><font color="#CCCCCC"> actually detect</font><font color="#E5E5E5"> UBA or</font>

93
00:04:34,820 --> 00:04:40,490
behavior<font color="#E5E5E5"> a detection</font><font color="#CCCCCC"> but the animal</font>

94
00:04:38,390 --> 00:04:42,200
detection<font color="#E5E5E5"> starts from day one and that</font>

95
00:04:40,490 --> 00:04:47,480
<font color="#E5E5E5">is something which</font><font color="#CCCCCC"> we are going</font><font color="#E5E5E5"> to focus</font>

96
00:04:42,200 --> 00:04:49,849
on on the<font color="#E5E5E5"> talk the lab configuration</font>

97
00:04:47,480 --> 00:04:51,860
which<font color="#E5E5E5"> I have used and which I'll be</font>

98
00:04:49,850 --> 00:04:54,680
going to use for the live demonstrations

99
00:04:51,860 --> 00:04:57,760
<font color="#E5E5E5">so I've worked on</font><font color="#CCCCCC"> a TA one dot sound</font>

100
00:04:54,680 --> 00:04:59,930
then 1.8 came I came<font color="#E5E5E5"> out like last month</font>

101
00:04:57,760 --> 00:05:01,390
<font color="#E5E5E5">tested interesting things on</font><font color="#CCCCCC"> that as</font>

102
00:04:59,930 --> 00:05:05,120
well

103
00:05:01,390 --> 00:05:07,520
the<font color="#E5E5E5"> ATS sensors for installation in my</font>

104
00:05:05,120 --> 00:05:09,800
environment<font color="#E5E5E5"> it has been used in my</font>

105
00:05:07,520 --> 00:05:11,659
classes as<font color="#E5E5E5"> well so more than</font><font color="#CCCCCC"> 400</font>

106
00:05:09,800 --> 00:05:15,230
<font color="#CCCCCC">attackers students have tested their</font>

107
00:05:11,660 --> 00:05:18,950
hands on<font color="#E5E5E5"> so one thing I can</font><font color="#CCCCCC"> guarantee</font>

108
00:05:15,230 --> 00:05:20,600
you that the bypass is we which<font color="#CCCCCC"> we have</font>

109
00:05:18,950 --> 00:05:24,380
a look at here have been thoroughly

110
00:05:20,600 --> 00:05:26,450
tested<font color="#CCCCCC"> I am using so there are two</font><font color="#E5E5E5"> ways</font>

111
00:05:24,380 --> 00:05:30,290
of implementation of<font color="#CCCCCC"> ETA I</font><font color="#E5E5E5"> am using a</font>

112
00:05:26,450 --> 00:05:32,990
lightweight<font color="#E5E5E5"> gateway that is the sensor</font>

113
00:05:30,290 --> 00:05:34,910
is living on to the domain controller

114
00:05:32,990 --> 00:05:37,130
it's not a separate<font color="#E5E5E5"> box so that doesn't</font>

115
00:05:34,910 --> 00:05:38,960
make any<font color="#CCCCCC"> difference to</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> detection as</font>

116
00:05:37,130 --> 00:05:43,040
far as I know we're just<font color="#CCCCCC"> wanting to let</font>

117
00:05:38,960 --> 00:05:45,080
that out<font color="#E5E5E5"> so the threats of interests</font>

118
00:05:43,040 --> 00:05:48,260
which<font color="#CCCCCC"> ata detects it it takes so many</font>

119
00:05:45,080 --> 00:05:53,000
things<font color="#CCCCCC"> so for my particular methodology</font>

120
00:05:48,260 --> 00:05:55,659
I always saw these<font color="#E5E5E5"> detection if I'm not</font>

121
00:05:53,000 --> 00:05:58,640
trying<font color="#E5E5E5"> to bypass a tour in the initial</font>

122
00:05:55,660 --> 00:06:00,500
days<font color="#CCCCCC"> when I found</font><font color="#E5E5E5"> out what a</font><font color="#CCCCCC"> T is</font><font color="#E5E5E5"> and</font>

123
00:05:58,640 --> 00:06:03,110
how it detects<font color="#CCCCCC"> things these</font><font color="#E5E5E5"> are some of</font>

124
00:06:00,500 --> 00:06:05,660
<font color="#CCCCCC">the</font><font color="#E5E5E5"> attacks which it detects so in</font>

125
00:06:03,110 --> 00:06:07,190
<font color="#E5E5E5">Drakon</font><font color="#CCCCCC"> phase account a numeration</font><font color="#E5E5E5"> you</font>

126
00:06:05,660 --> 00:06:09,380
know if you would like<font color="#CCCCCC"> to get</font>

127
00:06:07,190 --> 00:06:12,860
interesting data from the domain like

128
00:06:09,380 --> 00:06:15,830
list of<font color="#E5E5E5"> computers member computers users</font>

129
00:06:12,860 --> 00:06:18,220
interesting group memberships<font color="#E5E5E5"> leadership</font>

130
00:06:15,830 --> 00:06:22,039
like domain admins<font color="#E5E5E5"> Enterprise admins etc</font>

131
00:06:18,220 --> 00:06:25,610
then compromised credentials brute-force

132
00:06:22,040 --> 00:06:28,840
attacks unusual protocol implementation

133
00:06:25,610 --> 00:06:31,760
<font color="#E5E5E5">we'll see what this</font><font color="#CCCCCC"> is</font><font color="#E5E5E5"> abnormal</font><font color="#CCCCCC"> behavior</font>

134
00:06:28,840 --> 00:06:33,590
so for me once<font color="#E5E5E5"> again we are not going</font><font color="#CCCCCC"> to</font>

135
00:06:31,760 --> 00:06:34,669
<font color="#E5E5E5">focus on abnormal behavior detection is</font>

136
00:06:33,590 --> 00:06:37,940
here but that's<font color="#E5E5E5"> something which</font>

137
00:06:34,669 --> 00:06:39,349
interested<font color="#CCCCCC"> me initially then in the</font>

138
00:06:37,940 --> 00:06:42,890
lateral<font color="#E5E5E5"> movement face and</font>

139
00:06:39,350 --> 00:06:45,530
is<font color="#CCCCCC"> 488 really kicks in attacks</font><font color="#E5E5E5"> like</font>

140
00:06:42,890 --> 00:06:48,490
golden ticket<font color="#CCCCCC"> or pasta hash reuse of</font>

141
00:06:45,530 --> 00:06:51,260
<font color="#E5E5E5">tokens remote code execution attempts on</font>

142
00:06:48,490 --> 00:06:54,290
<font color="#E5E5E5">on to the domain controller and of</font>

143
00:06:51,260 --> 00:06:55,760
course<font color="#E5E5E5"> domain dominance so so we are</font>

144
00:06:54,290 --> 00:06:58,100
golden<font color="#E5E5E5"> ticket comes over here</font><font color="#CCCCCC"> and</font>

145
00:06:55,760 --> 00:07:00,500
<font color="#E5E5E5">malicious replications</font><font color="#CCCCCC"> free quests our</font>

146
00:06:58,100 --> 00:07:03,380
famous<font color="#CCCCCC"> DC sync attack so all of this has</font>

147
00:07:00,500 --> 00:07:06,050
been<font color="#E5E5E5"> taken</font><font color="#CCCCCC"> from the</font><font color="#E5E5E5"> Microsoft</font>

148
00:07:03,380 --> 00:07:10,760
documentation<font color="#E5E5E5"> now let's quickly jump in</font>

149
00:07:06,050 --> 00:07:13,100
and see how an attacker<font color="#E5E5E5"> gets detected so</font>

150
00:07:10,760 --> 00:07:16,099
this is an example<font color="#E5E5E5"> if you run any tool</font>

151
00:07:13,100 --> 00:07:17,630
like net view or<font color="#CCCCCC"> Power View</font><font color="#E5E5E5"> or even the</font>

152
00:07:16,100 --> 00:07:20,240
simple net commands<font color="#E5E5E5"> let's say you run</font>

153
00:07:17,630 --> 00:07:24,890
net<font color="#E5E5E5"> probe domain admins slash domain</font>

154
00:07:20,240 --> 00:07:27,710
<font color="#E5E5E5">this is something which your ATM console</font>

155
00:07:24,890 --> 00:07:29,450
will show you<font color="#E5E5E5"> now recon using directory</font>

156
00:07:27,710 --> 00:07:30,919
services and emulation or<font color="#E5E5E5"> reckon using</font>

157
00:07:29,450 --> 00:07:35,390
Assembly session enumeration with a

158
00:07:30,920 --> 00:07:38,500
medium severity<font color="#E5E5E5"> which is fine</font><font color="#CCCCCC"> I mean</font>

159
00:07:35,390 --> 00:07:43,190
<font color="#CCCCCC">direct getting your record detected</font><font color="#E5E5E5"> is</font>

160
00:07:38,500 --> 00:07:47,330
fine as long as you are<font color="#CCCCCC"> not</font><font color="#E5E5E5"> dealing</font><font color="#CCCCCC"> with</font>

161
00:07:43,190 --> 00:07:50,030
an<font color="#E5E5E5"> organization which takes its you know</font>

162
00:07:47,330 --> 00:07:51,320
<font color="#E5E5E5">security really seriously later on when</font>

163
00:07:50,030 --> 00:07:53,809
we'll have<font color="#CCCCCC"> a look at the console</font><font color="#E5E5E5"> you</font>

164
00:07:51,320 --> 00:07:56,750
will<font color="#E5E5E5"> see that not</font><font color="#CCCCCC"> only</font><font color="#E5E5E5"> this is detected</font>

165
00:07:53,810 --> 00:07:58,700
<font color="#E5E5E5">or let me show you</font><font color="#CCCCCC"> that right</font><font color="#E5E5E5"> away this</font>

166
00:07:56,750 --> 00:08:05,660
<font color="#CCCCCC">is how it looks like on to the</font><font color="#E5E5E5"> ATA</font>

167
00:07:58,700 --> 00:08:13,550
console so if I have an SMB session

168
00:08:05,660 --> 00:08:17,720
enumeration right here this so you can

169
00:08:13,550 --> 00:08:19,550
not<font color="#E5E5E5"> only</font><font color="#CCCCCC"> see</font><font color="#E5E5E5"> that it was</font><font color="#CCCCCC"> done against</font>

170
00:08:17,720 --> 00:08:23,450
<font color="#E5E5E5">the domain controller but from the box</font>

171
00:08:19,550 --> 00:08:25,900
from<font color="#E5E5E5"> the user so that makes when when I</font>

172
00:08:23,450 --> 00:08:28,700
first encountered<font color="#E5E5E5"> that encountered a TA</font>

173
00:08:25,900 --> 00:08:30,919
<font color="#CCCCCC">this is the thing which worried me</font><font color="#E5E5E5"> your</font>

174
00:08:28,700 --> 00:08:32,590
session enumeration getting<font color="#E5E5E5"> detected or</font>

175
00:08:30,920 --> 00:08:35,900
raising couple of flags which gets

176
00:08:32,590 --> 00:08:38,510
marked as<font color="#CCCCCC"> resolve is fine</font><font color="#E5E5E5"> but this tool</font>

177
00:08:35,900 --> 00:08:43,159
can pinpoint on a particular box<font color="#E5E5E5"> and</font>

178
00:08:38,510 --> 00:08:46,430
user which<font color="#E5E5E5"> was ready for me at the very</font>

179
00:08:43,159 --> 00:08:47,600
<font color="#E5E5E5">first time</font><font color="#CCCCCC"> this slowly</font><font color="#E5E5E5"> you once you</font>

180
00:08:46,430 --> 00:08:50,270
<font color="#E5E5E5">start playing</font><font color="#CCCCCC"> with a TA</font>

181
00:08:47,600 --> 00:08:53,030
<font color="#CCCCCC">you get to understand how it</font><font color="#E5E5E5"> detects</font>

182
00:08:50,270 --> 00:08:57,230
things for<font color="#CCCCCC"> example in case</font>

183
00:08:53,030 --> 00:09:02,750
any<font color="#CCCCCC"> work</font><font color="#E5E5E5"> on a TA generally at least up</font>

184
00:08:57,230 --> 00:09:04,820
to<font color="#E5E5E5"> 1.7 88 does not really mind</font><font color="#CCCCCC"> DC giving</font>

185
00:09:02,750 --> 00:09:08,530
out the<font color="#CCCCCC"> information</font><font color="#E5E5E5"> that is if you ask</font>

186
00:09:04,820 --> 00:09:11,360
give me the list of computers it's fine

187
00:09:08,530 --> 00:09:13,069
give me the membership<font color="#E5E5E5"> of domain admins</font>

188
00:09:11,360 --> 00:09:15,770
group that's fine as well<font color="#CCCCCC"> as long as</font>

189
00:09:13,070 --> 00:09:18,110
then you<font color="#E5E5E5"> do not go back to</font><font color="#CCCCCC"> the DC and do</font>

190
00:09:15,770 --> 00:09:20,540
some intrusive<font color="#E5E5E5"> enumeration and now</font>

191
00:09:18,110 --> 00:09:23,750
that's what's that intrusive enumeration

192
00:09:20,540 --> 00:09:25,610
<font color="#E5E5E5">we'll come back to that in a moment so</font>

193
00:09:23,750 --> 00:09:29,120
if you do not use we are<font color="#E5E5E5"> going to use</font>

194
00:09:25,610 --> 00:09:32,390
<font color="#E5E5E5">Power View here in this demo which I</font>

195
00:09:29,120 --> 00:09:35,030
have ready for you if you are not<font color="#CCCCCC"> using</font>

196
00:09:32,390 --> 00:09:39,410
your tools blindly and know what they do

197
00:09:35,030 --> 00:09:43,579
<font color="#E5E5E5">it is not really hard to bypass</font><font color="#CCCCCC"> 8-year</font>

198
00:09:39,410 --> 00:09:46,310
so a not poking the DC once again not

199
00:09:43,580 --> 00:09:49,220
poking the DC is the<font color="#E5E5E5"> key understand this</font>

200
00:09:46,310 --> 00:09:51,319
<font color="#CCCCCC">ATA looks at all the traffic which goes</font>

201
00:09:49,220 --> 00:09:53,420
to the DC some protocols which goes to

202
00:09:51,320 --> 00:09:56,270
the DC so as long<font color="#E5E5E5"> as</font><font color="#CCCCCC"> you are</font><font color="#E5E5E5"> talking to</font>

203
00:09:53,420 --> 00:09:59,000
the deceive you in a really<font color="#E5E5E5"> normal way</font>

204
00:09:56,270 --> 00:10:03,620
normal conversation or avoiding it at

205
00:09:59,000 --> 00:10:07,130
all you won't be detected<font color="#CCCCCC"> so let's have</font>

206
00:10:03,620 --> 00:10:09,530
<font color="#E5E5E5">a look at the example of hunting for a</font>

207
00:10:07,130 --> 00:10:11,990
domain admin token<font color="#E5E5E5"> also called user</font>

208
00:10:09,530 --> 00:10:15,140
hunting a very very popular<font color="#E5E5E5"> method with</font>

209
00:10:11,990 --> 00:10:18,530
the red teamers so in power<font color="#CCCCCC"> view use</font>

210
00:10:15,140 --> 00:10:21,050
invoke user hunter for this what this

211
00:10:18,530 --> 00:10:24,350
hunting means<font color="#E5E5E5"> you go</font><font color="#CCCCCC"> to the domain</font>

212
00:10:21,050 --> 00:10:27,500
controller asks us for<font color="#E5E5E5"> two things first</font>

213
00:10:24,350 --> 00:10:30,410
give me a<font color="#E5E5E5"> list of all the</font><font color="#CCCCCC"> boxes second</font>

214
00:10:27,500 --> 00:10:33,110
<font color="#E5E5E5">give me the list of the domain admins</font>

215
00:10:30,410 --> 00:10:36,079
<font color="#E5E5E5">then it goes</font><font color="#CCCCCC"> to each</font><font color="#E5E5E5"> and every box and</font>

216
00:10:33,110 --> 00:10:38,420
asks for<font color="#E5E5E5"> two things give me the current</font>

217
00:10:36,080 --> 00:10:40,550
sessions and current logins<font color="#CCCCCC"> and then the</font>

218
00:10:38,420 --> 00:10:44,060
tool matches if current session<font color="#CCCCCC"> our</font>

219
00:10:40,550 --> 00:10:45,680
current<font color="#CCCCCC"> logon users has membership of</font>

220
00:10:44,060 --> 00:10:53,030
the domain admins which it has<font color="#CCCCCC"> that's</font>

221
00:10:45,680 --> 00:10:57,829
how these are hunting works now yep so

222
00:10:53,030 --> 00:11:00,199
the way to bypass<font color="#E5E5E5"> it is this when you</font>

223
00:10:57,830 --> 00:11:02,150
<font color="#E5E5E5">run a run and I'm taking power of you</font>

224
00:11:00,200 --> 00:11:05,770
just as an example because<font color="#E5E5E5"> I work a lot</font>

225
00:11:02,150 --> 00:11:05,770
<font color="#CCCCCC">on PowerShell and that's an awesome</font><font color="#E5E5E5"> tool</font>

226
00:11:06,010 --> 00:11:12,370
if you request a list of machines from a

227
00:11:10,030 --> 00:11:14,560
domain<font color="#E5E5E5"> controller</font><font color="#CCCCCC"> before running</font><font color="#E5E5E5"> Power</font>

228
00:11:12,370 --> 00:11:16,180
<font color="#E5E5E5">View blindly on that because</font><font color="#CCCCCC"> when</font><font color="#E5E5E5"> you</font>

229
00:11:14,560 --> 00:11:17,949
run invoke user enter once again it

230
00:11:16,180 --> 00:11:21,550
automatically fetches<font color="#CCCCCC"> the list of all</font>

231
00:11:17,950 --> 00:11:24,730
boxes and runs enumeration on them make

232
00:11:21,550 --> 00:11:26,890
sure<font color="#E5E5E5"> that you do not run that user</font>

233
00:11:24,730 --> 00:11:28,690
hunting specifically on to the domain

234
00:11:26,890 --> 00:11:32,740
controller<font color="#CCCCCC"> that's it</font>

235
00:11:28,690 --> 00:11:35,050
if you do that<font color="#CCCCCC"> and if I would like to</font>

236
00:11:32,740 --> 00:11:37,930
show a demonstration<font color="#E5E5E5"> of that in a moment</font>

237
00:11:35,050 --> 00:11:40,120
<font color="#CCCCCC">if you do that</font><font color="#E5E5E5"> that doesn't get detected</font>

238
00:11:37,930 --> 00:11:42,729
retrieve the information<font color="#E5E5E5"> from the DC</font>

239
00:11:40,120 --> 00:11:44,170
like computer names and domain admin

240
00:11:42,730 --> 00:11:45,780
membership but do not retrieve

241
00:11:44,170 --> 00:11:48,550
information like<font color="#E5E5E5"> currently logged on</font>

242
00:11:45,780 --> 00:11:51,819
users or current sessions<font color="#E5E5E5"> and you will</font>

243
00:11:48,550 --> 00:11:55,270
be good another interesting<font color="#CCCCCC"> record</font>

244
00:11:51,820 --> 00:11:57,640
mechanism which<font color="#CCCCCC"> ata can't catch is</font><font color="#E5E5E5"> SP</font>

245
00:11:55,270 --> 00:12:00,699
<font color="#E5E5E5">and scanning so those of you who are not</font>

246
00:11:57,640 --> 00:12:03,069
<font color="#CCCCCC">aware</font><font color="#E5E5E5"> so a service principle</font><font color="#CCCCCC"> link is</font>

247
00:12:00,700 --> 00:12:04,570
used by Kerberos to keep track<font color="#E5E5E5"> of</font>

248
00:12:03,070 --> 00:12:08,350
service<font color="#E5E5E5"> accounts in an Active Directory</font>

249
00:12:04,570 --> 00:12:10,780
environment<font color="#E5E5E5"> to put it the easy way if</font>

250
00:12:08,350 --> 00:12:12,790
you do<font color="#CCCCCC"> Espeon scanning once again for</font>

251
00:12:10,780 --> 00:12:15,100
which you can use individual scripts or

252
00:12:12,790 --> 00:12:20,439
<font color="#CCCCCC">Power View</font><font color="#E5E5E5"> that doesn't get detected as</font>

253
00:12:15,100 --> 00:12:24,880
well so let's<font color="#E5E5E5"> have a look at how we can</font>

254
00:12:20,440 --> 00:12:34,060
actually use<font color="#CCCCCC"> Power</font><font color="#E5E5E5"> View and still evade</font>

255
00:12:24,880 --> 00:12:38,280
detection so we have<font color="#CCCCCC"> 80 a 1.8 here so</font>

256
00:12:34,060 --> 00:12:38,280
there has been no detection<font color="#CCCCCC"> up to now</font>

257
00:12:38,700 --> 00:12:44,260
now what I<font color="#E5E5E5"> do here this machine Alondra</font>

258
00:12:41,980 --> 00:12:46,660
<font color="#CCCCCC">to and please</font><font color="#E5E5E5"> do don't do or do to me</font>

259
00:12:44,260 --> 00:12:49,480
from<font color="#E5E5E5"> the Wi-Fi what this machine does</font>

260
00:12:46,660 --> 00:12:53,260
<font color="#E5E5E5">has it's a part of the domain</font><font color="#CCCCCC"> the user</font>

261
00:12:49,480 --> 00:12:55,510
is not any special<font color="#E5E5E5"> user I don't think he</font>

262
00:12:53,260 --> 00:12:57,340
not<font color="#E5E5E5"> even</font><font color="#CCCCCC"> a local</font><font color="#E5E5E5"> admin on the box</font><font color="#CCCCCC"> or if</font>

263
00:12:55,510 --> 00:13:00,610
it is<font color="#E5E5E5"> that's the max privileges it has</font>

264
00:12:57,340 --> 00:13:02,560
it's a normal domain user so what we can

265
00:13:00,610 --> 00:13:03,040
do with these privileges if this

266
00:13:02,560 --> 00:13:06,060
<font color="#CCCCCC">mis'able</font>

267
00:13:03,040 --> 00:13:11,020
till the back the the partial session

268
00:13:06,060 --> 00:13:14,260
yes thanks so and I'm not<font color="#CCCCCC"> going to do</font>

269
00:13:11,020 --> 00:13:16,410
any recorded demos so let's see how it

270
00:13:14,260 --> 00:13:16,410
goes

271
00:13:17,070 --> 00:13:32,830
let's load<font color="#E5E5E5"> power view here I think</font><font color="#CCCCCC"> it is</font>

272
00:13:25,150 --> 00:13:34,990
<font color="#E5E5E5">jicama now not using invoke user hunter</font>

273
00:13:32,830 --> 00:13:41,950
directly<font color="#E5E5E5"> what we can do is something</font>

274
00:13:34,990 --> 00:13:44,530
<font color="#E5E5E5">like this so we get a list of all the</font>

275
00:13:41,950 --> 00:13:48,490
<font color="#E5E5E5">boxes in this domain right</font><font color="#CCCCCC"> next thing</font>

276
00:13:44,530 --> 00:13:51,730
which<font color="#CCCCCC"> we can run is this which</font><font color="#E5E5E5"> is not</font>

277
00:13:48,490 --> 00:13:55,150
required<font color="#CCCCCC"> although we can leave this part</font>

278
00:13:51,730 --> 00:14:05,710
to invoke user hunter<font color="#E5E5E5"> but just in</font><font color="#CCCCCC"> case</font>

279
00:13:55,150 --> 00:14:17,230
<font color="#CCCCCC">let's see</font><font color="#E5E5E5"> what are the different domain</font>

280
00:14:05,710 --> 00:14:20,440
admins<font color="#CCCCCC"> so there</font><font color="#E5E5E5"> are two domain admins so</font>

281
00:14:17,230 --> 00:14:22,390
what we would<font color="#E5E5E5"> have done or what many of</font>

282
00:14:20,440 --> 00:14:23,860
us red teamers are guilty<font color="#CCCCCC"> of doing is</font>

283
00:14:22,390 --> 00:14:25,960
<font color="#E5E5E5">something like this after these</font>

284
00:14:23,860 --> 00:14:30,550
obligatory domain enumeration things

285
00:14:25,960 --> 00:14:34,380
what we do is simply something<font color="#E5E5E5"> like this</font>

286
00:14:30,550 --> 00:14:36,729
<font color="#E5E5E5">invoke user hunter and then we wait</font>

287
00:14:34,380 --> 00:14:39,130
<font color="#E5E5E5">invoke user and terror power does it's</font>

288
00:14:36,730 --> 00:14:41,380
magic<font color="#CCCCCC"> then it tried to target that box</font>

289
00:14:39,130 --> 00:14:46,270
<font color="#CCCCCC">where a domain admin is logged</font><font color="#E5E5E5"> in which</font>

290
00:14:41,380 --> 00:14:49,840
is<font color="#E5E5E5"> almost correct</font><font color="#CCCCCC"> just have a look at</font>

291
00:14:46,270 --> 00:14:52,900
the list<font color="#CCCCCC"> returned</font><font color="#E5E5E5"> by</font><font color="#CCCCCC"> DD see it lists</font>

292
00:14:49,840 --> 00:14:55,780
itself as well right so<font color="#CCCCCC"> the only</font>

293
00:14:52,900 --> 00:15:00,730
modification you<font color="#CCCCCC"> need to do here is save</font>

294
00:14:55,780 --> 00:15:03,569
this list to a file let's<font color="#E5E5E5"> say this</font><font color="#CCCCCC"> o</font><font color="#E5E5E5"> the</font>

295
00:15:00,730 --> 00:15:03,570
font is<font color="#CCCCCC"> really small</font>

296
00:15:08,010 --> 00:15:14,620
something like this even<font color="#CCCCCC"> if this</font><font color="#E5E5E5"> is not</font>

297
00:15:10,240 --> 00:15:18,520
visible what we have changed here is the

298
00:15:14,620 --> 00:15:22,240
first box<font color="#CCCCCC"> that is let's just</font><font color="#E5E5E5"> not run</font>

299
00:15:18,520 --> 00:15:31,120
user hunting on to the DC what we'll do

300
00:15:22,240 --> 00:15:33,340
in place<font color="#E5E5E5"> of</font><font color="#CCCCCC"> that</font><font color="#E5E5E5"> is this we're going</font><font color="#CCCCCC"> to</font>

301
00:15:31,120 --> 00:15:36,310
use the<font color="#E5E5E5"> computer file option which comes</font>

302
00:15:33,340 --> 00:15:41,380
<font color="#E5E5E5">with</font><font color="#CCCCCC"> power view Pass or list of</font>

303
00:15:36,310 --> 00:15:43,780
computers and now if you<font color="#E5E5E5"> see it doesn't</font>

304
00:15:41,380 --> 00:15:49,270
go to the DC to get a list<font color="#E5E5E5"> of the boxes</font>

305
00:15:43,780 --> 00:15:51,220
because<font color="#CCCCCC"> we have provided</font><font color="#E5E5E5"> that and now it</font>

306
00:15:49,270 --> 00:15:53,319
goes<font color="#CCCCCC"> to each and every box and looks for</font>

307
00:15:51,220 --> 00:15:56,190
<font color="#E5E5E5">if there is a box where our domain admin</font>

308
00:15:53,320 --> 00:15:59,020
is logged in<font color="#E5E5E5"> and that is it</font>

309
00:15:56,190 --> 00:16:00,760
<font color="#CCCCCC">81 detected why because you have</font><font color="#E5E5E5"> not</font>

310
00:15:59,020 --> 00:16:03,280
executed the inclusives

311
00:16:00,760 --> 00:16:04,930
intuitive enumeration<font color="#E5E5E5"> against the domain</font>

312
00:16:03,280 --> 00:16:08,079
controller just very<font color="#E5E5E5"> normal things you</font>

313
00:16:04,930 --> 00:16:13,390
know getting a list of boxes it's almost

314
00:16:08,080 --> 00:16:19,360
this thing so that's what we did<font color="#E5E5E5"> when we</font>

315
00:16:13,390 --> 00:16:21,490
<font color="#E5E5E5">run get net computer that's how you</font>

316
00:16:19,360 --> 00:16:24,360
avoid<font color="#CCCCCC"> rec</font><font color="#E5E5E5"> on and is this powerful really</font>

317
00:16:21,490 --> 00:16:26,410
<font color="#E5E5E5">you can use this against any sort of</font>

318
00:16:24,360 --> 00:16:28,720
enumeration if you are<font color="#E5E5E5"> going to have a</font>

319
00:16:26,410 --> 00:16:31,360
look for local<font color="#CCCCCC"> admin access on all</font><font color="#E5E5E5"> the</font>

320
00:16:28,720 --> 00:16:35,110
boxes<font color="#E5E5E5"> use computer file parameter</font><font color="#CCCCCC"> just</font>

321
00:16:31,360 --> 00:16:40,050
<font color="#E5E5E5">avoid the intrusion one for the DC</font>

322
00:16:35,110 --> 00:16:42,490
that's that's a trick now brute force

323
00:16:40,050 --> 00:16:45,329
<font color="#E5E5E5">how many of you actually use brute</font>

324
00:16:42,490 --> 00:16:48,880
forcing in Active Directory environments

325
00:16:45,330 --> 00:16:53,200
come on is there no one who uses brute

326
00:16:48,880 --> 00:16:56,680
force attacks in Active Directory<font color="#E5E5E5"> yeah</font>

327
00:16:53,200 --> 00:16:58,870
one<font color="#CCCCCC"> of you Wow</font><font color="#E5E5E5"> so of course you should</font>

328
00:16:56,680 --> 00:17:01,329
you should<font color="#CCCCCC"> use Active Directory</font><font color="#E5E5E5"> force in</font>

329
00:16:58,870 --> 00:17:03,520
Active Directory environments<font color="#CCCCCC"> just use a</font>

330
00:17:01,330 --> 00:17:07,150
modified version<font color="#CCCCCC"> use a single password</font>

331
00:17:03,520 --> 00:17:09,910
<font color="#E5E5E5">and try to get across the boxes you know</font>

332
00:17:07,150 --> 00:17:12,520
there is no<font color="#E5E5E5"> password policy in the world</font>

333
00:17:09,910 --> 00:17:15,280
<font color="#CCCCCC">in production</font><font color="#E5E5E5"> and I there won't be any</font>

334
00:17:12,520 --> 00:17:17,530
which law which locks<font color="#E5E5E5"> a user account</font><font color="#CCCCCC"> on</font>

335
00:17:15,280 --> 00:17:19,510
a single wrong attempt right and<font color="#E5E5E5"> that's</font>

336
00:17:17,530 --> 00:17:20,089
<font color="#E5E5E5">that's a well-known</font><font color="#CCCCCC"> trick</font><font color="#E5E5E5"> really</font><font color="#CCCCCC"> well</font>

337
00:17:19,510 --> 00:17:23,960
<font color="#E5E5E5">known one</font>

338
00:17:20,089 --> 00:17:27,290
so if we do this there's no<font color="#E5E5E5"> detection as</font>

339
00:17:23,960 --> 00:17:34,070
<font color="#E5E5E5">well so how a normal one gets detected</font>

340
00:17:27,290 --> 00:17:36,260
<font color="#E5E5E5">it gets directed like this so that's a</font>

341
00:17:34,070 --> 00:17:42,050
normal<font color="#CCCCCC"> root force</font><font color="#E5E5E5"> when you try multiple</font>

342
00:17:36,260 --> 00:17:44,480
passwords<font color="#E5E5E5"> against a user accesses number</font>

343
00:17:42,050 --> 00:17:46,669
of authentication failures<font color="#E5E5E5"> five zero</font>

344
00:17:44,480 --> 00:17:50,000
<font color="#CCCCCC">sound within few seconds so if you</font>

345
00:17:46,670 --> 00:17:55,370
actually<font color="#E5E5E5"> run walk with a TA and try to</font>

346
00:17:50,000 --> 00:17:58,790
see<font color="#E5E5E5"> how it detects things it's once</font>

347
00:17:55,370 --> 00:18:06,290
again<font color="#CCCCCC"> it's</font><font color="#E5E5E5"> not really</font><font color="#CCCCCC"> hard</font><font color="#E5E5E5"> to get around</font>

348
00:17:58,790 --> 00:18:08,360
<font color="#E5E5E5">it so if we go here of the next thing</font>

349
00:18:06,290 --> 00:18:11,330
which<font color="#CCCCCC"> we are</font><font color="#E5E5E5"> going</font><font color="#CCCCCC"> to use is in the</font>

350
00:18:08,360 --> 00:18:19,149
brute<font color="#CCCCCC"> force group</font><font color="#E5E5E5"> which in this part of</font>

351
00:18:11,330 --> 00:18:19,149
the nishang toolkit let's<font color="#E5E5E5"> run it</font>

352
00:18:30,650 --> 00:18:38,360
so small no directory<font color="#E5E5E5"> or dictionaries</font>

353
00:18:36,920 --> 00:18:40,850
are not directly a small dictionary<font color="#CCCCCC"> just</font>

354
00:18:38,360 --> 00:18:43,669
<font color="#CCCCCC">500 or some passwords it's the same one</font>

355
00:18:40,850 --> 00:18:46,669
which was used<font color="#E5E5E5"> when there was detection</font>

356
00:18:43,670 --> 00:18:51,800
<font color="#E5E5E5">what we did we tried a single</font><font color="#CCCCCC"> password</font>

357
00:18:46,670 --> 00:18:54,500
across the<font color="#E5E5E5"> Active Directory single</font>

358
00:18:51,800 --> 00:18:55,850
password<font color="#E5E5E5"> for each user that's a</font>

359
00:18:54,500 --> 00:19:06,350
well-known<font color="#CCCCCC"> technique</font><font color="#E5E5E5"> doesn't get</font>

360
00:18:55,850 --> 00:19:08,870
detected and now once we we are through

361
00:19:06,350 --> 00:19:11,090
the enumeration<font color="#CCCCCC"> part</font><font color="#E5E5E5"> the next</font><font color="#CCCCCC"> one or</font>

362
00:19:08,870 --> 00:19:14,689
where the<font color="#E5E5E5"> the actual meat is the</font><font color="#CCCCCC"> labor</font>

363
00:19:11,090 --> 00:19:16,280
<font color="#CCCCCC">movement part so what</font><font color="#E5E5E5"> we have done so</font>

364
00:19:14,690 --> 00:19:18,650
the demonstrations are<font color="#CCCCCC"> not freely</font>

365
00:19:16,280 --> 00:19:20,600
<font color="#E5E5E5">connected for a reason which</font><font color="#CCCCCC"> we'll get</font>

366
00:19:18,650 --> 00:19:22,429
<font color="#CCCCCC">to know later on</font><font color="#E5E5E5"> we started with</font>

367
00:19:20,600 --> 00:19:23,959
enumeration found out that domain<font color="#E5E5E5"> admin</font>

368
00:19:22,429 --> 00:19:26,660
is logged in<font color="#E5E5E5"> into</font><font color="#CCCCCC"> a box</font>

369
00:19:23,960 --> 00:19:28,700
then we brute force let's say a domain

370
00:19:26,660 --> 00:19:31,429
<font color="#E5E5E5">user which</font><font color="#CCCCCC"> is a local admin on that</font>

371
00:19:28,700 --> 00:19:34,520
particular box right that makes<font color="#E5E5E5"> sense</font>

372
00:19:31,429 --> 00:19:36,650
<font color="#CCCCCC">now once we are</font><font color="#E5E5E5"> local administrator on</font>

373
00:19:34,520 --> 00:19:38,780
that box where the domain admin token is

374
00:19:36,650 --> 00:19:41,450
available we can let's say we got our

375
00:19:38,780 --> 00:19:43,580
hands<font color="#CCCCCC"> on to</font><font color="#E5E5E5"> the credentials of the</font>

376
00:19:41,450 --> 00:19:48,559
domain admin by<font color="#E5E5E5"> croatians I mean</font><font color="#CCCCCC"> it's</font>

377
00:19:43,580 --> 00:19:50,210
secrets<font color="#E5E5E5"> ntlm hash AES keys what over</font>

378
00:19:48,559 --> 00:19:52,490
<font color="#CCCCCC">pasta</font><font color="#E5E5E5"> hash attack is you can create</font>

379
00:19:50,210 --> 00:19:55,760
valid Kerberos tickets from ntlm hash or

380
00:19:52,490 --> 00:19:57,770
ES keys so<font color="#E5E5E5"> Benjamin the guy who wrote</font>

381
00:19:55,760 --> 00:20:02,270
<font color="#E5E5E5">mimic ants as a detailed blog post about</font>

382
00:19:57,770 --> 00:20:06,080
this you can<font color="#E5E5E5"> have a look at it now when</font>

383
00:20:02,270 --> 00:20:08,990
you create<font color="#E5E5E5"> a session with</font><font color="#CCCCCC"> the domain</font>

384
00:20:06,080 --> 00:20:11,270
controller<font color="#CCCCCC"> that is you establish the</font>

385
00:20:08,990 --> 00:20:15,410
connection you<font color="#E5E5E5"> want to want access to</font><font color="#CCCCCC"> a</font>

386
00:20:11,270 --> 00:20:18,139
resource<font color="#E5E5E5"> when you requested at EDD</font><font color="#CCCCCC"> Eric</font>

387
00:20:15,410 --> 00:20:19,970
is<font color="#CCCCCC"> the packet which gets</font><font color="#E5E5E5"> sent and I</font>

388
00:20:18,140 --> 00:20:22,220
<font color="#E5E5E5">don't know if that's visible</font><font color="#CCCCCC"> or not but</font>

389
00:20:19,970 --> 00:20:22,850
this is<font color="#E5E5E5"> how it looks like when it is</font>

390
00:20:22,220 --> 00:20:26,420
normal

391
00:20:22,850 --> 00:20:28,399
e type so in the pre pre auth data<font color="#E5E5E5"> there</font>

392
00:20:26,420 --> 00:20:34,070
is<font color="#CCCCCC"> a field called</font><font color="#E5E5E5"> e type which is</font>

393
00:20:28,400 --> 00:20:36,140
aes-256<font color="#CCCCCC"> c TSH</font><font color="#E5E5E5"> McAfee t1 something which</font>

394
00:20:34,070 --> 00:20:39,200
is the<font color="#E5E5E5"> normal one this is something</font>

395
00:20:36,140 --> 00:20:43,030
which<font color="#E5E5E5"> you got to have a look at when</font>

396
00:20:39,200 --> 00:20:47,110
you're using clear text passwords<font color="#E5E5E5"> but</font>

397
00:20:43,030 --> 00:20:49,420
as soon as you use<font color="#CCCCCC"> ntlm hash</font><font color="#E5E5E5"> for</font>

398
00:20:47,110 --> 00:20:51,639
creating an overpass the hash attack or

399
00:20:49,420 --> 00:20:55,390
creating a Kerberos ticket and then you

400
00:20:51,640 --> 00:20:56,680
request a TGT from the KDC or the<font color="#E5E5E5"> domain</font>

401
00:20:55,390 --> 00:20:58,650
controller or the<font color="#E5E5E5"> key distribution</font>

402
00:20:56,680 --> 00:21:05,080
center<font color="#E5E5E5"> that's following the same thing</font>

403
00:20:58,650 --> 00:21:09,520
then you get to see this<font color="#E5E5E5"> the e type is</font>

404
00:21:05,080 --> 00:21:12,010
<font color="#CCCCCC">two ungraded</font><font color="#E5E5E5"> to</font><font color="#CCCCCC"> our 4-h Mac md5 and</font>

405
00:21:09,520 --> 00:21:15,879
that's what and this<font color="#CCCCCC"> is the command</font>

406
00:21:12,010 --> 00:21:18,300
which most<font color="#E5E5E5"> of us</font><font color="#CCCCCC"> use</font><font color="#E5E5E5"> right you know the</font>

407
00:21:15,880 --> 00:21:21,940
<font color="#CCCCCC">username the</font><font color="#E5E5E5"> domain and the ntlm hash</font>

408
00:21:18,300 --> 00:21:24,159
<font color="#E5E5E5">this is what a tier detects exactly this</font>

409
00:21:21,940 --> 00:21:27,550
is<font color="#E5E5E5"> the type of anomalies which is which</font>

410
00:21:24,160 --> 00:21:30,010
it is looking for lazy attackers so and

411
00:21:27,550 --> 00:21:34,090
there are two<font color="#CCCCCC"> detections basically</font><font color="#E5E5E5"> one</font>

412
00:21:30,010 --> 00:21:35,890
encryption<font color="#CCCCCC"> download activity and once</font>

413
00:21:34,090 --> 00:21:41,010
<font color="#E5E5E5">again if you look closely</font>

414
00:21:35,890 --> 00:21:44,920
<font color="#E5E5E5">88 tells you how it caught you pens down</font>

415
00:21:41,010 --> 00:21:46,780
is required so what does<font color="#E5E5E5"> it read the</font>

416
00:21:44,920 --> 00:21:50,110
<font color="#E5E5E5">encryption method of the encrypted</font>

417
00:21:46,780 --> 00:21:51,940
<font color="#E5E5E5">timestamp field of</font><font color="#CCCCCC"> s repeat</font><font color="#E5E5E5"> message was</font>

418
00:21:50,110 --> 00:21:54,129
downgraded<font color="#CCCCCC"> I mean there can't be</font>

419
00:21:51,940 --> 00:21:56,380
anything clearer than<font color="#CCCCCC"> that</font><font color="#E5E5E5"> then that</font>

420
00:21:54,130 --> 00:21:59,050
telling you in your face that try to

421
00:21:56,380 --> 00:22:03,790
<font color="#CCCCCC">increase you to improve your techniques</font>

422
00:21:59,050 --> 00:22:05,770
do not rely on<font color="#E5E5E5"> tools blindly and there</font>

423
00:22:03,790 --> 00:22:09,970
is another detection unusual protocol

424
00:22:05,770 --> 00:22:12,250
implementation which actually I it was

425
00:22:09,970 --> 00:22:15,250
<font color="#E5E5E5">not possible for me</font><font color="#CCCCCC"> to zero in on</font><font color="#E5E5E5"> the</font>

426
00:22:12,250 --> 00:22:18,430
<font color="#CCCCCC">reason of detection what my wild guess</font>

427
00:22:15,250 --> 00:22:20,680
was this if you look for supported

428
00:22:18,430 --> 00:22:23,530
encryption types<font color="#E5E5E5"> in the normal one</font><font color="#CCCCCC"> these</font>

429
00:22:20,680 --> 00:22:25,930
six items are there in the ntlm one<font color="#CCCCCC"> or</font>

430
00:22:23,530 --> 00:22:28,300
there are these<font color="#E5E5E5"> seven items and in the</font>

431
00:22:25,930 --> 00:22:32,230
AES one once again quite similar to<font color="#E5E5E5"> the</font>

432
00:22:28,300 --> 00:22:33,659
normal<font color="#CCCCCC"> one not the exact ones so it</font>

433
00:22:32,230 --> 00:22:38,200
could<font color="#CCCCCC"> be that as well</font>

434
00:22:33,660 --> 00:22:41,710
but if you use<font color="#CCCCCC"> AES</font><font color="#E5E5E5"> keys you might have</font>

435
00:22:38,200 --> 00:22:47,680
guessed what happens if you use aes-128

436
00:22:41,710 --> 00:22:50,350
or<font color="#E5E5E5"> AES 256 in place of the ntlm hash now</font>

437
00:22:47,680 --> 00:22:52,570
there is no detection<font color="#E5E5E5"> once again</font>

438
00:22:50,350 --> 00:22:55,270
Benjamin says here and that's what I

439
00:22:52,570 --> 00:22:56,889
have tested<font color="#E5E5E5"> AES keys can only be</font>

440
00:22:55,270 --> 00:22:58,930
replaced<font color="#E5E5E5"> on</font>

441
00:22:56,890 --> 00:23:02,650
<font color="#CCCCCC">a dot that is</font><font color="#E5E5E5"> you can use the</font><font color="#CCCCCC"> EES Keys</font>

442
00:22:58,930 --> 00:23:05,310
<font color="#E5E5E5">either on 8.1 10 or 2012 r2</font><font color="#CCCCCC"> all you need</font>

443
00:23:02,650 --> 00:23:09,160
<font color="#E5E5E5">to have this specific patch on the boxes</font>

444
00:23:05,310 --> 00:23:14,500
which actually doesn't<font color="#E5E5E5"> make this attack</font>

445
00:23:09,160 --> 00:23:18,580
any harder so if you're<font color="#E5E5E5"> over</font><font color="#CCCCCC"> pasta hash</font>

446
00:23:14,500 --> 00:23:19,950
attack<font color="#CCCCCC"> gets detected</font><font color="#E5E5E5"> use AES keys and</font>

447
00:23:18,580 --> 00:23:23,260
how does<font color="#E5E5E5"> that look like</font>

448
00:23:19,950 --> 00:23:35,880
so let<font color="#CCCCCC"> me show</font><font color="#E5E5E5"> you that from a 2012 r2</font>

449
00:23:23,260 --> 00:23:35,879
box let's see if I have<font color="#CCCCCC"> mimic</font><font color="#E5E5E5"> ants here</font>

450
00:23:46,030 --> 00:23:48,450
oops

451
00:23:49,580 --> 00:23:55,269
so in place of<font color="#E5E5E5"> ntlm hash you're using</font>

452
00:23:52,669 --> 00:23:59,889
all the three secrets here

453
00:23:55,269 --> 00:24:06,639
AES 256<font color="#CCCCCC"> a es 128 and ntlm hash as well</font>

454
00:23:59,889 --> 00:24:09,709
so we got our so you<font color="#E5E5E5"> can see that here</font>

455
00:24:06,639 --> 00:24:12,649
<font color="#CCCCCC">compare this</font><font color="#E5E5E5"> with when you run mimic</font><font color="#CCCCCC"> ads</font>

456
00:24:09,710 --> 00:24:15,080
just<font color="#CCCCCC"> with the ntlm hash</font><font color="#E5E5E5"> all these fields</font>

457
00:24:12,649 --> 00:24:22,359
are<font color="#E5E5E5"> null in those cases which they are</font>

458
00:24:15,080 --> 00:24:24,710
not right now so if<font color="#E5E5E5"> I</font><font color="#CCCCCC"> try</font><font color="#E5E5E5"> to</font><font color="#CCCCCC"> access any</font>

459
00:24:22,359 --> 00:24:32,359
resource<font color="#E5E5E5"> on to the domain controller</font>

460
00:24:24,710 --> 00:24:35,899
right<font color="#E5E5E5"> now</font><font color="#CCCCCC"> I can do that</font><font color="#E5E5E5"> that means</font><font color="#CCCCCC"> it if</font>

461
00:24:32,359 --> 00:24:39,139
you<font color="#E5E5E5"> have secrets of the copy</font><font color="#CCCCCC"> TGT account</font>

462
00:24:35,899 --> 00:24:40,699
not<font color="#E5E5E5"> only</font><font color="#CCCCCC"> the on ntlm hash I'm sorry</font><font color="#E5E5E5"> that</font>

463
00:24:39,139 --> 00:24:42,590
comes<font color="#E5E5E5"> later on right now we are on the</font>

464
00:24:40,700 --> 00:24:47,330
<font color="#E5E5E5">domain admin if you have hashes</font><font color="#CCCCCC"> of the</font>

465
00:24:42,590 --> 00:24:50,928
of a domain administrator<font color="#CCCCCC"> there's</font><font color="#E5E5E5"> no</font>

466
00:24:47,330 --> 00:24:53,869
need to<font color="#E5E5E5"> use ntlm hash go for AES keys</font>

467
00:24:50,929 --> 00:25:02,179
and you would be fine there would be any

468
00:24:53,869 --> 00:25:05,389
detection so if we go<font color="#E5E5E5"> here just</font><font color="#CCCCCC"> with no</font>

469
00:25:02,179 --> 00:25:10,100
detection how it gets detected<font color="#E5E5E5"> it's</font>

470
00:25:05,389 --> 00:25:13,459
something<font color="#E5E5E5"> like this or this so that's</font>

471
00:25:10,100 --> 00:25:16,488
your over pasta hash detection which it

472
00:25:13,460 --> 00:25:21,049
<font color="#CCCCCC">T</font><font color="#E5E5E5"> actually tells you in your face that</font><font color="#CCCCCC"> I</font>

473
00:25:16,489 --> 00:25:26,419
caught your or pasta hash right once you

474
00:25:21,049 --> 00:25:28,158
<font color="#CCCCCC">have your over pasta hash attack</font><font color="#E5E5E5"> you can</font>

475
00:25:26,419 --> 00:25:29,960
also do something once you<font color="#E5E5E5"> start reading</font>

476
00:25:28,159 --> 00:25:32,779
how it detected<font color="#CCCCCC"> there some interesting</font>

477
00:25:29,960 --> 00:25:35,809
things<font color="#E5E5E5"> you can</font><font color="#CCCCCC"> do for example you can</font>

478
00:25:32,779 --> 00:25:41,119
create fake events you know use whatever

479
00:25:35,809 --> 00:25:43,700
<font color="#CCCCCC">username in this command here and that</font>

480
00:25:41,119 --> 00:25:45,559
that's<font color="#E5E5E5"> without a year so if you want it</font>

481
00:25:43,700 --> 00:25:48,139
to get detected but some of it someone

482
00:25:45,559 --> 00:25:51,070
<font color="#E5E5E5">else's username you know your colleague</font>

483
00:25:48,139 --> 00:25:53,570
who got promoted but<font color="#E5E5E5"> you for not</font>

484
00:25:51,070 --> 00:25:55,960
something like that<font color="#E5E5E5"> now just getting</font>

485
00:25:53,570 --> 00:25:59,450
anything<font color="#CCCCCC"> if you want</font><font color="#E5E5E5"> just to distract</font>

486
00:25:55,960 --> 00:26:00,980
<font color="#E5E5E5">defenders or for some other reason if</font>

487
00:25:59,450 --> 00:26:02,750
you would like to<font color="#E5E5E5"> create false detection</font>

488
00:26:00,980 --> 00:26:05,150
so you can use this

489
00:26:02,750 --> 00:26:07,159
normal over pasta hash attack but in

490
00:26:05,150 --> 00:26:09,169
this<font color="#CCCCCC"> /user option of who maquettes if</font>

491
00:26:07,159 --> 00:26:11,419
<font color="#CCCCCC">you</font><font color="#E5E5E5"> are using</font><font color="#CCCCCC"> mimic ads for</font><font color="#E5E5E5"> that use</font>

492
00:26:09,169 --> 00:26:14,510
whatever username you want<font color="#E5E5E5"> make sure</font>

493
00:26:11,419 --> 00:26:18,230
<font color="#CCCCCC">that you use a correct one so that it</font>

494
00:26:14,510 --> 00:26:20,990
gets<font color="#CCCCCC"> attracted</font><font color="#E5E5E5"> also if you use a</font>

495
00:26:18,230 --> 00:26:22,970
<font color="#E5E5E5">non-existent one you can see here that</font>

496
00:26:20,990 --> 00:26:25,880
it still gets detected<font color="#E5E5E5"> but the</font><font color="#CCCCCC"> username</font>

497
00:26:22,970 --> 00:26:27,860
<font color="#E5E5E5">field is unknown so maybe just to create</font>

498
00:26:25,880 --> 00:26:32,780
<font color="#E5E5E5">panic or create distraction you can use</font>

499
00:26:27,860 --> 00:26:35,600
this<font color="#CCCCCC"> now also you can see that if you</font>

500
00:26:32,780 --> 00:26:38,299
know of course<font color="#CCCCCC"> that needs a little</font>

501
00:26:35,600 --> 00:26:41,000
<font color="#E5E5E5">little bit of work in itself</font><font color="#CCCCCC"> ATS opposed</font>

502
00:26:38,299 --> 00:26:43,668
to creating honey users or honey tokens

503
00:26:41,000 --> 00:26:45,919
you just create a user in<font color="#CCCCCC"> your domain</font>

504
00:26:43,669 --> 00:26:48,350
and tell<font color="#E5E5E5"> it here that this is a honey</font>

505
00:26:45,919 --> 00:26:50,809
token or<font color="#E5E5E5"> a bread crumb or a deception</font>

506
00:26:48,350 --> 00:26:53,299
user<font color="#E5E5E5"> you can create alerts for that user</font>

507
00:26:50,809 --> 00:26:56,510
as well<font color="#E5E5E5"> whatever user any user in the</font>

508
00:26:53,299 --> 00:26:59,900
domain<font color="#E5E5E5"> now once you</font><font color="#CCCCCC"> have domain</font><font color="#E5E5E5"> admin</font>

509
00:26:56,510 --> 00:27:03,530
privileges the next step for domain

510
00:26:59,900 --> 00:27:06,140
dominance is to have a persistence<font color="#E5E5E5"> there</font>

511
00:27:03,530 --> 00:27:08,270
and<font color="#CCCCCC"> it it would be amazing if that</font>

512
00:27:06,140 --> 00:27:11,000
persistence<font color="#E5E5E5"> comes with domain admin</font>

513
00:27:08,270 --> 00:27:15,168
privileges<font color="#E5E5E5"> that's what we</font><font color="#CCCCCC"> are going</font><font color="#E5E5E5"> to</font>

514
00:27:11,000 --> 00:27:17,750
do now<font color="#CCCCCC"> let's create</font><font color="#E5E5E5"> a golden ticket</font>

515
00:27:15,169 --> 00:27:19,610
attack so those<font color="#CCCCCC"> of you are not aware of</font>

516
00:27:17,750 --> 00:27:24,230
a the golden ticket attack allows you to

517
00:27:19,610 --> 00:27:26,719
come back<font color="#E5E5E5"> anytime later on once you have</font>

518
00:27:24,230 --> 00:27:30,049
<font color="#CCCCCC">da access pull the car BTD t-accounts</font>

519
00:27:26,720 --> 00:27:32,840
hash come back later on<font color="#E5E5E5"> this after maybe</font>

520
00:27:30,049 --> 00:27:35,360
let's say six months<font color="#E5E5E5"> create a valid</font><font color="#CCCCCC"> TGT</font>

521
00:27:32,840 --> 00:27:36,709
and access any resource as the domain

522
00:27:35,360 --> 00:27:40,939
admin<font color="#E5E5E5"> that's what the golden ticket</font>

523
00:27:36,710 --> 00:27:42,860
attack is so it was discussed by skip

524
00:27:40,940 --> 00:27:47,179
<font color="#E5E5E5">that wall an immense</font><font color="#CCCCCC"> I</font><font color="#E5E5E5"> mean a couple of</font>

525
00:27:42,860 --> 00:27:50,570
<font color="#E5E5E5">years back at blackhat now because it's</font>

526
00:27:47,179 --> 00:27:54,650
a valid<font color="#CCCCCC"> tgd the action now moves to the</font>

527
00:27:50,570 --> 00:27:58,570
<font color="#CCCCCC">TGS Rick Rick packet and it looks like</font>

528
00:27:54,650 --> 00:28:02,000
this<font color="#CCCCCC"> a normal one this is how a</font><font color="#E5E5E5"> normal</font>

529
00:27:58,570 --> 00:28:03,918
<font color="#E5E5E5">golden ticket and</font><font color="#CCCCCC"> one thing which I</font>

530
00:28:02,000 --> 00:28:06,909
<font color="#CCCCCC">would</font><font color="#E5E5E5"> like to emphasize is golden</font>

531
00:28:03,919 --> 00:28:10,539
tickets persistence<font color="#E5E5E5"> is based on</font>

532
00:28:06,909 --> 00:28:14,000
non-changing<font color="#CCCCCC"> Corbett EDT password so</font>

533
00:28:10,539 --> 00:28:16,129
that's that's the trust<font color="#E5E5E5"> anchor point if</font>

534
00:28:14,000 --> 00:28:18,110
the car<font color="#CCCCCC"> BT GT password is</font>

535
00:28:16,130 --> 00:28:20,870
a couple of times<font color="#E5E5E5"> then your golden</font>

536
00:28:18,110 --> 00:28:24,260
<font color="#CCCCCC">ticket attack will fail so with that</font>

537
00:28:20,870 --> 00:28:28,459
this is how a normal TGS<font color="#CCCCCC"> Rick packet</font>

538
00:28:24,260 --> 00:28:31,429
rooks rike<font color="#E5E5E5"> you know in the same way we</font>

539
00:28:28,460 --> 00:28:33,950
did<font color="#E5E5E5"> for overpass the hatch attack</font><font color="#CCCCCC"> if we</font>

540
00:28:31,429 --> 00:28:38,120
go here<font color="#E5E5E5"> and see the</font><font color="#CCCCCC"> e-type in the</font><font color="#E5E5E5"> TGS</font>

541
00:28:33,950 --> 00:28:39,460
<font color="#CCCCCC">sugar packet</font><font color="#E5E5E5"> it's aes-256</font><font color="#CCCCCC"> ETS</font><font color="#E5E5E5"> H</font><font color="#CCCCCC"> Mac</font>

542
00:28:38,120 --> 00:28:43,309
shi-wan

543
00:28:39,460 --> 00:28:47,830
now this is how<font color="#E5E5E5"> it looks</font><font color="#CCCCCC"> like</font><font color="#E5E5E5"> if you</font><font color="#CCCCCC"> use</font>

544
00:28:43,309 --> 00:28:50,690
the ntlm hash of the<font color="#CCCCCC"> kirby</font><font color="#E5E5E5"> TGT account</font>

545
00:28:47,830 --> 00:28:53,750
<font color="#CCCCCC">or clearly a downgrade and</font><font color="#E5E5E5"> that is what</font>

546
00:28:50,690 --> 00:28:55,400
exactly<font color="#E5E5E5"> we</font><font color="#CCCCCC"> meet a TA is looking for so</font>

547
00:28:53,750 --> 00:28:58,179
this<font color="#CCCCCC"> is the command which we</font><font color="#E5E5E5"> generally</font>

548
00:28:55,400 --> 00:29:01,250
use for<font color="#E5E5E5"> creating</font><font color="#CCCCCC"> a</font><font color="#E5E5E5"> world untick it</font>

549
00:28:58,179 --> 00:29:04,429
whatever<font color="#E5E5E5"> user name domain</font><font color="#CCCCCC"> seed of the</font>

550
00:29:01,250 --> 00:29:06,919
domain and the ntlm hash of the<font color="#CCCCCC"> COBE TTT</font>

551
00:29:04,429 --> 00:29:12,350
account<font color="#E5E5E5"> that's what we use normally</font>

552
00:29:06,919 --> 00:29:14,690
right so this<font color="#E5E5E5"> is clearly an animal</font><font color="#CCCCCC"> e and</font>

553
00:29:12,350 --> 00:29:18,250
it gets detected as encryption<font color="#CCCCCC"> down grid</font>

554
00:29:14,690 --> 00:29:23,809
activity once again if you open up the

555
00:29:18,250 --> 00:29:26,559
encryption downgrade activity here let

556
00:29:23,809 --> 00:29:26,559
<font color="#E5E5E5">me hello if</font>

557
00:29:31,110 --> 00:29:40,090
this thing so from so<font color="#E5E5E5"> this is an older</font>

558
00:29:37,600 --> 00:29:45,909
<font color="#CCCCCC">one or ps user</font><font color="#E5E5E5"> 11 a golden ticket</font><font color="#CCCCCC"> has</font>

559
00:29:40,090 --> 00:29:49,780
been<font color="#E5E5E5"> detected why because the</font><font color="#CCCCCC"> TTT field</font>

560
00:29:45,910 --> 00:29:51,520
of<font color="#CCCCCC"> TJ's rigged message has been</font>

561
00:29:49,780 --> 00:29:56,200
<font color="#CCCCCC">downgraded based on previously</font><font color="#E5E5E5"> learned</font>

562
00:29:51,520 --> 00:30:01,300
behavior fair<font color="#E5E5E5"> enough so let's make it</font>

563
00:29:56,200 --> 00:30:04,840
<font color="#CCCCCC">normal and how do we</font><font color="#E5E5E5"> do it no points for</font>

564
00:30:01,300 --> 00:30:08,139
<font color="#E5E5E5">guessing once again using AES keys and</font>

565
00:30:04,840 --> 00:30:11,110
because this time<font color="#E5E5E5"> we are not sending the</font>

566
00:30:08,140 --> 00:30:12,790
<font color="#CCCCCC">users keys we can</font><font color="#E5E5E5"> simply run</font><font color="#CCCCCC"> it from</font>

567
00:30:11,110 --> 00:30:15,520
<font color="#CCCCCC">whatever box we want there's no need to</font>

568
00:30:12,790 --> 00:30:23,610
<font color="#E5E5E5">run it from a 2012 r2 box or have a</font>

569
00:30:15,520 --> 00:30:23,610
specific patch<font color="#E5E5E5"> over there so let's see</font>

570
00:30:24,180 --> 00:30:34,050
can we<font color="#E5E5E5"> access any resource on to the</font>

571
00:30:27,820 --> 00:30:34,050
domain controller right<font color="#E5E5E5"> now no we can't</font>

572
00:30:40,560 --> 00:30:48,030
<font color="#CCCCCC">okay</font><font color="#E5E5E5"> let's create a note not this one</font>

573
00:30:45,560 --> 00:30:55,800
let's create<font color="#E5E5E5"> a quickly create a golden</font>

574
00:30:48,030 --> 00:31:05,160
<font color="#CCCCCC">ticket and see so do we have</font><font color="#E5E5E5"> many cats</font>

575
00:30:55,800 --> 00:31:10,560
here so we are using AES 256 for<font color="#E5E5E5"> the</font>

576
00:31:05,160 --> 00:31:13,380
<font color="#CCCCCC">Kirby</font><font color="#E5E5E5"> TDD account here</font><font color="#CCCCCC"> and can we access</font>

577
00:31:10,560 --> 00:31:15,659
<font color="#E5E5E5">a resource now on to the domain</font>

578
00:31:13,380 --> 00:31:17,850
controller<font color="#E5E5E5"> yes of</font><font color="#CCCCCC"> course we can</font><font color="#E5E5E5"> I mean</font>

579
00:31:15,660 --> 00:31:19,530
<font color="#E5E5E5">now we have a golden ticket we can</font>

580
00:31:17,850 --> 00:31:25,860
pretty much access any resource in the

581
00:31:19,530 --> 00:31:29,520
entire domain and there's no detection

582
00:31:25,860 --> 00:31:33,649
<font color="#E5E5E5">of this so this one that you see is from</font>

583
00:31:29,520 --> 00:31:36,900
<font color="#E5E5E5">yesterday when</font><font color="#CCCCCC"> I was testing things so</font>

584
00:31:33,650 --> 00:31:40,620
you normalize<font color="#E5E5E5"> your traffic and there</font>

585
00:31:36,900 --> 00:31:42,810
would be no<font color="#E5E5E5"> detection that's the key so</font>

586
00:31:40,620 --> 00:31:45,469
once again 8080 attacks golden ticket

587
00:31:42,810 --> 00:31:48,240
use AES<font color="#E5E5E5"> keys so I was quite</font><font color="#CCCCCC"> happy with</font>

588
00:31:45,470 --> 00:31:50,100
so I would<font color="#E5E5E5"> like to say this and I have a</font>

589
00:31:48,240 --> 00:31:52,440
<font color="#E5E5E5">slide for that</font><font color="#CCCCCC"> I'll I</font><font color="#E5E5E5"> worked with the</font>

590
00:31:50,100 --> 00:31:55,980
<font color="#E5E5E5">ATA team it was fantastic but up to this</font>

591
00:31:52,440 --> 00:31:57,900
time it was<font color="#E5E5E5"> very good with</font><font color="#CCCCCC"> ATM and</font><font color="#E5E5E5"> I was</font>

592
00:31:55,980 --> 00:32:02,400
respecting whatever it was<font color="#E5E5E5"> doing but for</font>

593
00:31:57,900 --> 00:32:05,910
some strange reason this happened you

594
00:32:02,400 --> 00:32:08,790
know<font color="#E5E5E5"> if you create a golden ticket with</font>

595
00:32:05,910 --> 00:32:11,160
ntlm hash but you use<font color="#E5E5E5"> the username as</font>

596
00:32:08,790 --> 00:32:13,440
something which is not<font color="#E5E5E5"> in</font><font color="#CCCCCC"> the domain you</font>

597
00:32:11,160 --> 00:32:14,910
make<font color="#E5E5E5"> something up</font><font color="#CCCCCC"> that thing</font><font color="#E5E5E5"> doesn't get</font>

598
00:32:13,440 --> 00:32:20,430
detected and that<font color="#E5E5E5"> is something which</font><font color="#CCCCCC"> is</font>

599
00:32:14,910 --> 00:32:23,280
<font color="#E5E5E5">really bad so how does this work in</font><font color="#CCCCCC"> the</font>

600
00:32:20,430 --> 00:32:25,620
in the command you use the<font color="#E5E5E5"> usual one you</font>

601
00:32:23,280 --> 00:32:27,960
<font color="#CCCCCC">simply</font><font color="#E5E5E5"> use something like this and this</font>

602
00:32:25,620 --> 00:32:30,919
<font color="#E5E5E5">is</font><font color="#CCCCCC"> very interesting</font><font color="#E5E5E5"> because in my class</font>

603
00:32:27,960 --> 00:32:35,190
I had questions<font color="#CCCCCC"> like</font><font color="#E5E5E5"> if we cannot</font>

604
00:32:30,920 --> 00:32:38,180
retrieve the AES key somehow because the

605
00:32:35,190 --> 00:32:40,620
DC<font color="#CCCCCC"> sync is one of the best methods and</font>

606
00:32:38,180 --> 00:32:42,720
given<font color="#E5E5E5"> that I have to give this to</font><font color="#CCCCCC"> a TA</font>

607
00:32:40,620 --> 00:32:46,169
<font color="#E5E5E5">no matter from where you run DC sync</font>

608
00:32:42,720 --> 00:32:49,770
from the same domain at least for me I

609
00:32:46,170 --> 00:32:53,040
couldn't<font color="#E5E5E5"> couldn't find any way to not</font>

610
00:32:49,770 --> 00:32:54,240
get detected<font color="#CCCCCC"> so this was this was very</font>

611
00:32:53,040 --> 00:32:56,399
interesting<font color="#CCCCCC"> for</font><font color="#E5E5E5"> me</font>

612
00:32:54,240 --> 00:32:58,499
just with the ntlm<font color="#CCCCCC"> hash known</font><font color="#E5E5E5"> nothing</font>

613
00:32:56,399 --> 00:33:00,408
else<font color="#E5E5E5"> we'll just use the</font><font color="#CCCCCC"> username</font><font color="#E5E5E5"> to be</font>

614
00:32:58,499 --> 00:33:03,629
something<font color="#CCCCCC"> else and</font><font color="#E5E5E5"> you would be fine</font><font color="#CCCCCC"> and</font>

615
00:33:00,409 --> 00:33:05,309
<font color="#E5E5E5">I initially of course</font><font color="#CCCCCC"> thought</font><font color="#E5E5E5"> that and</font>

616
00:33:03,629 --> 00:33:07,320
I'm not<font color="#CCCCCC"> this making this up when I</font>

617
00:33:05,309 --> 00:33:09,779
submit it slide<font color="#E5E5E5"> said for</font><font color="#CCCCCC"> blackhat this</font>

618
00:33:07,320 --> 00:33:11,399
<font color="#CCCCCC">is exactly what I wrote there I hope</font>

619
00:33:09,779 --> 00:33:13,259
this is a<font color="#CCCCCC"> Mis configuration in my lab</font>

620
00:33:11,399 --> 00:33:16,439
because<font color="#E5E5E5"> I couldn't fathom that this is</font>

621
00:33:13,259 --> 00:33:19,350
<font color="#E5E5E5">this could</font><font color="#CCCCCC"> be</font><font color="#E5E5E5"> possible but later on</font><font color="#CCCCCC"> it</font>

622
00:33:16,440 --> 00:33:22,110
turns out<font color="#E5E5E5"> that this was this is true</font><font color="#CCCCCC"> I</font>

623
00:33:19,350 --> 00:33:24,360
mean and this<font color="#CCCCCC"> is true up to</font><font color="#E5E5E5"> 1.8 as well</font>

624
00:33:22,110 --> 00:33:30,299
most of the<font color="#E5E5E5"> things which</font><font color="#CCCCCC"> we are</font>

625
00:33:24,360 --> 00:33:33,799
discussing are true for<font color="#CCCCCC"> a 1.8 so let me</font>

626
00:33:30,299 --> 00:33:33,799
see<font color="#E5E5E5"> if I have</font><font color="#CCCCCC"> a demo of this as well</font>

627
00:33:37,879 --> 00:33:42,259
<font color="#E5E5E5">okay and I need</font><font color="#CCCCCC"> to be a bit</font><font color="#E5E5E5"> faster</font><font color="#CCCCCC"> now</font>

628
00:33:43,789 --> 00:33:50,249
so I<font color="#CCCCCC"> purged the</font><font color="#E5E5E5"> tickets can I access any</font>

629
00:33:48,779 --> 00:33:52,820
resource on the domain controller<font color="#CCCCCC"> right</font>

630
00:33:50,249 --> 00:33:52,820
<font color="#E5E5E5">now</font><font color="#CCCCCC"> No</font>

631
00:33:59,340 --> 00:34:06,918
and the only<font color="#CCCCCC"> difference in this command</font>

632
00:34:02,039 --> 00:34:14,879
<font color="#E5E5E5">and the previous</font><font color="#CCCCCC"> one is that I use a</font>

633
00:34:06,919 --> 00:34:22,950
non-existent<font color="#E5E5E5"> username so the username</font>

634
00:34:14,879 --> 00:34:24,980
<font color="#E5E5E5">here is non-existent and I can once</font>

635
00:34:22,949 --> 00:34:29,428
again access resources<font color="#E5E5E5"> that is</font>

636
00:34:24,980 --> 00:34:36,510
persistence is still there<font color="#CCCCCC"> so very</font>

637
00:34:29,429 --> 00:34:39,599
interesting in 1.8<font color="#E5E5E5"> 81 dot s specifically</font>

638
00:34:36,510 --> 00:34:41,550
<font color="#E5E5E5">it was introduced or a feature was</font>

639
00:34:39,599 --> 00:34:44,730
introduced<font color="#E5E5E5"> for detection based on the</font>

640
00:34:41,550 --> 00:34:47,520
ticket lifetime<font color="#CCCCCC"> and I'd read it from the</font>

641
00:34:44,730 --> 00:34:49,859
<font color="#E5E5E5">release</font><font color="#CCCCCC"> notes if a Kerberos ticket is</font>

642
00:34:47,520 --> 00:34:52,020
used for more<font color="#E5E5E5"> than the allowed lifetime</font>

643
00:34:49,859 --> 00:34:54,569
80 will detect<font color="#CCCCCC"> as a suspicious</font><font color="#E5E5E5"> activity</font>

644
00:34:52,020 --> 00:34:57,720
obviously blunts the attack<font color="#E5E5E5"> now you</font>

645
00:34:54,569 --> 00:35:00,180
cannot simply<font color="#E5E5E5"> create</font><font color="#CCCCCC"> a golden</font><font color="#E5E5E5"> ticket and</font>

646
00:34:57,720 --> 00:35:03,149
take<font color="#E5E5E5"> it with your home come back six</font>

647
00:35:00,180 --> 00:35:05,250
months<font color="#CCCCCC"> later and use it that sort of</font>

648
00:35:03,150 --> 00:35:07,109
<font color="#E5E5E5">careful careless attacks are not</font>

649
00:35:05,250 --> 00:35:10,260
<font color="#E5E5E5">possible but keep this</font><font color="#CCCCCC"> in mind</font>

650
00:35:07,109 --> 00:35:12,690
it<font color="#E5E5E5"> is</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> so there are two is around</font><font color="#CCCCCC"> it</font>

651
00:35:10,260 --> 00:35:15,569
first one it is the<font color="#CCCCCC"> copy TDT hash and</font>

652
00:35:12,690 --> 00:35:18,920
not your<font color="#CCCCCC"> tickets save to</font><font color="#E5E5E5"> the file which</font>

653
00:35:15,569 --> 00:35:21,420
provides you persistence so stop<font color="#E5E5E5"> doing</font>

654
00:35:18,920 --> 00:35:23,190
<font color="#E5E5E5">something like this where you create</font><font color="#CCCCCC"> the</font>

655
00:35:21,420 --> 00:35:26,490
golden ticket save it to the file<font color="#E5E5E5"> and</font>

656
00:35:23,190 --> 00:35:28,650
use it later on<font color="#E5E5E5"> that would be a dead</font>

657
00:35:26,490 --> 00:35:30,299
giveaway<font color="#CCCCCC"> why because of</font><font color="#E5E5E5"> this thing if</font>

658
00:35:28,650 --> 00:35:34,050
<font color="#E5E5E5">you see whenever you create a golden</font>

659
00:35:30,300 --> 00:35:36,480
ticket<font color="#E5E5E5"> there is a</font><font color="#CCCCCC"> lifetime</font><font color="#E5E5E5"> attached to</font>

660
00:35:34,050 --> 00:35:39,960
it or for that matter any TGT there is a

661
00:35:36,480 --> 00:35:44,460
lifetime<font color="#E5E5E5"> attached to it if you create it</font>

662
00:35:39,960 --> 00:35:47,130
today and use it<font color="#E5E5E5"> six months</font><font color="#CCCCCC"> later the</font>

663
00:35:44,460 --> 00:35:48,839
detection<font color="#E5E5E5"> would be quite obvious</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> all</font>

664
00:35:47,130 --> 00:35:51,630
almost<font color="#E5E5E5"> all of the domains have a</font>

665
00:35:48,839 --> 00:35:53,578
<font color="#E5E5E5">lifetime on on a ticket and if you use a</font>

666
00:35:51,630 --> 00:35:54,569
ticket<font color="#CCCCCC"> witches</font><font color="#E5E5E5"> off its lifetime that's</font>

667
00:35:53,579 --> 00:35:56,730
<font color="#E5E5E5">that giveaway</font>

668
00:35:54,569 --> 00:36:00,480
<font color="#E5E5E5">so don't save your tickets on to the</font>

669
00:35:56,730 --> 00:36:03,540
disk<font color="#E5E5E5"> otherwise this is how lifetime</font>

670
00:36:00,480 --> 00:36:06,599
based detection looks like you know<font color="#E5E5E5"> our</font>

671
00:36:03,540 --> 00:36:08,279
ticket was used<font color="#E5E5E5"> so allowed maximum</font><font color="#CCCCCC"> in my</font>

672
00:36:06,599 --> 00:36:12,589
domain<font color="#E5E5E5"> for testing is one hours and</font>

673
00:36:08,280 --> 00:36:12,589
there was a<font color="#E5E5E5"> ticket use for</font><font color="#CCCCCC"> 275</font><font color="#E5E5E5"> hours</font>

674
00:36:20,940 --> 00:36:28,660
now keep the ticket lifetime in mind<font color="#E5E5E5"> if</font>

675
00:36:26,289 --> 00:36:30,640
you don't<font color="#E5E5E5"> know it it's in the</font><font color="#CCCCCC"> wiki of</font>

676
00:36:28,660 --> 00:36:32,170
the mimikatz<font color="#CCCCCC"> you can actually set a</font>

677
00:36:30,640 --> 00:36:34,720
lifetime<font color="#CCCCCC"> of a golden ticket while</font>

678
00:36:32,170 --> 00:36:37,569
<font color="#E5E5E5">creating it</font><font color="#CCCCCC"> so keep</font><font color="#E5E5E5"> that</font><font color="#CCCCCC"> in mind as well</font>

679
00:36:34,720 --> 00:36:40,149
<font color="#E5E5E5">you can use start</font><font color="#CCCCCC"> offset</font><font color="#E5E5E5"> and add in</font>

680
00:36:37,569 --> 00:36:43,210
options to set lifetime of<font color="#E5E5E5"> a ticket and</font>

681
00:36:40,150 --> 00:36:45,339
never leave your the golden ticket<font color="#E5E5E5"> in</font>

682
00:36:43,210 --> 00:36:47,589
<font color="#E5E5E5">memory purge it</font><font color="#CCCCCC"> as soon as you're</font><font color="#E5E5E5"> over</font>

683
00:36:45,339 --> 00:36:50,380
done with<font color="#CCCCCC"> the things project</font><font color="#E5E5E5"> otherwise</font>

684
00:36:47,589 --> 00:36:53,288
the detection which I<font color="#E5E5E5"> assured</font><font color="#CCCCCC"> you just</font>

685
00:36:50,380 --> 00:36:57,430
now would be<font color="#E5E5E5"> there ready ready to catch</font>

686
00:36:53,289 --> 00:37:00,569
you now there<font color="#E5E5E5"> are some interesting</font>

687
00:36:57,430 --> 00:37:03,700
<font color="#E5E5E5">attacks like constrained delegation</font>

688
00:37:00,569 --> 00:37:06,369
<font color="#E5E5E5">where you have the ability</font><font color="#CCCCCC"> to access</font><font color="#E5E5E5"> any</font>

689
00:37:03,700 --> 00:37:09,460
service<font color="#E5E5E5"> to access a particular</font><font color="#CCCCCC"> service</font>

690
00:37:06,369 --> 00:37:11,890
by<font color="#CCCCCC"> impersonating any user</font><font color="#E5E5E5"> so there is no</font>

691
00:37:09,460 --> 00:37:16,359
demonstration unfortunately for<font color="#E5E5E5"> that it</font>

692
00:37:11,890 --> 00:37:20,430
doesn't get detected<font color="#E5E5E5"> why service</font>

693
00:37:16,359 --> 00:37:23,410
accounts support only<font color="#E5E5E5"> rc4 encryption and</font>

694
00:37:20,430 --> 00:37:26,558
this<font color="#E5E5E5"> what this I learned while</font>

695
00:37:23,410 --> 00:37:29,229
<font color="#E5E5E5">discussing my talk with the ATA team I</font>

696
00:37:26,559 --> 00:37:31,200
didn't knew that in<font color="#E5E5E5"> advance of service</font>

697
00:37:29,229 --> 00:37:34,149
<font color="#E5E5E5">accounts support only rc4 encryption</font>

698
00:37:31,200 --> 00:37:36,910
<font color="#E5E5E5">when you use ntlm hash of a service</font>

699
00:37:34,150 --> 00:37:38,410
<font color="#E5E5E5">account to</font><font color="#CCCCCC"> exploit or to abuse</font>

700
00:37:36,910 --> 00:37:40,029
constraint delegation

701
00:37:38,410 --> 00:37:43,629
it's still the<font color="#E5E5E5"> same thing there is no</font>

702
00:37:40,029 --> 00:37:47,049
downgrade<font color="#CCCCCC"> so therefore there is no</font>

703
00:37:43,630 --> 00:37:50,259
detection<font color="#E5E5E5"> once again if you run DC sync</font>

704
00:37:47,049 --> 00:37:52,239
sort of attack using constrained

705
00:37:50,259 --> 00:37:54,969
delegation you will still get detected

706
00:37:52,239 --> 00:37:58,150
DC<font color="#E5E5E5"> syncs detection as</font><font color="#CCCCCC"> for</font><font color="#E5E5E5"> eyes I know</font>

707
00:37:54,969 --> 00:38:02,049
it's been<font color="#E5E5E5"> rock-solid couldn't find</font>

708
00:37:58,150 --> 00:38:06,279
anything<font color="#E5E5E5"> really interesting when comes</font>

709
00:38:02,049 --> 00:38:08,410
<font color="#CCCCCC">deceasing just</font><font color="#E5E5E5"> one thing and this</font><font color="#CCCCCC"> is</font>

710
00:38:06,279 --> 00:38:11,529
when when<font color="#E5E5E5"> I was discussing this thing or</font>

711
00:38:08,410 --> 00:38:15,190
during my<font color="#E5E5E5"> training the last day some of</font>

712
00:38:11,529 --> 00:38:20,410
<font color="#E5E5E5">my students or attendees did not agree</font>

713
00:38:15,190 --> 00:38:24,099
for<font color="#E5E5E5"> them the first part no the second</font>

714
00:38:20,410 --> 00:38:26,950
part if even if you run DC sync from<font color="#E5E5E5"> a</font>

715
00:38:24,099 --> 00:38:28,869
domain admin of a child domain for them

716
00:38:26,950 --> 00:38:31,140
it was getting detected<font color="#E5E5E5"> for me it was</font>

717
00:38:28,869 --> 00:38:31,140
not

718
00:38:31,720 --> 00:38:36,970
so let's nevertheless let's have a look

719
00:38:34,060 --> 00:38:39,609
at couple<font color="#E5E5E5"> of attacks across</font><font color="#CCCCCC"> to us</font><font color="#E5E5E5"> trusts</font>

720
00:38:36,970 --> 00:38:41,740
which doesn't get detected one is the

721
00:38:39,609 --> 00:38:44,759
<font color="#CCCCCC">well-known way</font><font color="#E5E5E5"> of detailed here the</font>

722
00:38:41,740 --> 00:38:48,040
<font color="#CCCCCC">well-known one when you</font><font color="#E5E5E5"> get access to</font>

723
00:38:44,760 --> 00:38:49,960
the<font color="#E5E5E5"> as L to the dome as a domain</font>

724
00:38:48,040 --> 00:38:53,140
<font color="#E5E5E5">administrator in a child domain and you</font>

725
00:38:49,960 --> 00:38:57,220
escalate<font color="#CCCCCC"> your privileges to enterprise</font>

726
00:38:53,140 --> 00:38:59,799
<font color="#E5E5E5">admin there is no detection at all why</font>

727
00:38:57,220 --> 00:39:04,810
because that interval<font color="#E5E5E5"> T DT is still</font>

728
00:38:59,800 --> 00:39:07,569
using our C for hash so no<font color="#CCCCCC"> detection</font><font color="#E5E5E5"> if</font>

729
00:39:04,810 --> 00:39:09,549
you run a replication<font color="#CCCCCC"> or a DC</font><font color="#E5E5E5"> sync from</font>

730
00:39:07,569 --> 00:39:13,089
a child domain<font color="#E5E5E5"> the child domain</font>

731
00:39:09,550 --> 00:39:15,910
controller<font color="#E5E5E5"> in during</font><font color="#CCCCCC"> my testing that was</font>

732
00:39:13,089 --> 00:39:20,819
not<font color="#E5E5E5"> detected right so that is the only</font>

733
00:39:15,910 --> 00:39:20,819
DC sync bypass or avoidance I know of

734
00:39:20,910 --> 00:39:26,649
<font color="#CCCCCC">none xed plaintext passwords</font><font color="#E5E5E5"> you can</font>

735
00:39:24,490 --> 00:39:29,979
expect<font color="#CCCCCC"> we</font><font color="#E5E5E5"> in test plaintext passwords</font>

736
00:39:26,650 --> 00:39:31,660
using variety of ways there are so many

737
00:39:29,980 --> 00:39:32,950
instances<font color="#CCCCCC"> where you</font><font color="#E5E5E5"> can get your hands</font>

738
00:39:31,660 --> 00:39:36,490
on in those cases

739
00:39:32,950 --> 00:39:38,680
animal<font color="#CCCCCC"> based detections are of no use if</font>

740
00:39:36,490 --> 00:39:41,680
you<font color="#CCCCCC"> can't bypass it just avoid it how do</font>

741
00:39:38,680 --> 00:39:45,009
you avoid it here by not talking<font color="#E5E5E5"> to the</font>

742
00:39:41,680 --> 00:39:47,049
domain controller like attacks like

743
00:39:45,010 --> 00:39:49,960
silver ticket<font color="#E5E5E5"> let's say you target a</font>

744
00:39:47,050 --> 00:39:53,050
server which has<font color="#CCCCCC"> a sequence</font><font color="#E5E5E5"> of</font><font color="#CCCCCC"> cycle</font>

745
00:39:49,960 --> 00:39:54,670
server running on it you target the

746
00:39:53,050 --> 00:39:57,280
service account of that<font color="#E5E5E5"> particular</font>

747
00:39:54,670 --> 00:40:00,069
sequel server get access to<font color="#E5E5E5"> it in a text</font>

748
00:39:57,280 --> 00:40:03,010
<font color="#E5E5E5">like these because there is no</font>

749
00:40:00,069 --> 00:40:04,740
communication<font color="#E5E5E5"> to the DC there is no</font>

750
00:40:03,010 --> 00:40:07,690
detection<font color="#E5E5E5"> right</font>

751
00:40:04,740 --> 00:40:12,060
Kerberos to<font color="#E5E5E5"> attack minimal interaction</font>

752
00:40:07,690 --> 00:40:15,130
with the DC just<font color="#E5E5E5"> request a valid TDS</font>

753
00:40:12,060 --> 00:40:19,540
save it to the disk<font color="#CCCCCC"> crack</font><font color="#E5E5E5"> it offline no</font>

754
00:40:15,130 --> 00:40:23,079
detection<font color="#E5E5E5"> variants of Kerberos you</font>

755
00:40:19,540 --> 00:40:28,060
request<font color="#E5E5E5"> if you go back here save a s</font><font color="#CCCCCC"> rap</font>

756
00:40:23,079 --> 00:40:30,609
to the<font color="#E5E5E5"> disk CBS CBS rep to the days</font>

757
00:40:28,060 --> 00:40:33,849
would force<font color="#E5E5E5"> it offline no detection for</font>

758
00:40:30,609 --> 00:40:36,160
set<font color="#CCCCCC"> s pn on a user request TGS save it</font>

759
00:40:33,849 --> 00:40:38,349
to the days would force offline no

760
00:40:36,160 --> 00:40:40,598
detection<font color="#E5E5E5"> why because we are not even</font>

761
00:40:38,349 --> 00:40:42,069
<font color="#CCCCCC">talking to the domain controller or if</font>

762
00:40:40,599 --> 00:40:44,440
there<font color="#E5E5E5"> is any talking</font><font color="#CCCCCC"> it's just</font>

763
00:40:42,069 --> 00:40:47,109
requesting a Kerberos ticket

764
00:40:44,440 --> 00:40:50,290
<font color="#CCCCCC">sequel</font><font color="#E5E5E5"> servers attack a sequel server</font>

765
00:40:47,109 --> 00:40:53,828
<font color="#E5E5E5">move across the database layer and</font><font color="#CCCCCC"> aadya</font>

766
00:40:50,290 --> 00:40:56,920
<font color="#CCCCCC">is not even designed to catch these sort</font>

767
00:40:53,829 --> 00:40:59,079
of attacks<font color="#E5E5E5"> off of course no detection</font><font color="#CCCCCC"> if</font>

768
00:40:56,920 --> 00:41:01,710
it is not really looking at<font color="#CCCCCC"> the</font><font color="#E5E5E5"> traffic</font>

769
00:40:59,079 --> 00:41:04,630
<font color="#CCCCCC">they</font><font color="#E5E5E5"> can be an interaction right a</font>

770
00:41:01,710 --> 00:41:06,160
couple of attack chains<font color="#E5E5E5"> which I think I</font>

771
00:41:04,630 --> 00:41:08,500
should skip right now because<font color="#E5E5E5"> I have</font>

772
00:41:06,160 --> 00:41:12,040
couple<font color="#E5E5E5"> of interesting things</font><font color="#CCCCCC"> and I have</font>

773
00:41:08,500 --> 00:41:13,180
like<font color="#CCCCCC"> seven or eight minutes</font><font color="#E5E5E5"> left or let</font>

774
00:41:12,040 --> 00:41:15,279
<font color="#E5E5E5">me quickly go through this</font>

775
00:41:13,180 --> 00:41:17,410
it's<font color="#CCCCCC"> Espeon scanning for sequel servers</font>

776
00:41:15,280 --> 00:41:19,420
gain access to a sequel server by brute

777
00:41:17,410 --> 00:41:21,160
forcing the<font color="#CCCCCC"> SA account or some Thor</font>

778
00:41:19,420 --> 00:41:23,740
sequel injection or whatever you want

779
00:41:21,160 --> 00:41:26,799
<font color="#E5E5E5">move around in the database layers by</font>

780
00:41:23,740 --> 00:41:30,959
exploiting<font color="#CCCCCC"> linked databases</font><font color="#E5E5E5"> and then</font>

781
00:41:26,800 --> 00:41:33,460
later<font color="#CCCCCC"> on if you are a pure goal of your</font>

782
00:41:30,960 --> 00:41:37,480
assessment is domain admin privileges go

783
00:41:33,460 --> 00:41:41,740
for it<font color="#CCCCCC"> okay lets me let me skip the</font>

784
00:41:37,480 --> 00:41:44,589
attack chain<font color="#E5E5E5"> to limitations LDAP</font><font color="#CCCCCC"> as</font>

785
00:41:41,740 --> 00:41:46,839
IPSec<font color="#CCCCCC"> ESB these are two</font><font color="#E5E5E5"> protocols which</font>

786
00:41:44,589 --> 00:41:49,420
are documented that<font color="#E5E5E5"> ata can't have a</font>

787
00:41:46,839 --> 00:41:53,740
look at there<font color="#CCCCCC"> are only certain protocols</font>

788
00:41:49,420 --> 00:41:56,619
which<font color="#CCCCCC"> eighty look at if there is no</font>

789
00:41:53,740 --> 00:41:58,419
detection<font color="#CCCCCC"> there is no animal e</font><font color="#E5E5E5"> signature</font>

790
00:41:56,619 --> 00:42:00,310
of an attack it won't get detected

791
00:41:58,420 --> 00:42:03,160
something<font color="#CCCCCC"> which I someone blogged about</font>

792
00:42:00,310 --> 00:42:08,259
at medium and<font color="#E5E5E5"> and we blogged it this</font>

793
00:42:03,160 --> 00:42:10,750
attack doesn't get detected as well now

794
00:42:08,260 --> 00:42:14,380
if we want<font color="#CCCCCC"> to attack the deployment of</font>

795
00:42:10,750 --> 00:42:16,510
<font color="#E5E5E5">ata that is it is fine as long</font><font color="#CCCCCC"> as</font><font color="#E5E5E5"> we can</font>

796
00:42:14,380 --> 00:42:18,359
bypass or avoid it<font color="#E5E5E5"> what are our options</font>

797
00:42:16,510 --> 00:42:23,710
if you would like<font color="#E5E5E5"> to directly heads on</font>

798
00:42:18,359 --> 00:42:27,130
target ata first you can identify<font color="#E5E5E5"> ata by</font>

799
00:42:23,710 --> 00:42:29,200
<font color="#E5E5E5">a simple banner</font><font color="#CCCCCC"> Grabel which is fine now</font>

800
00:42:27,130 --> 00:42:31,480
<font color="#CCCCCC">ATS subscribes to that</font><font color="#E5E5E5"> theory that if</font>

801
00:42:29,200 --> 00:42:34,960
you have administrative<font color="#E5E5E5"> access on</font><font color="#CCCCCC"> our</font>

802
00:42:31,480 --> 00:42:37,660
box<font color="#CCCCCC"> it's game over</font><font color="#E5E5E5"> what does that mean</font>

803
00:42:34,960 --> 00:42:39,819
<font color="#E5E5E5">if you have so ATF</font><font color="#CCCCCC"> use remember the</font>

804
00:42:37,660 --> 00:42:43,839
diagram has a system part and a console

805
00:42:39,819 --> 00:42:46,240
part so the console is where you know

806
00:42:43,839 --> 00:42:49,990
this console<font color="#E5E5E5"> is on the system so the ATS</font>

807
00:42:46,240 --> 00:42:52,180
system is that box where<font color="#CCCCCC"> 88 pulls all</font>

808
00:42:49,990 --> 00:42:54,819
the traffic and whatever<font color="#E5E5E5"> and do all its</font>

809
00:42:52,180 --> 00:42:57,669
magic so if you have admin access ended

810
00:42:54,819 --> 00:42:59,770
on that box<font color="#E5E5E5"> all the local</font>

811
00:42:57,670 --> 00:43:01,750
administrator users of<font color="#CCCCCC"> that</font><font color="#E5E5E5"> box have</font>

812
00:42:59,770 --> 00:43:04,569
access to a TA console<font color="#E5E5E5"> what does that</font>

813
00:43:01,750 --> 00:43:07,089
mean if you<font color="#CCCCCC"> have deployed a TA as part</font>

814
00:43:04,569 --> 00:43:09,190
of your<font color="#E5E5E5"> domain and the ATA system is</font>

815
00:43:07,089 --> 00:43:10,770
<font color="#E5E5E5">also part of</font><font color="#CCCCCC"> your domain</font><font color="#E5E5E5"> and you get</font>

816
00:43:09,190 --> 00:43:13,839
your hands<font color="#E5E5E5"> on to a</font><font color="#CCCCCC"> domain administrator</font>

817
00:43:10,770 --> 00:43:16,359
<font color="#CCCCCC">it would be</font><font color="#E5E5E5"> possible for you to access a</font>

818
00:43:13,839 --> 00:43:19,000
TA console what is<font color="#E5E5E5"> 80 console this this</font>

819
00:43:16,359 --> 00:43:24,430
thing<font color="#E5E5E5"> this is 80 console you can access</font>

820
00:43:19,000 --> 00:43:28,690
it using any such user which<font color="#CCCCCC"> is okay</font>

821
00:43:24,430 --> 00:43:31,540
<font color="#E5E5E5">that's just using authentication for</font>

822
00:43:28,690 --> 00:43:35,619
something else<font color="#CCCCCC"> now the</font><font color="#E5E5E5"> backend MongoDB</font>

823
00:43:31,540 --> 00:43:38,740
which<font color="#E5E5E5"> ATI uses to store things has no</font>

824
00:43:35,619 --> 00:43:41,710
password<font color="#CCCCCC"> all that listens</font><font color="#E5E5E5"> only on the</font>

825
00:43:38,740 --> 00:43:43,270
local<font color="#E5E5E5"> loopback but once again if you</font>

826
00:43:41,710 --> 00:43:44,980
<font color="#CCCCCC">have access to the box there are</font><font color="#E5E5E5"> so many</font>

827
00:43:43,270 --> 00:43:47,470
things you can<font color="#E5E5E5"> do you can read users</font>

828
00:43:44,980 --> 00:43:50,290
profiles how it is<font color="#E5E5E5"> detected things what</font>

829
00:43:47,470 --> 00:43:54,189
it is storing and we can do something

830
00:43:50,290 --> 00:43:56,470
<font color="#CCCCCC">like</font><font color="#E5E5E5"> this if there is an alert we can</font>

831
00:43:54,190 --> 00:44:01,359
actually<font color="#CCCCCC"> change</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> identity</font><font color="#E5E5E5"> on that</font>

832
00:43:56,470 --> 00:44:05,439
alert right<font color="#E5E5E5"> so here it was</font><font color="#CCCCCC"> Oh PS</font>

833
00:44:01,359 --> 00:44:07,630
terminal<font color="#E5E5E5"> SC term admin user which was</font>

834
00:44:05,440 --> 00:44:11,230
<font color="#E5E5E5">doing interesting things then we changed</font>

835
00:44:07,630 --> 00:44:13,960
it and can blame it on someone<font color="#E5E5E5"> else even</font>

836
00:44:11,230 --> 00:44:17,380
<font color="#E5E5E5">easier is to set the visibility</font><font color="#CCCCCC"> of</font>

837
00:44:13,960 --> 00:44:19,630
alerts you can<font color="#E5E5E5"> just change is visible to</font>

838
00:44:17,380 --> 00:44:25,270
<font color="#E5E5E5">false and an alert would be gone from</font>

839
00:44:19,630 --> 00:44:27,819
the console<font color="#E5E5E5"> without leaving any trace so</font>

840
00:44:25,270 --> 00:44:30,640
what are the defenses against the

841
00:44:27,819 --> 00:44:33,970
evasions<font color="#E5E5E5"> of course as soon as fixes are</font>

842
00:44:30,640 --> 00:44:36,759
<font color="#E5E5E5">there upgrade your</font><font color="#CCCCCC"> ata</font><font color="#E5E5E5"> and the normal</font>

843
00:44:33,970 --> 00:44:38,740
ones the the run-of-the-mill<font color="#E5E5E5"> defenses do</font>

844
00:44:36,760 --> 00:44:43,329
not allow your domain admins to<font color="#CCCCCC"> log into</font>

845
00:44:38,740 --> 00:44:45,040
whatever<font color="#E5E5E5"> box they wish to or possible</font>

846
00:44:43,329 --> 00:44:48,010
architectural changes suggested<font color="#E5E5E5"> here</font>

847
00:44:45,040 --> 00:44:50,829
securing privileged access<font color="#E5E5E5"> how do you</font>

848
00:44:48,010 --> 00:44:56,890
avoid<font color="#E5E5E5"> ata even when it is updated later</font>

849
00:44:50,829 --> 00:44:58,660
on why the temptation of escalating to

850
00:44:56,890 --> 00:45:00,490
domain admin privileges without

851
00:44:58,660 --> 00:45:02,609
understanding<font color="#E5E5E5"> Active Directory</font>

852
00:45:00,490 --> 00:45:05,259
environment there are so many

853
00:45:02,609 --> 00:45:08,020
<font color="#CCCCCC">breadcrumbs</font><font color="#E5E5E5"> and honey tokens and honey</font>

854
00:45:05,260 --> 00:45:10,359
users out there<font color="#E5E5E5"> that going at the very</font>

855
00:45:08,020 --> 00:45:11,350
first moment for the<font color="#E5E5E5"> lowest hanging</font>

856
00:45:10,359 --> 00:45:13,210
fruit

857
00:45:11,350 --> 00:45:15,160
should not<font color="#CCCCCC"> be there</font><font color="#E5E5E5"> you know as soon as</font>

858
00:45:13,210 --> 00:45:17,020
you<font color="#CCCCCC"> spot that okay in</font><font color="#E5E5E5"> my very first</font>

859
00:45:15,160 --> 00:45:19,359
<font color="#E5E5E5">enumeration I found out a box where</font><font color="#CCCCCC"> I'm</font>

860
00:45:17,020 --> 00:45:21,610
<font color="#CCCCCC">a local</font><font color="#E5E5E5"> admin and a domain admin is</font>

861
00:45:19,360 --> 00:45:25,390
logged in there that could<font color="#CCCCCC"> be a</font>

862
00:45:21,610 --> 00:45:28,390
deception<font color="#E5E5E5"> so be mindful of that and</font>

863
00:45:25,390 --> 00:45:31,240
reduce communication<font color="#CCCCCC"> to the DC</font><font color="#E5E5E5"> please do</font>

864
00:45:28,390 --> 00:45:33,609
not create a golden ticket<font color="#CCCCCC"> just so</font><font color="#E5E5E5"> that</font>

865
00:45:31,240 --> 00:45:36,040
you can write about<font color="#E5E5E5"> that</font><font color="#CCCCCC"> in your report</font>

866
00:45:33,610 --> 00:45:37,720
that<font color="#E5E5E5"> look how badly screw your</font>

867
00:45:36,040 --> 00:45:39,880
environment is<font color="#E5E5E5"> I've got a golden</font><font color="#CCCCCC"> ticket</font>

868
00:45:37,720 --> 00:45:42,910
no not for that<font color="#CCCCCC"> if you actually want to</font>

869
00:45:39,880 --> 00:45:46,260
persist<font color="#E5E5E5"> your terms of engagement say</font>

870
00:45:42,910 --> 00:45:46,259
that<font color="#CCCCCC"> only then go for it</font>

871
00:45:46,560 --> 00:45:52,210
<font color="#E5E5E5">so for limitations</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> this research or</font>

872
00:45:50,170 --> 00:45:55,060
talk has been<font color="#E5E5E5"> focused only on</font><font color="#CCCCCC"> the</font>

873
00:45:52,210 --> 00:45:56,800
bypasses<font color="#E5E5E5"> for animal based detections</font>

874
00:45:55,060 --> 00:45:59,110
<font color="#E5E5E5">of course there are so many of these</font>

875
00:45:56,800 --> 00:46:01,570
things<font color="#CCCCCC"> which may get detected in actual</font>

876
00:45:59,110 --> 00:46:05,310
environment<font color="#CCCCCC"> when user behavior detection</font>

877
00:46:01,570 --> 00:46:07,840
<font color="#E5E5E5">is implemented couldn't test that though</font>

878
00:46:05,310 --> 00:46:11,380
<font color="#E5E5E5">in case</font><font color="#CCCCCC"> you are getting</font><font color="#E5E5E5"> detected use</font>

879
00:46:07,840 --> 00:46:13,600
avoidance techniques and big<font color="#E5E5E5"> thanks to</font>

880
00:46:11,380 --> 00:46:16,990
the ATA team<font color="#E5E5E5"> I know some of you guys</font><font color="#CCCCCC"> are</font>

881
00:46:13,600 --> 00:46:19,690
<font color="#CCCCCC">here so it was fantastic to</font><font color="#E5E5E5"> work</font><font color="#CCCCCC"> with</font>

882
00:46:16,990 --> 00:46:22,029
them those I would quickly<font color="#CCCCCC"> like to say</font>

883
00:46:19,690 --> 00:46:24,840
<font color="#E5E5E5">this out I've worked with</font><font color="#CCCCCC"> em SRC last</font>

884
00:46:22,030 --> 00:46:28,510
year as<font color="#E5E5E5"> well and while speaking about MZ</font>

885
00:46:24,840 --> 00:46:31,120
it's a new Microsoft<font color="#CCCCCC"> so they</font><font color="#E5E5E5"> actually</font>

886
00:46:28,510 --> 00:46:33,040
encourage you to go after<font color="#E5E5E5"> their products</font>

887
00:46:31,120 --> 00:46:35,710
as<font color="#CCCCCC"> far as that isn't</font><font color="#E5E5E5"> what my</font><font color="#CCCCCC"> experiences</font>

888
00:46:33,040 --> 00:46:39,100
<font color="#CCCCCC">being go after their products</font><font color="#E5E5E5"> and</font><font color="#CCCCCC"> find</font>

889
00:46:35,710 --> 00:46:43,600
<font color="#E5E5E5">find the right guy and they will</font>

890
00:46:39,100 --> 00:46:45,850
actually<font color="#CCCCCC"> appreciate your work so to sum</font>

891
00:46:43,600 --> 00:46:48,790
it<font color="#E5E5E5"> up it is possible to bypass</font>

892
00:46:45,850 --> 00:46:51,040
detections by a TA<font color="#E5E5E5"> by modifying</font>

893
00:46:48,790 --> 00:46:53,110
<font color="#CCCCCC">well-known attacks a little bit so that</font>

894
00:46:51,040 --> 00:46:55,870
<font color="#E5E5E5">they appear</font><font color="#CCCCCC"> normal</font><font color="#E5E5E5"> to to the direction</font>

895
00:46:53,110 --> 00:46:58,000
<font color="#CCCCCC">sensors modification of attack</font>

896
00:46:55,870 --> 00:47:01,480
methodology<font color="#E5E5E5"> and staying focus on goals</font>

897
00:46:58,000 --> 00:47:03,820
<font color="#E5E5E5">of</font><font color="#CCCCCC"> your assessment that is not talking</font>

898
00:47:01,480 --> 00:47:07,990
<font color="#CCCCCC">to the DC and necessarily is effective</font>

899
00:47:03,820 --> 00:47:12,400
and despite its limitations<font color="#CCCCCC"> ata still</font>

900
00:47:07,990 --> 00:47:14,049
provides interesting<font color="#CCCCCC"> insight to do your</font>

901
00:47:12,400 --> 00:47:17,770
Active Directory environment so you may

902
00:47:14,050 --> 00:47:20,020
<font color="#E5E5E5">be still keep using it and that</font><font color="#CCCCCC"> is all</font>

903
00:47:17,770 --> 00:47:23,310
<font color="#E5E5E5">you know</font><font color="#CCCCCC"> once again you can</font><font color="#E5E5E5"> follow me on</font>

904
00:47:20,020 --> 00:47:23,310
<font color="#E5E5E5">Twitter here I would love that</font>

905
00:47:23,350 --> 00:47:27,520
<font color="#CCCCCC">brought me email</font><font color="#E5E5E5"> either on my personal</font>

906
00:47:25,150 --> 00:47:31,300
ID or<font color="#E5E5E5"> more my company ID for if you want</font>

907
00:47:27,520 --> 00:47:33,940
to hire me<font color="#CCCCCC"> and all the slides</font><font color="#E5E5E5"> all the</font>

908
00:47:31,300 --> 00:47:36,430
<font color="#CCCCCC">slides blogs etc</font><font color="#E5E5E5"> would be</font><font color="#CCCCCC"> available on</font>

909
00:47:33,940 --> 00:47:37,220
<font color="#CCCCCC">my blog and on my github thank you very</font>

910
00:47:36,430 --> 00:47:45,600
much

911
00:47:37,220 --> 00:47:45,600
[Applause]

