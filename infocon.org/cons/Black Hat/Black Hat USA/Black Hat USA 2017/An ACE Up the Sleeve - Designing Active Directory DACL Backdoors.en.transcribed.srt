1
00:00:00,000 --> 00:00:02,399
my name is<font color="#E5E5E5"> Andy Robbins this is</font><font color="#CCCCCC"> will</font>

2
00:00:01,530 --> 00:00:04,500
trader<font color="#E5E5E5"> we're going to introduce</font>

3
00:00:02,399 --> 00:00:06,660
<font color="#E5E5E5">ourselves a little more</font><font color="#CCCCCC"> in-depth the</font>

4
00:00:04,500 --> 00:00:09,420
title of our talk is an ace up the

5
00:00:06,660 --> 00:00:11,759
sleeve<font color="#CCCCCC"> designing Active Directory dackel</font>

6
00:00:09,420 --> 00:00:13,440
<font color="#CCCCCC">backdoors we're super excited about</font><font color="#E5E5E5"> the</font>

7
00:00:11,759 --> 00:00:14,759
talk we hope that we hope that<font color="#E5E5E5"> you enjoy</font>

8
00:00:13,440 --> 00:00:15,149
the content<font color="#CCCCCC"> this</font><font color="#E5E5E5"> is our first time at</font>

9
00:00:14,759 --> 00:00:16,619
blackhat

10
00:00:15,150 --> 00:00:19,710
<font color="#CCCCCC">our first time to act i blackhat</font><font color="#E5E5E5"> have</font>

11
00:00:16,619 --> 00:00:22,830
<font color="#E5E5E5">you got here super excited</font><font color="#CCCCCC"> this</font><font color="#E5E5E5"> is me</font>

12
00:00:19,710 --> 00:00:24,359
<font color="#CCCCCC">andy robbins also known as waldo i work</font>

13
00:00:22,830 --> 00:00:26,698
<font color="#E5E5E5">inspector ops as the adversary</font>

14
00:00:24,359 --> 00:00:28,650
resilience lead<font color="#CCCCCC"> i'm a</font><font color="#E5E5E5"> co-founder and</font>

15
00:00:26,699 --> 00:00:30,840
developer<font color="#CCCCCC"> of the bloodhound project i've</font>

16
00:00:28,650 --> 00:00:33,690
done training of done presentations<font color="#E5E5E5"> and</font>

17
00:00:30,840 --> 00:00:36,420
if you're a<font color="#E5E5E5"> financial geek</font><font color="#CCCCCC"> i would love</font>

18
00:00:33,690 --> 00:00:40,500
<font color="#E5E5E5">to talk</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> you about ACH and how awful</font>

19
00:00:36,420 --> 00:00:41,160
<font color="#CCCCCC">that that whole platform is my name is</font>

20
00:00:40,500 --> 00:00:43,320
<font color="#CCCCCC">Louis trader</font>

21
00:00:41,160 --> 00:00:45,750
my handle<font color="#E5E5E5"> is harm joy</font><font color="#CCCCCC"> I'm an offensive</font>

22
00:00:43,320 --> 00:00:48,360
engineer with Andy at Specter<font color="#CCCCCC"> ups</font><font color="#E5E5E5"> I've</font>

23
00:00:45,750 --> 00:00:51,059
written a lot of<font color="#E5E5E5"> code on the co-founder</font>

24
00:00:48,360 --> 00:00:53,489
or<font color="#E5E5E5"> developer on bail framework Empire</font>

25
00:00:51,059 --> 00:00:55,559
<font color="#E5E5E5">Power View</font><font color="#CCCCCC"> powerup bloodhound on key</font>

26
00:00:53,489 --> 00:00:58,169
<font color="#E5E5E5">thief a whole bunch of stuff</font><font color="#CCCCCC"> I presented</font>

27
00:00:55,559 --> 00:00:59,760
a few places been a trainer and<font color="#CCCCCC"> a active</font>

28
00:00:58,170 --> 00:01:02,280
<font color="#CCCCCC">powersploit</font><font color="#E5E5E5"> developer and I'm a</font>

29
00:00:59,760 --> 00:01:03,780
Microsoft<font color="#CCCCCC"> PowerShell MVP so somehow</font>

30
00:01:02,280 --> 00:01:05,369
Microsoft doesn't<font color="#CCCCCC"> hate me</font><font color="#E5E5E5"> enough</font><font color="#CCCCCC"> that</font>

31
00:01:03,780 --> 00:01:08,250
they decided to<font color="#E5E5E5"> at least make me an MVP</font>

32
00:01:05,369 --> 00:01:09,630
so<font color="#CCCCCC"> okay</font><font color="#E5E5E5"> so let's give you an</font><font color="#CCCCCC"> idea of</font>

33
00:01:08,250 --> 00:01:11,580
<font color="#E5E5E5">we're going to go so we're going to</font>

34
00:01:09,630 --> 00:01:13,619
start<font color="#E5E5E5"> off by talking about</font><font color="#CCCCCC"> decals and</font>

35
00:01:11,580 --> 00:01:15,240
<font color="#E5E5E5">aces what these are how they work why</font>

36
00:01:13,619 --> 00:01:17,310
they matter<font color="#E5E5E5"> we're going to talk about</font>

37
00:01:15,240 --> 00:01:19,289
<font color="#E5E5E5">common misconfigurations and how those</font>

38
00:01:17,310 --> 00:01:21,840
misconfigurations can be abused<font color="#CCCCCC"> for</font>

39
00:01:19,290 --> 00:01:23,220
privacy and for backdoors<font color="#E5E5E5"> we're going to</font>

40
00:01:21,840 --> 00:01:24,960
do a demonstration of how to analyze

41
00:01:23,220 --> 00:01:27,450
these more<font color="#E5E5E5"> easily using the</font><font color="#CCCCCC"> bloodhound</font>

42
00:01:24,960 --> 00:01:31,169
interface<font color="#E5E5E5"> then we'll go</font><font color="#CCCCCC"> through our case</font>

43
00:01:27,450 --> 00:01:33,509
studies<font color="#CCCCCC"> of designing the</font><font color="#E5E5E5"> the ACL based</font>

44
00:01:31,170 --> 00:01:34,560
<font color="#E5E5E5">backdoors will show some examples of</font>

45
00:01:33,509 --> 00:01:36,540
some<font color="#CCCCCC"> of the things that</font><font color="#E5E5E5"> we've thought of</font>

46
00:01:34,560 --> 00:01:39,030
<font color="#E5E5E5">and some of the things that other</font><font color="#CCCCCC"> people</font>

47
00:01:36,540 --> 00:01:40,380
may have<font color="#CCCCCC"> thought of already and then at</font>

48
00:01:39,030 --> 00:01:42,060
the end we'll<font color="#CCCCCC"> talk about defenses that</font>

49
00:01:40,380 --> 00:01:44,850
<font color="#CCCCCC">you may be able to implement to find</font>

50
00:01:42,060 --> 00:01:46,229
some<font color="#E5E5E5"> of this stuff so a important</font>

51
00:01:44,850 --> 00:01:47,939
disclaimer we're not dropping<font color="#CCCCCC"> O'Dea</font>

52
00:01:46,229 --> 00:01:51,869
we're not talking about<font color="#E5E5E5"> anything worthy</font>

53
00:01:47,939 --> 00:01:54,600
<font color="#E5E5E5">of</font><font color="#CCCCCC"> a CBE this is a way to abuse</font><font color="#E5E5E5"> the</font>

54
00:01:51,869 --> 00:01:57,390
<font color="#E5E5E5">windows security model</font><font color="#CCCCCC"> in a way that we</font>

55
00:01:54,600 --> 00:02:00,600
think<font color="#CCCCCC"> is pretty interesting secondly and</font>

56
00:01:57,390 --> 00:02:02,670
maybe more importantly is while<font color="#CCCCCC"> it's</font>

57
00:02:00,600 --> 00:02:04,079
while aces and<font color="#CCCCCC"> Akal can be used</font><font color="#E5E5E5"> for</font>

58
00:02:02,670 --> 00:02:07,530
elevating rights<font color="#E5E5E5"> what we're talking</font>

59
00:02:04,079 --> 00:02:09,750
about is post escalation and borrowing

60
00:02:07,530 --> 00:02:11,970
yourself into an Active Directory domain

61
00:02:09,750 --> 00:02:13,650
once you have become domain admin and

62
00:02:11,970 --> 00:02:16,320
how you can

63
00:02:13,650 --> 00:02:21,030
implement malicious aces to have

64
00:02:16,320 --> 00:02:24,720
<font color="#CCCCCC">long-term code execution lists</font>

65
00:02:21,030 --> 00:02:26,690
persistence in an environment cool<font color="#CCCCCC"> so</font>

66
00:02:24,720 --> 00:02:29,640
why should you<font color="#E5E5E5"> care</font><font color="#CCCCCC"> about this so</font>

67
00:02:26,690 --> 00:02:31,530
<font color="#CCCCCC">there's a few really cool</font><font color="#E5E5E5"> things that go</font>

68
00:02:29,640 --> 00:02:33,570
along<font color="#CCCCCC"> with this type of persistence</font>

69
00:02:31,530 --> 00:02:35,730
methodology in<font color="#E5E5E5"> this type of approach so</font>

70
00:02:33,570 --> 00:02:37,980
one it's often very<font color="#E5E5E5"> difficult</font><font color="#CCCCCC"> to</font>

71
00:02:35,730 --> 00:02:40,619
<font color="#E5E5E5">determine that if you find an ace that</font>

72
00:02:37,980 --> 00:02:43,709
<font color="#CCCCCC">can provide elevated access or you know</font>

73
00:02:40,620 --> 00:02:45,440
<font color="#CCCCCC">a you know additional</font><font color="#E5E5E5"> access into the</font>

74
00:02:43,709 --> 00:02:47,970
future if you find these malicious aces

75
00:02:45,440 --> 00:02:49,350
it can be difficult<font color="#CCCCCC"> to actually</font><font color="#E5E5E5"> tell are</font>

76
00:02:47,970 --> 00:02:51,030
they actually malicious<font color="#E5E5E5"> or were they</font>

77
00:02:49,350 --> 00:02:53,130
implemented by accident<font color="#E5E5E5"> either through</font>

78
00:02:51,030 --> 00:02:54,020
some<font color="#E5E5E5"> third-party installation or you</font>

79
00:02:53,130 --> 00:02:56,940
know who knows

80
00:02:54,020 --> 00:02:58,500
also these types of backdoors have a

81
00:02:56,940 --> 00:03:00,390
minimal forensic footprint<font color="#E5E5E5"> it's</font>

82
00:02:58,500 --> 00:03:02,070
<font color="#E5E5E5">difficult to even find them and we're</font>

83
00:03:00,390 --> 00:03:04,109
going<font color="#CCCCCC"> to make</font><font color="#E5E5E5"> it</font><font color="#CCCCCC"> even harder</font><font color="#E5E5E5"> to actually</font>

84
00:03:02,070 --> 00:03:05,760
<font color="#E5E5E5">find them later in the deck they</font><font color="#CCCCCC"> often</font>

85
00:03:04,110 --> 00:03:07,950
<font color="#E5E5E5">survive operating system and domain</font>

86
00:03:05,760 --> 00:03:09,390
functional level upgrades<font color="#E5E5E5"> and they're</font>

87
00:03:07,950 --> 00:03:11,359
very<font color="#E5E5E5"> subtle</font><font color="#CCCCCC"> so this gives you an</font>

88
00:03:09,390 --> 00:03:14,820
excellent chance<font color="#CCCCCC"> for long long-term</font>

89
00:03:11,360 --> 00:03:16,320
<font color="#E5E5E5">multi-year subtle domain persistence and</font>

90
00:03:14,820 --> 00:03:19,200
<font color="#E5E5E5">a big point here</font><font color="#CCCCCC"> is these</font><font color="#E5E5E5"> may have been</font>

91
00:03:16,320 --> 00:03:20,730
<font color="#E5E5E5">in your environment for years which kind</font>

92
00:03:19,200 --> 00:03:23,100
of terrifies me once we started<font color="#CCCCCC"> thinking</font>

93
00:03:20,730 --> 00:03:25,709
<font color="#E5E5E5">about it because and I</font><font color="#CCCCCC"> love this quote</font>

94
00:03:23,100 --> 00:03:27,959
<font color="#E5E5E5">Mac raver used to be my boss about</font><font color="#CCCCCC"> a</font>

95
00:03:25,709 --> 00:03:30,269
year<font color="#E5E5E5"> or so ago he</font><font color="#CCCCCC"> spoke two years ago at</font>

96
00:03:27,959 --> 00:03:32,310
blackhat on W mine<font color="#CCCCCC"> and he had this</font><font color="#E5E5E5"> great</font>

97
00:03:30,269 --> 00:03:33,980
quote saying as an offensive researcher

98
00:03:32,310 --> 00:03:36,420
if you can dream<font color="#E5E5E5"> it</font>

99
00:03:33,980 --> 00:03:38,579
someone has likely already<font color="#E5E5E5"> done it</font><font color="#CCCCCC"> and</font>

100
00:03:36,420 --> 00:03:40,230
<font color="#CCCCCC">that someone</font><font color="#E5E5E5"> isn't the kind of person</font>

101
00:03:38,580 --> 00:03:42,390
<font color="#CCCCCC">that comes and speaks</font><font color="#E5E5E5"> at security</font>

102
00:03:40,230 --> 00:03:44,340
conferences<font color="#E5E5E5"> so please keep this in mind</font>

103
00:03:42,390 --> 00:03:45,690
<font color="#E5E5E5">once we actually get</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> the case studies</font>

104
00:03:44,340 --> 00:03:46,920
<font color="#CCCCCC">we're going</font><font color="#E5E5E5"> through this</font><font color="#CCCCCC"> background</font><font color="#E5E5E5"> and</font>

105
00:03:45,690 --> 00:03:48,959
<font color="#E5E5E5">everything so you have the understanding</font>

106
00:03:46,920 --> 00:03:50,339
<font color="#E5E5E5">and then hopefully</font><font color="#CCCCCC"> we</font><font color="#E5E5E5"> will bring it all</font>

107
00:03:48,959 --> 00:03:52,049
together and<font color="#CCCCCC"> show</font><font color="#E5E5E5"> you the really really</font>

108
00:03:50,340 --> 00:03:54,930
<font color="#E5E5E5">cool things you can</font><font color="#CCCCCC"> do creatively</font><font color="#E5E5E5"> with</font>

109
00:03:52,049 --> 00:03:56,700
this type of stuff<font color="#CCCCCC"> okay so let's do some</font>

110
00:03:54,930 --> 00:03:58,079
<font color="#CCCCCC">background information and first of all</font>

111
00:03:56,700 --> 00:04:00,060
<font color="#E5E5E5">we need to acknowledge some previous</font>

112
00:03:58,079 --> 00:04:02,220
work<font color="#CCCCCC"> that came before us</font><font color="#E5E5E5"> most</font>

113
00:04:00,060 --> 00:04:04,170
importantly is this<font color="#CCCCCC"> project from</font><font color="#E5E5E5"> ANSI</font>

114
00:04:02,220 --> 00:04:06,810
which is the<font color="#E5E5E5"> French equivalent of the</font>

115
00:04:04,170 --> 00:04:09,119
NSA they<font color="#E5E5E5"> have this project</font><font color="#CCCCCC"> called</font><font color="#E5E5E5"> active</font>

116
00:04:06,810 --> 00:04:11,430
<font color="#E5E5E5">directory control paths they did the</font>

117
00:04:09,120 --> 00:04:14,310
white paper regarding<font color="#CCCCCC"> how aces can be</font>

118
00:04:11,430 --> 00:04:18,030
abused<font color="#E5E5E5"> and they also used graph theory</font>

119
00:04:14,310 --> 00:04:19,918
to map out the connections<font color="#CCCCCC"> that</font><font color="#E5E5E5"> can go</font>

120
00:04:18,029 --> 00:04:21,839
from<font color="#E5E5E5"> any</font><font color="#CCCCCC"> arbitrary place in the domain</font>

121
00:04:19,918 --> 00:04:23,430
<font color="#CCCCCC">to another so they also served as</font>

122
00:04:21,839 --> 00:04:25,289
initial inspiration<font color="#CCCCCC"> for us when we were</font>

123
00:04:23,430 --> 00:04:28,140
<font color="#E5E5E5">developing bloodhound</font>

124
00:04:25,290 --> 00:04:29,520
about a year<font color="#CCCCCC"> and a half ago Luca boyo</font>

125
00:04:28,140 --> 00:04:30,719
and<font color="#CCCCCC"> a</font><font color="#E5E5E5"> manual</font><font color="#CCCCCC"> Gras</font><font color="#E5E5E5"> we want to make sure</font>

126
00:04:29,520 --> 00:04:32,640
<font color="#E5E5E5">that we mentioned their names they're</font>

127
00:04:30,720 --> 00:04:35,880
the ones who develop the Active

128
00:04:32,640 --> 00:04:37,979
<font color="#E5E5E5">Directory control pads project</font><font color="#CCCCCC"> secondly</font>

129
00:04:35,880 --> 00:04:39,450
the ad<font color="#CCCCCC"> Akal scanner we should</font>

130
00:04:37,980 --> 00:04:42,330
acknowledge this work as<font color="#E5E5E5"> well this</font><font color="#CCCCCC"> is a</font>

131
00:04:39,450 --> 00:04:44,729
GUI interface<font color="#E5E5E5"> based on</font><font color="#CCCCCC"> powershell script</font>

132
00:04:42,330 --> 00:04:47,099
that you can<font color="#CCCCCC"> use for scanning Ackles in</font>

133
00:04:44,730 --> 00:04:49,620
Active Directory<font color="#CCCCCC"> it does things like</font><font color="#E5E5E5"> CSV</font>

134
00:04:47,100 --> 00:04:51,720
export<font color="#E5E5E5"> CSE</font><font color="#CCCCCC"> diffing some cool things like</font>

135
00:04:49,620 --> 00:04:52,950
that<font color="#E5E5E5"> we also have a really great blog</font>

136
00:04:51,720 --> 00:04:54,450
<font color="#CCCCCC">post there and</font><font color="#E5E5E5"> again these</font><font color="#CCCCCC"> slides will</font>

137
00:04:52,950 --> 00:04:56,099
be public<font color="#E5E5E5"> but</font><font color="#CCCCCC"> they go into some details</font>

138
00:04:54,450 --> 00:04:57,960
a lot<font color="#E5E5E5"> of</font><font color="#CCCCCC"> the control relationships that</font>

139
00:04:56,100 --> 00:04:59,550
we cover as well<font color="#E5E5E5"> that's all that's a</font>

140
00:04:57,960 --> 00:05:02,729
project<font color="#CCCCCC"> that's</font><font color="#E5E5E5"> a developed by</font><font color="#CCCCCC"> robin</font>

141
00:04:59,550 --> 00:05:04,860
Granberg at<font color="#E5E5E5"> Microsoft next when we</font>

142
00:05:02,730 --> 00:05:06,540
<font color="#E5E5E5">started doing the initial</font><font color="#CCCCCC"> research for</font>

143
00:05:04,860 --> 00:05:09,450
like can we<font color="#E5E5E5"> find an example where</font>

144
00:05:06,540 --> 00:05:11,340
<font color="#E5E5E5">somebody has used</font><font color="#CCCCCC"> ACLs for putting a</font>

145
00:05:09,450 --> 00:05:13,740
backdoor<font color="#E5E5E5"> into Active Directory already</font>

146
00:05:11,340 --> 00:05:14,789
we came<font color="#CCCCCC"> up pretty</font><font color="#E5E5E5"> empty-handed we</font>

147
00:05:13,740 --> 00:05:17,160
couldn't find a whole<font color="#CCCCCC"> lot of examples</font>

148
00:05:14,790 --> 00:05:19,800
<font color="#E5E5E5">this was the closest thing that we could</font>

149
00:05:17,160 --> 00:05:24,330
find it's a<font color="#E5E5E5"> Russian blog post from 2010</font>

150
00:05:19,800 --> 00:05:26,370
<font color="#CCCCCC">about how to use aces to obscure the</font>

151
00:05:24,330 --> 00:05:28,890
existence of objects<font color="#E5E5E5"> so it served as an</font>

152
00:05:26,370 --> 00:05:30,720
inspiration<font color="#CCCCCC"> for our talk</font><font color="#E5E5E5"> but we think</font>

153
00:05:28,890 --> 00:05:34,349
we've built on what this<font color="#E5E5E5"> blog post went</font>

154
00:05:30,720 --> 00:05:36,060
into pretty well and when<font color="#E5E5E5"> you're looking</font>

155
00:05:34,350 --> 00:05:39,330
at different<font color="#CCCCCC"> ways to attack an</font>

156
00:05:36,060 --> 00:05:40,530
environment if the<font color="#E5E5E5"> only existing writing</font>

157
00:05:39,330 --> 00:05:44,690
you can<font color="#E5E5E5"> find is in Russian you're</font>

158
00:05:40,530 --> 00:05:46,590
probably on the<font color="#E5E5E5"> right track yeah so</font>

159
00:05:44,690 --> 00:05:48,060
<font color="#CCCCCC">we'll you know a little</font><font color="#E5E5E5"> bit this</font>

160
00:05:46,590 --> 00:05:49,700
<font color="#CCCCCC">background what we mean by securable</font>

161
00:05:48,060 --> 00:05:51,510
objects and<font color="#CCCCCC"> decals and</font><font color="#E5E5E5"> all that so</font>

162
00:05:49,700 --> 00:05:53,010
securable objects in a Windows

163
00:05:51,510 --> 00:05:55,710
environment and<font color="#CCCCCC"> Active Directory or on</font>

164
00:05:53,010 --> 00:05:57,450
the host<font color="#E5E5E5"> are defined by objects that</font>

165
00:05:55,710 --> 00:05:59,729
have a security descriptor<font color="#E5E5E5"> this is a</font>

166
00:05:57,450 --> 00:06:01,409
binary structure<font color="#E5E5E5"> the stored it has</font>

167
00:05:59,730 --> 00:06:02,460
several different<font color="#E5E5E5"> pieces</font><font color="#CCCCCC"> so it has you</font>

168
00:06:01,410 --> 00:06:04,140
<font color="#CCCCCC">know</font><font color="#E5E5E5"> the primary group the owner</font>

169
00:06:02,460 --> 00:06:06,419
<font color="#E5E5E5">shackles and decals we'll go over the</font>

170
00:06:04,140 --> 00:06:08,280
all the<font color="#E5E5E5"> terms here in a second this can</font>

171
00:06:06,420 --> 00:06:10,170
also be described as a<font color="#E5E5E5"> security</font>

172
00:06:08,280 --> 00:06:11,760
descriptor definition language strings

173
00:06:10,170 --> 00:06:14,010
<font color="#CCCCCC">ons DDL string but we're not really</font>

174
00:06:11,760 --> 00:06:15,480
<font color="#CCCCCC">going</font><font color="#E5E5E5"> to cover that so the thing we</font><font color="#CCCCCC"> care</font>

175
00:06:14,010 --> 00:06:18,120
<font color="#CCCCCC">about here mostly</font><font color="#E5E5E5"> is the deckle what</font>

176
00:06:15,480 --> 00:06:20,010
we'll be covering<font color="#E5E5E5"> so we a lot</font><font color="#CCCCCC"> of people</font>

177
00:06:18,120 --> 00:06:22,320
<font color="#CCCCCC">use these</font><font color="#E5E5E5"> terms interchangeably we use</font>

178
00:06:20,010 --> 00:06:24,120
kind<font color="#E5E5E5"> of Apple and</font><font color="#CCCCCC"> deco interchangeably</font>

179
00:06:22,320 --> 00:06:26,159
but the access control list is<font color="#E5E5E5"> actually</font>

180
00:06:24,120 --> 00:06:28,290
the superset of the<font color="#CCCCCC"> Sakhalin the deckle</font>

181
00:06:26,160 --> 00:06:30,150
so<font color="#CCCCCC"> dackel</font><font color="#E5E5E5"> being the discretionary access</font>

182
00:06:28,290 --> 00:06:32,220
control list and<font color="#CCCCCC"> the</font><font color="#E5E5E5"> SAC will be in the</font>

183
00:06:30,150 --> 00:06:34,200
<font color="#CCCCCC">system access control</font><font color="#E5E5E5"> list these are</font>

184
00:06:32,220 --> 00:06:37,050
it's a pointer to<font color="#E5E5E5"> an ordered</font><font color="#CCCCCC"> collection</font>

185
00:06:34,200 --> 00:06:38,560
of access<font color="#E5E5E5"> control entries or aces that</font>

186
00:06:37,050 --> 00:06:40,870
<font color="#E5E5E5">are stored</font><font color="#CCCCCC"> for</font><font color="#E5E5E5"> the object</font>

187
00:06:38,560 --> 00:06:43,600
<font color="#CCCCCC">deckle is what</font><font color="#E5E5E5"> actually defines who has</font>

188
00:06:40,870 --> 00:06:45,430
what<font color="#E5E5E5"> rights what principles who has what</font>

189
00:06:43,600 --> 00:06:47,440
rights over a<font color="#E5E5E5"> particular object so it's</font>

190
00:06:45,430 --> 00:06:49,419
<font color="#CCCCCC">just the access control</font><font color="#E5E5E5"> model the</font><font color="#CCCCCC"> Sako</font>

191
00:06:47,440 --> 00:06:51,040
allows for auditing of success and

192
00:06:49,419 --> 00:06:52,570
failure auditing on accesses to

193
00:06:51,040 --> 00:06:53,830
<font color="#E5E5E5">different components</font><font color="#CCCCCC"> of the object</font><font color="#E5E5E5"> but</font>

194
00:06:52,570 --> 00:06:58,469
we're not really<font color="#CCCCCC"> going</font><font color="#E5E5E5"> to cover that in</font>

195
00:06:53,830 --> 00:07:00,969
<font color="#E5E5E5">this</font><font color="#CCCCCC"> presentation so aces include a</font>

196
00:06:58,470 --> 00:07:03,160
series of flags the control auditing<font color="#E5E5E5"> a</font>

197
00:07:00,970 --> 00:07:06,070
little bit of inheritance<font color="#E5E5E5"> and they have</font>

198
00:07:03,160 --> 00:07:07,810
the<font color="#CCCCCC"> principal</font><font color="#E5E5E5"> so the SID of the user</font>

199
00:07:06,070 --> 00:07:09,730
that<font color="#CCCCCC"> has</font><font color="#E5E5E5"> the right we care</font><font color="#CCCCCC"> about that</font>

200
00:07:07,810 --> 00:07:12,910
very<font color="#E5E5E5"> much and we'll get into a why and</font>

201
00:07:09,730 --> 00:07:13,810
it also has a<font color="#E5E5E5"> 32 bit access mask and you</font>

202
00:07:12,910 --> 00:07:15,370
know we're not going<font color="#CCCCCC"> to go and dive</font>

203
00:07:13,810 --> 00:07:17,290
super deep in the access mask<font color="#CCCCCC"> we</font>

204
00:07:15,370 --> 00:07:18,760
<font color="#E5E5E5">actually have a 64 page white paper</font>

205
00:07:17,290 --> 00:07:20,110
they'll be published by<font color="#E5E5E5"> black</font><font color="#CCCCCC"> hat</font><font color="#E5E5E5"> that</font>

206
00:07:18,760 --> 00:07:22,060
goes<font color="#CCCCCC"> into all this stuff and way way</font>

207
00:07:20,110 --> 00:07:24,340
more<font color="#E5E5E5"> debt than</font><font color="#CCCCCC"> we have time for</font><font color="#E5E5E5"> but the</font>

208
00:07:22,060 --> 00:07:26,590
access mask actually controls<font color="#CCCCCC"> you know</font>

209
00:07:24,340 --> 00:07:28,780
who has you know<font color="#E5E5E5"> what are the rights</font>

210
00:07:26,590 --> 00:07:30,159
that<font color="#E5E5E5"> this person has it can be very very</font>

211
00:07:28,780 --> 00:07:31,690
granular and will gain<font color="#CCCCCC"> the extended</font>

212
00:07:30,160 --> 00:07:33,370
stuff here in a second<font color="#E5E5E5"> but you know</font><font color="#CCCCCC"> an a</font>

213
00:07:31,690 --> 00:07:34,060
duck<font color="#E5E5E5"> active directory using computers is</font>

214
00:07:33,370 --> 00:07:35,800
what it looks like

215
00:07:34,060 --> 00:07:37,720
so the<font color="#E5E5E5"> harms or user the principle that</font>

216
00:07:35,800 --> 00:07:39,940
be stored in the<font color="#E5E5E5"> SID the the object</font>

217
00:07:37,720 --> 00:07:41,290
<font color="#CCCCCC">itself is victim</font><font color="#E5E5E5"> and the rights here is</font>

218
00:07:39,940 --> 00:07:45,310
they have<font color="#E5E5E5"> modified permissions and</font>

219
00:07:41,290 --> 00:07:46,720
<font color="#E5E5E5">modify owner</font><font color="#CCCCCC"> there's</font><font color="#E5E5E5"> one bit in the</font>

220
00:07:45,310 --> 00:07:49,419
access mask we definitely care<font color="#CCCCCC"> about</font>

221
00:07:46,720 --> 00:07:51,700
<font color="#CCCCCC">it's a</font><font color="#E5E5E5"> DES control</font><font color="#CCCCCC"> access it is a bit</font>

222
00:07:49,419 --> 00:07:53,919
that grants privileges and<font color="#E5E5E5"> the access</font>

223
00:07:51,700 --> 00:07:57,190
mask<font color="#E5E5E5"> or</font><font color="#CCCCCC"> it's a bit in the access mask</font>

224
00:07:53,919 --> 00:07:58,840
that is used<font color="#E5E5E5"> to demonstrate privileges</font>

225
00:07:57,190 --> 00:08:00,460
that<font color="#CCCCCC"> aren't easily expressed already in</font>

226
00:07:58,840 --> 00:08:01,989
the access mask so it's a way<font color="#E5E5E5"> to extend</font>

227
00:08:00,460 --> 00:08:03,609
how you can actually<font color="#E5E5E5"> define this stuff</font>

228
00:08:01,990 --> 00:08:05,710
so it's interpret this<font color="#E5E5E5"> bit is</font>

229
00:08:03,610 --> 00:08:07,870
interpreted two different ways if the

230
00:08:05,710 --> 00:08:11,200
object<font color="#CCCCCC"> ace type which is a good</font><font color="#E5E5E5"> if the</font>

231
00:08:07,870 --> 00:08:13,030
target of the<font color="#CCCCCC"> ace</font><font color="#E5E5E5"> is the confidential</font>

232
00:08:11,200 --> 00:08:14,469
property name so if<font color="#E5E5E5"> it late if it's</font>

233
00:08:13,030 --> 00:08:16,599
mapped back to a property<font color="#E5E5E5"> that's marked</font>

234
00:08:14,470 --> 00:08:18,669
as<font color="#CCCCCC"> confidential for example laps then</font>

235
00:08:16,600 --> 00:08:20,919
flipping the<font color="#CCCCCC"> DES control access</font><font color="#E5E5E5"> pit well</font>

236
00:08:18,669 --> 00:08:23,409
grant read access<font color="#E5E5E5"> to</font><font color="#CCCCCC"> the sensitive</font>

237
00:08:20,919 --> 00:08:26,380
property<font color="#CCCCCC"> alright so hopefully</font><font color="#E5E5E5"> make sense</font>

238
00:08:23,410 --> 00:08:28,660
right<font color="#E5E5E5"> no too crazy the second way is</font>

239
00:08:26,380 --> 00:08:32,140
<font color="#E5E5E5">that the</font><font color="#CCCCCC"> object</font><font color="#E5E5E5"> ace type is a gooood</font>

240
00:08:28,660 --> 00:08:34,900
<font color="#E5E5E5">that's mapped to an existing extended</font>

241
00:08:32,140 --> 00:08:36,909
<font color="#E5E5E5">right in the forest schema than a</font>

242
00:08:34,900 --> 00:08:38,919
specific<font color="#E5E5E5"> granular right in</font><font color="#CCCCCC"> Active</font>

243
00:08:36,909 --> 00:08:41,529
<font color="#CCCCCC">Directory this is specific just</font><font color="#E5E5E5"> active</font>

244
00:08:38,919 --> 00:08:43,900
<font color="#E5E5E5">directory then a specific extended right</font>

245
00:08:41,529 --> 00:08:45,459
is granted for example I don't<font color="#E5E5E5"> want</font>

246
00:08:43,900 --> 00:08:47,350
complete control<font color="#CCCCCC"> the object but I want</font>

247
00:08:45,459 --> 00:08:48,520
the ability<font color="#CCCCCC"> for</font><font color="#E5E5E5"> helpdesk to force reset</font>

248
00:08:47,350 --> 00:08:50,709
the password<font color="#E5E5E5"> but I don't want to give</font>

249
00:08:48,520 --> 00:08:52,390
them any other<font color="#E5E5E5"> rights right so that's</font>

250
00:08:50,709 --> 00:08:54,430
<font color="#CCCCCC">not easily</font><font color="#E5E5E5"> expressed in the</font><font color="#CCCCCC"> exist</font>

251
00:08:52,390 --> 00:08:56,620
access<font color="#CCCCCC"> math structure so</font><font color="#E5E5E5"> they flip the</font>

252
00:08:54,430 --> 00:08:58,120
control<font color="#CCCCCC"> access fit that</font><font color="#E5E5E5"> target gooood is</font>

253
00:08:56,620 --> 00:09:01,090
going to map in the Active Directory

254
00:08:58,120 --> 00:09:03,820
schema<font color="#E5E5E5"> to you know user</font><font color="#CCCCCC"> force change</font>

255
00:09:01,090 --> 00:09:05,050
<font color="#CCCCCC">password</font><font color="#E5E5E5"> also</font><font color="#CCCCCC"> say DC sync rights like</font>

256
00:09:03,820 --> 00:09:10,540
replication rights which we'll get into

257
00:09:05,050 --> 00:09:12,400
<font color="#CCCCCC">in some of the demonstrations</font><font color="#E5E5E5"> okay so we</font>

258
00:09:10,540 --> 00:09:14,230
have<font color="#E5E5E5"> with</font><font color="#CCCCCC"> tackle we have the Aces the</font>

259
00:09:12,400 --> 00:09:15,730
the<font color="#CCCCCC"> deckle is a collection of aces that</font>

260
00:09:14,230 --> 00:09:18,040
are listed in<font color="#E5E5E5"> what is called canonical</font>

261
00:09:15,730 --> 00:09:21,190
<font color="#E5E5E5">order so if you've</font><font color="#CCCCCC"> ever looked at like a</font>

262
00:09:18,040 --> 00:09:23,110
firewall<font color="#CCCCCC"> Akal you know that the firewall</font>

263
00:09:21,190 --> 00:09:26,200
reads the<font color="#CCCCCC"> Akal</font><font color="#E5E5E5"> from the top down and</font>

264
00:09:23,110 --> 00:09:27,730
<font color="#E5E5E5">from</font><font color="#CCCCCC"> top down</font><font color="#E5E5E5"> whatever rule is a plot is</font>

265
00:09:26,200 --> 00:09:30,130
relevant to the access<font color="#CCCCCC"> that</font><font color="#E5E5E5"> is being</font>

266
00:09:27,730 --> 00:09:32,260
requested is the rule that<font color="#CCCCCC"> hit in Active</font>

267
00:09:30,130 --> 00:09:36,250
Directory it's very similar<font color="#E5E5E5"> however</font>

268
00:09:32,260 --> 00:09:39,550
there is also inheritance<font color="#E5E5E5"> and overriding</font>

269
00:09:36,250 --> 00:09:42,100
<font color="#E5E5E5">permissions that you</font><font color="#CCCCCC"> have to</font><font color="#E5E5E5"> consider so</font>

270
00:09:39,550 --> 00:09:44,500
in the<font color="#E5E5E5"> in a Windows</font><font color="#CCCCCC"> security model the</font>

271
00:09:42,100 --> 00:09:46,930
kernel<font color="#CCCCCC"> mode</font><font color="#E5E5E5"> security reference monitor</font>

272
00:09:44,500 --> 00:09:48,670
<font color="#E5E5E5">is a part of the operating system</font><font color="#CCCCCC"> that</font>

273
00:09:46,930 --> 00:09:50,890
actually<font color="#E5E5E5"> evaluates the</font><font color="#CCCCCC"> dackel in</font>

274
00:09:48,670 --> 00:09:53,050
canonical<font color="#E5E5E5"> order and it makes the access</font>

275
00:09:50,890 --> 00:09:55,930
<font color="#CCCCCC">this decision of whether access</font><font color="#E5E5E5"> will</font><font color="#CCCCCC"> be</font>

276
00:09:53,050 --> 00:09:57,670
granted<font color="#E5E5E5"> or denied this becomes important</font>

277
00:09:55,930 --> 00:09:59,859
<font color="#CCCCCC">when we're talking about</font><font color="#E5E5E5"> adding our own</font>

278
00:09:57,670 --> 00:10:01,959
malicious aces<font color="#E5E5E5"> because we can take</font>

279
00:09:59,860 --> 00:10:04,840
<font color="#CCCCCC">advantage of the order of inheritance</font>

280
00:10:01,960 --> 00:10:07,180
<font color="#E5E5E5">and the order of evaluation that the SRM</font>

281
00:10:04,840 --> 00:10:09,310
uses and we can abuse that in a way that

282
00:10:07,180 --> 00:10:11,109
<font color="#CCCCCC">lets us do very very sneaky things we'll</font>

283
00:10:09,310 --> 00:10:12,280
<font color="#CCCCCC">talk about in a second</font><font color="#E5E5E5"> so let's talk</font>

284
00:10:11,110 --> 00:10:15,850
about<font color="#CCCCCC"> let's take</font><font color="#E5E5E5"> a look at this example</font>

285
00:10:12,280 --> 00:10:17,620
we<font color="#CCCCCC"> have this o u here called I</font><font color="#E5E5E5"> T under</font>

286
00:10:15,850 --> 00:10:19,450
<font color="#CCCCCC">there's a no you called help desk and</font>

287
00:10:17,620 --> 00:10:22,270
<font color="#E5E5E5">under there is a user called Robbie</font>

288
00:10:19,450 --> 00:10:26,710
Winchester<font color="#E5E5E5"> I'm going to put a deny</font><font color="#CCCCCC"> at</font>

289
00:10:22,270 --> 00:10:28,780
explicit deny<font color="#E5E5E5"> on this</font><font color="#CCCCCC"> I tou and explicit</font>

290
00:10:26,710 --> 00:10:31,570
deny for<font color="#E5E5E5"> full control say for example</font>

291
00:10:28,780 --> 00:10:33,579
that's<font color="#CCCCCC"> going to inherit down to the</font><font color="#E5E5E5"> O</font>

292
00:10:31,570 --> 00:10:34,980
you<font color="#E5E5E5"> under there and on the oh you there</font>

293
00:10:33,580 --> 00:10:37,810
it's going<font color="#CCCCCC"> to</font><font color="#E5E5E5"> be</font><font color="#CCCCCC"> reflected as a</font>

294
00:10:34,980 --> 00:10:39,370
inherited denied it's also going<font color="#E5E5E5"> to</font>

295
00:10:37,810 --> 00:10:40,780
inherit down to the user and it's also

296
00:10:39,370 --> 00:10:44,170
going to<font color="#E5E5E5"> show up there as an inherited</font>

297
00:10:40,780 --> 00:10:46,689
deny what if I in the intermediary<font color="#E5E5E5"> oh</font>

298
00:10:44,170 --> 00:10:48,150
you on<font color="#CCCCCC"> helpdesk if I said well wait a</font>

299
00:10:46,690 --> 00:10:50,860
minute I want<font color="#CCCCCC"> to have an explicit allow</font>

300
00:10:48,150 --> 00:10:54,730
<font color="#E5E5E5">that explicit allow is going to override</font>

301
00:10:50,860 --> 00:10:58,020
<font color="#E5E5E5">the inherited deny because</font><font color="#CCCCCC"> it explicitly</font>

302
00:10:54,730 --> 00:11:00,610
<font color="#CCCCCC">defined aces override inherited aces</font>

303
00:10:58,020 --> 00:11:03,490
there's one final complication with this

304
00:11:00,610 --> 00:11:05,540
so that explicit allow is also going to

305
00:11:03,490 --> 00:11:09,199
be<font color="#E5E5E5"> inherited down to the Robbie</font>

306
00:11:05,540 --> 00:11:11,660
<font color="#E5E5E5">Chester user now because the oh you</font>

307
00:11:09,199 --> 00:11:14,060
called help desk is generationally

308
00:11:11,660 --> 00:11:17,600
closer to the<font color="#CCCCCC"> robbing user than the oh</font>

309
00:11:14,060 --> 00:11:19,758
you called<font color="#E5E5E5"> IT the a</font><font color="#CCCCCC"> Siddhant inherits</font>

310
00:11:17,600 --> 00:11:22,670
from<font color="#E5E5E5"> it's closer oh you parent is the</font>

311
00:11:19,759 --> 00:11:26,420
<font color="#E5E5E5">one that is canonically higher in the</font>

312
00:11:22,670 --> 00:11:29,389
dackel finally if we if we define

313
00:11:26,420 --> 00:11:32,180
explicit<font color="#E5E5E5"> aces those also override</font>

314
00:11:29,389 --> 00:11:34,490
inherited aces so what you wind up with

315
00:11:32,180 --> 00:11:36,380
<font color="#CCCCCC">is on the ravi winchester user at the</font>

316
00:11:34,490 --> 00:11:38,360
very top we have explicit denies<font color="#CCCCCC"> that</font>

317
00:11:36,380 --> 00:11:40,220
will override anything<font color="#E5E5E5"> else with the</font>

318
00:11:38,360 --> 00:11:43,130
exception of the object<font color="#E5E5E5"> owner which</font>

319
00:11:40,220 --> 00:11:45,889
maintains full control then the explicit

320
00:11:43,130 --> 00:11:49,329
<font color="#E5E5E5">that's allow then the inherited allow</font>

321
00:11:45,889 --> 00:11:53,360
and<font color="#E5E5E5"> then finally the inherited deny</font>

322
00:11:49,329 --> 00:11:54,469
we're going to abuse<font color="#E5E5E5"> this in further in</font>

323
00:11:53,360 --> 00:11:56,620
a talk<font color="#CCCCCC"> I'm</font><font color="#E5E5E5"> going to show you how to do</font>

324
00:11:54,470 --> 00:11:58,610
that so<font color="#E5E5E5"> let's take a look at some basic</font>

325
00:11:56,620 --> 00:12:01,250
<font color="#CCCCCC">misconfigurations and how we</font><font color="#E5E5E5"> abused</font>

326
00:11:58,610 --> 00:12:03,560
these<font color="#E5E5E5"> before we took before we take a</font>

327
00:12:01,250 --> 00:12:07,339
you know<font color="#E5E5E5"> in-depth look at that one thing</font>

328
00:12:03,560 --> 00:12:09,920
<font color="#CCCCCC">too to repeat</font><font color="#E5E5E5"> is</font><font color="#CCCCCC"> that we are focusing</font>

329
00:12:07,339 --> 00:12:12,440
this talk on persistence not escalation

330
00:12:09,920 --> 00:12:14,120
so<font color="#CCCCCC"> everything that</font><font color="#E5E5E5"> we're talking about</font>

331
00:12:12,440 --> 00:12:17,180
requires some<font color="#E5E5E5"> kind of privilege to</font>

332
00:12:14,120 --> 00:12:18,649
implement these malicious cases<font color="#CCCCCC"> domain</font>

333
00:12:17,180 --> 00:12:20,899
<font color="#CCCCCC">Abin is the easiest one because</font><font color="#E5E5E5"> domain</font>

334
00:12:18,649 --> 00:12:22,069
<font color="#CCCCCC">Evan's control everything or you</font><font color="#E5E5E5"> have</font>

335
00:12:20,899 --> 00:12:24,139
<font color="#E5E5E5">control over the object that</font><font color="#CCCCCC"> you're</font>

336
00:12:22,069 --> 00:12:26,120
<font color="#E5E5E5">backdooring and in general we want to</font>

337
00:12:24,139 --> 00:12:27,949
chain<font color="#CCCCCC"> a SACEUR build these in that</font><font color="#E5E5E5"> you</font>

338
00:12:26,120 --> 00:12:29,930
can go<font color="#E5E5E5"> from lower less privileged</font>

339
00:12:27,949 --> 00:12:31,490
objects or<font color="#CCCCCC"> principals to higher</font>

340
00:12:29,930 --> 00:12:33,229
<font color="#CCCCCC">privilege one so we're going to go</font><font color="#E5E5E5"> from</font>

341
00:12:31,490 --> 00:12:35,690
a domain authenticated user up to domain

342
00:12:33,230 --> 00:12:38,180
admins or<font color="#E5E5E5"> specific user that's not any</font>

343
00:12:35,690 --> 00:12:41,060
<font color="#E5E5E5">privileged groups allowing them elevated</font>

344
00:12:38,180 --> 00:12:42,170
access to take back<font color="#E5E5E5"> over so</font><font color="#CCCCCC"> Active</font>

345
00:12:41,060 --> 00:12:44,630
<font color="#CCCCCC">Directory</font><font color="#E5E5E5"> obviously we have different</font>

346
00:12:42,170 --> 00:12:47,569
<font color="#CCCCCC">kinds of object classes one of those are</font>

347
00:12:44,630 --> 00:12:49,430
users so<font color="#CCCCCC"> if</font><font color="#E5E5E5"> we have an ace against a</font>

348
00:12:47,569 --> 00:12:51,560
user<font color="#CCCCCC"> that allows us to</font><font color="#E5E5E5"> take over</font><font color="#CCCCCC"> that</font>

349
00:12:49,430 --> 00:12:54,229
user there are basically two<font color="#CCCCCC"> options</font>

350
00:12:51,560 --> 00:12:56,359
that<font color="#E5E5E5"> we know of</font><font color="#CCCCCC"> right</font><font color="#E5E5E5"> now one the most</font>

351
00:12:54,230 --> 00:12:58,010
obvious<font color="#E5E5E5"> is</font><font color="#CCCCCC"> the ability</font><font color="#E5E5E5"> to change that</font>

352
00:12:56,360 --> 00:12:59,689
<font color="#CCCCCC">user's password without</font><font color="#E5E5E5"> knowing its</font>

353
00:12:58,010 --> 00:13:01,279
current value<font color="#E5E5E5"> this is what you give</font>

354
00:12:59,689 --> 00:13:02,540
<font color="#CCCCCC">helpdesk people so that they can reset</font>

355
00:13:01,279 --> 00:13:04,759
someone's password after<font color="#E5E5E5"> they lock their</font>

356
00:13:02,540 --> 00:13:07,160
account out the second<font color="#E5E5E5"> one is targeted</font>

357
00:13:04,759 --> 00:13:09,769
<font color="#E5E5E5">Kerberos</font><font color="#CCCCCC"> thing so if we can write a</font>

358
00:13:07,160 --> 00:13:12,920
value<font color="#E5E5E5"> to the</font><font color="#CCCCCC"> SVM property on the user</font>

359
00:13:09,769 --> 00:13:15,139
object<font color="#CCCCCC"> we can Kerberos that user from</font>

360
00:13:12,920 --> 00:13:16,610
any domain<font color="#E5E5E5"> user in the environment we</font>

361
00:13:15,139 --> 00:13:18,720
can<font color="#E5E5E5"> get a Kerberos ticket back from the</font>

362
00:13:16,610 --> 00:13:20,730
domain controller for that user<font color="#E5E5E5"> we</font>

363
00:13:18,720 --> 00:13:23,069
encrypted using the ntlm hash of that

364
00:13:20,730 --> 00:13:25,589
<font color="#CCCCCC">users</font><font color="#E5E5E5"> password then we're just</font><font color="#CCCCCC"> cracking</font>

365
00:13:23,069 --> 00:13:27,839
<font color="#CCCCCC">ntlm</font><font color="#E5E5E5"> if we can do that we can recover</font>

366
00:13:25,589 --> 00:13:29,879
<font color="#E5E5E5">the current</font><font color="#CCCCCC"> clear-text value of that</font>

367
00:13:27,839 --> 00:13:31,439
<font color="#E5E5E5">user's password</font><font color="#CCCCCC"> then we can reset</font><font color="#E5E5E5"> it and</font>

368
00:13:29,879 --> 00:13:33,899
<font color="#E5E5E5">the user is none the wiser so it's not</font>

369
00:13:31,439 --> 00:13:35,639
destructive<font color="#CCCCCC"> in that there's not there's</font>

370
00:13:33,899 --> 00:13:37,110
<font color="#E5E5E5">an indication that a property change but</font>

371
00:13:35,639 --> 00:13:39,180
the<font color="#E5E5E5"> end-user</font><font color="#CCCCCC"> doesn't actually</font><font color="#E5E5E5"> notice</font>

372
00:13:37,110 --> 00:13:41,730
anything different<font color="#CCCCCC"> secondly we</font><font color="#E5E5E5"> have</font>

373
00:13:39,180 --> 00:13:42,810
group objects obviously so<font color="#E5E5E5"> the primitive</font>

374
00:13:41,730 --> 00:13:45,629
that<font color="#CCCCCC"> we're looking</font><font color="#E5E5E5"> at here is the</font>

375
00:13:42,810 --> 00:13:48,689
ability to add an arbitrary<font color="#CCCCCC"> object to</font>

376
00:13:45,629 --> 00:13:50,550
the members list of a group then we

377
00:13:48,689 --> 00:13:52,079
<font color="#CCCCCC">write</font><font color="#E5E5E5"> the existing privilege</font><font color="#CCCCCC"> that</font><font color="#E5E5E5"> that</font>

378
00:13:50,550 --> 00:13:54,300
group<font color="#E5E5E5"> has either by security group</font>

379
00:13:52,079 --> 00:13:57,599
delegation or by that<font color="#E5E5E5"> grouping for</font>

380
00:13:54,300 --> 00:13:59,370
example a local<font color="#E5E5E5"> admin on a computer</font><font color="#CCCCCC"> we</font>

381
00:13:57,600 --> 00:14:01,079
can either have<font color="#CCCCCC"> the ability to write to</font>

382
00:13:59,370 --> 00:14:03,540
the members property or we can have<font color="#E5E5E5"> the</font>

383
00:14:01,079 --> 00:14:05,550
generic<font color="#CCCCCC"> write privilege and that allows</font>

384
00:14:03,540 --> 00:14:06,779
us<font color="#E5E5E5"> to do this and again</font><font color="#CCCCCC"> all throughout</font>

385
00:14:05,550 --> 00:14:08,819
<font color="#E5E5E5">this we actually</font><font color="#CCCCCC"> have weaponization</font>

386
00:14:06,779 --> 00:14:10,920
functions<font color="#E5E5E5"> through Power View to actually</font>

387
00:14:08,819 --> 00:14:14,189
abuse all these<font color="#E5E5E5"> takeover primitives yep</font>

388
00:14:10,920 --> 00:14:17,839
<font color="#CCCCCC">in this instance it ad -</font><font color="#E5E5E5"> domain group</font>

389
00:14:14,189 --> 00:14:22,519
member computer objects are

390
00:14:17,839 --> 00:14:24,689
unfortunately a little less sexy<font color="#E5E5E5"> yeah so</font>

391
00:14:22,519 --> 00:14:27,120
<font color="#E5E5E5">computer objects we do</font><font color="#CCCCCC"> now to</font><font color="#E5E5E5"> take over</font>

392
00:14:24,689 --> 00:14:29,009
these if<font color="#E5E5E5"> laps</font><font color="#CCCCCC"> is installed in the</font>

393
00:14:27,120 --> 00:14:30,360
<font color="#E5E5E5">environment laps is the local local</font>

394
00:14:29,009 --> 00:14:32,100
admin password solution<font color="#CCCCCC"> for Microsoft</font>

395
00:14:30,360 --> 00:14:35,459
<font color="#CCCCCC">which you</font><font color="#E5E5E5"> absolutely should have</font>

396
00:14:32,100 --> 00:14:37,050
deployed<font color="#E5E5E5"> laps changes a local admin</font>

397
00:14:35,459 --> 00:14:39,180
<font color="#E5E5E5">password for the computer</font><font color="#CCCCCC"> and then puts</font>

398
00:14:37,050 --> 00:14:41,040
the clear<font color="#E5E5E5"> text value of that</font><font color="#CCCCCC"> password as</font>

399
00:14:39,180 --> 00:14:43,979
a protected attribute on the<font color="#E5E5E5"> computer</font>

400
00:14:41,040 --> 00:14:45,990
object if we can read<font color="#CCCCCC"> that attribute we</font>

401
00:14:43,980 --> 00:14:49,230
have the local<font color="#CCCCCC"> lab and password makes</font>

402
00:14:45,990 --> 00:14:50,699
sense that's<font color="#E5E5E5"> about</font><font color="#CCCCCC"> as far</font><font color="#E5E5E5"> as we know of</font>

403
00:14:49,230 --> 00:14:52,350
how to take over computer objects we<font color="#E5E5E5"> are</font>

404
00:14:50,699 --> 00:14:53,849
very<font color="#E5E5E5"> interested in what others may have</font>

405
00:14:52,350 --> 00:14:58,309
<font color="#E5E5E5">as far as</font><font color="#CCCCCC"> ideas for how to do that</font>

406
00:14:53,850 --> 00:15:00,540
<font color="#E5E5E5">that's one</font><font color="#CCCCCC"> area for future research next</font>

407
00:14:58,309 --> 00:15:03,540
<font color="#E5E5E5">every active directory domain has a</font>

408
00:15:00,540 --> 00:15:05,809
domain object that<font color="#CCCCCC"> represents the domain</font>

409
00:15:03,540 --> 00:15:09,180
as a whole so the domain object itself

410
00:15:05,809 --> 00:15:12,360
<font color="#CCCCCC">if you have full</font><font color="#E5E5E5"> control or if you have</font>

411
00:15:09,180 --> 00:15:14,969
<font color="#E5E5E5">des replication get changes and des</font>

412
00:15:12,360 --> 00:15:17,759
replication get changes all then without

413
00:15:14,970 --> 00:15:20,910
<font color="#CCCCCC">any other kind of privilege you can DC</font>

414
00:15:17,759 --> 00:15:24,029
sync so let me say<font color="#E5E5E5"> that one more time</font>

415
00:15:20,910 --> 00:15:25,920
<font color="#E5E5E5">without having</font><font color="#CCCCCC"> a</font><font color="#E5E5E5"> local admin on a DC</font>

416
00:15:24,029 --> 00:15:27,630
without<font color="#E5E5E5"> being a domain admin if I have</font>

417
00:15:25,920 --> 00:15:30,839
certain privileges<font color="#CCCCCC"> on the</font><font color="#E5E5E5"> domain object</font>

418
00:15:27,630 --> 00:15:32,580
I can DC sync get NT hashes<font color="#E5E5E5"> for any user</font>

419
00:15:30,839 --> 00:15:34,800
in the environment<font color="#E5E5E5"> that I want including</font>

420
00:15:32,580 --> 00:15:37,110
anything<font color="#E5E5E5"> so again we care about right</font>

421
00:15:34,800 --> 00:15:39,029
<font color="#E5E5E5">tackle which would allow us to modify</font>

422
00:15:37,110 --> 00:15:40,519
<font color="#E5E5E5">the security</font><font color="#CCCCCC"> information to then grant</font>

423
00:15:39,029 --> 00:15:43,860
ourselves<font color="#CCCCCC"> that's right</font><font color="#E5E5E5"> exactly</font>

424
00:15:40,519 --> 00:15:46,230
<font color="#E5E5E5">so GPOs group</font><font color="#CCCCCC"> policy objects the main</font>

425
00:15:43,860 --> 00:15:48,420
<font color="#CCCCCC">takeover primitive for GPOs is involves</font>

426
00:15:46,230 --> 00:15:50,010
the right<font color="#E5E5E5"> to edit the gpo itself</font><font color="#CCCCCC"> so</font>

427
00:15:48,420 --> 00:15:51,959
<font color="#E5E5E5">these group policy objects are</font>

428
00:15:50,010 --> 00:15:54,450
collections of settings<font color="#E5E5E5"> that are applied</font>

429
00:15:51,959 --> 00:15:55,500
to oh you sites and domains<font color="#E5E5E5"> those are</font>

430
00:15:54,450 --> 00:15:57,000
then<font color="#CCCCCC"> filtered down through the</font>

431
00:15:55,500 --> 00:15:59,640
inheritance<font color="#E5E5E5"> and you talked about kind</font><font color="#CCCCCC"> of</font>

432
00:15:57,000 --> 00:16:01,620
like aces and these<font color="#E5E5E5"> settings are</font><font color="#CCCCCC"> applied</font>

433
00:15:59,640 --> 00:16:02,910
to users and<font color="#E5E5E5"> computers out user and</font>

434
00:16:01,620 --> 00:16:04,709
computer objects all the way kind of

435
00:16:02,910 --> 00:16:06,300
down the chain so if you have the

436
00:16:04,709 --> 00:16:07,800
<font color="#E5E5E5">ability to edit a GPO there's a</font>

437
00:16:06,300 --> 00:16:09,599
<font color="#CCCCCC">million-in-one</font><font color="#E5E5E5"> ways to turn that into</font>

438
00:16:07,800 --> 00:16:12,540
code execution on a computer is applied

439
00:16:09,600 --> 00:16:14,070
to or to modify<font color="#CCCCCC"> something about the user</font>

440
00:16:12,540 --> 00:16:15,540
you can change reg entries you know

441
00:16:14,070 --> 00:16:17,700
<font color="#CCCCCC">schedule tasks</font><font color="#E5E5E5"> there's a million one</font>

442
00:16:15,540 --> 00:16:19,310
things<font color="#E5E5E5"> so for this what we care</font><font color="#CCCCCC"> about is</font>

443
00:16:17,700 --> 00:16:26,040
<font color="#E5E5E5">writing</font><font color="#CCCCCC"> to all the properties are</font>

444
00:16:19,310 --> 00:16:28,410
writing to GPC<font color="#CCCCCC"> file system modify GPC</font>

445
00:16:26,040 --> 00:16:30,510
file suspicions are actually cloned down

446
00:16:28,410 --> 00:16:32,399
from what we can<font color="#E5E5E5"> tell on to the file</font>

447
00:16:30,510 --> 00:16:33,899
<font color="#CCCCCC">system insist fall or the</font><font color="#E5E5E5"> group where</font>

448
00:16:32,399 --> 00:16:36,240
the<font color="#E5E5E5"> GPO actually resides</font>

449
00:16:33,899 --> 00:16:37,680
so modify it<font color="#CCCCCC"> clung down and now I have</font>

450
00:16:36,240 --> 00:16:42,420
the<font color="#CCCCCC"> ability to actually edit the gpo</font>

451
00:16:37,680 --> 00:16:43,800
files that are actually<font color="#CCCCCC"> on sis well then</font>

452
00:16:42,420 --> 00:16:45,270
there's a few generic<font color="#E5E5E5"> rights that</font>

453
00:16:43,800 --> 00:16:46,620
applied to<font color="#E5E5E5"> pretty much all the objects</font>

454
00:16:45,270 --> 00:16:48,149
we talked about<font color="#E5E5E5"> so those are kind of the</font>

455
00:16:46,620 --> 00:16:50,070
object specific<font color="#CCCCCC"> takeover rights these</font>

456
00:16:48,149 --> 00:16:52,560
are the<font color="#E5E5E5"> generic ones so generic all</font>

457
00:16:50,070 --> 00:16:53,880
<font color="#E5E5E5">grants us all rights pretty simple it</font>

458
00:16:52,560 --> 00:16:55,250
also grants<font color="#E5E5E5"> control rights which we're</font>

459
00:16:53,880 --> 00:16:58,500
<font color="#E5E5E5">going to talk</font><font color="#CCCCCC"> about on the next</font><font color="#E5E5E5"> slide</font>

460
00:16:55,250 --> 00:17:01,620
generic right will allow us to<font color="#E5E5E5"> modify</font>

461
00:16:58,500 --> 00:17:03,570
all almost<font color="#CCCCCC"> all properties everything but</font>

462
00:17:01,620 --> 00:17:05,369
confidential properties on the object

463
00:17:03,570 --> 00:17:06,780
<font color="#E5E5E5">everything except where the things that</font>

464
00:17:05,369 --> 00:17:08,760
are protected<font color="#CCCCCC"> by the IDS control access</font>

465
00:17:06,780 --> 00:17:10,139
<font color="#E5E5E5">bit and like that type of thing</font><font color="#CCCCCC"> these</font>

466
00:17:08,760 --> 00:17:12,689
<font color="#E5E5E5">are both abusable with set domain</font>

467
00:17:10,140 --> 00:17:14,550
<font color="#E5E5E5">objects and these two rights again apply</font>

468
00:17:12,689 --> 00:17:15,870
to pretty<font color="#E5E5E5"> much almost anything we talked</font>

469
00:17:14,550 --> 00:17:19,139
<font color="#CCCCCC">about for takeover to get in the paper</font>

470
00:17:15,869 --> 00:17:21,510
as more specific details so what do<font color="#E5E5E5"> I</font>

471
00:17:19,140 --> 00:17:23,669
<font color="#CCCCCC">mean by control rights there are a</font>

472
00:17:21,510 --> 00:17:26,129
couple of<font color="#E5E5E5"> rights that will allow a</font>

473
00:17:23,669 --> 00:17:27,870
trustee or principal to take control of

474
00:17:26,130 --> 00:17:29,580
the object in a specific way instead<font color="#CCCCCC"> of</font>

475
00:17:27,869 --> 00:17:32,280
modifying<font color="#CCCCCC"> you know the actual object</font>

476
00:17:29,580 --> 00:17:36,540
itself<font color="#E5E5E5"> so right</font><font color="#CCCCCC"> deckle will grant us the</font>

477
00:17:32,280 --> 00:17:38,250
ability<font color="#CCCCCC"> to</font><font color="#E5E5E5"> modify</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> dackel right is</font><font color="#CCCCCC"> a</font>

478
00:17:36,540 --> 00:17:41,340
<font color="#CCCCCC">beautiful</font><font color="#E5E5E5"> power view with</font><font color="#CCCCCC"> ADD domain</font>

479
00:17:38,250 --> 00:17:43,620
object ACL<font color="#E5E5E5"> and right owner grants us</font><font color="#CCCCCC"> the</font>

480
00:17:41,340 --> 00:17:44,370
ability<font color="#E5E5E5"> to take ownership of the object</font>

481
00:17:43,620 --> 00:17:46,178
in Active Directory

482
00:17:44,370 --> 00:17:48,699
<font color="#E5E5E5">the reason care about this is that</font>

483
00:17:46,179 --> 00:17:50,350
owners have implicitly complete rights

484
00:17:48,700 --> 00:17:53,679
on the object<font color="#E5E5E5"> even if there's an</font>

485
00:17:50,350 --> 00:17:55,658
explicit deny even<font color="#E5E5E5"> if</font><font color="#CCCCCC"> we'll has complete</font>

486
00:17:53,679 --> 00:17:57,669
denying<font color="#CCCCCC"> Andy if I'm the owner then now</font>

487
00:17:55,659 --> 00:17:59,860
you<font color="#E5E5E5"> have complete full access and this</font>

488
00:17:57,669 --> 00:18:04,929
is abusable<font color="#CCCCCC"> power view with set</font><font color="#E5E5E5"> domain</font>

489
00:17:59,860 --> 00:18:06,789
object owner<font color="#E5E5E5"> okay so let's take a look</font>

490
00:18:04,929 --> 00:18:09,009
at how we<font color="#E5E5E5"> can analyze</font><font color="#CCCCCC"> this</font><font color="#E5E5E5"> stuff with</font>

491
00:18:06,789 --> 00:18:10,899
<font color="#E5E5E5">bloodhound</font><font color="#CCCCCC"> unfortunately if you try to</font>

492
00:18:09,009 --> 00:18:13,990
if<font color="#CCCCCC"> your to audit aces in Active</font>

493
00:18:10,899 --> 00:18:15,158
Directory you go down the path<font color="#CCCCCC"> of a very</font>

494
00:18:13,990 --> 00:18:18,009
<font color="#CCCCCC">frustrating experience</font>

495
00:18:15,159 --> 00:18:20,230
currently we think that we've<font color="#CCCCCC"> done</font><font color="#E5E5E5"> a</font>

496
00:18:18,009 --> 00:18:23,049
<font color="#E5E5E5">pretty good job with implementing these</font>

497
00:18:20,230 --> 00:18:25,119
<font color="#E5E5E5">ace edges into bloodhound</font><font color="#CCCCCC"> one thing I</font>

498
00:18:23,049 --> 00:18:28,059
notice we're<font color="#CCCCCC"> only implementing the</font>

499
00:18:25,119 --> 00:18:29,740
abusable<font color="#E5E5E5"> aces we're not pulling in every</font>

500
00:18:28,059 --> 00:18:31,658
single ace on every single<font color="#CCCCCC"> object</font><font color="#E5E5E5"> it's</font>

501
00:18:29,740 --> 00:18:33,009
also not 100%<font color="#CCCCCC"> complete there's a few</font>

502
00:18:31,659 --> 00:18:34,629
<font color="#E5E5E5">additional control relationships</font>

503
00:18:33,009 --> 00:18:37,149
specifically GPOs that were in the

504
00:18:34,629 --> 00:18:39,009
process<font color="#E5E5E5"> of implementing so as for</font>

505
00:18:37,149 --> 00:18:41,590
defenders we hope this<font color="#E5E5E5"> is</font><font color="#CCCCCC"> useful for</font>

506
00:18:39,009 --> 00:18:44,110
finding malicious backdoors<font color="#E5E5E5"> for</font>

507
00:18:41,590 --> 00:18:45,668
enforcing<font color="#CCCCCC"> leaf privilege and for</font>

508
00:18:44,110 --> 00:18:49,178
hopefully<font color="#CCCCCC"> detecting some of the non</font>

509
00:18:45,669 --> 00:18:51,490
stealthy<font color="#CCCCCC"> tackle</font><font color="#E5E5E5"> based best backdoors</font><font color="#CCCCCC"> as</font>

510
00:18:49,179 --> 00:18:53,559
attackers we can use this for finding

511
00:18:51,490 --> 00:18:55,389
opportunities where if we have a user

512
00:18:53,559 --> 00:18:57,190
<font color="#CCCCCC">that is multiple degrees of</font><font color="#E5E5E5"> separation</font>

513
00:18:55,389 --> 00:18:59,289
<font color="#E5E5E5">away from</font><font color="#CCCCCC"> the object that we're actually</font>

514
00:18:57,190 --> 00:19:00,970
<font color="#CCCCCC">interested in taking</font><font color="#E5E5E5"> over we can</font>

515
00:18:59,289 --> 00:19:02,799
<font color="#E5E5E5">backdoor this user which may not</font><font color="#CCCCCC"> be as</font>

516
00:19:00,970 --> 00:19:05,950
interesting<font color="#CCCCCC"> to the defenders and</font><font color="#E5E5E5"> we have</font>

517
00:19:02,799 --> 00:19:07,210
<font color="#E5E5E5">access to</font><font color="#CCCCCC"> this other</font><font color="#E5E5E5"> object</font><font color="#CCCCCC"> which is we</font>

518
00:19:05,950 --> 00:19:11,139
can also have an understanding<font color="#E5E5E5"> of what</font>

519
00:19:07,210 --> 00:19:12,639
the current privilege<font color="#E5E5E5"> maturity level is</font>

520
00:19:11,139 --> 00:19:15,668
in the<font color="#E5E5E5"> environment so that</font><font color="#CCCCCC"> we know just</font>

521
00:19:12,639 --> 00:19:18,008
<font color="#CCCCCC">how well we can sneak in and blend in</font>

522
00:19:15,669 --> 00:19:19,600
with the noise so we have a video<font color="#E5E5E5"> that</font>

523
00:19:18,009 --> 00:19:21,190
we're going<font color="#CCCCCC"> to show</font><font color="#E5E5E5"> you this is</font><font color="#CCCCCC"> the</font>

524
00:19:19,600 --> 00:19:24,850
bloodhound interface that we're going<font color="#E5E5E5"> to</font>

525
00:19:21,190 --> 00:19:26,649
<font color="#E5E5E5">look at when you pull</font><font color="#CCCCCC"> up the</font><font color="#E5E5E5"> bloodhound</font>

526
00:19:24,850 --> 00:19:29,019
interface you see<font color="#CCCCCC"> the members of the</font>

527
00:19:26,649 --> 00:19:30,580
<font color="#CCCCCC">domain admins groups which we unroll out</font>

528
00:19:29,019 --> 00:19:33,340
for you<font color="#CCCCCC"> so if</font><font color="#E5E5E5"> I click on the domain</font>

529
00:19:30,580 --> 00:19:36,490
<font color="#E5E5E5">admins I'm interested in seeing inbound</font>

530
00:19:33,340 --> 00:19:38,740
<font color="#E5E5E5">object control so this was released with</font>

531
00:19:36,490 --> 00:19:40,059
a<font color="#E5E5E5"> 1.3 update the explicit object</font>

532
00:19:38,740 --> 00:19:41,350
controllers we can see that there<font color="#CCCCCC"> are</font>

533
00:19:40,059 --> 00:19:42,759
<font color="#E5E5E5">six groups that have some</font><font color="#CCCCCC"> kind of</font>

534
00:19:41,350 --> 00:19:45,189
<font color="#E5E5E5">control over the domain admins group</font>

535
00:19:42,759 --> 00:19:47,769
<font color="#E5E5E5">four of them are a generic all edge</font>

536
00:19:45,190 --> 00:19:50,080
which<font color="#CCCCCC"> is full control and one of them is</font>

537
00:19:47,769 --> 00:19:52,169
<font color="#CCCCCC">a right tackle edge meaning that I can</font>

538
00:19:50,080 --> 00:19:54,519
take control of<font color="#E5E5E5"> the domain admins</font><font color="#CCCCCC"> group</font>

539
00:19:52,169 --> 00:19:55,720
so the we have the<font color="#CCCCCC"> exchange groups and</font>

540
00:19:54,519 --> 00:19:58,330
then<font color="#E5E5E5"> we have this administrators</font><font color="#CCCCCC"> group</font>

541
00:19:55,720 --> 00:19:59,710
in a<font color="#E5E5E5"> back up to there are users</font><font color="#CCCCCC"> that</font>

542
00:19:58,330 --> 00:20:01,689
belong to<font color="#CCCCCC"> these groups</font>

543
00:19:59,710 --> 00:20:03,130
if we unroll<font color="#CCCCCC"> that out we can</font><font color="#E5E5E5"> see this is</font>

544
00:20:01,690 --> 00:20:05,080
what the<font color="#CCCCCC"> picture actually</font><font color="#E5E5E5"> looks like and</font>

545
00:20:03,130 --> 00:20:07,360
so all<font color="#CCCCCC"> of these principles here actually</font>

546
00:20:05,080 --> 00:20:10,199
<font color="#CCCCCC">have control over</font><font color="#E5E5E5"> the domain admins</font>

547
00:20:07,360 --> 00:20:12,729
<font color="#CCCCCC">group via</font><font color="#E5E5E5"> security of your delegation</font>

548
00:20:10,200 --> 00:20:15,430
<font color="#E5E5E5">the exchange trust of the subsystem is</font>

549
00:20:12,730 --> 00:20:17,410
one of particular<font color="#E5E5E5"> interest</font><font color="#CCCCCC"> to us this</font>

550
00:20:15,430 --> 00:20:19,840
user here is a member<font color="#CCCCCC"> of that group</font>

551
00:20:17,410 --> 00:20:21,820
<font color="#E5E5E5">which is a member of</font><font color="#CCCCCC"> that group which is</font>

552
00:20:19,840 --> 00:20:23,290
a member of<font color="#CCCCCC"> that group</font><font color="#E5E5E5"> which is a member</font>

553
00:20:21,820 --> 00:20:26,500
<font color="#CCCCCC">of</font><font color="#E5E5E5"> that</font><font color="#CCCCCC"> group which has the right tackle</font>

554
00:20:23,290 --> 00:20:28,389
privilege the domain admins group what

555
00:20:26,500 --> 00:20:31,540
<font color="#E5E5E5">we can also do is look at inbound</font>

556
00:20:28,390 --> 00:20:33,790
transitive object control<font color="#E5E5E5"> so by only</font>

557
00:20:31,540 --> 00:20:36,100
manipulating these aces or by<font color="#E5E5E5"> executing</font>

558
00:20:33,790 --> 00:20:37,870
an<font color="#CCCCCC"> apple only attack</font><font color="#E5E5E5"> path who else in</font>

559
00:20:36,100 --> 00:20:39,850
the domain can take over<font color="#CCCCCC"> the domain</font>

560
00:20:37,870 --> 00:20:41,949
admins<font color="#CCCCCC"> group or any other</font><font color="#E5E5E5"> group or any</font>

561
00:20:39,850 --> 00:20:43,570
other<font color="#CCCCCC"> principle that</font><font color="#E5E5E5"> we track in this</font>

562
00:20:41,950 --> 00:20:46,000
instance we have a group that<font color="#E5E5E5"> belongs</font><font color="#CCCCCC"> to</font>

563
00:20:43,570 --> 00:20:48,610
a group<font color="#E5E5E5"> that has force Change Password</font>

564
00:20:46,000 --> 00:20:50,290
ability to this user called<font color="#CCCCCC"> D Shofner</font>

565
00:20:48,610 --> 00:20:52,750
and that user the part of the<font color="#E5E5E5"> domain</font>

566
00:20:50,290 --> 00:20:55,000
admins group<font color="#CCCCCC"> slightly more interesting</font>

567
00:20:52,750 --> 00:20:57,880
attack<font color="#CCCCCC"> path starting at this user we use</font>

568
00:20:55,000 --> 00:21:00,130
<font color="#CCCCCC">it</font><font color="#E5E5E5"> group delegation from this group to</font>

569
00:20:57,880 --> 00:21:01,960
<font color="#CCCCCC">the following</font><font color="#E5E5E5"> group that gives us the</font>

570
00:21:00,130 --> 00:21:04,450
<font color="#CCCCCC">ability to change the user password for</font>

571
00:21:01,960 --> 00:21:07,090
this user here that user can<font color="#CCCCCC"> then</font><font color="#E5E5E5"> in</font>

572
00:21:04,450 --> 00:21:09,000
turn<font color="#E5E5E5"> change that users password</font><font color="#CCCCCC"> who</font>

573
00:21:07,090 --> 00:21:11,080
belongs to<font color="#E5E5E5"> this group to</font><font color="#CCCCCC"> the right and</font>

574
00:21:09,000 --> 00:21:15,430
that group<font color="#E5E5E5"> has full control</font><font color="#CCCCCC"> of the</font>

575
00:21:11,080 --> 00:21:17,590
domain admins group<font color="#CCCCCC"> so</font><font color="#E5E5E5"> it is one more</font>

576
00:21:15,430 --> 00:21:19,990
<font color="#CCCCCC">one</font><font color="#E5E5E5"> more little thing so we what we're</font>

577
00:21:17,590 --> 00:21:21,820
also interested<font color="#E5E5E5"> in is outbound control</font>

578
00:21:19,990 --> 00:21:23,440
so obviously domain admins is going to

579
00:21:21,820 --> 00:21:25,120
have control of<font color="#E5E5E5"> everything or at least</font>

580
00:21:23,440 --> 00:21:27,280
they should<font color="#E5E5E5"> we can also look at a</font>

581
00:21:25,120 --> 00:21:29,649
supposedly low<font color="#E5E5E5"> privileged user and find</font>

582
00:21:27,280 --> 00:21:31,510
what its privileges are so our<font color="#CCCCCC"> tailor</font>

583
00:21:29,650 --> 00:21:34,000
<font color="#E5E5E5">will look at the outbound object control</font>

584
00:21:31,510 --> 00:21:36,280
section<font color="#E5E5E5"> first</font><font color="#CCCCCC"> degree</font><font color="#E5E5E5"> object control is</font><font color="#CCCCCC"> 0</font>

585
00:21:34,000 --> 00:21:39,090
so the user itself<font color="#E5E5E5"> is not</font><font color="#CCCCCC"> defined as a</font>

586
00:21:36,280 --> 00:21:42,280
control<font color="#CCCCCC"> principle on any other objects</font>

587
00:21:39,090 --> 00:21:43,929
by groups by security group delegation

588
00:21:42,280 --> 00:21:46,120
it actually has the<font color="#E5E5E5"> ability</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> change</font>

589
00:21:43,930 --> 00:21:47,440
for different<font color="#CCCCCC"> users passwords so because</font>

590
00:21:46,120 --> 00:21:49,419
he's a member of<font color="#E5E5E5"> this</font><font color="#CCCCCC"> group and</font><font color="#E5E5E5"> then a</font>

591
00:21:47,440 --> 00:21:51,660
<font color="#E5E5E5">member of the following group he can</font>

592
00:21:49,420 --> 00:21:55,510
change<font color="#E5E5E5"> these 4 years</font><font color="#CCCCCC"> of passwords now</font>

593
00:21:51,660 --> 00:21:58,360
<font color="#E5E5E5">outbound transitive object control what</font>

594
00:21:55,510 --> 00:22:01,090
principles can this user take over by

595
00:21:58,360 --> 00:22:02,979
executing an<font color="#E5E5E5"> apple only attack path</font><font color="#CCCCCC"> and</font>

596
00:22:01,090 --> 00:22:04,270
we<font color="#E5E5E5"> follow that tree out as far as we can</font>

597
00:22:02,980 --> 00:22:05,800
go

598
00:22:04,270 --> 00:22:07,870
and we're basically<font color="#CCCCCC"> looking</font><font color="#E5E5E5"> at every</font>

599
00:22:05,800 --> 00:22:10,720
edge in the bloodhound database except

600
00:22:07,870 --> 00:22:12,518
for admin rights to a computer or<font color="#E5E5E5"> a user</font>

601
00:22:10,720 --> 00:22:14,229
having a session<font color="#CCCCCC"> on</font><font color="#E5E5E5"> a system so again</font>

602
00:22:12,519 --> 00:22:16,269
don't need code execution<font color="#E5E5E5"> on any</font>

603
00:22:14,229 --> 00:22:17,529
additional<font color="#E5E5E5"> system to run these types of</font>

604
00:22:16,269 --> 00:22:18,459
attacks<font color="#CCCCCC"> yeah all of</font><font color="#E5E5E5"> this is</font><font color="#CCCCCC"> just</font>

605
00:22:17,529 --> 00:22:23,549
communicating<font color="#CCCCCC"> with a domain controller</font>

606
00:22:18,459 --> 00:22:23,549
<font color="#CCCCCC">and that's it that's</font><font color="#E5E5E5"> it for the visual</font>

607
00:22:31,320 --> 00:22:34,990
<font color="#E5E5E5">all right so that brings us to section</font><font color="#CCCCCC"> 4</font>

608
00:22:33,880 --> 00:22:37,960
designing these<font color="#CCCCCC"> Active Directory</font>

609
00:22:34,990 --> 00:22:41,350
<font color="#CCCCCC">database doors</font><font color="#E5E5E5"> so what our objective is</font>

610
00:22:37,960 --> 00:22:43,570
here<font color="#E5E5E5"> we want</font><font color="#CCCCCC"> to implement a</font><font color="#E5E5E5"> ACL based</font>

611
00:22:41,350 --> 00:22:46,270
<font color="#CCCCCC">backdoor in Active Directory that allows</font>

612
00:22:43,570 --> 00:22:49,929
us<font color="#CCCCCC"> to</font><font color="#E5E5E5"> get</font><font color="#CCCCCC"> access into</font><font color="#E5E5E5"> the network at any</font>

613
00:22:46,270 --> 00:22:52,210
<font color="#E5E5E5">time later in any user context and very</font>

614
00:22:49,930 --> 00:22:54,040
very quickly<font color="#E5E5E5"> upgrade</font><font color="#CCCCCC"> our rights</font><font color="#E5E5E5"> to</font>

615
00:22:52,210 --> 00:22:56,350
whatever privilege we want domain admin

616
00:22:54,040 --> 00:22:58,510
for example we want to either blend in

617
00:22:56,350 --> 00:22:59,949
with existing ACL so that it's<font color="#E5E5E5"> very hard</font>

618
00:22:58,510 --> 00:23:02,770
<font color="#CCCCCC">to tell the difference between our</font>

619
00:22:59,950 --> 00:23:06,000
malicious ones and<font color="#CCCCCC"> quote-unquote good</font>

620
00:23:02,770 --> 00:23:08,020
ones<font color="#CCCCCC"> and we also have other other</font>

621
00:23:06,000 --> 00:23:12,460
primitives for making<font color="#E5E5E5"> that very very</font>

622
00:23:08,020 --> 00:23:14,560
hard<font color="#E5E5E5"> for an auditor to actually find</font><font color="#CCCCCC"> the</font>

623
00:23:12,460 --> 00:23:16,960
first<font color="#E5E5E5"> of which is the ability to hide</font>

624
00:23:14,560 --> 00:23:20,830
the dackel from enumeration by an

625
00:23:16,960 --> 00:23:22,750
auditor<font color="#E5E5E5"> so this requires two steps will</font>

626
00:23:20,830 --> 00:23:25,120
have me the point already<font color="#E5E5E5"> that if if I</font>

627
00:23:22,750 --> 00:23:28,150
am the owner of<font color="#E5E5E5"> an object I retain all</font>

628
00:23:25,120 --> 00:23:31,629
privileges<font color="#E5E5E5"> regardless of what other what</font>

629
00:23:28,150 --> 00:23:33,490
other<font color="#E5E5E5"> aces</font><font color="#CCCCCC"> exist on that users tackle</font><font color="#E5E5E5"> so</font>

630
00:23:31,630 --> 00:23:35,020
<font color="#CCCCCC">we need to change</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> object owner</font><font color="#E5E5E5"> away</font>

631
00:23:33,490 --> 00:23:37,690
from domain admins to<font color="#E5E5E5"> some other</font>

632
00:23:35,020 --> 00:23:40,120
principle<font color="#E5E5E5"> and then I need to</font><font color="#CCCCCC"> add a new</font>

633
00:23:37,690 --> 00:23:41,440
explicit deny ace<font color="#E5E5E5"> which is going to</font>

634
00:23:40,120 --> 00:23:43,919
override<font color="#CCCCCC"> everything else</font>

635
00:23:41,440 --> 00:23:46,390
<font color="#E5E5E5">remember that</font><font color="#CCCCCC"> SR inheritance yep and</font>

636
00:23:43,920 --> 00:23:47,800
what I'm going<font color="#E5E5E5"> to do is the everyone</font>

637
00:23:46,390 --> 00:23:51,040
principle<font color="#E5E5E5"> I'm going to say they are</font>

638
00:23:47,800 --> 00:23:53,409
denied<font color="#E5E5E5"> read permissions so now if you do</font>

639
00:23:51,040 --> 00:23:55,180
like<font color="#CCCCCC"> Adi Cole scanner or if you look in</font>

640
00:23:53,410 --> 00:23:57,070
a<font color="#CCCCCC"> duct you're not going to be able to</font>

641
00:23:55,180 --> 00:24:00,490
even read the dackel on the<font color="#E5E5E5"> effected</font>

642
00:23:57,070 --> 00:24:02,560
object this<font color="#E5E5E5"> is what that looks like in</font>

643
00:24:00,490 --> 00:24:05,770
<font color="#E5E5E5">in a GUI so what I'm saying is that</font>

644
00:24:02,560 --> 00:24:07,419
<font color="#CCCCCC">everyone</font><font color="#E5E5E5"> is denied read permissions</font>

645
00:24:05,770 --> 00:24:11,830
<font color="#E5E5E5">against this user called Jeff</font><font color="#CCCCCC"> Dimmick</font>

646
00:24:07,420 --> 00:24:14,530
make sense what I can also do is I can

647
00:24:11,830 --> 00:24:16,000
<font color="#E5E5E5">hide the existence</font><font color="#CCCCCC"> of a principle this</font>

648
00:24:14,530 --> 00:24:17,710
<font color="#E5E5E5">can be any principle this would be any</font>

649
00:24:16,000 --> 00:24:19,480
<font color="#CCCCCC">object in Active Directory</font><font color="#E5E5E5"> I can I can</font>

650
00:24:17,710 --> 00:24:21,490
hide the<font color="#CCCCCC"> fact that it</font><font color="#E5E5E5"> actually exists</font>

651
00:24:19,480 --> 00:24:24,010
this<font color="#E5E5E5"> is a little more complicated but</font>

652
00:24:21,490 --> 00:24:26,560
it's basically<font color="#E5E5E5"> three steps the first of</font>

653
00:24:24,010 --> 00:24:28,750
which is change the object<font color="#E5E5E5"> owner to some</font>

654
00:24:26,560 --> 00:24:30,429
<font color="#E5E5E5">of the principle either itself</font><font color="#CCCCCC"> or a</font>

655
00:24:28,750 --> 00:24:33,730
principle that<font color="#E5E5E5"> we have control</font><font color="#CCCCCC"> of or</font>

656
00:24:30,430 --> 00:24:35,320
that<font color="#E5E5E5"> we can gain control</font><font color="#CCCCCC"> of then grant</font>

657
00:24:33,730 --> 00:24:38,430
explicit control<font color="#CCCCCC"> of the principle to</font>

658
00:24:35,320 --> 00:24:42,639
itself<font color="#CCCCCC"> or some</font><font color="#E5E5E5"> other control principle</font>

659
00:24:38,430 --> 00:24:43,840
<font color="#E5E5E5">then on the</font><font color="#CCCCCC"> öyou that contains this</font>

660
00:24:42,640 --> 00:24:46,900
principle

661
00:24:43,840 --> 00:24:51,549
we're going to deny<font color="#E5E5E5"> everyone the list</font>

662
00:24:46,900 --> 00:24:54,010
<font color="#E5E5E5">contents privilege so in a</font><font color="#CCCCCC"> duck</font><font color="#E5E5E5"> via LDAP</font>

663
00:24:51,549 --> 00:24:55,418
<font color="#E5E5E5">with a net executable</font><font color="#CCCCCC"> you're not going</font>

664
00:24:54,010 --> 00:24:59,260
to be able<font color="#CCCCCC"> to see that</font><font color="#E5E5E5"> this user even</font>

665
00:24:55,419 --> 00:25:00,340
exists<font color="#CCCCCC"> I assure you that a user exists</font>

666
00:24:59,260 --> 00:25:02,559
in this oh you

667
00:25:00,340 --> 00:25:04,809
however running of the domain admin and

668
00:25:02,559 --> 00:25:06,940
looking<font color="#CCCCCC"> at a duck we can't see</font><font color="#E5E5E5"> it and</font>

669
00:25:04,809 --> 00:25:11,139
whether<font color="#CCCCCC"> it's LDAP Power View a duck das</font>

670
00:25:06,940 --> 00:25:13,570
query doesn't<font color="#E5E5E5"> really matter right so to</font>

671
00:25:11,140 --> 00:25:16,149
sum that up we know how we can<font color="#E5E5E5"> take over</font>

672
00:25:13,570 --> 00:25:18,970
other objects in<font color="#E5E5E5"> Active Directory by</font>

673
00:25:16,149 --> 00:25:20,709
abusing<font color="#E5E5E5"> aces we know that we can control</font>

674
00:25:18,970 --> 00:25:21,880
who can enumerate the dackel to find

675
00:25:20,710 --> 00:25:23,620
these<font color="#CCCCCC"> backdoors that we're putting in</font>

676
00:25:21,880 --> 00:25:25,240
and we know that<font color="#E5E5E5"> we can hide the</font>

677
00:25:23,620 --> 00:25:28,629
principles that<font color="#CCCCCC"> we're back dooring or</font>

678
00:25:25,240 --> 00:25:31,360
otherwise<font color="#E5E5E5"> from easy identification</font><font color="#CCCCCC"> from</font>

679
00:25:28,630 --> 00:25:32,770
defenders okay that's all<font color="#CCCCCC"> the you know</font>

680
00:25:31,360 --> 00:25:34,330
<font color="#E5E5E5">that's all the background all the pieces</font>

681
00:25:32,770 --> 00:25:36,520
<font color="#E5E5E5">all the LEGO pieces we're going to put</font>

682
00:25:34,330 --> 00:25:38,020
<font color="#E5E5E5">together so remember if you can dream it</font>

683
00:25:36,520 --> 00:25:39,820
<font color="#E5E5E5">these are the</font><font color="#CCCCCC"> five we're going to go</font>

684
00:25:38,020 --> 00:25:42,100
<font color="#CCCCCC">over five case studies that</font><font color="#E5E5E5"> we came</font><font color="#CCCCCC"> up</font>

685
00:25:39,820 --> 00:25:43,450
<font color="#E5E5E5">with we</font><font color="#CCCCCC"> have</font><font color="#E5E5E5"> already have more</font><font color="#CCCCCC"> ideas</font>

686
00:25:42,100 --> 00:25:45,129
<font color="#E5E5E5">after you put</font><font color="#CCCCCC"> the deck together there's</font>

687
00:25:43,450 --> 00:25:48,760
infinite possibilities and<font color="#E5E5E5"> how</font><font color="#CCCCCC"> you could</font>

688
00:25:45,130 --> 00:25:50,830
design these chains of malicious aces<font color="#E5E5E5"> so</font>

689
00:25:48,760 --> 00:25:53,169
the very first<font color="#CCCCCC"> one pretty easy</font><font color="#E5E5E5"> I talked</font>

690
00:25:50,830 --> 00:25:54,520
about<font color="#E5E5E5"> those DC</font><font color="#CCCCCC"> sink privileges so what</font>

691
00:25:53,169 --> 00:25:56,890
the attacker does to implement the

692
00:25:54,520 --> 00:25:59,168
backdoor is they add<font color="#CCCCCC"> es replication get</font>

693
00:25:56,890 --> 00:26:02,169
changes and<font color="#E5E5E5"> des replication get changes</font>

694
00:25:59,169 --> 00:26:04,080
all to the domain objects itself<font color="#E5E5E5"> where</font>

695
00:26:02,169 --> 00:26:07,600
they are the they are the<font color="#E5E5E5"> principal or a</font>

696
00:26:04,080 --> 00:26:09,850
user they<font color="#E5E5E5"> controls the principal then</font>

697
00:26:07,600 --> 00:26:11,350
that user and that user our computer

698
00:26:09,850 --> 00:26:12,820
doesn't<font color="#E5E5E5"> matter what it is does</font><font color="#CCCCCC"> not have</font>

699
00:26:11,350 --> 00:26:14,199
to be in any groups at all<font color="#E5E5E5"> it doesn't</font>

700
00:26:12,820 --> 00:26:15,610
<font color="#CCCCCC">have to be in any privileged groups it</font>

701
00:26:14,200 --> 00:26:17,770
doesn't have to be domain admins doesn't

702
00:26:15,610 --> 00:26:19,840
have to be anything<font color="#CCCCCC"> you just</font><font color="#E5E5E5"> leave</font><font color="#CCCCCC"> it</font>

703
00:26:17,770 --> 00:26:21,668
there then the attacker in the future

704
00:26:19,840 --> 00:26:23,949
could be five years<font color="#CCCCCC"> in the future ten</font>

705
00:26:21,669 --> 00:26:26,710
years in the<font color="#E5E5E5"> future regains access to</font>

706
00:26:23,950 --> 00:26:28,570
that account<font color="#E5E5E5"> and then can use DC sync</font>

707
00:26:26,710 --> 00:26:30,250
again written<font color="#CCCCCC"> by Benjamin Delfy and</font>

708
00:26:28,570 --> 00:26:33,010
Vincent<font color="#CCCCCC"> Matoo thank you very much for DC</font>

709
00:26:30,250 --> 00:26:35,440
sync they can synchronize the ntlm or

710
00:26:33,010 --> 00:26:38,110
<font color="#E5E5E5">AES or whatever credential material from</font>

711
00:26:35,440 --> 00:26:39,549
the domain controller so we'll show<font color="#CCCCCC"> you</font>

712
00:26:38,110 --> 00:26:40,658
a demo<font color="#E5E5E5"> neguin with all these case</font>

713
00:26:39,549 --> 00:26:42,399
studies we're going to start off simple

714
00:26:40,659 --> 00:26:46,570
<font color="#E5E5E5">and we're going to get pretty crazy by</font>

715
00:26:42,399 --> 00:26:49,479
the<font color="#E5E5E5"> end</font><font color="#CCCCCC"> okay</font>

716
00:26:46,570 --> 00:26:51,158
so walking<font color="#E5E5E5"> through this all executed</font><font color="#CCCCCC"> a</font>

717
00:26:49,480 --> 00:26:53,260
<font color="#E5E5E5">CL</font><font color="#CCCCCC"> base</font><font color="#E5E5E5"> from one pivot point we're going</font>

718
00:26:51,159 --> 00:26:55,390
to import Power View<font color="#E5E5E5"> and we're going to</font>

719
00:26:53,260 --> 00:26:57,010
use this bad guy users or<font color="#E5E5E5"> principle he's</font>

720
00:26:55,390 --> 00:26:57,650
our attacker<font color="#E5E5E5"> so first we're going to</font>

721
00:26:57,010 --> 00:26:59,360
<font color="#E5E5E5">show</font><font color="#CCCCCC"> that</font>

722
00:26:57,650 --> 00:27:01,550
guarantee this bad guy user is<font color="#CCCCCC"> a no</font>

723
00:26:59,360 --> 00:27:03,740
<font color="#CCCCCC">privilege groups each s</font><font color="#E5E5E5"> in the domain</font>

724
00:27:01,550 --> 00:27:05,930
users<font color="#E5E5E5"> default group we're going to save</font>

725
00:27:03,740 --> 00:27:07,070
off the<font color="#CCCCCC"> SID of this bad guy and then</font>

726
00:27:05,930 --> 00:27:09,560
we're going<font color="#CCCCCC"> to enumerate the current</font>

727
00:27:07,070 --> 00:27:11,300
ACLs of the domain object filtering for

728
00:27:09,560 --> 00:27:13,460
that<font color="#E5E5E5"> Sid just to show you there</font><font color="#CCCCCC"> are no</font>

729
00:27:11,300 --> 00:27:13,970
explicit<font color="#E5E5E5"> aces on the domain</font><font color="#CCCCCC"> for that</font>

730
00:27:13,460 --> 00:27:16,310
user

731
00:27:13,970 --> 00:27:18,350
now using<font color="#E5E5E5"> Power View</font><font color="#CCCCCC"> ad the main</font><font color="#E5E5E5"> object</font>

732
00:27:16,310 --> 00:27:21,379
ACL<font color="#CCCCCC"> we are going to grant bad guide the</font>

733
00:27:18,350 --> 00:27:23,990
rights<font color="#E5E5E5"> to DC sync on the domain object</font>

734
00:27:21,380 --> 00:27:26,420
and again you need domain<font color="#E5E5E5"> admin rights</font>

735
00:27:23,990 --> 00:27:31,220
to implement<font color="#E5E5E5"> this backdoor we're going</font>

736
00:27:26,420 --> 00:27:33,320
to<font color="#E5E5E5"> ensure the rights are set and now</font>

737
00:27:31,220 --> 00:27:35,210
we're going to oh yet you see DF

738
00:27:33,320 --> 00:27:36,980
replication get changes all that<font color="#E5E5E5"> Sid</font>

739
00:27:35,210 --> 00:27:39,740
matches so our<font color="#CCCCCC"> attacker now has the</font>

740
00:27:36,980 --> 00:27:41,420
rights to DC sync any account in the

741
00:27:39,740 --> 00:27:43,760
entire<font color="#E5E5E5"> domain</font><font color="#CCCCCC"> I'm going to switch over</font>

742
00:27:41,420 --> 00:27:45,140
<font color="#CCCCCC">and you see up here</font><font color="#E5E5E5"> I have a context</font>

743
00:27:43,760 --> 00:27:47,150
<font color="#CCCCCC">ocation right in the context of bad guy</font>

744
00:27:45,140 --> 00:27:48,980
<font color="#E5E5E5">I tried to DC sync previously I got</font>

745
00:27:47,150 --> 00:27:51,200
nothing but<font color="#E5E5E5"> now</font><font color="#CCCCCC"> after</font><font color="#E5E5E5"> I implement the</font>

746
00:27:48,980 --> 00:27:54,620
backdoor<font color="#CCCCCC"> I</font><font color="#E5E5E5"> have the</font><font color="#CCCCCC"> ability to</font><font color="#E5E5E5"> get this</font>

747
00:27:51,200 --> 00:28:01,790
sensitive key material so kind of<font color="#E5E5E5"> cool</font>

748
00:27:54,620 --> 00:28:03,770
<font color="#E5E5E5">nothing too crazy yet alright so the</font>

749
00:28:01,790 --> 00:28:05,990
next<font color="#E5E5E5"> one we won't go into all the detail</font>

750
00:28:03,770 --> 00:28:07,790
for<font color="#E5E5E5"> MSD holder but a quick summary is it</font>

751
00:28:05,990 --> 00:28:10,640
essentially functions as a permission

752
00:28:07,790 --> 00:28:12,710
template for sensitive accounts so the

753
00:28:10,640 --> 00:28:15,050
backdoor is<font color="#CCCCCC"> an</font><font color="#E5E5E5"> attacker grant either</font>

754
00:28:12,710 --> 00:28:17,120
force change password generic<font color="#CCCCCC"> all on the</font>

755
00:28:15,050 --> 00:28:19,399
admin SD holder object<font color="#CCCCCC"> that's very</font>

756
00:28:17,120 --> 00:28:21,139
<font color="#E5E5E5">special</font><font color="#CCCCCC"> object in Active Directory then</font>

757
00:28:19,400 --> 00:28:22,550
every 60<font color="#CCCCCC"> minutes a special process</font>

758
00:28:21,140 --> 00:28:25,310
<font color="#E5E5E5">called the security descriptor</font>

759
00:28:22,550 --> 00:28:27,260
propagator process or SD prop will run

760
00:28:25,310 --> 00:28:29,840
and I'll take the permissions<font color="#E5E5E5"> that are</font>

761
00:28:27,260 --> 00:28:31,850
<font color="#E5E5E5">on Aven SD holder and it'll take those</font>

762
00:28:29,840 --> 00:28:33,169
and<font color="#E5E5E5"> clone them to every single protected</font>

763
00:28:31,850 --> 00:28:35,300
user and group<font color="#E5E5E5"> in Active Directory</font>

764
00:28:33,170 --> 00:28:37,460
<font color="#E5E5E5">enterprise admin the counter operators</font>

765
00:28:35,300 --> 00:28:39,830
domain admins<font color="#E5E5E5"> you know things that</font><font color="#CCCCCC"> are</font>

766
00:28:37,460 --> 00:28:42,830
usually<font color="#E5E5E5"> identified by admin count equals</font>

767
00:28:39,830 --> 00:28:44,780
<font color="#CCCCCC">one then the attacker hides</font><font color="#E5E5E5"> their</font>

768
00:28:42,830 --> 00:28:46,189
account their<font color="#E5E5E5"> principal their own their</font>

769
00:28:44,780 --> 00:28:48,590
own<font color="#E5E5E5"> account using</font><font color="#CCCCCC"> the methods described</font>

770
00:28:46,190 --> 00:28:50,930
<font color="#E5E5E5">so to execute the attacker</font><font color="#CCCCCC"> just whenever</font>

771
00:28:48,590 --> 00:28:52,459
<font color="#E5E5E5">they want five years from now force</font>

772
00:28:50,930 --> 00:28:55,370
resets the password for any<font color="#E5E5E5"> domain</font>

773
00:28:52,460 --> 00:28:56,660
administrator<font color="#CCCCCC"> in the entire domain</font><font color="#E5E5E5"> and</font>

774
00:28:55,370 --> 00:29:02,030
the cool thing<font color="#CCCCCC"> with</font><font color="#E5E5E5"> that</font><font color="#CCCCCC"> Mineski holder</font>

775
00:28:56,660 --> 00:29:04,010
is if defenders find the you know that

776
00:29:02,030 --> 00:29:05,750
backdoor<font color="#CCCCCC"> r1</font><font color="#E5E5E5"> domain admin if they don't</font>

777
00:29:04,010 --> 00:29:07,280
fix<font color="#E5E5E5"> it on</font><font color="#CCCCCC"> the MSD holder and they</font><font color="#E5E5E5"> aren't</font>

778
00:29:05,750 --> 00:29:09,670
aware<font color="#E5E5E5"> of it then</font><font color="#CCCCCC"> FC prop will just go</font>

779
00:29:07,280 --> 00:29:11,330
put the backdoor back in for you<font color="#CCCCCC"> so</font>

780
00:29:09,670 --> 00:29:12,889
<font color="#CCCCCC">again</font>

781
00:29:11,330 --> 00:29:15,019
<font color="#E5E5E5">we're starting from</font><font color="#CCCCCC"> a</font><font color="#E5E5E5"> different use of</font>

782
00:29:12,889 --> 00:29:16,729
<font color="#E5E5E5">this time</font><font color="#CCCCCC"> bag guy to load up</font><font color="#E5E5E5"> our view do</font>

783
00:29:15,019 --> 00:29:18,470
the same steps<font color="#E5E5E5"> we're going to show the</font>

784
00:29:16,730 --> 00:29:20,480
<font color="#CCCCCC">oh you location</font><font color="#E5E5E5"> for the bad guys users</font>

785
00:29:18,470 --> 00:29:22,940
<font color="#E5E5E5">totes not evolve</font><font color="#CCCCCC"> so this is so we</font><font color="#E5E5E5"> can</font>

786
00:29:20,480 --> 00:29:25,369
hide it later<font color="#E5E5E5"> on from enumeration now</font>

787
00:29:22,940 --> 00:29:27,529
we're going to grant the bad guy - all

788
00:29:25,369 --> 00:29:30,678
rights generic all rights on to the

789
00:29:27,529 --> 00:29:34,340
admin<font color="#CCCCCC"> SD holder object</font><font color="#E5E5E5"> using again Power</font>

790
00:29:30,679 --> 00:29:36,739
<font color="#E5E5E5">View for</font><font color="#CCCCCC"> ad</font><font color="#E5E5E5"> domain object ACL then we're</font>

791
00:29:34,340 --> 00:29:38,209
going to change the owner a bad guy<font color="#CCCCCC"> -</font><font color="#E5E5E5"> -</font>

792
00:29:36,739 --> 00:29:39,799
to himself so the first part<font color="#CCCCCC"> was</font><font color="#E5E5E5"> the</font>

793
00:29:38,210 --> 00:29:41,809
<font color="#CCCCCC">backdoor</font><font color="#E5E5E5"> and now we're going to hide the</font>

794
00:29:39,799 --> 00:29:43,070
<font color="#CCCCCC">principle so change the</font><font color="#E5E5E5"> owner we're</font>

795
00:29:41,809 --> 00:29:44,809
going to get<font color="#E5E5E5"> some pointer basically some</font>

796
00:29:43,070 --> 00:29:47,960
<font color="#E5E5E5">references the raw objects of the user</font>

797
00:29:44,809 --> 00:29:49,908
<font color="#CCCCCC">and</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> owe you then we're going to add</font>

798
00:29:47,960 --> 00:29:53,179
a custom ace that<font color="#CCCCCC"> did</font><font color="#E5E5E5"> not I see everyone</font>

799
00:29:49,909 --> 00:29:55,999
said<font color="#CCCCCC"> s110 the right to enumerate the</font>

800
00:29:53,179 --> 00:29:58,039
object itself directly so if we do this

801
00:29:55,999 --> 00:29:59,840
<font color="#E5E5E5">and leave</font><font color="#CCCCCC"> it now EE</font><font color="#E5E5E5"> Nevins could still</font>

802
00:29:58,039 --> 00:30:01,549
see the<font color="#E5E5E5"> existence of the object</font><font color="#CCCCCC"> in a</font><font color="#E5E5E5"> dog</font>

803
00:29:59,840 --> 00:30:03,649
but they couldn't<font color="#E5E5E5"> interact with it now</font>

804
00:30:01,549 --> 00:30:06,350
we're going to deny everyone the right

805
00:30:03,649 --> 00:30:09,109
to list the children of the<font color="#CCCCCC"> owe you that</font>

806
00:30:06,350 --> 00:30:12,590
the user is a part of so deny<font color="#E5E5E5"> list</font>

807
00:30:09,109 --> 00:30:14,869
children<font color="#E5E5E5"> that same s110 we're going to</font>

808
00:30:12,590 --> 00:30:18,168
commit those changes<font color="#E5E5E5"> we're going to wait</font>

809
00:30:14,869 --> 00:30:20,238
60 minutes<font color="#E5E5E5"> for SD prop to run we're back</font>

810
00:30:18,169 --> 00:30:22,789
<font color="#E5E5E5">we're going to check if those rights</font>

811
00:30:20,239 --> 00:30:25,850
propagated to<font color="#CCCCCC"> a domain</font><font color="#E5E5E5"> admin named</font><font color="#CCCCCC"> EA we</font>

812
00:30:22,789 --> 00:30:27,408
see<font color="#E5E5E5"> okay</font><font color="#CCCCCC"> we see the SID 1 173 now domain</font>

813
00:30:25,850 --> 00:30:32,449
admins could still enumerate the deckle

814
00:30:27,409 --> 00:30:35,330
on this but the domain admin cannot find

815
00:30:32,450 --> 00:30:37,850
the bad guy<font color="#CCCCCC"> to through LDAP searching</font><font color="#E5E5E5"> it</font>

816
00:30:35,330 --> 00:30:39,739
just it's not there<font color="#E5E5E5"> now</font><font color="#CCCCCC"> I'm the refresh</font>

817
00:30:37,850 --> 00:30:40,639
and a duck<font color="#E5E5E5"> and</font><font color="#CCCCCC"> that guy disappeared even</font>

818
00:30:39,739 --> 00:30:43,070
though he's still<font color="#E5E5E5"> there</font>

819
00:30:40,639 --> 00:30:45,469
<font color="#E5E5E5">I can still log in as him and I still</font>

820
00:30:43,070 --> 00:30:47,779
have the<font color="#CCCCCC"> ability now</font><font color="#E5E5E5"> to use bad guy to</font>

821
00:30:45,470 --> 00:30:50,210
to force<font color="#CCCCCC"> reset</font><font color="#E5E5E5"> the domain admin password</font>

822
00:30:47,779 --> 00:30:53,929
using<font color="#E5E5E5"> Power View</font><font color="#CCCCCC"> again and now I can do</font>

823
00:30:50,210 --> 00:30:55,879
a run as for the<font color="#E5E5E5"> DA and log back in and</font>

824
00:30:53,929 --> 00:30:57,679
I can do this<font color="#E5E5E5"> for any protected user in</font>

825
00:30:55,879 --> 00:30:59,988
the entire domain<font color="#E5E5E5"> and then don't like</font>

826
00:30:57,679 --> 00:31:01,700
you even try to<font color="#E5E5E5"> resolve the SID</font><font color="#CCCCCC"> though</font>

827
00:30:59,989 --> 00:31:03,950
my name<font color="#CCCCCC"> is can't even resolve the SID</font>

828
00:31:01,700 --> 00:31:05,359
for<font color="#E5E5E5"> this in the</font><font color="#CCCCCC"> principle kind</font><font color="#E5E5E5"> of cool</font>

829
00:31:03,950 --> 00:31:07,960
little little cool or<font color="#E5E5E5"> right using some</font>

830
00:31:05,359 --> 00:31:07,960
Mostel<font color="#E5E5E5"> fremitus</font>

831
00:31:11,830 --> 00:31:16,330
<font color="#CCCCCC">all</font><font color="#E5E5E5"> right that was expectation all right</font>

832
00:31:14,830 --> 00:31:18,279
<font color="#E5E5E5">two laps</font><font color="#CCCCCC"> we don't have a</font><font color="#E5E5E5"> video for this</font>

833
00:31:16,330 --> 00:31:19,510
one but<font color="#CCCCCC"> lapses microsoft local</font>

834
00:31:18,279 --> 00:31:21,580
administrator password solution like

835
00:31:19,510 --> 00:31:23,110
Andy mentioned<font color="#E5E5E5"> it's basically a set of</font>

836
00:31:21,580 --> 00:31:25,059
<font color="#E5E5E5">client-side extension than schema</font>

837
00:31:23,110 --> 00:31:27,250
extensions that<font color="#E5E5E5"> allow the computer to</font>

838
00:31:25,059 --> 00:31:29,110
change its<font color="#CCCCCC"> password to a writ local</font><font color="#E5E5E5"> I'm</font>

839
00:31:27,250 --> 00:31:31,830
and password<font color="#CCCCCC"> to a random value every 30</font>

840
00:31:29,110 --> 00:31:34,479
days<font color="#E5E5E5"> and then it stores</font><font color="#CCCCCC"> that in that MS</font>

841
00:31:31,830 --> 00:31:36,668
<font color="#CCCCCC">MTS admin password attribute that's</font>

842
00:31:34,480 --> 00:31:39,340
protected by<font color="#E5E5E5"> des control access</font><font color="#CCCCCC"> it's</font>

843
00:31:36,669 --> 00:31:41,140
administered by these admin<font color="#E5E5E5"> PWD</font><font color="#CCCCCC"> PS</font>

844
00:31:39,340 --> 00:31:43,389
<font color="#CCCCCC">command lights there's a specific</font>

845
00:31:41,140 --> 00:31:45,370
function<font color="#E5E5E5"> that they provide called find</font>

846
00:31:43,390 --> 00:31:49,139
<font color="#CCCCCC">Aven PWD extended</font><font color="#E5E5E5"> rights which you can</font>

847
00:31:45,370 --> 00:31:51,549
audit<font color="#E5E5E5"> who actually has these</font><font color="#CCCCCC"> MS mcs</font><font color="#E5E5E5"> so</font>

848
00:31:49,139 --> 00:31:54,760
the problem is<font color="#CCCCCC"> this command lit was</font>

849
00:31:51,549 --> 00:31:56,379
built to enumerate the typical ways

850
00:31:54,760 --> 00:31:57,879
these rights<font color="#E5E5E5"> are delegated through</font>

851
00:31:56,380 --> 00:31:59,889
normal processes and<font color="#CCCCCC"> Active Directory</font>

852
00:31:57,880 --> 00:32:02,080
<font color="#E5E5E5">which makes sense it was not meant as a</font>

853
00:31:59,889 --> 00:32:04,539
security<font color="#E5E5E5"> audit type protection it was</font>

854
00:32:02,080 --> 00:32:06,789
meant as oh you you ran through normal

855
00:32:04,539 --> 00:32:08,408
delegation for laps and you found<font color="#CCCCCC"> okay</font>

856
00:32:06,789 --> 00:32:12,029
you know here here's who you<font color="#CCCCCC"> actually</font>

857
00:32:08,409 --> 00:32:14,740
<font color="#E5E5E5">delegate it to so here is actually the</font>

858
00:32:12,029 --> 00:32:15,820
<font color="#E5E5E5">not comprehensive list because we found</font>

859
00:32:14,740 --> 00:32:17,679
some a little<font color="#CCCCCC"> bit more after we</font>

860
00:32:15,820 --> 00:32:20,260
<font color="#E5E5E5">submitted the slides and the</font><font color="#CCCCCC"> white paper</font>

861
00:32:17,679 --> 00:32:21,850
<font color="#CCCCCC">actually is updated for</font><font color="#E5E5E5"> it but these are</font>

862
00:32:20,260 --> 00:32:24,220
<font color="#CCCCCC">most of</font><font color="#E5E5E5"> the cases</font><font color="#CCCCCC"> where someone</font><font color="#E5E5E5"> has the</font>

863
00:32:21,850 --> 00:32:25,959
ability to read<font color="#E5E5E5"> the admin password you</font>

864
00:32:24,220 --> 00:32:27,690
have<font color="#E5E5E5"> the ideas control</font><font color="#CCCCCC"> access and</font>

865
00:32:25,960 --> 00:32:29,679
there's several like inheritance cases

866
00:32:27,690 --> 00:32:31,690
<font color="#E5E5E5">generic all because that's going to</font>

867
00:32:29,679 --> 00:32:33,279
<font color="#CCCCCC">apply all these extended</font><font color="#E5E5E5"> rights and then</font>

868
00:32:31,690 --> 00:32:33,730
<font color="#CCCCCC">object control</font><font color="#E5E5E5"> you know are you the</font>

869
00:32:33,279 --> 00:32:35,440
<font color="#E5E5E5">owner</font>

870
00:32:33,730 --> 00:32:38,529
can you<font color="#E5E5E5"> modify the DAC</font><font color="#CCCCCC"> own can</font><font color="#E5E5E5"> you</font>

871
00:32:35,440 --> 00:32:40,510
<font color="#E5E5E5">modify the owner unfortunately the</font>

872
00:32:38,529 --> 00:32:41,889
official command<font color="#CCCCCC"> --let misses a couple</font>

873
00:32:40,510 --> 00:32:45,279
of things there's a couple<font color="#E5E5E5"> logic flaws</font>

874
00:32:41,889 --> 00:32:46,840
so des control<font color="#CCCCCC"> access if it's there on</font>

875
00:32:45,279 --> 00:32:48,519
the<font color="#CCCCCC"> oh you</font><font color="#E5E5E5"> once inherited if it's</font>

876
00:32:46,840 --> 00:32:49,959
inherited<font color="#E5E5E5"> to all descendant objects</font>

877
00:32:48,519 --> 00:32:52,779
<font color="#E5E5E5">instead of just computers that is not</font>

878
00:32:49,960 --> 00:32:55,059
checked for the owner isn't<font color="#E5E5E5"> checked for</font>

879
00:32:52,779 --> 00:32:58,419
<font color="#CCCCCC">then</font><font color="#E5E5E5"> right dackel and right owner isn't</font>

880
00:32:55,059 --> 00:33:00,610
<font color="#E5E5E5">checked for and also it</font><font color="#CCCCCC"> only analyzes oh</font>

881
00:32:58,419 --> 00:33:02,620
use and optionally computer objects<font color="#CCCCCC"> in</font>

882
00:33:00,610 --> 00:33:04,360
those<font color="#CCCCCC"> OU's it does not analyze the</font>

883
00:33:02,620 --> 00:33:06,639
default container for users and

884
00:33:04,360 --> 00:33:10,870
<font color="#E5E5E5">computers so you</font><font color="#CCCCCC"> know those can still</font>

885
00:33:06,639 --> 00:33:13,269
have<font color="#CCCCCC"> labs installed so example</font><font color="#E5E5E5"> a normal</font>

886
00:33:10,870 --> 00:33:14,830
user can't read the<font color="#CCCCCC"> MSMC s admin</font>

887
00:33:13,269 --> 00:33:17,740
password this<font color="#E5E5E5"> is what we want this is</font>

888
00:33:14,830 --> 00:33:19,029
normal so<font color="#E5E5E5"> we had John Smith you know he</font>

889
00:33:17,740 --> 00:33:20,500
can't at the bottom there get the main

890
00:33:19,029 --> 00:33:22,090
computer<font color="#E5E5E5"> for exchange he can't actually</font>

891
00:33:20,500 --> 00:33:23,980
read the password and you see<font color="#E5E5E5"> running</font>

892
00:33:22,090 --> 00:33:25,158
that lapse command let<font color="#CCCCCC"> define admin</font>

893
00:33:23,980 --> 00:33:26,509
password rights for

894
00:33:25,159 --> 00:33:27,979
servers you see under extended

895
00:33:26,509 --> 00:33:31,190
<font color="#E5E5E5">rightsholders we have system domain</font>

896
00:33:27,979 --> 00:33:33,049
admins and server admins so that shows

897
00:33:31,190 --> 00:33:34,489
that<font color="#CCCCCC"> John</font><font color="#E5E5E5"> is not part of server admins</font>

898
00:33:33,049 --> 00:33:37,970
because he doesn't<font color="#CCCCCC"> have that</font><font color="#E5E5E5"> group</font>

899
00:33:34,489 --> 00:33:39,799
delegated right now we had a malicious

900
00:33:37,970 --> 00:33:41,539
<font color="#CCCCCC">ace</font><font color="#E5E5E5"> entry and again this it's a lot of</font>

901
00:33:39,799 --> 00:33:43,700
text<font color="#E5E5E5"> we explain it step</font><font color="#CCCCCC"> by step in the</font>

902
00:33:41,539 --> 00:33:45,739
white paper<font color="#E5E5E5"> we're going to add</font><font color="#CCCCCC"> a</font>

903
00:33:43,700 --> 00:33:47,809
specifically crafted<font color="#E5E5E5"> ace that exploits</font>

904
00:33:45,739 --> 00:33:50,419
<font color="#E5E5E5">the inheritance flaw we're going to add</font>

905
00:33:47,809 --> 00:33:53,899
this to<font color="#E5E5E5"> the Oh you so this is going to</font>

906
00:33:50,419 --> 00:33:55,940
<font color="#E5E5E5">propagate down</font><font color="#CCCCCC"> and now a domain user</font><font color="#E5E5E5"> at</font>

907
00:33:53,899 --> 00:33:58,639
the bottom there<font color="#CCCCCC"> that same guy John</font>

908
00:33:55,940 --> 00:34:01,700
Smith can read the local<font color="#E5E5E5"> laps password</font>

909
00:33:58,639 --> 00:34:03,709
for any<font color="#E5E5E5"> computer in</font><font color="#CCCCCC"> that oh you but the</font>

910
00:34:01,700 --> 00:34:06,559
official commandlets<font color="#E5E5E5"> don't actually show</font>

911
00:34:03,710 --> 00:34:09,619
<font color="#E5E5E5">John Smith is actually showing up as a</font>

912
00:34:06,559 --> 00:34:11,929
delegated<font color="#E5E5E5"> you know access holder so you</font>

913
00:34:09,619 --> 00:34:13,429
could set this right to these computers

914
00:34:11,929 --> 00:34:14,720
<font color="#E5E5E5">that have laps installed and everyone</font>

915
00:34:13,429 --> 00:34:16,789
thinks<font color="#E5E5E5"> it's protected and your</font>

916
00:34:14,719 --> 00:34:18,500
administrator<font color="#E5E5E5"> or your attacker account</font>

917
00:34:16,789 --> 00:34:20,149
has the ability to read<font color="#CCCCCC"> the local</font><font color="#E5E5E5"> admin</font>

918
00:34:18,500 --> 00:34:25,219
password<font color="#CCCCCC"> Andrey compromised any of</font><font color="#E5E5E5"> those</font>

919
00:34:20,149 --> 00:34:26,690
machines<font color="#CCCCCC"> that will ok</font><font color="#E5E5E5"> so I'm a little</font>

920
00:34:25,219 --> 00:34:29,118
<font color="#CCCCCC">bit biased but</font><font color="#E5E5E5"> this is my favorite one</font>

921
00:34:26,690 --> 00:34:31,190
this has<font color="#E5E5E5"> my philosophy this has to do</font>

922
00:34:29,119 --> 00:34:33,260
with<font color="#E5E5E5"> some the exchange server</font>

923
00:34:31,190 --> 00:34:35,629
installation process<font color="#E5E5E5"> which if you've</font>

924
00:34:33,260 --> 00:34:37,579
<font color="#CCCCCC">ever done that you know how challenging</font>

925
00:34:35,629 --> 00:34:40,190
that can potentially be<font color="#E5E5E5"> especially the</font>

926
00:34:37,579 --> 00:34:42,220
upgrade process<font color="#CCCCCC"> so when you install</font>

927
00:34:40,190 --> 00:34:44,839
exchange server multiple things happen

928
00:34:42,219 --> 00:34:46,578
<font color="#CCCCCC">exchange as many security</font><font color="#E5E5E5"> groups of the</font>

929
00:34:44,839 --> 00:34:47,328
domain it extends the<font color="#E5E5E5"> Active Directory</font>

930
00:34:46,579 --> 00:34:49,639
<font color="#E5E5E5">schema</font>

931
00:34:47,329 --> 00:34:51,909
it adds properties to several different

932
00:34:49,639 --> 00:34:55,399
object classes in Active Directory<font color="#CCCCCC"> and</font>

933
00:34:51,909 --> 00:34:58,069
it gives itself full control over

934
00:34:55,399 --> 00:35:01,069
several<font color="#E5E5E5"> objects in Active Directory</font><font color="#CCCCCC"> used</font>

935
00:34:58,069 --> 00:35:03,650
to be including the<font color="#CCCCCC"> admin FC holder the</font>

936
00:35:01,069 --> 00:35:07,460
domain object domain admins group<font color="#CCCCCC"> etc</font>

937
00:35:03,650 --> 00:35:11,150
now with<font color="#E5E5E5"> exchange 2016 with exchange</font>

938
00:35:07,460 --> 00:35:14,299
2013<font color="#CCCCCC"> and with exchange 2007</font><font color="#E5E5E5"> sp1</font><font color="#CCCCCC"> and</font>

939
00:35:11,150 --> 00:35:16,220
forward<font color="#CCCCCC"> it's every object in the domain</font>

940
00:35:14,299 --> 00:35:17,869
has it has full<font color="#CCCCCC"> control over with the</font>

941
00:35:16,220 --> 00:35:19,279
exception of anything that has<font color="#E5E5E5"> that</font>

942
00:35:17,869 --> 00:35:21,049
admin count equals<font color="#E5E5E5"> one</font>

943
00:35:19,279 --> 00:35:26,960
so anything protected by<font color="#E5E5E5"> a</font><font color="#CCCCCC"> man SD hole</font>

944
00:35:21,049 --> 00:35:29,480
right<font color="#E5E5E5"> exactly</font><font color="#CCCCCC"> yep so before 2007 sp1</font>

945
00:35:26,960 --> 00:35:31,520
<font color="#CCCCCC">Exchange gave itself</font><font color="#E5E5E5"> right tackle to</font><font color="#CCCCCC"> the</font>

946
00:35:29,480 --> 00:35:33,920
domain object<font color="#E5E5E5"> and we have seen in</font>

947
00:35:31,520 --> 00:35:35,869
multiple real environments where these

948
00:35:33,920 --> 00:35:38,030
groups have full<font color="#E5E5E5"> control of everything</font>

949
00:35:35,869 --> 00:35:42,110
<font color="#E5E5E5">including the domain object including</font>

950
00:35:38,030 --> 00:35:43,700
admins group so here's how this<font color="#CCCCCC"> backdoor</font>

951
00:35:42,110 --> 00:35:45,380
works<font color="#E5E5E5"> what we're going</font><font color="#CCCCCC"> to do we're going</font>

952
00:35:43,700 --> 00:35:46,939
<font color="#CCCCCC">to ride the existing privilege that</font>

953
00:35:45,380 --> 00:35:49,220
<font color="#CCCCCC">Exchange has and we're going to backdoor</font>

954
00:35:46,940 --> 00:35:51,440
<font color="#E5E5E5">an object that</font><font color="#CCCCCC"> has the</font><font color="#E5E5E5"> same privilege</font>

955
00:35:49,220 --> 00:35:53,259
<font color="#CCCCCC">bike security of your delegation</font><font color="#E5E5E5"> so this</font>

956
00:35:51,440 --> 00:35:55,640
is<font color="#E5E5E5"> going to be</font><font color="#CCCCCC"> extremely</font><font color="#E5E5E5"> hard to find</font>

957
00:35:53,260 --> 00:35:58,190
<font color="#E5E5E5">first of all we're going to find one of</font>

958
00:35:55,640 --> 00:36:00,230
these<font color="#E5E5E5"> non protected security groups that</font>

959
00:35:58,190 --> 00:36:02,810
<font color="#E5E5E5">has local admin rights</font><font color="#CCCCCC"> onto an</font><font color="#E5E5E5"> exchange</font>

960
00:36:00,230 --> 00:36:04,490
server the exchange servers when you

961
00:36:02,810 --> 00:36:05,810
install<font color="#CCCCCC"> exchange server in Active</font>

962
00:36:04,490 --> 00:36:08,569
Directory they're added<font color="#CCCCCC"> to a group</font>

963
00:36:05,810 --> 00:36:10,820
called<font color="#E5E5E5"> exchange</font><font color="#CCCCCC"> secure the exchange</font>

964
00:36:08,570 --> 00:36:11,420
<font color="#E5E5E5">trusted the exchange trusted subsystem</font>

965
00:36:10,820 --> 00:36:14,780
<font color="#E5E5E5">yeah</font>

966
00:36:11,420 --> 00:36:17,180
the<font color="#E5E5E5"> mouthful</font><font color="#CCCCCC"> that group</font><font color="#E5E5E5"> then</font><font color="#CCCCCC"> will have</font>

967
00:36:14,780 --> 00:36:19,550
all of<font color="#CCCCCC"> that</font><font color="#E5E5E5"> control and active directory</font>

968
00:36:17,180 --> 00:36:21,350
that<font color="#E5E5E5"> of the numerating before we're</font>

969
00:36:19,550 --> 00:36:23,510
going<font color="#E5E5E5"> to grant authenticated users full</font>

970
00:36:21,350 --> 00:36:26,080
control over<font color="#CCCCCC"> that security group that</font>

971
00:36:23,510 --> 00:36:28,370
<font color="#CCCCCC">has admin rights to the exchange server</font>

972
00:36:26,080 --> 00:36:32,000
we're<font color="#E5E5E5"> going to change the owner of the</font>

973
00:36:28,370 --> 00:36:34,009
group to<font color="#E5E5E5"> the exchange server and then</font>

974
00:36:32,000 --> 00:36:36,080
we're<font color="#E5E5E5"> going to deny read permissions on</font>

975
00:36:34,010 --> 00:36:39,500
that group to the everyone principle so

976
00:36:36,080 --> 00:36:41,000
nobody's going<font color="#CCCCCC"> to be</font><font color="#E5E5E5"> able to see what</font>

977
00:36:39,500 --> 00:36:44,270
the dackel is on this<font color="#E5E5E5"> group that we just</font>

978
00:36:41,000 --> 00:36:45,410
<font color="#E5E5E5">backdoored so how do we</font><font color="#CCCCCC"> execute this</font>

979
00:36:44,270 --> 00:36:48,050
<font color="#E5E5E5">first of all we're going to regain</font>

980
00:36:45,410 --> 00:36:50,810
access<font color="#E5E5E5"> Active Directory we're going to</font>

981
00:36:48,050 --> 00:36:52,550
and we can do this<font color="#CCCCCC"> as any user</font><font color="#E5E5E5"> we're</font>

982
00:36:50,810 --> 00:36:55,190
going to add ourselves to that

983
00:36:52,550 --> 00:36:56,570
<font color="#CCCCCC">backdoored security group then we're</font>

984
00:36:55,190 --> 00:36:58,220
going to<font color="#CCCCCC"> we're going to</font><font color="#E5E5E5"> use</font><font color="#CCCCCC"> our newfound</font>

985
00:36:56,570 --> 00:37:01,820
local admin rights on<font color="#CCCCCC"> that exchange</font>

986
00:36:58,220 --> 00:37:03,439
<font color="#E5E5E5">server to execute commands as the system</font>

987
00:37:01,820 --> 00:37:05,630
user on that computer

988
00:37:03,440 --> 00:37:07,370
which when<font color="#E5E5E5"> you do that you have</font><font color="#CCCCCC"> the same</font>

989
00:37:05,630 --> 00:37:09,740
privileges that<font color="#E5E5E5"> the computer object in</font>

990
00:37:07,370 --> 00:37:11,089
Active Directory has<font color="#E5E5E5"> yeah so for any</font>

991
00:37:09,740 --> 00:37:12,770
network traffic<font color="#E5E5E5"> when you're</font><font color="#CCCCCC"> running</font><font color="#E5E5E5"> a</font>

992
00:37:11,090 --> 00:37:14,330
system<font color="#CCCCCC"> it's going to use the</font><font color="#E5E5E5"> computer</font>

993
00:37:12,770 --> 00:37:16,490
<font color="#E5E5E5">account for the actual l-dub traffic</font>

994
00:37:14,330 --> 00:37:18,170
<font color="#E5E5E5">executive directory and so like I said</font>

995
00:37:16,490 --> 00:37:19,669
<font color="#E5E5E5">because many times the exchange trusted</font>

996
00:37:18,170 --> 00:37:21,290
subsystem<font color="#CCCCCC"> has full control of everything</font>

997
00:37:19,670 --> 00:37:24,410
<font color="#E5E5E5">that means that the exchange server</font>

998
00:37:21,290 --> 00:37:29,420
itself<font color="#E5E5E5"> can DC sync so we have a video</font><font color="#CCCCCC"> of</font>

999
00:37:24,410 --> 00:37:32,060
this this one<font color="#E5E5E5"> it's pretty cool there's</font>

1000
00:37:29,420 --> 00:37:33,500
our<font color="#E5E5E5"> last video all</font><font color="#CCCCCC"> right so again</font><font color="#E5E5E5"> here's</font>

1001
00:37:32,060 --> 00:37:34,610
here's<font color="#E5E5E5"> the bloodhound interface and what</font>

1002
00:37:33,500 --> 00:37:35,840
we're going<font color="#CCCCCC"> to do is we're</font><font color="#E5E5E5"> going to find</font>

1003
00:37:34,610 --> 00:37:38,660
the security<font color="#CCCCCC"> group that we want to</font>

1004
00:37:35,840 --> 00:37:40,370
<font color="#E5E5E5">backdoor so the domain admins group</font>

1005
00:37:38,660 --> 00:37:42,910
<font color="#CCCCCC">we're going to look</font><font color="#E5E5E5"> at transitive object</font>

1006
00:37:40,370 --> 00:37:42,910
controllers

1007
00:37:44,480 --> 00:37:48,380
and here we have the exchange trusted

1008
00:37:46,760 --> 00:37:52,070
<font color="#E5E5E5">subsystem which is populated with the</font>

1009
00:37:48,380 --> 00:37:53,540
exchange servers then we will select<font color="#E5E5E5"> one</font>

1010
00:37:52,070 --> 00:37:54,920
<font color="#CCCCCC">of those exchange servers and we're</font>

1011
00:37:53,540 --> 00:37:56,450
going to see who it is<font color="#E5E5E5"> that has</font>

1012
00:37:54,920 --> 00:37:57,920
<font color="#E5E5E5">effective local admin rights against</font>

1013
00:37:56,450 --> 00:38:00,770
<font color="#E5E5E5">that box so we're going to we're going</font>

1014
00:37:57,920 --> 00:38:02,390
<font color="#CCCCCC">to</font><font color="#E5E5E5"> do exchange</font><font color="#CCCCCC"> 0 0 1</font><font color="#E5E5E5"> again this is how</font>

1015
00:38:00,770 --> 00:38:04,190
<font color="#CCCCCC">bloodhound</font><font color="#E5E5E5"> can</font><font color="#CCCCCC"> be used to plan these</font>

1016
00:38:02,390 --> 00:38:05,720
<font color="#E5E5E5">types of backdoors we're going to look</font>

1017
00:38:04,190 --> 00:38:09,050
<font color="#CCCCCC">at who the unrolled admins are against</font>

1018
00:38:05,720 --> 00:38:11,240
this box which there are<font color="#CCCCCC"> seven users</font>

1019
00:38:09,050 --> 00:38:13,040
that have<font color="#E5E5E5"> local admin rights going from</font>

1020
00:38:11,240 --> 00:38:14,299
right<font color="#E5E5E5"> to left that's the computer</font><font color="#CCCCCC"> then</font>

1021
00:38:13,040 --> 00:38:17,180
there's a group that<font color="#E5E5E5"> has Evan</font><font color="#CCCCCC"> rights</font>

1022
00:38:14,300 --> 00:38:19,190
<font color="#E5E5E5">then you can see a group</font><font color="#CCCCCC"> as belonging</font><font color="#E5E5E5"> to</font>

1023
00:38:17,180 --> 00:38:21,410
<font color="#CCCCCC">that group and then again there's a</font>

1024
00:38:19,190 --> 00:38:24,200
third group<font color="#CCCCCC"> that</font><font color="#E5E5E5"> belongs in this nested</font>

1025
00:38:21,410 --> 00:38:25,790
group structure<font color="#E5E5E5"> this group here server</font>

1026
00:38:24,200 --> 00:38:27,049
back<font color="#CCCCCC"> up to</font><font color="#E5E5E5"> here - this is the group that</font>

1027
00:38:25,790 --> 00:38:30,529
<font color="#E5E5E5">we're going to</font><font color="#CCCCCC"> backdoor</font><font color="#E5E5E5"> that's going to</font>

1028
00:38:27,050 --> 00:38:31,730
give<font color="#E5E5E5"> us access</font><font color="#CCCCCC"> to everything again we're</font>

1029
00:38:30,530 --> 00:38:33,140
going<font color="#E5E5E5"> to import Power View and we're</font>

1030
00:38:31,730 --> 00:38:35,960
doing<font color="#CCCCCC"> this</font><font color="#E5E5E5"> at the domain admin we're</font>

1031
00:38:33,140 --> 00:38:38,598
installing the backdoor we're going to

1032
00:38:35,960 --> 00:38:41,750
get the we're going<font color="#E5E5E5"> to the raw directory</font>

1033
00:38:38,599 --> 00:38:43,670
entry for the object<font color="#E5E5E5"> for the group we're</font>

1034
00:38:41,750 --> 00:38:47,869
going to grant<font color="#E5E5E5"> authenticated users full</font>

1035
00:38:43,670 --> 00:38:49,790
control of the<font color="#CCCCCC"> security group then we're</font>

1036
00:38:47,869 --> 00:38:52,250
going<font color="#E5E5E5"> to change the the owner of the</font>

1037
00:38:49,790 --> 00:38:53,480
object to an<font color="#CCCCCC"> exchange server just</font><font color="#E5E5E5"> the</font>

1038
00:38:52,250 --> 00:38:58,510
same<font color="#E5E5E5"> exchange server that we're going to</font>

1039
00:38:53,480 --> 00:39:00,770
be targeting<font color="#E5E5E5"> for our backdoor done and</font>

1040
00:38:58,510 --> 00:39:01,970
then finally we're<font color="#E5E5E5"> going to deny read</font>

1041
00:39:00,770 --> 00:39:03,890
permissions on this group of<font color="#E5E5E5"> the</font>

1042
00:39:01,970 --> 00:39:05,180
everyone<font color="#E5E5E5"> principles so this is an anti</font>

1043
00:39:03,890 --> 00:39:09,890
audit measure that<font color="#E5E5E5"> will make it</font>

1044
00:39:05,180 --> 00:39:11,990
<font color="#E5E5E5">difficult to find this backdoor now</font>

1045
00:39:09,890 --> 00:39:13,129
that's it because I<font color="#CCCCCC"> didn't hear</font><font color="#E5E5E5"> yeah we</font>

1046
00:39:11,990 --> 00:39:14,629
come back<font color="#E5E5E5"> a year</font><font color="#CCCCCC"> later we're on the</font>

1047
00:39:13,130 --> 00:39:16,609
computer called Windows<font color="#CCCCCC"> eight zero zero</font>

1048
00:39:14,630 --> 00:39:19,430
<font color="#CCCCCC">one</font><font color="#E5E5E5"> as some user called</font><font color="#CCCCCC"> Robbie</font>

1049
00:39:16,609 --> 00:39:21,078
Winchester because we have full<font color="#E5E5E5"> control</font>

1050
00:39:19,430 --> 00:39:22,899
<font color="#E5E5E5">of the server</font><font color="#CCCCCC"> backup to your</font><font color="#E5E5E5"> group we're</font>

1051
00:39:21,079 --> 00:39:26,480
going to add ourselves to that group

1052
00:39:22,900 --> 00:39:28,280
done now<font color="#E5E5E5"> we're going</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> use PS exec and</font>

1053
00:39:26,480 --> 00:39:30,740
we're going to<font color="#E5E5E5"> run mimic</font><font color="#CCCCCC"> hats</font><font color="#E5E5E5"> on the</font>

1054
00:39:28,280 --> 00:39:32,839
remote system<font color="#CCCCCC"> in the system user context</font>

1055
00:39:30,740 --> 00:39:36,078
there<font color="#E5E5E5"> are obviously better offset ways</font>

1056
00:39:32,839 --> 00:39:37,970
<font color="#E5E5E5">to do this now we are running as a</font>

1057
00:39:36,079 --> 00:39:39,349
system user on that exchange<font color="#E5E5E5"> system and</font>

1058
00:39:37,970 --> 00:39:42,169
we're going to use that<font color="#CCCCCC"> privilege to</font>

1059
00:39:39,349 --> 00:39:44,599
<font color="#E5E5E5">Kerber or to a DC sync the curb</font><font color="#CCCCCC"> TDT</font>

1060
00:39:42,170 --> 00:39:46,819
account and we're done<font color="#E5E5E5"> now we have the</font>

1061
00:39:44,599 --> 00:39:48,740
NT hash of the<font color="#CCCCCC"> curb TGT we can create a</font>

1062
00:39:46,819 --> 00:39:51,200
golden<font color="#E5E5E5"> ticket we own the entire domain</font>

1063
00:39:48,740 --> 00:39:52,669
<font color="#E5E5E5">it thanks again to Vincent and Benjamin</font>

1064
00:39:51,200 --> 00:39:55,299
yes sir<font color="#E5E5E5"> Thank You Vince it</font><font color="#CCCCCC"> lets</font><font color="#E5E5E5"> you and</font>

1065
00:39:52,670 --> 00:39:55,300
<font color="#E5E5E5">Benjamin Delfy</font>

1066
00:39:55,460 --> 00:39:59,360
<font color="#CCCCCC">all</font><font color="#E5E5E5"> right so there's one last scenario</font>

1067
00:39:57,410 --> 00:40:01,430
<font color="#E5E5E5">that we don't have a video for because</font>

1068
00:39:59,360 --> 00:40:05,120
it's so kind of<font color="#E5E5E5"> complex but I'll try to</font>

1069
00:40:01,430 --> 00:40:06,529
<font color="#E5E5E5">talk through it so again</font><font color="#CCCCCC"> you can</font><font color="#E5E5E5"> do</font>

1070
00:40:05,120 --> 00:40:08,990
change of<font color="#E5E5E5"> this stuff you can let your</font>

1071
00:40:06,530 --> 00:40:11,750
<font color="#CCCCCC">imagination go wild so the back door</font><font color="#E5E5E5"> for</font>

1072
00:40:08,990 --> 00:40:15,620
<font color="#E5E5E5">this is the attacker grants them his or</font>

1073
00:40:11,750 --> 00:40:17,270
<font color="#E5E5E5">her self generic all to any user in the</font>

1074
00:40:15,620 --> 00:40:19,100
domain<font color="#E5E5E5"> if that user doesn't have to be</font>

1075
00:40:17,270 --> 00:40:21,320
privileged it can be<font color="#E5E5E5"> anybody</font>

1076
00:40:19,100 --> 00:40:24,259
and then you grants<font color="#E5E5E5"> that kind of</font><font color="#CCCCCC"> patsy</font>

1077
00:40:21,320 --> 00:40:27,140
<font color="#CCCCCC">or proxy user right</font><font color="#E5E5E5"> dackel on the</font>

1078
00:40:24,260 --> 00:40:29,450
default domain controller<font color="#E5E5E5"> CP oh that's</font>

1079
00:40:27,140 --> 00:40:30,980
the entire backdoor so this what I like

1080
00:40:29,450 --> 00:40:34,220
about this<font color="#E5E5E5"> approach</font><font color="#CCCCCC"> of using</font><font color="#E5E5E5"> kind of a</font>

1081
00:40:30,980 --> 00:40:37,010
proxy<font color="#CCCCCC"> or Apache user is that even if</font>

1082
00:40:34,220 --> 00:40:40,129
instant responders are you know domain

1083
00:40:37,010 --> 00:40:42,410
admins<font color="#E5E5E5"> find the</font><font color="#CCCCCC"> backdoor for the right</font>

1084
00:40:40,130 --> 00:40:44,000
<font color="#E5E5E5">tackle</font><font color="#CCCCCC"> and domain controllers</font><font color="#E5E5E5"> GPO they</font>

1085
00:40:42,410 --> 00:40:46,040
would then<font color="#E5E5E5"> have</font><font color="#CCCCCC"> to walk</font><font color="#E5E5E5"> back</font><font color="#CCCCCC"> up saying</font>

1086
00:40:44,000 --> 00:40:47,900
<font color="#E5E5E5">oh is there actually a chained backdoor</font>

1087
00:40:46,040 --> 00:40:49,820
to this user<font color="#E5E5E5"> which is</font><font color="#CCCCCC"> what we have with</font>

1088
00:40:47,900 --> 00:40:51,590
generic all<font color="#E5E5E5"> you think about it you could</font>

1089
00:40:49,820 --> 00:40:53,450
go back seven levels<font color="#E5E5E5"> right you get a</font>

1090
00:40:51,590 --> 00:40:55,970
force reset passwords in generic<font color="#CCCCCC"> o all</font>

1091
00:40:53,450 --> 00:40:58,609
the<font color="#CCCCCC"> way down the line</font><font color="#E5E5E5"> so you have to</font>

1092
00:40:55,970 --> 00:40:59,689
model the<font color="#CCCCCC"> entire</font><font color="#E5E5E5"> system in order to find</font>

1093
00:40:58,610 --> 00:41:01,790
these<font color="#E5E5E5"> types of things because we're</font>

1094
00:40:59,690 --> 00:41:03,320
basically<font color="#E5E5E5"> building attack chains out and</font>

1095
00:41:01,790 --> 00:41:04,520
it's going<font color="#E5E5E5"> to get harder and harder</font><font color="#CCCCCC"> and</font>

1096
00:41:03,320 --> 00:41:05,960
<font color="#E5E5E5">harder</font><font color="#CCCCCC"> because</font><font color="#E5E5E5"> every time it's going to</font>

1097
00:41:04,520 --> 00:41:07,190
branch out<font color="#CCCCCC"> with possibilities and</font><font color="#E5E5E5"> they</font>

1098
00:41:05,960 --> 00:41:09,110
would have<font color="#E5E5E5"> to investigate every single</font>

1099
00:41:07,190 --> 00:41:12,650
option<font color="#E5E5E5"> so for execution</font>

1100
00:41:09,110 --> 00:41:14,320
the attacker<font color="#E5E5E5"> grant this proxy user</font><font color="#CCCCCC"> or</font>

1101
00:41:12,650 --> 00:41:18,050
they<font color="#CCCCCC"> they force reset their password</font>

1102
00:41:14,320 --> 00:41:20,090
<font color="#E5E5E5">then they use that access to add a new</font>

1103
00:41:18,050 --> 00:41:21,650
<font color="#CCCCCC">deckle to the GPO because they had that</font>

1104
00:41:20,090 --> 00:41:24,080
right back<font color="#E5E5E5"> hold permission so they add a</font>

1105
00:41:21,650 --> 00:41:27,170
new<font color="#E5E5E5"> dackel that grants the</font><font color="#CCCCCC"> Patsy user</font>

1106
00:41:24,080 --> 00:41:29,120
that<font color="#CCCCCC"> GPC files this path modification so</font>

1107
00:41:27,170 --> 00:41:31,010
we're using<font color="#E5E5E5"> we</font><font color="#CCCCCC"> have the ability to</font>

1108
00:41:29,120 --> 00:41:33,350
<font color="#CCCCCC">modify</font><font color="#E5E5E5"> the access control information</font>

1109
00:41:31,010 --> 00:41:35,210
<font color="#CCCCCC">and we're using that to grant ourselves</font>

1110
00:41:33,350 --> 00:41:38,240
the right to actually<font color="#E5E5E5"> modify the GPO</font>

1111
00:41:35,210 --> 00:41:40,640
itself then the attacker uses<font color="#E5E5E5"> that</font>

1112
00:41:38,240 --> 00:41:43,790
account to grant<font color="#E5E5E5"> SC</font><font color="#CCCCCC"> enabled delegation</font>

1113
00:41:40,640 --> 00:41:45,650
privilege<font color="#E5E5E5"> to the attacker</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> this is</font>

1114
00:41:43,790 --> 00:41:46,880
this<font color="#E5E5E5"> is I wrote some</font><font color="#CCCCCC"> stuff about this</font>

1115
00:41:45,650 --> 00:41:48,530
and there's some other information<font color="#E5E5E5"> about</font>

1116
00:41:46,880 --> 00:41:50,060
<font color="#E5E5E5">this for a constrained delegation type</font>

1117
00:41:48,530 --> 00:41:52,850
of tax don't have time to go into it but

1118
00:41:50,060 --> 00:41:54,470
super<font color="#E5E5E5"> super cool</font><font color="#CCCCCC"> button result is with</font>

1119
00:41:52,850 --> 00:41:56,330
that that GPO is<font color="#E5E5E5"> pushed</font><font color="#CCCCCC"> down the</font>

1120
00:41:54,470 --> 00:41:58,279
attacker user now has<font color="#CCCCCC"> se delegation</font>

1121
00:41:56,330 --> 00:42:02,540
<font color="#E5E5E5">privilege on the domain controller</font><font color="#CCCCCC"> and</font>

1122
00:41:58,280 --> 00:42:04,640
it can modify the MS allowed to delegate

1123
00:42:02,540 --> 00:42:07,070
to parameter and then they can use<font color="#CCCCCC"> mimic</font>

1124
00:42:04,640 --> 00:42:08,690
<font color="#CCCCCC">caps and kikyo to actually execute a</font>

1125
00:42:07,070 --> 00:42:11,210
constrained delegation attack and

1126
00:42:08,690 --> 00:42:12,980
then DC<font color="#CCCCCC"> sink or</font><font color="#E5E5E5"> gained complete access</font>

1127
00:42:11,210 --> 00:42:14,569
or you know<font color="#E5E5E5"> to the entire domain</font><font color="#CCCCCC"> andrey</font>

1128
00:42:12,980 --> 00:42:16,010
<font color="#E5E5E5">compromised a domain controller</font><font color="#CCCCCC"> but</font>

1129
00:42:14,569 --> 00:42:17,990
again<font color="#E5E5E5"> that's really subtle right it's</font>

1130
00:42:16,010 --> 00:42:20,000
<font color="#E5E5E5">just generic all you just need</font><font color="#CCCCCC"> rights to</font>

1131
00:42:17,990 --> 00:42:21,680
one user and<font color="#E5E5E5"> then you chain this stuff</font>

1132
00:42:20,000 --> 00:42:23,270
back and then one person<font color="#CCCCCC"> at the end of</font>

1133
00:42:21,680 --> 00:42:27,379
the chain<font color="#CCCCCC"> actually has the modification</font>

1134
00:42:23,270 --> 00:42:28,130
rights you care about<font color="#E5E5E5"> so defenses all is</font>

1135
00:42:27,380 --> 00:42:30,319
not lost

1136
00:42:28,130 --> 00:42:32,480
the<font color="#E5E5E5"> you know I mentioned event</font><font color="#CCCCCC"> log stuff</font>

1137
00:42:30,319 --> 00:42:34,790
<font color="#CCCCCC">the difficulty is you</font><font color="#E5E5E5"> have to have your</font>

1138
00:42:32,480 --> 00:42:36,619
event<font color="#E5E5E5"> log tuned</font><font color="#CCCCCC"> at</font><font color="#E5E5E5"> the time the</font><font color="#CCCCCC"> backdoor</font>

1139
00:42:34,790 --> 00:42:37,970
is<font color="#E5E5E5"> actually implemented so if you find</font>

1140
00:42:36,619 --> 00:42:39,560
these<font color="#E5E5E5"> backdoors in your</font><font color="#CCCCCC"> environment and</font>

1141
00:42:37,970 --> 00:42:40,700
you don't have you know<font color="#CCCCCC"> five it was</font><font color="#E5E5E5"> put</font>

1142
00:42:39,560 --> 00:42:42,650
in<font color="#E5E5E5"> five years ago and you don't have</font>

1143
00:42:40,700 --> 00:42:44,509
historical<font color="#CCCCCC"> information you're</font><font color="#E5E5E5"> not going</font>

1144
00:42:42,650 --> 00:42:47,540
<font color="#E5E5E5">to know who put it in even if you can</font>

1145
00:42:44,510 --> 00:42:49,970
tell it's malicious for example though

1146
00:42:47,540 --> 00:42:51,380
you know<font color="#CCCCCC"> tune</font><font color="#E5E5E5"> up your domain controllers</font>

1147
00:42:49,970 --> 00:42:52,578
<font color="#CCCCCC">now with event log logging we're</font>

1148
00:42:51,380 --> 00:42:55,339
actually going to<font color="#E5E5E5"> put</font><font color="#CCCCCC"> out some guidance</font>

1149
00:42:52,579 --> 00:42:56,960
on<font color="#E5E5E5"> how</font><font color="#CCCCCC"> to tune with</font><font color="#E5E5E5"> shackles</font><font color="#CCCCCC"> and event</font>

1150
00:42:55,339 --> 00:42:58,670
logs for every<font color="#E5E5E5"> single attack</font><font color="#CCCCCC"> print</font><font color="#E5E5E5"> if we</font>

1151
00:42:56,960 --> 00:42:59,900
talked about we're<font color="#CCCCCC"> not bad guys we</font>

1152
00:42:58,670 --> 00:43:01,369
<font color="#E5E5E5">promise we want to give the full</font>

1153
00:42:59,900 --> 00:43:02,930
complete defensive information to bring

1154
00:43:01,369 --> 00:43:04,280
<font color="#CCCCCC">attention to this problem</font><font color="#E5E5E5"> so that</font>

1155
00:43:02,930 --> 00:43:06,470
guidance will be<font color="#E5E5E5"> out in</font><font color="#CCCCCC"> the next couple</font>

1156
00:43:04,280 --> 00:43:07,849
of months<font color="#CCCCCC"> but</font><font color="#E5E5E5"> for example</font><font color="#CCCCCC"> you know</font><font color="#E5E5E5"> event</font>

1157
00:43:06,470 --> 00:43:09,379
log<font color="#CCCCCC"> four seven three eight</font><font color="#E5E5E5"> a user</font>

1158
00:43:07,849 --> 00:43:11,150
account<font color="#E5E5E5"> which change and then filtering</font>

1159
00:43:09,380 --> 00:43:13,390
by the property modified<font color="#CCCCCC"> per se service</font>

1160
00:43:11,150 --> 00:43:15,440
<font color="#CCCCCC">principle name or something like</font><font color="#E5E5E5"> that</font>

1161
00:43:13,390 --> 00:43:17,029
also<font color="#CCCCCC"> we've been</font><font color="#E5E5E5"> diving into</font><font color="#CCCCCC"> some</font>

1162
00:43:15,440 --> 00:43:18,770
replication<font color="#E5E5E5"> metadata I have a post</font>

1163
00:43:17,030 --> 00:43:20,150
coming out in a<font color="#E5E5E5"> couple week on this but</font>

1164
00:43:18,770 --> 00:43:22,280
with domain controllers replicate<font color="#E5E5E5"> data</font>

1165
00:43:20,150 --> 00:43:24,079
between<font color="#E5E5E5"> each other you know there</font>

1166
00:43:22,280 --> 00:43:25,970
there's information that's<font color="#E5E5E5"> kind of left</font>

1167
00:43:24,079 --> 00:43:26,869
over this<font color="#E5E5E5"> metadata that says hey these</font>

1168
00:43:25,970 --> 00:43:29,990
properties change

1169
00:43:26,869 --> 00:43:31,730
so using this<font color="#E5E5E5"> replication metadata you</font>

1170
00:43:29,990 --> 00:43:34,310
can<font color="#E5E5E5"> figure out when a property was</font>

1171
00:43:31,730 --> 00:43:36,109
modified and<font color="#CCCCCC"> you can tell which domain</font>

1172
00:43:34,310 --> 00:43:37,759
controller the modification originated

1173
00:43:36,109 --> 00:43:39,348
on<font color="#CCCCCC"> so you can use this to figure</font><font color="#E5E5E5"> out oh</font>

1174
00:43:37,760 --> 00:43:41,119
crap there was you<font color="#E5E5E5"> know something</font><font color="#CCCCCC"> put in</font>

1175
00:43:39,349 --> 00:43:42,740
here and<font color="#E5E5E5"> then go straight</font><font color="#CCCCCC"> to that one</font>

1176
00:43:41,119 --> 00:43:44,150
<font color="#E5E5E5">particular domain controller and</font><font color="#CCCCCC"> if you</font>

1177
00:43:42,740 --> 00:43:44,660
have event log tuning you can figure<font color="#E5E5E5"> out</font>

1178
00:43:44,150 --> 00:43:46,190
<font color="#E5E5E5">who</font><font color="#CCCCCC"> did it</font>

1179
00:43:44,660 --> 00:43:48,140
so again<font color="#E5E5E5"> point you</font><font color="#CCCCCC"> in the right</font>

1180
00:43:46,190 --> 00:43:49,460
direction<font color="#E5E5E5"> but doesn't give you the</font><font color="#CCCCCC"> full</font>

1181
00:43:48,140 --> 00:43:50,720
<font color="#E5E5E5">picture you have to have the event marks</font>

1182
00:43:49,460 --> 00:43:53,710
for it there's not<font color="#CCCCCC"> really another way to</font>

1183
00:43:50,720 --> 00:43:56,450
do like kind<font color="#CCCCCC"> of forensics on the NTDs it</font>

1184
00:43:53,710 --> 00:43:58,010
also<font color="#CCCCCC"> suckled</font><font color="#E5E5E5"> so we didn't really</font><font color="#CCCCCC"> cover</font>

1185
00:43:56,450 --> 00:44:00,049
these but the system access control

1186
00:43:58,010 --> 00:44:01,819
lists<font color="#CCCCCC"> they're</font><font color="#E5E5E5"> aces that specify the</font>

1187
00:44:00,050 --> 00:44:03,530
types of access attempts to generate

1188
00:44:01,819 --> 00:44:05,029
audit records and security event<font color="#E5E5E5"> log of</font>

1189
00:44:03,530 --> 00:44:06,650
domain controllers<font color="#E5E5E5"> so basically you can</font>

1190
00:44:05,030 --> 00:44:08,569
build<font color="#E5E5E5"> cycles that would produce</font>

1191
00:44:06,650 --> 00:44:10,849
<font color="#E5E5E5">additional more granular events that say</font>

1192
00:44:08,569 --> 00:44:14,060
hey somebody modified or tried to<font color="#CCCCCC"> modify</font>

1193
00:44:10,849 --> 00:44:16,460
these<font color="#E5E5E5"> particular properties so a lot</font><font color="#CCCCCC"> of</font>

1194
00:44:14,060 --> 00:44:17,810
<font color="#E5E5E5">people think like oh</font><font color="#CCCCCC"> there's just</font><font color="#E5E5E5"> all we</font>

1195
00:44:16,460 --> 00:44:18,950
don't<font color="#E5E5E5"> want</font><font color="#CCCCCC"> to use sack holes because</font>

1196
00:44:17,810 --> 00:44:20,750
<font color="#E5E5E5">these have been around forever</font><font color="#CCCCCC"> but</font>

1197
00:44:18,950 --> 00:44:21,950
almost no<font color="#E5E5E5"> one we see uses them probably</font>

1198
00:44:20,750 --> 00:44:22,580
<font color="#CCCCCC">because they think we</font><font color="#E5E5E5"> have</font><font color="#CCCCCC"> to saca</font><font color="#E5E5E5"> lever</font>

1199
00:44:21,950 --> 00:44:24,500
ething and<font color="#E5E5E5"> it's</font>

1200
00:44:22,580 --> 00:44:26,150
so much data and<font color="#E5E5E5"> blah blah blah</font><font color="#CCCCCC"> what we</font>

1201
00:44:24,500 --> 00:44:28,520
think is<font color="#CCCCCC"> you can</font><font color="#E5E5E5"> start building Sacco's</font>

1202
00:44:26,150 --> 00:44:30,350
that actually target just<font color="#E5E5E5"> the object</font>

1203
00:44:28,520 --> 00:44:31,759
<font color="#E5E5E5">takeover primitives so then you can</font>

1204
00:44:30,350 --> 00:44:33,020
<font color="#E5E5E5">generate just those events and you're</font>

1205
00:44:31,760 --> 00:44:35,330
<font color="#E5E5E5">cutting down one to two orders of</font>

1206
00:44:33,020 --> 00:44:36,830
magnitude or<font color="#CCCCCC"> more</font><font color="#E5E5E5"> the actual</font><font color="#CCCCCC"> data you're</font>

1207
00:44:35,330 --> 00:44:39,110
<font color="#CCCCCC">gathering</font><font color="#E5E5E5"> so again we want to build a</font>

1208
00:44:36,830 --> 00:44:40,430
complete guide on<font color="#CCCCCC"> how to</font><font color="#E5E5E5"> use tackle to</font>

1209
00:44:39,110 --> 00:44:42,260
actually detect<font color="#E5E5E5"> everything we're talking</font>

1210
00:44:40,430 --> 00:44:44,419
<font color="#CCCCCC">about</font><font color="#E5E5E5"> at least again that's for</font>

1211
00:44:42,260 --> 00:44:46,130
modification<font color="#E5E5E5"> it's the back doors already</font>

1212
00:44:44,420 --> 00:44:48,710
<font color="#E5E5E5">there that's much much harder</font><font color="#CCCCCC"> to</font>

1213
00:44:46,130 --> 00:44:50,150
actually detect and there's a little

1214
00:44:48,710 --> 00:44:51,170
<font color="#CCCCCC">more information that bitly link and</font>

1215
00:44:50,150 --> 00:44:53,840
we're going to<font color="#E5E5E5"> have a post out of the</font>

1216
00:44:51,170 --> 00:44:55,580
next few months<font color="#E5E5E5"> future</font><font color="#CCCCCC"> work</font><font color="#E5E5E5"> we tried to</font>

1217
00:44:53,840 --> 00:44:56,870
implement<font color="#E5E5E5"> null tackles in that for</font>

1218
00:44:55,580 --> 00:44:59,960
Active Directory objects because we

1219
00:44:56,870 --> 00:45:00,890
thought<font color="#E5E5E5"> it'd be funny but um you</font><font color="#CCCCCC"> know we</font>

1220
00:44:59,960 --> 00:45:03,110
turn them in<font color="#CCCCCC"> feel like that</font><font color="#E5E5E5"> and also</font>

1221
00:45:00,890 --> 00:45:05,900
<font color="#E5E5E5">there's a bit in</font><font color="#CCCCCC"> the header control bit</font>

1222
00:45:03,110 --> 00:45:07,580
<font color="#E5E5E5">SC</font><font color="#CCCCCC"> deck will present the but any</font>

1223
00:45:05,900 --> 00:45:09,140
attempts to<font color="#CCCCCC"> modify the NT security</font>

1224
00:45:07,580 --> 00:45:12,230
descriptor in that way on an object

1225
00:45:09,140 --> 00:45:13,790
<font color="#E5E5E5">remotely those bits are ignored from</font>

1226
00:45:12,230 --> 00:45:15,590
what we can tell so we might be<font color="#CCCCCC"> able</font><font color="#E5E5E5"> to</font>

1227
00:45:13,790 --> 00:45:16,910
<font color="#E5E5E5">do it if you have</font><font color="#CCCCCC"> codex</font><font color="#E5E5E5"> a system on a DC</font>

1228
00:45:15,590 --> 00:45:19,040
but we can't actually do<font color="#E5E5E5"> it remotely</font>

1229
00:45:16,910 --> 00:45:20,569
<font color="#CCCCCC">so what this works</font><font color="#E5E5E5"> another local you</font>

1230
00:45:19,040 --> 00:45:21,590
want to look<font color="#E5E5E5"> into that we also want</font><font color="#CCCCCC"> to</font>

1231
00:45:20,570 --> 00:45:23,870
<font color="#E5E5E5">research additional control</font>

1232
00:45:21,590 --> 00:45:25,850
relationships again we are not<font color="#E5E5E5"> saying</font>

1233
00:45:23,870 --> 00:45:29,150
our control object takeover taxonomy is

1234
00:45:25,850 --> 00:45:31,250
complete we want to expand it so credits

1235
00:45:29,150 --> 00:45:33,860
<font color="#E5E5E5">huge huge huge</font><font color="#CCCCCC"> shout out</font><font color="#E5E5E5"> to our work</font>

1236
00:45:31,250 --> 00:45:35,240
<font color="#E5E5E5">mate inspector Lee</font><font color="#CCCCCC"> Christensen TIFF can</font>

1237
00:45:33,860 --> 00:45:37,100
he<font color="#E5E5E5"> really helped us with some the last</font>

1238
00:45:35,240 --> 00:45:39,410
research<font color="#E5E5E5"> and you know reviewed the white</font>

1239
00:45:37,100 --> 00:45:41,420
papers<font color="#CCCCCC"> and all that jet</font><font color="#E5E5E5"> Dimmick</font><font color="#CCCCCC"> was</font>

1240
00:45:39,410 --> 00:45:43,279
awesome<font color="#CCCCCC"> undoing content review everyone</font>

1241
00:45:41,420 --> 00:45:44,750
else's Specter out so our team you<font color="#E5E5E5"> know</font>

1242
00:45:43,280 --> 00:45:47,810
a huge amount we did not do this on<font color="#E5E5E5"> our</font>

1243
00:45:44,750 --> 00:45:49,370
own by any means<font color="#E5E5E5"> also</font><font color="#CCCCCC"> Mac Raber who used</font>

1244
00:45:47,810 --> 00:45:50,810
<font color="#E5E5E5">to work with us he he did some great</font>

1245
00:45:49,370 --> 00:45:52,940
review and did the kind<font color="#CCCCCC"> of</font><font color="#E5E5E5"> content</font>

1246
00:45:50,810 --> 00:45:54,440
feedback and<font color="#CCCCCC"> everything so I think</font><font color="#E5E5E5"> we</font>

1247
00:45:52,940 --> 00:45:55,730
have what<font color="#CCCCCC"> maybe</font><font color="#E5E5E5"> like three minutes or</font>

1248
00:45:54,440 --> 00:45:58,160
something<font color="#E5E5E5"> like that</font>

1249
00:45:55,730 --> 00:45:59,600
<font color="#E5E5E5">four minutes okay so we should have some</font>

1250
00:45:58,160 --> 00:46:01,160
time for<font color="#CCCCCC"> a couple questions if anyone's</font>

1251
00:45:59,600 --> 00:46:02,390
interested<font color="#E5E5E5"> hopefully hopefully we scared</font>

1252
00:46:01,160 --> 00:46:03,609
you<font color="#CCCCCC"> just a little bit but we want to</font>

1253
00:46:02,390 --> 00:46:07,640
<font color="#E5E5E5">bring</font><font color="#CCCCCC"> attention to</font><font color="#E5E5E5"> this whole</font><font color="#CCCCCC"> thing</font>

1254
00:46:03,610 --> 00:46:09,710
<font color="#E5E5E5">No no questions if anybody is walking up</font>

1255
00:46:07,640 --> 00:46:11,150
<font color="#E5E5E5">or thinking about</font><font color="#CCCCCC"> walking up a few other</font>

1256
00:46:09,710 --> 00:46:14,030
<font color="#CCCCCC">people that I would just like to repeat</font>

1257
00:46:11,150 --> 00:46:19,310
are things<font color="#E5E5E5"> for Lucario and Emmanuel</font>

1258
00:46:14,030 --> 00:46:20,060
<font color="#E5E5E5">broth formerly from ANSI mark</font><font color="#CCCCCC"> Gamache at</font>

1259
00:46:19,310 --> 00:46:22,730
Microsoft

1260
00:46:20,060 --> 00:46:24,470
<font color="#E5E5E5">Robin Granberg at Microsoft</font><font color="#CCCCCC"> Vincent</font><font color="#E5E5E5"> with</font>

1261
00:46:22,730 --> 00:46:25,790
<font color="#CCCCCC">- we can't think of enough</font><font color="#E5E5E5"> all of us owe</font>

1262
00:46:24,470 --> 00:46:28,100
him a lot

1263
00:46:25,790 --> 00:46:30,290
<font color="#E5E5E5">Benjamin</font><font color="#CCCCCC"> Delfy</font><font color="#E5E5E5"> the list goes on and</font><font color="#CCCCCC"> on</font>

1264
00:46:28,100 --> 00:46:32,770
and<font color="#CCCCCC"> on but yeah</font><font color="#E5E5E5"> it's on yeah thank</font><font color="#CCCCCC"> you</font>

1265
00:46:30,290 --> 00:46:32,770
<font color="#E5E5E5">um</font>

