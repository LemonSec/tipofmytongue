1
00:00:00,000 --> 00:00:06,920
good morning and welcome the black hat
USA 2015 day to you hopefully you're in

2
00:00:06,920 --> 00:00:12,879
the right place This Is Mandalay Bay VCD
starts here is going to be repurposing

3
00:00:12,880 --> 00:00:21,340
onion Duke with Joshua pits I have a
couple of announcements to give you just

4
00:00:21,340 --> 00:00:25,789
before we get started first we want to
remind you that you can stop by the

5
00:00:25,789 --> 00:00:29,689
Business Hall which is located in
Shoreline a for sponsored sessions in

6
00:00:29,689 --> 00:00:36,989
theaters a and be sure to check out our
black hat Arsenal game breakers de J K

7
00:00:36,989 --> 00:00:42,968
and we have sponsored workshops and
Mandalay J K and L

8
00:00:42,969 --> 00:00:48,010
thanks for putting your phone on vibrate
so that it doesn't disrupt the session

9
00:00:48,010 --> 00:00:53,300
we really appreciate your help with all
this and without further ado I present

10
00:00:53,300 --> 00:00:58,510
you just

11
00:00:58,510 --> 00:01:11,270
me thanks for coming I know it's early
1945 in Vegas is early so I appreciate

12
00:01:11,270 --> 00:01:16,990
it so like I said I'm Josh bits of
Directors security research and not sick

13
00:01:16,990 --> 00:01:21,919
for that I was done by then security and
if you're following along and the opium

14
00:01:21,920 --> 00:01:28,890
database I was a Booz Allen and then BC
and if you have the opium database you

15
00:01:28,890 --> 00:01:31,840
don't need anymore so I'll keep going
with that

16
00:01:31,840 --> 00:01:38,020
alright so I wrote video and media proxy
that is call it short or as a short for

17
00:01:38,020 --> 00:01:45,699
the back door factory so what does its
code is written in assembly that patches

18
00:01:45,700 --> 00:01:54,190
payloads into Pl San Marco formats and
media proxy is like a factory and mental

19
00:01:54,190 --> 00:02:00,789
processes or patches minors during
download so it's kind of fun and it and

20
00:02:00,789 --> 00:02:09,110
I'm actually gonna take any input that
into PDF so everyone can use it today

21
00:02:09,110 --> 00:02:13,950
real quick and we talked about 3% of now
where the beach and then we talked about

22
00:02:13,950 --> 00:02:19,339
how I discovered a new we're gonna
reverses you the Packer repurpose it and

23
00:02:19,340 --> 00:02:27,970
then I have to the most so repurposing
is what we do as humans is why we're

24
00:02:27,970 --> 00:02:34,470
alive it just makes sense it saves us
time in our in our industry is based on

25
00:02:34,470 --> 00:02:38,640
repurposing we share ideas and really if
you think about it

26
00:02:38,640 --> 00:02:44,200
ideas travel really fast and no amount
of regulation is going to stop that and

27
00:02:44,200 --> 00:02:49,209
and really going to see after this
presentation nation state weapons really

28
00:02:49,209 --> 00:02:54,709
are not special or magical there just
developed in private and then once we

29
00:02:54,709 --> 00:03:00,080
get to see them you know what everybody
is up to a higher level as far as what

30
00:03:00,080 --> 00:03:04,409
they know and how they can defend
against those attacks to relook at some

31
00:03:04,409 --> 00:03:07,280
reputable media sources

32
00:03:07,280 --> 00:03:12,910
and we will see how Mauer has been
reused in the media so we have the Sony

33
00:03:12,910 --> 00:03:20,090
attack between 14 and their attack the
malware was named just over in a feature

34
00:03:20,090 --> 00:03:24,110
that was delayed hard drive deletion had
some mercy

35
00:03:24,110 --> 00:03:29,090
control as a piece of our User South
Korea called little more and I was in

36
00:03:29,090 --> 00:03:34,400
2014 at some of our names and the time
delay before deleting hard drive that

37
00:03:34,400 --> 00:03:40,810
was similar to chakra in 2013 also use
in South Korea and just over you simply

38
00:03:40,810 --> 00:03:45,980
not malicious drivers as those in the
Shamu attacks in 2012 I think that was

39
00:03:45,980 --> 00:03:52,290
against a petroleum targets for energy
companies in Saudi Arabia and the leaked

40
00:03:52,290 --> 00:03:56,480
documents in a safe even develop their
own called wiper I'm surprised I didn't

41
00:03:56,480 --> 00:04:04,819
have a different name like slow down or
something but I was in 2012 so in the

42
00:04:04,819 --> 00:04:09,450
end I say you guys you guys remember in
2009 with Google Adsense a for help with

43
00:04:09,450 --> 00:04:14,899
your intrusion so this gave us a access
to parts of Google's infrastructure and

44
00:04:14,900 --> 00:04:22,590
also them our samples guys well in 2015
Kaspersky releases the equation report

45
00:04:22,590 --> 00:04:27,000
where the group you several prior 90
days including the Royal exploit and to

46
00:04:27,000 --> 00:04:33,390
exploit so she was taxes so according to
a report that was released by Der

47
00:04:33,390 --> 00:04:38,770
Spiegel there say supposedly leverage
South Korea implants against North Korea

48
00:04:38,770 --> 00:04:42,690
the leverage existing botanists and put
their own implants against other targets

49
00:04:42,690 --> 00:04:47,979
and they were purposely captured exploit
an impressive collection 2012 so you can

50
00:04:47,979 --> 00:04:54,090
ask yourself who's using him our
exploits so going to the criminal side

51
00:04:54,090 --> 00:04:58,929
of the house if there is a report
released in 2012 titled by psychoactive

52
00:04:58,930 --> 00:05:03,630
called cyber security is infamous 5 2014
in there there are five pieces empower

53
00:05:03,630 --> 00:05:08,479
their use different components and it
was a quote from that is likely an hour

54
00:05:08,479 --> 00:05:13,210
for reuse is quick and cost-effective
for every dollar spent by black hat

55
00:05:13,210 --> 00:05:17,770
hackers people that are in this room I
guess hundreds dollars are spent but I T

56
00:05:17,770 --> 00:05:21,620
security industry and if you've ever
done is a response to know that's true

57
00:05:21,620 --> 00:05:29,419
because men is not cheap so when you
have a team that happened one months ago

58
00:05:29,419 --> 00:05:32,690
1 month ago when their documents were
dropped on the internet and it didn't

59
00:05:32,690 --> 00:05:38,360
take long for pin testers to reuse some
the components this was the flash and

60
00:05:38,360 --> 00:05:47,970
then also criminals and this is anger
exploit kit so here's some back story on

61
00:05:47,970 --> 00:05:53,940
how I discovered it was September 2014
Derby Conn and I made a side comment I

62
00:05:53,940 --> 00:05:56,979
believe that man and a passionate
binaries on the internet was happening

63
00:05:56,979 --> 00:06:01,300
for certain reasons you can you can
google this this name you'll find a

64
00:06:01,300 --> 00:06:07,320
story was actually pretty interested so
I say that in the CEO of the virus and

65
00:06:07,320 --> 00:06:14,110
spyware to freak out he's like POC or
gtfo and I was like ok I will PRC I

66
00:06:14,110 --> 00:06:19,030
don't feel like leaving right now so I
said you know what towards gonna give me

67
00:06:19,030 --> 00:06:23,039
the best opportunity to find the men and
their passion activity because it's in

68
00:06:23,039 --> 00:06:26,880
many countries where this could happen
and basically when you set up the tracks

69
00:06:26,880 --> 00:06:32,870
and know that you are you you are an ISP
essentially so I used to be a model

70
00:06:32,870 --> 00:06:38,560
called X amount of winter and I wrote a
module that was actually it was called

71
00:06:38,560 --> 00:06:43,090
patching check and after I wrote it took
less than an hour to find the manual

72
00:06:43,090 --> 00:06:48,299
node was passing by Terry's during
download so I clicked about nine samples

73
00:06:48,300 --> 00:06:53,289
of her or five days and your PC download
same files to see if they would change

74
00:06:53,289 --> 00:07:02,409
any of their techniques they didn't and
they only do we patched or wrapped their

75
00:07:02,409 --> 00:07:07,870
power around x86 PC files and later on
if secure tied to the russian government

76
00:07:07,870 --> 00:07:14,300
well when you do they tell you to the
russian government and other possibly

77
00:07:14,300 --> 00:07:18,569
russian-backed crime syndicates however

78
00:07:18,569 --> 00:07:23,479
the first sample of opinion due to hit
virustotal was 10 months before I found

79
00:07:23,479 --> 00:07:30,669
it and if you look into the details a
user added tags to this when they

80
00:07:30,669 --> 00:07:36,020
uploaded it so they found it someone
knew that something was happening on

81
00:07:36,020 --> 00:07:41,258
tour that malicious and they didn't do
anything about it and this was happening

82
00:07:41,259 --> 00:07:48,020
for 10 months and how I found it is I
looked at I googled for the md5 hash of

83
00:07:48,020 --> 00:07:54,128
the tech section and so they're actually
using the same techniques for 10 months

84
00:07:54,129 --> 00:07:57,509
before it was it was caught so it's
pretty this was actually a pretty

85
00:07:57,509 --> 00:08:03,379
effective attack so when you're when
you're gone and repurposing software on

86
00:08:03,379 --> 00:08:07,589
this case however you look at it
different from his response you're

87
00:08:07,589 --> 00:08:11,999
looking for it indicators a compromise
exactly what you're doing is think of it

88
00:08:11,999 --> 00:08:16,139
as reverse engineering a competitor's
product for the implicit purpose of

89
00:08:16,139 --> 00:08:22,169
stealing their initial capital and
repackaged for your use or you want to

90
00:08:22,169 --> 00:08:25,269
make it look like they've moved on to
different targets you want to still

91
00:08:25,269 --> 00:08:30,490
their command control or even still the
box so you need to understand everything

92
00:08:30,490 --> 00:08:34,159
about the malware what software
protections exist what features do you

93
00:08:34,159 --> 00:08:38,669
think our novel for reusing in fact
there is little risk of legal

94
00:08:38,669 --> 00:08:42,458
retribution from the original authors
for example the agency is responsible

95
00:08:42,458 --> 00:08:47,508
for Stuxnet and the dentist appointment
are not going to sue you for using their

96
00:08:47,509 --> 00:08:52,980
ideas that without them rate so the only
thing you do need to worry about is

97
00:08:52,980 --> 00:08:58,850
probably a metal pipe so

98
00:08:58,850 --> 00:09:07,630
alright so let's take a look at the new
panel method and to me sorry for me the

99
00:09:07,630 --> 00:09:12,970
most important feature is the Packer not
necessary the power that was deployed

100
00:09:12,970 --> 00:09:17,610
within you do because if you reverse
engineer the packer in your right and

101
00:09:17,610 --> 00:09:22,329
you and you can use it then you can
complain about where you want it so can

102
00:09:22,329 --> 00:09:25,489
we take it reverse engineering
incorporated into the open source tools

103
00:09:25,490 --> 00:09:29,940
in fact I think before the the BIS
change your mind on their current

104
00:09:29,940 --> 00:09:35,389
recommendations they had open source
clause so if you open source your

105
00:09:35,389 --> 00:09:43,180
research then it's ok so should we open
source all nations that Mauer so this is

106
00:09:43,180 --> 00:09:44,560
how it worked

107
00:09:44,560 --> 00:09:49,699
the victim download the binary from the
server going through malicious node on

108
00:09:49,699 --> 00:09:54,589
the internet this case tour ambitious
x&o traps the binary with the packer the

109
00:09:54,589 --> 00:10:01,769
user executes an hour because the same
icons as the expected program after

110
00:10:01,769 --> 00:10:06,769
unpacking the original binary and power
disc with a batch file the batch files

111
00:10:06,769 --> 00:10:08,779
executed

112
00:10:08,779 --> 00:10:13,420
mauer is executed when the power has
executed infected the host the batch

113
00:10:13,420 --> 00:10:19,250
file replaces the need to Packer with
the original file and execute the

114
00:10:19,250 --> 00:10:24,639
original file so it's it's essentially a
shell game so everything's dropped an

115
00:10:24,639 --> 00:10:30,250
attempt filed on Dec was malware and now
never changed throughout the campaign

116
00:10:30,250 --> 00:10:36,329
original trial that he exceeded or the
say you have process explorer.exe

117
00:10:36,329 --> 00:10:44,508
that would be the name and then you have
a batch file that would have for random

118
00:10:44,509 --> 00:10:51,370
integers between underscore MS and got
back so I wanted to see what was

119
00:10:51,370 --> 00:10:54,740
different because something was
something different was happening so I

120
00:10:54,740 --> 00:10:59,350
looked at the indy five houses of the
sections through virustotal buyers to a

121
00:10:59,350 --> 00:11:03,089
file provides information so you'll
notice that the text sections are the

122
00:11:03,089 --> 00:11:08,200
same the eye Dr data sections are the
same and also

123
00:11:08,200 --> 00:11:14,670
relocation sections are the same you'll
see that the dot data sections of the

124
00:11:14,670 --> 00:11:19,270
same size but they have different
harshest so I want to look at the data

125
00:11:19,270 --> 00:11:23,900
sections and do it a different time to
see what was changing and by doing that

126
00:11:23,900 --> 00:11:31,180
you also notice that are sections are
sections were just completely different

127
00:11:31,180 --> 00:11:40,099
in size and house right right so what I
did is a cut out using DDI just cut out

128
00:11:40,100 --> 00:11:44,290
the data sections for two files and and
compared them and this led me to this

129
00:11:44,290 --> 00:11:51,390
block of data for CPS exact addy exceed
org and you'll see it a lot of no bites

130
00:11:51,390 --> 00:11:57,380
and that is basically the size of the of
the filename that it supported you also

131
00:11:57,380 --> 00:12:03,910
see filed IDX a rash of that and then
there were two there are couple for

132
00:12:03,910 --> 00:12:09,079
might block several Indian and I i
looked at the malware when it was loaded

133
00:12:09,080 --> 00:12:13,270
into memory and noticed that what was
loaded in memory was not the same size

134
00:12:13,270 --> 00:12:18,550
of the file what was loaded on disk so I
was looking at these numbers I figured

135
00:12:18,550 --> 00:12:24,500
out that the first the first 4 bytes
there is the location of the first file

136
00:12:24,500 --> 00:12:29,390
that has compressed and encoded and
opinion on the end of the binary the

137
00:12:29,390 --> 00:12:33,810
second four bytes is the size of that
file after spending compressed and

138
00:12:33,810 --> 00:12:42,359
encoded you'll see again another 424 buy
blocks this is d Mauer file location and

139
00:12:42,360 --> 00:12:48,710
size same concept as far as the resource
section

140
00:12:48,710 --> 00:12:53,320
scrubber and all the paper called
software distribution malware infection

141
00:12:53,320 --> 00:13:00,750
Dr aka little patches in 2008 and in
there they described a method for

142
00:13:00,750 --> 00:13:06,350
Passionata binaries however there's one
drawback the icon to change because he

143
00:13:06,350 --> 00:13:13,560
did not develop method to inherit the
icons from the incoming file my opinion

144
00:13:13,560 --> 00:13:17,469
the original binary our source for
research section behind the Packer stuff

145
00:13:17,470 --> 00:13:19,470
he removes any pattern

146
00:13:19,470 --> 00:13:25,060
and fixes up the relative virtual
address is based on the new stuff now a

147
00:13:25,060 --> 00:13:29,260
side note PDF PDF process never had this
issue because I just infect inside the

148
00:13:29,260 --> 00:13:35,540
file and I don't modify the size
generally so and also in the same paper

149
00:13:35,540 --> 00:13:40,689
this was kind of funny they said that
tour can be used as a countermeasure to

150
00:13:40,690 --> 00:13:45,470
protect against man in the whole batch
of its more actually it's more of a game

151
00:13:45,470 --> 00:13:49,200
of Russian Roulette

152
00:13:49,200 --> 00:14:00,040
you notice that you have a part that's
loaded into memory ok you have the data

153
00:14:00,040 --> 00:14:04,610
modifications they go into the Packer
stuff there are sore section resource

154
00:14:04,610 --> 00:14:09,210
section this late in the memory of the
compressed original binary that depended

155
00:14:09,210 --> 00:14:17,190
on the end and then press power so it's
really not too complicated for the study

156
00:14:17,190 --> 00:14:23,310
was compiled Visual Studio uses the GPS
security buffer Jack course is written

157
00:14:23,310 --> 00:14:30,339
in C++ captures command line arguments
the I thought it would pass it on to the

158
00:14:30,340 --> 00:14:36,620
batch file but it does not I could not
get that functionality to work it

159
00:14:36,620 --> 00:14:41,580
supports both NZ in Unicode basic
foundations and path so that's actually

160
00:14:41,580 --> 00:14:46,300
pretty cool because actually plan to
hire 22 actually supports multiple

161
00:14:46,300 --> 00:14:50,380
languages and being if it if you're
you're attacking Tory need to do that

162
00:14:50,380 --> 00:14:57,470
because you have 1919 languages you know
and she and the others so they wanted to

163
00:14:57,470 --> 00:15:01,590
make sure that they were able to
propagate everywhere so they supported

164
00:15:01,590 --> 00:15:07,900
it does support x64 P binaries but
however they did not use I could not get

165
00:15:07,900 --> 00:15:14,730
any of the binary is 64 bit test
binaries to be a raptor patched because

166
00:15:14,730 --> 00:15:21,950
you think about this was early 2014 XP
was still supported and so they did not

167
00:15:21,950 --> 00:15:26,000
want to wrap it a 64 bit binary that
might have been accidentally run on XP

168
00:15:26,000 --> 00:15:28,600
machine which you wouldn't run anyway so
I

169
00:15:28,600 --> 00:15:35,420
I'm kind of surprised they did not
support 64 bit and if it works it works

170
00:15:35,420 --> 00:15:43,779
so now there's or XOR each file is
expired after compression is staticy is

171
00:15:43,779 --> 00:15:49,720
that it never changed it was always was
always that number and here's just a

172
00:15:49,720 --> 00:15:54,940
quick glimpse of the stub and it
highlighted the expertise now but

173
00:15:54,940 --> 00:16:00,360
impression was kind of interesting it
took me some time to find because

174
00:16:00,360 --> 00:16:06,850
sometimes I'm not very smart and I was
actually consider considering looking at

175
00:16:06,850 --> 00:16:10,630
this simply output because it was
written in assembly a lot of those are

176
00:16:10,630 --> 00:16:15,850
in assembly and ported over to assembly
/ Python before I got too far into that

177
00:16:15,850 --> 00:16:23,740
I did some research and let me to a blog
post from rainbows which was a former

178
00:16:23,740 --> 00:16:29,100
coworker of mine and he works now Google
and his personal me to the AP lit

179
00:16:29,100 --> 00:16:33,649
compression library and so it's it's a
pretty cool oppression library

180
00:16:33,649 --> 00:16:40,310
non-sports x86 x64 I'm just a little
side note the team had some had spent

181
00:16:40,310 --> 00:16:44,699
some code that was called inject proxy
is part of the RCS and it all to back in

182
00:16:44,699 --> 00:16:50,649
2007 2008 however they depended only 150
on the end of the binary and use the

183
00:16:50,649 --> 00:16:54,630
exact same compression library and so
whenever a searching through all their

184
00:16:54,630 --> 00:16:55,399
stuff

185
00:16:55,399 --> 00:17:00,060
yes I did and I found out I was really
excited that they use the same

186
00:17:00,060 --> 00:17:04,069
impression I almost thought that they do
but they didn't I mean I wanted to find

187
00:17:04,069 --> 00:17:12,959
that so bad but they did they did not do
that so so all the samples that were

188
00:17:12,959 --> 00:17:20,490
captured and analyzed only deployed a
p/e executable binary but look into this

189
00:17:20,490 --> 00:17:26,220
simply I notice that they supported two
ways to deploy a deal low around 32 Delo

190
00:17:26,220 --> 00:17:33,909
it was via the print message export and
then by ordinal number no number was

191
00:17:33,909 --> 00:17:39,360
pre-populated and there's a reason for
that now secured discovered a new deal

192
00:17:39,360 --> 00:17:43,709
out but did not recover the Associated
packer because it's deleted after

193
00:17:43,710 --> 00:17:49,850
execution so they kinda cool to find
that so here's the here's the issue here

194
00:17:49,850 --> 00:17:54,510
the functions are responsible for the
choices in binary execution would be

195
00:17:54,510 --> 00:17:59,669
rendered lol instructions on the left
and middle and on the right is the flow

196
00:17:59,669 --> 00:18:08,820
for the pioneering execution so back to
the same data section there are 24 bite

197
00:18:08,820 --> 00:18:13,178
areas you can't see it here but looking
at the code as over to find that this

198
00:18:13,179 --> 00:18:19,270
first 4 bytes section if you have a 01
there just to note that the powers deal

199
00:18:19,270 --> 00:18:26,158
that you reminded the point the next
four bytes section is the ordinal if the

200
00:18:26,159 --> 00:18:31,370
ordinal is blank is going to use the
Print message export so it's kind of

201
00:18:31,370 --> 00:18:36,408
cool so it had some had some really
interesting features but they didn't

202
00:18:36,409 --> 00:18:44,390
vary at all because well they're going
to get caught so their passion framework

203
00:18:44,390 --> 00:18:51,270
I believe it was written in C++ because
I did not see delay on towards self I

204
00:18:51,270 --> 00:18:54,250
believe you know you could tell that it
was modular but they never say never

205
00:18:54,250 --> 00:18:58,600
using up functionality from what we
could tell it was campaign you can have

206
00:18:58,600 --> 00:19:03,090
a campaign based session and I think
that it's going to be seen again at

207
00:19:03,090 --> 00:19:07,860
least the man or patching framework as
they can recompile on you do can change

208
00:19:07,860 --> 00:19:14,889
some settings and probably get it down
to zero protections again so they're

209
00:19:14,890 --> 00:19:18,840
OPSEC wasn't very good when I first
found it I was using the Python user

210
00:19:18,840 --> 00:19:24,939
agent right so they they just passed
everything so I think now what they're

211
00:19:24,940 --> 00:19:29,220
going to do is focus on particular just
rows of Windows they'll say you know we

212
00:19:29,220 --> 00:19:32,220
only want 2007 or above

213
00:19:32,220 --> 00:19:37,299
we're gonna targets this particular
binary can be over this size i mean they

214
00:19:37,299 --> 00:19:38,908
could make the

215
00:19:38,909 --> 00:19:46,409
the rules very specific to get a very
specific target so if you can catch the

216
00:19:46,409 --> 00:19:53,849
next time they're using this I will buy
you a six pack of beer or even more now

217
00:19:53,849 --> 00:19:58,369
on to reason the Packer now what what do
I want to keep when it comes down to

218
00:19:58,369 --> 00:20:04,199
this going to keep all of this I think
that is pretty pretty novel at least at

219
00:20:04,200 --> 00:20:08,609
least four you know watching buyers man
the middle but there there's a there's a

220
00:20:08,609 --> 00:20:14,470
specific problem the detection rate is
really high and the stuff I need to do

221
00:20:14,470 --> 00:20:23,599
is about 70 kilobytes so ABC's have a
lot of leeway to tag flag the stuff so

222
00:20:23,599 --> 00:20:31,059
I'm gonna have to get a little creative
so we're gonna do this well I'm gonna

223
00:20:31,059 --> 00:20:37,019
randomized X-ers key to drop file names
and the section hashes it is going to be

224
00:20:37,019 --> 00:20:42,330
a different binary at least from a hash
hash perspective every single time ago

225
00:20:42,330 --> 00:20:49,070
through video now I have to worry about
a re-employment the our source stealing

226
00:20:49,070 --> 00:20:54,658
and updating my room I on our source
parser to update the RBA's so if you if

227
00:20:54,659 --> 00:21:00,419
you know what what the resource section
as you have branches you have leaves and

228
00:21:00,419 --> 00:21:05,409
then at the very end of those leaves
linked list pretty much you have the

229
00:21:05,409 --> 00:21:10,499
address village of virtual address based
on where it's loaded in memory and so I

230
00:21:10,499 --> 00:21:17,259
wrote a partial to update that now we
have to compress and sore the incoming

231
00:21:17,259 --> 00:21:23,460
file you provide an hour the author of
ap lab was kind enough to provide or

232
00:21:23,460 --> 00:21:30,519
Saks unreleased OSX libraries to support
this so I was able to support OS X and

233
00:21:30,519 --> 00:21:34,000
Linux and then

234
00:21:34,000 --> 00:21:39,460
finally going to update the PE header
the data section and the expertise

235
00:21:39,460 --> 00:21:46,800
within the stuff itself so this is what
we are rebuilding essentially right ok

236
00:21:46,800 --> 00:22:09,370
so this brings us to the demo

237
00:22:09,370 --> 00:22:16,709
I'm using back-to-back itself right now
I'm going to patch products for use on

238
00:22:16,710 --> 00:22:26,690
YouTube method and I'm providing a
binary that is x64 bit executable ok I'm

239
00:22:26,690 --> 00:22:32,870
compressing right now you can see this
compressed with AP lib I have a random

240
00:22:32,870 --> 00:22:43,669
acts or key

241
00:22:43,670 --> 00:22:48,190
and then check to see if it's a deal
I'll not be allowed just continues

242
00:22:48,190 --> 00:22:55,010
through and I'm bottom left a bitter
procession x64 bit

243
00:22:55,010 --> 00:23:01,379
recession now you'll notice that the
binary itself is x86 so you can deploy

244
00:23:01,380 --> 00:23:13,910
x86 or or 32 bit with this

245
00:23:13,910 --> 00:23:16,450
there you go

246
00:23:16,450 --> 00:23:21,670
connection back now one thing with no
need to do is that the original malware

247
00:23:21,670 --> 00:23:28,350
would in fact and then die it would
persist location and then died so you

248
00:23:28,350 --> 00:23:33,169
have to migrate to another process for
the other process to pop up immediately

249
00:23:33,170 --> 00:23:36,680
now you can do this with Metasploit you
can automate it but i just want to go

250
00:23:36,680 --> 00:23:43,820
through the steps to do in the migration
you could see the icon flash and then

251
00:23:43,820 --> 00:23:51,810
you have just normal processes sport now
11 nice thing about this feature is that

252
00:23:51,810 --> 00:23:54,899
if the user thinks that something is
wrong

253
00:23:54,900 --> 00:24:00,070
go back and check the binary right they
can right-click see if it was fine after

254
00:24:00,070 --> 00:24:07,510
it executes and they're gonna find the
original binary and my younger self had

255
00:24:07,510 --> 00:24:13,400
problems closing this one on paula jones
the guy doesn't write very good coat

256
00:24:13,400 --> 00:24:19,720
either so now I'm going to deploy a deal
out and I'm going to use the our flight

257
00:24:19,720 --> 00:24:25,620
our flags a new feature for BTF it's a
part it parses the resource section the

258
00:24:25,620 --> 00:24:30,469
manifest file and in fines he requested
execution level and that exists in the

259
00:24:30,470 --> 00:24:36,110
manifest file it will match the highest
available

260
00:24:36,110 --> 00:24:40,449
ok so you see that it check to see if
there's a deal out and said yesterday is

261
00:24:40,450 --> 00:24:44,420
a deal now and then it passed highest
available in the P manifest now what

262
00:24:44,420 --> 00:25:06,490
does it invokes uac so now the power's
going to execute as admin

263
00:25:06,490 --> 00:25:16,730
you see the icon noting that in his
executors admin USC prompt and connect

264
00:25:16,730 --> 00:25:28,720
back from interpreter get system
successfully and then we're going to

265
00:25:28,720 --> 00:25:45,290
migrate to a system process

266
00:25:45,290 --> 00:25:52,970
back 29 USC so that's a red flag but if
he is right click send checks will see

267
00:25:52,970 --> 00:26:01,970
that it signed so kind of cool article
and then they're gonna digital signature

268
00:26:01,970 --> 00:26:12,999
it is signed by Microsoft

269
00:26:12,999 --> 00:26:34,279
rights that's the first time

270
00:26:34,279 --> 00:26:40,149
so this is a PDF proxy config file now
what I'm going to do is this this is my

271
00:26:40,149 --> 00:26:46,468
passion and my areas like you to minors
with a price tag and what I'm doing is

272
00:26:46,469 --> 00:26:52,469
unusual method I'm gonna patch ones I've
been lazy prompt and their music X 64

273
00:26:52,469 --> 00:26:59,059
bit binary with 32 bit binary is as they
come across and then I'm going to do the

274
00:26:59,059 --> 00:27:03,269
same thing that 64 bit and I'm gonna use
the X 64 bit mature but in reverse TCP

275
00:27:03,269 --> 00:27:11,719
show now means you mad at that so I
started media proxy and then I want to

276
00:27:11,719 --> 00:27:18,440
go to do there there's a proxy we
executed a resource console resource

277
00:27:18,440 --> 00:27:26,039
file is I'll put it it's raining disk
and then you can use that to launch and

278
00:27:26,039 --> 00:27:30,799
it will populate all the handlers that
you use automatically so now I'm gonna

279
00:27:30,799 --> 00:27:37,399
go through and download executables from
Sysinternals internal you can either use

280
00:27:37,399 --> 00:27:39,599
a CPR CPS your choice

281
00:27:39,599 --> 00:27:46,689
secure and non-secure and now I'm going
to go through and update the config file

282
00:27:46,690 --> 00:27:52,019
to change it to a deal and the next
request that comes through and you'll

283
00:27:52,019 --> 00:28:00,730
also be served because the config
updates on the fly

284
00:28:00,730 --> 00:28:18,910
so click on a piece of malware or
executable form web site and now it is a

285
00:28:18,910 --> 00:28:32,140
kilo so actually quite quick first
mother binaries and so I uploaded Duke

286
00:28:32,140 --> 00:28:38,520
original binary to file sharing site and
I'm going downloaded and show you a

287
00:28:38,520 --> 00:28:45,580
feature that I added that I thought was
gonna need if and we've been watching C

288
00:28:45,580 --> 00:28:48,949
next to the video is I'm going to
execute a couple binaries and that's

289
00:28:48,950 --> 00:28:54,720
going on I'm gonna kind of voice track
the changes so I added it was a teacher

290
00:28:54,720 --> 00:28:59,429
if it's easy when you do come across a
signature thats pretty i think is pretty

291
00:28:59,429 --> 00:29:05,110
solid for fine minyan do if I see I need
to come across I will rip off the

292
00:29:05,110 --> 00:29:08,969
original malware and then put the
user-supplied power on the end there by

293
00:29:08,970 --> 00:29:13,840
hijacking the original intent so you
could either you can either put just a

294
00:29:13,840 --> 00:29:19,980
pop-up box saying you you should not be
downloading over a CD or or you can put

295
00:29:19,980 --> 00:29:27,799
your own our right is it takes awhile
for that side to deliver the file

296
00:29:27,799 --> 00:29:44,020
because they're serving ads and
collecting information on the

297
00:29:44,020 --> 00:29:54,250
and I need to grab binary went through
and it removed original power from the

298
00:29:54,250 --> 00:29:59,800
battery and then reoffended compressed
using the same X 48 that was applied so

299
00:29:59,800 --> 00:30:04,129
it's a different XRT lil still work with
it even if it's even if its PDF

300
00:30:04,130 --> 00:30:07,990
passionate so if you have someone
Patrick Dale but coming out of the ETF

301
00:30:07,990 --> 00:30:12,850
you can keep this going and they just
don't just replace the other malware as

302
00:30:12,850 --> 00:30:34,570
he keeps going so it's kind of a kind of
fun

303
00:30:34,570 --> 00:30:45,678
explained earlier I'm gonna go ahead and
execute the file and you'll see that I

304
00:30:45,679 --> 00:30:50,029
will get a Kinect back proving that I
read that I removed from our

305
00:30:50,029 --> 00:31:08,140
successfully and I added run as admin to
it so I proved that

306
00:31:08,140 --> 00:31:11,260
so it does take a little while for it to
pop up because of the EM is being

307
00:31:11,260 --> 00:31:27,800
overworked right down but you get the
picture

308
00:31:27,800 --> 00:31:35,550
alright so after all that work the best
that I can do with the AV evasion was 28

309
00:31:35,550 --> 00:31:43,350
of 55 now I did not do any large
exocrine the tech section I did not use

310
00:31:43,350 --> 00:31:48,459
any encryption I just changed where
filename dropped for example McAfee

311
00:31:48,460 --> 00:31:54,490
Sophos Microsoft him I go micro and
semantic they all keyed off the file dot

312
00:31:54,490 --> 00:32:03,780
exe just that filed them so if you if
you're targeting specific AV such as a

313
00:32:03,780 --> 00:32:12,800
JPG you can write specific signatures
for those anti viruses as you see fit so

314
00:32:12,800 --> 00:32:19,629
I flip side so just 30 33 points in a
statement is effective but is not

315
00:32:19,630 --> 00:32:26,160
magical about the private reasons ideas
techniques and software are going to

316
00:32:26,160 --> 00:32:31,020
continue and the Muslim agreements not
really gonna do much slowed down to any

317
00:32:31,020 --> 00:32:38,269
questions

318
00:32:38,269 --> 00:32:41,669
thank you for coming so we really
appreciate it and a special thanks to

319
00:32:41,669 --> 00:32:45,479
Travis more of a creeper Jason
butterfield Chris Chancellor and bush

320
00:32:45,479 --> 00:32:46,679
water appreciate it thank you

