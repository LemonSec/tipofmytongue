1
00:00:00,000 --> 00:00:04,440
all right<font color="#E5E5E5"> welcome everyone this</font>

2
00:00:02,580 --> 00:00:06,450
<font color="#CCCCCC">presentation is called Red</font><font color="#E5E5E5"> Team</font>

3
00:00:04,440 --> 00:00:08,460
techniques for evading bypassing and

4
00:00:06,450 --> 00:00:10,580
disabling Microsoft advanced<font color="#E5E5E5"> threat</font>

5
00:00:08,460 --> 00:00:14,849
protection and advanced threat analytics

6
00:00:10,580 --> 00:00:16,379
<font color="#E5E5E5">so this picture</font><font color="#CCCCCC"> I'm from Canada</font><font color="#E5E5E5"> and I</font>

7
00:00:14,849 --> 00:00:19,980
always<font color="#CCCCCC"> love</font><font color="#E5E5E5"> this picture this is from</font>

8
00:00:16,379 --> 00:00:24,180
the IBM<font color="#E5E5E5"> Toronto downtown data center</font>

9
00:00:19,980 --> 00:00:28,920
from 1963<font color="#E5E5E5"> but now it's actually a sushi</font>

10
00:00:24,180 --> 00:00:35,309
restaurant so<font color="#CCCCCC"> I'm rep bandit I'm the red</font>

11
00:00:28,920 --> 00:00:38,070
teaming ops lead<font color="#E5E5E5"> 4x4 shred</font><font color="#CCCCCC"> part of the</font>

12
00:00:35,309 --> 00:00:39,930
crest board for crest USA<font color="#E5E5E5"> and I like</font>

13
00:00:38,070 --> 00:00:41,219
being<font color="#E5E5E5"> in</font><font color="#CCCCCC"> Europe because</font><font color="#E5E5E5"> crest actually</font>

14
00:00:39,930 --> 00:00:47,010
means something<font color="#E5E5E5"> here where nobody's</font>

15
00:00:41,219 --> 00:00:48,960
heard of<font color="#E5E5E5"> it in North America</font><font color="#CCCCCC"> I conduct</font>

16
00:00:47,010 --> 00:00:51,059
red teaming operations against defense

17
00:00:48,960 --> 00:00:53,399
contractors<font color="#E5E5E5"> and</font><font color="#CCCCCC"> some of</font><font color="#E5E5E5"> North</font><font color="#CCCCCC"> America's</font>

18
00:00:51,059 --> 00:00:58,230
largest banks so I don't actually do red

19
00:00:53,399 --> 00:01:00,840
teaming of IBM but for IBM<font color="#E5E5E5"> so why this</font>

20
00:00:58,230 --> 00:01:03,059
talk on Microsoft advanced analytics and

21
00:01:00,840 --> 00:01:04,860
advanced threat protection<font color="#E5E5E5"> well when</font>

22
00:01:03,059 --> 00:01:07,460
you're<font color="#E5E5E5"> testing really mature companies</font>

23
00:01:04,860 --> 00:01:09,539
I've come against<font color="#E5E5E5"> really</font><font color="#CCCCCC"> good that's</font>

24
00:01:07,460 --> 00:01:12,570
defensive strategies and detection

25
00:01:09,540 --> 00:01:16,170
<font color="#CCCCCC">strategies at clients they've integrated</font>

26
00:01:12,570 --> 00:01:18,000
tools like<font color="#CCCCCC"> system on</font><font color="#E5E5E5"> an app Locker and a</font>

27
00:01:16,170 --> 00:01:20,460
<font color="#CCCCCC">met</font><font color="#E5E5E5"> and they're using Windows Event log</font>

28
00:01:18,000 --> 00:01:22,710
<font color="#E5E5E5">forwarding they've</font><font color="#CCCCCC"> been implemented</font>

29
00:01:20,460 --> 00:01:25,020
products like CrowdStrike<font color="#E5E5E5"> and silence</font>

30
00:01:22,710 --> 00:01:28,020
for host behavior analytics products

31
00:01:25,020 --> 00:01:30,630
like rapid<font color="#E5E5E5"> 7</font><font color="#CCCCCC"> user insights for domain</font>

32
00:01:28,020 --> 00:01:33,240
behavior analytics<font color="#E5E5E5"> and</font><font color="#CCCCCC"> I've</font><font color="#E5E5E5"> spent a lot</font>

33
00:01:30,630 --> 00:01:35,339
<font color="#CCCCCC">of time figuring</font><font color="#E5E5E5"> how to bypass or evade</font>

34
00:01:33,240 --> 00:01:37,649
them as a whole and when I saw<font color="#E5E5E5"> that</font>

35
00:01:35,340 --> 00:01:40,140
Microsoft was coming out<font color="#CCCCCC"> with both host</font>

36
00:01:37,650 --> 00:01:42,750
and domain based behavior analytics

37
00:01:40,140 --> 00:01:44,579
tools and that<font color="#E5E5E5"> ATP or advanced threat</font>

38
00:01:42,750 --> 00:01:47,790
protection was actually built<font color="#E5E5E5"> into</font>

39
00:01:44,579 --> 00:01:50,729
Windows 10<font color="#E5E5E5"> itself</font><font color="#CCCCCC"> I knew this was an</font>

40
00:01:47,790 --> 00:01:53,670
area<font color="#E5E5E5"> that as attackers</font><font color="#CCCCCC"> we needed to</font>

41
00:01:50,729 --> 00:01:57,360
spend a lot more time on especially

42
00:01:53,670 --> 00:01:59,880
<font color="#CCCCCC">since both products are</font><font color="#E5E5E5"> actually in the</font>

43
00:01:57,360 --> 00:02:04,170
process<font color="#E5E5E5"> of being integrated</font><font color="#CCCCCC"> to under the</font>

44
00:01:59,880 --> 00:02:06,390
the advanced<font color="#E5E5E5"> threat protection brand so</font>

45
00:02:04,170 --> 00:02:08,910
I gave an original<font color="#E5E5E5"> version of this talk</font>

46
00:02:06,390 --> 00:02:13,230
back at<font color="#CCCCCC"> DEFCON</font><font color="#E5E5E5"> which is the first talk</font>

47
00:02:08,910 --> 00:02:13,950
on ATP<font color="#E5E5E5"> and the second on ata as</font><font color="#CCCCCC"> Nikhil</font>

48
00:02:13,230 --> 00:02:16,950
had done it

49
00:02:13,950 --> 00:02:18,869
<font color="#CCCCCC">gan ata like a day before mine but since</font>

50
00:02:16,950 --> 00:02:20,640
then I've upgraded and<font color="#E5E5E5"> heavily revised</font>

51
00:02:18,870 --> 00:02:23,040
this talk<font color="#E5E5E5"> because new versions have come</font>

52
00:02:20,640 --> 00:02:25,109
out<font color="#E5E5E5"> so they fixed a lot of</font><font color="#CCCCCC"> the bypasses</font>

53
00:02:23,040 --> 00:02:27,599
<font color="#CCCCCC">that I found back then so I've had to</font>

54
00:02:25,110 --> 00:02:30,209
find<font color="#CCCCCC"> more but there's probably a lot of</font>

55
00:02:27,599 --> 00:02:31,619
techniques I haven't<font color="#E5E5E5"> tested or found or</font>

56
00:02:30,209 --> 00:02:33,750
didn't think<font color="#CCCCCC"> of so hopefully it inspires</font>

57
00:02:31,620 --> 00:02:37,319
you<font color="#CCCCCC"> to get you know familiar</font><font color="#E5E5E5"> with these</font>

58
00:02:33,750 --> 00:02:40,620
tools yourself<font color="#E5E5E5"> so to set the stage when</font>

59
00:02:37,319 --> 00:02:43,589
I developed IBM x-force<font color="#CCCCCC"> Reds TTP's or</font>

60
00:02:40,620 --> 00:02:45,810
<font color="#CCCCCC">taktik</font><font color="#E5E5E5"> technical tactical techniques and</font>

61
00:02:43,590 --> 00:02:49,019
procedures for red teaming<font color="#CCCCCC"> I put a huge</font>

62
00:02:45,810 --> 00:02:51,230
<font color="#E5E5E5">emphasis on hosts recon and internal</font>

63
00:02:49,019 --> 00:02:55,410
recon being<font color="#CCCCCC"> two very distinct phases</font>

64
00:02:51,230 --> 00:02:58,590
which<font color="#CCCCCC"> will go into</font><font color="#E5E5E5"> why</font><font color="#CCCCCC"> in</font><font color="#E5E5E5"> a bit but as</font>

65
00:02:55,410 --> 00:03:00,690
as red teamers when we're operating

66
00:02:58,590 --> 00:03:02,549
<font color="#E5E5E5">against really mature blue teams we need</font>

67
00:03:00,690 --> 00:03:04,440
to gain<font color="#CCCCCC"> a</font><font color="#E5E5E5"> solid understanding of what</font>

68
00:03:02,549 --> 00:03:06,480
indicators<font color="#E5E5E5"> are compromised our tools and</font>

69
00:03:04,440 --> 00:03:07,980
techniques are leaving<font color="#E5E5E5"> behind what</font>

70
00:03:06,480 --> 00:03:09,810
commands might be caught by script

71
00:03:07,980 --> 00:03:12,000
logging what's<font color="#E5E5E5"> flag de</font><font color="#CCCCCC"> belen</font><font color="#E5E5E5"> system on</font>

72
00:03:09,810 --> 00:03:14,880
and importantly<font color="#CCCCCC"> how we can learn to use</font>

73
00:03:12,000 --> 00:03:17,370
<font color="#E5E5E5">techniques that avoid user behavior</font>

74
00:03:14,880 --> 00:03:19,079
analytics<font color="#E5E5E5"> because machine learnings you</font>

75
00:03:17,370 --> 00:03:20,310
know coming<font color="#E5E5E5"> down the pipes and and lot</font>

76
00:03:19,079 --> 00:03:22,739
of companies<font color="#E5E5E5"> are</font><font color="#CCCCCC"> going</font><font color="#E5E5E5"> to be</font>

77
00:03:20,310 --> 00:03:24,980
implementing better behavior analytics

78
00:03:22,739 --> 00:03:27,750
<font color="#E5E5E5">than what's been out there in the past</font>

79
00:03:24,980 --> 00:03:29,310
<font color="#E5E5E5">so here's a quick</font><font color="#CCCCCC"> overview of advanced</font>

80
00:03:27,750 --> 00:03:31,739
<font color="#E5E5E5">threat protection or Windows Defender</font>

81
00:03:29,310 --> 00:03:34,470
<font color="#E5E5E5">advanced</font><font color="#CCCCCC"> tent</font><font color="#E5E5E5"> protection it's currently</font>

82
00:03:31,739 --> 00:03:36,329
active on more<font color="#E5E5E5"> than</font><font color="#CCCCCC"> 2 million</font><font color="#E5E5E5"> devices I</font>

83
00:03:34,470 --> 00:03:40,290
think<font color="#E5E5E5"> most of those are at</font><font color="#CCCCCC"> Microsoft</font>

84
00:03:36,329 --> 00:03:42,560
<font color="#E5E5E5">itself but this is the cloud ATP</font>

85
00:03:40,290 --> 00:03:44,970
dashboard that<font color="#E5E5E5"> the sensors report</font><font color="#CCCCCC"> into</font>

86
00:03:42,560 --> 00:03:46,139
<font color="#E5E5E5">it's very</font><font color="#CCCCCC"> similar to</font><font color="#E5E5E5"> other</font><font color="#CCCCCC"> dashboards</font>

87
00:03:44,970 --> 00:03:49,139
you've seen out there<font color="#E5E5E5"> for products</font><font color="#CCCCCC"> like</font>

88
00:03:46,139 --> 00:03:51,209
CrowdStrike<font color="#CCCCCC"> the difference with ATP</font><font color="#E5E5E5"> is</font>

89
00:03:49,139 --> 00:03:54,150
like I<font color="#E5E5E5"> mentioned it's actually embedded</font>

90
00:03:51,209 --> 00:03:57,630
<font color="#E5E5E5">into Windows</font><font color="#CCCCCC"> 10 Enterprise so there's</font>

91
00:03:54,150 --> 00:04:01,049
there's no real you know<font color="#E5E5E5"> it's not hard</font>

92
00:03:57,630 --> 00:04:03,090
to to activate and install this on a

93
00:04:01,049 --> 00:04:04,470
Windows 10 desktop<font color="#CCCCCC"> because it's</font><font color="#E5E5E5"> already</font>

94
00:04:03,090 --> 00:04:05,970
<font color="#E5E5E5">installed it's just a matter of running</font>

95
00:04:04,470 --> 00:04:09,989
<font color="#E5E5E5">a quick script to activate the</font>

96
00:04:05,970 --> 00:04:14,190
functionality<font color="#CCCCCC"> release 3 recently came</font>

97
00:04:09,989 --> 00:04:17,099
bundled<font color="#E5E5E5"> with the Windows 10</font><font color="#CCCCCC"> 1709 or fall</font>

98
00:04:14,190 --> 00:04:22,200
<font color="#E5E5E5">creators or autumn update for you in the</font>

99
00:04:17,099 --> 00:04:25,800
UK<font color="#CCCCCC"> so it it came</font><font color="#E5E5E5"> bundled on I believe</font>

100
00:04:22,200 --> 00:04:27,120
October<font color="#E5E5E5"> 17th for the latest version</font><font color="#CCCCCC"> and</font>

101
00:04:25,800 --> 00:04:27,570
then the next versions<font color="#CCCCCC"> gonna</font><font color="#E5E5E5"> be coming</font>

102
00:04:27,120 --> 00:04:30,330
<font color="#E5E5E5">out</font><font color="#CCCCCC"> in this</font>

103
00:04:27,570 --> 00:04:31,980
spring<font color="#CCCCCC"> so these sensors that are</font>

104
00:04:30,330 --> 00:04:34,820
embedded<font color="#E5E5E5"> in Windows 10 they collect</font>

105
00:04:31,980 --> 00:04:37,770
behavioral<font color="#E5E5E5"> signals from the box like</font>

106
00:04:34,820 --> 00:04:40,620
processes that are running changes to

107
00:04:37,770 --> 00:04:41,909
the<font color="#CCCCCC"> registry file changes network</font>

108
00:04:40,620 --> 00:04:44,420
communications and they send all the

109
00:04:41,910 --> 00:04:47,060
sensor data to<font color="#E5E5E5"> the cloud and then</font>

110
00:04:44,420 --> 00:04:51,060
<font color="#CCCCCC">Microsoft's</font><font color="#E5E5E5"> intelligence security graph</font>

111
00:04:47,060 --> 00:04:52,830
<font color="#E5E5E5">applies behavioral</font><font color="#CCCCCC"> learning to it too</font><font color="#E5E5E5"> to</font>

112
00:04:51,060 --> 00:04:56,910
analyze the<font color="#CCCCCC"> data that's</font><font color="#E5E5E5"> coming</font><font color="#CCCCCC"> from</font><font color="#E5E5E5"> all</font>

113
00:04:52,830 --> 00:04:59,190
these different<font color="#CCCCCC"> sensors so as of last</font>

114
00:04:56,910 --> 00:05:01,670
<font color="#CCCCCC">month's while</font><font color="#E5E5E5"> creators update the</font>

115
00:04:59,190 --> 00:05:04,530
Windows Defender brand was a include

116
00:05:01,670 --> 00:05:06,930
expanded to include not<font color="#CCCCCC"> only</font><font color="#E5E5E5"> the</font>

117
00:05:04,530 --> 00:05:10,789
traditional<font color="#E5E5E5"> Windows Defender that we all</font>

118
00:05:06,930 --> 00:05:12,930
love<font color="#E5E5E5"> and hate</font><font color="#CCCCCC"> it's now</font><font color="#E5E5E5"> defender ATP</font>

119
00:05:10,790 --> 00:05:15,980
<font color="#CCCCCC">defender exploit guard which was</font>

120
00:05:12,930 --> 00:05:18,710
previously<font color="#CCCCCC"> omit if you've ever used that</font>

121
00:05:15,980 --> 00:05:21,510
application guard<font color="#CCCCCC"> device guard</font>

122
00:05:18,710 --> 00:05:23,969
credential guard<font color="#E5E5E5"> and it's actually been</font>

123
00:05:21,510 --> 00:05:28,610
expanded<font color="#CCCCCC"> to start to</font><font color="#E5E5E5"> cover Windows</font>

124
00:05:23,970 --> 00:05:32,570
Server 2012<font color="#E5E5E5"> r2 and 2016 it's also being</font>

125
00:05:28,610 --> 00:05:37,110
expanded to<font color="#E5E5E5"> work with other products</font><font color="#CCCCCC"> too</font>

126
00:05:32,570 --> 00:05:39,780
<font color="#CCCCCC">that are running on Linux so it can take</font>

127
00:05:37,110 --> 00:05:41,850
any behavioral<font color="#E5E5E5"> data from other</font>

128
00:05:39,780 --> 00:05:44,609
<font color="#CCCCCC">third-party products and crunch that in</font>

129
00:05:41,850 --> 00:05:46,110
the cloud as well<font color="#CCCCCC"> and then deep</font>

130
00:05:44,610 --> 00:05:47,460
integration with advanced<font color="#E5E5E5"> threat</font>

131
00:05:46,110 --> 00:05:49,980
analytics the other product we'll be

132
00:05:47,460 --> 00:05:51,870
talking about today<font color="#CCCCCC"> is</font><font color="#E5E5E5"> coming in the</font>

133
00:05:49,980 --> 00:05:56,100
fall<font color="#CCCCCC"> we're starting</font><font color="#E5E5E5"> in the</font><font color="#CCCCCC"> spring of</font>

134
00:05:51,870 --> 00:05:57,870
next year<font color="#E5E5E5"> so here's the release</font><font color="#CCCCCC"> tree</font>

135
00:05:56,100 --> 00:05:59,310
dashboard I mentioned it right if we

136
00:05:57,870 --> 00:06:02,280
look in the bottom<font color="#E5E5E5"> right corner</font><font color="#CCCCCC"> we'll</font>

137
00:05:59,310 --> 00:06:04,260
see the<font color="#E5E5E5"> entire new Windows</font><font color="#CCCCCC"> 10 security</font>

138
00:06:02,280 --> 00:06:06,780
stack all reporting<font color="#E5E5E5"> into a single</font>

139
00:06:04,260 --> 00:06:09,420
dashboard<font color="#CCCCCC"> and this is interesting</font><font color="#E5E5E5"> from a</font>

140
00:06:06,780 --> 00:06:11,400
attackers<font color="#CCCCCC"> perspective because</font><font color="#E5E5E5"> before all</font>

141
00:06:09,420 --> 00:06:13,620
of this data was<font color="#CCCCCC"> just</font><font color="#E5E5E5"> mostly sitting on</font>

142
00:06:11,400 --> 00:06:16,229
the<font color="#E5E5E5"> box</font><font color="#CCCCCC"> we didn't have to worry about</font>

143
00:06:13,620 --> 00:06:19,230
<font color="#E5E5E5">somebody forwarding it off the box we</font>

144
00:06:16,230 --> 00:06:21,390
didn't worry about<font color="#CCCCCC"> omit alerting on us</font>

145
00:06:19,230 --> 00:06:25,400
but now it's all easily<font color="#E5E5E5"> reporting into</font>

146
00:06:21,390 --> 00:06:28,020
the blue team<font color="#CCCCCC"> so it makes adoption of</font>

147
00:06:25,400 --> 00:06:29,849
<font color="#CCCCCC">you know a better defensive strategy a</font>

148
00:06:28,020 --> 00:06:35,010
lot easier for<font color="#CCCCCC"> these these blue teams</font>

149
00:06:29,850 --> 00:06:36,690
and then in release<font color="#CCCCCC"> 4 just quickly</font><font color="#E5E5E5"> this</font>

150
00:06:35,010 --> 00:06:39,188
<font color="#CCCCCC">is</font><font color="#E5E5E5"> what's coming</font><font color="#CCCCCC"> in the</font><font color="#E5E5E5"> spring so Auto</font>

151
00:06:36,690 --> 00:06:43,479
remediation so it's<font color="#E5E5E5"> going</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> use</font>

152
00:06:39,189 --> 00:06:44,679
<font color="#CCCCCC">windows firewall</font><font color="#E5E5E5"> and the exploit guard</font>

153
00:06:43,479 --> 00:06:47,229
and app guard and all<font color="#E5E5E5"> these different</font>

154
00:06:44,679 --> 00:06:49,239
security tools in the security stack to

155
00:06:47,229 --> 00:06:50,889
block<font color="#CCCCCC"> other threats across</font><font color="#E5E5E5"> the</font>

156
00:06:49,239 --> 00:06:53,289
<font color="#CCCCCC">enterprise so it detects an attack</font><font color="#E5E5E5"> on</font>

157
00:06:50,889 --> 00:06:55,959
one it's gonna automatically say apply

158
00:06:53,289 --> 00:07:00,878
firewall rules to<font color="#E5E5E5"> block</font><font color="#CCCCCC"> c2</font><font color="#E5E5E5"> for any</font>

159
00:06:55,959 --> 00:07:05,439
malware<font color="#E5E5E5"> to all endpoints so let's</font>

160
00:07:00,879 --> 00:07:08,649
actually look<font color="#E5E5E5"> at ATP</font><font color="#CCCCCC"> in play here's with</font>

161
00:07:05,439 --> 00:07:11,469
just a basic launcher download cradle

162
00:07:08,649 --> 00:07:14,619
from<font color="#E5E5E5"> PowerShell</font><font color="#CCCCCC"> Empire</font><font color="#E5E5E5"> or cobalt strike</font>

163
00:07:11,469 --> 00:07:17,529
<font color="#E5E5E5">you can see it's encoded</font><font color="#CCCCCC"> it's going to</font>

164
00:07:14,619 --> 00:07:19,959
detect that pretty easily<font color="#CCCCCC"> it's also</font>

165
00:07:17,529 --> 00:07:22,058
going<font color="#E5E5E5"> to detect really heavily heavy</font>

166
00:07:19,959 --> 00:07:24,699
heavily office<font color="#E5E5E5"> gated PowerShell commands</font>

167
00:07:22,059 --> 00:07:27,809
and ones<font color="#CCCCCC"> that we generate ourselves</font>

168
00:07:24,699 --> 00:07:30,879
using<font color="#E5E5E5"> say</font><font color="#CCCCCC"> the obfuscated</font><font color="#E5E5E5"> Empire project</font>

169
00:07:27,809 --> 00:07:33,189
<font color="#CCCCCC">this particular one</font><font color="#E5E5E5"> was a custom cradle</font>

170
00:07:30,879 --> 00:07:37,599
from cobalt strike with a reverse<font color="#E5E5E5"> DNS</font>

171
00:07:33,189 --> 00:07:39,509
payload<font color="#CCCCCC"> and the reason they can detect</font>

172
00:07:37,599 --> 00:07:42,039
<font color="#CCCCCC">this so so Microsoft gave us a really</font>

173
00:07:39,509 --> 00:07:42,639
<font color="#E5E5E5">amazing framework with PowerShell as</font>

174
00:07:42,039 --> 00:07:45,279
attackers

175
00:07:42,639 --> 00:07:48,189
we've been favoring using<font color="#CCCCCC"> PowerShell Exe</font>

176
00:07:45,279 --> 00:07:50,050
a<font color="#E5E5E5"> PowerShell</font><font color="#CCCCCC"> exe the</font><font color="#E5E5E5"> PowerShell core and</font>

177
00:07:48,189 --> 00:07:51,610
the underlying<font color="#CCCCCC"> Windows</font><font color="#E5E5E5"> management</font>

178
00:07:50,050 --> 00:07:53,769
framework for several years because<font color="#CCCCCC"> of</font>

179
00:07:51,610 --> 00:07:55,869
<font color="#E5E5E5">its flexibility and ease of use</font><font color="#CCCCCC"> so we've</font>

180
00:07:53,769 --> 00:07:57,789
been using<font color="#E5E5E5"> awesome tools that have come</font>

181
00:07:55,869 --> 00:08:00,789
out<font color="#CCCCCC"> that</font><font color="#E5E5E5"> leverage PowerShell like</font>

182
00:07:57,789 --> 00:08:03,308
PowerShell<font color="#E5E5E5"> Empire powerup unmanaged</font>

183
00:08:00,789 --> 00:08:06,219
PowerShell not<font color="#E5E5E5"> PowerShell</font><font color="#CCCCCC"> powersploit</font>

184
00:08:03,309 --> 00:08:07,929
<font color="#E5E5E5">and the</font><font color="#CCCCCC"> sharing power view user hunter</font>

185
00:08:06,219 --> 00:08:11,229
and bloodhound<font color="#CCCCCC"> so a lot of</font><font color="#E5E5E5"> you guys will</font>

186
00:08:07,929 --> 00:08:13,568
be familiar<font color="#E5E5E5"> with those tools but once we</font>

187
00:08:11,229 --> 00:08:15,579
<font color="#CCCCCC">had</font><font color="#E5E5E5"> got all</font><font color="#CCCCCC"> our tools focused</font><font color="#E5E5E5"> on</font>

188
00:08:13,569 --> 00:08:18,039
PowerShell<font color="#E5E5E5"> then Microsoft implemented</font>

189
00:08:15,579 --> 00:08:20,379
<font color="#E5E5E5">all</font><font color="#CCCCCC"> of this</font><font color="#E5E5E5"> logging and all these</font>

190
00:08:18,039 --> 00:08:22,628
different security features within

191
00:08:20,379 --> 00:08:26,740
PowerShell<font color="#CCCCCC"> to kind of take our new shiny</font>

192
00:08:22,629 --> 00:08:30,009
tools away<font color="#E5E5E5"> by implementing all these new</font>

193
00:08:26,740 --> 00:08:31,569
security improvements<font color="#E5E5E5"> so what are some</font>

194
00:08:30,009 --> 00:08:33,159
<font color="#E5E5E5">of these improvements if we look at with</font>

195
00:08:31,569 --> 00:08:35,829
the windows management<font color="#E5E5E5"> framework or</font>

196
00:08:33,159 --> 00:08:38,019
<font color="#E5E5E5">PowerShell version 5 that includes</font>

197
00:08:35,828 --> 00:08:40,000
script lock logging transaction and

198
00:08:38,019 --> 00:08:45,519
transcription logging it<font color="#CCCCCC"> Flags on</font>

199
00:08:40,000 --> 00:08:48,009
suspicious strings like - and<font color="#CCCCCC"> C it can</font>

200
00:08:45,519 --> 00:08:50,079
implement constrain language mode and it

201
00:08:48,009 --> 00:08:52,540
contains just<font color="#E5E5E5"> enough administration</font>

202
00:08:50,079 --> 00:08:54,279
support as a

203
00:08:52,540 --> 00:08:56,649
as most<font color="#E5E5E5"> people have been avoiding</font>

204
00:08:54,279 --> 00:08:58,810
<font color="#CCCCCC">powershell version 5 by just</font><font color="#E5E5E5"> calling</font>

205
00:08:56,649 --> 00:09:01,630
powershell version 2 which didn't have

206
00:08:58,810 --> 00:09:03,518
any of this<font color="#E5E5E5"> and that was installed by</font>

207
00:09:01,630 --> 00:09:05,949
default<font color="#E5E5E5"> so even if defenders had</font>

208
00:09:03,519 --> 00:09:08,290
upgraded<font color="#CCCCCC"> and installed</font><font color="#E5E5E5"> powershell</font>

209
00:09:05,949 --> 00:09:11,380
version 5 in the past<font color="#E5E5E5"> powershell version</font>

210
00:09:08,290 --> 00:09:15,310
<font color="#E5E5E5">two remained installed even unless they</font>

211
00:09:11,380 --> 00:09:18,279
specifically uninstall it<font color="#E5E5E5"> but in Windows</font>

212
00:09:15,310 --> 00:09:20,410
<font color="#E5E5E5">10 1709 or the fall creators update</font>

213
00:09:18,279 --> 00:09:22,329
<font color="#E5E5E5">they've removed support</font><font color="#CCCCCC"> for</font><font color="#E5E5E5"> powershell</font>

214
00:09:20,410 --> 00:09:24,459
version<font color="#E5E5E5"> 2</font><font color="#CCCCCC"> altogether so you can't</font>

215
00:09:22,329 --> 00:09:30,519
install<font color="#E5E5E5"> it if you wanted to as an</font>

216
00:09:24,459 --> 00:09:32,099
attacker<font color="#CCCCCC"> they've they've put in we'll</font>

217
00:09:30,519 --> 00:09:37,440
talk about<font color="#E5E5E5"> that a minute</font><font color="#CCCCCC"> they've put in</font>

218
00:09:32,100 --> 00:09:40,360
ways to not<font color="#E5E5E5"> only detect powershell</font>

219
00:09:37,440 --> 00:09:43,720
<font color="#E5E5E5">malicious commands but also</font><font color="#CCCCCC"> windows</font>

220
00:09:40,360 --> 00:09:47,050
scripting host<font color="#E5E5E5"> vbscript</font><font color="#CCCCCC"> and javascript</font>

221
00:09:43,720 --> 00:09:49,839
based<font color="#E5E5E5"> attacks</font><font color="#CCCCCC"> if you try to use tools</font>

222
00:09:47,050 --> 00:09:52,540
like<font color="#CCCCCC"> bent ends not powershell which</font>

223
00:09:49,839 --> 00:09:54,130
basically is just<font color="#E5E5E5"> a front end wrapper to</font>

224
00:09:52,540 --> 00:09:56,079
talk to the<font color="#CCCCCC"> backend windows management</font>

225
00:09:54,130 --> 00:09:57,790
framework<font color="#E5E5E5"> that's also gonna</font><font color="#CCCCCC"> be caught</font>

226
00:09:56,079 --> 00:09:58,989
<font color="#CCCCCC">because the commands still need to be</font>

227
00:09:57,790 --> 00:10:02,170
sent to<font color="#E5E5E5"> the</font><font color="#CCCCCC"> backend windows management</font>

228
00:09:58,990 --> 00:10:04,569
framework version<font color="#CCCCCC"> 5</font><font color="#E5E5E5"> and we've seen</font>

229
00:10:02,170 --> 00:10:07,360
bypasses for<font color="#CCCCCC"> a lot</font><font color="#E5E5E5"> of these like</font><font color="#CCCCCC"> covers</font>

230
00:10:04,569 --> 00:10:10,029
<font color="#CCCCCC">yes</font><font color="#E5E5E5"> amp</font><font color="#CCCCCC"> c tool or different comm</font>

231
00:10:07,360 --> 00:10:11,829
techniques but red teamers really need

232
00:10:10,029 --> 00:10:14,709
to streamline<font color="#CCCCCC"> and chain all those</font>

233
00:10:11,829 --> 00:10:16,300
<font color="#E5E5E5">bypasses together to actually</font><font color="#CCCCCC"> get code</font>

234
00:10:14,709 --> 00:10:19,000
execution on the<font color="#CCCCCC"> box get a reverse shell</font>

235
00:10:16,300 --> 00:10:21,550
<font color="#CCCCCC">and start to run commands</font><font color="#E5E5E5"> all without</font>

236
00:10:19,000 --> 00:10:24,490
<font color="#E5E5E5">being detected so that's</font><font color="#CCCCCC"> actually</font><font color="#E5E5E5"> pretty</font>

237
00:10:21,550 --> 00:10:25,990
difficult to do so<font color="#CCCCCC"> as a result of these</font>

238
00:10:24,490 --> 00:10:28,630
<font color="#CCCCCC">improvements we really need to go back</font>

239
00:10:25,990 --> 00:10:30,579
<font color="#CCCCCC">to living off the land</font><font color="#E5E5E5"> selectively</font>

240
00:10:28,630 --> 00:10:33,250
running<font color="#CCCCCC"> powershell only after we're</font>

241
00:10:30,579 --> 00:10:37,810
confident<font color="#CCCCCC"> that we've disabled ATP</font><font color="#E5E5E5"> and</font>

242
00:10:33,250 --> 00:10:41,800
other<font color="#CCCCCC"> next</font><font color="#E5E5E5"> gen antivirus products the</font>

243
00:10:37,810 --> 00:10:46,300
the real powerhouse

244
00:10:41,800 --> 00:10:48,550
security<font color="#CCCCCC"> I'd say technology that</font>

245
00:10:46,300 --> 00:10:50,589
<font color="#CCCCCC">Microsoft is put out lately</font><font color="#E5E5E5"> is amp C or</font>

246
00:10:48,550 --> 00:10:52,540
<font color="#CCCCCC">the anti-malware scanning interface and</font>

247
00:10:50,589 --> 00:10:58,240
this is the reason<font color="#CCCCCC"> that everything's</font>

248
00:10:52,540 --> 00:10:59,920
being<font color="#E5E5E5"> caught because before</font><font color="#CCCCCC"> so</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> MC</font>

249
00:10:58,240 --> 00:11:03,250
basically hooks the<font color="#CCCCCC"> Windows scripting</font>

250
00:10:59,920 --> 00:11:05,769
host so before an interpreter runs these

251
00:11:03,250 --> 00:11:06,360
malicious commands<font color="#E5E5E5"> everything</font><font color="#CCCCCC"> is the</font>

252
00:11:05,769 --> 00:11:09,420
office key

253
00:11:06,360 --> 00:11:11,610
everything's in plain text<font color="#CCCCCC"> and it's</font>

254
00:11:09,420 --> 00:11:13,949
gonna catch dynamic Java<font color="#E5E5E5"> vbscript and</font>

255
00:11:11,610 --> 00:11:16,350
PowerShell code<font color="#CCCCCC"> before it's executed</font>

256
00:11:13,950 --> 00:11:20,160
began its run before<font color="#E5E5E5"> run through the</font>

257
00:11:16,350 --> 00:11:21,480
Windows Defender<font color="#CCCCCC"> there's an article</font><font color="#E5E5E5"> that</font>

258
00:11:20,160 --> 00:11:24,260
was just put<font color="#E5E5E5"> out two days</font><font color="#CCCCCC"> ago if you</font>

259
00:11:21,480 --> 00:11:27,060
want to have a look more into<font color="#CCCCCC"> em see</font>

260
00:11:24,260 --> 00:11:28,740
it's also pretty<font color="#CCCCCC"> good</font><font color="#E5E5E5"> at detecting using</font>

261
00:11:27,060 --> 00:11:31,410
sign binaries to launch malicious

262
00:11:28,740 --> 00:11:34,320
executables<font color="#E5E5E5"> based on abnormal behavior</font>

263
00:11:31,410 --> 00:11:37,319
like connecting to a recently<font color="#CCCCCC"> registered</font>

264
00:11:34,320 --> 00:11:40,079
domain or connecting out to tour using

265
00:11:37,320 --> 00:11:43,320
<font color="#E5E5E5">vbscript</font><font color="#CCCCCC"> within a macro enabled document</font>

266
00:11:40,079 --> 00:11:45,719
for example<font color="#E5E5E5"> and you can</font><font color="#CCCCCC"> see based on</font>

267
00:11:43,320 --> 00:11:48,510
some<font color="#CCCCCC"> of these alert examples that</font><font color="#E5E5E5"> any of</font>

268
00:11:45,720 --> 00:11:50,760
the initial execution execution<font color="#E5E5E5"> host</font>

269
00:11:48,510 --> 00:11:52,620
recon<font color="#E5E5E5"> and privilege escalation</font>

270
00:11:50,760 --> 00:11:57,600
<font color="#E5E5E5">activities are going to be flagged due</font>

271
00:11:52,620 --> 00:12:00,450
to the underlying techniques used but so

272
00:11:57,600 --> 00:12:02,519
you can get on<font color="#CCCCCC"> a box initially</font>

273
00:12:00,450 --> 00:12:04,140
undetected using say<font color="#E5E5E5"> PowerShell Empire</font>

274
00:12:02,519 --> 00:12:06,720
but the name of<font color="#CCCCCC"> the game</font><font color="#E5E5E5"> is to not get</font>

275
00:12:04,140 --> 00:12:11,490
<font color="#E5E5E5">caught so early so instead we want</font><font color="#CCCCCC"> to</font>

276
00:12:06,720 --> 00:12:13,350
<font color="#E5E5E5">use basically we want to use</font><font color="#CCCCCC"> on office</font>

277
00:12:11,490 --> 00:12:15,810
gated JavaScript or VB script payloads

278
00:12:13,350 --> 00:12:18,529
<font color="#CCCCCC">that don't have kernel32 API</font>

279
00:12:15,810 --> 00:12:20,310
declarations in them<font color="#CCCCCC"> we want to</font><font color="#E5E5E5"> use</font>

280
00:12:18,529 --> 00:12:23,189
signed execs

281
00:12:20,310 --> 00:12:28,619
<font color="#E5E5E5">to load payloads like cobalt</font><font color="#CCCCCC"> strikes</font>

282
00:12:23,190 --> 00:12:30,690
<font color="#CCCCCC">staged lists DNS payload and then we</font>

283
00:12:28,620 --> 00:12:34,620
want to you know whenever<font color="#CCCCCC"> possible use</font>

284
00:12:30,690 --> 00:12:36,779
things like<font color="#CCCCCC"> veil and Ebola and shelter</font>

285
00:12:34,620 --> 00:12:41,160
to<font color="#CCCCCC"> key</font><font color="#E5E5E5"> you our malware whenever possible</font>

286
00:12:36,779 --> 00:12:44,519
<font color="#E5E5E5">and encrypt it</font><font color="#CCCCCC"> and so some some</font>

287
00:12:41,160 --> 00:12:49,079
techniques with<font color="#CCCCCC"> some payloads created</font>

288
00:12:44,519 --> 00:12:50,660
with<font color="#E5E5E5"> veil won't be detected but now that</font>

289
00:12:49,079 --> 00:12:53,939
we're on<font color="#CCCCCC"> the Box the challenge doesn't</font>

290
00:12:50,660 --> 00:12:55,680
<font color="#E5E5E5">stop when we get on the</font><font color="#CCCCCC"> Box undetected</font>

291
00:12:53,940 --> 00:12:57,660
initially that's<font color="#E5E5E5"> the easy part the</font>

292
00:12:55,680 --> 00:13:00,300
<font color="#E5E5E5">problem</font><font color="#CCCCCC"> is detection of activities that</font>

293
00:12:57,660 --> 00:13:02,760
we perform<font color="#E5E5E5"> after</font><font color="#CCCCCC"> we get</font><font color="#E5E5E5"> on the box</font><font color="#CCCCCC"> so</font>

294
00:13:00,300 --> 00:13:04,859
tools and commands that<font color="#CCCCCC"> are</font><font color="#E5E5E5"> running like</font>

295
00:13:02,760 --> 00:13:06,750
creating a<font color="#CCCCCC"> new process or doing host</font>

296
00:13:04,860 --> 00:13:10,380
recon and environmental settings or

297
00:13:06,750 --> 00:13:13,110
local groups<font color="#E5E5E5"> maybe we want to attempt to</font>

298
00:13:10,380 --> 00:13:16,560
<font color="#E5E5E5">bypass</font><font color="#CCCCCC"> host controls like app Locker and</font>

299
00:13:13,110 --> 00:13:20,029
<font color="#CCCCCC">omit and UAC and power shell constrain</font>

300
00:13:16,560 --> 00:13:23,429
language mode and amp<font color="#E5E5E5"> C and whatnot</font>

301
00:13:20,029 --> 00:13:25,529
we want to perform<font color="#CCCCCC"> privilege</font><font color="#E5E5E5"> escalation</font>

302
00:13:23,429 --> 00:13:29,039
to go from a<font color="#E5E5E5"> regular user to admin on</font>

303
00:13:25,529 --> 00:13:30,059
the box so all of these are<font color="#E5E5E5"> commands</font>

304
00:13:29,039 --> 00:13:32,729
that we have<font color="#CCCCCC"> to worry about getting</font>

305
00:13:30,059 --> 00:13:35,608
<font color="#E5E5E5">detected on so</font><font color="#CCCCCC"> as red teamers a lot of</font>

306
00:13:32,729 --> 00:13:37,470
these<font color="#E5E5E5"> will look pretty familiar to you</font>

307
00:13:35,609 --> 00:13:39,809
they're just<font color="#CCCCCC"> hosts recon host</font>

308
00:13:37,470 --> 00:13:43,589
information<font color="#CCCCCC"> gathering a lot of those are</font>

309
00:13:39,809 --> 00:13:45,478
gonna be flagged by<font color="#E5E5E5"> ATP because that's</font>

310
00:13:43,589 --> 00:13:49,470
pretty<font color="#CCCCCC"> suspicious that</font><font color="#E5E5E5"> a regular users</font>

311
00:13:45,479 --> 00:13:52,349
running<font color="#E5E5E5"> those commands</font><font color="#CCCCCC"> but not detected</font>

312
00:13:49,470 --> 00:13:57,149
is the windows management<font color="#E5E5E5"> interface or</font>

313
00:13:52,349 --> 00:14:01,589
WMI<font color="#CCCCCC"> we can run the WMI command line</font><font color="#E5E5E5"> W</font>

314
00:13:57,149 --> 00:14:03,599
make<font color="#E5E5E5"> or we can run the we can call the</font>

315
00:14:01,589 --> 00:14:04,949
underlying W my schema directly using

316
00:14:03,599 --> 00:14:07,889
different classes like we see at the

317
00:14:04,949 --> 00:14:10,559
<font color="#CCCCCC">bottom there</font><font color="#E5E5E5"> so</font><font color="#CCCCCC"> in release four in the</font>

318
00:14:07,889 --> 00:14:13,129
spring<font color="#E5E5E5"> allegedly they're coming out with</font>

319
00:14:10,559 --> 00:14:15,509
<font color="#CCCCCC">a lot of improved WMI detections but</font>

320
00:14:13,129 --> 00:14:18,949
<font color="#E5E5E5">we'll see how they do with</font><font color="#CCCCCC"> that but</font>

321
00:14:15,509 --> 00:14:18,949
<font color="#E5E5E5">right</font><font color="#CCCCCC"> now W my is your best bet</font>

322
00:14:19,289 --> 00:14:25,369
also if you directly call<font color="#CCCCCC"> windows</font><font color="#E5E5E5"> api's</font>

323
00:14:22,339 --> 00:14:28,229
<font color="#CCCCCC">and really return to living</font><font color="#E5E5E5"> off the land</font>

324
00:14:25,369 --> 00:14:30,659
<font color="#E5E5E5">we can call windows api's through raw</font>

325
00:14:28,229 --> 00:14:33,419
sockets with meterpreter such as the

326
00:14:30,659 --> 00:14:37,919
<font color="#E5E5E5">Metasploit post module that use windows</font>

327
00:14:33,419 --> 00:14:39,899
api is via<font color="#E5E5E5"> railgun</font><font color="#CCCCCC"> we can use cobalt</font>

328
00:14:37,919 --> 00:14:43,169
strike<font color="#CCCCCC"> a number of cobalt strike mode</font>

329
00:14:39,899 --> 00:14:45,869
modules or<font color="#CCCCCC"> api</font><font color="#E5E5E5"> only but before you run</font>

330
00:14:43,169 --> 00:14:47,519
these<font color="#E5E5E5"> commands you want to make</font><font color="#CCCCCC"> sure</font>

331
00:14:45,869 --> 00:14:49,859
they<font color="#CCCCCC"> actually are making</font><font color="#E5E5E5"> just local</font>

332
00:14:47,519 --> 00:14:52,829
calls<font color="#E5E5E5"> and they aren't a combination of</font>

333
00:14:49,859 --> 00:14:57,319
local calls<font color="#E5E5E5"> and</font><font color="#CCCCCC"> Network calls like local</font>

334
00:14:52,829 --> 00:15:01,559
<font color="#CCCCCC">admins search you know another</font>

335
00:14:57,319 --> 00:15:03,719
<font color="#E5E5E5">interesting way I saw that that</font><font color="#CCCCCC"> was we</font>

336
00:15:01,559 --> 00:15:06,709
could get on a box<font color="#E5E5E5"> but not only get out</font>

337
00:15:03,720 --> 00:15:09,239
<font color="#CCCCCC">of box we could even</font><font color="#E5E5E5"> as a regular user</font>

338
00:15:06,709 --> 00:15:11,309
<font color="#CCCCCC">maintain persistence on the box</font><font color="#E5E5E5"> after</font>

339
00:15:09,239 --> 00:15:14,159
<font color="#CCCCCC">the box is rebooted was through comm</font>

340
00:15:11,309 --> 00:15:14,939
hijacking so I watched a talk by sub T

341
00:15:14,159 --> 00:15:17,970
<font color="#CCCCCC">and enigma</font>

342
00:15:14,939 --> 00:15:21,748
at Wild<font color="#E5E5E5"> West hacking fest</font><font color="#CCCCCC"> last month and</font>

343
00:15:17,970 --> 00:15:23,359
it got me curious to look at where<font color="#E5E5E5"> ATP</font>

344
00:15:21,749 --> 00:15:25,859
might be<font color="#CCCCCC"> vulnerable or other</font>

345
00:15:23,359 --> 00:15:28,829
opportunities<font color="#E5E5E5"> to hijack comm and Windows</font>

346
00:15:25,859 --> 00:15:30,989
10<font color="#E5E5E5"> so after a</font><font color="#CCCCCC"> few hours</font><font color="#E5E5E5"> and a few drinks</font>

347
00:15:28,829 --> 00:15:32,959
<font color="#E5E5E5">with them</font><font color="#CCCCCC"> I found</font><font color="#E5E5E5"> several</font><font color="#CCCCCC"> new comm</font>

348
00:15:30,989 --> 00:15:34,699
hijacks<font color="#E5E5E5"> in Windows 10</font>

349
00:15:32,959 --> 00:15:37,849
which can<font color="#E5E5E5"> be used to get various</font>

350
00:15:34,699 --> 00:15:40,849
processes to run<font color="#E5E5E5"> our malware for us so</font>

351
00:15:37,850 --> 00:15:42,589
what<font color="#E5E5E5"> is calm</font><font color="#CCCCCC"> so for the sake of</font><font color="#E5E5E5"> time I</font>

352
00:15:40,850 --> 00:15:44,089
won't<font color="#CCCCCC"> go into too</font><font color="#E5E5E5"> much detail but and</font>

353
00:15:42,589 --> 00:15:47,180
you<font color="#E5E5E5"> can look at James for Shaw's</font>

354
00:15:44,089 --> 00:15:49,189
<font color="#E5E5E5">troopers</font><font color="#CCCCCC"> talked earlier this year</font><font color="#E5E5E5"> or the</font>

355
00:15:47,180 --> 00:15:51,439
<font color="#CCCCCC">windows archaeology</font><font color="#E5E5E5"> talked by</font><font color="#CCCCCC"> a KC map</font>

356
00:15:49,189 --> 00:15:54,980
but all you<font color="#E5E5E5"> really need</font><font color="#CCCCCC"> to know</font><font color="#E5E5E5"> is that</font>

357
00:15:51,439 --> 00:15:57,498
when a pro sets loads it uses calm to

358
00:15:54,980 --> 00:16:00,559
register and reference objects and

359
00:15:57,499 --> 00:16:04,339
settings within<font color="#E5E5E5"> the Windows registry</font><font color="#CCCCCC"> so</font>

360
00:16:00,559 --> 00:16:05,929
there<font color="#E5E5E5"> are several registry hives that</font>

361
00:16:04,339 --> 00:16:08,179
<font color="#E5E5E5">you'll probably be familiar with there's</font>

362
00:16:05,929 --> 00:16:10,309
H key local machine which only admins

363
00:16:08,179 --> 00:16:12,769
and system can write to then there's an

364
00:16:10,309 --> 00:16:15,230
H key current user which any user the

365
00:16:12,769 --> 00:16:18,259
current user can write to and these

366
00:16:15,230 --> 00:16:21,529
<font color="#CCCCCC">actually blend when you log</font><font color="#E5E5E5"> into Windows</font>

367
00:16:18,259 --> 00:16:26,689
they blend into a virtual<font color="#E5E5E5"> hive called</font>

368
00:16:21,529 --> 00:16:29,600
the<font color="#E5E5E5"> HK current</font><font color="#CCCCCC"> route</font><font color="#E5E5E5"> so if we can find</font>

369
00:16:26,689 --> 00:16:34,490
<font color="#E5E5E5">instances where comm</font><font color="#CCCCCC"> is loading settings</font>

370
00:16:29,600 --> 00:16:38,089
from<font color="#E5E5E5"> the current user registry</font><font color="#CCCCCC"> and those</font>

371
00:16:34,490 --> 00:16:41,600
settings don't<font color="#E5E5E5"> exist in HK local machine</font>

372
00:16:38,089 --> 00:16:42,790
those will<font color="#E5E5E5"> be populated up to HK</font><font color="#CCCCCC"> crk</font>

373
00:16:41,600 --> 00:16:46,129
current route

374
00:16:42,790 --> 00:16:48,439
so as an unprivileged user we can

375
00:16:46,129 --> 00:16:50,319
register<font color="#E5E5E5"> those missing registry keys and</font>

376
00:16:48,439 --> 00:16:55,610
<font color="#E5E5E5">have a process run our malicious payload</font>

377
00:16:50,319 --> 00:16:58,639
so in this<font color="#CCCCCC"> example we see references</font><font color="#E5E5E5"> to</font>

378
00:16:55,610 --> 00:17:02,600
HK<font color="#E5E5E5"> current route from various programs</font>

379
00:16:58,639 --> 00:17:04,880
<font color="#E5E5E5">and you'll see that those keys weren't</font>

380
00:17:02,600 --> 00:17:08,299
found<font color="#E5E5E5"> so that's where using tools like</font>

381
00:17:04,880 --> 00:17:11,199
<font color="#E5E5E5">process monitor</font><font color="#CCCCCC"> we</font><font color="#E5E5E5"> can identify</font><font color="#CCCCCC"> these</font>

382
00:17:08,299 --> 00:17:15,250
missing column entries and hi Jacqueline

383
00:17:11,199 --> 00:17:19,189
so here's a<font color="#E5E5E5"> basic script which basically</font>

384
00:17:15,250 --> 00:17:22,250
crates defines a new<font color="#CCCCCC"> comm class ID</font>

385
00:17:19,189 --> 00:17:24,500
<font color="#CCCCCC">within current</font><font color="#E5E5E5"> user and defends a comm</font>

386
00:17:22,250 --> 00:17:26,689
scriptlet URL for the class so<font color="#CCCCCC"> that</font>

387
00:17:24,500 --> 00:17:30,049
<font color="#E5E5E5">scriptlet URL that we see at the bottom</font>

388
00:17:26,689 --> 00:17:33,140
attacker slash payload SCT<font color="#E5E5E5"> that's</font>

389
00:17:30,049 --> 00:17:38,480
actually<font color="#E5E5E5"> just an XML file that contains</font>

390
00:17:33,140 --> 00:17:43,210
our payload written<font color="#E5E5E5"> in VB or J script we</font>

391
00:17:38,480 --> 00:17:43,210
could<font color="#E5E5E5"> also instead</font><font color="#CCCCCC"> of targeting</font>

392
00:17:43,660 --> 00:17:49,690
the treat<font color="#E5E5E5"> has moniker</font><font color="#CCCCCC"> we can target</font>

393
00:17:46,180 --> 00:17:53,380
stuff like monikers like<font color="#CCCCCC"> Proctor of</font><font color="#E5E5E5"> 32</font>

394
00:17:49,690 --> 00:17:55,450
and<font color="#E5E5E5"> just have them run</font><font color="#CCCCCC"> a</font><font color="#E5E5E5"> DLL instead</font><font color="#CCCCCC"> so</font>

395
00:17:53,380 --> 00:17:59,710
lots of different<font color="#E5E5E5"> keys are vulnerable</font><font color="#CCCCCC"> to</font>

396
00:17:55,450 --> 00:18:01,900
this or can be abused by this and here's

397
00:17:59,710 --> 00:18:03,550
the simplified<font color="#E5E5E5"> view for those that have</font>

398
00:18:01,900 --> 00:18:06,310
been in the<font color="#E5E5E5"> Windows registry before</font>

399
00:18:03,550 --> 00:18:08,830
we're basically<font color="#E5E5E5"> defining our payload and</font>

400
00:18:06,310 --> 00:18:12,490
our new class called<font color="#CCCCCC"> ac/dc just by</font>

401
00:18:08,830 --> 00:18:14,590
<font color="#CCCCCC">sub-team and then we're filling in that</font>

402
00:18:12,490 --> 00:18:17,190
missing<font color="#E5E5E5"> registry key which will be</font>

403
00:18:14,590 --> 00:18:21,189
populated<font color="#E5E5E5"> up to current route</font>

404
00:18:17,190 --> 00:18:23,740
so we're basically<font color="#E5E5E5"> saying for this</font>

405
00:18:21,190 --> 00:18:25,870
missing key treat is treated as our

406
00:18:23,740 --> 00:18:30,430
malicious class and execute<font color="#E5E5E5"> our</font>

407
00:18:25,870 --> 00:18:32,800
malicious payload and now when we<font color="#E5E5E5"> even</font>

408
00:18:30,430 --> 00:18:34,450
after reboot various processes are<font color="#E5E5E5"> going</font>

409
00:18:32,800 --> 00:18:37,270
to load our malicious payload from

410
00:18:34,450 --> 00:18:41,470
either HP current user or<font color="#CCCCCC"> HP current</font>

411
00:18:37,270 --> 00:18:43,360
route<font color="#CCCCCC"> and it will run our payloads you</font>

412
00:18:41,470 --> 00:18:46,150
know for<font color="#CCCCCC"> example 50 instances</font><font color="#E5E5E5"> of calc</font>

413
00:18:43,360 --> 00:18:47,889
<font color="#E5E5E5">when I'm testing but any medium</font>

414
00:18:46,150 --> 00:18:49,420
integrity process<font color="#E5E5E5"> that calls this</font>

415
00:18:47,890 --> 00:18:50,920
missing column object is<font color="#E5E5E5"> going to run</font>

416
00:18:49,420 --> 00:18:55,240
our malware<font color="#E5E5E5"> for us and we can create</font>

417
00:18:50,920 --> 00:18:59,020
<font color="#E5E5E5">that malware using</font><font color="#CCCCCC"> James's</font><font color="#E5E5E5"> dotnet</font><font color="#CCCCCC"> to</font>

418
00:18:55,240 --> 00:19:04,240
<font color="#CCCCCC">jscript or we can just call</font><font color="#E5E5E5"> a malicious</font>

419
00:18:59,020 --> 00:19:06,250
DLL instead<font color="#CCCCCC"> the best part of</font><font color="#E5E5E5"> this</font>

420
00:19:04,240 --> 00:19:10,470
technique is<font color="#E5E5E5"> that you can use it to</font>

421
00:19:06,250 --> 00:19:13,330
bypass<font color="#E5E5E5"> MC because MC only triggers on</font>

422
00:19:10,470 --> 00:19:15,690
<font color="#CCCCCC">eval or</font><font color="#E5E5E5"> dynamic script creation for</font>

423
00:19:13,330 --> 00:19:18,300
<font color="#E5E5E5">Windows scripting</font><font color="#CCCCCC"> host so all of those</font>

424
00:19:15,690 --> 00:19:22,390
<font color="#E5E5E5">improvements to vbscript and jscript</font>

425
00:19:18,300 --> 00:19:26,320
<font color="#CCCCCC">that ATP relies on for detection</font><font color="#E5E5E5"> aren't</font>

426
00:19:22,390 --> 00:19:28,750
triggered so now we're at a point where

427
00:19:26,320 --> 00:19:31,530
<font color="#CCCCCC">we have persistence on the box</font><font color="#E5E5E5"> and we</font>

428
00:19:28,750 --> 00:19:35,830
can run whatever<font color="#E5E5E5"> we want against the box</font>

429
00:19:31,530 --> 00:19:38,560
let's look at how we can kill<font color="#E5E5E5"> ATP</font>

430
00:19:35,830 --> 00:19:42,760
<font color="#CCCCCC">altogether</font><font color="#E5E5E5"> after we've managed to maybe</font>

431
00:19:38,560 --> 00:19:44,530
elevate to admit so unlike other

432
00:19:42,760 --> 00:19:48,150
antiviruses we can't just use<font color="#CCCCCC"> these</font>

433
00:19:44,530 --> 00:19:53,190
common techniques to kill antivirus<font color="#CCCCCC"> a</font>

434
00:19:48,150 --> 00:19:53,190
lot of these<font color="#E5E5E5"> won't work even</font><font color="#CCCCCC"> as an admin</font>

435
00:19:53,490 --> 00:19:57,010
you could maybe modify file permissions

436
00:19:56,380 --> 00:20:01,150
on log

437
00:19:57,010 --> 00:20:04,510
but that's very<font color="#CCCCCC"> noisy and easy to detect</font>

438
00:20:01,150 --> 00:20:06,070
unlike other cloud AV or next-gen AV

439
00:20:04,510 --> 00:20:07,720
products like CrowdStrike you can't just

440
00:20:06,070 --> 00:20:11,889
<font color="#CCCCCC">uninstall them</font><font color="#E5E5E5"> from an elevated command</font>

441
00:20:07,720 --> 00:20:14,650
prompt<font color="#CCCCCC"> ATP requires an a generated</font>

442
00:20:11,890 --> 00:20:17,680
<font color="#E5E5E5">off-boarding script with a sha-256</font><font color="#CCCCCC"> sign</font>

443
00:20:14,650 --> 00:20:20,440
key based on the unique org ID and

444
00:20:17,680 --> 00:20:22,270
certificate and the reason as an admin

445
00:20:20,440 --> 00:20:25,960
you can't stop<font color="#CCCCCC"> ATP is because of</font>

446
00:20:22,270 --> 00:20:28,139
protected process light so<font color="#E5E5E5"> ppl was a</font>

447
00:20:25,960 --> 00:20:30,610
<font color="#E5E5E5">mechanism that came out in Windows 8.1</font>

448
00:20:28,140 --> 00:20:33,100
<font color="#CCCCCC">that transferred many of the security</font>

449
00:20:30,610 --> 00:20:36,010
<font color="#E5E5E5">restrictions apply to system processes</font>

450
00:20:33,100 --> 00:20:38,080
to user remote processes<font color="#E5E5E5"> so the binary</font>

451
00:20:36,010 --> 00:20:41,650
is actually signed<font color="#E5E5E5"> by a Windows signing</font>

452
00:20:38,080 --> 00:20:43,389
cert<font color="#E5E5E5"> and the</font><font color="#CCCCCC"> Windows ppl verification</font>

453
00:20:41,650 --> 00:20:46,180
extended key use is in the bottom<font color="#CCCCCC"> right</font>

454
00:20:43,390 --> 00:20:48,850
there<font color="#E5E5E5"> so after the services launch has</font>

455
00:20:46,180 --> 00:20:51,310
launched as protected<font color="#CCCCCC"> Windows uses code</font>

456
00:20:48,850 --> 00:20:54,070
integrity to not only allow<font color="#CCCCCC"> trusts</font><font color="#E5E5E5"> to</font>

457
00:20:51,310 --> 00:20:57,040
only allow trusted code to be injected

458
00:20:54,070 --> 00:20:59,350
into these processes<font color="#CCCCCC"> so</font><font color="#E5E5E5"> you know we</font>

459
00:20:57,040 --> 00:21:02,020
can't use<font color="#E5E5E5"> say me me cats to inject into</font>

460
00:20:59,350 --> 00:21:05,439
<font color="#E5E5E5">L SAS if alsace is running as a ppl for</font>

461
00:21:02,020 --> 00:21:08,230
example so if you want<font color="#E5E5E5"> to know more</font>

462
00:21:05,440 --> 00:21:10,240
about ppl<font color="#CCCCCC"> zelich</font><font color="#E5E5E5"> sionis</font><font color="#CCCCCC"> you covered them</font>

463
00:21:08,230 --> 00:21:12,310
<font color="#CCCCCC">extensively in an older blog post but</font>

464
00:21:10,240 --> 00:21:15,900
until now<font color="#E5E5E5"> we</font><font color="#CCCCCC"> actually haven't</font><font color="#E5E5E5"> seen</font><font color="#CCCCCC"> t pls</font>

465
00:21:12,310 --> 00:21:15,899
widely implemented<font color="#E5E5E5"> at all</font>

466
00:21:15,930 --> 00:21:25,510
there was a ppl bypass<font color="#E5E5E5"> for traditional</font>

467
00:21:20,140 --> 00:21:28,320
<font color="#E5E5E5">Windows Defender because defender can be</font>

468
00:21:25,510 --> 00:21:32,460
modified<font color="#CCCCCC"> by trusted installer only</font>

469
00:21:28,320 --> 00:21:37,960
basically project zeros bypass<font color="#E5E5E5"> was to</font>

470
00:21:32,460 --> 00:21:40,060
set the bin path of trusted installer to

471
00:21:37,960 --> 00:21:42,070
stop Windows Defender and<font color="#E5E5E5"> delete Windows</font>

472
00:21:40,060 --> 00:21:44,980
Defender<font color="#E5E5E5"> and then start the service up</font>

473
00:21:42,070 --> 00:21:47,980
again but since released<font color="#CCCCCC"> - they've</font>

474
00:21:44,980 --> 00:21:50,410
changed<font color="#CCCCCC"> a TP - now run</font><font color="#E5E5E5"> as a Windows ppl</font>

475
00:21:47,980 --> 00:21:53,080
protection level instead of<font color="#CCCCCC"> anti-male or</font>

476
00:21:50,410 --> 00:21:54,850
ppl and the process is configured as not

477
00:21:53,080 --> 00:21:58,810
stoppable so we can't use<font color="#CCCCCC"> the same</font>

478
00:21:54,850 --> 00:22:00,310
technique against a TP<font color="#E5E5E5"> and there's an</font>

479
00:21:58,810 --> 00:22:03,300
alert<font color="#CCCCCC"> that'll come up if you do try to</font>

480
00:22:00,310 --> 00:22:03,300
<font color="#E5E5E5">use it against a TV</font>

481
00:22:05,130 --> 00:22:12,880
so this is<font color="#E5E5E5"> this is a good quote by Matt</font>

482
00:22:07,980 --> 00:22:15,640
<font color="#E5E5E5">it's basically stating that as an</font>

483
00:22:12,880 --> 00:22:18,160
attacker<font color="#CCCCCC"> you know we we have to not only</font>

484
00:22:15,640 --> 00:22:20,559
<font color="#E5E5E5">get on a box initially we have to become</font>

485
00:22:18,160 --> 00:22:22,510
<font color="#CCCCCC">admin and we have to</font><font color="#E5E5E5"> bypass all the</font>

486
00:22:20,559 --> 00:22:24,940
<font color="#E5E5E5">logging</font><font color="#CCCCCC"> out there so as a defender you</font>

487
00:22:22,510 --> 00:22:26,920
<font color="#E5E5E5">have so many</font><font color="#CCCCCC"> opportunities to</font><font color="#E5E5E5"> detect</font>

488
00:22:24,940 --> 00:22:29,770
attackers even if they have admin on a

489
00:22:26,920 --> 00:22:31,690
box<font color="#CCCCCC"> you want to watch out for</font><font color="#E5E5E5"> them you</font>

490
00:22:29,770 --> 00:22:33,280
know<font color="#E5E5E5"> blocking Windows Event log</font>

491
00:22:31,690 --> 00:22:37,540
forwarding and bypassing all those

492
00:22:33,280 --> 00:22:42,100
controls we talked about<font color="#E5E5E5"> so using some</font>

493
00:22:37,540 --> 00:22:44,110
<font color="#E5E5E5">privileged techniques in release</font><font color="#CCCCCC"> two we</font>

494
00:22:42,100 --> 00:22:45,730
can't stop<font color="#CCCCCC"> ATP</font><font color="#E5E5E5"> anymore because it's</font>

495
00:22:44,110 --> 00:22:48,790
running<font color="#E5E5E5"> as a ppl and a protective</font>

496
00:22:45,730 --> 00:22:50,550
process<font color="#E5E5E5"> or sorry in release two it</font>

497
00:22:48,790 --> 00:22:54,730
wasn't

498
00:22:50,550 --> 00:22:59,050
now diag track is running as a ppl and

499
00:22:54,730 --> 00:23:00,820
<font color="#CCCCCC">Diet track</font><font color="#E5E5E5"> is</font><font color="#CCCCCC"> the service</font><font color="#E5E5E5"> that ATP uses</font>

500
00:22:59,050 --> 00:23:03,040
to communicate<font color="#CCCCCC"> out to</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> windows cloud</font>

501
00:23:00,820 --> 00:23:06,790
<font color="#E5E5E5">so it's the windows telemetry service</font>

502
00:23:03,040 --> 00:23:08,950
and in in release<font color="#E5E5E5"> two we could just stop</font>

503
00:23:06,790 --> 00:23:11,080
that service and prevent anything from

504
00:23:08,950 --> 00:23:15,280
connecting<font color="#E5E5E5"> out to the cloud since then</font>

505
00:23:11,080 --> 00:23:17,439
<font color="#E5E5E5">Microsoft's fix that and also made the</font>

506
00:23:15,280 --> 00:23:23,920
telemetry<font color="#E5E5E5"> service of ppl that we can't</font>

507
00:23:17,440 --> 00:23:26,440
stop<font color="#E5E5E5"> but they didn't flag it as not</font>

508
00:23:23,920 --> 00:23:28,870
stoppable<font color="#E5E5E5"> so we can use that</font><font color="#CCCCCC"> same</font>

509
00:23:26,440 --> 00:23:32,740
<font color="#E5E5E5">Windows Defender ppl bypass to stop it</font>

510
00:23:28,870 --> 00:23:37,540
by just changing the<font color="#CCCCCC"> location</font><font color="#E5E5E5"> of its bin</font>

511
00:23:32,740 --> 00:23:38,890
file<font color="#E5E5E5"> to to something non-existent as an</font>

512
00:23:37,540 --> 00:23:40,990
admin we don't have permissions<font color="#CCCCCC"> to</font>

513
00:23:38,890 --> 00:23:43,179
rename or delete the<font color="#CCCCCC"> HTTP binaries</font>

514
00:23:40,990 --> 00:23:44,110
however it is<font color="#CCCCCC"> vulnerable to DLL</font>

515
00:23:43,179 --> 00:23:48,340
hijacking

516
00:23:44,110 --> 00:23:52,240
so<font color="#E5E5E5"> since CNC proxy is just the</font>

517
00:23:48,340 --> 00:23:55,120
<font color="#CCCCCC">communication</font><font color="#E5E5E5"> module of ATP and</font><font color="#CCCCCC"> its</font>

518
00:23:52,240 --> 00:23:58,390
supposed to load the<font color="#CCCCCC"> Windows HTTP</font>

519
00:23:55,120 --> 00:24:00,760
services DLL from system<font color="#CCCCCC"> 32 but it</font>

520
00:23:58,390 --> 00:24:04,540
<font color="#E5E5E5">actually checks</font><font color="#CCCCCC"> within its own folder</font>

521
00:24:00,760 --> 00:24:08,140
first for<font color="#E5E5E5"> that DLL so as an admin though</font>

522
00:24:04,540 --> 00:24:12,428
we can't delete<font color="#E5E5E5"> sense proxy exe we can</font>

523
00:24:08,140 --> 00:24:15,970
create<font color="#CCCCCC"> DLLs</font><font color="#E5E5E5"> in in the program folder and</font>

524
00:24:12,429 --> 00:24:17,890
so we can you know either create

525
00:24:15,970 --> 00:24:20,260
non-existent dll's

526
00:24:17,890 --> 00:24:22,720
or we can create malicious dll's in

527
00:24:20,260 --> 00:24:24,850
there and that'll hijack the

528
00:24:22,720 --> 00:24:26,080
communication flow because<font color="#E5E5E5"> sense proxy</font>

529
00:24:24,850 --> 00:24:28,060
is called every five minutes<font color="#E5E5E5"> to</font>

530
00:24:26,080 --> 00:24:30,040
communicate to the cloud<font color="#E5E5E5"> so if it loads</font>

531
00:24:28,060 --> 00:24:32,800
our<font color="#E5E5E5"> DLL instead it won't actually</font>

532
00:24:30,040 --> 00:24:36,990
successfully load and it's just gonna

533
00:24:32,800 --> 00:24:36,990
crash as we see at the<font color="#CCCCCC"> bottom there</font>

534
00:24:37,620 --> 00:24:45,040
<font color="#CCCCCC">another way</font><font color="#E5E5E5"> to remove ppl protection for</font>

535
00:24:42,970 --> 00:24:48,790
a process<font color="#E5E5E5"> and this wasn't</font><font color="#CCCCCC"> very</font><font color="#E5E5E5"> well</font>

536
00:24:45,040 --> 00:24:51,210
documented at all<font color="#CCCCCC"> in me me cots</font><font color="#E5E5E5"> it was</font>

537
00:24:48,790 --> 00:24:54,850
originally created so you could remove

538
00:24:51,210 --> 00:24:58,990
<font color="#E5E5E5">ppl protection from Alsace in Windows 10</font>

539
00:24:54,850 --> 00:25:02,530
<font color="#CCCCCC">s but</font><font color="#E5E5E5"> we can actually use that to remove</font>

540
00:24:58,990 --> 00:25:05,620
process<font color="#E5E5E5"> ppl protection from</font><font color="#CCCCCC"> MS sense or</font>

541
00:25:02,530 --> 00:25:06,970
the<font color="#CCCCCC"> HTTP executable and just kill it</font>

542
00:25:05,620 --> 00:25:14,469
outright

543
00:25:06,970 --> 00:25:18,430
since then the<font color="#CCCCCC"> Mimi cots driver is now</font>

544
00:25:14,470 --> 00:25:19,990
registered<font color="#E5E5E5"> as malicious by ATP so it's</font>

545
00:25:18,430 --> 00:25:25,240
<font color="#E5E5E5">actually what it's actually</font><font color="#CCCCCC"> assigned</font>

546
00:25:19,990 --> 00:25:28,630
driver<font color="#CCCCCC"> the Benjamin created</font><font color="#E5E5E5"> and it loads</font>

547
00:25:25,240 --> 00:25:30,910
as<font color="#CCCCCC"> Mimi drive so we can go</font><font color="#E5E5E5"> into Mimi</font>

548
00:25:28,630 --> 00:25:32,770
drive and we<font color="#E5E5E5"> can change what it's</font>

549
00:25:30,910 --> 00:25:35,770
loading as we<font color="#CCCCCC"> can you</font><font color="#E5E5E5"> know we can</font><font color="#CCCCCC"> say it</font>

550
00:25:32,770 --> 00:25:43,330
it loads<font color="#CCCCCC"> as</font><font color="#E5E5E5"> anything we want the problem</font>

551
00:25:35,770 --> 00:25:46,570
is this<font color="#CCCCCC"> is a signed binary</font><font color="#E5E5E5"> and it it</font>

552
00:25:43,330 --> 00:25:49,449
requires a valid<font color="#E5E5E5"> kernel evey code</font>

553
00:25:46,570 --> 00:25:52,000
signing cert to sign it<font color="#E5E5E5"> so for</font><font color="#CCCCCC"> most</font>

554
00:25:49,450 --> 00:25:53,860
<font color="#E5E5E5">people</font><font color="#CCCCCC"> that's</font><font color="#E5E5E5"> out</font><font color="#CCCCCC"> of their realm of</font>

555
00:25:52,000 --> 00:25:56,230
possibility because they have to first

556
00:25:53,860 --> 00:26:00,340
register a company<font color="#E5E5E5"> and then they have to</font>

557
00:25:56,230 --> 00:26:03,280
<font color="#E5E5E5">have Microsoft or a</font><font color="#CCCCCC"> edy</font><font color="#E5E5E5"> certificate</font>

558
00:26:00,340 --> 00:26:05,050
authority<font color="#CCCCCC"> do some extended checks to</font>

559
00:26:03,280 --> 00:26:07,210
make<font color="#CCCCCC"> sure that it's a</font><font color="#E5E5E5"> legitimate</font><font color="#CCCCCC"> company</font>

560
00:26:05,050 --> 00:26:09,159
in<font color="#CCCCCC"> that you</font><font color="#E5E5E5"> actually work for it so</font><font color="#CCCCCC"> as</font>

561
00:26:07,210 --> 00:26:10,840
<font color="#E5E5E5">you know IBM obviously has access to</font>

562
00:26:09,160 --> 00:26:13,780
<font color="#E5E5E5">lots of code signing certs but for the</font>

563
00:26:10,840 --> 00:26:15,639
<font color="#E5E5E5">average person</font><font color="#CCCCCC"> not only is</font><font color="#E5E5E5"> it difficult</font>

564
00:26:13,780 --> 00:26:18,850
<font color="#CCCCCC">to get</font><font color="#E5E5E5"> one but it's really hard to avoid</font>

565
00:26:15,640 --> 00:26:21,210
<font color="#E5E5E5">at attrition</font><font color="#CCCCCC"> because you know they can</font>

566
00:26:18,850 --> 00:26:24,730
<font color="#CCCCCC">easily see who created that certificate</font>

567
00:26:21,210 --> 00:26:27,160
<font color="#CCCCCC">it now also</font><font color="#E5E5E5"> alerts on ppl tampering so</font>

568
00:26:24,730 --> 00:26:30,100
if we removed process protection and

569
00:26:27,160 --> 00:26:31,780
then<font color="#CCCCCC"> there's the service restarted it's</font>

570
00:26:30,100 --> 00:26:34,659
going to flag<font color="#E5E5E5"> that</font>

571
00:26:31,780 --> 00:26:37,899
we can get around that<font color="#CCCCCC"> after Ms sense is</font>

572
00:26:34,660 --> 00:26:39,910
killed by just again changing<font color="#CCCCCC"> the bin</font>

573
00:26:37,900 --> 00:26:42,670
path<font color="#E5E5E5"> but there's a lot easy there's a</font>

574
00:26:39,910 --> 00:26:44,980
much better way out there so we can<font color="#CCCCCC"> use</font>

575
00:26:42,670 --> 00:26:47,860
<font color="#E5E5E5">James for</font><font color="#CCCCCC"> chess technique to become</font>

576
00:26:44,980 --> 00:26:52,120
trusted<font color="#E5E5E5"> installer from admin and then</font>

577
00:26:47,860 --> 00:26:54,159
once we're trusted installer<font color="#E5E5E5"> we can have</font>

578
00:26:52,120 --> 00:26:57,120
<font color="#CCCCCC">write</font><font color="#E5E5E5"> permissions to</font><font color="#CCCCCC"> the program files</font>

579
00:26:54,160 --> 00:27:00,510
directory<font color="#E5E5E5"> and</font><font color="#CCCCCC"> we can just rename atps</font>

580
00:26:57,120 --> 00:27:02,919
executables<font color="#E5E5E5"> to whatever we like so</font>

581
00:27:00,510 --> 00:27:07,660
<font color="#E5E5E5">that's a much cleaner</font><font color="#CCCCCC"> way to do it</font><font color="#E5E5E5"> and</font>

582
00:27:02,920 --> 00:27:10,060
it<font color="#E5E5E5"> won't be flagged by ATP but my</font>

583
00:27:07,660 --> 00:27:12,130
preferred<font color="#CCCCCC"> technique is to make Microsoft</font>

584
00:27:10,060 --> 00:27:14,649
turn the gun<font color="#E5E5E5"> on itself</font><font color="#CCCCCC"> so here's a</font>

585
00:27:12,130 --> 00:27:17,380
snippet<font color="#CCCCCC"> from my PowerShell script I put</font>

586
00:27:14,650 --> 00:27:20,080
together it's on my github<font color="#E5E5E5"> basically all</font>

587
00:27:17,380 --> 00:27:22,570
it does is resolve all the hosts<font color="#E5E5E5"> that</font>

588
00:27:20,080 --> 00:27:26,169
Microsoft's communicating or ATP is

589
00:27:22,570 --> 00:27:28,050
communicating to<font color="#E5E5E5"> in the cloud and</font><font color="#CCCCCC"> just</font>

590
00:27:26,170 --> 00:27:31,330
adds a firewall<font color="#CCCCCC"> rule to block them and</font>

591
00:27:28,050 --> 00:27:33,820
the great thing<font color="#CCCCCC"> about this</font><font color="#E5E5E5"> technique is</font>

592
00:27:31,330 --> 00:27:35,980
<font color="#E5E5E5">you can also use this to block Windows</font>

593
00:27:33,820 --> 00:27:38,980
Event log forwarding to block like

594
00:27:35,980 --> 00:27:40,900
system on and<font color="#CCCCCC"> Pskov and you can just</font>

595
00:27:38,980 --> 00:27:43,930
base<font color="#CCCCCC"> it on a port or a service instead</font>

596
00:27:40,900 --> 00:27:46,630
of an IP<font color="#E5E5E5"> but but this is</font><font color="#CCCCCC"> a easy</font><font color="#E5E5E5"> way to</font>

597
00:27:43,930 --> 00:27:49,090
do<font color="#E5E5E5"> it and I</font><font color="#CCCCCC"> think that's actually</font><font color="#E5E5E5"> the</font>

598
00:27:46,630 --> 00:27:52,560
<font color="#CCCCCC">best approach because</font><font color="#E5E5E5"> that really can't</font>

599
00:27:49,090 --> 00:27:55,929
be<font color="#E5E5E5"> fixed</font><font color="#CCCCCC"> nobody is going</font><font color="#E5E5E5"> to be</font>

600
00:27:52,560 --> 00:27:57,669
preventing people from creating firewall

601
00:27:55,930 --> 00:28:00,940
rules unless<font color="#E5E5E5"> they specifically done it</font>

602
00:27:57,670 --> 00:28:02,920
in group policy<font color="#E5E5E5"> it doesn't</font><font color="#CCCCCC"> require</font>

603
00:28:00,940 --> 00:28:05,800
escalating the system to modify file

604
00:28:02,920 --> 00:28:08,410
permissions or find a ppl bypass<font color="#E5E5E5"> doesn't</font>

605
00:28:05,800 --> 00:28:12,700
<font color="#CCCCCC">require creating some new signed</font><font color="#E5E5E5"> kernel</font>

606
00:28:08,410 --> 00:28:14,410
module<font color="#CCCCCC"> and now that we've blocked ATP</font>

607
00:28:12,700 --> 00:28:15,850
<font color="#E5E5E5">and event log forwarding</font><font color="#CCCCCC"> and system on</font>

608
00:28:14,410 --> 00:28:21,660
and all<font color="#CCCCCC"> that we</font><font color="#E5E5E5"> really</font><font color="#CCCCCC"> don't</font><font color="#E5E5E5"> care what</font>

609
00:28:15,850 --> 00:28:24,129
<font color="#E5E5E5">we've done against the</font><font color="#CCCCCC"> local box the</font>

610
00:28:21,660 --> 00:28:25,780
problem comes when organizations are

611
00:28:24,130 --> 00:28:28,960
using<font color="#CCCCCC"> other products</font><font color="#E5E5E5"> to</font><font color="#CCCCCC"> manage the</font>

612
00:28:25,780 --> 00:28:30,610
firewall like McAfee hips<font color="#E5E5E5"> so if that's</font>

613
00:28:28,960 --> 00:28:33,840
<font color="#E5E5E5">the case you'd have to use one of the</font>

614
00:28:30,610 --> 00:28:36,159
other<font color="#CCCCCC"> techniques</font><font color="#E5E5E5"> because we can't</font>

615
00:28:33,840 --> 00:28:39,909
<font color="#E5E5E5">actually modify the firewall rules in</font>

616
00:28:36,160 --> 00:28:41,290
<font color="#E5E5E5">that case as easy so now we're at a</font>

617
00:28:39,910 --> 00:28:43,420
point where we can comfortably run

618
00:28:41,290 --> 00:28:44,290
commands<font color="#CCCCCC"> without being flagged by a</font>

619
00:28:43,420 --> 00:28:46,030
local

620
00:28:44,290 --> 00:28:48,309
Windows Defender<font color="#E5E5E5"> advanced threat</font>

621
00:28:46,030 --> 00:28:51,250
protection instance<font color="#E5E5E5"> let's actually</font><font color="#CCCCCC"> look</font>

622
00:28:48,309 --> 00:28:54,250
at the second product called advanced

623
00:28:51,250 --> 00:28:56,970
threat analytics<font color="#E5E5E5"> it's intended</font><font color="#CCCCCC"> to detect</font>

624
00:28:54,250 --> 00:28:59,669
<font color="#E5E5E5">typical Active Directory</font><font color="#CCCCCC"> recon and</font>

625
00:28:56,970 --> 00:29:02,770
lateral movement and credential attacks

626
00:28:59,669 --> 00:29:06,690
<font color="#CCCCCC">so a lot of</font><font color="#E5E5E5"> those attacks are there that</font>

627
00:29:02,770 --> 00:29:09,190
<font color="#E5E5E5">you</font><font color="#CCCCCC"> see</font><font color="#E5E5E5"> it's pretty decent</font><font color="#CCCCCC"> at detecting</font>

628
00:29:06,690 --> 00:29:11,350
this is the<font color="#E5E5E5"> architecture all you really</font>

629
00:29:09,190 --> 00:29:14,980
<font color="#E5E5E5">need to</font><font color="#CCCCCC"> know</font><font color="#E5E5E5"> is</font><font color="#CCCCCC"> it's collecting logs off</font>

630
00:29:11,350 --> 00:29:15,928
of the domain controller<font color="#E5E5E5"> and forwarding</font>

631
00:29:14,980 --> 00:29:21,130
them to you<font color="#CCCCCC"> ata</font>

632
00:29:15,929 --> 00:29:23,350
<font color="#E5E5E5">in the upcoming</font><font color="#CCCCCC"> version of Azur</font><font color="#E5E5E5"> ATP</font><font color="#CCCCCC"> or</font>

633
00:29:21,130 --> 00:29:26,590
<font color="#E5E5E5">basically advanced threat analytics</font><font color="#CCCCCC"> in</font>

634
00:29:23,350 --> 00:29:29,740
<font color="#E5E5E5">the cloud instead</font><font color="#CCCCCC"> of fording those logs</font>

635
00:29:26,590 --> 00:29:32,530
to a local instance it's now forwarding

636
00:29:29,740 --> 00:29:35,049
them to the Microsoft cloud and it's

637
00:29:32,530 --> 00:29:38,860
<font color="#E5E5E5">combining all of the telemetry data from</font>

638
00:29:35,049 --> 00:29:41,200
ATP with<font color="#E5E5E5"> HEA using the intelligent</font>

639
00:29:38,860 --> 00:29:42,639
security graph so this<font color="#CCCCCC"> versions not</font>

640
00:29:41,200 --> 00:29:45,429
going to be out for<font color="#CCCCCC"> three months I have</font>

641
00:29:42,640 --> 00:29:47,620
an invite to<font color="#CCCCCC"> the beta right now but they</font>

642
00:29:45,429 --> 00:29:49,660
haven't changed<font color="#CCCCCC"> any</font><font color="#E5E5E5"> functionality yet</font>

643
00:29:47,620 --> 00:29:51,010
<font color="#E5E5E5">it's coming</font><font color="#CCCCCC"> in a</font><font color="#E5E5E5"> couple months</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> when</font>

644
00:29:49,660 --> 00:29:53,280
it does come it's actually going<font color="#E5E5E5"> to be a</font>

645
00:29:51,010 --> 00:29:55,809
really formidable solution<font color="#E5E5E5"> because</font>

646
00:29:53,280 --> 00:29:57,490
you're<font color="#E5E5E5"> not only leveraging all that</font>

647
00:29:55,809 --> 00:30:01,389
<font color="#E5E5E5">telemetry data from every individual</font>

648
00:29:57,490 --> 00:30:04,000
<font color="#E5E5E5">endpoint</font><font color="#CCCCCC"> you're</font><font color="#E5E5E5"> also leveraging security</font>

649
00:30:01,390 --> 00:30:07,960
events from domain controllers<font color="#E5E5E5"> to to</font>

650
00:30:04,000 --> 00:30:10,929
alert on attacker behavior and quickly

651
00:30:07,960 --> 00:30:13,570
there's the the<font color="#E5E5E5"> ATA console</font><font color="#CCCCCC"> that you'd</font>

652
00:30:10,929 --> 00:30:18,250
<font color="#E5E5E5">log into and it shows all</font><font color="#CCCCCC"> the attacks in</font>

653
00:30:13,570 --> 00:30:19,990
progress so because<font color="#E5E5E5"> it's behavior on</font>

654
00:30:18,250 --> 00:30:23,380
analytics it takes a little<font color="#E5E5E5"> bit</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> time</font>

655
00:30:19,990 --> 00:30:26,770
to baseline normal behavior<font color="#CCCCCC"> especially</font>

656
00:30:23,380 --> 00:30:31,120
for abnormal behavior from users so

657
00:30:26,770 --> 00:30:33,610
already peeing<font color="#E5E5E5"> two random boxes using</font>

658
00:30:31,120 --> 00:30:38,830
dackel abuse<font color="#E5E5E5"> to modify sensitive groups</font>

659
00:30:33,610 --> 00:30:41,080
using<font color="#CCCCCC"> recon</font><font color="#E5E5E5"> obviously to prevent false</font>

660
00:30:38,830 --> 00:30:43,120
positives it will it needs some learning

661
00:30:41,080 --> 00:30:44,439
time otherwise it's not going<font color="#E5E5E5"> to be a</font>

662
00:30:43,120 --> 00:30:47,489
very useful<font color="#E5E5E5"> tool because it's going to</font>

663
00:30:44,440 --> 00:30:50,110
be flagging<font color="#CCCCCC"> a regular user behavior</font><font color="#E5E5E5"> and</font>

664
00:30:47,490 --> 00:30:52,780
<font color="#CCCCCC">so in a lab</font><font color="#E5E5E5"> when I'm testing</font><font color="#CCCCCC"> this it's</font>

665
00:30:50,110 --> 00:30:54,699
<font color="#E5E5E5">obviously pretty hard for me to</font><font color="#CCCCCC"> simulate</font>

666
00:30:52,780 --> 00:30:57,190
a twenty thousand person corporate

667
00:30:54,700 --> 00:30:57,730
environment in a little lab but there's

668
00:30:57,190 --> 00:30:59,919
basic

669
00:30:57,730 --> 00:31:02,019
<font color="#E5E5E5">principles of user behavior analytics</font>

670
00:30:59,919 --> 00:31:05,710
that<font color="#E5E5E5"> we can stick to to avoid</font><font color="#CCCCCC"> being</font>

671
00:31:02,019 --> 00:31:07,450
flagged<font color="#CCCCCC"> for abnormal user behavior</font><font color="#E5E5E5"> so as</font>

672
00:31:05,710 --> 00:31:09,850
an attacker we can leverage<font color="#E5E5E5"> our</font><font color="#CCCCCC"> TP</font>

673
00:31:07,450 --> 00:31:11,590
history<font color="#E5E5E5"> a</font><font color="#CCCCCC"> PowerShell</font><font color="#E5E5E5"> history we can look</font>

674
00:31:09,850 --> 00:31:14,019
at users bookmarks to make sure that

675
00:31:11,590 --> 00:31:15,820
<font color="#E5E5E5">we're only</font><font color="#CCCCCC"> visiting sites we know in the</font>

676
00:31:14,019 --> 00:31:21,429
corporate directory that<font color="#CCCCCC"> they should be</font>

677
00:31:15,820 --> 00:31:24,309
and key<font color="#E5E5E5"> we can use passive</font><font color="#CCCCCC"> tools</font><font color="#E5E5E5"> like</font>

678
00:31:21,429 --> 00:31:26,260
Wireshark<font color="#CCCCCC"> to</font><font color="#E5E5E5"> baseline what activity is</font>

679
00:31:24,309 --> 00:31:29,408
<font color="#CCCCCC">on the local network</font><font color="#E5E5E5"> and make sure that</font>

680
00:31:26,260 --> 00:31:30,970
we're<font color="#E5E5E5"> only targeting those boxes Tom</font>

681
00:31:29,409 --> 00:31:33,639
Porter<font color="#E5E5E5"> did a talk on extending</font>

682
00:31:30,970 --> 00:31:35,649
bloodhound<font color="#CCCCCC"> he talked about</font><font color="#E5E5E5"> mapping</font><font color="#CCCCCC"> out</font>

683
00:31:33,639 --> 00:31:37,840
connections based<font color="#E5E5E5"> on net stat a couple</font>

684
00:31:35,649 --> 00:31:43,809
of weeks<font color="#CCCCCC"> ago</font><font color="#E5E5E5"> which is another great</font>

685
00:31:37,840 --> 00:31:45,870
technique<font color="#CCCCCC"> so let's let's look at how</font>

686
00:31:43,809 --> 00:31:49,240
we're performing internal network recon

687
00:31:45,870 --> 00:31:51,370
so if you're<font color="#CCCCCC"> performing bulk DNS queries</font>

688
00:31:49,240 --> 00:31:56,500
are doing nslookup or trying zone

689
00:31:51,370 --> 00:31:58,870
transfers<font color="#CCCCCC"> that's gonna be flagged</font><font color="#E5E5E5"> if you</font>

690
00:31:56,500 --> 00:32:00,549
try to use things like net user<font color="#CCCCCC"> slash</font>

691
00:31:58,870 --> 00:32:02,709
<font color="#E5E5E5">domain to get more information about</font>

692
00:32:00,549 --> 00:32:04,539
particular user<font color="#CCCCCC"> accounts that's using</font>

693
00:32:02,710 --> 00:32:06,340
the<font color="#CCCCCC"> Samer protocol and that's</font><font color="#E5E5E5"> gonna be</font>

694
00:32:04,539 --> 00:32:11,500
flagged because<font color="#E5E5E5"> that's that's pretty</font>

695
00:32:06,340 --> 00:32:14,199
abnormal<font color="#E5E5E5"> for users to be doing that but</font>

696
00:32:11,500 --> 00:32:19,990
not detected as if we use<font color="#E5E5E5"> LDAP instead</font>

697
00:32:14,200 --> 00:32:21,940
of<font color="#CCCCCC"> Samer so we can use Power View</font><font color="#E5E5E5"> to</font>

698
00:32:19,990 --> 00:32:24,220
first grab a list of computers and group

699
00:32:21,940 --> 00:32:26,380
members<font color="#E5E5E5"> which is pretty normal</font><font color="#CCCCCC"> traffic</font>

700
00:32:24,220 --> 00:32:27,820
on a<font color="#CCCCCC"> domain and really hard to flag and</font>

701
00:32:26,380 --> 00:32:30,970
<font color="#E5E5E5">flagging on this would would lead to a</font>

702
00:32:27,820 --> 00:32:34,299
lot<font color="#CCCCCC"> of false positives</font><font color="#E5E5E5"> we can this is my</font>

703
00:32:30,970 --> 00:32:37,269
preferred<font color="#E5E5E5"> technique and you'll see in</font>

704
00:32:34,299 --> 00:32:44,700
this example<font color="#E5E5E5"> we're actually doing</font><font color="#CCCCCC"> WI</font>

705
00:32:37,269 --> 00:32:47,919
queries against the local<font color="#CCCCCC"> namespace so</font>

706
00:32:44,700 --> 00:32:49,899
this is really<font color="#E5E5E5"> interesting because we're</font>

707
00:32:47,919 --> 00:32:52,330
gathering all the information<font color="#CCCCCC"> about the</font>

708
00:32:49,899 --> 00:32:54,760
<font color="#E5E5E5">domain but we're running it against the</font>

709
00:32:52,330 --> 00:32:56,918
<font color="#CCCCCC">local box which has a</font><font color="#E5E5E5"> relatively up to</font>

710
00:32:54,760 --> 00:32:59,590
<font color="#E5E5E5">make up up-to-date copy of most of the</font>

711
00:32:56,919 --> 00:33:01,929
information<font color="#CCCCCC"> in in an Active Directory</font>

712
00:32:59,590 --> 00:33:04,418
domain<font color="#E5E5E5"> so none of this traffic's going</font>

713
00:33:01,929 --> 00:33:06,549
over the wire<font color="#CCCCCC"> it's not being run against</font>

714
00:33:04,419 --> 00:33:11,019
the domain controller so it<font color="#CCCCCC"> it's</font>

715
00:33:06,549 --> 00:33:11,170
impossible<font color="#CCCCCC"> for a TA to flag on that so</font>

716
00:33:11,019 --> 00:33:12,730
you

717
00:33:11,170 --> 00:33:15,040
you can use WMI CIM and<font color="#CCCCCC"> let's in</font>

718
00:33:12,730 --> 00:33:17,880
<font color="#CCCCCC">powershell version 2 or sim commandlets</font>

719
00:33:15,040 --> 00:33:20,379
<font color="#CCCCCC">and</font><font color="#E5E5E5"> powershell version 3 which are shown</font>

720
00:33:17,880 --> 00:33:23,680
alternatively<font color="#CCCCCC"> you could use the WMI</font>

721
00:33:20,380 --> 00:33:26,560
command<font color="#CCCCCC"> line we can also use this</font><font color="#E5E5E5"> method</font>

722
00:33:23,680 --> 00:33:29,470
<font color="#E5E5E5">to even see if a TA is in use in the in</font>

723
00:33:26,560 --> 00:33:31,480
the<font color="#CCCCCC"> environment</font><font color="#E5E5E5"> so once we get on a box</font>

724
00:33:29,470 --> 00:33:33,820
and we're worried about performing recon

725
00:33:31,480 --> 00:33:36,070
against the internal<font color="#E5E5E5"> domain we can first</font>

726
00:33:33,820 --> 00:33:37,840
check that<font color="#CCCCCC"> this group even exists in the</font>

727
00:33:36,070 --> 00:33:40,570
environment<font color="#CCCCCC"> and if this group</font><font color="#E5E5E5"> doesn't</font>

728
00:33:37,840 --> 00:33:43,870
<font color="#E5E5E5">exist we know that a</font><font color="#CCCCCC"> TA 1.8 is not in</font>

729
00:33:40,570 --> 00:33:46,330
use in the environment<font color="#CCCCCC"> so we're free to</font>

730
00:33:43,870 --> 00:33:52,060
run all the internal enumeration that<font color="#E5E5E5"> we</font>

731
00:33:46,330 --> 00:33:55,689
want<font color="#CCCCCC"> it's really difficult to</font><font color="#E5E5E5"> prevent</font>

732
00:33:52,060 --> 00:33:58,860
this<font color="#CCCCCC"> you'd have to</font><font color="#E5E5E5"> monitor the local</font>

733
00:33:55,690 --> 00:34:02,050
<font color="#E5E5E5">security event</font><font color="#CCCCCC"> log sort of nid for $7.99</font>

734
00:33:58,860 --> 00:34:03,459
<font color="#CCCCCC">and</font><font color="#E5E5E5"> filtering on the security ID not</font>

735
00:34:02,050 --> 00:34:05,230
being in the system<font color="#CCCCCC"> so it's really</font>

736
00:34:03,460 --> 00:34:09,340
<font color="#E5E5E5">difficult to detect people doing</font>

737
00:34:05,230 --> 00:34:12,360
enumeration using this technique also

738
00:34:09,340 --> 00:34:16,270
tools like user hunter and bloodhound

739
00:34:12,360 --> 00:34:18,820
<font color="#E5E5E5">which uses user hunter to query servers</font>

740
00:34:16,270 --> 00:34:22,090
to find all active SMB sessions so net

741
00:34:18,820 --> 00:34:24,010
net user session enumeration to grab all

742
00:34:22,090 --> 00:34:25,720
the user<font color="#E5E5E5"> doors and IPS associated with</font>

743
00:34:24,010 --> 00:34:28,510
those SMB sessions is going to be caught

744
00:34:25,719 --> 00:34:30,370
so if you've<font color="#E5E5E5"> ever used bloodhound you'll</font>

745
00:34:28,510 --> 00:34:32,620
see how valuable<font color="#CCCCCC"> this technique is</font><font color="#E5E5E5"> to</font>

746
00:34:30,370 --> 00:34:35,469
most attackers because they can use it

747
00:34:32,620 --> 00:34:38,168
to<font color="#E5E5E5"> map out</font><font color="#CCCCCC"> exactly who has</font><font color="#E5E5E5"> a session on</font>

748
00:34:35,469 --> 00:34:40,989
what box<font color="#E5E5E5"> in the domain and then map out</font>

749
00:34:38,168 --> 00:34:45,100
the attack<font color="#E5E5E5"> path against those users but</font>

750
00:34:40,989 --> 00:34:47,529
by<font color="#E5E5E5"> default user hunter first queries the</font>

751
00:34:45,100 --> 00:34:50,168
DC for a list of domain<font color="#CCCCCC"> member</font><font color="#E5E5E5"> computers</font>

752
00:34:47,530 --> 00:34:51,910
<font color="#E5E5E5">which will</font><font color="#CCCCCC"> also include</font><font color="#E5E5E5"> that all of the</font>

753
00:34:50,168 --> 00:34:57,400
domain controllers in<font color="#CCCCCC"> the environment</font><font color="#E5E5E5"> if</font>

754
00:34:51,909 --> 00:34:59,470
you run a default user hunter<font color="#CCCCCC"> or</font>

755
00:34:57,400 --> 00:35:02,440
bloodhound against a domain it's gonna

756
00:34:59,470 --> 00:35:05,500
be flagged because<font color="#E5E5E5"> you enumerated the</font>

757
00:35:02,440 --> 00:35:08,770
sessions<font color="#E5E5E5"> from the domain controllers so</font>

758
00:35:05,500 --> 00:35:11,470
if we see in the<font color="#CCCCCC"> bottom right it it's</font>

759
00:35:08,770 --> 00:35:17,020
<font color="#CCCCCC">flagging based on against a domain</font>

760
00:35:11,470 --> 00:35:19,390
controller but we can get around this by

761
00:35:17,020 --> 00:35:22,509
manually providing a list of computers

762
00:35:19,390 --> 00:35:24,910
that<font color="#CCCCCC"> don't include</font><font color="#E5E5E5"> the DC so this was</font>

763
00:35:22,510 --> 00:35:25,300
the this is a much<font color="#E5E5E5"> you know it takes a</font>

764
00:35:24,910 --> 00:35:27,310
long

765
00:35:25,300 --> 00:35:29,980
<font color="#E5E5E5">longer time</font><font color="#CCCCCC"> to go in and edit all of</font>

766
00:35:27,310 --> 00:35:32,440
your domain<font color="#CCCCCC"> controllers</font><font color="#E5E5E5"> out of that list</font>

767
00:35:29,980 --> 00:35:33,580
<font color="#CCCCCC">that you're supplying with computer file</font>

768
00:35:32,440 --> 00:35:38,050
flag there

769
00:35:33,580 --> 00:35:40,810
luckily the<font color="#CCCCCC"> bloodhound gang put out a</font>

770
00:35:38,050 --> 00:35:43,540
new<font color="#E5E5E5"> version called</font><font color="#CCCCCC"> char</font><font color="#E5E5E5"> pound and they</font>

771
00:35:40,810 --> 00:35:46,299
included the flag for<font color="#CCCCCC"> me</font><font color="#E5E5E5"> or</font><font color="#CCCCCC"> for s called</font>

772
00:35:43,540 --> 00:35:48,250
exclude DC so now<font color="#CCCCCC"> that</font><font color="#E5E5E5"> traffic is no</font>

773
00:35:46,300 --> 00:35:50,320
longer<font color="#E5E5E5"> going against domain controllers</font>

774
00:35:48,250 --> 00:35:52,270
<font color="#E5E5E5">so when you're running</font><font color="#CCCCCC"> Nets session</font>

775
00:35:50,320 --> 00:35:53,620
enumeration or<font color="#CCCCCC"> Dhakal enumeration just</font>

776
00:35:52,270 --> 00:35:58,300
make sure that<font color="#CCCCCC"> you're including the</font>

777
00:35:53,620 --> 00:36:01,029
exclude DC flag so now that we've

778
00:35:58,300 --> 00:36:04,150
gathered info on potential part targets

779
00:36:01,030 --> 00:36:07,180
such as privileged users or you know

780
00:36:04,150 --> 00:36:09,070
admin<font color="#E5E5E5"> workstations let's look at how to</font>

781
00:36:07,180 --> 00:36:12,000
<font color="#CCCCCC">perform lateral movement against these</font>

782
00:36:09,070 --> 00:36:15,160
boxes<font color="#CCCCCC"> so this typically involves</font>

783
00:36:12,000 --> 00:36:18,790
leveraging<font color="#E5E5E5"> the gathered SMB session</font>

784
00:36:15,160 --> 00:36:22,180
enumeration<font color="#CCCCCC"> espy info or SPN</font><font color="#E5E5E5"> info sorry</font>

785
00:36:18,790 --> 00:36:23,730
<font color="#CCCCCC">80</font><font color="#E5E5E5"> group info to target accounts and</font>

786
00:36:22,180 --> 00:36:27,040
then performing remote code execution

787
00:36:23,730 --> 00:36:28,900
<font color="#E5E5E5">via techniques or remote exploits</font><font color="#CCCCCC"> to</font>

788
00:36:27,040 --> 00:36:30,310
gain access to those other systems<font color="#E5E5E5"> and</font>

789
00:36:28,900 --> 00:36:36,280
<font color="#E5E5E5">move around the domain and elevate our</font>

790
00:36:30,310 --> 00:36:38,410
privileges so if we're targeting<font color="#E5E5E5"> the</font>

791
00:36:36,280 --> 00:36:40,870
domain controllers itself<font color="#CCCCCC"> ata is pretty</font>

792
00:36:38,410 --> 00:36:45,370
<font color="#E5E5E5">decent at detecting PS exec and W my</font>

793
00:36:40,870 --> 00:36:47,680
<font color="#CCCCCC">exact against a DC it may detect due</font><font color="#E5E5E5"> to</font>

794
00:36:45,370 --> 00:36:49,960
abnormal user behavior against a main

795
00:36:47,680 --> 00:36:51,609
<font color="#E5E5E5">member so me targeting another</font>

796
00:36:49,960 --> 00:36:54,150
<font color="#CCCCCC">workstation or another server in the</font>

797
00:36:51,610 --> 00:36:57,610
domain<font color="#E5E5E5"> using any of those techniques</font>

798
00:36:54,150 --> 00:37:00,270
because of abnormal behavior if it sees

799
00:36:57,610 --> 00:37:03,340
somebody<font color="#E5E5E5"> in marketing going after a key</font>

800
00:37:00,270 --> 00:37:05,350
security<font color="#E5E5E5"> server that's pretty abnormal</font>

801
00:37:03,340 --> 00:37:08,110
<font color="#CCCCCC">because it's never</font><font color="#E5E5E5"> seen anyone from that</font>

802
00:37:05,350 --> 00:37:11,890
<font color="#CCCCCC">domain user group in the past go against</font>

803
00:37:08,110 --> 00:37:14,500
<font color="#CCCCCC">that box let alone the user itself</font><font color="#E5E5E5"> so to</font>

804
00:37:11,890 --> 00:37:18,190
avoid<font color="#CCCCCC"> that</font><font color="#E5E5E5"> whenever possible again we</font>

805
00:37:14,500 --> 00:37:22,630
want<font color="#E5E5E5"> to leverage</font><font color="#CCCCCC"> powershell history</font><font color="#E5E5E5"> in</font>

806
00:37:18,190 --> 00:37:25,210
<font color="#E5E5E5">our DP history and passively monitor the</font>

807
00:37:22,630 --> 00:37:28,330
<font color="#E5E5E5">local domain traffic to see what boxes</font>

808
00:37:25,210 --> 00:37:30,370
are<font color="#E5E5E5"> frequently talked to with users and</font>

809
00:37:28,330 --> 00:37:32,529
then we also want to<font color="#CCCCCC"> use session</font>

810
00:37:30,370 --> 00:37:34,960
enumeration against these boxes to see

811
00:37:32,530 --> 00:37:36,310
who should<font color="#E5E5E5"> be logging</font><font color="#CCCCCC"> into these</font><font color="#E5E5E5"> boxes</font>

812
00:37:34,960 --> 00:37:38,880
because they<font color="#CCCCCC"> already have a valid</font>

813
00:37:36,310 --> 00:37:38,880
session there

814
00:37:38,990 --> 00:37:47,089
not detected is<font color="#CCCCCC"> SPN numeration</font><font color="#E5E5E5"> and</font>

815
00:37:43,940 --> 00:37:49,250
kerberos ting so any user if you're not

816
00:37:47,090 --> 00:37:50,960
familiar with<font color="#E5E5E5"> it can enumerate service</font>

817
00:37:49,250 --> 00:37:53,270
<font color="#CCCCCC">principal names associated</font><font color="#E5E5E5"> with service</font>

818
00:37:50,960 --> 00:37:56,090
accounts<font color="#E5E5E5"> and then they can request their</font>

819
00:37:53,270 --> 00:38:00,410
Kerberos<font color="#E5E5E5"> TGS ticket which is encrypted</font>

820
00:37:56,090 --> 00:38:03,020
<font color="#E5E5E5">with</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> accounts ntlm hash requesting</font>

821
00:38:00,410 --> 00:38:04,700
these tickets blends<font color="#E5E5E5"> in as regular</font>

822
00:38:03,020 --> 00:38:06,380
Active Directory traffic it's really

823
00:38:04,700 --> 00:38:09,770
difficult to properly<font color="#E5E5E5"> and</font><font color="#CCCCCC"> accurately</font>

824
00:38:06,380 --> 00:38:13,520
flag on<font color="#E5E5E5"> and once we have the SPN tickets</font>

825
00:38:09,770 --> 00:38:16,670
<font color="#E5E5E5">we can easily crack them if they're</font>

826
00:38:13,520 --> 00:38:20,750
using somewhat weak<font color="#E5E5E5"> service passwords</font>

827
00:38:16,670 --> 00:38:23,450
with<font color="#E5E5E5"> with something</font><font color="#CCCCCC"> like hash cap and so</font>

828
00:38:20,750 --> 00:38:25,640
there's<font color="#CCCCCC"> x-force's Reds</font><font color="#E5E5E5"> part of X versus</font>

829
00:38:23,450 --> 00:38:29,270
Reds cluster I think we have 16<font color="#CCCCCC"> gtx</font>

830
00:38:25,640 --> 00:38:33,140
1080s so cracking the average<font color="#CCCCCC"> SBN maybe</font>

831
00:38:29,270 --> 00:38:34,940
takes<font color="#CCCCCC"> five</font><font color="#E5E5E5"> minutes</font><font color="#CCCCCC"> so from a defender</font>

832
00:38:33,140 --> 00:38:37,250
point of view you<font color="#CCCCCC"> really want to make</font>

833
00:38:34,940 --> 00:38:41,570
<font color="#CCCCCC">sure that any</font><font color="#E5E5E5"> service</font><font color="#CCCCCC"> count that's been</font>

834
00:38:37,250 --> 00:38:44,060
registered as an<font color="#CCCCCC"> SPN is using</font><font color="#E5E5E5"> extremely</font>

835
00:38:41,570 --> 00:38:47,630
complex<font color="#E5E5E5"> passwords so 24 characters in</font>

836
00:38:44,060 --> 00:38:49,700
length<font color="#E5E5E5"> is the best practice</font><font color="#CCCCCC"> because hash</font>

837
00:38:47,630 --> 00:38:52,820
cat doesn't support that that many

838
00:38:49,700 --> 00:38:54,589
characters<font color="#E5E5E5"> right now</font><font color="#CCCCCC"> and and</font><font color="#E5E5E5"> making sure</font>

839
00:38:52,820 --> 00:38:57,290
that they're extremely<font color="#E5E5E5"> complex passwords</font>

840
00:38:54,590 --> 00:38:59,060
if you used<font color="#E5E5E5"> managed service account</font>

841
00:38:57,290 --> 00:39:01,340
functionality you<font color="#CCCCCC"> can set that</font><font color="#E5E5E5"> as</font><font color="#CCCCCC"> the</font>

842
00:38:59,060 --> 00:39:02,810
<font color="#CCCCCC">base line already</font><font color="#E5E5E5"> and automatically have</font>

843
00:39:01,340 --> 00:39:07,880
those service accounts update themselves

844
00:39:02,810 --> 00:39:11,570
<font color="#CCCCCC">with with</font><font color="#E5E5E5"> complex passwords also not</font>

845
00:39:07,880 --> 00:39:13,600
<font color="#CCCCCC">detected is silver tickets so once we</font>

846
00:39:11,570 --> 00:39:18,560
have those<font color="#CCCCCC"> SPMS</font>

847
00:39:13,600 --> 00:39:21,259
we can once<font color="#E5E5E5"> we have those service</font>

848
00:39:18,560 --> 00:39:23,029
accounts we can just<font color="#E5E5E5"> log</font><font color="#CCCCCC"> into</font><font color="#E5E5E5"> the</font>

849
00:39:21,260 --> 00:39:25,490
<font color="#CCCCCC">Associated server with those credentials</font>

850
00:39:23,030 --> 00:39:28,820
<font color="#E5E5E5">and the authentication traffic will</font>

851
00:39:25,490 --> 00:39:31,250
never hit the domain controller<font color="#CCCCCC"> if we</font>

852
00:39:28,820 --> 00:39:33,770
use silver tickets<font color="#E5E5E5"> if we don't use</font>

853
00:39:31,250 --> 00:39:36,020
silver tickets<font color="#E5E5E5"> they're gonna have</font>

854
00:39:33,770 --> 00:39:38,060
service accounts maybe interactively

855
00:39:36,020 --> 00:39:42,950
logging<font color="#CCCCCC"> into a box</font><font color="#E5E5E5"> and that's going to</font>

856
00:39:38,060 --> 00:39:44,540
<font color="#E5E5E5">be pretty easy for 88 a flag on or other</font>

857
00:39:42,950 --> 00:39:46,520
solutions<font color="#E5E5E5"> to flag on because they've</font>

858
00:39:44,540 --> 00:39:48,470
never seen<font color="#E5E5E5"> that service account login to</font>

859
00:39:46,520 --> 00:39:51,109
a server as an interactive<font color="#E5E5E5"> login for</font>

860
00:39:48,470 --> 00:39:53,899
example<font color="#E5E5E5"> so we can avoid that</font>

861
00:39:51,109 --> 00:39:56,680
<font color="#E5E5E5">authentication event altogether</font><font color="#CCCCCC"> by using</font>

862
00:39:53,900 --> 00:39:56,680
silver tickets

863
00:39:58,390 --> 00:40:04,190
I'd imagine though with ATP integration

864
00:40:01,670 --> 00:40:07,219
coming<font color="#CCCCCC"> an</font><font color="#E5E5E5"> ATP can read the</font><font color="#CCCCCC"> local</font>

865
00:40:04,190 --> 00:40:09,859
<font color="#E5E5E5">security event logs that information may</font>

866
00:40:07,219 --> 00:40:11,749
<font color="#CCCCCC">eventually hit the the</font><font color="#E5E5E5"> 80 a cloud and</font>

867
00:40:09,859 --> 00:40:14,749
they might start<font color="#E5E5E5"> alerting on it but for</font>

868
00:40:11,749 --> 00:40:18,140
<font color="#CCCCCC">now we're safe using</font><font color="#E5E5E5"> silver tickets to</font>

869
00:40:14,749 --> 00:40:22,819
to only<font color="#E5E5E5"> have local authentication events</font>

870
00:40:18,140 --> 00:40:26,269
against servers<font color="#CCCCCC"> HEA also detects</font>

871
00:40:22,819 --> 00:40:28,670
modification of sensitive groups so the

872
00:40:26,269 --> 00:40:32,029
<font color="#E5E5E5">following is a list of groups that are</font>

873
00:40:28,670 --> 00:40:33,559
considered<font color="#CCCCCC"> sensitive by</font><font color="#E5E5E5"> ata any user</font>

874
00:40:32,029 --> 00:40:36,890
that<font color="#CCCCCC"> as a member of</font><font color="#E5E5E5"> these groups is also</font>

875
00:40:33,559 --> 00:40:39,019
<font color="#E5E5E5">considered a sensitive account so if we</font>

876
00:40:36,890 --> 00:40:41,989
modify<font color="#CCCCCC"> these groups such as adding a</font>

877
00:40:39,019 --> 00:40:44,538
member or<font color="#E5E5E5"> resetting a password of a</font>

878
00:40:41,989 --> 00:40:47,420
member in these groups<font color="#E5E5E5"> ata should flag</font>

879
00:40:44,539 --> 00:40:49,009
on it<font color="#CCCCCC"> what I</font><font color="#E5E5E5"> haven't run into a single</font>

880
00:40:47,420 --> 00:40:50,869
environment<font color="#E5E5E5"> that these are the only</font>

881
00:40:49,009 --> 00:40:52,759
<font color="#E5E5E5">sensitive or privileged groups in an</font>

882
00:40:50,869 --> 00:40:54,709
Active Directory environment<font color="#CCCCCC"> in fact</font>

883
00:40:52,759 --> 00:40:57,650
Microsoft<font color="#E5E5E5"> if we follow their best</font>

884
00:40:54,709 --> 00:40:59,808
practice on<font color="#CCCCCC"> delegating permissions</font>

885
00:40:57,650 --> 00:41:01,880
suggests that we create a lot<font color="#CCCCCC"> more</font>

886
00:40:59,809 --> 00:41:08,359
privileged groups with delegated user

887
00:41:01,880 --> 00:41:14,390
rights so if we first use a tool<font color="#E5E5E5"> like</font>

888
00:41:08,359 --> 00:41:18,709
bloodhound to kind of enumerate what

889
00:41:14,390 --> 00:41:20,839
rights groups have in the<font color="#E5E5E5"> environment we</font>

890
00:41:18,709 --> 00:41:23,598
can enumerate<font color="#CCCCCC"> Active Directory</font><font color="#E5E5E5"> object</font>

891
00:41:20,839 --> 00:41:26,630
access control entities<font color="#CCCCCC"> or the ACLs for</font>

892
00:41:23,599 --> 00:41:29,420
each group or user and use bloodhound to

893
00:41:26,630 --> 00:41:33,170
visualize the attack<font color="#E5E5E5"> path so if we know</font>

894
00:41:29,420 --> 00:41:36,650
<font color="#CCCCCC">that we have a be Edwards password and</font>

895
00:41:33,170 --> 00:41:39,140
we<font color="#E5E5E5"> eventually want to get to DNS</font><font color="#CCCCCC"> o1 we</font>

896
00:41:36,650 --> 00:41:41,569
know that the<font color="#CCCCCC"> helpdesk</font><font color="#E5E5E5"> group has</font><font color="#CCCCCC"> write</font>

897
00:41:39,140 --> 00:41:43,190
permissions on DNS admin<font color="#CCCCCC"> and which has</font>

898
00:41:41,569 --> 00:41:46,279
write permissions on that user account

899
00:41:43,190 --> 00:41:48,079
which has admin to the box so we<font color="#CCCCCC"> can use</font>

900
00:41:46,279 --> 00:41:51,559
tools like bloodhound instead of using

901
00:41:48,079 --> 00:41:57,190
session enumeration<font color="#E5E5E5"> we can use add a</font>

902
00:41:51,559 --> 00:41:58,489
close to abuse those but the problem is

903
00:41:57,190 --> 00:42:03,299
excuse<font color="#E5E5E5"> me</font>

904
00:41:58,489 --> 00:42:07,319
the problem is if<font color="#E5E5E5"> we target</font>

905
00:42:03,299 --> 00:42:11,609
<font color="#E5E5E5">DNS admin's</font><font color="#CCCCCC"> because it's</font><font color="#E5E5E5"> listed</font>

906
00:42:07,319 --> 00:42:18,749
<font color="#CCCCCC">previously as a sensitive group</font><font color="#E5E5E5"> we're</font>

907
00:42:11,609 --> 00:42:21,719
<font color="#CCCCCC">gonna get flagged by a</font><font color="#E5E5E5"> TA so instead we</font>

908
00:42:18,749 --> 00:42:23,640
can so<font color="#E5E5E5"> if we abuse these excess</font>

909
00:42:21,719 --> 00:42:27,359
permissions to add ourselves to<font color="#E5E5E5"> non</font>

910
00:42:23,640 --> 00:42:29,129
<font color="#E5E5E5">sensitive admin groups like I set the</font>

911
00:42:27,359 --> 00:42:30,869
password of<font color="#E5E5E5"> a target account to</font>

912
00:42:29,130 --> 00:42:33,839
temporary login to a server such as a

913
00:42:30,869 --> 00:42:35,759
user that<font color="#E5E5E5"> regularly accesses that</font><font color="#CCCCCC"> box</font>

914
00:42:33,839 --> 00:42:37,439
combined with the numerating user

915
00:42:35,759 --> 00:42:39,869
sessions on the target server<font color="#E5E5E5"> we can</font>

916
00:42:37,439 --> 00:42:44,158
<font color="#E5E5E5">avoid being flagged by a TA for abnormal</font>

917
00:42:39,869 --> 00:42:45,959
user behavior<font color="#E5E5E5"> by using</font><font color="#CCCCCC"> an account again</font>

918
00:42:44,159 --> 00:42:48,539
that would<font color="#E5E5E5"> be expected</font><font color="#CCCCCC"> to log</font><font color="#E5E5E5"> into it</font>

919
00:42:45,959 --> 00:42:50,098
<font color="#CCCCCC">and Active Directory is working as</font>

920
00:42:48,539 --> 00:42:52,169
designed<font color="#E5E5E5"> here</font>

921
00:42:50,099 --> 00:42:54,149
<font color="#E5E5E5">ABI this account is a member of the</font>

922
00:42:52,169 --> 00:42:56,578
<font color="#CCCCCC">helpdesk</font><font color="#E5E5E5"> which had delegated control</font>

923
00:42:54,149 --> 00:42:59,848
over the web service which<font color="#CCCCCC"> was an admin</font>

924
00:42:56,579 --> 00:43:03,029
on<font color="#E5E5E5"> Apple</font><font color="#CCCCCC"> 1 so it would be</font><font color="#E5E5E5"> very difficult</font>

925
00:42:59,849 --> 00:43:05,819
to<font color="#CCCCCC"> 8 for a</font><font color="#E5E5E5"> TA to accurately detect us</font>

926
00:43:03,029 --> 00:43:08,519
abusing these dackel permit permissions

927
00:43:05,819 --> 00:43:13,019
as long as we're<font color="#CCCCCC"> not modifying groups</font>

928
00:43:08,519 --> 00:43:14,848
that were in the<font color="#CCCCCC"> previous slide rohan</font>

929
00:43:13,019 --> 00:43:17,968
<font color="#CCCCCC">andy and will from specter</font><font color="#E5E5E5"> ops crew</font>

930
00:43:14,849 --> 00:43:24,599
recently<font color="#E5E5E5"> covered a lot of this in the</font>

931
00:43:17,969 --> 00:43:28,409
<font color="#CCCCCC">last</font><font color="#E5E5E5"> bloodhound update so a</font><font color="#CCCCCC"> favored</font>

932
00:43:24,599 --> 00:43:32,639
technique<font color="#CCCCCC"> by attackers</font><font color="#E5E5E5"> is once you have</font>

933
00:43:28,409 --> 00:43:34,559
<font color="#E5E5E5">the ntlm hash of a victim so you get on</font>

934
00:43:32,639 --> 00:43:38,519
the<font color="#CCCCCC"> box you run</font><font color="#E5E5E5"> me me</font><font color="#CCCCCC"> Katz you get</font><font color="#E5E5E5"> their</font>

935
00:43:34,559 --> 00:43:41,009
ntlm hash and you use<font color="#CCCCCC"> that using say</font><font color="#E5E5E5"> an</font>

936
00:43:38,519 --> 00:43:43,439
overpass the hash<font color="#E5E5E5"> attack to request a</font>

937
00:43:41,009 --> 00:43:45,569
Kerberos ticket and you use that

938
00:43:43,439 --> 00:43:49,229
Kerberos ticket to log into<font color="#CCCCCC"> another</font><font color="#E5E5E5"> box</font>

939
00:43:45,569 --> 00:43:51,058
<font color="#E5E5E5">that's gonna be flagged and the reason</font>

940
00:43:49,229 --> 00:43:53,308
<font color="#CCCCCC">for that is you'll see that the alert</font>

941
00:43:51,059 --> 00:43:55,439
comes up as either unusual protocol

942
00:43:53,309 --> 00:43:58,289
implementation or encryption downgrade

943
00:43:55,439 --> 00:44:01,078
<font color="#CCCCCC">so a Kerberos ticket when you're</font>

944
00:43:58,289 --> 00:44:03,719
requesting it it actually<font color="#E5E5E5"> expects the</font>

945
00:44:01,079 --> 00:44:05,880
AES hashes<font color="#CCCCCC"> to be included as well</font><font color="#E5E5E5"> for</font>

946
00:44:03,719 --> 00:44:08,880
only including the rc4 which are the

947
00:44:05,880 --> 00:44:11,459
ntlm hashes and that's going<font color="#E5E5E5"> to be</font>

948
00:44:08,880 --> 00:44:15,539
easily flaga<font color="#E5E5E5"> becuz it's not regular</font>

949
00:44:11,459 --> 00:44:17,019
authentication attempts so if we include

950
00:44:15,539 --> 00:44:20,489
<font color="#CCCCCC">our</font><font color="#E5E5E5"> fuyi request</font>

951
00:44:17,019 --> 00:44:24,939
Kerberos ticket use<font color="#E5E5E5"> using the AES</font>

952
00:44:20,489 --> 00:44:30,059
password<font color="#E5E5E5"> as well or sorry the AES key as</font>

953
00:44:24,939 --> 00:44:35,049
<font color="#E5E5E5">well</font><font color="#CCCCCC"> you you can avoid being flagged</font><font color="#E5E5E5"> now</font>

954
00:44:30,059 --> 00:44:38,559
most boxes<font color="#E5E5E5"> will only contain the AES 256</font>

955
00:44:35,049 --> 00:44:40,538
key but I found that<font color="#E5E5E5"> and it's really</font>

956
00:44:38,559 --> 00:44:44,349
<font color="#E5E5E5">struggling on how</font><font color="#CCCCCC"> to find</font><font color="#E5E5E5"> the AES</font>

957
00:44:40,539 --> 00:44:46,839
<font color="#E5E5E5">128-bit key and I found if</font><font color="#CCCCCC"> you just use</font>

958
00:44:44,349 --> 00:44:49,299
all<font color="#E5E5E5"> zeros or any 32 characters</font>

959
00:44:46,839 --> 00:44:52,719
it won't flag on it<font color="#CCCCCC"> so as</font><font color="#E5E5E5"> long as you at</font>

960
00:44:49,299 --> 00:44:57,729
least have<font color="#CCCCCC"> the AES 256 key you won't</font><font color="#E5E5E5"> get</font>

961
00:44:52,719 --> 00:45:00,039
<font color="#CCCCCC">flame not</font><font color="#E5E5E5"> detected again</font><font color="#CCCCCC"> if we're</font>

962
00:44:57,729 --> 00:45:02,859
avoiding<font color="#E5E5E5"> domain level authentication</font>

963
00:45:00,039 --> 00:45:05,999
events<font color="#E5E5E5"> say by targeting sequel servers</font>

964
00:45:02,859 --> 00:45:07,989
that's not going to be flagged<font color="#E5E5E5"> either</font>

965
00:45:05,999 --> 00:45:09,939
<font color="#E5E5E5">because none</font><font color="#CCCCCC"> of those authentication</font>

966
00:45:07,989 --> 00:45:12,759
<font color="#E5E5E5">events are making their way back</font><font color="#CCCCCC"> up to</font>

967
00:45:09,939 --> 00:45:15,118
<font color="#E5E5E5">the Active</font><font color="#CCCCCC"> Directory so in the kill</font><font color="#E5E5E5"> did</font>

968
00:45:12,759 --> 00:45:17,949
cover a lot of<font color="#CCCCCC"> that and</font><font color="#E5E5E5"> in a blog post</font>

969
00:45:15,119 --> 00:45:21,189
<font color="#CCCCCC">but that's that's definitely a great</font>

970
00:45:17,949 --> 00:45:22,809
<font color="#E5E5E5">technique is to avoid domain level</font>

971
00:45:21,189 --> 00:45:26,618
authentication events either<font color="#E5E5E5"> with silver</font>

972
00:45:22,809 --> 00:45:31,359
tickets or using sequel attacks that use

973
00:45:26,619 --> 00:45:33,519
sequel off so once you have access<font color="#CCCCCC"> to</font>

974
00:45:31,359 --> 00:45:35,828
your privilege user<font color="#E5E5E5"> it's time to move</font>

975
00:45:33,519 --> 00:45:38,499
towards achieving the primary goals of

976
00:45:35,829 --> 00:45:40,719
<font color="#E5E5E5">say a</font><font color="#CCCCCC"> Red Team engagement so these might</font>

977
00:45:38,499 --> 00:45:43,359
<font color="#CCCCCC">include dominance over the</font><font color="#E5E5E5"> network and</font>

978
00:45:40,719 --> 00:45:45,849
<font color="#E5E5E5">you may or may</font><font color="#CCCCCC"> not have to grab the end</font>

979
00:45:43,359 --> 00:45:49,389
the Active<font color="#CCCCCC"> Directory database or the</font>

980
00:45:45,849 --> 00:45:51,219
<font color="#E5E5E5">NTDs update</font><font color="#CCCCCC"> it sure comes in handy but</font>

981
00:45:49,389 --> 00:45:53,679
it comes<font color="#E5E5E5"> with its own OPSEC challenges</font>

982
00:45:51,219 --> 00:45:55,149
that that<font color="#E5E5E5"> you have to risk so if it's if</font>

983
00:45:53,679 --> 00:45:57,819
you're<font color="#E5E5E5"> on</font><font color="#CCCCCC"> an engagement</font><font color="#E5E5E5"> you only need</font>

984
00:45:55,149 --> 00:46:00,549
access<font color="#E5E5E5"> to</font><font color="#CCCCCC"> specific source code or</font>

985
00:45:57,819 --> 00:46:02,409
specific file server<font color="#CCCCCC"> maybe</font><font color="#E5E5E5"> you don't</font>

986
00:46:00,549 --> 00:46:04,569
have<font color="#E5E5E5"> to grab the Active</font><font color="#CCCCCC"> Directory</font>

987
00:46:02,409 --> 00:46:10,329
database but again it sure comes in

988
00:46:04,569 --> 00:46:12,939
handy<font color="#E5E5E5"> so if we're trying to grab the</font>

989
00:46:10,329 --> 00:46:14,889
Active Directory<font color="#E5E5E5"> database using DC sync</font>

990
00:46:12,939 --> 00:46:17,288
this has been the<font color="#CCCCCC"> preferred method by</font>

991
00:46:14,889 --> 00:46:22,059
most people for quite a while because<font color="#E5E5E5"> DC</font>

992
00:46:17,289 --> 00:46:26,829
sync is so fast<font color="#E5E5E5"> and it's accurate</font><font color="#CCCCCC"> the</font>

993
00:46:22,059 --> 00:46:29,530
problem is<font color="#E5E5E5"> using</font><font color="#CCCCCC"> this technique is</font>

994
00:46:26,829 --> 00:46:31,480
<font color="#E5E5E5">really easy to catch because</font>

995
00:46:29,530 --> 00:46:34,090
you're effectively impersonating a

996
00:46:31,480 --> 00:46:37,150
domain controller from<font color="#E5E5E5"> say a</font><font color="#CCCCCC"> workstation</font>

997
00:46:34,090 --> 00:46:38,440
so you're saying I<font color="#E5E5E5"> have</font><font color="#CCCCCC"> another domain</font>

998
00:46:37,150 --> 00:46:40,210
controller you're saying hey I'm also a

999
00:46:38,440 --> 00:46:43,180
DC send me a<font color="#E5E5E5"> copy of the Active</font>

1000
00:46:40,210 --> 00:46:45,880
<font color="#E5E5E5">Directory database well obviously that</font>

1001
00:46:43,180 --> 00:46:50,830
<font color="#E5E5E5">workstation is not a DC and it's really</font>

1002
00:46:45,880 --> 00:46:53,740
<font color="#CCCCCC">easy for a</font><font color="#E5E5E5"> t-888 of flag</font><font color="#CCCCCC"> as long as</font>

1003
00:46:50,830 --> 00:46:57,970
you're running<font color="#E5E5E5"> this from the same forest</font>

1004
00:46:53,740 --> 00:47:00,160
if you compromised credentials<font color="#E5E5E5"> for</font>

1005
00:46:57,970 --> 00:47:02,740
another forest<font color="#E5E5E5"> and ran the attack from</font>

1006
00:47:00,160 --> 00:47:04,569
<font color="#E5E5E5">outside of that forest because the trust</font>

1007
00:47:02,740 --> 00:47:06,879
relationships<font color="#CCCCCC"> exists</font><font color="#E5E5E5"> between the two</font>

1008
00:47:04,570 --> 00:47:09,160
<font color="#E5E5E5">Active Directory forests that won't be</font>

1009
00:47:06,880 --> 00:47:12,040
flagged<font color="#E5E5E5"> if a TA is not running</font><font color="#CCCCCC"> in the</font>

1010
00:47:09,160 --> 00:47:14,500
target environment<font color="#CCCCCC"> but</font><font color="#E5E5E5"> there's a lot</font>

1011
00:47:12,040 --> 00:47:19,240
better<font color="#E5E5E5"> ways to grab the database instead</font>

1012
00:47:14,500 --> 00:47:23,230
of DC sync so this is in<font color="#CCCCCC"> 1.8 this is now</font>

1013
00:47:19,240 --> 00:47:27,459
partially detected I found so<font color="#CCCCCC"> we can use</font>

1014
00:47:23,230 --> 00:47:29,350
the WMI win32<font color="#CCCCCC"> shadow copy class to dump</font>

1015
00:47:27,460 --> 00:47:33,040
the<font color="#E5E5E5"> NTDs data or the Active</font><font color="#CCCCCC"> Directory</font>

1016
00:47:29,350 --> 00:47:35,140
database via volume Shadow Copy without

1017
00:47:33,040 --> 00:47:39,160
having to call<font color="#CCCCCC"> the</font><font color="#E5E5E5"> volume Shadow Copy</font>

1018
00:47:35,140 --> 00:47:42,490
admin executable but this is now flagged

1019
00:47:39,160 --> 00:47:44,290
as a low severity event in<font color="#CCCCCC"> ata 1.8 not</font>

1020
00:47:42,490 --> 00:47:47,589
because we're<font color="#CCCCCC"> copying the Active</font>

1021
00:47:44,290 --> 00:47:50,650
<font color="#CCCCCC">Directory database</font><font color="#E5E5E5"> but because we tried</font>

1022
00:47:47,590 --> 00:47:54,700
a lateral movement against<font color="#E5E5E5"> a domain</font>

1023
00:47:50,650 --> 00:47:56,350
controller<font color="#E5E5E5"> so it's pretty weird that</font>

1024
00:47:54,700 --> 00:47:58,600
<font color="#E5E5E5">there's still only flagging that is low</font>

1025
00:47:56,350 --> 00:48:00,100
<font color="#CCCCCC">even</font><font color="#E5E5E5"> though we're clearly making a copy</font>

1026
00:47:58,600 --> 00:48:02,080
of the Active<font color="#E5E5E5"> Directory database</font>

1027
00:48:00,100 --> 00:48:07,240
containing all the<font color="#E5E5E5"> users passwords and</font>

1028
00:48:02,080 --> 00:48:13,600
whatnot<font color="#CCCCCC"> also</font><font color="#E5E5E5"> not detected</font><font color="#CCCCCC"> is PS remoting</font>

1029
00:48:07,240 --> 00:48:16,839
with<font color="#E5E5E5"> L SAS inject so the win RM RPS</font>

1030
00:48:13,600 --> 00:48:19,120
remoting<font color="#E5E5E5"> we can inject me me cats into</font>

1031
00:48:16,840 --> 00:48:22,360
<font color="#CCCCCC">the alsace process on a domain</font>

1032
00:48:19,120 --> 00:48:27,790
<font color="#CCCCCC">controller</font><font color="#E5E5E5"> and grab the credentials</font><font color="#CCCCCC"> from</font>

1033
00:48:22,360 --> 00:48:30,010
memory there's lots of ways to harden

1034
00:48:27,790 --> 00:48:32,650
against this as a blue<font color="#CCCCCC"> Timur though</font><font color="#E5E5E5"> we</font>

1035
00:48:30,010 --> 00:48:34,990
can prevent who has win RM<font color="#E5E5E5"> RPS remoting</font>

1036
00:48:32,650 --> 00:48:36,820
writes into<font color="#CCCCCC"> a box we</font><font color="#E5E5E5"> can restrict that</font>

1037
00:48:34,990 --> 00:48:39,040
as<font color="#E5E5E5"> something as simple as</font><font color="#CCCCCC"> saying</font><font color="#E5E5E5"> only</font>

1038
00:48:36,820 --> 00:48:41,440
these specific groups can PS remote in

1039
00:48:39,040 --> 00:48:42,940
or only these specific source

1040
00:48:41,440 --> 00:48:46,750
workstations<font color="#CCCCCC"> or</font>

1041
00:48:42,940 --> 00:48:48,700
dresses can<font color="#E5E5E5"> PS</font><font color="#CCCCCC"> wrote</font><font color="#E5E5E5"> in also not</font>

1042
00:48:46,750 --> 00:48:53,530
<font color="#CCCCCC">detectives PS promoting with raw disk</font>

1043
00:48:48,700 --> 00:48:55,660
access so if we connect into a box<font color="#CCCCCC"> we</font>

1044
00:48:53,530 --> 00:48:59,349
can make a copy<font color="#E5E5E5"> of</font><font color="#CCCCCC"> the raw underlying</font>

1045
00:48:55,660 --> 00:49:02,049
<font color="#E5E5E5">file system</font><font color="#CCCCCC"> file without</font><font color="#E5E5E5"> starting any</font>

1046
00:48:59,349 --> 00:49:07,720
services or injecting any processes or

1047
00:49:02,050 --> 00:49:11,710
elevating the system you<font color="#E5E5E5"> can easily</font>

1048
00:49:07,720 --> 00:49:16,299
<font color="#E5E5E5">detect this using</font><font color="#CCCCCC"> sis Mon for anything</font>

1049
00:49:11,710 --> 00:49:19,540
injecting into<font color="#CCCCCC"> LSS or on your domain</font>

1050
00:49:16,300 --> 00:49:22,300
controllers<font color="#CCCCCC"> in</font><font color="#E5E5E5"> 2012 r2 and up you can</font>

1051
00:49:19,540 --> 00:49:28,569
set<font color="#CCCCCC"> Alsace as a protected process</font><font color="#E5E5E5"> and</font>

1052
00:49:22,300 --> 00:49:30,280
nothing can inject<font color="#CCCCCC"> into it mm-hmm</font><font color="#E5E5E5"> this</font>

1053
00:49:28,569 --> 00:49:33,819
this techniques<font color="#E5E5E5"> a little messy though</font>

1054
00:49:30,280 --> 00:49:37,630
<font color="#E5E5E5">because</font><font color="#CCCCCC"> you're you're conveying a live</font>

1055
00:49:33,819 --> 00:49:41,200
copy of the system file so because the

1056
00:49:37,630 --> 00:49:43,450
copies in use at the<font color="#CCCCCC"> time</font><font color="#E5E5E5"> it might the</font>

1057
00:49:41,200 --> 00:49:46,868
<font color="#E5E5E5">first attempt you might get a corrupted</font>

1058
00:49:43,450 --> 00:49:48,520
file which<font color="#E5E5E5"> you can clean</font><font color="#CCCCCC"> up or you can</font>

1059
00:49:46,869 --> 00:49:53,920
<font color="#E5E5E5">just request it again and hopefully not</font>

1060
00:49:48,520 --> 00:49:55,540
get a version<font color="#CCCCCC"> that's corrupt so now that</font>

1061
00:49:53,920 --> 00:49:58,089
<font color="#E5E5E5">we have</font><font color="#CCCCCC"> the Active Directory database</font>

1062
00:49:55,540 --> 00:50:00,579
what if we wanted<font color="#CCCCCC"> to leverage the</font>

1063
00:49:58,089 --> 00:50:04,140
Kerberos ticket granting ticket<font color="#E5E5E5"> service</font>

1064
00:50:00,579 --> 00:50:08,079
or the krbtgt<font color="#CCCCCC"> to create a golden ticket</font>

1065
00:50:04,140 --> 00:50:09,790
<font color="#CCCCCC">so we can come</font><font color="#E5E5E5"> into this environment</font><font color="#CCCCCC"> you</font>

1066
00:50:08,079 --> 00:50:11,800
know<font color="#E5E5E5"> six months down the line after</font>

1067
00:50:09,790 --> 00:50:13,660
compromising it to create a golden

1068
00:50:11,800 --> 00:50:17,410
ticket<font color="#CCCCCC"> on any account or any</font>

1069
00:50:13,660 --> 00:50:22,118
<font color="#CCCCCC">non-existent account because we're just</font>

1070
00:50:17,410 --> 00:50:24,129
<font color="#CCCCCC">using the ntlm hash again it's gonna be</font>

1071
00:50:22,119 --> 00:50:27,490
<font color="#E5E5E5">flagged as an encryption downgrade</font>

1072
00:50:24,130 --> 00:50:32,010
because<font color="#E5E5E5"> the TGT</font>

1073
00:50:27,490 --> 00:50:36,848
is expecting the<font color="#CCCCCC"> ASP</font><font color="#E5E5E5"> s to be in there</font>

1074
00:50:32,010 --> 00:50:38,280
but if<font color="#E5E5E5"> we again include the AES keys</font>

1075
00:50:36,849 --> 00:50:42,730
when we're creating<font color="#E5E5E5"> that golden ticket</font>

1076
00:50:38,280 --> 00:50:48,490
<font color="#CCCCCC">it won't be flagged Microsoft also put</font>

1077
00:50:42,730 --> 00:50:52,720
in a excessive session length<font color="#E5E5E5"> or</font>

1078
00:50:48,490 --> 00:50:55,089
excessive<font color="#E5E5E5"> ticket creation history</font>

1079
00:50:52,720 --> 00:50:56,069
basically<font color="#E5E5E5"> that if the length of the</font>

1080
00:50:55,089 --> 00:50:58,199
ticket<font color="#E5E5E5"> is</font>

1081
00:50:56,069 --> 00:51:00,119
more than like<font color="#E5E5E5"> eight hours</font><font color="#CCCCCC"> and it's used</font>

1082
00:50:58,199 --> 00:51:01,680
<font color="#CCCCCC">then it's going to be flagged</font><font color="#E5E5E5"> so we can</font>

1083
00:51:00,119 --> 00:51:03,719
get around<font color="#CCCCCC"> that by just creating</font><font color="#E5E5E5"> a</font>

1084
00:51:01,680 --> 00:51:05,940
ticket using<font color="#E5E5E5"> it for 20</font><font color="#CCCCCC"> minutes and then</font>

1085
00:51:03,719 --> 00:51:09,029
<font color="#E5E5E5">destroying the ticket ourselves and that</font>

1086
00:51:05,940 --> 00:51:10,529
<font color="#E5E5E5">won't be flagged by a TA so just make</font>

1087
00:51:09,029 --> 00:51:13,349
sure<font color="#E5E5E5"> if you</font><font color="#CCCCCC"> are using a golden ticket</font>

1088
00:51:10,529 --> 00:51:20,190
you're destroying it<font color="#E5E5E5"> after you've used</font>

1089
00:51:13,349 --> 00:51:22,199
it so for<font color="#E5E5E5"> blue team takeaways you really</font>

1090
00:51:20,190 --> 00:51:25,140
want to limit<font color="#E5E5E5"> PS remoting sources to</font>

1091
00:51:22,199 --> 00:51:28,680
<font color="#E5E5E5">dedicated admin services or sorry</font><font color="#CCCCCC"> min</font>

1092
00:51:25,140 --> 00:51:31,199
workstations<font color="#CCCCCC"> you you want to use</font><font color="#E5E5E5"> just</font>

1093
00:51:28,680 --> 00:51:33,660
enough<font color="#E5E5E5"> administration to help prevent</font>

1094
00:51:31,199 --> 00:51:37,499
lateral movement success if all the

1095
00:51:33,660 --> 00:51:39,479
privileged users are<font color="#CCCCCC"> only on my admitted</font>

1096
00:51:37,499 --> 00:51:41,640
<font color="#CCCCCC">it's gonna be a lot harder for</font><font color="#E5E5E5"> me</font><font color="#CCCCCC"> to</font>

1097
00:51:39,479 --> 00:51:43,709
laterally move around the network you

1098
00:51:41,640 --> 00:51:46,890
<font color="#CCCCCC">want to harden your sequel servers and</font>

1099
00:51:43,709 --> 00:51:48,930
your sequel accounts to<font color="#E5E5E5"> make sure that</font>

1100
00:51:46,890 --> 00:51:51,920
it's not easy to<font color="#CCCCCC"> perform the same sequel</font>

1101
00:51:48,930 --> 00:51:55,709
attacks that Nikhil has in his blog post

1102
00:51:51,920 --> 00:51:58,920
<font color="#CCCCCC">you really want to make sure that you're</font>

1103
00:51:55,709 --> 00:52:01,109
using strong service<font color="#E5E5E5"> account passwords</font>

1104
00:51:58,920 --> 00:52:04,890
<font color="#E5E5E5">especially for your</font><font color="#CCCCCC"> SBN</font><font color="#E5E5E5"> link service</font>

1105
00:52:01,109 --> 00:52:07,038
accounts you want to<font color="#CCCCCC"> ata gives you the</font>

1106
00:52:04,890 --> 00:52:10,078
option to integrate<font color="#CCCCCC"> sim</font><font color="#E5E5E5"> and VPN</font>

1107
00:52:07,039 --> 00:52:13,680
<font color="#E5E5E5">authentication logs into</font><font color="#CCCCCC"> ata</font>

1108
00:52:10,079 --> 00:52:15,119
<font color="#CCCCCC">so</font><font color="#E5E5E5"> definitely do that</font><font color="#CCCCCC"> and I think key of</font>

1109
00:52:13,680 --> 00:52:17,519
all you want<font color="#E5E5E5"> to</font><font color="#CCCCCC"> make sure</font><font color="#E5E5E5"> you're using</font>

1110
00:52:15,119 --> 00:52:20,579
Windows Event log forwarding as a second

1111
00:52:17,519 --> 00:52:23,038
source of<font color="#E5E5E5"> security data so don't just</font>

1112
00:52:20,579 --> 00:52:25,289
<font color="#E5E5E5">rely on your Windows Defender</font><font color="#CCCCCC"> atps or</font>

1113
00:52:23,039 --> 00:52:27,509
your crowd strikes or your silences<font color="#E5E5E5"> you</font>

1114
00:52:25,289 --> 00:52:29,130
want to be running<font color="#CCCCCC"> system on you want to</font>

1115
00:52:27,509 --> 00:52:31,499
be<font color="#E5E5E5"> using Windows Event log for it or to</font>

1116
00:52:29,130 --> 00:52:33,959
get those<font color="#E5E5E5"> logs off</font><font color="#CCCCCC"> the box so</font><font color="#E5E5E5"> even if</font>

1117
00:52:31,499 --> 00:52:34,919
I'm able<font color="#CCCCCC"> to kill CrowdStrike or ATP or</font>

1118
00:52:33,959 --> 00:52:36,868
<font color="#CCCCCC">what-have-you</font>

1119
00:52:34,920 --> 00:52:39,449
<font color="#E5E5E5">you still have a second source of all</font>

1120
00:52:36,869 --> 00:52:41,430
that data and<font color="#E5E5E5"> you're selectively sending</font>

1121
00:52:39,449 --> 00:52:45,229
some of<font color="#CCCCCC"> those</font><font color="#E5E5E5"> events off the</font><font color="#CCCCCC"> Box to a</font>

1122
00:52:41,430 --> 00:52:48,930
central file share and alerting on them

1123
00:52:45,229 --> 00:52:52,319
<font color="#CCCCCC">you want to use tools like bloodhound</font><font color="#E5E5E5"> to</font>

1124
00:52:48,930 --> 00:52:54,209
audit not<font color="#E5E5E5"> only how easy it would be for</font>

1125
00:52:52,319 --> 00:52:56,160
a user to<font color="#CCCCCC"> move</font><font color="#E5E5E5"> around with net session</font>

1126
00:52:54,209 --> 00:52:59,819
enumeration so finding sessions on

1127
00:52:56,160 --> 00:53:02,368
different<font color="#E5E5E5"> servers but also how easy is</font>

1128
00:52:59,819 --> 00:53:04,979
it to abuse excess permissions within

1129
00:53:02,369 --> 00:53:07,319
Active Directory groups so doing that

1130
00:53:04,979 --> 00:53:09,629
<font color="#CCCCCC">dackel abuse we talked about to move</font><font color="#E5E5E5"> to</font>

1131
00:53:07,319 --> 00:53:09,930
<font color="#CCCCCC">different</font><font color="#E5E5E5"> privileged groups maybe your</font>

1132
00:53:09,630 --> 00:53:12,420
help

1133
00:53:09,930 --> 00:53:16,379
desk user has our group has way too many

1134
00:53:12,420 --> 00:53:19,829
permissions<font color="#E5E5E5"> to some obscure delegated</font>

1135
00:53:16,380 --> 00:53:21,839
<font color="#E5E5E5">righted group that you forgot</font><font color="#CCCCCC"> about by</font>

1136
00:53:19,829 --> 00:53:27,839
using bloodhound you can audit<font color="#E5E5E5"> that all</font>

1137
00:53:21,839 --> 00:53:31,200
in<font color="#CCCCCC"> advance you can also enforce a es 256</font>

1138
00:53:27,839 --> 00:53:34,069
for your<font color="#E5E5E5"> SP n accounts and that way I'm</font>

1139
00:53:31,200 --> 00:53:36,240
not<font color="#E5E5E5"> going to be able to crack them</font>

1140
00:53:34,069 --> 00:53:41,160
<font color="#CCCCCC">assuming</font><font color="#E5E5E5"> that that you're still using</font>

1141
00:53:36,240 --> 00:53:43,618
strong passwords<font color="#CCCCCC"> in Windows 10 1703 and</font>

1142
00:53:41,160 --> 00:53:46,770
up<font color="#CCCCCC"> there a new feature</font><font color="#E5E5E5"> called binary</font>

1143
00:53:43,619 --> 00:53:49,650
signature policy<font color="#E5E5E5"> came in place to help</font>

1144
00:53:46,770 --> 00:53:51,839
protect ppl<font color="#CCCCCC"> s</font><font color="#E5E5E5"> which basically again</font><font color="#CCCCCC"> is</font>

1145
00:53:49,650 --> 00:53:53,940
<font color="#E5E5E5">only signed Microsoft code should be</font>

1146
00:53:51,839 --> 00:53:56,069
<font color="#CCCCCC">able</font><font color="#E5E5E5"> to inject into some of these ppl</font><font color="#CCCCCC"> s</font>

1147
00:53:53,940 --> 00:53:58,130
so as long<font color="#E5E5E5"> as</font><font color="#CCCCCC"> you're enforcing</font><font color="#E5E5E5"> binary</font>

1148
00:53:56,069 --> 00:54:02,308
signature policy<font color="#E5E5E5"> you can you can help</font>

1149
00:53:58,130 --> 00:54:04,740
prevent that<font color="#E5E5E5"> you also really want to</font>

1150
00:54:02,309 --> 00:54:07,140
integrate those new<font color="#E5E5E5"> defender branded</font>

1151
00:54:04,740 --> 00:54:09,000
tools so<font color="#CCCCCC"> that big windows</font><font color="#E5E5E5"> 10 security</font>

1152
00:54:07,140 --> 00:54:12,180
stack<font color="#E5E5E5"> that</font><font color="#CCCCCC"> we saw with credential guard</font>

1153
00:54:09,000 --> 00:54:13,230
and app guard and an exploit guard<font color="#CCCCCC"> you</font>

1154
00:54:12,180 --> 00:54:15,000
want to make<font color="#CCCCCC"> sure that you're actually</font>

1155
00:54:13,230 --> 00:54:17,780
<font color="#E5E5E5">leveraging all those tools because they</font>

1156
00:54:15,000 --> 00:54:19,770
work really well<font color="#CCCCCC"> if you're</font><font color="#E5E5E5"> properly</font>

1157
00:54:17,780 --> 00:54:22,349
<font color="#E5E5E5">configuring them and paying attention</font><font color="#CCCCCC"> to</font>

1158
00:54:19,770 --> 00:54:25,020
<font color="#CCCCCC">them but even just putting them in audit</font>

1159
00:54:22,349 --> 00:54:28,710
mode<font color="#E5E5E5"> so logs are generated is is what</font>

1160
00:54:25,020 --> 00:54:31,319
you at least want<font color="#E5E5E5"> to do and lastly you</font>

1161
00:54:28,710 --> 00:54:34,609
<font color="#E5E5E5">want to enforce emits or in Windows 10</font>

1162
00:54:31,319 --> 00:54:37,109
Windows Defender exploit guard<font color="#CCCCCC"> has these</font>

1163
00:54:34,609 --> 00:54:40,020
rules called attack surface reduction

1164
00:54:37,109 --> 00:54:42,328
rules very easy to<font color="#E5E5E5"> implement</font><font color="#CCCCCC"> basically</font>

1165
00:54:40,020 --> 00:54:44,520
you're preventing processes like

1166
00:54:42,329 --> 00:54:47,280
Microsoft Word<font color="#E5E5E5"> from creating new</font>

1167
00:54:44,520 --> 00:54:50,430
<font color="#E5E5E5">processes using like say a macro based</font>

1168
00:54:47,280 --> 00:54:52,170
attack<font color="#E5E5E5"> so there's no reason why somebody</font>

1169
00:54:50,430 --> 00:54:54,480
<font color="#CCCCCC">should be launching a document</font><font color="#E5E5E5"> and it</font>

1170
00:54:52,170 --> 00:54:55,589
launches<font color="#CCCCCC"> PowerShell dot exe or command</font>

1171
00:54:54,480 --> 00:54:57,900
exe

1172
00:54:55,589 --> 00:55:00,869
so using ASR you can you can really<font color="#E5E5E5"> help</font>

1173
00:54:57,900 --> 00:55:02,849
prevent<font color="#E5E5E5"> that</font><font color="#CCCCCC"> from a red teamers</font>

1174
00:55:00,869 --> 00:55:04,530
perspective we<font color="#CCCCCC"> really need to return</font><font color="#E5E5E5"> to</font>

1175
00:55:02,849 --> 00:55:08,130
living<font color="#E5E5E5"> off the land and directly calling</font>

1176
00:55:04,530 --> 00:55:12,089
api's we want to leverage<font color="#CCCCCC"> host-based</font>

1177
00:55:08,130 --> 00:55:15,450
powershell tools like<font color="#CCCCCC"> empire like power</font>

1178
00:55:12,089 --> 00:55:20,609
up etc<font color="#CCCCCC"> only</font><font color="#E5E5E5"> after we're confident that</font>

1179
00:55:15,450 --> 00:55:23,060
<font color="#CCCCCC">we can evade or block</font><font color="#E5E5E5"> ATP and event log</font>

1180
00:55:20,609 --> 00:55:26,900
forwarding so

1181
00:55:23,060 --> 00:55:30,720
even if we are<font color="#CCCCCC"> manage to</font><font color="#E5E5E5"> get</font><font color="#CCCCCC"> around 80</font>

1182
00:55:26,900 --> 00:55:32,790
<font color="#E5E5E5">ATP to get on the</font><font color="#CCCCCC"> box initially again we</font>

1183
00:55:30,720 --> 00:55:34,618
have to be cognizant of<font color="#E5E5E5"> what we're</font>

1184
00:55:32,790 --> 00:55:36,930
<font color="#E5E5E5">running against the box and what's going</font>

1185
00:55:34,619 --> 00:55:43,520
<font color="#E5E5E5">to be picked up by</font><font color="#CCCCCC"> PowerShell</font><font color="#E5E5E5"> event</font>

1186
00:55:36,930 --> 00:55:45,990
logging<font color="#E5E5E5"> or windows script host logging</font>

1187
00:55:43,520 --> 00:55:48,000
<font color="#CCCCCC">you want to block Windows Event log</font>

1188
00:55:45,990 --> 00:55:53,100
forwarding right after<font color="#CCCCCC"> your able to</font>

1189
00:55:48,000 --> 00:55:55,140
<font color="#E5E5E5">block</font><font color="#CCCCCC"> ATP or</font><font color="#E5E5E5"> other next-gen antivirus to</font>

1190
00:55:53,100 --> 00:55:58,770
prevent additional logs<font color="#E5E5E5"> from getting off</font>

1191
00:55:55,140 --> 00:56:03,180
the box and flagged<font color="#E5E5E5"> on you you want to</font>

1192
00:55:58,770 --> 00:56:04,890
<font color="#CCCCCC">use</font><font color="#E5E5E5"> that active directory object abuse</font>

1193
00:56:03,180 --> 00:56:07,470
whenever possible to<font color="#E5E5E5"> help avoid</font>

1194
00:56:04,890 --> 00:56:10,770
performing remote code execution on a

1195
00:56:07,470 --> 00:56:12,750
box<font color="#CCCCCC"> you want to focus on information</font>

1196
00:56:10,770 --> 00:56:14,460
gathering<font color="#E5E5E5"> and lateral movement</font>

1197
00:56:12,750 --> 00:56:17,660
techniques that don't<font color="#E5E5E5"> communicate with</font>

1198
00:56:14,460 --> 00:56:20,280
domain controllers so using sequel auth

1199
00:56:17,660 --> 00:56:24,540
using those silver tickets<font color="#E5E5E5"> and querying</font>

1200
00:56:20,280 --> 00:56:26,609
the<font color="#E5E5E5"> local</font><font color="#CCCCCC"> WMI</font><font color="#E5E5E5"> namespace you want to</font>

1201
00:56:24,540 --> 00:56:29,910
Kerberos stand silver ticket<font color="#E5E5E5"> all the</font>

1202
00:56:26,609 --> 00:56:32,210
things SPNs<font color="#CCCCCC"> are my</font><font color="#E5E5E5"> favorite target</font>

1203
00:56:29,910 --> 00:56:35,190
because they're so easy<font color="#E5E5E5"> any user can</font>

1204
00:56:32,210 --> 00:56:37,200
<font color="#E5E5E5">request them and most of the time you're</font>

1205
00:56:35,190 --> 00:56:39,359
<font color="#E5E5E5">gonna find the odd SPN that that was</font>

1206
00:56:37,200 --> 00:56:42,930
registered<font color="#CCCCCC"> with like password 0 1 for</font>

1207
00:56:39,359 --> 00:56:44,790
example<font color="#CCCCCC"> you want</font><font color="#E5E5E5"> to make sure you're</font>

1208
00:56:42,930 --> 00:56:47,700
using a s keys when you're performing

1209
00:56:44,790 --> 00:56:50,580
<font color="#E5E5E5">over over pass the hash to generate</font>

1210
00:56:47,700 --> 00:56:52,290
those Kerberos tickets or<font color="#E5E5E5"> the golden</font>

1211
00:56:50,580 --> 00:56:55,049
tickets<font color="#E5E5E5"> you want</font><font color="#CCCCCC"> to make sure how the</font>

1212
00:56:52,290 --> 00:56:57,990
AES as well and you<font color="#E5E5E5"> want to abuse forest</font>

1213
00:56:55,050 --> 00:57:03,300
trust whenever possible<font color="#E5E5E5"> because</font><font color="#CCCCCC"> a</font><font color="#E5E5E5"> TA is</font>

1214
00:56:57,990 --> 00:57:05,669
specific to<font color="#E5E5E5"> its own forest</font><font color="#CCCCCC"> only so a big</font>

1215
00:57:03,300 --> 00:57:07,710
thank you to<font color="#E5E5E5"> everyone on this slide and</font>

1216
00:57:05,670 --> 00:57:10,200
Simon stone<font color="#E5E5E5"> hog for permission to</font><font color="#CCCCCC"> use</font>

1217
00:57:07,710 --> 00:57:12,060
<font color="#E5E5E5">this art highly suggests following</font>

1218
00:57:10,200 --> 00:57:15,210
everyone<font color="#E5E5E5"> on that list there they're way</font>

1219
00:57:12,060 --> 00:57:19,290
smarter<font color="#E5E5E5"> than I will ever be really good</font>

1220
00:57:15,210 --> 00:57:20,850
people<font color="#CCCCCC"> the</font><font color="#E5E5E5"> M SATA and ATP teens have</font>

1221
00:57:19,290 --> 00:57:23,759
been<font color="#CCCCCC"> awesome to work with they've been</font>

1222
00:57:20,850 --> 00:57:26,430
quickly patching all the bypasses<font color="#E5E5E5"> that</font>

1223
00:57:23,760 --> 00:57:30,450
<font color="#E5E5E5">I've been finding and evasions I've been</font>

1224
00:57:26,430 --> 00:57:33,509
finding<font color="#E5E5E5"> release for is</font><font color="#CCCCCC"> gonna come</font><font color="#E5E5E5"> out</font>

1225
00:57:30,450 --> 00:57:34,939
with<font color="#E5E5E5"> a lot</font><font color="#CCCCCC"> of patches</font><font color="#E5E5E5"> for the bypasses</font>

1226
00:57:33,510 --> 00:57:37,400
<font color="#CCCCCC">that I found</font>

1227
00:57:34,940 --> 00:57:39,740
or at least ways to detect them in<font color="#CCCCCC"> use</font>

1228
00:57:37,400 --> 00:57:41,560
so<font color="#E5E5E5"> I'm looking forward to playing</font><font color="#CCCCCC"> with</font>

1229
00:57:39,740 --> 00:57:44,540
that in the<font color="#CCCCCC"> future</font><font color="#E5E5E5"> and finding more</font>

1230
00:57:41,560 --> 00:57:46,730
bypasses like a weird cat and mouse game

1231
00:57:44,540 --> 00:57:49,310
with<font color="#E5E5E5"> them but it's it's been fun for</font>

1232
00:57:46,730 --> 00:57:52,390
<font color="#E5E5E5">sure so thank you everyone for your</font><font color="#CCCCCC"> time</font>

1233
00:57:49,310 --> 00:57:52,390
and<font color="#E5E5E5"> for</font><font color="#CCCCCC"> coming out to the talk</font>

