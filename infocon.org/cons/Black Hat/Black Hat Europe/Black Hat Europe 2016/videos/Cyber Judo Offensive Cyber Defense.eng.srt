1
00:00:00,149 --> 00:00:02,250
welcome to our talk today my name is

2
00:00:02,250 --> 00:00:05,130
Todd berry I lead the security research

3
00:00:05,130 --> 00:00:06,060
for the advanced threat analytics

4
00:00:06,060 --> 00:00:09,210
product in Microsoft and with me attack

5
00:00:09,210 --> 00:00:12,210
ready a researcher in the team and thank

6
00:00:12,210 --> 00:00:13,950
you all for coming I know this is a hard

7
00:00:13,950 --> 00:00:15,870
hour the last hour the hour that

8
00:00:15,870 --> 00:00:18,300
separates between you and your drinks

9
00:00:18,300 --> 00:00:21,869
and London and so on so hopefully we'll

10
00:00:21,869 --> 00:00:25,740
keep it entertaining and hopefully you

11
00:00:25,740 --> 00:00:29,310
would enjoy that so what are we going to

12
00:00:29,310 --> 00:00:31,710
talk about today well we would like to

13
00:00:31,710 --> 00:00:35,010
take you along to the journey that we

14
00:00:35,010 --> 00:00:37,469
had and we had extracted quite a few

15
00:00:37,469 --> 00:00:40,860
insights in our journey to protect our

16
00:00:40,860 --> 00:00:43,200
customers against the targeted attack

17
00:00:43,200 --> 00:00:46,250
and some even philosophical insights

18
00:00:46,250 --> 00:00:51,030
about being gay cyber judoka using the

19
00:00:51,030 --> 00:00:55,680
attacker forces against them and so we

20
00:00:55,680 --> 00:00:58,079
would start with the primer on targeted

21
00:00:58,079 --> 00:01:01,260
attacks really real fast and I'm sure

22
00:01:01,260 --> 00:01:03,780
most of you already know that and then

23
00:01:03,780 --> 00:01:06,270
we'll take a deeper dive and we will

24
00:01:06,270 --> 00:01:08,850
analyze a single test case of lateral

25
00:01:08,850 --> 00:01:12,920
movement reconnaissance and we start by

26
00:01:12,920 --> 00:01:16,920
knowing the enemy and dissecting the

27
00:01:16,920 --> 00:01:19,320
attackers TTP's tactics techniques and

28
00:01:19,320 --> 00:01:24,119
procedures also it will talk about

29
00:01:24,119 --> 00:01:27,450
recent development in that area and they

30
00:01:27,450 --> 00:01:29,880
will discuss in their bloodhound as I'm

31
00:01:29,880 --> 00:01:32,640
sure all of you heard of and so it today

32
00:01:32,640 --> 00:01:35,970
in end is a bloodhound the arsenal talk

33
00:01:35,970 --> 00:01:41,570
so a big round of applause - Andy yeah

34
00:01:41,570 --> 00:01:45,540
so and you can also cheer him up after

35
00:01:45,540 --> 00:01:47,970
the talk and go talk to him great day

36
00:01:47,970 --> 00:01:51,030
great guy and great tool and we had

37
00:01:51,030 --> 00:01:54,119
taken one step further with an

38
00:01:54,119 --> 00:01:55,560
autonomous lateral movement

39
00:01:55,560 --> 00:01:59,130
proof-of-concept tool then we would want

40
00:01:59,130 --> 00:02:00,990
to leave you just with the problems we

41
00:02:00,990 --> 00:02:03,210
will talk about defenses against

42
00:02:03,210 --> 00:02:05,729
defensive moves classic defensive move

43
00:02:05,729 --> 00:02:07,920
how to blog how to detect how to prevent

44
00:02:07,920 --> 00:02:11,008
such attack and hopefully we will

45
00:02:11,008 --> 00:02:12,930
convince you you can take it to the next

46
00:02:12,930 --> 00:02:13,819
level

47
00:02:13,819 --> 00:02:16,310
and use these attack techniques in order

48
00:02:16,310 --> 00:02:19,129
to defend your own network and we will

49
00:02:19,129 --> 00:02:22,280
discuss two specific defense in fact it

50
00:02:22,280 --> 00:02:24,920
I will do that and discuss how lettuce

51
00:02:24,920 --> 00:02:27,260
can be used to detect pass the hash and

52
00:02:27,260 --> 00:02:29,180
how some our reconnaissance can be used

53
00:02:29,180 --> 00:02:31,730
in order to detect a local user attack

54
00:02:31,730 --> 00:02:37,040
so let's start okay so it's very very

55
00:02:37,040 --> 00:02:40,040
obvious and but we need the Sun Tzu

56
00:02:40,040 --> 00:02:42,799
quote in every security presentation

57
00:02:42,799 --> 00:02:46,819
that in order to win in any battle but

58
00:02:46,819 --> 00:02:49,099
specifically in the security information

59
00:02:49,099 --> 00:02:50,989
security battle you have to know the

60
00:02:50,989 --> 00:02:54,620
enemy and in fact this is a pretty messy

61
00:02:54,620 --> 00:02:55,609
situation today

62
00:02:55,609 --> 00:02:59,329
all unlighted defenders know that they

63
00:02:59,329 --> 00:03:02,269
should learn about their attackers ttp

64
00:03:02,269 --> 00:03:04,310
tactics techniques and procedures and

65
00:03:04,310 --> 00:03:08,000
build their own mechanisms and TTP's in

66
00:03:08,000 --> 00:03:11,659
order to fight them and also defenders

67
00:03:11,659 --> 00:03:15,739
are using red team of pen testers in

68
00:03:15,739 --> 00:03:19,489
order to exercise and simulate attackers

69
00:03:19,489 --> 00:03:23,060
move and and exercise and how to stop

70
00:03:23,060 --> 00:03:25,669
them and be better trained and be better

71
00:03:25,669 --> 00:03:28,340
in protecting but that's not what we

72
00:03:28,340 --> 00:03:31,970
mean in adapting a attackers tech tactic

73
00:03:31,970 --> 00:03:33,979
of course you need to do a red team you

74
00:03:33,979 --> 00:03:38,449
need to rehearse and mimic the attackers

75
00:03:38,449 --> 00:03:43,459
but that's not judo yet the DiGiacomo

76
00:03:43,459 --> 00:03:47,359
dos says that of course to be boxer is

77
00:03:47,359 --> 00:03:49,669
very important you need to defend you

78
00:03:49,669 --> 00:03:52,009
need to stop you need to mitigate but

79
00:03:52,009 --> 00:03:54,439
you can take the knowledge that you have

80
00:03:54,439 --> 00:03:59,030
gained and use it in order to a better

81
00:03:59,030 --> 00:04:02,540
defend your own network apply the same

82
00:04:02,540 --> 00:04:05,930
message that the attackers do and apply

83
00:04:05,930 --> 00:04:08,120
them for defense and hopefully by the

84
00:04:08,120 --> 00:04:12,349
end of this talk you would be able to

85
00:04:12,349 --> 00:04:14,870
convince you this is not just a nice PR

86
00:04:14,870 --> 00:04:18,019
and phrase but also something quite

87
00:04:18,019 --> 00:04:20,810
actionable that you can do on your own

88
00:04:20,810 --> 00:04:25,250
so let's take a little bit this is a

89
00:04:25,250 --> 00:04:27,199
little bit of a philosophical slide that

90
00:04:27,199 --> 00:04:27,530
the

91
00:04:27,530 --> 00:04:32,170
right so why in the first place and

92
00:04:32,170 --> 00:04:34,700
defenders are able to learn from

93
00:04:34,700 --> 00:04:37,340
attackers because in the end of the day

94
00:04:37,340 --> 00:04:39,620
defenders and attackers are very much

95
00:04:39,620 --> 00:04:43,040
the same we all wear a head be white hat

96
00:04:43,040 --> 00:04:45,500
or black hat but it's still ahead

97
00:04:45,500 --> 00:04:48,860
so defenders and attackers make all

98
00:04:48,860 --> 00:04:51,410
network a deployment in other terms

99
00:04:51,410 --> 00:04:53,180
defenders will call it proxy on network

100
00:04:53,180 --> 00:04:55,970
monitoring attackers will call it men in

101
00:04:55,970 --> 00:04:59,660
the middle or eavesdropper same goes for

102
00:04:59,660 --> 00:05:02,419
hot deployment either an agent or

103
00:05:02,419 --> 00:05:05,620
malware depends on where you sit and

104
00:05:05,620 --> 00:05:07,669
privileges both attackers and defenders

105
00:05:07,669 --> 00:05:11,060
strive to use as little the lower

106
00:05:11,060 --> 00:05:14,600
privileges as possible because they

107
00:05:14,600 --> 00:05:16,280
don't want to add any additional

108
00:05:16,280 --> 00:05:19,130
requirement to their attack tool or

109
00:05:19,130 --> 00:05:22,760
defensive tool integration both both of

110
00:05:22,760 --> 00:05:26,000
us try to live off the land attacks

111
00:05:26,000 --> 00:05:28,280
don't want to bring extra binaries to

112
00:05:28,280 --> 00:05:32,330
the environment and defense a product

113
00:05:32,330 --> 00:05:35,870
does not want to make do not want to

114
00:05:35,870 --> 00:05:38,570
make customer to to buy another pervert

115
00:05:38,570 --> 00:05:42,860
another product so and the expertise is

116
00:05:42,860 --> 00:05:46,340
quite the same we supposed at least to

117
00:05:46,340 --> 00:05:48,830
be well-versed in always internals and

118
00:05:48,830 --> 00:05:50,419
networking both attackers and defenders

119
00:05:50,419 --> 00:05:54,289
so it's very similar and domains and

120
00:05:54,289 --> 00:05:57,020
therefore it really makes sense the

121
00:05:57,020 --> 00:05:59,510
defender will be able to learn from

122
00:05:59,510 --> 00:06:03,289
attackers and with that let's talk a

123
00:06:03,289 --> 00:06:06,500
little bit about targeted attacks and we

124
00:06:06,500 --> 00:06:09,050
use the attack kill chain model in order

125
00:06:09,050 --> 00:06:12,289
to model their advanced attack so in the

126
00:06:12,289 --> 00:06:14,240
first phase attackers are able to

127
00:06:14,240 --> 00:06:17,330
penetrate into a single machine within

128
00:06:17,330 --> 00:06:20,990
their victim internal network most

129
00:06:20,990 --> 00:06:23,419
typically by launching a phishing

130
00:06:23,419 --> 00:06:26,360
campaign and eventually someone would

131
00:06:26,360 --> 00:06:28,789
click the malware or malicious link and

132
00:06:28,789 --> 00:06:31,910
get compromised but this is just an

133
00:06:31,910 --> 00:06:36,110
arbitrary user not necessarily the user

134
00:06:36,110 --> 00:06:39,950
that we are after their data or the

135
00:06:39,950 --> 00:06:41,380
attackers after their

136
00:06:41,380 --> 00:06:45,350
his or hers data and now that the

137
00:06:45,350 --> 00:06:48,230
attacker has a single a computer they

138
00:06:48,230 --> 00:06:50,720
control they want to advance within the

139
00:06:50,720 --> 00:06:53,840
network move towards as many computers

140
00:06:53,840 --> 00:06:57,620
as possible in order to gain the

141
00:06:57,620 --> 00:07:00,350
ultimate privileges in a Windows domain

142
00:07:00,350 --> 00:07:04,040
the domain admin credential and using

143
00:07:04,040 --> 00:07:06,550
the these credentials they are able to

144
00:07:06,550 --> 00:07:10,060
gain domain dominance either by directly

145
00:07:10,060 --> 00:07:11,960
installing something on the domain

146
00:07:11,960 --> 00:07:14,120
controller or just pulling that out of

147
00:07:14,120 --> 00:07:16,520
it maybe doing a distinct to get all

148
00:07:16,520 --> 00:07:18,890
keys information from the domain

149
00:07:18,890 --> 00:07:21,860
controller and then they attacker have

150
00:07:21,860 --> 00:07:24,980
the keys to all the doors but they are

151
00:07:24,980 --> 00:07:27,020
not winning yet because they need to get

152
00:07:27,020 --> 00:07:31,070
some specific data out of this network

153
00:07:31,070 --> 00:07:34,460
and be able to accelerate it and only

154
00:07:34,460 --> 00:07:37,760
then they can call them the campaign to

155
00:07:37,760 --> 00:07:40,400
be a successful one and this is a data

156
00:07:40,400 --> 00:07:42,950
the domain that Microsoft 88 it's

157
00:07:42,950 --> 00:07:47,000
focused on and we try to a unlike a

158
00:07:47,000 --> 00:07:50,810
single link cuts that chain and so to

159
00:07:50,810 --> 00:07:56,810
make the defenders win and just a - it's

160
00:07:56,810 --> 00:07:58,820
important to understand where we are in

161
00:07:58,820 --> 00:08:01,670
plate because to see the problem that we

162
00:08:01,670 --> 00:08:05,420
are facing so are a gateway usually see

163
00:08:05,420 --> 00:08:07,820
traffic from flowing into the domain

164
00:08:07,820 --> 00:08:10,550
controller so it does see a lot of

165
00:08:10,550 --> 00:08:13,160
traffic intercept traffic authentication

166
00:08:13,160 --> 00:08:15,500
stories Asian other protocols but it

167
00:08:15,500 --> 00:08:19,490
does not see traffic that doesn't go to

168
00:08:19,490 --> 00:08:21,710
the domain controller and it can't see

169
00:08:21,710 --> 00:08:24,230
encrypted traffic going to the domain

170
00:08:24,230 --> 00:08:27,260
controller and we will address two of

171
00:08:27,260 --> 00:08:30,410
these two problem these specific

172
00:08:30,410 --> 00:08:34,220
problems and we'll show how using some

173
00:08:34,220 --> 00:08:35,840
attackers method who are able to

174
00:08:35,840 --> 00:08:39,950
compensate for the lack of visibility so

175
00:08:39,950 --> 00:08:42,530
now let's take a deeper dive into the

176
00:08:42,530 --> 00:08:45,350
lateral movement reconnaissance and they

177
00:08:45,350 --> 00:08:48,410
see in what attackers are doing this so

178
00:08:48,410 --> 00:08:50,870
just to remind us is the attacker goal

179
00:08:50,870 --> 00:08:53,470
in that cell is grow from here that

180
00:08:53,470 --> 00:08:54,920
arbitrary

181
00:08:54,920 --> 00:08:58,040
a random user that they were able to

182
00:08:58,040 --> 00:09:01,160
infect and get to their to domain admin

183
00:09:01,160 --> 00:09:04,070
to the ultimate privilege in a Windows

184
00:09:04,070 --> 00:09:07,339
domain and how do they do that because

185
00:09:07,339 --> 00:09:09,680
every journey starts with a single step

186
00:09:09,680 --> 00:09:11,810
so a single step in that case would be

187
00:09:11,810 --> 00:09:14,800
to move from one computer to another and

188
00:09:14,800 --> 00:09:18,110
attackers use a current computer user

189
00:09:18,110 --> 00:09:20,480
privileges in order to execute on the

190
00:09:20,480 --> 00:09:22,370
target computer on the next computer and

191
00:09:22,370 --> 00:09:24,949
they do that technically by using some

192
00:09:24,949 --> 00:09:27,019
remote code execution tools such as this

193
00:09:27,019 --> 00:09:30,320
exec W max Egremont PowerShell and quite

194
00:09:30,320 --> 00:09:33,050
a few more and the payload did they

195
00:09:33,050 --> 00:09:36,290
execute on the remote computer stills

196
00:09:36,290 --> 00:09:39,860
the users credentials and create a new

197
00:09:39,860 --> 00:09:43,459
session or migrate to the existing

198
00:09:43,459 --> 00:09:46,850
session and attackers do that repeatedly

199
00:09:46,850 --> 00:09:50,870
these steps one after the not after the

200
00:09:50,870 --> 00:09:53,449
other and until they get to their

201
00:09:53,449 --> 00:09:55,430
destination of the domain admin an

202
00:09:55,430 --> 00:09:58,670
important note is that this process

203
00:09:58,670 --> 00:10:00,920
requires some high privileges on the

204
00:10:00,920 --> 00:10:03,350
target machine because as you would

205
00:10:03,350 --> 00:10:07,100
expect not anyone can execute any

206
00:10:07,100 --> 00:10:10,100
commands on remote machine you probably

207
00:10:10,100 --> 00:10:11,990
have to be an admin on that machine in

208
00:10:11,990 --> 00:10:17,449
order to execute on it remotely okay so

209
00:10:17,449 --> 00:10:19,970
how can we get methodically from here to

210
00:10:19,970 --> 00:10:23,120
there and the physical world the answer

211
00:10:23,120 --> 00:10:25,760
would be a map they are in the computer

212
00:10:25,760 --> 00:10:28,660
science lingo it would be a graph and

213
00:10:28,660 --> 00:10:32,029
specifically directed graph in which in

214
00:10:32,029 --> 00:10:35,180
this map the cities are computers and

215
00:10:35,180 --> 00:10:37,370
the user that are logged on to them and

216
00:10:37,370 --> 00:10:39,620
the rows are computer and user

217
00:10:39,620 --> 00:10:43,519
permissions so a computer a would have a

218
00:10:43,519 --> 00:10:46,579
road to computer be if logged on user on

219
00:10:46,579 --> 00:10:48,399
computer a have code execution

220
00:10:48,399 --> 00:10:50,870
permission and privileges on computers

221
00:10:50,870 --> 00:10:55,699
be in order to build the map attacker

222
00:10:55,699 --> 00:10:58,130
needs to note this three ingredients

223
00:10:58,130 --> 00:11:01,329
that we'll talk in the next slide about

224
00:11:01,329 --> 00:11:04,310
them specifically they need to find out

225
00:11:04,310 --> 00:11:06,410
about the cities where the users are

226
00:11:06,410 --> 00:11:08,600
logged on the roads user permission

227
00:11:08,600 --> 00:11:10,759
two computers and destination who are

228
00:11:10,759 --> 00:11:13,100
the domain admins there a suckers

229
00:11:13,100 --> 00:11:15,230
destination and all of this knowledge

230
00:11:15,230 --> 00:11:18,050
must be gained just as a low privilege

231
00:11:18,050 --> 00:11:20,839
user account because if it's already a

232
00:11:20,839 --> 00:11:22,940
high privilege account then the

233
00:11:22,940 --> 00:11:25,940
attackers had won and this kind of

234
00:11:25,940 --> 00:11:27,529
activity is called reconnaissance it's

235
00:11:27,529 --> 00:11:29,930
taken of course from the military domain

236
00:11:29,930 --> 00:11:31,940
it's all about gaining knowledge on

237
00:11:31,940 --> 00:11:34,399
anniversary in a hostile environment in

238
00:11:34,399 --> 00:11:36,920
this case the attacker adversaries asked

239
00:11:36,920 --> 00:11:41,449
the defenders and this is the graph that

240
00:11:41,449 --> 00:11:46,339
I stole from Def Con a presentation of

241
00:11:46,339 --> 00:11:49,130
bloodhound and because it's very good

242
00:11:49,130 --> 00:11:53,779
and let's drop the matter for that's

243
00:11:53,779 --> 00:11:56,839
what's going on which we use a bob we

244
00:11:56,839 --> 00:12:00,709
see use upon let's see if we see this is

245
00:12:00,709 --> 00:12:04,639
the Bob okay you see user Bob and his

246
00:12:04,639 --> 00:12:07,910
member of a group IT admins and we

247
00:12:07,910 --> 00:12:09,800
learned that group IP admins are admins

248
00:12:09,800 --> 00:12:12,319
on computers everyone and we learned the

249
00:12:12,319 --> 00:12:14,569
attackers learn that user mary has

250
00:12:14,569 --> 00:12:17,269
logged on on computers everyone has

251
00:12:17,269 --> 00:12:19,850
session to it and she is also a member

252
00:12:19,850 --> 00:12:22,339
of the group domain admin so it really

253
00:12:22,339 --> 00:12:24,740
shows us it showed the attacker a path

254
00:12:24,740 --> 00:12:27,380
how to get from user Bob to domain admin

255
00:12:27,380 --> 00:12:31,389
so let's break it down to the specific

256
00:12:31,389 --> 00:12:34,399
phases of it specific steps and let's

257
00:12:34,399 --> 00:12:37,579
take it one step at a time so first how

258
00:12:37,579 --> 00:12:39,439
attackers learn that user Bob is a

259
00:12:39,439 --> 00:12:41,180
member of group idea that means well

260
00:12:41,180 --> 00:12:42,889
this is very easy it's a simple

261
00:12:42,889 --> 00:12:46,399
command-line do a go to your Windows

262
00:12:46,399 --> 00:12:49,370
computer do if it's member of domain and

263
00:12:49,370 --> 00:12:51,410
do let user slash domain and the

264
00:12:51,410 --> 00:12:53,149
username and you will see a lot of

265
00:12:53,149 --> 00:12:55,250
interesting data but the user including

266
00:12:55,250 --> 00:12:58,610
group membership so and that user Bob

267
00:12:58,610 --> 00:13:01,639
will give us a and the attackers its

268
00:13:01,639 --> 00:13:05,149
membership same goes for net groups all

269
00:13:05,149 --> 00:13:07,759
kinds of interesting data and

270
00:13:07,759 --> 00:13:09,740
information about groups and their

271
00:13:09,740 --> 00:13:12,310
members and you can do full enumeration

272
00:13:12,310 --> 00:13:15,470
all users all groups or just for

273
00:13:15,470 --> 00:13:19,100
specific entity and over the network in

274
00:13:19,100 --> 00:13:20,959
manifests itself as you can see the

275
00:13:20,959 --> 00:13:22,190
allow lower

276
00:13:22,190 --> 00:13:25,310
ten side is some our protocol traffic

277
00:13:25,310 --> 00:13:28,070
against the domain controller so if we

278
00:13:28,070 --> 00:13:30,410
are monitoring the domain controller we

279
00:13:30,410 --> 00:13:32,830
can see that and require permission and

280
00:13:32,830 --> 00:13:35,240
maybe it would be surprised but any

281
00:13:35,240 --> 00:13:37,370
domain user n domain user can learn

282
00:13:37,370 --> 00:13:41,780
about all members all all users of the

283
00:13:41,780 --> 00:13:44,930
domain all groups even if it is not or

284
00:13:44,930 --> 00:13:47,690
she is not a member of any of this a

285
00:13:47,690 --> 00:13:50,660
group and we can see a screenshot of

286
00:13:50,660 --> 00:13:53,810
that command and just enumeration of

287
00:13:53,810 --> 00:13:57,100
some big domain and a list of users

288
00:13:57,100 --> 00:14:00,700
reducted the list of user is returned

289
00:14:00,700 --> 00:14:05,660
okay the next step in the attacker plan

290
00:14:05,660 --> 00:14:08,330
is to okay we learn the Bob is member of

291
00:14:08,330 --> 00:14:10,760
group IP I mean let's learn what group

292
00:14:10,760 --> 00:14:13,850
IT admins can do maybe there are admins

293
00:14:13,850 --> 00:14:17,090
on computers everyone and to do so you

294
00:14:17,090 --> 00:14:19,690
can utilize this powershell commandlets

295
00:14:19,690 --> 00:14:22,610
getnet local group written by a

296
00:14:22,610 --> 00:14:26,120
colleague of md very screwdriver right

297
00:14:26,120 --> 00:14:29,840
and so this is a publicly available you

298
00:14:29,840 --> 00:14:32,330
can go grab it from github and using

299
00:14:32,330 --> 00:14:36,050
that command a the user can list local

300
00:14:36,050 --> 00:14:40,070
users and group on any machine and again

301
00:14:40,070 --> 00:14:42,850
requires permission any domain user can

302
00:14:42,850 --> 00:14:47,240
query any computer and over the

303
00:14:47,240 --> 00:14:49,070
networking manifest itself again it's

304
00:14:49,070 --> 00:14:52,040
some are traffic but this time against

305
00:14:52,040 --> 00:14:54,170
the queried computer and not against the

306
00:14:54,170 --> 00:14:56,900
domain controller as we achieve and you

307
00:14:56,900 --> 00:14:59,810
can see screenshots of the output of

308
00:14:59,810 --> 00:15:03,560
this command and we queried the client

309
00:15:03,560 --> 00:15:07,190
one a computer and got a list of the

310
00:15:07,190 --> 00:15:10,010
groups on that computer and of course we

311
00:15:10,010 --> 00:15:13,520
can list the a group of a lot of

312
00:15:13,520 --> 00:15:15,230
administrators local group of

313
00:15:15,230 --> 00:15:17,180
administrator and files who are the

314
00:15:17,180 --> 00:15:20,170
local administrator on that computer and

315
00:15:20,170 --> 00:15:23,240
the final step was to find out that on

316
00:15:23,240 --> 00:15:25,940
computers everyone who is logged on find

317
00:15:25,940 --> 00:15:29,390
out that Mary is logged on on it so if

318
00:15:29,390 --> 00:15:31,580
this functionality is implemented in the

319
00:15:31,580 --> 00:15:33,830
Nets s tool it this is a very old tool

320
00:15:33,830 --> 00:15:34,490
it

321
00:15:34,490 --> 00:15:36,890
was the banner said it was written on

322
00:15:36,890 --> 00:15:39,890
January 2004 some more than a decade ago

323
00:15:39,890 --> 00:15:44,300
and what it does it uses the SMB service

324
00:15:44,300 --> 00:15:46,420
and the sob service can be queried

325
00:15:46,420 --> 00:15:48,860
remotely for active session who is room

326
00:15:48,860 --> 00:15:51,709
a remotely connected to the SMB server

327
00:15:51,709 --> 00:15:55,339
on the machine and in reply it returns

328
00:15:55,339 --> 00:15:57,740
the IP address and the username of this

329
00:15:57,740 --> 00:16:00,230
user over the network in many sets

330
00:16:00,230 --> 00:16:03,320
itself is SRV SVC protocol traffic

331
00:16:03,320 --> 00:16:05,000
against the domain controller again if

332
00:16:05,000 --> 00:16:06,950
you monitor domain control traffic you

333
00:16:06,950 --> 00:16:08,839
can see that and requires permission

334
00:16:08,839 --> 00:16:13,790
again like motive any domain user so but

335
00:16:13,790 --> 00:16:17,360
how does it help attacker to find out

336
00:16:17,360 --> 00:16:19,850
who is logged on well every logged on

337
00:16:19,850 --> 00:16:22,580
user fetches group policy from the DC on

338
00:16:22,580 --> 00:16:25,550
in a periodic manner when they when you

339
00:16:25,550 --> 00:16:28,339
log on you fetch group policy and also

340
00:16:28,339 --> 00:16:31,610
in periodic manner every one hour and a

341
00:16:31,610 --> 00:16:35,420
half and group policy are sent over SMB

342
00:16:35,420 --> 00:16:38,839
so if a talker and queries the domain

343
00:16:38,839 --> 00:16:41,360
controller who is connected to your

344
00:16:41,360 --> 00:16:44,320
version B you will see a portion of the

345
00:16:44,320 --> 00:16:47,180
clients that are currently downloading

346
00:16:47,180 --> 00:16:52,720
and their group policy over SMB and by a

347
00:16:52,720 --> 00:16:56,870
querying foreign let's say an hour and a

348
00:16:56,870 --> 00:17:00,350
half all connected users should connect

349
00:17:00,350 --> 00:17:03,010
and grab group policy and attacker

350
00:17:03,010 --> 00:17:05,780
periodically samples a domain controller

351
00:17:05,780 --> 00:17:06,740
for user

352
00:17:06,740 --> 00:17:09,530
there are connect of SMB and is able to

353
00:17:09,530 --> 00:17:11,990
see who is connected where uses in the

354
00:17:11,990 --> 00:17:16,819
lower and in the end of this a sliders

355
00:17:16,819 --> 00:17:21,819
screenshot that nets s against a ADC and

356
00:17:21,819 --> 00:17:26,030
returns is the admin is user at the

357
00:17:26,030 --> 00:17:30,320
admin is connected from I gather 1002

358
00:17:30,320 --> 00:17:35,420
and using that we can discover all the

359
00:17:35,420 --> 00:17:37,250
whereabouts of all the user all of the

360
00:17:37,250 --> 00:17:39,950
on user and specifically use a marriage

361
00:17:39,950 --> 00:17:41,990
that is connected to seven one so let's

362
00:17:41,990 --> 00:17:45,440
put it all together so we had use above

363
00:17:45,440 --> 00:17:47,720
and discover the attacker discovered

364
00:17:47,720 --> 00:17:50,150
is a member of a group ID admins using

365
00:17:50,150 --> 00:17:55,700
the netskope command then using a guest

366
00:17:55,700 --> 00:17:58,159
net local groups against computer server

367
00:17:58,159 --> 00:18:00,860
one the talk has learned that IT admins

368
00:18:00,860 --> 00:18:03,080
are insect administrators auto

369
00:18:03,080 --> 00:18:05,900
administrators on sever one and they

370
00:18:05,900 --> 00:18:09,230
discovered by sampling and periodically

371
00:18:09,230 --> 00:18:11,900
with net says the domain controller for

372
00:18:11,900 --> 00:18:14,450
SMB connected users they found out the

373
00:18:14,450 --> 00:18:17,230
user Mary's logged on on sever one and

374
00:18:17,230 --> 00:18:19,970
she is a member of group domain admins

375
00:18:19,970 --> 00:18:23,570
again that group or net user on Mary and

376
00:18:23,570 --> 00:18:26,809
so we have all the ingredients attackers

377
00:18:26,809 --> 00:18:28,460
that let's have all the ingredients and

378
00:18:28,460 --> 00:18:32,480
to do their job also attackers got a

379
00:18:32,480 --> 00:18:35,659
little bit lazy and saying oh map is for

380
00:18:35,659 --> 00:18:38,480
old guys it's so many well we need the

381
00:18:38,480 --> 00:18:41,210
navigation apps the this generation

382
00:18:41,210 --> 00:18:43,610
requires a navigation up don't want to

383
00:18:43,610 --> 00:18:45,500
do the hard work themselves so they have

384
00:18:45,500 --> 00:18:48,799
bloodhound and developed by again very

385
00:18:48,799 --> 00:18:52,460
scooped guys and you can go on download

386
00:18:52,460 --> 00:18:55,669
it play with it yeah try it on your own

387
00:18:55,669 --> 00:18:58,429
network you will be amazed with the

388
00:18:58,429 --> 00:18:59,960
results you would find something

389
00:18:59,960 --> 00:19:03,860
interesting I can guarantee ok and it's

390
00:19:03,860 --> 00:19:06,919
not just a graphic tool it's not not

391
00:19:06,919 --> 00:19:10,159
just present of this connection in a

392
00:19:10,159 --> 00:19:13,570
nice graphic manner it allows you you to

393
00:19:13,570 --> 00:19:16,610
to do all kinds of queries and most

394
00:19:16,610 --> 00:19:18,890
importantly find shortest path from one

395
00:19:18,890 --> 00:19:22,460
user to another specifically from the

396
00:19:22,460 --> 00:19:24,320
user that the attacker of ten tester

397
00:19:24,320 --> 00:19:27,860
controls to the domain admin and show

398
00:19:27,860 --> 00:19:32,330
the path ok so we had imagine let's

399
00:19:32,330 --> 00:19:35,120
imagine an autonomous lateral movement

400
00:19:35,120 --> 00:19:39,200
to ml where that automatically executes

401
00:19:39,200 --> 00:19:42,140
blood down star reconnaissance well we

402
00:19:42,140 --> 00:19:45,110
can imagine that quite easily compute

403
00:19:45,110 --> 00:19:47,570
shortest path the domain admin well it's

404
00:19:47,570 --> 00:19:50,150
already part of say blood down this that

405
00:19:50,150 --> 00:19:52,299
should be easy and the mirror then

406
00:19:52,299 --> 00:19:55,309
automatically do the lateral movements

407
00:19:55,309 --> 00:19:58,280
suggested by blue the blood downs of

408
00:19:58,280 --> 00:20:01,490
bloodhound like a functionality

409
00:20:01,490 --> 00:20:04,880
and now we can you can open your eyes no

410
00:20:04,880 --> 00:20:08,210
need to imagine anymore because we said

411
00:20:08,210 --> 00:20:11,149
well we're even lazier than blood down

412
00:20:11,149 --> 00:20:11,929
guys

413
00:20:11,929 --> 00:20:14,990
because navigation app is for old guys

414
00:20:14,990 --> 00:20:17,450
we want an autonomous vehicle and sauna

415
00:20:17,450 --> 00:20:19,299
most car that's what's going on today so

416
00:20:19,299 --> 00:20:22,520
we're telling that bloodhound dog to go

417
00:20:22,520 --> 00:20:25,159
fetch and an autonomous lateral movement

418
00:20:25,159 --> 00:20:27,080
to developed by Microsoft as a

419
00:20:27,080 --> 00:20:31,610
researcher Tama or aka Sal to dot now

420
00:20:31,610 --> 00:20:34,460
that's how other Tom more talented Tom

421
00:20:34,460 --> 00:20:38,659
and get bloodhound a exported graph its

422
00:20:38,659 --> 00:20:41,090
photos a JSON is attack plan input and

423
00:20:41,090 --> 00:20:44,630
then execute that attack plan a remote

424
00:20:44,630 --> 00:20:46,820
code execution with the remote

425
00:20:46,820 --> 00:20:48,909
powershell partial remoting and

426
00:20:48,909 --> 00:20:51,980
credential have a think from memory with

427
00:20:51,980 --> 00:20:58,279
mimic ax so let's see a demo of it no

428
00:20:58,279 --> 00:21:01,090
want to see a demo

429
00:21:01,090 --> 00:21:04,169
[Music]

430
00:21:07,929 --> 00:21:10,269
I think we're good to go so this is the

431
00:21:10,269 --> 00:21:13,090
attacker control user is a to Elm client

432
00:21:13,090 --> 00:21:16,690
size PC the attacker on execute blacked

433
00:21:16,690 --> 00:21:19,600
out reconnaissance and fits the result

434
00:21:19,600 --> 00:21:23,009
into the bloodhound a database in UI

435
00:21:23,009 --> 00:21:26,019
which is there is a nice simple graphs

436
00:21:26,019 --> 00:21:29,259
but we want the paths and from the

437
00:21:29,259 --> 00:21:31,929
control user user to that we have all

438
00:21:31,929 --> 00:21:34,749
the way to domain admin and this path

439
00:21:34,749 --> 00:21:36,850
traverses through and three different

440
00:21:36,850 --> 00:21:39,820
computers and three different user we

441
00:21:39,820 --> 00:21:44,289
will export that data into JSON and then

442
00:21:44,289 --> 00:21:47,879
fit it and to go fetch it's written in

443
00:21:47,879 --> 00:21:51,429
Python and it takes as an input that a

444
00:21:51,429 --> 00:21:53,889
graph don't worry if you don't see too

445
00:21:53,889 --> 00:21:57,190
much because we'll do zoom in one two

446
00:21:57,190 --> 00:22:00,369
okay this is oom and this is attack

447
00:22:00,369 --> 00:22:06,190
blender and three steps in it and

448
00:22:06,190 --> 00:22:08,470
divided to five but it's really three

449
00:22:08,470 --> 00:22:10,869
step three machines that the attacker

450
00:22:10,869 --> 00:22:14,110
has to traverse through and we can see

451
00:22:14,110 --> 00:22:17,259
the attack is already on its way and me

452
00:22:17,259 --> 00:22:20,649
we were executing using remote

453
00:22:20,649 --> 00:22:26,309
powershell and mimic us on that path and

454
00:22:26,309 --> 00:22:29,259
ntlm hash is a cross extracted on the

455
00:22:29,259 --> 00:22:32,110
way are prompted to the screen outputted

456
00:22:32,110 --> 00:22:34,240
to the stream and we can see that that

457
00:22:34,240 --> 00:22:36,639
finally the tool was able to extract the

458
00:22:36,639 --> 00:22:41,679
administrator a hash as an executed

459
00:22:41,679 --> 00:22:46,690
attack plan as suggested by platen so I

460
00:22:46,690 --> 00:22:48,970
think this pretty much impressive I

461
00:22:48,970 --> 00:22:52,330
think so and we won't leave you just

462
00:22:52,330 --> 00:22:55,119
with the problems now it is coming to

463
00:22:55,119 --> 00:22:57,700
help at all save us all with the defense

464
00:22:57,700 --> 00:23:03,429
so die okay so walk us through the

465
00:23:03,429 --> 00:23:05,350
lateral movement attackers battle moon

466
00:23:05,350 --> 00:23:08,200
movement tactic and several contents

467
00:23:08,200 --> 00:23:10,809
techniques now let's see how defenders

468
00:23:10,809 --> 00:23:13,539
can defend their domain so many dos

469
00:23:13,539 --> 00:23:17,320
attacks so firstly that defenders would

470
00:23:17,320 --> 00:23:19,509
like to do is blocking those attacks or

471
00:23:19,509 --> 00:23:21,940
in our case how them

472
00:23:21,940 --> 00:23:24,320
if we're talking about the local users

473
00:23:24,320 --> 00:23:25,730
and groups connaissance where the

474
00:23:25,730 --> 00:23:27,500
attackers trying to get as much

475
00:23:27,500 --> 00:23:29,240
information from our domain machines

476
00:23:29,240 --> 00:23:31,390
about the users and their permissions

477
00:23:31,390 --> 00:23:35,000
there is needed over the protocol name

478
00:23:35,000 --> 00:23:38,780
sama and since Windows 10 there is a new

479
00:23:38,780 --> 00:23:42,020
registry valuable energy poverty main

480
00:23:42,020 --> 00:23:44,960
restricted remote sum which controls the

481
00:23:44,960 --> 00:23:50,180
access to this exact same protocol so we

482
00:23:50,180 --> 00:23:53,570
can edit this photo call and move any of

483
00:23:53,570 --> 00:23:58,070
any domain users allowance and add the

484
00:23:58,070 --> 00:24:00,530
domain all only local administrators and

485
00:24:00,530 --> 00:24:04,070
permission and since Windows 10

486
00:24:04,070 --> 00:24:07,340
anniversary update by default you have

487
00:24:07,340 --> 00:24:09,920
this option I mean somehow is already

488
00:24:09,920 --> 00:24:12,470
hardened the only local insiders can

489
00:24:12,470 --> 00:24:15,740
remotely call this protocol and there is

490
00:24:15,740 --> 00:24:18,400
a huge group policy settings that can

491
00:24:18,400 --> 00:24:22,750
control this poverty and we are lucky I

492
00:24:22,750 --> 00:24:26,300
so they can have them the local user and

493
00:24:26,300 --> 00:24:29,780
group another thing that the fellows can

494
00:24:29,780 --> 00:24:32,450
do is detect ok detection is quite

495
00:24:32,450 --> 00:24:37,340
simple they can detect the many in this

496
00:24:37,340 --> 00:24:39,380
case we have abnormal access to

497
00:24:39,380 --> 00:24:41,630
resources in the domain environment

498
00:24:41,630 --> 00:24:43,760
these are that they compromised the

499
00:24:43,760 --> 00:24:46,070
attack is compromised is performing

500
00:24:46,070 --> 00:24:48,560
access to many machines in order lame so

501
00:24:48,560 --> 00:24:50,300
this access can be monitored by a

502
00:24:50,300 --> 00:24:52,790
security device in this case you can see

503
00:24:52,790 --> 00:24:55,670
a screenshot from a ta which tells us

504
00:24:55,670 --> 00:24:58,190
that user two which was compromised by

505
00:24:58,190 --> 00:25:02,420
attackers we performed many access to

506
00:25:02,420 --> 00:25:05,570
various a machines in our domain in this

507
00:25:05,570 --> 00:25:08,750
case 25 and normal resources were

508
00:25:08,750 --> 00:25:11,320
usually accessed only 6 so we have

509
00:25:11,320 --> 00:25:16,000
abnormal detection of the users behavior

510
00:25:16,270 --> 00:25:17,420
ok

511
00:25:17,420 --> 00:25:19,460
we blocked the attackers from accessing

512
00:25:19,460 --> 00:25:21,920
our users and groups say from local

513
00:25:21,920 --> 00:25:24,050
machines but the next test we want to do

514
00:25:24,050 --> 00:25:27,590
is blocking them from getting access to

515
00:25:27,590 --> 00:25:28,870
users

516
00:25:28,870 --> 00:25:31,540
and groups in our domain which are not

517
00:25:31,540 --> 00:25:34,990
local and again the this query let user

518
00:25:34,990 --> 00:25:38,260
net group also goes over their sam'l

519
00:25:38,260 --> 00:25:41,440
protocol and if the defenders have

520
00:25:41,440 --> 00:25:45,820
Windows Server 2016 they can edit the

521
00:25:45,820 --> 00:25:48,910
same registry value and remove or set

522
00:25:48,910 --> 00:25:52,330
the access onto local min status and if

523
00:25:52,330 --> 00:25:54,760
a normal user or regular domain user

524
00:25:54,760 --> 00:25:57,430
tries to get for example in this

525
00:25:57,430 --> 00:25:59,830
screenshot an egg group domain admins

526
00:25:59,830 --> 00:26:02,650
which gives me gives it the domain

527
00:26:02,650 --> 00:26:04,570
address in this domain you'll get access

528
00:26:04,570 --> 00:26:12,010
denied and again you can detect this

529
00:26:12,010 --> 00:26:14,920
query also again you have a summer

530
00:26:14,920 --> 00:26:17,170
traffic to the domain controller and

531
00:26:17,170 --> 00:26:21,010
this time the network and device detects

532
00:26:21,010 --> 00:26:23,290
the query and over the protocol somehow

533
00:26:23,290 --> 00:26:26,380
and it can detect the user the exact

534
00:26:26,380 --> 00:26:28,660
user that they found that action from

535
00:26:28,660 --> 00:26:32,890
which a machine and which method on the

536
00:26:32,890 --> 00:26:35,200
protocol was caught in this case it's

537
00:26:35,200 --> 00:26:38,290
that you can see it what it's the I know

538
00:26:38,290 --> 00:26:40,990
what all users okay some user would

539
00:26:40,990 --> 00:26:43,480
would like no all the users in this to

540
00:26:43,480 --> 00:26:50,230
me okay so the next thing that we like

541
00:26:50,230 --> 00:26:52,600
to block is getting information on

542
00:26:52,600 --> 00:26:55,450
logged on users in this domain so as Don

543
00:26:55,450 --> 00:26:58,510
mentioned autocracy is the next tool

544
00:26:58,510 --> 00:27:00,820
against the domain controller to verify

545
00:27:00,820 --> 00:27:03,700
and which user is logged on on each

546
00:27:03,700 --> 00:27:07,270
machine and which IP this access this

547
00:27:07,270 --> 00:27:11,530
method called has a specific registry

548
00:27:11,530 --> 00:27:14,890
value in the diversity we start in this

549
00:27:14,890 --> 00:27:17,320
case is s obviously system equal as you

550
00:27:17,320 --> 00:27:20,470
can see in this screenshot and this

551
00:27:20,470 --> 00:27:23,710
value this registry set property

552
00:27:23,710 --> 00:27:26,050
contains an access control list which

553
00:27:26,050 --> 00:27:29,380
tells the tells us who has access to

554
00:27:29,380 --> 00:27:30,600
this method

555
00:27:30,600 --> 00:27:34,179
so the defenders can remove the

556
00:27:34,179 --> 00:27:36,400
authenticated user group manually or

557
00:27:36,400 --> 00:27:38,830
they can use the tool that wrote message

558
00:27:38,830 --> 00:27:42,160
tool that does it for them and we need

559
00:27:42,160 --> 00:27:45,610
that one day anywhere a regular user

560
00:27:45,610 --> 00:27:47,500
tries to not just the domain controller

561
00:27:47,500 --> 00:27:49,990
to get access denied as you can see the

562
00:27:49,990 --> 00:27:56,680
screenshot below and again detection is

563
00:27:56,680 --> 00:27:59,260
also possible in this scenario in this

564
00:27:59,260 --> 00:28:01,000
case we are talking about the SLV sec

565
00:28:01,000 --> 00:28:04,540
protocol which is the SMB protocol so if

566
00:28:04,540 --> 00:28:06,730
you have a natural device that monitors

567
00:28:06,730 --> 00:28:09,130
the traffic to the domain controller you

568
00:28:09,130 --> 00:28:12,370
can see that a leafless administrator to

569
00:28:12,370 --> 00:28:15,810
perform the SMB nasturtium emulation and

570
00:28:15,810 --> 00:28:20,080
you can tell exactly which users were

571
00:28:20,080 --> 00:28:24,970
exposed to display so that's even better

572
00:28:24,970 --> 00:28:28,560
for forensic so investigation on some

573
00:28:28,560 --> 00:28:31,560
attack

574
00:28:31,770 --> 00:28:36,940
okay so we've locked the ethics but we

575
00:28:36,940 --> 00:28:39,460
told you that you can use the specific

576
00:28:39,460 --> 00:28:41,440
attacks in order to have a better

577
00:28:41,440 --> 00:28:44,260
details so let's let's start with the

578
00:28:44,260 --> 00:28:48,610
nexus in example in order to understand

579
00:28:48,610 --> 00:28:51,970
how we use the nexus for better results

580
00:28:51,970 --> 00:28:54,190
we need to talk about a little about the

581
00:28:54,190 --> 00:28:56,830
ntlm authentication until until an

582
00:28:56,830 --> 00:28:59,200
authentication the user tries to

583
00:28:59,200 --> 00:29:01,390
authenticate itself against a remote

584
00:29:01,390 --> 00:29:04,810
machine this server the user who's

585
00:29:04,810 --> 00:29:06,790
trying to authenticate itself sends the

586
00:29:06,790 --> 00:29:08,020
authentication request to be the

587
00:29:08,020 --> 00:29:09,970
magnitude domain controller and the

588
00:29:09,970 --> 00:29:11,880
domain controller sends a verification

589
00:29:11,880 --> 00:29:14,740
and the federation data in case for the

590
00:29:14,740 --> 00:29:16,900
successful authentication but this

591
00:29:16,900 --> 00:29:19,240
traffic between the server and the

592
00:29:19,240 --> 00:29:22,390
domain controller is done via secure

593
00:29:22,390 --> 00:29:24,280
channel which means this traffic is

594
00:29:24,280 --> 00:29:26,320
encrypted so if you have a security

595
00:29:26,320 --> 00:29:29,020
device that monitors this traffic it can

596
00:29:29,020 --> 00:29:34,810
do anything with that possibly so why

597
00:29:34,810 --> 00:29:37,090
are we talking about ntlm and I tell

598
00:29:37,090 --> 00:29:39,580
them is very common in attacks in some

599
00:29:39,580 --> 00:29:41,620
attacks and killings essence such as

600
00:29:41,620 --> 00:29:44,380
pass - okay were the hashes can tell and

601
00:29:44,380 --> 00:29:46,870
hash and Intel in real attacks it's

602
00:29:46,870 --> 00:29:50,860
still possible and sometimes a theorem

603
00:29:50,860 --> 00:29:54,430
is done by default was in such cases you

604
00:29:54,430 --> 00:29:55,990
have all the tattoos that

605
00:29:55,990 --> 00:29:59,380
get an upgrade to tables all you use

606
00:29:59,380 --> 00:30:02,260
some attack against the remote machine

607
00:30:02,260 --> 00:30:05,950
by its IP a lot at DNA and this case

608
00:30:05,950 --> 00:30:08,770
calvo's can't really world or sometimes

609
00:30:08,770 --> 00:30:10,900
we have chaos failures where the

610
00:30:10,900 --> 00:30:12,490
operating system downgrades

611
00:30:12,490 --> 00:30:17,140
automatically to internal application so

612
00:30:17,140 --> 00:30:19,330
as i mentioned earlier since we are

613
00:30:19,330 --> 00:30:21,190
talking about secure channel between the

614
00:30:21,190 --> 00:30:23,140
server and which delegates the 10th

615
00:30:23,140 --> 00:30:25,540
occasion to the domain controller we

616
00:30:25,540 --> 00:30:27,580
have a visibility problem ok we have a

617
00:30:27,580 --> 00:30:28,930
security device that monitors this

618
00:30:28,930 --> 00:30:30,610
traffic and the only thing that you can

619
00:30:30,610 --> 00:30:33,850
know is the opcode which means the the

620
00:30:33,850 --> 00:30:35,740
letter that was being called over this

621
00:30:35,740 --> 00:30:40,050
protocol in this case we see here the

622
00:30:40,050 --> 00:30:43,210
method and they include the encrypted

623
00:30:43,210 --> 00:30:46,570
data that came with this a method for so

624
00:30:46,570 --> 00:30:50,830
we can't miss the user information we

625
00:30:50,830 --> 00:30:52,930
can know which user was performing this

626
00:30:52,930 --> 00:30:55,240
application and from which machine which

627
00:30:55,240 --> 00:30:59,850
helps us identify pass the hash generics

628
00:30:59,850 --> 00:31:04,150
so how can we overcome this problem well

629
00:31:04,150 --> 00:31:08,580
here comes the NHS a 12 once we detect

630
00:31:08,580 --> 00:31:11,320
successful ntlm authentication we can

631
00:31:11,320 --> 00:31:13,510
extract the source IP which is the

632
00:31:13,510 --> 00:31:16,240
server that was delegating this

633
00:31:16,240 --> 00:31:18,790
authentication and to form against the

634
00:31:18,790 --> 00:31:22,420
server the necess recon ok that would

635
00:31:22,420 --> 00:31:25,540
give us the user the profoundest that

636
00:31:25,540 --> 00:31:28,780
open the session and the IP that it was

637
00:31:28,780 --> 00:31:32,800
always involved we also implemented this

638
00:31:32,800 --> 00:31:35,320
scenario in different tube but it will

639
00:31:35,320 --> 00:31:41,650
be public soon then let's see so if

640
00:31:41,650 --> 00:31:42,940
you'll have a look at the entire

641
00:31:42,940 --> 00:31:44,740
application again

642
00:31:44,740 --> 00:31:47,740
so we've detected a successful until an

643
00:31:47,740 --> 00:31:50,500
authentication our security device once

644
00:31:50,500 --> 00:31:52,330
not just against the server delegate

645
00:31:52,330 --> 00:31:56,800
this application and we got the user one

646
00:31:56,800 --> 00:32:00,040
in this case and it's IP address so the

647
00:32:00,040 --> 00:32:02,880
visibility problem resolved

648
00:32:02,880 --> 00:32:03,970
that's

649
00:32:03,970 --> 00:32:06,400
a quick demo I'll show you this side

650
00:32:06,400 --> 00:32:13,680
exactly that's a second

651
00:32:19,820 --> 00:32:24,350
okay here we have our domain controller

652
00:32:24,350 --> 00:32:28,100
okay let's run our security device in

653
00:32:28,100 --> 00:32:32,269
this case a wire sort and filter on ntlm

654
00:32:32,269 --> 00:32:40,840
authentication and let's go to our

655
00:32:41,289 --> 00:32:44,840
machine this is a machine now and violet

656
00:32:44,840 --> 00:32:48,619
let's see who's the user is the one and

657
00:32:48,619 --> 00:32:54,340
it's IP is 1000 - okay you can see here

658
00:32:54,340 --> 00:32:57,499
let's perform some remote access to

659
00:32:57,499 --> 00:32:59,809
another machine in our domain in this

660
00:32:59,809 --> 00:33:04,609
case 1000 10 and we will do it by type

661
00:33:04,609 --> 00:33:08,119
II so you have until Annunciation ok

662
00:33:08,119 --> 00:33:09,830
we're successful academic education and

663
00:33:09,830 --> 00:33:13,749
access the SMB server on that machine

664
00:33:13,749 --> 00:33:17,690
and let's go back to our domain

665
00:33:17,690 --> 00:33:19,729
controller here you can see gentle an

666
00:33:19,729 --> 00:33:23,899
application the IP that delegate this

667
00:33:23,899 --> 00:33:26,929
application and as you can see here this

668
00:33:26,929 --> 00:33:29,479
data is encrypted so you can only see

669
00:33:29,479 --> 00:33:33,440
that the opcode 31:39 Morse code so

670
00:33:33,440 --> 00:33:43,190
let's use matches against 1000 10 the

671
00:33:43,190 --> 00:33:46,580
source ID server IP and as you can see

672
00:33:46,580 --> 00:33:51,979
here we have user 1 access from the 1000

673
00:33:51,979 --> 00:33:58,749
- which is the attacker issue ok

674
00:34:11,270 --> 00:34:14,129
okay so that was Nessus let's see how we

675
00:34:14,129 --> 00:34:17,099
can use the sam'l protocol which gives

676
00:34:17,099 --> 00:34:19,739
us the ability to query our local users

677
00:34:19,739 --> 00:34:22,859
and groups and first let's understand

678
00:34:22,859 --> 00:34:26,099
why local users is important are

679
00:34:26,099 --> 00:34:29,760
important for attackers mainly for one

680
00:34:29,760 --> 00:34:32,699
example we have a problem in many

681
00:34:32,699 --> 00:34:36,839
organizations that there are existing

682
00:34:36,839 --> 00:34:39,839
users on any machine local

683
00:34:39,839 --> 00:34:42,719
administrators the same identical

684
00:34:42,719 --> 00:34:46,020
password usually this is done by IT

685
00:34:46,020 --> 00:34:51,149
admins that install add their own user

686
00:34:51,149 --> 00:34:54,750
to the whole day domain machine and they

687
00:34:54,750 --> 00:34:56,940
give it literally the same name or the

688
00:34:56,940 --> 00:34:59,160
same strong password but once you have

689
00:34:59,160 --> 00:35:00,810
attackers that compromised

690
00:35:00,810 --> 00:35:03,089
one machine they can extract these

691
00:35:03,089 --> 00:35:05,790
credentials and use this use a local

692
00:35:05,790 --> 00:35:08,550
user to move laterally into another

693
00:35:08,550 --> 00:35:11,550
machine allowed me so we can see a

694
00:35:11,550 --> 00:35:14,609
report from Fotolia that this a lot of

695
00:35:14,609 --> 00:35:16,319
movement technique does the hash of

696
00:35:16,319 --> 00:35:20,369
local teen status was successful in 60%

697
00:35:20,369 --> 00:35:25,770
of the dentist another problem that the

698
00:35:25,770 --> 00:35:28,740
attackers use the local user for is

699
00:35:28,740 --> 00:35:31,220
persistency okay they add their own

700
00:35:31,220 --> 00:35:34,349
local administrator to the the

701
00:35:34,349 --> 00:35:37,020
compromised machine usually no one

702
00:35:37,020 --> 00:35:39,480
notice that in this case you can see

703
00:35:39,480 --> 00:35:44,460
that let the user admin name admin was

704
00:35:44,460 --> 00:35:46,589
added to the administrator group which

705
00:35:46,589 --> 00:35:49,200
gives those attackers and the ability to

706
00:35:49,200 --> 00:35:53,480
get back to this machine with this user

707
00:35:54,200 --> 00:35:56,280
service it since we are talking about

708
00:35:56,280 --> 00:35:59,819
the local users the authentication means

709
00:35:59,819 --> 00:36:02,460
locally okay so that's mean that it's a

710
00:36:02,460 --> 00:36:04,200
problem to us if we are monitoring the

711
00:36:04,200 --> 00:36:06,780
domain controller and traffic no traffic

712
00:36:06,780 --> 00:36:09,780
will be noticed or will be seen in this

713
00:36:09,780 --> 00:36:13,619
channel so our network security device

714
00:36:13,619 --> 00:36:17,819
can see it and again we have a solution

715
00:36:17,819 --> 00:36:19,140
for that

716
00:36:19,140 --> 00:36:21,420
this is what the summer queries fans

717
00:36:21,420 --> 00:36:24,569
inhale we travel we can theoretically

718
00:36:24,569 --> 00:36:27,450
clay local users over the summer

719
00:36:27,450 --> 00:36:29,819
protocol on any machine in our

720
00:36:29,819 --> 00:36:33,299
environment get user information get the

721
00:36:33,299 --> 00:36:36,109
group ownership and with that we can

722
00:36:36,109 --> 00:36:39,269
discover several detection which I will

723
00:36:39,269 --> 00:36:43,380
go into details soon enough but info

724
00:36:43,380 --> 00:36:45,569
title it's abnormal login patterns boot

725
00:36:45,569 --> 00:36:47,819
for the tenth privilege group for this

726
00:36:47,819 --> 00:36:50,460
occasion toss-up configuration issues as

727
00:36:50,460 --> 00:36:54,329
much more let's see exactly what I mean

728
00:36:54,329 --> 00:36:57,950
ok so it will quarry very a computer

729
00:36:57,950 --> 00:37:00,690
periodically and get and compare the

730
00:37:00,690 --> 00:37:03,749
last one time of a user with the

731
00:37:03,749 --> 00:37:06,839
previous time that we see this is a log

732
00:37:06,839 --> 00:37:10,069
log in you can see the Tamaki user logon

733
00:37:10,069 --> 00:37:13,140
the user never logged onto the scene and

734
00:37:13,140 --> 00:37:17,730
now we see that it did block one and you

735
00:37:17,730 --> 00:37:20,900
can detect that and alert on this and

736
00:37:20,900 --> 00:37:23,009
another thing that can be easily

737
00:37:23,009 --> 00:37:25,920
detected is the brute force attempt in

738
00:37:25,920 --> 00:37:28,170
this case we can see the bad path of

739
00:37:28,170 --> 00:37:30,539
count property again with the same

740
00:37:30,539 --> 00:37:33,960
technique it was zero before and now

741
00:37:33,960 --> 00:37:36,420
several thousand of say let that passes

742
00:37:36,420 --> 00:37:42,150
on easy to detect a brute force and the

743
00:37:42,150 --> 00:37:45,119
ethical path of the detection is also

744
00:37:45,119 --> 00:37:48,569
something that is quite easy to detect

745
00:37:48,569 --> 00:37:52,589
because if we have a duplication of a

746
00:37:52,589 --> 00:37:56,400
hard life and all machines or export of

747
00:37:56,400 --> 00:37:58,559
the ends you can see that the same

748
00:37:58,559 --> 00:38:00,989
easily on different machines and with

749
00:38:00,989 --> 00:38:04,410
the same path of last set which is 64

750
00:38:04,410 --> 00:38:08,670
bits may tighten that will trigger and a

751
00:38:08,670 --> 00:38:12,749
detection of duplication which can be

752
00:38:12,749 --> 00:38:16,950
abused or exploited by attackers when

753
00:38:16,950 --> 00:38:19,489
the last thing that we can detect is the

754
00:38:19,489 --> 00:38:22,019
addition to the administrative group or

755
00:38:22,019 --> 00:38:23,999
any other group privilege group in this

756
00:38:23,999 --> 00:38:27,089
case we monitored a machine at a one

757
00:38:27,089 --> 00:38:30,839
time and and and the next day detection

758
00:38:30,839 --> 00:38:32,500
of the next time we saw

759
00:38:32,500 --> 00:38:35,460
delicious ezel was added to the group

760
00:38:35,460 --> 00:38:38,260
two-dimensional group so you have a new

761
00:38:38,260 --> 00:38:44,349
detection thank you so Thank You ty for

762
00:38:44,349 --> 00:38:46,330
providing the optimistic part of this

763
00:38:46,330 --> 00:38:49,750
talk I try not to ruin it with the last

764
00:38:49,750 --> 00:38:54,849
say three minutes okay so you might have

765
00:38:54,849 --> 00:38:59,440
asked yourself okay II we had presented

766
00:38:59,440 --> 00:39:01,780
something about do Rotom Bob boxing so

767
00:39:01,780 --> 00:39:04,510
what defender should do what should they

768
00:39:04,510 --> 00:39:06,550
choose so they choose to be boxers and

769
00:39:06,550 --> 00:39:10,240
block or enabled these all these API and

770
00:39:10,240 --> 00:39:14,859
use them and we say why not both you can

771
00:39:14,859 --> 00:39:17,920
actually in this case have your cake and

772
00:39:17,920 --> 00:39:21,310
eat it at the same time so for example

773
00:39:21,310 --> 00:39:24,970
for reconnaissance api's so as it I had

774
00:39:24,970 --> 00:39:27,640
shown there are ways to harden them and

775
00:39:27,640 --> 00:39:31,300
limit the access to this API and indeed

776
00:39:31,300 --> 00:39:34,540
why should any users all users have

777
00:39:34,540 --> 00:39:38,260
access to it but we can still live a few

778
00:39:38,260 --> 00:39:41,230
user or one specific user that is able

779
00:39:41,230 --> 00:39:43,980
to do just that and equip the hour a

780
00:39:43,980 --> 00:39:47,560
monitoring system with the permission so

781
00:39:47,560 --> 00:39:50,650
we we still get to use it for judo

782
00:39:50,650 --> 00:39:52,990
using that against the attackers but the

783
00:39:52,990 --> 00:39:56,770
attackers have really a slim chance of

784
00:39:56,770 --> 00:39:59,700
landing on that specific user and

785
00:39:59,700 --> 00:40:05,560
abusing it and we can still keep our

786
00:40:05,560 --> 00:40:08,650
detection open it's not like okay we

787
00:40:08,650 --> 00:40:10,540
block that so attacker wouldn't use it

788
00:40:10,540 --> 00:40:13,000
now we just need to tweak our detection

789
00:40:13,000 --> 00:40:16,060
algorithm and detect also excels at them

790
00:40:16,060 --> 00:40:17,980
so in this case I felt the attempt to

791
00:40:17,980 --> 00:40:21,490
retrieve next session information will

792
00:40:21,490 --> 00:40:24,190
detect an alert in Microsoft a DEA or

793
00:40:24,190 --> 00:40:27,790
any other solution and the second

794
00:40:27,790 --> 00:40:31,810
question that you might have is well you

795
00:40:31,810 --> 00:40:34,320
showed us quite a few nice things

796
00:40:34,320 --> 00:40:37,810
hopefully you think it's nothing and but

797
00:40:37,810 --> 00:40:40,390
is it really general or is it just

798
00:40:40,390 --> 00:40:44,380
something that you happen to find so and

799
00:40:44,380 --> 00:40:46,240
we're showing just

800
00:40:46,240 --> 00:40:48,400
two sinks and telematic Asian visibility

801
00:40:48,400 --> 00:40:51,760
with net session Nets s recognizes a

802
00:40:51,760 --> 00:40:54,900
local user visibility with summer

803
00:40:54,900 --> 00:40:58,540
reconnaissance but we still have some

804
00:40:58,540 --> 00:41:01,000
topics that we didn't discuss and

805
00:41:01,000 --> 00:41:04,180
because there isn't enough time and we

806
00:41:04,180 --> 00:41:06,070
have all times due to differences for

807
00:41:06,070 --> 00:41:09,790
example a cover defenses a defensive

808
00:41:09,790 --> 00:41:12,550
error injection attackers may use curved

809
00:41:12,550 --> 00:41:14,320
arrows error injection in order to

810
00:41:14,320 --> 00:41:16,420
trigger malicious password change or

811
00:41:16,420 --> 00:41:18,670
encryption downgrade and in fact there

812
00:41:18,670 --> 00:41:22,570
is I saw in in Blackett today Tom Gillis

813
00:41:22,570 --> 00:41:25,540
and the bill document from a dimension

814
00:41:25,540 --> 00:41:27,760
data Belgium if you see them they know a

815
00:41:27,760 --> 00:41:31,300
lot about the triggering vulnerabilities

816
00:41:31,300 --> 00:41:35,800
with a offensive error injection but we

817
00:41:35,800 --> 00:41:38,080
learned that we can use it for defense

818
00:41:38,080 --> 00:41:41,170
for example and this is an elegant way

819
00:41:41,170 --> 00:41:45,280
to block authentication and request that

820
00:41:45,280 --> 00:41:48,130
we feel that is suspicious and prompted

821
00:41:48,130 --> 00:41:51,850
the user to explicitly enter a password

822
00:41:51,850 --> 00:41:55,840
so if the attacker only knows a hash it

823
00:41:55,840 --> 00:41:59,770
would be an elegant elegant way and to

824
00:41:59,770 --> 00:42:03,490
block it and if we are wrong and this is

825
00:42:03,490 --> 00:42:06,520
a regular user then okay it's a bit of a

826
00:42:06,520 --> 00:42:10,510
hassle but we can input a they can input

827
00:42:10,510 --> 00:42:12,550
their password and move on so this is

828
00:42:12,550 --> 00:42:16,570
another judo defense or another place we

829
00:42:16,570 --> 00:42:18,730
can implement it is to do brute force on

830
00:42:18,730 --> 00:42:21,910
brute force if we see a certain a sudden

831
00:42:21,910 --> 00:42:26,320
surge in authentication requests and but

832
00:42:26,320 --> 00:42:28,210
we don't know if it's something normal

833
00:42:28,210 --> 00:42:30,400
or this this brute force and of course

834
00:42:30,400 --> 00:42:33,580
the password themselves are encrypted so

835
00:42:33,580 --> 00:42:36,400
can see that different password or at

836
00:42:36,400 --> 00:42:38,710
the same path of being repeated due to

837
00:42:38,710 --> 00:42:42,609
some error so we can do all kind of

838
00:42:42,609 --> 00:42:44,260
brute force on brute force in order to

839
00:42:44,260 --> 00:42:46,420
find out if it's really brute force or

840
00:42:46,420 --> 00:42:49,660
just some technical problem and we have

841
00:42:49,660 --> 00:42:52,300
quite a few of them so we feel like it's

842
00:42:52,300 --> 00:42:56,980
quite general and and what it really

843
00:42:56,980 --> 00:42:59,170
tells us and you can adapt it when we

844
00:42:59,170 --> 00:42:59,559
record

845
00:42:59,559 --> 00:43:02,890
that you adopted attitude is whenever we

846
00:43:02,890 --> 00:43:06,459
research a new attacker tactic so we're

847
00:43:06,459 --> 00:43:09,239
not just focused on understanding it and

848
00:43:09,239 --> 00:43:12,219
detecting preventing it we also always

849
00:43:12,219 --> 00:43:14,469
keep in the back of our mind we think is

850
00:43:14,469 --> 00:43:17,140
there a possibility can we do something

851
00:43:17,140 --> 00:43:20,109
be sensitively and use that ability and

852
00:43:20,109 --> 00:43:22,359
I think this is a good attitude to take

853
00:43:22,359 --> 00:43:28,209
in all areas of security so let's

854
00:43:28,209 --> 00:43:31,469
conclude what was new in this talk

855
00:43:31,469 --> 00:43:33,219
presented the lateral movement

856
00:43:33,219 --> 00:43:37,180
automation module go fetch in fact of

857
00:43:37,180 --> 00:43:40,900
where Thomas just uploaded the video to

858
00:43:40,900 --> 00:43:43,900
YouTube so you can check it out use the

859
00:43:43,900 --> 00:43:46,989
time to tweet it on the side and so

860
00:43:46,989 --> 00:43:50,170
check his or mine account and boxer

861
00:43:50,170 --> 00:43:54,699
defenses and we shown two ways to detect

862
00:43:54,699 --> 00:43:57,219
some our reconnaissance and meta

863
00:43:57,219 --> 00:43:59,019
reconnaissance from network traffic and

864
00:43:59,019 --> 00:44:02,410
to harden them to enable only specific

865
00:44:02,410 --> 00:44:07,269
user 3 and we had presented to do the

866
00:44:07,269 --> 00:44:09,579
defenses using the attackers strengths

867
00:44:09,579 --> 00:44:11,949
and capabilities against them local user

868
00:44:11,949 --> 00:44:14,499
visibility that is games via some are

869
00:44:14,499 --> 00:44:16,269
reconnaissance and entering lament

870
00:44:16,269 --> 00:44:18,519
education visibility with the Nets s

871
00:44:18,519 --> 00:44:23,890
tool for reconnaissance so if we need to

872
00:44:23,890 --> 00:44:26,650
conclude this talking just one sentence

873
00:44:26,650 --> 00:44:28,839
in order to defeat the enemy if you're

874
00:44:28,839 --> 00:44:31,660
ready to learn the enemy and then you

875
00:44:31,660 --> 00:44:35,229
know the enemy but finally you can beat

876
00:44:35,229 --> 00:44:37,539
the enemy against that enemy and

877
00:44:37,539 --> 00:44:39,939
defeated use their own strength

878
00:44:39,939 --> 00:44:42,339
strengths and capabilities against them

879
00:44:42,339 --> 00:44:45,249
final slide credits and sank so though

880
00:44:45,249 --> 00:44:48,130
our reviewer MD here the so our

881
00:44:48,130 --> 00:44:50,439
presentation gives some insightful

882
00:44:50,439 --> 00:44:53,170
remarks Microsoft ata researchers that

883
00:44:53,170 --> 00:44:55,689
are not here today tomorrow Melina Shima

884
00:44:55,689 --> 00:44:59,349
Cove and kymo and finally last but not

885
00:44:59,349 --> 00:45:01,959
least a Microsoft API designer and

886
00:45:01,959 --> 00:45:04,359
designed all kind of cool graphic things

887
00:45:04,359 --> 00:45:06,880
for this presentation specifically they

888
00:45:06,880 --> 00:45:09,670
go fetch a logo and thank you all for

889
00:45:09,670 --> 00:45:12,810
you for coming here today so thanks

890
00:45:12,810 --> 00:45:16,199
[Applause]

