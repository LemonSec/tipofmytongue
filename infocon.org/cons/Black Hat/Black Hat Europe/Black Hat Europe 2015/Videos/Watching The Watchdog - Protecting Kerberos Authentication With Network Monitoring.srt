1
00:00:00,000 --> 00:00:04,640
thank you very much for coming here
today for our talk watching the watchdog

2
00:00:04,640 --> 00:00:12,790
protecting hair bows with network
monitoring my name is Todd berry and my

3
00:00:12,790 --> 00:00:17,340
colleague areas Michael Cherney will
both work for Microsoft work on the

4
00:00:17,340 --> 00:00:23,198
research team of the Microsoft about the
threat analytics product that analyzes

5
00:00:23,199 --> 00:00:30,119
attackers movement over the network and
how many of you have been here for the

6
00:00:30,119 --> 00:00:36,190
keynote please raise hand if you will
hear so many of you have great so I hope

7
00:00:36,190 --> 00:00:43,660
this presentation will be in the
standard speaker Arun suggested for

8
00:00:43,660 --> 00:00:53,399
security talks which means hopefully we
will be able to give you something to

9
00:00:53,399 --> 00:00:58,440
work on it to convince you that we are
working on a tangible problem a problem

10
00:00:58,440 --> 00:01:06,770
which is concrete and happens in real
life and will take a deeper look into

11
00:01:06,770 --> 00:01:13,259
the Kerberos protocol and a new breed of
attacks against it and also send you a

12
00:01:13,260 --> 00:01:21,630
text that we will expose but also come
with solutions of network monitoring we

13
00:01:21,630 --> 00:01:28,798
will also release it all that you can
try when you get back to your homes in

14
00:01:28,799 --> 00:01:35,540
your internal networks so what are we
going to talk about today we'll start

15
00:01:35,540 --> 00:01:40,880
with discussing that I can motivation
why is this

16
00:01:40,880 --> 00:01:47,070
problem of attacks against cameras even
better we'll talk about the details of

17
00:01:47,070 --> 00:01:53,059
the Kerberos authentication and Kerberos
protocol and we'll talk about new

18
00:01:53,060 --> 00:01:59,439
attackers paradigm of switching from
stealing attacks to forgery attacks and

19
00:01:59,439 --> 00:02:04,619
what the Tigers it is by then we'll talk
a little bit about what it means to do

20
00:02:04,619 --> 00:02:08,780
not talk monitoring of the Kerberos
protocol in this is in the introduction

21
00:02:08,780 --> 00:02:15,519
then we'll take the really deep dive
into four different attacks and finally

22
00:02:15,519 --> 00:02:23,269
we will have will rip it up with some
what we think action actionable

23
00:02:23,269 --> 00:02:29,840
recommendations and a new tool that we
are releasing it let's start with the

24
00:02:29,840 --> 00:02:30,310
start

25
00:02:30,310 --> 00:02:40,160
why do attackers attack the Kerberos
protocol because attackers need axis it

26
00:02:40,160 --> 00:02:47,400
usually infects one mission within your
network but its run them arbitrary

27
00:02:47,400 --> 00:02:55,069
machine it's not it's not where did they
want to get to reside so they need to

28
00:02:55,069 --> 00:03:01,260
travel through your network out till
they reach their destination and to do

29
00:03:01,260 --> 00:03:06,920
that they need axis and access requires
both authentication which means very

30
00:03:06,920 --> 00:03:12,548
frank the user identity and
authorization they need you there with

31
00:03:12,549 --> 00:03:19,670
just enough to do what they need to
access the doctor they want and South

32
00:03:19,670 --> 00:03:23,458
Cariboo rose is the default
authentication and authorization

33
00:03:23,459 --> 00:03:28,910
protocol of the windows networks it
means attacker must attack the Kerberos

34
00:03:28,910 --> 00:03:34,200
protocol in order to get the axis the
desperately needs so they have no choice

35
00:03:34,200 --> 00:03:40,369
to have to attack or at least abused
their cameras protocol and

36
00:03:40,370 --> 00:03:46,860
here is a quick review of the Kerberos
protocol of the indication and

37
00:03:46,860 --> 00:03:52,250
authorization so what happens on a
Windows machine when you input your

38
00:03:52,250 --> 00:03:58,340
password so let's end this graphics are
buying momentum in the day of the rough

39
00:03:58,340 --> 00:04:02,920
air when the user inputs

40
00:04:02,920 --> 00:04:08,609
his passport that say was I want to
three forms / then tells us

41
00:04:08,610 --> 00:04:16,510
process within the computer derives keys
from the password encryption keys that

42
00:04:16,510 --> 00:04:25,139
are derived from this specific password
then it's an ass request request

43
00:04:25,139 --> 00:04:32,729
authentication service from the KBC KBC
is the Kerberos server and I will use

44
00:04:32,729 --> 00:04:37,849
call it KDC or ADC for the main
controller or Active Directory but

45
00:04:37,850 --> 00:04:44,630
anytime I stayed it it means the same to
Kerberos server so they use their sense

46
00:04:44,630 --> 00:04:50,000
something encrypted with the kid that
they are from the password on stage one

47
00:04:50,000 --> 00:04:57,419
with its request the KDC price to
decrypt it with the user's a key because

48
00:04:57,419 --> 00:05:03,289
the disease has all the keys if they are
successful if the server is successful

49
00:05:03,289 --> 00:05:10,039
and decrypting it it returns a TGT
ticket granting ticket to make to the

50
00:05:10,039 --> 00:05:17,110
user and from there from that point
onwards the user does not have to retain

51
00:05:17,110 --> 00:05:23,630
put their passwords they use that ticket
to request specific access to the

52
00:05:23,630 --> 00:05:28,370
servers that do the services they want
say they want to access a file server

53
00:05:28,370 --> 00:05:36,099
then they present the TGT in step three
is this again to the DAC and ADC

54
00:05:36,099 --> 00:05:37,240
looks at the

55
00:05:37,240 --> 00:05:46,889
TGT and derives radovan TGS a service
ticket which is specific to the resource

56
00:05:46,889 --> 00:05:56,669
the user want to use and will go into
deeper details in the coming sluts let

57
00:05:56,669 --> 00:06:03,940
repeat again on the process what happens
in the most pro-clinton user input

58
00:06:03,940 --> 00:06:10,840
credential though the user input their
credential right there and a key is

59
00:06:10,840 --> 00:06:18,880
derived and this kid is used to lock a
box or in reality to encrypt a timestamp

60
00:06:18,880 --> 00:06:24,039
that lockbox is coming to the Dec

61
00:06:24,039 --> 00:06:27,340
to do this triangle the Dec

62
00:06:27,340 --> 00:06:33,080
try to open it with the key of the user
and if it's successful then he put in

63
00:06:33,080 --> 00:06:38,889
the same box which means it creates with
the same key the ticket and this ticket

64
00:06:38,889 --> 00:06:45,750
this digiti comes back to the user so
they are very obvious attacks against

65
00:06:45,750 --> 00:06:55,130
the scheme and its killing at X attacker
which is based on the endpoint can still

66
00:06:55,130 --> 00:07:02,240
other credentials the key or the ticket
the comes in the end of it and there are

67
00:07:02,240 --> 00:07:03,680
specific names

68
00:07:03,680 --> 00:07:12,759
instilling overpass too harsh for a kiss
tilling and tickets is calling passing

69
00:07:12,759 --> 00:07:17,460
the ticket so it's very obvious you can
still any of these ingredients and

70
00:07:17,460 --> 00:07:19,529
disguise yourself as

71
00:07:19,529 --> 00:07:27,579
user that identity stolen but still it
will only take the attacker so far

72
00:07:27,579 --> 00:07:34,109
because you can still and doctors can
still on in what is present you cannot

73
00:07:34,109 --> 00:07:40,989
still up his he's in there and therefore
the head to wait for the right user the

74
00:07:40,989 --> 00:07:46,279
user with enough privileges the user
which is less morning for them so on so

75
00:07:46,279 --> 00:07:52,189
forth and they have to wait but we think
it's boring and time is money from the

76
00:07:52,189 --> 00:07:58,559
attackers perspective don't want to wait
with their operation of deal some of the

77
00:07:58,559 --> 00:08:06,959
ministry there were a lot of sin into
the machine they control and and

78
00:08:06,959 --> 00:08:12,999
stealing things he's tokens are
unpredictable unreliable in some sense

79
00:08:12,999 --> 00:08:18,159
because they can expire tickets go bus
ticket expires and usually after 10

80
00:08:18,159 --> 00:08:24,319
hours but was in kids can change so
attacker don't want to start their

81
00:08:24,319 --> 00:08:27,009
campaign and in the middle

82
00:08:27,009 --> 00:08:32,610
understand that their password then
access is no longer valid and go back to

83
00:08:32,610 --> 00:08:39,070
square one and for some scenarios
basically there is no mister right there

84
00:08:39,070 --> 00:08:40,760
isn't right

85
00:08:40,760 --> 00:08:46,760
a user does not exist for example if it
doctor wants you would administrative

86
00:08:46,760 --> 00:08:54,600
privileges so they can access everything
but yet did that the disused won't be

87
00:08:54,600 --> 00:09:00,540
listed as an administrator so it
wouldn't be monitored by some some

88
00:09:00,540 --> 00:09:08,630
monitoring tools then there isn't such
so you cannot still it but if you use if

89
00:09:08,630 --> 00:09:15,290
attackers uses forgery and forging the
relevant camera's broken and they are

90
00:09:15,290 --> 00:09:20,810
fiddling with the protocol they can get
in on the amount privilege and axis as

91
00:09:20,810 --> 00:09:24,579
they want so they move on

92
00:09:24,579 --> 00:09:29,959
attackers from Ford from stealing to
forgery and we will talk about for

93
00:09:29,959 --> 00:09:35,290
specific attacks the forge keep the
skeleton key

94
00:09:35,290 --> 00:09:45,069
forges the golden ticket and two variant
of forge park and will spot in 1468 and

95
00:09:45,069 --> 00:09:52,719
the new attack we developed the diamond
pack and just before and we've gone to

96
00:09:52,720 --> 00:09:59,610
the specifics of this attack we said
that everything can be protected and

97
00:09:59,610 --> 00:10:07,690
detected using network monitoring what
do we mean by that women that all of

98
00:10:07,690 --> 00:10:12,579
these devices every device that wants to
access resources within the network must

99
00:10:12,579 --> 00:10:21,949
speak with the Active Directory so
regardless of the operating system this

100
00:10:21,949 --> 00:10:29,660
could be an iOS Windows or Linux and
this protocol messages are flowing

101
00:10:29,660 --> 00:10:33,920
through the Active Directory and
security divided passively money force

102
00:10:33,920 --> 00:10:38,959
that traffic just bought more mirroring
on the switch in front

103
00:10:38,960 --> 00:10:46,860
the Active Directory the Kerberos server
will show that it is enough to mitigate

104
00:10:46,860 --> 00:10:52,280
and detect all of this attack and very
importantly without knowing any of the

105
00:10:52,280 --> 00:10:57,910
Active Directory secrets this device
does not need to know any of the

106
00:10:57,910 --> 00:11:02,510
passwords within the domain with that
let's start with the first attack the

107
00:11:02,510 --> 00:11:10,610
skeleton key michael kors think it'll so
let's talk about skeletal what the

108
00:11:10,610 --> 00:11:18,080
skeletal is actually lower attackers
installing malware on Dec

109
00:11:18,080 --> 00:11:24,440
to be able to indicate any user by using
one unique secret password

110
00:11:24,440 --> 00:11:33,040
the result is it ok now log on to any
workstation or server either via

111
00:11:33,040 --> 00:11:39,579
terminal all over the network using the
single use secret possible but don't you

112
00:11:39,580 --> 00:11:43,230
look so user experience is not hamper
consider it still looks and feels the

113
00:11:43,230 --> 00:11:48,270
same so let's just experienced a them
see how this looks like let's

114
00:11:48,270 --> 00:11:59,439
administrator admin 123 and secret
password is configured to be possible so

115
00:11:59,440 --> 00:12:06,830
now administrator approach to the study
research assistant station and blogs in

116
00:12:06,830 --> 00:12:13,890
just like a child and then by mistake
enters the Prague Castle and again just

117
00:12:13,890 --> 00:12:20,560
as she should he or she is the failure
but now not a car enters his secret

118
00:12:20,560 --> 00:12:28,140
possible he also likes it all again so

119
00:12:28,140 --> 00:12:32,600
after the skeleton key malware was work
was published by Dell SecureWorks

120
00:12:32,600 --> 00:12:41,150
Benjamin therapy also added support too
many cuts for the skeleton key now its

121
00:12:41,150 --> 00:12:49,709
products for all everybody can't right
now let's see how this works

122
00:12:49,710 --> 00:12:54,810
first let's focus on the fact that the
camera supports multiple contacts from

123
00:12:54,810 --> 00:12:58,020
work includes client and server

124
00:12:58,020 --> 00:13:05,079
need to negotiate to know which of the
chance to be to use English Asian

125
00:13:05,080 --> 00:13:11,490
happens user a decline machine and also
his username and password and decline

126
00:13:11,490 --> 00:13:16,300
since the client machine sense to the
comment on what i doin group that what

127
00:13:16,300 --> 00:13:23,430
is part of a group of guys from his
perspective the momentum prior thanks

128
00:13:23,430 --> 00:13:32,270
Jason concert with what it can and what
the keys type of keys this user have

129
00:13:32,270 --> 00:13:39,010
directory database so in this case it
has our C for engineers keys so it will

130
00:13:39,010 --> 00:13:41,730
respond ok well I can talk if you are

131
00:13:41,730 --> 00:13:50,970
see four or A S declined to hopefully
will choose the more secure on russia's

132
00:13:50,970 --> 00:13:57,070
from the user passwords accordingly and
creeped the timestamp intended to the

133
00:13:57,070 --> 00:14:02,960
car will try to decrypt it to the
recording key type of that User

134
00:14:02,960 --> 00:14:06,670
even description is successful it will
send back they take advantage of the

135
00:14:06,670 --> 00:14:14,479
dignity and how it looks over the wire
from the perspective client sends all

136
00:14:14,480 --> 00:14:20,690
day encryption types it supports the
answer as to what it can do it and

137
00:14:20,690 --> 00:14:24,610
actually far and declined response

138
00:14:24,610 --> 00:14:30,779
time camping trip to the US now what is
different between us and our see foreign

139
00:14:30,779 --> 00:14:32,110
how it's red at all

140
00:14:32,110 --> 00:14:39,399
a smaller we said that client sends the
time thinking group that we should

141
00:14:39,399 --> 00:14:46,010
deliver two of the user's password so
even if that time is termed a tiger

142
00:14:46,010 --> 00:14:50,510
would attempt a brute-force attack to
make those books for socks demand

143
00:14:50,510 --> 00:14:55,540
difficult most well-known the technicals
12 salting it's a goal that for two

144
00:14:55,540 --> 00:15:00,480
different users even if their password
is the same the key to harsh would be

145
00:15:00,480 --> 00:15:02,190
different

146
00:15:02,190 --> 00:15:06,380
it's done by pending assault string to
the password while they're driving the

147
00:15:06,380 --> 00:15:13,000
crash here since using the user name as
a salt making the unique for each user

148
00:15:13,000 --> 00:15:18,620
I'll see for on the other hand doesn't
use any assaulting another terrific you

149
00:15:18,620 --> 00:15:26,149
is stretching its goal is to increase
the amount of CPU required to check

150
00:15:26,149 --> 00:15:32,339
where a single pass on this correct one
or not drawing them a small force attack

151
00:15:32,339 --> 00:15:34,529
infeasible

152
00:15:34,529 --> 00:15:39,300
PBK Jeff to standard which is possible
waste generation function to standard

153
00:15:39,300 --> 00:15:44,769
which is basically performance thousands
of rounds in case of Windows 8 around

154
00:15:44,769 --> 00:15:51,380
lady hold policy for again doesn't do
any distortion house armed robber talk

155
00:15:51,380 --> 00:15:57,660
to their tacos are talking as in this
case the lava c4 why because due to salt

156
00:15:57,660 --> 00:16:02,399
in identical possible would create
different a ski for different users and

157
00:16:02,399 --> 00:16:07,839
verify that one unique password which
secret possible attackers consider we

158
00:16:07,839 --> 00:16:12,620
would have to either calculated for each
user authentication in real-time which

159
00:16:12,620 --> 00:16:14,540
will do a lot of CBO

160
00:16:14,540 --> 00:16:19,529
critical critical collected and stored
in memory would require a lot of memory

161
00:16:19,529 --> 00:16:26,579
what I can do in this case we just cause
chemical down with marcia for and how

162
00:16:26,579 --> 00:16:31,599
they do it I said the developers call
what it does actually better as a memory

163
00:16:31,600 --> 00:16:34,640
card of the main controller one function

164
00:16:34,640 --> 00:16:40,260
which is at pages in the function which
checks where the user have what it's

165
00:16:40,260 --> 00:16:44,210
called campus and your keys which is
basically a skis and a donut false

166
00:16:44,210 --> 00:16:50,340
careful driving the skis practically
non-existent and no one is to create

167
00:16:50,340 --> 00:16:55,300
function different function is a
function which tries to decrypt their

168
00:16:55,300 --> 00:17:01,479
time to time and therefore check whether
the user is what he claims he he's

169
00:17:01,480 --> 00:17:05,260
inspection away so that the original

170
00:17:05,260 --> 00:17:13,129
decrypt its original function and if it
fails it calls it again with harsh of

171
00:17:13,130 --> 00:17:20,370
the secret so even if possible even
enter the password correct it will still

172
00:17:20,369 --> 00:17:24,750
it will work as expected to indicate
that the secret password will be in

173
00:17:24,750 --> 00:17:28,569
touch again it will be indicated if it's
neither of them are wrong but it will

174
00:17:28,569 --> 00:17:43,939
sell it looks like he's instructed to
scale them all over this means that

175
00:17:43,940 --> 00:17:51,370
practically always actively each user
now have to see for DS one gentleman

176
00:17:51,370 --> 00:17:56,949
which is doable features on bus 101 is
the debate about the skeleton key on

177
00:17:56,950 --> 00:18:02,110
Flickr password and love affair a schism
are not accessible they practically did

178
00:18:02,110 --> 00:18:05,570
not do not exist so now when the user
enters day

179
00:18:05,570 --> 00:18:11,780
skeleton post-world client is not
affected was very important or from here

180
00:18:11,780 --> 00:18:15,800
the line is not affect the baby small
road smaller only exist on demand on the

181
00:18:15,800 --> 00:18:21,690
door but the man crew now looks and says
I'd only have enough seats for key for

182
00:18:21,690 --> 00:18:22,730
this user

183
00:18:22,730 --> 00:18:28,780
sold only one I support now he's done
before and client will call candidacy

184
00:18:28,780 --> 00:18:38,680
for harsh encrypt the times in 256 for
the car will check that is correct

185
00:18:38,680 --> 00:18:46,170
against the skeleton key and then back
to the client and so this is how it

186
00:18:46,170 --> 00:18:56,000
works just how it looks over the where
missus before the car was intersected

187
00:18:56,000 --> 00:19:00,870
with the skeleton key client sends all
the encryption types are as the

188
00:19:00,870 --> 00:19:07,790
responses all them and the client sends
at the time that conclusively a/s after

189
00:19:07,790 --> 00:19:13,220
it was in Sector Plan as we said is not
affected so it's just the same old

190
00:19:13,220 --> 00:19:17,150
increase the tax on those different
types it supports but now that among the

191
00:19:17,150 --> 00:19:22,080
proper response only with 564 and
therefore client will also include the

192
00:19:22,080 --> 00:19:30,949
times in 244 ascended big dog blanket or
so how can we detected we said that the

193
00:19:30,950 --> 00:19:33,080
essence of this game tomorrow

194
00:19:33,080 --> 00:19:39,290
great to are so far so therefore we can
detected behavior because it's also

195
00:19:39,290 --> 00:19:45,510
manifest itself over the network we
cannot get the user should be offered a

196
00:19:45,510 --> 00:19:50,270
of my decide how because I'd always
showing a possible in the loan that Dec

197
00:19:50,270 --> 00:19:55,760
24 was offering yesterday in a previous
taxes on by judge in bed the mental

198
00:19:55,760 --> 00:20:02,600
function level and the user communities
so if you should be over before white on

199
00:20:02,600 --> 00:20:09,340
the outside for now they're microsoft
plans for economic point of the door and

200
00:20:09,340 --> 00:20:12,679
detected on with activity because the
screenshot of the leptin levels on it

201
00:20:12,680 --> 00:20:14,080
saying his problem

202
00:20:14,080 --> 00:20:25,519
skeletal also wrote the script which can
actively the check is in fact it is the

203
00:20:25,519 --> 00:20:31,760
link here to download a movie script and
pride in this screenshot is asking too

204
00:20:31,760 --> 00:20:38,320
many cuts which in fact that I meant to
turn we've skeleton key and the script

205
00:20:38,320 --> 00:20:44,370
to escape which runs and detects but
this did in fact it now we're down to

206
00:20:44,370 --> 00:20:55,239
the time to talk about golden ticket and
remember remind herself again what its

207
00:20:55,240 --> 00:20:59,659
cameras and we only talked with said the
cameras into default authentication and

208
00:20:59,659 --> 00:21:03,860
authorization protocol but we only
talked about authentication which means

209
00:21:03,860 --> 00:21:07,850
of verifying the identity of the user
within speak about the authorization at

210
00:21:07,850 --> 00:21:16,699
though which means how do you see a sign
is provided to the user so let's do that

211
00:21:16,700 --> 00:21:24,039
and when those networks and
authorization isreali then implemented

212
00:21:24,039 --> 00:21:29,539
with a pack privilege attribute
certificate which hold that although

213
00:21:29,539 --> 00:21:35,320
authorization that are you can see here
which means basically all the groups you

214
00:21:35,320 --> 00:21:41,950
are a member with this user
administrator there is member of the man

215
00:21:41,950 --> 00:21:49,769
I mean enterprising means and means and
so on and so forth and if you can sync

216
00:21:49,769 --> 00:21:53,789
their brick-and-mortar I'm not a d4

217
00:21:53,789 --> 00:22:00,629
authentication authorization ID card so
they're your picture and name is your

218
00:22:00,629 --> 00:22:06,949
authentication and authorization is the
party said what you are allowed to do

219
00:22:06,950 --> 00:22:12,269
with this car maybe to drive some
vehicle or enter some place so this is

220
00:22:12,269 --> 00:22:19,460
an indication of disorientation and the
pocket not only contain the not only

221
00:22:19,460 --> 00:22:24,429
contains groups but also has some
security measures within it

222
00:22:24,429 --> 00:22:34,119
of signatures and we'll talk about that
so how is the pack go

223
00:22:34,119 --> 00:22:40,149
enters the game of cameras so when the
user authenticate to the DEC and

224
00:22:40,149 --> 00:22:47,289
assuming that the key was indeed the
right one calculates this park which

225
00:22:47,289 --> 00:22:53,809
again this is all the group that the
user is member in and sent it along with

226
00:22:53,809 --> 00:22:59,920
the TGT embedded within then when

227
00:22:59,920 --> 00:23:07,670
the user request access to specific
resource that part is being copied from

228
00:23:07,670 --> 00:23:13,330
the tragedy into the service ticket and
that's the way that authorization is

229
00:23:13,330 --> 00:23:20,990
implemented in Windows with Kerberos
protocol a quick words and reminder of

230
00:23:20,990 --> 00:23:27,520
what is digital signature specifically H
mark this is the Wikipedia definition

231
00:23:27,520 --> 00:23:32,590
message authentication code mark a show
piece of information used to

232
00:23:32,590 --> 00:23:37,550
authenticate the message and its market
just crashed marky mark that uses a

233
00:23:37,550 --> 00:23:43,669
harsh and we'll continue this diagram
again from Wikipedia that greet them the

234
00:23:43,670 --> 00:23:48,560
house month onwards I'm takes a key and
some calculation with the message and

235
00:23:48,560 --> 00:23:56,629
the key and the receiver which has also
has the key can verify that indeed this

236
00:23:56,630 --> 00:23:59,400
message has not been tampered with

237
00:23:59,400 --> 00:24:05,050
because their signatures remained the
same so this is the basic digital

238
00:24:05,050 --> 00:24:14,950
signature and so what promised that the
TGT is in the is indeed and tart and its

239
00:24:14,950 --> 00:24:23,150
integrity is not has now problems so
picketed integrity is guaranteed by the

240
00:24:23,150 --> 00:24:30,010
fact that the ticket itself is encrypted
and it's encrypted with the curb TGT key

241
00:24:30,010 --> 00:24:36,120
DDT is the internal Kerberos account and
therefore since this is encrypted

242
00:24:36,120 --> 00:24:40,790
attacker cannot simply edit the TGT
because they don't know the captivity

243
00:24:40,790 --> 00:24:47,010
and on top of that the package integrity
itself even though that is embedded

244
00:24:47,010 --> 00:24:55,120
within the camera within the TGT or a
service ticket itself and as a result

245
00:24:55,120 --> 00:25:03,739
it's incredible to it also being signed
twice by the curb TGT as you can see in

246
00:25:03,740 --> 00:25:04,900
the bottom of the

247
00:25:04,900 --> 00:25:12,550
of the pocket illustration there are two
signatures of the server on it again

248
00:25:12,550 --> 00:25:19,300
using the captivity key as we can see
the curb TGT key here is a single point

249
00:25:19,300 --> 00:25:26,060
of failure everything depended on it so
if the attackers are able to obtain the

250
00:25:26,060 --> 00:25:30,810
captivity key then they create can
create the famous or the notorious

251
00:25:30,810 --> 00:25:38,270
golden ticket which mean if they still
the captivity key from Active Directory

252
00:25:38,270 --> 00:25:44,810
they can create arbitrary tickets and
again this was implemented in many cuts

253
00:25:44,810 --> 00:25:51,590
in budget cuts and they like this quote
a golden ticket is a homemade pick it

254
00:25:51,590 --> 00:25:59,280
it's done with a lot of love and the cab
to duty key so what happens here and

255
00:25:59,280 --> 00:26:06,920
this is the attackers how attackers
requests for specific service looks like

256
00:26:06,920 --> 00:26:08,550
with the golden ticket

257
00:26:08,550 --> 00:26:18,210
the attacker gives it exploits the
captivity key and the ticket details

258
00:26:18,210 --> 00:26:30,130
groups that want their user to be member
in that exploit heat makes DDT and

259
00:26:30,130 --> 00:26:31,930
injective

260
00:26:31,930 --> 00:26:38,730
injected to us or has its own
implementation of Kerberos and from that

261
00:26:38,730 --> 00:26:45,200
to duty the user is able to the attacker
is able to request access to specific

262
00:26:45,200 --> 00:26:51,040
resources as in before so let's play a
little game let's play for the

263
00:26:51,040 --> 00:26:57,810
difference so this is how regular
authentication and authorization look

264
00:26:57,810 --> 00:27:08,080
like five steps that with earlier and
this is how well we're using golden

265
00:27:08,080 --> 00:27:09,030
ticket

266
00:27:09,030 --> 00:27:14,830
authentication looks like can you spot
the differences

267
00:27:14,830 --> 00:27:19,189
well yeah exactly

268
00:27:19,190 --> 00:27:23,510
if there is a missing step there again
this is not by mister this is the

269
00:27:23,510 --> 00:27:29,310
essence of the attack and attack you try
to skip the first indication there and

270
00:27:29,310 --> 00:27:39,120
start from the Middle already with a
capital sorry det that they bake in

271
00:27:39,120 --> 00:27:45,840
advance using the captivity key and how
does it look over the network so this is

272
00:27:45,840 --> 00:27:51,939
again a normal authentication you can
see here in des reply which is the

273
00:27:51,940 --> 00:27:58,600
second step of the five steps you can
see here in their Redbox this is the

274
00:27:58,600 --> 00:28:01,909
ticket that goes back

275
00:28:01,910 --> 00:28:09,130
22 the user you can I'm not sure you can
see it but it's it's a blob long before

276
00:28:09,130 --> 00:28:15,480
long encrypted buffer and its encrypted
network monitoring cannot see the

277
00:28:15,480 --> 00:28:21,850
confidence of it but they don't know we
don't need to because what is important

278
00:28:21,850 --> 00:28:30,100
is that the user quotes this after very
between buy 24 bite in the tedious

279
00:28:30,100 --> 00:28:35,090
request as you can see here and if you
don't see you can believe me that

280
00:28:35,090 --> 00:28:41,639
include that powered the bank part in
this screenshot is the same between the

281
00:28:41,640 --> 00:28:48,230
S reply and it is just request and in
the screenshot that the bottom you can

282
00:28:48,230 --> 00:28:56,040
see it difficult session of cameras
which contains again single s reply with

283
00:28:56,040 --> 00:29:03,370
a ticket in the anchor part and then a
series of digits through quick access to

284
00:29:03,370 --> 00:29:07,750
various resources has the same

285
00:29:07,750 --> 00:29:15,830
encrypted take it information group that
did the information in them so the

286
00:29:15,830 --> 00:29:22,320
network based detection is trivial from
this could be devised rotary couple did

287
00:29:22,320 --> 00:29:31,550
you dnt just request with its parent in
the air supply and if this security

288
00:29:31,550 --> 00:29:36,000
device unable to find the TGT the
tedious request

289
00:29:36,000 --> 00:29:47,410
parent s replied that created it it a
large possible ticket and and this is

290
00:29:47,410 --> 00:29:54,230
just to show you that this is not only
theoretical issue consider this is slide

291
00:29:54,230 --> 00:29:56,980
from crowd strike from RSA

292
00:29:56,980 --> 00:30:03,890
this year and this is a threat to act or
a sink hurricane funded a name and this

293
00:30:03,890 --> 00:30:09,330
threat doctors one of the steps in
establishing access to the network was

294
00:30:09,330 --> 00:30:18,790
create a golden ticket so this is a very
and it is used in there while let's move

295
00:30:18,790 --> 00:30:24,668
on to another attack another forgery
attack that again was found in the wild

296
00:30:24,669 --> 00:30:34,390
and its 1468 I like this by giving
millard giving analogy to this is a must

297
00:30:34,390 --> 00:30:42,929
for 268 is like buying a regular ticket
to fly writing I'm the pilot and the

298
00:30:42,929 --> 00:30:50,169
ticket and the Stewarts welcome kip then
how how would you like your coffee

299
00:30:50,169 --> 00:30:55,260
you start as a regular passengers and
end up within the cockpit as the captain

300
00:30:55,260 --> 00:31:01,720
and again this is not your article
attack this is the way that the

301
00:31:01,720 --> 00:31:08,970
Kaspersky attackers were able to reach
Kaspersky Kaspersky internal network so

302
00:31:08,970 --> 00:31:15,500
this is indeed something that advanced
attackers actually do and let's talk

303
00:31:15,500 --> 00:31:21,460
about the technical details of this
attack so this is the part that remember

304
00:31:21,460 --> 00:31:28,820
from the Golden Ticket attack and its
embedded within the encrypted ticket

305
00:31:28,820 --> 00:31:37,250
let's talk about what happens when the
user since the TGT and requested teaches

306
00:31:37,250 --> 00:31:39,520
what happens to the park

307
00:31:39,520 --> 00:31:48,059
the kissa first verifies the signatures
and if the signature is found to be

308
00:31:48,059 --> 00:31:48,710
valid

309
00:31:48,710 --> 00:31:55,929
which means the park was not tampered
with it just copies the park from the

310
00:31:55,929 --> 00:32:01,720
TGT into the service ticket and resize
it once with the server key so the

311
00:32:01,720 --> 00:32:09,110
server will be able to validate that
indeed this is a ballot box and thanks

312
00:32:09,110 --> 00:32:17,490
again with again with his cabinet with
its cameras digiti captivity key so if

313
00:32:17,490 --> 00:32:22,000
the server for some reason want two
extra validation to do extra validation

314
00:32:22,000 --> 00:32:31,330
they can it can send this back back to
Dec and asked asked if indeed this is

315
00:32:31,330 --> 00:32:38,418
properly son and here is the essence of
detective on our ability

316
00:32:38,419 --> 00:32:46,010
develop the ones that Killa signatures
were allowed so in theory and the

317
00:32:46,010 --> 00:32:51,379
specification only hMIC which means a
hash with a key should be used to sign

318
00:32:51,380 --> 00:32:56,090
but the vulnerability was erroneously
the case except killers harshest

319
00:32:56,090 --> 00:33:01,689
signatures for example you can sign this
back with them decide which means that

320
00:33:01,690 --> 00:33:07,559
anyone can sign because there is no ki
no secret and I meant in this process

321
00:33:07,559 --> 00:33:14,520
therefore there is no point in this
signature anyone can sign it but that

322
00:33:14,520 --> 00:33:19,059
serious because we were said that

323
00:33:19,059 --> 00:33:27,090
ticket itself is encrypted attackers get
not just overwrite the park and Kerberos

324
00:33:27,090 --> 00:33:31,689
ticket and with the pocket they signed
on with them 25 because it wouldn't work

325
00:33:31,690 --> 00:33:37,049
and would be decrypted properly and if
they can decrypt it and they already

326
00:33:37,049 --> 00:33:46,649
have the capacity key so why bother with
it they can just do whatever ok so but

327
00:33:46,649 --> 00:33:54,539
there is a way to exploit it without
knowing the cabotage Attiki so here is

328
00:33:54,539 --> 00:33:59,129
how it worked for the attackers that I
purchase requests and as request

329
00:33:59,129 --> 00:34:04,279
authentication request but they asked
for a populist digiti please give me a

330
00:34:04,279 --> 00:34:10,418
TGT without a pack this is this field
include Park equals fall then they

331
00:34:10,418 --> 00:34:17,469
tackle request with the teachers request
a service ticket with a fake but so they

332
00:34:17,469 --> 00:34:24,069
quote that backless digiti but they have
a new field they're called and

333
00:34:24,069 --> 00:34:34,699
conservation dollar which is optional
and in that field they feel in their MDN

334
00:34:34,699 --> 00:34:43,368
5 signed park so this is an interim
summary of what's going on for their

335
00:34:43,369 --> 00:34:52,599
docket that doctors still think you need
a password so irregular s request is

336
00:34:52,599 --> 00:35:02,020
performed but their doctor requests
requested to be without a pack then uses

337
00:35:02,020 --> 00:35:07,690
that ankle sore edition that I thank you

338
00:35:07,690 --> 00:35:18,760
that authorization data field in order
to put in the back of the tease they

339
00:35:18,760 --> 00:35:27,079
signed with AMD five and said that to
the VC disse just embeds that cock into

340
00:35:27,079 --> 00:35:31,190
the service ticket that is used to
access the specific resource that the

341
00:35:31,190 --> 00:35:41,410
attacker ones but it does not really
work because servers this before the

342
00:35:41,410 --> 00:35:50,868
pair towards a but was able accepted box
that our time with him defied but

343
00:35:50,869 --> 00:35:57,970
servers were already pitched and they do
not accept the design within the 5 end

344
00:35:57,970 --> 00:36:10,200
therefore they would reject and that
ticket because not properly signed by

345
00:36:10,200 --> 00:36:16,930
the attackers does not quit don't do not
quit and they introduce another stage in

346
00:36:16,930 --> 00:36:24,029
their attack that fixes that situation
so in that attack instead of directly

347
00:36:24,030 --> 00:36:28,700
requesting access to the resource that
they want they have another round in

348
00:36:28,700 --> 00:36:37,910
state three and four they send the TGS
request they want specific access to the

349
00:36:37,910 --> 00:36:44,509
camera's internal service to curb GGT
usually it is used to renew a ticket if

350
00:36:44,510 --> 00:36:54,540
you have a ticket that is about to
expire you create the captivity and you

351
00:36:54,540 --> 00:37:04,130
get a new one so that's what they do
they request access to captivity the KDC

352
00:37:04,130 --> 00:37:11,930
just embed the park they specify the
incarceration data into the service

353
00:37:11,930 --> 00:37:21,770
ticket in stage four and then in stage 5
they request Knox's to their research

354
00:37:21,770 --> 00:37:28,109
they actually want to access to by then
they have attended they have a TGT with

355
00:37:28,109 --> 00:37:32,630
a fake back within it but what happens
on the server will go see in the next

356
00:37:32,630 --> 00:37:36,130
slide

357
00:37:36,130 --> 00:37:45,020
KBC follows its usual flow first it
verifies the signature the signature is

358
00:37:45,020 --> 00:37:52,730
MDN 5 but since this the KDC is
vulnerable and is willing to accept box

359
00:37:52,730 --> 00:37:59,770
and with them the 50 said that's ok and
copies the Bakken formation and then it

360
00:37:59,770 --> 00:38:07,380
three signs but this time properly with
md4 mujh market show wanna H mark and

361
00:38:07,380 --> 00:38:15,690
the fight with each key with capita GDP
and so vicky que using this stage at

362
00:38:15,690 --> 00:38:22,990
doctors are able to get a valid kosher
ticket

363
00:38:22,990 --> 00:38:35,368
user now becomes the domain admin if
they like to and can bridge the

364
00:38:35,369 --> 00:38:45,230
Kaspersky inter-mountain network so
let's discuss network based detection so

365
00:38:45,230 --> 00:38:56,119
far and its server dns request with duct
work with equal false because I want a

366
00:38:56,119 --> 00:39:02,440
ticket with our parks ok so they can
bring their own pack into the game then

367
00:39:02,440 --> 00:39:07,390
CNN acquisition data field which is not
now which contains some of the tradition

368
00:39:07,390 --> 00:39:15,078
that I did is used by the attackers to
put their back in and finally that

369
00:39:15,079 --> 00:39:22,000
verified that the doctor server in these
needs it back which it's another field

370
00:39:22,000 --> 00:39:29,180
in the Active Directory so even though
that some of these fields can be can be

371
00:39:29,180 --> 00:39:36,879
not a nominee have this value but having
all three of them together just doesn't

372
00:39:36,880 --> 00:39:42,940
make sense and we can and detect this
attack for pets

373
00:39:42,940 --> 00:39:49,319
it is easier to detect this attack and
the point of detecting attack against

374
00:39:49,319 --> 00:39:53,450
press service even if it would work
because you want to know that you were

375
00:39:53,450 --> 00:39:59,220
under attack even if it wasn't
successful is that the KBC were returned

376
00:39:59,220 --> 00:40:04,649
an error which very indicative to the
situation that the signature type is not

377
00:40:04,650 --> 00:40:10,339
supported because its patents no longer
willing to accept and the five as a

378
00:40:10,339 --> 00:40:20,150
signature sorry this is a little bit
detection off MS-forty healthy aFAIK

379
00:40:20,150 --> 00:40:26,859
back exactly based on the criteria we
had mentioned before and now we move on

380
00:40:26,859 --> 00:40:38,410
for the last attack Ford repair their
damaged so let's talk about diamond is

381
00:40:38,410 --> 00:40:44,180
now he's a nobel attack variant which is
offering

382
00:40:44,180 --> 00:40:50,799
offspring of two attacks it takes a deal
still in the clarity from the golden

383
00:40:50,800 --> 00:40:57,750
ticket and then takes a lot to embed
with the pack from the fake back and the

384
00:40:57,750 --> 00:41:03,940
result is a diamond park so how'd it go
for the doctor that I can think and

385
00:41:03,940 --> 00:41:09,800
reason and then it will create their own
back we've put our approaches

386
00:41:09,800 --> 00:41:16,430
tucker names but it was not like an
effect back at a quick and defied it

387
00:41:16,430 --> 00:41:25,339
will sign it just like her ward with the
contrat key and it will used a fake back

388
00:41:25,340 --> 00:41:34,590
attack slow to embed but to push back
toward the DDT and then to teach you to

389
00:41:34,590 --> 00:41:37,360
Jess

390
00:41:37,360 --> 00:41:42,870
exploit from the stage looks very
similar or the same practically as a

391
00:41:42,870 --> 00:41:48,960
fake back to find major difference I
thought hearst makes the pact signed it

392
00:41:48,960 --> 00:41:56,340
with a diamond back then it goes in
there doing a request to the acting

393
00:41:56,340 --> 00:42:03,770
director say you made their duty without
about no backup

394
00:42:03,770 --> 00:42:10,550
back to duty bound to pack it goes again
to the camera store Michael to Active

395
00:42:10,550 --> 00:42:18,550
Directory we've asks again for the TT's
captivity service this time in the side

396
00:42:18,550 --> 00:42:26,900
of any position data Diamondback back
signed by Kevin Eugene Domingo returns

397
00:42:26,900 --> 00:42:34,050
to duty with copy it back and then we're
not talking now will go and ask to

398
00:42:34,050 --> 00:42:36,810
access to specific resource basically
asking

399
00:42:36,810 --> 00:42:44,540
Jessica West bespeak will be copied over
to the ticket to the service ticket but

400
00:42:44,540 --> 00:42:48,590
since the departure is signed correctly
with the country's tea among car to

401
00:42:48,590 --> 00:42:54,260
mentor will accept it and it will pass
verification will rest time it will end

402
00:42:54,260 --> 00:43:02,110
service password and then take it the
service ticket this means that even if

403
00:43:02,110 --> 00:43:07,380
the server the Active Directory special
against take back the

404
00:43:07,380 --> 00:43:20,450
1468 this time it will still work so the
obvious question is widely used the Sun

405
00:43:20,450 --> 00:43:25,019
the Diamondback instead of the parents
but we just explain it because the

406
00:43:25,019 --> 00:43:30,758
golden ticket is easily detectable over
the net one because in all not on over

407
00:43:30,759 --> 00:43:35,980
there because there is a kind of copper
and gold integration response to the

408
00:43:35,980 --> 00:43:42,750
request response and adjust the quest
for peace patched it's not longer and

409
00:43:42,750 --> 00:43:47,670
longer life so we have a Diamondback
attack which gives us an unbound bridges

410
00:43:47,670 --> 00:43:55,670
just like a golden ticket but a military
usually flow of the network but

411
00:43:55,670 --> 00:44:02,990
fortunately scenes the following just
like the sake backflow this game logic

412
00:44:02,990 --> 00:44:10,450
which detects the fake back will detect
the diamond Pok Pok yes sorry and gang

413
00:44:10,450 --> 00:44:19,919
did the same I left will be in advance
for tonight at six so we will conclude

414
00:44:19,920 --> 00:44:25,190
the conclusion is that a Packers no
longer stopped at stephen existence

415
00:44:25,190 --> 00:44:30,839
identity just not enough we must
intervene or walking of the camera

416
00:44:30,839 --> 00:44:34,930
system to be able to follow identities
and privileges which is not previously

417
00:44:34,930 --> 00:44:42,058
exist but metal point around which and
protect against both of those products

418
00:44:42,059 --> 00:44:52,079
so let's put another point and leash on
the dog and you can download the scanner

419
00:44:52,079 --> 00:45:00,460
against the key from the link on this
slide you can also text if you like and

420
00:45:00,460 --> 00:45:01,849
thank you very much

421
00:45:01,849 --> 00:45:12,490
any questions

422
00:45:12,490 --> 00:45:19,740
we will their presentation will be on
blankets side so you can you know from

423
00:45:19,740 --> 00:45:38,859
there if you like a narrow question

424
00:45:38,860 --> 00:45:45,100
ok so the question was is this
monitoring approach only good against

425
00:45:45,100 --> 00:45:51,799
that actually shown here or is it
something more general generic so the

426
00:45:51,800 --> 00:45:58,050
short answer yes it's general solution
all kinds of I don't take for example

427
00:45:58,050 --> 00:46:03,140
still in the text is it to the tech
network monitoring for example but the

428
00:46:03,140 --> 00:46:08,390
ticket you see that pic him towards
assigned to a certain computer and all

429
00:46:08,390 --> 00:46:13,420
of a sudden you see it from another
computer so from the network perspective

430
00:46:13,420 --> 00:46:19,670
it's very easily to see this anomaly but
if you don't have network monitoring how

431
00:46:19,670 --> 00:46:24,450
can you spot it it everything works
perfectly so this is a very generic

432
00:46:24,450 --> 00:46:31,069
approach to detecting this kind of
attack and not only the one that we had

433
00:46:31,070 --> 00:46:43,840
shown you think yes the question was
what is our accommodation if you're

434
00:46:43,840 --> 00:46:49,200
already infected attacker was able to
obtain the capital city

435
00:46:49,200 --> 00:46:51,129
key

436
00:46:51,130 --> 00:46:59,010
what do you do now so obviously you need
to change that DDT key and their look

437
00:46:59,010 --> 00:46:59,610
for it

438
00:46:59,610 --> 00:47:03,550
technique Microsoft technologies away
how to change it in fact you have to

439
00:47:03,550 --> 00:47:09,280
change it twice because one generation
all their captivity key is still valid

440
00:47:09,280 --> 00:47:15,260
and in fact there is also if you want to
go the extra mile there is a screen you

441
00:47:15,260 --> 00:47:20,810
can download from TechNet that
periodically rotate your captivity keys

442
00:47:20,810 --> 00:47:25,470
so even if you're not aware and that
someone stole your golden ticket because

443
00:47:25,470 --> 00:47:30,859
typically what it used to be is that
administrator never change

444
00:47:30,860 --> 00:47:37,850
he in fact that they weren't even very
aware that it existed so you start

445
00:47:37,850 --> 00:47:43,120
attackers stole it once and got access
to the network for ever but now there is

446
00:47:43,120 --> 00:47:51,370
described that rotates that heavy duty
keys so even if you if you're a domain

447
00:47:51,370 --> 00:47:53,690
controller had been exposed

448
00:47:53,690 --> 00:47:59,750
and darker obtained community so it's
only good for a few days and not forever

449
00:47:59,750 --> 00:48:18,700
is used to be so the question was if the
Kerberos protocol is so vulnerable why

450
00:48:18,700 --> 00:48:22,120
don't we start with something else
something new

451
00:48:22,120 --> 00:48:25,750
the short answer is impossible

452
00:48:25,750 --> 00:48:30,190
very much because let's take for example
the NTLM political the old their

453
00:48:30,190 --> 00:48:35,910
authentication protocol that Microsoft
had used and try to in effect for

454
00:48:35,910 --> 00:48:41,899
Windows 2000 so fifteen years ago and
Microsoft difficult

455
00:48:41,900 --> 00:48:50,240
authentication protocol was not until
but still even Windows 10 still support

456
00:48:50,240 --> 00:48:55,810
and PLM because of backward
compatibility and all the application

457
00:48:55,810 --> 00:49:00,259
and so on so forth because this is a
protocol it's not something on your

458
00:49:00,260 --> 00:49:05,330
computer its own computer it's on the D
see it on their application you you

459
00:49:05,330 --> 00:49:09,759
acces so it's very hard to change that
protocol and even though Microsoft is

460
00:49:09,760 --> 00:49:16,210
trying for fifteen years to get rid of
NTLM and able to limit its use from the

461
00:49:16,210 --> 00:49:19,109
division it still cannot

462
00:49:19,109 --> 00:49:25,369
get rid of it all together so even if we
changed cables which is a good protocol

463
00:49:25,369 --> 00:49:34,220
but has some attacks on it it will take
us at least 15 years to get rid of

464
00:49:34,220 --> 00:49:44,069
all the ecosphere of it so it wouldn't
so they think their best strategy would

465
00:49:44,070 --> 00:49:48,210
be to have monitoring

466
00:49:48,210 --> 00:49:52,040
instruction and not replace it with
something else

467
00:49:52,040 --> 00:50:01,450
ok if there are further questions thank
you for coming today you can find out if

468
00:50:01,450 --> 00:50:08,040
there is some horrendous for us and you
can reach us to ask anything you want

469
00:50:08,040 --> 00:50:11,109
and will be here after the talks are
thank you very much thank you

