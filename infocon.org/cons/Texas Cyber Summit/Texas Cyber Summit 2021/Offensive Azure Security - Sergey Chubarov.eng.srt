1
00:00:00,960 --> 00:00:01,920
hello

2
00:00:01,920 --> 00:00:03,760
welcome to offensive azure security

3
00:00:03,760 --> 00:00:05,920
session my name is sergey and i'm going

4
00:00:05,920 --> 00:00:08,080
to be a presenter

5
00:00:08,080 --> 00:00:09,760
what this session is all about

6
00:00:09,760 --> 00:00:11,840
in this session i'm going to cover how

7
00:00:11,840 --> 00:00:12,719
we can

8
00:00:12,719 --> 00:00:16,640
pen test and uh cloud environment and

9
00:00:16,640 --> 00:00:20,160
find out different misconfigurations

10
00:00:20,160 --> 00:00:22,960
nowadays cloud is very huge part of our

11
00:00:22,960 --> 00:00:25,039
infrastructure so we can't ignore cloud

12
00:00:25,039 --> 00:00:27,439
and we must know

13
00:00:27,439 --> 00:00:29,840
how to penetration test and run

14
00:00:29,840 --> 00:00:31,920
assessment when we have cloud

15
00:00:31,920 --> 00:00:33,440
environment

16
00:00:33,440 --> 00:00:35,120
what's what is also interesting about

17
00:00:35,120 --> 00:00:37,760
this session this session is demo based

18
00:00:37,760 --> 00:00:40,000
i'm not going to show you many slides

19
00:00:40,000 --> 00:00:42,079
and another one

20
00:00:42,079 --> 00:00:44,719
this session is pre-recorded

21
00:00:44,719 --> 00:00:46,719
um because

22
00:00:46,719 --> 00:00:48,879
i'm going to have a flight uh right

23
00:00:48,879 --> 00:00:51,199
before the conference across the ocean

24
00:00:51,199 --> 00:00:53,039
and you know nowadays it's hard to

25
00:00:53,039 --> 00:00:54,239
predict

26
00:00:54,239 --> 00:00:56,239
when and where i'm going to take off and

27
00:00:56,239 --> 00:00:57,199
land

28
00:00:57,199 --> 00:00:58,559
just in case this session is

29
00:00:58,559 --> 00:01:00,320
pre-recorded i hope i'm gonna be with

30
00:01:00,320 --> 00:01:02,879
you and i will work with you in the chat

31
00:01:02,879 --> 00:01:05,840
answer your questions and so on if not

32
00:01:05,840 --> 00:01:07,600
i'm in the sky

33
00:01:07,600 --> 00:01:08,960
fingers crossed

34
00:01:08,960 --> 00:01:10,560
so hopefully

35
00:01:10,560 --> 00:01:12,479
currently i'm with you

36
00:01:12,479 --> 00:01:13,920
so

37
00:01:13,920 --> 00:01:16,240
um let me show one more slide about

38
00:01:16,240 --> 00:01:17,920
myself and i

39
00:01:17,920 --> 00:01:20,479
i promise you we're going to start the

40
00:01:20,479 --> 00:01:24,479
session and the content of this session

41
00:01:25,759 --> 00:01:27,680
so my name is sergey once again

42
00:01:27,680 --> 00:01:29,759
um very important where i'm from i'm

43
00:01:29,759 --> 00:01:30,880
from russia

44
00:01:30,880 --> 00:01:33,840
so that's my burden to do all of this

45
00:01:33,840 --> 00:01:35,840
hacking and

46
00:01:35,840 --> 00:01:37,920
as you can see on the slide i i do a lot

47
00:01:37,920 --> 00:01:40,720
of fantastic and also i'm an instructor

48
00:01:40,720 --> 00:01:42,159
conference speaker

49
00:01:42,159 --> 00:01:44,159
if you want to contact me

50
00:01:44,159 --> 00:01:45,840
during the session after the session

51
00:01:45,840 --> 00:01:47,680
whatever it may be here's the linkedin

52
00:01:47,680 --> 00:01:50,640
url go ahead and find me you may

53
00:01:50,640 --> 00:01:52,960
ask something say something or you may

54
00:01:52,960 --> 00:01:54,799
just find some other conferences where i

55
00:01:54,799 --> 00:01:56,320
speak

56
00:01:56,320 --> 00:01:58,000
i'm azure mvp

57
00:01:58,000 --> 00:01:59,040
i have

58
00:01:59,040 --> 00:02:02,719
oscp or sap mct whatever it may be

59
00:02:02,719 --> 00:02:04,399
certifications

60
00:02:04,399 --> 00:02:06,640
but i think the your goal here is not

61
00:02:06,640 --> 00:02:08,800
just listen about me but

62
00:02:08,800 --> 00:02:10,800
finally let's start the session

63
00:02:10,800 --> 00:02:12,400
so let's start the session and let's

64
00:02:12,400 --> 00:02:14,480
take a look on our agenda and you can

65
00:02:14,480 --> 00:02:16,080
see here

66
00:02:16,080 --> 00:02:18,560
three figures and you may ask what the

67
00:02:18,560 --> 00:02:19,920
hell is that

68
00:02:19,920 --> 00:02:22,800
i'm waiting for agenda

69
00:02:22,800 --> 00:02:25,280
what those things are all about

70
00:02:25,280 --> 00:02:27,680
so that's that's my agenda as i

71
00:02:27,680 --> 00:02:29,360
mentioned before this session will be

72
00:02:29,360 --> 00:02:30,239
about

73
00:02:30,239 --> 00:02:31,840
will be about

74
00:02:31,840 --> 00:02:34,000
like an offensive things will be about

75
00:02:34,000 --> 00:02:37,360
dark side i will show you how those

76
00:02:37,360 --> 00:02:40,640
three environments may be compromised

77
00:02:40,640 --> 00:02:43,280
so how hybrid id may be compromised when

78
00:02:43,280 --> 00:02:45,760
you have on-premise id and you have

79
00:02:45,760 --> 00:02:48,480
ad connect and azure id as well

80
00:02:48,480 --> 00:02:51,120
how those things may be compromised

81
00:02:51,120 --> 00:02:53,120
you will see how virtual machines may be

82
00:02:53,120 --> 00:02:56,319
compromised and also the last one

83
00:02:56,319 --> 00:02:57,120
is

84
00:02:57,120 --> 00:03:00,879
application in pass services

85
00:03:00,879 --> 00:03:04,319
um using the oh it will use only past

86
00:03:04,319 --> 00:03:06,400
services how those things may be

87
00:03:06,400 --> 00:03:08,080
compromised as well

88
00:03:08,080 --> 00:03:10,720
that's my agenda so let's get started as

89
00:03:10,720 --> 00:03:12,640
i mentioned before a session will be

90
00:03:12,640 --> 00:03:14,560
based on live demos so you will not see

91
00:03:14,560 --> 00:03:16,800
a lot of slides here i will use slides

92
00:03:16,800 --> 00:03:19,840
to just show where we are

93
00:03:19,840 --> 00:03:21,200
but

94
00:03:21,200 --> 00:03:23,680
i will not really use slides for

95
00:03:23,680 --> 00:03:25,599
technical explanation

96
00:03:25,599 --> 00:03:27,360
so the first scenario

97
00:03:27,360 --> 00:03:28,159
is

98
00:03:28,159 --> 00:03:30,560
my own parameter directory with ad

99
00:03:30,560 --> 00:03:32,239
connect

100
00:03:32,239 --> 00:03:35,120
um and of course azure id as well so let

101
00:03:35,120 --> 00:03:36,959
me jump to demo as you

102
00:03:36,959 --> 00:03:39,120
demo as i promised you and so here i

103
00:03:39,120 --> 00:03:41,760
have a simple configuration first of all

104
00:03:41,760 --> 00:03:43,760
i have the main controller

105
00:03:43,760 --> 00:03:48,480
and i have ad connect server as well

106
00:03:48,720 --> 00:03:50,319
and it's it's very very typical

107
00:03:50,319 --> 00:03:51,760
configuration of course you have

108
00:03:51,760 --> 00:03:53,599
multiple domain controllers it doesn't

109
00:03:53,599 --> 00:03:54,640
really matter

110
00:03:54,640 --> 00:03:57,920
so the the idea here i have

111
00:03:57,920 --> 00:04:00,480
active directory on-premises and i have

112
00:04:00,480 --> 00:04:03,200
ad connect that connects me to to azure

113
00:04:03,200 --> 00:04:04,480
id

114
00:04:04,480 --> 00:04:07,040
what may go wrong here

115
00:04:07,040 --> 00:04:10,799
um if i connect my on-premise cd to

116
00:04:10,799 --> 00:04:12,720
azure id using ad connect

117
00:04:12,720 --> 00:04:13,599
so

118
00:04:13,599 --> 00:04:14,400
when

119
00:04:14,400 --> 00:04:17,040
i do it

120
00:04:17,040 --> 00:04:19,279
uh during configuration of ad connect i

121
00:04:19,279 --> 00:04:21,120
must

122
00:04:21,120 --> 00:04:22,960
choose

123
00:04:22,960 --> 00:04:24,960
i must create a gif what's called a

124
00:04:24,960 --> 00:04:26,960
deforest account

125
00:04:26,960 --> 00:04:29,360
a deforest account that's an account

126
00:04:29,360 --> 00:04:32,160
that will that will

127
00:04:32,160 --> 00:04:34,320
will will will get

128
00:04:34,320 --> 00:04:36,720
access to on-prem database

129
00:04:36,720 --> 00:04:41,199
um azure azure id to azure id to get

130
00:04:41,199 --> 00:04:43,759
accounts from there to get users to get

131
00:04:43,759 --> 00:04:46,400
groups so this account will be used to

132
00:04:46,400 --> 00:04:49,120
access your on-premises id

133
00:04:49,120 --> 00:04:50,560
and so

134
00:04:50,560 --> 00:04:52,000
during the

135
00:04:52,000 --> 00:04:54,160
ad connect configuration you must create

136
00:04:54,160 --> 00:04:56,479
this account or you may also pre-create

137
00:04:56,479 --> 00:04:59,120
but more secure option is more commanded

138
00:04:59,120 --> 00:05:02,560
is the first one create new ad account

139
00:05:02,560 --> 00:05:05,759
so adconnect will create a new account

140
00:05:05,759 --> 00:05:07,440
for you

141
00:05:07,440 --> 00:05:09,360
let's take a look on this account

142
00:05:09,360 --> 00:05:11,919
if i go back to my dc

143
00:05:11,919 --> 00:05:14,960
and in folder called users i may find

144
00:05:14,960 --> 00:05:18,720
this account it's called msl underscore

145
00:05:18,720 --> 00:05:20,880
and something something something

146
00:05:20,880 --> 00:05:22,960
if i look at the account itself this

147
00:05:22,960 --> 00:05:25,039
account should be just a regular user

148
00:05:25,039 --> 00:05:26,639
and looks like there is no problem with

149
00:05:26,639 --> 00:05:28,960
this account just just a low proof

150
00:05:28,960 --> 00:05:30,240
account

151
00:05:30,240 --> 00:05:33,360
and yeah it is it is but

152
00:05:33,360 --> 00:05:34,400
but

153
00:05:34,400 --> 00:05:36,800
when you also configure ad connect

154
00:05:36,800 --> 00:05:39,360
you will you will also enable if you

155
00:05:39,360 --> 00:05:40,720
wish of course

156
00:05:40,720 --> 00:05:43,600
some options optional features and when

157
00:05:43,600 --> 00:05:45,680
you enable optional features

158
00:05:45,680 --> 00:05:48,880
that account will have more permissions

159
00:05:48,880 --> 00:05:50,400
let's take a look on some features that

160
00:05:50,400 --> 00:05:52,560
are you may see you you see some

161
00:05:52,560 --> 00:05:54,000
features on the slide but i will give a

162
00:05:54,000 --> 00:05:56,160
comment there is only about one feature

163
00:05:56,160 --> 00:05:58,000
and very important feature which is

164
00:05:58,000 --> 00:06:00,560
highly recommended is called password

165
00:06:00,560 --> 00:06:02,000
hash sync

166
00:06:02,000 --> 00:06:03,759
so this feature

167
00:06:03,759 --> 00:06:06,639
allows you to store password hashes of

168
00:06:06,639 --> 00:06:08,560
your on-premises users

169
00:06:08,560 --> 00:06:10,240
in azure id

170
00:06:10,240 --> 00:06:13,039
so after synchronization not only user

171
00:06:13,039 --> 00:06:14,800
itself will be created in the cloud but

172
00:06:14,800 --> 00:06:17,600
also user password

173
00:06:17,600 --> 00:06:20,000
hashed will be stored in the cloud as

174
00:06:20,000 --> 00:06:21,199
well

175
00:06:21,199 --> 00:06:22,960
and so it's very commanded disaster

176
00:06:22,960 --> 00:06:24,800
recovery option because if you lose

177
00:06:24,800 --> 00:06:26,800
connectivity between your on-premises in

178
00:06:26,800 --> 00:06:27,840
the cloud

179
00:06:27,840 --> 00:06:30,080
users will be able to log into the cloud

180
00:06:30,080 --> 00:06:33,440
with using stored hashes and stored

181
00:06:33,440 --> 00:06:34,880
hashes in the cloud

182
00:06:34,880 --> 00:06:36,080
that's one of the

183
00:06:36,080 --> 00:06:37,919
one one of the benefits of this password

184
00:06:37,919 --> 00:06:39,199
hersing

185
00:06:39,199 --> 00:06:40,560
uh but

186
00:06:40,560 --> 00:06:42,960
when you enable password hashing account

187
00:06:42,960 --> 00:06:45,759
msrl account will have extra permissions

188
00:06:45,759 --> 00:06:47,600
account will have will have this permit

189
00:06:47,600 --> 00:06:51,280
to those two permissions

190
00:06:51,440 --> 00:06:53,759
so a replicate directory changes and the

191
00:06:53,759 --> 00:06:56,080
replicate directory changes all

192
00:06:56,080 --> 00:06:58,000
so what those permissions are all about

193
00:06:58,000 --> 00:07:00,720
those permissions will allow you to

194
00:07:00,720 --> 00:07:03,039
replicate active directory

195
00:07:03,039 --> 00:07:06,479
so you will act like you may act

196
00:07:06,479 --> 00:07:08,960
like a domain controller

197
00:07:08,960 --> 00:07:11,280
so let's take a look on this

198
00:07:11,280 --> 00:07:13,440
permissions if i go to properties of my

199
00:07:13,440 --> 00:07:14,560
domain

200
00:07:14,560 --> 00:07:18,800
and go to security find this msl and

201
00:07:18,800 --> 00:07:20,000
find

202
00:07:20,000 --> 00:07:21,360
yeah here we go

203
00:07:21,360 --> 00:07:24,160
so i have those permissions

204
00:07:24,160 --> 00:07:26,880
um and you may say here all right so

205
00:07:26,880 --> 00:07:28,000
yeah that's that's quite a lot of

206
00:07:28,000 --> 00:07:30,479
permissions but this account was created

207
00:07:30,479 --> 00:07:32,720
automatically by microsoft and we don't

208
00:07:32,720 --> 00:07:35,120
know the password to this account so it

209
00:07:35,120 --> 00:07:37,680
should be secure

210
00:07:37,680 --> 00:07:38,560
um

211
00:07:38,560 --> 00:07:42,240
yeah it is it is secure but

212
00:07:42,240 --> 00:07:44,639
how do you think if we have an account

213
00:07:44,639 --> 00:07:48,479
and we don't know the password someone

214
00:07:48,479 --> 00:07:51,520
or something must know this password if

215
00:07:51,520 --> 00:07:53,280
if this something wants to use this

216
00:07:53,280 --> 00:07:54,400
account

217
00:07:54,400 --> 00:07:58,720
so adconnect ad connect itself must know

218
00:07:58,720 --> 00:08:01,199
this password let's take a look where

219
00:08:01,199 --> 00:08:03,759
this value is stored let me jump back to

220
00:08:03,759 --> 00:08:05,120
adconnect

221
00:08:05,120 --> 00:08:08,720
and open uh adconnect database which is

222
00:08:08,720 --> 00:08:11,039
adc indeed called adsync

223
00:08:11,039 --> 00:08:13,360
and here we have multiple tables i need

224
00:08:13,360 --> 00:08:14,720
table called

225
00:08:14,720 --> 00:08:18,479
mms management agent

226
00:08:20,960 --> 00:08:26,039
let me remove columns i don't need

227
00:08:26,319 --> 00:08:27,759
those

228
00:08:27,759 --> 00:08:30,800
columns as well

229
00:08:31,120 --> 00:08:32,640
and let's run that

230
00:08:32,640 --> 00:08:34,559
so

231
00:08:34,559 --> 00:08:36,159
let me find

232
00:08:36,159 --> 00:08:38,000
this account

233
00:08:38,000 --> 00:08:40,640
and yeah it's here so as you can see

234
00:08:40,640 --> 00:08:43,200
here that's that's that's my account in

235
00:08:43,200 --> 00:08:45,600
sql database ad connect database and

236
00:08:45,600 --> 00:08:47,760
also there's a parameter called password

237
00:08:47,760 --> 00:08:50,160
which is says encrypted

238
00:08:50,160 --> 00:08:53,200
so yeah password is there but password

239
00:08:53,200 --> 00:08:55,839
is encrypted

240
00:08:55,920 --> 00:08:57,600
um

241
00:08:57,600 --> 00:08:59,839
not that simple so there is no plain

242
00:08:59,839 --> 00:09:01,519
text password

243
00:09:01,519 --> 00:09:03,279
all right maybe maybe it's possible to

244
00:09:03,279 --> 00:09:04,720
decrypt password

245
00:09:04,720 --> 00:09:06,560
uh yeah it is

246
00:09:06,560 --> 00:09:10,080
if you are a local administrator

247
00:09:10,080 --> 00:09:12,800
on ad connect server and here's the

248
00:09:12,800 --> 00:09:14,240
problem

249
00:09:14,240 --> 00:09:16,800
so before before all of this

250
00:09:16,800 --> 00:09:18,720
it's it's a common configuration but

251
00:09:18,720 --> 00:09:19,839
where's the

252
00:09:19,839 --> 00:09:22,880
where's the problem the problem is is

253
00:09:22,880 --> 00:09:25,519
if your regular admin like a server

254
00:09:25,519 --> 00:09:28,320
admin middle level admin

255
00:09:28,320 --> 00:09:31,600
tier 2 admin whatever it may be

256
00:09:31,600 --> 00:09:34,000
may have

257
00:09:34,000 --> 00:09:36,720
local admin access to ad connect server

258
00:09:36,720 --> 00:09:38,959
let me show you what may happen

259
00:09:38,959 --> 00:09:41,360
if you have configuration like this

260
00:09:41,360 --> 00:09:44,640
i'm going to open powershell

261
00:09:45,040 --> 00:09:47,440
and try to decrypt

262
00:09:47,440 --> 00:09:49,360
this

263
00:09:49,360 --> 00:09:50,480
this account

264
00:09:50,480 --> 00:09:52,640
you made it manually but it will be not

265
00:09:52,640 --> 00:09:55,920
very straightforward much better is to a

266
00:09:55,920 --> 00:09:58,000
fine tool called ad connect dump you may

267
00:09:58,000 --> 00:10:00,080
find freely on github by the way on the

268
00:10:00,080 --> 00:10:03,360
github you may also find the link how to

269
00:10:03,360 --> 00:10:05,680
decrypt account manually so the whole

270
00:10:05,680 --> 00:10:07,360
procedure but it will take so much time

271
00:10:07,360 --> 00:10:10,959
i'm not going to show you here

272
00:10:11,040 --> 00:10:13,040
but if you want to just have a result

273
00:10:13,040 --> 00:10:15,360
let me run this tool

274
00:10:15,360 --> 00:10:16,720
and look at this

275
00:10:16,720 --> 00:10:20,320
now i have now i have account

276
00:10:20,320 --> 00:10:22,800
and the password

277
00:10:22,800 --> 00:10:23,920
so

278
00:10:23,920 --> 00:10:26,320
using this value let me copy this

279
00:10:26,320 --> 00:10:28,959
password i'm going to jump to another

280
00:10:28,959 --> 00:10:32,000
machine and let me open

281
00:10:32,000 --> 00:10:34,800
this one as different user

282
00:10:34,800 --> 00:10:36,480
type password here

283
00:10:36,480 --> 00:10:38,959
and user here and click ok

284
00:10:38,959 --> 00:10:41,760
so now what i'm trying to do i'm going

285
00:10:41,760 --> 00:10:44,480
to open command prompt

286
00:10:44,480 --> 00:10:48,880
on client machine as this ms oil user

287
00:10:48,880 --> 00:10:51,279
i also have a command prompt open let me

288
00:10:51,279 --> 00:10:54,160
show you who am i

289
00:10:54,320 --> 00:10:56,959
uh i'm a user jada so just just like a

290
00:10:56,959 --> 00:10:57,920
regular

291
00:10:57,920 --> 00:10:59,600
user

292
00:10:59,600 --> 00:11:02,000
who is local admin on this machine but

293
00:11:02,000 --> 00:11:03,279
not

294
00:11:03,279 --> 00:11:05,360
not an administrator in domain

295
00:11:05,360 --> 00:11:08,560
let's see a second command prompt here i

296
00:11:08,560 --> 00:11:10,480
am a msrl user

297
00:11:10,480 --> 00:11:12,640
and so let's try to access domain

298
00:11:12,640 --> 00:11:15,040
controller from both command prompts let

299
00:11:15,040 --> 00:11:17,200
me try to do this jdo

300
00:11:17,200 --> 00:11:18,640
nope denied

301
00:11:18,640 --> 00:11:21,600
let's try to do it as

302
00:11:21,600 --> 00:11:23,680
msoil denied

303
00:11:23,680 --> 00:11:25,279
so it's

304
00:11:25,279 --> 00:11:27,600
the accounts they don't have permissions

305
00:11:27,600 --> 00:11:30,720
to access directory but once again

306
00:11:30,720 --> 00:11:33,440
one one account which is a mesol has

307
00:11:33,440 --> 00:11:35,360
permissions to replicate active

308
00:11:35,360 --> 00:11:36,640
directory

309
00:11:36,640 --> 00:11:38,000
and so

310
00:11:38,000 --> 00:11:40,240
if i want to use this permission

311
00:11:40,240 --> 00:11:42,959
i will run tool called mimikatz

312
00:11:42,959 --> 00:11:45,600
uh by the way mimikats may be detected

313
00:11:45,600 --> 00:11:47,680
by any antivirus i have a different

314
00:11:47,680 --> 00:11:50,399
session how to evade

315
00:11:50,399 --> 00:11:53,120
antiviruses and so on so

316
00:11:53,120 --> 00:11:55,360
go ahead and find me on linkedin you

317
00:11:55,360 --> 00:11:57,920
will find a link there as well on my

318
00:11:57,920 --> 00:12:00,000
session about evasion

319
00:12:00,000 --> 00:12:01,920
and and here what i want to do i want to

320
00:12:01,920 --> 00:12:04,639
run simple command called lsa dump dc

321
00:12:04,639 --> 00:12:06,639
sync and i want i want to get

322
00:12:06,639 --> 00:12:09,519
information about user trainer

323
00:12:09,519 --> 00:12:12,560
so i will replicate information about

324
00:12:12,560 --> 00:12:14,720
the main administrator and now i have a

325
00:12:14,720 --> 00:12:16,320
hash

326
00:12:16,320 --> 00:12:19,200
of this user

327
00:12:19,519 --> 00:12:20,399
now

328
00:12:20,399 --> 00:12:22,959
i'm going to open mimikat again

329
00:12:22,959 --> 00:12:25,279
uh also i want to say privilege

330
00:12:25,279 --> 00:12:28,240
previous

331
00:12:28,240 --> 00:12:30,800
debug

332
00:12:31,120 --> 00:12:33,760
and run very well known command called

333
00:12:33,760 --> 00:12:35,760
pass the hash

334
00:12:35,760 --> 00:12:37,600
and let me copy this

335
00:12:37,600 --> 00:12:38,639
hash

336
00:12:38,639 --> 00:12:40,880
and place here

337
00:12:40,880 --> 00:12:42,959
and now if i try to accidentally

338
00:12:42,959 --> 00:12:45,360
controller

339
00:12:45,360 --> 00:12:46,560
look at this

340
00:12:46,560 --> 00:12:48,079
now i have permissions to access them in

341
00:12:48,079 --> 00:12:49,440
controller so it means i'm a domain

342
00:12:49,440 --> 00:12:50,720
admin

343
00:12:50,720 --> 00:12:53,040
and so now

344
00:12:53,040 --> 00:12:54,240
we have

345
00:12:54,240 --> 00:12:56,240
this environment compromised i'm a

346
00:12:56,240 --> 00:12:57,600
domain admin

347
00:12:57,600 --> 00:13:00,160
and i became the main admin based on my

348
00:13:00,160 --> 00:13:04,000
access to azure ad connect server

349
00:13:04,000 --> 00:13:07,360
so if you have administrators who are

350
00:13:07,360 --> 00:13:09,839
have access to this environment i mean

351
00:13:09,839 --> 00:13:12,720
ad connect be careful those guys they

352
00:13:12,720 --> 00:13:15,760
may become domain admins if they wish

353
00:13:15,760 --> 00:13:16,800
so

354
00:13:16,800 --> 00:13:20,880
uh next scenario will be uh my jenkins

355
00:13:20,880 --> 00:13:22,480
virtual machines

356
00:13:22,480 --> 00:13:23,440
and

357
00:13:23,440 --> 00:13:26,079
um i have a jenkins application

358
00:13:26,079 --> 00:13:28,320
jenkins application uh deployed on

359
00:13:28,320 --> 00:13:29,680
virtual machines

360
00:13:29,680 --> 00:13:33,120
and onenote on windows second note on

361
00:13:33,120 --> 00:13:34,560
linux

362
00:13:34,560 --> 00:13:36,160
to be fair it doesn't really matter if

363
00:13:36,160 --> 00:13:38,000
jenkins or something else my goal here

364
00:13:38,000 --> 00:13:40,079
is not to show jenkins the goal is to

365
00:13:40,079 --> 00:13:42,720
show you that i may compromise different

366
00:13:42,720 --> 00:13:44,800
operating systems maybe linux maybe

367
00:13:44,800 --> 00:13:45,680
windows

368
00:13:45,680 --> 00:13:47,600
doesn't really matter

369
00:13:47,600 --> 00:13:51,360
so let me jump back to demo

370
00:13:52,480 --> 00:13:55,360
and so let's continue from here

371
00:13:55,360 --> 00:13:57,199
now i have the main admin credentials

372
00:13:57,199 --> 00:14:00,320
and i want to start to explore azure and

373
00:14:00,320 --> 00:14:02,720
virtual machines in azure um if i'm in

374
00:14:02,720 --> 00:14:04,160
the main admin what i can do with this

375
00:14:04,160 --> 00:14:06,880
with those permissions so literally i

376
00:14:06,880 --> 00:14:07,760
can

377
00:14:07,760 --> 00:14:10,160
connect to any workstation

378
00:14:10,160 --> 00:14:11,920
on this network

379
00:14:11,920 --> 00:14:14,160
let me show you what i can do if if i

380
00:14:14,160 --> 00:14:16,320
have permission like this if i can

381
00:14:16,320 --> 00:14:18,240
connect to any workstation

382
00:14:18,240 --> 00:14:19,760
i'm going to open

383
00:14:19,760 --> 00:14:22,639
workstation one workstation and another

384
00:14:22,639 --> 00:14:25,440
workstation

385
00:14:26,560 --> 00:14:31,040
and here i want to say a oh sorry

386
00:14:31,040 --> 00:14:33,519
uh a z

387
00:14:33,519 --> 00:14:36,399
uh account

388
00:14:36,399 --> 00:14:38,160
list

389
00:14:38,160 --> 00:14:43,040
and let's let's output as a table

390
00:14:43,040 --> 00:14:44,320
and i can see here the list of my

391
00:14:44,320 --> 00:14:46,079
subscriptions

392
00:14:46,079 --> 00:14:47,920
all right let's try this let's try to do

393
00:14:47,920 --> 00:14:48,880
the same

394
00:14:48,880 --> 00:14:52,320
on the second machine

395
00:14:52,320 --> 00:14:54,399
all right now i can see that it says

396
00:14:54,399 --> 00:14:57,199
please run az login

397
00:14:57,199 --> 00:14:59,440
to access your account so it asked me

398
00:14:59,440 --> 00:15:01,839
for login here but didn't ask me for

399
00:15:01,839 --> 00:15:03,760
login here

400
00:15:03,760 --> 00:15:06,560
so probably it means that somewhere

401
00:15:06,560 --> 00:15:09,279
credentials to access the cloud are

402
00:15:09,279 --> 00:15:11,360
cached

403
00:15:11,360 --> 00:15:14,639
uh where they where are they cached if

404
00:15:14,639 --> 00:15:18,800
you go to user profile and you find a

405
00:15:18,800 --> 00:15:22,079
folder called dot azure

406
00:15:22,079 --> 00:15:24,959
and here are cache credentials

407
00:15:24,959 --> 00:15:27,199
so if i'm a domain admin what i can do i

408
00:15:27,199 --> 00:15:30,160
can connect to workstation of developer

409
00:15:30,160 --> 00:15:33,279
or system admin who has access to azure

410
00:15:33,279 --> 00:15:35,920
and steal this token let's try to take

411
00:15:35,920 --> 00:15:37,360
this token

412
00:15:37,360 --> 00:15:41,160
let's zip it real quick

413
00:15:43,680 --> 00:15:48,239
and copy this to second machine

414
00:15:53,199 --> 00:15:56,399
uh let me remove this

415
00:15:59,360 --> 00:16:04,240
and extract this dot azure

416
00:16:04,240 --> 00:16:06,480
alright so now let's try again fingers

417
00:16:06,480 --> 00:16:09,360
crossed

418
00:16:09,360 --> 00:16:11,120
and

419
00:16:11,120 --> 00:16:13,120
now i have list of subscriptions it

420
00:16:13,120 --> 00:16:14,880
means i'm

421
00:16:14,880 --> 00:16:17,759
i have the same level of access as the

422
00:16:17,759 --> 00:16:21,360
administrator on that machine

423
00:16:21,360 --> 00:16:23,279
where i get the

424
00:16:23,279 --> 00:16:25,120
the folder with token

425
00:16:25,120 --> 00:16:28,000
so with those permissions i can start to

426
00:16:28,000 --> 00:16:30,800
explore virtual machines so let's say

427
00:16:30,800 --> 00:16:32,160
a z

428
00:16:32,160 --> 00:16:34,639
vm

429
00:16:35,440 --> 00:16:37,839
list

430
00:16:39,680 --> 00:16:41,600
and

431
00:16:41,600 --> 00:16:42,959
i should see the list of virtual

432
00:16:42,959 --> 00:16:44,639
machines

433
00:16:44,639 --> 00:16:46,480
from this account yeah i can see the

434
00:16:46,480 --> 00:16:47,839
list of machines

435
00:16:47,839 --> 00:16:50,720
i'm interested in jenkins so i will

436
00:16:50,720 --> 00:16:52,959
i will i will test those two machines

437
00:16:52,959 --> 00:16:56,160
jenkins master and jenkins slave

438
00:16:56,160 --> 00:16:57,120
all right

439
00:16:57,120 --> 00:16:58,480
so

440
00:16:58,480 --> 00:17:01,440
what i can do with virtual machines

441
00:17:01,440 --> 00:17:03,279
now let me jump to portal and let me

442
00:17:03,279 --> 00:17:04,799
give you some demo about virtual

443
00:17:04,799 --> 00:17:08,160
machines so so you'll get more ideas uh

444
00:17:08,160 --> 00:17:10,959
what may be the problem

445
00:17:10,959 --> 00:17:12,319
if you look at the virtual machines you

446
00:17:12,319 --> 00:17:13,599
may find

447
00:17:13,599 --> 00:17:16,480
the option called run command

448
00:17:16,480 --> 00:17:18,880
let's click click there and for windows

449
00:17:18,880 --> 00:17:21,679
machine oh sorry slip links machine for

450
00:17:21,679 --> 00:17:23,599
linux machine you may find the command

451
00:17:23,599 --> 00:17:26,000
to run shell script it means you will

452
00:17:26,000 --> 00:17:26,880
run

453
00:17:26,880 --> 00:17:29,280
bash bash script

454
00:17:29,280 --> 00:17:31,600
so if i click there

455
00:17:31,600 --> 00:17:34,160
i may run script here

456
00:17:34,160 --> 00:17:36,559
if i go to windows machine i'm gonna see

457
00:17:36,559 --> 00:17:39,120
the same but powershell script let's

458
00:17:39,120 --> 00:17:41,678
let's see that

459
00:17:43,200 --> 00:17:45,280
and here i can i can see powershell

460
00:17:45,280 --> 00:17:46,559
script

461
00:17:46,559 --> 00:17:48,080
what is interesting about this run

462
00:17:48,080 --> 00:17:49,840
command first of all they will be

463
00:17:49,840 --> 00:17:52,160
executed with the highest permissions

464
00:17:52,160 --> 00:17:54,160
with the highest privileges they will be

465
00:17:54,160 --> 00:17:55,600
executed on windows with system

466
00:17:55,600 --> 00:17:58,240
privileges and on linux with root

467
00:17:58,240 --> 00:18:00,400
privileges that's the first idea that

468
00:18:00,400 --> 00:18:03,840
you should keep in mind second idea

469
00:18:03,840 --> 00:18:06,320
to execute them you just need to be a

470
00:18:06,320 --> 00:18:08,080
reader

471
00:18:08,080 --> 00:18:10,160
on the machine level so let's let me

472
00:18:10,160 --> 00:18:13,280
show you this if i click reader

473
00:18:13,280 --> 00:18:17,280
and click and look at my permissions

474
00:18:22,160 --> 00:18:24,640
compute

475
00:18:25,679 --> 00:18:28,400
and let me find run command

476
00:18:28,400 --> 00:18:30,880
so look look at this so if i if i'm a

477
00:18:30,880 --> 00:18:32,640
reader i have permissions to run

478
00:18:32,640 --> 00:18:34,559
commands

479
00:18:34,559 --> 00:18:36,240
all right so that's that that's that

480
00:18:36,240 --> 00:18:38,320
that's that's my that's maybe a problem

481
00:18:38,320 --> 00:18:41,360
if some if this if that user had read

482
00:18:41,360 --> 00:18:42,640
permissions

483
00:18:42,640 --> 00:18:45,120
that user may run commands so if i want

484
00:18:45,120 --> 00:18:47,120
to connect the virtual machine and like

485
00:18:47,120 --> 00:18:49,039
let's say i want to get into virtual

486
00:18:49,039 --> 00:18:51,120
machine i must know

487
00:18:51,120 --> 00:18:52,400
normally

488
00:18:52,400 --> 00:18:54,880
a username and password but let me show

489
00:18:54,880 --> 00:18:57,679
you how with run commands i can bypass

490
00:18:57,679 --> 00:18:59,440
those requirements

491
00:18:59,440 --> 00:19:02,480
um what i want to do i i will run

492
00:19:02,480 --> 00:19:03,440
um

493
00:19:03,440 --> 00:19:05,440
reverse shell commands

494
00:19:05,440 --> 00:19:08,160
and so those commands will allow me to

495
00:19:08,160 --> 00:19:10,000
get into virtual machine without

496
00:19:10,000 --> 00:19:13,280
restrictions let's take a look on that

497
00:19:13,280 --> 00:19:14,320
um

498
00:19:14,320 --> 00:19:17,360
so let me let's first try a linux server

499
00:19:17,360 --> 00:19:20,160
shell i'm gonna run

500
00:19:20,160 --> 00:19:21,039
um

501
00:19:21,039 --> 00:19:24,320
this the script from command prompt and

502
00:19:24,320 --> 00:19:26,480
i will run the command like this

503
00:19:26,480 --> 00:19:29,280
so that should give me a reverse shell

504
00:19:29,280 --> 00:19:32,720
with linux machine let's try that

505
00:19:32,720 --> 00:19:34,960
what is what is important to know run

506
00:19:34,960 --> 00:19:38,559
commands not super quick so we may need

507
00:19:38,559 --> 00:19:40,720
to wait

508
00:19:40,720 --> 00:19:43,200
some number of seconds i'm not really

509
00:19:43,200 --> 00:19:46,160
sure yeah so let's wait

510
00:19:46,160 --> 00:19:48,880
let's wait

511
00:19:49,039 --> 00:19:50,320
um

512
00:19:50,320 --> 00:19:53,039
30 seconds and hopefully i will get a

513
00:19:53,039 --> 00:19:54,320
shell

514
00:19:54,320 --> 00:19:55,600
in parallel

515
00:19:55,600 --> 00:19:58,240
in parallel let me run let me try to run

516
00:19:58,240 --> 00:20:00,640
that for window on windows

517
00:20:00,640 --> 00:20:02,159
and windows will be slightly different

518
00:20:02,159 --> 00:20:03,840
in my case

519
00:20:03,840 --> 00:20:05,679
i will download

520
00:20:05,679 --> 00:20:06,559
my

521
00:20:06,559 --> 00:20:10,080
my executable with reverse shell and

522
00:20:10,080 --> 00:20:13,600
just run it let's try to do it here

523
00:20:13,600 --> 00:20:15,440
all right let's see i already have a

524
00:20:15,440 --> 00:20:17,520
shell on linux let's see

525
00:20:17,520 --> 00:20:20,559
if i type id and root here and so i can

526
00:20:20,559 --> 00:20:25,039
do whatever i want on linux machine

527
00:20:26,559 --> 00:20:27,679
so

528
00:20:27,679 --> 00:20:30,960
i'm root here and i'm a god on this

529
00:20:30,960 --> 00:20:33,440
machine let's take a look on windows and

530
00:20:33,440 --> 00:20:37,280
yeah we have the same for windows

531
00:20:37,280 --> 00:20:40,720
and i'm i work as the local system

532
00:20:40,720 --> 00:20:42,480
and to just finish the demo about

533
00:20:42,480 --> 00:20:44,080
jenkins um

534
00:20:44,080 --> 00:20:46,799
maybe no maybe not maybe not there is

535
00:20:46,799 --> 00:20:48,640
there's an airlock of jenkins and you

536
00:20:48,640 --> 00:20:50,960
may find the initial passport

537
00:20:50,960 --> 00:20:54,480
um there in jenkins so if i copy this

538
00:20:54,480 --> 00:20:59,200
copy this password and i i can find

539
00:21:01,280 --> 00:21:03,360
um

540
00:21:03,360 --> 00:21:04,320
all right

541
00:21:04,320 --> 00:21:07,280
so let me just copy this first

542
00:21:07,280 --> 00:21:08,159
um

543
00:21:08,159 --> 00:21:09,280
login to

544
00:21:09,280 --> 00:21:12,559
try to log into jenkins

545
00:21:13,120 --> 00:21:17,320
let's take this password again

546
00:21:21,919 --> 00:21:24,320
copy this

547
00:21:24,320 --> 00:21:26,240
paste here of course it may not it may

548
00:21:26,240 --> 00:21:28,240
not work and to be fair i don't really

549
00:21:28,240 --> 00:21:31,360
care if this is working or not my goal

550
00:21:31,360 --> 00:21:33,120
is to show you how can i get into

551
00:21:33,120 --> 00:21:34,799
virtual machines not the now how can i

552
00:21:34,799 --> 00:21:38,720
get into into jenkins um all right so

553
00:21:38,720 --> 00:21:40,880
but i hope it was clear

554
00:21:40,880 --> 00:21:43,120
how virtual machines may be compromised

555
00:21:43,120 --> 00:21:46,000
because if i have read access on virtual

556
00:21:46,000 --> 00:21:47,600
machine level

557
00:21:47,600 --> 00:21:48,960
what i can do

558
00:21:48,960 --> 00:21:50,720
i can

559
00:21:50,720 --> 00:21:53,120
just get into

560
00:21:53,120 --> 00:21:55,280
so that was the second scenario where we

561
00:21:55,280 --> 00:21:58,320
talk about legacy applications jenkins

562
00:21:58,320 --> 00:22:00,480
is not really a legacy but this

563
00:22:00,480 --> 00:22:02,640
application is based on virtual machines

564
00:22:02,640 --> 00:22:04,640
so finally let's take a look at the last

565
00:22:04,640 --> 00:22:09,120
scenario and here we're going to cover

566
00:22:09,120 --> 00:22:11,039
um application which is which should be

567
00:22:11,039 --> 00:22:12,559
a bit more interesting

568
00:22:12,559 --> 00:22:14,080
in this application

569
00:22:14,080 --> 00:22:15,919
we will have

570
00:22:15,919 --> 00:22:17,600
application

571
00:22:17,600 --> 00:22:19,120
web application

572
00:22:19,120 --> 00:22:22,720
uh um with a sql database backend

573
00:22:22,720 --> 00:22:25,919
um also the the credentials to access

574
00:22:25,919 --> 00:22:28,320
backend will not be stored

575
00:22:28,320 --> 00:22:30,240
locally on the web application it will

576
00:22:30,240 --> 00:22:32,880
be stored in a key volt

577
00:22:32,880 --> 00:22:36,159
and the credentials they will be rotated

578
00:22:36,159 --> 00:22:37,600
periodically

579
00:22:37,600 --> 00:22:39,520
with azure functions and also

580
00:22:39,520 --> 00:22:41,039
application will be protected with

581
00:22:41,039 --> 00:22:43,280
application gateway in front

582
00:22:43,280 --> 00:22:45,600
with the feature enabled

583
00:22:45,600 --> 00:22:46,559
so

584
00:22:46,559 --> 00:22:49,840
it looks looks like this application is

585
00:22:49,840 --> 00:22:51,600
quite secure

586
00:22:51,600 --> 00:22:52,960
quite secure

587
00:22:52,960 --> 00:22:57,360
uh but let's try that first let's try

588
00:22:57,360 --> 00:22:58,960
that

589
00:22:58,960 --> 00:23:00,559
so i'm going to jump back to demo as

590
00:23:00,559 --> 00:23:02,960
usual

591
00:23:03,840 --> 00:23:05,760
so we compromised let me close all of

592
00:23:05,760 --> 00:23:06,640
this

593
00:23:06,640 --> 00:23:08,400
so we compromised two environments

594
00:23:08,400 --> 00:23:09,919
compromised to environments now let's

595
00:23:09,919 --> 00:23:12,240
take a look

596
00:23:12,240 --> 00:23:16,480
how can i try to get into this

597
00:23:16,480 --> 00:23:17,600
um

598
00:23:17,600 --> 00:23:20,559
this application

599
00:23:20,720 --> 00:23:23,679
um

600
00:23:23,679 --> 00:23:25,520
let me show you one more slide

601
00:23:25,520 --> 00:23:28,400
to to to just um

602
00:23:28,400 --> 00:23:31,039
give an idea what may be in our case an

603
00:23:31,039 --> 00:23:32,240
entry point

604
00:23:32,240 --> 00:23:35,760
so my goal my initial my my goal is to

605
00:23:35,760 --> 00:23:36,480
get

606
00:23:36,480 --> 00:23:38,960
access to database because all of the

607
00:23:38,960 --> 00:23:40,320
the most interesting things will be

608
00:23:40,320 --> 00:23:42,320
there

609
00:23:42,320 --> 00:23:44,720
but easier as you remember credentials

610
00:23:44,720 --> 00:23:47,600
are to access database will be stored

611
00:23:47,600 --> 00:23:50,960
in key vault

612
00:23:50,960 --> 00:23:52,960
let's first test if i have access to key

613
00:23:52,960 --> 00:23:55,039
vault or not i'm going to go to keyboard

614
00:23:55,039 --> 00:23:56,720
maybe this user that was compromised

615
00:23:56,720 --> 00:23:59,919
already have access to key vault

616
00:23:59,919 --> 00:24:04,640
let's see that if i go to secrets

617
00:24:04,640 --> 00:24:07,120
uh no there is no

618
00:24:07,120 --> 00:24:09,440
permissions to access key vault let me

619
00:24:09,440 --> 00:24:11,440
quickly give permissions to myself to

620
00:24:11,440 --> 00:24:13,120
just show you that

621
00:24:13,120 --> 00:24:15,360
um

622
00:24:15,679 --> 00:24:20,080
those something something exists there

623
00:24:21,600 --> 00:24:23,760
i'm gonna just give permission to list

624
00:24:23,760 --> 00:24:25,600
click add

625
00:24:25,600 --> 00:24:27,919
here and go back to secrets

626
00:24:27,919 --> 00:24:29,679
refresh

627
00:24:29,679 --> 00:24:31,600
no

628
00:24:31,600 --> 00:24:35,840
no damn it i didn't save it sorry

629
00:24:41,039 --> 00:24:42,480
let's try again

630
00:24:42,480 --> 00:24:46,720
click add and let's click save

631
00:24:46,720 --> 00:24:49,120
and now if i go to secrets i should yeah

632
00:24:49,120 --> 00:24:53,919
i have password here pass and username

633
00:24:53,919 --> 00:24:56,480
so let me remove this permission click

634
00:24:56,480 --> 00:24:59,120
save again

635
00:24:59,760 --> 00:25:02,080
and now let's try to

636
00:25:02,080 --> 00:25:05,120
somehow get access to

637
00:25:05,120 --> 00:25:07,039
to those secrets

638
00:25:07,039 --> 00:25:10,480
and for me entry point will be key

639
00:25:10,480 --> 00:25:12,640
rotation function because it's very

640
00:25:12,640 --> 00:25:15,120
commanded to have key rotation

641
00:25:15,120 --> 00:25:18,320
keys or secrets in my case rotation

642
00:25:18,320 --> 00:25:20,640
and on microsoft website you may even

643
00:25:20,640 --> 00:25:24,799
find the function that will rotate the

644
00:25:24,799 --> 00:25:27,200
secret in the keyboard and on the target

645
00:25:27,200 --> 00:25:29,600
application like sql database on our

646
00:25:29,600 --> 00:25:31,600
target

647
00:25:31,600 --> 00:25:33,440
so here's a slide

648
00:25:33,440 --> 00:25:34,880
with my

649
00:25:34,880 --> 00:25:36,720
with my function so i have a function

650
00:25:36,720 --> 00:25:38,559
and this function will

651
00:25:38,559 --> 00:25:41,440
like change password on in sql database

652
00:25:41,440 --> 00:25:44,400
and the key vault at the same time

653
00:25:44,400 --> 00:25:47,200
and what the typical problem that i find

654
00:25:47,200 --> 00:25:49,360
periodically

655
00:25:49,360 --> 00:25:51,600
in there in the real world

656
00:25:51,600 --> 00:25:54,159
when a function has different

657
00:25:54,159 --> 00:25:56,480
configuration compared to key vault so

658
00:25:56,480 --> 00:25:59,760
key vault may be very restrictive

659
00:25:59,760 --> 00:26:02,000
but the same time function

660
00:26:02,000 --> 00:26:04,480
will have also like reader permissions

661
00:26:04,480 --> 00:26:06,880
inherited from subscription

662
00:26:06,880 --> 00:26:09,360
and so function will have a bit more

663
00:26:09,360 --> 00:26:11,840
permissions so so users will have a bit

664
00:26:11,840 --> 00:26:14,000
more permissions on that function

665
00:26:14,000 --> 00:26:15,919
compared to key vault let me show you

666
00:26:15,919 --> 00:26:18,240
what i can do if i if i have a case like

667
00:26:18,240 --> 00:26:20,400
this

668
00:26:20,400 --> 00:26:22,080
so i'm going to go to

669
00:26:22,080 --> 00:26:23,520
portal

670
00:26:23,520 --> 00:26:26,320
and find functions

671
00:26:26,320 --> 00:26:28,400
function applications and here i have

672
00:26:28,400 --> 00:26:30,960
one function

673
00:26:30,960 --> 00:26:32,799
so let's take a look at what what do we

674
00:26:32,799 --> 00:26:34,559
have here

675
00:26:34,559 --> 00:26:36,640
in under one function application i have

676
00:26:36,640 --> 00:26:37,919
two functions

677
00:26:37,919 --> 00:26:40,480
one is triggered by event grid second

678
00:26:40,480 --> 00:26:42,400
one is triggered by http

679
00:26:42,400 --> 00:26:44,240
this one is will be more interesting for

680
00:26:44,240 --> 00:26:46,159
me because i can trigger that manually

681
00:26:46,159 --> 00:26:50,120
so let me show you the code

682
00:26:54,000 --> 00:26:55,279
come on

683
00:26:55,279 --> 00:26:56,320
and so

684
00:26:56,320 --> 00:26:58,559
uh by default when i deploy the function

685
00:26:58,559 --> 00:27:01,200
from um

686
00:27:01,200 --> 00:27:04,960
from microsoft github from from github

687
00:27:04,960 --> 00:27:07,760
it will show me the code like this

688
00:27:07,760 --> 00:27:10,799
so this code is is the legit code to

689
00:27:10,799 --> 00:27:13,200
rotate secret

690
00:27:13,200 --> 00:27:14,080
but

691
00:27:14,080 --> 00:27:16,080
what where maybe the problem the problem

692
00:27:16,080 --> 00:27:17,840
is

693
00:27:17,840 --> 00:27:20,799
by default function is ac may be

694
00:27:20,799 --> 00:27:22,000
accessed

695
00:27:22,000 --> 00:27:23,679
via ftp so if you look at the

696
00:27:23,679 --> 00:27:26,880
configuration of the function

697
00:27:29,360 --> 00:27:31,760
you may find that in general settings

698
00:27:31,760 --> 00:27:35,279
ftp is enabled by default

699
00:27:35,279 --> 00:27:39,760
most in most cases you don't use that

700
00:27:39,840 --> 00:27:42,320
but it's enabled by default

701
00:27:42,320 --> 00:27:44,720
and so if you go to the deployment

702
00:27:44,720 --> 00:27:46,480
center

703
00:27:46,480 --> 00:27:50,080
you may find ftp credentials here

704
00:27:50,080 --> 00:27:52,720
and so here's the ftp credentials so now

705
00:27:52,720 --> 00:27:54,880
let me try to get those credentials but

706
00:27:54,880 --> 00:27:56,880
of course as usual from command prompt

707
00:27:56,880 --> 00:27:59,760
um so let me open command prompt here

708
00:27:59,760 --> 00:28:03,120
and let's try to get

709
00:28:03,120 --> 00:28:05,360
first of all a url

710
00:28:05,360 --> 00:28:08,880
for fftp url to connect the function

711
00:28:08,880 --> 00:28:12,000
so here's the ftp url let me copy this

712
00:28:12,000 --> 00:28:12,960
and

713
00:28:12,960 --> 00:28:15,440
paste to filezilla and then i want to

714
00:28:15,440 --> 00:28:19,360
get credentials of this function

715
00:28:19,360 --> 00:28:21,679
of this function application and here's

716
00:28:21,679 --> 00:28:23,440
the username

717
00:28:23,440 --> 00:28:25,679
here's the username

718
00:28:25,679 --> 00:28:27,039
paste here

719
00:28:27,039 --> 00:28:29,919
and here is the password let me copy

720
00:28:29,919 --> 00:28:32,240
this

721
00:28:32,240 --> 00:28:34,640
here's the password

722
00:28:34,640 --> 00:28:36,880
and now i have

723
00:28:36,880 --> 00:28:38,880
permissions to log in there and i can

724
00:28:38,880 --> 00:28:41,120
see here the structure which is my two

725
00:28:41,120 --> 00:28:42,240
functions

726
00:28:42,240 --> 00:28:44,320
let me go to to the http function and

727
00:28:44,320 --> 00:28:46,000
here i can and here i can see the

728
00:28:46,000 --> 00:28:48,559
structure of the function what i can do

729
00:28:48,559 --> 00:28:53,279
i can upload i can upload my own code

730
00:28:53,279 --> 00:28:56,399
and so this code with the name called

731
00:28:56,399 --> 00:28:58,320
around.ps1 in this case it's the

732
00:28:58,320 --> 00:28:59,600
powerful function

733
00:28:59,600 --> 00:29:00,559
so

734
00:29:00,559 --> 00:29:03,039
i can upload my

735
00:29:03,039 --> 00:29:05,039
around.ps1 code

736
00:29:05,039 --> 00:29:07,200
and this code will be executed when

737
00:29:07,200 --> 00:29:08,720
function is triggered

738
00:29:08,720 --> 00:29:10,880
and so this function because the

739
00:29:10,880 --> 00:29:12,720
function has permissions to access

740
00:29:12,720 --> 00:29:15,279
keyboard i will access keyword and i

741
00:29:15,279 --> 00:29:16,880
will get information from keyboard on

742
00:29:16,880 --> 00:29:18,000
behalf

743
00:29:18,000 --> 00:29:19,679
of function

744
00:29:19,679 --> 00:29:22,480
and my my code will just get information

745
00:29:22,480 --> 00:29:25,200
i need from keyboard let's try that i'm

746
00:29:25,200 --> 00:29:27,600
going to just open powershell

747
00:29:27,600 --> 00:29:28,320
and

748
00:29:28,320 --> 00:29:31,439
run the command like this

749
00:29:31,600 --> 00:29:34,399
and so let's let's try to get

750
00:29:34,399 --> 00:29:38,799
credentials from from keyword

751
00:29:38,799 --> 00:29:40,960
fingers crossed i will get it also by

752
00:29:40,960 --> 00:29:43,600
the way i can go to function itself and

753
00:29:43,600 --> 00:29:45,039
and just

754
00:29:45,039 --> 00:29:46,559
take a look

755
00:29:46,559 --> 00:29:49,200
when it was any when it was executed if

756
00:29:49,200 --> 00:29:52,600
i click monitor

757
00:29:57,039 --> 00:29:59,279
um

758
00:30:01,440 --> 00:30:03,600
nothing here maybe already yeah it's

759
00:30:03,600 --> 00:30:06,399
ready give me give me information

760
00:30:06,399 --> 00:30:07,200
so

761
00:30:07,200 --> 00:30:09,520
um it's finished

762
00:30:09,520 --> 00:30:11,760
now i can see the username is web app

763
00:30:11,760 --> 00:30:14,399
and the password is password

764
00:30:14,399 --> 00:30:17,120
and those credentials are will be used

765
00:30:17,120 --> 00:30:19,120
to connect to

766
00:30:19,120 --> 00:30:20,480
sql server

767
00:30:20,480 --> 00:30:22,159
so let's try to connect the sql server

768
00:30:22,159 --> 00:30:24,320
now

769
00:30:24,320 --> 00:30:28,399
um so first let me take this url and

770
00:30:28,399 --> 00:30:31,120
type my password

771
00:30:31,120 --> 00:30:35,120
and now i can see i always connect it

772
00:30:35,120 --> 00:30:39,039
and i can see my database with tables

773
00:30:39,039 --> 00:30:42,799
and the content there

774
00:30:46,480 --> 00:30:49,200
and there's there's only one

775
00:30:49,200 --> 00:30:50,640
record there

776
00:30:50,640 --> 00:30:52,559
let me try to do the same from the

777
00:30:52,559 --> 00:30:54,320
different workstation let me just

778
00:30:54,320 --> 00:30:56,320
connect copy this

779
00:30:56,320 --> 00:30:59,799
from different workstation

780
00:31:05,519 --> 00:31:07,440
and now it says hey you can't do it

781
00:31:07,440 --> 00:31:10,320
because firewall does not allow you to

782
00:31:10,320 --> 00:31:13,918
connect to this server

783
00:31:14,159 --> 00:31:16,720
interesting uh let's take a look

784
00:31:16,720 --> 00:31:18,399
how this fire will look like

785
00:31:18,399 --> 00:31:21,120
now let's go to database

786
00:31:21,120 --> 00:31:22,960
and open this database

787
00:31:22,960 --> 00:31:25,279
so every sql database in the cloud has

788
00:31:25,279 --> 00:31:29,039
this uh the sql server has the firewall

789
00:31:29,039 --> 00:31:31,840
database as well by the way so if i if i

790
00:31:31,840 --> 00:31:34,240
if i click firewall i can find here very

791
00:31:34,240 --> 00:31:36,399
interesting configuration which is very

792
00:31:36,399 --> 00:31:38,559
very typical

793
00:31:38,559 --> 00:31:42,159
uh this firewall this firewall has this

794
00:31:42,159 --> 00:31:44,480
option enabled it says allow azure

795
00:31:44,480 --> 00:31:46,640
services and the resources to access

796
00:31:46,640 --> 00:31:48,880
this server

797
00:31:48,880 --> 00:31:50,559
what does it mean

798
00:31:50,559 --> 00:31:53,120
many people think that it means that

799
00:31:53,120 --> 00:31:55,919
their azure virtual machines their azure

800
00:31:55,919 --> 00:31:57,760
services may access

801
00:31:57,760 --> 00:32:00,240
this database but in fact it is not

802
00:32:00,240 --> 00:32:01,840
really true

803
00:32:01,840 --> 00:32:05,120
this option means that any

804
00:32:05,120 --> 00:32:07,200
any once again any

805
00:32:07,200 --> 00:32:10,880
azure ip address will be able to access

806
00:32:10,880 --> 00:32:13,120
this sql server

807
00:32:13,120 --> 00:32:14,480
so

808
00:32:14,480 --> 00:32:15,360
a

809
00:32:15,360 --> 00:32:16,640
from any

810
00:32:16,640 --> 00:32:19,679
from any customer subscription from any

811
00:32:19,679 --> 00:32:22,559
content from any country in the world

812
00:32:22,559 --> 00:32:25,519
you will be able to access

813
00:32:25,519 --> 00:32:27,279
your sql server

814
00:32:27,279 --> 00:32:29,360
firewall will not filter that at least

815
00:32:29,360 --> 00:32:31,600
if you have this option enabled

816
00:32:31,600 --> 00:32:34,559
so quite often

817
00:32:34,880 --> 00:32:36,880
the the it professionals in company

818
00:32:36,880 --> 00:32:38,399
security professionals they don't really

819
00:32:38,399 --> 00:32:39,519
understand

820
00:32:39,519 --> 00:32:43,200
the impact of this option so if i have

821
00:32:43,200 --> 00:32:45,519
this option enabled then

822
00:32:45,519 --> 00:32:48,159
any virtual machine in azure from with

823
00:32:48,159 --> 00:32:50,480
azure ap address may have access to my

824
00:32:50,480 --> 00:32:55,080
sql let me disable this

825
00:32:56,320 --> 00:32:59,200
um and let's try to innate

826
00:32:59,200 --> 00:33:01,919
in allow only

827
00:33:01,919 --> 00:33:05,279
um only private access so there is no

828
00:33:05,279 --> 00:33:07,440
public access at all

829
00:33:07,440 --> 00:33:08,880
now

830
00:33:08,880 --> 00:33:11,840
now

831
00:33:11,840 --> 00:33:15,200
um my sequel is probably better

832
00:33:15,200 --> 00:33:17,039
now um

833
00:33:17,039 --> 00:33:20,000
i have credentials but acts allowed only

834
00:33:20,000 --> 00:33:23,440
from internal network so i cannot access

835
00:33:23,440 --> 00:33:27,039
from from anywhere

836
00:33:27,279 --> 00:33:30,880
is it possible to get into database

837
00:33:30,880 --> 00:33:31,919
yeah

838
00:33:31,919 --> 00:33:36,240
if we compromise the application itself

839
00:33:36,240 --> 00:33:38,640
and so from application we can get

840
00:33:38,640 --> 00:33:41,919
access to sql database let's try to do

841
00:33:41,919 --> 00:33:45,200
to do it let me go back to

842
00:33:45,200 --> 00:33:47,919
my portal and i'm going to open

843
00:33:47,919 --> 00:33:50,480
application

844
00:33:50,840 --> 00:33:53,679
um so if i just

845
00:33:53,679 --> 00:33:56,159
uh go to application configuration you

846
00:33:56,159 --> 00:33:57,919
may find here network and if i click

847
00:33:57,919 --> 00:34:00,320
configure networking it says hey you

848
00:34:00,320 --> 00:34:02,000
must have a standard

849
00:34:02,000 --> 00:34:04,480
tier if you want to work with networking

850
00:34:04,480 --> 00:34:08,719
so let me upgrade my application to s1

851
00:34:15,119 --> 00:34:17,839
and so now i can connect my application

852
00:34:17,839 --> 00:34:19,839
to network let me do it real quick so

853
00:34:19,839 --> 00:34:22,480
i'm going to say

854
00:34:22,960 --> 00:34:24,480
add v-net

855
00:34:24,480 --> 00:34:27,599
and i want to connect my application to

856
00:34:27,599 --> 00:34:29,839
virtual network

857
00:34:29,839 --> 00:34:31,040
click ok

858
00:34:31,040 --> 00:34:33,440
and so that will take some time before

859
00:34:33,440 --> 00:34:37,520
this application will be able to connect

860
00:34:37,760 --> 00:34:40,320
so as you can see here it's already con

861
00:34:40,320 --> 00:34:42,079
it's just connected but

862
00:34:42,079 --> 00:34:43,918
in reality

863
00:34:43,918 --> 00:34:45,760
what i can do i can

864
00:34:45,760 --> 00:34:47,760
really quickly restart this application

865
00:34:47,760 --> 00:34:48,399
to

866
00:34:48,399 --> 00:34:50,639
speed things up

867
00:34:50,639 --> 00:34:55,359
so now if i compromise this application

868
00:34:55,359 --> 00:34:59,839
i will be able i should be able to

869
00:35:00,320 --> 00:35:02,960
get into database uh the quite common

870
00:35:02,960 --> 00:35:04,240
question wait a second but how to

871
00:35:04,240 --> 00:35:06,079
compromise application especially if you

872
00:35:06,079 --> 00:35:09,680
look at them if you hear there's a vaf

873
00:35:09,680 --> 00:35:12,079
application firewall will not allow me

874
00:35:12,079 --> 00:35:15,119
to just simply get into application

875
00:35:15,119 --> 00:35:18,160
uh yes but i just want to remind you i

876
00:35:18,160 --> 00:35:20,240
just want to really remind you that we

877
00:35:20,240 --> 00:35:22,640
have for web application the same

878
00:35:22,640 --> 00:35:26,800
default configuration ftp is allowed

879
00:35:26,800 --> 00:35:28,839
if i go click

880
00:35:28,839 --> 00:35:31,359
configuration and go to general settings

881
00:35:31,359 --> 00:35:33,920
i may find here ftp is allowed by

882
00:35:33,920 --> 00:35:36,320
default

883
00:35:36,320 --> 00:35:38,720
so quite often companies they do not

884
00:35:38,720 --> 00:35:41,760
disable this ftp and in the same manner

885
00:35:41,760 --> 00:35:45,040
i can get into

886
00:35:45,040 --> 00:35:47,200
this application as before

887
00:35:47,200 --> 00:35:48,800
let me try to do it

888
00:35:48,800 --> 00:35:53,200
so let me close this and this

889
00:35:53,359 --> 00:35:54,640
um

890
00:35:54,640 --> 00:35:58,000
now if i just

891
00:35:58,000 --> 00:36:00,480
try the same

892
00:36:00,480 --> 00:36:01,680
let me find

893
00:36:01,680 --> 00:36:06,078
a ftp url of the application

894
00:36:09,920 --> 00:36:13,400
copy this

895
00:36:15,599 --> 00:36:18,720
and credentials as well

896
00:36:20,880 --> 00:36:22,240
and so let me

897
00:36:22,240 --> 00:36:26,598
type credentials as well

898
00:36:31,440 --> 00:36:33,280
so as you can see here this application

899
00:36:33,280 --> 00:36:36,560
is nothing more than just a php page and

900
00:36:36,560 --> 00:36:37,760
let's let's first explore this

901
00:36:37,760 --> 00:36:39,599
application that

902
00:36:39,599 --> 00:36:41,040
we'll just check that application is

903
00:36:41,040 --> 00:36:42,079
working

904
00:36:42,079 --> 00:36:45,040
let me open the application itself let's

905
00:36:45,040 --> 00:36:47,280
click here

906
00:36:47,280 --> 00:36:49,040
i can see the application is here an

907
00:36:49,040 --> 00:36:51,520
application is working so let me just

908
00:36:51,520 --> 00:36:53,440
take a look if i say

909
00:36:53,440 --> 00:36:58,640
i'm a user let's call myself michael

910
00:36:58,640 --> 00:37:00,799
and

911
00:37:02,320 --> 00:37:05,839
let's say my email is m smith whatever

912
00:37:05,839 --> 00:37:08,720
it may be whatever that whatever.com

913
00:37:08,720 --> 00:37:10,560
and let's say submit

914
00:37:10,560 --> 00:37:12,320
this this is working so it's working the

915
00:37:12,320 --> 00:37:14,720
database application is working now let

916
00:37:14,720 --> 00:37:17,200
me jump back to

917
00:37:17,200 --> 00:37:19,680
my filezilla and now what i can do if i

918
00:37:19,680 --> 00:37:22,560
if i know that this application is php

919
00:37:22,560 --> 00:37:26,800
what i can do i can upload my shell

920
00:37:26,800 --> 00:37:29,920
and you know that php and sp as well by

921
00:37:29,920 --> 00:37:30,960
the way

922
00:37:30,960 --> 00:37:33,440
they they are executed on the server

923
00:37:33,440 --> 00:37:36,640
side so the php will be executed on the

924
00:37:36,640 --> 00:37:38,960
server side not on the client side

925
00:37:38,960 --> 00:37:42,720
so if i can upload my my own php code i

926
00:37:42,720 --> 00:37:45,040
can execute something on server let me

927
00:37:45,040 --> 00:37:47,839
just run my shell and look at this

928
00:37:47,839 --> 00:37:51,839
so now i have access to

929
00:37:52,079 --> 00:37:54,880
this workstation or the server through

930
00:37:54,880 --> 00:37:56,240
web shell

931
00:37:56,240 --> 00:37:58,320
web shell not not super interactive so

932
00:37:58,320 --> 00:38:00,720
let me

933
00:38:00,800 --> 00:38:05,240
establish establish the better shell

934
00:38:07,920 --> 00:38:10,560
so on my web shell i want to

935
00:38:10,560 --> 00:38:11,839
to

936
00:38:11,839 --> 00:38:14,640
fix the shell i want to make shell

937
00:38:14,640 --> 00:38:15,920
better

938
00:38:15,920 --> 00:38:17,280
and so

939
00:38:17,280 --> 00:38:18,720
now i have a shell

940
00:38:18,720 --> 00:38:20,960
uh all right so what i can what what i

941
00:38:20,960 --> 00:38:22,960
found here that

942
00:38:22,960 --> 00:38:25,520
my username is just a regular user not

943
00:38:25,520 --> 00:38:28,720
the web server web server user

944
00:38:28,720 --> 00:38:31,040
usually usually low pre low privileged

945
00:38:31,040 --> 00:38:32,720
user so i will not be able to do

946
00:38:32,720 --> 00:38:34,960
whatever i want on this server

947
00:38:34,960 --> 00:38:38,480
my goal is to connect to sql database

948
00:38:38,480 --> 00:38:41,920
but the problem is that a regular server

949
00:38:41,920 --> 00:38:44,560
doesn't have tools to connect to sql

950
00:38:44,560 --> 00:38:47,040
server

951
00:38:47,040 --> 00:38:49,920
um i need some sort of management studio

952
00:38:49,920 --> 00:38:51,920
for linux linux of course not visual

953
00:38:51,920 --> 00:38:53,680
studio it's not management studio it

954
00:38:53,680 --> 00:38:57,119
will be like a sql cli but to install

955
00:38:57,119 --> 00:38:59,920
that i must be an admin i have i must

956
00:38:59,920 --> 00:39:01,359
have pseudo permissions or root

957
00:39:01,359 --> 00:39:03,920
permissions i don't have it

958
00:39:03,920 --> 00:39:05,520
so what i can do here

959
00:39:05,520 --> 00:39:07,040
i can use some

960
00:39:07,040 --> 00:39:09,119
third-party tools and the tool that you

961
00:39:09,119 --> 00:39:11,839
may try called usql

962
00:39:11,839 --> 00:39:14,000
this tool will run without insta will

963
00:39:14,000 --> 00:39:15,920
work without installation

964
00:39:15,920 --> 00:39:18,720
and so using usql i will try to connect

965
00:39:18,720 --> 00:39:22,400
to sql database i'm going to say

966
00:39:22,400 --> 00:39:25,119
connect using g sql and looks like i was

967
00:39:25,119 --> 00:39:29,800
connected let's try to list tables

968
00:39:31,200 --> 00:39:33,599
and look at this i can see two tables

969
00:39:33,599 --> 00:39:35,520
there

970
00:39:35,520 --> 00:39:40,280
so let's try to list the content

971
00:39:42,720 --> 00:39:45,839
and look at this so my jundo and my

972
00:39:45,839 --> 00:39:48,480
michael user are there

973
00:39:48,480 --> 00:39:52,400
so now i have access to sql database

974
00:39:52,400 --> 00:39:53,280
so

975
00:39:53,280 --> 00:39:54,560
uh i hope

976
00:39:54,560 --> 00:39:57,040
all of this was informative and you get

977
00:39:57,040 --> 00:39:58,880
an idea how those things may be

978
00:39:58,880 --> 00:40:01,119
compromised and we finally reached to

979
00:40:01,119 --> 00:40:02,720
the end of the session

980
00:40:02,720 --> 00:40:05,119
please use new knowledge that you got

981
00:40:05,119 --> 00:40:06,720
from this session

982
00:40:06,720 --> 00:40:08,960
um and

983
00:40:08,960 --> 00:40:10,880
go ahead and ask your questions if you

984
00:40:10,880 --> 00:40:13,280
have them so thank you very much for

985
00:40:13,280 --> 00:40:16,240
your participation see you next time bye

986
00:40:16,240 --> 00:40:19,240
bye

