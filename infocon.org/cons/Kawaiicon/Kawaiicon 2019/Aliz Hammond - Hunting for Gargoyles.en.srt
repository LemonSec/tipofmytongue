1
00:00:02,570 --> 00:00:06,660
awesome cool so they start to put on it

2
00:00:05,400 --> 00:00:08,760
sparkles before I came out and I was

3
00:00:06,660 --> 00:00:09,059
like sparkles cool sounds fun let's do

4
00:00:08,760 --> 00:00:12,090
that

5
00:00:09,059 --> 00:00:13,678
so yeah fantastic so hello hello kawaii

6
00:00:12,090 --> 00:00:18,090
Kon how are you doing I hope you all

7
00:00:13,679 --> 00:00:21,240
awake and more than I am at midday maybe

8
00:00:18,090 --> 00:00:22,859
so yes anyway I'm here I'm here to speak

9
00:00:21,240 --> 00:00:26,970
about my my talk

10
00:00:22,859 --> 00:00:30,029
hunting for gargoyles it's a little bit

11
00:00:26,970 --> 00:00:31,830
of a last-minute filling in slot so

12
00:00:30,029 --> 00:00:33,030
apologies in advance if the slide deck

13
00:00:31,830 --> 00:00:34,920
is a little bit too corporate

14
00:00:33,030 --> 00:00:37,530
not as kawaii as it could have could

15
00:00:34,920 --> 00:00:39,600
have been I tried there's a little bit

16
00:00:37,530 --> 00:00:41,280
of Kauai in there so quick agenda for

17
00:00:39,600 --> 00:00:43,860
get started and I talked about who I am

18
00:00:41,280 --> 00:00:45,480
Bobby very very very briefly don't worry

19
00:00:43,860 --> 00:00:47,670
because this is the first time I've been

20
00:00:45,480 --> 00:00:49,769
in go icon or Kiwi Con or New Zealand

21
00:00:47,670 --> 00:00:56,250
all nice country thank you for having me

22
00:00:49,770 --> 00:00:59,070
in it yeah I have talked very briefly

23
00:00:56,250 --> 00:01:00,600
about be the attack itself gargoyle very

24
00:00:59,070 --> 00:01:02,670
brief leaks on your favorite time slot

25
00:01:00,600 --> 00:01:04,019
and this is the slot just for lunch so I

26
00:01:02,670 --> 00:01:05,760
don't want to open one because then I'll

27
00:01:04,019 --> 00:01:07,650
be very hungry then I'll talk about

28
00:01:05,760 --> 00:01:09,210
detection which is the the interesting

29
00:01:07,650 --> 00:01:10,619
cool stuff where we'll talk about you

30
00:01:09,210 --> 00:01:13,259
know the kernel and all that all that

31
00:01:10,619 --> 00:01:14,909
jazz and then I'll talk a little bit

32
00:01:13,260 --> 00:01:17,759
about automating attack and automating

33
00:01:14,909 --> 00:01:20,400
automating the detection and kind of

34
00:01:17,759 --> 00:01:22,610
pitfalls that it's easy to fall into and

35
00:01:20,400 --> 00:01:27,869
the things to look out for when doing so

36
00:01:22,610 --> 00:01:29,340
so first off about me I'm Alice Hammond

37
00:01:27,869 --> 00:01:30,000
don't worry uh pronouncing my name wrong

38
00:01:29,340 --> 00:01:33,450
everyone does it

39
00:01:30,000 --> 00:01:35,670
don't worry I'm based in Singapore been

40
00:01:33,450 --> 00:01:38,159
there for about three four years ish I'm

41
00:01:35,670 --> 00:01:42,420
all the way from England as you can see

42
00:01:38,159 --> 00:01:43,890
from this fantastic chap who is yes yes

43
00:01:42,420 --> 00:01:46,770
well if you follow British politics you

44
00:01:43,890 --> 00:01:48,630
probably recognize the picture my

45
00:01:46,770 --> 00:01:50,850
background is in kind of bug finding

46
00:01:48,630 --> 00:01:53,850
exploitation I like fuzzing things I

47
00:01:50,850 --> 00:01:56,219
like wearing exploits so like yeah I

48
00:01:53,850 --> 00:01:57,390
don't say breaking things but kind of

49
00:01:56,219 --> 00:02:00,419
breaking things and fixing them

50
00:01:57,390 --> 00:02:03,149
sometimes yeah hobbies wise I'm into

51
00:02:00,420 --> 00:02:04,619
like DIY chess electronics old computers

52
00:02:03,149 --> 00:02:05,820
if anyone knows if I wants to talk about

53
00:02:04,619 --> 00:02:09,360
computers come and talk to be out there

54
00:02:05,820 --> 00:02:11,129
fun stuff because I like to dabble in

55
00:02:09,360 --> 00:02:13,470
electronics kind of digital electronics

56
00:02:11,129 --> 00:02:15,030
because I'm a logs too hard for me but I

57
00:02:13,470 --> 00:02:18,810
doubling digital electronics and that

58
00:02:15,030 --> 00:02:21,390
has given me this mindset of when I

59
00:02:18,810 --> 00:02:23,460
approach a computer problem about

60
00:02:21,390 --> 00:02:25,019
detection of malware I'll come from the

61
00:02:23,460 --> 00:02:27,480
bottom up I'll start looking at the

62
00:02:25,020 --> 00:02:30,150
kernel first and move upwards as opposed

63
00:02:27,480 --> 00:02:31,950
to an upwards an upward down approach of

64
00:02:30,150 --> 00:02:34,080
looking at web browser and then all that

65
00:02:31,950 --> 00:02:38,730
stuff it's just a orientation of my

66
00:02:34,080 --> 00:02:42,090
mindset maybe my my role it's a f-secure

67
00:02:38,730 --> 00:02:44,340
counter sept is that I'm a researcher

68
00:02:42,090 --> 00:02:48,120
supporting threat hunters so all my time

69
00:02:44,340 --> 00:02:52,560
is spent doing research into real world

70
00:02:48,120 --> 00:02:53,910
attacks okay I say that and then at the

71
00:02:52,560 --> 00:02:55,320
end the first question I always get

72
00:02:53,910 --> 00:02:56,730
after this talk is have you seen this

73
00:02:55,320 --> 00:03:00,510
attack in the wild and I have to say no

74
00:02:56,730 --> 00:03:05,429
so I die I look into real world attacks

75
00:03:00,510 --> 00:03:07,590
and this one so I'm I'm not I'm not fond

76
00:03:05,430 --> 00:03:09,420
of myself so I'm not like up-to-date

77
00:03:07,590 --> 00:03:11,730
with all like the latest apts and

78
00:03:09,420 --> 00:03:13,470
threats typically I'm kind of a point of

79
00:03:11,730 --> 00:03:15,179
elevation for the hunting team that

80
00:03:13,470 --> 00:03:17,220
they'll spend they have like an amount

81
00:03:15,180 --> 00:03:18,120
of time that's budgeted to research and

82
00:03:17,220 --> 00:03:19,830
if something's gonna go over that

83
00:03:18,120 --> 00:03:22,290
they'll they'll throw off to me and I'll

84
00:03:19,830 --> 00:03:24,300
have to like go and stare at it

85
00:03:22,290 --> 00:03:27,239
repeatedly until it gets in the

86
00:03:24,300 --> 00:03:29,400
submission and I figure it out anyway on

87
00:03:27,239 --> 00:03:31,650
to the first on to the first section of

88
00:03:29,400 --> 00:03:33,989
what what is gargoyle since it's it's

89
00:03:31,650 --> 00:03:35,880
not not particularly well known I think

90
00:03:33,989 --> 00:03:38,070
it should be but to really describe it

91
00:03:35,880 --> 00:03:39,780
well I need to put go into a bit of

92
00:03:38,070 --> 00:03:42,060
historical context and I'm sure you I'm

93
00:03:39,780 --> 00:03:43,440
sure you all on all I'm guessing a lot

94
00:03:42,060 --> 00:03:44,820
of you might know this already if you if

95
00:03:43,440 --> 00:03:46,170
you do like malware research and that

96
00:03:44,820 --> 00:03:46,950
kind of thing stick with me okay

97
00:03:46,170 --> 00:03:51,179
interesting

98
00:03:46,950 --> 00:03:53,040
promise so if we think back to back in

99
00:03:51,180 --> 00:03:55,290
the day you know the 2000s kind of over

100
00:03:53,040 --> 00:03:56,970
when malware came onto your system

101
00:03:55,290 --> 00:03:58,679
speaking from purely Windows perspective

102
00:03:56,970 --> 00:04:00,209
here when malware came into your system

103
00:03:58,680 --> 00:04:03,180
it would use some bug wake into your

104
00:04:00,209 --> 00:04:05,489
system and then typically do offer some

105
00:04:03,180 --> 00:04:08,220
kind of malicious executable so it might

106
00:04:05,489 --> 00:04:10,110
be no back over face of seven you know

107
00:04:08,220 --> 00:04:11,370
that kind of error look at it would be

108
00:04:10,110 --> 00:04:12,600
written to your disk and then the

109
00:04:11,370 --> 00:04:14,790
register of modified so that would be

110
00:04:12,600 --> 00:04:18,120
loaded and all that jazz so the industry

111
00:04:14,790 --> 00:04:19,738
responded with anti viruses that would

112
00:04:18,120 --> 00:04:23,280
examine every file on the disk and look

113
00:04:19,738 --> 00:04:25,380
for suspicious things but one thing I do

114
00:04:23,280 --> 00:04:27,510
on earth so point out here is that when

115
00:04:25,380 --> 00:04:30,990
this was done there was usually a

116
00:04:27,510 --> 00:04:34,830
yeah well almost always a filter on file

117
00:04:30,990 --> 00:04:37,230
types so if someone has a gigantic 10

118
00:04:34,830 --> 00:04:39,260
megabyte bitmap image the antivirus

119
00:04:37,230 --> 00:04:41,970
wouldn't scan through it for like an MBR

120
00:04:39,260 --> 00:04:43,469
an MBR infector because that would just

121
00:04:41,970 --> 00:04:46,320
be silly and it would take too long and

122
00:04:43,470 --> 00:04:48,180
it's if in contrast to it being an

123
00:04:46,320 --> 00:04:49,380
optimization to make things faster it's

124
00:04:48,180 --> 00:04:52,650
more of an optimization to make things

125
00:04:49,380 --> 00:04:55,469
like usable and possible is a relic I

126
00:04:52,650 --> 00:04:58,590
don't know if you can see but this is

127
00:04:55,470 --> 00:05:01,080
the blaster worm from back in the day

128
00:04:58,590 --> 00:05:04,200
complete with you know vitriol to poor

129
00:05:01,080 --> 00:05:06,060
mr. Bill Gates anyway after that over

130
00:05:04,200 --> 00:05:08,460
time frames are very very what

131
00:05:06,060 --> 00:05:10,500
approximately after a ver people started

132
00:05:08,460 --> 00:05:12,060
dropping their malware into memory and

133
00:05:10,500 --> 00:05:14,970
running systems wants to avoid hitting

134
00:05:12,060 --> 00:05:16,860
the disk avoid its detection so because

135
00:05:14,970 --> 00:05:19,290
of that we start ced our tools that

136
00:05:16,860 --> 00:05:21,600
words a examine system memory in real

137
00:05:19,290 --> 00:05:23,610
time scan for badness that kind of thing

138
00:05:21,600 --> 00:05:25,920
and again they these tools will filter

139
00:05:23,610 --> 00:05:27,750
based on memory permissions so if you

140
00:05:25,920 --> 00:05:30,270
had a system that had say eight

141
00:05:27,750 --> 00:05:32,880
gigabytes of ram in it you couldn't

142
00:05:30,270 --> 00:05:35,070
really you couldn't feasibly scan that

143
00:05:32,880 --> 00:05:38,700
at the kind of real-time speeds you want

144
00:05:35,070 --> 00:05:40,800
to be able to scan without excluding all

145
00:05:38,700 --> 00:05:42,349
the memory there isn't maps xq ball so

146
00:05:40,800 --> 00:05:45,030
again if you've got your gigantic or

147
00:05:42,350 --> 00:05:47,160
you've got your giant 800 megabyte

148
00:05:45,030 --> 00:05:49,440
bitmap image say then you don't be

149
00:05:47,160 --> 00:05:50,640
scanning that for signs of infection see

150
00:05:49,440 --> 00:05:52,260
you would filter based on the memory

151
00:05:50,640 --> 00:05:54,450
permissions of the CPUs got so on

152
00:05:52,260 --> 00:05:56,310
here's i try to get a good example this

153
00:05:54,450 --> 00:05:58,530
is as good as I could get here's a an

154
00:05:56,310 --> 00:06:01,440
executable memory range which might

155
00:05:58,530 --> 00:06:04,349
contain some malware so the whole

156
00:06:01,440 --> 00:06:06,930
gargoyle attack is an evolution of that

157
00:06:04,350 --> 00:06:09,720
I think to some degree and it works by

158
00:06:06,930 --> 00:06:11,340
hiding this code in hiding malicious

159
00:06:09,720 --> 00:06:14,100
code in areas of memory which aren't

160
00:06:11,340 --> 00:06:16,919
executable it's a really it's a really

161
00:06:14,100 --> 00:06:18,750
nice it's really cool attack it's been

162
00:06:16,920 --> 00:06:23,010
around for a couple of years I say the

163
00:06:18,750 --> 00:06:25,280
POC was out March 2017 and there's no or

164
00:06:23,010 --> 00:06:27,330
until I did this research there was no

165
00:06:25,280 --> 00:06:29,130
detection method at least that I'm aware

166
00:06:27,330 --> 00:06:31,109
of that I could find to make my googling

167
00:06:29,130 --> 00:06:33,300
stalls weren't weren't up to it here's

168
00:06:31,110 --> 00:06:35,280
my my screenshot all I'm saying here is

169
00:06:33,300 --> 00:06:36,930
all we've got here is some memory that's

170
00:06:35,280 --> 00:06:38,729
readable read right there could be

171
00:06:36,930 --> 00:06:39,500
badness lurking in there and we wouldn't

172
00:06:38,730 --> 00:06:42,629
know about it

173
00:06:39,500 --> 00:06:44,879
Victor I don't know as I as I alluded

174
00:06:42,629 --> 00:06:47,490
earlier I'm sorry there's nowhere we

175
00:06:44,879 --> 00:06:48,689
haven't seen this in the wild but this

176
00:06:47,490 --> 00:06:51,210
could be because you know it's hard to

177
00:06:48,689 --> 00:06:53,219
detect we have seen our bone red seen

178
00:06:51,210 --> 00:06:56,878
using it though this is a post by one of

179
00:06:53,219 --> 00:06:58,949
our guys Wilbur guess back in 2018 it's

180
00:06:56,879 --> 00:07:01,830
I say one of our guys I'm sorry we were

181
00:06:58,949 --> 00:07:03,300
we were acquired where we used to be MWR

182
00:07:01,830 --> 00:07:05,729
and we were acquired by f-secure so

183
00:07:03,300 --> 00:07:08,039
sorry about the the confusion there but

184
00:07:05,729 --> 00:07:09,719
this is one of our guys to the cobalt

185
00:07:08,039 --> 00:07:12,419
strike beacon and modified it to use

186
00:07:09,719 --> 00:07:14,400
gargoyle such that it's much more

187
00:07:12,419 --> 00:07:17,508
stealthy so we don't see it in the world

188
00:07:14,400 --> 00:07:21,719
but we use it not sure if that counts

189
00:07:17,509 --> 00:07:23,610
okay so on words to talk about what it

190
00:07:21,719 --> 00:07:26,099
is so as I alluded to before it's a

191
00:07:23,610 --> 00:07:28,349
method of hiding executable payloads and

192
00:07:26,099 --> 00:07:31,878
malware in non-executable memory which

193
00:07:28,349 --> 00:07:35,520
is you know quite a feat given the

194
00:07:31,879 --> 00:07:38,490
difficulty of subverting that this

195
00:07:35,520 --> 00:07:40,979
executable code is very briefly made

196
00:07:38,490 --> 00:07:42,930
executable in a kind of time window and

197
00:07:40,979 --> 00:07:46,110
I say very briefly there's there's a POC

198
00:07:42,930 --> 00:07:50,599
of the attack which I think I think it's

199
00:07:46,110 --> 00:07:53,520
every five minutes or five loops okay

200
00:07:50,599 --> 00:07:55,020
every so often it will sleep for a while

201
00:07:53,520 --> 00:07:57,628
and then pop a message box and say hello

202
00:07:55,020 --> 00:07:58,948
so you could have your your your malware

203
00:07:57,629 --> 00:08:01,650
implant could sit there I could sleep

204
00:07:58,949 --> 00:08:04,020
for five seconds come up for like 100

205
00:08:01,650 --> 00:08:06,029
milliseconds make itself excusable run

206
00:08:04,020 --> 00:08:07,680
itself go back to sleep and unless

207
00:08:06,029 --> 00:08:10,050
you're a dr tool is scanning right at

208
00:08:07,680 --> 00:08:10,650
right at the right moment just at the

209
00:08:10,050 --> 00:08:13,949
right moment

210
00:08:10,650 --> 00:08:15,870
then you're gonna miss it no good so

211
00:08:13,949 --> 00:08:17,370
here's a fantastic animated gif that i

212
00:08:15,870 --> 00:08:18,569
found online and I found this gif and I

213
00:08:17,370 --> 00:08:19,490
was like there's no way I'm not doing

214
00:08:18,569 --> 00:08:23,849
that in my presentation

215
00:08:19,490 --> 00:08:26,819
here's his - - threat hunters I guess

216
00:08:23,849 --> 00:08:28,620
who are with a client system in the

217
00:08:26,819 --> 00:08:30,960
center in gray and they've gone through

218
00:08:28,620 --> 00:08:32,789
this system with their EDR tools and

219
00:08:30,960 --> 00:08:34,198
their forensic tools and of like note

220
00:08:32,789 --> 00:08:35,968
there's there's no baddies on this

221
00:08:34,198 --> 00:08:37,948
machine this is completely clean

222
00:08:35,969 --> 00:08:39,750
there's no APC there's nothing here it's

223
00:08:37,948 --> 00:08:42,750
all good it's so clean they're gonna get

224
00:08:39,750 --> 00:08:45,140
selfie with with the picture itself but

225
00:08:42,750 --> 00:08:48,200
what they don't know is this gargoyle

226
00:08:45,140 --> 00:08:50,810
becomes magically animated

227
00:08:48,200 --> 00:08:52,880
I love this guy's expression man it's

228
00:08:50,810 --> 00:08:56,719
just like it is priceless

229
00:08:52,880 --> 00:08:59,779
yeah fantastic fantastic oh I could look

230
00:08:56,720 --> 00:09:01,279
at that all day okay I'm gonna sorry

231
00:08:59,779 --> 00:09:04,430
advance the slide so I don't look at it

232
00:09:01,279 --> 00:09:06,529
all dates so anyway the hope the whole

233
00:09:04,430 --> 00:09:07,699
thing of the The Gargoyle of Mythology

234
00:09:06,529 --> 00:09:08,930
you know States staying there for

235
00:09:07,699 --> 00:09:10,430
hundreds of years and then becoming

236
00:09:08,930 --> 00:09:13,969
magically animated one day and all that

237
00:09:10,430 --> 00:09:15,560
it's not that kind of thing so you might

238
00:09:13,970 --> 00:09:17,930
be thinking this is easy to do by having

239
00:09:15,560 --> 00:09:20,149
a small stub of code that you have like

240
00:09:17,930 --> 00:09:21,589
your main malware is all non-executable

241
00:09:20,149 --> 00:09:23,300
and then you have a tiny little stub

242
00:09:21,589 --> 00:09:25,250
which is in charge of waking up the main

243
00:09:23,300 --> 00:09:28,819
payload and making it keep on calling it

244
00:09:25,250 --> 00:09:30,380
but Gargoyle it doesn't do that and this

245
00:09:28,820 --> 00:09:34,370
is where it's such a cute it's at such a

246
00:09:30,380 --> 00:09:37,100
kawaii attack it has it has no X cubed

247
00:09:34,370 --> 00:09:39,019
at all during the dormant dormant stage

248
00:09:37,100 --> 00:09:40,190
and this is why I kind of really like it

249
00:09:39,019 --> 00:09:43,880
and think it's a really cool kind of

250
00:09:40,190 --> 00:09:46,399
thing so the way it kind of gets around

251
00:09:43,880 --> 00:09:48,560
this is it all the way it wakes itself

252
00:09:46,399 --> 00:09:50,209
up is by abusing system facilities and

253
00:09:48,560 --> 00:09:53,630
the system facility uses is a system

254
00:09:50,209 --> 00:09:55,550
timer which is a Windows feature the

255
00:09:53,630 --> 00:09:57,890
windows provides so just since it's just

256
00:09:55,550 --> 00:09:59,050
a callback but the callback obviously

257
00:09:57,890 --> 00:10:02,089
you can't call non-executable memory

258
00:09:59,050 --> 00:10:04,579
without like access faulting so without

259
00:10:02,089 --> 00:10:07,940
faulting and badness happening so to get

260
00:10:04,579 --> 00:10:11,449
around the lack of executable memory we

261
00:10:07,940 --> 00:10:12,890
do of the gargle attack does the use the

262
00:10:11,449 --> 00:10:14,990
same techniques to exploit writers been

263
00:10:12,890 --> 00:10:18,079
using for years right which is the magic

264
00:10:14,990 --> 00:10:21,350
of the blockchain so your system timer

265
00:10:18,079 --> 00:10:23,630
simply points to a stack pivot and then

266
00:10:21,350 --> 00:10:24,829
there's a rope chain that calls virtual

267
00:10:23,630 --> 00:10:27,140
protect makes the main malware

268
00:10:24,829 --> 00:10:28,849
executable invokes it and then when it

269
00:10:27,140 --> 00:10:30,880
returns makes it not execute once again

270
00:10:28,850 --> 00:10:33,410
and goes back to sleep

271
00:10:30,880 --> 00:10:35,390
so deter the attack can be summarized

272
00:10:33,410 --> 00:10:38,089
pretty much as a system timer

273
00:10:35,390 --> 00:10:41,089
calling a bak chain that makes them it

274
00:10:38,089 --> 00:10:43,699
makes non actual memory into executable

275
00:10:41,089 --> 00:10:44,899
for long enough they can run I'm not

276
00:10:43,699 --> 00:10:45,740
going to like like labor this that

277
00:10:44,899 --> 00:10:47,839
that's all I'm gonna say about the

278
00:10:45,740 --> 00:10:49,880
attack I'd love to talk more but but as

279
00:10:47,839 --> 00:10:52,069
I say it's a half hour presentation this

280
00:10:49,880 --> 00:10:54,560
is yeah I adapted this from or one our

281
00:10:52,069 --> 00:10:56,120
slide deck so yes we'll see how this

282
00:10:54,560 --> 00:10:58,018
goes so anyway on to the fun stuff

283
00:10:56,120 --> 00:11:00,779
detection yay

284
00:10:58,019 --> 00:11:02,339
so how we gonna detect this so first

285
00:11:00,779 --> 00:11:03,540
thing I like to look at is you know it

286
00:11:02,339 --> 00:11:06,089
lists out all the artifacts that that

287
00:11:03,540 --> 00:11:07,649
this kind of technique is going to is

288
00:11:06,089 --> 00:11:08,759
going to leave running on the system and

289
00:11:07,649 --> 00:11:12,089
there's obviously there's some

290
00:11:08,759 --> 00:11:13,439
non-executable memory but this is maybe

291
00:11:12,089 --> 00:11:15,119
maybe there's something clever you could

292
00:11:13,439 --> 00:11:17,040
do in terms of like analyzing everything

293
00:11:15,119 --> 00:11:18,809
on the system and saying mmm this isn't

294
00:11:17,040 --> 00:11:20,819
marked as code but it kind of looks like

295
00:11:18,809 --> 00:11:22,199
it could be but I figure this is gonna

296
00:11:20,819 --> 00:11:23,399
be difficult to do and it's gonna be a

297
00:11:22,199 --> 00:11:26,238
rough road and you're gonna have to scan

298
00:11:23,399 --> 00:11:28,649
through all of the memory and the other

299
00:11:26,239 --> 00:11:30,329
the other kind of artifact that looks

300
00:11:28,649 --> 00:11:33,029
more interesting to me was the system

301
00:11:30,329 --> 00:11:34,618
time itself because if we can look at

302
00:11:33,029 --> 00:11:36,239
all these timers we enumerate a list of

303
00:11:34,619 --> 00:11:37,920
timers see whether while going a figure

304
00:11:36,239 --> 00:11:42,029
stuff out okay okay

305
00:11:37,920 --> 00:11:43,920
but it turns out getting getting any

306
00:11:42,029 --> 00:11:45,389
information about system the state of

307
00:11:43,920 --> 00:11:47,099
system time is in the system is actually

308
00:11:45,389 --> 00:11:49,259
really difficult from user mode there's

309
00:11:47,100 --> 00:11:50,699
no real ways of doing it to hold all of

310
00:11:49,259 --> 00:11:52,379
the functionalities in the kernel and

311
00:11:50,699 --> 00:11:55,498
there's some very thin wrappers that

312
00:11:52,379 --> 00:11:57,299
just call the kernel components so okay

313
00:11:55,499 --> 00:12:00,600
no problem break up the kernel debugger

314
00:11:57,299 --> 00:12:01,920
we can handle this okay but in the

315
00:12:00,600 --> 00:12:04,709
inside the kernel there's also an

316
00:12:01,920 --> 00:12:06,360
incredibly sparsely documented kind of

317
00:12:04,709 --> 00:12:08,910
functionality here they're functions to

318
00:12:06,360 --> 00:12:10,619
initialize them to set them get rid of

319
00:12:08,910 --> 00:12:11,999
them that's what yeah you can't list

320
00:12:10,619 --> 00:12:14,639
them you can't interrogate them that

321
00:12:11,999 --> 00:12:16,619
kind of thing so suck huh okay time for

322
00:12:14,639 --> 00:12:17,939
the verse engineering okay so sat down

323
00:12:16,619 --> 00:12:19,889
with the windows internal box and try

324
00:12:17,939 --> 00:12:22,799
figure so and I've really found there

325
00:12:19,889 --> 00:12:24,600
wasn't really any kind of easy

326
00:12:22,799 --> 00:12:25,769
undocumented way so it's so obviously

327
00:12:24,600 --> 00:12:27,480
doing security research we're not

328
00:12:25,769 --> 00:12:29,549
supposed to do undocumented things but

329
00:12:27,480 --> 00:12:31,529
we always have to like pbt be you know

330
00:12:29,549 --> 00:12:32,999
and there wasn't anything that was kind

331
00:12:31,529 --> 00:12:35,759
of stable I'm over when those versions

332
00:12:32,999 --> 00:12:39,899
or kind of reliable enough to use like

333
00:12:35,759 --> 00:12:41,220
hmm so a bit stumped so I start googling

334
00:12:39,899 --> 00:12:42,629
as I always do when I'm stumped for the

335
00:12:41,220 --> 00:12:44,339
particular difficult problem and of

336
00:12:42,629 --> 00:12:47,549
course volatility comes to the rescue a

337
00:12:44,339 --> 00:12:49,350
volatility so it turns out volatility

338
00:12:47,549 --> 00:12:53,100
ships for the plug-in time is dot P Y

339
00:12:49,350 --> 00:12:55,049
which will list system timers fantastic

340
00:12:53,100 --> 00:12:57,389
it was the only tool I could find that

341
00:12:55,049 --> 00:12:57,869
would list these timers so I was like

342
00:12:57,389 --> 00:12:59,879
okay great

343
00:12:57,869 --> 00:13:01,949
it can enumerate these it can find the

344
00:12:59,879 --> 00:13:04,410
APC the APC being essentially the

345
00:13:01,949 --> 00:13:05,969
description of a callback okay great

346
00:13:04,410 --> 00:13:07,679
that's that's pretty much all we need so

347
00:13:05,970 --> 00:13:09,360
I assumed off and started trying to have

348
00:13:07,679 --> 00:13:11,009
a look at it I I'm not sure if you can

349
00:13:09,360 --> 00:13:11,400
read this I guess the actual content

350
00:13:11,009 --> 00:13:12,810
isn't

351
00:13:11,400 --> 00:13:15,270
Stickley important there's just no

352
00:13:12,810 --> 00:13:16,469
numbers here words there it's fine the

353
00:13:15,270 --> 00:13:18,600
leftmost one is the interesting one

354
00:13:16,470 --> 00:13:24,030
because it points to a struct of type II

355
00:13:18,600 --> 00:13:25,410
timer which is but you just did which is

356
00:13:24,030 --> 00:13:27,000
just a structure that holds information

357
00:13:25,410 --> 00:13:30,270
about the timer that we want to know is

358
00:13:27,000 --> 00:13:32,220
the description in in win debug I don't

359
00:13:30,270 --> 00:13:33,930
know if it I don't know where if if

360
00:13:32,220 --> 00:13:35,490
people are familiar with Wendy Bob doing

361
00:13:33,930 --> 00:13:37,199
kernel debugging it's Wendy bugs

362
00:13:35,490 --> 00:13:38,970
fantastic for this stuff it's like

363
00:13:37,200 --> 00:13:39,690
typical Microsoft tool it's fantastic

364
00:13:38,970 --> 00:13:42,200
it's brilliant

365
00:13:39,690 --> 00:13:45,450
has like 10 years of legacy behind it

366
00:13:42,200 --> 00:13:48,600
but yeah so anyway but I think my laser

367
00:13:45,450 --> 00:13:49,560
point is gonna work that far oh so

368
00:13:48,600 --> 00:13:51,060
anyway you can see there's some fun

369
00:13:49,560 --> 00:13:54,089
information there you get a timer period

370
00:13:51,060 --> 00:13:55,829
and you get time at a PC which is the

371
00:13:54,090 --> 00:13:57,780
structure that describes what's going to

372
00:13:55,830 --> 00:13:58,800
happen when the time of fires so it has

373
00:13:57,780 --> 00:14:01,650
the address of the code it's gonna

374
00:13:58,800 --> 00:14:04,140
invoke it has it has information needed

375
00:14:01,650 --> 00:14:06,090
to find the thread it's going to use as

376
00:14:04,140 --> 00:14:06,840
a context and all that kind of stuff so

377
00:14:06,090 --> 00:14:09,420
that's all we need

378
00:14:06,840 --> 00:14:11,700
fantastic so now we can go away and we

379
00:14:09,420 --> 00:14:15,089
can scribble up some stuff in volatility

380
00:14:11,700 --> 00:14:17,700
and the the kind of naive obvious way of

381
00:14:15,090 --> 00:14:19,380
doing this is to enumerate all these

382
00:14:17,700 --> 00:14:20,910
timers get a list of these handler

383
00:14:19,380 --> 00:14:22,890
functions and then check out their

384
00:14:20,910 --> 00:14:24,990
prologues right if you you you would

385
00:14:22,890 --> 00:14:27,150
expect each one to have a fairly

386
00:14:24,990 --> 00:14:29,100
sensible looking Prolog like a you know

387
00:14:27,150 --> 00:14:30,870
make an x86 stack frame do something

388
00:14:29,100 --> 00:14:33,000
sensible you wouldn't expect like an

389
00:14:30,870 --> 00:14:35,010
obvious what stack there that way if you

390
00:14:33,000 --> 00:14:39,330
see like pop pop let's it's something

391
00:14:35,010 --> 00:14:42,480
fishy going on so I yeah so I fired up

392
00:14:39,330 --> 00:14:45,690
my my trusty Python interpreter and I

393
00:14:42,480 --> 00:14:47,250
wrote something here that's fairly big I

394
00:14:45,690 --> 00:14:48,750
think you can read it will say anyway B

395
00:14:47,250 --> 00:14:51,900
yeah the important thing is the point in

396
00:14:48,750 --> 00:14:54,150
the middle pop-pop-pop lcx Bob is B

397
00:14:51,900 --> 00:14:57,060
let's there's pop-up that looks pretty

398
00:14:54,150 --> 00:14:59,610
suspicious that's the yeah

399
00:14:57,060 --> 00:15:02,069
gargle de XE is the the POC is available

400
00:14:59,610 --> 00:15:04,680
online so yeah that's kind of cool

401
00:15:02,070 --> 00:15:06,540
so we could give this tool to our threat

402
00:15:04,680 --> 00:15:09,030
hunters and we can say okay if you

403
00:15:06,540 --> 00:15:11,520
suspect this kind of thing you can take

404
00:15:09,030 --> 00:15:12,480
a take a memory dump of the system run

405
00:15:11,520 --> 00:15:15,240
it through this script and you'll see

406
00:15:12,480 --> 00:15:17,100
what's going on and that's cool but it

407
00:15:15,240 --> 00:15:18,900
means after that hunters have to spend

408
00:15:17,100 --> 00:15:20,400
some time like looking at this and

409
00:15:18,900 --> 00:15:22,530
feeling it all out so I started thinking

410
00:15:20,400 --> 00:15:24,529
you know maybe we can automate it a bit

411
00:15:22,530 --> 00:15:27,649
maybe you can figure more stuff out

412
00:15:24,529 --> 00:15:30,799
so I was like hmm okay let's give it a

413
00:15:27,649 --> 00:15:33,769
go automation the thing the thing I want

414
00:15:30,799 --> 00:15:37,749
to stress here is that it's very easy to

415
00:15:33,769 --> 00:15:37,749
it to get carried away with automation

416
00:15:37,899 --> 00:15:43,399
yeah it's late

417
00:15:41,049 --> 00:15:45,439
if you do it too much then you end up

418
00:15:43,399 --> 00:15:47,209
being the company that says here's a

419
00:15:45,439 --> 00:15:48,679
magic box and you put it on your

420
00:15:47,209 --> 00:15:51,799
internet connection and all the hackers

421
00:15:48,679 --> 00:15:53,029
get stopped by it and then you know the

422
00:15:51,799 --> 00:15:55,489
ones in the dashboard that says oh yes

423
00:15:53,029 --> 00:15:59,869
368 hack attacks blocked in the last

424
00:15:55,489 --> 00:16:01,639
five minutes you know so yeah that's

425
00:15:59,869 --> 00:16:03,379
that's something I want to avoid we have

426
00:16:01,639 --> 00:16:04,999
so the way that we do things account set

427
00:16:03,379 --> 00:16:06,919
so I hope this isn't like to corpora or

428
00:16:04,999 --> 00:16:10,339
whatever but we yeah we have a team of

429
00:16:06,919 --> 00:16:12,139
hunters who who essentially just spend

430
00:16:10,339 --> 00:16:16,029
their days looking through the events

431
00:16:12,139 --> 00:16:18,319
that are fired off by our PR agents so

432
00:16:16,029 --> 00:16:20,809
okay there was like yes so I went a bit

433
00:16:18,319 --> 00:16:22,339
off track that's so as I say automation

434
00:16:20,809 --> 00:16:25,539
has to be done carefully and I think the

435
00:16:22,339 --> 00:16:27,739
the the best way I found to kind of

436
00:16:25,539 --> 00:16:31,279
explain this and state it in a good way

437
00:16:27,739 --> 00:16:33,439
is that it should be objective here we

438
00:16:31,279 --> 00:16:35,509
shouldn't have some code that tries to

439
00:16:33,439 --> 00:16:38,029
figure out the intent of what's going on

440
00:16:35,509 --> 00:16:40,699
so we shouldn't have code that says this

441
00:16:38,029 --> 00:16:43,009
person is trying to hack your system but

442
00:16:40,699 --> 00:16:45,079
we could have something very objective

443
00:16:43,009 --> 00:16:47,419
that says oh this timer has been used in

444
00:16:45,079 --> 00:16:49,488
an unusual way or this code is here so

445
00:16:47,419 --> 00:16:50,389
that was the kind of level of automation

446
00:16:49,489 --> 00:16:51,799
I was going for

447
00:16:50,389 --> 00:16:55,819
the other thing I want to do very

448
00:16:51,799 --> 00:16:57,079
carefully was to fail safely because it

449
00:16:55,819 --> 00:16:58,728
would be pretty bad if I made and I

450
00:16:57,079 --> 00:17:01,248
thought enough for automation that it

451
00:16:58,729 --> 00:17:03,199
would you know automate itself out of

452
00:17:01,249 --> 00:17:05,470
the loop or something you you know want

453
00:17:03,199 --> 00:17:08,449
things to break and yeah

454
00:17:05,470 --> 00:17:10,759
so the way to do this in this case was

455
00:17:08,449 --> 00:17:14,110
to expose the behavior of the timer

456
00:17:10,759 --> 00:17:17,240
handler in a more accessible way I think

457
00:17:14,109 --> 00:17:20,388
so if we can find such data points as

458
00:17:17,240 --> 00:17:21,649
does it form a stack Vivat pretty good

459
00:17:20,388 --> 00:17:22,698
date point if that happens there's a

460
00:17:21,648 --> 00:17:24,378
pretty high chance there's some

461
00:17:22,699 --> 00:17:27,139
maliciousness going on and a human can

462
00:17:24,378 --> 00:17:29,119
go and take a look at it is there a call

463
00:17:27,138 --> 00:17:30,949
to virtual protect I mean this time as

464
00:17:29,119 --> 00:17:32,658
handler if there is then there's that's

465
00:17:30,950 --> 00:17:33,860
pretty bad and if there's a call to

466
00:17:32,659 --> 00:17:35,960
virtual protect that mark something

467
00:17:33,860 --> 00:17:37,010
executable and then a branch to that

468
00:17:35,960 --> 00:17:38,929
address you know that

469
00:17:37,010 --> 00:17:41,120
almost certainly bad and we need to get

470
00:17:38,929 --> 00:17:44,150
our we've got wake up our hunting team

471
00:17:41,120 --> 00:17:47,689
and get them to go and do stuff hunt

472
00:17:44,150 --> 00:17:52,130
some pets so we're chose to do this was

473
00:17:47,690 --> 00:17:53,390
to use an emulation framework and the

474
00:17:52,130 --> 00:17:55,850
emulation framework I used was a

475
00:17:53,390 --> 00:17:57,380
fantastic a named unicorn engine hell

476
00:17:55,850 --> 00:17:59,178
yes unicorns yes

477
00:17:57,380 --> 00:18:00,470
I almost put some unicorns in this slide

478
00:17:59,179 --> 00:18:01,760
but I didn't in the last minute and I'm

479
00:18:00,470 --> 00:18:03,799
kind of regretting that now there's not

480
00:18:01,760 --> 00:18:04,309
enough unicorns in this presentation but

481
00:18:03,799 --> 00:18:06,559
yes

482
00:18:04,309 --> 00:18:07,639
unicorn engine is a it's a fantastic

483
00:18:06,559 --> 00:18:10,160
tool I'm just going to plug it for a

484
00:18:07,640 --> 00:18:11,390
little bit because I love it and a lot

485
00:18:10,160 --> 00:18:13,190
of people like speech you haven't used

486
00:18:11,390 --> 00:18:14,299
it and don't know about it and it makes

487
00:18:13,190 --> 00:18:17,030
makes my life a lot easier

488
00:18:14,299 --> 00:18:19,639
it's just a very full-featured CPU

489
00:18:17,030 --> 00:18:21,678
emulation engine I say light it as light

490
00:18:19,640 --> 00:18:24,650
as a fully featured CP emulation and

491
00:18:21,679 --> 00:18:26,390
engine can be it's just based on QEMU so

492
00:18:24,650 --> 00:18:27,890
guy took a load of care QEMU and tidied

493
00:18:26,390 --> 00:18:29,330
it up and did a lot of cool stuff so it

494
00:18:27,890 --> 00:18:30,650
you can simulate instructions very

495
00:18:29,330 --> 00:18:32,510
easily you'd say oh here's some memory

496
00:18:30,650 --> 00:18:33,380
what happens when I execute it cool it

497
00:18:32,510 --> 00:18:34,580
does like a zillion different

498
00:18:33,380 --> 00:18:36,500
architecture so if you're looking at

499
00:18:34,580 --> 00:18:37,699
like MIPS code or arm or whatever it'll

500
00:18:36,500 --> 00:18:39,080
do that and you can call it from

501
00:18:37,700 --> 00:18:40,750
whatever your favorite languages so in

502
00:18:39,080 --> 00:18:43,428
this case it was Python because it's all

503
00:18:40,750 --> 00:18:44,990
volatility but call it from whatever you

504
00:18:43,429 --> 00:18:48,770
like it's also actively maintained which

505
00:18:44,990 --> 00:18:50,660
is yeah and it's from this chap Quinn

506
00:18:48,770 --> 00:18:52,610
who another tool called capstone which

507
00:18:50,660 --> 00:18:54,260
is like you know awesome awesome

508
00:18:52,610 --> 00:18:55,580
disassemble a framework and because

509
00:18:54,260 --> 00:18:56,780
they're both written by the same guy

510
00:18:55,580 --> 00:18:58,070
they ought they both play together

511
00:18:56,780 --> 00:18:59,928
really nicely so you can do all your

512
00:18:58,070 --> 00:19:01,580
disassembly and then feed the data into

513
00:18:59,929 --> 00:19:03,140
the emulator without having to do loads

514
00:19:01,580 --> 00:19:04,760
of like weird stuff in between right

515
00:19:03,140 --> 00:19:05,990
fantastic I'm just gonna plug this

516
00:19:04,760 --> 00:19:07,940
because this is great and unfortunately

517
00:19:05,990 --> 00:19:10,040
in the original presentation I had like

518
00:19:07,940 --> 00:19:11,270
a whole slide of me going on like a

519
00:19:10,040 --> 00:19:12,950
tangent with an entirely different

520
00:19:11,270 --> 00:19:14,660
project where this was really useful but

521
00:19:12,950 --> 00:19:17,450
I don't have time to share that maybe

522
00:19:14,660 --> 00:19:18,620
later when we're parting harder sorry

523
00:19:17,450 --> 00:19:20,210
sorry

524
00:19:18,620 --> 00:19:21,469
I'm you're partying hard I have a habit

525
00:19:20,210 --> 00:19:24,919
stroking my beard I just have to be

526
00:19:21,470 --> 00:19:27,190
careful not to do so probably okay so

527
00:19:24,919 --> 00:19:29,750
anyway I digress

528
00:19:27,190 --> 00:19:31,100
so I I went away and I spilled up some

529
00:19:29,750 --> 00:19:32,809
code to do this and this is this may

530
00:19:31,100 --> 00:19:34,939
well be too small for people to read but

531
00:19:32,809 --> 00:19:36,440
there's just a column here that says has

532
00:19:34,940 --> 00:19:38,570
it adjusted page missions and it says

533
00:19:36,440 --> 00:19:40,309
true which is you know I guess it's not

534
00:19:38,570 --> 00:19:42,770
not very a particularly glamorous

535
00:19:40,309 --> 00:19:44,270
looking mmm I should have had it like

536
00:19:42,770 --> 00:19:45,350
with a like bursts of glitter or

537
00:19:44,270 --> 00:19:47,480
something that would've been a bit more

538
00:19:45,350 --> 00:19:50,750
but yeah not a glamorous looking but it

539
00:19:47,480 --> 00:19:52,669
detects it and it fails safely as well

540
00:19:50,750 --> 00:19:54,380
if it can't emulate something which

541
00:19:52,669 --> 00:19:56,299
happens like reasonably often like not

542
00:19:54,380 --> 00:19:59,870
like reasonably often reasonably often

543
00:19:56,299 --> 00:20:04,039
in it's there's quite a lot that Unicorn

544
00:19:59,870 --> 00:20:05,479
can't do some things because it's it's

545
00:20:04,039 --> 00:20:08,620
unusual enough that it's not implemented

546
00:20:05,480 --> 00:20:10,880
so things like using the 16 bits

547
00:20:08,620 --> 00:20:13,610
CSDs segment registers and that kind of

548
00:20:10,880 --> 00:20:15,350
thing which seems like something I

549
00:20:13,610 --> 00:20:17,539
wouldn't need but then you need it if

550
00:20:15,350 --> 00:20:19,309
you're using well-well-well 64 because

551
00:20:17,539 --> 00:20:22,730
it's used in all the thunking stuff and

552
00:20:19,309 --> 00:20:24,710
then other stuff that it can't possibly

553
00:20:22,730 --> 00:20:27,230
do like emulating other pieces of the

554
00:20:24,710 --> 00:20:29,539
hardware like disk disk IO or something

555
00:20:27,230 --> 00:20:30,710
so in this case we just like to say oh

556
00:20:29,539 --> 00:20:31,700
we don't know what's going on here you

557
00:20:30,710 --> 00:20:33,260
better take a look

558
00:20:31,700 --> 00:20:37,280
and it happens infrequently enough this

559
00:20:33,260 --> 00:20:38,658
it's manageable so yeah oh wow I have

560
00:20:37,280 --> 00:20:40,010
nine and a half minutes left now I'm on

561
00:20:38,659 --> 00:20:42,409
my summary slide I'm so pleased with

562
00:20:40,010 --> 00:20:43,850
myself I haven't gone too fast and like

563
00:20:42,409 --> 00:20:48,039
really nervous he's like spoke really

564
00:20:43,850 --> 00:20:55,850
fast anyway okay on to the final slide

565
00:20:48,039 --> 00:20:59,990
nine minutes more lunch awesome okay so

566
00:20:55,850 --> 00:21:03,199
I digress anyway so yes now we can

567
00:20:59,990 --> 00:21:04,280
detect this this was my my my-y a moment

568
00:21:03,200 --> 00:21:06,020
that was given to our clients not like

569
00:21:04,280 --> 00:21:08,809
yes now we can detect this and you can

570
00:21:06,020 --> 00:21:10,700
too all the code is up online there's I

571
00:21:08,809 --> 00:21:13,850
did a huge blog post and if you're into

572
00:21:10,700 --> 00:21:15,950
or if you particularly if you'd like to

573
00:21:13,850 --> 00:21:17,990
be in the inter Windows kernel stuff and

574
00:21:15,950 --> 00:21:20,990
you're not quite sure kind of how to get

575
00:21:17,990 --> 00:21:22,070
into it or or that kind of thing if you

576
00:21:20,990 --> 00:21:24,080
check out the blog post it's attached

577
00:21:22,070 --> 00:21:25,309
this there's like walkthroughs of no

578
00:21:24,080 --> 00:21:26,809
attach your kernel debugger and then

579
00:21:25,309 --> 00:21:29,360
type this command and then you can see

580
00:21:26,809 --> 00:21:30,799
this and then this means this so it

581
00:21:29,360 --> 00:21:35,139
might might be it might be useful and

582
00:21:30,799 --> 00:21:42,470
interesting hopefully hopefully there's

583
00:21:35,140 --> 00:21:44,330
so there's there yeah check it out if

584
00:21:42,470 --> 00:21:46,520
you're more in place on the attack I

585
00:21:44,330 --> 00:21:47,899
probably have spent an extra eight

586
00:21:46,520 --> 00:21:50,179
minutes not talking about the attack oh

587
00:21:47,900 --> 00:21:51,440
well nobody so if you want if you're

588
00:21:50,179 --> 00:21:56,240
more famous for the attack which is by

589
00:21:51,440 --> 00:21:57,740
this this this this chap Josh Josh

590
00:21:56,240 --> 00:21:58,970
something I'm not going to say it just

591
00:21:57,740 --> 00:22:00,320
in case I mispronounce it because it

592
00:21:58,970 --> 00:22:01,909
would be so disrespectful how miss Mouse

593
00:22:00,320 --> 00:22:03,379
is named all talk about his attack but

594
00:22:01,909 --> 00:22:04,340
the chap who develop this attack check

595
00:22:03,380 --> 00:22:05,840
it out it's it

596
00:22:04,340 --> 00:22:07,309
he has like a nice graphic and explains

597
00:22:05,840 --> 00:22:08,809
a lot better than me just say no year to

598
00:22:07,309 --> 00:22:10,908
walk chain it's great if you're

599
00:22:08,809 --> 00:22:12,889
interested in me check out my Twitter

600
00:22:10,909 --> 00:22:15,140
it's my it's my personal Twitter I talk

601
00:22:12,890 --> 00:22:16,640
about loads of stuff I talk always talk

602
00:22:15,140 --> 00:22:18,320
about like I always talk about like

603
00:22:16,640 --> 00:22:20,090
completely breaking stuff talk what all

604
00:22:18,320 --> 00:22:21,139
computers fun stuff and then I talk

605
00:22:20,090 --> 00:22:23,029
about loads of other stuff that might

606
00:22:21,140 --> 00:22:24,380
not interest you so take the pinch of

607
00:22:23,029 --> 00:22:25,970
salt you might like it you might not and

608
00:22:24,380 --> 00:22:30,610
I'll be happy to answer any questions

609
00:22:25,970 --> 00:22:30,610
that meaning 7 minutes and 14 seconds

610
00:22:33,610 --> 00:22:37,219
okay you're all in the stunned amazed

611
00:22:35,659 --> 00:22:42,909
silence by how great I am

612
00:22:37,220 --> 00:22:42,909
I'll take that thank you okay

