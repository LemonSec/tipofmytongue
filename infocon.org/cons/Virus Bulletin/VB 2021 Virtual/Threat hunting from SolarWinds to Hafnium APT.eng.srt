1
00:00:02,640 --> 00:00:05,819
[Music]

2
00:00:08,720 --> 00:00:10,960
hey everyone thank you for joining i'm

3
00:00:10,960 --> 00:00:13,280
nathan this is ellie we are both working

4
00:00:13,280 --> 00:00:15,920
in cyber reason now topic for today will

5
00:00:15,920 --> 00:00:18,400
be friend threat hunting from soloings

6
00:00:18,400 --> 00:00:21,119
to afternoon apt

7
00:00:21,119 --> 00:00:23,680
so a little bit about us my name is my

8
00:00:23,680 --> 00:00:25,519
name is niv and i'm the incense response

9
00:00:25,519 --> 00:00:28,000
practice director it's cyber reason

10
00:00:28,000 --> 00:00:29,679
which means i manage scent response

11
00:00:29,679 --> 00:00:32,159
cases most of my work is around threat

12
00:00:32,159 --> 00:00:33,200
hunting and

13
00:00:33,200 --> 00:00:35,280
investigations of bridge incidents of

14
00:00:35,280 --> 00:00:38,160
customers before joining cyber reason i

15
00:00:38,160 --> 00:00:40,160
was a second insect response manager in

16
00:00:40,160 --> 00:00:42,160
the israeli air force

17
00:00:42,160 --> 00:00:44,559
hey my name is ellie i'm a lead threat

18
00:00:44,559 --> 00:00:46,559
hunter and male reverse engineer at

19
00:00:46,559 --> 00:00:49,200
cybriza i work in the private sector of

20
00:00:49,200 --> 00:00:51,760
the cyber security industry for a couple

21
00:00:51,760 --> 00:00:53,199
of years now

22
00:00:53,199 --> 00:00:55,440
and in my free time i like to publish

23
00:00:55,440 --> 00:00:57,520
articles about malware research and

24
00:00:57,520 --> 00:01:00,320
threat hunting

25
00:01:01,359 --> 00:01:03,520
this is the agenda for today we will

26
00:01:03,520 --> 00:01:05,438
start with talking about freight hunting

27
00:01:05,438 --> 00:01:06,640
what and why

28
00:01:06,640 --> 00:01:08,320
then we will deep dive into the grey

29
00:01:08,320 --> 00:01:11,040
area problem and we'll talk about iocs

30
00:01:11,040 --> 00:01:13,600
versus iobs data collection and which

31
00:01:13,600 --> 00:01:15,600
data you need to collect in order to

32
00:01:15,600 --> 00:01:17,840
perform threat hunting threat hunting

33
00:01:17,840 --> 00:01:20,799
hypothesis and i will see it in our team

34
00:01:20,799 --> 00:01:23,119
and threat hunting use cases the first

35
00:01:23,119 --> 00:01:25,280
one is solar wind supply chain attack

36
00:01:25,280 --> 00:01:28,240
where we focus on iocs and the other one

37
00:01:28,240 --> 00:01:30,560
will be proxy logon and afternoon where

38
00:01:30,560 --> 00:01:33,439
we focus on iobs

39
00:01:33,439 --> 00:01:35,360
but i think freight hunting is about

40
00:01:35,360 --> 00:01:37,040
being proactive and searching for

41
00:01:37,040 --> 00:01:39,200
adversaries versus the old reactive

42
00:01:39,200 --> 00:01:41,520
approach responding to incidents when we

43
00:01:41,520 --> 00:01:43,200
do front hunting we will analyze

44
00:01:43,200 --> 00:01:45,759
telemetry data and logs and we will look

45
00:01:45,759 --> 00:01:47,520
for anomalies and endpoints process

46
00:01:47,520 --> 00:01:50,320
activities connections and so on create

47
00:01:50,320 --> 00:01:53,280
iobs indicators of behavior

48
00:01:53,280 --> 00:01:55,920
instead of the traditional iocs

49
00:01:55,920 --> 00:01:59,200
indicators of compromise transform ttps

50
00:01:59,200 --> 00:02:02,799
into tactical antiquaries

51
00:02:03,840 --> 00:02:06,000
why it should perform threat hunting

52
00:02:06,000 --> 00:02:08,720
fat tactiles are continuous continuously

53
00:02:08,720 --> 00:02:10,560
evolving and adapting tactics and

54
00:02:10,560 --> 00:02:12,879
techniques to bypass security tools and

55
00:02:12,879 --> 00:02:14,720
as defenders we need to learn how to

56
00:02:14,720 --> 00:02:16,560
find anomalies and how to differentiate

57
00:02:16,560 --> 00:02:18,400
between legitimate and non-legitimate

58
00:02:18,400 --> 00:02:20,800
activities pet acting covers the gaps

59
00:02:20,800 --> 00:02:23,120
that additional security products have

60
00:02:23,120 --> 00:02:24,560
and the frequenting premise is that the

61
00:02:24,560 --> 00:02:28,720
attacker is already in the environment

62
00:02:28,720 --> 00:02:30,560
the majority of threatened inquiry's

63
00:02:30,560 --> 00:02:32,720
purpose is to add anomalies in the gray

64
00:02:32,720 --> 00:02:35,440
area the grey area is the place where we

65
00:02:35,440 --> 00:02:37,760
observe usage of benign applications or

66
00:02:37,760 --> 00:02:40,000
behavior for malicious purposes

67
00:02:40,000 --> 00:02:41,280
for example

68
00:02:41,280 --> 00:02:43,200
scanning activities

69
00:02:43,200 --> 00:02:44,640
is always

70
00:02:44,640 --> 00:02:46,480
is something that sits in the gray area

71
00:02:46,480 --> 00:02:49,040
since it's not 100 malicious so benign

72
00:02:49,040 --> 00:02:51,760
on the one end attackers can use sk

73
00:02:51,760 --> 00:02:53,040
scanning to perform internal

74
00:02:53,040 --> 00:02:54,959
reconnaissance so it received the red

75
00:02:54,959 --> 00:02:57,760
area as malicious but on the other end

76
00:02:57,760 --> 00:03:00,080
various it will scan the network all the

77
00:03:00,080 --> 00:03:02,239
time and this type of activity is in the

78
00:03:02,239 --> 00:03:04,959
blue blue area which is benign

79
00:03:04,959 --> 00:03:06,959
as threat hunters we see that reductions

80
00:03:06,959 --> 00:03:09,280
operate in the gay area all the time and

81
00:03:09,280 --> 00:03:11,599
security tools struggle to detect those

82
00:03:11,599 --> 00:03:13,519
activities since they don't want to

83
00:03:13,519 --> 00:03:15,200
create detection that has high rate of

84
00:03:15,200 --> 00:03:17,040
false positive rates

85
00:03:17,040 --> 00:03:19,360
there are many gray areas in operating

86
00:03:19,360 --> 00:03:22,239
systems therefore as a threat hunter

87
00:03:22,239 --> 00:03:23,840
must have extensive theoretical

88
00:03:23,840 --> 00:03:26,000
knowledge about how an operating system

89
00:03:26,000 --> 00:03:27,360
should work

90
00:03:27,360 --> 00:03:30,159
iocs versus iobis this is the pyramid of

91
00:03:30,159 --> 00:03:32,400
pain which was perfectly introduced in

92
00:03:32,400 --> 00:03:34,640
2013 by the security professional david

93
00:03:34,640 --> 00:03:37,280
j bianco fred hunting can start

94
00:03:37,280 --> 00:03:39,840
from the traditional usage such as hash

95
00:03:39,840 --> 00:03:42,159
values ip addresses and domain names

96
00:03:42,159 --> 00:03:44,000
looking for ios is supposed to be an

97
00:03:44,000 --> 00:03:46,799
easy thing to look for in edl app

98
00:03:46,799 --> 00:03:49,040
products and it's indicative and a great

99
00:03:49,040 --> 00:03:50,640
quick win to begin with

100
00:03:50,640 --> 00:03:52,720
going up the pyramid it will become more

101
00:03:52,720 --> 00:03:54,319
complex and challenging to create

102
00:03:54,319 --> 00:03:56,720
antiquaries we will want to focus on

103
00:03:56,720 --> 00:03:58,879
btps and attacker tools

104
00:03:58,879 --> 00:04:01,519
and their behavior behavioral indicators

105
00:04:01,519 --> 00:04:03,280
instead of looking for static values of

106
00:04:03,280 --> 00:04:07,200
metadata that can be easily changed

107
00:04:07,200 --> 00:04:09,680
now let's talk about data collection

108
00:04:09,680 --> 00:04:10,959
data collection is one of the

109
00:04:10,959 --> 00:04:13,200
fundamental steps in threat hunting our

110
00:04:13,200 --> 00:04:14,640
team focused mainly on endpoint

111
00:04:14,640 --> 00:04:16,478
telemetry and most of the research is

112
00:04:16,478 --> 00:04:18,320
based on data collection from our adr

113
00:04:18,320 --> 00:04:21,120
product idr and endpoint protection

114
00:04:21,120 --> 00:04:22,479
platforms

115
00:04:22,479 --> 00:04:23,919
show what is happening in your

116
00:04:23,919 --> 00:04:26,000
organization endpoints right now

117
00:04:26,000 --> 00:04:28,320
these products usually have a sensor on

118
00:04:28,320 --> 00:04:29,919
the endpoint that monitors useful

119
00:04:29,919 --> 00:04:31,840
information such as running processors

120
00:04:31,840 --> 00:04:34,639
loaded modules connections file events

121
00:04:34,639 --> 00:04:37,280
user activity registry

122
00:04:37,280 --> 00:04:40,000
entry and files these products have a

123
00:04:40,000 --> 00:04:42,000
built-in screen that allows you to run

124
00:04:42,000 --> 00:04:43,520
complex searches across all the

125
00:04:43,520 --> 00:04:44,880
available data

126
00:04:44,880 --> 00:04:47,280
all this data is necessarily necessary

127
00:04:47,280 --> 00:04:49,919
for creating antiques based on iabs and

128
00:04:49,919 --> 00:04:52,479
not only on ioc's if you don't have an

129
00:04:52,479 --> 00:04:54,639
idea or apd product you can use free

130
00:04:54,639 --> 00:04:56,240
tools such as this one

131
00:04:56,240 --> 00:04:58,320
from the system error suite that for

132
00:04:58,320 --> 00:05:00,960
microsoft assistment allow you allows

133
00:05:00,960 --> 00:05:02,960
you to collect that detailed information

134
00:05:02,960 --> 00:05:04,720
and log it into the windows event log on

135
00:05:04,720 --> 00:05:06,960
every endpoint you can

136
00:05:06,960 --> 00:05:08,560
follow all the events to a centralized

137
00:05:08,560 --> 00:05:11,199
log server such as planck or elastic or

138
00:05:11,199 --> 00:05:13,120
to your local sim product

139
00:05:13,120 --> 00:05:14,800
the centralized location is where you

140
00:05:14,800 --> 00:05:16,800
will run and build all of your hunting

141
00:05:16,800 --> 00:05:18,960
place there are many ways

142
00:05:18,960 --> 00:05:21,039
best practices on how to configure

143
00:05:21,039 --> 00:05:22,639
system on your environment and i really

144
00:05:22,639 --> 00:05:25,919
recommend following one of them

145
00:05:26,560 --> 00:05:28,400
let's talk about the methodology and how

146
00:05:28,400 --> 00:05:31,199
we learn funding in this library in in

147
00:05:31,199 --> 00:05:33,520
iot we split our work into four main

148
00:05:33,520 --> 00:05:36,080
phases where hypothesis research great

149
00:05:36,080 --> 00:05:37,840
hunting query and less detect and

150
00:05:37,840 --> 00:05:40,800
analyze clearly policies in this phase

151
00:05:40,800 --> 00:05:42,560
you will choose the subject you want to

152
00:05:42,560 --> 00:05:44,479
focus on you don't need to be a single

153
00:05:44,479 --> 00:05:46,320
security researcher to perform flat

154
00:05:46,320 --> 00:05:47,440
hunting

155
00:05:47,440 --> 00:05:49,039
you will need to gain access to

156
00:05:49,039 --> 00:05:51,280
information about ttps and what is being

157
00:05:51,280 --> 00:05:52,479
used right now

158
00:05:52,479 --> 00:05:54,479
in the cyber security world there are

159
00:05:54,479 --> 00:05:56,319
many useful resources that you can

160
00:05:56,319 --> 00:05:58,560
leverage for that you can use austin to

161
00:05:58,560 --> 00:06:00,240
see the trends of today in the

162
00:06:00,240 --> 00:06:02,160
financials world and find a lead to

163
00:06:02,160 --> 00:06:03,280
start with

164
00:06:03,280 --> 00:06:05,120
we recommend following security company

165
00:06:05,120 --> 00:06:07,600
blocks and tweets from security searches

166
00:06:07,600 --> 00:06:09,440
sometimes these resources will be

167
00:06:09,440 --> 00:06:11,840
straightforward and contain iocs and the

168
00:06:11,840 --> 00:06:13,919
outlooks sometimes they have deep dive

169
00:06:13,919 --> 00:06:15,440
analysis that will allow you to create

170
00:06:15,440 --> 00:06:18,719
iobs in antiquities

171
00:06:19,039 --> 00:06:21,120
research in this phase we gather more

172
00:06:21,120 --> 00:06:22,720
information about the threat technical

173
00:06:22,720 --> 00:06:24,880
dtp we will do a deep dive into the

174
00:06:24,880 --> 00:06:26,960
topic and understand how the behavior

175
00:06:26,960 --> 00:06:29,039
looks in our internal environment we

176
00:06:29,039 --> 00:06:31,039
will do that by looking in a real life

177
00:06:31,039 --> 00:06:33,520
example of the investigated threats

178
00:06:33,520 --> 00:06:36,000
ranataki tools related milo samples and

179
00:06:36,000 --> 00:06:38,800
so on we will use resources

180
00:06:38,800 --> 00:06:41,520
such as uh research documents faris

181
00:06:41,520 --> 00:06:44,400
total sandbox says blogs and

182
00:06:44,400 --> 00:06:46,479
and twitter for enrichment and to help

183
00:06:46,479 --> 00:06:49,440
you in the future create and think well

184
00:06:49,440 --> 00:06:51,280
after you've done some research and have

185
00:06:51,280 --> 00:06:53,520
some ideas to work with you can start to

186
00:06:53,520 --> 00:06:56,160
build your antiquities on our team we

187
00:06:56,160 --> 00:06:58,080
usually focus on running processes and

188
00:06:58,080 --> 00:07:00,639
endpoint telemetry we study depositories

189
00:07:00,639 --> 00:07:02,720
in their command lines and build several

190
00:07:02,720 --> 00:07:04,800
ideas for queries that can be that can

191
00:07:04,800 --> 00:07:06,240
catch the activity the malicious

192
00:07:06,240 --> 00:07:07,680
activities

193
00:07:07,680 --> 00:07:10,000
it can also look at other data search

194
00:07:10,000 --> 00:07:12,720
data sets such as file events registry

195
00:07:12,720 --> 00:07:15,520
entries schedule tasks services and wmi

196
00:07:15,520 --> 00:07:17,039
events

197
00:07:17,039 --> 00:07:19,280
then we'll move to the last phase detect

198
00:07:19,280 --> 00:07:21,120
analyze when you do when you have

199
00:07:21,120 --> 00:07:23,039
surrounding queries ready to run you can

200
00:07:23,039 --> 00:07:25,120
start an executing them start with a

201
00:07:25,120 --> 00:07:27,120
small subset of data and see what you

202
00:07:27,120 --> 00:07:28,000
get

203
00:07:28,000 --> 00:07:30,479
sometimes ttps that seem to be malicious

204
00:07:30,479 --> 00:07:32,479
are just normal behavior so you'll need

205
00:07:32,479 --> 00:07:33,919
to review the results and tweak your

206
00:07:33,919 --> 00:07:36,160
queries to reduce false positives if you

207
00:07:36,160 --> 00:07:37,919
have a larger data states you can repeat

208
00:07:37,919 --> 00:07:39,599
the testing and tweaking

209
00:07:39,599 --> 00:07:41,440
acting queries need to be re-evaluated

210
00:07:41,440 --> 00:07:43,680
and tested over time based on relevance

211
00:07:43,680 --> 00:07:46,879
and volatility of rates

212
00:07:46,879 --> 00:07:48,639
now let's talk about the first use case

213
00:07:48,639 --> 00:07:50,479
of solar winds

214
00:07:50,479 --> 00:07:52,240
the solarwinds supply chain attack was

215
00:07:52,240 --> 00:07:54,160
one of the most covered cyber attacks of

216
00:07:54,160 --> 00:07:56,960
2020. we'll use solarwinds as an example

217
00:07:56,960 --> 00:07:59,520
of how to perform search ios and find

218
00:07:59,520 --> 00:08:01,599
the low energy roots

219
00:08:01,599 --> 00:08:03,680
in december of 2020 it was first

220
00:08:03,680 --> 00:08:05,840
reported that multiple u.s government

221
00:08:05,840 --> 00:08:07,599
agencies were breached through

222
00:08:07,599 --> 00:08:09,840
swallowing zodiac software a supply

223
00:08:09,840 --> 00:08:11,919
chain attack is an attack that aims to

224
00:08:11,919 --> 00:08:13,759
damage an organization by targeting less

225
00:08:13,759 --> 00:08:15,280
secure elements in this supply chain

226
00:08:15,280 --> 00:08:16,319
network

227
00:08:16,319 --> 00:08:17,919
in a supply network

228
00:08:17,919 --> 00:08:19,520
in this attack the threat actors

229
00:08:19,520 --> 00:08:20,960
inserted malicious score into the

230
00:08:20,960 --> 00:08:23,280
legitimate updates of the thorium of the

231
00:08:23,280 --> 00:08:25,360
orion software allowing them to get

232
00:08:25,360 --> 00:08:26,720
remote access into the victims

233
00:08:26,720 --> 00:08:28,160
environment

234
00:08:28,160 --> 00:08:30,639
the attack was associated with apt-29

235
00:08:30,639 --> 00:08:32,240
which is allegedly related to the

236
00:08:32,240 --> 00:08:33,839
russian foreign

237
00:08:33,839 --> 00:08:36,000
intelligence service the trojanized

238
00:08:36,000 --> 00:08:38,320
module stopped sunburst contains the

239
00:08:38,320 --> 00:08:39,919
vector that can download delete in the

240
00:08:39,919 --> 00:08:42,080
right arbitrary files manipulate the

241
00:08:42,080 --> 00:08:44,640
windows service and registry and more in

242
00:08:44,640 --> 00:08:47,200
addition to that the ca reported

243
00:08:47,200 --> 00:08:49,600
on malo adapt theodore an mlv only

244
00:08:49,600 --> 00:08:51,440
dropper that equips and executes the

245
00:08:51,440 --> 00:08:53,360
combat strike framework

246
00:08:53,360 --> 00:08:56,320
overall solarwinds tested that

247
00:08:56,320 --> 00:08:58,560
stated that eighteen thousand of its

248
00:08:58,560 --> 00:09:00,720
thirty-three thousand alien customers

249
00:09:00,720 --> 00:09:02,880
were affected by this intelligence

250
00:09:02,880 --> 00:09:05,200
following the outbreak reports related

251
00:09:05,200 --> 00:09:06,800
to solarwinds our team collected

252
00:09:06,800 --> 00:09:08,800
information that helped us to understand

253
00:09:08,800 --> 00:09:11,200
this attack in our customers environment

254
00:09:11,200 --> 00:09:13,279
this is using open source intelligence

255
00:09:13,279 --> 00:09:14,640
we learned about the attack chain of

256
00:09:14,640 --> 00:09:16,560
solarwinds and where we should focus our

257
00:09:16,560 --> 00:09:19,360
efforts also because of the widespread

258
00:09:19,360 --> 00:09:20,959
coverage from the cyber security

259
00:09:20,959 --> 00:09:23,200
industry various blogs and researchers

260
00:09:23,200 --> 00:09:26,720
quickly share the list of biases

261
00:09:26,880 --> 00:09:28,720
by reading all these resources we

262
00:09:28,720 --> 00:09:30,399
started to build the structure of how we

263
00:09:30,399 --> 00:09:31,680
want to execute this threat and

264
00:09:31,680 --> 00:09:32,880
operation

265
00:09:32,880 --> 00:09:35,839
first we start with scoping we want to

266
00:09:35,839 --> 00:09:37,600
find all machines that might be impacted

267
00:09:37,600 --> 00:09:39,519
by this operation we looked for all

268
00:09:39,519 --> 00:09:41,360
machines or servers trying solving

269
00:09:41,360 --> 00:09:43,600
product we can achieve that by running

270
00:09:43,600 --> 00:09:45,680
different queries looking for processes

271
00:09:45,680 --> 00:09:48,320
or deals with name with indicative

272
00:09:48,320 --> 00:09:50,800
strings such as swallowings or oil and

273
00:09:50,800 --> 00:09:53,120
business layer

274
00:09:53,120 --> 00:09:55,279
which what which we'll find as files on

275
00:09:55,279 --> 00:09:57,519
this filter by metadata such as product

276
00:09:57,519 --> 00:10:01,279
name company name and signature

277
00:10:01,279 --> 00:10:03,040
second most of the published blog

278
00:10:03,040 --> 00:10:06,160
contained ioc is vitrogenized or dll so

279
00:10:06,160 --> 00:10:07,519
we search for the existence of the

280
00:10:07,519 --> 00:10:09,839
trojanus version of the servings module

281
00:10:09,839 --> 00:10:12,079
in this way you could find a number of

282
00:10:12,079 --> 00:10:13,440
customers that did have authorized

283
00:10:13,440 --> 00:10:15,120
modules installed in their environment

284
00:10:15,120 --> 00:10:17,120
they simply used

285
00:10:17,120 --> 00:10:20,079
256

286
00:10:21,760 --> 00:10:23,440
in this case we have a very indicative

287
00:10:23,440 --> 00:10:25,279
domain which was used by threat actual

288
00:10:25,279 --> 00:10:29,040
super from dga avs vm cloud by reviewing

289
00:10:29,040 --> 00:10:30,880
network log data we could observe old

290
00:10:30,880 --> 00:10:32,800
connection in this domain by reviewing

291
00:10:32,800 --> 00:10:35,440
ip subnet ip subnets to the center

292
00:10:35,440 --> 00:10:37,839
meaning

293
00:10:38,560 --> 00:10:41,200
to summarize soloing supply chain attack

294
00:10:41,200 --> 00:10:43,120
is a very sophisticated and complex and

295
00:10:43,120 --> 00:10:45,040
complex attack it stayed under the radar

296
00:10:45,040 --> 00:10:46,640
for a very long time

297
00:10:46,640 --> 00:10:48,399
using traditional analysis we could

298
00:10:48,399 --> 00:10:50,160
simply scope all machines that might be

299
00:10:50,160 --> 00:10:52,560
affected in this image we considered the

300
00:10:52,560 --> 00:10:54,160
ascertaining module solarwinds zoom

301
00:10:54,160 --> 00:10:55,680
chrome business layer that was

302
00:10:55,680 --> 00:10:57,279
compromised in the supply chain attack

303
00:10:57,279 --> 00:10:59,600
and added sample spectral in it the

304
00:10:59,600 --> 00:11:01,839
model resulted into the process solving

305
00:11:01,839 --> 00:11:03,600
business layer asked and performed the

306
00:11:03,600 --> 00:11:07,600
connection to the command of control

307
00:11:08,720 --> 00:11:10,640
in contrast to the solomon's case we

308
00:11:10,640 --> 00:11:12,320
want to present another eye profile

309
00:11:12,320 --> 00:11:13,920
incident it will demonstrate the power

310
00:11:13,920 --> 00:11:16,320
of either peace and flight hunting as

311
00:11:16,320 --> 00:11:18,000
you can guess from the title it's the

312
00:11:18,000 --> 00:11:21,120
paxillogan oxylogon exploitation which

313
00:11:21,120 --> 00:11:23,120
first observed in use of the athenian

314
00:11:23,120 --> 00:11:26,800
fertactos we will also show how our

315
00:11:26,800 --> 00:11:29,120
internal team react from the moment of

316
00:11:29,120 --> 00:11:31,040
initial publication of this incident

317
00:11:31,040 --> 00:11:34,399
till the end of the investigation

318
00:11:35,680 --> 00:11:38,240
hey so first for those of you are not

319
00:11:38,240 --> 00:11:40,720
familiar with this incident let's start

320
00:11:40,720 --> 00:11:42,480
with some background

321
00:11:42,480 --> 00:11:45,760
so in march 2021 microsoft announced the

322
00:11:45,760 --> 00:11:47,760
existence of multiple zero days

323
00:11:47,760 --> 00:11:51,040
vulnerabilities collectively referred as

324
00:11:51,040 --> 00:11:52,720
as proxy logo

325
00:11:52,720 --> 00:11:55,360
in the exchange server on-prem's product

326
00:11:55,360 --> 00:11:58,160
along with the urgent security update to

327
00:11:58,160 --> 00:12:01,120
mitigate further exploitation

328
00:12:01,120 --> 00:12:03,200
security vendors including surveys and

329
00:12:03,200 --> 00:12:05,600
observed evidence of a wide range of

330
00:12:05,600 --> 00:12:08,240
threat actors that have exploited these

331
00:12:08,240 --> 00:12:09,680
vulnerabilities

332
00:12:09,680 --> 00:12:14,519
including apt groups such as apt-41 ft

333
00:12:14,519 --> 00:12:17,519
27 and half new

334
00:12:17,519 --> 00:12:20,079
in addition other trade actors

335
00:12:20,079 --> 00:12:22,160
have been observed attempting to deploy

336
00:12:22,160 --> 00:12:24,480
ransomware payloads on affected

337
00:12:24,480 --> 00:12:26,800
infrastructures

338
00:12:26,800 --> 00:12:29,040
so reports estimated that the array of

339
00:12:29,040 --> 00:12:31,440
this attack collectively known as

340
00:12:31,440 --> 00:12:33,519
the half new apt attack

341
00:12:33,519 --> 00:12:36,800
affected at least 30 000 organizations

342
00:12:36,800 --> 00:12:38,480
across the united states

343
00:12:38,480 --> 00:12:40,800
including significant number of small

344
00:12:40,800 --> 00:12:44,639
businesses as uh towns cities and local

345
00:12:44,639 --> 00:12:46,560
governments

346
00:12:46,560 --> 00:12:49,519
due to the due to the large uh number of

347
00:12:49,519 --> 00:12:52,079
these tractor actors exploiting the

348
00:12:52,079 --> 00:12:54,720
proxy logo and vulnerabilities a number

349
00:12:54,720 --> 00:12:57,120
of different web show payloads have been

350
00:12:57,120 --> 00:12:58,320
emerged

351
00:12:58,320 --> 00:13:00,959
and the most common observed one was the

352
00:13:00,959 --> 00:13:02,959
china chopper web shell

353
00:13:02,959 --> 00:13:05,120
which is a multiple which multiple

354
00:13:05,120 --> 00:13:08,639
chinese apt groups have already used

355
00:13:08,639 --> 00:13:11,680
in several years now

356
00:13:11,680 --> 00:13:14,560
so let's start with scoping

357
00:13:14,560 --> 00:13:17,200
our first goal was to scope all the

358
00:13:17,200 --> 00:13:20,399
machines that all servers that have

359
00:13:20,399 --> 00:13:22,880
involved in this uh

360
00:13:22,880 --> 00:13:24,240
incident

361
00:13:24,240 --> 00:13:26,720
so after we learned the capabilities of

362
00:13:26,720 --> 00:13:28,800
these probabilities we knew that we had

363
00:13:28,800 --> 00:13:30,320
to react quick

364
00:13:30,320 --> 00:13:33,200
so our hypothesis was the

365
00:13:33,200 --> 00:13:36,639
of our customers is already compromised

366
00:13:36,639 --> 00:13:38,320
by this vulnerability

367
00:13:38,320 --> 00:13:42,000
and by the threat the huffington actor

368
00:13:42,000 --> 00:13:44,079
uh so this vulnerability could be

369
00:13:44,079 --> 00:13:47,360
exploited on the exchange server so we

370
00:13:47,360 --> 00:13:48,880
had to start

371
00:13:48,880 --> 00:13:50,320
by searching

372
00:13:50,320 --> 00:13:53,040
all the microsoft exchange servers in

373
00:13:53,040 --> 00:13:55,279
our customer base

374
00:13:55,279 --> 00:13:57,839
this can be achieved by looking for

375
00:13:57,839 --> 00:14:01,279
machines of services with exchange

376
00:14:01,279 --> 00:14:05,120
processes or services installed

377
00:14:05,279 --> 00:14:08,079
so in this slide we can see two examples

378
00:14:08,079 --> 00:14:09,839
of scoping queries

379
00:14:09,839 --> 00:14:12,160
one searching for the mx exchange

380
00:14:12,160 --> 00:14:14,880
related services and the other for the

381
00:14:14,880 --> 00:14:18,399
ms exchange related processes

382
00:14:18,399 --> 00:14:19,600
once we

383
00:14:19,600 --> 00:14:22,480
found these services or processes

384
00:14:22,480 --> 00:14:24,800
we could correlate them to

385
00:14:24,800 --> 00:14:27,599
a certain machine

386
00:14:28,000 --> 00:14:28,839
so

387
00:14:28,839 --> 00:14:32,720
next uh from uh allsyncs the open source

388
00:14:32,720 --> 00:14:34,720
intelligent we saw that the threat

389
00:14:34,720 --> 00:14:36,639
actors are using

390
00:14:36,639 --> 00:14:41,040
the is worker process or w3wp.exe

391
00:14:41,040 --> 00:14:42,880
which is the web

392
00:14:42,880 --> 00:14:44,480
component

393
00:14:44,480 --> 00:14:47,920
of the exchange email server

394
00:14:47,920 --> 00:14:51,440
so we looked for all the w3wp execution

395
00:14:51,440 --> 00:14:53,279
on those servers

396
00:14:53,279 --> 00:14:55,440
and we started to to look for

397
00:14:55,440 --> 00:14:57,199
animalities

398
00:14:57,199 --> 00:14:59,920
uh searching for these animalities can

399
00:14:59,920 --> 00:15:01,440
be done by

400
00:15:01,440 --> 00:15:04,320
reviewing command line of the is worker

401
00:15:04,320 --> 00:15:05,600
processedly

402
00:15:05,600 --> 00:15:09,600
uh and behavior such as file creation

403
00:15:09,600 --> 00:15:13,600
modification uh and also external uh

404
00:15:13,600 --> 00:15:16,880
connection and more

405
00:15:17,199 --> 00:15:18,320
so

406
00:15:18,320 --> 00:15:21,120
to focus our effort we identified a

407
00:15:21,120 --> 00:15:22,399
pattern that

408
00:15:22,399 --> 00:15:25,360
highlighted actually in every blog post

409
00:15:25,360 --> 00:15:28,320
the attacker attempted to exploit the

410
00:15:28,320 --> 00:15:30,959
microsoft exchange application pool

411
00:15:30,959 --> 00:15:35,360
named ms exchange owa app pull

412
00:15:35,360 --> 00:15:39,920
so accordingly we look for w3 wp are

413
00:15:39,920 --> 00:15:42,160
instances that has the command line that

414
00:15:42,160 --> 00:15:45,360
contains the string at this exchange o w

415
00:15:45,360 --> 00:15:48,560
a at full

416
00:15:49,199 --> 00:15:52,560
uh next because we knew that the thread

417
00:15:52,560 --> 00:15:55,519
actor are using web shows

418
00:15:55,519 --> 00:15:56,720
we look for

419
00:15:56,720 --> 00:16:00,160
shell child processes such as cmd

420
00:16:00,160 --> 00:16:03,880
and powershell.txt

421
00:16:04,000 --> 00:16:04,800
so

422
00:16:04,800 --> 00:16:08,079
once we form the base for our handy

423
00:16:08,079 --> 00:16:10,320
queries we discovered that indeed our

424
00:16:10,320 --> 00:16:12,000
hypothesis was

425
00:16:12,000 --> 00:16:14,399
correct uh in one in one of the

426
00:16:14,399 --> 00:16:16,639
infections we discovered that we

427
00:16:16,639 --> 00:16:19,440
discovered an active exploitation of the

428
00:16:19,440 --> 00:16:20,839
silicon

429
00:16:20,839 --> 00:16:23,440
vulnerabilities in addition we find the

430
00:16:23,440 --> 00:16:26,160
exactly tps that have been associated

431
00:16:26,160 --> 00:16:29,600
with the huffington third actor

432
00:16:29,600 --> 00:16:32,399
as we can see from the screenshot the

433
00:16:32,399 --> 00:16:34,959
actor used the child chopper webshell

434
00:16:34,959 --> 00:16:38,160
stored in dot aspx files

435
00:16:38,160 --> 00:16:41,600
uh with the name of outlook en dot svx

436
00:16:41,600 --> 00:16:45,320
and time logout.sps

437
00:16:45,920 --> 00:16:48,800
some workshops are common techniques

438
00:16:48,800 --> 00:16:51,759
technique used by threat actors to gain

439
00:16:51,759 --> 00:16:53,440
and also maintain

440
00:16:53,440 --> 00:16:56,959
access to inter-enterprise networks

441
00:16:56,959 --> 00:16:59,759
the challenge chopper rupture itself was

442
00:16:59,759 --> 00:17:02,000
first discovered in

443
00:17:02,000 --> 00:17:06,400
2012 and despite it despite its small

444
00:17:06,400 --> 00:17:08,160
size and simplicity

445
00:17:08,160 --> 00:17:10,319
it is actually known to take part in

446
00:17:10,319 --> 00:17:12,959
various apt activities

447
00:17:12,959 --> 00:17:16,400
especially in the apec region

448
00:17:16,400 --> 00:17:19,039
so after the web show is being deployed

449
00:17:19,039 --> 00:17:21,599
this vertex can remotely access the

450
00:17:21,599 --> 00:17:24,799
server via a publicly accessible

451
00:17:24,799 --> 00:17:28,960
web service or site and start to perform

452
00:17:28,960 --> 00:17:31,440
actions on the compromise server under

453
00:17:31,440 --> 00:17:35,760
the context of the web service

454
00:17:36,080 --> 00:17:37,840
so

455
00:17:37,840 --> 00:17:39,960
as seen in the previous slide

456
00:17:39,960 --> 00:17:41,679
cmd.xc

457
00:17:41,679 --> 00:17:44,720
was spawned from w3wp

458
00:17:44,720 --> 00:17:47,440
the threat actors has been using uh

459
00:17:47,440 --> 00:17:50,080
different channel chopper payloads uh to

460
00:17:50,080 --> 00:17:52,480
gain uh access to the vulnerable

461
00:17:52,480 --> 00:17:54,559
microsoft exchange servers

462
00:17:54,559 --> 00:17:56,880
so these files can be

463
00:17:56,880 --> 00:17:58,000
placed

464
00:17:58,000 --> 00:18:01,360
within the offline address book or oab

465
00:18:01,360 --> 00:18:04,000
object via the vulnerability

466
00:18:04,000 --> 00:18:06,799
so the next thing we did is was to look

467
00:18:06,799 --> 00:18:08,880
for any suspicious file

468
00:18:08,880 --> 00:18:10,880
on these directories

469
00:18:10,880 --> 00:18:13,280
and we indeed we found

470
00:18:13,280 --> 00:18:16,880
many webshell files on these folders

471
00:18:16,880 --> 00:18:19,679
some had the misleading names and some

472
00:18:19,679 --> 00:18:23,919
had just random characters

473
00:18:24,080 --> 00:18:26,640
so by reviewing the process 3

474
00:18:26,640 --> 00:18:29,440
we could analyze which chart process of

475
00:18:29,440 --> 00:18:31,600
the w3wp

476
00:18:31,600 --> 00:18:34,080
is spawn is spawning and observe

477
00:18:34,080 --> 00:18:36,480
actually the the full attack

478
00:18:36,480 --> 00:18:38,559
in this scenario we

479
00:18:38,559 --> 00:18:41,039
we have seen several stages that are

480
00:18:41,039 --> 00:18:45,200
known to happen when a threat actor

481
00:18:45,200 --> 00:18:48,320
first infiltrate an environment

482
00:18:48,320 --> 00:18:51,679
so we observed the several internal

483
00:18:51,679 --> 00:18:53,919
reconnaissance activities using the

484
00:18:53,919 --> 00:18:55,360
processes

485
00:18:55,360 --> 00:19:00,480
finesse dr hostname ping and query

486
00:19:00,480 --> 00:19:02,640
the attackers also deployed their own

487
00:19:02,640 --> 00:19:06,080
tool that came bundled as an archive

488
00:19:06,080 --> 00:19:09,600
file just to evade detection

489
00:19:09,600 --> 00:19:11,520
and lastly

490
00:19:11,520 --> 00:19:13,600
we see the persistence mechanism using

491
00:19:13,600 --> 00:19:16,879
the schedule task

492
00:19:18,640 --> 00:19:20,080
from this activity

493
00:19:20,080 --> 00:19:22,160
we build our hunting query

494
00:19:22,160 --> 00:19:26,080
we started from uh with the w3wp process

495
00:19:26,080 --> 00:19:28,799
that is spawning the cmd.exe

496
00:19:28,799 --> 00:19:32,080
now that might be a little bit noisy but

497
00:19:32,080 --> 00:19:34,720
but if you hunt for just uh

498
00:19:34,720 --> 00:19:36,840
one network it should be

499
00:19:36,840 --> 00:19:38,559
fine

500
00:19:38,559 --> 00:19:41,440
so another option is to add a filter for

501
00:19:41,440 --> 00:19:43,760
grandchildren

502
00:19:43,760 --> 00:19:46,000
for processes that can

503
00:19:46,000 --> 00:19:48,080
perform reconnaissance or other

504
00:19:48,080 --> 00:19:50,880
suspicious suspicious activity

505
00:19:50,880 --> 00:19:53,840
such as net.xc

506
00:19:53,840 --> 00:19:54,720
ping

507
00:19:54,720 --> 00:19:56,240
task list

508
00:19:56,240 --> 00:19:57,520
task here

509
00:19:57,520 --> 00:20:01,120
ralph and finance dr

510
00:20:01,520 --> 00:20:03,200
in addition to performing the classic

511
00:20:03,200 --> 00:20:06,080
reconnaissance activity the attackers

512
00:20:06,080 --> 00:20:08,720
also attempted to collect information

513
00:20:08,720 --> 00:20:10,559
about the domain servers

514
00:20:10,559 --> 00:20:12,880
and the domain admins users on the

515
00:20:12,880 --> 00:20:14,480
infected the

516
00:20:14,480 --> 00:20:18,840
on the victims network using the net.txt

517
00:20:18,840 --> 00:20:21,840
processes hunt this activity we look for

518
00:20:21,840 --> 00:20:24,320
any we look through for this kind of

519
00:20:24,320 --> 00:20:26,480
process tree with the command line that

520
00:20:26,480 --> 00:20:28,720
contain group of interests such as

521
00:20:28,720 --> 00:20:30,159
domain admins

522
00:20:30,159 --> 00:20:32,840
exchange install domain

523
00:20:32,840 --> 00:20:38,080
servers enterprise domain and so on

524
00:20:38,400 --> 00:20:40,559
from this behavior actually we can start

525
00:20:40,559 --> 00:20:43,120
to build and create another hunting

526
00:20:43,120 --> 00:20:44,159
query

527
00:20:44,159 --> 00:20:46,880
first we will start from the w3wp

528
00:20:46,880 --> 00:20:50,320
process that is spawning cmd.exe

529
00:20:50,320 --> 00:20:53,600
and then we will look for data txc as

530
00:20:53,600 --> 00:20:55,200
the grandchildren

531
00:20:55,200 --> 00:20:59,360
and eventually uh we can

532
00:20:59,600 --> 00:21:02,799
and eventually this net.xc has to

533
00:21:02,799 --> 00:21:05,039
contain one of the aforementioned domain

534
00:21:05,039 --> 00:21:07,120
related strings in

535
00:21:07,120 --> 00:21:10,000
its command line

536
00:21:10,720 --> 00:21:12,960
once the throat actor

537
00:21:12,960 --> 00:21:15,360
set its persistence performed its

538
00:21:15,360 --> 00:21:16,559
internal

539
00:21:16,559 --> 00:21:18,640
reconnaissance and actually set their

540
00:21:18,640 --> 00:21:19,520
goal

541
00:21:19,520 --> 00:21:22,880
they started to to move laterally

542
00:21:22,880 --> 00:21:25,760
in one instance uh we observed lateral

543
00:21:25,760 --> 00:21:28,159
movement using the w my command line

544
00:21:28,159 --> 00:21:31,520
utility or wmic dot exe

545
00:21:31,520 --> 00:21:33,520
with the command line process called

546
00:21:33,520 --> 00:21:34,720
create

547
00:21:34,720 --> 00:21:37,280
to stay under the radar the attackers

548
00:21:37,280 --> 00:21:40,559
chose the name test dot but and also

549
00:21:40,559 --> 00:21:42,799
pslog list dot but

550
00:21:42,799 --> 00:21:46,480
which can be appear legitimate

551
00:21:46,480 --> 00:21:48,960
in another reconnaissance measure the

552
00:21:48,960 --> 00:21:52,000
second skipped pslog list but objective

553
00:21:52,000 --> 00:21:53,520
was to run

554
00:21:53,520 --> 00:21:56,159
the microsoft sys internals to ps log

555
00:21:56,159 --> 00:21:57,039
list

556
00:21:57,039 --> 00:22:00,320
and saved the security logs from the

557
00:22:00,320 --> 00:22:04,480
reviewer of the last 10 days

558
00:22:06,400 --> 00:22:07,440
so

559
00:22:07,440 --> 00:22:10,400
the hardy query we could build for for

560
00:22:10,400 --> 00:22:13,520
this scenario is

561
00:22:13,520 --> 00:22:16,559
we will search for any w3wp

562
00:22:16,559 --> 00:22:19,360
processes that spawn the children of

563
00:22:19,360 --> 00:22:21,360
cmd.exe

564
00:22:21,360 --> 00:22:22,960
and then we will search for

565
00:22:22,960 --> 00:22:24,400
grandchildren

566
00:22:24,400 --> 00:22:26,799
wmic dot exe

567
00:22:26,799 --> 00:22:28,960
with the command line of process called

568
00:22:28,960 --> 00:22:31,360
create

569
00:22:32,080 --> 00:22:34,080
after completing reconnaissance and

570
00:22:34,080 --> 00:22:35,520
later

571
00:22:35,520 --> 00:22:37,760
letter movement activities uh the

572
00:22:37,760 --> 00:22:40,960
attacker executed a batch script that

573
00:22:40,960 --> 00:22:43,280
excel exfiltrated

574
00:22:43,280 --> 00:22:46,640
the same system and security registry

575
00:22:46,640 --> 00:22:50,080
hives on the exported microsoft exchange

576
00:22:50,080 --> 00:22:51,840
server machine

577
00:22:51,840 --> 00:22:53,840
using this hive the attacker could

578
00:22:53,840 --> 00:22:57,440
extract and actually crack their hashes

579
00:22:57,440 --> 00:22:59,520
for accounts that were logged into the

580
00:22:59,520 --> 00:23:00,960
server and

581
00:23:00,960 --> 00:23:03,280
potentially compromising

582
00:23:03,280 --> 00:23:08,200
also administrators credentials

583
00:23:08,240 --> 00:23:10,799
uh therefore therefore to hunt these

584
00:23:10,799 --> 00:23:13,200
activities uh all we can do is to look

585
00:23:13,200 --> 00:23:15,280
for cmd.xc

586
00:23:15,280 --> 00:23:16,400
processes

587
00:23:16,400 --> 00:23:17,640
that spawn

588
00:23:17,640 --> 00:23:21,360
reg.xc processes which contain

589
00:23:21,360 --> 00:23:23,679
the word save and also one of the

590
00:23:23,679 --> 00:23:25,120
aforementioned

591
00:23:25,120 --> 00:23:28,000
registries registry hives

592
00:23:28,000 --> 00:23:31,200
sam security and system in its command

593
00:23:31,200 --> 00:23:33,440
line

594
00:23:33,919 --> 00:23:36,960
in another activity uh we observed a

595
00:23:36,960 --> 00:23:38,640
threat actor

596
00:23:38,640 --> 00:23:41,679
executing the partial script that dumped

597
00:23:41,679 --> 00:23:44,880
the lsas file the lds process

598
00:23:44,880 --> 00:23:46,159
to do so

599
00:23:46,159 --> 00:23:48,120
the attacker used the

600
00:23:48,120 --> 00:23:50,400
randy1132.txt process

601
00:23:50,400 --> 00:23:53,520
to execute the com service dll or commas

602
00:23:53,520 --> 00:23:55,120
cs.dlf

603
00:23:55,120 --> 00:23:58,000
with the function minidab and specify

604
00:23:58,000 --> 00:24:00,640
the elsa's process id

605
00:24:00,640 --> 00:24:03,919
it then specifies also the fire location

606
00:24:03,919 --> 00:24:06,960
of the memory dump

607
00:24:07,120 --> 00:24:09,279
after extracting the registry hives the

608
00:24:09,279 --> 00:24:12,480
attacker also compressed the dumped data

609
00:24:12,480 --> 00:24:15,679
and save it into a cabinet file

610
00:24:15,679 --> 00:24:19,520
so also to masquerade it the dumped

611
00:24:19,520 --> 00:24:23,200
extracted content as a legitimate files

612
00:24:23,200 --> 00:24:26,400
doctors changed the file extension to be

613
00:24:26,400 --> 00:24:27,760
dot png

614
00:24:27,760 --> 00:24:30,240
with also a legitimate name of microsoft

615
00:24:30,240 --> 00:24:31,440
exchange

616
00:24:31,440 --> 00:24:33,919
server related name

617
00:24:33,919 --> 00:24:37,200
and also by reviewing the network log

618
00:24:37,200 --> 00:24:39,440
of this machine you could see that the

619
00:24:39,440 --> 00:24:41,919
threat actor used to

620
00:24:41,919 --> 00:24:44,480
which is another incidental

621
00:24:44,480 --> 00:24:47,520
indicator of behavior that you can hunt

622
00:24:47,520 --> 00:24:48,720
for

623
00:24:48,720 --> 00:24:50,640
before we finish we want to give credit

624
00:24:50,640 --> 00:24:52,080
to the great team who walk with us on

625
00:24:52,080 --> 00:24:55,039
this project omari empel eval foodie

626
00:24:55,039 --> 00:24:58,159
niva connor elon sokolowski met art and

627
00:24:58,159 --> 00:25:00,080
mo levy thank you all for all of your

628
00:25:00,080 --> 00:25:01,520
help

629
00:25:01,520 --> 00:25:04,400
to summarize just do it fretlanding is a

630
00:25:04,400 --> 00:25:06,640
very broad and dynamic subject and there

631
00:25:06,640 --> 00:25:08,880
are many ways to do it we hope that by

632
00:25:08,880 --> 00:25:10,320
listening to this session you feel

633
00:25:10,320 --> 00:25:12,400
encouraged to do it yourself and start

634
00:25:12,400 --> 00:25:14,799
creating an impact on your network

635
00:25:14,799 --> 00:25:16,880
happy hunting and thank you all for

636
00:25:16,880 --> 00:25:21,000
being here thank you

637
00:25:21,340 --> 00:25:24,510
[Music]

