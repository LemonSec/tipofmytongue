1
00:00:00,949 --> 00:00:04,259
all right we're gonna get ready to start

2
00:00:04,259 --> 00:00:06,540
the next session now we have Robert

3
00:00:06,540 --> 00:00:08,340
Simmons from threat connect is gonna

4
00:00:08,340 --> 00:00:11,370
talk to us about building an open-source

5
00:00:11,370 --> 00:00:13,170
and malware labs so over to you Robert

6
00:00:13,170 --> 00:00:15,780
thank you I'm just waiting for my power

7
00:00:15,780 --> 00:00:18,230
just a second

8
00:00:18,230 --> 00:00:24,990
are we plugged in okay everything needs

9
00:00:24,990 --> 00:00:27,259
power

10
00:00:59,160 --> 00:01:02,620
all right good morning everybody my name

11
00:01:02,620 --> 00:01:05,340
is Rob Simmons I go by boot Cano's

12
00:01:05,340 --> 00:01:08,650
that's my handle it means duckbill

13
00:01:08,650 --> 00:01:12,640
platypus and Russian and I am the

14
00:01:12,640 --> 00:01:14,560
director of research innovation at

15
00:01:14,560 --> 00:01:17,020
Direct Connect I run a team of

16
00:01:17,020 --> 00:01:20,140
researchers and it's a great company to

17
00:01:20,140 --> 00:01:24,009
work for I have a lot of fun there so

18
00:01:24,009 --> 00:01:26,130
what are we going to talk about today

19
00:01:26,130 --> 00:01:29,680
I'm gonna talk about what I have as a

20
00:01:29,680 --> 00:01:32,500
concept of a malware lab sort of a very

21
00:01:32,500 --> 00:01:35,259
simple one but why what I wanted to

22
00:01:35,259 --> 00:01:36,970
start with is why would you need in our

23
00:01:36,970 --> 00:01:39,700
lab I guess I'm preaching to the choir

24
00:01:39,700 --> 00:01:42,160
here in this particular crowd as to why

25
00:01:42,160 --> 00:01:44,369
you would need a malware lab but

26
00:01:44,369 --> 00:01:47,350
basically you need to have automated

27
00:01:47,350 --> 00:01:50,679
malware analysis and the the need for

28
00:01:50,679 --> 00:01:54,280
this is based on the volume of malware

29
00:01:54,280 --> 00:01:55,539
that you get even in a small

30
00:01:55,539 --> 00:01:58,810
organization and on the on the side of

31
00:01:58,810 --> 00:02:02,140
the slide here this is from Lenny's

32
00:02:02,140 --> 00:02:05,530
ulcers website and this is the

33
00:02:05,530 --> 00:02:07,840
increasing levels of difficulty in the

34
00:02:07,840 --> 00:02:10,179
different stages of malware analysis and

35
00:02:10,179 --> 00:02:12,670
so today I'm going to be talking about

36
00:02:12,670 --> 00:02:14,530
the bottom two stages and they're the

37
00:02:14,530 --> 00:02:18,400
easiest to automate so the the first one

38
00:02:18,400 --> 00:02:21,040
is fully automated malware analysis and

39
00:02:21,040 --> 00:02:23,170
then also static properties analysis and

40
00:02:23,170 --> 00:02:25,799
I'm not going to be talking about manual

41
00:02:25,799 --> 00:02:29,470
manual analysis or code reversing today

42
00:02:29,470 --> 00:02:32,560
but what are the things that you get as

43
00:02:32,560 --> 00:02:34,600
a benefit from a automated malware

44
00:02:34,600 --> 00:02:36,640
analysis system you can enhance your

45
00:02:36,640 --> 00:02:38,769
threat intelligence program if you have

46
00:02:38,769 --> 00:02:42,280
hunt teams hunt teams and internal teams

47
00:02:42,280 --> 00:02:44,590
such as this would need to be we need to

48
00:02:44,590 --> 00:02:46,510
have access to an automated malware

49
00:02:46,510 --> 00:02:49,329
analysis system to get some of the easy

50
00:02:49,329 --> 00:02:52,750
tasks done in an automated way it's also

51
00:02:52,750 --> 00:02:54,940
important for network defense if you

52
00:02:54,940 --> 00:02:57,400
have a mail server you're going to want

53
00:02:57,400 --> 00:02:59,590
to look at and detonate any of the

54
00:02:59,590 --> 00:03:01,690
attachments that are not you know

55
00:03:01,690 --> 00:03:04,600
obviously encrypted but also you have

56
00:03:04,600 --> 00:03:06,549
network traffic if you want to carve out

57
00:03:06,549 --> 00:03:08,349
files that are coming in to your network

58
00:03:08,349 --> 00:03:10,989
or leaving your network it's a good idea

59
00:03:10,989 --> 00:03:12,250
to

60
00:03:12,250 --> 00:03:13,810
detonate those as well in an automated

61
00:03:13,810 --> 00:03:16,050
Malheur analysis system and then finally

62
00:03:16,050 --> 00:03:18,640
many endpoint protection systems if they

63
00:03:18,640 --> 00:03:21,220
have a file that hasn't been observed or

64
00:03:21,220 --> 00:03:24,190
known it will be reported to a central

65
00:03:24,190 --> 00:03:25,720
server and then that from that

66
00:03:25,720 --> 00:03:28,300
repository you also want to run those

67
00:03:28,300 --> 00:03:29,470
through an automated malware analysis

68
00:03:29,470 --> 00:03:34,990
system so my concept here is that there

69
00:03:34,990 --> 00:03:37,270
are a number of basic entry points into

70
00:03:37,270 --> 00:03:39,130
the malware analysis process

71
00:03:39,130 --> 00:03:41,620
I usually go into detail about what each

72
00:03:41,620 --> 00:03:43,480
one of these are but I think with this

73
00:03:43,480 --> 00:03:45,520
particular group I don't need to tell

74
00:03:45,520 --> 00:03:48,970
you what a file or URL is a pcap is a

75
00:03:48,970 --> 00:03:51,520
packet capture of network traffic

76
00:03:51,520 --> 00:03:54,370
between two points in time basically a

77
00:03:54,370 --> 00:03:56,980
recording and then a memory image is

78
00:03:56,980 --> 00:03:59,530
also at one point in time an image of

79
00:03:59,530 --> 00:04:02,910
what is in volatile memory on a computer

80
00:04:02,910 --> 00:04:05,770
so for each one of these particular

81
00:04:05,770 --> 00:04:07,780
entry points into the malware analysis

82
00:04:07,780 --> 00:04:11,380
process I have chosen what is in my

83
00:04:11,380 --> 00:04:13,750
opinion one of the better tools and all

84
00:04:13,750 --> 00:04:16,478
of these are open source so KooKoo

85
00:04:16,478 --> 00:04:19,209
sandbox is my go-to for processing files

86
00:04:19,209 --> 00:04:22,510
of all types Thug if you are familiar

87
00:04:22,510 --> 00:04:24,580
with thug Thug is a low interaction

88
00:04:24,580 --> 00:04:27,310
honey client which pretends basically to

89
00:04:27,310 --> 00:04:30,130
be a browser and so it visits a URL and

90
00:04:30,130 --> 00:04:32,560
its goal is to get a payload from a

91
00:04:32,560 --> 00:04:36,060
drive-by or from a download URL bro

92
00:04:36,060 --> 00:04:38,380
interestingly enough bro is a network

93
00:04:38,380 --> 00:04:40,510
security monitoring tool I'm actually

94
00:04:40,510 --> 00:04:42,460
not going to be talking about bro in the

95
00:04:42,460 --> 00:04:44,200
context of network security monitoring

96
00:04:44,200 --> 00:04:47,979
and we're going to go into into you know

97
00:04:47,979 --> 00:04:51,040
a little bit of depth with bro as a

98
00:04:51,040 --> 00:04:53,830
malware analysis tool and then finally

99
00:04:53,830 --> 00:04:56,020
volatility this is the tool that I used

100
00:04:56,020 --> 00:05:00,640
to analyze memory images so we'll start

101
00:05:00,640 --> 00:05:03,850
with kuku sandbox and there are a couple

102
00:05:03,850 --> 00:05:05,710
of different you know qualities of kuku

103
00:05:05,710 --> 00:05:09,490
so it has a it it like any sandbox is a

104
00:05:09,490 --> 00:05:11,110
controlled safe environment for

105
00:05:11,110 --> 00:05:14,380
observing the behavior of malware you

106
00:05:14,380 --> 00:05:16,570
could have a closed network where you

107
00:05:16,570 --> 00:05:18,370
can observe the malware calling back to

108
00:05:18,370 --> 00:05:20,650
something like I netsim or you can have

109
00:05:20,650 --> 00:05:22,570
it open to the Internet and have it call

110
00:05:22,570 --> 00:05:25,169
back to you know malicious

111
00:05:25,169 --> 00:05:27,389
command and control servers so it

112
00:05:27,389 --> 00:05:29,999
leverages virtual machines it can also

113
00:05:29,999 --> 00:05:33,740
use bare metal analysis machines and

114
00:05:33,740 --> 00:05:36,419
essentially it performs static analysis

115
00:05:36,419 --> 00:05:38,819
in addition because static analysis

116
00:05:38,819 --> 00:05:40,650
doesn't take a lot of time or resources

117
00:05:40,650 --> 00:05:44,759
on a server and so the you know the more

118
00:05:44,759 --> 00:05:47,789
resources are used for VMs and so at the

119
00:05:47,789 --> 00:05:49,379
same time you can do the small amount of

120
00:05:49,379 --> 00:05:51,479
static analysis that you need to at the

121
00:05:51,479 --> 00:05:56,300
same time with nearly no cost so I

122
00:05:56,300 --> 00:05:58,860
usually have a longer form of this talk

123
00:05:58,860 --> 00:06:01,379
but I wanted to drill down into some of

124
00:06:01,379 --> 00:06:02,939
the techniques that I've developed that

125
00:06:02,939 --> 00:06:05,789
are kind of interesting and actually

126
00:06:05,789 --> 00:06:08,279
this is one where you would look at file

127
00:06:08,279 --> 00:06:10,469
metadata and look at the compiled time

128
00:06:10,469 --> 00:06:12,990
stamp of a particular file and what's

129
00:06:12,990 --> 00:06:16,139
interesting is if you look at the time

130
00:06:16,139 --> 00:06:20,389
of submission to public sandbox such as

131
00:06:20,389 --> 00:06:24,029
malware or the extreme hybrid analysis

132
00:06:24,029 --> 00:06:27,389
or if you look at virus total you can

133
00:06:27,389 --> 00:06:30,330
see first of all this this file was

134
00:06:30,330 --> 00:06:35,009
compiled at this time so 941 and then if

135
00:06:35,009 --> 00:06:36,990
you look at the submission time when it

136
00:06:36,990 --> 00:06:40,199
was seen by that particular public

137
00:06:40,199 --> 00:06:42,750
system you see that those two time

138
00:06:42,750 --> 00:06:45,210
stamps are very very close together so

139
00:06:45,210 --> 00:06:47,819
it can be assumed that probably the

140
00:06:47,819 --> 00:06:49,830
person who compiled this piece of

141
00:06:49,830 --> 00:06:52,050
malware has submitted it to that service

142
00:06:52,050 --> 00:06:54,029
some of these services do give you a

143
00:06:54,029 --> 00:06:55,469
little bit of information on the

144
00:06:55,469 --> 00:06:57,960
identity of that entity that submitted

145
00:06:57,960 --> 00:07:00,270
it this is actually a submitter hash

146
00:07:00,270 --> 00:07:01,259
from virustotal

147
00:07:01,259 --> 00:07:03,680
so this file was submitted by this

148
00:07:03,680 --> 00:07:07,379
submitter hash via web and from russia

149
00:07:07,379 --> 00:07:09,839
and so now you can hunt for that

150
00:07:09,839 --> 00:07:12,779
particular individual and with a fairly

151
00:07:12,779 --> 00:07:16,589
high you know high probability of it

152
00:07:16,589 --> 00:07:19,560
being the same author of this malware

153
00:07:19,560 --> 00:07:22,229
you can then say anything that this

154
00:07:22,229 --> 00:07:23,999
particular individual submits the virus

155
00:07:23,999 --> 00:07:25,560
total is probably going to be malicious

156
00:07:25,560 --> 00:07:28,830
so I want to go ahead and and flag it or

157
00:07:28,830 --> 00:07:33,449
analyze it more in depth so kuku comes

158
00:07:33,449 --> 00:07:35,969
in a number of different flavors so the

159
00:07:35,969 --> 00:07:38,470
current stable version is 1.2

160
00:07:38,470 --> 00:07:40,930
I would not recommend using one point to

161
00:07:40,930 --> 00:07:43,570
the next generation is 2.0 and it's at

162
00:07:43,570 --> 00:07:45,580
release candidate one it's been at

163
00:07:45,580 --> 00:07:47,020
release candidate one for a little bit

164
00:07:47,020 --> 00:07:50,950
of time but it is you know it is usable

165
00:07:50,950 --> 00:07:52,630
so I would recommend going with that

166
00:07:52,630 --> 00:07:55,330
there's an alternative the Braddock

167
00:07:55,330 --> 00:07:57,730
you've ant or spender sandbox which is

168
00:07:57,730 --> 00:08:00,490
also known as cuckoo modified this one

169
00:08:00,490 --> 00:08:03,730
was a fork of the the earlier version of

170
00:08:03,730 --> 00:08:05,650
cuckoo with a couple of things that were

171
00:08:05,650 --> 00:08:10,030
fixed that were outstanding bugs or

172
00:08:10,030 --> 00:08:12,400
outstanding problems with cuckoo and one

173
00:08:12,400 --> 00:08:15,790
of them was and I have usually have a

174
00:08:15,790 --> 00:08:17,830
lot more slides about cuckoo but this is

175
00:08:17,830 --> 00:08:20,110
a kind of a abbreviated talk so I wanted

176
00:08:20,110 --> 00:08:21,910
to talk about one thing that and focus

177
00:08:21,910 --> 00:08:26,230
on one idea that the cuckoo modified and

178
00:08:26,230 --> 00:08:28,330
new cuckoo are able to do so

179
00:08:28,330 --> 00:08:31,030
normalization of registry paths a normal

180
00:08:31,030 --> 00:08:33,099
normal is a ssin of drop file paths and

181
00:08:33,099 --> 00:08:35,500
it's really important because as you can

182
00:08:35,500 --> 00:08:37,750
see when it's not normalized those two

183
00:08:37,750 --> 00:08:40,330
different paths are essentially the same

184
00:08:40,330 --> 00:08:43,240
but one is on XP and one is on Windows 7

185
00:08:43,240 --> 00:08:45,490
so if you're doing data science about

186
00:08:45,490 --> 00:08:48,160
the particular paths you're basically

187
00:08:48,160 --> 00:08:49,930
you have two different data sets here

188
00:08:49,930 --> 00:08:51,640
that are not compatible so if you

189
00:08:51,640 --> 00:08:53,620
normalize it you then use the

190
00:08:53,620 --> 00:08:55,720
environment variable app data and then

191
00:08:55,720 --> 00:08:58,600
you have a you have two sources of data

192
00:08:58,600 --> 00:09:02,020
for maybe XP VMs and Windows 7 VMs but

193
00:09:02,020 --> 00:09:04,230
now you have a data set that you can use

194
00:09:04,230 --> 00:09:08,350
that's completely normalized so what

195
00:09:08,350 --> 00:09:11,260
happens if the malware is VM aware you

196
00:09:11,260 --> 00:09:14,680
know this is an important thing to pay

197
00:09:14,680 --> 00:09:17,620
attention to so there's two tools that

198
00:09:17,620 --> 00:09:20,290
you can use to discover if discover if

199
00:09:20,290 --> 00:09:23,040
your sandbox is vulnerable to certain

200
00:09:23,040 --> 00:09:25,750
anti analysis techniques and then

201
00:09:25,750 --> 00:09:28,080
another tool that you can use to prevent

202
00:09:28,080 --> 00:09:31,030
malware from finding out that it's in a

203
00:09:31,030 --> 00:09:33,790
sandbox or in a VM so the first one is

204
00:09:33,790 --> 00:09:35,860
Posche or paranoid fish

205
00:09:35,860 --> 00:09:38,200
it's a executable that you run through

206
00:09:38,200 --> 00:09:40,900
your sandbox and it tells you it gives

207
00:09:40,900 --> 00:09:44,050
you a little readout like here and it

208
00:09:44,050 --> 00:09:45,820
tells you if it's able to find certain

209
00:09:45,820 --> 00:09:49,330
registry keys and other indicators that

210
00:09:49,330 --> 00:09:50,259
it's in

211
00:09:50,259 --> 00:09:53,439
VM or in an analysis environment and

212
00:09:53,439 --> 00:09:55,509
then the second tool here is VM cloak

213
00:09:55,509 --> 00:09:57,579
it's written by one of the members of

214
00:09:57,579 --> 00:10:01,600
the kuku sandbox project and what it

215
00:10:01,600 --> 00:10:04,389
does is obfuscates the indicators that

216
00:10:04,389 --> 00:10:06,970
your that paw fish is looking for so

217
00:10:06,970 --> 00:10:09,009
moves them around changes some things

218
00:10:09,009 --> 00:10:12,429
and so basically makes the it hardens

219
00:10:12,429 --> 00:10:14,859
the VM against the now anti analysis

220
00:10:14,859 --> 00:10:18,339
techniques so these are two very good

221
00:10:18,339 --> 00:10:21,699
tools even if you're not using kuku in

222
00:10:21,699 --> 00:10:23,529
your automated malware analysis system

223
00:10:23,529 --> 00:10:27,189
it's good to look at at least run Popish

224
00:10:27,189 --> 00:10:29,709
through your system to see what what it

225
00:10:29,709 --> 00:10:33,249
may be missing so let's move on to thug

226
00:10:33,249 --> 00:10:35,799
so thug is a low interaction honey

227
00:10:35,799 --> 00:10:39,369
client it pretends to be a browser it's

228
00:10:39,369 --> 00:10:41,709
written completely in Python and it uses

229
00:10:41,709 --> 00:10:44,169
different libraries to basically pretend

230
00:10:44,169 --> 00:10:47,769
to be a browser and the goal of thug is

231
00:10:47,769 --> 00:10:50,619
to trigger a drive-by download and to

232
00:10:50,619 --> 00:10:53,199
capture its payload for further analysis

233
00:10:53,199 --> 00:10:56,649
so thug does not analyze any files that

234
00:10:56,649 --> 00:10:58,989
it downloads but what you would want to

235
00:10:58,989 --> 00:11:00,609
do and this is also in my paper

236
00:11:00,609 --> 00:11:03,609
basically connect thug and automate it

237
00:11:03,609 --> 00:11:06,179
so that thug files that thug you know

238
00:11:06,179 --> 00:11:09,309
captures from a URL are then sent to you

239
00:11:09,309 --> 00:11:11,949
kuku for analysis it's also good to have

240
00:11:11,949 --> 00:11:14,919
a packet capture of the thug session and

241
00:11:14,919 --> 00:11:16,600
then analyze that with bro which we'll

242
00:11:16,600 --> 00:11:20,410
see in a moment so bro is a network

243
00:11:20,410 --> 00:11:23,859
analysis framework and I am I'm

244
00:11:23,859 --> 00:11:26,019
basically going to abuse the concept of

245
00:11:26,019 --> 00:11:27,489
bro and use it for a completely

246
00:11:27,489 --> 00:11:31,089
different purpose today so it's a

247
00:11:31,089 --> 00:11:33,369
network security monitoring framework it

248
00:11:33,369 --> 00:11:36,249
you processes live packet capture or it

249
00:11:36,249 --> 00:11:38,679
can process recorded packet capture of

250
00:11:38,679 --> 00:11:39,189
pcaps

251
00:11:39,189 --> 00:11:41,559
and it's made up of a series of scripts

252
00:11:41,559 --> 00:11:44,169
so it's very open-ended as to what you

253
00:11:44,169 --> 00:11:46,749
can do with it it's packaged with a

254
00:11:46,749 --> 00:11:48,579
large group of scripts out of the box

255
00:11:48,579 --> 00:11:50,859
and then there's a lot of people that

256
00:11:50,859 --> 00:11:52,809
create their own open-source scripts and

257
00:11:52,809 --> 00:11:54,789
contribute them typically you'll find

258
00:11:54,789 --> 00:11:57,009
them all over the place on github you

259
00:11:57,009 --> 00:11:58,809
can also write your own bro scripts for

260
00:11:58,809 --> 00:12:01,720
your own needs and so today I'm not

261
00:12:01,720 --> 00:12:03,100
going to think about it from that

262
00:12:03,100 --> 00:12:03,540
perspective

263
00:12:03,540 --> 00:12:07,080
and also I'm not going to use any bro

264
00:12:07,080 --> 00:12:08,550
scripts that aren't in the

265
00:12:08,550 --> 00:12:10,770
out-of-the-box version of bro so what

266
00:12:10,770 --> 00:12:12,330
we're gonna talk about today uses some

267
00:12:12,330 --> 00:12:15,240
of the basic capabilities of bro so I

268
00:12:15,240 --> 00:12:18,720
wanted to expose some of the really

269
00:12:18,720 --> 00:12:21,090
great qualities of bro and if you want

270
00:12:21,090 --> 00:12:23,370
to you can on your own later follow

271
00:12:23,370 --> 00:12:25,980
along with what I've done this is the

272
00:12:25,980 --> 00:12:28,020
sha-1 hash of the file that I'm going to

273
00:12:28,020 --> 00:12:30,510
analyze that was the source of the pcap

274
00:12:30,510 --> 00:12:32,940
so hybrid analysis com public site I

275
00:12:32,940 --> 00:12:35,100
think you would need to sign up for an

276
00:12:35,100 --> 00:12:36,780
account but the account is free to be

277
00:12:36,780 --> 00:12:40,830
able to download the peak app and as you

278
00:12:40,830 --> 00:12:42,240
can see at the top so our analysis

279
00:12:42,240 --> 00:12:46,950
target is a word document so the first

280
00:12:46,950 --> 00:12:48,150
thing you want to do is look at the

281
00:12:48,150 --> 00:12:52,050
connection log and the incantation at

282
00:12:52,050 --> 00:12:55,560
the top narrows the connection log down

283
00:12:55,560 --> 00:12:58,170
to just the columns that I'm interested

284
00:12:58,170 --> 00:12:58,670
in

285
00:12:58,670 --> 00:13:02,670
bro-bro output is basically text with a

286
00:13:02,670 --> 00:13:04,800
number of columns of all the different

287
00:13:04,800 --> 00:13:06,210
that are the outputs of the different

288
00:13:06,210 --> 00:13:10,050
components in a script so there are

289
00:13:10,050 --> 00:13:11,550
things that you're going to see that are

290
00:13:11,550 --> 00:13:14,610
natural like normal benign traffic that

291
00:13:14,610 --> 00:13:16,440
you're going to find from any sandbox

292
00:13:16,440 --> 00:13:18,420
session so you want to make sure that

293
00:13:18,420 --> 00:13:21,480
you know what the benign traffic is

294
00:13:21,480 --> 00:13:23,460
that's in your sandbox and make sure

295
00:13:23,460 --> 00:13:25,890
that you scrub that out of your final

296
00:13:25,890 --> 00:13:28,980
results and then the next thing you want

297
00:13:28,980 --> 00:13:30,900
to analyze of course is the DNS traffic

298
00:13:30,900 --> 00:13:34,170
this is very rich information and then

299
00:13:34,170 --> 00:13:36,840
bro is very good at finding what the

300
00:13:36,840 --> 00:13:41,460
traffic service and protocol are but

301
00:13:41,460 --> 00:13:44,100
sorry got it got ahead of myself so the

302
00:13:44,100 --> 00:13:46,470
HTTP traffic this is going to be also

303
00:13:46,470 --> 00:13:49,830
very interesting c2 traffic but this is

304
00:13:49,830 --> 00:13:52,530
what I call the WTF traffic if bro can't

305
00:13:52,530 --> 00:13:54,960
figure out what the what the service is

306
00:13:54,960 --> 00:13:57,810
it's probably something that is made up

307
00:13:57,810 --> 00:13:59,430
by the malware author and it doesn't fit

308
00:13:59,430 --> 00:14:01,890
within some of the the signatures that

309
00:14:01,890 --> 00:14:04,290
bro has so that is very important to

310
00:14:04,290 --> 00:14:07,890
look at so if you have a if you have a

311
00:14:07,890 --> 00:14:10,020
word doc then probably your Macaroni is

312
00:14:10,020 --> 00:14:12,210
infected there's something very very

313
00:14:12,210 --> 00:14:12,720
wrong

314
00:14:12,720 --> 00:14:14,640
if you have a word doc and you've opened

315
00:14:14,640 --> 00:14:16,280
it and it's calling back to that

316
00:14:16,280 --> 00:14:18,770
IP addresses and making that many DNS

317
00:14:18,770 --> 00:14:22,670
requests so the first thing we want to

318
00:14:22,670 --> 00:14:26,870
look at next is the DNS log so the DNS

319
00:14:26,870 --> 00:14:28,760
log gives us a lot of information you

320
00:14:28,760 --> 00:14:32,540
have these are you know some basic

321
00:14:32,540 --> 00:14:35,360
benign traffic's you want to scrub that

322
00:14:35,360 --> 00:14:39,020
out but here we have a couple of very

323
00:14:39,020 --> 00:14:42,050
interesting callbacks and so we have

324
00:14:42,050 --> 00:14:45,260
hooked outdoors dint Tabo go and then a

325
00:14:45,260 --> 00:14:48,800
s web coms s web coms it looks like it

326
00:14:48,800 --> 00:14:50,870
has some sort of round robin DNS going

327
00:14:50,870 --> 00:14:54,770
on which you know for a legitimate site

328
00:14:54,770 --> 00:14:57,500
is possible but I've also seen this for

329
00:14:57,500 --> 00:15:00,170
malware so this is but this is an

330
00:15:00,170 --> 00:15:01,790
interesting thing and we might want to

331
00:15:01,790 --> 00:15:06,440
look at it further so I go and you know

332
00:15:06,440 --> 00:15:09,290
I I want to only expose things that are

333
00:15:09,290 --> 00:15:12,500
free or open source here so I'm not

334
00:15:12,500 --> 00:15:14,840
going to talk about some of the paid PB

335
00:15:14,840 --> 00:15:17,890
NS services but I want to show you a

336
00:15:17,890 --> 00:15:20,930
poor-man's P DNS technique so if you go

337
00:15:20,930 --> 00:15:25,130
to Bing and you type in the index of IP

338
00:15:25,130 --> 00:15:27,980
colon and then type in the IP address

339
00:15:27,980 --> 00:15:31,070
Bing will show you a list of sites that

340
00:15:31,070 --> 00:15:32,870
it has crawled that resolved to that IP

341
00:15:32,870 --> 00:15:36,290
address so this is a really good quick

342
00:15:36,290 --> 00:15:40,520
poor-man's DNS poor-man's P DNS so as

343
00:15:40,520 --> 00:15:42,140
you can see this particular IP address

344
00:15:42,140 --> 00:15:43,910
and this is the one at the top for

345
00:15:43,910 --> 00:15:46,339
hooked outdoors this IP address has a

346
00:15:46,339 --> 00:15:48,380
lot of different sites that are resolved

347
00:15:48,380 --> 00:15:50,270
to it so I'm going to assume for now

348
00:15:50,270 --> 00:15:54,200
that this is a multi-tenant web server

349
00:15:54,200 --> 00:15:56,810
so this is a good indicator this is a

350
00:15:56,810 --> 00:15:59,240
compromised website and I go and visit

351
00:15:59,240 --> 00:16:01,460
the website of course and it looks like

352
00:16:01,460 --> 00:16:03,920
someone's phishing site and if you look

353
00:16:03,920 --> 00:16:06,110
at the top it's kind of hard to see but

354
00:16:06,110 --> 00:16:09,080
there's a little Drupal icon there so

355
00:16:09,080 --> 00:16:10,730
I'm going to assume I know exactly how

356
00:16:10,730 --> 00:16:15,410
they got in so that's a compromised

357
00:16:15,410 --> 00:16:17,450
website so that's a you know first red

358
00:16:17,450 --> 00:16:19,730
flag now let's look at the next one so

359
00:16:19,730 --> 00:16:23,210
dint Tabo go this one using for man's

360
00:16:23,210 --> 00:16:25,310
DNS P D and s it doesn't have any

361
00:16:25,310 --> 00:16:27,470
resolution so chances are this is

362
00:16:27,470 --> 00:16:28,990
something that was stood up specific

363
00:16:28,990 --> 00:16:31,959
for this attack and then looking in

364
00:16:31,959 --> 00:16:34,380
domain tools we've got a very recent

365
00:16:34,380 --> 00:16:38,070
creation date and then we also have a

366
00:16:38,070 --> 00:16:40,630
email address down there that we can use

367
00:16:40,630 --> 00:16:44,980
to pivot to other other domains so again

368
00:16:44,980 --> 00:16:47,649
I'm going to do some poor man's reverse

369
00:16:47,649 --> 00:16:50,020
here is and so just Google the Google

370
00:16:50,020 --> 00:16:53,200
the email address and as you can see

371
00:16:53,200 --> 00:16:54,790
down in the bottom we've got another two

372
00:16:54,790 --> 00:16:57,520
domains that were registered using the

373
00:16:57,520 --> 00:16:59,500
same email address and then also there's

374
00:16:59,500 --> 00:17:01,180
sort of a a good indicator that

375
00:17:01,180 --> 00:17:03,010
something is wrong because threat I

376
00:17:03,010 --> 00:17:04,890
think threat crowd and a couple of other

377
00:17:04,890 --> 00:17:08,589
malware focused websites are have been

378
00:17:08,589 --> 00:17:11,050
talking about this particular email

379
00:17:11,050 --> 00:17:14,829
address so something is up here and then

380
00:17:14,829 --> 00:17:16,569
I go to the site and there's no content

381
00:17:16,569 --> 00:17:18,490
unable to connect so it's not running a

382
00:17:18,490 --> 00:17:20,020
web server at least it's not running a

383
00:17:20,020 --> 00:17:27,609
web server on port 80 or poor 443 so so

384
00:17:27,609 --> 00:17:30,340
the next thing we want to look at is ass

385
00:17:30,340 --> 00:17:33,429
web coms and so I cycled through all

386
00:17:33,429 --> 00:17:35,500
those and look at this it also has a

387
00:17:35,500 --> 00:17:39,490
recent a recent date and then it has an

388
00:17:39,490 --> 00:17:41,679
email address but the email address is

389
00:17:41,679 --> 00:17:43,780
an email address at the web site so it

390
00:17:43,780 --> 00:17:45,309
doesn't give me something I can pivot to

391
00:17:45,309 --> 00:17:48,370
other things too but it has a name

392
00:17:48,370 --> 00:17:50,679
server and if I I did go a little bit

393
00:17:50,679 --> 00:17:53,830
deeper on the name server and found this

394
00:17:53,830 --> 00:17:56,620
is probably a name server that has many

395
00:17:56,620 --> 00:18:00,010
other malicious domains on it so going

396
00:18:00,010 --> 00:18:02,410
through we've got from this particular

397
00:18:02,410 --> 00:18:05,679
IP address my assumption is that there's

398
00:18:05,679 --> 00:18:08,050
going to be more maliciousness there so

399
00:18:08,050 --> 00:18:12,070
I've done P DNS query and I found you

400
00:18:12,070 --> 00:18:13,900
know there's a lot of nonsensical name

401
00:18:13,900 --> 00:18:15,790
domains these are obviously something

402
00:18:15,790 --> 00:18:18,010
that were either just you know keyboard

403
00:18:18,010 --> 00:18:21,580
mash or a DGA of some kind so we've got

404
00:18:21,580 --> 00:18:23,290
another set of indicators surrounding

405
00:18:23,290 --> 00:18:28,420
this so moving on to the HTTP log so in

406
00:18:28,420 --> 00:18:30,250
the HTTP log we've got a lot of

407
00:18:30,250 --> 00:18:33,760
different fun things to look at so we've

408
00:18:33,760 --> 00:18:39,550
got some ahoy slash gate PHP this I'm

409
00:18:39,550 --> 00:18:42,080
going to talk about in just a moment

410
00:18:42,080 --> 00:18:45,289
oh boy by the way a little Russian

411
00:18:45,289 --> 00:18:48,080
language lesson for you as a boy is a

412
00:18:48,080 --> 00:18:49,190
term used in Russia and other

413
00:18:49,190 --> 00:18:51,710
post-soviet states to describe alcohol

414
00:18:51,710 --> 00:18:54,860
abuse or behavior alcohol abuse behavior

415
00:18:54,860 --> 00:18:57,019
resulting in two or more days of

416
00:18:57,019 --> 00:18:59,929
continuous drunkenness so most of your

417
00:18:59,929 --> 00:19:04,429
hacker conferences are as a boy so but

418
00:19:04,429 --> 00:19:05,750
also if you think about it this is a

419
00:19:05,750 --> 00:19:07,220
little bit of a little bit of a

420
00:19:07,220 --> 00:19:12,019
breadcrumb as to at least the language

421
00:19:12,019 --> 00:19:13,549
of the person that I'm dealing with here

422
00:19:13,549 --> 00:19:17,870
that wrote some of this malware so just

423
00:19:17,870 --> 00:19:20,690
so you know if you look it up as a boy

424
00:19:20,690 --> 00:19:23,809
is a pony this is an indicator of this

425
00:19:23,809 --> 00:19:26,450
being the pony family of malware and

426
00:19:26,450 --> 00:19:29,299
then if we look here this sort of

427
00:19:29,299 --> 00:19:32,899
gobbledygook slash index dot PHP from

428
00:19:32,899 --> 00:19:35,899
the HTTP log this is an indicator of

429
00:19:35,899 --> 00:19:36,529
naima

430
00:19:36,529 --> 00:19:39,980
so from here doing a little bit more

431
00:19:39,980 --> 00:19:42,590
googling again just google those that

432
00:19:42,590 --> 00:19:46,070
that you pile of information and we come

433
00:19:46,070 --> 00:19:50,059
up with a very good report on threat

434
00:19:50,059 --> 00:19:52,909
geek saying that these this collection

435
00:19:52,909 --> 00:19:56,149
of indicators is something that the man

436
00:19:56,149 --> 00:19:59,230
one adversary group uses commonly so

437
00:19:59,230 --> 00:20:01,399
with a pretty high confidence I can

438
00:20:01,399 --> 00:20:03,620
think that that's what you know the the

439
00:20:03,620 --> 00:20:05,870
never quest man one group is who I'm

440
00:20:05,870 --> 00:20:08,269
working with at the moment so what have

441
00:20:08,269 --> 00:20:10,309
we learned from pcap only so this is the

442
00:20:10,309 --> 00:20:12,409
I've made this sort of an exercise where

443
00:20:12,409 --> 00:20:14,299
I'm only using pcap it's sort of like

444
00:20:14,299 --> 00:20:16,940
taking a cup and listening to what

445
00:20:16,940 --> 00:20:18,409
people what the malware is saying in the

446
00:20:18,409 --> 00:20:21,620
next room so our adversary is likely

447
00:20:21,620 --> 00:20:24,080
Rousseff owned an office an office

448
00:20:24,080 --> 00:20:25,940
document generating network traffic that

449
00:20:25,940 --> 00:20:27,919
is a very bad thing

450
00:20:27,919 --> 00:20:30,190
it's multi-stage malware because I saw

451
00:20:30,190 --> 00:20:34,389
callbacks from not one but two or more

452
00:20:34,389 --> 00:20:37,639
different malware family strains and so

453
00:20:37,639 --> 00:20:41,360
one payload is Pony one is nyam nyam has

454
00:20:41,360 --> 00:20:43,460
a dedicated infrastructure we saw that

455
00:20:43,460 --> 00:20:45,679
and it possibly has a rogue DNS server

456
00:20:45,679 --> 00:20:46,970
working for it

457
00:20:46,970 --> 00:20:49,070
and The Dropper uses compromised Drupal

458
00:20:49,070 --> 00:20:51,710
web sites and the adversary may be man

459
00:20:51,710 --> 00:20:52,530
one so

460
00:20:52,530 --> 00:20:55,020
we have a lot of TTP's here that we can

461
00:20:55,020 --> 00:20:58,770
use to develop you know intel on what's

462
00:20:58,770 --> 00:21:03,450
happening so moving on so volatility

463
00:21:03,450 --> 00:21:04,890
volatility is a memory analysis

464
00:21:04,890 --> 00:21:08,640
framework and the framework extracts

465
00:21:08,640 --> 00:21:11,160
artifacts from samples of volatile

466
00:21:11,160 --> 00:21:14,730
memory you can using some tools from the

467
00:21:14,730 --> 00:21:16,710
recall project you could actually do

468
00:21:16,710 --> 00:21:20,310
live dumps and live analysis but what

469
00:21:20,310 --> 00:21:22,470
I'm talking about here is a previously

470
00:21:22,470 --> 00:21:25,170
captured memory image and it gives you a

471
00:21:25,170 --> 00:21:27,450
really amazing view into basically what

472
00:21:27,450 --> 00:21:30,240
the Mauer is thinking if a pcap gives

473
00:21:30,240 --> 00:21:31,800
you a view into what the malware is

474
00:21:31,800 --> 00:21:34,740
saying the volatility will give you a

475
00:21:34,740 --> 00:21:36,390
view into what the malware is thinking

476
00:21:36,390 --> 00:21:39,930
so let's do that same exercise and see

477
00:21:39,930 --> 00:21:42,450
what you can see only with volatility so

478
00:21:42,450 --> 00:21:45,870
again by the way if you have a file that

479
00:21:45,870 --> 00:21:50,040
is a DX e or 1 dot exe or b dot exe it

480
00:21:50,040 --> 00:21:54,060
is nearly always malware never trust

481
00:21:54,060 --> 00:21:57,630
something that's like d exe so again you

482
00:21:57,630 --> 00:22:00,000
can follow along at home with this

483
00:22:00,000 --> 00:22:02,480
that's the sha-1 of this particular file

484
00:22:02,480 --> 00:22:06,450
so and I always want to make sure that

485
00:22:06,450 --> 00:22:08,460
when I have beaten my head against the

486
00:22:08,460 --> 00:22:10,470
brick wall and made you know made a

487
00:22:10,470 --> 00:22:12,570
mistake over and over and over and if I

488
00:22:12,570 --> 00:22:14,640
can figure out how to avoid doing that

489
00:22:14,640 --> 00:22:16,980
again I want to definitely share that

490
00:22:16,980 --> 00:22:20,310
with everybody so this incantation and I

491
00:22:20,310 --> 00:22:22,380
know the slides are going to be at the

492
00:22:22,380 --> 00:22:25,380
virus Bolton site after at some point

493
00:22:25,380 --> 00:22:27,450
after this you don't you don't have to

494
00:22:27,450 --> 00:22:29,400
take a picture of this you can actually

495
00:22:29,400 --> 00:22:31,800
just copy and paste this from the slides

496
00:22:31,800 --> 00:22:35,070
but this is how you dump a memory image

497
00:22:35,070 --> 00:22:39,030
from a running VirtualBox VM you need to

498
00:22:39,030 --> 00:22:42,810
basically change it from elf 64 into a

499
00:22:42,810 --> 00:22:45,600
raw DD style memory dump and those are

500
00:22:45,600 --> 00:22:48,300
the two those are the two command line

501
00:22:48,300 --> 00:22:53,010
incantations to do that so first of all

502
00:22:53,010 --> 00:22:56,220
you would do P scan and what I've done

503
00:22:56,220 --> 00:22:58,880
here has done a diff against the clean

504
00:22:58,880 --> 00:23:02,010
memory image from that VM against the

505
00:23:02,010 --> 00:23:02,700
after

506
00:23:02,700 --> 00:23:04,499
I've run the malware and so now we see

507
00:23:04,499 --> 00:23:07,080
that we have explorer.exe which is begun

508
00:23:07,080 --> 00:23:09,649
running and I didn't run explore dot exe

509
00:23:09,649 --> 00:23:13,859
so that's suspicious so then we want to

510
00:23:13,859 --> 00:23:17,489
go and use mal find and we find of

511
00:23:17,489 --> 00:23:21,359
course we have mal find is pointing to

512
00:23:21,359 --> 00:23:24,600
explore dot exe and so you know this is

513
00:23:24,600 --> 00:23:29,429
a you know second layer of indication

514
00:23:29,429 --> 00:23:31,830
that something's wrong with with

515
00:23:31,830 --> 00:23:35,190
Explorer and so what I do next is pull

516
00:23:35,190 --> 00:23:39,239
those two two areas of memory and then

517
00:23:39,239 --> 00:23:41,429
run them through a virus scanner Bank

518
00:23:41,429 --> 00:23:44,519
and I can see that Avira and cui who 360

519
00:23:44,519 --> 00:23:48,389
have marked that first memory address

520
00:23:48,389 --> 00:23:51,749
and its pages as being malicious and

521
00:23:51,749 --> 00:23:53,669
then cui who has marked the second one

522
00:23:53,669 --> 00:23:56,269
it looks like these are very general

523
00:23:56,269 --> 00:23:58,799
signatures but still there's something

524
00:23:58,799 --> 00:24:02,070
bad going on here so the next thing I

525
00:24:02,070 --> 00:24:05,879
want to do is look at the the net scan

526
00:24:05,879 --> 00:24:09,119
to see if there's any network traffic

527
00:24:09,119 --> 00:24:11,159
that has been generated and if there is

528
00:24:11,159 --> 00:24:13,230
here so we've got an IP address and a

529
00:24:13,230 --> 00:24:17,129
port so what do we learn from memory

530
00:24:17,129 --> 00:24:20,039
analysis that this sample uses process

531
00:24:20,039 --> 00:24:22,559
injection it injects Explorer dot exe

532
00:24:22,559 --> 00:24:24,809
and we have a command and control IP

533
00:24:24,809 --> 00:24:28,909
address of such-and-such it's shown here

534
00:24:28,909 --> 00:24:32,309
so in conclusion I want to tie it all

535
00:24:32,309 --> 00:24:35,009
together and you know in the published

536
00:24:35,009 --> 00:24:36,840
paper in the Proceedings is a more

537
00:24:36,840 --> 00:24:39,090
detailed picture of how to tie it all

538
00:24:39,090 --> 00:24:41,639
together but I wanted to give you kind

539
00:24:41,639 --> 00:24:45,419
of a graphic version of that so if you

540
00:24:45,419 --> 00:24:48,929
start with a cuckoo sandbox session you

541
00:24:48,929 --> 00:24:50,460
want to submit the file to cuckoo

542
00:24:50,460 --> 00:24:52,559
sandbox and then from that dynamic

543
00:24:52,559 --> 00:24:55,139
analysis you may end up with a set of

544
00:24:55,139 --> 00:24:57,779
URLs you may see and you will end up

545
00:24:57,779 --> 00:25:00,239
with a pcap so you want to take those

546
00:25:00,239 --> 00:25:02,639
and process them with the appropriate

547
00:25:02,639 --> 00:25:05,220
tool and also there's a decision there

548
00:25:05,220 --> 00:25:07,080
at the end of each one of these where

549
00:25:07,080 --> 00:25:10,409
have you seen a file or have you seen a

550
00:25:10,409 --> 00:25:14,159
URL in the past and if you if you have

551
00:25:14,159 --> 00:25:15,960
don't process it again

552
00:25:15,960 --> 00:25:18,150
except for URLs you may want to process

553
00:25:18,150 --> 00:25:20,400
the URL again later on just wait a

554
00:25:20,400 --> 00:25:23,100
particular amount of time before you

555
00:25:23,100 --> 00:25:25,710
process it a second time and then you

556
00:25:25,710 --> 00:25:27,270
want to send all of your data that

557
00:25:27,270 --> 00:25:28,410
you're collecting to your threat

558
00:25:28,410 --> 00:25:31,620
intelligence platform and then I've

559
00:25:31,620 --> 00:25:33,810
separated out this is all one contiguous

560
00:25:33,810 --> 00:25:36,690
set of swimlanes in reality but when I

561
00:25:36,690 --> 00:25:39,060
had volatility in the same set of

562
00:25:39,060 --> 00:25:40,470
swimlanes it all looked like a pile of

563
00:25:40,470 --> 00:25:43,440
spaghetti so I've separated volatility

564
00:25:43,440 --> 00:25:46,080
out into a second set of swimlanes but

565
00:25:46,080 --> 00:25:47,880
logically if you just put these together

566
00:25:47,880 --> 00:25:50,160
it's all one set of swimlane so

567
00:25:50,160 --> 00:25:51,840
volatility you start with a memory image

568
00:25:51,840 --> 00:25:54,540
you can pull URLs and you can pull files

569
00:25:54,540 --> 00:25:57,210
out of it and then you want to process

570
00:25:57,210 --> 00:25:59,670
those with the appropriate secondary

571
00:25:59,670 --> 00:26:05,700
tools so I think this wraps up my talk I

572
00:26:05,700 --> 00:26:08,180
will be in two weeks I'll be at sektor

573
00:26:08,180 --> 00:26:10,260
giving another talk about malware

574
00:26:10,260 --> 00:26:12,390
analysis I hope to see any of you that

575
00:26:12,390 --> 00:26:15,120
are in Toronto or will be at sektor come

576
00:26:15,120 --> 00:26:17,220
see me there and then if you have any

577
00:26:17,220 --> 00:26:21,900
questions please thank you very much

578
00:26:21,900 --> 00:26:24,900
Robert congratulations on finding a use

579
00:26:24,900 --> 00:26:29,670
for Bing so I'll be honest that's the

580
00:26:29,670 --> 00:26:33,930
only thing I ever do with Bing do we

581
00:26:33,930 --> 00:26:48,510
have any questions for Robert no I have

582
00:26:48,510 --> 00:26:48,960
not

583
00:26:48,960 --> 00:26:52,200
because right now my focus has been just

584
00:26:52,200 --> 00:26:54,840
narrowly on Windows and you know

585
00:26:54,840 --> 00:26:58,530
windows-based malware but with the new

586
00:26:58,530 --> 00:27:01,700
version of ku-ku-ku-ku does support now

587
00:27:01,700 --> 00:27:06,210
Linux Android I think Mac OS and so you

588
00:27:06,210 --> 00:27:07,710
know I have plans to start looking at

589
00:27:07,710 --> 00:27:10,790
that but no not not at the moment

590
00:27:10,790 --> 00:27:14,750
any other questions

591
00:27:17,140 --> 00:27:20,090
all right spawning any more hands if we

592
00:27:20,090 --> 00:27:21,680
can thank you very much for his

593
00:27:21,680 --> 00:27:23,980
presentation

594
00:27:23,980 --> 00:27:27,869
[Applause]

