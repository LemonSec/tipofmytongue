1
00:00:09,230 --> 00:00:13,770
all right well hi everyone welcome to a

2
00:00:11,400 --> 00:00:16,079
red versus blue the untold chapter

3
00:00:13,770 --> 00:00:18,000
thanks for attending and he got myself

4
00:00:16,079 --> 00:00:20,669
air and herndon here and then Tom a

5
00:00:18,000 --> 00:00:22,890
little bit about ourselves Aaron I'm a

6
00:00:20,670 --> 00:00:25,470
seer security consultant with rap and

7
00:00:22,890 --> 00:00:27,269
seven my primary areas of focus are

8
00:00:25,470 --> 00:00:30,000
social engineering I like to do a lot of

9
00:00:27,269 --> 00:00:31,769
payload development ESC type stuff also

10
00:00:30,000 --> 00:00:33,300
do something physical and electronic my

11
00:00:31,769 --> 00:00:35,850
little awkward picture there clicking a

12
00:00:33,300 --> 00:00:37,559
door then red teaming I do a lot of red

13
00:00:35,850 --> 00:00:41,399
team type operations more on the covert

14
00:00:37,560 --> 00:00:45,300
side that internet-of-things not as much

15
00:00:41,399 --> 00:00:47,129
in a hardware guy but I'll dig into a

16
00:00:45,300 --> 00:00:48,419
lot of hardware based items and work

17
00:00:47,129 --> 00:00:49,769
with teammates to get firmware pulled

18
00:00:48,420 --> 00:00:51,660
but after that I'll start doing a lot of

19
00:00:49,770 --> 00:00:53,280
a reversing of the firmware how things

20
00:00:51,660 --> 00:00:55,230
work and so was it kind of where my

21
00:00:53,280 --> 00:00:57,329
passions lie

22
00:00:55,230 --> 00:01:00,050
Tom Summerville secure engineer at

23
00:00:57,329 --> 00:01:02,780
Gordon food service over at state

24
00:01:00,050 --> 00:01:05,580
engineer pretty standard run-of-the-mill

25
00:01:02,780 --> 00:01:07,590
you know blue team stuff don't do a

26
00:01:05,580 --> 00:01:10,740
whole lot with risk compliance or

27
00:01:07,590 --> 00:01:12,990
anything like that yeah no social media

28
00:01:10,740 --> 00:01:15,380
or anything like that I pretty much stay

29
00:01:12,990 --> 00:01:17,908
off the internet when I'm not at work so

30
00:01:15,380 --> 00:01:22,979
if you want to get in touch with me just

31
00:01:17,909 --> 00:01:24,450
meet me after you make contact so this

32
00:01:22,979 --> 00:01:26,460
talk is gonna focus really on a single

33
00:01:24,450 --> 00:01:28,020
attack chain and we thought about doing

34
00:01:26,460 --> 00:01:29,490
you know a bunch of different red team

35
00:01:28,020 --> 00:01:31,229
type operations and then how blue team

36
00:01:29,490 --> 00:01:32,548
could detect them but there's so much to

37
00:01:31,229 --> 00:01:34,770
cover we really want to focus on

38
00:01:32,549 --> 00:01:36,450
something basic single attack chain

39
00:01:34,770 --> 00:01:39,060
where I is the attacker I'm gonna break

40
00:01:36,450 --> 00:01:40,799
into a simulated network and then Tom as

41
00:01:39,060 --> 00:01:43,079
the defender is going to threat hunt

42
00:01:40,799 --> 00:01:44,520
that we're gonna use basic tools open

43
00:01:43,079 --> 00:01:45,658
source tools and not gonna be using any

44
00:01:44,520 --> 00:01:47,820
of the custom tool kits we've written

45
00:01:45,659 --> 00:01:49,380
just keeping it simple with what you

46
00:01:47,820 --> 00:01:50,969
could use out there from my perspective

47
00:01:49,380 --> 00:01:54,060
at least and then he's gonna use an EGR

48
00:01:50,969 --> 00:01:55,048
but it's gonna be you know basic back

49
00:01:54,060 --> 00:01:56,939
and forth there's gonna be some

50
00:01:55,049 --> 00:01:58,920
intentional OPSEC fails on the red team

51
00:01:56,939 --> 00:01:59,908
side so we can point those out along the

52
00:01:58,920 --> 00:02:01,950
way

53
00:01:59,909 --> 00:02:03,390
so that you know can help improve red

54
00:02:01,950 --> 00:02:04,979
teamers and then from the blue team side

55
00:02:03,390 --> 00:02:07,079
those OPSEC fails are also going to help

56
00:02:04,979 --> 00:02:08,430
him with you know doing better threat

57
00:02:07,079 --> 00:02:13,829
hunting there and understanding what's

58
00:02:08,430 --> 00:02:14,890
going on yeah so really the the intent

59
00:02:13,830 --> 00:02:16,240
here is

60
00:02:14,890 --> 00:02:18,369
if you're thinking about doing

61
00:02:16,240 --> 00:02:19,900
throughout hunting or are you just

62
00:02:18,370 --> 00:02:22,300
spinning up this type of program at your

63
00:02:19,900 --> 00:02:24,370
organization this would be a really good

64
00:02:22,300 --> 00:02:26,350
exercise or something similar to this

65
00:02:24,370 --> 00:02:29,380
also we wanted to focus on using a

66
00:02:26,350 --> 00:02:31,239
really limited toolset in fact pretty

67
00:02:29,380 --> 00:02:34,990
much everything we do here is done with

68
00:02:31,240 --> 00:02:38,740
one tool in EDR there's a lot of options

69
00:02:34,990 --> 00:02:40,540
out there so but they mostly will be

70
00:02:38,740 --> 00:02:43,570
able to allow you to perform exercises

71
00:02:40,540 --> 00:02:46,630
like this we're not gonna go into a lot

72
00:02:43,570 --> 00:02:48,190
of the post-incident analysis do your

73
00:02:46,630 --> 00:02:50,410
time when we first ran through it three

74
00:02:48,190 --> 00:02:54,310
hours so we had to knock it down a

75
00:02:50,410 --> 00:02:55,660
little bit so here we go alright so

76
00:02:54,310 --> 00:02:59,290
Wednesday evening we got Sponge Bob

77
00:02:55,660 --> 00:03:01,030
transitions to help us out and yeah so

78
00:02:59,290 --> 00:03:02,950
late Wednesday afternoon

79
00:03:01,030 --> 00:03:05,980
Red Team comes along our target company

80
00:03:02,950 --> 00:03:07,630
is desing that's the company we're

81
00:03:05,980 --> 00:03:09,369
looking at it's the first thing as a red

82
00:03:07,630 --> 00:03:10,750
team I need some do some open source

83
00:03:09,370 --> 00:03:12,430
intelligence gather and who is this

84
00:03:10,750 --> 00:03:15,130
company what do they have out there

85
00:03:12,430 --> 00:03:16,780
exposed what's their external attack

86
00:03:15,130 --> 00:03:18,880
surface and is there anything worth

87
00:03:16,780 --> 00:03:20,769
using to get into can I avoid phishing

88
00:03:18,880 --> 00:03:22,630
sometimes fishing while it's nice can

89
00:03:20,769 --> 00:03:24,850
burn all of your c2 infra and you have

90
00:03:22,630 --> 00:03:26,260
to spend a lot of time setting up new c2

91
00:03:24,850 --> 00:03:28,299
infrastructure so if we can get in

92
00:03:26,260 --> 00:03:30,399
without it it's nice but so we do our

93
00:03:28,299 --> 00:03:31,780
Osen we're looking at aaron records

94
00:03:30,400 --> 00:03:34,180
finding out what this company has

95
00:03:31,780 --> 00:03:35,769
registered for IP space showed in what

96
00:03:34,180 --> 00:03:37,180
ports then services they have running on

97
00:03:35,769 --> 00:03:39,220
the internet without actually actively

98
00:03:37,180 --> 00:03:41,560
scanning some LinkedIn reconnaissance

99
00:03:39,220 --> 00:03:44,019
connect datacom or document metadata to

100
00:03:41,560 --> 00:03:46,239
get some usernames and company info

101
00:03:44,019 --> 00:03:48,730
employee names then googled or King

102
00:03:46,239 --> 00:03:51,040
finds subdomains out there what they

103
00:03:48,730 --> 00:03:53,200
might be running on sites see if we can

104
00:03:51,040 --> 00:03:55,359
find a VPN portal or a Citrix portal

105
00:03:53,200 --> 00:03:56,290
something interesting and after all that

106
00:03:55,360 --> 00:03:57,640
who might switch to active

107
00:03:56,290 --> 00:03:58,989
reconnaissance from an external

108
00:03:57,640 --> 00:04:01,268
perspective I might stand up a burner

109
00:03:58,989 --> 00:04:03,220
box and AWS or some kind of cloud

110
00:04:01,269 --> 00:04:05,500
platform that I can just blast their

111
00:04:03,220 --> 00:04:06,730
network with and scan if that gets

112
00:04:05,500 --> 00:04:08,470
caught by the blue team they banned the

113
00:04:06,730 --> 00:04:10,238
IP no harm no foul it was my burner box

114
00:04:08,470 --> 00:04:11,470
I can stand up another one I mean people

115
00:04:10,239 --> 00:04:13,000
are getting hammered in the internet all

116
00:04:11,470 --> 00:04:15,430
the time their goal is not to have

117
00:04:13,000 --> 00:04:16,540
attribution linked back to you but at

118
00:04:15,430 --> 00:04:18,880
the end of all my reconnaissance my

119
00:04:16,540 --> 00:04:20,470
active and passive reconnaissance does

120
00:04:18,880 --> 00:04:22,300
buzzing Cuban do business or their shell

121
00:04:20,470 --> 00:04:24,500
company I found nothing like I found a

122
00:04:22,300 --> 00:04:27,050
few employees out there

123
00:04:24,500 --> 00:04:28,160
you know not a lot to go off of one

124
00:04:27,050 --> 00:04:30,650
thing we did find though they have

125
00:04:28,160 --> 00:04:32,750
office 365 we use the tool called spoof

126
00:04:30,650 --> 00:04:34,460
check to basically we're looking at SPF

127
00:04:32,750 --> 00:04:35,330
records seeing what they had configured

128
00:04:34,460 --> 00:04:37,010
for their domain

129
00:04:35,330 --> 00:04:39,050
and it says they're allowing mail from

130
00:04:37,010 --> 00:04:41,870
SPF protection outlook.com with a soft

131
00:04:39,050 --> 00:04:43,850
veil for all so ok they're using office

132
00:04:41,870 --> 00:04:46,790
365 maybe we can get into that portal

133
00:04:43,850 --> 00:04:48,920
and use it a little bit more fun fact

134
00:04:46,790 --> 00:04:51,560
about office 365 permits username a

135
00:04:48,920 --> 00:04:53,570
numeration another fun fact is that

136
00:04:51,560 --> 00:04:55,520
admins like to neglect their office 365

137
00:04:53,570 --> 00:04:57,620
logs it's pretty hard to get all of them

138
00:04:55,520 --> 00:04:59,750
into a centralized logging and even once

139
00:04:57,620 --> 00:05:01,400
you do office 365 their logging

140
00:04:59,750 --> 00:05:03,169
capabilities unless you fine-tune them

141
00:05:01,400 --> 00:05:04,880
out of the box there's no great way to

142
00:05:03,169 --> 00:05:07,190
correlate things like passwords Bray's

143
00:05:04,880 --> 00:05:08,510
you can see it and you know an IP trying

144
00:05:07,190 --> 00:05:10,669
to log in a bunch of times but you can't

145
00:05:08,510 --> 00:05:12,530
correlate to oh did they successfully

146
00:05:10,669 --> 00:05:14,210
log in to the portal or not when their

147
00:05:12,530 --> 00:05:15,650
spring usernames against a single

148
00:05:14,210 --> 00:05:18,020
password so that's what we're gonna do

149
00:05:15,650 --> 00:05:20,060
build a user list enumerate against the

150
00:05:18,020 --> 00:05:21,080
portal for valid users password spray

151
00:05:20,060 --> 00:05:23,270
and profit off of it

152
00:05:21,080 --> 00:05:24,500
first thing we need a user list we had

153
00:05:23,270 --> 00:05:25,700
already scraped LinkedIn to get some

154
00:05:24,500 --> 00:05:27,830
usernames but there wasn't a lot out

155
00:05:25,700 --> 00:05:31,310
there so I switch to using burp suite as

156
00:05:27,830 --> 00:05:33,530
a co2 plug-in and they have inside co2

157
00:05:31,310 --> 00:05:35,510
is a user generator you can take census

158
00:05:33,530 --> 00:05:36,890
data and generate a list of common first

159
00:05:35,510 --> 00:05:39,080
names and last names and put them into

160
00:05:36,890 --> 00:05:41,750
any format so here we took a bunch of

161
00:05:39,080 --> 00:05:44,330
census data from the 1950s the 1990s for

162
00:05:41,750 --> 00:05:46,340
first names and then the top 20% of

163
00:05:44,330 --> 00:05:48,200
surnames in the United States put them

164
00:05:46,340 --> 00:05:50,900
together made a list of first initial

165
00:05:48,200 --> 00:05:52,630
last name appended the email at the end

166
00:05:50,900 --> 00:05:55,370
and now we have our list to spray with

167
00:05:52,630 --> 00:05:57,650
office 365 again from its user

168
00:05:55,370 --> 00:06:00,770
enumeration so if I were to use the tool

169
00:05:57,650 --> 00:06:02,239
office 365 user and I'm basically it

170
00:06:00,770 --> 00:06:04,099
tries to log in to the portal using

171
00:06:02,240 --> 00:06:06,020
active sync and active sync when you're

172
00:06:04,100 --> 00:06:07,850
logging in if you get a 404 not found

173
00:06:06,020 --> 00:06:09,289
the user you tried to log in with was an

174
00:06:07,850 --> 00:06:13,040
invalid user take them out of your list

175
00:06:09,290 --> 00:06:14,690
they're not in that area no 365 403

176
00:06:13,040 --> 00:06:16,550
forbidden cool you logged in with user

177
00:06:14,690 --> 00:06:18,950
name and password but you had to FA ok

178
00:06:16,550 --> 00:06:21,919
nothing you can do there unless you to

179
00:06:18,950 --> 00:06:23,390
FA fish 200 ok that was cred success

180
00:06:21,919 --> 00:06:24,770
you're in the portal and 401

181
00:06:23,390 --> 00:06:26,300
unauthorized you now know you have a

182
00:06:24,770 --> 00:06:28,400
valid user name with an invalid password

183
00:06:26,300 --> 00:06:29,900
so after your first spray come back

184
00:06:28,400 --> 00:06:31,549
through with valid user names again

185
00:06:29,900 --> 00:06:32,989
and only use your valid user names

186
00:06:31,550 --> 00:06:35,990
because obviously there's no sense in

187
00:06:32,990 --> 00:06:37,289
spring with invalid and so here we have

188
00:06:35,990 --> 00:06:40,439
Smith J was a

189
00:06:37,289 --> 00:06:44,219
user butt so one thing I'd like to do is

190
00:06:40,439 --> 00:06:45,569
spray season year users love season year

191
00:06:44,219 --> 00:06:47,009
why because you have password

192
00:06:45,569 --> 00:06:48,839
requirements that change every 90 days

193
00:06:47,009 --> 00:06:51,930
and what changes every 90 days the

194
00:06:48,839 --> 00:06:53,129
season so people do this all the time

195
00:06:51,930 --> 00:06:54,779
pretty common if you have a large

196
00:06:53,129 --> 00:06:57,599
employee base to find somebody using a

197
00:06:54,779 --> 00:06:59,580
password in that nature so we try Summer

198
00:06:57,599 --> 00:07:02,369
2018 exclamation point with our email

199
00:06:59,580 --> 00:07:04,498
list against the office 365 portal we

200
00:07:02,369 --> 00:07:07,770
find this guy pain see maybe like Chris

201
00:07:04,499 --> 00:07:11,009
pain or something has a weak password

202
00:07:07,770 --> 00:07:12,240
for a Summer 2018 exclamation point so

203
00:07:11,009 --> 00:07:14,729
now we have email access what are we

204
00:07:12,240 --> 00:07:17,550
gonna do with that well the tool ruler

205
00:07:14,729 --> 00:07:19,229
we can use to go ahead and dump the gal

206
00:07:17,550 --> 00:07:20,969
or global address list and get a list of

207
00:07:19,229 --> 00:07:23,159
all employees there we can also go

208
00:07:20,969 --> 00:07:25,020
through the email address or the email

209
00:07:23,159 --> 00:07:27,300
account and start looking for sensitive

210
00:07:25,020 --> 00:07:29,698
information passwords we don't really

211
00:07:27,300 --> 00:07:31,229
find any of that and so instead we're

212
00:07:29,699 --> 00:07:34,759
gonna use this email account as a spring

213
00:07:31,229 --> 00:07:34,758
boarding platform to basically spear

214
00:07:36,439 --> 00:07:40,199
inside someone's email we can send

215
00:07:38,699 --> 00:07:41,669
trusted emails to the company we know

216
00:07:40,199 --> 00:07:43,229
what their email headers look like I

217
00:07:41,669 --> 00:07:45,779
mean it's pretty easy to simulate this

218
00:07:43,229 --> 00:07:47,039
employee at this point and set maybe a

219
00:07:45,779 --> 00:07:50,189
payload that's gonna get us internal

220
00:07:47,039 --> 00:07:52,019
network access so digging around we find

221
00:07:50,189 --> 00:07:53,490
that Chris pain and Paul Nelson actually

222
00:07:52,019 --> 00:07:56,759
happened to be pretty old and they're

223
00:07:53,490 --> 00:07:58,559
gonna be retiring and so if anyone knows

224
00:07:56,759 --> 00:08:01,589
these two people there's a lot of jokes

225
00:07:58,559 --> 00:08:04,259
for them yeah they're gonna be retiring

226
00:08:01,589 --> 00:08:06,529
and so their retirement celebration sent

227
00:08:04,259 --> 00:08:08,369
out and with the retirement celebration

228
00:08:06,529 --> 00:08:10,499
they were just saying hey we're going to

229
00:08:08,369 --> 00:08:12,449
founders we're gonna meet up you know

230
00:08:10,499 --> 00:08:15,119
whoever wants to join us but we think

231
00:08:12,449 --> 00:08:16,469
okay here's an invite what if we replied

232
00:08:15,119 --> 00:08:18,509
back to everyone that's Chris pain since

233
00:08:16,469 --> 00:08:21,479
we're in his account saying here's the

234
00:08:18,509 --> 00:08:22,860
an evite we need you to open an RSVP if

235
00:08:21,479 --> 00:08:24,959
you're gonna attend so that's what we do

236
00:08:22,860 --> 00:08:26,849
we start crafting loops sorry we start

237
00:08:24,959 --> 00:08:30,240
crafting this evite that's gonna use a

238
00:08:26,849 --> 00:08:32,698
payload for people to open and say yeah

239
00:08:30,240 --> 00:08:33,930
we're gonna come to your party some

240
00:08:32,698 --> 00:08:36,149
assumptions before we start crafting our

241
00:08:33,929 --> 00:08:37,169
payload though just basic assumptions

242
00:08:36,149 --> 00:08:38,519
I'm going to make because I haven't done

243
00:08:37,169 --> 00:08:40,529
a lot of recon to figure out what their

244
00:08:38,519 --> 00:08:42,060
hosts are like I'm gonna go with

245
00:08:40,529 --> 00:08:44,009
probably have some sort of next-gen AV

246
00:08:42,059 --> 00:08:46,449
running I'm gonna say AppLocker is going

247
00:08:44,009 --> 00:08:48,400
to prevent the execution of unsigned

248
00:08:46,450 --> 00:08:50,800
Ares PowerShell is going to be disabled

249
00:08:48,400 --> 00:08:53,350
or heavily logged if they're on v5 or

250
00:08:50,800 --> 00:08:55,479
above and then Windows 10 with ASR

251
00:08:53,350 --> 00:08:57,580
attack surface reduction rules that's

252
00:08:55,480 --> 00:09:02,050
going to prevent me from executing some

253
00:08:57,580 --> 00:09:04,900
of my common things like that outside of

254
00:09:02,050 --> 00:09:06,819
inside of the word macro so it's gonna

255
00:09:04,900 --> 00:09:09,040
take away using office documents there

256
00:09:06,820 --> 00:09:11,110
to be able to get a successful fish

257
00:09:09,040 --> 00:09:11,740
unless I can find a bypass for it what

258
00:09:11,110 --> 00:09:13,570
does that leave me with

259
00:09:11,740 --> 00:09:16,240
well we're gonna hope HTML applications

260
00:09:13,570 --> 00:09:17,680
work what is in HTA just a little bit

261
00:09:16,240 --> 00:09:21,280
about that

262
00:09:17,680 --> 00:09:23,199
it's basically a it's been around in

263
00:09:21,280 --> 00:09:25,900
Windows for a while and it's run by

264
00:09:23,200 --> 00:09:28,480
MSHDA exe which is mark soft sign

265
00:09:25,900 --> 00:09:30,220
binaries it runs HTML code but it does

266
00:09:28,480 --> 00:09:32,920
outside of the Internet Explorer sandbox

267
00:09:30,220 --> 00:09:34,900
and so that means I can put VB script or

268
00:09:32,920 --> 00:09:37,540
JavaScript inside of it have it execute

269
00:09:34,900 --> 00:09:40,240
things like ActiveX objects to create a

270
00:09:37,540 --> 00:09:41,560
shell or run commands on the system so I

271
00:09:40,240 --> 00:09:43,150
could run a batch file I could run

272
00:09:41,560 --> 00:09:44,650
anything on the system a user could run

273
00:09:43,150 --> 00:09:47,110
whoever is running it I can run through

274
00:09:44,650 --> 00:09:50,560
our HTA here while still presenting them

275
00:09:47,110 --> 00:09:52,420
a pretty HTML page so inside this HTA

276
00:09:50,560 --> 00:09:54,130
I'm gonna pack in a few things first are

277
00:09:52,420 --> 00:09:57,370
some c-sharp brains that are gonna

278
00:09:54,130 --> 00:09:59,439
pretty much do all my Pitt State payload

279
00:09:57,370 --> 00:10:01,240
staging I'm gonna batch file that's

280
00:09:59,440 --> 00:10:02,680
gonna compile and execute my c-sharp and

281
00:10:01,240 --> 00:10:04,210
then I'm gonna have the HD a that's

282
00:10:02,680 --> 00:10:07,089
gonna deliver all of that to disk while

283
00:10:04,210 --> 00:10:08,740
presenting them this retirement invite

284
00:10:07,090 --> 00:10:10,330
and as you can see the evite thing I've

285
00:10:08,740 --> 00:10:11,740
created here that's actually an open HT

286
00:10:10,330 --> 00:10:13,050
a application right now that's the one

287
00:10:11,740 --> 00:10:15,550
we created for this phishing campaign

288
00:10:13,050 --> 00:10:17,560
looks you know pretty legitimate user

289
00:10:15,550 --> 00:10:19,359
opens it up when they click on download

290
00:10:17,560 --> 00:10:26,410
it says mark soft want you to run this

291
00:10:19,360 --> 00:10:28,480
HTML application they click yes so

292
00:10:26,410 --> 00:10:31,300
walking through what that is the evite

293
00:10:28,480 --> 00:10:34,260
nopsi s that I created is a basically

294
00:10:31,300 --> 00:10:34,260
c-sharp script

295
00:10:37,749 --> 00:10:41,509
PowerShell without PowerShell briefly

296
00:10:40,009 --> 00:10:43,189
assistant management automation library

297
00:10:41,509 --> 00:10:44,839
well that's what we're gonna use we're

298
00:10:43,189 --> 00:10:46,368
gonna create a new run space and run

299
00:10:44,839 --> 00:10:48,559
some PowerShell code and it's just gonna

300
00:10:46,369 --> 00:10:51,019
run a partial Empire stagers anyone use

301
00:10:48,559 --> 00:10:52,608
PowerShell Empire or familiar with got a

302
00:10:51,019 --> 00:10:53,949
few people in the room so basically

303
00:10:52,609 --> 00:10:58,579
PowerShell Empire

304
00:10:53,949 --> 00:11:00,799
it's a CG framework that takes calls

305
00:10:58,579 --> 00:11:02,269
back out to your server and then it just

306
00:11:00,799 --> 00:11:05,358
keeps beaconing out to your server and

307
00:11:02,269 --> 00:11:06,859
through HTTP or HTTPS and looking for

308
00:11:05,359 --> 00:11:09,109
new commands or PowerShell scripts to

309
00:11:06,859 --> 00:11:10,759
download and execute so instead of

310
00:11:09,109 --> 00:11:16,489
calling PowerShell Bob exe we're just

311
00:11:10,759 --> 00:11:19,309
gonna bake that initial stage we're also

312
00:11:16,489 --> 00:11:20,719
gonna use install u2 to bypass block

313
00:11:19,309 --> 00:11:22,939
because again this is gonna be compiled

314
00:11:20,719 --> 00:11:23,569
into an executable that's unsigned so if

315
00:11:22,939 --> 00:11:25,399
an app Locker

316
00:11:23,569 --> 00:11:26,709
blocking unsigned executable as well I

317
00:11:25,399 --> 00:11:29,889
need to be able to get around that

318
00:11:26,709 --> 00:11:32,899
install util is a Microsoft utility on

319
00:11:29,889 --> 00:11:34,729
Windows workstations that is signed

320
00:11:32,899 --> 00:11:36,589
again Microsoft utility that can run

321
00:11:34,729 --> 00:11:38,479
other executables if they have the

322
00:11:36,589 --> 00:11:39,499
uninstall class to put into them so

323
00:11:38,479 --> 00:11:41,929
that's what we're using the uninstall

324
00:11:39,499 --> 00:11:44,119
class for here if I type install utility

325
00:11:41,929 --> 00:11:46,369
XE and then evite body once it's

326
00:11:44,119 --> 00:11:49,249
compiled it's gonna call this uninstall

327
00:11:46,369 --> 00:11:51,229
class which is I'm gonna write my run my

328
00:11:49,249 --> 00:11:52,609
connect to invite server code which is

329
00:11:51,229 --> 00:11:54,889
basically my PowerShell Empire stager

330
00:11:52,609 --> 00:11:57,649
and then the batch file it's gonna be

331
00:11:54,889 --> 00:12:00,369
running in order to compile it locally I

332
00:11:57,649 --> 00:12:02,719
want to find CSC exe which is in the

333
00:12:00,369 --> 00:12:04,159
folder but I'm not sure what versions

334
00:12:02,719 --> 00:12:06,079
running there so the batch file it just

335
00:12:04,159 --> 00:12:07,879
kind of traverses through finds where

336
00:12:06,079 --> 00:12:10,159
they have that file located and then

337
00:12:07,879 --> 00:12:11,269
uses it to compile my code we have to

338
00:12:10,159 --> 00:12:13,189
find the system management automation

339
00:12:11,269 --> 00:12:17,359
library to reference when it's compiling

340
00:12:13,189 --> 00:12:18,769
and it's got to find install utility and

341
00:12:17,359 --> 00:12:20,719
then it's just gonna start those it's

342
00:12:18,769 --> 00:12:23,629
gonna start to the comp or compile it

343
00:12:20,719 --> 00:12:24,949
and then it's gonna run it and finally

344
00:12:23,629 --> 00:12:26,389
we have all these things we've written

345
00:12:24,949 --> 00:12:29,059
we need to get them on the users disk

346
00:12:26,389 --> 00:12:30,529
from an OPSEC perspective you know we're

347
00:12:29,059 --> 00:12:31,728
putting things on disk if instant

348
00:12:30,529 --> 00:12:33,079
responder comes along they can now

349
00:12:31,729 --> 00:12:34,849
reverse it they can figure out what

350
00:12:33,079 --> 00:12:36,169
we're doing so it's maybe not the safest

351
00:12:34,849 --> 00:12:38,179
method but it's what we're working with

352
00:12:36,169 --> 00:12:40,899
here with our limited toolset and kind

353
00:12:38,179 --> 00:12:44,059
of trying to bypass and the AV detection

354
00:12:40,899 --> 00:12:45,979
and so we have our HD a payload it's

355
00:12:44,059 --> 00:12:47,478
gonna write our C sharp to disk it's

356
00:12:45,979 --> 00:12:47,779
gonna write that batch bio you just saw

357
00:12:47,479 --> 00:12:49,550
it

358
00:12:47,779 --> 00:12:51,529
then it's gonna execute the batch file

359
00:12:49,550 --> 00:12:56,089
which is gonna do the compiling and then

360
00:12:51,529 --> 00:12:57,649
execution of the payload and eventually

361
00:12:56,089 --> 00:13:00,019
we're good to go we have our payload set

362
00:12:57,649 --> 00:13:01,490
we have our evite HTA now we need to

363
00:13:00,019 --> 00:13:04,279
send it off so we take our Chris Payne

364
00:13:01,490 --> 00:13:05,629
email we send a link to please go here

365
00:13:04,279 --> 00:13:07,490
to list website to you know

366
00:13:05,629 --> 00:13:09,769
RSVP if you're attending to the founders

367
00:13:07,490 --> 00:13:11,509
retirement party or not one of the

368
00:13:09,769 --> 00:13:14,089
things you never want to attach an HT a

369
00:13:11,509 --> 00:13:16,129
directly in an email email box or

370
00:13:14,089 --> 00:13:18,560
scanners are gonna block it all so if

371
00:13:16,129 --> 00:13:20,959
you attach a link or a path far sorry a

372
00:13:18,560 --> 00:13:22,790
path that goes directly to the HT a most

373
00:13:20,959 --> 00:13:24,800
email scanners are smart enough to go

374
00:13:22,790 --> 00:13:25,250
this is a link to a file therefore it's

375
00:13:24,800 --> 00:13:28,878
a file

376
00:13:25,250 --> 00:13:30,319
let me first so if you send them a link

377
00:13:28,879 --> 00:13:31,939
to a web page where they have to click a

378
00:13:30,319 --> 00:13:33,769
few buttons before they get to that file

379
00:13:31,939 --> 00:13:35,540
you're not gonna have the email scanner

380
00:13:33,769 --> 00:13:38,170
actually click those buttons and do that

381
00:13:35,540 --> 00:13:42,019
therefore you kind of get past the email

382
00:13:38,170 --> 00:13:49,610
filters and so we send it out late on

383
00:13:42,019 --> 00:13:56,029
Wednesday night and we wait okay so I

384
00:13:49,610 --> 00:13:57,529
was asleep because so I come in Thursday

385
00:13:56,029 --> 00:14:01,699
I get my coffee go about my morning

386
00:13:57,529 --> 00:14:03,290
routine you know responding to that need

387
00:14:01,699 --> 00:14:07,490
my attention first thing in the morning

388
00:14:03,290 --> 00:14:10,910
and then I kind of settle into some

389
00:14:07,490 --> 00:14:13,879
routine queries and peruse the logs that

390
00:14:10,910 --> 00:14:16,519
we do up on the screen here are a couple

391
00:14:13,879 --> 00:14:17,569
of items that I run through we're not

392
00:14:16,519 --> 00:14:19,129
going to take the time to go through

393
00:14:17,569 --> 00:14:21,559
each and every one of these these are

394
00:14:19,129 --> 00:14:23,180
just to give you some ideas of what type

395
00:14:21,559 --> 00:14:25,969
of activity I'm looking for through my

396
00:14:23,180 --> 00:14:28,819
EDR and if you take a look at these

397
00:14:25,970 --> 00:14:33,129
you're gonna kind of realize that you

398
00:14:28,819 --> 00:14:33,128
know everything on here is going to be

399
00:14:40,629 --> 00:14:45,519
spend a lot of time kind of weeding out

400
00:14:42,949 --> 00:14:50,750
on my network what is normal behavior

401
00:14:45,519 --> 00:14:52,430
and abnormal and so over period of time

402
00:14:50,750 --> 00:14:54,199
you'll kind of establish that baseline

403
00:14:52,430 --> 00:14:56,359
you'll filter out that normal activity

404
00:14:54,199 --> 00:14:56,760
and this will become a smaller and

405
00:14:56,360 --> 00:14:59,570
smaller

406
00:14:56,760 --> 00:15:01,650
tasks each day over a period of months

407
00:14:59,570 --> 00:15:04,320
one of the things that we're going to

408
00:15:01,650 --> 00:15:06,930
focus on here is the AppLocker bypass

409
00:15:04,320 --> 00:15:10,200
list there at the bottom is the list

410
00:15:06,930 --> 00:15:12,120
that I use so there's a whole bunch of

411
00:15:10,200 --> 00:15:15,180
different binaries one of them is

412
00:15:12,120 --> 00:15:19,200
install utility Exe I just quickly run

413
00:15:15,180 --> 00:15:23,250
to take a look for any use from this I

414
00:15:19,200 --> 00:15:25,470
am not used to I do have big spreadsheet

415
00:15:23,250 --> 00:15:27,450
filled with all those string queries

416
00:15:25,470 --> 00:15:29,520
that I'll do I'll put them in there to

417
00:15:27,450 --> 00:15:33,360
filter out that baseline and here you

418
00:15:29,520 --> 00:15:36,569
can see I have a log here for insight a

419
00:15:33,360 --> 00:15:40,230
lat exe invoking install command for a

420
00:15:36,570 --> 00:15:42,420
binary in C temp evite exe this is

421
00:15:40,230 --> 00:15:44,580
abnormal for me I'm not aware of this

422
00:15:42,420 --> 00:15:47,300
application we don't really execute

423
00:15:44,580 --> 00:15:49,230
binaries how to see Temple whole lot so

424
00:15:47,300 --> 00:15:51,030
because this is not part of that

425
00:15:49,230 --> 00:15:53,190
baseline it takes some time I'm going to

426
00:15:51,030 --> 00:15:55,110
take an you know follow rabbit trail and

427
00:15:53,190 --> 00:15:56,160
see where this goes so I don't know

428
00:15:55,110 --> 00:15:58,770
where it's at so I'm gonna grab the

429
00:15:56,160 --> 00:16:01,530
parent process ID for this command line

430
00:15:58,770 --> 00:16:03,420
execution then I stick it in and figure

431
00:16:01,530 --> 00:16:06,209
out okay maybe they'll tell me where

432
00:16:03,420 --> 00:16:08,459
it's from and I do see another command

433
00:16:06,210 --> 00:16:13,020
line execution for the c-sharp compiler

434
00:16:08,460 --> 00:16:15,330
CSC exe compiling this evite exe from

435
00:16:13,020 --> 00:16:19,500
the code Eve like that CS all within

436
00:16:15,330 --> 00:16:22,140
that C temp directory so I now know

437
00:16:19,500 --> 00:16:24,120
where the evite exe binary came from but

438
00:16:22,140 --> 00:16:27,900
I don't know where that c-sharp code

439
00:16:24,120 --> 00:16:31,590
came from so same process got the parent

440
00:16:27,900 --> 00:16:35,730
process ID stick it in and we see that

441
00:16:31,590 --> 00:16:38,580
the command line execution for evite bat

442
00:16:35,730 --> 00:16:41,310
also so once again want to know where

443
00:16:38,580 --> 00:16:43,290
that bat file came from grab the parent

444
00:16:41,310 --> 00:16:47,699
process ID and I can see that this

445
00:16:43,290 --> 00:16:50,790
retirement party even HTA running out of

446
00:16:47,700 --> 00:16:52,890
the Downloads folder is the binary that

447
00:16:50,790 --> 00:16:56,579
created that bat file which then created

448
00:16:52,890 --> 00:17:00,510
a short script which then was used to

449
00:16:56,580 --> 00:17:03,330
compile that exe file so I want to know

450
00:17:00,510 --> 00:17:04,890
where this file came from I've seen the

451
00:17:03,330 --> 00:17:05,799
Downloads folder probably can guess it's

452
00:17:04,890 --> 00:17:08,620
from the internet

453
00:17:05,799 --> 00:17:10,750
so I grabbed the Tanner process ID and I

454
00:17:08,619 --> 00:17:13,020
can see which patient it was used to

455
00:17:10,750 --> 00:17:16,270
download and it looks like it's chrome

456
00:17:13,020 --> 00:17:19,510
one artifact here in this chrome long

457
00:17:16,270 --> 00:17:21,309
that you can see and kind of a detail

458
00:17:19,510 --> 00:17:23,890
about our network is that we use safe

459
00:17:21,309 --> 00:17:27,369
links in email these safe links

460
00:17:23,890 --> 00:17:30,909
protection will rewrite any URLs inside

461
00:17:27,369 --> 00:17:32,949
the message email and wrap it in a

462
00:17:30,909 --> 00:17:35,890
scanner engine so when they click on

463
00:17:32,950 --> 00:17:37,649
that link instead of going directly to

464
00:17:35,890 --> 00:17:40,059
the website they are going through

465
00:17:37,649 --> 00:17:42,070
Microsoft scan engine which is going to

466
00:17:40,059 --> 00:17:45,340
analyze the website before it lets them

467
00:17:42,070 --> 00:17:47,860
go through Microsoft's malicious big red

468
00:17:45,340 --> 00:17:50,709
screen that says do not continue to this

469
00:17:47,860 --> 00:17:52,539
website and if it's fine it just

470
00:17:50,710 --> 00:17:57,130
redirects them right away and they don't

471
00:17:52,539 --> 00:18:00,279
know so I'm going to assume that because

472
00:17:57,130 --> 00:18:02,289
the URL that this download came from is

473
00:18:00,279 --> 00:18:04,120
grabbed from the safe links that this

474
00:18:02,289 --> 00:18:05,799
came from this was originally sent

475
00:18:04,120 --> 00:18:07,719
through a phishing email so I'm gonna

476
00:18:05,799 --> 00:18:09,789
test that hypothesis I mean I hop over

477
00:18:07,720 --> 00:18:12,279
to office 365 I'm gonna do a Content

478
00:18:09,789 --> 00:18:13,840
search for any email in my mail

479
00:18:12,279 --> 00:18:16,360
environment that contains that safe

480
00:18:13,840 --> 00:18:19,480
links URL and sure enough get a couple

481
00:18:16,360 --> 00:18:21,928
of results looks like Chris pain is the

482
00:18:19,480 --> 00:18:25,000
sender here and he sent out this email

483
00:18:21,929 --> 00:18:28,539
and if I click in I could take a look at

484
00:18:25,000 --> 00:18:30,370
that email and I can see okay standard

485
00:18:28,539 --> 00:18:32,890
hook he's having a retirement party you

486
00:18:30,370 --> 00:18:34,959
know he sits over there I know he's

487
00:18:32,890 --> 00:18:36,789
having that retirement party and I have

488
00:18:34,960 --> 00:18:39,399
a URL down the bottom see paying

489
00:18:36,789 --> 00:18:44,770
retirement Evite's net I'm gonna assume

490
00:18:39,399 --> 00:18:47,080
that is where that HTA came from and so

491
00:18:44,770 --> 00:18:49,270
I want a copy of that HTA I kind of want

492
00:18:47,080 --> 00:18:51,610
to know you know where this email was

493
00:18:49,270 --> 00:18:53,529
getting me some more details about it so

494
00:18:51,610 --> 00:18:55,299
I'm gonna hop over to my sandboxing and

495
00:18:53,529 --> 00:18:58,149
visit the website and it looks like this

496
00:18:55,299 --> 00:19:01,840
website is down so know what gain HT

497
00:18:58,149 --> 00:19:04,928
over there hop over to Microsoft message

498
00:19:01,840 --> 00:19:07,750
header analyzer tool I am a fan of and I

499
00:19:04,929 --> 00:19:09,460
stick the message headers in and it kind

500
00:19:07,750 --> 00:19:10,990
of just parses it out makes it a lot

501
00:19:09,460 --> 00:19:12,549
easier than you know scrolling through

502
00:19:10,990 --> 00:19:14,950
that and notepad which I find to be very

503
00:19:12,549 --> 00:19:17,090
annoying and I can see that this is a

504
00:19:14,950 --> 00:19:19,940
legitimate email it did originate from

505
00:19:17,090 --> 00:19:21,770
mailserver to my mail server it's not a

506
00:19:19,940 --> 00:19:24,140
spoof or anything like that so Chris

507
00:19:21,770 --> 00:19:27,230
Payne is indeed actually the sender but

508
00:19:24,140 --> 00:19:29,390
I still want a copy of that HTA file the

509
00:19:27,230 --> 00:19:31,400
only place I know that has it is that

510
00:19:29,390 --> 00:19:33,440
end users box where I saw those process

511
00:19:31,400 --> 00:19:36,440
logs executing so I'm gonna hop over to

512
00:19:33,440 --> 00:19:37,940
my EDR which has a remote shell and when

513
00:19:36,440 --> 00:19:40,880
I go over to that see temperature

514
00:19:37,940 --> 00:19:43,370
treatment with a lovely surprise there's

515
00:19:40,880 --> 00:19:46,160
a lot of items here that I was not

516
00:19:43,370 --> 00:19:49,639
previously aware of now you'll know this

517
00:19:46,160 --> 00:19:51,800
is my Thursday morning and you know this

518
00:19:49,640 --> 00:19:55,160
takes time you know I'm not gonna like

519
00:19:51,800 --> 00:19:57,050
chunk on query into my EDR and the first

520
00:19:55,160 --> 00:19:58,940
thing I find is when I go down the

521
00:19:57,050 --> 00:20:00,620
rabbit hole I'm gonna go through a few

522
00:19:58,940 --> 00:20:02,420
of those lines maybe I'll go down a

523
00:20:00,620 --> 00:20:06,830
rabbit hole the deme it's not malicious

524
00:20:02,420 --> 00:20:08,780
and then go continue on my day so it

525
00:20:06,830 --> 00:20:11,210
looks like there has been some activity

526
00:20:08,780 --> 00:20:14,680
on this box I don't know what it is I

527
00:20:11,210 --> 00:20:17,240
especially love that folder called pivot

528
00:20:14,680 --> 00:20:19,850
and it's at this time where I go yeah

529
00:20:17,240 --> 00:20:22,670
this is probably malicious but I work

530
00:20:19,850 --> 00:20:24,290
for you know corporations so before I

531
00:20:22,670 --> 00:20:27,290
could call into full and Senate

532
00:20:24,290 --> 00:20:28,940
responder mode I need to witness with

533
00:20:27,290 --> 00:20:30,620
malicious activity I need to see

534
00:20:28,940 --> 00:20:33,200
malicious code I can't just you know

535
00:20:30,620 --> 00:20:36,139
like oh I have a hunch let's go kill

536
00:20:33,200 --> 00:20:39,380
that server I might not have a job so

537
00:20:36,140 --> 00:20:42,080
we're gonna go ahead and download all of

538
00:20:39,380 --> 00:20:44,840
these local to the box for some analysis

539
00:20:42,080 --> 00:20:47,120
now you'll notice I connected to a box

540
00:20:44,840 --> 00:20:49,340
that I was investigating I did this

541
00:20:47,120 --> 00:20:52,300
through my EDRs credential ashell it is

542
00:20:49,340 --> 00:20:55,520
a very common practice for attackers to

543
00:20:52,300 --> 00:20:58,100
you know monitor for connections to

544
00:20:55,520 --> 00:20:59,900
workstations or just servers and try to

545
00:20:58,100 --> 00:21:01,760
intercept those credentials so if you

546
00:20:59,900 --> 00:21:03,830
are doing any type of investigation it's

547
00:21:01,760 --> 00:21:06,650
very important you know don't RDP into a

548
00:21:03,830 --> 00:21:09,949
server with your domain creds you use a

549
00:21:06,650 --> 00:21:12,410
credential a shell with an hour tool

550
00:21:09,950 --> 00:21:15,710
that you may have or may be getting soon

551
00:21:12,410 --> 00:21:17,450
or a lot of times the helpdesk remote

552
00:21:15,710 --> 00:21:19,430
assistant software does not use

553
00:21:17,450 --> 00:21:20,930
credentials to be able to connect to a

554
00:21:19,430 --> 00:21:23,150
box so you can piggyback off their

555
00:21:20,930 --> 00:21:24,990
infrastructure and if you don't have an

556
00:21:23,150 --> 00:21:26,640
option like that you can

557
00:21:24,990 --> 00:21:28,620
whose credentials local to the

558
00:21:26,640 --> 00:21:29,850
workstation if it is infected any

559
00:21:28,620 --> 00:21:31,620
credentials local to that workstation

560
00:21:29,850 --> 00:21:33,540
you can probably already assume are

561
00:21:31,620 --> 00:21:36,030
compromised so if you pass them

562
00:21:33,540 --> 00:21:37,560
credentials they already have not a big

563
00:21:36,030 --> 00:21:40,050
deal especially if they can't use those

564
00:21:37,560 --> 00:21:42,240
to pivot so use something like Microsoft

565
00:21:40,050 --> 00:21:45,690
lapse in order to do that connection if

566
00:21:42,240 --> 00:21:48,360
you absolutely must pass threats ok so I

567
00:21:45,690 --> 00:21:50,400
have a busy day and I don't manually

568
00:21:48,360 --> 00:21:52,169
reverse-engineer every single binary

569
00:21:50,400 --> 00:21:54,990
file that comes across my computer

570
00:21:52,170 --> 00:21:57,060
screen so I use a tool called hybrid

571
00:21:54,990 --> 00:21:59,520
analysis there's a ton of these you can

572
00:21:57,060 --> 00:22:00,960
have there's public ones there's private

573
00:21:59,520 --> 00:22:02,850
sandboxes that you can get

574
00:22:00,960 --> 00:22:06,720
I want these dudes you can just chuck as

575
00:22:02,850 --> 00:22:09,449
suspicious or more malicious binary into

576
00:22:06,720 --> 00:22:10,650
this it will run it in a sandbox and

577
00:22:09,450 --> 00:22:12,960
it'll analyze it give you a whole bunch

578
00:22:10,650 --> 00:22:16,710
of indicators that you accuse to a pivot

579
00:22:12,960 --> 00:22:19,650
off an investigation so here we have a

580
00:22:16,710 --> 00:22:22,890
kind of a sec opps break if you're using

581
00:22:19,650 --> 00:22:25,620
a public sandbox like this attackers

582
00:22:22,890 --> 00:22:27,960
watch these um if they develop a payload

583
00:22:25,620 --> 00:22:29,219
for your environment they have the hash

584
00:22:27,960 --> 00:22:31,260
values and they're going to be

585
00:22:29,220 --> 00:22:32,760
monitoring to see if those hash values

586
00:22:31,260 --> 00:22:34,260
are in that environment this is the

587
00:22:32,760 --> 00:22:36,720
first time they'd probably say hey

588
00:22:34,260 --> 00:22:40,080
they're on to me they'll either go into

589
00:22:36,720 --> 00:22:41,490
stasis or you know if they're jerks like

590
00:22:40,080 --> 00:22:47,250
this guy here he might bring the whole

591
00:22:41,490 --> 00:22:49,620
environment down so you know if you if

592
00:22:47,250 --> 00:22:50,940
you don't have an internal sandbox that

593
00:22:49,620 --> 00:22:52,590
you can do this type file you can

594
00:22:50,940 --> 00:22:54,450
purchase you services where they're not

595
00:22:52,590 --> 00:22:57,030
public facing not queryable and they're

596
00:22:54,450 --> 00:23:00,630
just for your company alone and for the

597
00:22:57,030 --> 00:23:02,129
sandbox why I'm letting the hybrid

598
00:23:00,630 --> 00:23:04,590
analysis do the heavy listening on that

599
00:23:02,130 --> 00:23:06,120
evite exe file I'm gonna come over I'm

600
00:23:04,590 --> 00:23:10,590
gonna take a look at the C sharp script

601
00:23:06,120 --> 00:23:12,629
now I'm not a full-time programmer but

602
00:23:10,590 --> 00:23:14,490
it doesn't take a whole lot to take a

603
00:23:12,630 --> 00:23:19,920
look at this code and realize that know

604
00:23:14,490 --> 00:23:21,300
sober programmer wrote this and it just

605
00:23:19,920 --> 00:23:22,860
sold a couple of minutes here maybe like

606
00:23:21,300 --> 00:23:25,980
two minutes I can see this is just

607
00:23:22,860 --> 00:23:29,070
nonsensical math up top the uninstall

608
00:23:25,980 --> 00:23:30,870
class just invokes one class which is

609
00:23:29,070 --> 00:23:34,020
right below and if I take a look at that

610
00:23:30,870 --> 00:23:37,409
class I have two base64 encoded

611
00:23:34,020 --> 00:23:38,220
variables or it looks like one big basic

612
00:23:37,410 --> 00:23:40,230
seed forward

613
00:23:38,220 --> 00:23:42,630
string that was split into two and then

614
00:23:40,230 --> 00:23:43,740
the line at the very bottom there I went

615
00:23:42,630 --> 00:23:45,299
up from the bottom there it's just

616
00:23:43,740 --> 00:23:47,880
connect at Nate's those two variables

617
00:23:45,299 --> 00:23:49,710
together and then decodes them this is

618
00:23:47,880 --> 00:23:53,429
not normal practice for our developers

619
00:23:49,710 --> 00:23:55,799
I'm not aware of it being widely adopted

620
00:23:53,429 --> 00:23:58,159
so I when I see stuff like this I kind

621
00:23:55,799 --> 00:24:01,049
of assume it's malicious and we'll take

622
00:23:58,159 --> 00:24:03,480
I'm gonna pop over to the look at that

623
00:24:01,049 --> 00:24:05,629
SSH that VBS file that we also saw on

624
00:24:03,480 --> 00:24:06,900
that see temp directory it's so quick

625
00:24:05,630 --> 00:24:09,900
vbscript

626
00:24:06,900 --> 00:24:14,100
and it looks right here is just use W

627
00:24:09,900 --> 00:24:17,150
script shell to use SSH to exe along

628
00:24:14,100 --> 00:24:20,158
with a key file and tunnel out to an IP

629
00:24:17,150 --> 00:24:22,409
so I'm gonna grab you know binary names

630
00:24:20,159 --> 00:24:24,870
port numbers I'm gonna grab the keep

631
00:24:22,409 --> 00:24:26,730
file IP addresses you know file hashes

632
00:24:24,870 --> 00:24:28,080
these are all indicators you're gonna

633
00:24:26,730 --> 00:24:31,470
write down I'm gonna set them to the

634
00:24:28,080 --> 00:24:34,860
side going over to that city and peeta

635
00:24:31,470 --> 00:24:36,270
ps1 file I open that up and anyone

636
00:24:34,860 --> 00:24:39,149
familiar with PowerShell Empire will

637
00:24:36,270 --> 00:24:41,850
immediately recognize this as the chrome

638
00:24:39,150 --> 00:24:44,130
dump script still fully commented and

639
00:24:41,850 --> 00:24:46,649
unedited directly off their github page

640
00:24:44,130 --> 00:24:48,240
so getting a little concerned here cuz

641
00:24:46,650 --> 00:24:51,120
uh looks like there is actually a

642
00:24:48,240 --> 00:24:53,880
malicious activity um and somewhere

643
00:24:51,120 --> 00:24:56,760
between you know you know looking at the

644
00:24:53,880 --> 00:25:01,559
email and now I've moved into hunting

645
00:24:56,760 --> 00:25:03,090
and into incident response so you know I

646
00:25:01,559 --> 00:25:05,700
want to see if that script was

647
00:25:03,090 --> 00:25:07,590
successful and if I look at that CDM P

648
00:25:05,700 --> 00:25:10,049
dot txt file that was in the directory

649
00:25:07,590 --> 00:25:12,240
it looks like it was have a nice list

650
00:25:10,049 --> 00:25:14,610
here full of plain text credentials on

651
00:25:12,240 --> 00:25:18,000
the URLs that the attacker can use with

652
00:25:14,610 --> 00:25:20,610
them so excellent not that I need the

653
00:25:18,000 --> 00:25:23,490
hybrid analysis results to identify this

654
00:25:20,610 --> 00:25:25,229
activity as malicious but here's the

655
00:25:23,490 --> 00:25:27,690
results from hybrid analysis that come

656
00:25:25,230 --> 00:25:31,230
in it's got a 45 out of hundred no AV

657
00:25:27,690 --> 00:25:34,679
vendors have determined it was you know

658
00:25:31,230 --> 00:25:36,720
malicious you know I'm sure all of you

659
00:25:34,679 --> 00:25:39,150
are fully staffed and have all of the

660
00:25:36,720 --> 00:25:42,240
time that you need to do phone track

661
00:25:39,150 --> 00:25:44,309
down every minor thing but for one of

662
00:25:42,240 --> 00:25:46,260
those socks that are not fully staffed

663
00:25:44,309 --> 00:25:48,030
or you know are a little busy this

664
00:25:46,260 --> 00:25:49,290
probably would get passed over if all

665
00:25:48,030 --> 00:25:52,320
they do is have it announced

666
00:25:49,290 --> 00:25:54,960
and they'll move on with their day so I

667
00:25:52,320 --> 00:25:57,480
know it's malicious and some of you guys

668
00:25:54,960 --> 00:26:00,030
may work in an environment where you

669
00:25:57,480 --> 00:26:03,510
know rogue employees are major concern

670
00:26:00,030 --> 00:26:05,490
for you I don't and if I see an

671
00:26:03,510 --> 00:26:07,080
employee's email accounts and you know

672
00:26:05,490 --> 00:26:09,450
malicious fishes

673
00:26:07,080 --> 00:26:12,090
I don't assume it's the employee trying

674
00:26:09,450 --> 00:26:13,980
to do that type of activity but I kind

675
00:26:12,090 --> 00:26:16,080
of assume that his account has been

676
00:26:13,980 --> 00:26:22,020
compromised so the first thing I'm going

677
00:26:16,080 --> 00:26:23,429
to do is I try to purge that malicious

678
00:26:22,020 --> 00:26:26,580
email out of my environment then I'm

679
00:26:23,430 --> 00:26:28,380
gonna go see if my hypothesis on his

680
00:26:26,580 --> 00:26:31,080
account being compromised is correct so

681
00:26:28,380 --> 00:26:33,780
connect to the security appliance center

682
00:26:31,080 --> 00:26:36,330
for office 365 with PowerShell I can do

683
00:26:33,780 --> 00:26:38,100
is call the content search purge earlier

684
00:26:36,330 --> 00:26:39,810
I did a Content search where I gathered

685
00:26:38,100 --> 00:26:42,750
all those phishing emails up from that

686
00:26:39,810 --> 00:26:44,850
URL now I can say purge that from my

687
00:26:42,750 --> 00:26:46,770
mail server completely I will remove it

688
00:26:44,850 --> 00:26:49,290
from every instance about still keep it

689
00:26:46,770 --> 00:26:51,360
in an isolated spot that secure you know

690
00:26:49,290 --> 00:26:53,220
that content search so that I can

691
00:26:51,360 --> 00:26:54,870
continue to grab and download for

692
00:26:53,220 --> 00:26:57,840
samples or if I want to go back and take

693
00:26:54,870 --> 00:26:59,610
a look at it next to take a look at the

694
00:26:57,840 --> 00:27:02,100
account activity I'm going to head over

695
00:26:59,610 --> 00:27:04,439
to Azure Active Directory for my office

696
00:27:02,100 --> 00:27:06,870
365 environment which is actually where

697
00:27:04,440 --> 00:27:12,030
the authentication logs for office 365

698
00:27:06,870 --> 00:27:14,760
are stored now like Aaron said not all

699
00:27:12,030 --> 00:27:17,210
seams work to ingest this or maybe you

700
00:27:14,760 --> 00:27:19,500
know your EPS licensing isn't able to

701
00:27:17,210 --> 00:27:20,850
bring this type of information in

702
00:27:19,500 --> 00:27:22,530
because you're too busy trying to you

703
00:27:20,850 --> 00:27:26,610
know meet PCI compliance or something

704
00:27:22,530 --> 00:27:29,129
like that so luckily they do allow you

705
00:27:26,610 --> 00:27:31,050
to download these vlogs into a nice CSV

706
00:27:29,130 --> 00:27:33,300
file so I'm going to go ahead and I'm

707
00:27:31,050 --> 00:27:36,240
gonna do that and you see this is what

708
00:27:33,300 --> 00:27:37,470
it takes to look in looks like lots of

709
00:27:36,240 --> 00:27:39,270
different things that we can you know

710
00:27:37,470 --> 00:27:41,370
run good searches on you have source IP

711
00:27:39,270 --> 00:27:44,010
user agent strings authentication and

712
00:27:41,370 --> 00:27:46,290
results now you could search through

713
00:27:44,010 --> 00:27:48,420
this by hand that would take way too

714
00:27:46,290 --> 00:27:50,610
long and I'm Way too lazy to do that so

715
00:27:48,420 --> 00:27:52,350
I wrote a PowerShell script that will

716
00:27:50,610 --> 00:27:54,360
just churn through the logs filter out

717
00:27:52,350 --> 00:27:56,820
the known good IPS like our headquarter

718
00:27:54,360 --> 00:27:59,159
office or remote offices where I do

719
00:27:56,820 --> 00:28:01,830
expect a lot of authentication failures

720
00:27:59,160 --> 00:28:05,370
from multiple user accounts to happen

721
00:28:01,830 --> 00:28:08,309
and then I will turn through fine to any

722
00:28:05,370 --> 00:28:10,770
IP address that have for each failure

723
00:28:08,309 --> 00:28:12,990
log that has attempted to log into more

724
00:28:10,770 --> 00:28:15,360
than one user account and has greater

725
00:28:12,990 --> 00:28:17,280
than 10 failures and then I'll take all

726
00:28:15,360 --> 00:28:19,379
those IP addresses are rerun through all

727
00:28:17,280 --> 00:28:21,389
the successful logs and I'll spit out

728
00:28:19,380 --> 00:28:24,510
any email address and IP address that

729
00:28:21,390 --> 00:28:26,790
has had a successful login so when I run

730
00:28:24,510 --> 00:28:28,950
this script sure enough pain see a

731
00:28:26,790 --> 00:28:30,930
pheasant comm it looks like it was from

732
00:28:28,950 --> 00:28:32,760
one of those attacker IP addresses and

733
00:28:30,930 --> 00:28:35,850
was able to successfully log in so

734
00:28:32,760 --> 00:28:37,559
suspicions confirmed so I'm gonna clean

735
00:28:35,850 --> 00:28:39,389
that up first gonna reset the password

736
00:28:37,559 --> 00:28:42,210
in Active Directory I'm gonna hop into

737
00:28:39,390 --> 00:28:44,100
office 365 they now have this in the GUI

738
00:28:42,210 --> 00:28:47,550
or you can still to empower shell to

739
00:28:44,100 --> 00:28:50,250
revoke all keys across the board so any

740
00:28:47,550 --> 00:28:52,500
client that has used has authenticated

741
00:28:50,250 --> 00:28:55,260
to that account will be forced to reopen

742
00:28:52,500 --> 00:28:57,059
to kate post password reset I'll send a

743
00:28:55,260 --> 00:28:58,830
ticket over to the helpdesk to assist

744
00:28:57,059 --> 00:29:00,960
the user with getting all his devices

745
00:28:58,830 --> 00:29:02,520
and everything back on gonna send that

746
00:29:00,960 --> 00:29:04,320
chrome dump script over so they can you

747
00:29:02,520 --> 00:29:05,100
know make sure all his personal stuff

748
00:29:04,320 --> 00:29:08,580
isn't hosed

749
00:29:05,100 --> 00:29:11,909
tomorrow the also a common attacker

750
00:29:08,580 --> 00:29:14,189
technique is to forward all copy of all

751
00:29:11,910 --> 00:29:16,530
nails out to an external so external

752
00:29:14,190 --> 00:29:18,600
email so even if they lose access to the

753
00:29:16,530 --> 00:29:19,830
mailbox they still have full eyes on any

754
00:29:18,600 --> 00:29:22,350
type of communication that may happen

755
00:29:19,830 --> 00:29:24,840
and believe it or not helped us do send

756
00:29:22,350 --> 00:29:29,790
the passwords for resets to email so

757
00:29:24,840 --> 00:29:31,230
that's like a thing so yeah so I'm gonna

758
00:29:29,790 --> 00:29:33,120
review those make sure there isn't

759
00:29:31,230 --> 00:29:35,309
anything fishy going on they're gonna

760
00:29:33,120 --> 00:29:37,530
just spot check his sent mail make sure

761
00:29:35,309 --> 00:29:39,210
he didn't say any other fishes out I'm

762
00:29:37,530 --> 00:29:41,480
gonna spot check his activity logs make

763
00:29:39,210 --> 00:29:45,080
sure he's enough to anything else on so

764
00:29:41,480 --> 00:29:47,220
after doing all that we look good so

765
00:29:45,080 --> 00:29:48,780
initial ingress cleaned up back to

766
00:29:47,220 --> 00:29:52,950
ranking out the rest of the activity and

767
00:29:48,780 --> 00:29:55,500
I originally started with you know one

768
00:29:52,950 --> 00:29:57,330
log at a time taking the parent process

769
00:29:55,500 --> 00:29:59,760
ID chucking it in and kind of mapping

770
00:29:57,330 --> 00:30:01,439
this out by hand and that takes a lot of

771
00:29:59,760 --> 00:30:04,379
time and when you're trying to you know

772
00:30:01,440 --> 00:30:06,059
spin up and justify threat hunting in

773
00:30:04,380 --> 00:30:09,300
your environment but you do get a lot of

774
00:30:06,059 --> 00:30:11,149
value from it it's really hard to sell

775
00:30:09,300 --> 00:30:12,799
it when you're like yes that one guy

776
00:30:11,149 --> 00:30:14,330
we'll spend all day everyday just

777
00:30:12,799 --> 00:30:17,179
manually going through logs it's

778
00:30:14,330 --> 00:30:20,239
probably not gonna sell and so where you

779
00:30:17,179 --> 00:30:23,059
focus on tooling really matters most

780
00:30:20,239 --> 00:30:24,169
edie our products come you know help you

781
00:30:23,059 --> 00:30:25,489
with that and they come with something

782
00:30:24,169 --> 00:30:27,799
like this where you can just right click

783
00:30:25,489 --> 00:30:30,379
on any one of those logs anywhere in the

784
00:30:27,799 --> 00:30:32,599
entire activity chain and you can draw

785
00:30:30,379 --> 00:30:34,279
out a process tree like this and you can

786
00:30:32,599 --> 00:30:35,809
see here this is what it looks like for

787
00:30:34,279 --> 00:30:37,279
these eight logs that I was looking at

788
00:30:35,809 --> 00:30:39,859
earlier so let's take a look and see

789
00:30:37,279 --> 00:30:43,339
what we got so this is the initial log

790
00:30:39,859 --> 00:30:46,759
install util that exe executing that

791
00:30:43,339 --> 00:30:48,710
evite exe file moving up I can see HTA

792
00:30:46,759 --> 00:30:51,320
execution and over on the right-hand

793
00:30:48,710 --> 00:30:53,769
side you can see that they have you know

794
00:30:51,320 --> 00:30:56,149
files written to disk that evite dot bat

795
00:30:53,769 --> 00:30:57,799
going up the tree I can see the parent

796
00:30:56,149 --> 00:30:59,869
processes of Chrome which is invoked to

797
00:30:57,799 --> 00:31:03,349
the download and I can also see that

798
00:30:59,869 --> 00:31:06,168
chrome was launched from Outlook so here

799
00:31:03,349 --> 00:31:09,189
we can see that CSC that exe is

800
00:31:06,169 --> 00:31:12,440
compiling eval-exp

801
00:31:09,190 --> 00:31:15,440
and here we get some new activity we can

802
00:31:12,440 --> 00:31:18,349
see that scheduled tasks being created

803
00:31:15,440 --> 00:31:22,609
called field of pain and is referencing

804
00:31:18,349 --> 00:31:24,320
feel the pain DBS in C temp next I can

805
00:31:22,609 --> 00:31:28,189
see PowerShell executing that

806
00:31:24,320 --> 00:31:31,939
chromed-out script I can see tasks kill

807
00:31:28,190 --> 00:31:34,129
killing process ID and then I can see

808
00:31:31,940 --> 00:31:38,479
that chrome down script executes again

809
00:31:34,129 --> 00:31:39,799
but then all activity stops so I'm going

810
00:31:38,479 --> 00:31:41,719
to take a look at the event timeline and

811
00:31:39,799 --> 00:31:44,719
see you and I can have what I can do so

812
00:31:41,719 --> 00:31:47,299
I chuck that install you to that exe

813
00:31:44,719 --> 00:31:48,830
into the event timeline the night UDR

814
00:31:47,299 --> 00:31:52,519
provides and I can see there's a lot of

815
00:31:48,830 --> 00:31:54,918
activity for that binary you know last

816
00:31:52,519 --> 00:31:56,809
night and then over on the right hand

817
00:31:54,919 --> 00:31:59,629
side after a long period of no activity

818
00:31:56,809 --> 00:32:02,509
I see some activity turning up again I'm

819
00:31:59,629 --> 00:32:05,449
somewhere in this green blob of activity

820
00:32:02,509 --> 00:32:07,460
if time period over on the right but I

821
00:32:05,450 --> 00:32:10,609
have been investigating everything over

822
00:32:07,460 --> 00:32:12,979
on the left so quick recap up until now

823
00:32:10,609 --> 00:32:14,989
looks like we had a successful password

824
00:32:12,979 --> 00:32:17,029
spree on office 365 for an attacker

825
00:32:14,989 --> 00:32:18,889
popped credentials for Chris Payne sent

826
00:32:17,029 --> 00:32:21,289
out a fish from the users mailbox and it

827
00:32:18,889 --> 00:32:22,800
looks like we had an end user Somerville

828
00:32:21,289 --> 00:32:26,100
T click on that fish

829
00:32:22,800 --> 00:32:28,409
to open a shell it appears that they

830
00:32:26,100 --> 00:32:31,320
were off-premise while doing that it

831
00:32:28,410 --> 00:32:33,870
looks like the attacker was setting up

832
00:32:31,320 --> 00:32:35,070
persistence via skype s and then looks

833
00:32:33,870 --> 00:32:36,929
like the attacker was successful at

834
00:32:35,070 --> 00:32:39,929
dumping of stored credentials from the

835
00:32:36,930 --> 00:32:41,970
end users Chrome browser and then all

836
00:32:39,930 --> 00:32:44,310
activity steps most likely due because

837
00:32:41,970 --> 00:32:45,090
the machine being powered off because it

838
00:32:44,310 --> 00:32:47,490
was nighttime

839
00:32:45,090 --> 00:32:48,840
so I then cleaned up the fish the

840
00:32:47,490 --> 00:32:51,300
initial point of ingress did the

841
00:32:48,840 --> 00:32:53,310
password resets Thank You helpdesk and

842
00:32:51,300 --> 00:32:56,790
it appears I have new activity this

843
00:32:53,310 --> 00:32:58,620
morning that I still need to map out but

844
00:32:56,790 --> 00:33:00,870
I will hand it over to Aaron before we

845
00:32:58,620 --> 00:33:03,540
get to that all right so Tom obviously

846
00:33:00,870 --> 00:33:05,100
ran through a lot more than I had showed

847
00:33:03,540 --> 00:33:08,280
with the payload I mean made the payload

848
00:33:05,100 --> 00:33:09,449
I sent it out but I got a fish so we let

849
00:33:08,280 --> 00:33:10,620
him run through some detection stuff

850
00:33:09,450 --> 00:33:12,480
we're gonna backtrack and do a little

851
00:33:10,620 --> 00:33:15,300
flashback to show what was actually

852
00:33:12,480 --> 00:33:16,680
happening on the red team's ID we sent

853
00:33:15,300 --> 00:33:18,389
the email out we sent it out late at

854
00:33:16,680 --> 00:33:20,460
night and what do you know a shell came

855
00:33:18,390 --> 00:33:21,900
back that night looks like they had a

856
00:33:20,460 --> 00:33:24,720
good employee who decided to work from

857
00:33:21,900 --> 00:33:25,980
home on his corporate laptop works for

858
00:33:24,720 --> 00:33:28,350
me I guess I get a shell I'm gonna start

859
00:33:25,980 --> 00:33:29,760
hacking until it goes away first thing I

860
00:33:28,350 --> 00:33:32,250
get a shell comes through I need to make

861
00:33:29,760 --> 00:33:34,080
sure my persistence is set up one poor

862
00:33:32,250 --> 00:33:35,430
thing I did in my operational setup was

863
00:33:34,080 --> 00:33:37,889
that I didn't have an auto persistence

864
00:33:35,430 --> 00:33:39,900
run on my initial beachhead shell or my

865
00:33:37,890 --> 00:33:42,570
stage one so I need to go ahead and

866
00:33:39,900 --> 00:33:44,490
establish that poor planning I'm rushing

867
00:33:42,570 --> 00:33:46,980
I'm just gonna go with SCH tasks likely

868
00:33:44,490 --> 00:33:48,480
as we saw from Tom stuff there but we

869
00:33:46,980 --> 00:33:50,070
see in our shell real quick that it's

870
00:33:48,480 --> 00:33:54,180
executed by install you - this is the

871
00:33:50,070 --> 00:33:55,320
Empire C - listener here and it's

872
00:33:54,180 --> 00:33:57,450
telling me basically the shell is

873
00:33:55,320 --> 00:33:59,280
running as Summerville t is the username

874
00:33:57,450 --> 00:34:01,170
that's running under process name

875
00:33:59,280 --> 00:34:03,510
install util it's not running as an

876
00:34:01,170 --> 00:34:05,790
admin and we can also see the IP mast

877
00:34:03,510 --> 00:34:07,140
out but it came from a home IP address

878
00:34:05,790 --> 00:34:10,110
it wasn't from the Bezdek network that

879
00:34:07,140 --> 00:34:11,790
we were expecting and so like ran on

880
00:34:10,110 --> 00:34:13,080
this machine but I guess we're at home

881
00:34:11,790 --> 00:34:15,270
we're not gonna be able to be able to do

882
00:34:13,080 --> 00:34:16,290
domain lateral movement or anything so

883
00:34:15,270 --> 00:34:19,739
let's see what we can find about this

884
00:34:16,290 --> 00:34:21,179
local host right now so again we're

885
00:34:19,739 --> 00:34:22,439
rushing for persistence at this point

886
00:34:21,179 --> 00:34:24,750
because we should have set it up before

887
00:34:22,440 --> 00:34:26,510
it's one of those OPSEC fails and so we

888
00:34:24,750 --> 00:34:29,790
go with creating a quick scheduled task

889
00:34:26,510 --> 00:34:30,929
and we're gonna use our field obtain VBS

890
00:34:29,790 --> 00:34:32,460
is what we end up putting on disk

891
00:34:30,929 --> 00:34:34,500
because we have our batch file that can

892
00:34:32,460 --> 00:34:36,139
run to run our shell that the HTA made

893
00:34:34,500 --> 00:34:37,730
but if you try to run a batch

894
00:34:36,139 --> 00:34:39,649
on windows outside of using something

895
00:34:37,730 --> 00:34:41,239
like vbscript on Windows 10 especially

896
00:34:39,649 --> 00:34:43,190
you can't get rid of a black box that's

897
00:34:41,239 --> 00:34:44,869
gonna pop up there's no hiding it so we

898
00:34:43,190 --> 00:34:48,200
can use vbscript

899
00:34:44,869 --> 00:34:50,029
to do me a w script shell which will go

900
00:34:48,199 --> 00:34:52,158
ahead and execute it in a hidden

901
00:34:50,029 --> 00:34:54,829
background window and so we create our

902
00:34:52,159 --> 00:34:56,299
field pane VBS we drop it on disk and

903
00:34:54,829 --> 00:34:59,390
then we set up a scheduled task to run

904
00:34:56,299 --> 00:35:00,710
it to run our batch file after we have

905
00:34:59,390 --> 00:35:03,230
our persistence we know it's gonna call

906
00:35:00,710 --> 00:35:04,880
back each day for us we're not on the

907
00:35:03,230 --> 00:35:06,499
local network so again it's not like I

908
00:35:04,880 --> 00:35:08,180
can do any domain recon

909
00:35:06,499 --> 00:35:09,348
they weren't VPN din it didn't look like

910
00:35:08,180 --> 00:35:10,910
so I'm just gonna figure out what this

911
00:35:09,349 --> 00:35:13,309
host has and what I can use on this host

912
00:35:10,910 --> 00:35:14,538
is there any next-gen AV running let's

913
00:35:13,309 --> 00:35:15,769
get the AV provider let's get some

914
00:35:14,539 --> 00:35:18,440
information about the current software

915
00:35:15,769 --> 00:35:20,180
and processes running are there any

916
00:35:18,440 --> 00:35:21,829
exploitable services for local privilege

917
00:35:20,180 --> 00:35:25,190
escalation since the user is not a local

918
00:35:21,829 --> 00:35:27,529
admin you know are there any scheduled

919
00:35:25,190 --> 00:35:29,089
tasks we could abuse or you know any

920
00:35:27,529 --> 00:35:30,859
ideas we could hide you back to try and

921
00:35:29,089 --> 00:35:32,980
elevate our privileges check for patches

922
00:35:30,859 --> 00:35:35,749
but overall we didn't find any of that

923
00:35:32,980 --> 00:35:37,220
you know we had been looking for it but

924
00:35:35,749 --> 00:35:39,169
we didn't find it we didn't see there

925
00:35:37,220 --> 00:35:42,859
was a next-gen AV running though and II

926
00:35:39,170 --> 00:35:45,589
D our product so if we don't have any

927
00:35:42,859 --> 00:35:47,150
way to get to local admin well option

928
00:35:45,589 --> 00:35:48,980
would be to get off this box usually

929
00:35:47,150 --> 00:35:50,150
once you compromise a host as well you

930
00:35:48,980 --> 00:35:51,950
don't want to sit on the host that you

931
00:35:50,150 --> 00:35:54,019
fished because eventually they might

932
00:35:51,950 --> 00:35:55,519
catch on it's it's like your hot spot

933
00:35:54,019 --> 00:35:56,868
host I guess it's you know you don't rob

934
00:35:55,519 --> 00:35:58,700
a bank and then just sit inside once you

935
00:35:56,869 --> 00:35:59,869
get inside you want to get out go

936
00:35:58,700 --> 00:36:01,249
somewhere else go hide

937
00:35:59,869 --> 00:36:03,380
so it's an attacker I'm gonna get on the

938
00:36:01,249 --> 00:36:05,299
Box I need to get off to somewhere else

939
00:36:03,380 --> 00:36:07,279
and then establish persistence on the

940
00:36:05,299 --> 00:36:09,288
new host I've gotten access to and then

941
00:36:07,279 --> 00:36:13,430
work out of that one to further lateral

942
00:36:09,289 --> 00:36:14,839
move inside the network but I need a way

943
00:36:13,430 --> 00:36:17,839
to do that with credentials I don't have

944
00:36:14,839 --> 00:36:18,920
this users credentials and so I wanted

945
00:36:17,839 --> 00:36:20,599
to get the users graduals that I'm

946
00:36:18,920 --> 00:36:22,279
currently logged in as and so I decided

947
00:36:20,599 --> 00:36:23,569
use chrome dump I can't from chrome dump

948
00:36:22,279 --> 00:36:25,759
I'm going to find all the websites he's

949
00:36:23,569 --> 00:36:28,359
logged into what credentials you use if

950
00:36:25,759 --> 00:36:30,799
he stored passwords in the browser and

951
00:36:28,359 --> 00:36:33,170
run that but one of the things I ran

952
00:36:30,799 --> 00:36:34,849
into is an issue the Empire module isn't

953
00:36:33,170 --> 00:36:36,980
working and I couldn't just call it I

954
00:36:34,849 --> 00:36:38,809
could use IX to download from the

955
00:36:36,980 --> 00:36:40,910
internet and run the PowerShell script

956
00:36:38,809 --> 00:36:43,220
so I don't have to put it on disk but IX

957
00:36:40,910 --> 00:36:44,020
is pretty often flagged when you're

958
00:36:43,220 --> 00:36:45,910
downloading something

959
00:36:44,020 --> 00:36:48,009
the Internet and so I know the chrome

960
00:36:45,910 --> 00:36:50,500
dump script is not like a running you

961
00:36:48,010 --> 00:36:52,300
know mini cats script or some of the

962
00:36:50,500 --> 00:36:55,180
more malicious ones it's usually not

963
00:36:52,300 --> 00:36:56,530
flagged not sure why but a lot of a/b

964
00:36:55,180 --> 00:36:56,890
vendors aren't looking directly at this

965
00:36:56,530 --> 00:36:58,780
one

966
00:36:56,890 --> 00:37:00,160
so I test it in my sandbox and then

967
00:36:58,780 --> 00:37:02,230
decide to just upload it directly to

968
00:37:00,160 --> 00:37:04,060
this host and run it without using noisy

969
00:37:02,230 --> 00:37:06,880
things like an IE X download to invoke

970
00:37:04,060 --> 00:37:08,650
in memory and so I upload it there

971
00:37:06,880 --> 00:37:10,660
didn't modify it that much though I just

972
00:37:08,650 --> 00:37:13,420
changed the name maybe that's something

973
00:37:10,660 --> 00:37:15,430
that you know as a more mature red team

974
00:37:13,420 --> 00:37:17,260
would do is modify the script write

975
00:37:15,430 --> 00:37:19,899
their own change variables inside of it

976
00:37:17,260 --> 00:37:21,850
so it's not so obviously chrome dump but

977
00:37:19,900 --> 00:37:24,040
in this case now we just opted to run

978
00:37:21,850 --> 00:37:27,580
quick so one of those second OPSEC fails

979
00:37:24,040 --> 00:37:29,529
I was talking about and then one of the

980
00:37:27,580 --> 00:37:31,720
other things is chrome dump can't run

981
00:37:29,530 --> 00:37:32,620
when chrome is running because it needs

982
00:37:31,720 --> 00:37:34,779
to spin up an instance of the browser

983
00:37:32,620 --> 00:37:37,060
attached to it and pull a key out of

984
00:37:34,780 --> 00:37:39,970
them out of memory so that we can take

985
00:37:37,060 --> 00:37:41,710
and extract that information from the

986
00:37:39,970 --> 00:37:43,270
database and decrypt it so we have to

987
00:37:41,710 --> 00:37:44,890
kill the users instance of chrome since

988
00:37:43,270 --> 00:37:46,750
they're running it so we quickly kill it

989
00:37:44,890 --> 00:37:48,700
run chrome dump and then start chrome

990
00:37:46,750 --> 00:37:50,350
for them so they think drum must have

991
00:37:48,700 --> 00:37:51,879
just crashed or something hopefully they

992
00:37:50,350 --> 00:37:54,310
don't look into it too much if you do it

993
00:37:51,880 --> 00:37:57,130
quick enough and then once we have our

994
00:37:54,310 --> 00:37:58,690
output file we download chrome dump text

995
00:37:57,130 --> 00:38:00,190
and see we have passwords in there and

996
00:37:58,690 --> 00:38:02,380
we know it's the user's domain password

997
00:38:00,190 --> 00:38:03,910
password quits it's stored for the login

998
00:38:02,380 --> 00:38:07,300
microsoft online.com

999
00:38:03,910 --> 00:38:08,710
so there 365 deployment and yeah now

1000
00:38:07,300 --> 00:38:10,270
we've got you know some are real T's

1001
00:38:08,710 --> 00:38:12,790
creds and let's see what we can do with

1002
00:38:10,270 --> 00:38:14,590
them and then as we kept working to look

1003
00:38:12,790 --> 00:38:16,060
at the hosts our shell goes away I mean

1004
00:38:14,590 --> 00:38:17,500
it was late at night I guess employees

1005
00:38:16,060 --> 00:38:19,690
have to sleep - I guess red teamers

1006
00:38:17,500 --> 00:38:21,550
don't usually do that but standard

1007
00:38:19,690 --> 00:38:25,450
employees whatever so ya know she'll

1008
00:38:21,550 --> 00:38:29,770
hopefully we get it back the next day ok

1009
00:38:25,450 --> 00:38:31,319
so back to when I was talking but fast

1010
00:38:29,770 --> 00:38:33,520
forward from when Aaron was talking

1011
00:38:31,320 --> 00:38:36,400
immediately following the last time that

1012
00:38:33,520 --> 00:38:39,250
I talked um we're gonna take a look at

1013
00:38:36,400 --> 00:38:41,440
that activity that I saw popped back up

1014
00:38:39,250 --> 00:38:43,270
in the morning so first thing I'm gonna

1015
00:38:41,440 --> 00:38:44,860
do you know I saw I was looking to

1016
00:38:43,270 --> 00:38:46,750
install util that Exe something to drop

1017
00:38:44,860 --> 00:38:48,970
the process chief for the activity and

1018
00:38:46,750 --> 00:38:51,820
sure enough I do see some child

1019
00:38:48,970 --> 00:38:52,120
processes from that binary and taking a

1020
00:38:51,820 --> 00:38:54,100
look

1021
00:38:52,120 --> 00:38:57,290
I see another scheduled task called

1022
00:38:54,100 --> 00:38:59,630
painful proxy being created

1023
00:38:57,290 --> 00:39:02,570
and calls that SSH to fpbs script if you

1024
00:38:59,630 --> 00:39:04,490
remember earlier this morning we had

1025
00:39:02,570 --> 00:39:08,750
looked at it and made a tunnel out to

1026
00:39:04,490 --> 00:39:11,479
that remote IP I see a couple of uses of

1027
00:39:08,750 --> 00:39:14,600
net here trying to mount the c drive to

1028
00:39:11,480 --> 00:39:18,440
a remote dev server you can see the IP

1029
00:39:14,600 --> 00:39:21,290
address here and then here it looks like

1030
00:39:18,440 --> 00:39:24,320
the attacker was successful after a few

1031
00:39:21,290 --> 00:39:26,870
attempts at mounting that now but then

1032
00:39:24,320 --> 00:39:29,450
there's no activity other than just that

1033
00:39:26,870 --> 00:39:32,060
little bit and if I take a look at the

1034
00:39:29,450 --> 00:39:34,910
start date start timestamp in the end

1035
00:39:32,060 --> 00:39:37,279
timestamp of all this activity it looks

1036
00:39:34,910 --> 00:39:39,140
here that it's all took place over two

1037
00:39:37,280 --> 00:39:42,060
hour period like I said this does not

1038
00:39:39,140 --> 00:39:44,890
happen at the speed of light you know

1039
00:39:42,060 --> 00:39:46,340
[Music]

1040
00:39:44,890 --> 00:39:48,640
interrupt you

1041
00:39:46,340 --> 00:39:53,060
hopefully not when your name our mode

1042
00:39:48,640 --> 00:39:54,770
and but I do remember that he created

1043
00:39:53,060 --> 00:39:56,180
that scheduled task for that SSH script

1044
00:39:54,770 --> 00:39:58,400
so it's a reason to believe he took the

1045
00:39:56,180 --> 00:40:00,200
time to set that up maybe he did that

1046
00:39:58,400 --> 00:40:02,240
for a better tool set he was having

1047
00:40:00,200 --> 00:40:03,439
trouble with his initial shell so I'm

1048
00:40:02,240 --> 00:40:06,649
gonna pivot out and I'm gonna take a

1049
00:40:03,440 --> 00:40:08,690
look for any additional logs that may be

1050
00:40:06,650 --> 00:40:10,970
interacting with that sage scripting we

1051
00:40:08,690 --> 00:40:12,950
can see that W script shell you know

1052
00:40:10,970 --> 00:40:16,580
using that VBS script I'm gonna draw up

1053
00:40:12,950 --> 00:40:17,419
that process tree now I do see over on

1054
00:40:16,580 --> 00:40:19,610
the right

1055
00:40:17,420 --> 00:40:22,010
in really small text right hand corner

1056
00:40:19,610 --> 00:40:25,490
you know we have network activity to a

1057
00:40:22,010 --> 00:40:27,200
remote IP over port 22 as expected but I

1058
00:40:25,490 --> 00:40:35,479
also see my first sign of lateral

1059
00:40:27,200 --> 00:40:37,490
movement and this IP drive - and it's

1060
00:40:35,480 --> 00:40:40,220
over three three eight nine so my

1061
00:40:37,490 --> 00:40:45,259
assumption here is that he is using RDP

1062
00:40:40,220 --> 00:40:47,299
to server so I'm gonna hop over and I'm

1063
00:40:45,260 --> 00:40:49,490
going to take a look for any of these

1064
00:40:47,300 --> 00:40:52,250
indicators I got IP addresses file names

1065
00:40:49,490 --> 00:40:55,129
file hashes I've got binary names

1066
00:40:52,250 --> 00:40:57,410
I've got activity such as install

1067
00:40:55,130 --> 00:40:58,820
calling uninstall command I'm gonna run

1068
00:40:57,410 --> 00:41:00,410
all through all these things that I've

1069
00:40:58,820 --> 00:41:02,450
gathered up against that dev server see

1070
00:41:00,410 --> 00:41:04,879
if I see the attacker acting over there

1071
00:41:02,450 --> 00:41:06,808
and sure enough I do see the install

1072
00:41:04,880 --> 00:41:10,679
utility XE

1073
00:41:06,809 --> 00:41:12,179
evite exe running on the dead server so

1074
00:41:10,679 --> 00:41:15,749
let's draw that process tree up and take

1075
00:41:12,179 --> 00:41:19,349
a look at what we got and I do see that

1076
00:41:15,749 --> 00:41:22,109
he is attempting to use that same binary

1077
00:41:19,349 --> 00:41:24,779
in order to you know call out I assume

1078
00:41:22,109 --> 00:41:28,078
to his infrastructure but I don't see

1079
00:41:24,779 --> 00:41:30,689
any network actually being created looks

1080
00:41:28,079 --> 00:41:34,679
like for some reason you know he's

1081
00:41:30,689 --> 00:41:36,178
trying about failing so not sure why I

1082
00:41:34,679 --> 00:41:39,630
feel like I'm catching up I feel like

1083
00:41:36,179 --> 00:41:43,140
since I see him reusing you know his

1084
00:41:39,630 --> 00:41:43,890
TPP's I'm going to you know try to make

1085
00:41:43,140 --> 00:41:53,939
my move

1086
00:41:43,890 --> 00:41:55,919
see all right basically we're coming

1087
00:41:53,939 --> 00:41:57,779
back to you know I lost my show that

1088
00:41:55,919 --> 00:41:59,219
night I got up the next morning he's

1089
00:41:57,779 --> 00:42:01,169
already triaged a little past this part

1090
00:41:59,219 --> 00:42:03,689
because you know he's running a little

1091
00:42:01,169 --> 00:42:05,879
ahead of our time so let's go back and

1092
00:42:03,689 --> 00:42:08,219
see what was going on well that morning

1093
00:42:05,880 --> 00:42:09,749
like clockwork I got my shell back you

1094
00:42:08,219 --> 00:42:12,089
know the Wednesday night I had sent out

1095
00:42:09,749 --> 00:42:13,709
the fish I was trying to get access so I

1096
00:42:12,089 --> 00:42:15,679
want to open it I was in their laptop

1097
00:42:13,709 --> 00:42:18,629
for a couple hours it was at home nope

1098
00:42:15,679 --> 00:42:20,099
Wow Thursday morning they go in I get

1099
00:42:18,630 --> 00:42:21,869
access to the internal company Network

1100
00:42:20,099 --> 00:42:23,909
you see the internal IP changed there a

1101
00:42:21,869 --> 00:42:25,259
little bit and so now I'm running back

1102
00:42:23,909 --> 00:42:27,900
on their laptop because my scheduled

1103
00:42:25,259 --> 00:42:29,159
tasks called back so things to check

1104
00:42:27,900 --> 00:42:30,539
I've already done a lot of my host space

1105
00:42:29,159 --> 00:42:32,489
reconnaissance there's not much more I'm

1106
00:42:30,539 --> 00:42:34,140
gonna do there but I want to get off of

1107
00:42:32,489 --> 00:42:35,819
this host like I said I'm in a hot like

1108
00:42:34,140 --> 00:42:37,949
hot seat right here and I just need to

1109
00:42:35,819 --> 00:42:39,808
get out of it let's try and get on to

1110
00:42:37,949 --> 00:42:41,159
another host in the network preferably a

1111
00:42:39,809 --> 00:42:42,599
server something that's gonna stay up

1112
00:42:41,159 --> 00:42:45,239
you know it's not subject to employee

1113
00:42:42,599 --> 00:42:46,739
schedules you know a server that might

1114
00:42:45,239 --> 00:42:48,900
be commonly calling back to the internet

1115
00:42:46,739 --> 00:42:50,489
but can would be preferable you know you

1116
00:42:48,900 --> 00:42:51,829
want to blend in with traffic but we're

1117
00:42:50,489 --> 00:42:53,759
gonna take what we are given and so

1118
00:42:51,829 --> 00:42:55,709
start looking for active network

1119
00:42:53,759 --> 00:42:57,689
connections at this laptop might make to

1120
00:42:55,709 --> 00:42:59,279
the network we're gonna do some domain

1121
00:42:57,689 --> 00:43:01,049
recon try and find fully qualified

1122
00:42:59,279 --> 00:43:02,519
domain names understand what servers are

1123
00:43:01,049 --> 00:43:05,390
out there because admins love the name

1124
00:43:02,519 --> 00:43:08,158
their internal servers like SharePoint

1125
00:43:05,390 --> 00:43:10,558
buzzing calm or someone kernel network

1126
00:43:08,159 --> 00:43:12,839
you just go off of domain names to try

1127
00:43:10,559 --> 00:43:15,119
and find that I love password manager

1128
00:43:12,839 --> 00:43:16,558
buzzing calm things like that just helps

1129
00:43:15,119 --> 00:43:17,130
me out as an attacker makes my life

1130
00:43:16,559 --> 00:43:19,140
easier

1131
00:43:17,130 --> 00:43:20,160
go search for sensitive documents on any

1132
00:43:19,140 --> 00:43:23,098
shares that were connected to

1133
00:43:20,160 --> 00:43:23,910
you look for things that might be run by

1134
00:43:23,099 --> 00:43:25,650
another server

1135
00:43:23,910 --> 00:43:27,899
sometimes there's you know scripts I

1136
00:43:25,650 --> 00:43:29,849
like it run by servers that user could

1137
00:43:27,900 --> 00:43:31,460
have write access to I'm gonna look to

1138
00:43:29,849 --> 00:43:34,440
see if there's any passwords stored and

1139
00:43:31,460 --> 00:43:36,180
preferences you know store it out there

1140
00:43:34,440 --> 00:43:37,319
no windows environment and then service

1141
00:43:36,180 --> 00:43:39,180
principal name see if I can get their

1142
00:43:37,319 --> 00:43:41,308
hashes through Kerberos sting techniques

1143
00:43:39,180 --> 00:43:43,049
and then try and crack those hashes but

1144
00:43:41,309 --> 00:43:44,819
those are some steps we're not gonna go

1145
00:43:43,049 --> 00:43:47,430
through them all of them but some things

1146
00:43:44,819 --> 00:43:48,808
I would do so one thing we came across

1147
00:43:47,430 --> 00:43:51,868
that was interesting here in our single

1148
00:43:48,809 --> 00:43:54,480
attack chain is that somerville t he was

1149
00:43:51,869 --> 00:43:57,990
a member of the Bezeq vs is a one group

1150
00:43:54,480 --> 00:44:00,539
very common to see companies put their

1151
00:43:57,990 --> 00:44:02,609
global group memberships pretty much the

1152
00:44:00,539 --> 00:44:03,750
same as a server name that they're

1153
00:44:02,609 --> 00:44:04,799
saying this user has access to

1154
00:44:03,750 --> 00:44:06,569
you know principle of least privilege

1155
00:44:04,799 --> 00:44:07,950
obviously you don't want every user to

1156
00:44:06,569 --> 00:44:09,839
have admin to every server or

1157
00:44:07,950 --> 00:44:15,509
workstation or access to him so you

1158
00:44:09,839 --> 00:44:19,770
signed them groups and you assign them

1159
00:44:15,510 --> 00:44:21,089
groups but with those groups they you

1160
00:44:19,770 --> 00:44:22,380
know probably have access to it and as

1161
00:44:21,089 --> 00:44:24,089
an attacker I'm gonna look at it and go

1162
00:44:22,380 --> 00:44:25,680
perfect that's a good group if I can

1163
00:44:24,089 --> 00:44:27,660
find a server that correlates to it and

1164
00:44:25,680 --> 00:44:31,500
sure enough in my domain name recon I

1165
00:44:27,660 --> 00:44:34,170
found out vs is oh one calm I have a

1166
00:44:31,500 --> 00:44:37,470
domain group this users a part of and a

1167
00:44:34,170 --> 00:44:38,880
server that matches that name and you

1168
00:44:37,470 --> 00:44:40,709
know this is our hypothetical situation

1169
00:44:38,880 --> 00:44:43,049
but this is something that happens

1170
00:44:40,710 --> 00:44:44,880
pretty often on our real world

1171
00:44:43,049 --> 00:44:48,029
engagements so not just blowing smoke

1172
00:44:44,880 --> 00:44:49,559
here to make an easy attack chain so

1173
00:44:48,029 --> 00:44:51,029
once we have that I want to pivot to it

1174
00:44:49,559 --> 00:44:53,460
I'm gonna guess this user has access to

1175
00:44:51,029 --> 00:44:55,829
it but right now all's I can do is I'm

1176
00:44:53,460 --> 00:44:57,900
running commands through a shell that's

1177
00:44:55,829 --> 00:44:59,670
basically using HTTP and HTTPS there's

1178
00:44:57,900 --> 00:45:01,200
no persistent connection here it's only

1179
00:44:59,670 --> 00:45:03,510
connecting back out to me every 30

1180
00:45:01,200 --> 00:45:05,549
seconds calling back to run a command

1181
00:45:03,510 --> 00:45:07,230
for me and then giving me the output so

1182
00:45:05,549 --> 00:45:10,140
it's not like I can RDP it's not like I

1183
00:45:07,230 --> 00:45:17,569
can SSH into the server so instead I'm

1184
00:45:10,140 --> 00:45:17,569
gonna try this is good

1185
00:45:17,780 --> 00:45:24,980
so I'm gonna try and use SSH dot exe

1186
00:45:22,190 --> 00:45:26,810
Microsoft signed binary because OpenSSH

1187
00:45:24,980 --> 00:45:28,700
project they were trying to import SSH

1188
00:45:26,810 --> 00:45:30,380
into Windows a lot of you probably on

1189
00:45:28,700 --> 00:45:32,120
Windows 10 if you guys use SSH now on

1190
00:45:30,380 --> 00:45:34,100
Windows and all of its native and

1191
00:45:32,120 --> 00:45:36,410
everyone's Windows 10 deployment did

1192
00:45:34,100 --> 00:45:37,880
anyone know ssh is now native to the

1193
00:45:36,410 --> 00:45:40,279
Windows 10 deployment there on the whate

1194
00:45:37,880 --> 00:45:41,930
latest patches it's awesome we wrote

1195
00:45:40,280 --> 00:45:43,970
this talk right before that was possible

1196
00:45:41,930 --> 00:45:45,500
so I have to drop SSH Exe to disk but

1197
00:45:43,970 --> 00:45:47,390
with my luck it's you know still

1198
00:45:45,500 --> 00:45:49,730
Microsoft sign binary because they were

1199
00:45:47,390 --> 00:45:51,980
working on it and dev at that time and

1200
00:45:49,730 --> 00:45:55,550
what I'm gonna do is from the laptop I'm

1201
00:45:51,980 --> 00:45:58,340
gonna do a reverse epidemics oxide proxy

1202
00:45:55,550 --> 00:45:59,930
out to a jump box in the internet I have

1203
00:45:58,340 --> 00:46:01,910
a jump box this user can get into let's

1204
00:45:59,930 --> 00:46:03,290
restricted and so in the laptop calls

1205
00:46:01,910 --> 00:46:05,029
out to it what's gonna happen is it's

1206
00:46:03,290 --> 00:46:08,300
gonna create a tunnel that's over port

1207
00:46:05,030 --> 00:46:10,490
94 it goes out over to to airport 22 ssh

1208
00:46:08,300 --> 00:46:12,260
to my server opens up this tunnel and

1209
00:46:10,490 --> 00:46:14,660
opens up a listening interface on my

1210
00:46:12,260 --> 00:46:16,400
server that's port 9050 and anything

1211
00:46:14,660 --> 00:46:18,379
that goes into port 9050 on my server

1212
00:46:16,400 --> 00:46:20,540
gets tunneled over that ssh connection

1213
00:46:18,380 --> 00:46:22,550
into the laptop and then off the laptop

1214
00:46:20,540 --> 00:46:26,210
into the network so it's a reverse

1215
00:46:22,550 --> 00:46:27,950
socks5 proxy chain using ssh and then it

1216
00:46:26,210 --> 00:46:29,480
from my attacker box I'm going to SSH

1217
00:46:27,950 --> 00:46:32,000
into that jump box forwarding all

1218
00:46:29,480 --> 00:46:33,830
traffic for my attacker box to port 1950

1219
00:46:32,000 --> 00:46:35,120
on the junk box which then goes into the

1220
00:46:33,830 --> 00:46:38,380
network and therefore I have a full

1221
00:46:35,120 --> 00:46:40,670
tunnel to pivot into their network so

1222
00:46:38,380 --> 00:46:43,940
first I gotta get that to run so I'm

1223
00:46:40,670 --> 00:46:45,620
gonna upload our OpenSSH exe I'm gonna

1224
00:46:43,940 --> 00:46:49,490
unzip my package that I dropped there

1225
00:46:45,620 --> 00:46:51,740
once I unzip it I need to modify the

1226
00:46:49,490 --> 00:46:53,959
keys I used SSH keys from the laptop to

1227
00:46:51,740 --> 00:46:56,000
jump out to my bastion host obviously

1228
00:46:53,960 --> 00:46:58,160
I'm putting keys on his laptop so the

1229
00:46:56,000 --> 00:46:59,510
host here is a burner box the blue team

1230
00:46:58,160 --> 00:47:01,250
finds them we'll be able to use them to

1231
00:46:59,510 --> 00:47:02,720
get to the server but just to annoying

1232
00:47:01,250 --> 00:47:03,860
my to factor did as well so it's like

1233
00:47:02,720 --> 00:47:06,169
and they can get to them but it's not

1234
00:47:03,860 --> 00:47:07,790
much it's gonna happen but on top of

1235
00:47:06,170 --> 00:47:09,710
that the user account is fully

1236
00:47:07,790 --> 00:47:11,330
restricted it doesn't get a shell I'm

1237
00:47:09,710 --> 00:47:13,820
not naive people can break out of those

1238
00:47:11,330 --> 00:47:15,200
user or those user restrictions but the

1239
00:47:13,820 --> 00:47:16,610
server if they get into it I'm not

1240
00:47:15,200 --> 00:47:20,270
terribly concerned because it's a

1241
00:47:16,610 --> 00:47:22,190
complete burner box so from my

1242
00:47:20,270 --> 00:47:23,840
perspective it gives me my jump back and

1243
00:47:22,190 --> 00:47:25,190
I have to change the keys here though

1244
00:47:23,840 --> 00:47:27,140
change there

1245
00:47:25,190 --> 00:47:30,290
permissions so that the keys will work

1246
00:47:27,140 --> 00:47:32,870
with SSH keys and here with SSH and then

1247
00:47:30,290 --> 00:47:34,279
I'm gonna run it and I'm gonna use a VB

1248
00:47:32,870 --> 00:47:38,120
script to run it so that it hides the

1249
00:47:34,280 --> 00:47:39,590
black prompt window and then I'm gonna

1250
00:47:38,120 --> 00:47:41,150
execute it from a schedule task just to

1251
00:47:39,590 --> 00:47:44,060
detach it from the current process that

1252
00:47:41,150 --> 00:47:46,430
I'm running it under so it's not

1253
00:47:44,060 --> 00:47:49,700
directly running under the install utila

1254
00:47:46,430 --> 00:47:50,990
program and after that I can use proxy

1255
00:47:49,700 --> 00:47:52,549
chains do you go ahead and pivot into

1256
00:47:50,990 --> 00:47:54,649
the network so I was proxy chains with

1257
00:47:52,550 --> 00:47:56,360
enum for Linux just to kind of do some

1258
00:47:54,650 --> 00:47:57,980
domain reconnaissance to verify that it

1259
00:47:56,360 --> 00:47:59,990
works and get back a list of user

1260
00:47:57,980 --> 00:48:02,060
accounts a list of domain information

1261
00:47:59,990 --> 00:48:03,859
that's going straight into their domain

1262
00:48:02,060 --> 00:48:05,420
controller the 10:30 zero sixteen is

1263
00:48:03,860 --> 00:48:06,770
their domain controller and my proxy

1264
00:48:05,420 --> 00:48:08,870
chains configuration is set up on my

1265
00:48:06,770 --> 00:48:10,370
attacker box to forward all that traffic

1266
00:48:08,870 --> 00:48:13,700
through the proxy tunnel we established

1267
00:48:10,370 --> 00:48:15,380
and then after that we can use RDP with

1268
00:48:13,700 --> 00:48:16,730
Roxy chains so now we're already peeing

1269
00:48:15,380 --> 00:48:19,400
into that server that we thought we had

1270
00:48:16,730 --> 00:48:20,720
access to for that user account based on

1271
00:48:19,400 --> 00:48:22,910
you know then being a part of that group

1272
00:48:20,720 --> 00:48:26,060
sure enough we do we have access to the

1273
00:48:22,910 --> 00:48:27,529
server and we have an RDP session with

1274
00:48:26,060 --> 00:48:31,100
our RDP session open I need to get

1275
00:48:27,530 --> 00:48:33,860
scripts onto that server so one thing

1276
00:48:31,100 --> 00:48:35,839
I'm gonna do here is try and use SMB

1277
00:48:33,860 --> 00:48:37,460
client through my initial shell or

1278
00:48:35,840 --> 00:48:39,020
through proxy chains to connect to it

1279
00:48:37,460 --> 00:48:40,970
and mount the share and then I'm gonna

1280
00:48:39,020 --> 00:48:42,980
drop my payload script that had been

1281
00:48:40,970 --> 00:48:44,450
running before on the workstation over

1282
00:48:42,980 --> 00:48:46,100
on that server so I can run it and get a

1283
00:48:44,450 --> 00:48:47,120
connection out from that server so I'm

1284
00:48:46,100 --> 00:48:49,610
not pivoting through this workstation

1285
00:48:47,120 --> 00:48:51,710
anymore so I start setting that up and

1286
00:48:49,610 --> 00:48:53,540
then I use crack math math exec just to

1287
00:48:51,710 --> 00:48:55,100
execute it instead that calling it

1288
00:48:53,540 --> 00:48:56,420
through my RDP session so that hopefully

1289
00:48:55,100 --> 00:48:59,180
it stays open even when you know I

1290
00:48:56,420 --> 00:49:01,070
closed my RDP session and I come up with

1291
00:48:59,180 --> 00:49:02,899
an error some reason my payload doesn't

1292
00:49:01,070 --> 00:49:04,130
want to run on this 2012 server probably

1293
00:49:02,900 --> 00:49:05,540
one of those OPSEC fails that's why you

1294
00:49:04,130 --> 00:49:06,740
always kind of clone your environment

1295
00:49:05,540 --> 00:49:08,360
out when you're attacking it you don't

1296
00:49:06,740 --> 00:49:09,620
rush through it you make sure you have a

1297
00:49:08,360 --> 00:49:11,900
clone of who you're attacking and you

1298
00:49:09,620 --> 00:49:13,370
test all your tools out there wasn't

1299
00:49:11,900 --> 00:49:14,630
tested here there was some error with my

1300
00:49:13,370 --> 00:49:17,170
payload just doesn't like the dotnet

1301
00:49:14,630 --> 00:49:19,460
runtime version they've got who knows

1302
00:49:17,170 --> 00:49:21,170
and so before we spend our time triaging

1303
00:49:19,460 --> 00:49:23,960
i'm in panic mode now has an attacker

1304
00:49:21,170 --> 00:49:25,670
things are not quite going my way I need

1305
00:49:23,960 --> 00:49:27,230
to go a little quick so I'm just gonna

1306
00:49:25,670 --> 00:49:29,440
try and get credentials maybe hold some

1307
00:49:27,230 --> 00:49:32,060
persistence and get onto other servers

1308
00:49:29,440 --> 00:49:33,890
as an attacker once I get rushed I'm

1309
00:49:32,060 --> 00:49:35,270
gonna start making quicker mistake sorry

1310
00:49:33,890 --> 00:49:35,870
more mistakes you know you try to move

1311
00:49:35,270 --> 00:49:38,360
quick

1312
00:49:35,870 --> 00:49:39,529
you're not to silent so one of the

1313
00:49:38,360 --> 00:49:42,380
things I do here is I'm gonna try and

1314
00:49:39,530 --> 00:49:44,180
dump LSA I'm gonna dump the Sam and get

1315
00:49:42,380 --> 00:49:47,360
the local admin creds off of that

1316
00:49:44,180 --> 00:49:48,589
machine and so while Aaron has been

1317
00:49:47,360 --> 00:49:50,510
playing around the server I think I

1318
00:49:48,590 --> 00:49:53,150
should kick him out before he gets too

1319
00:49:50,510 --> 00:49:59,750
far into our network so immediately

1320
00:49:53,150 --> 00:50:01,310
following the last time I got confused

1321
00:49:59,750 --> 00:50:02,870
picking up where I left off I'm gonna

1322
00:50:01,310 --> 00:50:07,130
try to get him out of the network here

1323
00:50:02,870 --> 00:50:09,290
so so I got a bunch of different

1324
00:50:07,130 --> 00:50:11,900
indicators IP addresses binary names

1325
00:50:09,290 --> 00:50:13,520
everything I know kind of how he's been

1326
00:50:11,900 --> 00:50:15,680
acting I've seen him used to same

1327
00:50:13,520 --> 00:50:17,440
techniques and multiple boxes in the

1328
00:50:15,680 --> 00:50:19,700
network so I'm gonna take those

1329
00:50:17,440 --> 00:50:21,470
indicators and in the back out I'm gonna

1330
00:50:19,700 --> 00:50:23,029
filter out the computers I know he's

1331
00:50:21,470 --> 00:50:24,919
already compromised and then you send

1332
00:50:23,030 --> 00:50:26,870
these through my logs and see if I see

1333
00:50:24,920 --> 00:50:29,240
any of this activity happening anywhere

1334
00:50:26,870 --> 00:50:31,250
else in my network so going to the ER

1335
00:50:29,240 --> 00:50:33,470
looking for activity that IP address I

1336
00:50:31,250 --> 00:50:35,600
see none so it looks like all that

1337
00:50:33,470 --> 00:50:37,430
activity to and from the attacker and my

1338
00:50:35,600 --> 00:50:39,410
network is going through that one

1339
00:50:37,430 --> 00:50:41,330
workstation that I know is compromised

1340
00:50:39,410 --> 00:50:43,009
just to confirm that make sure you

1341
00:50:41,330 --> 00:50:45,020
didn't pivot out too you know unmanaged

1342
00:50:43,010 --> 00:50:47,300
assets like T device or a security

1343
00:50:45,020 --> 00:50:49,850
camera or you know I'm sure all of your

1344
00:50:47,300 --> 00:50:53,960
endpoint teens you know hit 100% on your

1345
00:50:49,850 --> 00:50:57,170
endpoint agents all the time but just in

1346
00:50:53,960 --> 00:50:59,450
case they missed one or two I can go

1347
00:50:57,170 --> 00:51:02,450
through my firewall logs ever go into

1348
00:50:59,450 --> 00:51:04,399
net flow and I can do the same thing and

1349
00:51:02,450 --> 00:51:06,589
here I can see him a firewall no

1350
00:51:04,400 --> 00:51:09,200
activity to that IP address from any

1351
00:51:06,590 --> 00:51:10,940
other devices I can also take a look at

1352
00:51:09,200 --> 00:51:13,819
some of the other protocols he was using

1353
00:51:10,940 --> 00:51:17,060
I know he used SSH I know that he was

1354
00:51:13,820 --> 00:51:18,680
going to use using RDP so I'm going to

1355
00:51:17,060 --> 00:51:20,390
take a look for any RDP activity from

1356
00:51:18,680 --> 00:51:22,910
that compromised workstation to any

1357
00:51:20,390 --> 00:51:25,160
other device and I do only see activity

1358
00:51:22,910 --> 00:51:27,259
to that server so I feel like the

1359
00:51:25,160 --> 00:51:29,750
attacker it has not gotten through far

1360
00:51:27,260 --> 00:51:31,550
he's you know communicating through that

1361
00:51:29,750 --> 00:51:33,590
workstation and it looks like he's

1362
00:51:31,550 --> 00:51:35,720
pivoted out to that dev server but

1363
00:51:33,590 --> 00:51:38,960
that's about it so what am I gonna do

1364
00:51:35,720 --> 00:51:40,399
well most EDR is come with a fancy dancy

1365
00:51:38,960 --> 00:51:41,900
little network contain you can click a

1366
00:51:40,400 --> 00:51:43,490
button and you can kill all network

1367
00:51:41,900 --> 00:51:45,860
activity on a device that has an

1368
00:51:43,490 --> 00:51:46,808
endpoint mine does that so I'm going to

1369
00:51:45,860 --> 00:51:48,309
hit that networking

1370
00:51:46,809 --> 00:51:49,719
button this is going to kill all

1371
00:51:48,309 --> 00:51:50,469
communication to and from that

1372
00:51:49,719 --> 00:51:53,769
workstation

1373
00:51:50,469 --> 00:51:55,419
I accept from my EDR environment so I'll

1374
00:51:53,769 --> 00:51:56,890
continue to get logs you know I'll still

1375
00:51:55,419 --> 00:52:00,249
have that remote shell to the

1376
00:51:56,890 --> 00:52:03,429
workstation next I can blacklist them

1377
00:52:00,249 --> 00:52:07,029
the IP address full of domain names into

1378
00:52:03,429 --> 00:52:09,369
our firewall and I want to make sure

1379
00:52:07,029 --> 00:52:11,979
that I do all this simultaneously as

1380
00:52:09,369 --> 00:52:14,799
possible what I don't want to do is be

1381
00:52:11,979 --> 00:52:17,288
wrong you know or move slow maybe just

1382
00:52:14,799 --> 00:52:19,809
kill that server the attacker realizes

1383
00:52:17,289 --> 00:52:21,759
that you know oh hey they're on to me

1384
00:52:19,809 --> 00:52:27,489
and he blows up cryptolocker on the

1385
00:52:21,759 --> 00:52:29,049
workstation so so after I have finished

1386
00:52:27,489 --> 00:52:31,419
kicking the attacker out of the network

1387
00:52:29,049 --> 00:52:35,079
now I have a little more time to breathe

1388
00:52:31,419 --> 00:52:37,749
it maybe you know a little more time to

1389
00:52:35,079 --> 00:52:40,900
breathe and go into that post incident

1390
00:52:37,749 --> 00:52:43,238
analysis now we were going to go and you

1391
00:52:40,900 --> 00:52:45,189
know it was just as long as the talk has

1392
00:52:43,239 --> 00:52:48,039
been so far on this we can call it

1393
00:52:45,189 --> 00:52:50,709
consolidated down this slide but you see

1394
00:52:48,039 --> 00:52:52,329
here that if I were to do this post

1395
00:52:50,709 --> 00:52:54,788
instant analysis the forensics on the

1396
00:52:52,329 --> 00:52:56,319
device the logs that it gives me an ER

1397
00:52:54,789 --> 00:53:00,099
is very helpful for this and you can see

1398
00:52:56,319 --> 00:53:03,939
the attacker trying to dump Sam and do a

1399
00:53:00,099 --> 00:53:05,259
hash dump on the dead server so that

1400
00:53:03,939 --> 00:53:06,759
would have been cleaned up and I can

1401
00:53:05,259 --> 00:53:08,469
take all those credentials assume

1402
00:53:06,759 --> 00:53:14,079
they're compromised and get all that

1403
00:53:08,469 --> 00:53:15,849
cleaned up we'll so recap recap from the

1404
00:53:14,079 --> 00:53:17,319
red team here you know obviously some

1405
00:53:15,849 --> 00:53:20,619
lesson learned from a red team

1406
00:53:17,319 --> 00:53:21,609
perspective one you know test your

1407
00:53:20,619 --> 00:53:23,199
payloads and all your environments

1408
00:53:21,609 --> 00:53:24,969
before you run them but the second one

1409
00:53:23,199 --> 00:53:26,529
there is maybe I should've been running

1410
00:53:24,969 --> 00:53:29,009
that payload on the server

1411
00:53:26,529 --> 00:53:31,659
I had already used it as my initial

1412
00:53:29,009 --> 00:53:33,309
payload to run on the workstation he's

1413
00:53:31,659 --> 00:53:34,689
obviously already caught it even if I'd

1414
00:53:33,309 --> 00:53:36,069
gotten it to run on that server and he

1415
00:53:34,689 --> 00:53:37,839
hadn't seen my lateral movement to that

1416
00:53:36,069 --> 00:53:39,249
server had he just taken that payload

1417
00:53:37,839 --> 00:53:40,749
hash and checked it in the environment

1418
00:53:39,249 --> 00:53:43,209
to see if anywhere else had executed or

1419
00:53:40,749 --> 00:53:45,819
installed and had that there he'd find

1420
00:53:43,209 --> 00:53:47,379
the same signatures so as a red team a

1421
00:53:45,819 --> 00:53:49,029
good thing to do is once you've landed

1422
00:53:47,380 --> 00:53:50,529
your beachhead your stage one payloads

1423
00:53:49,029 --> 00:53:51,880
you get into a workstation

1424
00:53:50,529 --> 00:53:53,169
those are burnable there you're

1425
00:53:51,880 --> 00:53:54,999
expecting those to be burned you're

1426
00:53:53,169 --> 00:53:56,589
constantly working on new ones but

1427
00:53:54,999 --> 00:53:58,640
you're once you're starting to move

1428
00:53:56,589 --> 00:54:01,500
laterally and you're establish

1429
00:53:58,640 --> 00:54:03,118
and you're slow callbacks and your

1430
00:54:01,500 --> 00:54:04,080
persistence as well you're gonna want to

1431
00:54:03,119 --> 00:54:05,450
use a different payload for your

1432
00:54:04,080 --> 00:54:07,859
persistence when you get on that server

1433
00:54:05,450 --> 00:54:09,598
or that other workstation and that's

1434
00:54:07,859 --> 00:54:11,970
gonna call back with maybe a long pole

1435
00:54:09,599 --> 00:54:13,200
you can maybe use like a DNS type call

1436
00:54:11,970 --> 00:54:15,089
back so maybe you just check for a

1437
00:54:13,200 --> 00:54:17,700
command every hour to run in case you

1438
00:54:15,089 --> 00:54:19,170
lose your rat and then the next step is

1439
00:54:17,700 --> 00:54:22,109
you're going to install or establish a

1440
00:54:19,170 --> 00:54:23,940
rat toolkit on that server or host so

1441
00:54:22,109 --> 00:54:26,069
that you can use that in the future to

1442
00:54:23,940 --> 00:54:27,510
do more operations without having to

1443
00:54:26,070 --> 00:54:29,460
upload all these files to disk and get

1444
00:54:27,510 --> 00:54:31,680
really noisy but that needs to be really

1445
00:54:29,460 --> 00:54:33,119
flushed out toolkit and framework so

1446
00:54:31,680 --> 00:54:35,879
sometimes it's hard to work with

1447
00:54:33,119 --> 00:54:36,810
whatever is open source out there like

1448
00:54:35,880 --> 00:54:38,849
if you're just working with an empire

1449
00:54:36,810 --> 00:54:40,650
framework it's known the TTP's for how

1450
00:54:38,849 --> 00:54:42,240
that operates are known so having your

1451
00:54:40,650 --> 00:54:44,160
own custom toolkit as a red team can be

1452
00:54:42,240 --> 00:54:45,689
pretty helpful especially when you're

1453
00:54:44,160 --> 00:54:49,520
trying to keep like an offset

1454
00:54:45,690 --> 00:54:51,720
perspective so it doesn't all get burned

1455
00:54:49,520 --> 00:54:53,820
don't rush as the Red Team have

1456
00:54:51,720 --> 00:54:54,629
everything strategically planned out so

1457
00:54:53,820 --> 00:54:56,580
that you don't get in that situation

1458
00:54:54,630 --> 00:54:58,020
where you're trying to pivot and you're

1459
00:54:56,580 --> 00:55:02,609
frantically doing it and then you make

1460
00:54:58,020 --> 00:55:05,759
mistakes and get caught and for blue

1461
00:55:02,609 --> 00:55:09,450
team I think the biggest takeaway is

1462
00:55:05,760 --> 00:55:12,810
that you know all the bells and whistles

1463
00:55:09,450 --> 00:55:15,149
a fully tool environment just with the

1464
00:55:12,810 --> 00:55:18,859
you know implementation of one tool and

1465
00:55:15,150 --> 00:55:23,099
most EDR products are fairly easy to

1466
00:55:18,859 --> 00:55:25,560
implement you can do quite a bit so all

1467
00:55:23,099 --> 00:55:28,710
this was done pretty much with just the

1468
00:55:25,560 --> 00:55:30,750
EDR I did quickly take a look at net

1469
00:55:28,710 --> 00:55:33,119
flow and firewall just to confirm what

1470
00:55:30,750 --> 00:55:35,040
my EDR had told me I'm sure most of you

1471
00:55:33,119 --> 00:55:39,540
guys have firewall and hopefully

1472
00:55:35,040 --> 00:55:43,050
firewall logs uh-huh so yeah you don't

1473
00:55:39,540 --> 00:55:45,180
need you know you know millions of

1474
00:55:43,050 --> 00:55:46,440
dollars of investment in five years to

1475
00:55:45,180 --> 00:55:48,450
tool before you can do this activity

1476
00:55:46,440 --> 00:55:51,900
start it now see how versing your

1477
00:55:48,450 --> 00:55:55,049
environment also all the other IT teams

1478
00:55:51,900 --> 00:55:56,550
like they have a lot of tools that help

1479
00:55:55,050 --> 00:55:57,900
them your network team probably has a

1480
00:55:56,550 --> 00:55:59,910
net flow implementation and your

1481
00:55:57,900 --> 00:56:01,410
helpdesk team probably has the remote

1482
00:55:59,910 --> 00:56:03,868
assistance software like I mentioned

1483
00:56:01,410 --> 00:56:07,220
with the credential shell so other teams

1484
00:56:03,869 --> 00:56:08,520
tools are your team's tools too

1485
00:56:07,220 --> 00:56:11,230
hopefully

1486
00:56:08,520 --> 00:56:12,640
so maybe borrow them for

1487
00:56:11,230 --> 00:56:15,040
until you can stand up your own vid

1488
00:56:12,640 --> 00:56:16,420
structure also you can get a lot of

1489
00:56:15,040 --> 00:56:17,980
value from doing this even if you

1490
00:56:16,420 --> 00:56:20,770
fumbled through it just like two hours a

1491
00:56:17,980 --> 00:56:22,510
week you will learn a lot about your

1492
00:56:20,770 --> 00:56:23,800
environment you're gonna learn about

1493
00:56:22,510 --> 00:56:26,200
your norms you're going to learn about

1494
00:56:23,800 --> 00:56:28,270
your blind spots and it's going to help

1495
00:56:26,200 --> 00:56:38,399
you a better security organization even

1496
00:56:28,270 --> 00:56:40,960
if you actually don't find exercises

1497
00:56:38,400 --> 00:56:42,490
against your own organization you know

1498
00:56:40,960 --> 00:56:44,619
you don't want to stick to world's best

1499
00:56:42,490 --> 00:56:58,000
red teamer against a brand new hunter

1500
00:56:44,619 --> 00:57:00,670
right like it's usually they're gonna

1501
00:56:58,000 --> 00:57:02,770
find and then you can slowly and

1502
00:57:00,670 --> 00:57:05,109
incrementally increase the complexity of

1503
00:57:02,770 --> 00:57:09,390
those exercises as you get more practice

1504
00:57:05,109 --> 00:57:12,819
or you you get your infrastructure down

1505
00:57:09,390 --> 00:57:14,410
and then also you know if you think you

1506
00:57:12,820 --> 00:57:16,660
can benefit from this type of activity

1507
00:57:14,410 --> 00:57:18,460
really like man I really I came to spend

1508
00:57:16,660 --> 00:57:20,950
two hours a week doing this

1509
00:57:18,460 --> 00:57:22,630
most ER and the next-gen AV products

1510
00:57:20,950 --> 00:57:24,279
that generate these tips of logs they

1511
00:57:22,630 --> 00:57:26,410
have some type of managed hunting

1512
00:57:24,280 --> 00:57:28,300
service you know they're not perfect

1513
00:57:26,410 --> 00:57:30,910
they come with their flaws they come

1514
00:57:28,300 --> 00:57:32,560
with the delays but you can see here

1515
00:57:30,910 --> 00:57:34,810
this exact attack chain that we just

1516
00:57:32,560 --> 00:57:42,790
went through my ID our product caught

1517
00:57:34,810 --> 00:57:45,009
this a couple days you know they're the

1518
00:57:42,790 --> 00:57:48,069
humans in California somewhere you know

1519
00:57:45,010 --> 00:57:49,750
the sock monkeys they they they didn't

1520
00:57:48,069 --> 00:57:52,380
alert me to this so better late than

1521
00:57:49,750 --> 00:57:54,400
never and then I can go through that

1522
00:57:52,380 --> 00:57:57,970
response mode so these are some things

1523
00:57:54,400 --> 00:58:03,970
that you as a crutch until they're able

1524
00:57:57,970 --> 00:58:06,779
to actually do it yourself that's all

1525
00:58:03,970 --> 00:58:06,779
you have any questions

1526
00:58:07,370 --> 00:58:13,109
[Applause]

1527
00:58:34,989 --> 00:58:45,949
so during the talk let's see if we go

1528
00:58:41,919 --> 00:58:49,098
somewhere up here you'll see somewhere

1529
00:58:45,949 --> 00:58:54,799
between you know me trying to figure out

1530
00:58:49,099 --> 00:58:56,839
what this email is and me seen this

1531
00:58:54,799 --> 00:58:59,449
folder structure called pivot and then

1532
00:58:56,839 --> 00:59:02,839
definitely if that hasn't triggered my

1533
00:58:59,449 --> 00:59:05,029
hunting to IR transition seeing the

1534
00:59:02,839 --> 00:59:09,828
chrome-dome script so it's somewhere

1535
00:59:05,029 --> 00:59:11,719
between you know funny binary not

1536
00:59:09,829 --> 00:59:14,259
incident response we're still hunting or

1537
00:59:11,719 --> 00:59:17,869
doing that investigation okay

1538
00:59:14,259 --> 00:59:20,239
oddly named malicious folders called

1539
00:59:17,869 --> 00:59:23,419
pivot with a whole bunch of scripts in C

1540
00:59:20,239 --> 00:59:26,329
temp that might trigger IR for some

1541
00:59:23,419 --> 00:59:28,519
companies but if that doesn't trigger it

1542
00:59:26,329 --> 00:59:30,139
definitely the moment I open up the text

1543
00:59:28,519 --> 00:59:31,968
file in that folder well that will

1544
00:59:30,139 --> 00:59:33,709
trigger it so it's going to be a little

1545
00:59:31,969 --> 00:59:36,829
different between every organization

1546
00:59:33,709 --> 00:59:39,589
where that handoff is in my environment

1547
00:59:36,829 --> 00:59:41,749
the handoff is from me to me so I just

1548
00:59:39,589 --> 00:59:43,279
keep going on through I'm doing the

1549
00:59:41,749 --> 00:59:47,419
hunting and I've turned into into IR

1550
00:59:43,279 --> 00:59:50,209
mode so it's not rigid like I found

1551
00:59:47,419 --> 00:59:51,649
something have fun and that's how I

1552
00:59:50,209 --> 00:59:53,288
recommend it put your incident

1553
00:59:51,649 --> 00:59:56,689
responders whoever is looking

1554
00:59:53,289 --> 00:59:58,519
who would clean up an actual attack like

1555
00:59:56,689 --> 01:00:01,399
this in your environment have them start

1556
00:59:58,519 --> 01:00:02,868
that hunting if you don't have an HR

1557
01:00:01,399 --> 01:00:06,459
that's generate out to just give you a

1558
01:00:02,869 --> 01:00:06,459
new FTE to do this dedicated

1559
01:00:22,520 --> 01:00:28,880
yeah both of those actually so in a

1560
01:00:27,350 --> 01:00:30,560
perfect scenario when I have a lot more

1561
01:00:28,880 --> 01:00:31,640
time for recon I'm gonna try and figure

1562
01:00:30,560 --> 01:00:33,590
out what their environment looks like a

1563
01:00:31,640 --> 01:00:35,690
little bit more I have custom payloads

1564
01:00:33,590 --> 01:00:37,340
I've developed that basically run and

1565
01:00:35,690 --> 01:00:39,590
they their purpose isn't to get me a

1566
01:00:37,340 --> 01:00:40,970
shell is to do recon for me and exfil it

1567
01:00:39,590 --> 01:00:42,500
to a burner box and I don't care if

1568
01:00:40,970 --> 01:00:44,089
those get caught I'll be sending those

1569
01:00:42,500 --> 01:00:45,619
out I'll try and figure out fingerprint

1570
01:00:44,090 --> 01:00:48,140
their environment their AV products

1571
01:00:45,619 --> 01:00:50,090
their EDR everything I can possibly find

1572
01:00:48,140 --> 01:00:52,100
about it server versions they have out

1573
01:00:50,090 --> 01:00:53,810
there once all that's done and I have my

1574
01:00:52,100 --> 01:00:55,160
recon I might say dormant for a little

1575
01:00:53,810 --> 01:00:56,930
while while I build out in an

1576
01:00:55,160 --> 01:00:58,549
environment that matches theirs do all

1577
01:00:56,930 --> 01:01:00,379
my testing in it and then I'll be ready

1578
01:00:58,550 --> 01:01:02,930
to go and actually attack it but I also

1579
01:01:00,380 --> 01:01:05,750
do have a lab that has your generics

1580
01:01:02,930 --> 01:01:08,720
it's gonna have Windows Server 2012 and

1581
01:01:05,750 --> 01:01:10,730
2016 and then windows 7 and 10 things

1582
01:01:08,720 --> 01:01:13,250
like that so I'll still test in those as

1583
01:01:10,730 --> 01:01:15,470
well but you really do want to figure

1584
01:01:13,250 --> 01:01:17,540
out their environment by some means

1585
01:01:15,470 --> 01:01:19,189
beforehand and also if you do some recon

1586
01:01:17,540 --> 01:01:21,320
externally they have external servers

1587
01:01:19,190 --> 01:01:24,500
that you see and you see all of them are

1588
01:01:21,320 --> 01:01:26,090
like 2012 server then you know ok looks

1589
01:01:24,500 --> 01:01:28,220
like their environments about at this

1590
01:01:26,090 --> 01:01:30,430
level I should test most of my stuff in

1591
01:01:28,220 --> 01:01:30,430
that

1592
01:01:41,220 --> 01:01:43,450
[Applause]

