1
00:00:02,240 --> 00:00:03,919
hi everybody um

2
00:00:03,919 --> 00:00:05,920
this is the first time we present this

3
00:00:05,920 --> 00:00:08,320
talk in english so i hope you'll forgive

4
00:00:08,320 --> 00:00:11,280
us for any pronunciation mistakes

5
00:00:11,280 --> 00:00:14,240
this is the last talk so we try to be

6
00:00:14,240 --> 00:00:15,440
fast

7
00:00:15,440 --> 00:00:16,880
and

8
00:00:16,880 --> 00:00:19,119
before we start i would like to ask how

9
00:00:19,119 --> 00:00:21,840
many of you as have ever been involved

10
00:00:21,840 --> 00:00:23,920
in a real world red team or penetration

11
00:00:23,920 --> 00:00:26,080
test activity so if you can please raise

12
00:00:26,080 --> 00:00:27,359
your end

13
00:00:27,359 --> 00:00:29,359
okay

14
00:00:29,359 --> 00:00:32,000
okay good

15
00:00:32,000 --> 00:00:33,840
today we are here to offer you a talk

16
00:00:33,840 --> 00:00:35,360
which is a bit different from those

17
00:00:35,360 --> 00:00:36,399
before

18
00:00:36,399 --> 00:00:38,879
we know that many of you are university

19
00:00:38,879 --> 00:00:40,640
students and

20
00:00:40,640 --> 00:00:42,800
many of you and which are not university

21
00:00:42,800 --> 00:00:46,559
students may want to approach a i.t

22
00:00:46,559 --> 00:00:48,079
security field

23
00:00:48,079 --> 00:00:49,520
maybe after the achievement of your

24
00:00:49,520 --> 00:00:52,399
degree or as your career

25
00:00:52,399 --> 00:00:54,399
this is why today we choose to share

26
00:00:54,399 --> 00:00:56,480
with you one of our last penetration

27
00:00:56,480 --> 00:00:58,719
test activities

28
00:00:58,719 --> 00:01:00,640
and we hope that this can be inspiring

29
00:01:00,640 --> 00:01:02,160
for your studies

30
00:01:02,160 --> 00:01:04,239
and can be useful to understand better

31
00:01:04,239 --> 00:01:07,600
how penetration test activity works and

32
00:01:07,600 --> 00:01:09,520
how to bring together different pieces

33
00:01:09,520 --> 00:01:11,840
to follow a logical thread which can

34
00:01:11,840 --> 00:01:13,360
lead to exploit successfully

35
00:01:13,360 --> 00:01:14,960
misconfigurations

36
00:01:14,960 --> 00:01:16,960
and achieve greater results during your

37
00:01:16,960 --> 00:01:18,560
activity

38
00:01:18,560 --> 00:01:19,360
so

39
00:01:19,360 --> 00:01:22,000
if luca does not want to add

40
00:01:22,000 --> 00:01:23,200
more

41
00:01:23,200 --> 00:01:25,200
i'm going to start our talk by telling

42
00:01:25,200 --> 00:01:26,880
you something about us

43
00:01:26,880 --> 00:01:29,920
so we are i.t people a team of

44
00:01:29,920 --> 00:01:32,799
iit people which are definitely not

45
00:01:32,799 --> 00:01:34,560
photographers that you can see from this

46
00:01:34,560 --> 00:01:36,560
not properly beautiful photos

47
00:01:36,560 --> 00:01:39,040
and that's why we offer a variety of

48
00:01:39,040 --> 00:01:40,799
services mainly regarding the i.t

49
00:01:40,799 --> 00:01:43,280
security world such as consultancy

50
00:01:43,280 --> 00:01:44,799
penetration tests

51
00:01:44,799 --> 00:01:48,640
red teaming activities and so on

52
00:01:48,640 --> 00:01:51,520
our team is named inside out sec and is

53
00:01:51,520 --> 00:01:53,759
composed by me

54
00:01:53,759 --> 00:01:56,320
luca and our colleague you simone which

55
00:01:56,320 --> 00:01:58,960
unfortunately can

56
00:01:58,960 --> 00:02:00,640
can be here with us today due to some

57
00:02:00,640 --> 00:02:04,799
more commitments yet during these days

58
00:02:04,799 --> 00:02:07,040
okay

59
00:02:07,119 --> 00:02:09,520
now before we start

60
00:02:09,520 --> 00:02:11,920
all the tests we performed on

61
00:02:11,920 --> 00:02:14,000
customer we were performed on customer

62
00:02:14,000 --> 00:02:15,280
requests and

63
00:02:15,280 --> 00:02:17,440
were commissioned by our customer

64
00:02:17,440 --> 00:02:18,480
um

65
00:02:18,480 --> 00:02:20,000
and all the information we are going to

66
00:02:20,000 --> 00:02:21,920
disclose are disclosed

67
00:02:21,920 --> 00:02:24,239
with customers approval

68
00:02:24,239 --> 00:02:26,959
additionally we can't name explicitly

69
00:02:26,959 --> 00:02:30,080
our customers so we will

70
00:02:30,080 --> 00:02:31,200
call it

71
00:02:31,200 --> 00:02:31,920
yeah

72
00:02:31,920 --> 00:02:34,560
megacorp i know what you're thinking of

73
00:02:34,560 --> 00:02:36,959
if we can name a variable other than

74
00:02:36,959 --> 00:02:38,640
people one two three

75
00:02:38,640 --> 00:02:40,560
we could also find something better than

76
00:02:40,560 --> 00:02:42,080
megacorp but

77
00:02:42,080 --> 00:02:43,840
that's it

78
00:02:43,840 --> 00:02:45,040
uh okay

79
00:02:45,040 --> 00:02:47,840
this is the start of our journey what we

80
00:02:47,840 --> 00:02:52,000
are going to do is to follow the paths

81
00:02:52,000 --> 00:02:55,280
through our activity with you again

82
00:02:55,280 --> 00:02:57,440
and

83
00:02:58,239 --> 00:02:59,040
we

84
00:02:59,040 --> 00:03:01,760
will show you how we started thinking

85
00:03:01,760 --> 00:03:04,319
about the activity and how we learned

86
00:03:04,319 --> 00:03:07,040
bit by bit piece by piece and how the

87
00:03:07,040 --> 00:03:09,680
customer's infrastructure works

88
00:03:09,680 --> 00:03:12,400
first of all let's give you some context

89
00:03:12,400 --> 00:03:15,200
the activity was a penetration test on a

90
00:03:15,200 --> 00:03:17,599
vdi secrets environment

91
00:03:17,599 --> 00:03:19,840
and

92
00:03:20,080 --> 00:03:23,040
the activity period was of five days the

93
00:03:23,040 --> 00:03:25,920
original main goal was to find ways to

94
00:03:25,920 --> 00:03:28,080
exfiltrate sensitive information from

95
00:03:28,080 --> 00:03:30,799
the protected environment but

96
00:03:30,799 --> 00:03:33,120
we accomplished this goal in only one

97
00:03:33,120 --> 00:03:34,400
day of work

98
00:03:34,400 --> 00:03:36,799
so we asked our customer if we could go

99
00:03:36,799 --> 00:03:38,720
deeper with the activity and upgrade it

100
00:03:38,720 --> 00:03:39,760
from

101
00:03:39,760 --> 00:03:42,640
yeah try to find something uh some ways

102
00:03:42,640 --> 00:03:44,480
to expect information to a full

103
00:03:44,480 --> 00:03:46,959
translation test with a larger scope and

104
00:03:46,959 --> 00:03:49,360
this activity

105
00:03:49,360 --> 00:03:53,440
led us to very interesting results

106
00:03:54,000 --> 00:03:56,879
okay first of all this is a

107
00:03:56,879 --> 00:03:57,460
activity

108
00:03:57,460 --> 00:03:58,879
[Music]

109
00:03:58,879 --> 00:04:01,599
which is um

110
00:04:01,680 --> 00:04:03,040
which is a

111
00:04:03,040 --> 00:04:05,920
work which works like a black box

112
00:04:05,920 --> 00:04:09,120
activity and so we didn't know uh how

113
00:04:09,120 --> 00:04:10,959
customers infrastructure works so first

114
00:04:10,959 --> 00:04:14,000
of all we need to make some hypotheses

115
00:04:14,000 --> 00:04:15,840
about how it works

116
00:04:15,840 --> 00:04:16,639
and

117
00:04:16,639 --> 00:04:19,680
this is a very high level scheme we at

118
00:04:19,680 --> 00:04:21,519
this point of the activity we don't know

119
00:04:21,519 --> 00:04:23,280
anything so

120
00:04:23,280 --> 00:04:24,560
we are

121
00:04:24,560 --> 00:04:27,600
interpreting a customer's employee who

122
00:04:27,600 --> 00:04:29,280
wants to connect to at the citrix

123
00:04:29,280 --> 00:04:32,080
environment through our customers vpn to

124
00:04:32,080 --> 00:04:34,880
do their work and we can assume that

125
00:04:34,880 --> 00:04:35,919
from

126
00:04:35,919 --> 00:04:38,720
from citrix we can reach

127
00:04:38,720 --> 00:04:40,800
at least a part of our customer series

128
00:04:40,800 --> 00:04:42,400
so at least some segments

129
00:04:42,400 --> 00:04:44,000
and we can also

130
00:04:44,000 --> 00:04:47,360
assume that the access to internet is

131
00:04:47,360 --> 00:04:48,560
controlled

132
00:04:48,560 --> 00:04:51,440
by some kind of proxy which acts like a

133
00:04:51,440 --> 00:04:54,080
filter maybe we don't know

134
00:04:54,080 --> 00:04:57,120
the goal is to exfiltrate information or

135
00:04:57,120 --> 00:04:59,520
inject malicious files

136
00:04:59,520 --> 00:05:02,320
into our environment

137
00:05:02,320 --> 00:05:04,080
okay

138
00:05:04,080 --> 00:05:06,560
let's start

139
00:05:06,560 --> 00:05:08,800
this is the first thing we see when we

140
00:05:08,800 --> 00:05:12,240
connect to citrix vdi

141
00:05:12,240 --> 00:05:14,240
these are just a normal desktop as you

142
00:05:14,240 --> 00:05:17,280
can see and remember that our goal is to

143
00:05:17,280 --> 00:05:20,639
exfiltrate information but unfortunately

144
00:05:20,639 --> 00:05:21,680
the

145
00:05:21,680 --> 00:05:23,680
citrix functionalities which

146
00:05:23,680 --> 00:05:25,360
implement the file transfers are

147
00:05:25,360 --> 00:05:28,000
disabled but just from the desktop we

148
00:05:28,000 --> 00:05:30,479
can immediately see something which can

149
00:05:30,479 --> 00:05:31,440
be

150
00:05:31,440 --> 00:05:34,560
useful to accomplish our goal we see

151
00:05:34,560 --> 00:05:36,639
outlook and a couple of browsers and

152
00:05:36,639 --> 00:05:39,600
this sounds really like a perfect start

153
00:05:39,600 --> 00:05:41,840
another trivial but a good way to

154
00:05:41,840 --> 00:05:44,960
exfiltrate files is copy paste but

155
00:05:44,960 --> 00:05:46,400
here is

156
00:05:46,400 --> 00:05:50,720
mainly disabled as we can as we will see

157
00:05:50,720 --> 00:05:52,720
soon

158
00:05:52,720 --> 00:05:53,600
okay

159
00:05:53,600 --> 00:05:55,840
let's start trying out outlook

160
00:05:55,840 --> 00:05:58,080
if we manage to send a mail with

161
00:05:58,080 --> 00:06:00,319
attachments we can trivially attach

162
00:06:00,319 --> 00:06:01,280
files

163
00:06:01,280 --> 00:06:03,039
into an email and send it to another

164
00:06:03,039 --> 00:06:05,600
controlled by us

165
00:06:05,600 --> 00:06:07,120
as you can see here this worked out

166
00:06:07,120 --> 00:06:09,440
quite well we used tempmail.org to

167
00:06:09,440 --> 00:06:11,199
obtain a temporary email address and

168
00:06:11,199 --> 00:06:13,120
then we use the account configured

169
00:06:13,120 --> 00:06:17,280
inside outlook to send ourselves a

170
00:06:17,280 --> 00:06:20,639
mail with a sensitive file attachment

171
00:06:20,639 --> 00:06:23,199
after the end of the engagement so after

172
00:06:23,199 --> 00:06:25,199
the five days of the activity we had a

173
00:06:25,199 --> 00:06:26,560
call with our customers and we

174
00:06:26,560 --> 00:06:31,360
understood that their dlp so their

175
00:06:31,520 --> 00:06:34,240
data leak prevention system sees our

176
00:06:34,240 --> 00:06:36,160
email but

177
00:06:36,160 --> 00:06:38,240
it doesn't block them

178
00:06:38,240 --> 00:06:40,639
instead we send only a notification to

179
00:06:40,639 --> 00:06:42,800
our customer's it team

180
00:06:42,800 --> 00:06:44,880
the issue here is that when the

181
00:06:44,880 --> 00:06:47,360
notification reaches our customers t

182
00:06:47,360 --> 00:06:50,319
team the file is already out of their

183
00:06:50,319 --> 00:06:53,199
network so we have the information we

184
00:06:53,199 --> 00:06:54,479
have expected the information

185
00:06:54,479 --> 00:06:57,120
successfully

186
00:06:58,319 --> 00:06:59,520
now

187
00:06:59,520 --> 00:07:00,560
i think

188
00:07:00,560 --> 00:07:04,000
i think i think we all can agree that

189
00:07:04,000 --> 00:07:06,880
the http protocol is a very good way to

190
00:07:06,880 --> 00:07:09,599
exfiltrate and inject information into

191
00:07:09,599 --> 00:07:12,400
our environment

192
00:07:13,039 --> 00:07:13,840
so

193
00:07:13,840 --> 00:07:15,599
by using

194
00:07:15,599 --> 00:07:18,479
websites which allows us to upload and

195
00:07:18,479 --> 00:07:20,800
download files

196
00:07:20,800 --> 00:07:23,520
we can see in a very simple manner

197
00:07:23,520 --> 00:07:26,960
exfiltrate and inject files

198
00:07:26,960 --> 00:07:29,680
but here as you can see we got blocked

199
00:07:29,680 --> 00:07:31,440
by

200
00:07:31,440 --> 00:07:35,440
a proxy a filter which we know from the

201
00:07:35,440 --> 00:07:38,479
gray text under the red line is powered

202
00:07:38,479 --> 00:07:41,199
by surface

203
00:07:41,280 --> 00:07:44,800
now we can see that we have a sort of

204
00:07:44,800 --> 00:07:47,120
two-level blacklist we have blacklisted

205
00:07:47,120 --> 00:07:50,720
domains such as facebook.com and we have

206
00:07:50,720 --> 00:07:53,120
blacklisted domain categories such as

207
00:07:53,120 --> 00:07:56,560
market or gambling or something similar

208
00:07:56,560 --> 00:07:59,039
and um

209
00:07:59,039 --> 00:08:00,400
we have a blacklist

210
00:08:00,400 --> 00:08:04,080
so i am going to make a big reveal to

211
00:08:04,080 --> 00:08:07,120
you and this is really a big reveal so

212
00:08:07,120 --> 00:08:09,280
hold on tight what i'm going to say to

213
00:08:09,280 --> 00:08:11,120
you is that to bypass a blacklist you

214
00:08:11,120 --> 00:08:13,280
have to well finding something that not

215
00:08:13,280 --> 00:08:14,879
that listed so

216
00:08:14,879 --> 00:08:17,039
we

217
00:08:17,360 --> 00:08:19,039
we can simply

218
00:08:19,039 --> 00:08:22,560
make some kind of brute force so we can

219
00:08:22,560 --> 00:08:25,680
take a great number of sites and try if

220
00:08:25,680 --> 00:08:28,160
it bypasses our blacklist or we can

221
00:08:28,160 --> 00:08:29,360
think

222
00:08:29,360 --> 00:08:30,879
away smarter

223
00:08:30,879 --> 00:08:32,719
so from the

224
00:08:32,719 --> 00:08:33,839
software

225
00:08:33,839 --> 00:08:36,320
which we could see in our desktop we

226
00:08:36,320 --> 00:08:39,360
know that our customers works with ibm

227
00:08:39,360 --> 00:08:41,839
so

228
00:08:42,640 --> 00:08:45,600
we can assume reasonably that

229
00:08:45,600 --> 00:08:48,160
cloud.ibm.com

230
00:08:48,160 --> 00:08:50,560
maybe not that list

231
00:08:50,560 --> 00:08:52,720
as you can see this is true and this

232
00:08:52,720 --> 00:08:54,399
consents us to

233
00:08:54,399 --> 00:08:56,959
upload or download the arbitrary files

234
00:08:56,959 --> 00:08:58,800
inside the environment so this is the

235
00:08:58,800 --> 00:09:00,959
second method to exfiltrate and inject

236
00:09:00,959 --> 00:09:03,599
information

237
00:09:04,240 --> 00:09:06,720
after that we enumerate a variety of

238
00:09:06,720 --> 00:09:10,640
websites which can be useful to perform

239
00:09:10,640 --> 00:09:13,600
explications or inject a injection of

240
00:09:13,600 --> 00:09:15,680
malicious files and we found out that

241
00:09:15,680 --> 00:09:18,720
xerobin.net is not blacklisted

242
00:09:18,720 --> 00:09:20,480
this

243
00:09:20,480 --> 00:09:23,760
is empowered by the findings that the

244
00:09:23,760 --> 00:09:26,560
copy paste was not disabled inside edge

245
00:09:26,560 --> 00:09:30,320
if we put together the students we can

246
00:09:30,320 --> 00:09:32,800
open a file with edge copy its content

247
00:09:32,800 --> 00:09:35,440
and paste it inside xerobin.net and

248
00:09:35,440 --> 00:09:37,600
immediately we found the third method to

249
00:09:37,600 --> 00:09:41,600
exfiltrate and inject information

250
00:09:42,240 --> 00:09:43,839
okay

251
00:09:43,839 --> 00:09:45,920
that's good but at the moment we need to

252
00:09:45,920 --> 00:09:49,600
rely on third-party websites which

253
00:09:49,600 --> 00:09:52,000
do the work for us

254
00:09:52,000 --> 00:09:53,120
so

255
00:09:53,120 --> 00:09:56,320
how can we completely bypass the filter

256
00:09:56,320 --> 00:09:58,880
and make our target connect to something

257
00:09:58,880 --> 00:10:02,720
which is fully controlled by us

258
00:10:03,120 --> 00:10:04,880
we know that

259
00:10:04,880 --> 00:10:08,640
our proxy works with site categories

260
00:10:08,640 --> 00:10:12,240
and so if we are able to find a domain

261
00:10:12,240 --> 00:10:13,839
which is available

262
00:10:13,839 --> 00:10:16,640
at which we can buy so

263
00:10:16,640 --> 00:10:19,040
which matches a

264
00:10:19,040 --> 00:10:21,279
category which is not that listed

265
00:10:21,279 --> 00:10:23,920
maybe we should be able to bypass the

266
00:10:23,920 --> 00:10:25,600
restriction

267
00:10:25,600 --> 00:10:26,320
so

268
00:10:26,320 --> 00:10:28,320
let's use the url categorization adopted

269
00:10:28,320 --> 00:10:30,480
by siren and let's see an example we

270
00:10:30,480 --> 00:10:32,480
have astrive.net which is not that

271
00:10:32,480 --> 00:10:35,600
listed and its category is computers and

272
00:10:35,600 --> 00:10:38,079
technology

273
00:10:38,079 --> 00:10:41,040
okay so we can assume reasonably that

274
00:10:41,040 --> 00:10:43,120
computers and technology is a category

275
00:10:43,120 --> 00:10:45,200
which is not the list

276
00:10:45,200 --> 00:10:46,399
so

277
00:10:46,399 --> 00:10:49,200
what we can think now is

278
00:10:49,200 --> 00:10:51,200
well domains

279
00:10:51,200 --> 00:10:52,560
expire

280
00:10:52,560 --> 00:10:54,160
so what about

281
00:10:54,160 --> 00:10:58,160
finding and buying a domain expired and

282
00:10:58,160 --> 00:10:59,760
available

283
00:10:59,760 --> 00:11:02,959
which is still categorized as

284
00:11:02,959 --> 00:11:04,800
one of the follow with categorized

285
00:11:04,800 --> 00:11:05,760
category

286
00:11:05,760 --> 00:11:07,519
one of the white listed categories such

287
00:11:07,519 --> 00:11:11,279
as computers and technology in our case

288
00:11:11,279 --> 00:11:13,440
so we use domain hunter to find the

289
00:11:13,440 --> 00:11:15,519
expired domain which contains the word

290
00:11:15,519 --> 00:11:17,760
computer in their name

291
00:11:17,760 --> 00:11:20,079
we found nrcomputer.com which seems to

292
00:11:20,079 --> 00:11:22,079
be available and seems to match the

293
00:11:22,079 --> 00:11:24,320
category computers and technology let's

294
00:11:24,320 --> 00:11:26,720
see if by this can be useful for us

295
00:11:26,720 --> 00:11:29,120
now the only thing to do is to craft a

296
00:11:29,120 --> 00:11:31,600
super duper professional upload page

297
00:11:31,600 --> 00:11:33,360
which can be used to exfiltrate

298
00:11:33,360 --> 00:11:35,680
information or inject something

299
00:11:35,680 --> 00:11:39,200
in a second moment into the environment

300
00:11:39,200 --> 00:11:42,240
here we are this is the results as you

301
00:11:42,240 --> 00:11:44,399
can see the domain successfully bypasses

302
00:11:44,399 --> 00:11:45,410
the filter and

303
00:11:45,410 --> 00:11:46,720
[Music]

304
00:11:46,720 --> 00:11:48,480
allows us to reach a web server under

305
00:11:48,480 --> 00:11:51,279
our control in the pic you can fully

306
00:11:51,279 --> 00:11:55,680
appreciate our very professional crafted

307
00:11:55,680 --> 00:11:56,480
page

308
00:11:56,480 --> 00:11:58,399
we use php

309
00:11:58,399 --> 00:12:00,720
yeah

310
00:12:01,440 --> 00:12:03,680
okay

311
00:12:04,560 --> 00:12:05,600
okay

312
00:12:05,600 --> 00:12:07,920
we have a domain capable of bypassing

313
00:12:07,920 --> 00:12:11,600
the category checks so

314
00:12:11,600 --> 00:12:14,240
reasonably we can also use it to inject

315
00:12:14,240 --> 00:12:16,800
malicious files instead of a target

316
00:12:16,800 --> 00:12:18,160
but

317
00:12:18,160 --> 00:12:20,639
as we can see here

318
00:12:20,639 --> 00:12:22,880
if we try to directly download an

319
00:12:22,880 --> 00:12:25,360
executable file we get blocked by the

320
00:12:25,360 --> 00:12:27,120
proxy

321
00:12:27,120 --> 00:12:29,920
if we also try to download an encrypted

322
00:12:29,920 --> 00:12:31,519
archive

323
00:12:31,519 --> 00:12:33,920
we also get blocked by the proxy so what

324
00:12:33,920 --> 00:12:36,480
we can deduce from these is that

325
00:12:36,480 --> 00:12:40,560
our proxy can do some packet inspection

326
00:12:40,560 --> 00:12:41,519
to

327
00:12:41,519 --> 00:12:43,440
discern a good file from an unwanted one

328
00:12:43,440 --> 00:12:45,519
in our case executable files and

329
00:12:45,519 --> 00:12:47,600
encrypted archives

330
00:12:47,600 --> 00:12:51,120
a way to bypass this could be

331
00:12:51,120 --> 00:12:52,560
tls

332
00:12:52,560 --> 00:12:55,120
tls encrypts packets and if our proxy

333
00:12:55,120 --> 00:12:57,760
has no ssl termination then he can't

334
00:12:57,760 --> 00:13:00,160
inspect the real content of our files

335
00:13:00,160 --> 00:13:01,200
and

336
00:13:01,200 --> 00:13:03,519
we can simply inject arbitrary files

337
00:13:03,519 --> 00:13:05,279
inside our environment

338
00:13:05,279 --> 00:13:07,440
caddy is useful to

339
00:13:07,440 --> 00:13:10,399
quickly set up an https server on

340
00:13:10,399 --> 00:13:12,800
our machine

341
00:13:12,800 --> 00:13:15,600
well as you can see our proxy has no ssl

342
00:13:15,600 --> 00:13:18,240
termination and thus we are able to

343
00:13:18,240 --> 00:13:19,839
upload arbitrary file inside our

344
00:13:19,839 --> 00:13:21,360
environment

345
00:13:21,360 --> 00:13:24,880
the very stealthy file mobile.exe is now

346
00:13:24,880 --> 00:13:28,160
inside their system

347
00:13:28,160 --> 00:13:30,000
okay

348
00:13:30,000 --> 00:13:31,440
we have a domain which is capable of

349
00:13:31,440 --> 00:13:33,600
bypassing our customer fetus so we can

350
00:13:33,600 --> 00:13:34,800
think

351
00:13:34,800 --> 00:13:38,399
about dns name resolution explication

352
00:13:38,399 --> 00:13:40,320
what's the concept the concept is really

353
00:13:40,320 --> 00:13:42,399
quite simple

354
00:13:42,399 --> 00:13:45,120
if we want to expect the information x

355
00:13:45,120 --> 00:13:46,720
by z

356
00:13:46,720 --> 00:13:48,800
and we

357
00:13:48,800 --> 00:13:52,880
query some subdomains of such as

358
00:13:52,880 --> 00:13:55,600
xyz.nrcomputer.com

359
00:13:55,600 --> 00:13:58,320
and we set an authoritative dns server

360
00:13:58,320 --> 00:14:01,519
from the only domain on our computer.com

361
00:14:01,519 --> 00:14:02,639
we

362
00:14:02,639 --> 00:14:05,120
get the information xyz from such

363
00:14:05,120 --> 00:14:07,680
operation

364
00:14:08,160 --> 00:14:09,120
so

365
00:14:09,120 --> 00:14:10,399
the steps are

366
00:14:10,399 --> 00:14:12,160
the following

367
00:14:12,160 --> 00:14:14,079
we have to configure an authoritative

368
00:14:14,079 --> 00:14:16,320
dns server from one domain in our case

369
00:14:16,320 --> 00:14:18,959
on our computer.com we can generate

370
00:14:18,959 --> 00:14:20,959
these filtration payloads using a simple

371
00:14:20,959 --> 00:14:22,959
script like the one you can see in this

372
00:14:22,959 --> 00:14:24,560
slide

373
00:14:24,560 --> 00:14:26,880
and then we can simply explain data

374
00:14:26,880 --> 00:14:28,959
using

375
00:14:28,959 --> 00:14:30,800
dns name resolution

376
00:14:30,800 --> 00:14:33,600
uh clearly there were an ml in this

377
00:14:33,600 --> 00:14:35,680
start

378
00:14:35,680 --> 00:14:37,600
yeah

379
00:14:37,600 --> 00:14:40,079
as you can see the encryption operation

380
00:14:40,079 --> 00:14:44,079
is performed before uh to

381
00:14:44,079 --> 00:14:48,160
send the queries this is because

382
00:14:48,160 --> 00:14:50,079
in this manner we can

383
00:14:50,079 --> 00:14:53,120
augment the entropy of our file

384
00:14:53,120 --> 00:14:55,519
the entropy of the payload which

385
00:14:55,519 --> 00:14:56,839
is

386
00:14:56,839 --> 00:14:58,399
which

387
00:14:58,399 --> 00:15:01,040
which go through our network and thus we

388
00:15:01,040 --> 00:15:04,480
can make more difficult the life of the

389
00:15:04,480 --> 00:15:06,480
people which have to

390
00:15:06,480 --> 00:15:08,959
analyze uh logs

391
00:15:08,959 --> 00:15:11,120
which cannot immediately know what file

392
00:15:11,120 --> 00:15:13,920
vs filtrated

393
00:15:14,720 --> 00:15:16,720
yeah as you can see using this technique

394
00:15:16,720 --> 00:15:19,600
we successfully managed to obtain

395
00:15:19,600 --> 00:15:21,600
a sensitive file

396
00:15:21,600 --> 00:15:25,199
through dns name resolution explication

397
00:15:25,199 --> 00:15:26,490
okay

398
00:15:26,490 --> 00:15:28,560
[Music]

399
00:15:28,560 --> 00:15:31,759
the first name was fulfilled so i let

400
00:15:31,759 --> 00:15:33,759
luca talk you about

401
00:15:33,759 --> 00:15:36,639
how to proceed with further

402
00:15:36,639 --> 00:15:39,360
analysis and

403
00:15:39,360 --> 00:15:41,920
how to proceed with in specific sandbox

404
00:15:41,920 --> 00:15:45,920
escape from our controlled environment

405
00:15:46,480 --> 00:15:48,320
thank you victoria

406
00:15:48,320 --> 00:15:49,120
so

407
00:15:49,120 --> 00:15:50,959
here we are

408
00:15:50,959 --> 00:15:52,720
the scope at the beginning as vittorio

409
00:15:52,720 --> 00:15:55,279
said was just to exfiltrate data but we

410
00:15:55,279 --> 00:15:57,839
asked a little grants to

411
00:15:57,839 --> 00:16:00,079
to go further in the activity to be able

412
00:16:00,079 --> 00:16:02,079
to see how

413
00:16:02,079 --> 00:16:04,880
uh the other part of the infrastructure

414
00:16:04,880 --> 00:16:07,600
works and was hardened

415
00:16:07,600 --> 00:16:10,160
doing that

416
00:16:10,959 --> 00:16:12,800
we're doing that we have started to

417
00:16:12,800 --> 00:16:14,720
escalate the system

418
00:16:14,720 --> 00:16:17,600
so far we haven't talked about what is a

419
00:16:17,600 --> 00:16:20,079
vdi system maybe

420
00:16:20,079 --> 00:16:22,560
many of you knows that but the secrets

421
00:16:22,560 --> 00:16:24,639
with the eye is nothing less than an

422
00:16:24,639 --> 00:16:27,040
exposed guest os through a web

423
00:16:27,040 --> 00:16:30,160
application so a web page that exposes

424
00:16:30,160 --> 00:16:32,880
in our case a microsoft windows

425
00:16:32,880 --> 00:16:35,759
generally in this tape or customer an

426
00:16:35,759 --> 00:16:37,680
architect or there are also something

427
00:16:37,680 --> 00:16:40,399
like configuration control that at each

428
00:16:40,399 --> 00:16:43,360
spawn of the guest os will configure

429
00:16:43,360 --> 00:16:45,839
things like zpo or hardening of the

430
00:16:45,839 --> 00:16:48,720
system or get it and so on that to lock

431
00:16:48,720 --> 00:16:51,519
down the system for the customer and for

432
00:16:51,519 --> 00:16:54,000
the uh and for what

433
00:16:54,000 --> 00:16:56,399
the the customer is aiming to give to

434
00:16:56,399 --> 00:16:59,199
their employee in this case

435
00:16:59,199 --> 00:17:01,279
so in this case we have the citrix that

436
00:17:01,279 --> 00:17:03,600
expose windows os and then we have

437
00:17:03,600 --> 00:17:06,319
evanti that is one to one of the many

438
00:17:06,319 --> 00:17:08,880
tools that can be used to configure a

439
00:17:08,880 --> 00:17:11,439
guest os

440
00:17:14,000 --> 00:17:15,760
so

441
00:17:15,760 --> 00:17:16,880
hardening

442
00:17:16,880 --> 00:17:18,880
in this particular cases but in many

443
00:17:18,880 --> 00:17:21,359
cases when you see also in i don't know

444
00:17:21,359 --> 00:17:24,400
hotels and so on you can

445
00:17:24,400 --> 00:17:26,720
easily imagine that many of the

446
00:17:26,720 --> 00:17:28,799
functionality of windows will be

447
00:17:28,799 --> 00:17:32,720
inhibited so here we had uh

448
00:17:32,720 --> 00:17:34,720
the inhibition system commands the

449
00:17:34,720 --> 00:17:36,160
inhibition on

450
00:17:36,160 --> 00:17:38,960
the free navigation or internet shares

451
00:17:38,960 --> 00:17:39,919
or

452
00:17:39,919 --> 00:17:42,000
other

453
00:17:42,000 --> 00:17:44,799
standard functionality of windows so guy

454
00:17:44,799 --> 00:17:49,840
guy future like opens save as and so on

455
00:17:52,640 --> 00:17:56,240
so we turn back from our initial desktop

456
00:17:56,240 --> 00:17:57,760
and

457
00:17:57,760 --> 00:17:59,840
for example here we haven't take the

458
00:17:59,840 --> 00:18:02,000
picture but the start menu was very

459
00:18:02,000 --> 00:18:03,679
limited there weren't

460
00:18:03,679 --> 00:18:06,240
any rnas or

461
00:18:06,240 --> 00:18:09,120
other pan control panels so on so it's a

462
00:18:09,120 --> 00:18:10,320
classic

463
00:18:10,320 --> 00:18:12,720
locked down environment but since from

464
00:18:12,720 --> 00:18:14,880
here when we start the activity we

465
00:18:14,880 --> 00:18:18,000
already noticed something that uh

466
00:18:18,000 --> 00:18:20,960
lighted a lamp in our head because we

467
00:18:20,960 --> 00:18:24,080
can see a full office suite that is uh

468
00:18:24,080 --> 00:18:25,600
given to the

469
00:18:25,600 --> 00:18:29,120
employees to to do their work and

470
00:18:29,120 --> 00:18:32,799
as we know if the if this uh

471
00:18:32,799 --> 00:18:36,240
suite as the development tools enable it

472
00:18:36,240 --> 00:18:38,880
could lead us to the to write

473
00:18:38,880 --> 00:18:42,160
public uba application and so to access

474
00:18:42,160 --> 00:18:47,039
some kind of control inside the machine

475
00:18:47,039 --> 00:18:47,880
but

476
00:18:47,880 --> 00:18:51,200
[Music]

477
00:18:51,200 --> 00:18:54,000
in this in our case when we opened the

478
00:18:54,000 --> 00:18:57,039
microsoft word xl so on we noticed that

479
00:18:57,039 --> 00:18:59,600
there weren't the developer to enable

480
00:18:59,600 --> 00:19:04,000
but we we noticed uh soon after that

481
00:19:04,000 --> 00:19:06,000
they were left uh

482
00:19:06,000 --> 00:19:09,200
they left the ability to enable it by

483
00:19:09,200 --> 00:19:11,520
the configuration of the office suite so

484
00:19:11,520 --> 00:19:14,400
we were able to simply write a wba

485
00:19:14,400 --> 00:19:16,559
script

486
00:19:16,559 --> 00:19:19,200
and so and then execute it

487
00:19:19,200 --> 00:19:21,200
first thing we tried

488
00:19:21,200 --> 00:19:24,240
is of course access a cmd

489
00:19:24,240 --> 00:19:26,080
but as you can see from the screenshot

490
00:19:26,080 --> 00:19:28,320
the cmt was locked in this case was

491
00:19:28,320 --> 00:19:31,440
locked by arrogated in arrogated

492
00:19:31,440 --> 00:19:34,080
configuration

493
00:19:34,080 --> 00:19:34,880
so

494
00:19:34,880 --> 00:19:35,600
what

495
00:19:35,600 --> 00:19:37,039
what we told

496
00:19:37,039 --> 00:19:39,039
if we can use cmd we had to find

497
00:19:39,039 --> 00:19:41,840
something that allow us to run commands

498
00:19:41,840 --> 00:19:43,440
as cmd

499
00:19:43,440 --> 00:19:44,400
we

500
00:19:44,400 --> 00:19:47,919
we use the the all their ftp that with

501
00:19:47,919 --> 00:19:50,880
the ban allow us to run command exactly

502
00:19:50,880 --> 00:19:54,160
like we were in under cnd environment

503
00:19:54,160 --> 00:19:56,400
and so we started the escalation from

504
00:19:56,400 --> 00:19:58,640
there

505
00:19:59,360 --> 00:20:01,440
we also find out that uh

506
00:20:01,440 --> 00:20:03,760
was possible to run many of the

507
00:20:03,760 --> 00:20:05,200
extension we

508
00:20:05,200 --> 00:20:08,640
we just say usa is here but many of the

509
00:20:08,640 --> 00:20:11,280
extension that allowed to write code in

510
00:20:11,280 --> 00:20:13,440
different language from visual basic to

511
00:20:13,440 --> 00:20:16,960
perl and so on was left enabled in the

512
00:20:16,960 --> 00:20:19,600
system so also that we find out another

513
00:20:19,600 --> 00:20:22,000
way to write our code and start to

514
00:20:22,000 --> 00:20:23,120
execute

515
00:20:23,120 --> 00:20:25,840
uh code exactly

516
00:20:25,840 --> 00:20:27,120
inside the

517
00:20:27,120 --> 00:20:27,919
the

518
00:20:27,919 --> 00:20:30,880
request to us and so be more

519
00:20:30,880 --> 00:20:35,159
fast in what we were doing

520
00:20:35,919 --> 00:20:36,720
we

521
00:20:36,720 --> 00:20:39,679
when we tried out the the cmd we figured

522
00:20:39,679 --> 00:20:42,480
that was blocked by rug edit as i said

523
00:20:42,480 --> 00:20:44,080
but

524
00:20:44,080 --> 00:20:47,360
we were able to to read with our

525
00:20:47,360 --> 00:20:50,559
user delegated but not to edit it so we

526
00:20:50,559 --> 00:20:53,760
weren't able we weren't able to uh

527
00:20:53,760 --> 00:20:58,000
enable it again what we do

528
00:20:58,559 --> 00:21:00,880
what we do we can do instead in this

529
00:21:00,880 --> 00:21:04,320
case is to use the functionality of the

530
00:21:04,320 --> 00:21:07,760
cmddl dynamic link library so that

531
00:21:07,760 --> 00:21:10,240
expose all the functionality of cindy

532
00:21:10,240 --> 00:21:11,919
and

533
00:21:11,919 --> 00:21:14,960
entirely we could have used it to access

534
00:21:14,960 --> 00:21:18,080
the functionality of the windows os

535
00:21:18,080 --> 00:21:20,320
um

536
00:21:20,640 --> 00:21:22,960
as you may know if you have ever played

537
00:21:22,960 --> 00:21:26,080
any ctf and i'm sure you did uh around

538
00:21:26,080 --> 00:21:28,080
the aldol trench redway

539
00:21:28,080 --> 00:21:30,879
32 sorry

540
00:21:30,960 --> 00:21:33,679
is that the easiest way in windows is

541
00:21:33,679 --> 00:21:36,480
provide the director by the operating

542
00:21:36,480 --> 00:21:39,919
system and allow us to call dynamic link

543
00:21:39,919 --> 00:21:42,400
libraries directly and so in this case

544
00:21:42,400 --> 00:21:44,559
we just called the main function of the

545
00:21:44,559 --> 00:21:46,400
cmd between

546
00:21:46,400 --> 00:21:50,559
between cmdd scripts and uh and we

547
00:21:50,559 --> 00:21:53,919
as you can see access a full cmd and so

548
00:21:53,919 --> 00:21:56,320
we have just bypassed the the first

549
00:21:56,320 --> 00:21:57,760
block and

550
00:21:57,760 --> 00:22:00,559
that allow us to control the first part

551
00:22:00,559 --> 00:22:03,520
of the operation system

552
00:22:03,520 --> 00:22:05,760
as i said the drug edit

553
00:22:05,760 --> 00:22:09,600
was uh was able we were we were able to

554
00:22:09,600 --> 00:22:12,480
read the dark editor so we started to

555
00:22:12,480 --> 00:22:15,520
learn how this system was configured we

556
00:22:15,520 --> 00:22:17,840
weren't able to write it down but where

557
00:22:17,840 --> 00:22:22,080
we were able to dump it so we dump out

558
00:22:22,080 --> 00:22:24,000
and we start to read the

559
00:22:24,000 --> 00:22:26,960
the the key the most interesting key for

560
00:22:26,960 --> 00:22:29,919
in in representation test between those

561
00:22:29,919 --> 00:22:32,320
we found out the link

562
00:22:32,320 --> 00:22:35,039
of a pac file queen the approx proxy

563
00:22:35,039 --> 00:22:36,480
configuration file automatic

564
00:22:36,480 --> 00:22:38,640
configuration file this is a normal

565
00:22:38,640 --> 00:22:40,880
procedure in active directory in windows

566
00:22:40,880 --> 00:22:44,080
environment is used in both medium to

567
00:22:44,080 --> 00:22:46,400
large corporation to provide information

568
00:22:46,400 --> 00:22:48,640
booth for for systems

569
00:22:48,640 --> 00:22:51,360
but is also a good starting point to

570
00:22:51,360 --> 00:22:53,039
start to map the

571
00:22:53,039 --> 00:22:55,679
network infrastructure of the customer

572
00:22:55,679 --> 00:22:58,559
so we find this tricky and we start to

573
00:22:58,559 --> 00:23:01,120
uh download this pac file to start

574
00:23:01,120 --> 00:23:03,440
inspect them

575
00:23:03,440 --> 00:23:06,960
this is a the the example a piece of the

576
00:23:06,960 --> 00:23:08,960
the pac file and

577
00:23:08,960 --> 00:23:12,159
just from here we can start to see a lot

578
00:23:12,159 --> 00:23:15,919
of domain so this is a very good way to

579
00:23:15,919 --> 00:23:18,960
enumerate service announced without

580
00:23:18,960 --> 00:23:22,400
being detected in any case because is a

581
00:23:22,400 --> 00:23:24,559
file accessed and normally accessed by

582
00:23:24,559 --> 00:23:25,919
all the clients

583
00:23:25,919 --> 00:23:29,039
and we also start to understand how the

584
00:23:29,039 --> 00:23:32,159
architecture works how many uh how the

585
00:23:32,159 --> 00:23:34,000
the internet traffic is driven to the

586
00:23:34,000 --> 00:23:35,280
network

587
00:23:35,280 --> 00:23:37,840
with kind of control they doing they are

588
00:23:37,840 --> 00:23:40,640
doing in this kind of environment from

589
00:23:40,640 --> 00:23:44,000
which domain we can roots what and from

590
00:23:44,000 --> 00:23:46,080
which not

591
00:23:46,080 --> 00:23:49,120
so what we did now was uh

592
00:23:49,120 --> 00:23:51,760
writting the infrastructure so we took

593
00:23:51,760 --> 00:23:54,159
our first draw our first curse of the

594
00:23:54,159 --> 00:23:56,240
infrastructure and we started redrawing

595
00:23:56,240 --> 00:23:59,840
it to be able to have a picture a real

596
00:23:59,840 --> 00:24:02,640
picture of how the the

597
00:24:02,640 --> 00:24:05,039
the infrastructure was working now with

598
00:24:05,039 --> 00:24:06,640
the information we had

599
00:24:06,640 --> 00:24:09,360
so we find out that

600
00:24:09,360 --> 00:24:12,640
the the infrastructures and

601
00:24:12,640 --> 00:24:14,640
from the guest os

602
00:24:14,640 --> 00:24:17,200
internet traffic were driven based on

603
00:24:17,200 --> 00:24:19,360
rules and we will see in a bit

604
00:24:19,360 --> 00:24:20,320
uh

605
00:24:20,320 --> 00:24:22,720
through two different kind of of web

606
00:24:22,720 --> 00:24:23,760
proxy

607
00:24:23,760 --> 00:24:26,960
one was a surface proxy and there's one

608
00:24:26,960 --> 00:24:28,720
we saw before in the screenshot the

609
00:24:28,720 --> 00:24:31,760
other one was the an iron port proxy but

610
00:24:31,760 --> 00:24:34,640
the interesting thing

611
00:24:34,640 --> 00:24:38,650
uh the interesting thing was that

612
00:24:38,650 --> 00:24:40,400
[Music]

613
00:24:40,400 --> 00:24:42,799
we find out we noticed something strong

614
00:24:42,799 --> 00:24:44,159
we noticed that

615
00:24:44,159 --> 00:24:47,200
from the comments inside the pac file

616
00:24:47,200 --> 00:24:49,679
looks like that the iron port

617
00:24:49,679 --> 00:24:52,400
proxy wasn't configured in filtered mode

618
00:24:52,400 --> 00:24:55,520
so it could theoretically allow

619
00:24:55,520 --> 00:24:58,320
uh any traffic to go through it

620
00:24:58,320 --> 00:24:59,120
uh

621
00:24:59,120 --> 00:25:03,360
reading uh reading the the pac file

622
00:25:03,360 --> 00:25:05,360
we also saw uh

623
00:25:05,360 --> 00:25:06,400
that uh

624
00:25:06,400 --> 00:25:08,720
all the internal domains of the bank

625
00:25:08,720 --> 00:25:11,679
will be driven through the the

626
00:25:11,679 --> 00:25:13,440
unfiltered proxy

627
00:25:13,440 --> 00:25:17,200
and we also noticed a a nice thing that

628
00:25:17,200 --> 00:25:20,400
there were a rules and sh exp match

629
00:25:20,400 --> 00:25:21,440
rules

630
00:25:21,440 --> 00:25:24,000
that was misconfigured because there

631
00:25:24,000 --> 00:25:26,000
were a star at the end

632
00:25:26,000 --> 00:25:28,400
that makes that makes

633
00:25:28,400 --> 00:25:29,360
any

634
00:25:29,360 --> 00:25:32,080
domain with that little part at the

635
00:25:32,080 --> 00:25:35,679
beginning match that rule so without any

636
00:25:35,679 --> 00:25:38,240
moody any more mode at the system

637
00:25:38,240 --> 00:25:40,320
without touching anything inside the

638
00:25:40,320 --> 00:25:42,799
system we were able to exfiltrate

639
00:25:42,799 --> 00:25:44,240
through a domain

640
00:25:44,240 --> 00:25:47,120
so we bought the nr computer but

641
00:25:47,120 --> 00:25:49,200
any domain you want just

642
00:25:49,200 --> 00:25:51,520
adding a sub domain that matches that

643
00:25:51,520 --> 00:25:54,880
rule this way we were able to bypass and

644
00:25:54,880 --> 00:25:56,480
totally

645
00:25:56,480 --> 00:26:00,080
going through an infiltrate proxy and

646
00:26:00,080 --> 00:26:02,480
as we discovered later was also not

647
00:26:02,480 --> 00:26:04,720
monitored one so we were able for

648
00:26:04,720 --> 00:26:05,760
example

649
00:26:05,760 --> 00:26:08,000
to drive ssh

650
00:26:08,000 --> 00:26:10,159
on the port 443 because there was the

651
00:26:10,159 --> 00:26:12,720
only one open but we were able to do a

652
00:26:12,720 --> 00:26:15,279
reverse tunnel vssh directly through a

653
00:26:15,279 --> 00:26:18,240
web proxy that the the company the

654
00:26:18,240 --> 00:26:21,600
corporation implemented

655
00:26:21,840 --> 00:26:24,480
so now we now

656
00:26:24,480 --> 00:26:26,559
victoria continue your time

657
00:26:26,559 --> 00:26:27,679
okay

658
00:26:27,679 --> 00:26:28,880
now we have

659
00:26:28,880 --> 00:26:31,440
a lot of more information about how our

660
00:26:31,440 --> 00:26:33,919
customers infrastructure works and we

661
00:26:33,919 --> 00:26:36,799
can think of infecting the system with a

662
00:26:36,799 --> 00:26:38,880
malware

663
00:26:38,880 --> 00:26:40,320
uh yeah

664
00:26:40,320 --> 00:26:42,400
our first thing we need to test

665
00:26:42,400 --> 00:26:46,000
antivirus's capabilities

666
00:26:46,000 --> 00:26:46,960
so

667
00:26:46,960 --> 00:26:51,120
due to the directory drag of time and

668
00:26:51,520 --> 00:26:53,840
we can choose to generate a

669
00:26:53,840 --> 00:26:56,880
general period with metasploit okay and

670
00:26:56,880 --> 00:26:58,880
with this choice we booked our place to

671
00:26:58,880 --> 00:27:01,039
l

672
00:27:02,320 --> 00:27:03,840
yeah

673
00:27:03,840 --> 00:27:05,360
the last

674
00:27:05,360 --> 00:27:07,360
last thing we can see in this slide is a

675
00:27:07,360 --> 00:27:09,360
quote from decoder how many of you know

676
00:27:09,360 --> 00:27:12,639
the other piece are your hand

677
00:27:13,039 --> 00:27:14,400
the color

678
00:27:14,400 --> 00:27:16,400
window sucker

679
00:27:16,400 --> 00:27:19,200
lonely potato no

680
00:27:19,200 --> 00:27:20,480
okay so

681
00:27:20,480 --> 00:27:21,200
for

682
00:27:21,200 --> 00:27:22,720
those of you who don't know decoder

683
00:27:22,720 --> 00:27:24,640
decoder is one maybe one of the best

684
00:27:24,640 --> 00:27:28,000
windows hackers i ever seen and

685
00:27:28,000 --> 00:27:30,799
this is a quote from he

686
00:27:30,799 --> 00:27:33,039
taken from a telegram chat we have in

687
00:27:33,039 --> 00:27:36,080
common and for those of you who

688
00:27:36,080 --> 00:27:37,840
don't speak italian they could say

689
00:27:37,840 --> 00:27:39,360
something like

690
00:27:39,360 --> 00:27:42,240
we can find almost only donkeys and

691
00:27:42,240 --> 00:27:44,960
metasploit lovers and thus mad people

692
00:27:44,960 --> 00:27:47,440
but i can't find

693
00:27:47,440 --> 00:27:49,360
better i can find better

694
00:27:49,360 --> 00:27:51,279
so

695
00:27:51,279 --> 00:27:53,600
to clarify better uh

696
00:27:53,600 --> 00:27:56,240
the position of the color towards

697
00:27:56,240 --> 00:27:57,840
metasploit

698
00:27:57,840 --> 00:28:00,880
this is taken from his blog

699
00:28:00,880 --> 00:28:02,159
this is the article which describes

700
00:28:02,159 --> 00:28:04,799
lonely potato which is one of the zero

701
00:28:04,799 --> 00:28:06,799
days he published the

702
00:28:06,799 --> 00:28:10,000
for windows operating system

703
00:28:10,000 --> 00:28:11,360
and uh

704
00:28:11,360 --> 00:28:12,240
so

705
00:28:12,240 --> 00:28:14,159
please decoder forgive us because we are

706
00:28:14,159 --> 00:28:14,960
seen

707
00:28:14,960 --> 00:28:17,840
okay

708
00:28:17,840 --> 00:28:18,640
well

709
00:28:18,640 --> 00:28:21,360
met arpata are maybe

710
00:28:21,360 --> 00:28:25,360
the most known malware from any av

711
00:28:25,360 --> 00:28:28,480
software yeah so is

712
00:28:28,480 --> 00:28:30,640
easily detected

713
00:28:30,640 --> 00:28:34,399
and thus is a good way to test if

714
00:28:34,399 --> 00:28:36,960
the av software configured inside our

715
00:28:36,960 --> 00:28:39,120
target is easily

716
00:28:39,120 --> 00:28:42,960
uh by possible okay

717
00:28:42,960 --> 00:28:45,600
we used as you can see uh

718
00:28:45,600 --> 00:28:47,440
tls to

719
00:28:47,440 --> 00:28:49,679
make our traffic

720
00:28:49,679 --> 00:28:51,919
more

721
00:28:52,480 --> 00:28:53,840
stealthy yeah

722
00:28:53,840 --> 00:28:57,919
and uh we use the port 443 because we

723
00:28:57,919 --> 00:29:01,840
know that it's open in output we can

724
00:29:01,840 --> 00:29:05,760
trivially connect to https websites

725
00:29:05,760 --> 00:29:06,559
and

726
00:29:06,559 --> 00:29:08,080
as we

727
00:29:08,080 --> 00:29:10,799
can easily think if we use our

728
00:29:10,799 --> 00:29:12,720
interpreter payload

729
00:29:12,720 --> 00:29:15,600
as it is without any kind of obfuscation

730
00:29:15,600 --> 00:29:16,720
it's uh

731
00:29:16,720 --> 00:29:17,840
it's blocked

732
00:29:17,840 --> 00:29:20,960
and annihilated by the av software

733
00:29:20,960 --> 00:29:23,120
configured inside our system

734
00:29:23,120 --> 00:29:25,039
so we have to

735
00:29:25,039 --> 00:29:28,480
obfuscate it and pedzer is a magnificent

736
00:29:28,480 --> 00:29:32,480
tool to do this so thanks to fra

737
00:29:32,480 --> 00:29:34,799
and using various obfuscation techniques

738
00:29:34,799 --> 00:29:37,200
such as gen with which

739
00:29:37,200 --> 00:29:40,480
which is um improvements of chicataganai

740
00:29:40,480 --> 00:29:43,039
unhook syscalls and anti-debug options

741
00:29:43,039 --> 00:29:45,360
which implement some various

742
00:29:45,360 --> 00:29:47,760
obfuscation techniques

743
00:29:47,760 --> 00:29:49,440
we managed to

744
00:29:49,440 --> 00:29:51,279
obtain a meter protoshell inside the

745
00:29:51,279 --> 00:29:54,080
system but we didn't really use

746
00:29:54,080 --> 00:29:56,240
interpreter capabilities so

747
00:29:56,240 --> 00:29:59,600
our scene is a bit less serious

748
00:29:59,600 --> 00:30:01,440
okay

749
00:30:01,440 --> 00:30:03,200
so this is a good way to let our

750
00:30:03,200 --> 00:30:05,520
customers see that the av solution can

751
00:30:05,520 --> 00:30:07,679
be easily bypassed

752
00:30:07,679 --> 00:30:08,799
now

753
00:30:08,799 --> 00:30:11,200
this is really nice but how far can we

754
00:30:11,200 --> 00:30:13,440
go

755
00:30:13,440 --> 00:30:16,080
our first idea was to

756
00:30:16,080 --> 00:30:18,399
expand our horizons by using graphical

757
00:30:18,399 --> 00:30:21,919
menus and lucky as we are by using the

758
00:30:21,919 --> 00:30:24,880
save as and open with menus of

759
00:30:24,880 --> 00:30:26,320
softwares like

760
00:30:26,320 --> 00:30:30,159
v4 windows and ibm lotus nodes

761
00:30:30,159 --> 00:30:32,320
we managed to exponentially increase our

762
00:30:32,320 --> 00:30:34,159
scope

763
00:30:34,159 --> 00:30:36,000
looking around value system and network

764
00:30:36,000 --> 00:30:37,840
paths we found some really interesting

765
00:30:37,840 --> 00:30:40,880
things and one of these is that while

766
00:30:40,880 --> 00:30:42,799
our users

767
00:30:42,799 --> 00:30:44,159
is as

768
00:30:44,159 --> 00:30:46,640
access denied to some network shares if

769
00:30:46,640 --> 00:30:49,120
we create a link file which points to

770
00:30:49,120 --> 00:30:51,679
net for sharepod we managed to freely

771
00:30:51,679 --> 00:30:55,120
access it in most of most of the cases

772
00:30:55,120 --> 00:30:56,880
and using this

773
00:30:56,880 --> 00:30:57,919
technique

774
00:30:57,919 --> 00:31:00,000
we managed to bypass

775
00:31:00,000 --> 00:31:02,240
restrictions and access the sysvol

776
00:31:02,240 --> 00:31:04,480
shares of a domain controller

777
00:31:04,480 --> 00:31:06,159
sysbol is a

778
00:31:06,159 --> 00:31:08,320
folder shared among all the domain

779
00:31:08,320 --> 00:31:10,080
controllers which contains information

780
00:31:10,080 --> 00:31:11,039
about

781
00:31:11,039 --> 00:31:13,279
group policies and logon scripts and so

782
00:31:13,279 --> 00:31:15,840
on and it may contain

783
00:31:15,840 --> 00:31:19,600
sensitive files and we found it

784
00:31:19,600 --> 00:31:20,919
we found

785
00:31:20,919 --> 00:31:23,760
groups.xml and drives.xml

786
00:31:23,760 --> 00:31:26,880
which contains usernames and c password

787
00:31:26,880 --> 00:31:28,559
entries as you can see

788
00:31:28,559 --> 00:31:29,360
now

789
00:31:29,360 --> 00:31:32,799
c password is a

790
00:31:32,799 --> 00:31:35,039
encrypted using

791
00:31:35,039 --> 00:31:36,320
aes

792
00:31:36,320 --> 00:31:37,159
with

793
00:31:37,159 --> 00:31:41,200
256 bit in cbc mode with all zeros iv

794
00:31:41,200 --> 00:31:44,320
and this is a very secure cryptosystem

795
00:31:44,320 --> 00:31:46,559
without particular cases it cannot be

796
00:31:46,559 --> 00:31:47,919
broken

797
00:31:47,919 --> 00:31:50,159
given that the key is

798
00:31:50,159 --> 00:31:53,760
unknown and microsoft well

799
00:31:53,760 --> 00:31:55,919
published online the key so

800
00:31:55,919 --> 00:31:58,080
it's

801
00:31:58,080 --> 00:32:01,600
it was really easy to decrypt passwords

802
00:32:01,600 --> 00:32:03,440
and obtain

803
00:32:03,440 --> 00:32:05,039
a full set of credentials for an

804
00:32:05,039 --> 00:32:08,158
administrator account

805
00:32:08,880 --> 00:32:10,290
okay

806
00:32:10,290 --> 00:32:12,480
[Music]

807
00:32:12,480 --> 00:32:15,039
so with microsoft lending hands

808
00:32:15,039 --> 00:32:16,960
uh we

809
00:32:16,960 --> 00:32:19,919
used the credential we found in the five

810
00:32:19,919 --> 00:32:22,080
different random randomically selected

811
00:32:22,080 --> 00:32:24,480
systems including a domain controller

812
00:32:24,480 --> 00:32:25,519
and

813
00:32:25,519 --> 00:32:26,720
it works

814
00:32:26,720 --> 00:32:29,279
so from here the path to the heaven is

815
00:32:29,279 --> 00:32:31,600
really close

816
00:32:31,600 --> 00:32:32,799
but

817
00:32:32,799 --> 00:32:35,519
the escalation to the main admin is not

818
00:32:35,519 --> 00:32:39,360
our scope so we have to stop here

819
00:32:39,360 --> 00:32:40,799
and well

820
00:32:40,799 --> 00:32:43,279
we did what our talk promised to do we

821
00:32:43,279 --> 00:32:45,440
escalated from home worker to servers

822
00:32:45,440 --> 00:32:46,559
admin

823
00:32:46,559 --> 00:32:50,480
now before close our talk let's uh

824
00:32:50,480 --> 00:32:52,080
let's see

825
00:32:52,080 --> 00:32:54,080
some lessons we learned

826
00:32:54,080 --> 00:32:57,039
thinking as a blue team

827
00:32:57,039 --> 00:33:00,559
so vdi guests are not viral

828
00:33:00,559 --> 00:33:01,600
so

829
00:33:01,600 --> 00:33:03,039
a proper network segregation is

830
00:33:03,039 --> 00:33:05,600
mandatory this is why during our network

831
00:33:05,600 --> 00:33:07,440
enumeration we found out that an actor

832
00:33:07,440 --> 00:33:09,760
was almost completely flat

833
00:33:09,760 --> 00:33:12,080
so this is important really important to

834
00:33:12,080 --> 00:33:14,320
have

835
00:33:14,399 --> 00:33:17,679
efficient segmentation of the network

836
00:33:17,679 --> 00:33:19,519
one virtual image to rule them all does

837
00:33:19,519 --> 00:33:22,159
not work because too many software are

838
00:33:22,159 --> 00:33:24,799
needed for the to fulfill the

839
00:33:24,799 --> 00:33:27,440
requirements of virus groups so it's

840
00:33:27,440 --> 00:33:30,640
better to have a different image one of

841
00:33:30,640 --> 00:33:32,320
each

842
00:33:32,320 --> 00:33:34,960
kind of user group we have so

843
00:33:34,960 --> 00:33:38,799
it's better to have an image for

844
00:33:38,799 --> 00:33:41,760
for users for employees an image for

845
00:33:41,760 --> 00:33:43,120
uh

846
00:33:43,120 --> 00:33:45,440
for developers yeah and any email for

847
00:33:45,440 --> 00:33:47,600
each kind of groups

848
00:33:47,600 --> 00:33:49,440
do not insert credential and set your

849
00:33:49,440 --> 00:33:51,519
policy preferences this is deprecated

850
00:33:51,519 --> 00:33:52,720
and

851
00:33:52,720 --> 00:33:54,640
microsoft released it if i

852
00:33:54,640 --> 00:33:56,720
don't if i if

853
00:33:56,720 --> 00:33:59,279
this is not if i don't remember well

854
00:33:59,279 --> 00:34:00,799
microsoft released a patch which

855
00:34:00,799 --> 00:34:02,960
inhibits totally group policy

856
00:34:02,960 --> 00:34:05,600
preferences

857
00:34:05,840 --> 00:34:06,960
because uh

858
00:34:06,960 --> 00:34:09,440
the credential is stored inside the

859
00:34:09,440 --> 00:34:12,399
csvall in a very vulnerable way as you

860
00:34:12,399 --> 00:34:14,639
will see

861
00:34:14,639 --> 00:34:16,399
and implement the group policies and

862
00:34:16,399 --> 00:34:18,639
locking features in attempt to

863
00:34:18,639 --> 00:34:20,800
stop a motivated attacker

864
00:34:20,800 --> 00:34:24,399
is not really easy

865
00:34:24,399 --> 00:34:26,879
now what do we learn

866
00:34:26,879 --> 00:34:29,918
thinking as a red team

867
00:34:29,918 --> 00:34:32,399
all works first let us see we as last

868
00:34:32,399 --> 00:34:34,960
three shots

869
00:34:36,079 --> 00:34:38,800
first of all try trivially things

870
00:34:38,800 --> 00:34:40,639
invest time to look out the features of

871
00:34:40,639 --> 00:34:43,199
the whitelisted software of on a

872
00:34:43,199 --> 00:34:44,879
protected environment because those can

873
00:34:44,879 --> 00:34:47,599
be useful to perform a sandbox escape

874
00:34:47,599 --> 00:34:49,520
and when you're racking windows

875
00:34:49,520 --> 00:34:51,440
sometimes

876
00:34:51,440 --> 00:34:53,839
almost always microsoft is your best

877
00:34:53,839 --> 00:34:54,719
friend

878
00:34:54,719 --> 00:34:56,960
so thanks for your attention the talk is

879
00:34:56,960 --> 00:34:59,960
over

880
00:35:03,839 --> 00:35:06,450
uh

881
00:35:06,450 --> 00:35:09,049
[Applause]

