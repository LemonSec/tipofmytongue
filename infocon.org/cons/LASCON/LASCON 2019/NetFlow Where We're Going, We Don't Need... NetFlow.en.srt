1
00:00:09,300 --> 00:00:32,280
[Music]

2
00:00:34,760 --> 00:00:41,370
well hello everybody I'm presenting

3
00:00:38,130 --> 00:00:44,640
today as checksum my hacker handle about

4
00:00:41,370 --> 00:00:46,050
outbound traffic filtering I really

5
00:00:44,640 --> 00:00:47,460
liked the keynote because some of the

6
00:00:46,050 --> 00:00:49,559
slides just played right into my

7
00:00:47,460 --> 00:00:51,840
presentation especially the one where

8
00:00:49,559 --> 00:00:54,510
John mentioned if you're a small company

9
00:00:51,840 --> 00:00:59,190
you probably cannot afford to have

10
00:00:54,510 --> 00:01:00,690
Splunk or some other fancy tools so this

11
00:00:59,190 --> 00:01:03,300
is actually a detailed walkthrough of

12
00:01:00,690 --> 00:01:06,179
how to use tools you may already have to

13
00:01:03,300 --> 00:01:09,000
get to a better security state without

14
00:01:06,180 --> 00:01:11,640
those fancy tools there are about 70 or

15
00:01:09,000 --> 00:01:13,110
so pages when you print this but don't

16
00:01:11,640 --> 00:01:14,850
worry I won't be presenting all of them

17
00:01:13,110 --> 00:01:18,750
right now but there will be a link at

18
00:01:14,850 --> 00:01:19,919
the end so if you if you trust me you

19
00:01:18,750 --> 00:01:23,160
know go ahead and click it and you can

20
00:01:19,920 --> 00:01:25,590
get the presentation right away so the

21
00:01:23,160 --> 00:01:27,630
about me slide yes I'm indeed a former

22
00:01:25,590 --> 00:01:30,750
coming out of Czechoslovakia it's where

23
00:01:27,630 --> 00:01:33,300
I was born and raised but now really I'm

24
00:01:30,750 --> 00:01:38,220
just a security guy on the purple path

25
00:01:33,300 --> 00:01:40,080
and my favorite pastime is enjoying you

26
00:01:38,220 --> 00:01:44,310
know making life for attackers a lot

27
00:01:40,080 --> 00:01:46,110
more difficult than it needs to be so

28
00:01:44,310 --> 00:01:47,369
row this is about why should you filter

29
00:01:46,110 --> 00:01:50,009
outbound traffic right

30
00:01:47,369 --> 00:01:52,800
hardly anybody does that but it's a

31
00:01:50,009 --> 00:01:55,950
powerful security control I'm going to

32
00:01:52,800 --> 00:01:57,390
show you that we don't do it because we

33
00:01:55,950 --> 00:01:58,860
don't really have an easy button or we

34
00:01:57,390 --> 00:02:01,920
don't have the budget to get the tools

35
00:01:58,860 --> 00:02:04,410
to do that right I will discuss the

36
00:02:01,920 --> 00:02:06,509
logic behind the script how to automate

37
00:02:04,410 --> 00:02:07,950
this and we'll be free touch on the

38
00:02:06,509 --> 00:02:12,090
results and some lessons how this

39
00:02:07,950 --> 00:02:14,190
applies maybe at your place so this is a

40
00:02:12,090 --> 00:02:18,330
web publication conference so let's go

41
00:02:14,190 --> 00:02:21,180
through a web attack our players are

42
00:02:18,330 --> 00:02:23,250
ultra secure Apache struts server and

43
00:02:21,180 --> 00:02:25,800
the developers believe they're secure

44
00:02:23,250 --> 00:02:28,190
because they follow every OS coding

45
00:02:25,800 --> 00:02:30,030
practice so the code is legit

46
00:02:28,190 --> 00:02:33,660
unfortunately the version of Apache

47
00:02:30,030 --> 00:02:34,830
struts is not so good right now we have

48
00:02:33,660 --> 00:02:38,970
the attacker in here

49
00:02:34,830 --> 00:02:41,340
at this IP who is going to find this and

50
00:02:38,970 --> 00:02:43,440
through some enumeration they will

51
00:02:41,340 --> 00:02:45,810
realize that there is a CD

52
00:02:43,440 --> 00:02:47,250
in a Python script that can exploit this

53
00:02:45,810 --> 00:02:49,680
this gives you actually remote code

54
00:02:47,250 --> 00:02:52,110
execution and the attacker wants the

55
00:02:49,680 --> 00:02:53,310
server to connect back to him and give

56
00:02:52,110 --> 00:02:55,080
him interactive control

57
00:02:53,310 --> 00:02:57,330
it's like SSH in Reverse you just ask

58
00:02:55,080 --> 00:03:01,380
the server hey come to me and give me

59
00:02:57,330 --> 00:03:03,930
control over you on the wire it goes

60
00:03:01,380 --> 00:03:06,810
it's going to send an HTTP request I

61
00:03:03,930 --> 00:03:08,820
redacted a lot of the exploit stuff it's

62
00:03:06,810 --> 00:03:11,460
really going to if the code executes

63
00:03:08,820 --> 00:03:13,079
there will be a network connection

64
00:03:11,460 --> 00:03:15,480
coming from the web server to the

65
00:03:13,080 --> 00:03:19,380
attacker along with the interactive in

66
00:03:15,480 --> 00:03:21,239
bash shell as John pointed out firewall

67
00:03:19,380 --> 00:03:24,540
right we know everybody everybody wants

68
00:03:21,240 --> 00:03:27,360
our wall they keep the bad guys out or

69
00:03:24,540 --> 00:03:28,679
so you think because the way the

70
00:03:27,360 --> 00:03:32,130
attacker is going to come to you on

71
00:03:28,680 --> 00:03:33,600
HTTPS and you'll need to allow that

72
00:03:32,130 --> 00:03:35,940
right if you want to have any customers

73
00:03:33,600 --> 00:03:37,859
on the outside that are going to visit

74
00:03:35,940 --> 00:03:41,220
your web page you need to let them in

75
00:03:37,860 --> 00:03:43,460
and also the attacker so the export code

76
00:03:41,220 --> 00:03:45,960
gets on the web server it gets executed

77
00:03:43,460 --> 00:03:47,489
the attacker is going to set up netcat

78
00:03:45,960 --> 00:03:50,970
listener so they can receive the shell

79
00:03:47,489 --> 00:03:54,810
on something on this port and the server

80
00:03:50,970 --> 00:03:57,090
is connecting to us now and now let's do

81
00:03:54,810 --> 00:03:58,800
a quick poll who here thinks that the

82
00:03:57,090 --> 00:04:04,140
attacker is getting a reverse shell at

83
00:03:58,800 --> 00:04:05,310
this point nobody interesting alright so

84
00:04:04,140 --> 00:04:09,359
everybody else thinks that the attacker

85
00:04:05,310 --> 00:04:12,540
is not getting a reverse shell right

86
00:04:09,360 --> 00:04:15,660
well it really depends on the outbound

87
00:04:12,540 --> 00:04:17,849
traffic policy that you have what is

88
00:04:15,660 --> 00:04:19,529
port 3 1 3 3 7 into the lead port right

89
00:04:17,850 --> 00:04:21,750
do you have business applications that

90
00:04:19,529 --> 00:04:24,239
use that to reach out also why do you

91
00:04:21,750 --> 00:04:26,850
allow it now I also want to highlight

92
00:04:24,240 --> 00:04:29,250
this is an incredibly powerful detective

93
00:04:26,850 --> 00:04:32,280
control because if you understand how

94
00:04:29,250 --> 00:04:34,200
your application behaves and you know

95
00:04:32,280 --> 00:04:37,229
that the server never reaches out to the

96
00:04:34,200 --> 00:04:39,450
Internet if you get the alert on the

97
00:04:37,230 --> 00:04:41,700
firewall that it's blocked and the

98
00:04:39,450 --> 00:04:44,930
connection was attempted it's probably

99
00:04:41,700 --> 00:04:44,930
something you want to look into it right

100
00:04:46,220 --> 00:04:51,660
so our mission is to deny everything

101
00:04:49,410 --> 00:04:54,210
right in and out unfortunately

102
00:04:51,660 --> 00:04:57,180
the de facto standard is we are pretty

103
00:04:54,210 --> 00:04:59,039
good at working inbound but we can

104
00:04:57,180 --> 00:05:03,750
suck at you know a blocking outbound

105
00:04:59,039 --> 00:05:05,669
just about everything the better way

106
00:05:03,750 --> 00:05:08,810
would be obviously to block everything

107
00:05:05,669 --> 00:05:11,008
in and out and only allow their own good

108
00:05:08,810 --> 00:05:13,860
let's pretend we live in a perfect world

109
00:05:11,009 --> 00:05:16,070
so we have well-defined perimeter you

110
00:05:13,860 --> 00:05:20,100
have all the tools knowledgeable admins

111
00:05:16,070 --> 00:05:22,229
anybody works at a company like that no

112
00:05:20,100 --> 00:05:28,350
ok I was about to ask if you gotta if

113
00:05:22,229 --> 00:05:30,419
you are hiring if you do so in the real

114
00:05:28,350 --> 00:05:32,039
world right you're like perimeter isn't

115
00:05:30,419 --> 00:05:32,810
that something that we study in the 90s

116
00:05:32,039 --> 00:05:35,039
or something

117
00:05:32,810 --> 00:05:37,410
NetFlow I don't even know what it is or

118
00:05:35,039 --> 00:05:39,449
you know where to collect that just by

119
00:05:37,410 --> 00:05:41,009
the way net flow is a aggregation of

120
00:05:39,449 --> 00:05:42,810
your network connection it kind of tells

121
00:05:41,009 --> 00:05:46,020
you who talks to whom for how long and

122
00:05:42,810 --> 00:05:48,720
when and where your critical business

123
00:05:46,020 --> 00:05:50,669
processes right so you come home to your

124
00:05:48,720 --> 00:05:53,160
organization and you say hey I heard

125
00:05:50,669 --> 00:05:55,409
this crazy chick guy talking we should

126
00:05:53,160 --> 00:05:57,479
block all outbound traffic and you you

127
00:05:55,410 --> 00:05:59,310
you're over there and slow ok let's do

128
00:05:57,479 --> 00:06:01,800
it and then a month later your business

129
00:05:59,310 --> 00:06:03,750
process breaks that exchanges data with

130
00:06:01,800 --> 00:06:08,490
your partner and you know you're not

131
00:06:03,750 --> 00:06:10,800
going home a hero if anybody here looked

132
00:06:08,490 --> 00:06:13,020
at just running sniffer on their

133
00:06:10,800 --> 00:06:15,120
workstation if you don't do anything you

134
00:06:13,020 --> 00:06:17,280
see a lot of advantage already right

135
00:06:15,120 --> 00:06:20,820
so on an enterprise scale there'll be

136
00:06:17,280 --> 00:06:23,010
just so much data this were Splunk and

137
00:06:20,820 --> 00:06:24,240
other seem solutions come in play but

138
00:06:23,010 --> 00:06:25,620
you know they charge you because they

139
00:06:24,240 --> 00:06:27,840
know how voluminous it is and how

140
00:06:25,620 --> 00:06:29,460
difficult it is and really nobody has

141
00:06:27,840 --> 00:06:32,638
time to do extra critical activities

142
00:06:29,460 --> 00:06:35,219
right some tips on how you can overcome

143
00:06:32,639 --> 00:06:37,650
these would be well if you don't have

144
00:06:35,220 --> 00:06:40,740
the networks or the tools let's look for

145
00:06:37,650 --> 00:06:42,719
an alternative data source if you have a

146
00:06:40,740 --> 00:06:44,789
firewall it most likely can log the

147
00:06:42,720 --> 00:06:47,639
traffic that it sees and it can send it

148
00:06:44,789 --> 00:06:49,949
to a syslog server which is just you

149
00:06:47,639 --> 00:06:51,630
know an install on any Linux so there is

150
00:06:49,949 --> 00:06:55,020
really a minimal cost in getting this

151
00:06:51,630 --> 00:06:57,539
done and if you look at it which will do

152
00:06:55,020 --> 00:06:59,789
you can then get to you know we're a

153
00:06:57,539 --> 00:07:01,889
commercial tool or even open source tool

154
00:06:59,789 --> 00:07:05,340
can get you you can get yourself with

155
00:07:01,889 --> 00:07:07,830
just a little bit of creativity for the

156
00:07:05,340 --> 00:07:10,500
critical business processes if you a

157
00:07:07,830 --> 00:07:11,140
nice at least like let's say 12 to 18

158
00:07:10,500 --> 00:07:12,970
months worth

159
00:07:11,140 --> 00:07:15,070
data you should probably see everything

160
00:07:12,970 --> 00:07:16,750
who if there is a process that launches

161
00:07:15,070 --> 00:07:19,210
every two years maybe we'll miss that

162
00:07:16,750 --> 00:07:20,170
right but hopefully it happens at least

163
00:07:19,210 --> 00:07:22,810
once a year

164
00:07:20,170 --> 00:07:24,700
so you can document that if you don't

165
00:07:22,810 --> 00:07:26,890
have a tool you need to write your own

166
00:07:24,700 --> 00:07:29,800
right and obviously a PHP is the tool of

167
00:07:26,890 --> 00:07:32,620
choice for everybody I do want to give a

168
00:07:29,800 --> 00:07:35,080
shout out to my buddy mark Montgomery

169
00:07:32,620 --> 00:07:37,180
least to always argue whether Python or

170
00:07:35,080 --> 00:07:39,490
PHP is better for this task

171
00:07:37,180 --> 00:07:43,090
he was obviously wrong with Python PHP

172
00:07:39,490 --> 00:07:45,280
is the the better choice and as you have

173
00:07:43,090 --> 00:07:47,260
too much data you just need to focus on

174
00:07:45,280 --> 00:07:50,799
what is the bare minimum of data that I

175
00:07:47,260 --> 00:07:52,210
need to make the determination and then

176
00:07:50,800 --> 00:07:56,110
just get rid of the rest you cannot boil

177
00:07:52,210 --> 00:07:58,690
the ocean right to get time what you may

178
00:07:56,110 --> 00:08:01,210
try to do is you know Friday 3:00 p.m.

179
00:07:58,690 --> 00:08:02,830
the last two hours in your workday let's

180
00:08:01,210 --> 00:08:05,349
be honest you know nobody really does

181
00:08:02,830 --> 00:08:07,450
all that much productive work what if

182
00:08:05,350 --> 00:08:09,130
you make it any or rnd time like

183
00:08:07,450 --> 00:08:11,440
research and development and you just

184
00:08:09,130 --> 00:08:13,120
say okay I'm officially of work I'm

185
00:08:11,440 --> 00:08:18,700
working on this and you know building

186
00:08:13,120 --> 00:08:20,950
something so when we are done we hope

187
00:08:18,700 --> 00:08:23,110
that nothing breaks right we know our

188
00:08:20,950 --> 00:08:24,789
outbound traffic IP and port

189
00:08:23,110 --> 00:08:26,380
combinations that may include some

190
00:08:24,790 --> 00:08:29,770
agents or a business-to-business

191
00:08:26,380 --> 00:08:31,540
transactions call homes for everything

192
00:08:29,770 --> 00:08:33,189
else that you cannot easily control like

193
00:08:31,540 --> 00:08:36,130
well because how do you filter web right

194
00:08:33,190 --> 00:08:39,220
you need to allow that to people you can

195
00:08:36,130 --> 00:08:42,539
channel them through a proxy like Cisco

196
00:08:39,220 --> 00:08:44,860
ironport or squid proxy a Bluecoat

197
00:08:42,539 --> 00:08:46,870
because if you do that gives you an

198
00:08:44,860 --> 00:08:48,340
inspection point right and you can get

199
00:08:46,870 --> 00:08:51,430
additional capability like domain

200
00:08:48,340 --> 00:08:53,530
reputation and stuff like that also you

201
00:08:51,430 --> 00:08:55,329
may be wondering well you know it

202
00:08:53,530 --> 00:08:58,240
doesn't apply to me because we are cloud

203
00:08:55,330 --> 00:08:59,980
only organization okay well you still

204
00:08:58,240 --> 00:09:02,860
have a parameter right you probably have

205
00:08:59,980 --> 00:09:04,990
some servers that are or information at

206
00:09:02,860 --> 00:09:08,470
least that is sensitive and it would be

207
00:09:04,990 --> 00:09:09,940
a bad day if it works out the method

208
00:09:08,470 --> 00:09:11,950
will be different but it's really the

209
00:09:09,940 --> 00:09:14,950
same you can look at what the outbound

210
00:09:11,950 --> 00:09:16,690
connections are and broke everything or

211
00:09:14,950 --> 00:09:18,460
you can scale it down to a network Inc

212
00:09:16,690 --> 00:09:20,440
life if you have large enterprise and

213
00:09:18,460 --> 00:09:23,220
just like okay I cannot work our bond

214
00:09:20,440 --> 00:09:23,220
because it's just too much

215
00:09:23,710 --> 00:09:28,780
how do we get there let's find the data

216
00:09:26,030 --> 00:09:31,730
source find the most relevant stuff and

217
00:09:28,780 --> 00:09:32,750
John alluded to it in the keynote you

218
00:09:31,730 --> 00:09:34,340
need to start small

219
00:09:32,750 --> 00:09:35,990
right because there's so much data that

220
00:09:34,340 --> 00:09:38,030
he just cannot do it all at once so

221
00:09:35,990 --> 00:09:41,630
let's just test their theories and you

222
00:09:38,030 --> 00:09:44,150
know slowly roll roll it out so now

223
00:09:41,630 --> 00:09:45,980
we're getting into how to actually get

224
00:09:44,150 --> 00:09:47,660
the data like how do you go from these

225
00:09:45,980 --> 00:09:49,460
surgical concepts that yeah we should

226
00:09:47,660 --> 00:09:53,689
filter outbound traffic into actually

227
00:09:49,460 --> 00:09:57,350
getting there well let's set up a cisco

228
00:09:53,690 --> 00:10:00,620
sa firewall it sends log messages to the

229
00:09:57,350 --> 00:10:02,480
syslog server and you start to look at

230
00:10:00,620 --> 00:10:04,370
the syslog messages and you're like huh

231
00:10:02,480 --> 00:10:07,550
I don't know like is it even English

232
00:10:04,370 --> 00:10:09,440
it's just telling me something but may I

233
00:10:07,550 --> 00:10:12,620
recommend that he read the fine manual

234
00:10:09,440 --> 00:10:15,980
on Cisco's website it's going to talk

235
00:10:12,620 --> 00:10:17,870
about all of these codes and there's

236
00:10:15,980 --> 00:10:19,610
also go Google Chrome web site that you

237
00:10:17,870 --> 00:10:23,390
know if you know it knows everything you

238
00:10:19,610 --> 00:10:25,580
can find all your answers there then you

239
00:10:23,390 --> 00:10:27,530
start looking at the manual from Cisco

240
00:10:25,580 --> 00:10:29,810
and you're like yeah that's that's worse

241
00:10:27,530 --> 00:10:31,910
than CSSP book on reading she's just not

242
00:10:29,810 --> 00:10:33,829
doing it today right when you look at

243
00:10:31,910 --> 00:10:35,510
your syslog server then you realize

244
00:10:33,830 --> 00:10:38,270
there are a hundred different SA codes

245
00:10:35,510 --> 00:10:39,590
each hour and you're like okay you must

246
00:10:38,270 --> 00:10:44,780
be smoking something that you are not

247
00:10:39,590 --> 00:10:46,310
sharing so what you can do is again

248
00:10:44,780 --> 00:10:48,170
you're coming to it call like you don't

249
00:10:46,310 --> 00:10:50,390
really know how it looks

250
00:10:48,170 --> 00:10:52,459
so let's plant a needle in the haystack

251
00:10:50,390 --> 00:10:54,319
right let's generate an unbound

252
00:10:52,460 --> 00:10:56,990
connection from our premise into the

253
00:10:54,320 --> 00:10:59,720
club so there's a beautiful shade of

254
00:10:56,990 --> 00:11:01,820
posted yellow is a Cali living in a

255
00:10:59,720 --> 00:11:04,430
cloud and there is a netcat listener

256
00:11:01,820 --> 00:11:06,410
netcat is just a universal network

257
00:11:04,430 --> 00:11:10,189
connectivity tool that you can do cool

258
00:11:06,410 --> 00:11:12,290
things with the baby blue color

259
00:11:10,190 --> 00:11:15,830
it's our ultra secure windows millennium

260
00:11:12,290 --> 00:11:18,980
that lives on premises right and no

261
00:11:15,830 --> 00:11:20,120
smelly but if you have it you know I

262
00:11:18,980 --> 00:11:23,480
don't know you know if netiquette works

263
00:11:20,120 --> 00:11:26,060
on it so you make the connection or

264
00:11:23,480 --> 00:11:28,880
bound connect to the IP you send some

265
00:11:26,060 --> 00:11:32,540
text so you can generate traffic and you

266
00:11:28,880 --> 00:11:34,520
close the connection next you go to your

267
00:11:32,540 --> 00:11:35,480
sis log server and now you know the time

268
00:11:34,520 --> 00:11:37,459
and you did it so you

269
00:11:35,480 --> 00:11:39,560
and narrow down you know into a small

270
00:11:37,459 --> 00:11:41,420
window and you know that you you

271
00:11:39,560 --> 00:11:42,469
connected to port for four four four so

272
00:11:41,420 --> 00:11:44,149
hopefully you don't see too many

273
00:11:42,470 --> 00:11:46,880
connections that's the Metasploit

274
00:11:44,149 --> 00:11:50,720
default port hopefully you find only

275
00:11:46,880 --> 00:11:51,800
yours and now we are getting into the

276
00:11:50,720 --> 00:11:53,630
like is this even English

277
00:11:51,800 --> 00:11:56,750
just like wall of tags doesn't make any

278
00:11:53,630 --> 00:11:57,980
sense if you read a little bit it's

279
00:11:56,750 --> 00:12:00,320
starting in the connection was built

280
00:11:57,980 --> 00:12:03,260
outbound you see the IP and the port we

281
00:12:00,320 --> 00:12:04,970
connected to and from which there is

282
00:12:03,260 --> 00:12:07,970
some connection ID that will be helpful

283
00:12:04,970 --> 00:12:10,220
later you get another hit on that search

284
00:12:07,970 --> 00:12:13,130
and that is the when the connection was

285
00:12:10,220 --> 00:12:15,199
destroyed when it was terminated this

286
00:12:13,130 --> 00:12:16,730
one tells you how long it lasted how

287
00:12:15,199 --> 00:12:21,079
many bytes were transferred and other

288
00:12:16,730 --> 00:12:24,740
stuff this is the reference from this is

289
00:12:21,079 --> 00:12:26,239
a manual and they explained each of the

290
00:12:24,740 --> 00:12:29,630
field like what it actually means so it

291
00:12:26,240 --> 00:12:32,389
make it easier this slide is really just

292
00:12:29,630 --> 00:12:33,829
the same just helping in visualize your

293
00:12:32,389 --> 00:12:36,230
internal network with Windows millennium

294
00:12:33,829 --> 00:12:38,359
going out through the internal interface

295
00:12:36,230 --> 00:12:41,000
into the external interface and out into

296
00:12:38,360 --> 00:12:43,790
the cloud so this was the posted yellow

297
00:12:41,000 --> 00:12:47,360
baby blue and the walk message is

298
00:12:43,790 --> 00:12:49,670
generated in here before you start

299
00:12:47,360 --> 00:12:51,380
jumping to conclusions that now you know

300
00:12:49,670 --> 00:12:53,899
what to look for how does the log data

301
00:12:51,380 --> 00:12:55,310
look like I would recommend that you

302
00:12:53,899 --> 00:12:57,350
test your theories just to make sure

303
00:12:55,310 --> 00:12:59,029
that it's correct right so let's

304
00:12:57,350 --> 00:13:01,790
generate some inbound traffic which is

305
00:12:59,029 --> 00:13:05,060
we just switch the roles Kali is living

306
00:13:01,790 --> 00:13:06,439
in the DMZ on our organization and in

307
00:13:05,060 --> 00:13:08,329
the cloud we have in those millennium

308
00:13:06,440 --> 00:13:10,880
connecting to the DMZ so this will be in

309
00:13:08,329 --> 00:13:14,329
bulk connection for us what's in some

310
00:13:10,880 --> 00:13:18,050
traffic and look at the log at the

311
00:13:14,329 --> 00:13:19,760
syslog server you can cannot see that

312
00:13:18,050 --> 00:13:21,560
the message rule is the same there is

313
00:13:19,760 --> 00:13:23,389
one subtle difference and that the

314
00:13:21,560 --> 00:13:25,849
connection was built in bound but the

315
00:13:23,389 --> 00:13:27,709
order and like the IPS and stuff it's

316
00:13:25,850 --> 00:13:29,300
pretty much the same so that's a little

317
00:13:27,709 --> 00:13:30,589
bit of a challenge because if the third

318
00:13:29,300 --> 00:13:32,630
our connection doesn't tell you the

319
00:13:30,589 --> 00:13:36,260
direction you cannot introduce some

320
00:13:32,630 --> 00:13:40,430
magic behind the scenes to get that this

321
00:13:36,260 --> 00:13:43,430
is again the same visualization some

322
00:13:40,430 --> 00:13:45,680
other things to test what does that look

323
00:13:43,430 --> 00:13:46,670
like on the UDP side what if you know

324
00:13:45,680 --> 00:13:49,790
like is it

325
00:13:46,670 --> 00:13:51,650
is a code is a different what if you

326
00:13:49,790 --> 00:13:54,530
have a rule that blocks the traffic on

327
00:13:51,650 --> 00:13:57,410
the firewall and how does that

328
00:13:54,530 --> 00:14:01,930
connection look like or a syslog message

329
00:13:57,410 --> 00:14:04,069
or if the IP doesn't exist right so I

330
00:14:01,930 --> 00:14:05,660
already mentioned there are the allowed

331
00:14:04,070 --> 00:14:07,490
at a-- to parse through and you are

332
00:14:05,660 --> 00:14:09,589
building a homegrown script so you don't

333
00:14:07,490 --> 00:14:11,150
have an enterprise class tool you need

334
00:14:09,590 --> 00:14:12,680
to really minimize what you call like

335
00:14:11,150 --> 00:14:16,640
just get the bare minimum that you need

336
00:14:12,680 --> 00:14:19,189
and the the messages have most the same

337
00:14:16,640 --> 00:14:20,870
information so which one do you get you

338
00:14:19,190 --> 00:14:23,810
get the built out or the teardown

339
00:14:20,870 --> 00:14:26,330
message you're going to get both because

340
00:14:23,810 --> 00:14:28,640
the built out has direction and the

341
00:14:26,330 --> 00:14:30,950
teardown does not but the teardown will

342
00:14:28,640 --> 00:14:33,650
tell you was the connection successful

343
00:14:30,950 --> 00:14:34,660
how many bytes were transferred how long

344
00:14:33,650 --> 00:14:38,150
did it last

345
00:14:34,660 --> 00:14:39,500
and if you get only one you know where

346
00:14:38,150 --> 00:14:40,970
do you get the time from the any shock

347
00:14:39,500 --> 00:14:44,600
on it when it was built or when it was

348
00:14:40,970 --> 00:14:45,980
turned down so I don't recommend you

349
00:14:44,600 --> 00:14:48,260
collect both of them because there's

350
00:14:45,980 --> 00:14:50,240
duplicating the amount of data and how

351
00:14:48,260 --> 00:14:51,230
you can actually parse it now we're

352
00:14:50,240 --> 00:14:53,120
getting a little bit into the

353
00:14:51,230 --> 00:14:56,690
implementation details and again the

354
00:14:53,120 --> 00:14:59,300
notes go into great detail in more

355
00:14:56,690 --> 00:15:00,860
concepts behind this as you parse your

356
00:14:59,300 --> 00:15:04,550
sis locks looking for outbound

357
00:15:00,860 --> 00:15:06,140
connections let's build an array or

358
00:15:04,550 --> 00:15:08,689
associative array it's called a

359
00:15:06,140 --> 00:15:10,910
dictionary in Python and you're looking

360
00:15:08,690 --> 00:15:12,260
for connections crossing the external

361
00:15:10,910 --> 00:15:14,630
interface because you don't need

362
00:15:12,260 --> 00:15:17,150
internal to DMZ that's outbound as well

363
00:15:14,630 --> 00:15:21,560
from inside to DMZ but that's still your

364
00:15:17,150 --> 00:15:23,240
network hopefully so you build the art

365
00:15:21,560 --> 00:15:25,040
bound and you use the connection ID as

366
00:15:23,240 --> 00:15:27,530
the key in the array and then you read

367
00:15:25,040 --> 00:15:29,630
all the teardown messages again using

368
00:15:27,530 --> 00:15:31,910
the connection ID and then you can call

369
00:15:29,630 --> 00:15:33,950
what's called an array intersect where

370
00:15:31,910 --> 00:15:37,310
essentially it takes the two arrays and

371
00:15:33,950 --> 00:15:39,080
it will crop the larger one leaving only

372
00:15:37,310 --> 00:15:41,630
the elements that are in the smaller one

373
00:15:39,080 --> 00:15:44,030
so you're going to get the teardown more

374
00:15:41,630 --> 00:15:49,160
valuable information but only those that

375
00:15:44,030 --> 00:15:51,230
are are bound the unique key in these

376
00:15:49,160 --> 00:15:53,449
connections you know pair the

377
00:15:51,230 --> 00:15:56,330
documentation it should be unique but I

378
00:15:53,450 --> 00:15:58,220
did figure out there was an obviously

379
00:15:56,330 --> 00:16:00,140
inbound connection in my data set for

380
00:15:58,220 --> 00:16:02,390
outbound only and I was

381
00:16:00,140 --> 00:16:04,189
wondering where I made a mistake so when

382
00:16:02,390 --> 00:16:06,650
I looked at the log files I realized

383
00:16:04,190 --> 00:16:08,570
that I had a TCP and UDP connection with

384
00:16:06,650 --> 00:16:10,579
the same connection ID which wasn't

385
00:16:08,570 --> 00:16:12,410
problem for the firewall because it

386
00:16:10,580 --> 00:16:13,940
keeps it separate night but it was

387
00:16:12,410 --> 00:16:16,219
problem for my script because I just

388
00:16:13,940 --> 00:16:19,550
picked up the teardown message for the

389
00:16:16,220 --> 00:16:21,710
inbound or the outbound so to combat

390
00:16:19,550 --> 00:16:26,359
that you can add the protocol into the

391
00:16:21,710 --> 00:16:28,460
connection ID as the key there is always

392
00:16:26,360 --> 00:16:30,200
the source and destination interface and

393
00:16:28,460 --> 00:16:31,640
if you ever work the firewall ticket you

394
00:16:30,200 --> 00:16:34,100
know that people just don't get those

395
00:16:31,640 --> 00:16:36,170
straight it's for some reason it's

396
00:16:34,100 --> 00:16:38,090
confusing right but then if you look at

397
00:16:36,170 --> 00:16:39,709
the syslog message which one is the

398
00:16:38,090 --> 00:16:42,140
source which one is the destination and

399
00:16:39,710 --> 00:16:44,480
is it the same for inbound and outbound

400
00:16:42,140 --> 00:16:46,460
would you imagine that the in bonnet and

401
00:16:44,480 --> 00:16:49,310
bonnets does it switch the position or

402
00:16:46,460 --> 00:16:51,260
not in this capsule it does not for

403
00:16:49,310 --> 00:16:54,500
outbound the first one is destination

404
00:16:51,260 --> 00:16:57,800
and the second one is source and for

405
00:16:54,500 --> 00:16:59,360
inbound it's the other way but it's not

406
00:16:57,800 --> 00:17:01,520
even important right now because you're

407
00:16:59,360 --> 00:17:03,380
just carving out the data and you can

408
00:17:01,520 --> 00:17:05,240
call it interface 1 and interface to

409
00:17:03,380 --> 00:17:07,160
write and then build some logic later on

410
00:17:05,240 --> 00:17:09,170
after you figure out what it is because

411
00:17:07,160 --> 00:17:11,570
if you start calling it source now in

412
00:17:09,170 --> 00:17:13,310
your script and data set and it's the

413
00:17:11,569 --> 00:17:14,510
destination then guess what you need to

414
00:17:13,310 --> 00:17:20,359
go and change all of it right

415
00:17:14,510 --> 00:17:22,579
a prototype use 64-bit because you go

416
00:17:20,359 --> 00:17:27,290
over for 32-bit architecture pretty

417
00:17:22,579 --> 00:17:30,500
easily 4.2 billion is not enough we do

418
00:17:27,290 --> 00:17:32,810
have some tips on parsing actually and

419
00:17:30,500 --> 00:17:35,060
this is you know this is not a PHP talk

420
00:17:32,810 --> 00:17:36,500
so there are just some function you can

421
00:17:35,060 --> 00:17:39,020
use the programming language of your

422
00:17:36,500 --> 00:17:41,210
choice look for an alternative in there

423
00:17:39,020 --> 00:17:42,920
or similar function this is some tips

424
00:17:41,210 --> 00:17:47,120
how you can extract the data out of the

425
00:17:42,920 --> 00:17:50,270
the syslog you are now carving out the

426
00:17:47,120 --> 00:17:51,080
data and you are just getting IP address

427
00:17:50,270 --> 00:17:53,090
and a port

428
00:17:51,080 --> 00:17:54,949
well can you enrich that right because

429
00:17:53,090 --> 00:17:57,649
IP address doesn't like tell us anything

430
00:17:54,950 --> 00:17:59,000
so you can do some s and and who is

431
00:17:57,650 --> 00:18:01,220
lookup and geolocation

432
00:17:59,000 --> 00:18:02,900
you figure out who owns the IP because

433
00:18:01,220 --> 00:18:04,820
that may be interesting like are we

434
00:18:02,900 --> 00:18:08,300
talking to the Czech Republic and for

435
00:18:04,820 --> 00:18:11,240
what reason you can also do NS lookups

436
00:18:08,300 --> 00:18:13,139
on those IPs just be mindful that if you

437
00:18:11,240 --> 00:18:15,780
resolve

438
00:18:13,140 --> 00:18:18,420
DNS name that's unique to you in a

439
00:18:15,780 --> 00:18:20,250
campaign by an adversary it may tip them

440
00:18:18,420 --> 00:18:22,200
off then you know about them right so

441
00:18:20,250 --> 00:18:25,260
but you know it's nice to know the

442
00:18:22,200 --> 00:18:27,840
domains regarding the data and just you

443
00:18:25,260 --> 00:18:30,150
know you have the date time but how do

444
00:18:27,840 --> 00:18:31,830
you run queries on show me all outbound

445
00:18:30,150 --> 00:18:32,250
traffic to port four four four that

446
00:18:31,830 --> 00:18:34,830
happen

447
00:18:32,250 --> 00:18:36,840
every second Thursday in a month you

448
00:18:34,830 --> 00:18:39,419
would have to go through essentially all

449
00:18:36,840 --> 00:18:41,939
the timestamps carve out the Thursday's

450
00:18:39,420 --> 00:18:44,070
that's every second and then it will be

451
00:18:41,940 --> 00:18:46,500
really slow so I just split the data and

452
00:18:44,070 --> 00:18:48,870
say okay this date was Thursday at this

453
00:18:46,500 --> 00:18:54,330
hour this day of the month and this

454
00:18:48,870 --> 00:18:57,209
makes the querying of the data faster as

455
00:18:54,330 --> 00:18:59,460
I said there'll be a lot of data so you

456
00:18:57,210 --> 00:19:02,220
realize pretty soon that you cannot keep

457
00:18:59,460 --> 00:19:04,140
up by doing the the information

458
00:19:02,220 --> 00:19:07,380
enhancement because one thing is taking

459
00:19:04,140 --> 00:19:09,870
even large volume of data extracted

460
00:19:07,380 --> 00:19:11,520
information saving in a database the

461
00:19:09,870 --> 00:19:14,189
other thing is if you start doing whois

462
00:19:11,520 --> 00:19:16,590
lookup and DNS lookups all of sudden you

463
00:19:14,190 --> 00:19:19,080
go from nanoseconds to milliseconds or

464
00:19:16,590 --> 00:19:22,169
maybe more times hundreds of thousands

465
00:19:19,080 --> 00:19:24,449
lines or millions of lines and II my

466
00:19:22,170 --> 00:19:27,510
initial iteration of the script was

467
00:19:24,450 --> 00:19:30,030
going slower than the real time so I was

468
00:19:27,510 --> 00:19:31,860
like okay I will never catch up so I

469
00:19:30,030 --> 00:19:34,110
changed it at I just extract the data

470
00:19:31,860 --> 00:19:37,919
and then run a second script that parses

471
00:19:34,110 --> 00:19:39,750
that and does the enrichment also as I

472
00:19:37,920 --> 00:19:42,780
said you just cannot do it all at once

473
00:19:39,750 --> 00:19:45,150
so let's look at the Chettiars protocols

474
00:19:42,780 --> 00:19:47,010
probably DNS and web will be most of

475
00:19:45,150 --> 00:19:49,290
your traffic leaving your organization

476
00:19:47,010 --> 00:19:50,340
well I'll just ignore that maybe you

477
00:19:49,290 --> 00:19:53,670
have the proxy that it goes through

478
00:19:50,340 --> 00:19:56,399
maybe not you know we can get to it at

479
00:19:53,670 --> 00:19:59,070
some later point but it's just too much

480
00:19:56,400 --> 00:20:00,840
data so let's get rid of that you may

481
00:19:59,070 --> 00:20:03,600
have some cloud presence and you have

482
00:20:00,840 --> 00:20:05,639
on-premise scanner so it does a port

483
00:20:03,600 --> 00:20:07,679
scan and guess what you see you know all

484
00:20:05,640 --> 00:20:09,360
the ports being hit outside is it all

485
00:20:07,680 --> 00:20:11,700
needed no no it's just this kind of

486
00:20:09,360 --> 00:20:13,919
doing its job so if you know what IP

487
00:20:11,700 --> 00:20:16,530
address that has was just not collect

488
00:20:13,920 --> 00:20:19,380
the data and if you know about the

489
00:20:16,530 --> 00:20:21,420
transactions then you should definitely

490
00:20:19,380 --> 00:20:24,000
not collect those because if it's non

491
00:20:21,420 --> 00:20:26,840
good then it should be allowed and you

492
00:20:24,000 --> 00:20:30,000
don't have to worry about it

493
00:20:26,840 --> 00:20:31,590
just a simple ignore lace the first line

494
00:20:30,000 --> 00:20:35,790
really says you know if the protocol is

495
00:20:31,590 --> 00:20:38,879
TCP or UDP and the port is 84 43 or 53

496
00:20:35,790 --> 00:20:42,470
so that's when DNS I don't care I'm not

497
00:20:38,880 --> 00:20:46,260
collecting the data just drop that line

498
00:20:42,470 --> 00:20:48,690
so to put it all together you need to go

499
00:20:46,260 --> 00:20:50,879
and get the syslog file from the syslog

500
00:20:48,690 --> 00:20:52,590
server and syslog usually rolls every

501
00:20:50,880 --> 00:20:54,300
hour and then at the end of the day it

502
00:20:52,590 --> 00:20:56,610
compresses the data I move them to a

503
00:20:54,300 --> 00:20:58,649
different folder so I start my script

504
00:20:56,610 --> 00:21:01,020
than 1 a.m. to give the syslog time to

505
00:20:58,650 --> 00:21:04,050
do whatever it needs to do I collect the

506
00:21:01,020 --> 00:21:06,420
data parse it find the unbound

507
00:21:04,050 --> 00:21:09,690
connections extract the IPS and save it

508
00:21:06,420 --> 00:21:12,240
do some enrichment and now it's time for

509
00:21:09,690 --> 00:21:15,270
you to shine by building a cheesy web

510
00:21:12,240 --> 00:21:17,940
GUI and you know I'm not a graphical

511
00:21:15,270 --> 00:21:20,400
designer or web developer I'm scriptor

512
00:21:17,940 --> 00:21:23,100
mr. my escapes work I didn't have to

513
00:21:20,400 --> 00:21:24,840
look pretty but this gives you because

514
00:21:23,100 --> 00:21:26,730
now we have the data all outbound

515
00:21:24,840 --> 00:21:28,649
connections well how do you search

516
00:21:26,730 --> 00:21:32,340
through it so you can search by source

517
00:21:28,650 --> 00:21:36,170
or destination IP or by the protocol you

518
00:21:32,340 --> 00:21:39,720
may not know what to really search for

519
00:21:36,170 --> 00:21:41,580
there's a filter for date because again

520
00:21:39,720 --> 00:21:43,770
if you call it for a long time you will

521
00:21:41,580 --> 00:21:45,840
have large data sets you can put some

522
00:21:43,770 --> 00:21:49,440
tips how to use it how to use wildcards

523
00:21:45,840 --> 00:21:52,040
and then you present the users with

524
00:21:49,440 --> 00:21:54,630
results right so this actually line is

525
00:21:52,040 --> 00:21:56,610
discussing or showing the connection we

526
00:21:54,630 --> 00:21:59,160
made from our Windows ME host to the

527
00:21:56,610 --> 00:22:00,659
callee and you now see the data

528
00:21:59,160 --> 00:22:04,980
enrichment because previously we just

529
00:22:00,660 --> 00:22:06,570
seen the IP 100 777 but now we know it's

530
00:22:04,980 --> 00:22:09,210
a cloud provider in Texas

531
00:22:06,570 --> 00:22:10,950
ok kind of good we also know that the

532
00:22:09,210 --> 00:22:12,720
source was the Windows millennium host

533
00:22:10,950 --> 00:22:14,820
so that kind of tells you ok I know what

534
00:22:12,720 --> 00:22:16,170
to look and you know that data has been

535
00:22:14,820 --> 00:22:19,580
transferred so that kind of tells you

536
00:22:16,170 --> 00:22:22,020
well did we just lose some data right

537
00:22:19,580 --> 00:22:23,939
then you start looking for other for for

538
00:22:22,020 --> 00:22:26,730
for traffic and you may find other

539
00:22:23,940 --> 00:22:29,070
interesting things like for example your

540
00:22:26,730 --> 00:22:30,750
pwned host on your domain is talking to

541
00:22:29,070 --> 00:22:33,659
the Czech Republic and the company name

542
00:22:30,750 --> 00:22:36,810
happens to be hackers for rent so do you

543
00:22:33,660 --> 00:22:38,520
have a problem right you can find

544
00:22:36,810 --> 00:22:39,580
another data set and that's just telling

545
00:22:38,520 --> 00:22:41,530
you that

546
00:22:39,580 --> 00:22:47,620
somebody in Oklahoma was not successful

547
00:22:41,530 --> 00:22:49,149
we all know you know oh you sucks and

548
00:22:47,620 --> 00:22:53,379
then you can get some of the UDP traffic

549
00:22:49,150 --> 00:22:55,540
now that link description rates an excel

550
00:22:53,380 --> 00:22:57,340
file because this is for line so it's

551
00:22:55,540 --> 00:22:59,350
easy to analyze but if you get back you

552
00:22:57,340 --> 00:23:01,540
know thousands of lines you want to put

553
00:22:59,350 --> 00:23:06,820
it in Excel and do some analytics pivot

554
00:23:01,540 --> 00:23:09,550
tables and you know other things so now

555
00:23:06,820 --> 00:23:11,740
you have an interface that can query the

556
00:23:09,550 --> 00:23:14,440
data what I'm going to ask right which

557
00:23:11,740 --> 00:23:16,360
questions are going to ask suppose you

558
00:23:14,440 --> 00:23:17,920
get an indicator of compromise that says

559
00:23:16,360 --> 00:23:20,379
you know if you see this IP and the

560
00:23:17,920 --> 00:23:25,870
sport it's probably bad now if interface

561
00:23:20,380 --> 00:23:28,600
to go and look but even better is if you

562
00:23:25,870 --> 00:23:30,939
carve out the statistics then it's not

563
00:23:28,600 --> 00:23:33,610
going to help you narrow down the search

564
00:23:30,940 --> 00:23:35,890
on let's let's take we now know that web

565
00:23:33,610 --> 00:23:37,959
and DNS are just too much we are not

566
00:23:35,890 --> 00:23:41,130
looking at that let's find the next most

567
00:23:37,960 --> 00:23:47,590
shadiest protocol or destination IP and

568
00:23:41,130 --> 00:23:49,330
look into that so you I'm going to

569
00:23:47,590 --> 00:23:51,280
extract the statistics overnight because

570
00:23:49,330 --> 00:23:53,560
it takes a long time to pull from large

571
00:23:51,280 --> 00:23:55,660
data set and then you publish it to the

572
00:23:53,560 --> 00:23:58,210
user so they can do some in front

573
00:23:55,660 --> 00:24:00,670
queries on this and my initial thought

574
00:23:58,210 --> 00:24:03,490
was okay what is leaving the

575
00:24:00,670 --> 00:24:06,520
organization I'll be generous and let's

576
00:24:03,490 --> 00:24:09,400
say 200 different protocols there are 65

577
00:24:06,520 --> 00:24:11,560
thousand on TCP and UDP and then I look

578
00:24:09,400 --> 00:24:13,930
after eighteen months we are hitting

579
00:24:11,560 --> 00:24:17,649
more than half of those and just like

580
00:24:13,930 --> 00:24:20,200
what the hell is going on and then you

581
00:24:17,650 --> 00:24:22,690
see the non FTP ports FTP data that data

582
00:24:20,200 --> 00:24:25,030
channel is just extremely chatty and

583
00:24:22,690 --> 00:24:28,180
horrible and it's hitting almost all of

584
00:24:25,030 --> 00:24:29,800
those ports right on the unique

585
00:24:28,180 --> 00:24:31,450
destination IP count again these are the

586
00:24:29,800 --> 00:24:35,740
unique numbers rightful from the data

587
00:24:31,450 --> 00:24:37,210
base excluding web and DNS I think it's

588
00:24:35,740 --> 00:24:39,340
actually a pretty small number because

589
00:24:37,210 --> 00:24:41,950
over 18 months out of the four plus

590
00:24:39,340 --> 00:24:45,330
billion IP addresses you hit only 56,000

591
00:24:41,950 --> 00:24:45,330
ok that's maybe not bad

592
00:24:46,030 --> 00:24:50,139
this is really a interesting I because

593
00:24:48,430 --> 00:24:51,730
this is telling you what is the most

594
00:24:50,140 --> 00:24:54,460
common protocol that you see outbound

595
00:24:51,730 --> 00:24:56,260
and number one over there is eight four

596
00:24:54,460 --> 00:24:59,470
four three so that looks like an

597
00:24:56,260 --> 00:25:03,430
alternative web port but is it an agent

598
00:24:59,470 --> 00:25:05,460
is it you know what is that you can also

599
00:25:03,430 --> 00:25:09,070
look at it when you see the counts

600
00:25:05,460 --> 00:25:11,140
notice that like number one is quite

601
00:25:09,070 --> 00:25:13,689
ahead of number two and then number two

602
00:25:11,140 --> 00:25:16,600
and three are together but number four

603
00:25:13,690 --> 00:25:20,410
is half of number three and then you see

604
00:25:16,600 --> 00:25:24,219
the big drop-offs on the UDP side look

605
00:25:20,410 --> 00:25:27,040
at the bottom you see 16384 five and six

606
00:25:24,220 --> 00:25:28,990
and the count is almost the same it

607
00:25:27,040 --> 00:25:34,780
looks kind of interesting right and is

608
00:25:28,990 --> 00:25:36,460
number sixteen 83 or 87 so now that you

609
00:25:34,780 --> 00:25:38,860
know this you can't actually go and look

610
00:25:36,460 --> 00:25:42,040
for for clues and figure out what this

611
00:25:38,860 --> 00:25:43,689
is some other stats you may want to

612
00:25:42,040 --> 00:25:46,139
provide is you know the Chettiar source

613
00:25:43,690 --> 00:25:49,810
system so you see that you're

614
00:25:46,140 --> 00:25:51,730
conferencing audio-video systems are the

615
00:25:49,810 --> 00:25:54,490
chilliest and they are talking outbound

616
00:25:51,730 --> 00:25:55,930
and you may think like okay it lives in

617
00:25:54,490 --> 00:25:58,690
the conference room that's where we

618
00:25:55,930 --> 00:26:00,700
discuss maybe sensitive stuff and the

619
00:25:58,690 --> 00:26:04,120
thing is connecting outbound all around

620
00:26:00,700 --> 00:26:06,910
the world is that supposed to be there

621
00:26:04,120 --> 00:26:09,030
it's somebody else listening is do you

622
00:26:06,910 --> 00:26:12,430
have a member on the call let's silent

623
00:26:09,030 --> 00:26:15,160
then he can look at you know if if you

624
00:26:12,430 --> 00:26:17,140
have mobile user base and they go across

625
00:26:15,160 --> 00:26:19,750
the floors they go home they go wireless

626
00:26:17,140 --> 00:26:23,560
they keep changing IPS but one of them

627
00:26:19,750 --> 00:26:25,210
is like among the top five does it mean

628
00:26:23,560 --> 00:26:26,860
like what is it that they are doing

629
00:26:25,210 --> 00:26:30,370
right why they're so chatty where

630
00:26:26,860 --> 00:26:32,800
everybody else is not and you can see

631
00:26:30,370 --> 00:26:35,350
some servers and other stuff on the

632
00:26:32,800 --> 00:26:37,899
destination side this is what's going to

633
00:26:35,350 --> 00:26:39,520
highlight the business-to-business data

634
00:26:37,900 --> 00:26:41,530
exchanges that you may want to pay

635
00:26:39,520 --> 00:26:45,970
attention to if they use non-standard

636
00:26:41,530 --> 00:26:49,060
port you can also see that there is a

637
00:26:45,970 --> 00:26:50,950
lot of cloud traffic because everybody

638
00:26:49,060 --> 00:26:52,600
is in the cloud and so there is a cloud

639
00:26:50,950 --> 00:26:55,240
9 provider that you know we seemed to

640
00:26:52,600 --> 00:26:57,490
hit quite often your guess as to which

641
00:26:55,240 --> 00:27:01,750
cloud provider that is

642
00:26:57,490 --> 00:27:03,820
I also like to look at the other end of

643
00:27:01,750 --> 00:27:07,029
the statistic analysis so I looked at

644
00:27:03,820 --> 00:27:09,490
which ports and IPS were connected to

645
00:27:07,029 --> 00:27:12,610
her head just once or up to three times

646
00:27:09,490 --> 00:27:15,399
and the data is actually pretty

647
00:27:12,610 --> 00:27:19,299
interesting because on the UDP side we

648
00:27:15,399 --> 00:27:22,629
had 33,000 unique UDP ports but a third

649
00:27:19,299 --> 00:27:24,220
of those has been hit just once what the

650
00:27:22,630 --> 00:27:26,309
hell is that right that just doesn't

651
00:27:24,220 --> 00:27:29,770
make any sense

652
00:27:26,309 --> 00:27:32,980
and then if you look at the destination

653
00:27:29,770 --> 00:27:34,779
IP is we had 56,000 so that's a little

654
00:27:32,980 --> 00:27:39,730
bit over half that's been hit just once

655
00:27:34,779 --> 00:27:44,620
so what is that some conclusions on the

656
00:27:39,730 --> 00:27:46,690
statistics we do have the the bad sorry

657
00:27:44,620 --> 00:27:49,719
the good is you know relatively small

658
00:27:46,690 --> 00:27:51,399
number of IPs the bet is that we hit

659
00:27:49,720 --> 00:27:55,750
half of the ports so there'll be no easy

660
00:27:51,399 --> 00:27:57,158
deny and the ugly of course that's the

661
00:27:55,750 --> 00:28:00,039
FTP right because it's just horrible

662
00:27:57,159 --> 00:28:02,409
protocol but also those 11,000 UDP ports

663
00:28:00,039 --> 00:28:04,390
that were he just wants I just hope that

664
00:28:02,409 --> 00:28:07,120
it's one source IP that's responsible I

665
00:28:04,390 --> 00:28:11,799
mean I can find it otherwise good luck

666
00:28:07,120 --> 00:28:18,010
chasing that down this is also important

667
00:28:11,799 --> 00:28:20,230
I told you sorry I told you how you can

668
00:28:18,010 --> 00:28:21,789
get the data and you know that port

669
00:28:20,230 --> 00:28:24,390
eight four four four was your number one

670
00:28:21,789 --> 00:28:27,129
well what is that how do you get there

671
00:28:24,390 --> 00:28:30,220
if you have a network tab on your

672
00:28:27,130 --> 00:28:32,289
parameter you can build some VPS filters

673
00:28:30,220 --> 00:28:35,080
and run TCP dump and look for that

674
00:28:32,289 --> 00:28:36,700
traffic and then waiting collect that

675
00:28:35,080 --> 00:28:38,980
you can use Wireshark because it is

676
00:28:36,700 --> 00:28:41,169
protocol analyzers and you can really

677
00:28:38,980 --> 00:28:44,080
figure out what it is if you don't have

678
00:28:41,169 --> 00:28:46,059
that visibility or to augment that you

679
00:28:44,080 --> 00:28:48,428
can also use endpoint detection and

680
00:28:46,059 --> 00:28:50,200
response tools like a carbon block for

681
00:28:48,429 --> 00:28:52,090
example or something else that can tell

682
00:28:50,200 --> 00:28:54,220
you which process made that connection

683
00:28:52,090 --> 00:28:57,000
if it is you know War II acts II

684
00:28:54,220 --> 00:28:59,890
probably okay if it is checksum dot exe

685
00:28:57,000 --> 00:29:01,390
perhaps you wanna look into that and if

686
00:28:59,890 --> 00:29:04,120
you don't have tools like that you can

687
00:29:01,390 --> 00:29:05,710
just use the native logging on the OS so

688
00:29:04,120 --> 00:29:07,870
Windows seven nineteen fifty one fifty

689
00:29:05,710 --> 00:29:10,930
six you can collect that and extract the

690
00:29:07,870 --> 00:29:13,120
data or turn it on Linux auditing

691
00:29:10,930 --> 00:29:14,740
you can also think about you have a work

692
00:29:13,120 --> 00:29:17,050
station that sends interesting traffic

693
00:29:14,740 --> 00:29:18,880
well you can set up man-in-the-middle or

694
00:29:17,050 --> 00:29:20,590
use burp if you have local you know

695
00:29:18,880 --> 00:29:23,740
configuration if it's maybe web traffic

696
00:29:20,590 --> 00:29:25,929
and then you can see what's going on and

697
00:29:23,740 --> 00:29:27,610
let's not forget it you can also talk to

698
00:29:25,930 --> 00:29:29,440
the user right like you can be like hey

699
00:29:27,610 --> 00:29:31,689
I see interesting traffic coming out of

700
00:29:29,440 --> 00:29:34,780
your work station can you tell me a

701
00:29:31,690 --> 00:29:38,680
little bit more about that as you go and

702
00:29:34,780 --> 00:29:40,780
do this analysis I recommended you take

703
00:29:38,680 --> 00:29:44,470
notes right and I put it on the website

704
00:29:40,780 --> 00:29:46,120
as well where if somebody is looking at

705
00:29:44,470 --> 00:29:48,220
the eight four four three and nine five

706
00:29:46,120 --> 00:29:50,830
seven three those were like two in the

707
00:29:48,220 --> 00:29:53,950
top five that actually happens to be

708
00:29:50,830 --> 00:29:56,439
WebSockets so when you visit like you

709
00:29:53,950 --> 00:29:58,770
know the go.com domain for ABC and

710
00:29:56,440 --> 00:30:02,080
affiliates like ESPN and everything else

711
00:29:58,770 --> 00:30:05,440
you may connect your web proxy on port

712
00:30:02,080 --> 00:30:09,100
443 but then there is a WebSocket

713
00:30:05,440 --> 00:30:11,830
channel open on port 80 443 and that's

714
00:30:09,100 --> 00:30:13,480
quite chatting now does your web proxy

715
00:30:11,830 --> 00:30:15,699
understand that is it going through it

716
00:30:13,480 --> 00:30:16,720
do you have any visibility because you

717
00:30:15,700 --> 00:30:18,640
have one connection that's maybe

718
00:30:16,720 --> 00:30:24,070
filtered and inspected and the other one

719
00:30:18,640 --> 00:30:25,510
you know who knows the the Cisco these

720
00:30:24,070 --> 00:30:28,419
are all access koba backs

721
00:30:25,510 --> 00:30:31,570
ports the conferencing equipment in your

722
00:30:28,420 --> 00:30:32,950
conference room that's why you see so

723
00:30:31,570 --> 00:30:36,370
many of those ports they're all tied

724
00:30:32,950 --> 00:30:39,730
into that and again I would say okay if

725
00:30:36,370 --> 00:30:41,679
I know if I understand what it is and I

726
00:30:39,730 --> 00:30:44,230
know that I need that then I can allow

727
00:30:41,680 --> 00:30:46,720
that on the firewall and remove it from

728
00:30:44,230 --> 00:30:48,670
my data collection and then drops the

729
00:30:46,720 --> 00:30:49,720
volume that we are collecting and if you

730
00:30:48,670 --> 00:30:54,360
know that you don't need it and you just

731
00:30:49,720 --> 00:30:59,230
block it and also stop start ignoring it

732
00:30:54,360 --> 00:31:01,600
the Teredo protocol you may have an

733
00:30:59,230 --> 00:31:05,350
organization that says you know we don't

734
00:31:01,600 --> 00:31:06,280
do ipv6 but Shay who rose ipv6

735
00:31:05,350 --> 00:31:08,560
intentionally

736
00:31:06,280 --> 00:31:10,450
hardly anybody right but yeah you all

737
00:31:08,560 --> 00:31:13,960
row i p v6 without you knowing that

738
00:31:10,450 --> 00:31:16,000
because it's just there and microsoft

739
00:31:13,960 --> 00:31:17,220
has the tunneling protocol that is using

740
00:31:16,000 --> 00:31:21,700
for UDP

741
00:31:17,220 --> 00:31:23,730
34 40 35 44 and it talks outside and is

742
00:31:21,700 --> 00:31:26,250
looking for ipv6 routers

743
00:31:23,730 --> 00:31:30,120
and ipv6 route is typically preferred by

744
00:31:26,250 --> 00:31:32,580
the OS over ipv4 so you may set up all

745
00:31:30,120 --> 00:31:33,540
your controls in here and your systems

746
00:31:32,580 --> 00:31:36,270
are going through there

747
00:31:33,540 --> 00:31:40,850
do you have visibility in IPS or ideas

748
00:31:36,270 --> 00:31:40,850
and then you find some other weird stuff

749
00:31:41,210 --> 00:31:46,950
so as you go through this again your

750
00:31:45,150 --> 00:31:48,660
goal is to filter everything out bound

751
00:31:46,950 --> 00:31:50,790
so the first step is knowing what you

752
00:31:48,660 --> 00:31:53,940
have as you go through the exercise of

753
00:31:50,790 --> 00:31:56,370
figuring it out you find port 8 4 4 4

754
00:31:53,940 --> 00:31:59,880
maybe it's WebSockets running through

755
00:31:56,370 --> 00:32:02,820
the proxy and block it and it's topic

756
00:31:59,880 --> 00:32:04,260
stop collecting it in here if it's a non

757
00:32:02,820 --> 00:32:05,520
bed and you don't just create a block

758
00:32:04,260 --> 00:32:07,920
Lior to denialist

759
00:32:05,520 --> 00:32:09,570
and maybe you want to investigate why is

760
00:32:07,920 --> 00:32:12,570
it making that is it just a call home

761
00:32:09,570 --> 00:32:14,520
that you don't need or is it some pre

762
00:32:12,570 --> 00:32:20,939
compromised docker image that it's

763
00:32:14,520 --> 00:32:24,030
running one of the interesting thing for

764
00:32:20,940 --> 00:32:27,930
me was you've seen the TCP port we seen

765
00:32:24,030 --> 00:32:30,330
like 55,000 but of that about 20,000 or

766
00:32:27,930 --> 00:32:32,640
so we'll just tied to FTP and you'll be

767
00:32:30,330 --> 00:32:35,669
like oh wait a minute FTP that's port 21

768
00:32:32,640 --> 00:32:37,650
and 24 the data check was like well not

769
00:32:35,670 --> 00:32:41,100
quite right so you have the control

770
00:32:37,650 --> 00:32:44,460
channel and as you transfer data it

771
00:32:41,100 --> 00:32:45,600
opening random ports on the server and

772
00:32:44,460 --> 00:32:47,610
you're connecting to those and

773
00:32:45,600 --> 00:32:49,169
exchanging data but because you don't

774
00:32:47,610 --> 00:32:51,629
have visibility into the control channel

775
00:32:49,170 --> 00:32:54,480
in your syslog how do you tie all these

776
00:32:51,630 --> 00:32:57,120
floats into that FTP control channel and

777
00:32:54,480 --> 00:32:59,340
I would go in length on discussing the

778
00:32:57,120 --> 00:33:02,600
logic behind that so you know this is

779
00:32:59,340 --> 00:33:05,040
just we know what this slide is about

780
00:33:02,600 --> 00:33:07,350
the things you may find I cannot touched

781
00:33:05,040 --> 00:33:09,180
on that a little bit already you have

782
00:33:07,350 --> 00:33:10,949
web sockets like do you know what web

783
00:33:09,180 --> 00:33:13,110
sockets are right like how do they work

784
00:33:10,950 --> 00:33:16,650
or inspecting that if you are looking at

785
00:33:13,110 --> 00:33:18,240
hard bound web traffic your ipv6 you

786
00:33:16,650 --> 00:33:22,880
know you may think that you don't run it

787
00:33:18,240 --> 00:33:25,560
but you know think again for the

788
00:33:22,880 --> 00:33:27,690
personal emails being mapped to your

789
00:33:25,560 --> 00:33:29,669
corporate Outlook I'm not discussing

790
00:33:27,690 --> 00:33:32,040
whether it is okay per your company

791
00:33:29,670 --> 00:33:34,170
policy can you do it or not but think

792
00:33:32,040 --> 00:33:36,629
about it this way you may invest heavily

793
00:33:34,170 --> 00:33:37,380
into email security control so you put

794
00:33:36,630 --> 00:33:39,600
some advanced

795
00:33:37,380 --> 00:33:42,360
threat prediction stuff and you know a

796
00:33:39,600 --> 00:33:44,389
bunch of filtering and then you know a

797
00:33:42,360 --> 00:33:47,760
user check some maps their check

798
00:33:44,390 --> 00:33:49,890
personal email to a corporate Outlook

799
00:33:47,760 --> 00:33:51,900
and you're not opening all the emails

800
00:33:49,890 --> 00:33:53,850
and attachments on our endpoint so all

801
00:33:51,900 --> 00:33:57,630
your email Enterprise controls are being

802
00:33:53,850 --> 00:33:59,280
ignored so if you see that you know you

803
00:33:57,630 --> 00:34:06,000
can go talk to him and be like hey what

804
00:33:59,280 --> 00:34:08,460
are you doing some parting thoughts you

805
00:34:06,000 --> 00:34:11,250
know Jonah in the keynote alluded to it

806
00:34:08,460 --> 00:34:13,409
you may have some cool tools and if you

807
00:34:11,250 --> 00:34:15,330
do then definitely use them I did say

808
00:34:13,409 --> 00:34:16,470
that we don't need any NetFlow but if

809
00:34:15,330 --> 00:34:18,389
you have it I don't saying that flows

810
00:34:16,469 --> 00:34:20,250
bad it's actually really good you should

811
00:34:18,389 --> 00:34:23,850
be collecting that but maybe you don't

812
00:34:20,250 --> 00:34:25,889
have the ability to do so so if you

813
00:34:23,850 --> 00:34:28,110
don't have that you can just go and

814
00:34:25,889 --> 00:34:29,760
script your way away in our field I

815
00:34:28,110 --> 00:34:31,500
highly recommend for you to learn a

816
00:34:29,760 --> 00:34:34,440
scripting language it doesn't have to be

817
00:34:31,500 --> 00:34:38,879
PHP it can be Python or you know Perl

818
00:34:34,440 --> 00:34:41,280
PowerShell whatever else but you need to

819
00:34:38,879 --> 00:34:45,179
help yourself get through the you know

820
00:34:41,280 --> 00:34:47,429
volume of data fine you know where the

821
00:34:45,179 --> 00:34:49,110
data is and looks through alternative

822
00:34:47,429 --> 00:34:51,629
locations because again you may not have

823
00:34:49,110 --> 00:34:54,510
a fancy sync tool where that has all the

824
00:34:51,629 --> 00:34:57,149
answers for you but you can pull maybe a

825
00:34:54,510 --> 00:35:00,540
log from an application or a device that

826
00:34:57,149 --> 00:35:03,060
can cannot tell you about that of course

827
00:35:00,540 --> 00:35:04,830
if you find some good data then extract

828
00:35:03,060 --> 00:35:06,840
that see how we can image that and

829
00:35:04,830 --> 00:35:10,560
analyze this to get you a step closer

830
00:35:06,840 --> 00:35:13,680
and you know any automation is of course

831
00:35:10,560 --> 00:35:15,390
awesome and don't be afraid to just

832
00:35:13,680 --> 00:35:16,680
ignore the data that you don't need you

833
00:35:15,390 --> 00:35:20,129
really need to be like cherry-picking

834
00:35:16,680 --> 00:35:26,220
what do you need all right

835
00:35:20,130 --> 00:35:28,650
I know it's lunchtime so as I said that

836
00:35:26,220 --> 00:35:31,259
that QR code will go to the short URL

837
00:35:28,650 --> 00:35:33,510
link right there

838
00:35:31,260 --> 00:35:36,380
I tried it before the presentation it

839
00:35:33,510 --> 00:35:39,380
opens this as a PDF file in onedrive I

840
00:35:36,380 --> 00:35:39,380
promise

841
00:35:39,630 --> 00:35:46,030
well so your NetFlow the firewall really

842
00:35:43,000 --> 00:35:47,560
doesn't care what protocol it is but you

843
00:35:46,030 --> 00:35:50,410
will see it going on a port 80 and 443

844
00:35:47,560 --> 00:35:52,000
right so you will see the connection in

845
00:35:50,410 --> 00:35:53,859
net flow but you may think that it's a

846
00:35:52,000 --> 00:35:57,820
web traffic where it may be DNS and

847
00:35:53,860 --> 00:35:59,500
that's why I have the slide on if you

848
00:35:57,820 --> 00:36:01,420
start looking at it figure out what it

849
00:35:59,500 --> 00:36:04,060
actually is try to sniff the traffic or

850
00:36:01,420 --> 00:36:07,180
look at the end point I know it's you

851
00:36:04,060 --> 00:36:09,040
know reasonably in technology but it

852
00:36:07,180 --> 00:36:11,319
really doesn't change the equation you

853
00:36:09,040 --> 00:36:13,509
may just be blindsided and keep in mind

854
00:36:11,320 --> 00:36:15,880
that you know I've you know we are not

855
00:36:13,510 --> 00:36:17,740
looking at everything so if the attacker

856
00:36:15,880 --> 00:36:20,110
is going to choose port 80 for our bank

857
00:36:17,740 --> 00:36:21,700
shell maybe they get out right if they

858
00:36:20,110 --> 00:36:23,680
go through a proxy maybe I need to have

859
00:36:21,700 --> 00:36:31,620
a proxy evershell and it's a little bit

860
00:36:23,680 --> 00:36:31,620
difficult anyway any other question

861
00:36:32,820 --> 00:36:41,679
all right well thank you

862
00:36:35,770 --> 00:36:41,679
[Applause]

863
00:36:47,859 --> 00:36:49,920
you

