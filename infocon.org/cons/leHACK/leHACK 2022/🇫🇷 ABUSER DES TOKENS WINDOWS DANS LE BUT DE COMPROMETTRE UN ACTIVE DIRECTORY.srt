1
00:00:03,890 --> 00:00:06,839
hello to all suddenly today I

2
00:00:06,839 --> 00:00:08,840
'm going to give you a presentation on

3
00:00:08,840 --> 00:00:11,429
bon the goal is to see what

4
00:00:11,429 --> 00:00:13,200
windows weekends are so the

5
00:00:13,200 --> 00:00:15,299
presentation the role the idea is to

6
00:00:15,299 --> 00:00:16,260
make an introduction  to paint is

7
00:00:16,260 --> 00:00:19,170
active directory but also to internal

8
00:00:19,170 --> 00:00:21,539
windows so I'm really going to start from

9
00:00:21,539 --> 00:00:22,279
the base

10
00:00:22,279 --> 00:00:24,240
which is an act and active directory

11
00:00:24,240 --> 00:00:25,769
and then I'm going to ramp up

12
00:00:25,769 --> 00:00:28,199
until I get to internal

13
00:00:28,199 --> 00:00:29,580
windows what are the boxes what are

14
00:00:29,580 --> 00:00:31,140
the rates  that they

15
00:00:31,140 --> 00:00:32,340
what they are used for how they are used and how we

16
00:00:32,340 --> 00:00:34,890
can exploit them in the case we arrive

17
00:00:34,890 --> 00:00:37,020
on an information system which is

18
00:00:37,020 --> 00:00:39,440
very good at giving back

19
00:00:39,440 --> 00:00:41,129
to what I have perhaps that we want it's

20
00:00:41,129 --> 00:00:42,750
not  represented 11 suddenly me it's

21
00:00:42,750 --> 00:00:44,820
aurélien chalot I am pentester

22
00:00:44,820 --> 00:00:47,550
hackers sysadmin security researcher

23
00:00:47,550 --> 00:00:50,399
have a cyber defense so big up to my

24
00:00:50,399 --> 00:00:52,520
team

25
00:00:52,520 --> 00:00:55,760
[Applause]

26
00:00:55,760 --> 00:00:58,020
veils and mika listings enthusiastic

27
00:00:58,020 --> 00:00:59,510
my street we look at this kind of thing

28
00:00:59,510 --> 00:01:02,160
and then I'm part of  the team at  5

29
00:01:02,160 --> 00:01:03,510
p.m. dnssec so I know they are

30
00:01:03,510 --> 00:01:06,500
also there a video for you guys

31
00:01:06,580 --> 00:01:09,120
and here

32
00:01:09,120 --> 00:01:10,950
I also have a blog on which game but

33
00:01:10,950 --> 00:01:12,540
hey there is only one article for a moment

34
00:01:12,540 --> 00:01:15,330
there will be others over time  if

35
00:01:15,330 --> 00:01:16,440
you want to love each other but

36
00:01:16,440 --> 00:01:18,120
research note so here I take a subject

37
00:01:18,120 --> 00:01:19,740
on windows mainly windows and

38
00:01:19,740 --> 00:01:21,180
the activated directory and suddenly

39
00:01:21,180 --> 00:01:23,030
esteem them and

40
00:01:23,030 --> 00:01:25,380
well here I dissect I do

41
00:01:25,380 --> 00:01:26,730
research I write code and then I

42
00:01:26,730 --> 00:01:28,680
share all that  because i like to

43
00:01:28,680 --> 00:01:30,630
share what i learn as researchers

44
00:01:30,630 --> 00:01:33,030
carling

45
00:01:33,030 --> 00:01:35,250
ok so the basis of a talk movement

46
00:01:35,250 --> 00:01:37,710
that active directory what

47
00:01:37,710 --> 00:01:38,970
is an active directory bas it is quite

48
00:01:38,970 --> 00:01:40,979
simply a directory that contains the

49
00:01:40,979 --> 00:01:42,840
information relating to the resources

50
00:01:42,840 --> 00:01:44,700
of an operating system

51
00:01:44,700 --> 00:01:46,500
information systems rather of a company

52
00:01:46,500 --> 00:01:48,180
so we find there what we find there

53
00:01:48,180 --> 00:01:50,399
computers servers we will find there

54
00:01:50,399 --> 00:01:51,630
printers shared folders

55
00:01:51,630 --> 00:01:54,000
so smb tanks we will also find

56
00:01:54,000 --> 00:01:56,280
the  wholesale users  upes which

57
00:01:56,280 --> 00:01:57,090
allow the management of its

58
00:01:57,090 --> 00:01:59,610
users we will find gpus so

59
00:01:59,610 --> 00:02:01,890
all that is the rule the rules of

60
00:02:01,890 --> 00:02:04,590
management of the machines etc etc the idea of an activ

61
00:02:04,590 --> 00:02:07,050
directory is to have all the r

62
00:02:07,050 --> 00:02:09,000
sources centralized and that 

63
00:02:09,000 --> 00:02:11,640
e  can manage without taking the lead in

64
00:02:11,640 --> 00:02:13,520
fact

65
00:02:13,520 --> 00:02:16,620
if I had to give a diagram of

66
00:02:16,620 --> 00:02:18,660
what an active directory is I think

67
00:02:18,660 --> 00:02:20,610
it comes close rather not badly rather

68
00:02:20,610 --> 00:02:23,490
not rather well earlier so what do we have

69
00:02:23,490 --> 00:02:25,650
in an active directory we have

70
00:02:25,650 --> 00:02:29,550
roughly three types of components we will

71
00:02:29,550 --> 00:02:31,350
have is domain administrator get

72
00:02:31,350 --> 00:02:32,880
tired of the top level it is those who have

73
00:02:32,880 --> 00:02:35,640
more privileges and it is also these

74
00:02:35,640 --> 00:02:37,560
people that we go to a case during

75
00:02:37,560 --> 00:02:39,590
the emission of intrusion tests

76
00:02:39,590 --> 00:02:41,730
we have the users of the

77
00:02:41,730 --> 00:02:43,470
classic domain so that's you me when

78
00:02:43,470 --> 00:02:45,180
I arrive at work play my pc I

79
00:02:45,180 --> 00:02:47,459
connect with the wii nor cloudy logo

80
00:02:47,459 --> 00:02:48,810
but in the name of the senator my password

81
00:02:48,810 --> 00:02:51,330
and I recover my information my

82
00:02:51,330 --> 00:02:52,650
files and then  I have access to meschers

83
00:02:52,650 --> 00:02:54,000
jacques it is  an asset but serve as

84
00:02:54,000 --> 00:02:56,640
work and therefore suddenly as I do not want

85
00:02:56,640 --> 00:02:58,200
to say we have the machines of the domain

86
00:02:58,200 --> 00:02:59,640
so we have tanks and armed

87
00:02:59,640 --> 00:03:02,640
web servers servers have c s we

88
00:03:02,640 --> 00:03:04,850
have computers and printers

89
00:03:04,850 --> 00:03:07,800
in the middle of all that we  in the

90
00:03:07,800 --> 00:03:09,000
central room which is simply the

91
00:03:09,000 --> 00:03:10,470
controller of the domain so it's

92
00:03:10,470 --> 00:03:13,920
really it's the server on which we

93
00:03:13,920 --> 00:03:15,330
will manage all these all its

94
00:03:15,330 --> 00:03:18,600
resources and on this server there is

95
00:03:18,600 --> 00:03:21,630
a tds so I will come back later

96
00:03:21,630 --> 00:03:23,280
if we let ourselves

97
00:03:23,280 --> 00:03:24,720
roughly speaking what can hold back is just having

98
00:03:24,720 --> 00:03:26,310
fun ds it's a database

99
00:03:26,310 --> 00:03:27,450
which is present on all the active

100
00:03:27,450 --> 00:03:29,060
directories

101
00:03:29,060 --> 00:03:30,900
ok a few words on

102
00:03:30,900 --> 00:03:33,329
internal penetration tests so I

103
00:03:33,329 --> 00:03:34,769
put you only the internal penetration test

104
00:03:34,769 --> 00:03:36,239
its purpose 7 to compromise active directory

105
00:03:36,239 --> 00:03:38,849
so to be an administrator of the domain in

106
00:03:38,849 --> 00:03:40,859
reality it is not completely true the

107
00:03:40,859 --> 00:03:42,269
purpose of an internal penetration test is

108
00:03:42,269 --> 00:03:44,549
to find all the vulnerabilities on

109
00:03:44,549 --> 00:03:46,439
a corporate network and all that

110
00:03:46,439 --> 00:03:48,060
gonna be the bad one  ise network configuration

111
00:03:48,060 --> 00:03:49,349
misconfiguration of the tipp

112
00:03:49,349 --> 00:03:51,269
directory everything that is service

113
00:03:51,269 --> 00:03:53,640
vulnerable this kind of thing but

114
00:03:53,640 --> 00:03:56,280
in fact when a tester arrives on an

115
00:03:56,280 --> 00:03:58,079
internal test what he wants is to

116
00:03:58,079 --> 00:03:59,329
be a thousand away from the domain

117
00:03:59,329 --> 00:04:01,950
to get to this stage  there they

118
00:04:01,950 --> 00:04:02,939
have in fact several

119
00:04:02,939 --> 00:04:04,620
techniques so for example we will have

120
00:04:04,620 --> 00:04:05,819
user accounts with

121
00:04:05,819 --> 00:04:07,590
weak passwords that we have all already

122
00:04:07,590 --> 00:04:10,590
seen it I think the fist admin admin we

123
00:04:10,590 --> 00:04:12,389
will have configuration fault exploitation

124
00:04:12,389 --> 00:04:14,639
and  they directory and we will

125
00:04:14,639 --> 00:04:16,410
also be able to use

126
00:04:16,410 --> 00:04:18,120
maple services servers which will

127
00:04:18,120 --> 00:04:20,070
allow us to extend the attack perimeter

128
00:04:20,070 --> 00:04:23,599
and bounce on other machines

129
00:04:24,810 --> 00:04:27,039
a classic

130
00:04:27,039 --> 00:04:28,599
intrusion test scenario is probably the one we

131
00:04:28,599 --> 00:04:29,830
find the end that we

132
00:04:29,830 --> 00:04:34,020
clearly find in 80% of our tests it's

133
00:04:34,020 --> 00:04:36,940
good we are we are at this stage we have

134
00:04:36,940 --> 00:04:38,650
just connected margie 45 on our on

135
00:04:38,650 --> 00:04:41,110
our on the network and in fact we are going to

136
00:04:41,110 --> 00:04:42,789
compromise a first  server then the

137
00:04:42,789 --> 00:04:44,319
compromise of the first server is done

138
00:04:44,319 --> 00:04:46,150
in many different ways we will be

139
00:04:46,150 --> 00:04:48,129
able to have death shoot people who

140
00:04:48,129 --> 00:04:49,479
do dev you have the tom cats with

141
00:04:49,479 --> 00:04:50,860
default passwords which will

142
00:04:50,860 --> 00:04:52,090
allow us to claude and code which

143
00:04:52,090 --> 00:04:53,319
will us  allow to compromise the

144
00:04:53,319 --> 00:04:55,150
server we are going to have all the cities

145
00:04:55,150 --> 00:04:56,440
that are related to the lack of update

146
00:04:56,440 --> 00:04:59,020
so for example eternal blue the roles

147
00:04:59,020 --> 00:05:00,300
to gones

148
00:05:00,300 --> 00:05:03,400
recently the certif ride and that kind of

149
00:05:03,400 --> 00:05:04,810
stuff good even if it has the satisfied that

150
00:05:04,810 --> 00:05:06,610
they have  no more compromise of

151
00:05:06,610 --> 00:05:09,490
the activated directory directly and

152
00:05:09,490 --> 00:05:11,110
once we have acquired this server we will

153
00:05:11,110 --> 00:05:14,310
boost the sum of the low ham as

154
00:05:14,310 --> 00:05:15,810
well as the ram of the process they

155
00:05:15,810 --> 00:05:18,660
therefore do from there we recover

156
00:05:18,660 --> 00:05:19,950
login credentials from the secrets

157
00:05:19,950 --> 00:05:21,570
that we will  simply replaying

158
00:05:21,570 --> 00:05:23,790
on other servers on the whole computer park

159
00:05:23,790 --> 00:05:26,400
and most of the time that is

160
00:05:26,400 --> 00:05:30,000
enough to fall on oneself compromising

161
00:05:30,000 --> 00:05:31,590
the domain account of the

162
00:05:31,590 --> 00:05:34,620
domain controller sorry has fallen on others  are the

163
00:05:34,620 --> 00:05:36,390
identifier who allowed us 30

164
00:05:36,390 --> 00:05:37,650
compromise the domain controller

165
00:05:37,650 --> 00:05:41,620
and therefore natale minister is wrong

166
00:05:41,620 --> 00:05:46,180
so sorry I know that my

167
00:05:46,180 --> 00:05:47,350
everyone does not do active directory

168
00:05:47,350 --> 00:05:48,610
and windows so I allow myself to

169
00:05:48,610 --> 00:05:52,120
come back to a few notions a few

170
00:05:52,120 --> 00:05:55,720
words so who  are the assam ulfa cnt ds

171
00:05:55,720 --> 00:05:58,510
so ltds it's just that

172
00:05:58,510 --> 00:06:01,060
means nt directory services good it's the

173
00:06:01,060 --> 00:06:03,250
database of accounts on a

174
00:06:03,250 --> 00:06:05,650
network active directory all your

175
00:06:05,650 --> 00:06:07,180
user accounts in your company all

176
00:06:07,180 --> 00:06:08,620
the accounts of your machines are

177
00:06:08,620 --> 00:06:10,000
stored  finally the passwords of the

178
00:06:10,000 --> 00:06:11,229
identifiers the identifiers are

179
00:06:11,229 --> 00:06:13,030
stored in the form of an ax to its

180
00:06:13,030 --> 00:06:15,160
strict and we will say to simplify

181
00:06:15,160 --> 00:06:16,960
within the nds

182
00:06:16,960 --> 00:06:18,669
this file this database is

183
00:06:18,669 --> 00:06:20,949
present on all

184
00:06:20,949 --> 00:06:22,870
the domain controllers in the form of  'a

185
00:06:22,870 --> 00:06:25,300
file called ndds we say

186
00:06:25,300 --> 00:06:27,849
so that's really the golden trophy

187
00:06:27,849 --> 00:06:29,979
for an attacker why because it

188
00:06:29,979 --> 00:06:31,659
is absolutely all the identifiers of

189
00:06:31,659 --> 00:06:33,520
all users  who say they have

190
00:06:33,520 --> 00:06:34,950
stored

191
00:06:34,950 --> 00:06:36,870
not in clear but who are

192
00:06:36,870 --> 00:06:39,300
still present and that we can

193
00:06:39,300 --> 00:06:41,280
then use we have the wife so the sum

194
00:06:41,280 --> 00:06:44,159
is balla security account manager

195
00:06:44,159 --> 00:06:45,840
it is also a database which

196
00:06:45,840 --> 00:06:47,729
contains the local accounts  on a

197
00:06:47,729 --> 00:06:48,949
windows system

198
00:06:48,949 --> 00:06:52,050
this database has the contents

199
00:06:52,050 --> 00:06:54,030
in the registry keys on so i

200
00:06:54,030 --> 00:06:54,870
play as i wanted on all

201
00:06:54,870 --> 00:06:57,270
windows machines and here we can

202
00:06:57,270 --> 00:06:59,150
see a preview of it here

203
00:06:59,150 --> 00:07:01,289
me

204
00:07:01,289 --> 00:07:03,089
so when your computer is not

205
00:07:03,089 --> 00:07:04,529
linked to a  active directory what will

206
00:07:04,529 --> 00:07:07,499
happen is that well he will he will

207
00:07:07,499 --> 00:07:08,849
ask you on this basis there to authenticate you

208
00:07:08,849 --> 00:07:11,058


209
00:07:11,430 --> 00:07:14,450
finally we have one last

210
00:07:14,450 --> 00:07:17,689
of a good we at hell's ass

211
00:07:17,689 --> 00:07:19,519
she that means local security

212
00:07:19,519 --> 00:07:20,989
authority sap system in fact  it is the

213
00:07:20,989 --> 00:07:23,809
process under windows which is in charge

214
00:07:23,809 --> 00:07:25,549
of authentication on a

215
00:07:25,549 --> 00:07:28,279
windows system between the two diagrams that

216
00:07:28,279 --> 00:07:29,360
I put to you earlier I lied a little

217
00:07:29,360 --> 00:07:32,959
bit excuse me what to see

218
00:07:32,959 --> 00:07:35,029
in fact  it's just that it's really

219
00:07:35,029 --> 00:07:35,779
a phase  e who will manage

220
00:07:35,779 --> 00:07:36,559
the authentication

221
00:07:36,559 --> 00:07:38,809
that is to say that whether you are

222
00:07:38,809 --> 00:07:41,360
active directory link or not the login credentials

223
00:07:41,360 --> 00:07:42,829
that you will specify

224
00:07:42,829 --> 00:07:44,959
will be transmitted to her hunting and she

225
00:07:44,959 --> 00:07:47,360
will make the connection either with the bass

226
00:07:47,360 --> 00:07:49,489
ham it's my  third inter is not

227
00:07:49,489 --> 00:07:51,589
linked to direct access to rice either with

228
00:07:51,589 --> 00:07:52,969
the domain controller which will

229
00:07:52,969 --> 00:07:54,499
verify that the login credentials

230
00:07:54,499 --> 00:07:57,800
are good via the ndds so if

231
00:07:57,800 --> 00:07:59,179
you open this is your windows and

232
00:07:59,179 --> 00:07:59,959
you have in the

233
00:07:59,959 --> 00:08:01,879
task manager you will see  all the time a

234
00:08:01,879 --> 00:08:03,409
process called local security

235
00:08:03,409 --> 00:08:07,000
authority system sap system

236
00:08:07,000 --> 00:08:09,620
so here is the thing to remember

237
00:08:09,620 --> 00:08:11,480
especially in relation to ussat is that

238
00:08:11,480 --> 00:08:13,250
as it manages authentication and well

239
00:08:13,250 --> 00:08:15,440
it actually has within its

240
00:08:15,440 --> 00:08:16,790
process  so within its

241
00:08:16,790 --> 00:08:19,760
memory space of authentication secrets

242
00:08:19,760 --> 00:08:21,380
it's secret it can be

243
00:08:21,380 --> 00:08:23,360
passwords stored in plain text in the form of

244
00:08:23,360 --> 00:08:26,030
hlm so h ntlm it's the

245
00:08:26,030 --> 00:08:28,490
windows tasks format one of the 2 h formats of

246
00:08:28,490 --> 00:08:30,470
wind  ows we can also find tic

247
00:08:30,470 --> 00:08:32,539
imbert up and we also find lots

248
00:08:32,539 --> 00:08:34,840
of other very interesting information

249
00:08:34,840 --> 00:08:37,700
but which we will not talk about here so

250
00:08:37,700 --> 00:08:38,599
suddenly

251
00:08:38,599 --> 00:08:40,039
we what will interest us when we

252
00:08:40,039 --> 00:08:42,049
have compromised a server or a machine

253
00:08:42,049 --> 00:08:43,969
these two dom vayssette  this

254
00:08:43,969 --> 00:08:46,670
memory space for then the game and

255
00:08:46,670 --> 00:08:49,310
obtain all the information all the

256
00:08:49,310 --> 00:08:51,910
authentication secrets

257
00:08:51,910 --> 00:08:54,130
once we have that as we saw on the

258
00:08:54,130 --> 00:08:55,600
diagram just before we will replay the

259
00:08:55,600 --> 00:08:57,280
connection identifiers and we can

260
00:08:57,280 --> 00:08:58,960
compromise servers one after

261
00:08:58,960 --> 00:09:00,730
the others

262
00:09:00,730 --> 00:09:02,920
so

263
00:09:02,920 --> 00:09:04,120
I gave you little words

264
00:09:04,120 --> 00:09:06,550
so I'm going to show you in fact what

265
00:09:06,550 --> 00:09:08,279
it looks like in fact a most basic intrusion test

266
00:09:08,279 --> 00:09:10,670


267
00:09:10,670 --> 00:09:13,280
so the laboratory it consists of

268
00:09:13,280 --> 00:09:14,600
two servers the first is a

269
00:09:14,600 --> 00:09:17,420
windows 2019 server  the second is a

270
00:09:17,420 --> 00:09:19,700
death in a domain controller in

271
00:09:19,700 --> 00:09:23,060
windows 2019 we have a

272
00:09:23,060 --> 00:09:24,620
domain administrator who is connected to the

273
00:09:24,620 --> 00:09:26,540
windows 2019 server and as I tell you

274
00:09:26,540 --> 00:09:28,950
then we have line tds

275
00:09:28,950 --> 00:09:30,770
e  t there the goal what we are going to do is that

276
00:09:30,770 --> 00:09:32,850
we are going to use a tool called

277
00:09:32,850 --> 00:09:35,040
mimikatz well I think it is well

278
00:09:35,040 --> 00:09:38,100
known enough to recover the identifiers

279
00:09:38,100 --> 00:09:40,320
of the domain administrator who is

280
00:09:40,320 --> 00:09:42,510
this character people there on  this

281
00:09:42,510 --> 00:09:44,310
server and we are going to play them on death

282
00:09:44,310 --> 00:09:45,630
which will allow us to compromise

283
00:09:45,630 --> 00:09:47,829
the domain

284
00:09:47,829 --> 00:09:50,829
so

285
00:09:59,330 --> 00:10:02,310
already good I tell you I cheated

286
00:10:02,310 --> 00:10:04,830
why not what you are going to see good

287
00:10:04,830 --> 00:10:06,810
there I point out information

288
00:10:06,810 --> 00:10:08,040
so excuse me I  hadn't thought about the

289
00:10:08,040 --> 00:10:11,430
fact that the room this story is big so

290
00:10:11,430 --> 00:10:12,330
I don't think the people at the back

291
00:10:12,330 --> 00:10:14,340
will necessarily see what to

292
00:10:14,340 --> 00:10:16,380
remember is that on the right we have two

293
00:10:16,380 --> 00:10:19,380
servers, the 2019 server and the domain

294
00:10:19,380 --> 00:10:21,960
controllers in 2019  below

295
00:10:21,960 --> 00:10:24,360
I have a chai the distance on the 2019 server

296
00:10:24,360 --> 00:10:27,290


297
00:10:28,700 --> 00:10:30,840
I told you I cheated

298
00:10:30,840 --> 00:10:32,940
deactivate windows defender it is considered

299
00:10:32,940 --> 00:10:34,730
that there is no antivirus on the machine

300
00:10:34,730 --> 00:10:38,370
for reasons which we will discuss just

301
00:10:38,370 --> 00:10:40,610
after

302
00:10:44,540 --> 00:10:47,530
so below

303
00:10:47,730 --> 00:10:49,440
my on my  chat the distance to show

304
00:10:49,440 --> 00:10:51,839
u actually  user mt

305
00:10:51,839 --> 00:10:53,160
system authorities therefore the most

306
00:10:53,160 --> 00:10:56,120
privileged user on the machine

307
00:10:56,259 --> 00:10:58,720
of course the server therefore this one is at

308
00:10:58,720 --> 00:11:00,879
the root you know I had claude r min

309
00:11:00,879 --> 00:11:03,359
90

310
00:11:07,329 --> 00:11:10,920
eghezée he switches me to

311
00:11:10,920 --> 00:11:14,410
the command line 2004 interface and I

312
00:11:14,410 --> 00:11:15,610
I will simply use the module

313
00:11:15,610 --> 00:11:18,360
would locate the ess a as well

314
00:11:18,360 --> 00:11:21,489
as specifying the logan password which will

315
00:11:21,489 --> 00:11:23,170
actually allow me to jump mini-quads

316
00:11:23,170 --> 00:11:25,869
and all of the

317
00:11:25,869 --> 00:11:27,579
process ram and the airlock within this

318
00:11:27,579 --> 00:11:30,149
ram space on  will see that there are several

319
00:11:30,149 --> 00:11:32,559
connection identifiers so there we

320
00:11:32,559 --> 00:11:34,389
can see that healy to that of

321
00:11:34,389 --> 00:11:36,100
the domain administrator white flag

322
00:11:36,100 --> 00:11:38,259
so as I wanted to say his

323
00:11:38,259 --> 00:11:39,970
identifier and his password sorry

324
00:11:39,970 --> 00:11:41,410
is not in clear but in the form

325
00:11:41,410 --> 00:11:43,749
of a purchase the tlm it turns out that on

326
00:11:43,749 --> 00:11:45,369
windows that we are one or the other it does not

327
00:11:45,369 --> 00:11:46,809
change anything it is exactly the same

328
00:11:46,809 --> 00:11:48,929
thing

329
00:11:49,860 --> 00:11:52,150
here is the hlm

330
00:11:52,150 --> 00:11:53,770
then we will use a small

331
00:11:53,770 --> 00:11:55,420
tool called crack  map exec so in

332
00:11:55,420 --> 00:11:58,060
addition there is a conference on it by

333
00:11:58,060 --> 00:11:59,410
martial I don't know anymore  if it's

334
00:11:59,410 --> 00:12:00,760
today or tomorrow so here it is a

335
00:12:00,760 --> 00:12:03,550
small little advertisement very good tools

336
00:12:03,550 --> 00:12:05,440
Swiss army knife tools for

337
00:12:05,440 --> 00:12:07,000
internal intrusion testing we use then

338
00:12:07,000 --> 00:12:09,630
finally come out mainly that that

339
00:12:09,630 --> 00:12:11,290
sorry

340
00:12:11,290 --> 00:12:14,259
is what I'm doing here it's that I

341
00:12:14,259 --> 00:12:16,660
retrieves the tlm string from the administrators user

342
00:12:16,660 --> 00:12:19,199


343
00:12:19,510 --> 00:12:21,720
authenticates to the

344
00:12:21,720 --> 00:12:24,970
10.0.1 2.21 server so the one on the left and we

345
00:12:24,970 --> 00:12:26,410
can see that I have the mention

346
00:12:26,410 --> 00:12:28,030
paul's which means that I am the

347
00:12:28,030 --> 00:12:30,889
local administrator of the machine

348
00:12:30,889 --> 00:12:33,410
once we have  that we know that we have

349
00:12:33,410 --> 00:12:35,299
identifiers that are valid we will

350
00:12:35,299 --> 00:12:36,709
just replay them on other servers

351
00:12:36,709 --> 00:12:38,869
and in this case we will play them on

352
00:12:38,869 --> 00:12:40,879
the domain controller whose ip and point it

353
00:12:40,879 --> 00:12:43,899
in vain

354
00:12:45,660 --> 00:12:47,769
here we are

355
00:12:47,769 --> 00:12:49,320


356
00:12:49,320 --> 00:12:50,790
connected as  'administrator

357
00:12:50,790 --> 00:12:52,980
on the domain controllers I

358
00:12:52,980 --> 00:12:54,270
invented well paul so the

359
00:12:54,270 --> 00:12:56,100
local administrator g compromised he active directory

360
00:12:56,100 --> 00:12:57,630
I compromised the domain controller

361
00:12:57,630 --> 00:13:00,650
and therefore active directory

362
00:13:06,320 --> 00:13:09,020
ok so yeah as I told you good

363
00:13:09,020 --> 00:13:10,950
his last seven golo what I  want

364
00:13:10,950 --> 00:13:12,270
do but it absolutely does not reflect a

365
00:13:12,270 --> 00:13:14,560
real case

366
00:13:14,560 --> 00:13:17,350
the ag of mpl saas with mick act but

367
00:13:17,350 --> 00:13:19,660
windows defender and any

368
00:13:19,660 --> 00:13:21,630
security tool obviously

369
00:13:21,630 --> 00:13:24,760
won't let me do that so whether it

370
00:13:24,760 --> 00:13:26,529
's antivirus and dr fights

371
00:13:26,529 --> 00:13:28,360
whatever it will let me  not do that

372
00:13:28,360 --> 00:13:30,640
why because the sas it was it is

373
00:13:30,640 --> 00:13:31,900
a process which is extremely

374
00:13:31,900 --> 00:13:33,670
sensitive because of its content so

375
00:13:33,670 --> 00:13:35,190
for this reason

376
00:13:35,190 --> 00:13:38,500
excuse me for this reason it and

377
00:13:38,500 --> 00:13:39,820
monitor in all directions by all

378
00:13:39,820 --> 00:13:41,250
the antiviruses of the world

379
00:13:41,250 --> 00:13:43,720
here is as soon as  you are going to deposit a mini

380
00:13:43,720 --> 00:13:45,580
4 points and bet on a machine it will

381
00:13:45,580 --> 00:13:47,410
be mole and on sight is deleted in the

382
00:13:47,410 --> 00:13:48,710
process

383
00:13:48,710 --> 00:13:50,570
fortunately for us we are

384
00:13:50,570 --> 00:13:53,750
smarter than windows defender we know

385
00:13:53,750 --> 00:13:56,030
that there are interests of the mechanisms

386
00:13:56,030 --> 00:13:58,430
internal to windows in particular the

387
00:13:58,430 --> 00:14:00,970
carnelle objects and we will see

388
00:14:00,970 --> 00:14:03,440
what these objects are and how we

389
00:14:03,440 --> 00:14:04,580
can use them to bypass

390
00:14:04,580 --> 00:14:06,380
security

391
00:14:06,380 --> 00:14:08,480
ok

392
00:14:08,480 --> 00:14:09,820
so first of all

393
00:14:09,820 --> 00:14:13,070
what is the kernel good the

394
00:14:13,070 --> 00:14:14,360
kernel is the heart of the system

395
00:14:14,360 --> 00:14:16,579
operating its function is to

396
00:14:16,579 --> 00:14:18,560
manage the system resources therefore the

397
00:14:18,560 --> 00:14:21,260
ram memory the processes to manage the

398
00:14:21,260 --> 00:14:23,779
secure access to these resources for

399
00:14:23,779 --> 00:14:25,820
example to ensure that

400
00:14:25,820 --> 00:14:26,899
any user cannot

401
00:14:26,899 --> 00:14:28,910
access any  any file and

402
00:14:28,910 --> 00:14:30,680
especially the kernel allows

403
00:14:30,680 --> 00:14:32,149
communication between software and

404
00:14:32,149 --> 00:14:34,070
hardware so what happens is that

405
00:14:34,070 --> 00:14:36,920
you have a keyboard that sends

406
00:14:36,920 --> 00:14:38,800
electrical impulses

407
00:14:38,800 --> 00:14:41,360
and your pc has to

408
00:14:41,360 --> 00:14:43,459
understand them can interpret and for

409
00:14:43,459 --> 00:14:44,810
that in fact  you have a driver that is

410
00:14:44,810 --> 00:14:46,220
able to do the translation in fact

411
00:14:46,220 --> 00:14:48,019
but it knows that when you hit the

412
00:14:48,019 --> 00:14:49,699
down key you will send a

413
00:14:49,699 --> 00:14:51,320
resident an electrical impulse that you

414
00:14:51,320 --> 00:14:53,200
have to translate

415
00:14:53,200 --> 00:14:55,990
and display you obviously have

416
00:14:55,990 --> 00:14:58,360
drivers for everyone so the bluetooth

417
00:14:58,360 --> 00:15:00,570
mouse regardless of the screen etc

418
00:15:00,570 --> 00:15:03,030
and to ensure this its functions

419
00:15:03,030 --> 00:15:05,420
the kernel has several objects

420
00:15:05,420 --> 00:15:08,310
for example it has a

421
00:15:08,310 --> 00:15:09,620
trial type object

422
00:15:09,620 --> 00:15:11,580
which is used to  to manage a

423
00:15:11,580 --> 00:15:14,250
process it also has a

424
00:15:14,250 --> 00:15:16,050
type object will be used for my children yeah

425
00:15:16,050 --> 00:15:18,690
to manage in this raid is still a

426
00:15:18,690 --> 00:15:20,160
token type object and this is the

427
00:15:20,160 --> 00:15:21,270
one that will particularly

428
00:15:21,270 --> 00:15:24,060
interest us so on the right I put you

429
00:15:24,060 --> 00:15:26,640
an impression of a tool called

430
00:15:26,640 --> 00:15:29,490
louis nos b j so for those who

431
00:15:29,490 --> 00:15:30,690
know it's the civic

432
00:15:30,690 --> 00:15:32,580
sysinternals that's pretty good to see

433
00:15:32,580 --> 00:15:34,170
what objects exist

434
00:15:34,170 --> 00:15:35,810
for others those who don't know

435
00:15:35,810 --> 00:15:37,770
leave this internal  it's a suite

436
00:15:37,770 --> 00:15:39,870
of tools that was developed by mark

437
00:15:39,870 --> 00:15:41,640
russinovich i hope i did

438
00:15:41,640 --> 00:15:44,130
n't correct his last name is in fact it's

439
00:15:44,130 --> 00:15:45,480
a set of tools that will allow

440
00:15:45,480 --> 00:15:46,740
to administer not to administer a

441
00:15:46,740 --> 00:15:48,120
machine but in any case to understand how it

442
00:15:48,120 --> 00:15:49,820
works

443
00:15:49,820 --> 00:15:52,430
and obviously when it comes to making

444
00:15:52,430 --> 00:15:54,470
the dab bypass team last and this kind of

445
00:15:54,470 --> 00:15:56,090
thing is tools that we use

446
00:15:56,090 --> 00:15:58,160
absolutely all the time and even when

447
00:15:58,160 --> 00:15:59,540
it comes  to do the escalation of

448
00:15:59,540 --> 00:16:01,310
privileges of the  persistence in short it's

449
00:16:01,310 --> 00:16:04,040
really the top

450
00:16:04,040 --> 00:16:07,160
ok so suddenly we're just going to do what is

451
00:16:07,160 --> 00:16:08,660
it a thing of

452
00:16:08,660 --> 00:16:10,100


453
00:16:10,100 --> 00:16:11,930
hers it's really the objective of the most interest here so lautoka it's a windows object

454
00:16:11,930 --> 00:16:14,180
which describes  the security context of a

455
00:16:14,180 --> 00:16:16,070
process where in this raid

456
00:16:16,070 --> 00:16:18,020
within this token we find what we

457
00:16:18,020 --> 00:16:19,280
find the identity of the user

458
00:16:19,280 --> 00:16:20,840
who owns it so here we see that it is

459
00:16:20,840 --> 00:16:22,040
white flag

460
00:16:22,040 --> 00:16:23,950
administrators the domain administrator

461
00:16:23,950 --> 00:16:26,180
we find there  finds the groups in which

462
00:16:26,180 --> 00:16:27,710
the user is located so there we can

463
00:16:27,710 --> 00:16:30,670
see that it is administrative building

464
00:16:30,670 --> 00:16:33,750
authorities authenticated user also

465
00:16:33,750 --> 00:16:34,950
and we also find there all the

466
00:16:34,950 --> 00:16:36,510
privileges which are attributed to this

467
00:16:36,510 --> 00:16:38,310
user on the system the

468
00:16:38,310 --> 00:16:39,530
privileges are there

469
00:16:39,530 --> 00:16:42,180
we can see  that some are active

470
00:16:42,180 --> 00:16:45,150
and others are not and suddenly I allow myself

471
00:16:45,150 --> 00:16:46,950
to make a small return on here is

472
00:16:46,950 --> 00:16:48,060
well to explain what it is the

473
00:16:48,060 --> 00:16:50,160
privileges windows so basically on

474
00:16:50,160 --> 00:16:51,660
windows I told you that the

475
00:16:51,660 --> 00:16:54,420
most privileged account cnt authorities  system

476
00:16:54,420 --> 00:16:55,610
in

477
00:16:55,610 --> 00:16:59,250
in fact it is possible to divide the

478
00:16:59,250 --> 00:17:02,640
rights of this user

479
00:17:02,640 --> 00:17:04,680
in addition to a small privilege so

480
00:17:04,680 --> 00:17:06,359
currently on windows there are 37 of them

481
00:17:06,359 --> 00:17:08,550
and which in fact allow the person

482
00:17:08,550 --> 00:17:10,440
who holds them to perform actions more

483
00:17:10,440 --> 00:17:12,359
or less finally different actions on

484
00:17:12,359 --> 00:17:15,119
the system for example  you have

485
00:17:15,119 --> 00:17:18,030
the aude driver privilege which

486
00:17:18,030 --> 00:17:19,980
simply allows you to load and

487
00:17:19,980 --> 00:17:23,290
unload a driver on a system

488
00:17:23,290 --> 00:17:25,000
you have the staggered privilege which

489
00:17:25,000 --> 00:17:26,140
allows you to stop the machine so

490
00:17:26,140 --> 00:17:28,359
this one all long users and

491
00:17:28,359 --> 00:17:30,670
we have the so2 bay  privilege that allows to

492
00:17:30,670 --> 00:17:32,410
unlock and access the resources of

493
00:17:32,410 --> 00:17:34,840
any process on the system

494
00:17:34,840 --> 00:17:36,640
so that one for what they did

495
00:17:36,640 --> 00:17:38,110
with mimikatz good you know it is

496
00:17:38,110 --> 00:17:39,520
extremely important for all

497
00:17:39,520 --> 00:17:40,480
wish they make

498
00:17:40,480 --> 00:17:43,120
process injection and it's the same thing it is

499
00:17:43,120 --> 00:17:45,330
essential

500
00:17:46,930 --> 00:17:49,630
ok let's go back to our what

501
00:17:49,630 --> 00:17:51,980
good in fact there are two types of

502
00:17:51,980 --> 00:17:54,410
poker the primary token and the token

503
00:17:54,410 --> 00:17:56,210
personal ui on a windows system

504
00:17:56,210 --> 00:17:59,480
so we'll see what's the difference

505
00:17:59,480 --> 00:18:01,880
the first question that I

506
00:18:01,880 --> 00:18:02,750
'm going to answer is when do you

507
00:18:02,750 --> 00:18:04,570
get a prime heriteau cannes in fact

508
00:18:04,570 --> 00:18:07,130
printing token is always obtained

509
00:18:07,130 --> 00:18:08,750
following a so-called

510
00:18:08,750 --> 00:18:11,030
interactive authentication it's at  say that you

511
00:18:11,030 --> 00:18:13,390
arrive on your machine and you will

512
00:18:13,390 --> 00:18:15,410
manually enter your login credentials

513
00:18:15,410 --> 00:18:17,150
your username and

514
00:18:17,150 --> 00:18:19,550
your password it works

515
00:18:19,550 --> 00:18:21,530
both on your local machine so

516
00:18:21,530 --> 00:18:22,280
when you are behind your desk

517
00:18:22,280 --> 00:18:24,200
but also when you access it  via

518
00:18:24,200 --> 00:18:25,810
rdp

519
00:18:25,810 --> 00:18:28,100
in fact what will happen once

520
00:18:28,100 --> 00:18:29,780
you have you will bring your

521
00:18:29,780 --> 00:18:31,820
identifiers is that behind it sas

522
00:18:31,820 --> 00:18:33,830
the process that follows richard who manages

523
00:18:33,830 --> 00:18:35,900
the authentication will receive them and

524
00:18:35,900 --> 00:18:38,029
check that they are correct

525
00:18:38,029 --> 00:18:40,249
so for that  he can either do it

526
00:18:40,249 --> 00:18:42,440
remotely via the nt ds base or

527
00:18:42,440 --> 00:18:44,509
locally via the sans se base the

528
00:18:44,509 --> 00:18:46,159
identifiers are correct so at

529
00:18:46,159 --> 00:18:47,719
that point she has created what is

530
00:18:47,719 --> 00:18:49,820
called a merit award kane which is  t

531
00:18:49,820 --> 00:18:52,099
assigned to the current user and

532
00:18:52,099 --> 00:18:53,690
what is interesting to know is that

533
00:18:53,690 --> 00:18:55,669
this prime mairie token when a

534
00:18:55,669 --> 00:18:56,619
user

535
00:18:56,619 --> 00:18:58,609
launches an executable therefore creating a

536
00:18:58,609 --> 00:19:00,769
process is indeed this process and

537
00:19:00,769 --> 00:19:03,049
necessarily rites of soto cano therefore why

538
00:19:03,049 --> 00:19:05,119
simply because bach if  you

539
00:19:05,119 --> 00:19:07,099
have the administrator of the machine that

540
00:19:07,099 --> 00:19:08,809
creates a process c is conducted for

541
00:19:08,809 --> 00:19:10,399
example is low and it is legitimate that he

542
00:19:10,399 --> 00:19:12,469
has access to all files

543
00:19:12,469 --> 00:19:14,869
almost all files of the machine

544
00:19:14,869 --> 00:19:16,309
is in fact windows uses soto cano

545
00:19:16,309 --> 00:19:18,649
to  know whether or not they give

546
00:19:18,649 --> 00:19:22,539
access to the machine officer sorry

547
00:19:22,539 --> 00:19:24,799
and so suddenly that's why

548
00:19:24,799 --> 00:19:27,190
earlier in the presentation

549
00:19:27,190 --> 00:19:30,320
I put you that I put you this

550
00:19:30,320 --> 00:19:32,149
screen where we see a

551
00:19:32,149 --> 00:19:34,809
powershell process whose rate

552
00:19:34,809 --> 00:19:36,559
belongs to  users wherever they

553
00:19:36,559 --> 00:19:37,849
go admins

554
00:19:37,849 --> 00:19:39,200
just because actually i logged

555
00:19:39,200 --> 00:19:40,759
in as admin and started

556
00:19:40,759 --> 00:19:42,580
this process

557
00:19:42,580 --> 00:19:44,260
and which it stopped it inherited my

558
00:19:44,260 --> 00:19:46,440
hockey

559
00:19:46,440 --> 00:19:48,219
the second question to  which I

560
00:19:48,219 --> 00:19:49,059
answer you know when do you

561
00:19:49,059 --> 00:19:51,609
get a person has none so

562
00:19:51,609 --> 00:19:53,139
that they are a bit peculiar because

563
00:19:53,139 --> 00:19:54,090
in fact

564
00:19:54,090 --> 00:19:57,070
they are kept hungry almost all the time

565
00:19:57,070 --> 00:19:59,109
until at one point I am

566
00:19:59,109 --> 00:20:01,379
wrong but  I take for me for sure

567
00:20:01,379 --> 00:20:04,479
I've never seen an example to others they

568
00:20:04,479 --> 00:20:05,619
are always obtained following a

569
00:20:05,619 --> 00:20:07,539


570
00:20:07,539 --> 00:20:10,349
missing multi peak network authentication connect smb auction

571
00:20:10,349 --> 00:20:13,719
so sorry I explained more so I

572
00:20:13,719 --> 00:20:15,549
'll start again you have your

573
00:20:15,549 --> 00:20:18,339
windows server and we beat simplify we will say

574
00:20:18,339 --> 00:20:20,469
that on the left you have the smb server

575
00:20:20,469 --> 00:20:22,989
so the file server and on the right

576
00:20:22,989 --> 00:20:25,509
you have the process and the airlock so there

577
00:20:25,509 --> 00:20:27,700
you have months domain

578
00:20:27,700 --> 00:20:30,159
users trying to connect to the machine

579
00:20:30,159 --> 00:20:32,300
to access  to his files on my dear

580
00:20:32,300 --> 00:20:33,860
how does it work be careful it's

581
00:20:33,860 --> 00:20:35,630
extremely simplified but the idea is

582
00:20:35,630 --> 00:20:37,700
that in fact I'm going to motant weaver

583
00:20:37,700 --> 00:20:39,650
over the smb protocol via what is

584
00:20:39,650 --> 00:20:42,080
called a package provider hell's ass

585
00:20:42,080 --> 00:20:45,680
bon l  idea c  is it just that the

586
00:20:45,680 --> 00:20:48,410
smb service will check with it that what my

587
00:20:48,410 --> 00:20:50,330
login credentials are good and

588
00:20:50,330 --> 00:20:52,130
if it's good it will create a

589
00:20:52,130 --> 00:20:53,660
personal friend token why is this doing

590
00:20:53,660 --> 00:20:55,460
that it just me because the

591
00:20:55,460 --> 00:20:58,040
smb server  and from a server the service

592
00:20:58,040 --> 00:20:59,210
and it makes me rather is a service which

593
00:20:59,210 --> 00:21:01,040
is extremely privileged it runs

594
00:21:01,040 --> 00:21:03,770
as such system so if you

595
00:21:03,770 --> 00:21:06,160
login with your user

596
00:21:06,160 --> 00:21:07,510
to this service you are not a t

597
00:21:07,510 --> 00:21:09,340
systems if you were  it will be a big

598
00:21:09,340 --> 00:21:10,960
security problem

599
00:21:10,960 --> 00:21:13,000
it would not be very dangerous quite

600
00:21:13,000 --> 00:21:15,070
simply so what we want is

601
00:21:15,070 --> 00:21:16,450
that you can connect to your

602
00:21:16,450 --> 00:21:20,020
service your smb server but with the

603
00:21:20,020 --> 00:21:21,039
security context of your

604
00:21:21,039 --> 00:21:22,450
user that is  say unprivileged user

605
00:21:22,450 --> 00:21:24,399
who is just there to

606
00:21:24,399 --> 00:21:25,990
grab right to left files

607
00:21:25,990 --> 00:21:27,909
well thats exactly what

608
00:21:27,909 --> 00:21:32,200
a token is for a personal friend token basically

609
00:21:32,200 --> 00:21:34,539
she sas going to create that personal

610
00:21:34,539 --> 00:21:36,909
token anthem for you for you apply  in

611
00:21:36,909 --> 00:21:40,330
fact s  implement your rights and then the

612
00:21:40,330 --> 00:21:43,309
smb service will create a new this raid to

613
00:21:43,309 --> 00:21:45,590
which this thread in fact will

614
00:21:45,590 --> 00:21:47,539
inherit this personal anthem token then

615
00:21:47,539 --> 00:21:50,659
you recover remote access to the

616
00:21:50,659 --> 00:21:53,179
tanks and sam b and this thread will

617
00:21:53,179 --> 00:21:54,620
always run with your rights which does  that

618
00:21:54,620 --> 00:21:56,149
you will be able in particular you would be the

619
00:21:56,149 --> 00:21:57,409
local administrator of the machine you

620
00:21:57,409 --> 00:21:58,789
will not be able to access the dear these

621
00:21:58,789 --> 00:22:02,149
two points it is dollar and therefore suddenly

622
00:22:02,149 --> 00:22:04,269
this mechanism of the reception staff

623
00:22:04,269 --> 00:22:06,549
simply allows privileges to be

624
00:22:06,549 --> 00:22:10,330
compartmentalized on a machine

625
00:22:11,820 --> 00:22:15,100
ok our taste one  small summary

626
00:22:15,100 --> 00:22:18,430
a premium brito kahn 26 personal token

627
00:22:18,430 --> 00:22:21,530
therefore printed rite to which is attributed

628
00:22:21,530 --> 00:22:23,330
in process in fact one could even

629
00:22:23,330 --> 00:22:25,610
say that the one could even call this

630
00:22:25,610 --> 00:22:29,180
open process tocane for a simple

631
00:22:29,180 --> 00:22:31,070
and good reason that it is not tribes and

632
00:22:31,070 --> 00:22:32,870
cadets process

633
00:22:32,870 --> 00:22:34,490
an aged hyper sonic token is

634
00:22:34,490 --> 00:22:37,370
assigned to a thread after a mature itoken

635
00:22:37,370 --> 00:22:38,600
is obtained following an

636
00:22:38,600 --> 00:22:42,220
interactive wind logon ratp authentication among others  es

637
00:22:42,220 --> 00:22:44,120
while a personal friend as long as it

638
00:22:44,120 --> 00:22:45,710
is obtained mainly via

639
00:22:45,710 --> 00:22:47,570
remote network authentication so

640
00:22:47,570 --> 00:22:50,660
for example for access to a smb tank

641
00:22:50,660 --> 00:22:52,580
for those who do a lot of paw

642
00:22:52,580 --> 00:22:56,090
is ya for example the service w put

643
00:22:56,090 --> 00:22:57,910
everything that goes  to be passed to isaac etc etc

644
00:22:57,910 --> 00:23:01,600
and above all what interests us the most

645
00:23:01,600 --> 00:23:03,860
is to know if

646
00:23:03,860 --> 00:23:05,270
login identifiers are stored in an airlock at the

647
00:23:05,270 --> 00:23:07,260
time of authentication

648
00:23:07,260 --> 00:23:09,510
and in fact yes for the primary token

649
00:23:09,510 --> 00:23:12,090
long for the imf arsenal for which

650
00:23:12,090 --> 00:23:13,500
reasons quite simply because well we have

651
00:23:13,500 --> 00:23:15,660
just said itoken scoops

652
00:23:15,660 --> 00:23:16,770
require interest

653
00:23:16,770 --> 00:23:19,080
interactive authentication

654
00:23:19,080 --> 00:23:20,040
from the moment you have had

655
00:23:20,040 --> 00:23:22,050
interactive notification of a

656
00:23:22,050 --> 00:23:25,200
connection option will be stored I put aside

657
00:23:25,200 --> 00:23:28,020
the cases apart from art of ning  and

658
00:23:28,020 --> 00:23:30,320
active directory configuration

659
00:23:30,320 --> 00:23:32,029
we assume that here we are

660
00:23:32,029 --> 00:23:34,279
not everything is set up either

661
00:23:34,279 --> 00:23:36,289
and suddenly by default login credentials

662
00:23:36,289 --> 00:23:38,240
are stored while

663
00:23:38,240 --> 00:23:39,559
for  r one personal token that's not

664
00:23:39,559 --> 00:23:41,740
the case

665
00:23:42,460 --> 00:23:44,440
ok that's great all that I'm talking I'm

666
00:23:44,440 --> 00:23:46,830
talking but why am I explaining this

667
00:23:46,830 --> 00:23:49,990
to you simply because tokens

668
00:23:49,990 --> 00:23:51,910
are windows objects in fact which

669
00:23:51,910 --> 00:23:54,280
represent a user on a system

670
00:23:54,280 --> 00:23:56,560
but  also and above all the privileges that

671
00:23:56,560 --> 00:23:59,080
are associated with this user and as

672
00:23:59,080 --> 00:24:01,570
they are windows ce objects and it is

673
00:24:01,570 --> 00:24:04,480
possible to manipulate them provided you

674
00:24:04,480 --> 00:24:07,030
have sufficient privileges we

675
00:24:07,030 --> 00:24:09,690
find ourselves in a situation in fact where

676
00:24:09,690 --> 00:24:13,750
in internal intrusion test either we

677
00:24:13,750 --> 00:24:16,320
try to dmp alsace

678
00:24:16,320 --> 00:24:17,840
which could take us days a

679
00:24:17,840 --> 00:24:20,190
lot of time and above all which will

680
00:24:20,190 --> 00:24:21,539
require a lot of knowledge in

681
00:24:21,539 --> 00:24:23,460
bypass da v 2 d andy goode to this

682
00:24:23,460 --> 00:24:25,889
stuff either we just have to dig

683
00:24:25,889 --> 00:24:28,559
into the ream of the system process

684
00:24:28,559 --> 00:24:31,139
windows pardon went to recover metals that

685
00:24:31,139 --> 00:24:32,250
they from people who are more

686
00:24:32,250 --> 00:24:33,690
privileged than not

687
00:24:33,690 --> 00:24:36,040
obviously me I am a I am a fan

688
00:24:36,040 --> 00:24:37,710
testers at heart

689
00:24:37,710 --> 00:24:40,809
I am often too lazy to spend

690
00:24:40,809 --> 00:24:42,000
too much time on  s things

691
00:24:42,000 --> 00:24:44,290
for which low I can have

692
00:24:44,290 --> 00:24:46,420
easier solutions so it's

693
00:24:46,420 --> 00:24:49,740
now it's my c

694
00:24:49,740 --> 00:24:50,790
well you'll see what we're going to do

695
00:24:50,790 --> 00:24:52,230
but it's the technique that I use

696
00:24:52,230 --> 00:24:54,179
all the time now and which works at

697
00:24:54,179 --> 00:24:56,130
all the moves

698
00:24:56,130 --> 00:24:59,210
that extend from dikes and a little bit

699
00:24:59,210 --> 00:25:02,280
of code and especially

700
00:25:02,280 --> 00:25:04,260
windows structures well I reassure you I don't want to

701
00:25:04,260 --> 00:25:07,080
do you I'm not going to go too far

702
00:25:07,080 --> 00:25:10,050
either just show you what it

703
00:25:10,050 --> 00:25:11,240
looks like

704
00:25:11,240 --> 00:25:13,710
so yes sorry I forgot to

705
00:25:13,710 --> 00:25:15,630
tell you but the idea finally I will

706
00:25:15,630 --> 00:25:16,890
specify it but the idea is clearly

707
00:25:16,890 --> 00:25:18,360
to go and steal the tocanes of

708
00:25:18,360 --> 00:25:19,860
the domain administrator

709
00:25:19,860 --> 00:25:21,720
and use it for ourselves so it's what

710
00:25:21,720 --> 00:25:23,720
we call a  personification

711
00:25:23,720 --> 00:25:26,990
of tocane

712
00:25:27,960 --> 00:25:29,160
the first thing i wanted to show you

713
00:25:29,160 --> 00:25:31,190


714
00:25:31,490 --> 00:25:35,490
is the vergil us application

715
00:25:35,490 --> 00:25:38,100
finally the website to gibus why am i

716
00:25:38,100 --> 00:25:39,480
showing you it was going in fact it's

717
00:25:39,480 --> 00:25:42,840
then these guys there are absolutely brilliant

718
00:25:42,840 --> 00:25:43,920
as an application because these guys there

719
00:25:43,920 --> 00:25:45,630
have listed all the structures

720
00:25:45,630 --> 00:25:46,830
most  art of the windows structures which are

721
00:25:46,830 --> 00:25:48,570
known for all the

722
00:25:48,570 --> 00:25:50,970
windows bubbles since windows 2003 so for

723
00:25:50,970 --> 00:25:52,020
all the people who are part of the jura

724
00:25:52,020 --> 00:25:53,850
team of the development of the exploit of the

725
00:25:53,850 --> 00:25:56,370
tse the structures are updated

726
00:25:56,370 --> 00:25:57,900
they are maintained we know that it  it's

727
00:25:57,900 --> 00:25:59,400
in there and frankly it's here

728
00:25:59,400 --> 00:26:01,080
windows it's an operating system

729
00:26:01,080 --> 00:26:03,900
that is based on structures and so

730
00:26:03,900 --> 00:26:05,460
it's really interesting to have them

731
00:26:05,460 --> 00:26:06,750
at hand it allows you not to have to

732
00:26:06,750 --> 00:26:08,790
struggle on the msdn doc knowing that

733
00:26:08,790 --> 00:26:12,890
it  is not necessarily the most

734
00:26:12,890 --> 00:26:14,850
readable we will say

735
00:26:14,850 --> 00:26:16,230
is what I wanted to show you here

736
00:26:16,230 --> 00:26:18,690
is that on the left you have the

737
00:26:18,690 --> 00:26:23,100
structure of a surduts token on a

738
00:26:23,100 --> 00:26:25,590
windows 2003 os and on the right you have the

739
00:26:25,590 --> 00:26:28,140
same structure on a windows os  2011 and

740
00:26:28,140 --> 00:26:29,970
we see that ball is slightly

741
00:26:29,970 --> 00:26:31,530
different it is even very

742
00:26:31,530 --> 00:26:34,290
different and now I wanted to

743
00:26:34,290 --> 00:26:37,170
show this because I like I

744
00:26:37,170 --> 00:26:38,790
really like the way

745
00:26:38,790 --> 00:26:40,170
windows work and its structures and I

746
00:26:40,170 --> 00:26:41,430
find it exciting and heartwarming  p I

747
00:26:41,430 --> 00:26:42,270
wanted to show you this application

748
00:26:42,270 --> 00:26:45,620
for those who don't know it

749
00:26:46,040 --> 00:26:48,500
and how far we're going to go to see some of the

750
00:26:48,500 --> 00:26:50,680
code

751
00:26:51,550 --> 00:26:54,190
sorry

752
00:26:54,190 --> 00:26:56,529
so obviously I wrote a small

753
00:26:56,529 --> 00:27:00,460
tool that allows you to read the

754
00:27:00,460 --> 00:27:02,620
system memory to recover all the tocanes that are

755
00:27:02,620 --> 00:27:04,720
there  are present and then that allows one

756
00:27:04,720 --> 00:27:06,490
to impersonate one to run

757
00:27:06,490 --> 00:27:07,570
commands as another

758
00:27:07,570 --> 00:27:08,549
user

759
00:27:08,549 --> 00:27:11,649
that's all it's heavily based even

760
00:27:11,649 --> 00:27:13,210
a strong idea to it's greatly

761
00:27:13,210 --> 00:27:15,279
based on a tool a lot of people

762
00:27:15,279 --> 00:27:16,840
must know this  who changes event

763
00:27:16,840 --> 00:27:19,990
is who is the incognito suite

764
00:27:19,990 --> 00:27:22,040
that was integrated to interpret me

765
00:27:22,040 --> 00:27:24,620
it's a module so the only problem

766
00:27:24,620 --> 00:27:25,940
is that I wanted to have a

767
00:27:25,940 --> 00:27:28,460
static binary for a

768
00:27:28,460 --> 00:27:31,370
simple binary that only includes functions

769
00:27:31,370 --> 00:27:33,350
20-15 plus the minimum function to

770
00:27:33,350 --> 00:27:35,660
then be able to bypass a maximum

771
00:27:35,660 --> 00:27:37,460
of antivirus in fact you should know that

772
00:27:37,460 --> 00:27:41,770
when you have an executable the

773
00:27:41,860 --> 00:27:44,090
more it uses two functions of

774
00:27:44,090 --> 00:27:46,190
the country so the more codes

775
00:27:46,190 --> 00:27:47,990
it has the more chance it has  are flag greenhouses and the

776
00:27:47,990 --> 00:27:50,390
less you have - you have a chance

777
00:27:50,390 --> 00:27:51,860
of being flagged, so the idea

778
00:27:51,860 --> 00:27:54,050
was really to take my

779
00:27:54,050 --> 00:27:55,670
interpretations and keep only the

780
00:27:55,670 --> 00:27:57,410
functions that interest me, knowing

781
00:27:57,410 --> 00:27:59,960
that basically the  all incognitos come

782
00:27:59,960 --> 00:28:03,170
from 3 years old and packaged in 3 different binaries

783
00:28:03,170 --> 00:28:04,210


784
00:28:04,210 --> 00:28:06,980
but which for me to use here are too many

785
00:28:06,980 --> 00:28:08,200
functions

786
00:28:08,200 --> 00:28:09,850
I said to myself go go

787
00:28:09,850 --> 00:28:11,649
let's go we'll go we'll do our own

788
00:28:11,649 --> 00:28:12,909
thing

789
00:28:12,909 --> 00:28:15,669
and that's it  so you see

790
00:28:15,669 --> 00:28:17,109
it's not very very long it's

791
00:28:17,109 --> 00:28:19,809
about 300 15 lines of code we're going to jump

792
00:28:19,809 --> 00:28:21,249
is directly on the mail I

793
00:28:21,249 --> 00:28:24,129
spare you the structures of structures of

794
00:28:24,129 --> 00:28:25,509
structures the windows mode this and

795
00:28:25,509 --> 00:28:27,340
the implication structure c  it's a bit of a

796
00:28:27,340 --> 00:28:30,940
mess but suddenly we're going to look at the

797
00:28:30,940 --> 00:28:32,249
interesting part

798
00:28:32,249 --> 00:28:34,599
so the maine it will start with what they

799
00:28:34,599 --> 00:28:36,989
start by recovering

800
00:28:36,989 --> 00:28:39,570
a function

801
00:28:39,570 --> 00:28:42,600
we don't see it which is called a theory

802
00:28:42,600 --> 00:28:44,010
this system a training then this

803
00:28:44,010 --> 00:28:46,620
function it is useful why  not

804
00:28:46,620 --> 00:28:48,720
what will we p  allow to recruit a

805
00:28:48,720 --> 00:28:49,920
certain amount of information on the

806
00:28:49,920 --> 00:28:52,740
system and in particular the list of

807
00:28:52,740 --> 00:28:54,540
processes d would be from the list of tokens

808
00:28:54,540 --> 00:28:55,980
the list of objects which are used

809
00:28:55,980 --> 00:28:59,250
by windows so once we have

810
00:28:59,250 --> 00:29:01,470
recovered so there I am using the

811
00:29:01,470 --> 00:29:01,830
function

812
00:29:01,830 --> 00:29:03,320
[Music]

813
00:29:03,320 --> 00:29:05,010
I use the function of a

814
00:29:05,010 --> 00:29:06,900
scale uniform system technology I retrieve the

815
00:29:06,900 --> 00:29:09,570
information from the system pro and I

816
00:29:09,570 --> 00:29:13,380
store it in the handel table' a formation

817
00:29:13,380 --> 00:29:15,150
the zooms and to the maximum history that

818
00:29:15,150 --> 00:29:17,840
not everything can see well ok

819
00:29:17,840 --> 00:29:20,310
then I  I have a strong loop so for

820
00:29:20,310 --> 00:29:22,680
each young person who is present in this

821
00:29:22,680 --> 00:29:25,860
table so I specify a handel

822
00:29:25,860 --> 00:29:27,690
what is it is quite simply a pointer

823
00:29:27,690 --> 00:29:30,150
to a windows structure so when for

824
00:29:30,150 --> 00:29:31,980
example when you do an open in

825
00:29:31,980 --> 00:29:33,810
python on a file you get  a

826
00:29:33,810 --> 00:29:35,730
handel on this file which allows you

827
00:29:35,730 --> 00:29:37,950
to read but also to write teeth on

828
00:29:37,950 --> 00:29:39,570
windows it's the same it's just that

829
00:29:39,570 --> 00:29:40,830
here the lendl also

830
00:29:40,830 --> 00:29:42,120
allow access to objects a little more

831
00:29:42,120 --> 00:29:43,620
complicate a little more  s complex as

832
00:29:43,620 --> 00:29:46,140
here are the processes processes these kinds

833
00:29:46,140 --> 00:29:47,679
of things

834
00:29:47,679 --> 00:29:50,710
for each handel that is in it

835
00:29:50,710 --> 00:29:53,840
so I'm going to do an open process then

836
00:29:53,840 --> 00:29:56,419
open process it's a function that actually

837
00:29:56,419 --> 00:29:58,730
allows access to the content of a

838
00:29:58,730 --> 00:29:59,860
process

839
00:29:59,860 --> 00:30:01,399
why I'm doing  that simply

840
00:30:01,399 --> 00:30:02,710
because eyes

841
00:30:02,710 --> 00:30:04,940
when I wanted to deal and the

842
00:30:04,940 --> 00:30:06,080
primary poken it is at the heart of a

843
00:30:06,080 --> 00:30:08,720
personification are a title and

844
00:30:08,720 --> 00:30:10,490
would be finger processes so to be

845
00:30:10,490 --> 00:30:11,929
able to access this information

846
00:30:11,929 --> 00:30:13,789
I must be able to access the

847
00:30:13,789 --> 00:30:15,500
process to then be able  typing the

848
00:30:15,500 --> 00:30:17,470
contains

849
00:30:17,470 --> 00:30:20,500
then i'm just going to

850
00:30:20,500 --> 00:30:23,480
grab the unders that are present

851
00:30:23,480 --> 00:30:25,639
within this process again and

852
00:30:25,639 --> 00:30:27,649
i'm going all and i'm actually going to compare

853
00:30:27,649 --> 00:30:29,809
them to make sure the object that

854
00:30:29,809 --> 00:30:32,269
young retrieve and well in tokyo if  this is

855
00:30:32,269 --> 00:30:35,769
the case I store it in a in

856
00:30:35,769 --> 00:30:39,100
a table sorry

857
00:30:39,100 --> 00:30:43,250
and then I file it here so I

858
00:30:43,250 --> 00:30:44,930
display the several

859
00:30:44,930 --> 00:30:47,120
analytical information and an incremental value

860
00:30:47,120 --> 00:30:51,190
we will see it thaler I display at the

861
00:30:51,190 --> 00:30:54,260
ssi who owns the token he created

862
00:30:54,260 --> 00:30:56,540
what is his type what the primaries

863
00:30:56,540 --> 00:30:57,830
and sketches a prize meritas kane is

864
00:30:57,830 --> 00:30:58,820
what is a personal link of canes

865
00:30:58,820 --> 00:31:01,130
etc etc

866
00:31:01,130 --> 00:31:05,549
and finally last thing once we have

867
00:31:05,549 --> 00:31:06,660
the list  of the tokens you will see it

868
00:31:06,660 --> 00:31:08,970
after selling the demo it is possible to

869
00:31:08,970 --> 00:31:11,220
relaunch the tool to specify united

870
00:31:11,220 --> 00:31:13,380
token as well as a command to be executed

871
00:31:13,380 --> 00:31:14,780
and

872
00:31:14,780 --> 00:31:18,720
therefore it is this code blog there here the

873
00:31:18,720 --> 00:31:19,950
purpose is that it calls the

874
00:31:19,950 --> 00:31:21,990
duplicated function launch so this is a

875
00:31:21,990 --> 00:31:24,029
function that I wrote

876
00:31:24,029 --> 00:31:26,809
and which is defined here

877
00:31:27,380 --> 00:31:28,899
what the

878
00:31:28,899 --> 00:31:30,860
hell quite simply

879
00:31:30,860 --> 00:31:32,140
ok

880
00:31:32,140 --> 00:31:33,670
so the initiator token we want has

881
00:31:33,670 --> 00:31:35,530
personified

882
00:31:35,530 --> 00:31:37,510
and it creates a process as

883
00:31:37,510 --> 00:31:39,040
this user by taking  in the

884
00:31:39,040 --> 00:31:40,510
parameters the token so basically

885
00:31:40,510 --> 00:31:41,560
really literally what will

886
00:31:41,560 --> 00:31:43,360
happen is that I will crawl and the

887
00:31:43,360 --> 00:31:45,070
system I recover all the tokens that

888
00:31:45,070 --> 00:31:46,750
I find and as soon as I see that of the

889
00:31:46,750 --> 00:31:48,010
senator who interests me therefore in

890
00:31:48,010 --> 00:31:49,480
this case l  'domain administrator

891
00:31:49,480 --> 00:31:51,940
and well I take it I copy it  e and I me

892
00:31:51,940 --> 00:31:53,320
the title and I run

893
00:31:53,320 --> 00:31:56,340
commands as him

894
00:31:57,310 --> 00:32:01,419
which leads us to the second demo

895
00:32:05,940 --> 00:32:08,639
and same configuration on the left you have

896
00:32:08,639 --> 00:32:10,919
the 2019 server that we already compromised on the

897
00:32:10,919 --> 00:32:13,730
right the domain controllers

898
00:32:13,730 --> 00:32:18,029
excuse me and below  the remote shell

899
00:32:18,029 --> 00:32:20,899
that we obtained via Greek pc

900
00:32:20,899 --> 00:32:23,149
so here I show you that I am not

901
00:32:23,149 --> 00:32:24,039
a crook

902
00:32:24,039 --> 00:32:27,289
that I have activated windows defender

903
00:32:27,289 --> 00:32:30,099
that it is up to date

904
00:32:30,190 --> 00:32:31,570
and above all I show you that here is

905
00:32:31,570 --> 00:32:33,190
the administrative 20 I am connected  on the

906
00:32:33,190 --> 00:32:34,480
left as

907
00:32:34,480 --> 00:32:36,549
domain administrator so as we have seen then it is

908
00:32:36,549 --> 00:32:37,960
an interactive authentication

909
00:32:37,960 --> 00:32:38,950
I connected by entering my

910
00:32:38,950 --> 00:32:41,679
identifiers so inevitably there is a

911
00:32:41,679 --> 00:32:43,389
bonus deserves none lying around on the

912
00:32:43,389 --> 00:32:45,658
system

913
00:32:45,720 --> 00:32:47,799
so I also show you  the

914
00:32:47,799 --> 00:32:49,270
configuration was to show you

915
00:32:49,270 --> 00:32:50,740
that I did lied that I am not a

916
00:32:50,740 --> 00:32:52,080
charlatan

917
00:32:52,080 --> 00:32:54,150
here

918
00:32:54,150 --> 00:32:56,220
it is in the hands said p

919
00:32:56,220 --> 00:32:58,049
so the same as earlier at the

920
00:32:58,049 --> 00:33:00,270
root I deposited so the code that I

921
00:33:00,270 --> 00:33:02,320
have for you  shown compiled

922
00:33:02,320 --> 00:33:05,260
so persona binarism  read it

923
00:33:05,260 --> 00:33:07,420
I run it and there I'm a little

924
00:33:07,420 --> 00:33:08,740
special thing is that I feel the

925
00:33:08,740 --> 00:33:11,710
result good I think you'll

926
00:33:11,710 --> 00:33:14,590
not see very well but basically I feel the

927
00:33:14,590 --> 00:33:16,900
result of all in a text file

928
00:33:16,900 --> 00:33:18,850
why I'm doing this quite simply

929
00:33:18,850 --> 00:33:21,340
because  that the football batch on pc is a

930
00:33:21,340 --> 00:33:23,290
little messed up from time to time and the

931
00:33:23,290 --> 00:33:24,790
present case in fact it shows me is not the

932
00:33:24,790 --> 00:33:26,650
first 20 tokens on the system I

933
00:33:26,650 --> 00:33:27,700
only had the last three tries which does

934
00:33:27,700 --> 00:33:30,210
not interest me

935
00:33:34,429 --> 00:33:36,039


936
00:33:36,039 --> 00:33:38,049
of the order we can clearly see that it

937
00:33:38,049 --> 00:33:40,269
tells us who lists the tekken and there you

938
00:33:40,269 --> 00:33:41,559
have all the toxins that have been

939
00:33:41,559 --> 00:33:44,229
found on the machine so there are plenty

940
00:33:44,229 --> 00:33:45,669
of things that are interesting the

941
00:33:45,669 --> 00:33:47,019
first is that we have  primary tekken

942
00:33:47,019 --> 00:33:48,609
and being a personal canine

943
00:33:48,609 --> 00:33:50,679
you therefore have us prizes deserve in canada

944
00:33:50,679 --> 00:33:52,950
a person

945
00:33:53,370 --> 00:33:55,140
the second is that we have 22

946
00:33:55,140 --> 00:33:57,720
tocane so we still have a lot of things

947
00:33:57,720 --> 00:34:00,559
is good so there I have already underlined  but

948
00:34:00,559 --> 00:34:02,490
me if I wanted to show you it is

949
00:34:02,490 --> 00:34:05,070
also that we have taken for accounts

950
00:34:05,070 --> 00:34:06,870
which are  t not necessarily

951
00:34:06,870 --> 00:34:08,159
domain accounts have not necessarily user accounts

952
00:34:08,159 --> 00:34:09,690
we ad taken for

953
00:34:09,690 --> 00:34:12,510
local service accounts in dayton for

954
00:34:12,510 --> 00:34:14,960
nt system the contact and

955
00:34:14,960 --> 00:34:17,879
systems elsewhere I take advantage of it but if

956
00:34:17,879 --> 00:34:21,000
you have already touched it in roatan poté early  and

957
00:34:21,000 --> 00:34:22,918
all that is the following rothen on the touba side

958
00:34:22,918 --> 00:34:24,810
here it is more or less the

959
00:34:24,810 --> 00:34:26,489
same technique finally personifying a

960
00:34:26,489 --> 00:34:28,739
token and above all the one that

961
00:34:28,739 --> 00:34:30,570
interests us is the auto range of amd

962
00:34:30,570 --> 00:34:32,489
number 2 why because it  is a

963
00:34:32,489 --> 00:34:34,530
thing with a primary which is in the name of

964
00:34:34,530 --> 00:34:37,310
the domain administrator

965
00:34:37,480 --> 00:34:39,429
so that when you see it in the

966
00:34:39,429 --> 00:34:40,389
intrusion test it's really jacques

967
00:34:40,389 --> 00:34:42,629
pretends

968
00:34:42,870 --> 00:34:44,850
I do I relaunch the tool I specify

969
00:34:44,850 --> 00:34:46,710
the guide of the token that I want to

970
00:34:46,710 --> 00:34:48,270
personify  so in this case the

971
00:34:48,270 --> 00:34:50,250
crazy guide of two

972
00:34:50,250 --> 00:34:52,060
domain administrators

973
00:34:52,060 --> 00:34:54,580
and I provide him with a command so a

974
00:34:54,580 --> 00:34:55,870
simple command for once it's

975
00:34:55,870 --> 00:34:57,400
justin wang we just want to make sure that

976
00:34:57,400 --> 00:34:58,900
the tool works and that it is not  not

977
00:34:58,900 --> 00:35:00,000
blocked the

978
00:35:00,000 --> 00:35:02,680
same I feel the result in tai  lle

979
00:35:02,680 --> 00:35:05,260
in the file results point txt and there

980
00:35:05,260 --> 00:35:06,420
we see

981
00:35:06,420 --> 00:35:09,220
the output of the command so it tells me that

982
00:35:09,220 --> 00:35:10,360
there is a unified force

983
00:35:10,360 --> 00:35:12,339
the administrator of the domain

984
00:35:12,339 --> 00:35:13,960
and that he launched the command cmd points

985
00:35:13,960 --> 00:35:16,390
aimed with the argument guahma is there  the

986
00:35:16,390 --> 00:35:19,119
result well it's good that here is monnet

987
00:35:19,119 --> 00:35:20,289
white flag administrators including a

988
00:35:20,289 --> 00:35:22,080
domain administrator

989
00:35:22,080 --> 00:35:25,110
and just after I think yes here I

990
00:35:25,110 --> 00:35:26,270
type right or wrong

991
00:35:26,270 --> 00:35:28,290
to show you that I am not

992
00:35:28,290 --> 00:35:29,690
domain administrator

993
00:35:29,690 --> 00:35:32,160
I was system authorities on a server

994
00:35:32,160 --> 00:35:34,260
but  taking to task and had to

995
00:35:34,260 --> 00:35:35,520
publicly tocane and the domain administrator well

996
00:35:35,520 --> 00:35:37,050
I pretend to be

997
00:35:37,050 --> 00:35:40,320
him last thing I'm going to rerun the

998
00:35:40,320 --> 00:35:41,940
same command except this time I

999
00:35:41,940 --> 00:35:42,920
'm

1000
00:35:42,920 --> 00:35:45,780
going to explore the charles smb of the domain

1001
00:35:45,780 --> 00:35:48,090
controllers why am I doing this

1002
00:35:48,090 --> 00:35:49,560
because  if you can if you are

1003
00:35:49,560 --> 00:35:52,110
able to explore the expensive it is

1004
00:35:52,110 --> 00:35:54,510
dollars of the domain controller but

1005
00:35:54,510 --> 00:35:55,800
it is that you are local administrator

1006
00:35:55,800 --> 00:35:57,540
on the domain controller and therefore that

1007
00:35:57,540 --> 00:35:59,220
you are administrated  teur also of the

1008
00:35:59,220 --> 00:36:01,370
domain

1009
00:36:02,250 --> 00:36:04,510
lannan once again

1010
00:36:04,510 --> 00:36:07,830
I bet that I display the result

1011
00:36:08,549 --> 00:36:10,810
so here we have the result

1012
00:36:10,810 --> 00:36:13,090
once again a personification of

1013
00:36:13,090 --> 00:36:14,380
the administrator game the old how to

1014
00:36:14,380 --> 00:36:16,240
say baksaas backlash death for 1 voice

1015
00:36:16,240 --> 00:36:20,620
of local file it  is dollars and I have the

1016
00:36:20,620 --> 00:36:23,020
return of the c dollars so

1017
00:36:23,020 --> 00:36:25,840
I managed well to go to connect to the tc so

1018
00:36:25,840 --> 00:36:27,340
I am administrator of the death and therefore

1019
00:36:27,340 --> 00:36:28,930
I am administrator of the domain

1020
00:36:28,930 --> 00:36:30,730
why because at this point the

1021
00:36:30,730 --> 00:36:31,570
last thing I have left to  do

1022
00:36:31,570 --> 00:36:33,520
is to add me an account on the

1023
00:36:33,520 --> 00:36:34,870
domain and then to add it in the

1024
00:36:34,870 --> 00:36:36,430
tale in the domain administrators group

1025
00:36:36,430 --> 00:36:39,040
which I will show

1026
00:36:39,040 --> 00:36:39,940
you later because I

1027
00:36:39,940 --> 00:36:41,470
still brought you a small trophy  of a

1028
00:36:41,470 --> 00:36:44,110
mission on which I was able to do this

1029
00:36:44,110 --> 00:36:46,470
kind of thing

1030
00:36:47,130 --> 00:36:48,330
obviously I show you one last

1031
00:36:48,330 --> 00:36:49,340
time that here I did not cheat

1032
00:36:49,340 --> 00:36:51,750
windows defender did not complain he

1033
00:36:51,750 --> 00:36:55,220
said nothing and there is not even an alert

1034
00:36:59,350 --> 00:37:01,170
ok so here is

1035
00:37:01,170 --> 00:37:05,339
real intrusion so there good po  for

1036
00:37:05,339 --> 00:37:06,569
the background in fact I was in a penetration

1037
00:37:06,569 --> 00:37:08,299
test with one of my colleagues

1038
00:37:08,299 --> 00:37:10,589
and we ended up in a hotel

1039
00:37:10,589 --> 00:37:13,819
sorry a hotel a hospital

1040
00:37:24,020 --> 00:37:26,420
antoine I see you

1041
00:37:26,420 --> 00:37:28,309
here so suddenly we find ourselves

1042
00:37:28,309 --> 00:37:30,650
in a hospital sorry

1043
00:37:30,650 --> 00:37:33,030
and  we said to ourselves well well yeah it's a

1044
00:37:33,030 --> 00:37:34,740
hospital in general it's there is very

1045
00:37:34,740 --> 00:37:36,240
little budget so it's not the most

1046
00:37:36,240 --> 00:37:39,510
complicated thing to do to compromise to

1047
00:37:39,510 --> 00:37:42,059
compromise and yet in fact it's

1048
00:37:42,059 --> 00:37:43,349
well it was good  more complicated than

1049
00:37:43,349 --> 00:37:45,690
we thought all why because

1050
00:37:45,690 --> 00:37:47,520
quite simply he had both

1051
00:37:47,520 --> 00:37:49,280
a compromise upstream a few servers

1052
00:37:49,280 --> 00:37:52,770
but he had both antivirus and

1053
00:37:52,770 --> 00:37:55,049
d edf so from there all the one in

1054
00:37:55,049 --> 00:37:57,930
bassam and touched the base of the  wings sas

1055
00:37:57,930 --> 00:38:00,540
especially her sas in fact turned out to

1056
00:38:00,540 --> 00:38:01,890
be much more complicated than expected

1057
00:38:01,890 --> 00:38:03,450
and in fact it was simply not

1058
00:38:03,450 --> 00:38:05,760
possible we had mentioned no nonsense

1059
00:38:05,760 --> 00:38:09,390
two days to do this test is good

1060
00:38:09,390 --> 00:38:10,859
well in two days unfortunately we

1061
00:38:10,859 --> 00:38:11,790
did not have  not necessarily have the time to

1062
00:38:11,790 --> 00:38:13,530
develop a tool that will  rput to

1063
00:38:13,530 --> 00:38:16,220
bypass its security solutions

1064
00:38:16,220 --> 00:38:19,099
which I said to myself ok bomb to

1065
00:38:19,099 --> 00:38:21,839
death for death might as well test as much to

1066
00:38:21,839 --> 00:38:23,240
test a little bit

1067
00:38:23,240 --> 00:38:26,250
different attack vectors so I

1068
00:38:26,250 --> 00:38:28,950
used the binary that I showed you

1069
00:38:28,950 --> 00:38:32,520
and sorry rather before I listed  all

1070
00:38:32,520 --> 00:38:33,810
the users connected to the

1071
00:38:33,810 --> 00:38:35,849
jaycee servers until I came across a

1072
00:38:35,849 --> 00:38:37,859
domain administrator so the

1073
00:38:37,859 --> 00:38:39,930
administrator account I have of men shovels and to

1074
00:38:39,930 --> 00:38:42,630
which she had 29 and therefore among these

1075
00:38:42,630 --> 00:38:46,920
29 tocane there was indeed one

1076
00:38:46,920 --> 00:38:48,180
the domain administrator account which

1077
00:38:48,180 --> 00:38:50,790
were present sim allowed to create

1078
00:38:50,790 --> 00:38:53,130
a user on the domain

1079
00:38:53,130 --> 00:38:55,320
and add it to the contamines finally to the

1080
00:38:55,320 --> 00:38:57,859
admin group of the domain

1081
00:38:58,310 --> 00:39:00,930
obviously by passing both windev

1082
00:39:00,930 --> 00:39:03,990
and the end it was boutef and kaspersky and

1083
00:39:03,990 --> 00:39:05,490
the other if another solution of

1084
00:39:05,490 --> 00:39:07,850
security whose name I don't remember anymore

1085
00:39:07,850 --> 00:39:10,060
so it works here is

1086
00:39:10,060 --> 00:39:13,430
the question now it's how

1087
00:39:13,430 --> 00:39:16,570
we protect ourselves from this kind of attack

1088
00:39:16,570 --> 00:39:18,660
in fact there are several vectors of

1089
00:39:18,660 --> 00:39:21,670
the analysis the first finally the first  first

1090
00:39:21,670 --> 00:39:22,990
vector is to statically analyze

1091
00:39:22,990 --> 00:39:24,790
the executables to see that it

1092
00:39:24,790 --> 00:39:26,160
worked if you say

1093
00:39:26,160 --> 00:39:27,670
that's what I was telling you earlier

1094
00:39:27,670 --> 00:39:30,660
with 1004 the antivirus

1095
00:39:30,660 --> 00:39:32,770
will check a lot of things on the

1096
00:39:32,770 --> 00:39:33,850
binaries finally on the files that  in

1097
00:39:33,850 --> 00:39:36,520
particular you drop the binaries they will

1098
00:39:36,520 --> 00:39:37,510
look at what functions

1099
00:39:37,510 --> 00:39:38,860
they use are the

1100
00:39:38,860 --> 00:39:41,110
binaries signed and do they have an

1101
00:39:41,110 --> 00:39:43,930
earlier signature that

1102
00:39:43,930 --> 00:39:45,700
would identify them as

1103
00:39:45,700 --> 00:39:48,640
malicious vinaries so that's it  that's it,

1104
00:39:48,640 --> 00:39:49,900
that's the first step, it's the static analysis,

1105
00:39:49,900 --> 00:39:51,790
then we'll see the dynamic analysis,

1106
00:39:51,790 --> 00:39:53,620
so this one

1107
00:39:53,620 --> 00:39:55,210
actually aims to analyze the behavior of the

1108
00:39:55,210 --> 00:39:57,130
binary, so we could say that the

1109
00:39:57,130 --> 00:40:00,430
doctor is capable of analyzing  in fact to

1110
00:40:00,430 --> 00:40:02,080
see that when I executed my binary

1111
00:40:02,080 --> 00:40:04,300
in personal could bet and well first

1112
00:40:04,300 --> 00:40:05,680
of all I start by listing all

1113
00:40:05,680 --> 00:40:08,260
the weekends on the system then I will

1114
00:40:08,260 --> 00:40:10,390
go and duplicate one and create a

1115
00:40:10,390 --> 00:40:12,400
process with this token so there  it's

1116
00:40:12,400 --> 00:40:14,200
U  no logical sequence which shows all the same

1117
00:40:14,200 --> 00:40:15,240
that there is an

1118
00:40:15,240 --> 00:40:18,040
exploit which could probably be

1119
00:40:18,040 --> 00:40:19,640
underway

1120
00:40:19,640 --> 00:40:23,040
but above all in fact yeah and knowing

1121
00:40:23,040 --> 00:40:24,390
that once again it's the smells

1122
00:40:24,390 --> 00:40:26,329
and the experts who will no longer take care of it

1123
00:40:26,329 --> 00:40:28,819
obviously there are

1124
00:40:28,819 --> 00:40:31,609
bypass techniques  so

1125
00:40:31,609 --> 00:40:35,040
for those who have touched 6 whispers and

1126
00:40:35,040 --> 00:40:37,410
direct is sticking this kind of thing

1127
00:40:37,410 --> 00:40:39,869
well that will be more than enough for

1128
00:40:39,869 --> 00:40:42,270
past lease kind of solution I think but

1129
00:40:42,270 --> 00:40:45,240
above all in fact the first recce is

1130
00:40:45,240 --> 00:40:47,460
simply not to use not

1131
00:40:47,460 --> 00:40:48,270
to connect  with

1132
00:40:48,270 --> 00:40:50,099
domain administrator accounts on your

1133
00:40:50,099 --> 00:40:52,319
account outside the domains

1134
00:40:52,319 --> 00:40:54,030
the domain controllers so that's where

1135
00:40:54,030 --> 00:40:56,549
we give in all cases in

1136
00:40:56,549 --> 00:40:57,510
all all the intrusion tests

1137
00:40:57,510 --> 00:40:58,730
that we do

1138
00:40:58,730 --> 00:41:01,230
an administrator of the  domain that puts this

1139
00:41:01,230 --> 00:41:03,180
in place obviously it will mitigate

1140
00:41:03,180 --> 00:41:05,250
almost all attacks and it will

1141
00:41:05,250 --> 00:41:06,809
be very complicated to compromise the

1142
00:41:06,809 --> 00:41:08,819
domain simply because Basel

1143
00:41:08,819 --> 00:41:09,960
and the domain administrator accounts will

1144
00:41:09,960 --> 00:41:12,089
not be used.  never reachable in

1145
00:41:12,089 --> 00:41:13,710
fact for an attacker even if this one

1146
00:41:13,710 --> 00:41:16,369
compromises all the servers outside

1147
00:41:16,369 --> 00:41:19,700
the domain controller

1148
00:41:21,270 --> 00:41:25,040
ok good suddenly I put a little summary

1149
00:41:25,040 --> 00:41:27,270
so we saw that the

1150
00:41:27,270 --> 00:41:28,710
windows authentication is carried out by the

1151
00:41:28,710 --> 00:41:30,660
process and hell's ass  locally via

1152
00:41:30,660 --> 00:41:32,970
the low ham remotely by contacting

1153
00:41:32,970 --> 00:41:34,500
the domain controller so via the low

1154
00:41:34,500 --> 00:41:36,120
ltds once the authentication has been

1155
00:41:36,120 --> 00:41:37,640
validated

1156
00:41:37,640 --> 00:41:40,740
they know how to create a token in the name of

1157
00:41:40,740 --> 00:41:43,350
the user so it is rather than one

1158
00:41:43,350 --> 00:41:45,000
contains the name of luis de  the user

1159
00:41:45,000 --> 00:41:46,290
the groups in which he is present

1160
00:41:46,290 --> 00:41:48,050
the privileges associated with the user

1161
00:41:48,050 --> 00:41:49,800
the rates that they are

1162
00:41:49,800 --> 00:41:51,810
windows objects that can be manipulated the

1163
00:41:51,810 --> 00:41:53,100
condition of having sufficient privileges

1164
00:41:53,100 --> 00:41:55,770
therefore in general the

1165
00:41:55,770 --> 00:41:57,480
sufficiency and domain administrator privileges

1166
00:41:57,480 --> 00:41:58,830
if  you are one of the systems on the

1167
00:41:58,830 --> 00:42:01,590
machine it is perfect by duplicating

1168
00:42:01,590 --> 00:42:03,330
a user's tocane we can usurp

1169
00:42:03,330 --> 00:42:06,050
his identity but especially his privileges

1170
00:42:06,050 --> 00:42:08,070
and within the framework of an int test

1171
00:42:08,070 --> 00:42:10,890
internal rusion of the weekend administrator of

1172
00:42:10,890 --> 00:42:12,090
tekken of a domain administrator

1173
00:42:12,090 --> 00:42:14,430
but in fact it amounts to compromising

1174
00:42:14,430 --> 00:42:16,710
his account obtaining his privileges and

1175
00:42:16,710 --> 00:42:18,270
therefore in the end to compromising the small

1176
00:42:18,270 --> 00:42:20,460
directory a few words on the

1177
00:42:20,460 --> 00:42:21,840
mitigation once again as it is

1178
00:42:21,840 --> 00:42:23,640
an internal mechanism  we have seen that here is

1179
00:42:23,640 --> 00:42:25,590
windows created tokens when you

1180
00:42:25,590 --> 00:42:26,850
connect to the machine but also

1181
00:42:26,850 --> 00:42:28,580
finally when you connect

1182
00:42:28,580 --> 00:42:30,240
interactively to the machine but

1183
00:42:30,240 --> 00:42:32,670
also remotely so you can imagine the number

1184
00:42:32,670 --> 00:42:34,710
of tekken of a personification which are

1185
00:42:34,710 --> 00:42:36,150
created on an active directory

1186
00:42:36,150 --> 00:42:38,370
c network  is absolutely gigantic as

1187
00:42:38,370 --> 00:42:40,320
it is an internal mechanism of windows it

1188
00:42:40,320 --> 00:42:42,510
is very complicated or even I see

1189
00:42:42,510 --> 00:42:44,670
not really very complicated for

1190
00:42:44,670 --> 00:42:45,960
security solutions to detect the

1191
00:42:45,960 --> 00:42:49,530
tacc is the end point of this

1192
00:42:49,530 --> 00:42:50,820
presentation if I may say it is

1193
00:42:50,820 --> 00:42:55,280
really bah  here today we have

1194
00:42:55,330 --> 00:42:57,100
microsoft which develops more and

1195
00:42:57,100 --> 00:43:00,310
more security tools from third-party vendors

1196
00:43:00,310 --> 00:43:02,230
also we have antiviruses which are  have

1197
00:43:02,230 --> 00:43:04,390
relatives are potatoes we already have airs

1198
00:43:04,390 --> 00:43:06,430
of equiterre we have all that we will soon we

1199
00:43:06,430 --> 00:43:08,140
will have virtualization we already have

1200
00:43:08,140 --> 00:43:10,260
delta virtualization these kinds of things

1201
00:43:10,260 --> 00:43:13,240
saleh more and more complicated to

1202
00:43:13,240 --> 00:43:15,430
understand a machine but by

1203
00:43:15,430 --> 00:43:16,450
knowing by having a good

1204
00:43:16,450 --> 00:43:18,040
knowledge of deaths

1205
00:43:18,040 --> 00:43:20,440
internal operation of windows so the internal

1206
00:43:20,440 --> 00:43:22,330
well we will be able to either circumvent its

1207
00:43:22,330 --> 00:43:23,550
security solution

1208
00:43:23,550 --> 00:43:26,920
or quite simply here we are really

1209
00:43:26,920 --> 00:43:28,810
going to find techniques that will

1210
00:43:28,810 --> 00:43:31,630
allow us to get through and and by

1211
00:43:31,630 --> 00:43:33,040
exploiting legitimate behavior of

1212
00:43:33,040 --> 00:43:34,750
windows

1213
00:43:34,750 --> 00:43:37,909
[Music]

1214
00:43:38,430 --> 00:43:40,780
well here it is if you are interested

1215
00:43:40,780 --> 00:43:42,670
crazy people in front of the internal windows

1216
00:43:42,670 --> 00:43:45,010
know that there are books and in

1217
00:43:45,010 --> 00:43:49,240
part in particular two books that

1218
00:43:49,240 --> 00:43:50,980
cat that come out for each version of

1219
00:43:50,980 --> 00:43:53,740
windows which are the internal ones with the names

1220
00:43:53,740 --> 00:43:55,920
the internal windows sorry

1221
00:43:55,920 --> 00:43:57,940
it's  cobblestones that make 700 pages

1222
00:43:57,940 --> 00:43:59,320
each of us turn two for

1223
00:43:59,320 --> 00:44:02,710
each windows distribution and

1224
00:44:02,710 --> 00:44:04,210
that's good it's a hell of a cobblestone  olle and

1225
00:44:04,210 --> 00:44:05,950
you have to have to hang on but

1226
00:44:05,950 --> 00:44:08,860
once you've read that and well you'll

1227
00:44:08,860 --> 00:44:11,590
understand really well yeah it's

1228
00:44:11,590 --> 00:44:13,030
good I'm not hiding from you that I haven't

1229
00:44:13,030 --> 00:44:14,770
read everything a pretty few chapters only

1230
00:44:14,770 --> 00:44:17,710
the chapters that interest me  but here

1231
00:44:17,710 --> 00:44:20,310
it is a great job

1232
00:44:20,310 --> 00:44:22,330
it's a great job of synthesis

1233
00:44:22,330 --> 00:44:26,040
and explanations and so here it is then

1234
00:44:26,040 --> 00:44:28,380
for those who are interested

1235
00:44:28,380 --> 00:44:31,900
just here I created a year drawn skin

1236
00:44:31,900 --> 00:44:34,590
six months ago you will find the code

1237
00:44:34,590 --> 00:44:38,080
yes I don't  I don't have access to the internet well well

1238
00:44:38,080 --> 00:44:39,510
too bad

1239
00:44:39,510 --> 00:44:41,830
you'll find it good here you'll surely find

1240
00:44:41,830 --> 00:44:43,740


1241
00:44:43,740 --> 00:44:47,050
their shoulders fair with the code and then if

1242
00:44:47,050 --> 00:44:49,480
you have any questions you want to

1243
00:44:49,480 --> 00:44:50,740
ask me questions and chat with me

1244
00:44:50,740 --> 00:44:52,180
well here you have info from twitter

1245
00:44:52,180 --> 00:44:54,730
my blog  he said if you have any

1246
00:44:54,730 --> 00:44:56,890
questions now low I

1247
00:44:56,890 --> 00:44:58,680
'm listening

1248
00:44:58,680 --> 00:45:06,410
[Applause]

