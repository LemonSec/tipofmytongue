1
00:00:20,939 --> 00:00:22,800
so hello everyone my name is Ryan

2
00:00:22,800 --> 00:00:24,119
Thompson

3
00:00:24,119 --> 00:00:24,960
um we're today we're going to be talking

4
00:00:24,960 --> 00:00:26,640
about the registry keys and hopefully a

5
00:00:26,640 --> 00:00:29,279
way that's uh approachable for people

6
00:00:29,279 --> 00:00:30,720
who may not be as familiar with the

7
00:00:30,720 --> 00:00:32,340
Windows registry and we're going to be

8
00:00:32,340 --> 00:00:35,219
focusing more specifically on uh

9
00:00:35,219 --> 00:00:37,260
registry keys that have been abused by

10
00:00:37,260 --> 00:00:40,440
attackers for defensivision

11
00:00:40,440 --> 00:00:43,020
it's a little bit about me currently I

12
00:00:43,020 --> 00:00:45,239
work as a senior intrusion researcher at

13
00:00:45,239 --> 00:00:46,980
crowdstrike

14
00:00:46,980 --> 00:00:49,620
um I also do some work for stands uh on

15
00:00:49,620 --> 00:00:51,480
one of their forensics courses uh

16
00:00:51,480 --> 00:00:54,960
focused on uh Windows Mac Linux and

17
00:00:54,960 --> 00:00:56,940
cloud and containers forensics a little

18
00:00:56,940 --> 00:00:59,039
bit all over the place 3608 class so I

19
00:00:59,039 --> 00:01:00,719
do a little bit of teaching in previous

20
00:01:00,719 --> 00:01:02,579
lives I've talked to US military how to

21
00:01:02,579 --> 00:01:04,799
do Network thread hunting and I've done

22
00:01:04,799 --> 00:01:06,659
security consultant work for some

23
00:01:06,659 --> 00:01:09,540
Fortune 500 companies in a way way past

24
00:01:09,540 --> 00:01:12,420
life it seems like uh decades ago I used

25
00:01:12,420 --> 00:01:13,979
to actually be in procurement so I've

26
00:01:13,979 --> 00:01:16,680
been a little bit all over the place

27
00:01:16,680 --> 00:01:19,439
so what are we going to talk about today

28
00:01:19,439 --> 00:01:21,600
we're going to start by establishing a

29
00:01:21,600 --> 00:01:23,280
baseline I want to bring everyone up to

30
00:01:23,280 --> 00:01:24,960
the level they need to be able to speak

31
00:01:24,960 --> 00:01:28,799
about registry keys intelligently not

32
00:01:28,799 --> 00:01:30,240
it's not necessarily training class on

33
00:01:30,240 --> 00:01:31,560
register Keys you're not going to walk

34
00:01:31,560 --> 00:01:33,000
away from it being an expert but we're

35
00:01:33,000 --> 00:01:34,920
going to be speaking the same language

36
00:01:34,920 --> 00:01:37,380
we're then going to talk about how

37
00:01:37,380 --> 00:01:38,939
registered keys are used legitimately

38
00:01:38,939 --> 00:01:41,340
and how they're abused just at a high

39
00:01:41,340 --> 00:01:43,200
level kind of give you some some context

40
00:01:43,200 --> 00:01:45,900
for the data that we're looking at

41
00:01:45,900 --> 00:01:47,579
we're then going to dive into actual

42
00:01:47,579 --> 00:01:49,740
register Keys themselves looking first

43
00:01:49,740 --> 00:01:51,960
at artifact removal and then moving on

44
00:01:51,960 --> 00:01:54,720
to how you can leverage those keys to

45
00:01:54,720 --> 00:01:57,119
impair defenses so trip up the defender

46
00:01:57,119 --> 00:01:59,040
even shut down some certain defense

47
00:01:59,040 --> 00:02:00,840
certain defenses

48
00:02:00,840 --> 00:02:02,340
we'll summarize what we saw and then

49
00:02:02,340 --> 00:02:03,720
we'll talk about some recommendations on

50
00:02:03,720 --> 00:02:05,939
how to make things better or I guess in

51
00:02:05,939 --> 00:02:07,320
this case how to monitor for these

52
00:02:07,320 --> 00:02:09,060
things

53
00:02:09,060 --> 00:02:12,780
so opening up with Windows registry

54
00:02:12,780 --> 00:02:15,540
what is the Windows registry uh for the

55
00:02:15,540 --> 00:02:17,340
longest time for me is this black box

56
00:02:17,340 --> 00:02:20,220
that I knew not to touch unless uh I had

57
00:02:20,220 --> 00:02:21,959
an issue and then I would Google it I

58
00:02:21,959 --> 00:02:23,400
would very carefully enter in a command

59
00:02:23,400 --> 00:02:26,160
and I would I would send it and then I

60
00:02:26,160 --> 00:02:27,840
would I would kind of squint I'd restart

61
00:02:27,840 --> 00:02:29,760
my computer and if it turned back on

62
00:02:29,760 --> 00:02:31,800
that was a good thing that's where I was

63
00:02:31,800 --> 00:02:33,599
a while back and I think that's where a

64
00:02:33,599 --> 00:02:35,280
lot of people are even in the security

65
00:02:35,280 --> 00:02:37,020
field I don't think uh there's a lot of

66
00:02:37,020 --> 00:02:38,819
people that are very comfortable with it

67
00:02:38,819 --> 00:02:40,860
but at its course it's a place to store

68
00:02:40,860 --> 00:02:41,879
Aesthetics

69
00:02:41,879 --> 00:02:44,400
that's all the registry is now I'm going

70
00:02:44,400 --> 00:02:45,840
to oversimplify it so you're gonna have

71
00:02:45,840 --> 00:02:47,700
some windows pierced in here uh I wanted

72
00:02:47,700 --> 00:02:50,340
to throw things at me but at its core if

73
00:02:50,340 --> 00:02:51,780
you if you close your eyes and you

74
00:02:51,780 --> 00:02:54,000
imagine opening up an Explorer window

75
00:02:54,000 --> 00:02:56,340
and creating a bunch of folders

76
00:02:56,340 --> 00:02:58,980
directories nested in directories and

77
00:02:58,980 --> 00:03:00,480
then inside those folders you just put

78
00:03:00,480 --> 00:03:02,040
key value pairs

79
00:03:02,040 --> 00:03:06,060
you know dark mode on or off uh maybe we

80
00:03:06,060 --> 00:03:08,340
we say when the computer starts up start

81
00:03:08,340 --> 00:03:09,959
these applications it's really just a

82
00:03:09,959 --> 00:03:12,599
place to store settings

83
00:03:12,599 --> 00:03:15,900
so everyone in this room uh needs to

84
00:03:15,900 --> 00:03:17,340
kind of understand the language that I'm

85
00:03:17,340 --> 00:03:18,780
going to use and understand when I'm

86
00:03:18,780 --> 00:03:20,519
going to use it incorrectly and kind of

87
00:03:20,519 --> 00:03:22,920
kind of navigate that so let's take a

88
00:03:22,920 --> 00:03:25,680
look at some of the verbiage that we use

89
00:03:25,680 --> 00:03:27,959
first of all at that top level we're

90
00:03:27,959 --> 00:03:30,239
going to talk more about this hkey local

91
00:03:30,239 --> 00:03:31,800
machine that's an example of a key

92
00:03:31,800 --> 00:03:34,140
that's a top level folder or top level

93
00:03:34,140 --> 00:03:35,940
directory in the registry

94
00:03:35,940 --> 00:03:38,040
every folder underneath which once again

95
00:03:38,040 --> 00:03:39,780
we'll dive into a little bit more are

96
00:03:39,780 --> 00:03:41,760
going to be called sub keys

97
00:03:41,760 --> 00:03:44,640
I will incorrectly call the sub key a

98
00:03:44,640 --> 00:03:46,620
key just know that's the formal

99
00:03:46,620 --> 00:03:48,180
definition and then we're going to talk

100
00:03:48,180 --> 00:03:50,040
about some values inside those registry

101
00:03:50,040 --> 00:03:51,360
keys and these are where your settings

102
00:03:51,360 --> 00:03:52,980
live

103
00:03:52,980 --> 00:03:55,560
so that's just come to the level set

104
00:03:55,560 --> 00:03:57,000
now the good news is everyone in this

105
00:03:57,000 --> 00:03:58,920
room has interacted with registry keys

106
00:03:58,920 --> 00:04:01,680
probably indirectly

107
00:04:01,680 --> 00:04:03,959
so by the way there's going to be a lot

108
00:04:03,959 --> 00:04:07,080
of screenshots some of them even moving

109
00:04:07,080 --> 00:04:08,760
pictures so to speak and so if you want

110
00:04:08,760 --> 00:04:10,860
to move to the front either now or if

111
00:04:10,860 --> 00:04:12,900
you change your mind absolutely screwed

112
00:04:12,900 --> 00:04:14,580
up I try to make this as big as possible

113
00:04:14,580 --> 00:04:16,019
but some of the font is still pretty

114
00:04:16,019 --> 00:04:17,100
small

115
00:04:17,100 --> 00:04:19,139
so we've all interacted with a register

116
00:04:19,139 --> 00:04:20,699
key this is a very direct interaction

117
00:04:20,699 --> 00:04:22,620
you go into your settings you say I want

118
00:04:22,620 --> 00:04:24,780
this to go from light mode to dark mode

119
00:04:24,780 --> 00:04:26,400
there's a registry key that lives back

120
00:04:26,400 --> 00:04:29,280
there that says system uses light theme

121
00:04:29,280 --> 00:04:31,560
that'll be set to a zero or one that's a

122
00:04:31,560 --> 00:04:33,000
pretty obvious way that we interact with

123
00:04:33,000 --> 00:04:35,100
it but anytime you install an

124
00:04:35,100 --> 00:04:36,960
application anytime you open a document

125
00:04:36,960 --> 00:04:39,000
there are registry changes being made

126
00:04:39,000 --> 00:04:40,440
and so a lot of the time it's indirect

127
00:04:40,440 --> 00:04:44,180
and we're interacting with them

128
00:04:44,759 --> 00:04:46,199
we're going to very briefly touch on

129
00:04:46,199 --> 00:04:47,940
where these files live

130
00:04:47,940 --> 00:04:50,280
we are not going to to dwell on this

131
00:04:50,280 --> 00:04:52,259
please you know if you want to take

132
00:04:52,259 --> 00:04:54,120
notes you can but this is not where

133
00:04:54,120 --> 00:04:55,259
we're going to focus a lot of our time

134
00:04:55,259 --> 00:04:57,720
we're not going to get lost in the weeds

135
00:04:57,720 --> 00:04:59,460
there's a few different places it lives

136
00:04:59,460 --> 00:05:01,919
near your user directory under a folder

137
00:05:01,919 --> 00:05:04,440
called ntuser.dat and it also lives

138
00:05:04,440 --> 00:05:07,259
under Windows system 32 config now this

139
00:05:07,259 --> 00:05:08,520
is not what we're going to start talking

140
00:05:08,520 --> 00:05:09,720
about registry

141
00:05:09,720 --> 00:05:11,220
we are not going to start by saying hey

142
00:05:11,220 --> 00:05:12,300
yeah you got to open up the security

143
00:05:12,300 --> 00:05:14,220
file and you go here

144
00:05:14,220 --> 00:05:16,680
we abstract that a little bit we don't

145
00:05:16,680 --> 00:05:18,360
talk about the physical location we

146
00:05:18,360 --> 00:05:20,460
instead talk about The Logical location

147
00:05:20,460 --> 00:05:22,320
and so once again this looks very

148
00:05:22,320 --> 00:05:24,180
complicated don't worry we're going to

149
00:05:24,180 --> 00:05:26,039
simplify it we're gonna actually get rid

150
00:05:26,039 --> 00:05:27,300
of

151
00:05:27,300 --> 00:05:29,039
the physical files we're only going to

152
00:05:29,039 --> 00:05:31,500
focus on The Logical names

153
00:05:31,500 --> 00:05:32,880
now this is still pretty complicated

154
00:05:32,880 --> 00:05:34,080
you'll notice there's arrows going

155
00:05:34,080 --> 00:05:36,240
places that are getting cut off in this

156
00:05:36,240 --> 00:05:37,860
diagram a little bit and that's okay

157
00:05:37,860 --> 00:05:41,759
what this means is this current config

158
00:05:41,759 --> 00:05:43,919
is a subset

159
00:05:43,919 --> 00:05:46,440
of local machine so really the same data

160
00:05:46,440 --> 00:05:47,820
resides there's just a pointer to a

161
00:05:47,820 --> 00:05:48,720
different place

162
00:05:48,720 --> 00:05:51,000
that can get confusing as well let's

163
00:05:51,000 --> 00:05:52,919
simplify it again we're only going to

164
00:05:52,919 --> 00:05:56,340
focus on two of these major segments or

165
00:05:56,340 --> 00:05:57,560
hives

166
00:05:57,560 --> 00:06:00,479
and let's define them a little bit

167
00:06:00,479 --> 00:06:02,400
we're going to be looking at hkey local

168
00:06:02,400 --> 00:06:04,860
machine and H Key current user

169
00:06:04,860 --> 00:06:08,100
local machine is well settings for your

170
00:06:08,100 --> 00:06:09,780
entire machine it's not going to be

171
00:06:09,780 --> 00:06:12,780
dependent upon what users logged in and

172
00:06:12,780 --> 00:06:14,160
you're going to need a local admin to

173
00:06:14,160 --> 00:06:16,560
make changes to these

174
00:06:16,560 --> 00:06:17,820
on the other hand we're going to look at

175
00:06:17,820 --> 00:06:20,100
some current user registry keys and

176
00:06:20,100 --> 00:06:22,080
these can be modified by a standard user

177
00:06:22,080 --> 00:06:24,300
and only impact the active user that's

178
00:06:24,300 --> 00:06:25,979
actually logged in

179
00:06:25,979 --> 00:06:27,180
so

180
00:06:27,180 --> 00:06:28,800
that's it

181
00:06:28,800 --> 00:06:31,199
let's talk a little bit about registry

182
00:06:31,199 --> 00:06:32,819
keys and how they're normally interacted

183
00:06:32,819 --> 00:06:35,580
with and how adversaries are are

184
00:06:35,580 --> 00:06:37,020
actually going in and modifying those

185
00:06:37,020 --> 00:06:39,539
for their own needs

186
00:06:39,539 --> 00:06:40,979
I want to start off by saying there's no

187
00:06:40,979 --> 00:06:43,259
such thing as an evil register key

188
00:06:43,259 --> 00:06:45,479
these machines uh you know our systems

189
00:06:45,479 --> 00:06:46,919
and our applications are looking for

190
00:06:46,919 --> 00:06:49,199
certain keys to make judgments about how

191
00:06:49,199 --> 00:06:50,699
an application interacts or how our

192
00:06:50,699 --> 00:06:53,160
operating system interacts and for the

193
00:06:53,160 --> 00:06:55,440
most part they're all pretty benign

194
00:06:55,440 --> 00:06:57,720
right there's your settings that are set

195
00:06:57,720 --> 00:06:59,819
either on or off uh they're pointing to

196
00:06:59,819 --> 00:07:01,680
certain file locations and what happens

197
00:07:01,680 --> 00:07:03,479
is these mechanisms are abused by

198
00:07:03,479 --> 00:07:04,979
adversaries

199
00:07:04,979 --> 00:07:06,660
um but at their core they're all

200
00:07:06,660 --> 00:07:09,500
legitimate functions

201
00:07:09,660 --> 00:07:11,940
a lot of stuff on this slide not going

202
00:07:11,940 --> 00:07:13,680
to go through all of them I just want

203
00:07:13,680 --> 00:07:15,060
you to know that when a legitimate

204
00:07:15,060 --> 00:07:16,979
application interacts with the registry

205
00:07:16,979 --> 00:07:21,180
it's using this Advanced API 32 dll

206
00:07:21,180 --> 00:07:23,819
and it's sending these API calls and

207
00:07:23,819 --> 00:07:26,039
that's how a legitimate application will

208
00:07:26,039 --> 00:07:27,000
interact

209
00:07:27,000 --> 00:07:28,560
that's not to say a malicious

210
00:07:28,560 --> 00:07:29,940
application can't be written to use

211
00:07:29,940 --> 00:07:32,280
these same things but all your

212
00:07:32,280 --> 00:07:33,900
legitimate use cases are going to use

213
00:07:33,900 --> 00:07:36,419
this API

214
00:07:36,419 --> 00:07:38,460
now what I'm interested in

215
00:07:38,460 --> 00:07:40,919
uh specifically for this talk is

216
00:07:40,919 --> 00:07:44,099
how do I directly modify a specific

217
00:07:44,099 --> 00:07:46,560
registry key and registry value

218
00:07:46,560 --> 00:07:49,319
and so we can use a few different things

219
00:07:49,319 --> 00:07:52,139
I'm going to be using reg.exe you'll see

220
00:07:52,139 --> 00:07:54,539
that as reg add or reg delete and that's

221
00:07:54,539 --> 00:07:56,340
used from the command line

222
00:07:56,340 --> 00:07:58,380
Powershell can also be used and then

223
00:07:58,380 --> 00:08:00,599
there's a GUI called regedit

224
00:08:00,599 --> 00:08:02,819
it can either be used from the command

225
00:08:02,819 --> 00:08:05,220
line to say reg edit I want to make the

226
00:08:05,220 --> 00:08:07,319
changes in this dot reg file or you can

227
00:08:07,319 --> 00:08:08,460
pop it up you're going to see a lot of

228
00:08:08,460 --> 00:08:10,979
screenshots that I open up from reg edit

229
00:08:10,979 --> 00:08:14,099
it can be modified with a GUI

230
00:08:14,099 --> 00:08:15,900
so these are more interesting

231
00:08:15,900 --> 00:08:18,080
I'm not going to say no legitimate

232
00:08:18,080 --> 00:08:20,520
applications modify the registry this

233
00:08:20,520 --> 00:08:22,319
way I'm sure there's some that are

234
00:08:22,319 --> 00:08:23,940
poorly written that do it this way but

235
00:08:23,940 --> 00:08:25,740
for the most part you should keep an eye

236
00:08:25,740 --> 00:08:27,000
on these and we'll talk about that in

237
00:08:27,000 --> 00:08:29,960
the recommendation section

238
00:08:32,099 --> 00:08:34,559
so how do we know what's in the registry

239
00:08:34,559 --> 00:08:36,059
first of all I want to give a huge shout

240
00:08:36,059 --> 00:08:38,159
out to the friendly Community they do a

241
00:08:38,159 --> 00:08:41,099
ton of work doing investigations into

242
00:08:41,099 --> 00:08:43,380
the registry now what I have here may be

243
00:08:43,380 --> 00:08:44,520
a little bit hard to read from the back

244
00:08:44,520 --> 00:08:46,020
that's okay

245
00:08:46,020 --> 00:08:48,480
what this is is is the forensics

246
00:08:48,480 --> 00:08:49,860
Community is a lot of time having to do

247
00:08:49,860 --> 00:08:51,959
dead box forensics so they don't have

248
00:08:51,959 --> 00:08:53,700
access to a live machine they can't go

249
00:08:53,700 --> 00:08:55,500
in and see what settings are set they

250
00:08:55,500 --> 00:08:57,000
can't go see the history of things they

251
00:08:57,000 --> 00:08:58,380
don't have access to those applications

252
00:08:58,380 --> 00:09:00,360
so they need to know where that data

253
00:09:00,360 --> 00:09:02,100
lives and a lot of the times in the

254
00:09:02,100 --> 00:09:04,200
registry and so they do a ton of work

255
00:09:04,200 --> 00:09:08,000
and it's super super helpful

256
00:09:08,160 --> 00:09:09,779
another way you can do research and

257
00:09:09,779 --> 00:09:11,160
actually achieve what the forensics

258
00:09:11,160 --> 00:09:12,959
Community is after is by manually

259
00:09:12,959 --> 00:09:14,940
navigating that structure there's a ton

260
00:09:14,940 --> 00:09:16,860
of folders I was going to try to figure

261
00:09:16,860 --> 00:09:18,680
out how many

262
00:09:18,680 --> 00:09:21,720
keys and sub keys I had on my system I

263
00:09:21,720 --> 00:09:22,800
didn't spend a whole lot of time doing

264
00:09:22,800 --> 00:09:25,920
it just let's all agree that there's a

265
00:09:25,920 --> 00:09:27,060
ton

266
00:09:27,060 --> 00:09:28,380
um so I wouldn't want to go navigate

267
00:09:28,380 --> 00:09:29,880
these manually but you can that's

268
00:09:29,880 --> 00:09:31,920
absolutely a method and sometimes you

269
00:09:31,920 --> 00:09:34,080
find a key and you wonder I wonder

270
00:09:34,080 --> 00:09:35,519
I wonder what that does and sometimes

271
00:09:35,519 --> 00:09:37,080
Microsoft documents it and sometimes

272
00:09:37,080 --> 00:09:38,580
they don't

273
00:09:38,580 --> 00:09:41,160
the last one which I think is my

274
00:09:41,160 --> 00:09:43,200
personal favorite is by doing some level

275
00:09:43,200 --> 00:09:44,640
of monitoring

276
00:09:44,640 --> 00:09:46,920
so I have something like procmon running

277
00:09:46,920 --> 00:09:49,140
I'm looking at the Active register keys

278
00:09:49,140 --> 00:09:52,140
and I open up my brand new windows 11.

279
00:09:52,140 --> 00:09:54,120
and I start filtering down what I'm

280
00:09:54,120 --> 00:09:55,560
monitoring and I say great I think I've

281
00:09:55,560 --> 00:09:57,060
got I'm only looking at the settings

282
00:09:57,060 --> 00:09:59,459
application and I go and I flip a toggle

283
00:09:59,459 --> 00:10:01,920
and I see what registry key changes this

284
00:10:01,920 --> 00:10:04,380
is a really good way to do research

285
00:10:04,380 --> 00:10:06,060
um having said that I didn't use any of

286
00:10:06,060 --> 00:10:07,080
these

287
00:10:07,080 --> 00:10:08,940
I'm pretty fortunate where I work for

288
00:10:08,940 --> 00:10:11,700
that I get a really good uh signal to

289
00:10:11,700 --> 00:10:13,080
noise ratio

290
00:10:13,080 --> 00:10:15,779
from Real World intrusions and so all

291
00:10:15,779 --> 00:10:17,220
the data you're going to see from from

292
00:10:17,220 --> 00:10:19,080
this presentation comes from our

293
00:10:19,080 --> 00:10:20,940
OverWatch team at crowdstrike they do

294
00:10:20,940 --> 00:10:24,360
thread hunting and once they identify a

295
00:10:24,360 --> 00:10:25,980
intrusion they hand it over to my team

296
00:10:25,980 --> 00:10:28,860
we do post-mortem analysis so we get a

297
00:10:28,860 --> 00:10:31,380
lot of uh commands that are run actually

298
00:10:31,380 --> 00:10:33,420
by actual adversaries uh sometimes

299
00:10:33,420 --> 00:10:35,700
criminal groups sometimes nation state

300
00:10:35,700 --> 00:10:38,580
but we get a lot of really good data and

301
00:10:38,580 --> 00:10:40,200
so I'm it's pretty easy for me I don't

302
00:10:40,200 --> 00:10:41,640
need to go look at potential attacks I

303
00:10:41,640 --> 00:10:42,720
can just go look at what's actually

304
00:10:42,720 --> 00:10:44,579
being used in the wild so that's what's

305
00:10:44,579 --> 00:10:46,740
really cool about this uh every register

306
00:10:46,740 --> 00:10:49,140
key you've seen has been used in the

307
00:10:49,140 --> 00:10:51,540
wild uh by an adversary

308
00:10:51,540 --> 00:10:53,579
having said that

309
00:10:53,579 --> 00:10:55,440
we first of all I want to say we don't

310
00:10:55,440 --> 00:10:56,760
have screenshots we don't have the

311
00:10:56,760 --> 00:10:58,260
capability to go navigate our client

312
00:10:58,260 --> 00:10:59,940
systems and if we did we still wouldn't

313
00:10:59,940 --> 00:11:00,899
share it

314
00:11:00,899 --> 00:11:02,459
all the screenshots you're going to see

315
00:11:02,459 --> 00:11:04,740
are from a VM and have been recreated

316
00:11:04,740 --> 00:11:06,000
just want to make sure we get that out

317
00:11:06,000 --> 00:11:07,260
of the way nobody thinks I'm sharing

318
00:11:07,260 --> 00:11:08,640
client data up here

319
00:11:08,640 --> 00:11:10,440
and then the last piece is we're

320
00:11:10,440 --> 00:11:12,120
focusing on intent

321
00:11:12,120 --> 00:11:14,399
we're not focused on if Falcon blocked

322
00:11:14,399 --> 00:11:16,019
it or if you can get past Windows

323
00:11:16,019 --> 00:11:17,279
Defender with this

324
00:11:17,279 --> 00:11:19,019
my team specifically is focused on what

325
00:11:19,019 --> 00:11:20,820
are adversaries trying to do

326
00:11:20,820 --> 00:11:22,860
let's document that and let's kind of

327
00:11:22,860 --> 00:11:25,200
disperse that to the community at Large

328
00:11:25,200 --> 00:11:27,839
so intent is the focus here

329
00:11:27,839 --> 00:11:29,579
so first and foremost we're going to

330
00:11:29,579 --> 00:11:32,220
start by focusing on individual registry

331
00:11:32,220 --> 00:11:35,040
keys that impact uh artifacts and more

332
00:11:35,040 --> 00:11:38,420
importantly remove those artifacts

333
00:11:38,899 --> 00:11:42,240
very very small kill chain-esque here I

334
00:11:42,240 --> 00:11:44,040
just wanted to kind of set the stage for

335
00:11:44,040 --> 00:11:46,140
what we're looking at an adversary gains

336
00:11:46,140 --> 00:11:47,820
access they probably do a little bit of

337
00:11:47,820 --> 00:11:49,459
digging around a little bit of Discovery

338
00:11:49,459 --> 00:11:52,380
uh and sometimes what will happen is

339
00:11:52,380 --> 00:11:54,180
they'll say you know I would really like

340
00:11:54,180 --> 00:11:56,279
to to be able to move around a little

341
00:11:56,279 --> 00:11:59,100
bit more freely maybe open up some form

342
00:11:59,100 --> 00:12:00,540
of persistence and be able to walk back

343
00:12:00,540 --> 00:12:02,579
in kind of leave a door or a jar in this

344
00:12:02,579 --> 00:12:05,399
environment maybe I want to interact

345
00:12:05,399 --> 00:12:08,100
with with a a home directory or or pull

346
00:12:08,100 --> 00:12:10,440
things down and not impact a user that

347
00:12:10,440 --> 00:12:13,200
exists as users we may notice if things

348
00:12:13,200 --> 00:12:15,720
pop up in our documents folder I don't

349
00:12:15,720 --> 00:12:16,500
know about you I probably wouldn't

350
00:12:16,500 --> 00:12:18,060
notice if it dropped into my downloads

351
00:12:18,060 --> 00:12:21,000
folder it's a mess right but if an

352
00:12:21,000 --> 00:12:23,160
attacker can open up a new one that

353
00:12:23,160 --> 00:12:24,600
segments them a little bit from the user

354
00:12:24,600 --> 00:12:25,860
since the less likely they're going to

355
00:12:25,860 --> 00:12:26,880
be seen

356
00:12:26,880 --> 00:12:29,040
now the problem is

357
00:12:29,040 --> 00:12:31,019
users may still notice that additional

358
00:12:31,019 --> 00:12:33,060
user being created that extra user

359
00:12:33,060 --> 00:12:34,320
floating around that wasn't there before

360
00:12:34,320 --> 00:12:36,839
so that is where they make the register

361
00:12:36,839 --> 00:12:40,500
key change let's take a look at that

362
00:12:40,500 --> 00:12:42,240
real quick caveat there's going to be

363
00:12:42,240 --> 00:12:44,519
registry keys along the top here

364
00:12:44,519 --> 00:12:46,500
I'm not going to read those out that

365
00:12:46,500 --> 00:12:47,399
doesn't make for an interesting

366
00:12:47,399 --> 00:12:49,320
presentation it's a lot of slashes I'm

367
00:12:49,320 --> 00:12:51,360
going to mess it up but at the end I'll

368
00:12:51,360 --> 00:12:52,800
give you a link and I'll have references

369
00:12:52,800 --> 00:12:54,779
to all these and then please feel free

370
00:12:54,779 --> 00:12:56,100
to reach out to me I can send you the

371
00:12:56,100 --> 00:12:58,079
slides as well so I'm going to focus on

372
00:12:58,079 --> 00:12:59,760
the activity that's happening here

373
00:12:59,760 --> 00:13:01,260
there's a screenshot on the left hand

374
00:13:01,260 --> 00:13:03,120
side there's usually I've created called

375
00:13:03,120 --> 00:13:04,500
Susan storm

376
00:13:04,500 --> 00:13:07,380
and every time I log in Susan Storm's

377
00:13:07,380 --> 00:13:09,180
name there I can click on that one and

378
00:13:09,180 --> 00:13:10,440
log in

379
00:13:10,440 --> 00:13:12,060
once I make that registry key change

380
00:13:12,060 --> 00:13:14,880
I've I've added a value to the special

381
00:13:14,880 --> 00:13:17,519
accounts user list called Susan storm

382
00:13:17,519 --> 00:13:19,800
I've set it to one

383
00:13:19,800 --> 00:13:21,620
to be truthful I don't know the the

384
00:13:21,620 --> 00:13:24,180
intent behind this register key but what

385
00:13:24,180 --> 00:13:26,880
happens is it starts disappearing

386
00:13:26,880 --> 00:13:29,820
from your your interfaces so it doesn't

387
00:13:29,820 --> 00:13:31,980
just happen on the login screen but all

388
00:13:31,980 --> 00:13:33,300
of a sudden you won't see that as an

389
00:13:33,300 --> 00:13:35,040
option

390
00:13:35,040 --> 00:13:37,019
when you click your start menu normally

391
00:13:37,019 --> 00:13:39,000
you can click on your user and you can

392
00:13:39,000 --> 00:13:40,740
see other users that you can log into

393
00:13:40,740 --> 00:13:43,019
you can switch users once you set that

394
00:13:43,019 --> 00:13:45,300
key once again it's disappeared there as

395
00:13:45,300 --> 00:13:46,920
well so it's just a way to kind of tuck

396
00:13:46,920 --> 00:13:48,959
away you also can't see the home

397
00:13:48,959 --> 00:13:51,420
directory of that user of course if you

398
00:13:51,420 --> 00:13:52,800
really dig in the registry you can you

399
00:13:52,800 --> 00:13:54,360
can find evidence that that user exists

400
00:13:54,360 --> 00:13:56,040
but for the average user navigating the

401
00:13:56,040 --> 00:13:58,320
system you won't notice it

402
00:13:58,320 --> 00:14:00,660
the last place that vanishes is in the

403
00:14:00,660 --> 00:14:02,639
settings themselves so I'm under family

404
00:14:02,639 --> 00:14:05,040
and other users you can see Susan storm

405
00:14:05,040 --> 00:14:06,420
all of a sudden

406
00:14:06,420 --> 00:14:08,940
they're gone that user's still there I

407
00:14:08,940 --> 00:14:10,740
can still interact with them you can

408
00:14:10,740 --> 00:14:12,720
actually uh

409
00:14:12,720 --> 00:14:16,320
set that user to remove their their home

410
00:14:16,320 --> 00:14:18,240
directory entirely

411
00:14:18,240 --> 00:14:20,040
and you can still log in there's an

412
00:14:20,040 --> 00:14:21,360
error that pops up and it still seems

413
00:14:21,360 --> 00:14:22,740
fully functional to me so you can do a

414
00:14:22,740 --> 00:14:25,740
pretty good job of hiding these users

415
00:14:25,740 --> 00:14:27,480
that's our first artifact

416
00:14:27,480 --> 00:14:29,399
our second artifact is you're just going

417
00:14:29,399 --> 00:14:32,399
to barely touch on on activity uh

418
00:14:32,399 --> 00:14:34,260
artifacts so what do I mean by activity

419
00:14:34,260 --> 00:14:36,740
artifacts

420
00:14:37,200 --> 00:14:39,360
avistro gains access they start doing

421
00:14:39,360 --> 00:14:41,040
some file system navigation start

422
00:14:41,040 --> 00:14:43,500
digging around some and maybe they start

423
00:14:43,500 --> 00:14:45,060
executing some applications that are

424
00:14:45,060 --> 00:14:47,160
native to the system now this is going

425
00:14:47,160 --> 00:14:51,300
to cause uh a lot of uh digital

426
00:14:51,300 --> 00:14:52,920
Footprints I guess the best way to put

427
00:14:52,920 --> 00:14:55,380
that and if you are

428
00:14:55,380 --> 00:14:57,720
you know if you spend any time in the

429
00:14:57,720 --> 00:14:59,459
forensics world you know that every

430
00:14:59,459 --> 00:15:01,560
click you're you're making every thing

431
00:15:01,560 --> 00:15:02,639
that you're doing in the windows

432
00:15:02,639 --> 00:15:04,199
environment is being tracked usually by

433
00:15:04,199 --> 00:15:05,519
the registry

434
00:15:05,519 --> 00:15:07,139
and so we have some of our more advanced

435
00:15:07,139 --> 00:15:08,459
adversaries actually removing those

436
00:15:08,459 --> 00:15:09,660
artifacts so that's what we're going to

437
00:15:09,660 --> 00:15:11,639
take a look at

438
00:15:11,639 --> 00:15:12,899
the first one we're going to take a look

439
00:15:12,899 --> 00:15:15,000
at is typed paths

440
00:15:15,000 --> 00:15:18,240
so I can go into Windows Explorer and I

441
00:15:18,240 --> 00:15:20,279
can type a full path to where I want to

442
00:15:20,279 --> 00:15:22,620
go and it'll take me right there

443
00:15:22,620 --> 00:15:23,760
cool thing you can do is you can

444
00:15:23,760 --> 00:15:25,860
actually type in CMD or Powershell and

445
00:15:25,860 --> 00:15:29,100
it'll open up a command line or a

446
00:15:29,100 --> 00:15:30,600
Powershell directly to that directory

447
00:15:30,600 --> 00:15:32,820
and as you can see

448
00:15:32,820 --> 00:15:35,220
as you can see when you go and you click

449
00:15:35,220 --> 00:15:36,240
that drop down

450
00:15:36,240 --> 00:15:38,399
it gives you a history of where you've

451
00:15:38,399 --> 00:15:39,120
been

452
00:15:39,120 --> 00:15:41,279
and so there's going to be kind of a

453
00:15:41,279 --> 00:15:42,959
theme here with these types of artifacts

454
00:15:42,959 --> 00:15:45,540
anytime you get any convenience from for

455
00:15:45,540 --> 00:15:47,760
Windows they're gonna have to track that

456
00:15:47,760 --> 00:15:49,199
somewhere

457
00:15:49,199 --> 00:15:51,120
and so all those live under this

458
00:15:51,120 --> 00:15:53,639
Explorer typed path and you can see you

459
00:15:53,639 --> 00:15:55,860
know CMD documents desktop downloads

460
00:15:55,860 --> 00:15:58,560
full file paths all these exist so if

461
00:15:58,560 --> 00:16:00,420
you're an adversary that has rdp'd into

462
00:16:00,420 --> 00:16:02,100
an environment and this is the way you

463
00:16:02,100 --> 00:16:03,860
choose to navigate

464
00:16:03,860 --> 00:16:05,940
all this evidence is going to be there

465
00:16:05,940 --> 00:16:08,639
even if the system has been shut down

466
00:16:08,639 --> 00:16:10,440
so of course what do you want to do

467
00:16:10,440 --> 00:16:12,540
you want to get rid of it

468
00:16:12,540 --> 00:16:14,399
and so in this case we're going to open

469
00:16:14,399 --> 00:16:15,600
it up we're going to see that those

470
00:16:15,600 --> 00:16:16,500
exist

471
00:16:16,500 --> 00:16:18,240
we're going to make this registry key

472
00:16:18,240 --> 00:16:19,620
change

473
00:16:19,620 --> 00:16:21,300
and all of a sudden we're going to

474
00:16:21,300 --> 00:16:24,240
refresh our our registry

475
00:16:24,240 --> 00:16:25,380
we're going to notice that they

476
00:16:25,380 --> 00:16:27,779
disappeared

477
00:16:27,779 --> 00:16:30,000
we open up Explorer again

478
00:16:30,000 --> 00:16:32,339
and all of a sudden they're gone

479
00:16:32,339 --> 00:16:34,079
and so that's a great way for them to

480
00:16:34,079 --> 00:16:36,180
hide that activity that they've done

481
00:16:36,180 --> 00:16:38,519
and this is by far not the only place

482
00:16:38,519 --> 00:16:41,540
where this exists

483
00:16:41,880 --> 00:16:43,199
there's another place that I'm going to

484
00:16:43,199 --> 00:16:45,420
talk about it's called run mru mru

485
00:16:45,420 --> 00:16:47,639
stands for most recently used and so

486
00:16:47,639 --> 00:16:49,800
we're looking for uh we're looking at

487
00:16:49,800 --> 00:16:51,180
the Run command here where you can

488
00:16:51,180 --> 00:16:53,519
launch applications this also has a

489
00:16:53,519 --> 00:16:55,680
history so if you've gone through and

490
00:16:55,680 --> 00:16:57,540
ran multiple commands you see that

491
00:16:57,540 --> 00:16:59,459
Windows kindly provides that to you they

492
00:16:59,459 --> 00:17:01,079
say hey here's the drop down you can run

493
00:17:01,079 --> 00:17:02,940
in these again

494
00:17:02,940 --> 00:17:04,980
these of course exist somewhere

495
00:17:04,980 --> 00:17:06,959
in the registry interesting thing about

496
00:17:06,959 --> 00:17:08,099
this

497
00:17:08,099 --> 00:17:09,859
Microsoft doesn't keep an order

498
00:17:09,859 --> 00:17:12,179
necessarily of these uh in the way that

499
00:17:12,179 --> 00:17:13,559
you would expect

500
00:17:13,559 --> 00:17:15,900
so they say great you ran CMD we're

501
00:17:15,900 --> 00:17:17,880
going to assign that a letter

502
00:17:17,880 --> 00:17:19,380
you ran Chrome we're going to send that

503
00:17:19,380 --> 00:17:20,520
a letter

504
00:17:20,520 --> 00:17:23,280
and if you think about it let's say

505
00:17:23,280 --> 00:17:25,799
you ran command first you run a bunch of

506
00:17:25,799 --> 00:17:27,900
others and then you run command again

507
00:17:27,900 --> 00:17:30,600
in a traditional ordered list you'd have

508
00:17:30,600 --> 00:17:32,220
to rearrange everything all of a sudden

509
00:17:32,220 --> 00:17:35,100
command would have to be you know F then

510
00:17:35,100 --> 00:17:36,240
everything would have to reshuffle

511
00:17:36,240 --> 00:17:40,020
that's not how run uh mru actually works

512
00:17:40,020 --> 00:17:42,840
they have a list down here that

513
00:17:42,840 --> 00:17:44,400
indicates the order that your

514
00:17:44,400 --> 00:17:46,620
applications ran and so that's kind of

515
00:17:46,620 --> 00:17:48,480
cool it's an efficiency mechanism that

516
00:17:48,480 --> 00:17:50,640
was put in place long ago but it shows

517
00:17:50,640 --> 00:17:52,679
that hey these are the orders your e

518
00:17:52,679 --> 00:17:55,020
entry was ran uh most recently followed

519
00:17:55,020 --> 00:17:57,960
by fdcba and so it keeps the parameter

520
00:17:57,960 --> 00:17:59,280
to make too many registry changes

521
00:17:59,280 --> 00:18:01,500
probably for efficiency

522
00:18:01,500 --> 00:18:04,380
so let's nuke it

523
00:18:04,380 --> 00:18:06,179
you can completely wipe this with a

524
00:18:06,179 --> 00:18:08,400
single command and all of a sudden we

525
00:18:08,400 --> 00:18:11,400
refresh that it's gone I opened up uh I

526
00:18:11,400 --> 00:18:13,620
never closed run so you'll notice that

527
00:18:13,620 --> 00:18:15,179
that history still exists whenever you

528
00:18:15,179 --> 00:18:17,520
close it and reopen it it'll be empty so

529
00:18:17,520 --> 00:18:18,960
there's tons of these I could spend a

530
00:18:18,960 --> 00:18:21,419
whole talk on forensics artifacts of hey

531
00:18:21,419 --> 00:18:23,340
here's what a user is done let's get rid

532
00:18:23,340 --> 00:18:25,380
of it but those are two clear signs of

533
00:18:25,380 --> 00:18:28,580
it we do see this in the wild

534
00:18:30,480 --> 00:18:33,360
all right this is a fun one

535
00:18:33,360 --> 00:18:35,039
this is a little peek behind the curtain

536
00:18:35,039 --> 00:18:37,200
in terms of how things work so let's say

537
00:18:37,200 --> 00:18:38,760
you're an adversary you've established

538
00:18:38,760 --> 00:18:40,679
uh you know a footholded environment and

539
00:18:40,679 --> 00:18:41,820
you want to set up some level of

540
00:18:41,820 --> 00:18:43,260
persistence

541
00:18:43,260 --> 00:18:44,820
a good way to do that is to use an

542
00:18:44,820 --> 00:18:46,980
authentic tool a legitimate tool that's

543
00:18:46,980 --> 00:18:48,840
out there so I'm going to pick on any

544
00:18:48,840 --> 00:18:50,640
desk here for just a second not because

545
00:18:50,640 --> 00:18:52,320
I think they're a bad product they put

546
00:18:52,320 --> 00:18:53,580
out a great product

547
00:18:53,580 --> 00:18:56,280
but adversaries are used in this all the

548
00:18:56,280 --> 00:18:58,860
time we see a terror agent any of these

549
00:18:58,860 --> 00:19:01,620
remote access softwares are being used

550
00:19:01,620 --> 00:19:04,080
by avicers it's going to fly by AV

551
00:19:04,080 --> 00:19:06,600
because it's not malware it's signed

552
00:19:06,600 --> 00:19:07,980
they're usually downloading it from a

553
00:19:07,980 --> 00:19:09,600
legitimate source and they're installing

554
00:19:09,600 --> 00:19:11,820
it on the system and it gives them a

555
00:19:11,820 --> 00:19:14,100
back door into that system

556
00:19:14,100 --> 00:19:16,140
so of course the question is how do we

557
00:19:16,140 --> 00:19:17,940
get rid of it now I'm only going to

558
00:19:17,940 --> 00:19:21,000
focus on one particular artifact uh that

559
00:19:21,000 --> 00:19:22,559
we can remove to actually hide that

560
00:19:22,559 --> 00:19:23,640
application but I think it's an

561
00:19:23,640 --> 00:19:26,120
interesting one

562
00:19:26,940 --> 00:19:29,100
this used to be called add or remove

563
00:19:29,100 --> 00:19:30,720
programs now it's called apps and

564
00:19:30,720 --> 00:19:32,940
features in Windows 10. but we're

565
00:19:32,940 --> 00:19:34,320
probably all pretty familiar with this

566
00:19:34,320 --> 00:19:36,299
and up until I did this research I

567
00:19:36,299 --> 00:19:37,620
thought that just gets populated by

568
00:19:37,620 --> 00:19:39,840
Magic I don't know how it works I

569
00:19:39,840 --> 00:19:41,640
install an application sometimes it's

570
00:19:41,640 --> 00:19:43,559
there sometimes it's not and I cannot

571
00:19:43,559 --> 00:19:45,900
install things right

572
00:19:45,900 --> 00:19:48,000
well of course registry has all the

573
00:19:48,000 --> 00:19:49,919
answers when you start digging into it

574
00:19:49,919 --> 00:19:51,840
I'm going to point out two specific ones

575
00:19:51,840 --> 00:19:53,880
here there's display name and there's

576
00:19:53,880 --> 00:19:55,620
uninstall string

577
00:19:55,620 --> 00:19:58,919
and so as long as long as display name

578
00:19:58,919 --> 00:20:00,600
shows up

579
00:20:00,600 --> 00:20:03,120
it'll be on this list

580
00:20:03,120 --> 00:20:05,580
as long as the uninstalled string has

581
00:20:05,580 --> 00:20:07,200
something in it

582
00:20:07,200 --> 00:20:09,720
this button will exist otherwise it'll

583
00:20:09,720 --> 00:20:11,700
be grayed out those are the the minimum

584
00:20:11,700 --> 00:20:13,380
two things you have to have you'll

585
00:20:13,380 --> 00:20:15,900
notice also there's display icon in here

586
00:20:15,900 --> 00:20:18,179
and so of course the part of my brain

587
00:20:18,179 --> 00:20:19,799
that likes to break things makes me want

588
00:20:19,799 --> 00:20:22,020
to wonder hey what can I do with this to

589
00:20:22,020 --> 00:20:25,500
really mess with a user and force them

590
00:20:25,500 --> 00:20:27,179
to maybe uninstall their browsers that's

591
00:20:27,179 --> 00:20:28,440
not where we're going with this but

592
00:20:28,440 --> 00:20:29,520
there's a lot of fun to be had here

593
00:20:29,520 --> 00:20:31,559
let's just put it that way

594
00:20:31,559 --> 00:20:34,020
so how do we hide something

595
00:20:34,020 --> 00:20:35,760
uh like let's say maybe I've installed

596
00:20:35,760 --> 00:20:38,220
any disk it's actually pretty easy we

597
00:20:38,220 --> 00:20:40,860
run this command now you'll notice that

598
00:20:40,860 --> 00:20:42,660
um we go to this current version

599
00:20:42,660 --> 00:20:45,120
uninstall sub key and then you have to

600
00:20:45,120 --> 00:20:48,059
specific you have to specify which app

601
00:20:48,059 --> 00:20:50,160
you want to to kind of go after here and

602
00:20:50,160 --> 00:20:52,140
so in this case it'd be any desk

603
00:20:52,140 --> 00:20:54,600
I think the command I have up there uh

604
00:20:54,600 --> 00:20:56,400
is removing everything but the command I

605
00:20:56,400 --> 00:20:58,559
run here just removes that display name

606
00:20:58,559 --> 00:21:00,840
so as long as you remove display name

607
00:21:00,840 --> 00:21:02,580
it's no longer going to be there I'm

608
00:21:02,580 --> 00:21:03,960
going to go and remove it

609
00:21:03,960 --> 00:21:05,580
refresh my registry you'll notice that

610
00:21:05,580 --> 00:21:08,100
it disappears

611
00:21:08,100 --> 00:21:10,320
click off of apps and

612
00:21:10,320 --> 00:21:12,240
features click back on and it's gone

613
00:21:12,240 --> 00:21:14,700
it's just a good way to hide that that

614
00:21:14,700 --> 00:21:17,280
uh element and hide those tracks once

615
00:21:17,280 --> 00:21:19,260
again you kind of solve those pieces you

616
00:21:19,260 --> 00:21:20,640
can change the icon you can change the

617
00:21:20,640 --> 00:21:22,740
string that's executed once you click

618
00:21:22,740 --> 00:21:24,179
uninstall there's all kinds of fun stuff

619
00:21:24,179 --> 00:21:26,840
you can do in there

620
00:21:27,000 --> 00:21:28,860
all right we're shifting gears a little

621
00:21:28,860 --> 00:21:31,500
bit we've been covering our tracks now I

622
00:21:31,500 --> 00:21:34,200
want to focus on in pairing defenses so

623
00:21:34,200 --> 00:21:36,120
the first one is going to really talk

624
00:21:36,120 --> 00:21:38,400
about how we can almost bypass a certain

625
00:21:38,400 --> 00:21:40,200
defenses that's in place and then we're

626
00:21:40,200 --> 00:21:41,159
going to get a little bit more fun with

627
00:21:41,159 --> 00:21:43,559
it and and touch on what I call the

628
00:21:43,559 --> 00:21:46,320
disrespectful register keys so

629
00:21:46,320 --> 00:21:47,940
let's get started a little bit of

630
00:21:47,940 --> 00:21:50,580
History here now keep in mind not I'm

631
00:21:50,580 --> 00:21:52,559
not a great historian I wasn't you know

632
00:21:52,559 --> 00:21:55,200
13 when Windows XP came out so it's a

633
00:21:55,200 --> 00:21:57,059
lot of secondhand knowledge here

634
00:21:57,059 --> 00:21:59,419
foreign

635
00:21:59,419 --> 00:22:02,760
so w digest was introduced alongside

636
00:22:02,760 --> 00:22:04,919
Windows XP

637
00:22:04,919 --> 00:22:06,960
I'm not going to get into how this this

638
00:22:06,960 --> 00:22:10,080
authentication uh actually works the the

639
00:22:10,080 --> 00:22:12,059
key piece is that when you would log

640
00:22:12,059 --> 00:22:13,260
into windows

641
00:22:13,260 --> 00:22:15,059
Windows once again being super helpful

642
00:22:15,059 --> 00:22:16,740
said hey you might want to use W digest

643
00:22:16,740 --> 00:22:18,179
to authenticate against something you

644
00:22:18,179 --> 00:22:21,360
know authenticate against ldap or http

645
00:22:21,360 --> 00:22:22,559
when you log in we're going to go and

646
00:22:22,559 --> 00:22:23,940
pick your password and we're just going

647
00:22:23,940 --> 00:22:25,919
to study here in the registry or I'm

648
00:22:25,919 --> 00:22:27,480
sorry into memory and if you ever want

649
00:22:27,480 --> 00:22:29,100
to use it we got you

650
00:22:29,100 --> 00:22:30,900
it's just sitting there right

651
00:22:30,900 --> 00:22:32,940
so Mimi cats comes along

652
00:22:32,940 --> 00:22:34,620
and all of a sudden you dump that

653
00:22:34,620 --> 00:22:36,840
directly out and so it was still present

654
00:22:36,840 --> 00:22:39,059
in Windows 7. and by the time Windows

655
00:22:39,059 --> 00:22:41,159
8.1 came around windows why some depth

656
00:22:41,159 --> 00:22:42,419
and said all right I'm gonna put out

657
00:22:42,419 --> 00:22:44,100
some advisories you need to go change

658
00:22:44,100 --> 00:22:45,960
this registry key which of course is

659
00:22:45,960 --> 00:22:47,880
just a bunch of manual work

660
00:22:47,880 --> 00:22:49,860
um but also when 8.1 came out everything

661
00:22:49,860 --> 00:22:51,299
moving forward would have that key

662
00:22:51,299 --> 00:22:53,400
disabled it would be set to zero instead

663
00:22:53,400 --> 00:22:54,299
of one

664
00:22:54,299 --> 00:22:56,280
by the time we get to Windows 10 that

665
00:22:56,280 --> 00:22:58,919
registry key doesn't even exist

666
00:22:58,919 --> 00:23:01,020
I'm taking you down this path not

667
00:23:01,020 --> 00:23:02,760
because it was fixed there you probably

668
00:23:02,760 --> 00:23:06,000
you probably know that right so let's

669
00:23:06,000 --> 00:23:08,900
take a look at how to abuse that now

670
00:23:08,900 --> 00:23:11,580
uh we'll skip over this but I think the

671
00:23:11,580 --> 00:23:12,900
only interesting thing about this is and

672
00:23:12,900 --> 00:23:14,179
all the other ones that we've looked at

673
00:23:14,179 --> 00:23:16,679
the adversary doesn't action and then

674
00:23:16,679 --> 00:23:18,419
covers it up with registry in this case

675
00:23:18,419 --> 00:23:20,640
we're flipping that we're saying we want

676
00:23:20,640 --> 00:23:24,059
to set this to log the credentials uh to

677
00:23:24,059 --> 00:23:25,740
clear text and memory

678
00:23:25,740 --> 00:23:27,360
and here's the interesting piece about

679
00:23:27,360 --> 00:23:28,320
this

680
00:23:28,320 --> 00:23:30,720
whenever you flip that switch it doesn't

681
00:23:30,720 --> 00:23:33,179
take credentials that are of users that

682
00:23:33,179 --> 00:23:35,460
are already logged in a user has to log

683
00:23:35,460 --> 00:23:37,260
in again for those credentials to be

684
00:23:37,260 --> 00:23:39,240
available in memory so it tells us a

685
00:23:39,240 --> 00:23:40,679
little bit about the adversary they're

686
00:23:40,679 --> 00:23:42,419
probably pretty patient they're probably

687
00:23:42,419 --> 00:23:44,520
not not doing a smash and grab job maybe

688
00:23:44,520 --> 00:23:46,080
they're going to hang out for a bit so

689
00:23:46,080 --> 00:23:47,880
tell us a little bit about them but once

690
00:23:47,880 --> 00:23:49,620
a user does come along and log in they

691
00:23:49,620 --> 00:23:53,120
can dump that dump those credentials

692
00:23:53,220 --> 00:23:54,840
so

693
00:23:54,840 --> 00:23:56,280
all we have to do

694
00:23:56,280 --> 00:23:59,520
is add this key back in this was the one

695
00:23:59,520 --> 00:24:02,400
that uh was excluded from Windows 8.1

696
00:24:02,400 --> 00:24:05,159
and non-existent in Windows 10. we add

697
00:24:05,159 --> 00:24:06,840
that back in with this used logged on

698
00:24:06,840 --> 00:24:09,539
credential value set to one and it works

699
00:24:09,539 --> 00:24:12,000
just like it did back in 2003. and so

700
00:24:12,000 --> 00:24:13,140
that tells us a little bit about the

701
00:24:13,140 --> 00:24:14,700
Windows operating system and the

702
00:24:14,700 --> 00:24:17,100
technological debt it has to carry to be

703
00:24:17,100 --> 00:24:19,200
reverse compatible right or backwards

704
00:24:19,200 --> 00:24:21,360
compatible so we set that all of a

705
00:24:21,360 --> 00:24:23,280
sudden a user logs in no longer is the

706
00:24:23,280 --> 00:24:24,480
password null

707
00:24:24,480 --> 00:24:25,980
it's in clear text

708
00:24:25,980 --> 00:24:27,539
so this is one that's still being used

709
00:24:27,539 --> 00:24:29,700
today because it still works

710
00:24:29,700 --> 00:24:31,080
there's an interesting thing that I

711
00:24:31,080 --> 00:24:33,360
noticed in my register key research is

712
00:24:33,360 --> 00:24:35,340
that there are a ton of registry keys

713
00:24:35,340 --> 00:24:37,020
that applications in the system are

714
00:24:37,020 --> 00:24:38,880
calling that don't exist

715
00:24:38,880 --> 00:24:42,120
now why don't they exist maybe it's a

716
00:24:42,120 --> 00:24:45,299
feature that an older version used and

717
00:24:45,299 --> 00:24:47,220
you know they don't expect it to be

718
00:24:47,220 --> 00:24:48,840
there or they've removed it to

719
00:24:48,840 --> 00:24:50,880
quote-unquote secure things

720
00:24:50,880 --> 00:24:52,679
truth is a lot of these applications and

721
00:24:52,679 --> 00:24:54,179
systems are still looking for those keys

722
00:24:54,179 --> 00:24:55,500
if you were to put them back in

723
00:24:55,500 --> 00:24:57,299
something is trying to do something with

724
00:24:57,299 --> 00:24:59,340
those values and so this is an example

725
00:24:59,340 --> 00:25:01,639
of that

726
00:25:04,620 --> 00:25:06,720
all right

727
00:25:06,720 --> 00:25:08,400
moving on to a little bit more fun one

728
00:25:08,400 --> 00:25:12,539
uh in my opinion this is not uh taking a

729
00:25:12,539 --> 00:25:14,460
look at how to disable these security

730
00:25:14,460 --> 00:25:17,460
functionalities this is how to hide them

731
00:25:17,460 --> 00:25:19,320
so there's a key under policies and

732
00:25:19,320 --> 00:25:20,580
Explorer

733
00:25:20,580 --> 00:25:23,340
for settings page visibility is what

734
00:25:23,340 --> 00:25:25,440
it's called and you set the value to

735
00:25:25,440 --> 00:25:27,360
hide Windows Defender

736
00:25:27,360 --> 00:25:29,880
really by the way absolutely no Rhyme or

737
00:25:29,880 --> 00:25:31,919
Reason to the naming Convention of these

738
00:25:31,919 --> 00:25:34,380
uh how you disable One Thing compared to

739
00:25:34,380 --> 00:25:36,059
what I would consider to be an equal

740
00:25:36,059 --> 00:25:37,799
thing may live in completely different

741
00:25:37,799 --> 00:25:39,480
areas

742
00:25:39,480 --> 00:25:41,640
so when the whenever you go to settings

743
00:25:41,640 --> 00:25:43,279
normally you see this nice little

744
00:25:43,279 --> 00:25:46,200
Windows security over here this is

745
00:25:46,200 --> 00:25:47,580
usually pointing at Windows Defender I

746
00:25:47,580 --> 00:25:49,340
think you can point it to different AVS

747
00:25:49,340 --> 00:25:51,720
but we set that key and all of a sudden

748
00:25:51,720 --> 00:25:53,279
it's no longer there

749
00:25:53,279 --> 00:25:55,559
now is this going to allow you to bypass

750
00:25:55,559 --> 00:25:57,539
Windows Defender no that's not what I'm

751
00:25:57,539 --> 00:25:59,220
here to talk about but it does make it

752
00:25:59,220 --> 00:26:01,200
harder for an average user to go pull

753
00:26:01,200 --> 00:26:03,179
that up to go check an alert to go make

754
00:26:03,179 --> 00:26:04,440
sure they're firewall firewall is

755
00:26:04,440 --> 00:26:06,419
enabled it's just one additional piece

756
00:26:06,419 --> 00:26:08,820
that's a little bit harder to do

757
00:26:08,820 --> 00:26:10,620
where else can they get us to Defender

758
00:26:10,620 --> 00:26:11,760
though

759
00:26:11,760 --> 00:26:13,740
well they can right click on a folder

760
00:26:13,740 --> 00:26:16,200
they say Scandal phone does defender of

761
00:26:16,200 --> 00:26:18,240
course there's a key for that you can

762
00:26:18,240 --> 00:26:20,100
disable anything in these context menus

763
00:26:20,100 --> 00:26:21,360
by the way so you know when you install

764
00:26:21,360 --> 00:26:24,720
like 7-Zip or WinRAR you get additional

765
00:26:24,720 --> 00:26:27,419
options those all exist under the shell

766
00:26:27,419 --> 00:26:30,539
X context menu handlers now the specific

767
00:26:30,539 --> 00:26:32,880
one I'm targeting here is EPP in point

768
00:26:32,880 --> 00:26:34,080
protection

769
00:26:34,080 --> 00:26:36,240
so this specific one disables it for

770
00:26:36,240 --> 00:26:38,520
folders disabling it for individual

771
00:26:38,520 --> 00:26:40,320
files is a little bit more difficult you

772
00:26:40,320 --> 00:26:42,900
have to do that at each type of file so

773
00:26:42,900 --> 00:26:45,059
there's one for exe one for PDF one for

774
00:26:45,059 --> 00:26:47,760
XLS because of course the context of

775
00:26:47,760 --> 00:26:49,260
what you can do with those files changes

776
00:26:49,260 --> 00:26:51,539
depending on the type so I I grabbed the

777
00:26:51,539 --> 00:26:53,220
easiest one I could just for a demo

778
00:26:53,220 --> 00:26:55,200
purpose and you can actually remove that

779
00:26:55,200 --> 00:26:57,179
scan with Windows Defender once again

780
00:26:57,179 --> 00:26:59,580
not bypassing anything but making the

781
00:26:59,580 --> 00:27:00,900
defender's job a little bit harder

782
00:27:00,900 --> 00:27:03,059
especially for an average user if they

783
00:27:03,059 --> 00:27:04,620
find something suspicious it just makes

784
00:27:04,620 --> 00:27:06,179
it a little bit harder for them to do a

785
00:27:06,179 --> 00:27:09,179
little bit deeper dive investigation

786
00:27:09,179 --> 00:27:11,220
this one is fun

787
00:27:11,220 --> 00:27:12,779
um this is continuing that trend of

788
00:27:12,779 --> 00:27:13,919
hiding security

789
00:27:13,919 --> 00:27:16,200
uh for you that are eagle-eyed out in

790
00:27:16,200 --> 00:27:17,400
the audience you'll notice this is not

791
00:27:17,400 --> 00:27:20,100
Windows 10. uh I believe this is Windows

792
00:27:20,100 --> 00:27:22,559
7. and I saw this registry key in an

793
00:27:22,559 --> 00:27:25,020
intrusion in the last two years and so I

794
00:27:25,020 --> 00:27:26,700
do some research on it and I said great

795
00:27:26,700 --> 00:27:28,919
this this disables the notification icon

796
00:27:28,919 --> 00:27:31,200
down in the bottom right let's slap it

797
00:27:31,200 --> 00:27:33,539
into Windows 10 and see if it works

798
00:27:33,539 --> 00:27:35,460
put in there nothing I'm getting nothing

799
00:27:35,460 --> 00:27:37,200
for it it's not disappearing I'm

800
00:27:37,200 --> 00:27:39,480
restarting my VM wasting a lot of time

801
00:27:39,480 --> 00:27:42,299
to be quite quite honest and so dig a

802
00:27:42,299 --> 00:27:43,620
little bit deeper this hides it for

803
00:27:43,620 --> 00:27:45,179
Windows 7.

804
00:27:45,179 --> 00:27:47,100
so what does that tell me well that

805
00:27:47,100 --> 00:27:49,260
tells me one of two things either one an

806
00:27:49,260 --> 00:27:51,000
adversary did a lot of research about

807
00:27:51,000 --> 00:27:52,500
the host that they were on found out

808
00:27:52,500 --> 00:27:54,000
that it was Windows 7 and they used this

809
00:27:54,000 --> 00:27:55,559
key

810
00:27:55,559 --> 00:27:57,960
or which I think this is much more

811
00:27:57,960 --> 00:27:58,860
likely

812
00:27:58,860 --> 00:28:00,600
these adversaries have outdated run

813
00:28:00,600 --> 00:28:01,620
books

814
00:28:01,620 --> 00:28:04,140
and this key used to work and nobody's

815
00:28:04,140 --> 00:28:05,940
updated that documentation

816
00:28:05,940 --> 00:28:07,919
that'd be my guess once again I have to

817
00:28:07,919 --> 00:28:09,840
dive into the individual intrusions to

818
00:28:09,840 --> 00:28:11,460
figure that out but it does tell you a

819
00:28:11,460 --> 00:28:12,720
little bit about the intent there and

820
00:28:12,720 --> 00:28:14,700
you can pull that back and figure out

821
00:28:14,700 --> 00:28:17,039
how these adversaries operate which is

822
00:28:17,039 --> 00:28:18,539
definitely more on the Intel side of the

823
00:28:18,539 --> 00:28:21,059
house but it does provide valuable Intel

824
00:28:21,059 --> 00:28:23,220
so I dug a little bit deeper I said well

825
00:28:23,220 --> 00:28:24,779
I still want to disable it for Windows

826
00:28:24,779 --> 00:28:25,679
10.

827
00:28:25,679 --> 00:28:27,900
and so I figured out how to do that uh

828
00:28:27,900 --> 00:28:30,059
it's under Microsoft's Windows Defender

829
00:28:30,059 --> 00:28:32,700
security Center under sys tray you can

830
00:28:32,700 --> 00:28:35,640
just say hide systray to one and all of

831
00:28:35,640 --> 00:28:37,440
a sudden what used to be a nice little

832
00:28:37,440 --> 00:28:40,380
Shield is gone

833
00:28:40,380 --> 00:28:42,179
again these are more fun ones to to get

834
00:28:42,179 --> 00:28:44,159
rid of things but we are not targeting

835
00:28:44,159 --> 00:28:46,260
your IR team with this one

836
00:28:46,260 --> 00:28:47,940
right adversaries aren't saying man I'm

837
00:28:47,940 --> 00:28:50,279
gonna bypass everything your IR team is

838
00:28:50,279 --> 00:28:51,179
going to come in they're not going to

839
00:28:51,179 --> 00:28:52,220
know what to do

840
00:28:52,220 --> 00:28:54,419
especially for larger organizations they

841
00:28:54,419 --> 00:28:55,679
probably have remote ways to interact

842
00:28:55,679 --> 00:28:57,059
with this and they're probably you know

843
00:28:57,059 --> 00:28:59,820
siphoning these logs off to a Sim but

844
00:28:59,820 --> 00:29:01,799
this will bypass most of your average

845
00:29:01,799 --> 00:29:03,779
user's ability to do any investigation

846
00:29:03,779 --> 00:29:06,320
on this stuff

847
00:29:06,360 --> 00:29:08,580
so we're kind of making a shift here

848
00:29:08,580 --> 00:29:10,799
we're shifting away from hiding things

849
00:29:10,799 --> 00:29:12,840
uh and this is is a little bit more

850
00:29:12,840 --> 00:29:14,700
disrespectful uh these last three and

851
00:29:14,700 --> 00:29:17,820
they're kind of my favorites uh

852
00:29:17,820 --> 00:29:18,960
so the first one is we're going to

853
00:29:18,960 --> 00:29:20,760
disable task manager

854
00:29:20,760 --> 00:29:22,740
um because of course you can right why

855
00:29:22,740 --> 00:29:24,659
why could you not

856
00:29:24,659 --> 00:29:26,399
um so I just launched task manager over

857
00:29:26,399 --> 00:29:27,419
there

858
00:29:27,419 --> 00:29:30,059
I'm going to change this key from a 0 to

859
00:29:30,059 --> 00:29:31,200
a one

860
00:29:31,200 --> 00:29:33,299
and all of a sudden uh let's see I think

861
00:29:33,299 --> 00:29:35,039
I grabbed that I don't know if you can

862
00:29:35,039 --> 00:29:36,059
read in the back there it says task

863
00:29:36,059 --> 00:29:37,559
manager has been disabled by your

864
00:29:37,559 --> 00:29:38,700
administrator

865
00:29:38,700 --> 00:29:41,039
so fun thing about that if a standard

866
00:29:41,039 --> 00:29:45,120
user sees that my admin did this they

867
00:29:45,120 --> 00:29:47,220
they got me they trust me they only they

868
00:29:47,220 --> 00:29:48,360
don't reach out to me when I click on

869
00:29:48,360 --> 00:29:50,220
bad things they they know they know

870
00:29:50,220 --> 00:29:51,960
what's right and so that's the trend

871
00:29:51,960 --> 00:29:53,220
with shutting these things off for the

872
00:29:53,220 --> 00:29:55,140
registry is that you're going to see

873
00:29:55,140 --> 00:29:57,120
messages that pop up that say oh my

874
00:29:57,120 --> 00:29:59,220
admin disabled this so I think that's

875
00:29:59,220 --> 00:30:02,880
that's kind of um inadvertently a way to

876
00:30:02,880 --> 00:30:05,899
make it seem more legitimate

877
00:30:06,059 --> 00:30:08,159
we also disable CMD

878
00:30:08,159 --> 00:30:10,200
so you that's not an important one right

879
00:30:10,200 --> 00:30:11,880
you won't need that

880
00:30:11,880 --> 00:30:14,399
one thing to notice here is that this is

881
00:30:14,399 --> 00:30:16,140
hkcu

882
00:30:16,140 --> 00:30:17,520
now if you think all the way back to

883
00:30:17,520 --> 00:30:18,720
being in this presentation there was

884
00:30:18,720 --> 00:30:21,419
hkey current user and so what this does

885
00:30:21,419 --> 00:30:23,820
is it disables it for the current user

886
00:30:23,820 --> 00:30:26,700
but doesn't disable it for uh you know

887
00:30:26,700 --> 00:30:28,799
the admin or any other users and so as

888
00:30:28,799 --> 00:30:30,480
an adversary maybe you disable it for

889
00:30:30,480 --> 00:30:32,220
the average user but you leave it open

890
00:30:32,220 --> 00:30:34,080
for that Susan storm and you can still

891
00:30:34,080 --> 00:30:35,940
interact with the system

892
00:30:35,940 --> 00:30:37,500
um now to be fair I was actually having

893
00:30:37,500 --> 00:30:39,539
a conversation with Brandon yesterday

894
00:30:39,539 --> 00:30:41,399
apparently it's the military branches do

895
00:30:41,399 --> 00:30:43,320
this by default to their systems

896
00:30:43,320 --> 00:30:44,700
so I think that's probably a pretty good

897
00:30:44,700 --> 00:30:47,940
call your average user doesn't need CMD

898
00:30:47,940 --> 00:30:49,380
um your average Soldier probably doesn't

899
00:30:49,380 --> 00:30:51,659
need CMD right you're not going to do

900
00:30:51,659 --> 00:30:53,100
any good with it

901
00:30:53,100 --> 00:30:54,899
um they're if anything there's your

902
00:30:54,899 --> 00:30:56,880
bypassing controls to play video games

903
00:30:56,880 --> 00:30:59,399
right that's the best case scenario and

904
00:30:59,399 --> 00:31:01,320
so uh we have seen this used in the wild

905
00:31:01,320 --> 00:31:02,220
though

906
00:31:02,220 --> 00:31:05,399
and last but not least for these uh

907
00:31:05,399 --> 00:31:06,840
pardon the pun this is a good way to

908
00:31:06,840 --> 00:31:08,940
break the key off from the door you can

909
00:31:08,940 --> 00:31:11,279
disable registry register tools on your

910
00:31:11,279 --> 00:31:13,559
way out and so once again we're getting

911
00:31:13,559 --> 00:31:15,059
messages that say Hey your administrator

912
00:31:15,059 --> 00:31:17,039
has disabled this you can no longer use

913
00:31:17,039 --> 00:31:20,100
reg.exe you can no longer use rege edit

914
00:31:20,100 --> 00:31:23,100
now I'm naturally a little bit curious

915
00:31:23,100 --> 00:31:25,320
and I tried out Powershell Powershell

916
00:31:25,320 --> 00:31:27,779
still works so we're still good we can

917
00:31:27,779 --> 00:31:31,200
still revert that it does make uh

918
00:31:31,200 --> 00:31:33,419
creating demos more difficult if all of

919
00:31:33,419 --> 00:31:35,399
your bat files are usually in command

920
00:31:35,399 --> 00:31:38,279
and you disable command early in uh

921
00:31:38,279 --> 00:31:39,899
building a slide deck I don't know about

922
00:31:39,899 --> 00:31:41,700
register Keys it makes it a little bit

923
00:31:41,700 --> 00:31:42,720
more difficult you gotta do a little bit

924
00:31:42,720 --> 00:31:46,440
more research uh and and just to show

925
00:31:46,440 --> 00:31:48,539
that I don't always know what I'm doing

926
00:31:48,539 --> 00:31:50,520
I completely disabled all applications

927
00:31:50,520 --> 00:31:53,220
for my VM and had to go back to a

928
00:31:53,220 --> 00:31:56,399
snapshot so you can absolutely uh put

929
00:31:56,399 --> 00:31:57,659
yourself into a corner with some of

930
00:31:57,659 --> 00:31:59,760
these but we've seen all these in the

931
00:31:59,760 --> 00:32:01,380
wild

932
00:32:01,380 --> 00:32:04,559
so what do we do about it

933
00:32:04,559 --> 00:32:07,200
well first we need to reevaluate what

934
00:32:07,200 --> 00:32:08,940
we've looked at today

935
00:32:08,940 --> 00:32:10,919
on the artifact removal side we've hid

936
00:32:10,919 --> 00:32:12,840
users we've cleared some forensics

937
00:32:12,840 --> 00:32:13,980
pieces

938
00:32:13,980 --> 00:32:17,520
and we've we've hidden uninstall options

939
00:32:17,520 --> 00:32:20,399
and so those are all viable ways to hide

940
00:32:20,399 --> 00:32:22,860
those artifacts and and make that that

941
00:32:22,860 --> 00:32:25,440
activity a little bit less noticeable

942
00:32:25,440 --> 00:32:27,299
we then went over and we impeded some

943
00:32:27,299 --> 00:32:29,460
defenses right we enabled W digest clear

944
00:32:29,460 --> 00:32:32,460
text password uh storage or caching I

945
00:32:32,460 --> 00:32:33,840
think is what they call it we've hit

946
00:32:33,840 --> 00:32:35,520
some Security Options and we've disabled

947
00:32:35,520 --> 00:32:38,460
some admin tools so all in all not a bad

948
00:32:38,460 --> 00:32:39,480
day

949
00:32:39,480 --> 00:32:42,720
what do we as Defenders do about this

950
00:32:42,720 --> 00:32:45,779
uh I I am going to say here for a second

951
00:32:45,779 --> 00:32:47,700
I'm going to go to the next slide this

952
00:32:47,700 --> 00:32:49,140
piece of advice is going to be extremely

953
00:32:49,140 --> 00:32:50,640
difficult to implement please don't

954
00:32:50,640 --> 00:32:52,500
crucify me this is like when I hear

955
00:32:52,500 --> 00:32:54,000
evident or when I hear recommendations

956
00:32:54,000 --> 00:32:56,640
like just don't let them get admin right

957
00:32:56,640 --> 00:32:58,620
like it's easier said than done so I

958
00:32:58,620 --> 00:33:01,699
just want to say I'm aware of that

959
00:33:02,520 --> 00:33:03,899
um but if you go into an existing

960
00:33:03,899 --> 00:33:06,419
environment let's say you're not uh you

961
00:33:06,419 --> 00:33:07,740
know actually grabbing registry key

962
00:33:07,740 --> 00:33:09,480
changes you're not monitoring command

963
00:33:09,480 --> 00:33:11,159
lines you're going into an environment

964
00:33:11,159 --> 00:33:13,620
that you've never seen before or maybe

965
00:33:13,620 --> 00:33:15,720
you're just maturing your security

966
00:33:15,720 --> 00:33:18,179
program

967
00:33:18,179 --> 00:33:20,700
it's pre-manual you if you start

968
00:33:20,700 --> 00:33:23,220
monitoring registering key changes from

969
00:33:23,220 --> 00:33:25,019
today moving forward you won't see one

970
00:33:25,019 --> 00:33:26,460
that changed last week

971
00:33:26,460 --> 00:33:28,559
and so hopefully by documenting these

972
00:33:28,559 --> 00:33:30,299
and making them available there's some

973
00:33:30,299 --> 00:33:32,399
that you can start to query in my

974
00:33:32,399 --> 00:33:34,260
opinion the W digest one would be the

975
00:33:34,260 --> 00:33:35,940
place where I'd start I'd want to know

976
00:33:35,940 --> 00:33:37,620
if that's enabled anywhere on accident

977
00:33:37,620 --> 00:33:39,419
or maliciously

978
00:33:39,419 --> 00:33:40,500
right

979
00:33:40,500 --> 00:33:42,779
now how do we do this well we can use an

980
00:33:42,779 --> 00:33:43,740
EDR

981
00:33:43,740 --> 00:33:45,840
be honest a little bit biased I think

982
00:33:45,840 --> 00:33:47,220
crowdstrike does a pretty good job but

983
00:33:47,220 --> 00:33:49,440
EDR in general can usually push commands

984
00:33:49,440 --> 00:33:51,000
out to a system

985
00:33:51,000 --> 00:33:53,399
we have some OS forensics tools or

986
00:33:53,399 --> 00:33:55,320
interrogation tools such as OS query

987
00:33:55,320 --> 00:33:56,760
that do a pretty good job of this as

988
00:33:56,760 --> 00:33:57,480
well

989
00:33:57,480 --> 00:33:59,100
or you can just build a custom script

990
00:33:59,100 --> 00:34:00,720
and push it out across all of your

991
00:34:00,720 --> 00:34:02,820
agents and pull that back

992
00:34:02,820 --> 00:34:04,919
so once again I'm fully aware just like

993
00:34:04,919 --> 00:34:06,899
go check under all the Rocks it's not a

994
00:34:06,899 --> 00:34:09,480
good good solution this is the right way

995
00:34:09,480 --> 00:34:11,339
to do it it doesn't make it easy

996
00:34:11,339 --> 00:34:13,500
luckily the rest of mine are going to be

997
00:34:13,500 --> 00:34:16,520
a little bit easier to implement

998
00:34:18,119 --> 00:34:20,879
so for ongoing monitoring let's say

999
00:34:20,879 --> 00:34:23,159
you've gone through and you feel pretty

1000
00:34:23,159 --> 00:34:25,139
confident that hey you know I've checked

1001
00:34:25,139 --> 00:34:26,699
under two or three big boulders I don't

1002
00:34:26,699 --> 00:34:28,320
see anything but I would like to keep an

1003
00:34:28,320 --> 00:34:30,119
eye out moving forward

1004
00:34:30,119 --> 00:34:32,099
first of all I take a look for those

1005
00:34:32,099 --> 00:34:34,080
manual changes that I talked about

1006
00:34:34,080 --> 00:34:37,020
you can't go in and audit or inspect

1007
00:34:37,020 --> 00:34:40,080
every single registry key change that'd

1008
00:34:40,080 --> 00:34:44,580
be a whole socks worth of of uh of their

1009
00:34:44,580 --> 00:34:46,260
head count right they'd be looking at

1010
00:34:46,260 --> 00:34:48,359
every single one and trust me it changes

1011
00:34:48,359 --> 00:34:49,260
a lot

1012
00:34:49,260 --> 00:34:50,639
they've been wasting a lot of their time

1013
00:34:50,639 --> 00:34:52,500
what I'm talking about here is more

1014
00:34:52,500 --> 00:34:54,060
focused on how I change them in this

1015
00:34:54,060 --> 00:34:54,800
talk

1016
00:34:54,800 --> 00:34:58,380
reg.exe Powershell or reg edit

1017
00:34:58,380 --> 00:35:00,359
if anyone is changing registered Keys

1018
00:35:00,359 --> 00:35:01,980
manually you should be knowing about it

1019
00:35:01,980 --> 00:35:03,599
that should be something you pull in now

1020
00:35:03,599 --> 00:35:05,400
that's easier said than done how do we

1021
00:35:05,400 --> 00:35:06,960
get that data

1022
00:35:06,960 --> 00:35:08,460
of course I'm going to recommend EDR I

1023
00:35:08,460 --> 00:35:10,020
think it does a pretty good job of that

1024
00:35:10,020 --> 00:35:12,900
but also you can do some logging through

1025
00:35:12,900 --> 00:35:15,420
your CMD or through Powershell pull

1026
00:35:15,420 --> 00:35:17,880
those into a Sim and start to analyze

1027
00:35:17,880 --> 00:35:19,859
those setup filters looking for reg add

1028
00:35:19,859 --> 00:35:23,820
reg delete reg query any of those look

1029
00:35:23,820 --> 00:35:26,220
for that Reg edit and dig a little bit

1030
00:35:26,220 --> 00:35:28,260
deeper and so

1031
00:35:28,260 --> 00:35:30,240
I I don't recommend setting this up and

1032
00:35:30,240 --> 00:35:32,040
then immediately setting it to your sock

1033
00:35:32,040 --> 00:35:33,540
there's there's a little bit of a

1034
00:35:33,540 --> 00:35:36,060
tearing that we need to do first we need

1035
00:35:36,060 --> 00:35:37,980
to capture all those manual changes

1036
00:35:37,980 --> 00:35:39,720
do this over a period of time maybe a

1037
00:35:39,720 --> 00:35:41,760
week maybe a month depends on how busy

1038
00:35:41,760 --> 00:35:43,500
your organization is one thing that's

1039
00:35:43,500 --> 00:35:45,420
going to become super apparent to you

1040
00:35:45,420 --> 00:35:48,480
really quickly as you Analyze This is if

1041
00:35:48,480 --> 00:35:51,420
uh you know Jim uh the admin that's been

1042
00:35:51,420 --> 00:35:53,640
here for 40 years set up a script that

1043
00:35:53,640 --> 00:35:54,960
makes the manual registry change every

1044
00:35:54,960 --> 00:35:56,700
morning across all the machines it's

1045
00:35:56,700 --> 00:35:58,619
gonna you're gonna see that immediately

1046
00:35:58,619 --> 00:36:00,300
you're also going to notice any any

1047
00:36:00,300 --> 00:36:02,760
custom applications that do these these

1048
00:36:02,760 --> 00:36:05,280
manual registry changes so keep an eye

1049
00:36:05,280 --> 00:36:06,720
on those

1050
00:36:06,720 --> 00:36:08,760
um kind of take uh take note of those

1051
00:36:08,760 --> 00:36:10,619
and then as you go into the monitoring

1052
00:36:10,619 --> 00:36:12,960
stage whitelift those from your alerts

1053
00:36:12,960 --> 00:36:15,839
and so hopefully you get the the your

1054
00:36:15,839 --> 00:36:17,579
the large chunk of those red manual

1055
00:36:17,579 --> 00:36:19,380
registry changes that are either

1056
00:36:19,380 --> 00:36:20,760
legitimate or you can run down where

1057
00:36:20,760 --> 00:36:22,740
they're coming from and only focus on

1058
00:36:22,740 --> 00:36:25,440
the one-offs and so the nice thing about

1059
00:36:25,440 --> 00:36:26,880
that monitoring phase is once you're

1060
00:36:26,880 --> 00:36:28,560
looking at them on a daily basis as they

1061
00:36:28,560 --> 00:36:30,060
occur you'll absolutely know what an

1062
00:36:30,060 --> 00:36:31,920
admin puts in another script to go

1063
00:36:31,920 --> 00:36:35,520
manually change a key somewhere

1064
00:36:35,520 --> 00:36:37,500
and the last one is telemetry capture

1065
00:36:37,500 --> 00:36:40,380
this is part of the ongoing uh ongoing

1066
00:36:40,380 --> 00:36:43,200
monitoring now this is not something I

1067
00:36:43,200 --> 00:36:44,700
would be sending every single one to a

1068
00:36:44,700 --> 00:36:45,480
sock

1069
00:36:45,480 --> 00:36:47,400
this is once again they happen all the

1070
00:36:47,400 --> 00:36:49,380
time literally every time you open a

1071
00:36:49,380 --> 00:36:51,060
document it's being added to multiple

1072
00:36:51,060 --> 00:36:53,460
places in terms of the evidence of

1073
00:36:53,460 --> 00:36:55,980
execution and and the files that we use

1074
00:36:55,980 --> 00:36:58,920
those mrus most recently used Keys

1075
00:36:58,920 --> 00:37:01,079
constantly being updated even if the

1076
00:37:01,079 --> 00:37:02,339
Windows system is sitting by itself

1077
00:37:02,339 --> 00:37:03,660
there's probably still some registered

1078
00:37:03,660 --> 00:37:05,160
Keys being modified

1079
00:37:05,160 --> 00:37:07,260
so don't look at all of them but capture

1080
00:37:07,260 --> 00:37:08,220
them all

1081
00:37:08,220 --> 00:37:10,380
this this is a crucial piece of the

1082
00:37:10,380 --> 00:37:12,780
investigation that I do as as well as

1083
00:37:12,780 --> 00:37:14,880
our threat Hunters do uh at crowdstrike

1084
00:37:14,880 --> 00:37:16,800
we grab that Telemetry and so if we find

1085
00:37:16,800 --> 00:37:18,420
something sketchy

1086
00:37:18,420 --> 00:37:21,780
we can uh we can look at the Telemetry

1087
00:37:21,780 --> 00:37:23,220
around it including those registry key

1088
00:37:23,220 --> 00:37:25,560
changes so if we see a reg edit where

1089
00:37:25,560 --> 00:37:27,780
the GUI popped up we have the Telemetry

1090
00:37:27,780 --> 00:37:29,820
to go see what keys were changed even if

1091
00:37:29,820 --> 00:37:31,560
it's not in a command line

1092
00:37:31,560 --> 00:37:34,320
and then as you mature more and as you

1093
00:37:34,320 --> 00:37:35,880
get more data and as you have more

1094
00:37:35,880 --> 00:37:37,440
researchers maybe you hire some

1095
00:37:37,440 --> 00:37:39,480
detection Engineers you can start

1096
00:37:39,480 --> 00:37:41,280
setting up rules for commonly abused

1097
00:37:41,280 --> 00:37:42,960
keys so now you don't care if it's

1098
00:37:42,960 --> 00:37:44,820
changed by an API if it's changed by

1099
00:37:44,820 --> 00:37:46,560
regis.exe you just know when this key

1100
00:37:46,560 --> 00:37:49,440
changes is bad and so this is definitely

1101
00:37:49,440 --> 00:37:51,000
that final step of maturity where you

1102
00:37:51,000 --> 00:37:52,800
start capturing these and specifically

1103
00:37:52,800 --> 00:37:54,720
building some rules for them a lot of

1104
00:37:54,720 --> 00:37:56,339
edrs do a really good job of that out of

1105
00:37:56,339 --> 00:37:58,020
the box once again I'm a little biased

1106
00:37:58,020 --> 00:38:00,540
but all of them have this capability

1107
00:38:00,540 --> 00:38:02,220
and so with that said

1108
00:38:02,220 --> 00:38:03,180
um

1109
00:38:03,180 --> 00:38:05,220
well first of all I want to say I've got

1110
00:38:05,220 --> 00:38:07,380
reference material down here it's not

1111
00:38:07,380 --> 00:38:10,140
pretty I put that together last night

1112
00:38:10,140 --> 00:38:12,180
um so it's just a list of the registered

1113
00:38:12,180 --> 00:38:13,680
keys that I talked about in this talk

1114
00:38:13,680 --> 00:38:15,540
eventually I'd like to get the slides up

1115
00:38:15,540 --> 00:38:17,160
there as well but there's where the

1116
00:38:17,160 --> 00:38:18,300
reference material is for anyone who

1117
00:38:18,300 --> 00:38:20,640
wants to jot that down uh are there any

1118
00:38:20,640 --> 00:38:22,200
questions for me it looks like I

1119
00:38:22,200 --> 00:38:23,339
finished a little bit early so we've got

1120
00:38:23,339 --> 00:38:25,700
some time

1121
00:38:27,480 --> 00:38:30,200
go for it

1122
00:38:32,820 --> 00:38:35,900
uh one more time

1123
00:38:46,940 --> 00:38:49,079
yeah um

1124
00:38:49,079 --> 00:38:50,640
that's a great question

1125
00:38:50,640 --> 00:38:54,060
I I don't know but um I guess the way to

1126
00:38:54,060 --> 00:38:55,859
do that I'm thinking through it live

1127
00:38:55,859 --> 00:38:58,200
here uh I would probably open up procmon

1128
00:38:58,200 --> 00:39:00,420
I would start looking for register key

1129
00:39:00,420 --> 00:39:03,420
queries and I would run CMD I know I'm

1130
00:39:03,420 --> 00:39:06,560
going to see a query for

1131
00:39:07,619 --> 00:39:10,560
this is going to check this one and it's

1132
00:39:10,560 --> 00:39:12,599
going to determine that it's it's

1133
00:39:12,599 --> 00:39:13,859
disabled

1134
00:39:13,859 --> 00:39:15,540
because it's set to one so I know it's

1135
00:39:15,540 --> 00:39:17,460
querying that and then when that pop-up

1136
00:39:17,460 --> 00:39:19,740
happens immediately after you'd have to

1137
00:39:19,740 --> 00:39:21,119
see if there's a second query in there

1138
00:39:21,119 --> 00:39:22,560
to check for a notification pop-up

1139
00:39:22,560 --> 00:39:24,660
that's a great question though I I don't

1140
00:39:24,660 --> 00:39:26,940
know and and

1141
00:39:26,940 --> 00:39:28,200
I don't want to say that I've gone

1142
00:39:28,200 --> 00:39:29,579
through every registered key change we

1143
00:39:29,579 --> 00:39:30,599
have but I've gone through a bunch of

1144
00:39:30,599 --> 00:39:32,040
them and I haven't haven't come across

1145
00:39:32,040 --> 00:39:33,359
that that doesn't mean that key doesn't

1146
00:39:33,359 --> 00:39:34,920
exist it just means it's not actively

1147
00:39:34,920 --> 00:39:36,359
being used

1148
00:39:36,359 --> 00:39:40,339
that's a good question good one

1149
00:39:41,180 --> 00:39:44,400
out of date you mentioned how their

1150
00:39:44,400 --> 00:39:46,260
playbook kind of went out of date

1151
00:39:46,260 --> 00:39:47,579
um when they were looking through

1152
00:39:47,579 --> 00:39:49,619
different commands to run

1153
00:39:49,619 --> 00:39:52,260
um have you seen or know of any other

1154
00:39:52,260 --> 00:39:55,079
maybe I'm assuming like a GitHub list or

1155
00:39:55,079 --> 00:39:57,660
something like that of other useful uh

1156
00:39:57,660 --> 00:40:00,359
offensive like registry changes that

1157
00:40:00,359 --> 00:40:03,000
again happen in the wild or most often

1158
00:40:03,000 --> 00:40:06,180
to kind of evade things turn AV off

1159
00:40:06,180 --> 00:40:07,320
stuff like that

1160
00:40:07,320 --> 00:40:10,740
so except I don't inherently have an

1161
00:40:10,740 --> 00:40:12,420
encyclopedic knowledge of the register

1162
00:40:12,420 --> 00:40:13,920
key so I did a lot of This research I

1163
00:40:13,920 --> 00:40:15,420
said I found this key it's being used

1164
00:40:15,420 --> 00:40:17,640
what the heck is it for sometimes

1165
00:40:17,640 --> 00:40:19,200
Microsoft would help sometimes they

1166
00:40:19,200 --> 00:40:20,280
wouldn't

1167
00:40:20,280 --> 00:40:23,339
um and I didn't find a concise list

1168
00:40:23,339 --> 00:40:25,020
um I've I've started to build a list on

1169
00:40:25,020 --> 00:40:26,880
my personal site

1170
00:40:26,880 --> 00:40:28,680
um but it there's not doesn't seem to be

1171
00:40:28,680 --> 00:40:30,000
one out there that I've come across if

1172
00:40:30,000 --> 00:40:32,880
anyone has one I'll absolutely take it

1173
00:40:32,880 --> 00:40:34,380
um because right now it's very painful

1174
00:40:34,380 --> 00:40:35,940
and I've got references to a ton of

1175
00:40:35,940 --> 00:40:37,619
different sites there's a website called

1176
00:40:37,619 --> 00:40:39,240
pen testing Labs or something like that

1177
00:40:39,240 --> 00:40:40,859
that keeps coming up

1178
00:40:40,859 --> 00:40:44,220
um maybe not exactly that but I'll look

1179
00:40:44,220 --> 00:40:46,560
it up I'll get it to you that have a lot

1180
00:40:46,560 --> 00:40:47,760
of really good write-ups especially a

1181
00:40:47,760 --> 00:40:49,440
lot of the older registry keys but it's

1182
00:40:49,440 --> 00:40:51,839
not a concise list so you're still kind

1183
00:40:51,839 --> 00:40:53,940
of hitting individual blogs here and

1184
00:40:53,940 --> 00:40:54,720
there

1185
00:40:54,720 --> 00:40:56,579
that's a good question though

1186
00:40:56,579 --> 00:40:59,520
um fun fact about outdated uh run books

1187
00:40:59,520 --> 00:41:02,820
what we do see is incorrectly used run

1188
00:41:02,820 --> 00:41:05,460
Books A lot of the time we'll see an

1189
00:41:05,460 --> 00:41:07,079
adversary gain access to a Linux machine

1190
00:41:07,079 --> 00:41:10,020
and run uh you know dirt or the other

1191
00:41:10,020 --> 00:41:11,760
way around right we'll see somebody

1192
00:41:11,760 --> 00:41:14,240
think that they're inside of a uh

1193
00:41:14,240 --> 00:41:16,680
Metasploit uh shell and they'll start

1194
00:41:16,680 --> 00:41:18,180
running Metasploit commands when they're

1195
00:41:18,180 --> 00:41:20,640
in CMD and so we see this evidence of

1196
00:41:20,640 --> 00:41:23,760
like hey uh you know this is my run book

1197
00:41:23,760 --> 00:41:24,900
this is what I'm supposed to do maybe

1198
00:41:24,900 --> 00:41:26,880
they missed a step uh maybe they're

1199
00:41:26,880 --> 00:41:28,200
somewhere they're not not familiar with

1200
00:41:28,200 --> 00:41:30,780
or heck uh I'll be the first to admit I

1201
00:41:30,780 --> 00:41:33,359
run LS and CMD all the time right and so

1202
00:41:33,359 --> 00:41:34,800
it really shows there's a human on the

1203
00:41:34,800 --> 00:41:36,839
other side of this and in cases like

1204
00:41:36,839 --> 00:41:39,000
this these humans may be not as skilled

1205
00:41:39,000 --> 00:41:41,339
especially on the e-com side

1206
00:41:41,339 --> 00:41:42,660
um they got run books they're hiring

1207
00:41:42,660 --> 00:41:44,040
people they've got ridiculous turnover

1208
00:41:44,040 --> 00:41:46,260
and so if that documentation is up to

1209
00:41:46,260 --> 00:41:47,700
date yeah they can look really Advanced

1210
00:41:47,700 --> 00:41:48,900
but a lot of the time they're just

1211
00:41:48,900 --> 00:41:50,760
copying and pasting commands right

1212
00:41:50,760 --> 00:41:52,380
they're looking to hire low-skilled

1213
00:41:52,380 --> 00:41:55,320
people to make as much money as they can

1214
00:41:55,320 --> 00:41:57,000
so

1215
00:41:57,000 --> 00:41:59,900
any other questions

1216
00:42:02,460 --> 00:42:05,060
yeah

1217
00:42:05,220 --> 00:42:07,560
one more question um you mentioned how

1218
00:42:07,560 --> 00:42:09,359
the two kind of areas that you're

1219
00:42:09,359 --> 00:42:10,680
looking at at least that you showed

1220
00:42:10,680 --> 00:42:12,780
earlier were the HP current user and HQ

1221
00:42:12,780 --> 00:42:16,020
local machine there's other there's like

1222
00:42:16,020 --> 00:42:18,260
three or four other ones classes root

1223
00:42:18,260 --> 00:42:20,940
users current config do you ever see

1224
00:42:20,940 --> 00:42:24,480
those being modified or what are those

1225
00:42:24,480 --> 00:42:27,180
for I guess I'm not a expert on the

1226
00:42:27,180 --> 00:42:30,240
registry side yeah thank you I'll be the

1227
00:42:30,240 --> 00:42:32,160
first to admit I'm not either I just

1228
00:42:32,160 --> 00:42:35,280
play one on stage but

1229
00:42:35,280 --> 00:42:37,320
um what we're seeing here so is this

1230
00:42:37,320 --> 00:42:38,520
local machine

1231
00:42:38,520 --> 00:42:40,500
um hives so to speak you'll notice an

1232
00:42:40,500 --> 00:42:43,200
error comes down here and current config

1233
00:42:43,200 --> 00:42:44,640
sits down here so if you open up current

1234
00:42:44,640 --> 00:42:46,800
config remember this is all logical this

1235
00:42:46,800 --> 00:42:48,359
has nothing to do with where the files

1236
00:42:48,359 --> 00:42:49,200
live

1237
00:42:49,200 --> 00:42:51,060
and so if you were to open up hkey

1238
00:42:51,060 --> 00:42:53,160
current config and you open up local

1239
00:42:53,160 --> 00:42:55,079
machine and you navigate it down into

1240
00:42:55,079 --> 00:42:57,000
local machine there's a point where

1241
00:42:57,000 --> 00:42:58,500
those mirror each other

1242
00:42:58,500 --> 00:43:01,079
so it's really just a pointer so current

1243
00:43:01,079 --> 00:43:03,960
config is a pointer Uh current user is a

1244
00:43:03,960 --> 00:43:05,940
pointer and classes dot root as a

1245
00:43:05,940 --> 00:43:07,740
pointer that all point back to either

1246
00:43:07,740 --> 00:43:09,960
users or local machine

1247
00:43:09,960 --> 00:43:13,319
so the hkey users has all the users

1248
00:43:13,319 --> 00:43:15,119
current user will literally just point

1249
00:43:15,119 --> 00:43:17,819
you who has ever actively logged in so

1250
00:43:17,819 --> 00:43:19,440
um could you make a registry key call

1251
00:43:19,440 --> 00:43:20,420
that

1252
00:43:20,420 --> 00:43:24,540
targets hkey users yes but you'd

1253
00:43:24,540 --> 00:43:25,920
probably need to know

1254
00:43:25,920 --> 00:43:28,079
what user you wanted to Target and it's

1255
00:43:28,079 --> 00:43:30,000
just easier to go after current user

1256
00:43:30,000 --> 00:43:32,220
Uh current config you could probably do

1257
00:43:32,220 --> 00:43:33,599
it pretty easily as well you could

1258
00:43:33,599 --> 00:43:36,119
probably create that but remember you're

1259
00:43:36,119 --> 00:43:37,619
you're going into that Hive and you're

1260
00:43:37,619 --> 00:43:39,839
you're selecting a subset a very very

1261
00:43:39,839 --> 00:43:42,720
small subset of local machine and so it

1262
00:43:42,720 --> 00:43:43,980
just makes sense to hit those top level

1263
00:43:43,980 --> 00:43:45,540
ones because the director is going to be

1264
00:43:45,540 --> 00:43:47,160
the same every time it's a great

1265
00:43:47,160 --> 00:43:48,240
question though

1266
00:43:48,240 --> 00:43:50,040
um I as I started digging to this I was

1267
00:43:50,040 --> 00:43:53,339
like why am I only seeing LM and uh

1268
00:43:53,339 --> 00:43:55,560
see you you know a current user local

1269
00:43:55,560 --> 00:43:58,700
machine this is really why

1270
00:43:59,220 --> 00:44:00,660
you got a few more minutes here any

1271
00:44:00,660 --> 00:44:02,480
other questions it'll also be available

1272
00:44:02,480 --> 00:44:06,560
afterwards if you any questions

1273
00:44:06,780 --> 00:44:09,720
no all right well thank you everyone for

1274
00:44:09,720 --> 00:44:11,099
attending I'm going to try to skip to

1275
00:44:11,099 --> 00:44:12,599
the end here

1276
00:44:12,599 --> 00:44:16,260
to put up that URL again

1277
00:44:16,260 --> 00:44:17,880
I'll leave that up for as long as I can

1278
00:44:17,880 --> 00:44:20,280
until the next speaker comes in you can

1279
00:44:20,280 --> 00:44:23,339
grab the URL and it's got a list of all

1280
00:44:23,339 --> 00:44:25,020
the registered keys that I modified

1281
00:44:25,020 --> 00:44:26,640
today

1282
00:44:26,640 --> 00:44:28,200
so and then feel free to connect with me

1283
00:44:28,200 --> 00:44:30,180
or reach out those are some other ways

1284
00:44:30,180 --> 00:44:31,740
to get a hold of me thank you guys so

1285
00:44:31,740 --> 00:44:33,119
much for attending my talk

1286
00:44:33,119 --> 00:44:35,900
appreciate it

