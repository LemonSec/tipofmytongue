1
00:00:07,890 --> 00:00:13,080
thanks for coming<font color="#CCCCCC"> I'm</font><font color="#E5E5E5"> David</font><font color="#CCCCCC"> isotope this</font>

2
00:00:10,230 --> 00:00:15,660
is some well capital from from<font color="#E5E5E5"> Caesar</font>

3
00:00:13,080 --> 00:00:18,029
<font color="#E5E5E5">and we're going to speak about the</font>

4
00:00:15,660 --> 00:00:23,849
witness protocol and its<font color="#E5E5E5"> implementation</font>

5
00:00:18,029 --> 00:00:28,919
in Samba so we'll start<font color="#E5E5E5"> off just with an</font>

6
00:00:23,849 --> 00:00:31,259
<font color="#E5E5E5">introduction to to Samba</font><font color="#CCCCCC"> and so we don't</font>

7
00:00:28,919 --> 00:00:34,170
<font color="#CCCCCC">have a PA within the room so I'll just</font>

8
00:00:31,259 --> 00:00:36,420
have to try<font color="#E5E5E5"> and reach everyone I'll</font>

9
00:00:34,170 --> 00:00:39,780
start off with an introduction<font color="#CCCCCC"> to Samba</font>

10
00:00:36,420 --> 00:00:41,879
and C to<font color="#E5E5E5"> DB or clustered Samba</font><font color="#CCCCCC"> we'll</font>

11
00:00:39,780 --> 00:00:44,070
then move<font color="#CCCCCC"> on to</font><font color="#E5E5E5"> the witness protocol</font>

12
00:00:41,879 --> 00:00:48,349
<font color="#E5E5E5">some of the details of the protocol</font>

13
00:00:44,070 --> 00:00:51,570
itself<font color="#CCCCCC"> we have a demo so just a video of</font>

14
00:00:48,350 --> 00:00:53,100
<font color="#CCCCCC">the witness protocol in action and then</font>

15
00:00:51,570 --> 00:00:55,260
<font color="#E5E5E5">we'll finish with sort of an outlook</font>

16
00:00:53,100 --> 00:00:57,690
<font color="#E5E5E5">where we're heading with with this stuff</font>

17
00:00:55,260 --> 00:01:02,579
<font color="#E5E5E5">what we need to do to get it sort of in</font>

18
00:00:57,690 --> 00:01:05,250
shape for<font color="#CCCCCC"> up-stream so starting off with</font>

19
00:01:02,579 --> 00:01:07,650
<font color="#E5E5E5">samba hopefully you're all familiar it's</font>

20
00:01:05,250 --> 00:01:11,580
a SMB file server

21
00:01:07,650 --> 00:01:13,590
it handles authentication<font color="#E5E5E5"> Active</font>

22
00:01:11,580 --> 00:01:17,610
Directory Integration so you can join a

23
00:01:13,590 --> 00:01:24,120
domain<font color="#E5E5E5"> controller or act as a domain</font>

24
00:01:17,610 --> 00:01:26,160
controller with<font color="#CCCCCC"> samba we have one main</font>

25
00:01:24,120 --> 00:01:30,480
daemon which is or one main file server

26
00:01:26,160 --> 00:01:32,700
daemon which is smbd<font color="#E5E5E5"> it's then generally</font>

27
00:01:30,480 --> 00:01:35,850
forked for for each<font color="#E5E5E5"> client connection</font>

28
00:01:32,700 --> 00:01:39,060
and we<font color="#E5E5E5"> have a pluggable file system back</font>

29
00:01:35,850 --> 00:01:41,970
in so a<font color="#CCCCCC"> VFS layer and</font><font color="#E5E5E5"> this is then what</font>

30
00:01:39,060 --> 00:01:46,830
we use for for things<font color="#E5E5E5"> like</font><font color="#CCCCCC"> ourself</font><font color="#E5E5E5"> we</font>

31
00:01:41,970 --> 00:01:49,500
have lips ffs integration<font color="#E5E5E5"> for butter</font><font color="#CCCCCC"> FS</font>

32
00:01:46,830 --> 00:01:53,759
we have some sort<font color="#CCCCCC"> of snapshot specific</font>

33
00:01:49,500 --> 00:01:56,160
stuff we have<font color="#CCCCCC"> wind bind for the</font>

34
00:01:53,760 --> 00:02:01,650
authentication<font color="#CCCCCC"> ID mapping or ad</font>

35
00:01:56,160 --> 00:02:05,009
<font color="#E5E5E5">integration part and with the protocol</font>

36
00:02:01,650 --> 00:02:07,080
<font color="#CCCCCC">itself we have a bunch of state which</font>

37
00:02:05,010 --> 00:02:11,430
obviously they<font color="#E5E5E5"> need to be tracked by the</font>

38
00:02:07,080 --> 00:02:14,640
server<font color="#CCCCCC"> yeah so for</font><font color="#E5E5E5"> things like open</font>

39
00:02:11,430 --> 00:02:18,450
files leases user<font color="#E5E5E5"> mapping we store that</font>

40
00:02:14,640 --> 00:02:21,660
in in a database so we<font color="#E5E5E5"> use</font>

41
00:02:18,450 --> 00:02:25,950
<font color="#CCCCCC">TDB or trivial database for that</font><font color="#E5E5E5"> on a</font>

42
00:02:21,660 --> 00:02:29,220
<font color="#E5E5E5">standalone system</font><font color="#CCCCCC"> what was initially</font>

43
00:02:25,950 --> 00:02:30,810
trivial is now sort<font color="#E5E5E5"> of I</font><font color="#CCCCCC"> guess</font><font color="#E5E5E5"> had a bit</font>

44
00:02:29,220 --> 00:02:34,430
of feature creep in that it<font color="#E5E5E5"> supports</font>

45
00:02:30,810 --> 00:02:37,230
<font color="#E5E5E5">things like transactions</font><font color="#CCCCCC"> record locking</font>

46
00:02:34,430 --> 00:02:40,980
<font color="#E5E5E5">we have multiple</font><font color="#CCCCCC"> writers so multiple</font>

47
00:02:37,230 --> 00:02:45,268
smbd processes<font color="#E5E5E5"> writing at the same time</font>

48
00:02:40,980 --> 00:02:50,069
to to those databases for clustered

49
00:02:45,269 --> 00:02:50,790
<font color="#E5E5E5">samba we then have CTD</font><font color="#CCCCCC"> B so this</font><font color="#E5E5E5"> then</font>

50
00:02:50,069 --> 00:02:53,130
handles

51
00:02:50,790 --> 00:02:58,170
basically<font color="#E5E5E5"> in the case of an active</font>

52
00:02:53,130 --> 00:03:00,630
<font color="#E5E5E5">active</font><font color="#CCCCCC"> Samba cluster we have these or a</font>

53
00:02:58,170 --> 00:03:05,040
consistent database<font color="#E5E5E5"> across all of these</font>

54
00:03:00,630 --> 00:03:08,190
<font color="#E5E5E5">nodes it also has a number</font><font color="#CCCCCC"> of H a feed</font>

55
00:03:05,040 --> 00:03:12,359
it features integrated<font color="#E5E5E5"> so we have things</font>

56
00:03:08,190 --> 00:03:15,090
<font color="#E5E5E5">like IP failover service monitoring it's</font>

57
00:03:12,360 --> 00:03:17,610
<font color="#E5E5E5">it's I guess you could say a proper H a</font>

58
00:03:15,090 --> 00:03:25,980
stack as<font color="#CCCCCC"> well for a clustered</font><font color="#E5E5E5"> Samba</font>

59
00:03:17,610 --> 00:03:28,920
<font color="#CCCCCC">setup yeah placement within</font><font color="#E5E5E5"> the CTD B</font>

60
00:03:25,980 --> 00:03:32,820
database is then our<font color="#E5E5E5"> computation on a</font>

61
00:03:28,920 --> 00:03:36,208
hash of<font color="#E5E5E5"> the key so we can find out from</font>

62
00:03:32,820 --> 00:03:39,329
<font color="#CCCCCC">that</font><font color="#E5E5E5"> the master or a node which knows</font>

63
00:03:36,209 --> 00:03:41,430
the location of that<font color="#E5E5E5"> record and from</font>

64
00:03:39,329 --> 00:03:44,190
<font color="#E5E5E5">that location master we then have</font>

65
00:03:41,430 --> 00:03:46,320
another level of indirection<font color="#E5E5E5"> to find out</font>

66
00:03:44,190 --> 00:03:50,459
where it's<font color="#CCCCCC"> actually placed so you can</font>

67
00:03:46,320 --> 00:03:56,030
move<font color="#CCCCCC"> sort of records around</font><font color="#E5E5E5"> the cluster</font>

68
00:03:50,459 --> 00:03:58,560
<font color="#CCCCCC">to to where they're</font><font color="#E5E5E5"> needed we have</font>

69
00:03:56,030 --> 00:04:02,340
amongst the the<font color="#E5E5E5"> CTD B nodes we have</font>

70
00:03:58,560 --> 00:04:04,500
election of a recovery master and that

71
00:04:02,340 --> 00:04:06,930
<font color="#E5E5E5">recovery master then performs in</font><font color="#CCCCCC"> the</font>

72
00:04:04,500 --> 00:04:12,209
event<font color="#E5E5E5"> of an outage things like you're</font>

73
00:04:06,930 --> 00:04:16,978
cleaning up mid transaction<font color="#CCCCCC"> yeah that</font>

74
00:04:12,209 --> 00:04:19,139
also<font color="#E5E5E5"> holds a clustered mutex</font><font color="#CCCCCC"> or requires</font>

75
00:04:16,978 --> 00:04:22,500
a cluster mutex

76
00:04:19,139 --> 00:04:25,889
so with CTD B<font color="#E5E5E5"> that's generally placed on</font>

77
00:04:22,500 --> 00:04:29,370
the clustered file system<font color="#E5E5E5"> backing the</font>

78
00:04:25,889 --> 00:04:31,429
sander servers or the file servers we

79
00:04:29,370 --> 00:04:35,770
<font color="#CCCCCC">SEF we have sort of a</font>

80
00:04:31,429 --> 00:04:40,279
a helper<font color="#E5E5E5"> binary which which uses aratus</font>

81
00:04:35,770 --> 00:04:44,808
or<font color="#CCCCCC"> rattles</font><font color="#E5E5E5"> locks for that for IP</font>

82
00:04:40,279 --> 00:04:47,959
failover<font color="#CCCCCC"> it</font><font color="#E5E5E5"> uses what's called a tickle</font>

83
00:04:44,809 --> 00:04:50,929
<font color="#CCCCCC">app AK which sort</font><font color="#E5E5E5"> of speeds up the</font>

84
00:04:47,959 --> 00:04:53,749
process of<font color="#E5E5E5"> a client in the event of an</font>

85
00:04:50,929 --> 00:04:59,989
outage<font color="#E5E5E5"> reconnecting to to another node</font>

86
00:04:53,749 --> 00:05:02,599
after<font color="#E5E5E5"> IP failover</font><font color="#CCCCCC"> and so this is then a</font>

87
00:04:59,989 --> 00:05:06,649
look<font color="#E5E5E5"> at sort of</font><font color="#CCCCCC"> how things have changed</font>

88
00:05:02,599 --> 00:05:10,128
or are changing with clustered SMB

89
00:05:06,649 --> 00:05:14,089
serving so with<font color="#CCCCCC"> Windows</font><font color="#E5E5E5"> in the past</font>

90
00:05:10,129 --> 00:05:15,649
they've had active passive<font color="#E5E5E5"> setups where</font>

91
00:05:14,089 --> 00:05:20,199
they have this file server<font color="#CCCCCC"> role which</font>

92
00:05:15,649 --> 00:05:20,199
moves across nodes within the cluster

93
00:05:20,379 --> 00:05:28,039
<font color="#CCCCCC">their CT DB has has always been active</font>

94
00:05:24,079 --> 00:05:29,659
active to<font color="#E5E5E5"> the point that or where</font>

95
00:05:28,039 --> 00:05:38,929
clusters are then sort<font color="#E5E5E5"> of spread across</font>

96
00:05:29,659 --> 00:05:47,659
those city DB or<font color="#E5E5E5"> SMB gateway nodes so</font>

97
00:05:38,929 --> 00:05:53,138
now<font color="#E5E5E5"> on to witness witness is a new</font>

98
00:05:47,659 --> 00:05:57,699
dce/rpc<font color="#CCCCCC"> starting with the definition</font>

99
00:05:53,139 --> 00:06:00,829
<font color="#E5E5E5">witness is a new this year RPC basis</font>

100
00:05:57,699 --> 00:06:03,019
mechanism to inform the<font color="#CCCCCC"> client about</font>

101
00:06:00,829 --> 00:06:06,169
changes<font color="#CCCCCC"> in the topology</font><font color="#E5E5E5"> or the state of</font>

102
00:06:03,019 --> 00:06:08,929
<font color="#CCCCCC">or the</font><font color="#E5E5E5"> state of</font><font color="#CCCCCC"> the cluster</font>

103
00:06:06,169 --> 00:06:13,329
it helps together with new features<font color="#CCCCCC"> in</font>

104
00:06:08,929 --> 00:06:16,479
the<font color="#E5E5E5"> smb3 protocol to provide transparent</font>

105
00:06:13,329 --> 00:06:20,809
failover for the<font color="#E5E5E5"> cluster clients and</font>

106
00:06:16,479 --> 00:06:23,269
additionally<font color="#E5E5E5"> it also can</font><font color="#CCCCCC"> be used to load</font>

107
00:06:20,809 --> 00:06:25,360
<font color="#CCCCCC">balance the cluster because</font><font color="#E5E5E5"> you can tell</font>

108
00:06:23,269 --> 00:06:31,219
a<font color="#CCCCCC"> client on demand to move to another</font>

109
00:06:25,360 --> 00:06:34,069
cluster node so before explaining<font color="#CCCCCC"> how</font>

110
00:06:31,219 --> 00:06:38,179
witness works let's have a<font color="#E5E5E5"> look how</font>

111
00:06:34,069 --> 00:06:42,349
failover was working in SMB one and SMB

112
00:06:38,179 --> 00:06:44,539
two clusters so in a<font color="#CCCCCC"> Windows cluster</font><font color="#E5E5E5"> we</font>

113
00:06:42,349 --> 00:06:47,599
have a server that<font color="#E5E5E5"> is whole</font>

114
00:06:44,540 --> 00:06:51,050
in the file server<font color="#CCCCCC"> role</font><font color="#E5E5E5"> so the client</font>

115
00:06:47,600 --> 00:06:54,290
opens the SMB connection to do<font color="#E5E5E5"> this note</font>

116
00:06:51,050 --> 00:06:57,650
and if<font color="#E5E5E5"> the note goes</font><font color="#CCCCCC"> down in the cluster</font>

117
00:06:54,290 --> 00:07:00,260
<font color="#CCCCCC">moves the role to another</font><font color="#E5E5E5"> server</font><font color="#CCCCCC"> but the</font>

118
00:06:57,650 --> 00:07:05,210
<font color="#CCCCCC">client has to</font><font color="#E5E5E5"> wait</font><font color="#CCCCCC"> for</font><font color="#E5E5E5"> the TCP timeout</font>

119
00:07:00,260 --> 00:07:08,090
<font color="#E5E5E5">to reconnect so after the TCP timeout</font>

120
00:07:05,210 --> 00:07:11,359
<font color="#CCCCCC">the client reconnected</font><font color="#E5E5E5"> the protocol does</font>

121
00:07:08,090 --> 00:07:15,760
not define any failover mechanism at all

122
00:07:11,360 --> 00:07:18,760
<font color="#E5E5E5">in SMB one an SMB two in a Samba cluster</font>

123
00:07:15,760 --> 00:07:21,770
<font color="#E5E5E5">thing</font><font color="#CCCCCC"> the failover works works better</font>

124
00:07:18,760 --> 00:07:24,289
<font color="#E5E5E5">because samba implements additional</font>

125
00:07:21,770 --> 00:07:27,799
measures<font color="#E5E5E5"> to speed up the recovery as</font>

126
00:07:24,290 --> 00:07:31,400
<font color="#E5E5E5">David said before the IP</font><font color="#CCCCCC"> takeover</font><font color="#E5E5E5"> the</font>

127
00:07:27,800 --> 00:07:35,450
gratitude IRP and tease and tickle<font color="#E5E5E5"> a</font>

128
00:07:31,400 --> 00:07:37,849
ticket so in a city DB cluster the IP

129
00:07:35,450 --> 00:07:41,270
<font color="#CCCCCC">all nodes are active at the same</font><font color="#E5E5E5"> time</font>

130
00:07:37,850 --> 00:07:45,440
and the IP<font color="#E5E5E5"> addresses are distributed</font>

131
00:07:41,270 --> 00:07:49,570
between the<font color="#CCCCCC"> node so the client opens the</font>

132
00:07:45,440 --> 00:07:53,510
SMB connection and when an old goes down

133
00:07:49,570 --> 00:07:56,390
the cluster enters in recovery<font color="#CCCCCC"> state and</font>

134
00:07:53,510 --> 00:08:01,270
runs the IP takeover algorithm which

135
00:07:56,390 --> 00:08:01,270
<font color="#E5E5E5">moved the</font><font color="#CCCCCC"> IP address to another node</font>

136
00:08:01,480 --> 00:08:07,820
after that<font color="#CCCCCC"> CT DB sends a gratuitous ARP</font>

137
00:08:05,000 --> 00:08:11,000
<font color="#E5E5E5">to the client to</font><font color="#CCCCCC"> inform about</font><font color="#E5E5E5"> the new</font>

138
00:08:07,820 --> 00:08:15,099
MAC address associated to the IP and

139
00:08:11,000 --> 00:08:18,620
also sends article<font color="#E5E5E5"> a</font><font color="#CCCCCC"> ciggie that is a</font>

140
00:08:15,100 --> 00:08:22,670
crafted<font color="#CCCCCC"> TCP packet with a wrong sequence</font>

141
00:08:18,620 --> 00:08:24,680
<font color="#E5E5E5">number which has the effect of the</font>

142
00:08:22,670 --> 00:08:26,780
client automatically<font color="#CCCCCC"> wrested the</font>

143
00:08:24,680 --> 00:08:30,820
connection bit<font color="#E5E5E5"> without having to wait</font>

144
00:08:26,780 --> 00:08:35,030
for<font color="#CCCCCC"> the timeout</font><font color="#E5E5E5"> so the client recollect</font>

145
00:08:30,820 --> 00:08:37,490
in smb3 Microsoft added new features<font color="#CCCCCC"> to</font>

146
00:08:35,030 --> 00:08:41,150
<font color="#CCCCCC">the protocol to provide</font>

147
00:08:37,490 --> 00:08:43,580
transparent<font color="#E5E5E5"> client file over one is the</font>

148
00:08:41,150 --> 00:08:45,800
witness<font color="#E5E5E5"> services that we are going to</font>

149
00:08:43,580 --> 00:08:48,950
<font color="#E5E5E5">see how it works not and another one is</font>

150
00:08:45,800 --> 00:08:51,170
persistent<font color="#E5E5E5"> handles the idea I'm just</font>

151
00:08:48,950 --> 00:08:54,650
<font color="#CCCCCC">going to</font><font color="#E5E5E5"> give the</font><font color="#CCCCCC"> idea of persistent</font>

152
00:08:51,170 --> 00:08:57,500
handles<font color="#E5E5E5"> and when the client opens a file</font>

153
00:08:54,650 --> 00:08:58,550
in a server the server has<font color="#CCCCCC"> to store</font><font color="#E5E5E5"> what</font>

154
00:08:57,500 --> 00:09:01,280
is called the

155
00:08:58,550 --> 00:09:03,319
file handle estate which contains

156
00:09:01,280 --> 00:09:07,130
information<font color="#E5E5E5"> about the leases the share</font>

157
00:09:03,320 --> 00:09:10,640
<font color="#E5E5E5">mods and the logs so if the server</font>

158
00:09:07,130 --> 00:09:13,070
crashes before persistent<font color="#CCCCCC"> hundred</font><font color="#E5E5E5"> this</font>

159
00:09:10,640 --> 00:09:15,319
<font color="#E5E5E5">information was lost but with persistent</font>

160
00:09:13,070 --> 00:09:19,580
handles this file handle estate is

161
00:09:15,320 --> 00:09:22,100
somehow persisted so the client can when

162
00:09:19,580 --> 00:09:25,460
he recognized he can request<font color="#E5E5E5"> the server</font>

163
00:09:22,100 --> 00:09:29,420
to open to reduce the<font color="#CCCCCC"> fine handle estate</font>

164
00:09:25,460 --> 00:09:32,630
and in cluster<font color="#CCCCCC"> environment this</font><font color="#E5E5E5"> file</font>

165
00:09:29,420 --> 00:09:35,599
handle estate is also synchronized<font color="#E5E5E5"> at or</font>

166
00:09:32,630 --> 00:09:38,090
distributed across a<font color="#E5E5E5"> cluster so a client</font>

167
00:09:35,600 --> 00:09:42,590
can open a file in<font color="#E5E5E5"> another node</font><font color="#CCCCCC"> in the</font>

168
00:09:38,090 --> 00:09:47,300
same in the<font color="#CCCCCC"> same estate so in an SMB 3</font>

169
00:09:42,590 --> 00:09:49,430
cluster<font color="#E5E5E5"> the all</font><font color="#CCCCCC"> notes are running the</font>

170
00:09:47,300 --> 00:09:52,130
witness service and the client opens<font color="#CCCCCC"> two</font>

171
00:09:49,430 --> 00:09:55,040
different connections and it's important

172
00:09:52,130 --> 00:09:58,370
to to know to remark that these

173
00:09:55,040 --> 00:10:03,740
connections<font color="#CCCCCC"> are always two different</font>

174
00:09:58,370 --> 00:10:07,720
<font color="#CCCCCC">nodes so when they note holding the file</font>

175
00:10:03,740 --> 00:10:10,580
server<font color="#E5E5E5"> role process two things happen</font>

176
00:10:07,720 --> 00:10:14,600
the cluster moves the role to another

177
00:10:10,580 --> 00:10:18,080
server<font color="#E5E5E5"> but and also the witness service</font>

178
00:10:14,600 --> 00:10:20,690
tells the<font color="#CCCCCC"> client about</font><font color="#E5E5E5"> this movement so</font>

179
00:10:18,080 --> 00:10:26,990
the client can react and<font color="#E5E5E5"> automatically</font>

180
00:10:20,690 --> 00:10:29,120
reconnect the<font color="#E5E5E5"> other node now we are</font>

181
00:10:26,990 --> 00:10:32,650
<font color="#E5E5E5">going to explain our demo environment</font>

182
00:10:29,120 --> 00:10:32,650
that we are useful

183
00:10:34,939 --> 00:10:53,699
sure<font color="#E5E5E5"> I'm assuming that we already taking</font>

184
00:10:44,670 --> 00:10:57,870
<font color="#E5E5E5">the crash</font><font color="#CCCCCC"> so the the question was how is</font>

185
00:10:53,699 --> 00:11:00,180
<font color="#CCCCCC">the crash detected for failover and in</font>

186
00:10:57,870 --> 00:11:02,430
in the case of witness it's generally

187
00:11:00,180 --> 00:11:06,239
<font color="#E5E5E5">driven by the the cluster so the cluster</font>

188
00:11:02,430 --> 00:11:17,969
notices an outage<font color="#E5E5E5"> and then tells the</font><font color="#CCCCCC"> the</font>

189
00:11:06,240 --> 00:11:21,170
client<font color="#E5E5E5"> about that so I mean it depends</font>

190
00:11:17,970 --> 00:11:24,660
<font color="#E5E5E5">on the</font><font color="#CCCCCC"> implementation for</font><font color="#E5E5E5"> Samba we have</font>

191
00:11:21,170 --> 00:11:28,229
<font color="#CCCCCC">CTD be basically</font><font color="#E5E5E5"> managing the clustered</font>

192
00:11:24,660 --> 00:11:31,469
SMB gateways<font color="#E5E5E5"> and</font><font color="#CCCCCC"> in that</font><font color="#E5E5E5"> case they</font>

193
00:11:28,230 --> 00:11:33,839
notice<font color="#E5E5E5"> an outage of a node so they're</font>

194
00:11:31,470 --> 00:11:35,910
continuously<font color="#E5E5E5"> monitoring the Gateway</font>

195
00:11:33,839 --> 00:11:46,920
notes they notice this<font color="#E5E5E5"> at each</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> then</font>

196
00:11:35,910 --> 00:11:50,759
notify the clients for<font color="#E5E5E5"> failover if the</font>

197
00:11:46,920 --> 00:11:55,370
quorum or if the<font color="#CCCCCC"> majority of city of</font><font color="#E5E5E5"> B</font>

198
00:11:50,759 --> 00:11:55,370
nodes go down then yes yes

199
00:11:59,730 --> 00:12:07,699
so just sort<font color="#E5E5E5"> of explaining the the demo</font>

200
00:12:02,939 --> 00:12:11,310
setup<font color="#E5E5E5"> we have so we have our</font><font color="#CCCCCC"> SEF cluster</font>

201
00:12:07,699 --> 00:12:14,639
<font color="#CCCCCC">we have the Samba gateways and</font><font color="#E5E5E5"> so in</font>

202
00:12:11,310 --> 00:12:19,699
this<font color="#E5E5E5"> case two gateways in front of the</font>

203
00:12:14,639 --> 00:12:25,199
SEF cluster<font color="#CCCCCC"> these gateways are using the</font>

204
00:12:19,699 --> 00:12:29,339
<font color="#CCCCCC">EFSF back in for Samba</font><font color="#E5E5E5"> also CTD</font><font color="#CCCCCC"> B</font><font color="#E5E5E5"> and is</font>

205
00:12:25,199 --> 00:12:35,309
the cluster service and key value store

206
00:12:29,339 --> 00:12:39,180
for<font color="#CCCCCC"> Samba yeah we have a bunch of</font>

207
00:12:35,309 --> 00:12:41,069
changes on top of current<font color="#CCCCCC"> mainline so so</font>

208
00:12:39,180 --> 00:12:46,128
<font color="#E5E5E5">well implemented the the witness server</font>

209
00:12:41,069 --> 00:12:48,870
<font color="#CCCCCC">I worked on the async DC RPC server</font>

210
00:12:46,129 --> 00:12:54,180
persistent handles were implemented by

211
00:12:48,870 --> 00:12:58,050
Ralph<font color="#E5E5E5"> bloomer from our su net</font><font color="#CCCCCC"> yeah we</font>

212
00:12:54,180 --> 00:13:01,079
also have from<font color="#E5E5E5"> Stephan met smoker from</font>

213
00:12:58,050 --> 00:13:04,490
also<font color="#E5E5E5"> from Sur net</font><font color="#CCCCCC"> the T event</font>

214
00:13:01,079 --> 00:13:04,489
<font color="#E5E5E5">impersonation changes</font>

215
00:13:09,380 --> 00:13:15,650
so it's it's a<font color="#CCCCCC"> little difficult to</font><font color="#E5E5E5"> see</font><font color="#CCCCCC"> I</font>

216
00:13:13,150 --> 00:13:17,360
mean<font color="#E5E5E5"> we do get a pretty graph on the on</font>

217
00:13:15,650 --> 00:13:19,760
the<font color="#CCCCCC"> right-hand side so we can</font><font color="#E5E5E5"> at</font><font color="#CCCCCC"> least</font>

218
00:13:17,360 --> 00:13:22,070
see something later<font color="#CCCCCC"> on I'll try</font><font color="#E5E5E5"> to sort</font>

219
00:13:19,760 --> 00:13:26,300
of guide through what's going<font color="#CCCCCC"> on</font><font color="#E5E5E5"> anyway</font>

220
00:13:22,070 --> 00:13:28,970
<font color="#CCCCCC">so we</font><font color="#E5E5E5"> have yeah these are the the to</font>

221
00:13:26,300 --> 00:13:32,410
note there to<font color="#E5E5E5"> see</font><font color="#CCCCCC"> t DB</font><font color="#E5E5E5"> nodes and the</font>

222
00:13:28,970 --> 00:13:37,970
corresponding<font color="#E5E5E5"> witness server logs yeah</font>

223
00:13:32,410 --> 00:13:43,610
the other<font color="#E5E5E5"> two black squares there yeah</font>

224
00:13:37,970 --> 00:13:45,530
it's it's<font color="#E5E5E5"> barely readable so in this</font>

225
00:13:43,610 --> 00:13:50,360
case we're just yeah

226
00:13:45,530 --> 00:13:53,780
initially connecting to the to the

227
00:13:50,360 --> 00:14:04,340
cluster<font color="#E5E5E5"> so this is a we know Server 2012</font>

228
00:13:53,780 --> 00:14:05,900
r2<font color="#CCCCCC"> wit client</font><font color="#E5E5E5"> so here we can see so</font>

229
00:14:04,340 --> 00:14:08,810
we've just<font color="#E5E5E5"> done a connection to the</font>

230
00:14:05,900 --> 00:14:11,810
cluster I mean here we can see<font color="#CCCCCC"> that the</font>

231
00:14:08,810 --> 00:14:14,920
client has then basically registered

232
00:14:11,810 --> 00:14:19,430
with the witness service so since this

233
00:14:14,920 --> 00:14:21,740
async notify request to witness and what

234
00:14:19,430 --> 00:14:24,109
<font color="#E5E5E5">happens now is</font><font color="#CCCCCC"> that that</font><font color="#E5E5E5"> that request</font>

235
00:14:21,740 --> 00:14:28,160
<font color="#CCCCCC">basically sleeps</font><font color="#E5E5E5"> on</font><font color="#CCCCCC"> the witness</font><font color="#E5E5E5"> server</font>

236
00:14:24,110 --> 00:14:32,480
side and a response is sent<font color="#E5E5E5"> when a</font>

237
00:14:28,160 --> 00:14:34,839
notification is is then ready for the

238
00:14:32,480 --> 00:14:34,840
client

239
00:14:39,820 --> 00:14:50,720
yes<font color="#CCCCCC"> so we're trying to</font><font color="#E5E5E5"> show the I</font><font color="#CCCCCC"> think</font>

240
00:14:45,920 --> 00:14:53,510
this is<font color="#CCCCCC"> there</font><font color="#E5E5E5"> isn't</font><font color="#CCCCCC"> be status yeah this</font>

241
00:14:50,720 --> 00:14:58,279
is the<font color="#CCCCCC"> output of the resign</font><font color="#E5E5E5"> us</font><font color="#CCCCCC"> and the</font>

242
00:14:53,510 --> 00:15:01,779
SMB witness list<font color="#E5E5E5"> comment that it tells</font>

243
00:14:58,279 --> 00:15:06,410
you what you you will<font color="#E5E5E5"> have to believe me</font>

244
00:15:01,779 --> 00:15:12,560
<font color="#E5E5E5">he says that the client is registered on</font>

245
00:15:06,410 --> 00:15:14,449
the<font color="#E5E5E5"> CT TB</font><font color="#CCCCCC"> node1 this here is the client</font>

246
00:15:12,560 --> 00:15:15,079
name is just a<font color="#CCCCCC"> computer the computer</font>

247
00:15:14,450 --> 00:15:17,420
name

248
00:15:15,079 --> 00:15:20,510
<font color="#E5E5E5">yes it tells it tells you that</font><font color="#CCCCCC"> the SMB</font>

249
00:15:17,420 --> 00:15:23,660
connection is open to<font color="#E5E5E5"> note Class C to</font>

250
00:15:20,510 --> 00:15:37,640
denote<font color="#CCCCCC"> zero and this is</font><font color="#E5E5E5"> the network the</font>

251
00:15:23,660 --> 00:15:43,300
network name<font color="#CCCCCC"> this is the SMB esta status</font>

252
00:15:37,640 --> 00:15:46,730
output<font color="#E5E5E5"> just to check that the client is</font>

253
00:15:43,300 --> 00:15:52,640
<font color="#E5E5E5">connected to one IP that is</font><font color="#CCCCCC"> a Sagna to</font>

254
00:15:46,730 --> 00:15:55,490
the node<font color="#E5E5E5"> to node</font><font color="#CCCCCC"> zero this this is the</font>

255
00:15:52,640 --> 00:15:58,089
<font color="#CCCCCC">output the association of the IP</font>

256
00:15:55,490 --> 00:16:03,470
<font color="#E5E5E5">addresses to the to the city DB note</font>

257
00:15:58,089 --> 00:16:06,140
this was 13 and 13 is in<font color="#CCCCCC"> node</font><font color="#E5E5E5"> 0 so now</font>

258
00:16:03,470 --> 00:16:09,709
we are prepared preparing the SM<font color="#E5E5E5"> SMB</font>

259
00:16:06,140 --> 00:16:12,529
witness SMB with the new SMB witness

260
00:16:09,709 --> 00:16:16,489
<font color="#E5E5E5">move comment to</font><font color="#CCCCCC"> tell the client to move</font>

261
00:16:12,529 --> 00:16:19,939
to the<font color="#CCCCCC"> other node so they send the</font>

262
00:16:16,490 --> 00:16:23,060
witness move the client name and<font color="#E5E5E5"> the</font>

263
00:16:19,940 --> 00:16:25,579
they note the<font color="#CCCCCC"> new node so right so I</font>

264
00:16:23,060 --> 00:16:26,899
guess we<font color="#CCCCCC"> should say at this point</font><font color="#E5E5E5"> so in</font>

265
00:16:25,579 --> 00:16:29,870
this case we're not triggering a file

266
00:16:26,899 --> 00:16:33,470
<font color="#CCCCCC">over and we also have all these Samwell</font>

267
00:16:29,870 --> 00:16:35,660
<font color="#E5E5E5">implemented the ability to to just do a</font>

268
00:16:33,470 --> 00:16:39,260
manual notification so to<font color="#E5E5E5"> request that</font>

269
00:16:35,660 --> 00:16:40,730
the client then move its SMB or<font color="#E5E5E5"> file</font>

270
00:16:39,260 --> 00:16:42,970
server connection from<font color="#CCCCCC"> one node to</font>

271
00:16:40,730 --> 00:16:42,970
another

272
00:16:47,209 --> 00:16:58,939
the connection is throttle is in<font color="#CCCCCC"> TBM so</font>

273
00:16:51,100 --> 00:17:02,180
now when you<font color="#E5E5E5"> this here is the the output</font>

274
00:16:58,940 --> 00:17:05,110
<font color="#CCCCCC">of</font><font color="#E5E5E5"> SMB a status to check the</font><font color="#CCCCCC"> address</font>

275
00:17:02,180 --> 00:17:09,799
where the client is connected<font color="#E5E5E5"> this is</font>

276
00:17:05,109 --> 00:17:11,958
then<font color="#CCCCCC"> not</font><font color="#E5E5E5"> one so now when now we have</font>

277
00:17:09,799 --> 00:17:22,789
tell the client to move the keynesian<font color="#E5E5E5"> so</font>

278
00:17:11,959 --> 00:17:24,620
<font color="#CCCCCC">comes down but the copy</font><font color="#E5E5E5"> continue it</font>

279
00:17:22,789 --> 00:17:28,129
requires the witness service on the

280
00:17:24,619 --> 00:17:31,580
client<font color="#E5E5E5"> to accept these notifications or</font>

281
00:17:28,130 --> 00:17:39,080
<font color="#CCCCCC">two to</font><font color="#E5E5E5"> notice these</font><font color="#CCCCCC"> changes or act on</font>

282
00:17:31,580 --> 00:17:42,500
<font color="#CCCCCC">these changes now now we are</font><font color="#E5E5E5"> taking that</font>

283
00:17:39,080 --> 00:17:46,280
the connection has<font color="#E5E5E5"> been moved to today</font>

284
00:17:42,500 --> 00:17:49,070
well<font color="#E5E5E5"> not with</font><font color="#CCCCCC"> SMB a status and the</font>

285
00:17:46,280 --> 00:17:51,280
association of the IP addresses<font color="#E5E5E5"> in the</font>

286
00:17:49,070 --> 00:17:51,280
cluster

287
00:18:02,179 --> 00:18:10,289
the what is additional is well this was

288
00:18:06,870 --> 00:18:12,570
a could<font color="#CCCCCC"> be active with some gratitude</font>

289
00:18:10,289 --> 00:18:15,419
<font color="#E5E5E5">syrup IRP</font><font color="#CCCCCC"> an tickling sickies</font>

290
00:18:12,570 --> 00:18:18,899
this is something new the finally in the

291
00:18:15,419 --> 00:18:21,330
smb3 protocol that<font color="#E5E5E5"> I mean</font><font color="#CCCCCC"> got to do</font>

292
00:18:18,900 --> 00:18:24,000
<font color="#CCCCCC">therapy antic Eliza kisses somebody team</font>

293
00:18:21,330 --> 00:18:26,908
but<font color="#CCCCCC"> is</font><font color="#E5E5E5"> outside of the protocol Microsoft</font>

294
00:18:24,000 --> 00:18:30,929
now has<font color="#E5E5E5"> define persistent handles and</font>

295
00:18:26,909 --> 00:18:33,419
the witness services yet for<font color="#CCCCCC"> that it the</font>

296
00:18:30,929 --> 00:18:34,890
<font color="#CCCCCC">Connecticut was like a</font><font color="#E5E5E5"> drink</font><font color="#CCCCCC"> so I think</font>

297
00:18:33,419 --> 00:18:37,740
the main<font color="#E5E5E5"> point here is that there's no</font>

298
00:18:34,890 --> 00:18:39,960
interruption to the application layer<font color="#CCCCCC"> so</font>

299
00:18:37,740 --> 00:18:42,299
<font color="#E5E5E5">we have failover between nodes within</font>

300
00:18:39,960 --> 00:18:45,230
the cluster<font color="#E5E5E5"> without the the application</font>

301
00:18:42,299 --> 00:18:59,429
in this<font color="#E5E5E5"> case just an explorer a copy</font>

302
00:18:45,230 --> 00:19:02,520
noticing so in that case basically

303
00:18:59,429 --> 00:19:05,520
there's an outage<font color="#E5E5E5"> at the SMB protocol</font>

304
00:19:02,520 --> 00:19:07,830
layer and the client then forces a

305
00:19:05,520 --> 00:19:10,289
reconnect in this case we have a

306
00:19:07,830 --> 00:19:13,559
separate witness service which basically

307
00:19:10,289 --> 00:19:16,230
tells the<font color="#E5E5E5"> client please move to a</font>

308
00:19:13,559 --> 00:19:20,639
different node so it's it's controlled

309
00:19:16,230 --> 00:19:23,340
and yeah<font color="#E5E5E5"> done it</font><font color="#CCCCCC"> a layer separate</font><font color="#E5E5E5"> to or</font>

310
00:19:20,640 --> 00:19:26,010
such that the application<font color="#E5E5E5"> doesn't really</font>

311
00:19:23,340 --> 00:19:31,559
<font color="#E5E5E5">notice the the at each other</font><font color="#CCCCCC"> the move</font>

312
00:19:26,010 --> 00:19:34,500
between servers so it was<font color="#E5E5E5"> just a</font>

313
00:19:31,559 --> 00:19:36,960
question<font color="#CCCCCC"> on basically whether</font><font color="#E5E5E5"> this could</font>

314
00:19:34,500 --> 00:19:45,210
already be achieved with durable<font color="#CCCCCC"> flow</font>

315
00:19:36,960 --> 00:19:47,730
handles the connect I know here we have

316
00:19:45,210 --> 00:19:50,000
more<font color="#CCCCCC"> forgetting the connection to to CTD</font>

317
00:19:47,730 --> 00:19:53,000
<font color="#CCCCCC">be</font><font color="#E5E5E5"> note one and the file transfer</font>

318
00:19:50,000 --> 00:19:53,000
<font color="#CCCCCC">continues</font>

319
00:19:54,340 --> 00:19:58,639
<font color="#CCCCCC">it was just</font><font color="#E5E5E5"> saying that he's moved it</font>

320
00:19:56,480 --> 00:20:00,260
again from from one node<font color="#CCCCCC"> to another and</font>

321
00:19:58,640 --> 00:20:05,020
then moved back again

322
00:20:00,260 --> 00:20:05,020
yeah just<font color="#E5E5E5"> well the copy is in progress</font>

323
00:20:12,640 --> 00:20:19,850
<font color="#CCCCCC">there so that's</font><font color="#E5E5E5"> sort of what we have is</font>

324
00:20:16,250 --> 00:20:21,770
a prototype<font color="#CCCCCC"> yeah we</font><font color="#E5E5E5"> still have quite a</font>

325
00:20:19,850 --> 00:20:26,600
<font color="#E5E5E5">bit of</font><font color="#CCCCCC"> work to do for</font><font color="#E5E5E5"> for</font><font color="#CCCCCC"> up streaming</font>

326
00:20:21,770 --> 00:20:29,990
mostly in the dce/rpc<font color="#E5E5E5"> server layer so</font><font color="#CCCCCC"> we</font>

327
00:20:26,600 --> 00:20:34,790
have this source<font color="#CCCCCC"> three implementation of</font>

328
00:20:29,990 --> 00:20:37,730
<font color="#CCCCCC">asynchronous TC RPC server so Samwell</font>

329
00:20:34,790 --> 00:20:41,330
has also<font color="#E5E5E5"> worked on then merging the</font>

330
00:20:37,730 --> 00:20:44,810
source<font color="#E5E5E5"> 3 and source for implementations</font>

331
00:20:41,330 --> 00:20:46,909
<font color="#E5E5E5">so that gets us to I think a much</font>

332
00:20:44,810 --> 00:20:49,340
cleaner<font color="#E5E5E5"> point where we can then start up</font>

333
00:20:46,910 --> 00:20:53,540
streaming the witness stuff on top of

334
00:20:49,340 --> 00:20:56,179
that<font color="#CCCCCC"> yay another</font><font color="#E5E5E5"> possible future feature</font>

335
00:20:53,540 --> 00:20:57,860
would then be automatic load<font color="#E5E5E5"> balancing</font>

336
00:20:56,180 --> 00:21:00,740
so<font color="#E5E5E5"> basically from the cluster side</font>

337
00:20:57,860 --> 00:21:03,530
seeing which nodes have free resources

338
00:21:00,740 --> 00:21:07,550
and and moving<font color="#CCCCCC"> class</font><font color="#E5E5E5"> sorry moving client</font>

339
00:21:03,530 --> 00:21:13,250
nodes<font color="#E5E5E5"> balancing client nodes between the</font>

340
00:21:07,550 --> 00:21:15,740
cluster more more evenly<font color="#CCCCCC"> yeah this is</font>

341
00:21:13,250 --> 00:21:19,610
more on<font color="#CCCCCC"> the safe side so currently</font><font color="#E5E5E5"> we</font>

342
00:21:15,740 --> 00:21:22,780
have CTD be acting<font color="#E5E5E5"> as in the the</font>

343
00:21:19,610 --> 00:21:25,520
clustered key value store with<font color="#E5E5E5"> SEF</font>

344
00:21:22,780 --> 00:21:28,940
backing the the file server we we have

345
00:21:25,520 --> 00:21:32,240
another<font color="#E5E5E5"> option as a key</font><font color="#CCCCCC"> value store so</font>

346
00:21:28,940 --> 00:21:35,300
we can<font color="#E5E5E5"> potentially look at using SEF</font>

347
00:21:32,240 --> 00:21:37,550
instead of<font color="#CCCCCC"> c2</font><font color="#E5E5E5"> DB and then also making</font>

348
00:21:35,300 --> 00:21:40,430
use<font color="#CCCCCC"> of routers classes to sort</font><font color="#E5E5E5"> of</font>

349
00:21:37,550 --> 00:21:47,210
offload some<font color="#CCCCCC"> of the compute</font><font color="#E5E5E5"> to the</font>

350
00:21:40,430 --> 00:21:51,440
database<font color="#CCCCCC"> so so</font><font color="#E5E5E5"> Samba does so the</font>

351
00:21:47,210 --> 00:21:52,190
question was compute of the database<font color="#E5E5E5"> can</font>

352
00:21:51,440 --> 00:21:56,300
<font color="#CCCCCC">I expand on that</font>

353
00:21:52,190 --> 00:21:59,180
<font color="#E5E5E5">so Samba does some things</font><font color="#CCCCCC"> like traversal</font>

354
00:21:56,300 --> 00:22:03,080
to you know look<font color="#E5E5E5"> up specific records</font>

355
00:21:59,180 --> 00:22:05,270
this<font color="#E5E5E5"> is</font><font color="#CCCCCC"> like incredibly intensive on at</font>

356
00:22:03,080 --> 00:22:08,780
least<font color="#E5E5E5"> it for a</font><font color="#CCCCCC"> CTV case</font>

357
00:22:05,270 --> 00:22:10,760
it's very<font color="#CCCCCC"> inefficient so using</font><font color="#E5E5E5"> Radha's</font>

358
00:22:08,780 --> 00:22:13,610
classes for for<font color="#E5E5E5"> something like that</font>

359
00:22:10,760 --> 00:22:15,410
where we<font color="#CCCCCC"> can offload that operation</font><font color="#E5E5E5"> to</font>

360
00:22:13,610 --> 00:22:23,479
<font color="#E5E5E5">to where the storage or where the key</font>

361
00:22:15,410 --> 00:22:26,270
value store is located would<font color="#E5E5E5"> be no so I</font>

362
00:22:23,480 --> 00:22:27,620
think<font color="#E5E5E5"> we'd still use the</font><font color="#CCCCCC"> OMAP layer</font><font color="#E5E5E5"> for</font>

363
00:22:26,270 --> 00:22:31,340
the<font color="#E5E5E5"> most part or at least we'd start</font>

364
00:22:27,620 --> 00:22:34,820
with<font color="#E5E5E5"> just basic</font><font color="#CCCCCC"> home app on the the</font>

365
00:22:31,340 --> 00:22:36,770
<font color="#CCCCCC">samba side and then when we see what</font>

366
00:22:34,820 --> 00:22:38,540
sort of can be<font color="#E5E5E5"> nicely offloaded to the</font>

367
00:22:36,770 --> 00:22:44,600
cluster we could then go go down<font color="#E5E5E5"> that</font>

368
00:22:38,540 --> 00:22:47,180
path I mean Justin<font color="#CCCCCC"> yeah</font><font color="#E5E5E5"> otherwise that's</font>

369
00:22:44,600 --> 00:22:49,699
it<font color="#E5E5E5"> so I think we</font><font color="#CCCCCC"> have a few minutes for</font>

370
00:22:47,180 --> 00:22:51,140
questions<font color="#E5E5E5"> otherwise just grab</font><font color="#CCCCCC"> ass in</font><font color="#E5E5E5"> two</font>

371
00:22:49,700 --> 00:22:59,020
minutes<font color="#CCCCCC"> so just grab ass in</font><font color="#E5E5E5"> the hall</font>

372
00:22:51,140 --> 00:22:59,020
otherwise yes

373
00:23:14,950 --> 00:23:19,510
there would be<font color="#E5E5E5"> a</font><font color="#CCCCCC"> situation</font><font color="#E5E5E5"> either</font>

374
00:23:32,890 --> 00:23:40,250
so the question was is<font color="#E5E5E5"> there a race</font>

375
00:23:36,110 --> 00:23:42,620
<font color="#CCCCCC">condition in</font><font color="#E5E5E5"> this</font><font color="#CCCCCC"> case where yeah where</font>

376
00:23:40,250 --> 00:23:44,450
we have both things sort<font color="#E5E5E5"> of timing out</font>

377
00:23:42,620 --> 00:23:48,229
on the client<font color="#CCCCCC"> side and</font><font color="#E5E5E5"> server side</font>

378
00:23:44,450 --> 00:23:51,950
simultaneously<font color="#CCCCCC"> for the</font><font color="#E5E5E5"> the witness</font><font color="#CCCCCC"> case</font>

379
00:23:48,230 --> 00:23:55,430
<font color="#E5E5E5">it's it's important to remember that the</font>

380
00:23:51,950 --> 00:23:57,230
client<font color="#E5E5E5"> automatically tries to use</font>

381
00:23:55,430 --> 00:24:01,580
separate nodes for the<font color="#E5E5E5"> file server and</font>

382
00:23:57,230 --> 00:24:03,890
<font color="#E5E5E5">the witness server so in that case if</font>

383
00:24:01,580 --> 00:24:06,590
<font color="#E5E5E5">the file server goes</font><font color="#CCCCCC"> down we can notify</font>

384
00:24:03,890 --> 00:24:08,570
by the the witness<font color="#E5E5E5"> channel so we have a</font>

385
00:24:06,590 --> 00:24:12,250
separate channel to basically<font color="#E5E5E5"> manage the</font>

386
00:24:08,570 --> 00:24:12,250
<font color="#CCCCCC">the failover</font><font color="#E5E5E5"> in that case</font>

387
00:24:14,040 --> 00:24:22,049
[Applause]

