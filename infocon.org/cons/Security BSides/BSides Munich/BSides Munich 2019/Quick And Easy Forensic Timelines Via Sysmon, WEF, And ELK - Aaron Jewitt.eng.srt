1
00:00:02,900 --> 00:00:07,039
invited me here so my name is Aaron

2
00:00:05,630 --> 00:00:10,219
Jewett I'm gonna be talking about

3
00:00:07,040 --> 00:00:11,750
forensic timelines via system on window

4
00:00:10,220 --> 00:00:15,309
F stands for windows event forwarding

5
00:00:11,750 --> 00:00:18,830
see that acronym and ELQ elastic stack

6
00:00:15,309 --> 00:00:22,250
so Who am I I'm a threat hunter this

7
00:00:18,830 --> 00:00:24,860
name is my life right now just about

8
00:00:22,250 --> 00:00:26,930
every alert you see on the network about

9
00:00:24,860 --> 00:00:30,020
90% of them are assist admins doing

10
00:00:26,930 --> 00:00:32,719
weird things so this is what I do so

11
00:00:30,020 --> 00:00:35,420
right now I work for Booz Allen working

12
00:00:32,719 --> 00:00:38,420
with the US Army up in Wiesbaden as a

13
00:00:35,420 --> 00:00:41,510
threat hunter I spent about ten years as

14
00:00:38,420 --> 00:00:43,339
a rock operator at the NSA so I've got a

15
00:00:41,510 --> 00:00:45,678
lot of experience on both sides the

16
00:00:43,339 --> 00:00:48,108
defense and offense as far as info set

17
00:00:45,679 --> 00:00:50,690
goes living in Frankfort

18
00:00:48,109 --> 00:00:52,429
so yeah the new job with elastic I start

19
00:00:50,690 --> 00:00:54,108
next month so I'm going to be

20
00:00:52,429 --> 00:00:55,879
transitioning from a Windows centric

21
00:00:54,109 --> 00:00:57,649
network to an entirely cloud-based

22
00:00:55,879 --> 00:00:59,208
network that I'm gonna have to defend so

23
00:00:57,649 --> 00:01:02,359
it's gonna be a bit of a learning curve

24
00:00:59,209 --> 00:01:04,940
for me I think no adventures and once

25
00:01:02,359 --> 00:01:08,060
again you know all opinions are my own

26
00:01:04,940 --> 00:01:10,039
not anybody else's in case I say

27
00:01:08,060 --> 00:01:13,220
something that makes somebody upset um

28
00:01:10,040 --> 00:01:15,020
so what this talk is about so it's gonna

29
00:01:13,220 --> 00:01:16,789
be about basically using Kabana or

30
00:01:15,020 --> 00:01:18,410
Splunk I'm going to focus on Cabana

31
00:01:16,790 --> 00:01:20,720
because it was free and easy to use it

32
00:01:18,410 --> 00:01:23,630
my house we use Splunk at the office

33
00:01:20,720 --> 00:01:25,429
they're both great so we're gonna be

34
00:01:23,630 --> 00:01:26,570
talking about building dashboards that

35
00:01:25,430 --> 00:01:28,310
make the response

36
00:01:26,570 --> 00:01:30,679
easier so you know so there's multiple

37
00:01:28,310 --> 00:01:32,450
portions there's the alerting

38
00:01:30,680 --> 00:01:34,640
there's detecting the adversary there's

39
00:01:32,450 --> 00:01:36,290
hunting there are tons and tons of blogs

40
00:01:34,640 --> 00:01:39,140
out there and talks out there about

41
00:01:36,290 --> 00:01:40,550
using this type of setup for that so I

42
00:01:39,140 --> 00:01:42,230
wanted to focus on what do you do when

43
00:01:40,550 --> 00:01:44,060
you see an alert how do you respond to

44
00:01:42,230 --> 00:01:47,480
it and how do you make it quicker easier

45
00:01:44,060 --> 00:01:49,760
and more efficient to do the response so

46
00:01:47,480 --> 00:01:51,470
what this talk is not about you know the

47
00:01:49,760 --> 00:01:52,970
anomaly detection the threat hunting I

48
00:01:51,470 --> 00:01:54,679
definitely you know I could do a whole

49
00:01:52,970 --> 00:01:56,450
other talk on that but like I said lots

50
00:01:54,680 --> 00:01:58,040
of people have done these talks so I

51
00:01:56,450 --> 00:01:59,870
didn't want to focus on that portion of

52
00:01:58,040 --> 00:02:01,670
it I'm not gonna go step by step

53
00:01:59,870 --> 00:02:03,560
walkthrough on setting this up I've got

54
00:02:01,670 --> 00:02:05,390
a lot of instructions but you know

55
00:02:03,560 --> 00:02:06,920
there's a lot of stuff out there on the

56
00:02:05,390 --> 00:02:09,019
internet showing you how and and yeah

57
00:02:06,920 --> 00:02:10,430
absolutely zero blockchain or AI in this

58
00:02:09,019 --> 00:02:12,570
talk you know

59
00:02:10,430 --> 00:02:16,950
blockchains a scam and AI is way too

60
00:02:12,570 --> 00:02:20,220
complicated for me so we're gonna go on

61
00:02:16,950 --> 00:02:22,260
this scenario you know your CI so just

62
00:02:20,220 --> 00:02:25,080
got a call Brian Krebs said he's got

63
00:02:22,260 --> 00:02:27,840
indications that you're compromised he's

64
00:02:25,080 --> 00:02:29,820
got a host name a user name and it's

65
00:02:27,840 --> 00:02:32,310
Saturday you know how quickly can you

66
00:02:29,820 --> 00:02:35,310
get forensic information from that host

67
00:02:32,310 --> 00:02:36,960
about that user you know one of the

68
00:02:35,310 --> 00:02:38,460
users and hosts in New York

69
00:02:36,960 --> 00:02:40,620
it's an international company in New

70
00:02:38,460 --> 00:02:42,240
York Singapore imagine it's you know 4th

71
00:02:40,620 --> 00:02:44,100
of July weekend and some holiday in

72
00:02:42,240 --> 00:02:47,010
Singapore you know it's a Sunday in

73
00:02:44,100 --> 00:02:49,079
Germany so nothing's open and you've got

74
00:02:47,010 --> 00:02:50,220
to get all these answers you know so how

75
00:02:49,080 --> 00:02:52,200
long does it take to collect this data

76
00:02:50,220 --> 00:02:53,970
you know how long how many people in

77
00:02:52,200 --> 00:02:55,920
your company are capable of doing this

78
00:02:53,970 --> 00:02:58,170
you know these are the scenarios that is

79
00:02:55,920 --> 00:02:59,489
traditional InfoSec you know you get a

80
00:02:58,170 --> 00:03:00,480
lot of people they get a phone call and

81
00:02:59,490 --> 00:03:02,220
they got to get on an airplane to

82
00:03:00,480 --> 00:03:06,570
Singapore to go image a hard drive and

83
00:03:02,220 --> 00:03:09,960
it's just not a good way to do things so

84
00:03:06,570 --> 00:03:11,340
problems the attacker is moving quickly

85
00:03:09,960 --> 00:03:12,810
through your network you have to be able

86
00:03:11,340 --> 00:03:15,710
to keep up with them you have to contain

87
00:03:12,810 --> 00:03:18,750
them and find them getting data for

88
00:03:15,710 --> 00:03:20,610
investigations is hard if anybody who's

89
00:03:18,750 --> 00:03:22,590
taken the SANS forensics course is the

90
00:03:20,610 --> 00:03:24,660
first two or three days of most the

91
00:03:22,590 --> 00:03:26,880
forensics courses is all about gathering

92
00:03:24,660 --> 00:03:28,440
the data about imaging hard drives about

93
00:03:26,880 --> 00:03:30,240
you know getting the forensic

94
00:03:28,440 --> 00:03:33,300
information off of the device that takes

95
00:03:30,240 --> 00:03:34,860
time and expertise if you don't have the

96
00:03:33,300 --> 00:03:36,840
expertise in-house you got to pay

97
00:03:34,860 --> 00:03:40,440
expensive consultants to go do it for

98
00:03:36,840 --> 00:03:42,750
you so this is this talk is about you

99
00:03:40,440 --> 00:03:44,400
know getting the getting the systems

100
00:03:42,750 --> 00:03:45,600
built so that you don't have to call

101
00:03:44,400 --> 00:03:49,410
these people you don't have to spend

102
00:03:45,600 --> 00:03:51,630
this money on that more problems you

103
00:03:49,410 --> 00:03:53,609
know traditional seems only contain

104
00:03:51,630 --> 00:03:55,890
alerts they said the the antivirus says

105
00:03:53,610 --> 00:03:57,330
something bad happened and that's all it

106
00:03:55,890 --> 00:03:59,429
tells you something bad happened and

107
00:03:57,330 --> 00:04:01,050
you've got a time and a host and that's

108
00:03:59,430 --> 00:04:03,270
all the information that the antivirus

109
00:04:01,050 --> 00:04:05,910
gives you because they suck

110
00:04:03,270 --> 00:04:07,320
attackers delete the logs you know they

111
00:04:05,910 --> 00:04:09,210
compromised user accounts and they

112
00:04:07,320 --> 00:04:10,680
spread so you're trying to quarantine a

113
00:04:09,210 --> 00:04:13,740
system but it's actually the user

114
00:04:10,680 --> 00:04:16,140
account that's compromised invading

115
00:04:13,740 --> 00:04:18,120
antivirus like I said it's super easy I

116
00:04:16,140 --> 00:04:20,959
lost a lot of respect for any virus

117
00:04:18,120 --> 00:04:22,340
during my 10 years on the offensive side

118
00:04:20,959 --> 00:04:24,440
and I haven't getting any respect back

119
00:04:22,340 --> 00:04:27,940
for the three years on the defensive

120
00:04:24,440 --> 00:04:27,940
side at stevia

121
00:04:28,389 --> 00:04:33,830
so what's the solution so we're gonna

122
00:04:31,280 --> 00:04:36,380
create components or Splunk not you know

123
00:04:33,830 --> 00:04:39,169
should be yes or you know either one

124
00:04:36,380 --> 00:04:41,150
whatever you want to pay for and so you

125
00:04:39,169 --> 00:04:43,159
make these these dashboards and it makes

126
00:04:41,150 --> 00:04:44,508
this easy to do so then you get a

127
00:04:43,160 --> 00:04:45,889
dashboard and then you have you don't

128
00:04:44,509 --> 00:04:47,240
have to spend three days of sans

129
00:04:45,889 --> 00:04:48,800
training teaching somebody how to image

130
00:04:47,240 --> 00:04:50,509
a hard drive they just go to the

131
00:04:48,800 --> 00:04:52,280
dashboard and type in an IP address and

132
00:04:50,509 --> 00:04:54,560
boom there's all your information they

133
00:04:52,280 --> 00:04:56,570
type in a username you can do the

134
00:04:54,560 --> 00:04:59,599
investigations extremely quickly like

135
00:04:56,570 --> 00:05:01,520
this elastic and spunk they are great

136
00:04:59,599 --> 00:05:03,289
for forensic science but everybody does

137
00:05:01,520 --> 00:05:05,960
the talks about data science about AI

138
00:05:03,289 --> 00:05:08,090
about anomaly detection you know they

139
00:05:05,960 --> 00:05:09,469
put up these you know crazy formulas for

140
00:05:08,090 --> 00:05:10,969
the data scientists that I just they

141
00:05:09,470 --> 00:05:13,340
blow my mind I don't understand any of

142
00:05:10,970 --> 00:05:15,500
that what I do know is forensic science

143
00:05:13,340 --> 00:05:17,599
and all about you know most forensics is

144
00:05:15,500 --> 00:05:19,460
creating a timeline of events you know

145
00:05:17,599 --> 00:05:21,530
what happened when who did it while

146
00:05:19,460 --> 00:05:23,719
you're doing an investigation I don't

147
00:05:21,530 --> 00:05:27,320
need you know complicated math for that

148
00:05:23,720 --> 00:05:28,610
I just need a time so how are we going

149
00:05:27,320 --> 00:05:30,199
to do this so this is what I'm gonna

150
00:05:28,610 --> 00:05:32,510
talk about in this talk so it's

151
00:05:30,199 --> 00:05:34,190
three-step process super easy well it's

152
00:05:32,510 --> 00:05:37,430
a lot harder than that but it's you know

153
00:05:34,190 --> 00:05:39,020
this is not I'm gonna go out over a lot

154
00:05:37,430 --> 00:05:40,490
of stuff but it's it's pretty much these

155
00:05:39,020 --> 00:05:42,650
three steps so you got to enable the

156
00:05:40,490 --> 00:05:44,330
verbose logging so we're gonna do that

157
00:05:42,650 --> 00:05:46,549
with sis Mon on the windows boxes

158
00:05:44,330 --> 00:05:50,840
elastics auto beep module which just

159
00:05:46,550 --> 00:05:53,240
came out on the Linux and Mac OS systems

160
00:05:50,840 --> 00:05:55,849
which is basically like system on the

161
00:05:53,240 --> 00:05:57,380
for Linux and then you get all those

162
00:05:55,849 --> 00:06:00,520
logs you centrally collect them and then

163
00:05:57,380 --> 00:06:03,139
you feed them into a elastic stack or

164
00:06:00,520 --> 00:06:04,219
Splunk whatever you're using and then

165
00:06:03,139 --> 00:06:06,530
you build your dashboards and you're

166
00:06:04,220 --> 00:06:07,880
good to go and then after that you got

167
00:06:06,530 --> 00:06:10,549
to keep growing and adapting and

168
00:06:07,880 --> 00:06:10,909
changing your stuff so it's not like

169
00:06:10,550 --> 00:06:12,620
that

170
00:06:10,909 --> 00:06:15,430
you do that and you're done now you know

171
00:06:12,620 --> 00:06:17,780
hang up the mission accomplished banner

172
00:06:15,430 --> 00:06:22,460
alright so step one getting the right

173
00:06:17,780 --> 00:06:24,380
logs so sis Mon so if anybody hasn't

174
00:06:22,460 --> 00:06:26,690
heard about sis Mon if you're running a

175
00:06:24,380 --> 00:06:29,060
Windows domain you absolutely should

176
00:06:26,690 --> 00:06:31,610
have system on deployed it's a free

177
00:06:29,060 --> 00:06:34,730
utility so big emphasis there on free

178
00:06:31,610 --> 00:06:37,520
and the config file lets you

179
00:06:34,730 --> 00:06:40,640
it allows granular control over exactly

180
00:06:37,520 --> 00:06:42,680
which logs are created most people they

181
00:06:40,640 --> 00:06:44,659
just say oh it's too much it's too much

182
00:06:42,680 --> 00:06:47,720
data it's because if you use the default

183
00:06:44,660 --> 00:06:49,870
configuration file for sis mod is you

184
00:06:47,720 --> 00:06:54,200
know probably a gigabyte a day per host

185
00:06:49,870 --> 00:06:55,820
if you tuned it down to only send you

186
00:06:54,200 --> 00:06:57,409
the stuff that you care about you can

187
00:06:55,820 --> 00:07:00,099
get it down to just a few megabytes per

188
00:06:57,410 --> 00:07:03,560
host which is a much more manageable

189
00:07:00,100 --> 00:07:04,940
manageable amount in an enterprise this

190
00:07:03,560 --> 00:07:06,230
is a quick overview of some of the stuff

191
00:07:04,940 --> 00:07:08,090
if you haven't heard of system on that

192
00:07:06,230 --> 00:07:11,150
it logs you know every time a process

193
00:07:08,090 --> 00:07:12,950
starts and stops any time somebody

194
00:07:11,150 --> 00:07:14,750
changes the file stamp on a file

195
00:07:12,950 --> 00:07:16,280
you know attackers love doing this when

196
00:07:14,750 --> 00:07:18,290
they put down their root kits and

197
00:07:16,280 --> 00:07:20,359
implants every network connection and

198
00:07:18,290 --> 00:07:22,520
network connection tells you not just

199
00:07:20,360 --> 00:07:23,960
the the source and destination IP like a

200
00:07:22,520 --> 00:07:26,150
firewall log will but it tells you the

201
00:07:23,960 --> 00:07:28,849
exact process gets spawned that network

202
00:07:26,150 --> 00:07:32,179
connection registry changes file

203
00:07:28,850 --> 00:07:33,890
downloads named pipes drivers etc you

204
00:07:32,180 --> 00:07:36,460
can see this it's it's an amazing amount

205
00:07:33,890 --> 00:07:39,650
of data once you tune it to work right

206
00:07:36,460 --> 00:07:42,739
alright so you can you manage it via

207
00:07:39,650 --> 00:07:45,099
config file so if you haven't you know

208
00:07:42,740 --> 00:07:47,330
looked at it Swift on security put out a

209
00:07:45,100 --> 00:07:50,840
config file the community's been adding

210
00:07:47,330 --> 00:07:52,880
to it it's a great place to start and I

211
00:07:50,840 --> 00:07:54,950
say start is and you will have to make

212
00:07:52,880 --> 00:07:56,659
changes to it for your domain no matter

213
00:07:54,950 --> 00:07:59,539
you know you cannot just take this and

214
00:07:56,660 --> 00:08:02,090
plug it in every domain is unique you're

215
00:07:59,540 --> 00:08:03,440
gonna have scripts you know you're you

216
00:08:02,090 --> 00:08:05,119
know as I mentioned from that first meme

217
00:08:03,440 --> 00:08:07,190
some sysadmin is doing some weird

218
00:08:05,120 --> 00:08:08,450
out there and you're going to have to

219
00:08:07,190 --> 00:08:12,200
whitelist it because it's just going to

220
00:08:08,450 --> 00:08:13,550
flood your logs umm constant testing and

221
00:08:12,200 --> 00:08:15,590
changing it never ends somebody's gonna

222
00:08:13,550 --> 00:08:17,690
go buy some new software and it's gonna

223
00:08:15,590 --> 00:08:21,710
wreck your config and you're gonna have

224
00:08:17,690 --> 00:08:25,520
to you know tune that up so here's some

225
00:08:21,710 --> 00:08:27,620
config tips so that top line explote

226
00:08:25,520 --> 00:08:30,169
exclude the good and include everything

227
00:08:27,620 --> 00:08:31,880
else a lot of people will try to just

228
00:08:30,170 --> 00:08:33,440
they'll treat it like it's an IDs like

229
00:08:31,880 --> 00:08:35,750
it's Splunk err suffer like it's snort

230
00:08:33,440 --> 00:08:38,390
where they say I know this is bad so

231
00:08:35,750 --> 00:08:39,799
show me this that's the wrong way to go

232
00:08:38,390 --> 00:08:41,390
because then the attackers will say oh

233
00:08:39,799 --> 00:08:44,540
this is all you're looking for I'm gonna

234
00:08:41,390 --> 00:08:46,069
do something else if you exclude it if

235
00:08:44,540 --> 00:08:48,040
you include everything and only

236
00:08:46,070 --> 00:08:50,740
whitelist that no noise

237
00:08:48,040 --> 00:08:52,300
you know chrome dot exe making a

238
00:08:50,740 --> 00:08:54,850
connection on port 80 to the Internet

239
00:08:52,300 --> 00:08:56,620
okay I'm going to exclude that there may

240
00:08:54,850 --> 00:08:59,019
be times the attacker uses that and it

241
00:08:56,620 --> 00:09:00,699
sucks but it's gonna fall it's gonna

242
00:08:59,019 --> 00:09:02,980
flood my logs I want to know every time

243
00:09:00,699 --> 00:09:05,589
chrome talks to a port that's not 80 or

244
00:09:02,980 --> 00:09:07,720
443 you know or you know maybe then I

245
00:09:05,589 --> 00:09:11,470
whitelist my local you know internal

246
00:09:07,720 --> 00:09:13,240
servers that use weird ports whitelist

247
00:09:11,470 --> 00:09:14,980
with caution with sis Mon if you

248
00:09:13,240 --> 00:09:16,540
whitelist an event you will it will

249
00:09:14,980 --> 00:09:17,380
never show up in the logs and it's like

250
00:09:16,540 --> 00:09:19,420
it never happened

251
00:09:17,380 --> 00:09:20,800
you know inevitably you will be doing an

252
00:09:19,420 --> 00:09:23,139
investigation in something and you'll

253
00:09:20,800 --> 00:09:25,300
run into a dead end and you'll know that

254
00:09:23,139 --> 00:09:26,560
that the logs keep happening you just

255
00:09:25,300 --> 00:09:28,479
don't have a copy because the attacker

256
00:09:26,560 --> 00:09:30,609
moved somewhere like I said maybe they

257
00:09:28,480 --> 00:09:32,380
migrated into chrome dot exe and started

258
00:09:30,610 --> 00:09:33,910
connecting on 443 over the Internet

259
00:09:32,380 --> 00:09:36,630
you're not going to have that connection

260
00:09:33,910 --> 00:09:40,529
and your system on locks sorry

261
00:09:36,630 --> 00:09:40,529
just part of the price of doing business

262
00:09:40,800 --> 00:09:46,479
management tips so sis Mon config file

263
00:09:43,569 --> 00:09:48,910
every host when you you can point that

264
00:09:46,480 --> 00:09:51,310
you can host your config on your net

265
00:09:48,910 --> 00:09:53,290
logon server on your domain and then

266
00:09:51,310 --> 00:09:54,969
just use Active Directory to tell

267
00:09:53,290 --> 00:09:57,459
everybody to go back to this config make

268
00:09:54,970 --> 00:09:58,540
sure it's read-only of course don't you

269
00:09:57,459 --> 00:10:02,199
don't want your attackers messing with

270
00:09:58,540 --> 00:10:04,839
your config well best practices we found

271
00:10:02,199 --> 00:10:06,790
over the last year or so doing it three

272
00:10:04,839 --> 00:10:08,519
separate config files your workstations

273
00:10:06,790 --> 00:10:11,560
your domain administrator your domains

274
00:10:08,519 --> 00:10:12,910
controllers and then your servers on a

275
00:10:11,560 --> 00:10:15,069
domain controller you're going to want

276
00:10:12,910 --> 00:10:17,079
to log it every day and you can

277
00:10:15,069 --> 00:10:19,180
generally whitelist everything that

278
00:10:17,079 --> 00:10:20,649
happens on that because it's it's a

279
00:10:19,180 --> 00:10:22,899
domain controller you shouldn't have

280
00:10:20,649 --> 00:10:24,490
chrome connecting out on the internet so

281
00:10:22,899 --> 00:10:27,490
you on a domain controller you may want

282
00:10:24,490 --> 00:10:29,500
to log that so have three separate

283
00:10:27,490 --> 00:10:33,069
configs you know customize it for your

284
00:10:29,500 --> 00:10:34,360
domain group policy powershell make

285
00:10:33,069 --> 00:10:35,860
they're great for deploying this stuff

286
00:10:34,360 --> 00:10:37,899
once again i'm not gonna go too in depth

287
00:10:35,860 --> 00:10:39,730
over this there are blogs out there on

288
00:10:37,899 --> 00:10:41,170
how to do all this stuff oh and yeah

289
00:10:39,730 --> 00:10:43,589
don't make changes on a friday just

290
00:10:41,170 --> 00:10:43,589
don't

291
00:10:44,149 --> 00:10:49,310
elastic ought to be module this just

292
00:10:46,100 --> 00:10:51,050
came out January 29th so when I actually

293
00:10:49,310 --> 00:10:55,189
did the call for paper this didn't exist

294
00:10:51,050 --> 00:10:57,529
so yeah every host gets a unique gooood

295
00:10:55,189 --> 00:10:59,899
when it's deployed and so you can change

296
00:10:57,529 --> 00:11:01,639
the host name the IP address everything

297
00:10:59,899 --> 00:11:03,829
about the host but that unique gooood

298
00:11:01,639 --> 00:11:05,930
stays the same so in your you know in

299
00:11:03,829 --> 00:11:08,269
your stack you can track all the changes

300
00:11:05,930 --> 00:11:10,459
to a system over time other than that

301
00:11:08,269 --> 00:11:12,800
yeah process information socket creation

302
00:11:10,459 --> 00:11:14,359
user logins etc and so anybody who's

303
00:11:12,800 --> 00:11:16,459
ever smashed their head against oddity

304
00:11:14,360 --> 00:11:19,459
logs knows that they're just just a

305
00:11:16,459 --> 00:11:20,268
nightmare and Linux logging in general

306
00:11:19,459 --> 00:11:22,430
is just a nightmare

307
00:11:20,269 --> 00:11:25,970
so this is you know a great thing to

308
00:11:22,430 --> 00:11:27,739
have yeah for some reason ready for vs.

309
00:11:25,970 --> 00:11:29,839
Red Hat 5 they changed the schemas and

310
00:11:27,740 --> 00:11:34,300
everything looks different it's just

311
00:11:29,839 --> 00:11:37,430
yeah no standardization additional data

312
00:11:34,300 --> 00:11:40,069
so in addition to the windows event logs

313
00:11:37,430 --> 00:11:41,719
you may want to add some extra stuff so

314
00:11:40,069 --> 00:11:43,790
Active Directory information is great

315
00:11:41,720 --> 00:11:46,939
for enriching your dashboards so like

316
00:11:43,790 --> 00:11:48,980
get ad computers get ad users on a daily

317
00:11:46,939 --> 00:11:50,990
basis and pipe that into your dashboards

318
00:11:48,980 --> 00:11:52,670
then you can add all the you know you

319
00:11:50,990 --> 00:11:54,139
can you know when you look up a hostname

320
00:11:52,670 --> 00:11:55,370
you'll find out exactly what desk they

321
00:11:54,139 --> 00:11:57,589
set out and it's displayed on the

322
00:11:55,370 --> 00:11:59,000
dashboard through the phone um what the

323
00:11:57,589 --> 00:12:00,290
phone number is for a user so you can

324
00:11:59,000 --> 00:12:03,769
pick them up and call them say hey was

325
00:12:00,290 --> 00:12:05,660
this you autoruns Palantir made a cool

326
00:12:03,769 --> 00:12:06,800
project where they run auto run it this

327
00:12:05,660 --> 00:12:08,719
is a PowerShell script that will run

328
00:12:06,800 --> 00:12:10,459
auto runs and write as a Windows Event

329
00:12:08,720 --> 00:12:12,910
log so you can just scoop that up and

330
00:12:10,459 --> 00:12:15,199
all the rest of your collection and then

331
00:12:12,910 --> 00:12:18,709
any other vendor Windows Event log

332
00:12:15,199 --> 00:12:21,079
however Sony so step to collecting the

333
00:12:18,709 --> 00:12:24,138
logs if your logs look like that you're

334
00:12:21,079 --> 00:12:25,910
getting too much data um

335
00:12:24,139 --> 00:12:28,490
so different ways of collecting logs

336
00:12:25,910 --> 00:12:31,040
you've got agent based and then just

337
00:12:28,490 --> 00:12:32,209
using the built in functionalities most

338
00:12:31,040 --> 00:12:34,519
time you're gonna have to use a hybrid

339
00:12:32,209 --> 00:12:37,160
approach in a Windows domain the Windows

340
00:12:34,519 --> 00:12:38,629
event forwarding is a great way to use

341
00:12:37,160 --> 00:12:42,439
the built-in capabilities once again

342
00:12:38,629 --> 00:12:44,589
it's free and if a system gets the GPOs

343
00:12:42,439 --> 00:12:47,719
then it gets the event forwarding agent

344
00:12:44,589 --> 00:12:49,639
agent based technology a lot of times

345
00:12:47,720 --> 00:12:51,350
your agent will die and you have no idea

346
00:12:49,639 --> 00:12:53,329
I mean how do you know you didn't get a

347
00:12:51,350 --> 00:12:55,519
log that you know it's just sitting out

348
00:12:53,329 --> 00:12:56,550
there so you you know relying on the

349
00:12:55,519 --> 00:12:58,709
agents gets a

350
00:12:56,550 --> 00:13:00,329
tricky as to seeing a little bit of

351
00:12:58,709 --> 00:13:02,849
diagram later at some point you do have

352
00:13:00,330 --> 00:13:07,110
to use an agent to get it into your your

353
00:13:02,850 --> 00:13:09,420
digestion system windows event

354
00:13:07,110 --> 00:13:11,700
forwarding so like I said it's free any

355
00:13:09,420 --> 00:13:14,250
well mostly free any of you just need a

356
00:13:11,700 --> 00:13:17,040
Windows server on base install Windows

357
00:13:14,250 --> 00:13:20,010
server VM works can be a Windows Event

358
00:13:17,040 --> 00:13:21,990
collector so GPO to tell the

359
00:13:20,010 --> 00:13:24,209
workstations what to do everybody has to

360
00:13:21,990 --> 00:13:26,329
have win RM on in your domain if you

361
00:13:24,209 --> 00:13:28,979
don't have it on just turn it on

362
00:13:26,329 --> 00:13:30,810
Jessica pain at Microsoft has a bunch of

363
00:13:28,980 --> 00:13:34,110
great blog posts on how to set this up

364
00:13:30,810 --> 00:13:36,239
how to use this for threat hunting once

365
00:13:34,110 --> 00:13:39,110
again that that this could be its own to

366
00:13:36,240 --> 00:13:42,360
our talk so I'm not gonna talk about it

367
00:13:39,110 --> 00:13:44,010
the subscription so every system gets a

368
00:13:42,360 --> 00:13:45,810
subscription these are all the windows

369
00:13:44,010 --> 00:13:48,360
events that have to go to the the

370
00:13:45,810 --> 00:13:50,189
collection system so everything is

371
00:13:48,360 --> 00:13:51,870
system on your logins these are just

372
00:13:50,190 --> 00:13:55,290
some other recommendations of things

373
00:13:51,870 --> 00:13:57,089
that you want to send for collection USB

374
00:13:55,290 --> 00:13:58,649
events is great if you're looking at

375
00:13:57,089 --> 00:14:01,200
like insider threat or things like that

376
00:13:58,649 --> 00:14:03,870
you know every time that's the kernel

377
00:14:01,200 --> 00:14:05,430
PNP have it the time and devices plugged

378
00:14:03,870 --> 00:14:09,779
into a system you'll get a log event for

379
00:14:05,430 --> 00:14:11,399
it what do you do once you've got it in

380
00:14:09,779 --> 00:14:14,010
your Windows Event collector then you

381
00:14:11,399 --> 00:14:17,010
can send it so in this example we send

382
00:14:14,010 --> 00:14:19,649
it to Kafka so I used hunting elk help

383
00:14:17,010 --> 00:14:22,589
for this talk to set this up at home

384
00:14:19,649 --> 00:14:24,390
because it was easy to do and we use

385
00:14:22,589 --> 00:14:25,950
Kafka at work as well it's a great place

386
00:14:24,390 --> 00:14:27,720
to send your logs and everything can

387
00:14:25,950 --> 00:14:30,240
subscribe to it so if you have Splunk

388
00:14:27,720 --> 00:14:32,160
and elastic and a traditional seam and

389
00:14:30,240 --> 00:14:35,160
whatever else you can send everything to

390
00:14:32,160 --> 00:14:36,990
your Kafka instance and from there send

391
00:14:35,160 --> 00:14:41,339
it out to whoever needs it it's a a

392
00:14:36,990 --> 00:14:42,829
subscription model alright so step three

393
00:14:41,339 --> 00:14:45,209
we're gonna build things with these logs

394
00:14:42,829 --> 00:14:47,130
this is the big thing that I'm you know

395
00:14:45,209 --> 00:14:48,359
the big part of this talk alright so the

396
00:14:47,130 --> 00:14:50,279
alerts I said I wasn't going to talk

397
00:14:48,360 --> 00:14:53,190
about this but I got a you know put a

398
00:14:50,279 --> 00:14:55,829
quick shout out Sigma project by Florian

399
00:14:53,190 --> 00:14:58,529
Roth it uses a lot of these system on

400
00:14:55,829 --> 00:15:00,779
data to make alerts so if you see run

401
00:14:58,529 --> 00:15:03,079
DLL 32 executing with no command-line

402
00:15:00,779 --> 00:15:06,029
options that's bad that's an attacker

403
00:15:03,079 --> 00:15:07,469
most of the time a lot of these rules

404
00:15:06,029 --> 00:15:09,930
like that I think they're about 130

405
00:15:07,470 --> 00:15:10,440
system on specific rules in a sigma

406
00:15:09,930 --> 00:15:13,410
project

407
00:15:10,440 --> 00:15:15,210
and Hulk has a script that will just go

408
00:15:13,410 --> 00:15:17,250
to github get the latest rules and

409
00:15:15,210 --> 00:15:19,380
create a last alerts with them so that

410
00:15:17,250 --> 00:15:21,150
in your elastic stack you get alerts

411
00:15:19,380 --> 00:15:23,250
whenever these rules trigger and you can

412
00:15:21,150 --> 00:15:24,510
add them in your dashboards or you can

413
00:15:23,250 --> 00:15:26,630
send them to a slack channel whatever

414
00:15:24,510 --> 00:15:28,740
you want to do with them

415
00:15:26,630 --> 00:15:30,990
alright so the dashboards so the

416
00:15:28,740 --> 00:15:33,570
dashboards the the big advantage

417
00:15:30,990 --> 00:15:36,150
dashboards is you can have one person

418
00:15:33,570 --> 00:15:36,720
who learns how to use elastic use

419
00:15:36,150 --> 00:15:39,300
Qabbani

420
00:15:36,720 --> 00:15:41,520
or Splunk and really build out these

421
00:15:39,300 --> 00:15:42,930
nice easy-to-use dashboards so that the

422
00:15:41,520 --> 00:15:45,960
rest of your forensics team doesn't have

423
00:15:42,930 --> 00:15:47,760
to become a data science specialist most

424
00:15:45,960 --> 00:15:49,890
of these places will you know most the

425
00:15:47,760 --> 00:15:51,569
time i've seen businesses they they get

426
00:15:49,890 --> 00:15:53,340
their logs they throw it into Kabana and

427
00:15:51,570 --> 00:15:55,740
they just hand it to their security team

428
00:15:53,340 --> 00:15:57,570
and say have fun and it's just a mess

429
00:15:55,740 --> 00:15:59,130
and nobody you know these they're not

430
00:15:57,570 --> 00:16:01,650
data scientists they want to know what

431
00:15:59,130 --> 00:16:05,970
happened and when so the dashboards can

432
00:16:01,650 --> 00:16:06,840
make this easy so host investigation

433
00:16:05,970 --> 00:16:09,240
dashboard so i'm going to talk about

434
00:16:06,840 --> 00:16:10,380
three big dashboards and i've got at the

435
00:16:09,240 --> 00:16:12,600
end of the talk i've got a link to my

436
00:16:10,380 --> 00:16:16,290
github project and all the JSON files to

437
00:16:12,600 --> 00:16:17,880
import these in your Caban instance so

438
00:16:16,290 --> 00:16:20,880
that the host investigation

439
00:16:17,880 --> 00:16:23,250
investigation dashboard who when where

440
00:16:20,880 --> 00:16:25,560
how and why for a single host so you

441
00:16:23,250 --> 00:16:27,270
enter a host name IP address select your

442
00:16:25,560 --> 00:16:28,650
time frame and boom

443
00:16:27,270 --> 00:16:31,140
here's your forensics timeline if you've

444
00:16:28,650 --> 00:16:33,180
ever done the sans classes they talk

445
00:16:31,140 --> 00:16:35,280
about like logged a timeline they've got

446
00:16:33,180 --> 00:16:37,560
lots of these scripts did like take the

447
00:16:35,280 --> 00:16:39,689
logs you move them to a server you run

448
00:16:37,560 --> 00:16:41,670
python scripts you export that to an

449
00:16:39,690 --> 00:16:43,530
excel spreadsheet and then you do some

450
00:16:41,670 --> 00:16:46,349
other things to it and then you get this

451
00:16:43,530 --> 00:16:48,120
timeline and here you type in an IP

452
00:16:46,350 --> 00:16:50,310
address or a host name and you hit enter

453
00:16:48,120 --> 00:16:51,810
and it's done depending on how much

454
00:16:50,310 --> 00:16:55,410
horsepower your elastic or spunk

455
00:16:51,810 --> 00:16:57,599
instance has each panel should answer a

456
00:16:55,410 --> 00:16:59,699
question you split it out so it's not

457
00:16:57,600 --> 00:17:02,640
too confusing and then you know once

458
00:16:59,700 --> 00:17:07,920
again whitelist annoys your SCCM regular

459
00:17:02,640 --> 00:17:09,930
recurring tasks um so this is just a

460
00:17:07,920 --> 00:17:12,810
kind of how i've separated it out when

461
00:17:09,930 --> 00:17:15,449
it's pretty easy to do user events um

462
00:17:12,810 --> 00:17:17,839
show me all the active users who was

463
00:17:15,449 --> 00:17:21,630
logged into the system at what time line

464
00:17:17,839 --> 00:17:22,980
successful and failed login attempts you

465
00:17:21,630 --> 00:17:24,209
want to grab the logs from the domain

466
00:17:22,980 --> 00:17:27,209
controller as well

467
00:17:24,209 --> 00:17:30,240
to enrich this elevated privileged

468
00:17:27,209 --> 00:17:32,039
account logins 4672 these are great to

469
00:17:30,240 --> 00:17:34,289
see on if you see a normal user

470
00:17:32,039 --> 00:17:35,940
elevating their privileges this you've

471
00:17:34,289 --> 00:17:39,539
got it you know probably gonna have a

472
00:17:35,940 --> 00:17:41,580
bad day commands executed by system if

473
00:17:39,539 --> 00:17:45,960
you ever see system user execute who am

474
00:17:41,580 --> 00:17:48,570
i dot exe you just got owned because red

475
00:17:45,960 --> 00:17:50,460
team guys and i found guilty of this as

476
00:17:48,570 --> 00:17:52,200
well the very first thing you do when

477
00:17:50,460 --> 00:17:55,049
you pop a shell on a box you type who am

478
00:17:52,200 --> 00:17:57,179
i to see if you got system and that's an

479
00:17:55,049 --> 00:17:59,460
indicator right there so you know

480
00:17:57,179 --> 00:18:01,830
everybody's guilty of it so if you see

481
00:17:59,460 --> 00:18:06,360
who am i dot exe running a system you

482
00:18:01,830 --> 00:18:08,549
know it's for sounding alarm downloaded

483
00:18:06,360 --> 00:18:10,289
files this is a great one if you know

484
00:18:08,549 --> 00:18:12,990
when you're trying to find out why of an

485
00:18:10,289 --> 00:18:14,879
anti-virus alert popped and the user

486
00:18:12,990 --> 00:18:16,529
says i have no idea why that pop and

487
00:18:14,880 --> 00:18:19,770
then you can go to the downloaded files

488
00:18:16,529 --> 00:18:21,570
and if nid fifteen you say hey i see

489
00:18:19,770 --> 00:18:23,760
here the chrome dot exe created this

490
00:18:21,570 --> 00:18:25,918
file and the downloads at this exact

491
00:18:23,760 --> 00:18:27,600
time while you are logged in while you

492
00:18:25,919 --> 00:18:30,090
are surfing to this dubious website oh

493
00:18:27,600 --> 00:18:32,760
you know now the user has a little more

494
00:18:30,090 --> 00:18:35,129
trouble arguing the case or do you see

495
00:18:32,760 --> 00:18:36,390
outlook dot exe create the file you know

496
00:18:35,130 --> 00:18:42,659
great things to know when you're doing

497
00:18:36,390 --> 00:18:46,169
an investigation process execution every

498
00:18:42,659 --> 00:18:48,990
process has a unique process to it I'll

499
00:18:46,169 --> 00:18:51,539
go into that later but you get the full

500
00:18:48,990 --> 00:18:53,820
information about the process about you

501
00:18:51,539 --> 00:18:57,029
know the the full path what the current

502
00:18:53,820 --> 00:18:59,010
directory was who then who's the user

503
00:18:57,029 --> 00:19:01,110
that ran it everything you can imagine

504
00:18:59,010 --> 00:19:03,510
with that so you make these dashboards

505
00:19:01,110 --> 00:19:05,370
so if I see the parent process how it

506
00:19:03,510 --> 00:19:07,470
also tells you who the parent was it's a

507
00:19:05,370 --> 00:19:09,330
parent's command powershell w script c

508
00:19:07,470 --> 00:19:10,950
script you know put those all in a

509
00:19:09,330 --> 00:19:12,510
little panel so i can say hey the user

510
00:19:10,950 --> 00:19:15,210
just opened up powershell and ran all

511
00:19:12,510 --> 00:19:16,710
these commands and they work in the

512
00:19:15,210 --> 00:19:19,100
finance section so they shouldn't be

513
00:19:16,710 --> 00:19:19,100
doing that

514
00:19:21,120 --> 00:19:26,610
strange network connections this is you

515
00:19:24,539 --> 00:19:29,820
know things that not chrome cut talking

516
00:19:26,610 --> 00:19:31,649
to 80 and 443 things of that nature just

517
00:19:29,820 --> 00:19:32,820
you can include everything but it's

518
00:19:31,649 --> 00:19:36,750
going to be noisy if you want to get

519
00:19:32,820 --> 00:19:38,370
into the big investigations you're gonna

520
00:19:36,750 --> 00:19:39,840
if you've got more data

521
00:19:38,370 --> 00:19:41,580
coming in just the windows events you

522
00:19:39,840 --> 00:19:43,980
can add in your proxy data your firewall

523
00:19:41,580 --> 00:19:46,530
your bro data once again make this

524
00:19:43,980 --> 00:19:48,360
really easy to do for your users you can

525
00:19:46,530 --> 00:19:50,940
have a junior person you know very

526
00:19:48,360 --> 00:19:52,860
quickly identify you know events inside

527
00:19:50,940 --> 00:19:57,330
your firewall logs correlated with your

528
00:19:52,860 --> 00:20:00,389
windows logs modifications to the host

529
00:19:57,330 --> 00:20:01,800
registry changes new files created so if

530
00:20:00,390 --> 00:20:04,860
you see somebody dropping files in

531
00:20:01,800 --> 00:20:08,309
system 32 that shouldn't be new services

532
00:20:04,860 --> 00:20:11,309
getting installed drivers loaded USB

533
00:20:08,309 --> 00:20:12,899
changes as once again insertions you can

534
00:20:11,309 --> 00:20:16,559
also find this if you look for registry

535
00:20:12,900 --> 00:20:18,960
keys with star Enuma star every time you

536
00:20:16,559 --> 00:20:20,730
plug in registry or a USB item into a

537
00:20:18,960 --> 00:20:22,650
Windows box it makes the registry key

538
00:20:20,730 --> 00:20:25,080
and gives you it gives you the name of

539
00:20:22,650 --> 00:20:27,720
it so you can see you know Jim's iPad

540
00:20:25,080 --> 00:20:30,000
plugged in you know at this time on it

541
00:20:27,720 --> 00:20:33,050
you know it's in the registry and then

542
00:20:30,000 --> 00:20:36,090
the W my subscription changes that's a

543
00:20:33,050 --> 00:20:39,960
popular persistence tech technique for

544
00:20:36,090 --> 00:20:43,709
attackers all right so on to the user

545
00:20:39,960 --> 00:20:45,980
investigation dashboard once again users

546
00:20:43,710 --> 00:20:48,540
get compromised just like systems do

547
00:20:45,980 --> 00:20:50,730
sometimes the users bad sometimes their

548
00:20:48,540 --> 00:20:53,460
account gets compromised there's no way

549
00:20:50,730 --> 00:20:54,750
of knowing really the difference just by

550
00:20:53,460 --> 00:20:56,700
the behavior of what's happening on the

551
00:20:54,750 --> 00:20:59,370
computer most the time that takes like a

552
00:20:56,700 --> 00:21:04,320
law enforcement type investigation or

553
00:20:59,370 --> 00:21:07,139
somebody's going to fess up to it yeah

554
00:21:04,320 --> 00:21:09,389
get a B user is your friend if you can

555
00:21:07,140 --> 00:21:10,920
enrich this data then you can have the

556
00:21:09,390 --> 00:21:13,260
users phone number and so then your

557
00:21:10,920 --> 00:21:15,270
junior analyst on a Saturday morning see

558
00:21:13,260 --> 00:21:16,559
somebody logging in and they type it

559
00:21:15,270 --> 00:21:17,760
into the panel and it's got their phone

560
00:21:16,559 --> 00:21:19,710
number there they just pick up the phone

561
00:21:17,760 --> 00:21:21,929
and say hey was this you yeah I'm

562
00:21:19,710 --> 00:21:24,780
working on a Saturday morning okay great

563
00:21:21,929 --> 00:21:26,340
and they say no I'm with my kids at the

564
00:21:24,780 --> 00:21:31,110
field I'm not I'm not at work at all

565
00:21:26,340 --> 00:21:34,169
didn't you got an issue this is just a

566
00:21:31,110 --> 00:21:36,379
quick screenshot of the dashboard I made

567
00:21:34,170 --> 00:21:39,000
a home on a over the weekend on qivana

568
00:21:36,380 --> 00:21:41,340
like I said we use Splunk at work I use

569
00:21:39,000 --> 00:21:43,050
Caban at home either way it's not too

570
00:21:41,340 --> 00:21:46,290
hard to do you can see the dubious

571
00:21:43,050 --> 00:21:48,270
PowerShell command line spawning off

572
00:21:46,290 --> 00:21:51,590
there the user was a running PowerShell

573
00:21:48,270 --> 00:21:51,590
Empire because was me

574
00:21:52,750 --> 00:21:58,480
so this is just so you saw the time line

575
00:21:56,050 --> 00:22:01,000
there that that was the time line of

576
00:21:58,480 --> 00:22:02,560
every computer that's logged into so

577
00:22:01,000 --> 00:22:04,450
when you've got a computer user account

578
00:22:02,560 --> 00:22:05,710
that gets compromised you know this is

579
00:22:04,450 --> 00:22:07,210
great because you can just put in and

580
00:22:05,710 --> 00:22:09,190
say hey you for the last seven days show

581
00:22:07,210 --> 00:22:12,400
me everything this users done every

582
00:22:09,190 --> 00:22:15,780
system they logged in to all these

583
00:22:12,400 --> 00:22:19,120
events successful and failed logins

584
00:22:15,780 --> 00:22:21,490
definitely it gets a good it gets a bit

585
00:22:19,120 --> 00:22:23,620
creepy though because this dashboard is

586
00:22:21,490 --> 00:22:27,540
capable of showing you everything users

587
00:22:23,620 --> 00:22:30,489
done on your domain you know anywhere so

588
00:22:27,540 --> 00:22:32,170
this kind of because of the power of

589
00:22:30,490 --> 00:22:33,160
this and these dashboards in general if

590
00:22:32,170 --> 00:22:35,110
you do this at work

591
00:22:33,160 --> 00:22:36,990
make sure you multi-factor

592
00:22:35,110 --> 00:22:38,740
authentication lockdown these systems

593
00:22:36,990 --> 00:22:40,870
because there is going to be some

594
00:22:38,740 --> 00:22:42,400
sensitive information in here it's not

595
00:22:40,870 --> 00:22:44,159
going to show you the contents of files

596
00:22:42,400 --> 00:22:47,440
but it show you the name of the files

597
00:22:44,160 --> 00:22:49,480
you will have admins typing the password

598
00:22:47,440 --> 00:22:51,580
into the command line and you'll have

599
00:22:49,480 --> 00:22:54,360
those passwords in your logs so you know

600
00:22:51,580 --> 00:22:58,169
bug people about that it's bad habits

601
00:22:54,360 --> 00:23:00,610
but you're gonna see that in your logs

602
00:22:58,170 --> 00:23:02,260
this is a good selling point to the

603
00:23:00,610 --> 00:23:05,290
compliance team so because you know I

604
00:23:02,260 --> 00:23:06,910
live up in Frankfort you know regularly

605
00:23:05,290 --> 00:23:09,370
the bullet I'll walk into the Deutsche

606
00:23:06,910 --> 00:23:10,750
Bank offices and ask for you know escort

607
00:23:09,370 --> 00:23:12,370
a user out and ask for everything

608
00:23:10,750 --> 00:23:15,900
they've done you know so a dashboard

609
00:23:12,370 --> 00:23:15,899
like this would come in handy for them

610
00:23:16,410 --> 00:23:21,250
all right so let's say you're gonna

611
00:23:19,480 --> 00:23:23,470
learn it's talking about a very specific

612
00:23:21,250 --> 00:23:25,390
process that's happening and you say

613
00:23:23,470 --> 00:23:28,060
what is this process doing every process

614
00:23:25,390 --> 00:23:31,510
in sis Mon has a unique process gooood

615
00:23:28,060 --> 00:23:33,610
this process good is unique every so if

616
00:23:31,510 --> 00:23:35,170
you spawn for calyx dottie exceeds every

617
00:23:33,610 --> 00:23:38,350
four of them are gonna have a unique

618
00:23:35,170 --> 00:23:39,700
good so you just go to the dashboard you

619
00:23:38,350 --> 00:23:41,669
see search for this do it it will show

620
00:23:39,700 --> 00:23:44,500
you who spawned it who is parent was

621
00:23:41,670 --> 00:23:48,070
every single event related to this

622
00:23:44,500 --> 00:23:49,780
process will be in this dashboard and in

623
00:23:48,070 --> 00:23:51,760
the dashboard you can add multiple goods

624
00:23:49,780 --> 00:23:53,170
and get a whole hierarchy chain of

625
00:23:51,760 --> 00:23:55,210
events of everything that happened so if

626
00:23:53,170 --> 00:23:56,950
if you see a user doing something shady

627
00:23:55,210 --> 00:23:59,770
with PowerShell you can see every child

628
00:23:56,950 --> 00:24:02,680
process and the parent process you know

629
00:23:59,770 --> 00:24:05,139
chain together this is just a quick

630
00:24:02,680 --> 00:24:08,170
instance that the shady user spawning

631
00:24:05,140 --> 00:24:10,990
our shell empire again so you can see uh

632
00:24:08,170 --> 00:24:12,610
I think yeah I think I ran who am i in

633
00:24:10,990 --> 00:24:13,750
there actually that ran automatically

634
00:24:12,610 --> 00:24:15,610
that was just part of power show and

635
00:24:13,750 --> 00:24:19,690
fired I didn't even have to run Who am I

636
00:24:15,610 --> 00:24:21,310
it just does it on its own so uh I can

637
00:24:19,690 --> 00:24:23,110
find out you know I can just trace it

638
00:24:21,310 --> 00:24:26,409
back so this is great for junior

639
00:24:23,110 --> 00:24:28,659
analysts to really get an idea of every

640
00:24:26,410 --> 00:24:30,220
time you see an alert you say okay is

641
00:24:28,660 --> 00:24:32,800
this something bad and I've seen in

642
00:24:30,220 --> 00:24:34,630
countless organizations where you know

643
00:24:32,800 --> 00:24:36,040
analysts will just say oh I've seen this

644
00:24:34,630 --> 00:24:37,930
alert hundreds of times it's nothing

645
00:24:36,040 --> 00:24:40,210
well how do you know it's nothing well

646
00:24:37,930 --> 00:24:42,040
one time it could be something well it's

647
00:24:40,210 --> 00:24:44,260
it's just so hard to investigate

648
00:24:42,040 --> 00:24:46,659
individual alerts they just write off oh

649
00:24:44,260 --> 00:24:48,790
it's nothing with this you can say okay

650
00:24:46,660 --> 00:24:49,990
show me everything that that account

651
00:24:48,790 --> 00:24:52,240
actually did everything that that

652
00:24:49,990 --> 00:24:54,400
process is done and now you can say

653
00:24:52,240 --> 00:24:59,080
definitively that it's nothing or it is

654
00:24:54,400 --> 00:25:02,830
something so I think I probably went a

655
00:24:59,080 --> 00:25:06,580
little too fast but so any organization

656
00:25:02,830 --> 00:25:07,649
can build this very little money so that

657
00:25:06,580 --> 00:25:10,689
the software is free

658
00:25:07,650 --> 00:25:12,250
you just need basically the hardware to

659
00:25:10,690 --> 00:25:15,190
run this on and everything can be done

660
00:25:12,250 --> 00:25:16,780
on virtual machines the dashboards are

661
00:25:15,190 --> 00:25:18,130
not just for the security team this

662
00:25:16,780 --> 00:25:21,160
whole system is not just for the

663
00:25:18,130 --> 00:25:23,290
security team so if you are trying to

664
00:25:21,160 --> 00:25:25,240
get this built in your organization you

665
00:25:23,290 --> 00:25:27,370
know go get the active directory guys on

666
00:25:25,240 --> 00:25:30,040
board go get the DevOps guys on board on

667
00:25:27,370 --> 00:25:31,840
all of this data is great for them as

668
00:25:30,040 --> 00:25:34,389
well and if you get them on board then

669
00:25:31,840 --> 00:25:35,949
that helps the funding and your your CIO

670
00:25:34,390 --> 00:25:39,400
so we'll be happy as well to share the

671
00:25:35,950 --> 00:25:40,780
burden of this system when you can use

672
00:25:39,400 --> 00:25:43,420
this to audit changes to Active

673
00:25:40,780 --> 00:25:45,879
Directory or do a quick query of all

674
00:25:43,420 --> 00:25:47,500
crashing processes or find out you know

675
00:25:45,880 --> 00:25:49,210
things of that nature if the DevOps guy

676
00:25:47,500 --> 00:25:50,950
is trying to troubleshoot why their

677
00:25:49,210 --> 00:25:55,900
system keeps crashing they can use these

678
00:25:50,950 --> 00:25:57,880
dashboards so are there any questions

679
00:25:55,900 --> 00:25:58,330
start that one a little faster than I

680
00:25:57,880 --> 00:26:09,310
expected

681
00:25:58,330 --> 00:26:12,040
Oh question yeah so we we spoke with

682
00:26:09,310 --> 00:26:13,600
some some of the German German Army

683
00:26:12,040 --> 00:26:15,760
Bundestag people came and they were

684
00:26:13,600 --> 00:26:18,340
taking about this and they liked the

685
00:26:15,760 --> 00:26:18,790
fact that when the logs the logs come in

686
00:26:18,340 --> 00:26:21,429
they don't

687
00:26:18,790 --> 00:26:23,980
have the contents of any of the files so

688
00:26:21,430 --> 00:26:25,780
you have the file name so if somebody

689
00:26:23,980 --> 00:26:29,140
puts sensitive information in the name

690
00:26:25,780 --> 00:26:30,879
of the file that may be an issue but

691
00:26:29,140 --> 00:26:32,650
it's easy to justify look we were

692
00:26:30,880 --> 00:26:35,380
collecting the names of the files on our

693
00:26:32,650 --> 00:26:37,120
domain so they were pretty confident

694
00:26:35,380 --> 00:26:40,540
they could sell it to their lawyers I

695
00:26:37,120 --> 00:26:43,389
haven't had that argument but you know

696
00:26:40,540 --> 00:26:48,550
once again it's you just have to have

697
00:26:43,390 --> 00:26:50,080
the right lawyer I guess oh sorry yeah

698
00:26:48,550 --> 00:26:53,080
the question was how does that work with

699
00:26:50,080 --> 00:26:56,409
German labor laws with the sensitivity

700
00:26:53,080 --> 00:26:59,230
of the information etc and yes any

701
00:26:56,410 --> 00:27:00,700
system like this absolutely must be

702
00:26:59,230 --> 00:27:03,880
locked down like don't put this out on

703
00:27:00,700 --> 00:27:04,900
your AWS cloud with a crappy password or

704
00:27:03,880 --> 00:27:07,090
no password

705
00:27:04,900 --> 00:27:12,610
you know two-factor authentication keep

706
00:27:07,090 --> 00:27:14,500
it protected any of the in India this

707
00:27:12,610 --> 00:27:18,820
will fly with a big company with a

708
00:27:14,500 --> 00:27:21,130
decent life behind them because you can

709
00:27:18,820 --> 00:27:23,649
basically see if someone was working

710
00:27:21,130 --> 00:27:25,750
what they were working on yes so the

711
00:27:23,650 --> 00:27:29,620
question was about a big company with it

712
00:27:25,750 --> 00:27:32,620
with a union and yeah monitoring

713
00:27:29,620 --> 00:27:34,209
individuals and yeah the data is already

714
00:27:32,620 --> 00:27:37,030
there in the net work we're just

715
00:27:34,210 --> 00:27:41,020
centrally collecting it so yeah once

716
00:27:37,030 --> 00:27:42,670
again I'm not a lawyer in the German

717
00:27:41,020 --> 00:27:45,400
labor laws I'm definitely not familiar

718
00:27:42,670 --> 00:27:46,990
with them to that extent but you are

719
00:27:45,400 --> 00:27:49,240
just you're collecting the data that's

720
00:27:46,990 --> 00:27:50,590
already there I mean any of it any of

721
00:27:49,240 --> 00:27:51,790
this information you could already you

722
00:27:50,590 --> 00:27:55,030
could find out with the PowerShell

723
00:27:51,790 --> 00:27:56,409
script as well but this it just makes it

724
00:27:55,030 --> 00:27:59,500
a lot easier and makes it a lot more

725
00:27:56,410 --> 00:28:02,310
simple to to view and see I see them

726
00:27:59,500 --> 00:28:02,310
myself

727
00:28:02,400 --> 00:28:11,770
the team's yeah my team then push it

728
00:28:05,380 --> 00:28:13,390
back because yeah okay just adds up yeah

729
00:28:11,770 --> 00:28:15,129
I'm sure there's always anything like

730
00:28:13,390 --> 00:28:18,430
this there may be a maybe pushback

731
00:28:15,130 --> 00:28:20,320
because the users would have zero

732
00:28:18,430 --> 00:28:21,790
visibility in this I don't know how much

733
00:28:20,320 --> 00:28:24,580
pushback the pushback would have to come

734
00:28:21,790 --> 00:28:26,050
you know from someone who has access or

735
00:28:24,580 --> 00:28:28,000
somebody who knows what's in the system

736
00:28:26,050 --> 00:28:29,590
and knows more about system like

737
00:28:28,000 --> 00:28:31,740
Microsoft teams makes it pretty obvious

738
00:28:29,590 --> 00:28:31,740
I think

739
00:28:32,260 --> 00:28:36,640
and normal like normal managers in the

740
00:28:35,170 --> 00:28:39,010
company should not have access to this

741
00:28:36,640 --> 00:28:40,600
system this should be like the IT guys

742
00:28:39,010 --> 00:28:43,810
and security guys and maybe some

743
00:28:40,600 --> 00:28:45,610
compliance teams regular old manager no

744
00:28:43,810 --> 00:28:55,139
they should not access the system in any

745
00:28:45,610 --> 00:28:57,850
way yes coverage necessary from this so

746
00:28:55,140 --> 00:29:01,120
100% of my service and on Senate McFly's

747
00:28:57,850 --> 00:29:03,550
power yeah so the question is what

748
00:29:01,120 --> 00:29:03,909
percentage of coverage to profit from

749
00:29:03,550 --> 00:29:06,010
this

750
00:29:03,910 --> 00:29:08,620
I would aim for a hundred percent I mean

751
00:29:06,010 --> 00:29:10,360
there's it's because it is free and it

752
00:29:08,620 --> 00:29:13,360
is just a GPO that you push out to the

753
00:29:10,360 --> 00:29:16,120
systems yes it does have to be rolled

754
00:29:13,360 --> 00:29:17,320
out and yeah we've been doing it for a

755
00:29:16,120 --> 00:29:18,820
year and we haven't gotten to a hundred

756
00:29:17,320 --> 00:29:20,889
percent yet there's always there always

757
00:29:18,820 --> 00:29:24,040
going to be you know pushback from

758
00:29:20,890 --> 00:29:27,190
admins workstations I definitely think a

759
00:29:24,040 --> 00:29:29,950
hundred percent isn't it is doable we've

760
00:29:27,190 --> 00:29:31,870
had red team's come in and before we had

761
00:29:29,950 --> 00:29:33,520
this they were able to do PowerShell

762
00:29:31,870 --> 00:29:36,879
Empire and living off the land

763
00:29:33,520 --> 00:29:38,440
techniques and we didn't see it after we

764
00:29:36,880 --> 00:29:40,030
built this we kicked their butt we would

765
00:29:38,440 --> 00:29:42,220
see him immediately we get the alerts

766
00:29:40,030 --> 00:29:46,270
within 10 minutes of them coming in and

767
00:29:42,220 --> 00:29:47,830
we'd kick them out within 30 and so yeah

768
00:29:46,270 --> 00:29:49,210
they look on a red team's face when you

769
00:29:47,830 --> 00:29:51,100
should have a full report of every

770
00:29:49,210 --> 00:29:53,620
single command they ran while they were

771
00:29:51,100 --> 00:29:54,969
on your system is great you know it's it

772
00:29:53,620 --> 00:29:56,979
makes up for all those years of them

773
00:29:54,970 --> 00:29:58,390
coming in to kick your ass what you can

774
00:29:56,980 --> 00:30:00,630
say this is everything you did and this

775
00:29:58,390 --> 00:30:02,470
is when we kicked you out of the network

776
00:30:00,630 --> 00:30:04,000
and that's a great thing for a

777
00:30:02,470 --> 00:30:06,190
pentesting record to have that so yeah

778
00:30:04,000 --> 00:30:08,110
that's as far as workstations go you

779
00:30:06,190 --> 00:30:10,960
need to have coverage because they're

780
00:30:08,110 --> 00:30:12,850
gonna go to your kiosk downstairs or you

781
00:30:10,960 --> 00:30:14,170
know that the waiting room area or

782
00:30:12,850 --> 00:30:16,120
somewhere where it's not going to be a

783
00:30:14,170 --> 00:30:20,620
critical access system and then try to

784
00:30:16,120 --> 00:30:22,149
move laterally from their servers you

785
00:30:20,620 --> 00:30:23,949
know I would push for a hundred percent

786
00:30:22,150 --> 00:30:32,890
if you can but it's gonna be an ongoing

787
00:30:23,950 --> 00:30:35,260
fight that never ends nope oh yeah and

788
00:30:32,890 --> 00:30:37,840
yeah the question side yeah that that's

789
00:30:35,260 --> 00:30:40,090
the github link for the so I've got this

790
00:30:37,840 --> 00:30:42,970
these slides as well as the the JSON

791
00:30:40,090 --> 00:30:44,780
file so if you want to use these

792
00:30:42,970 --> 00:30:48,050
dashboards you just go there um

793
00:30:44,780 --> 00:30:51,379
right in your Cabana so I was using elk

794
00:30:48,050 --> 00:30:54,139
the hunting elk for this so your if

795
00:30:51,380 --> 00:30:56,210
you're it's formatting the events based

796
00:30:54,140 --> 00:30:59,720
on the fact that Kabana gets them first

797
00:30:56,210 --> 00:31:01,100
and then they move into Earth that Kafka

798
00:30:59,720 --> 00:31:03,140
gets them first and then they move into

799
00:31:01,100 --> 00:31:04,969
cabana everybody's going to have

800
00:31:03,140 --> 00:31:06,350
different field names but if you just do

801
00:31:04,970 --> 00:31:07,940
a fine if you have different field names

802
00:31:06,350 --> 00:31:15,139
you can find and replace inside of the

803
00:31:07,940 --> 00:31:22,160
JSON files and it should work one other

804
00:31:15,140 --> 00:31:24,710
question we have with German and because

805
00:31:22,160 --> 00:31:26,450
my limits they've been something really

806
00:31:24,710 --> 00:31:28,940
problems because a lot of things are

807
00:31:26,450 --> 00:31:30,590
then suddenly German yeah and I think

808
00:31:28,940 --> 00:31:33,320
that's where the when I mentioned that

809
00:31:30,590 --> 00:31:35,300
every domain is unique you're gonna have

810
00:31:33,320 --> 00:31:37,070
you're gonna have some processes that

811
00:31:35,300 --> 00:31:39,620
are the same name and some that are

812
00:31:37,070 --> 00:31:42,230
completely different and so you're gonna

813
00:31:39,620 --> 00:31:44,179
have to just so I think I kind of

814
00:31:42,230 --> 00:31:46,280
skimmed over it but I said start small

815
00:31:44,180 --> 00:31:48,620
with your config when you're when you're

816
00:31:46,280 --> 00:31:50,600
building this out you know pick random

817
00:31:48,620 --> 00:31:52,489
hosts five or ten hosts in the network

818
00:31:50,600 --> 00:31:55,129
and just start collecting from those

819
00:31:52,490 --> 00:31:57,110
systems do not push to everybody in the

820
00:31:55,130 --> 00:31:58,150
network l at once that's a horrible idea

821
00:31:57,110 --> 00:32:00,889
and it will break things

822
00:31:58,150 --> 00:32:03,470
pick five or six people and a spend a

823
00:32:00,890 --> 00:32:04,760
week or two just tuning the logs and

824
00:32:03,470 --> 00:32:07,550
getting rid of the white noise and then

825
00:32:04,760 --> 00:32:10,250
you know maybe go from five to ten to a

826
00:32:07,550 --> 00:32:12,200
hundred to a thousand from there as you

827
00:32:10,250 --> 00:32:15,140
build out your config take it you know

828
00:32:12,200 --> 00:32:16,640
you know this is it's a project you're

829
00:32:15,140 --> 00:32:19,190
going to need a project manager for this

830
00:32:16,640 --> 00:32:21,800
to get it deployed somebody to kind of

831
00:32:19,190 --> 00:32:25,910
champion this and push the to push it

832
00:32:21,800 --> 00:32:30,260
out into your domain ya get the same

833
00:32:25,910 --> 00:32:32,300
quality for unique systems I think so

834
00:32:30,260 --> 00:32:34,550
like I said audit became out and the

835
00:32:32,300 --> 00:32:37,070
question was same quality of information

836
00:32:34,550 --> 00:32:39,050
for audit be so ought to be came out

837
00:32:37,070 --> 00:32:40,490
January 29th as I mentioned my next job

838
00:32:39,050 --> 00:32:43,129
is going to be working for elastic which

839
00:32:40,490 --> 00:32:44,600
is primarily a Mac OS Linux based

840
00:32:43,130 --> 00:32:47,420
network so I'll be learning this and

841
00:32:44,600 --> 00:32:51,409
trying to build this on you know these

842
00:32:47,420 --> 00:32:52,850
systems so prior to the oughta be you

843
00:32:51,410 --> 00:32:55,760
know I've tried building out these

844
00:32:52,850 --> 00:32:57,620
dashboards using like audit D data just

845
00:32:55,760 --> 00:32:59,870
using the built in Windows that net logs

846
00:32:57,620 --> 00:33:02,840
are the windows syslog data and it's

847
00:32:59,870 --> 00:33:05,510
just a nightmare you get data from your

848
00:33:02,840 --> 00:33:06,980
SX server and from your Red Hat server

849
00:33:05,510 --> 00:33:08,900
and you're a bun to server and your

850
00:33:06,980 --> 00:33:11,270
debian server and the logs are all

851
00:33:08,900 --> 00:33:13,309
completely different format and there's

852
00:33:11,270 --> 00:33:18,049
no normalization and it's just is

853
00:33:13,309 --> 00:33:19,610
horrible so yeah so I'm hoping that I

854
00:33:18,049 --> 00:33:25,010
like said I haven't done it yet but I'm

855
00:33:19,610 --> 00:33:31,010
hoping the door work are there any other

856
00:33:25,010 --> 00:33:32,450
questions all right so I guess that

857
00:33:31,010 --> 00:33:34,039
concludes my talk and I'll be here the

858
00:33:32,450 --> 00:33:37,240
rest of the day and if anybody has any

859
00:33:34,039 --> 00:33:37,240
other questions thank you

