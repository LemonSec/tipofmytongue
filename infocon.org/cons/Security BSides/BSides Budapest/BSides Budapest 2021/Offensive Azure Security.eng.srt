1
00:00:00,240 --> 00:00:01,280
hello

2
00:00:01,280 --> 00:00:03,840
and welcome to b-sides so here and

3
00:00:03,840 --> 00:00:06,960
besides budapest we're gonna start the

4
00:00:06,960 --> 00:00:09,599
next session which is offensive azure

5
00:00:09,599 --> 00:00:12,160
security my name is sergey and i will be

6
00:00:12,160 --> 00:00:15,360
presenter uh during this session

7
00:00:15,360 --> 00:00:18,640
this session is going to cover azure's

8
00:00:18,640 --> 00:00:21,199
azure service and how we can pentest

9
00:00:21,199 --> 00:00:23,039
this popular cloud service so you will

10
00:00:23,039 --> 00:00:25,039
see live demos of different techniques

11
00:00:25,039 --> 00:00:28,080
that may be used to

12
00:00:28,080 --> 00:00:30,720
let's say compromise or pan test if you

13
00:00:30,720 --> 00:00:31,760
wish

14
00:00:31,760 --> 00:00:32,880
this

15
00:00:32,880 --> 00:00:35,680
measures azure different different

16
00:00:35,680 --> 00:00:38,879
resources that we may deploy in azure so

17
00:00:38,879 --> 00:00:41,040
let me show you one more slide about me

18
00:00:41,040 --> 00:00:43,200
and then we're going to

19
00:00:43,200 --> 00:00:44,960
cover something more

20
00:00:44,960 --> 00:00:47,600
more important which is the our content

21
00:00:47,600 --> 00:00:49,600
so my name is sergey once again

22
00:00:49,600 --> 00:00:51,600
um very important where i'm from i'm

23
00:00:51,600 --> 00:00:55,039
from russia so that's my burden to do

24
00:00:55,039 --> 00:00:57,680
all of this hacking and

25
00:00:57,680 --> 00:00:59,840
as you can see on the slide i i do a lot

26
00:00:59,840 --> 00:01:02,640
of pen tests and also i'm an instructor

27
00:01:02,640 --> 00:01:04,080
conference speaker

28
00:01:04,080 --> 00:01:06,080
if you want to contact me

29
00:01:06,080 --> 00:01:07,680
during the session after the session

30
00:01:07,680 --> 00:01:10,159
whatever maybe here's the linkedin url

31
00:01:10,159 --> 00:01:12,560
go ahead and find me you may

32
00:01:12,560 --> 00:01:14,799
ask something say something or you may

33
00:01:14,799 --> 00:01:16,720
just find some other conferences where i

34
00:01:16,720 --> 00:01:17,840
speak

35
00:01:17,840 --> 00:01:19,920
uh i'm azure mvp

36
00:01:19,920 --> 00:01:20,880
i have

37
00:01:20,880 --> 00:01:24,840
oscp or sap mct whatever it may be

38
00:01:24,840 --> 00:01:27,280
certifications but i think

39
00:01:27,280 --> 00:01:29,360
your goal here is not just listen about

40
00:01:29,360 --> 00:01:30,640
me but

41
00:01:30,640 --> 00:01:32,640
finally let's start the session

42
00:01:32,640 --> 00:01:34,320
so let's start the session and let's

43
00:01:34,320 --> 00:01:36,400
take a look on our agenda and you can

44
00:01:36,400 --> 00:01:37,920
see here

45
00:01:37,920 --> 00:01:40,400
three figures and you may ask what the

46
00:01:40,400 --> 00:01:41,759
hell is that

47
00:01:41,759 --> 00:01:44,720
i'm waiting for agenda

48
00:01:44,720 --> 00:01:47,119
what those things are all about

49
00:01:47,119 --> 00:01:49,520
so that's that's my agenda as i

50
00:01:49,520 --> 00:01:51,200
mentioned before this session will be

51
00:01:51,200 --> 00:01:52,159
about

52
00:01:52,159 --> 00:01:53,759
will be about

53
00:01:53,759 --> 00:01:55,840
like an offensive things will be about

54
00:01:55,840 --> 00:01:56,960
dark side

55
00:01:56,960 --> 00:01:59,600
i will show you how those three

56
00:01:59,600 --> 00:02:02,560
environments may be compromised

57
00:02:02,560 --> 00:02:05,119
so how hybrid ad may be compromised when

58
00:02:05,119 --> 00:02:07,600
you have on-premise id and you have

59
00:02:07,600 --> 00:02:10,318
ad connect and in azure id as well

60
00:02:10,318 --> 00:02:12,959
how those things may be compromised

61
00:02:12,959 --> 00:02:14,959
you will see how virtual machines may be

62
00:02:14,959 --> 00:02:18,959
compromised and also the last one is

63
00:02:18,959 --> 00:02:22,720
application in pass services

64
00:02:22,720 --> 00:02:24,239
um using

65
00:02:24,239 --> 00:02:27,440
oh it will use only past services how

66
00:02:27,440 --> 00:02:29,920
those things may be compromised as well

67
00:02:29,920 --> 00:02:32,560
that's my agenda so let's get started as

68
00:02:32,560 --> 00:02:34,480
i mentioned before a session will be

69
00:02:34,480 --> 00:02:36,400
based on live demos so you will not see

70
00:02:36,400 --> 00:02:38,640
a lot of slides here i will use slides

71
00:02:38,640 --> 00:02:41,760
to just show where we are

72
00:02:41,760 --> 00:02:43,040
but

73
00:02:43,040 --> 00:02:45,599
i will not really use slides for

74
00:02:45,599 --> 00:02:47,440
technical explanation

75
00:02:47,440 --> 00:02:49,280
so the first scenario

76
00:02:49,280 --> 00:02:52,400
is my own parameter directory with ad

77
00:02:52,400 --> 00:02:54,720
connect

78
00:02:54,720 --> 00:02:57,120
and of course azure id as well so let me

79
00:02:57,120 --> 00:02:58,879
jump to demo as you

80
00:02:58,879 --> 00:03:01,040
demo as i promised you and so here i

81
00:03:01,040 --> 00:03:03,599
have a simple configuration first of all

82
00:03:03,599 --> 00:03:05,599
i have the main controller

83
00:03:05,599 --> 00:03:10,159
and i have ad connect server as well

84
00:03:10,159 --> 00:03:12,159
um and it's it's very very typical

85
00:03:12,159 --> 00:03:13,680
configuration of course you have

86
00:03:13,680 --> 00:03:15,440
multiple domain controllers it doesn't

87
00:03:15,440 --> 00:03:19,760
really matter so the idea here i have

88
00:03:19,760 --> 00:03:22,319
active directory on premises and i have

89
00:03:22,319 --> 00:03:25,040
ad connect that connects me to to azure

90
00:03:25,040 --> 00:03:26,319
id

91
00:03:26,319 --> 00:03:28,959
what may go wrong here

92
00:03:28,959 --> 00:03:32,640
um if i connect my on-premise cd to

93
00:03:32,640 --> 00:03:34,640
azure using ad connect

94
00:03:34,640 --> 00:03:35,519
so

95
00:03:35,519 --> 00:03:39,040
when i do it

96
00:03:39,200 --> 00:03:41,120
during configuration of ad connect i

97
00:03:41,120 --> 00:03:42,959
must

98
00:03:42,959 --> 00:03:44,879
choose

99
00:03:44,879 --> 00:03:46,799
i must create a diff what's called a

100
00:03:46,799 --> 00:03:48,799
deforest account

101
00:03:48,799 --> 00:03:51,200
a deforest account that's an account

102
00:03:51,200 --> 00:03:54,239
that will that will

103
00:03:54,239 --> 00:03:56,159
will will will get

104
00:03:56,159 --> 00:03:58,560
access to on-prem database

105
00:03:58,560 --> 00:04:02,720
um azure azure id to azure id to get

106
00:04:02,720 --> 00:04:05,439
um accounts from there to get users to

107
00:04:05,439 --> 00:04:08,000
get groups so this account will be used

108
00:04:08,000 --> 00:04:11,040
to access your on-premises id

109
00:04:11,040 --> 00:04:12,400
and so

110
00:04:12,400 --> 00:04:15,200
during the ad 80 connect configuration

111
00:04:15,200 --> 00:04:17,358
you must create this account or you may

112
00:04:17,358 --> 00:04:19,759
also pre-create but more secure option

113
00:04:19,759 --> 00:04:22,240
is more commanded is the first one

114
00:04:22,240 --> 00:04:25,680
create new id account so adconnect will

115
00:04:25,680 --> 00:04:29,280
create a new account for you

116
00:04:29,280 --> 00:04:31,280
let's take a look on this account

117
00:04:31,280 --> 00:04:33,840
if i go back to my dc

118
00:04:33,840 --> 00:04:36,800
and in folder called users i may find

119
00:04:36,800 --> 00:04:40,560
this account it's called msl underscore

120
00:04:40,560 --> 00:04:42,720
and something something something

121
00:04:42,720 --> 00:04:44,800
if i look at the account itself this

122
00:04:44,800 --> 00:04:46,880
account should be just a regular user

123
00:04:46,880 --> 00:04:48,560
and looks like there is no problem with

124
00:04:48,560 --> 00:04:50,880
this account just just a low proof

125
00:04:50,880 --> 00:04:52,080
account

126
00:04:52,080 --> 00:04:55,280
and yeah it is it is but

127
00:04:55,280 --> 00:04:58,639
but when you also configure ad connect

128
00:04:58,639 --> 00:05:01,199
you will you will also enable if you

129
00:05:01,199 --> 00:05:02,560
wish of course

130
00:05:02,560 --> 00:05:05,440
some options optional features and when

131
00:05:05,440 --> 00:05:07,600
you enable optional features

132
00:05:07,600 --> 00:05:10,800
that account will have more permissions

133
00:05:10,800 --> 00:05:12,240
let's take a look on some features that

134
00:05:12,240 --> 00:05:12,960
are

135
00:05:12,960 --> 00:05:14,880
you may see you you see some features on

136
00:05:14,880 --> 00:05:16,160
the slide that i will give a comment

137
00:05:16,160 --> 00:05:18,000
there is only about one feature

138
00:05:18,000 --> 00:05:19,840
and very important feature which is

139
00:05:19,840 --> 00:05:22,400
highly recommended is called password

140
00:05:22,400 --> 00:05:23,840
hash

141
00:05:23,840 --> 00:05:25,680
so this feature

142
00:05:25,680 --> 00:05:28,479
allows you to store password hashes of

143
00:05:28,479 --> 00:05:30,400
your on-premises users

144
00:05:30,400 --> 00:05:32,080
in azure id

145
00:05:32,080 --> 00:05:34,880
so after synchronization not only user

146
00:05:34,880 --> 00:05:36,639
itself will be created in the cloud but

147
00:05:36,639 --> 00:05:39,520
also user password

148
00:05:39,520 --> 00:05:41,840
hashed will be stored in the cloud as

149
00:05:41,840 --> 00:05:43,120
well

150
00:05:43,120 --> 00:05:44,800
and so it's very commanded disaster

151
00:05:44,800 --> 00:05:46,639
recovery option because if you lose

152
00:05:46,639 --> 00:05:48,639
connectivity between your on-premises in

153
00:05:48,639 --> 00:05:49,680
the cloud

154
00:05:49,680 --> 00:05:51,919
users will be able to log into the cloud

155
00:05:51,919 --> 00:05:55,600
with using stored hashes and stored hash

156
00:05:55,600 --> 00:05:56,720
in the cloud

157
00:05:56,720 --> 00:05:58,800
that's one of the one one of the

158
00:05:58,800 --> 00:06:01,520
benefits of this password here sync

159
00:06:01,520 --> 00:06:02,400
but

160
00:06:02,400 --> 00:06:04,880
when you enable password account and

161
00:06:04,880 --> 00:06:07,680
msrl account will have extra permissions

162
00:06:07,680 --> 00:06:09,440
account will have will have this permit

163
00:06:09,440 --> 00:06:13,199
to those two permissions

164
00:06:13,280 --> 00:06:15,600
so a replicate directory changes and the

165
00:06:15,600 --> 00:06:18,000
replicate directory changes all

166
00:06:18,000 --> 00:06:19,840
so what those permissions are all about

167
00:06:19,840 --> 00:06:22,560
those permissions will allow you to

168
00:06:22,560 --> 00:06:24,880
replicate active directory

169
00:06:24,880 --> 00:06:28,319
so you will act like you may act

170
00:06:28,319 --> 00:06:30,800
like a domain controller

171
00:06:30,800 --> 00:06:33,199
so let's take a look on this

172
00:06:33,199 --> 00:06:35,360
permissions if i go to properties of my

173
00:06:35,360 --> 00:06:36,479
domain

174
00:06:36,479 --> 00:06:40,639
and go to security find this msl and

175
00:06:40,639 --> 00:06:41,919
find

176
00:06:41,919 --> 00:06:43,280
yeah here we go

177
00:06:43,280 --> 00:06:46,560
so i have those permissions

178
00:06:46,560 --> 00:06:48,960
and you may say here all right so yeah

179
00:06:48,960 --> 00:06:50,560
that's that's quite a lot of permissions

180
00:06:50,560 --> 00:06:52,319
but this account was created

181
00:06:52,319 --> 00:06:54,560
automatically by microsoft and we don't

182
00:06:54,560 --> 00:06:56,960
know the password of this account so it

183
00:06:56,960 --> 00:06:59,520
should be secure

184
00:06:59,520 --> 00:07:00,400
um

185
00:07:00,400 --> 00:07:03,440
yeah it is it is secure but

186
00:07:03,440 --> 00:07:05,360
uh how do you think if we have an

187
00:07:05,360 --> 00:07:06,479
account

188
00:07:06,479 --> 00:07:10,400
and we don't know the password someone

189
00:07:10,400 --> 00:07:13,440
or something must know this password if

190
00:07:13,440 --> 00:07:15,120
if the something wants to use this

191
00:07:15,120 --> 00:07:19,199
account so ad connect ad connect itself

192
00:07:19,199 --> 00:07:20,639
must know

193
00:07:20,639 --> 00:07:23,120
this password let's take a look where

194
00:07:23,120 --> 00:07:25,680
this value is stored let me jump back to

195
00:07:25,680 --> 00:07:26,960
adconnect

196
00:07:26,960 --> 00:07:28,400
and open

197
00:07:28,400 --> 00:07:31,440
adconnect database which is adc indeed

198
00:07:31,440 --> 00:07:32,880
called adsync

199
00:07:32,880 --> 00:07:35,199
and here we have multiple tables i need

200
00:07:35,199 --> 00:07:36,560
table called

201
00:07:36,560 --> 00:07:40,319
mms management agent

202
00:07:42,880 --> 00:07:47,199
let me remove columns i don't need

203
00:07:47,680 --> 00:07:49,599
and those

204
00:07:49,599 --> 00:07:52,639
columns as well

205
00:07:53,039 --> 00:07:54,560
and let's run that

206
00:07:54,560 --> 00:07:56,479
so

207
00:07:56,479 --> 00:07:59,919
let me find this account

208
00:07:59,919 --> 00:08:01,680
and yeah it's here

209
00:08:01,680 --> 00:08:03,759
so as you can see here that's that's

210
00:08:03,759 --> 00:08:06,400
that's my account in sql database ad

211
00:08:06,400 --> 00:08:07,919
connect database and also there's a

212
00:08:07,919 --> 00:08:10,840
parameter called password which is says

213
00:08:10,840 --> 00:08:14,639
encrypted so yeah password is there but

214
00:08:14,639 --> 00:08:17,840
password is encrypted

215
00:08:19,440 --> 00:08:22,080
not that simple so there's no plain text

216
00:08:22,080 --> 00:08:23,360
password

217
00:08:23,360 --> 00:08:25,199
all right maybe maybe it's possible to

218
00:08:25,199 --> 00:08:26,639
decrypt password

219
00:08:26,639 --> 00:08:28,400
uh yeah it is

220
00:08:28,400 --> 00:08:30,080
if you are

221
00:08:30,080 --> 00:08:31,919
a local administrator

222
00:08:31,919 --> 00:08:34,719
on ad connect server and here's the

223
00:08:34,719 --> 00:08:36,080
problem

224
00:08:36,080 --> 00:08:38,719
so before before all of this

225
00:08:38,719 --> 00:08:40,559
it's it's a common configuration but

226
00:08:40,559 --> 00:08:41,679
where's the

227
00:08:41,679 --> 00:08:44,720
where's the problem the problem is is

228
00:08:44,720 --> 00:08:47,360
if your regular admin like a server

229
00:08:47,360 --> 00:08:49,600
admin middle level admin

230
00:08:49,600 --> 00:08:53,760
um tier 2 admin whatever it may be

231
00:08:53,760 --> 00:08:55,920
have

232
00:08:55,920 --> 00:08:58,560
local admin access to ad connect server

233
00:08:58,560 --> 00:09:00,800
let me show you what what may happen

234
00:09:00,800 --> 00:09:03,200
if you have configuration like this

235
00:09:03,200 --> 00:09:06,560
i'm going to open powershell

236
00:09:06,880 --> 00:09:09,360
and try to decrypt

237
00:09:09,360 --> 00:09:10,480
this

238
00:09:10,480 --> 00:09:11,200
uh

239
00:09:11,200 --> 00:09:13,680
this account you made it manually but it

240
00:09:13,680 --> 00:09:16,160
will be not very straightforward much

241
00:09:16,160 --> 00:09:17,760
better is to

242
00:09:17,760 --> 00:09:19,920
find tool called ad connect dump you may

243
00:09:19,920 --> 00:09:22,000
find freedom github by the way on the

244
00:09:22,000 --> 00:09:25,200
github you may also find the link how to

245
00:09:25,200 --> 00:09:27,519
decrypt account manually so the whole

246
00:09:27,519 --> 00:09:29,279
procedure but it will take so much time

247
00:09:29,279 --> 00:09:32,800
i'm not going to show you here

248
00:09:32,880 --> 00:09:34,880
but if you want to just have a result

249
00:09:34,880 --> 00:09:37,279
let me run this tool

250
00:09:37,279 --> 00:09:38,560
and look at this

251
00:09:38,560 --> 00:09:42,240
now i have now i have account

252
00:09:42,240 --> 00:09:44,640
and the password

253
00:09:44,640 --> 00:09:45,760
so

254
00:09:45,760 --> 00:09:48,240
using this value let me copy this

255
00:09:48,240 --> 00:09:49,279
password

256
00:09:49,279 --> 00:09:51,760
i'm gonna jump to another machine and

257
00:09:51,760 --> 00:09:53,920
let me open

258
00:09:53,920 --> 00:09:56,640
this one as different user

259
00:09:56,640 --> 00:09:58,320
type password here

260
00:09:58,320 --> 00:10:00,880
and user here and click ok

261
00:10:00,880 --> 00:10:03,600
so now what i'm trying to do i'm going

262
00:10:03,600 --> 00:10:06,399
to open command prompt

263
00:10:06,399 --> 00:10:10,720
on client machine as this ms oil user

264
00:10:10,720 --> 00:10:13,120
i also have a command prompt open let me

265
00:10:13,120 --> 00:10:16,079
show you who am i

266
00:10:16,320 --> 00:10:18,800
i'm a user jdo so just just like a

267
00:10:18,800 --> 00:10:19,839
regular

268
00:10:19,839 --> 00:10:20,959
user

269
00:10:20,959 --> 00:10:23,600
uh who is local admin on this machine

270
00:10:23,600 --> 00:10:24,720
but not

271
00:10:24,720 --> 00:10:27,279
uh not an administrator in domain

272
00:10:27,279 --> 00:10:30,399
let's see a second command prompt here i

273
00:10:30,399 --> 00:10:34,000
am a mysil user and so let's try to

274
00:10:34,000 --> 00:10:36,000
access domain controller from both

275
00:10:36,000 --> 00:10:37,839
command prompts let me try to do this

276
00:10:37,839 --> 00:10:39,040
jdog

277
00:10:39,040 --> 00:10:40,480
nope denied

278
00:10:40,480 --> 00:10:42,480
let's try to do it as

279
00:10:42,480 --> 00:10:43,440
um

280
00:10:43,440 --> 00:10:45,600
msoil denied

281
00:10:45,600 --> 00:10:47,120
so it's

282
00:10:47,120 --> 00:10:49,440
the accounts they don't have permissions

283
00:10:49,440 --> 00:10:52,640
to access directory but once again

284
00:10:52,640 --> 00:10:55,279
one one account which is a mesol has

285
00:10:55,279 --> 00:10:57,200
permissions to replicate active

286
00:10:57,200 --> 00:10:58,560
directory

287
00:10:58,560 --> 00:11:02,160
and so if i want to use this permission

288
00:11:02,160 --> 00:11:04,800
i will run tool called mimikats

289
00:11:04,800 --> 00:11:06,079
uh by the way

290
00:11:06,079 --> 00:11:07,920
mimikatz may be detected by any

291
00:11:07,920 --> 00:11:10,240
antivirus i have a different session how

292
00:11:10,240 --> 00:11:12,240
to evade

293
00:11:12,240 --> 00:11:14,640
antiviruses and so on so

294
00:11:14,640 --> 00:11:17,200
uh go ahead and find me on linkedin you

295
00:11:17,200 --> 00:11:19,760
will find a link there as well on my

296
00:11:19,760 --> 00:11:21,839
session about evasion

297
00:11:21,839 --> 00:11:23,760
and and here what i want to do i want to

298
00:11:23,760 --> 00:11:26,480
run simple command called lsa dump dc

299
00:11:26,480 --> 00:11:28,480
sync and that one i want to get

300
00:11:28,480 --> 00:11:31,360
information about user trainer

301
00:11:31,360 --> 00:11:32,560
so i will

302
00:11:32,560 --> 00:11:34,800
replicate information about the main

303
00:11:34,800 --> 00:11:38,240
administrator and now i have a hash

304
00:11:38,240 --> 00:11:41,040
of this user

305
00:11:41,360 --> 00:11:44,800
now i'm going to open mimikatz again

306
00:11:44,800 --> 00:11:47,120
uh also i want to say privilege

307
00:11:47,120 --> 00:11:50,120
previllage

308
00:11:50,160 --> 00:11:52,719
debug

309
00:11:52,959 --> 00:11:55,600
and run very well known command called

310
00:11:55,600 --> 00:11:57,600
pass the hash

311
00:11:57,600 --> 00:12:00,480
and let me copy this hash

312
00:12:00,480 --> 00:12:02,800
and place here

313
00:12:02,800 --> 00:12:04,800
and now if i try to accidentally

314
00:12:04,800 --> 00:12:07,200
controller

315
00:12:07,200 --> 00:12:08,399
look at this

316
00:12:08,399 --> 00:12:09,920
now i have permissions to access them in

317
00:12:09,920 --> 00:12:11,360
controller so it means i'm a domain

318
00:12:11,360 --> 00:12:12,560
admin

319
00:12:12,560 --> 00:12:14,880
and so now

320
00:12:14,880 --> 00:12:16,079
we have

321
00:12:16,079 --> 00:12:18,160
this environment compromised i'm at the

322
00:12:18,160 --> 00:12:19,440
main admin

323
00:12:19,440 --> 00:12:22,000
and i became the main admin based on my

324
00:12:22,000 --> 00:12:25,920
access to azure ad connect server

325
00:12:25,920 --> 00:12:29,200
so if you have administrators who are

326
00:12:29,200 --> 00:12:31,680
have access to this environment i mean

327
00:12:31,680 --> 00:12:34,639
ad connect be careful those guys they

328
00:12:34,639 --> 00:12:37,600
may become the main admins if they wish

329
00:12:37,600 --> 00:12:38,720
so

330
00:12:38,720 --> 00:12:41,519
uh next scenario will be

331
00:12:41,519 --> 00:12:44,320
my jenkins virtual machines

332
00:12:44,320 --> 00:12:45,279
and

333
00:12:45,279 --> 00:12:47,920
um i have a jenkins application

334
00:12:47,920 --> 00:12:49,519
jenkins application

335
00:12:49,519 --> 00:12:51,600
deployed on virtual machines

336
00:12:51,600 --> 00:12:54,959
and one note on windows second note on

337
00:12:54,959 --> 00:12:56,480
linux

338
00:12:56,480 --> 00:12:58,000
to be fair it doesn't really matter for

339
00:12:58,000 --> 00:12:59,920
jenkins or something else my goal here

340
00:12:59,920 --> 00:13:01,760
is not to show you jenkins the goal is

341
00:13:01,760 --> 00:13:04,320
to show you that i may compromise

342
00:13:04,320 --> 00:13:06,399
different operating systems maybe linux

343
00:13:06,399 --> 00:13:09,440
maybe windows doesn't really matter

344
00:13:09,440 --> 00:13:13,200
so let me jump back to demo

345
00:13:14,320 --> 00:13:17,200
and so let's continue from here

346
00:13:17,200 --> 00:13:19,040
now i have the main admin credentials

347
00:13:19,040 --> 00:13:22,160
and i want to start to explore azure and

348
00:13:22,160 --> 00:13:24,160
virtual machines in azure

349
00:13:24,160 --> 00:13:25,760
if i'm in the main admin what i can do

350
00:13:25,760 --> 00:13:28,000
with this with those permissions so

351
00:13:28,000 --> 00:13:29,600
literally i can

352
00:13:29,600 --> 00:13:32,000
connect to any workstation

353
00:13:32,000 --> 00:13:33,680
on this network

354
00:13:33,680 --> 00:13:36,000
let me show you what i can do if if i

355
00:13:36,000 --> 00:13:37,839
have permission like this

356
00:13:37,839 --> 00:13:40,079
if i can connect to any workstation

357
00:13:40,079 --> 00:13:41,600
i'm going to open

358
00:13:41,600 --> 00:13:44,560
workstation one workstation and another

359
00:13:44,560 --> 00:13:47,560
workstation

360
00:13:48,399 --> 00:13:49,839
and here i want to say

361
00:13:49,839 --> 00:13:52,959
a oh sorry

362
00:13:52,959 --> 00:13:55,360
uh a z

363
00:13:55,360 --> 00:13:58,240
uh account

364
00:13:58,240 --> 00:14:00,000
list

365
00:14:00,000 --> 00:14:04,880
and let's let's output as a table

366
00:14:04,880 --> 00:14:06,240
and i can see here the list of my

367
00:14:06,240 --> 00:14:08,000
subscriptions

368
00:14:08,000 --> 00:14:09,760
all right let's try this let's try to do

369
00:14:09,760 --> 00:14:10,800
the same

370
00:14:10,800 --> 00:14:14,240
on the second machine

371
00:14:14,240 --> 00:14:16,240
all right now i can see that it says

372
00:14:16,240 --> 00:14:19,040
please run a z login

373
00:14:19,040 --> 00:14:21,360
to access your account so it asked me

374
00:14:21,360 --> 00:14:23,680
for login here but didn't ask me for

375
00:14:23,680 --> 00:14:25,680
login here

376
00:14:25,680 --> 00:14:28,399
so probably it means that somewhere

377
00:14:28,399 --> 00:14:31,120
credentials to access the cloud are

378
00:14:31,120 --> 00:14:33,440
cached

379
00:14:33,440 --> 00:14:34,480
where they

380
00:14:34,480 --> 00:14:38,079
where are they cached if you go to user

381
00:14:38,079 --> 00:14:40,399
profile and you find

382
00:14:40,399 --> 00:14:44,000
a folder called dot azure

383
00:14:44,000 --> 00:14:46,800
and here are cash credentials

384
00:14:46,800 --> 00:14:49,120
so if i'm a domain admin what i can do i

385
00:14:49,120 --> 00:14:52,079
can connect to workstation of developer

386
00:14:52,079 --> 00:14:55,120
or system admin who has access to azure

387
00:14:55,120 --> 00:14:57,760
and steal this token let's try to take

388
00:14:57,760 --> 00:14:59,199
this token

389
00:14:59,199 --> 00:15:02,319
let's zip it real quick

390
00:15:05,600 --> 00:15:10,680
and copy this to second machine

391
00:15:15,040 --> 00:15:18,240
ah let me remove this

392
00:15:21,199 --> 00:15:26,160
and extract this dot azure

393
00:15:26,160 --> 00:15:28,320
alright so now let's try again fingers

394
00:15:28,320 --> 00:15:30,720
crossed

395
00:15:31,199 --> 00:15:32,959
and

396
00:15:32,959 --> 00:15:35,600
now i have list of subscription it means

397
00:15:35,600 --> 00:15:36,800
i'm

398
00:15:36,800 --> 00:15:39,680
i have the same level of access as the

399
00:15:39,680 --> 00:15:43,199
administrator on that machine

400
00:15:43,199 --> 00:15:45,120
where i get the

401
00:15:45,120 --> 00:15:47,040
the folder with token

402
00:15:47,040 --> 00:15:49,839
so with those permissions i can start to

403
00:15:49,839 --> 00:15:52,639
explore virtual machines let's say

404
00:15:52,639 --> 00:15:55,639
az

405
00:15:57,279 --> 00:15:59,600
list

406
00:16:01,519 --> 00:16:03,440
and

407
00:16:03,440 --> 00:16:04,800
i should see the list of virtual

408
00:16:04,800 --> 00:16:06,480
machines

409
00:16:06,480 --> 00:16:08,399
from this account yeah i can see the

410
00:16:08,399 --> 00:16:09,680
list of machines

411
00:16:09,680 --> 00:16:12,720
i'm interested in jenkins so i will i

412
00:16:12,720 --> 00:16:14,800
will i will test those two machines

413
00:16:14,800 --> 00:16:18,000
jenkins master and jenkins slave

414
00:16:18,000 --> 00:16:18,959
all right

415
00:16:18,959 --> 00:16:20,399
so

416
00:16:20,399 --> 00:16:23,360
what i can do with virtual machines

417
00:16:23,360 --> 00:16:25,120
now let me jump to portal and let me

418
00:16:25,120 --> 00:16:26,639
give you some demo about virtual

419
00:16:26,639 --> 00:16:30,000
machines so so you'll get more ideas uh

420
00:16:30,000 --> 00:16:32,560
what may be the problem

421
00:16:32,560 --> 00:16:34,079
uh if you look at the virtual machines

422
00:16:34,079 --> 00:16:35,440
you may find

423
00:16:35,440 --> 00:16:38,320
the option called run command

424
00:16:38,320 --> 00:16:40,399
let's click it click there and for

425
00:16:40,399 --> 00:16:42,800
windows machine oh sorry slip lens

426
00:16:42,800 --> 00:16:44,800
machine for links machine you may find

427
00:16:44,800 --> 00:16:47,519
the command to run shell script it means

428
00:16:47,519 --> 00:16:49,360
you will run

429
00:16:49,360 --> 00:16:51,199
bash script

430
00:16:51,199 --> 00:16:53,440
so if i click there

431
00:16:53,440 --> 00:16:56,000
i may run script here

432
00:16:56,000 --> 00:16:58,480
if i go to windows machine i'm gonna see

433
00:16:58,480 --> 00:17:01,360
the same but powershell script let's see

434
00:17:01,360 --> 00:17:04,360
that

435
00:17:05,119 --> 00:17:07,119
and here i can i can see powershell

436
00:17:07,119 --> 00:17:08,400
script

437
00:17:08,400 --> 00:17:09,919
what is interesting about this run

438
00:17:09,919 --> 00:17:11,760
command first of all they will be

439
00:17:11,760 --> 00:17:14,000
executed with the highest permissions

440
00:17:14,000 --> 00:17:16,079
with the highest privileges they will be

441
00:17:16,079 --> 00:17:17,439
executed on windows with system

442
00:17:17,439 --> 00:17:20,160
privileges and on linux with root

443
00:17:20,160 --> 00:17:22,240
privileges that's the first idea that

444
00:17:22,240 --> 00:17:25,760
you should keep in mind second idea

445
00:17:25,760 --> 00:17:28,160
to execute them you just need to be a

446
00:17:28,160 --> 00:17:29,919
reader

447
00:17:29,919 --> 00:17:32,080
on the machine level so let's let me

448
00:17:32,080 --> 00:17:35,120
show you this if i click reader

449
00:17:35,120 --> 00:17:39,120
and click and look at my permissions

450
00:17:44,000 --> 00:17:47,000
compute

451
00:17:47,600 --> 00:17:50,240
and let me find run command

452
00:17:50,240 --> 00:17:52,720
so look look at this so if i if i'm a

453
00:17:52,720 --> 00:17:54,480
reader i have permissions to run

454
00:17:54,480 --> 00:17:56,400
commands

455
00:17:56,400 --> 00:17:58,160
all right so that's that that's that

456
00:17:58,160 --> 00:18:00,160
that's that's my that's maybe a problem

457
00:18:00,160 --> 00:18:03,280
if some if this if that user had read

458
00:18:03,280 --> 00:18:04,480
permissions

459
00:18:04,480 --> 00:18:07,039
that user may run commands so if i want

460
00:18:07,039 --> 00:18:09,039
to connect the virtual machine and like

461
00:18:09,039 --> 00:18:10,880
let's say i want to get into virtual

462
00:18:10,880 --> 00:18:12,960
machine i must know

463
00:18:12,960 --> 00:18:16,320
normally a username and password but let

464
00:18:16,320 --> 00:18:18,400
me show you how with run commands i can

465
00:18:18,400 --> 00:18:19,520
bypass

466
00:18:19,520 --> 00:18:21,600
those requirements

467
00:18:21,600 --> 00:18:25,360
what i want to do i will run

468
00:18:25,360 --> 00:18:27,280
reverse shell commands

469
00:18:27,280 --> 00:18:30,000
and so those commands will allow me to

470
00:18:30,000 --> 00:18:31,919
get into virtual machine without the

471
00:18:31,919 --> 00:18:35,760
restrictions let's take a look on that

472
00:18:36,160 --> 00:18:38,799
so let me let's first try a linux

473
00:18:38,799 --> 00:18:40,840
reverse shell i'm gonna

474
00:18:40,840 --> 00:18:42,960
run um

475
00:18:42,960 --> 00:18:46,160
this the script from command prompt and

476
00:18:46,160 --> 00:18:48,320
i will run the command like this

477
00:18:48,320 --> 00:18:51,120
so that should give me a reverse shell

478
00:18:51,120 --> 00:18:53,760
with linux machine let's try that

479
00:18:53,760 --> 00:18:54,559
um

480
00:18:54,559 --> 00:18:56,559
what is what is important to know that

481
00:18:56,559 --> 00:19:00,160
run commands not super quick so we may

482
00:19:00,160 --> 00:19:02,640
need to wait

483
00:19:02,640 --> 00:19:05,039
some number of seconds i'm not really

484
00:19:05,039 --> 00:19:08,000
sure yeah so let's wait

485
00:19:08,000 --> 00:19:10,880
let's wait

486
00:19:10,880 --> 00:19:12,160
um

487
00:19:12,160 --> 00:19:13,919
30 seconds and

488
00:19:13,919 --> 00:19:16,240
hopefully i will get a shell

489
00:19:16,240 --> 00:19:19,440
in parallel in parallel let me run let

490
00:19:19,440 --> 00:19:22,559
me try to run that for window on windows

491
00:19:22,559 --> 00:19:24,000
and windows will be slightly different

492
00:19:24,000 --> 00:19:25,280
in my case

493
00:19:25,280 --> 00:19:27,600
um i will download

494
00:19:27,600 --> 00:19:31,120
my my executable with reverse shell

495
00:19:31,120 --> 00:19:35,440
and just run it let's try to do it here

496
00:19:35,440 --> 00:19:37,280
all right let's see i already have a

497
00:19:37,280 --> 00:19:39,360
shell on linux let's see

498
00:19:39,360 --> 00:19:42,400
if i type id and root here and so i can

499
00:19:42,400 --> 00:19:46,960
do whatever i want on linux machine

500
00:19:48,400 --> 00:19:49,360
so

501
00:19:49,360 --> 00:19:50,880
i'm root here

502
00:19:50,880 --> 00:19:53,840
and i'm a god on this machine let's take

503
00:19:53,840 --> 00:19:56,080
a look on windows and yeah we have the

504
00:19:56,080 --> 00:19:59,120
same for windows

505
00:19:59,200 --> 00:20:02,640
and i'm i work as the local system

506
00:20:02,640 --> 00:20:04,320
and to just finish the demo about

507
00:20:04,320 --> 00:20:08,159
jenkins um maybe no maybe not maybe not

508
00:20:08,159 --> 00:20:10,240
there is there's an airlock of jenkins

509
00:20:10,240 --> 00:20:12,880
and you may find the initial passport

510
00:20:12,880 --> 00:20:16,400
um there in jenkins so if i copy this

511
00:20:16,400 --> 00:20:21,640
copy this password and i can find

512
00:20:23,120 --> 00:20:25,200
um

513
00:20:25,200 --> 00:20:26,159
all right

514
00:20:26,159 --> 00:20:29,120
so let me just copy this first

515
00:20:29,120 --> 00:20:30,000
um

516
00:20:30,000 --> 00:20:31,200
login to

517
00:20:31,200 --> 00:20:34,919
try to log into jenkins

518
00:20:35,039 --> 00:20:38,480
let's take this password again

519
00:20:43,760 --> 00:20:46,159
copy this

520
00:20:46,159 --> 00:20:48,080
paste here of course it may not it may

521
00:20:48,080 --> 00:20:50,799
not work to be fair i don't really care

522
00:20:50,799 --> 00:20:53,520
if this is working or not my goal is to

523
00:20:53,520 --> 00:20:55,280
show you how can i get into virtual

524
00:20:55,280 --> 00:20:57,280
machines not now how can i get into the

525
00:20:57,280 --> 00:20:58,559
into jenkins

526
00:20:58,559 --> 00:21:00,559
um all right so

527
00:21:00,559 --> 00:21:02,400
but i hope it was clear

528
00:21:02,400 --> 00:21:04,240
uh how virtual machines may be

529
00:21:04,240 --> 00:21:06,720
compromised because if i have read

530
00:21:06,720 --> 00:21:09,520
access on virtual machine level

531
00:21:09,520 --> 00:21:10,799
what i can do

532
00:21:10,799 --> 00:21:12,559
i can

533
00:21:12,559 --> 00:21:14,960
just get into

534
00:21:14,960 --> 00:21:17,120
so that was the second scenario where we

535
00:21:17,120 --> 00:21:19,520
talk about legacy application

536
00:21:19,520 --> 00:21:20,640
really jenkins there's not really a

537
00:21:20,640 --> 00:21:23,120
legacy but this application is based on

538
00:21:23,120 --> 00:21:24,559
virtual machines

539
00:21:24,559 --> 00:21:26,559
so finally let's take a look at the last

540
00:21:26,559 --> 00:21:30,960
scenario and here we're going to cover

541
00:21:30,960 --> 00:21:32,880
um application which is which should be

542
00:21:32,880 --> 00:21:34,799
a bit more interesting in this

543
00:21:34,799 --> 00:21:35,919
application

544
00:21:35,919 --> 00:21:37,760
we will have

545
00:21:37,760 --> 00:21:39,520
application

546
00:21:39,520 --> 00:21:42,159
web application

547
00:21:42,159 --> 00:21:44,559
with a sql database backend

548
00:21:44,559 --> 00:21:47,840
um also the the credentials to access

549
00:21:47,840 --> 00:21:50,799
backend will not be stored um locally on

550
00:21:50,799 --> 00:21:52,559
the web application it will be stored in

551
00:21:52,559 --> 00:21:54,799
the key vault

552
00:21:54,799 --> 00:21:58,080
and the credentials they will be rotated

553
00:21:58,080 --> 00:21:59,440
periodically

554
00:21:59,440 --> 00:22:01,360
with azure functions and also

555
00:22:01,360 --> 00:22:02,880
application will be protected with

556
00:22:02,880 --> 00:22:05,120
application gateway in front

557
00:22:05,120 --> 00:22:07,440
with the feature enabled

558
00:22:07,440 --> 00:22:08,480
so

559
00:22:08,480 --> 00:22:11,760
it looks looks like this application is

560
00:22:11,760 --> 00:22:13,440
quite secure

561
00:22:13,440 --> 00:22:16,159
quite secure

562
00:22:16,159 --> 00:22:20,799
but let's try that first let's try that

563
00:22:20,799 --> 00:22:22,480
so i'm going to jump back to demo as

564
00:22:22,480 --> 00:22:24,799
usual

565
00:22:25,039 --> 00:22:27,600
um so we compromised let me close all of

566
00:22:27,600 --> 00:22:28,559
this

567
00:22:28,559 --> 00:22:30,320
so we compromised two environments

568
00:22:30,320 --> 00:22:32,000
compromised environments now let's take

569
00:22:32,000 --> 00:22:32,960
a look

570
00:22:32,960 --> 00:22:34,080
um

571
00:22:34,080 --> 00:22:38,320
how can they try to get into this

572
00:22:38,320 --> 00:22:39,520
um

573
00:22:39,520 --> 00:22:42,480
this application

574
00:22:42,640 --> 00:22:44,880
um

575
00:22:45,600 --> 00:22:47,600
let me show you one more slide to

576
00:22:47,600 --> 00:22:50,240
to to just um

577
00:22:50,240 --> 00:22:52,960
give an idea what may be in our case an

578
00:22:52,960 --> 00:22:56,640
entry point so my goal my initial my my

579
00:22:56,640 --> 00:22:59,919
goal is to get access to database

580
00:22:59,919 --> 00:23:01,679
because all of the the most interesting

581
00:23:01,679 --> 00:23:04,159
things will be there

582
00:23:04,159 --> 00:23:06,559
but easier as you remember credentials

583
00:23:06,559 --> 00:23:09,520
are to access database will be stored

584
00:23:09,520 --> 00:23:12,159
in key vault

585
00:23:12,159 --> 00:23:14,720
um let's first test if i have access to

586
00:23:14,720 --> 00:23:16,559
key vault or not i'm going to go to

587
00:23:16,559 --> 00:23:17,919
keyboard maybe this user that was

588
00:23:17,919 --> 00:23:19,840
compromised already have access to key

589
00:23:19,840 --> 00:23:21,760
vault

590
00:23:21,760 --> 00:23:26,240
let's see that if i go to secrets

591
00:23:26,480 --> 00:23:29,039
uh no there is no

592
00:23:29,039 --> 00:23:31,360
permissions to access key vault let me

593
00:23:31,360 --> 00:23:33,360
quickly give permissions to myself to

594
00:23:33,360 --> 00:23:34,960
just show you that

595
00:23:34,960 --> 00:23:37,520
um

596
00:23:37,520 --> 00:23:41,918
those something something exists there

597
00:23:43,440 --> 00:23:45,600
i'm gonna just give permission to list

598
00:23:45,600 --> 00:23:47,440
click add

599
00:23:47,440 --> 00:23:49,760
here and go back to secrets

600
00:23:49,760 --> 00:23:51,600
refresh

601
00:23:51,600 --> 00:23:53,440
no

602
00:23:53,440 --> 00:23:57,760
oh damn i didn't save it sorry

603
00:24:02,880 --> 00:24:05,520
let's try again click add

604
00:24:05,520 --> 00:24:08,559
and let's click save

605
00:24:08,559 --> 00:24:10,960
and now if i go to secrets i should yeah

606
00:24:10,960 --> 00:24:15,760
i have password here pass and username

607
00:24:15,760 --> 00:24:18,400
so let me remove this permission click

608
00:24:18,400 --> 00:24:20,960
save again

609
00:24:21,600 --> 00:24:24,000
and now let's try to

610
00:24:24,000 --> 00:24:26,960
somehow get access to

611
00:24:26,960 --> 00:24:28,960
to those secrets

612
00:24:28,960 --> 00:24:32,320
and for me entry point will be key

613
00:24:32,320 --> 00:24:34,480
rotation function because it's very

614
00:24:34,480 --> 00:24:37,360
commanded to have key rotation uh keys

615
00:24:37,360 --> 00:24:40,159
or secrets in my case rotation

616
00:24:40,159 --> 00:24:42,559
and on microsoft website you may even

617
00:24:42,559 --> 00:24:46,400
find the function that will rotate

618
00:24:46,400 --> 00:24:48,640
the secret in the keyboard and on the

619
00:24:48,640 --> 00:24:51,360
target application like sql database on

620
00:24:51,360 --> 00:24:53,440
our target

621
00:24:53,440 --> 00:24:55,279
so here's a slide

622
00:24:55,279 --> 00:24:56,799
with my

623
00:24:56,799 --> 00:24:58,720
with my function so i have function and

624
00:24:58,720 --> 00:25:00,400
this function will

625
00:25:00,400 --> 00:25:03,279
like change password on in sql database

626
00:25:03,279 --> 00:25:06,240
and the keyword at the same time

627
00:25:06,240 --> 00:25:09,039
and what the typical problem that i find

628
00:25:09,039 --> 00:25:11,200
periodically

629
00:25:11,200 --> 00:25:13,440
in there in the real world

630
00:25:13,440 --> 00:25:16,000
when a function has different

631
00:25:16,000 --> 00:25:18,559
configuration compared to keyword so key

632
00:25:18,559 --> 00:25:21,600
vault may be very restrictive

633
00:25:21,600 --> 00:25:23,919
but the same time function

634
00:25:23,919 --> 00:25:26,400
will have also like either permissions

635
00:25:26,400 --> 00:25:28,799
inherited from subscription

636
00:25:28,799 --> 00:25:31,279
and so function will have a bit more

637
00:25:31,279 --> 00:25:33,760
permissions so so users will have a bit

638
00:25:33,760 --> 00:25:35,840
more permissions on that function

639
00:25:35,840 --> 00:25:37,919
compared to keyword let me show you what

640
00:25:37,919 --> 00:25:42,240
i can do if i if i have a case like this

641
00:25:42,240 --> 00:25:43,919
so i'm going to go to

642
00:25:43,919 --> 00:25:45,440
portal

643
00:25:45,440 --> 00:25:48,159
and find functions

644
00:25:48,159 --> 00:25:50,320
function applications and here i have

645
00:25:50,320 --> 00:25:52,799
one function

646
00:25:52,799 --> 00:25:54,640
so let's take a look at what what do we

647
00:25:54,640 --> 00:25:56,480
have here

648
00:25:56,480 --> 00:25:58,480
in under one function application i have

649
00:25:58,480 --> 00:25:59,760
two functions

650
00:25:59,760 --> 00:26:02,320
one is triggered by event grid second

651
00:26:02,320 --> 00:26:04,240
one is triggered by http

652
00:26:04,240 --> 00:26:06,159
this one is will be more interesting for

653
00:26:06,159 --> 00:26:08,000
me because i can trigger that manually

654
00:26:08,000 --> 00:26:11,840
so let me show you the code

655
00:26:15,840 --> 00:26:17,120
come on

656
00:26:17,120 --> 00:26:18,480
and so

657
00:26:18,480 --> 00:26:20,400
by default when i deploy the function

658
00:26:20,400 --> 00:26:22,799
from

659
00:26:23,039 --> 00:26:26,799
from microsoft github from from github

660
00:26:26,799 --> 00:26:29,679
it will show me the code like this

661
00:26:29,679 --> 00:26:32,720
so this code is is the legit code to

662
00:26:32,720 --> 00:26:35,039
rotate secret

663
00:26:35,039 --> 00:26:35,919
but

664
00:26:35,919 --> 00:26:38,000
what where maybe the problem the problem

665
00:26:38,000 --> 00:26:39,679
is

666
00:26:39,679 --> 00:26:41,679
by default function

667
00:26:41,679 --> 00:26:43,840
is ac may be accessed

668
00:26:43,840 --> 00:26:45,520
via ftp so if you look at the

669
00:26:45,520 --> 00:26:48,720
configuration of the function

670
00:26:51,200 --> 00:26:53,679
you may find that in general settings

671
00:26:53,679 --> 00:26:57,120
ftp is enabled by default

672
00:26:57,120 --> 00:27:01,600
most in most cases you don't use that

673
00:27:01,679 --> 00:27:04,240
but it's enabled by default

674
00:27:04,240 --> 00:27:07,919
and so you go to the deployment center

675
00:27:07,919 --> 00:27:11,919
um you may find ftp credentials here

676
00:27:11,919 --> 00:27:14,559
and so here's the ftp credentials so now

677
00:27:14,559 --> 00:27:16,799
let me try to get those credentials but

678
00:27:16,799 --> 00:27:18,799
of course as usual from command prompt

679
00:27:18,799 --> 00:27:21,679
um so let me open command prompt here

680
00:27:21,679 --> 00:27:24,799
and let's try to get

681
00:27:24,960 --> 00:27:27,200
first of all a url

682
00:27:27,200 --> 00:27:30,799
for ftp url to connect the function

683
00:27:30,799 --> 00:27:33,840
so here's the ftp url let me copy this

684
00:27:33,840 --> 00:27:34,799
and

685
00:27:34,799 --> 00:27:37,279
paste to filezilla and then i want to

686
00:27:37,279 --> 00:27:40,080
get credentials of this

687
00:27:40,080 --> 00:27:41,200
function

688
00:27:41,200 --> 00:27:43,520
of this function application and here's

689
00:27:43,520 --> 00:27:45,279
the username

690
00:27:45,279 --> 00:27:47,520
which is the username

691
00:27:47,520 --> 00:27:48,880
paste here

692
00:27:48,880 --> 00:27:51,840
and here is the password let me copy

693
00:27:51,840 --> 00:27:54,080
this

694
00:27:54,080 --> 00:27:56,480
here's the password

695
00:27:56,480 --> 00:27:58,720
and now i have

696
00:27:58,720 --> 00:28:00,720
permissions to log in there and i can

697
00:28:00,720 --> 00:28:02,960
see here the structure which is my two

698
00:28:02,960 --> 00:28:04,080
functions

699
00:28:04,080 --> 00:28:06,240
let me go to to the http function and

700
00:28:06,240 --> 00:28:07,840
here i can and here i can see the

701
00:28:07,840 --> 00:28:10,399
structure of the function what i can do

702
00:28:10,399 --> 00:28:15,120
i can upload i can upload my own code

703
00:28:15,120 --> 00:28:18,320
and so this code with the name called

704
00:28:18,320 --> 00:28:20,559
around.ps1 in this case it's the partial

705
00:28:20,559 --> 00:28:22,399
function so

706
00:28:22,399 --> 00:28:24,919
i can upload my

707
00:28:24,919 --> 00:28:26,960
around.ps1 code

708
00:28:26,960 --> 00:28:29,039
and this code will be executed when

709
00:28:29,039 --> 00:28:30,640
function is triggered

710
00:28:30,640 --> 00:28:32,799
and so this function because the

711
00:28:32,799 --> 00:28:34,640
function has permissions to access

712
00:28:34,640 --> 00:28:35,679
keyboard

713
00:28:35,679 --> 00:28:37,520
i will access keyword and i will get

714
00:28:37,520 --> 00:28:39,919
information from keyboard on behalf

715
00:28:39,919 --> 00:28:41,520
of function

716
00:28:41,520 --> 00:28:44,399
and my code will just get information i

717
00:28:44,399 --> 00:28:47,120
need from keyboard let's try that i'm

718
00:28:47,120 --> 00:28:49,440
going to just open powershell

719
00:28:49,440 --> 00:28:53,279
and run the command like this

720
00:28:53,440 --> 00:28:56,320
and so let's let's try to get

721
00:28:56,320 --> 00:29:00,640
credentials from from key vault

722
00:29:00,640 --> 00:29:02,799
fingers crossed i will get it also by

723
00:29:02,799 --> 00:29:05,440
the way i can go to function itself and

724
00:29:05,440 --> 00:29:06,960
and just

725
00:29:06,960 --> 00:29:08,399
take a look

726
00:29:08,399 --> 00:29:11,120
when it was when it was executed if i

727
00:29:11,120 --> 00:29:13,840
click monitor

728
00:29:23,279 --> 00:29:25,440
nothing here maybe already yeah it's

729
00:29:25,440 --> 00:29:28,320
ready give me give me information

730
00:29:28,320 --> 00:29:31,360
so um it's finished

731
00:29:31,360 --> 00:29:33,679
now i can see the username is web app

732
00:29:33,679 --> 00:29:36,240
and the password is password

733
00:29:36,240 --> 00:29:39,039
and those credentials are will be used

734
00:29:39,039 --> 00:29:41,039
to connect to

735
00:29:41,039 --> 00:29:43,360
sql server so let's try to connect the

736
00:29:43,360 --> 00:29:46,240
sql server now

737
00:29:47,120 --> 00:29:48,399
first let me

738
00:29:48,399 --> 00:29:53,039
take this url and type my password

739
00:29:53,039 --> 00:29:56,559
and now i can see i always connected

740
00:29:56,559 --> 00:30:00,880
um and i can see my database with tables

741
00:30:00,880 --> 00:30:01,600
and

742
00:30:01,600 --> 00:30:05,320
the content there

743
00:30:08,000 --> 00:30:11,039
uh and there's there's only one

744
00:30:11,039 --> 00:30:12,480
record there

745
00:30:12,480 --> 00:30:14,399
let me try to do the same from the

746
00:30:14,399 --> 00:30:15,840
different workstation

747
00:30:15,840 --> 00:30:18,159
just connect copy this

748
00:30:18,159 --> 00:30:21,640
from different workstation

749
00:30:27,360 --> 00:30:29,360
and now it says hey you can't do it

750
00:30:29,360 --> 00:30:32,240
because firewall does not allow you to

751
00:30:32,240 --> 00:30:36,000
connect to this server

752
00:30:36,000 --> 00:30:38,559
interesting uh let's take a look

753
00:30:38,559 --> 00:30:40,559
how this fire will look like now let's

754
00:30:40,559 --> 00:30:42,960
go to database

755
00:30:42,960 --> 00:30:44,799
and open this database

756
00:30:44,799 --> 00:30:47,120
so every sql database in the cloud has

757
00:30:47,120 --> 00:30:48,159
this

758
00:30:48,159 --> 00:30:50,880
sql server has the firewall

759
00:30:50,880 --> 00:30:53,760
database as well by the way so if i if i

760
00:30:53,760 --> 00:30:56,080
if i click firewall i can find here very

761
00:30:56,080 --> 00:30:58,320
interesting configuration which is very

762
00:30:58,320 --> 00:31:00,399
very typical

763
00:31:00,399 --> 00:31:04,080
uh this firewall this firewall has this

764
00:31:04,080 --> 00:31:06,399
option enabled it says allow azure

765
00:31:06,399 --> 00:31:08,480
services and the resources to access

766
00:31:08,480 --> 00:31:10,720
this server

767
00:31:10,720 --> 00:31:12,399
what does it mean

768
00:31:12,399 --> 00:31:14,960
many people think that it means that

769
00:31:14,960 --> 00:31:17,760
their azure virtual machines their azure

770
00:31:17,760 --> 00:31:19,600
services may access

771
00:31:19,600 --> 00:31:22,080
this database but in fact it is not

772
00:31:22,080 --> 00:31:23,679
really true

773
00:31:23,679 --> 00:31:27,039
this option means that any

774
00:31:27,039 --> 00:31:31,360
any once again any azure ip address will

775
00:31:31,360 --> 00:31:35,039
be able to access this sql server

776
00:31:35,039 --> 00:31:36,399
so

777
00:31:36,399 --> 00:31:37,279
a

778
00:31:37,279 --> 00:31:38,559
from any

779
00:31:38,559 --> 00:31:41,519
from any customer subscription from any

780
00:31:41,519 --> 00:31:44,399
content from any country in the world

781
00:31:44,399 --> 00:31:46,559
you will be able to access

782
00:31:46,559 --> 00:31:47,360
um

783
00:31:47,360 --> 00:31:49,120
your sql server

784
00:31:49,120 --> 00:31:51,200
firewall will not filter that at least

785
00:31:51,200 --> 00:31:53,440
if you have this option enabled

786
00:31:53,440 --> 00:31:56,720
so quite often uh the the

787
00:31:56,720 --> 00:31:58,799
the the it professionals in company

788
00:31:58,799 --> 00:32:00,240
security professionals they don't really

789
00:32:00,240 --> 00:32:01,360
understand

790
00:32:01,360 --> 00:32:03,840
the impact of this option

791
00:32:03,840 --> 00:32:07,360
so if i have this option enabled then

792
00:32:07,360 --> 00:32:10,080
any virtual machine in azure from with

793
00:32:10,080 --> 00:32:12,320
azure ap address may have access to my

794
00:32:12,320 --> 00:32:16,158
sql let me disable this

795
00:32:18,559 --> 00:32:21,120
and let's try to innate

796
00:32:21,120 --> 00:32:23,760
in allow only

797
00:32:23,760 --> 00:32:27,120
um only private access so there is no

798
00:32:27,120 --> 00:32:29,279
public access at all

799
00:32:29,279 --> 00:32:30,720
now

800
00:32:30,720 --> 00:32:33,039
now

801
00:32:33,760 --> 00:32:34,559
um

802
00:32:34,559 --> 00:32:37,039
my sequel is probably better

803
00:32:37,039 --> 00:32:38,880
now

804
00:32:38,880 --> 00:32:41,840
i have credentials but axe aloud only

805
00:32:41,840 --> 00:32:45,360
from internal network so i cannot access

806
00:32:45,360 --> 00:32:48,959
from from anywhere

807
00:32:49,120 --> 00:32:52,320
is it possible to get into database

808
00:32:52,320 --> 00:32:53,840
uh yeah

809
00:32:53,840 --> 00:32:58,080
if we compromise the application itself

810
00:32:58,080 --> 00:33:00,559
and so from application we can get

811
00:33:00,559 --> 00:33:02,799
access to sql database

812
00:33:02,799 --> 00:33:05,519
let's try to do to do it let me go back

813
00:33:05,519 --> 00:33:07,039
to

814
00:33:07,039 --> 00:33:08,080
my

815
00:33:08,080 --> 00:33:11,840
portal and i'm going to open application

816
00:33:11,840 --> 00:33:13,840
um

817
00:33:13,840 --> 00:33:15,840
so if i just

818
00:33:15,840 --> 00:33:18,159
go to application configuration you may

819
00:33:18,159 --> 00:33:19,840
find here network and if i click

820
00:33:19,840 --> 00:33:22,159
configure networking it says hey you

821
00:33:22,159 --> 00:33:25,279
must have a standard tier if you want to

822
00:33:25,279 --> 00:33:27,200
work with networking so let me upgrade

823
00:33:27,200 --> 00:33:30,559
my application to s1

824
00:33:37,039 --> 00:33:38,399
and so now

825
00:33:38,399 --> 00:33:40,559
i can connect my application to network

826
00:33:40,559 --> 00:33:42,080
let me do it real quick so i'm going to

827
00:33:42,080 --> 00:33:44,320
say

828
00:33:44,799 --> 00:33:46,320
add v-net

829
00:33:46,320 --> 00:33:49,440
and i want to connect my application to

830
00:33:49,440 --> 00:33:51,679
virtual network

831
00:33:51,679 --> 00:33:52,880
click ok

832
00:33:52,880 --> 00:33:55,360
and so that will take some time before

833
00:33:55,360 --> 00:33:59,360
this application will be able to connect

834
00:33:59,600 --> 00:34:02,240
so as you can see here it's already con

835
00:34:02,240 --> 00:34:03,919
it's just connected but

836
00:34:03,919 --> 00:34:04,840
in

837
00:34:04,840 --> 00:34:07,600
reality what i can do i can

838
00:34:07,600 --> 00:34:09,679
really quickly restart this application

839
00:34:09,679 --> 00:34:12,480
to speed things up

840
00:34:12,480 --> 00:34:16,800
so now if i compromise this application

841
00:34:16,800 --> 00:34:21,839
uh i will be able i should be able to

842
00:34:22,239 --> 00:34:23,918
get into database

843
00:34:23,918 --> 00:34:25,359
uh the quite common question wait a

844
00:34:25,359 --> 00:34:27,199
second but how to compromise application

845
00:34:27,199 --> 00:34:29,280
especially if you look at them if you'll

846
00:34:29,280 --> 00:34:31,520
hear there's a vaf

847
00:34:31,520 --> 00:34:33,918
application firewall will not allow me

848
00:34:33,918 --> 00:34:36,960
to just simply get into application

849
00:34:36,960 --> 00:34:40,079
uh yes but i just want to remind you i

850
00:34:40,079 --> 00:34:42,159
just want to really remind you that we

851
00:34:42,159 --> 00:34:44,480
have for web application the same

852
00:34:44,480 --> 00:34:48,719
default configuration ftp is allowed

853
00:34:48,719 --> 00:34:51,760
if i go click configuration

854
00:34:51,760 --> 00:34:53,918
and go to general settings i may find

855
00:34:53,918 --> 00:34:58,160
here ftp is allowed by default

856
00:34:58,160 --> 00:35:00,560
so quite often companies they do not

857
00:35:00,560 --> 00:35:03,599
disable this ftp and in the same manner

858
00:35:03,599 --> 00:35:06,880
i can get into

859
00:35:06,880 --> 00:35:09,119
this application as before

860
00:35:09,119 --> 00:35:12,640
let me try to do it so let me close this

861
00:35:12,640 --> 00:35:15,118
and this

862
00:35:15,200 --> 00:35:16,480
um

863
00:35:16,480 --> 00:35:17,760
now if i

864
00:35:17,760 --> 00:35:19,839
just

865
00:35:19,839 --> 00:35:22,320
try the same

866
00:35:22,320 --> 00:35:23,520
let me find

867
00:35:23,520 --> 00:35:28,440
a ftp url of the application

868
00:35:31,760 --> 00:35:34,560
copy this

869
00:35:37,440 --> 00:35:40,560
and credentials as well

870
00:35:42,720 --> 00:35:47,839
and so let me type credentials as well

871
00:35:53,280 --> 00:35:55,200
so as you can see here this application

872
00:35:55,200 --> 00:35:58,480
is nothing more than just a php page and

873
00:35:58,480 --> 00:35:59,599
let's let's first explore this

874
00:35:59,599 --> 00:36:01,520
application that

875
00:36:01,520 --> 00:36:02,960
we'll just check the application is

876
00:36:02,960 --> 00:36:04,000
working

877
00:36:04,000 --> 00:36:06,880
let me open the application itself let's

878
00:36:06,880 --> 00:36:09,119
click here

879
00:36:09,119 --> 00:36:10,960
i can see the application is here an

880
00:36:10,960 --> 00:36:13,359
application is working so let me just

881
00:36:13,359 --> 00:36:15,280
take a look if i say

882
00:36:15,280 --> 00:36:20,480
i'm a user let's call myself michael

883
00:36:20,480 --> 00:36:23,040
and

884
00:36:24,160 --> 00:36:27,680
let's say my email is ampsmith whatever

885
00:36:27,680 --> 00:36:28,920
it may be

886
00:36:28,920 --> 00:36:30,560
whatever.com

887
00:36:30,560 --> 00:36:32,400
and let's say submit

888
00:36:32,400 --> 00:36:34,079
this this is working so it's working

889
00:36:34,079 --> 00:36:36,240
with database application is working

890
00:36:36,240 --> 00:36:39,119
now let me jump back to

891
00:36:39,119 --> 00:36:40,560
my filezilla

892
00:36:40,560 --> 00:36:42,240
and now what i can do if i if i know

893
00:36:42,240 --> 00:36:44,800
that this application is php what i can

894
00:36:44,800 --> 00:36:48,640
do i can upload my shell

895
00:36:48,640 --> 00:36:51,760
and you know that php and sp as well by

896
00:36:51,760 --> 00:36:52,800
the way

897
00:36:52,800 --> 00:36:55,280
they they are executed on the server

898
00:36:55,280 --> 00:36:58,480
side so the php will be executed on the

899
00:36:58,480 --> 00:37:01,200
server side not on the client side so if

900
00:37:01,200 --> 00:37:04,880
i can upload my my own php code i can

901
00:37:04,880 --> 00:37:07,119
execute something on server let me just

902
00:37:07,119 --> 00:37:09,680
run my shell and look at this

903
00:37:09,680 --> 00:37:13,520
so now i have access to

904
00:37:13,920 --> 00:37:16,720
this workstation or the server through

905
00:37:16,720 --> 00:37:18,079
web shell

906
00:37:18,079 --> 00:37:20,400
web shell not super interactive so let

907
00:37:20,400 --> 00:37:22,720
me

908
00:37:22,720 --> 00:37:26,399
establish establish the better shell

909
00:37:29,839 --> 00:37:32,400
so on my web shell i want to

910
00:37:32,400 --> 00:37:33,680
to

911
00:37:33,680 --> 00:37:36,480
fix the shell i want to make shell

912
00:37:36,480 --> 00:37:37,839
better

913
00:37:37,839 --> 00:37:39,200
and so

914
00:37:39,200 --> 00:37:40,960
now i have a shell

915
00:37:40,960 --> 00:37:42,800
all right so what i can what what i

916
00:37:42,800 --> 00:37:44,800
found here that

917
00:37:44,800 --> 00:37:47,359
my username is just a regular user not

918
00:37:47,359 --> 00:37:50,560
the web server web server user

919
00:37:50,560 --> 00:37:52,880
usually usually low pre low privilege

920
00:37:52,880 --> 00:37:54,560
user so i will not be able to do

921
00:37:54,560 --> 00:37:56,800
whatever i want on this server

922
00:37:56,800 --> 00:38:00,320
my goal is to connect to sql database

923
00:38:00,320 --> 00:38:03,760
but the problem is that a regular server

924
00:38:03,760 --> 00:38:06,400
doesn't have tools to connect to sql

925
00:38:06,400 --> 00:38:08,800
server

926
00:38:08,880 --> 00:38:11,760
um i need some sort of management studio

927
00:38:11,760 --> 00:38:13,839
for linux as linux of course not visual

928
00:38:13,839 --> 00:38:15,520
studio it's not management studio it

929
00:38:15,520 --> 00:38:18,960
will be like a sql cli but to install

930
00:38:18,960 --> 00:38:21,760
that i must be an admin i have i must

931
00:38:21,760 --> 00:38:23,280
have sudo permissions or root

932
00:38:23,280 --> 00:38:25,839
permissions i don't have it

933
00:38:25,839 --> 00:38:28,880
so what i can do here i can use some

934
00:38:28,880 --> 00:38:30,960
third-party tools and the tool that you

935
00:38:30,960 --> 00:38:33,760
may try called usql

936
00:38:33,760 --> 00:38:35,839
this tool will run without insta will

937
00:38:35,839 --> 00:38:37,760
work without installation

938
00:38:37,760 --> 00:38:40,560
and so using usql i will try to connect

939
00:38:40,560 --> 00:38:44,320
to sql database i'm going to say

940
00:38:44,320 --> 00:38:46,480
connect using the sql and it looks like

941
00:38:46,480 --> 00:38:48,640
i i was connected let's try to list

942
00:38:48,640 --> 00:38:51,118
tables

943
00:38:53,040 --> 00:38:55,440
and look at this i can see two tables

944
00:38:55,440 --> 00:38:56,720
there

945
00:38:56,720 --> 00:39:01,839
um so let's try to list the content

946
00:39:04,640 --> 00:39:07,680
and look at this so my jundo and my

947
00:39:07,680 --> 00:39:10,320
michael user are there

948
00:39:10,320 --> 00:39:14,240
so now i have access to sql database

949
00:39:14,240 --> 00:39:15,440
so

950
00:39:15,440 --> 00:39:16,400
i hope

951
00:39:16,400 --> 00:39:18,880
all of this was informative and you get

952
00:39:18,880 --> 00:39:20,800
an idea how those things may be

953
00:39:20,800 --> 00:39:23,040
compromised and we've finally reached to

954
00:39:23,040 --> 00:39:24,640
the end of the session

955
00:39:24,640 --> 00:39:26,960
please use new knowledge that you got

956
00:39:26,960 --> 00:39:29,119
from this session

957
00:39:29,119 --> 00:39:30,800
and

958
00:39:30,800 --> 00:39:32,800
go ahead and ask your questions if you

959
00:39:32,800 --> 00:39:33,760
have them

960
00:39:33,760 --> 00:39:35,440
so thank you very much for your

961
00:39:35,440 --> 00:39:40,880
participation see you next time bye bye

