1
00:00:06,240 --> 00:00:07,600
so let's get started

2
00:00:07,600 --> 00:00:10,880
um let me just tell a few few words

3
00:00:10,880 --> 00:00:11,679
about me

4
00:00:11,679 --> 00:00:15,200
a few more um one more thing i'm from

5
00:00:15,200 --> 00:00:17,199
russia if you're interested in that

6
00:00:17,199 --> 00:00:20,880
so um that's my burden to uh

7
00:00:20,880 --> 00:00:24,080
talk about hacking um yeah yeah

8
00:00:24,080 --> 00:00:25,519
absolutely right about certification so

9
00:00:25,519 --> 00:00:26,800
i don't want to read them again if you

10
00:00:26,800 --> 00:00:29,199
want to find me here's the linkedin

11
00:00:29,199 --> 00:00:32,479
so go ahead and find me there

12
00:00:32,479 --> 00:00:35,520
um so what this session is all about

13
00:00:35,520 --> 00:00:37,760
uh what the session is all about um i'm

14
00:00:37,760 --> 00:00:39,280
gonna i'm going to cover

15
00:00:39,280 --> 00:00:42,160
um the typical misconfigurations that

16
00:00:42,160 --> 00:00:43,680
you may find in azure

17
00:00:43,680 --> 00:00:46,719
because uh azure is pretty secure by

18
00:00:46,719 --> 00:00:48,160
itself

19
00:00:48,160 --> 00:00:50,960
but when you when you use that when

20
00:00:50,960 --> 00:00:52,800
company use that

21
00:00:52,800 --> 00:00:55,600
they have like very typical scenarios

22
00:00:55,600 --> 00:00:57,120
that may be compromised

23
00:00:57,120 --> 00:00:59,680
i want to show you them so so because i

24
00:00:59,680 --> 00:01:00,719
do assessments

25
00:01:00,719 --> 00:01:02,399
and penetration tests for different

26
00:01:02,399 --> 00:01:03,840
companies and

27
00:01:03,840 --> 00:01:05,600
quite often i find they're repeatable

28
00:01:05,600 --> 00:01:08,159
scenarios uh tributable evidence

29
00:01:08,159 --> 00:01:09,200
patterns

30
00:01:09,200 --> 00:01:11,840
so i combine them all together in the

31
00:01:11,840 --> 00:01:12,960
single scenario

32
00:01:12,960 --> 00:01:14,560
and so that's what i want to show you

33
00:01:14,560 --> 00:01:16,080
here uh what is

34
00:01:16,080 --> 00:01:17,840
what is interesting about my session

35
00:01:17,840 --> 00:01:20,000
from my standpoint

36
00:01:20,000 --> 00:01:22,080
in general i don't really like to use

37
00:01:22,080 --> 00:01:24,320
slides i prefer live demos so

38
00:01:24,320 --> 00:01:26,080
this session mostly will be based on

39
00:01:26,080 --> 00:01:28,080
live demos uh of course i will show you

40
00:01:28,080 --> 00:01:29,600
some slides to just just

41
00:01:29,600 --> 00:01:32,159
just just give an idea where we are now

42
00:01:32,159 --> 00:01:33,280
uh but most of the time

43
00:01:33,280 --> 00:01:36,400
you may expect live demos um and in the

44
00:01:36,400 --> 00:01:37,759
end of session of course i will answer

45
00:01:37,759 --> 00:01:39,200
your questions and i will give you some

46
00:01:39,200 --> 00:01:41,360
ideas how can you mitigate that but once

47
00:01:41,360 --> 00:01:43,119
again that's going to be

48
00:01:43,119 --> 00:01:45,439
most of the most of the other the most

49
00:01:45,439 --> 00:01:46,960
of the session most of the time

50
00:01:46,960 --> 00:01:49,360
i will show you some offensive things um

51
00:01:49,360 --> 00:01:50,079
all right

52
00:01:50,079 --> 00:01:51,840
all right so let's get started uh that's

53
00:01:51,840 --> 00:01:53,600
my agenda

54
00:01:53,600 --> 00:01:58,399
so i will have like three environments

55
00:01:58,399 --> 00:02:00,560
uh three different type of different

56
00:02:00,560 --> 00:02:01,439
type of public

57
00:02:01,439 --> 00:02:03,840
type of environments and i will

58
00:02:03,840 --> 00:02:05,680
compromise them one by one

59
00:02:05,680 --> 00:02:07,680
and so i will move from one environment

60
00:02:07,680 --> 00:02:08,878
to another and so

61
00:02:08,878 --> 00:02:11,038
we're gonna start from hybrid active

62
00:02:11,038 --> 00:02:13,440
directory

63
00:02:13,440 --> 00:02:17,040
and so in my hybrid ad i have

64
00:02:17,040 --> 00:02:19,280
the main controller and i have what's

65
00:02:19,280 --> 00:02:22,000
called azure ad connect

66
00:02:22,000 --> 00:02:24,800
and this service uh is we can

67
00:02:24,800 --> 00:02:26,000
synchronize

68
00:02:26,000 --> 00:02:28,959
accounts groups users and so on from on

69
00:02:28,959 --> 00:02:31,120
primacy directory to the cloud so

70
00:02:31,120 --> 00:02:33,599
company can reuse those accounts in the

71
00:02:33,599 --> 00:02:35,360
cloud

72
00:02:35,360 --> 00:02:38,640
so let me just jump to demo um

73
00:02:38,640 --> 00:02:40,879
and show you how it looks like so here's

74
00:02:40,879 --> 00:02:42,000
the azurity connect

75
00:02:42,000 --> 00:02:46,000
on the separate server um and

76
00:02:46,000 --> 00:02:49,519
um you may ask all right so 80 connect

77
00:02:49,519 --> 00:02:50,160
is

78
00:02:50,160 --> 00:02:52,640
very typical very typical configuration

79
00:02:52,640 --> 00:02:54,720
what's the problem with ad connect

80
00:02:54,720 --> 00:02:56,640
uh one of the problems with ad connect

81
00:02:56,640 --> 00:02:58,640
is configuration

82
00:02:58,640 --> 00:03:02,720
which is like um recommended

83
00:03:02,720 --> 00:03:04,720
some some some part of this

84
00:03:04,720 --> 00:03:06,319
configuration is recommended

85
00:03:06,319 --> 00:03:09,200
so when you configure ad connect uh you

86
00:03:09,200 --> 00:03:09,599
must

87
00:03:09,599 --> 00:03:13,040
create what's called a deforest account

88
00:03:13,040 --> 00:03:16,239
uh this account uh

89
00:03:16,239 --> 00:03:17,760
will be created automatically that's the

90
00:03:17,760 --> 00:03:18,879
most recommended ways to create it

91
00:03:18,879 --> 00:03:20,000
automatically

92
00:03:20,000 --> 00:03:21,519
and one of the things when this about

93
00:03:21,519 --> 00:03:23,360
this account uh

94
00:03:23,360 --> 00:03:26,640
when you configure your ad connect

95
00:03:26,640 --> 00:03:28,959
uh you must specify different features

96
00:03:28,959 --> 00:03:31,280
and if you specify a feature which is

97
00:03:31,280 --> 00:03:33,200
highly recommended called password hash

98
00:03:33,200 --> 00:03:33,680
scene

99
00:03:33,680 --> 00:03:36,799
so it means that the hashes of passwords

100
00:03:36,799 --> 00:03:38,799
will be synchronized from on-prem id the

101
00:03:38,799 --> 00:03:40,560
cloud as well

102
00:03:40,560 --> 00:03:42,480
uh if you if you enable this feature and

103
00:03:42,480 --> 00:03:44,400
this feature is super useful

104
00:03:44,400 --> 00:03:48,319
because uh in this case in your azure

105
00:03:48,319 --> 00:03:50,159
your your users will have the same

106
00:03:50,159 --> 00:03:52,319
password and if you lose connectivity on

107
00:03:52,319 --> 00:03:52,959
pram

108
00:03:52,959 --> 00:03:55,120
they will still be able to connect so

109
00:03:55,120 --> 00:03:56,080
password hashing

110
00:03:56,080 --> 00:03:58,400
is is very commanded by microsoft

111
00:03:58,400 --> 00:04:00,879
because it's resilient

112
00:04:00,879 --> 00:04:06,879
and but if you enable password hash sync

113
00:04:06,879 --> 00:04:10,319
account for synchronization will have

114
00:04:10,319 --> 00:04:12,480
this permissions replicate directory

115
00:04:12,480 --> 00:04:14,400
changes and replica directory changes

116
00:04:14,400 --> 00:04:15,840
all

117
00:04:15,840 --> 00:04:19,040
let me jump back to demo and show you on

118
00:04:19,040 --> 00:04:21,199
the main controller this account

119
00:04:21,199 --> 00:04:24,639
so just in case if if you haven't

120
00:04:24,639 --> 00:04:26,560
worked with ad connect before azure id

121
00:04:26,560 --> 00:04:28,000
connect before

122
00:04:28,000 --> 00:04:29,440
so that's the service that's installed

123
00:04:29,440 --> 00:04:31,520
on the separate server

124
00:04:31,520 --> 00:04:34,080
during the configuration you must create

125
00:04:34,080 --> 00:04:34,800
an account

126
00:04:34,800 --> 00:04:37,919
that will read active directory to grab

127
00:04:37,919 --> 00:04:39,759
accounts from there

128
00:04:39,759 --> 00:04:41,120
and sell the account that will be

129
00:04:41,120 --> 00:04:43,280
created for this synchronization

130
00:04:43,280 --> 00:04:46,400
it's called like this msrl and

131
00:04:46,400 --> 00:04:49,120
random numbers and letters let me check

132
00:04:49,120 --> 00:04:50,880
permissions of this account if i look at

133
00:04:50,880 --> 00:04:53,440
the properties of the main controller

134
00:04:53,440 --> 00:04:56,560
and go to security tab

135
00:04:56,560 --> 00:05:00,000
i can find this msil

136
00:05:00,160 --> 00:05:03,520
and look at this so it has replicate and

137
00:05:03,520 --> 00:05:04,960
directly changes

138
00:05:04,960 --> 00:05:06,960
so what does it mean if i have urban

139
00:05:06,960 --> 00:05:08,000
directly changes

140
00:05:08,000 --> 00:05:09,360
i think you're familiar with a tag

141
00:05:09,360 --> 00:05:11,360
called dc sync

142
00:05:11,360 --> 00:05:14,000
when some attacker may synchronize uh

143
00:05:14,000 --> 00:05:16,160
some content from active directory

144
00:05:16,160 --> 00:05:18,320
so in fact replicating directory changes

145
00:05:18,320 --> 00:05:19,600
allowed me to do

146
00:05:19,600 --> 00:05:22,800
dc sync with mimikatz so this account

147
00:05:22,800 --> 00:05:25,039
become pretty powerful

148
00:05:25,039 --> 00:05:27,680
um uh but the question that you may have

149
00:05:27,680 --> 00:05:29,440
all right so this account is powerful

150
00:05:29,440 --> 00:05:31,360
but what is the password how can we find

151
00:05:31,360 --> 00:05:33,520
the password who can find a password

152
00:05:33,520 --> 00:05:35,759
um generally speaking this account for

153
00:05:35,759 --> 00:05:37,759
this for this account we don't know

154
00:05:37,759 --> 00:05:38,880
password

155
00:05:38,880 --> 00:05:40,960
normally because this account generate

156
00:05:40,960 --> 00:05:42,240
automatically and

157
00:05:42,240 --> 00:05:44,720
password is managed by ad connect by

158
00:05:44,720 --> 00:05:45,520
itself so

159
00:05:45,520 --> 00:05:47,600
you don't have access to password

160
00:05:47,600 --> 00:05:48,720
directly

161
00:05:48,720 --> 00:05:51,440
but there is a way how can we do it

162
00:05:51,440 --> 00:05:52,400
there is a way how can

163
00:05:52,400 --> 00:05:55,280
we get access uh let me jump back to ad

164
00:05:55,280 --> 00:05:57,440
connect

165
00:05:57,440 --> 00:06:00,160
um and let's think about this let's

166
00:06:00,160 --> 00:06:01,199
think about this

167
00:06:01,199 --> 00:06:03,440
so if we have 80 connects if if we have

168
00:06:03,440 --> 00:06:05,039
an ad connect server

169
00:06:05,039 --> 00:06:07,360
an ad connect server somehow uses this

170
00:06:07,360 --> 00:06:08,080
account

171
00:06:08,080 --> 00:06:10,160
so somewhere this password must be

172
00:06:10,160 --> 00:06:11,360
stored

173
00:06:11,360 --> 00:06:14,560
this password is stored in sql database

174
00:06:14,560 --> 00:06:17,440
if i look at the sql database for that

175
00:06:17,440 --> 00:06:18,479
that has

176
00:06:18,479 --> 00:06:21,360
the database of id connect and i look at

177
00:06:21,360 --> 00:06:23,680
the

178
00:06:23,840 --> 00:06:27,759
management agent here i can find

179
00:06:27,759 --> 00:06:30,639
oh let me just remove and columns i

180
00:06:30,639 --> 00:06:32,000
don't need

181
00:06:32,000 --> 00:06:35,120
remove this

182
00:06:35,120 --> 00:06:38,240
from this as well uh let's remove this

183
00:06:38,240 --> 00:06:41,280
those all right so let me run again

184
00:06:41,280 --> 00:06:45,120
and now let me find this

185
00:06:45,120 --> 00:06:48,880
account here and look at this

186
00:06:48,880 --> 00:06:51,840
so account i think it means that okay

187
00:06:51,840 --> 00:06:53,280
here we go

188
00:06:53,280 --> 00:06:56,720
so account is here and it says password

189
00:06:56,720 --> 00:06:57,840
we have password

190
00:06:57,840 --> 00:07:01,759
but password is encrypted stream so

191
00:07:01,759 --> 00:07:03,520
we cannot have direct access to

192
00:07:03,520 --> 00:07:05,440
passwords we can find the plain text

193
00:07:05,440 --> 00:07:06,160
password

194
00:07:06,160 --> 00:07:08,000
uh because if i look here it will be

195
00:07:08,000 --> 00:07:09,680
something encrypted

196
00:07:09,680 --> 00:07:13,759
uh but uh it's possible to decrypt

197
00:07:13,759 --> 00:07:16,560
and who can decrypt that anyone who has

198
00:07:16,560 --> 00:07:18,720
permissions of local administrator on ad

199
00:07:18,720 --> 00:07:19,919
connect server

200
00:07:19,919 --> 00:07:21,680
and and here the typical

201
00:07:21,680 --> 00:07:23,280
misconfiguration is started

202
00:07:23,280 --> 00:07:25,759
because companies think like all right

203
00:07:25,759 --> 00:07:28,960
if ad connect is not a domain controller

204
00:07:28,960 --> 00:07:32,319
so we may allow uh like a server

205
00:07:32,319 --> 00:07:33,840
administrators

206
00:07:33,840 --> 00:07:35,280
manage ad connect because it's not

207
00:07:35,280 --> 00:07:36,960
domain controller

208
00:07:36,960 --> 00:07:38,880
and also it has different usually ad

209
00:07:38,880 --> 00:07:40,400
connect has different baselines not the

210
00:07:40,400 --> 00:07:42,160
same as domain controller as

211
00:07:42,160 --> 00:07:43,840
um yeah of course that has some

212
00:07:43,840 --> 00:07:45,440
different features but anyway

213
00:07:45,440 --> 00:07:49,280
um so the typical misconfiguration when

214
00:07:49,280 --> 00:07:49,919
company

215
00:07:49,919 --> 00:07:52,000
companies allow uh like server

216
00:07:52,000 --> 00:07:53,039
administrators

217
00:07:53,039 --> 00:07:55,440
manage ad connect let me show you what

218
00:07:55,440 --> 00:07:56,720
we can do with that

219
00:07:56,720 --> 00:07:59,360
um so you can decrypt this password you

220
00:07:59,360 --> 00:08:00,800
can do it manually but it's

221
00:08:00,800 --> 00:08:02,879
pain in the neck so it will take a lot

222
00:08:02,879 --> 00:08:04,240
of time it

223
00:08:04,240 --> 00:08:05,919
will be longer than i have for my

224
00:08:05,919 --> 00:08:08,560
session but you may find also on the web

225
00:08:08,560 --> 00:08:10,639
uh the tool called ad connect dump so

226
00:08:10,639 --> 00:08:12,639
just just google about this

227
00:08:12,639 --> 00:08:14,400
you will find the tool and you will find

228
00:08:14,400 --> 00:08:15,840
the article of author

229
00:08:15,840 --> 00:08:17,680
and author describes how to do it

230
00:08:17,680 --> 00:08:19,680
manually but for the sake of time i will

231
00:08:19,680 --> 00:08:20,479
share that

232
00:08:20,479 --> 00:08:22,479
uh how can how can i do with one click

233
00:08:22,479 --> 00:08:24,319
so i'm gonna just i just run

234
00:08:24,319 --> 00:08:27,039
uh the script on my server on 80 connect

235
00:08:27,039 --> 00:08:28,879
server with admin permissions

236
00:08:28,879 --> 00:08:31,360
uh so i'm not the main admin here uh i

237
00:08:31,360 --> 00:08:32,479
might just restart

238
00:08:32,479 --> 00:08:35,120
just a regular local local administrator

239
00:08:35,120 --> 00:08:36,799
and i can have

240
00:08:36,799 --> 00:08:40,240
this username and password so let me

241
00:08:40,240 --> 00:08:41,120
copy this

242
00:08:41,120 --> 00:08:44,320
value this this

243
00:08:44,320 --> 00:08:48,000
value and jump to

244
00:08:48,000 --> 00:08:51,120
client workstation so i'm going to open

245
00:08:51,120 --> 00:08:55,440
um cmd

246
00:08:55,440 --> 00:08:57,760
and i'm going to open cmd again as a

247
00:08:57,760 --> 00:09:00,560
different user

248
00:09:01,279 --> 00:09:04,959
so place here and let's sign this name

249
00:09:04,959 --> 00:09:06,240
and click ok

250
00:09:06,240 --> 00:09:08,640
so now what i want to do i want to i

251
00:09:08,640 --> 00:09:09,760
want to run

252
00:09:09,760 --> 00:09:11,760
that very typical well-known command

253
00:09:11,760 --> 00:09:13,760
called dc sync

254
00:09:13,760 --> 00:09:17,360
um using very well known tool minicats

255
00:09:17,360 --> 00:09:18,880
and you know but this is the in case i

256
00:09:18,880 --> 00:09:20,959
can synchronize the main administrator i

257
00:09:20,959 --> 00:09:22,160
can synchronize

258
00:09:22,160 --> 00:09:25,600
uh kirbtgt and create golden tickets if

259
00:09:25,600 --> 00:09:27,200
or if i synchronize my administrator i

260
00:09:27,200 --> 00:09:28,800
can run the hash

261
00:09:28,800 --> 00:09:30,720
so it it will give me a lot of

262
00:09:30,720 --> 00:09:32,160
permission so first

263
00:09:32,160 --> 00:09:34,320
before i start to do anything let me

264
00:09:34,320 --> 00:09:35,519
check my permissions

265
00:09:35,519 --> 00:09:38,640
and who am i so in one command line uh i

266
00:09:38,640 --> 00:09:41,600
i'm a contoso j dom and what permissions

267
00:09:41,600 --> 00:09:42,720
do i have can i

268
00:09:42,720 --> 00:09:44,560
enumerate c drive for the of my

269
00:09:44,560 --> 00:09:46,480
controller no i can

270
00:09:46,480 --> 00:09:49,600
let's try another one

271
00:09:49,760 --> 00:09:51,839
here i am msl can i enumerate my

272
00:09:51,839 --> 00:09:53,680
controller no

273
00:09:53,680 --> 00:09:57,920
all right so let's open minicaps first

274
00:09:57,920 --> 00:10:01,279
as an smsl account let's run in cats

275
00:10:01,279 --> 00:10:04,320
and here i want to say um lsa

276
00:10:04,320 --> 00:10:08,320
dump dc sync

277
00:10:08,320 --> 00:10:11,279
end user is going to be trainer who is

278
00:10:11,279 --> 00:10:13,600
mydom administrator

279
00:10:13,600 --> 00:10:16,800
look at this so now i have

280
00:10:16,800 --> 00:10:19,920
a hash of the my administrator

281
00:10:19,920 --> 00:10:23,839
what next then i go to to to

282
00:10:23,839 --> 00:10:26,079
mimic it's again open as the regular

283
00:10:26,079 --> 00:10:27,120
domain user

284
00:10:27,120 --> 00:10:30,839
with location permission of course um

285
00:10:30,839 --> 00:10:35,279
and run past the hash

286
00:10:35,279 --> 00:10:38,560
and so here i must copy

287
00:10:38,560 --> 00:10:41,440
and paste this hash all right so i have

288
00:10:41,440 --> 00:10:43,440
another command prompt let me just

289
00:10:43,440 --> 00:10:46,880
oh sorry wrong one

290
00:10:46,880 --> 00:10:49,200
and yeah i have access domain controller

291
00:10:49,200 --> 00:10:51,360
so that's a typical problem

292
00:10:51,360 --> 00:10:54,880
uh when companies allow ad connect to be

293
00:10:54,880 --> 00:10:55,680
managed by

294
00:10:55,680 --> 00:10:57,279
server administrators and those

295
00:10:57,279 --> 00:10:58,880
administrators they may become the main

296
00:10:58,880 --> 00:10:59,600
admins

297
00:10:59,600 --> 00:11:02,880
and we we find it very often it's

298
00:11:02,880 --> 00:11:06,240
many companies this configuration so

299
00:11:06,240 --> 00:11:09,680
let me jump back to to here so now we

300
00:11:09,680 --> 00:11:10,880
compromised

301
00:11:10,880 --> 00:11:14,000
uh on parameter directory and with ad

302
00:11:14,000 --> 00:11:15,680
connect

303
00:11:15,680 --> 00:11:18,880
uh and and we became the main admins

304
00:11:18,880 --> 00:11:22,640
now from here uh let's move to the next

305
00:11:22,640 --> 00:11:24,800
uh next infrastructure which is virtual

306
00:11:24,800 --> 00:11:26,079
machine so we have

307
00:11:26,079 --> 00:11:29,040
virtual machines in azure and and they

308
00:11:29,040 --> 00:11:29,519
will be

309
00:11:29,519 --> 00:11:32,399
they they have in my case a jenkins

310
00:11:32,399 --> 00:11:33,440
application installed

311
00:11:33,440 --> 00:11:35,279
to be fair it doesn't really matter what

312
00:11:35,279 --> 00:11:36,640
is installed there

313
00:11:36,640 --> 00:11:38,720
i use jenkins just an example because

314
00:11:38,720 --> 00:11:40,880
jenkins may have multiple nodes with

315
00:11:40,880 --> 00:11:42,160
different operating system

316
00:11:42,160 --> 00:11:44,240
in my case windows and linux i just want

317
00:11:44,240 --> 00:11:46,399
to show you how linux and windows

318
00:11:46,399 --> 00:11:49,200
may be compromised in the same manner so

319
00:11:49,200 --> 00:11:50,320
let's move on

320
00:11:50,320 --> 00:11:52,880
and i'm going to jump back to demo and

321
00:11:52,880 --> 00:11:54,000
just want to continue

322
00:11:54,000 --> 00:11:57,279
this previous uh demo and and and

323
00:11:57,279 --> 00:11:59,360
in transit to the next scenario so now

324
00:11:59,360 --> 00:12:00,560
i'm in the main admin

325
00:12:00,560 --> 00:12:04,320
and i need somehow to get into azure

326
00:12:04,320 --> 00:12:06,800
and to if i want to pen test virtual

327
00:12:06,800 --> 00:12:07,600
machines

328
00:12:07,600 --> 00:12:09,360
so if i'm at my admin i have multiple

329
00:12:09,360 --> 00:12:11,040
ways to do it so first of all i can

330
00:12:11,040 --> 00:12:12,320
create a new account

331
00:12:12,320 --> 00:12:14,880
in active directory and add account to

332
00:12:14,880 --> 00:12:16,079
some sort of groups

333
00:12:16,079 --> 00:12:17,440
and if if those group they have

334
00:12:17,440 --> 00:12:19,760
permissions in azure all of this will be

335
00:12:19,760 --> 00:12:20,800
synchronized

336
00:12:20,800 --> 00:12:23,360
that's a bit noisy first of all and

337
00:12:23,360 --> 00:12:25,279
second problem

338
00:12:25,279 --> 00:12:28,480
um second problem

339
00:12:28,480 --> 00:12:31,519
um i don't know

340
00:12:31,519 --> 00:12:33,839
i don't know what groups should i use

341
00:12:33,839 --> 00:12:36,079
because what groups have permissions i

342
00:12:36,079 --> 00:12:37,120
need

343
00:12:37,120 --> 00:12:39,519
i can try a different thing since i'm a

344
00:12:39,519 --> 00:12:41,760
domain admin i can also try to connect

345
00:12:41,760 --> 00:12:43,839
to any workstation and if i connect the

346
00:12:43,839 --> 00:12:45,680
workstation of administrators

347
00:12:45,680 --> 00:12:47,920
or developers i can find something

348
00:12:47,920 --> 00:12:49,519
interesting there let me share that real

349
00:12:49,519 --> 00:12:50,320
quick

350
00:12:50,320 --> 00:12:52,160
so first of all i'm going to open a

351
00:12:52,160 --> 00:12:54,480
workstation that let's say belongs to me

352
00:12:54,480 --> 00:12:57,680
and i want to remove just one thing

353
00:12:57,680 --> 00:12:59,920
there

354
00:13:00,010 --> 00:13:03,360
[Music]

355
00:13:03,360 --> 00:13:08,160
all right that's fine uh let me open cmd

356
00:13:08,160 --> 00:13:11,839
uh on developer machine now let's type

357
00:13:11,839 --> 00:13:15,680
a z account

358
00:13:15,839 --> 00:13:18,720
list and output table it doesn't really

359
00:13:18,720 --> 00:13:19,120
matter

360
00:13:19,120 --> 00:13:20,639
i can anything i look at this so it

361
00:13:20,639 --> 00:13:22,720
shows me my subscriptions

362
00:13:22,720 --> 00:13:25,040
now if i do the same on the different

363
00:13:25,040 --> 00:13:27,680
workstation

364
00:13:29,040 --> 00:13:32,560
uh az account list

365
00:13:32,560 --> 00:13:36,399
and of output table so

366
00:13:36,399 --> 00:13:37,760
fingers crossed it should give me an

367
00:13:37,760 --> 00:13:39,600
error

368
00:13:39,600 --> 00:13:44,160
come on did

369
00:13:44,160 --> 00:13:47,440
oh so it doesn't work so that's that's

370
00:13:47,440 --> 00:13:50,079
easy that's the tool that very commonly

371
00:13:50,079 --> 00:13:50,560
used

372
00:13:50,560 --> 00:13:52,880
by administrators and developers to

373
00:13:52,880 --> 00:13:54,800
administer azure environment

374
00:13:54,800 --> 00:13:57,199
and so when i showed you before the

375
00:13:57,199 --> 00:13:58,480
previous workstation

376
00:13:58,480 --> 00:14:00,480
i typed the command and it didn't ask me

377
00:14:00,480 --> 00:14:02,000
for a password

378
00:14:02,000 --> 00:14:03,839
here it's it says hey you must

379
00:14:03,839 --> 00:14:06,160
authenticate first

380
00:14:06,160 --> 00:14:08,399
so it looks like those authentication

381
00:14:08,399 --> 00:14:09,279
token

382
00:14:09,279 --> 00:14:12,560
uh cached somewhere and

383
00:14:12,560 --> 00:14:15,519
let's find where this token is if i go

384
00:14:15,519 --> 00:14:16,000
to user

385
00:14:16,000 --> 00:14:20,240
profile user profile

386
00:14:21,360 --> 00:14:25,199
and here's the folder folder and profile

387
00:14:25,199 --> 00:14:25,600
called

388
00:14:25,600 --> 00:14:29,600
dot azure and the token will be cached

389
00:14:29,600 --> 00:14:31,440
here

390
00:14:31,440 --> 00:14:34,560
and if i'm the main admin i can connect

391
00:14:34,560 --> 00:14:36,240
to any workstation and

392
00:14:36,240 --> 00:14:39,360
and nothing stops me from getting this

393
00:14:39,360 --> 00:14:39,839
ticket

394
00:14:39,839 --> 00:14:44,639
let me take a ticket but token

395
00:14:44,639 --> 00:14:49,600
so let me zip it and copy that to

396
00:14:49,839 --> 00:14:52,480
my machine

397
00:14:55,279 --> 00:14:59,839
all right and let's extract here

398
00:15:00,000 --> 00:15:01,920
all right let's try again cross your

399
00:15:01,920 --> 00:15:04,639
fingers for me

400
00:15:04,959 --> 00:15:08,720
and come on

401
00:15:08,720 --> 00:15:13,199
yeah now i have access to azure

402
00:15:13,199 --> 00:15:15,680
uh as some sort of administrator i don't

403
00:15:15,680 --> 00:15:16,240
know

404
00:15:16,240 --> 00:15:17,760
which one i mean i don't know what

405
00:15:17,760 --> 00:15:19,600
permissions i have but i know

406
00:15:19,600 --> 00:15:22,480
that i'm there i can do something there

407
00:15:22,480 --> 00:15:24,639
and i wasn't asked for password and what

408
00:15:24,639 --> 00:15:26,240
is the most important

409
00:15:26,240 --> 00:15:28,959
um it didn't prompt me it didn't show me

410
00:15:28,959 --> 00:15:30,160
any mfa prompt

411
00:15:30,160 --> 00:15:33,279
so i i just i can manage azure now

412
00:15:33,279 --> 00:15:36,560
uh from from my workstation um and i i

413
00:15:36,560 --> 00:15:38,000
don't have to be authenticate

414
00:15:38,000 --> 00:15:40,399
i don't even need to create the fancy

415
00:15:40,399 --> 00:15:42,240
ways to bypass mfa just

416
00:15:42,240 --> 00:15:45,040
just just here in the safe credentials

417
00:15:45,040 --> 00:15:46,320
so

418
00:15:46,320 --> 00:15:50,079
so now if i have an access let's try to

419
00:15:50,079 --> 00:15:52,079
pen test

420
00:15:52,079 --> 00:15:54,079
virtual machines of course in the usual

421
00:15:54,079 --> 00:15:55,279
pen test we have

422
00:15:55,279 --> 00:15:58,000
a very long reconnaissance phase i don't

423
00:15:58,000 --> 00:15:59,519
know waste your time here because

424
00:15:59,519 --> 00:16:01,360
reconnaissance is

425
00:16:01,360 --> 00:16:04,000
it takes time uh let me just quickly

426
00:16:04,000 --> 00:16:05,680
just check what virtual machines i have

427
00:16:05,680 --> 00:16:07,199
here

428
00:16:07,199 --> 00:16:09,839
um

429
00:16:10,959 --> 00:16:14,000
so do you have any

430
00:16:14,000 --> 00:16:17,040
machines yeah i do and since my target

431
00:16:17,040 --> 00:16:17,759
once again

432
00:16:17,759 --> 00:16:22,160
is uh jenkins and both vms of jenkins

433
00:16:22,160 --> 00:16:25,839
i want to take those two vms

434
00:16:25,839 --> 00:16:28,560
those two vms uh and play with them a

435
00:16:28,560 --> 00:16:29,759
bit

436
00:16:29,759 --> 00:16:31,920
jinping's master and jenkins slave just

437
00:16:31,920 --> 00:16:33,440
just want to quickly remind you that

438
00:16:33,440 --> 00:16:37,040
jenkins mazda is windows server

439
00:16:37,040 --> 00:16:40,480
and jenkinslave is a linux server

440
00:16:40,480 --> 00:16:42,480
all right so what can i do with virtual

441
00:16:42,480 --> 00:16:44,480
machines so for this demo

442
00:16:44,480 --> 00:16:45,839
first i want to i want to jump to the

443
00:16:45,839 --> 00:16:47,519
portal and show you in a more visual

444
00:16:47,519 --> 00:16:48,320
manner

445
00:16:48,320 --> 00:16:49,839
and then i will get back to the command

446
00:16:49,839 --> 00:16:52,320
prompt and will complete my attack

447
00:16:52,320 --> 00:16:55,600
so if i go to azure portal to azure

448
00:16:55,600 --> 00:16:56,959
portal

449
00:16:56,959 --> 00:16:59,680
um and i open any virtual machine let me

450
00:16:59,680 --> 00:17:02,000
open jenkins master

451
00:17:02,000 --> 00:17:04,799
um for in any for any virtual machine

452
00:17:04,799 --> 00:17:06,720
you may find

453
00:17:06,720 --> 00:17:10,079
uh this command called run commands

454
00:17:10,079 --> 00:17:14,240
run commands and run under run commands

455
00:17:14,240 --> 00:17:16,959
for windows uh it will be around

456
00:17:16,959 --> 00:17:18,559
powershell script

457
00:17:18,559 --> 00:17:20,480
so you may run partial script execute

458
00:17:20,480 --> 00:17:22,000
powershell it says here

459
00:17:22,000 --> 00:17:24,880
you may exit powershell if this is linux

460
00:17:24,880 --> 00:17:25,599
of course this

461
00:17:25,599 --> 00:17:28,400
it will be shell script uh so that's

462
00:17:28,400 --> 00:17:29,120
that's the

463
00:17:29,120 --> 00:17:30,960
that's the same for both operand system

464
00:17:30,960 --> 00:17:32,320
types just a different

465
00:17:32,320 --> 00:17:34,000
uh different type of scripts of course

466
00:17:34,000 --> 00:17:36,160
uh powershell or shell

467
00:17:36,160 --> 00:17:38,240
um but now what is the most important

468
00:17:38,240 --> 00:17:39,360
about the search machines

469
00:17:39,360 --> 00:17:41,919
about this feature um what permissions

470
00:17:41,919 --> 00:17:42,640
you must have

471
00:17:42,640 --> 00:17:44,720
to run this feature oh by the way why do

472
00:17:44,720 --> 00:17:46,559
we need this feature in general you know

473
00:17:46,559 --> 00:17:48,559
that cloud is obstruction and they want

474
00:17:48,559 --> 00:17:50,640
us to administer cloud or fix some

475
00:17:50,640 --> 00:17:51,440
problems

476
00:17:51,440 --> 00:17:53,600
uh without logging locally to virtual

477
00:17:53,600 --> 00:17:55,600
machines so i i can try to do it

478
00:17:55,600 --> 00:17:57,440
i can try to run some scripts and fix

479
00:17:57,440 --> 00:17:58,880
something or configure something virtual

480
00:17:58,880 --> 00:17:59,600
machine

481
00:17:59,600 --> 00:18:03,200
without a local login and now

482
00:18:03,200 --> 00:18:06,320
my goal will be use this feature to

483
00:18:06,320 --> 00:18:08,480
bypass authentication and get into

484
00:18:08,480 --> 00:18:09,919
virtual machine

485
00:18:09,919 --> 00:18:12,640
from my current position let me show you

486
00:18:12,640 --> 00:18:14,559
what permissions i must have if i want

487
00:18:14,559 --> 00:18:15,360
to i mean

488
00:18:15,360 --> 00:18:17,280
if i want to use this feature so if i go

489
00:18:17,280 --> 00:18:18,640
to roles

490
00:18:18,640 --> 00:18:21,840
on azure and i can click very typical

491
00:18:21,840 --> 00:18:22,559
role called

492
00:18:22,559 --> 00:18:25,520
reader so and for many companies they

493
00:18:25,520 --> 00:18:27,360
think oh that's just a reader

494
00:18:27,360 --> 00:18:30,160
this this this role cannot do anything

495
00:18:30,160 --> 00:18:31,200
bad

496
00:18:31,200 --> 00:18:33,679
or some some so just it can read it and

497
00:18:33,679 --> 00:18:34,799
nothing more

498
00:18:34,799 --> 00:18:37,760
so this in this role quite often you may

499
00:18:37,760 --> 00:18:39,280
find on subscription level

500
00:18:39,280 --> 00:18:42,080
and will be inherited by other resources

501
00:18:42,080 --> 00:18:42,400
so

502
00:18:42,400 --> 00:18:45,440
let me click reader

503
00:18:45,440 --> 00:18:49,600
look at the permissions and

504
00:18:49,600 --> 00:18:53,360
find compute here

505
00:18:54,640 --> 00:18:59,120
um sorry

506
00:19:00,080 --> 00:19:04,640
and look at this run command

507
00:19:04,640 --> 00:19:08,080
this th this feature is available

508
00:19:08,080 --> 00:19:11,200
for readers all right

509
00:19:11,200 --> 00:19:14,080
now we we know what it is so i can run

510
00:19:14,080 --> 00:19:15,840
powerful scripts and shell scripts as

511
00:19:15,840 --> 00:19:16,480
well

512
00:19:16,480 --> 00:19:19,919
now let's jump back and do it um

513
00:19:19,919 --> 00:19:23,039
so first before i start running scripts

514
00:19:23,039 --> 00:19:24,160
what do they when where do you want to

515
00:19:24,160 --> 00:19:26,559
run what do i want to run probably

516
00:19:26,559 --> 00:19:28,320
if i want to get access to those virtual

517
00:19:28,320 --> 00:19:30,400
machines it will be

518
00:19:30,400 --> 00:19:34,640
shell i mean reverse shell of course

519
00:19:34,640 --> 00:19:36,640
metasploit but if you have antivirus

520
00:19:36,640 --> 00:19:38,640
maybe a bad idea or something custom

521
00:19:38,640 --> 00:19:39,760
which is which is better

522
00:19:39,760 --> 00:19:41,360
which is better at the end so let me

523
00:19:41,360 --> 00:19:44,799
first establish netcat listener

524
00:19:46,720 --> 00:19:50,840
on this port another port for

525
00:19:50,840 --> 00:19:54,080
windows so

526
00:19:54,080 --> 00:19:58,400
let's try first let's try linux

527
00:19:58,400 --> 00:20:00,799
uh that's how can i do it from this

528
00:20:00,799 --> 00:20:01,760
command prompt

529
00:20:01,760 --> 00:20:04,880
let's click here

530
00:20:04,880 --> 00:20:06,080
by the way this feature is not super

531
00:20:06,080 --> 00:20:09,039
fast so let me just

532
00:20:09,039 --> 00:20:13,679
wait a bit it should be here

533
00:20:13,679 --> 00:20:16,080
fingers crossed again once again it

534
00:20:16,080 --> 00:20:18,960
takes time before that will be executed

535
00:20:18,960 --> 00:20:21,919
hopefully it will be and i didn't block

536
00:20:21,919 --> 00:20:23,679
it oh look at this

537
00:20:23,679 --> 00:20:26,320
so i have the shell on linux now let's

538
00:20:26,320 --> 00:20:29,760
try the same trick with windows

539
00:20:31,280 --> 00:20:33,120
for windows you know we don't have any

540
00:20:33,120 --> 00:20:34,480
native shells

541
00:20:34,480 --> 00:20:36,880
of course you may try something like

542
00:20:36,880 --> 00:20:38,480
power shell

543
00:20:38,480 --> 00:20:41,600
nishan shell or whatever i i just did a

544
00:20:41,600 --> 00:20:43,440
different thing i just create my own

545
00:20:43,440 --> 00:20:45,919
shell on python and so i will download

546
00:20:45,919 --> 00:20:47,039
that

547
00:20:47,039 --> 00:20:49,039
and just run it and it shouldn't be

548
00:20:49,039 --> 00:20:50,799
detected by antiviruses because it's my

549
00:20:50,799 --> 00:20:52,000
custom thing

550
00:20:52,000 --> 00:20:55,919
all right let's run that let's run that

551
00:20:55,919 --> 00:20:58,960
um and let's wait for for windows shell

552
00:20:58,960 --> 00:20:59,440
as well

553
00:20:59,440 --> 00:21:01,520
let me just first explore linux uh let's

554
00:21:01,520 --> 00:21:02,640
see if i type

555
00:21:02,640 --> 00:21:06,159
id here i can see i'm root why i'm rude

556
00:21:06,159 --> 00:21:09,840
um am i running at this vm as a route

557
00:21:09,840 --> 00:21:11,760
uh it doesn't really matter oh look at

558
00:21:11,760 --> 00:21:13,440
this we have a shell for for windows as

559
00:21:13,440 --> 00:21:13,919
well

560
00:21:13,919 --> 00:21:16,720
it doesn't really matter because this

561
00:21:16,720 --> 00:21:17,440
this

562
00:21:17,440 --> 00:21:20,320
feature to run run commands work on

563
00:21:20,320 --> 00:21:22,159
behalf of a local system or on behalf of

564
00:21:22,159 --> 00:21:22,720
root

565
00:21:22,720 --> 00:21:25,760
so for on on window on linux i'm root on

566
00:21:25,760 --> 00:21:27,760
windows

567
00:21:27,760 --> 00:21:30,720
i'm local system and i can do whatever i

568
00:21:30,720 --> 00:21:31,919
want now

569
00:21:31,919 --> 00:21:35,520
on those virtual machines isn't cool

570
00:21:35,520 --> 00:21:39,440
so for for companies it may look like oh

571
00:21:39,440 --> 00:21:42,080
we just enable reader feature who cares

572
00:21:42,080 --> 00:21:45,200
but that's what i can do if i have

573
00:21:45,200 --> 00:21:46,880
reader permissions on virtual machine

574
00:21:46,880 --> 00:21:47,280
level

575
00:21:47,280 --> 00:21:48,880
so let me just just just do one more

576
00:21:48,880 --> 00:21:50,799
thing uh let me open

577
00:21:50,799 --> 00:21:53,679
jenkins error log i know it's not really

578
00:21:53,679 --> 00:21:55,360
important about the jenkins himself but

579
00:21:55,360 --> 00:21:56,400
let me just

580
00:21:56,400 --> 00:21:59,840
uh let me just check uh what i can i can

581
00:21:59,840 --> 00:22:00,880
find here

582
00:22:00,880 --> 00:22:03,280
and i can find here the password of

583
00:22:03,280 --> 00:22:04,159
jenkins

584
00:22:04,159 --> 00:22:07,120
uh it is the initial password there uh

585
00:22:07,120 --> 00:22:08,480
it will be an airlock

586
00:22:08,480 --> 00:22:11,840
um so let me try to do oh what is that

587
00:22:11,840 --> 00:22:12,559
russ i

588
00:22:12,559 --> 00:22:15,840
forgot um

589
00:22:15,840 --> 00:22:26,400
let me try to log into jenkins

590
00:22:26,400 --> 00:22:30,480
and this is my password

591
00:22:31,040 --> 00:22:34,230
[Music]

592
00:22:35,039 --> 00:22:38,080
and yeah that works fine so uh

593
00:22:38,080 --> 00:22:41,120
that is uh that is

594
00:22:41,120 --> 00:22:42,640
virtual machine to be fair i don't

595
00:22:42,640 --> 00:22:44,559
really care for jenkins or something

596
00:22:44,559 --> 00:22:45,440
else

597
00:22:45,440 --> 00:22:47,360
i just want i just want to show you how

598
00:22:47,360 --> 00:22:48,559
virtual machines

599
00:22:48,559 --> 00:22:51,840
may be compromised

600
00:22:51,840 --> 00:22:56,320
all right so let's jump to the last

601
00:22:56,320 --> 00:23:00,000
scenario um and now we have something

602
00:23:00,000 --> 00:23:01,600
more advanced

603
00:23:01,600 --> 00:23:04,880
we have a pass application

604
00:23:04,880 --> 00:23:08,320
a platform as a service so here i have

605
00:23:08,320 --> 00:23:09,360
my application

606
00:23:09,360 --> 00:23:12,720
deployed on app service

607
00:23:12,720 --> 00:23:15,919
it stored data in azure azure sql

608
00:23:15,919 --> 00:23:17,840
database

609
00:23:17,840 --> 00:23:20,000
and it doesn't store credentials

610
00:23:20,000 --> 00:23:22,320
directly on the web application

611
00:23:22,320 --> 00:23:25,679
so we store credentials in key vault

612
00:23:25,679 --> 00:23:29,280
um and and also credentials there will

613
00:23:29,280 --> 00:23:30,159
be

614
00:23:30,159 --> 00:23:34,159
rotated by this function

615
00:23:34,159 --> 00:23:37,679
and and also i have a application

616
00:23:37,679 --> 00:23:39,679
application firewall or vaf

617
00:23:39,679 --> 00:23:42,720
to protect application from outside so

618
00:23:42,720 --> 00:23:44,559
what how can we what can i do here

619
00:23:44,559 --> 00:23:46,880
uh how can i try to compromise this

620
00:23:46,880 --> 00:23:47,760
application probably

621
00:23:47,760 --> 00:23:51,120
my goal will be a sql database could

622
00:23:51,120 --> 00:23:53,440
because the data should be there but how

623
00:23:53,440 --> 00:23:54,159
can they

624
00:23:54,159 --> 00:23:55,840
do it where can i what should i where

625
00:23:55,840 --> 00:23:57,679
should they start

626
00:23:57,679 --> 00:24:01,440
um so of course i can start from

627
00:24:01,440 --> 00:24:04,640
uh web application but if i want to move

628
00:24:04,640 --> 00:24:04,960
on

629
00:24:04,960 --> 00:24:08,480
i must have my goals database and so if

630
00:24:08,480 --> 00:24:10,240
i look at the web application i will not

631
00:24:10,240 --> 00:24:12,000
find credentials there

632
00:24:12,000 --> 00:24:15,279
uh even if i get into the application so

633
00:24:15,279 --> 00:24:16,080
it should be some

634
00:24:16,080 --> 00:24:18,960
different path to to try to get into sql

635
00:24:18,960 --> 00:24:20,000
database

636
00:24:20,000 --> 00:24:24,320
and that is going to be this function

637
00:24:24,320 --> 00:24:26,320
uh of course this is less typical

638
00:24:26,320 --> 00:24:27,840
misconfiguration but let me

639
00:24:27,840 --> 00:24:29,679
but but but that's what we also

640
00:24:29,679 --> 00:24:30,880
sometimes find

641
00:24:30,880 --> 00:24:33,919
uh in our customers so when we have key

642
00:24:33,919 --> 00:24:37,120
vault and credentials there

643
00:24:37,120 --> 00:24:40,159
it's recommended by microsoft to rotate

644
00:24:40,159 --> 00:24:42,640
those credentials so it means it will it

645
00:24:42,640 --> 00:24:44,240
will use some function function

646
00:24:44,240 --> 00:24:46,240
which is serverless application if i

647
00:24:46,240 --> 00:24:48,080
know if you're more familiar with amazon

648
00:24:48,080 --> 00:24:49,279
it's like a lambda

649
00:24:49,279 --> 00:24:53,279
in amazon or function in azure um and so

650
00:24:53,279 --> 00:24:55,840
uh the special special function will run

651
00:24:55,840 --> 00:24:56,640
periodically

652
00:24:56,640 --> 00:24:57,919
based on some triggers and you may

653
00:24:57,919 --> 00:24:59,919
define triggers yourself

654
00:24:59,919 --> 00:25:03,120
and rotate the credential storton

655
00:25:03,120 --> 00:25:03,760
keyboard

656
00:25:03,760 --> 00:25:05,520
and sql database and sql database

657
00:25:05,520 --> 00:25:07,279
password as well

658
00:25:07,279 --> 00:25:10,559
so it will rotate those credentials

659
00:25:10,559 --> 00:25:12,960
application will will get transparently

660
00:25:12,960 --> 00:25:14,159
because because it has

661
00:25:14,159 --> 00:25:17,200
access onto key volt and so uh at the

662
00:25:17,200 --> 00:25:18,880
same time it will change the password

663
00:25:18,880 --> 00:25:20,559
and sql database

664
00:25:20,559 --> 00:25:23,760
and rotate this past the secret in

665
00:25:23,760 --> 00:25:26,720
keyword so what is the typical problem

666
00:25:26,720 --> 00:25:28,159
with this configuration

667
00:25:28,159 --> 00:25:31,279
so it seems very very secure but typical

668
00:25:31,279 --> 00:25:32,960
problem here

669
00:25:32,960 --> 00:25:35,600
because key vault companies know that

670
00:25:35,600 --> 00:25:36,799
key vault store

671
00:25:36,799 --> 00:25:39,919
it contains corporate secrets and

672
00:25:39,919 --> 00:25:40,880
they're very careful

673
00:25:40,880 --> 00:25:43,919
with kievault but

674
00:25:43,919 --> 00:25:47,039
when they have this function

675
00:25:47,039 --> 00:25:50,080
um what also may be found that they

676
00:25:50,080 --> 00:25:52,240
did not break inheritance and they still

677
00:25:52,240 --> 00:25:54,320
have this inherent permissions

678
00:25:54,320 --> 00:25:57,120
or either access to this function and

679
00:25:57,120 --> 00:25:58,880
let's see what i can do if i have access

680
00:25:58,880 --> 00:26:00,480
to font so i may not have access to key

681
00:26:00,480 --> 00:26:01,440
volt

682
00:26:01,440 --> 00:26:03,440
but i may have access to function also

683
00:26:03,440 --> 00:26:05,039
by the way keyboard has a separate

684
00:26:05,039 --> 00:26:08,080
separate configuration to get connected

685
00:26:08,080 --> 00:26:08,799
to keys

686
00:26:08,799 --> 00:26:11,919
but i may or six per seconds but i may

687
00:26:11,919 --> 00:26:14,559
have access to function

688
00:26:14,559 --> 00:26:17,200
and on behalf of function i can get

689
00:26:17,200 --> 00:26:17,760
access

690
00:26:17,760 --> 00:26:20,799
from this keyboard

691
00:26:20,799 --> 00:26:25,120
uh let's try that let's try that

692
00:26:25,120 --> 00:26:26,799
i'm going to switch back to my demo as

693
00:26:26,799 --> 00:26:28,720
usual and first i'm going to show you on

694
00:26:28,720 --> 00:26:29,679
the portal with

695
00:26:29,679 --> 00:26:30,880
the key vault itself

696
00:26:30,880 --> 00:26:33,760
[Music]

697
00:26:33,760 --> 00:26:36,960
so let me open the keyboard here and if

698
00:26:36,960 --> 00:26:39,840
i go to secrets

699
00:26:41,039 --> 00:26:44,400
look at this so it says um your policy

700
00:26:44,400 --> 00:26:44,799
not

701
00:26:44,799 --> 00:26:46,880
so the policy that configured at this

702
00:26:46,880 --> 00:26:49,039
moment does not allow you

703
00:26:49,039 --> 00:26:53,120
to see those values let me just quickly

704
00:26:53,120 --> 00:26:56,000
give myself permissions oh i don't have

705
00:26:56,000 --> 00:26:59,039
my permissions here at all

706
00:26:59,039 --> 00:27:03,039
let me just say

707
00:27:03,039 --> 00:27:05,520
just list just just allow the list

708
00:27:05,520 --> 00:27:06,799
permissions

709
00:27:06,799 --> 00:27:09,918
uh secrets

710
00:27:10,410 --> 00:27:13,479
[Music]

711
00:27:15,520 --> 00:27:19,360
save all right let's go back

712
00:27:19,360 --> 00:27:21,679
so i can i can i have two secrets here a

713
00:27:21,679 --> 00:27:23,919
username that's used by database

714
00:27:23,919 --> 00:27:27,360
uh and a password which is used by

715
00:27:27,360 --> 00:27:29,360
database as well

716
00:27:29,360 --> 00:27:31,760
now let me get permissions back so let

717
00:27:31,760 --> 00:27:34,799
me remove them

718
00:27:34,799 --> 00:27:37,520
i mean remove those permissions and now

719
00:27:37,520 --> 00:27:38,320
let's test

720
00:27:38,320 --> 00:27:41,360
this this function before i test that

721
00:27:41,360 --> 00:27:42,960
let me also show you how this function

722
00:27:42,960 --> 00:27:43,679
look like

723
00:27:43,679 --> 00:27:44,640
so i'm going to open function

724
00:27:44,640 --> 00:27:46,799
application and this function is by the

725
00:27:46,799 --> 00:27:48,000
way is deployed just right

726
00:27:48,000 --> 00:27:49,919
from the microsoft github from from from

727
00:27:49,919 --> 00:27:51,679
microsoft page

728
00:27:51,679 --> 00:27:54,559
and it's recommended let me go to

729
00:27:54,559 --> 00:27:55,760
functions

730
00:27:55,760 --> 00:27:57,679
and here here we have two functions

731
00:27:57,679 --> 00:28:01,120
first one is triggered by custom events

732
00:28:01,120 --> 00:28:02,960
second one will be triggered by http

733
00:28:02,960 --> 00:28:04,880
trigger

734
00:28:04,880 --> 00:28:07,919
all right so two functions here um

735
00:28:07,919 --> 00:28:10,880
now let me tell you about a problem with

736
00:28:10,880 --> 00:28:12,559
problems with configuration

737
00:28:12,559 --> 00:28:16,159
if i have permissions to read that what

738
00:28:16,159 --> 00:28:18,240
i can do

739
00:28:18,240 --> 00:28:20,399
by default there are two

740
00:28:20,399 --> 00:28:22,559
misconfigurations will be here

741
00:28:22,559 --> 00:28:24,880
misconfiguration number one companies

742
00:28:24,880 --> 00:28:26,720
they usually don't use

743
00:28:26,720 --> 00:28:29,760
ftp to publish their functions

744
00:28:29,760 --> 00:28:32,640
but by default ftp is turned on so

745
00:28:32,640 --> 00:28:34,799
that's the default ftp state to access

746
00:28:34,799 --> 00:28:35,600
function

747
00:28:35,600 --> 00:28:38,640
and say they don't turn off ftp

748
00:28:38,640 --> 00:28:41,919
access that's the first one

749
00:28:41,919 --> 00:28:43,919
first misconfigure second one i can read

750
00:28:43,919 --> 00:28:46,320
data and see what i can do here

751
00:28:46,320 --> 00:28:50,080
i can get pro get published profile

752
00:28:50,080 --> 00:28:52,240
and in this profile i will find ftp

753
00:28:52,240 --> 00:28:53,600
credentials

754
00:28:53,600 --> 00:28:56,880
so let's jump back to to

755
00:28:56,880 --> 00:29:00,720
my demo environment and let's do it oh

756
00:29:00,720 --> 00:29:03,760
let's close this and let's do it

757
00:29:03,760 --> 00:29:07,760
let's do it oh well let's do it from

758
00:29:07,760 --> 00:29:11,520
here because i will use filezilla

759
00:29:11,520 --> 00:29:14,159
for this purposes and so i don't need to

760
00:29:14,159 --> 00:29:18,000
jump from one window to another

761
00:29:18,559 --> 00:29:21,760
um so um let's first

762
00:29:21,760 --> 00:29:24,880
get a ftp address of this func

763
00:29:24,880 --> 00:29:27,600
function uplift of this function so let

764
00:29:27,600 --> 00:29:29,039
me function application

765
00:29:29,039 --> 00:29:32,720
let me copy this address place here

766
00:29:32,720 --> 00:29:34,640
and now i get i i want to have

767
00:29:34,640 --> 00:29:36,559
credentials

768
00:29:36,559 --> 00:29:40,000
command will look like this

769
00:29:40,000 --> 00:29:44,080
and now i have this

770
00:29:44,080 --> 00:29:46,720
username

771
00:29:47,200 --> 00:29:51,200
and password as well

772
00:29:51,200 --> 00:29:53,840
let's click connect now i have a bunch

773
00:29:53,840 --> 00:29:54,799
of folders here

774
00:29:54,799 --> 00:29:57,520
i i want to have this function which is

775
00:29:57,520 --> 00:29:57,840
uh

776
00:29:57,840 --> 00:30:01,200
triggered by by um hdb and what

777
00:30:01,200 --> 00:30:04,559
what i did uh i renamed the standard

778
00:30:04,559 --> 00:30:06,880
what like a previous function which is

779
00:30:06,880 --> 00:30:08,559
which was a partial script

780
00:30:08,559 --> 00:30:11,520
and i called to run one because the

781
00:30:11,520 --> 00:30:12,720
function that will run

782
00:30:12,720 --> 00:30:15,360
just must have this name and i place my

783
00:30:15,360 --> 00:30:16,159
own

784
00:30:16,159 --> 00:30:19,039
um my own partial code and this code

785
00:30:19,039 --> 00:30:21,039
will exfiltrate data

786
00:30:21,039 --> 00:30:23,760
from keyboard so let me get data from

787
00:30:23,760 --> 00:30:25,360
keyboard let me just

788
00:30:25,360 --> 00:30:29,440
run and this is it may be triggered by

789
00:30:29,440 --> 00:30:31,600
um http triggers so i can do it right

790
00:30:31,600 --> 00:30:33,360
from here let me let me just turn on

791
00:30:33,360 --> 00:30:34,720
this trigger

792
00:30:34,720 --> 00:30:37,840
and let's just wait for a moment before

793
00:30:37,840 --> 00:30:41,679
it's going to give me uh credentials

794
00:30:41,679 --> 00:30:45,039
should give me at least hopefully it

795
00:30:45,039 --> 00:30:47,279
will

796
00:30:47,600 --> 00:30:49,600
all right so in parallel let me open new

797
00:30:49,600 --> 00:30:52,080
tab uh because it will be

798
00:30:52,080 --> 00:30:54,799
super easy just close that and open

799
00:30:54,799 --> 00:30:55,760
filezilla again

800
00:30:55,760 --> 00:30:58,000
because we'll use that later on all

801
00:30:58,000 --> 00:30:59,600
right so now i have

802
00:30:59,600 --> 00:31:01,519
information from key vault so the

803
00:31:01,519 --> 00:31:03,440
username called webapp

804
00:31:03,440 --> 00:31:05,440
and the password is password and that's

805
00:31:05,440 --> 00:31:06,799
the credentials that

806
00:31:06,799 --> 00:31:09,200
application used to connect to database

807
00:31:09,200 --> 00:31:11,679
so i can try to connect database myself

808
00:31:11,679 --> 00:31:14,960
let's do it real quick so first of all

809
00:31:14,960 --> 00:31:17,440
i'm going to open sql mention studio and

810
00:31:17,440 --> 00:31:18,559
i can say here so

811
00:31:18,559 --> 00:31:20,399
here this address that does not trust

812
00:31:20,399 --> 00:31:22,720
them to

813
00:31:22,720 --> 00:31:26,159
my sequel not my sim and my sql course

814
00:31:26,159 --> 00:31:28,960
um so i connected normally and now let's

815
00:31:28,960 --> 00:31:30,640
try to do the same

816
00:31:30,640 --> 00:31:33,120
from the different machine i'll damn it

817
00:31:33,120 --> 00:31:36,959
so i need to have this address

818
00:31:38,360 --> 00:31:44,840
[Music]

819
00:31:44,840 --> 00:31:47,519
and

820
00:31:47,519 --> 00:31:50,640
look at this i cannot log connect from

821
00:31:50,640 --> 00:31:53,760
this machine because it says hey you the

822
00:31:53,760 --> 00:31:55,200
firewall in azure

823
00:31:55,200 --> 00:31:56,880
will not allow you to connect to

824
00:31:56,880 --> 00:31:59,039
database so you must whitelist this ip

825
00:31:59,039 --> 00:32:00,080
address and here

826
00:32:00,080 --> 00:32:02,399
so you must sign in with permissions the

827
00:32:02,399 --> 00:32:03,440
credentials that

828
00:32:03,440 --> 00:32:06,159
has permission they have permissions to

829
00:32:06,159 --> 00:32:08,000
manage firewall let me jump back to

830
00:32:08,000 --> 00:32:09,919
a portal and show you this firewall so

831
00:32:09,919 --> 00:32:11,039
if i go to

832
00:32:11,039 --> 00:32:14,640
sql database and

833
00:32:14,640 --> 00:32:16,720
open firewall so what you can find here

834
00:32:16,720 --> 00:32:18,480
so it doesn't have any rules

835
00:32:18,480 --> 00:32:21,840
except one rule this rule says

836
00:32:21,840 --> 00:32:24,559
allow azure services and the resources

837
00:32:24,559 --> 00:32:26,960
to access this server

838
00:32:26,960 --> 00:32:29,039
and that's another problem that i

839
00:32:29,039 --> 00:32:31,279
usually find in company environment

840
00:32:31,279 --> 00:32:33,360
because i i was able to log in from this

841
00:32:33,360 --> 00:32:35,600
machine because this machine in azure

842
00:32:35,600 --> 00:32:38,480
but this azure is it it's that's a

843
00:32:38,480 --> 00:32:39,519
different subscription

844
00:32:39,519 --> 00:32:43,120
that's a different region many companies

845
00:32:43,120 --> 00:32:43,519
think

846
00:32:43,519 --> 00:32:46,640
that if they if they say yes here

847
00:32:46,640 --> 00:32:49,919
they allow access of their or

848
00:32:49,919 --> 00:32:53,200
their resources that they have to

849
00:32:53,200 --> 00:32:55,519
this sql database like the virtual

850
00:32:55,519 --> 00:32:57,279
machine will be will have access

851
00:32:57,279 --> 00:33:00,399
uh no not at all any

852
00:33:00,399 --> 00:33:02,960
azure address from any customer from any

853
00:33:02,960 --> 00:33:04,640
region in the world

854
00:33:04,640 --> 00:33:07,279
if it belongs to azure will will have

855
00:33:07,279 --> 00:33:11,279
access to your database

856
00:33:11,279 --> 00:33:13,360
of course you must have username and

857
00:33:13,360 --> 00:33:14,720
password but

858
00:33:14,720 --> 00:33:17,200
firewall will not blocked so the better

859
00:33:17,200 --> 00:33:19,200
solution will be

860
00:33:19,200 --> 00:33:24,240
turn it off

861
00:33:24,240 --> 00:33:26,640
and deny public accidental so in this

862
00:33:26,640 --> 00:33:27,279
case

863
00:33:27,279 --> 00:33:31,279
um i can connect to a sql database

864
00:33:31,279 --> 00:33:33,760
only from my web application let me run

865
00:33:33,760 --> 00:33:35,279
my application

866
00:33:35,279 --> 00:33:36,799
by the way my application on the on a

867
00:33:36,799 --> 00:33:39,279
free tier so

868
00:33:39,279 --> 00:33:41,440
oh that's worked that works fine uh even

869
00:33:41,440 --> 00:33:42,480
though three tier

870
00:33:42,480 --> 00:33:43,919
oh no that's not the free gear anymore

871
00:33:43,919 --> 00:33:45,760
so i just i i migrate

872
00:33:45,760 --> 00:33:48,480
from free tier right before the the demo

873
00:33:48,480 --> 00:33:50,159
and so that's a simple application and i

874
00:33:50,159 --> 00:33:50,799
can just

875
00:33:50,799 --> 00:33:55,039
say something like hey um besides

876
00:33:55,039 --> 00:33:58,399
uh user and let me just add password as

877
00:33:58,399 --> 00:33:59,760
well

878
00:33:59,760 --> 00:34:03,039
oh sorry email um

879
00:34:03,039 --> 00:34:06,320
be at sites.com

880
00:34:06,320 --> 00:34:09,280
um and yeah yeah that that's working

881
00:34:09,280 --> 00:34:09,839
normally

882
00:34:09,839 --> 00:34:11,520
that's working fine this database it

883
00:34:11,520 --> 00:34:13,440
looks like a application has

884
00:34:13,440 --> 00:34:16,159
access to database normal access if i

885
00:34:16,159 --> 00:34:18,480
try to let me just reconnect

886
00:34:18,480 --> 00:34:22,159
to this database from azure machine

887
00:34:24,320 --> 00:34:26,079
but i don't have access anymore so it

888
00:34:26,079 --> 00:34:28,320
says uh access only allow

889
00:34:28,320 --> 00:34:30,320
only private access allowed so what i

890
00:34:30,320 --> 00:34:31,839
can do here

891
00:34:31,839 --> 00:34:35,040
i can try to access database from

892
00:34:35,040 --> 00:34:38,560
the actual application for this purposes

893
00:34:38,560 --> 00:34:41,119
i'm going to jump back to my demo so i

894
00:34:41,119 --> 00:34:41,839
think i have

895
00:34:41,839 --> 00:34:44,239
10 minutes i should speed up speed up a

896
00:34:44,239 --> 00:34:45,839
bit

897
00:34:45,839 --> 00:34:49,520
so let me just um

898
00:34:49,520 --> 00:34:51,918
get the ftp so i will do the same i'm

899
00:34:51,918 --> 00:34:53,280
still going to say

900
00:34:53,280 --> 00:34:56,639
i will get address um of ftp

901
00:34:56,639 --> 00:34:58,960
ftp address of this application let me

902
00:34:58,960 --> 00:35:00,160
just take this address

903
00:35:00,160 --> 00:35:01,920
because those applications they they use

904
00:35:01,920 --> 00:35:03,520
the same approach as

905
00:35:03,520 --> 00:35:06,720
uh kevo oh sorry here

906
00:35:06,720 --> 00:35:08,150
um it's here

907
00:35:08,150 --> 00:35:11,200
[Music]

908
00:35:11,200 --> 00:35:17,200
and let me oh the wrong one

909
00:35:17,200 --> 00:35:19,599
and let's take credentials as well and

910
00:35:19,599 --> 00:35:21,119
connect with ftp

911
00:35:21,119 --> 00:35:23,599
again

912
00:35:29,119 --> 00:35:31,920
all right so i can see here php page and

913
00:35:31,920 --> 00:35:33,680
just one one pager

914
00:35:33,680 --> 00:35:36,720
and you you can guess if if i have f

915
00:35:36,720 --> 00:35:38,480
php application i can upload my share i

916
00:35:38,480 --> 00:35:40,960
have ftp access i can upload my shell

917
00:35:40,960 --> 00:35:45,839
and execute on the server side

918
00:35:46,960 --> 00:35:50,000
oh damn it sorry

919
00:35:50,160 --> 00:35:54,720
and now i have access to this server

920
00:35:54,720 --> 00:35:56,560
all right the last problem i have last

921
00:35:56,560 --> 00:35:58,480
problem i have is

922
00:35:58,480 --> 00:36:01,200
um how can i connect with sql database i

923
00:36:01,200 --> 00:36:02,000
need to have some

924
00:36:02,000 --> 00:36:04,880
tools to connect but looks like uh i'm

925
00:36:04,880 --> 00:36:06,000
not an admin here

926
00:36:06,000 --> 00:36:08,800
oh by the way before i start to do

927
00:36:08,800 --> 00:36:10,480
anything let me establish the new

928
00:36:10,480 --> 00:36:12,480
new shell because this one is not super

929
00:36:12,480 --> 00:36:14,560
interactive you know that's a web shell

930
00:36:14,560 --> 00:36:18,800
um so let me just establish the new

931
00:36:18,800 --> 00:36:21,200
shell

932
00:36:25,040 --> 00:36:28,640
so let's see id so

933
00:36:28,640 --> 00:36:31,920
i just regular uh www user uh not

934
00:36:31,920 --> 00:36:33,119
privileged user

935
00:36:33,119 --> 00:36:35,200
so for this purposes i need to have

936
00:36:35,200 --> 00:36:36,640
something some tools that

937
00:36:36,640 --> 00:36:38,800
may work without installation and this

938
00:36:38,800 --> 00:36:40,800
tool is called useql

939
00:36:40,800 --> 00:36:44,160
usql this tool allow me to

940
00:36:44,160 --> 00:36:45,920
connect a database without installation

941
00:36:45,920 --> 00:36:49,200
so let me connect the database

942
00:36:49,280 --> 00:36:52,839
and it looks like i did let's try to get

943
00:36:52,839 --> 00:36:55,920
tables um

944
00:36:58,000 --> 00:36:59,920
a list of tables so i can see two tables

945
00:36:59,920 --> 00:37:02,640
here and let's try to

946
00:37:02,640 --> 00:37:08,000
get content of table called registration

947
00:37:08,000 --> 00:37:11,040
and now i have this besides user

948
00:37:11,040 --> 00:37:14,079
there all right so that's

949
00:37:14,079 --> 00:37:15,839
that's what i can do that's what i can

950
00:37:15,839 --> 00:37:17,119
do to

951
00:37:17,119 --> 00:37:20,320
um find uh the path to this application

952
00:37:20,320 --> 00:37:20,880
of course

953
00:37:20,880 --> 00:37:23,680
all of this that i show you here um i

954
00:37:23,680 --> 00:37:24,400
found

955
00:37:24,400 --> 00:37:26,960
partially for many companies it's not

956
00:37:26,960 --> 00:37:28,320
one company that has all of those

957
00:37:28,320 --> 00:37:29,440
vulnerabilities and mismix

958
00:37:29,440 --> 00:37:30,240
configurations

959
00:37:30,240 --> 00:37:33,520
more correct but some of those

960
00:37:33,520 --> 00:37:36,079
misconfigurations may be found

961
00:37:36,079 --> 00:37:38,079
many companies and i just combine all

962
00:37:38,079 --> 00:37:39,440
those things together

963
00:37:39,440 --> 00:37:41,359
all right so last last thing here last

964
00:37:41,359 --> 00:37:45,359
thing is we have application gateway

965
00:37:45,520 --> 00:37:48,960
application firewall um and

966
00:37:48,960 --> 00:37:51,119
what it is so i don't need i don't want

967
00:37:51,119 --> 00:37:52,480
to explain you what

968
00:37:52,480 --> 00:37:54,240
vaf is because that's a security

969
00:37:54,240 --> 00:37:56,000
conference probably all of you know what

970
00:37:56,000 --> 00:37:56,480
buff

971
00:37:56,480 --> 00:37:58,240
what puff is i just want to show you the

972
00:37:58,240 --> 00:38:01,119
built-in buff that we have in azure

973
00:38:01,119 --> 00:38:05,119
um and um so we have

974
00:38:05,119 --> 00:38:08,880
firewall on the gateway level and

975
00:38:08,880 --> 00:38:11,920
it's nothing more than very well known

976
00:38:11,920 --> 00:38:15,359
open source firewall

977
00:38:15,440 --> 00:38:18,560
um open source firewall

978
00:38:18,560 --> 00:38:20,240
forgot the name of the firewall open

979
00:38:20,240 --> 00:38:22,079
source uh

980
00:38:22,079 --> 00:38:26,800
dammit sorry um

981
00:38:26,800 --> 00:38:31,440
let me just go there and find that dress

982
00:38:31,440 --> 00:38:34,800
now let's try to and now let's try to

983
00:38:34,800 --> 00:38:38,079
run some some injections

984
00:38:38,560 --> 00:38:43,440
and accident access the knight

985
00:38:43,520 --> 00:38:47,680
um so i i i cannot run injection on this

986
00:38:47,680 --> 00:38:51,040
level so uh

987
00:38:51,040 --> 00:38:53,520
um and that is this buff which is all

988
00:38:53,520 --> 00:38:54,960
available in azure but of course if you

989
00:38:54,960 --> 00:38:55,760
wish you may

990
00:38:55,760 --> 00:39:00,960
try some other firewalls so um

991
00:39:00,960 --> 00:39:04,240
to be fair um that's

992
00:39:04,240 --> 00:39:06,320
that was my plan but it looks like we

993
00:39:06,320 --> 00:39:07,920
have six six more minutes so

994
00:39:07,920 --> 00:39:11,599
let me uh discuss with you uh how can we

995
00:39:11,599 --> 00:39:13,760
mitigate all of those things so you you

996
00:39:13,760 --> 00:39:14,880
saw here

997
00:39:14,880 --> 00:39:18,400
you saw here that we compromised

998
00:39:18,400 --> 00:39:19,920
three different environments and the

999
00:39:19,920 --> 00:39:22,160
typical question how can we

1000
00:39:22,160 --> 00:39:25,440
all right so we we now we know uh

1001
00:39:25,440 --> 00:39:28,400
we we have problems what to do with them

1002
00:39:28,400 --> 00:39:29,839
so let's start to

1003
00:39:29,839 --> 00:39:31,920
to try to fix them i will not show you

1004
00:39:31,920 --> 00:39:32,880
the like

1005
00:39:32,880 --> 00:39:35,200
all of those how to fix but give you

1006
00:39:35,200 --> 00:39:36,240
some ideas

1007
00:39:36,240 --> 00:39:38,400
what in the first scenario in the first

1008
00:39:38,400 --> 00:39:40,720
scenario when we have

1009
00:39:40,720 --> 00:39:45,680
um when we compromised um directory

1010
00:39:46,000 --> 00:39:48,320
very bad idea will be disabled password

1011
00:39:48,320 --> 00:39:49,119
hashing

1012
00:39:49,119 --> 00:39:51,440
no that's that's not that that not what

1013
00:39:51,440 --> 00:39:52,720
should we do

1014
00:39:52,720 --> 00:39:55,680
um is i know some companies that prefer

1015
00:39:55,680 --> 00:39:57,040
to disable that but

1016
00:39:57,040 --> 00:39:59,200
i don't recommend because you will have

1017
00:39:59,200 --> 00:40:01,200
more problems and benefits

1018
00:40:01,200 --> 00:40:05,680
but you should keep in mind ad connect

1019
00:40:05,680 --> 00:40:09,440
has may lead anyone

1020
00:40:09,440 --> 00:40:12,160
to domain admin permissions so if you

1021
00:40:12,160 --> 00:40:15,680
allow access to ad connect

1022
00:40:15,680 --> 00:40:18,720
then this user may become the main admin

1023
00:40:18,720 --> 00:40:21,920
easily so be careful about

1024
00:40:21,920 --> 00:40:24,720
who can manage i highly recommend you to

1025
00:40:24,720 --> 00:40:26,240
allow management of ad connect

1026
00:40:26,240 --> 00:40:29,280
only by the my administrators next one

1027
00:40:29,280 --> 00:40:32,319
this environment be careful about

1028
00:40:32,319 --> 00:40:33,040
permissions

1029
00:40:33,040 --> 00:40:36,839
keep in mind reader or either

1030
00:40:36,839 --> 00:40:40,240
reader just the reader

1031
00:40:40,240 --> 00:40:43,919
can do it so

1032
00:40:44,960 --> 00:40:47,040
do not allow did not give permissions of

1033
00:40:47,040 --> 00:40:48,480
even of reader

1034
00:40:48,480 --> 00:40:50,839
to the user who shouldn't have those

1035
00:40:50,839 --> 00:40:52,480
permissions

1036
00:40:52,480 --> 00:40:54,880
keep in mind even reader may be pretty

1037
00:40:54,880 --> 00:40:55,760
powerful

1038
00:40:55,760 --> 00:40:58,160
and finally let's take a look here uh

1039
00:40:58,160 --> 00:40:58,800
what

1040
00:40:58,800 --> 00:41:00,480
here here i can i can give you a bunch

1041
00:41:00,480 --> 00:41:02,000
of recommendations so first of all

1042
00:41:02,000 --> 00:41:03,920
uh credentials of key vault if we use

1043
00:41:03,920 --> 00:41:06,400
key rotation

1044
00:41:06,400 --> 00:41:08,000
the permissions here and permissions

1045
00:41:08,000 --> 00:41:09,839
here must be equal

1046
00:41:09,839 --> 00:41:13,440
so but uh unfortunately

1047
00:41:13,440 --> 00:41:16,800
fine typical case when we have um

1048
00:41:16,800 --> 00:41:19,760
smaller permissions here on on key vault

1049
00:41:19,760 --> 00:41:21,520
at the same time

1050
00:41:21,520 --> 00:41:23,280
some other users some administrators

1051
00:41:23,280 --> 00:41:24,640
middle level administrators

1052
00:41:24,640 --> 00:41:28,079
they have access to to actual

1053
00:41:28,079 --> 00:41:31,200
uh function that may rotate credentials

1054
00:41:31,200 --> 00:41:33,839
and then they use they may use of course

1055
00:41:33,839 --> 00:41:34,400
doesn't mean

1056
00:41:34,400 --> 00:41:37,040
they use that but but they may use a

1057
00:41:37,040 --> 00:41:38,160
function to

1058
00:41:38,160 --> 00:41:41,359
get data from application also disable

1059
00:41:41,359 --> 00:41:42,480
ftp

1060
00:41:42,480 --> 00:41:45,839
don't allow ftp here um because probably

1061
00:41:45,839 --> 00:41:47,599
don't use that

1062
00:41:47,599 --> 00:41:51,200
disable public access allow only private

1063
00:41:51,200 --> 00:41:51,760
access

1064
00:41:51,760 --> 00:41:53,920
even with proud even with private access

1065
00:41:53,920 --> 00:41:55,520
we can have access to

1066
00:41:55,520 --> 00:41:58,160
um internal the infrastructure i mean

1067
00:41:58,160 --> 00:41:59,520
the actual database

1068
00:41:59,520 --> 00:42:01,040
use new application but if you have

1069
00:42:01,040 --> 00:42:03,440
public access then

1070
00:42:03,440 --> 00:42:05,760
you're absolutely open to the world even

1071
00:42:05,760 --> 00:42:07,119
if you enable just

1072
00:42:07,119 --> 00:42:09,599
uh only even if you allow only from

1073
00:42:09,599 --> 00:42:11,520
azure

1074
00:42:11,520 --> 00:42:15,040
is still open to too many

1075
00:42:15,040 --> 00:42:17,119
not to everyone but for tomatoes and

1076
00:42:17,119 --> 00:42:20,160
finally vav

1077
00:42:20,160 --> 00:42:22,800
go ahead and use use buff it doesn't

1078
00:42:22,800 --> 00:42:23,440
have to be

1079
00:42:23,440 --> 00:42:28,560
a azure vav like built in azure

1080
00:42:28,839 --> 00:42:30,560
uh

1081
00:42:30,560 --> 00:42:34,880
um not doesn't have to be built in but

1082
00:42:34,880 --> 00:42:38,319
um um um it should be

1083
00:42:38,319 --> 00:42:39,760
last thing by the way about waffle i'm

1084
00:42:39,760 --> 00:42:42,000
gonna show you is uh when i

1085
00:42:42,000 --> 00:42:45,359
test this valve by one of the fuzzers

1086
00:42:45,359 --> 00:42:45,760
like

1087
00:42:45,760 --> 00:42:48,880
in this in my case it was loft ninja um

1088
00:42:48,880 --> 00:42:53,520
this built-in laugh showed me this so

1089
00:42:56,720 --> 00:42:59,760
by the way i finally remember the name

1090
00:42:59,760 --> 00:43:02,160
uh it's mod security you know open

1091
00:43:02,160 --> 00:43:03,760
source smart security

1092
00:43:03,760 --> 00:43:06,240
well-known software-based firewall but

1093
00:43:06,240 --> 00:43:06,800
they have

1094
00:43:06,800 --> 00:43:09,920
pretty uh well-configured rules so

1095
00:43:09,920 --> 00:43:12,800
all of those attempts to bypass to to to

1096
00:43:12,800 --> 00:43:14,480
bypass firewall

1097
00:43:14,480 --> 00:43:17,760
they were not successful i tried to to

1098
00:43:17,760 --> 00:43:19,440
to run signal injection and it didn't

1099
00:43:19,440 --> 00:43:20,720
work

1100
00:43:20,720 --> 00:43:23,839
um all right so now if you have any

1101
00:43:23,839 --> 00:43:24,480
questions

1102
00:43:24,480 --> 00:43:28,480
go ahead thanks sergey that was uh

1103
00:43:28,480 --> 00:43:31,520
an amazing uh talk and demo um one of

1104
00:43:31,520 --> 00:43:33,760
the things that blew my mind was the

1105
00:43:33,760 --> 00:43:36,800
access to any azure

1106
00:43:36,800 --> 00:43:38,640
um resource anywhere in the world for

1107
00:43:38,640 --> 00:43:40,560
any client any customer of azure that

1108
00:43:40,560 --> 00:43:41,119
was

1109
00:43:41,119 --> 00:43:42,640
crazy i don't even know why that's a

1110
00:43:42,640 --> 00:43:44,880
load but anyway um we only applied for

1111
00:43:44,880 --> 00:43:45,839
maybe one question

1112
00:43:45,839 --> 00:43:47,680
um one of them was that came in was how

1113
00:43:47,680 --> 00:43:49,359
do we guard against abuse of the reader

1114
00:43:49,359 --> 00:43:49,839
privilege

1115
00:43:49,839 --> 00:43:54,000
in vm based attacks

1116
00:43:54,000 --> 00:43:56,160
don't give permissions that's that

1117
00:43:56,160 --> 00:43:57,920
that's the mo that's obvious quite uh

1118
00:43:57,920 --> 00:43:58,880
answer because

1119
00:43:58,880 --> 00:44:00,960
uh oh let me give you a bit more details

1120
00:44:00,960 --> 00:44:02,160
here um so

1121
00:44:02,160 --> 00:44:05,200
reader role is a role that built in

1122
00:44:05,200 --> 00:44:08,160
don't use built-in roles so if i go to

1123
00:44:08,160 --> 00:44:09,280
roles here and

1124
00:44:09,280 --> 00:44:11,359
let me go to the level of a resource

1125
00:44:11,359 --> 00:44:12,560
group at least

1126
00:44:12,560 --> 00:44:16,079
if i click add oh sorry um i am

1127
00:44:16,079 --> 00:44:18,240
and click add role here is the custom

1128
00:44:18,240 --> 00:44:19,200
role

1129
00:44:19,200 --> 00:44:21,520
create custom roles with according to

1130
00:44:21,520 --> 00:44:23,599
principle of list privileges because

1131
00:44:23,599 --> 00:44:26,560
built-in roles they have to even if they

1132
00:44:26,560 --> 00:44:28,720
they sound like hey just they're either

1133
00:44:28,720 --> 00:44:31,520
uh they they they over privileged so

1134
00:44:31,520 --> 00:44:33,280
create custom roles and

1135
00:44:33,280 --> 00:44:35,119
provide only minimum privileges that you

1136
00:44:35,119 --> 00:44:37,359
really need to provide

1137
00:44:37,359 --> 00:44:39,280
very good that was uh that was an

1138
00:44:39,280 --> 00:44:49,280
excellent talk sergey thanks very much

