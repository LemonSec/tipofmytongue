1
00:00:00,000 --> 00:00:01,439
we're going to start with some thread

2
00:00:01,439 --> 00:00:02,879
hunting fundamentals I'm going to talk a

3
00:00:02,879 --> 00:00:05,400
little bit about how crowdstrike does it

4
00:00:05,400 --> 00:00:07,859
um but keep in mind these techniques can

5
00:00:07,859 --> 00:00:10,559
be used for any company and so we think

6
00:00:10,559 --> 00:00:12,420
we're pretty good at what we do but I

7
00:00:12,420 --> 00:00:13,559
don't want you to think this is a sales

8
00:00:13,559 --> 00:00:15,299
pitch this is something I think can be

9
00:00:15,299 --> 00:00:17,640
applicable to most organizations

10
00:00:17,640 --> 00:00:19,320
uh then we're going to take a brief look

11
00:00:19,320 --> 00:00:21,180
at uh Pioneer kitten that's the

12
00:00:21,180 --> 00:00:23,039
adversary we're talking about today talk

13
00:00:23,039 --> 00:00:25,260
about who they are who they target

14
00:00:25,260 --> 00:00:27,060
and then get into the meat of of the

15
00:00:27,060 --> 00:00:28,859
actual presentation which is the

16
00:00:28,859 --> 00:00:30,420
intrusion overview or intrusion

17
00:00:30,420 --> 00:00:32,040
walkthrough and that's going to be kind

18
00:00:32,040 --> 00:00:33,980
of a step-by-step of what we've seen

19
00:00:33,980 --> 00:00:37,620
this actor do in a specific intrusion

20
00:00:37,620 --> 00:00:39,660
and the final pieces yeah that's great

21
00:00:39,660 --> 00:00:41,399
what do we do about it because that's

22
00:00:41,399 --> 00:00:42,719
going to be the recommendation piece of

23
00:00:42,719 --> 00:00:45,960
this so let's go and get started

24
00:00:45,960 --> 00:00:48,480
so once again this is going to be a

25
00:00:48,480 --> 00:00:50,100
little bit about how we do it and why we

26
00:00:50,100 --> 00:00:52,920
do it first up why why is it necessary

27
00:00:52,920 --> 00:00:55,559
why is threat hunting a piece that

28
00:00:55,559 --> 00:00:57,980
should be fundamental to organizations

29
00:00:57,980 --> 00:01:00,059
defense portfolio

30
00:01:00,059 --> 00:01:02,460
and realistically it comes down to a

31
00:01:02,460 --> 00:01:04,319
couple of different things you know

32
00:01:04,319 --> 00:01:06,119
um as Garrett said in the previous talk

33
00:01:06,119 --> 00:01:09,119
we have access Brokers as well as spear

34
00:01:09,119 --> 00:01:11,400
fishing becoming bigger and bigger

35
00:01:11,400 --> 00:01:12,780
threats and so no longer are people

36
00:01:12,780 --> 00:01:15,560
having to find ways to get into your

37
00:01:15,560 --> 00:01:17,700
environment that would trigger perimeter

38
00:01:17,700 --> 00:01:19,740
controls now they have keys to the front

39
00:01:19,740 --> 00:01:21,720
door and so you need somebody looking on

40
00:01:21,720 --> 00:01:23,939
the other side of that door and finding

41
00:01:23,939 --> 00:01:25,259
those indicators that they're already in

42
00:01:25,259 --> 00:01:26,640
the system

43
00:01:26,640 --> 00:01:28,560
the other piece is we see a lot of them

44
00:01:28,560 --> 00:01:30,240
using native tools this intrusion

45
00:01:30,240 --> 00:01:31,979
doesn't have a single piece of software

46
00:01:31,979 --> 00:01:33,600
pulled down from the Internet or or

47
00:01:33,600 --> 00:01:36,060
brought with the the attackers this is

48
00:01:36,060 --> 00:01:38,040
all using native binaries within the

49
00:01:38,040 --> 00:01:40,140
Windows system this is a trend we're

50
00:01:40,140 --> 00:01:42,479
seeing time and time again and uh it

51
00:01:42,479 --> 00:01:43,860
makes them a lot sneakier you're no

52
00:01:43,860 --> 00:01:46,259
longer matching on hashes or

53
00:01:46,259 --> 00:01:47,700
um you know those file downloads and so

54
00:01:47,700 --> 00:01:49,740
this is why we do it

55
00:01:49,740 --> 00:01:51,540
a little bit about the different ways we

56
00:01:51,540 --> 00:01:52,680
go about it

57
00:01:52,680 --> 00:01:55,560
the first piece is going to be your

58
00:01:55,560 --> 00:01:57,180
statistical analysis and so that's hey

59
00:01:57,180 --> 00:01:59,520
what's weird in my environment now we

60
00:01:59,520 --> 00:02:01,140
have a bit of a leg up here on this to

61
00:02:01,140 --> 00:02:02,460
be fair we've got a lot of environments

62
00:02:02,460 --> 00:02:05,100
but even within a single organization's

63
00:02:05,100 --> 00:02:07,380
uh environment you should be looking for

64
00:02:07,380 --> 00:02:09,598
those outliers right you need to find

65
00:02:09,598 --> 00:02:11,340
what what programs are people running

66
00:02:11,340 --> 00:02:13,560
what scheduled tasks are there um what's

67
00:02:13,560 --> 00:02:15,780
strange and so that's where we start we

68
00:02:15,780 --> 00:02:17,280
have to do some retrospective analysis

69
00:02:17,280 --> 00:02:18,480
we'll talk about this a little bit later

70
00:02:18,480 --> 00:02:20,580
that's going to be great we found a new

71
00:02:20,580 --> 00:02:22,739
technique wait a second we we weren't

72
00:02:22,739 --> 00:02:24,900
looking for that let's go do that now

73
00:02:24,900 --> 00:02:26,700
right and so as we discover new things

74
00:02:26,700 --> 00:02:29,520
let's apply that to our previous uh data

75
00:02:29,520 --> 00:02:31,739
sets the last piece is hypothesis

76
00:02:31,739 --> 00:02:33,900
testing and so this is really the human

77
00:02:33,900 --> 00:02:35,459
side of this

78
00:02:35,459 --> 00:02:36,840
um where you're thinking well you know

79
00:02:36,840 --> 00:02:39,480
I've seen this this uh binary be renamed

80
00:02:39,480 --> 00:02:41,640
but it has this interesting flag I

81
00:02:41,640 --> 00:02:43,260
wonder if I can go find other renamed

82
00:02:43,260 --> 00:02:46,140
binaries using this same unique flag and

83
00:02:46,140 --> 00:02:48,060
so that's kind of like a I wonder if and

84
00:02:48,060 --> 00:02:50,160
then following that up so this is our

85
00:02:50,160 --> 00:02:51,540
high level strategies but let's talk

86
00:02:51,540 --> 00:02:52,980
about what a good thread hunting process

87
00:02:52,980 --> 00:02:54,360
looks like

88
00:02:54,360 --> 00:02:56,340
and so the first step of this is going

89
00:02:56,340 --> 00:02:57,660
to be and that

90
00:02:57,660 --> 00:02:59,879
let me take one step back we use the

91
00:02:59,879 --> 00:03:02,879
acronym sense or military search here to

92
00:03:02,879 --> 00:03:05,099
describe this process once again I don't

93
00:03:05,099 --> 00:03:06,540
want people walking away from this

94
00:03:06,540 --> 00:03:07,860
thinking this isn't applicable to your

95
00:03:07,860 --> 00:03:09,720
organizations and so while this is

96
00:03:09,720 --> 00:03:12,060
specifically crowdstrike language these

97
00:03:12,060 --> 00:03:13,800
Concepts still apply

98
00:03:13,800 --> 00:03:16,140
so the first uh the first step is going

99
00:03:16,140 --> 00:03:17,580
to be sense and at this point we're just

100
00:03:17,580 --> 00:03:19,379
Gathering Telemetry we're not passing

101
00:03:19,379 --> 00:03:21,720
any judgment on it and that Telemetry

102
00:03:21,720 --> 00:03:24,239
has all different kinds of elements to

103
00:03:24,239 --> 00:03:25,680
it that could be processes that are

104
00:03:25,680 --> 00:03:28,860
being ran uh you know DNS requests could

105
00:03:28,860 --> 00:03:30,720
be scheduled tasks and you know from

106
00:03:30,720 --> 00:03:32,340
contracts perspective this is all

107
00:03:32,340 --> 00:03:33,900
endpoint Focus but if you're doing

108
00:03:33,900 --> 00:03:36,239
Network detection it needs to be Network

109
00:03:36,239 --> 00:03:37,800
focused what what connections are being

110
00:03:37,800 --> 00:03:40,140
reached out the duration those pieces of

111
00:03:40,140 --> 00:03:41,640
information

112
00:03:41,640 --> 00:03:43,440
the next step is we need to enrich this

113
00:03:43,440 --> 00:03:45,780
for somebody to find some use out of

114
00:03:45,780 --> 00:03:47,519
this we need to start applying some

115
00:03:47,519 --> 00:03:49,739
properties to these so where is that DNS

116
00:03:49,739 --> 00:03:51,420
request reaching out to

117
00:03:51,420 --> 00:03:53,459
what is that process that's being ran

118
00:03:53,459 --> 00:03:56,340
what is the scheduled task right and so

119
00:03:56,340 --> 00:03:59,760
what happens is we end up with what we

120
00:03:59,760 --> 00:04:01,440
call threat hunting leads and these are

121
00:04:01,440 --> 00:04:02,879
things that we know are a little

122
00:04:02,879 --> 00:04:04,860
suspicious but there's no way we could

123
00:04:04,860 --> 00:04:07,019
send these to a sock we we can't be

124
00:04:07,019 --> 00:04:09,180
alerting customers or or getting the

125
00:04:09,180 --> 00:04:12,060
instant response uh Team brought up on

126
00:04:12,060 --> 00:04:13,620
this for every single one of these

127
00:04:13,620 --> 00:04:15,060
because they're they're a lot looser

128
00:04:15,060 --> 00:04:17,639
than your typical detections right these

129
00:04:17,639 --> 00:04:19,260
are are commands like who am I being

130
00:04:19,260 --> 00:04:21,358
rammed uh these are sometimes account

131
00:04:21,358 --> 00:04:23,639
creations and so what we look for is we

132
00:04:23,639 --> 00:04:25,139
look for clusters of this information

133
00:04:25,139 --> 00:04:27,960
operating on a single host or uh that

134
00:04:27,960 --> 00:04:30,600
are related in some way and so that's

135
00:04:30,600 --> 00:04:32,759
this next stage is analyzed we start

136
00:04:32,759 --> 00:04:34,620
clustering this and we say great we we

137
00:04:34,620 --> 00:04:36,300
have these these hunting leads that we

138
00:04:36,300 --> 00:04:39,060
we know can sometimes be malicious what

139
00:04:39,060 --> 00:04:40,860
other pieces of telemetry have we

140
00:04:40,860 --> 00:04:44,100
gathered and are those malicious as well

141
00:04:44,100 --> 00:04:46,259
right what about those let's dive into

142
00:04:46,259 --> 00:04:48,960
those a little bit deeper and I I want

143
00:04:48,960 --> 00:04:51,180
to point out here we gather all of this

144
00:04:51,180 --> 00:04:53,400
without any judgment and that's in my

145
00:04:53,400 --> 00:04:55,139
opinion the best way to do it because if

146
00:04:55,139 --> 00:04:57,360
there's anyone in this room that can

147
00:04:57,360 --> 00:04:58,620
look at a bunch of telemetry and

148
00:04:58,620 --> 00:05:00,180
immediately make it a judgment call and

149
00:05:00,180 --> 00:05:01,860
if it's good or bad and be 100 right

150
00:05:01,860 --> 00:05:04,020
please come let me know we want to hire

151
00:05:04,020 --> 00:05:06,720
you right and so

152
00:05:06,720 --> 00:05:08,220
um you need to be gathering all that so

153
00:05:08,220 --> 00:05:09,780
that way you can analyze it after the

154
00:05:09,780 --> 00:05:11,960
fact

155
00:05:12,540 --> 00:05:14,639
next is we're reconstructing right we're

156
00:05:14,639 --> 00:05:17,280
taking a look at the attacker did step

157
00:05:17,280 --> 00:05:20,340
one two three four and what that usually

158
00:05:20,340 --> 00:05:22,500
leads to is actually new new detections

159
00:05:22,500 --> 00:05:23,940
being made you see them up here in the

160
00:05:23,940 --> 00:05:25,440
blue

161
00:05:25,440 --> 00:05:27,060
um and we say oh we didn't know this

162
00:05:27,060 --> 00:05:29,039
technique existed it was a variation on

163
00:05:29,039 --> 00:05:31,320
an existing technique and so now we've

164
00:05:31,320 --> 00:05:33,539
expanded what we know a little bit

165
00:05:33,539 --> 00:05:35,340
and I'll be honest this next step

166
00:05:35,340 --> 00:05:37,680
communicate this is why we do it whether

167
00:05:37,680 --> 00:05:39,720
you're an internal threat hunting team

168
00:05:39,720 --> 00:05:41,580
that's providing this feedback to your

169
00:05:41,580 --> 00:05:44,100
IR team or your crowdstrike you're

170
00:05:44,100 --> 00:05:45,840
providing it to clients you need to

171
00:05:45,840 --> 00:05:48,660
isolate that that intrusion and somehow

172
00:05:48,660 --> 00:05:50,639
package it up and make sure that it gets

173
00:05:50,639 --> 00:05:52,500
to the right stakeholders right at the

174
00:05:52,500 --> 00:05:54,060
end of the day

175
00:05:54,060 --> 00:05:56,880
now once again this is why we do it but

176
00:05:56,880 --> 00:05:58,979
to be better at this step we need to

177
00:05:58,979 --> 00:06:00,900
also hone this and so we found these new

178
00:06:00,900 --> 00:06:02,100
hunting leads

179
00:06:02,100 --> 00:06:04,620
maybe we turn these into existing ones

180
00:06:04,620 --> 00:06:06,060
and then there's that retrospective

181
00:06:06,060 --> 00:06:09,780
analysis we apply it to other pieces of

182
00:06:09,780 --> 00:06:11,220
telemetry and start to find additional

183
00:06:11,220 --> 00:06:12,240
intrusions that we wouldn't have

184
00:06:12,240 --> 00:06:14,639
otherwise stopped

185
00:06:14,639 --> 00:06:16,860
so this is the the threat hunting

186
00:06:16,860 --> 00:06:18,300
methodology and once again this is what

187
00:06:18,300 --> 00:06:20,460
our OverWatch team does a traditional

188
00:06:20,460 --> 00:06:21,720
threat hunting team would do the same

189
00:06:21,720 --> 00:06:23,759
thing and the output this team is

190
00:06:23,759 --> 00:06:26,479
communication so speed is important

191
00:06:26,479 --> 00:06:28,860
brevity is important in those reports in

192
00:06:28,860 --> 00:06:31,319
terms of uh what mitigations need to be

193
00:06:31,319 --> 00:06:33,300
be done next

194
00:06:33,300 --> 00:06:35,400
I don't work on the OverWatch team I

195
00:06:35,400 --> 00:06:37,020
work on a fun team that sits in between

196
00:06:37,020 --> 00:06:40,020
that communicate and hone stage so my

197
00:06:40,020 --> 00:06:41,880
team is the Tactical intrusion research

198
00:06:41,880 --> 00:06:42,660
team

199
00:06:42,660 --> 00:06:45,060
and what we do is we do post mortem

200
00:06:45,060 --> 00:06:47,160
analysis on intrusions have been found

201
00:06:47,160 --> 00:06:50,280
and so the way I usually explain it is

202
00:06:50,280 --> 00:06:52,740
uh you know the hunters are finding the

203
00:06:52,740 --> 00:06:54,840
needles in in the haystack and then

204
00:06:54,840 --> 00:06:56,400
they're just handing us piles of needles

205
00:06:56,400 --> 00:06:58,620
and so from an exposure perspective it's

206
00:06:58,620 --> 00:07:01,500
pretty cool I get a great signal to

207
00:07:01,500 --> 00:07:04,319
noise ratio on what I get to look at and

208
00:07:04,319 --> 00:07:06,840
this presentation is a direct result of

209
00:07:06,840 --> 00:07:10,159
being in the middle of that process

210
00:07:13,560 --> 00:07:15,840
so

211
00:07:15,840 --> 00:07:18,900
a brief bit about Pioneer kitten first

212
00:07:18,900 --> 00:07:20,759
of all Garrett once again mentioned this

213
00:07:20,759 --> 00:07:21,780
I'm going to keep referencing him

214
00:07:21,780 --> 00:07:24,240
because he had a lot of good points

215
00:07:24,240 --> 00:07:25,620
um adversary attribution is actually

216
00:07:25,620 --> 00:07:27,960
really difficult it becomes really fuzzy

217
00:07:27,960 --> 00:07:30,240
and so there's two pieces of this

218
00:07:30,240 --> 00:07:31,620
um that become important you have your

219
00:07:31,620 --> 00:07:33,120
Atomic indicators that are things like

220
00:07:33,120 --> 00:07:35,759
IP addresses and domains

221
00:07:35,759 --> 00:07:37,740
um those can be easily faked those can

222
00:07:37,740 --> 00:07:39,840
be easily subverted right if we think

223
00:07:39,840 --> 00:07:41,819
about the Pyramid of pain those are easy

224
00:07:41,819 --> 00:07:44,039
for an adversary to swap out

225
00:07:44,039 --> 00:07:45,840
on the other side though these

226
00:07:45,840 --> 00:07:48,360
behavioral indicators are actually way

227
00:07:48,360 --> 00:07:49,979
more interesting a little bit more

228
00:07:49,979 --> 00:07:52,560
nuanced as well because not only are we

229
00:07:52,560 --> 00:07:55,380
looking at techniques and tools right

230
00:07:55,380 --> 00:07:57,660
um normally you know do a raise of hands

231
00:07:57,660 --> 00:07:58,500
here but I'm going to make the

232
00:07:58,500 --> 00:08:00,599
assumption that in this room we've had a

233
00:08:00,599 --> 00:08:02,039
lot of people go to different classes

234
00:08:02,039 --> 00:08:03,900
for either blue team or Red Team Tools

235
00:08:03,900 --> 00:08:05,940
you invested time you invested money to

236
00:08:05,940 --> 00:08:08,160
learn those techniques and if somebody

237
00:08:08,160 --> 00:08:09,840
said well yeah great I need you to do

238
00:08:09,840 --> 00:08:11,160
the same task you've been doing but I

239
00:08:11,160 --> 00:08:13,199
need to use a different tool there'd be

240
00:08:13,199 --> 00:08:15,539
a substantial investment required for

241
00:08:15,539 --> 00:08:17,280
you to pick up an alternative tool and

242
00:08:17,280 --> 00:08:18,240
the same thing is true for our

243
00:08:18,240 --> 00:08:20,039
adversaries and so figuring out what

244
00:08:20,039 --> 00:08:21,780
techniques they use and what tools

245
00:08:21,780 --> 00:08:23,759
you're using on a regular basis can help

246
00:08:23,759 --> 00:08:25,680
kind of cluster that activity around an

247
00:08:25,680 --> 00:08:27,180
actor

248
00:08:27,180 --> 00:08:28,500
the next thing up is command flag

249
00:08:28,500 --> 00:08:30,660
because you'd be surprised a lot of

250
00:08:30,660 --> 00:08:33,059
these companies I say companies criminal

251
00:08:33,059 --> 00:08:35,700
organizations like Conti have run books

252
00:08:35,700 --> 00:08:38,640
and so sometimes those operators are not

253
00:08:38,640 --> 00:08:40,679
actually as skilled as we may think and

254
00:08:40,679 --> 00:08:43,500
so when they see netstat Dash Nao they

255
00:08:43,500 --> 00:08:45,839
are always going to run the dash Nao in

256
00:08:45,839 --> 00:08:47,700
that order and so depending on order

257
00:08:47,700 --> 00:08:50,580
those flags are in or what types of

258
00:08:50,580 --> 00:08:51,839
flags right maybe they're using a dash

259
00:08:51,839 --> 00:08:54,480
dash and then a word we can start to get

260
00:08:54,480 --> 00:08:57,000
those patterns down the the one that I

261
00:08:57,000 --> 00:08:59,339
love is command mistakes we actually

262
00:08:59,339 --> 00:09:01,260
have some some tracking that looks at

263
00:09:01,260 --> 00:09:03,899
hey who's trying to run an interpreter

264
00:09:03,899 --> 00:09:06,300
command inside of a normal shell that

265
00:09:06,300 --> 00:09:08,339
tells us that whatever group this is is

266
00:09:08,339 --> 00:09:10,140
used to running interpreter and so

267
00:09:10,140 --> 00:09:11,640
there's all these little pieces that

268
00:09:11,640 --> 00:09:14,220
help identify that

269
00:09:14,220 --> 00:09:17,160
so specifically though today now keep in

270
00:09:17,160 --> 00:09:18,420
mind please don't ask me a ton of

271
00:09:18,420 --> 00:09:19,980
attribution questions I'm not on the

272
00:09:19,980 --> 00:09:21,060
Intel team

273
00:09:21,060 --> 00:09:23,160
um I I do get this information and we

274
00:09:23,160 --> 00:09:25,380
can use this to hunt deeper but today

275
00:09:25,380 --> 00:09:26,580
we're going to be looking at Pioneer

276
00:09:26,580 --> 00:09:29,760
kitten Pioneer kitten is a Iranian

277
00:09:29,760 --> 00:09:33,300
threat actor and um ideally they're

278
00:09:33,300 --> 00:09:34,680
they're targeting

279
00:09:34,680 --> 00:09:37,440
um IP r d they're looking for

280
00:09:37,440 --> 00:09:40,440
information so you know very different

281
00:09:40,440 --> 00:09:42,420
than Conti their motivation was clearly

282
00:09:42,420 --> 00:09:44,160
Financial

283
00:09:44,160 --> 00:09:46,800
um this this team is is targeting

284
00:09:46,800 --> 00:09:48,120
um countries all over the world quite

285
00:09:48,120 --> 00:09:49,080
frankly

286
00:09:49,080 --> 00:09:50,519
um but mainly

287
00:09:50,519 --> 00:09:53,279
um you know the US uh Israel and then

288
00:09:53,279 --> 00:09:55,140
some other Middle East these countries

289
00:09:55,140 --> 00:09:56,160
um maybe that's a little bit more

290
00:09:56,160 --> 00:09:58,260
politically motivated they're targeting

291
00:09:58,260 --> 00:10:02,220
uh Industries such as uh government uh

292
00:10:02,220 --> 00:10:04,380
Healthcare technology and defense and

293
00:10:04,380 --> 00:10:06,600
all those are surrounded

294
00:10:06,600 --> 00:10:09,779
um and focused on because of the

295
00:10:09,779 --> 00:10:11,160
information they have not necessarily

296
00:10:11,160 --> 00:10:13,080
the money they have right

297
00:10:13,080 --> 00:10:14,519
so

298
00:10:14,519 --> 00:10:17,279
a little bit of a few caveats here first

299
00:10:17,279 --> 00:10:19,740
things first I'm I'm not up here to

300
00:10:19,740 --> 00:10:22,320
rebuild a play-by-play second by second

301
00:10:22,320 --> 00:10:24,360
of this intrusion

302
00:10:24,360 --> 00:10:26,220
um I'm here to focus on the techniques

303
00:10:26,220 --> 00:10:27,660
that they use and so that's what we're

304
00:10:27,660 --> 00:10:28,860
going to be doing we'll be jumping and

305
00:10:28,860 --> 00:10:30,420
kind of clustering those in ways that

306
00:10:30,420 --> 00:10:32,220
make sense logically

307
00:10:32,220 --> 00:10:34,380
the other thing is I'm not too

308
00:10:34,380 --> 00:10:36,720
interested if whether it's falcon or

309
00:10:36,720 --> 00:10:38,519
whatever technique was blocked Maybe by

310
00:10:38,519 --> 00:10:40,740
Windows that's less relevant to me as

311
00:10:40,740 --> 00:10:42,660
well because these are techniques that

312
00:10:42,660 --> 00:10:44,279
are being attempted everyone's

313
00:10:44,279 --> 00:10:45,360
organization is going to be different

314
00:10:45,360 --> 00:10:46,680
your controls are going to be different

315
00:10:46,680 --> 00:10:48,839
and so I want to let you know what's

316
00:10:48,839 --> 00:10:51,000
being used out there in the wild

317
00:10:51,000 --> 00:10:53,820
um that's whether it impacted this

318
00:10:53,820 --> 00:10:55,320
particular client

319
00:10:55,320 --> 00:10:57,000
um you know negatively or not is

320
00:10:57,000 --> 00:10:59,040
irrelevant to everyone in this room so

321
00:10:59,040 --> 00:11:00,899
and the last piece is obviously we've

322
00:11:00,899 --> 00:11:02,579
redacted some information so anytime you

323
00:11:02,579 --> 00:11:04,560
see something in blue

324
00:11:04,560 --> 00:11:06,120
um that is an indication that's been

325
00:11:06,120 --> 00:11:07,380
replaced I didn't want to put big old

326
00:11:07,380 --> 00:11:09,360
redacted things it doesn't doesn't make

327
00:11:09,360 --> 00:11:11,100
those commands look super great and may

328
00:11:11,100 --> 00:11:12,600
confuse some people on where to look for

329
00:11:12,600 --> 00:11:14,399
for some of these files

330
00:11:14,399 --> 00:11:17,100
so let's Dive In

331
00:11:17,100 --> 00:11:19,200
first up now you know I should have

332
00:11:19,200 --> 00:11:20,459
learned from Garrett these these should

333
00:11:20,459 --> 00:11:22,500
be a little bit larger good news I don't

334
00:11:22,500 --> 00:11:23,700
need you to read these commands or their

335
00:11:23,700 --> 00:11:26,820
output what we see here is we see an

336
00:11:26,820 --> 00:11:28,019
adversary running some Discovery

337
00:11:28,019 --> 00:11:30,420
commands net user they found a user and

338
00:11:30,420 --> 00:11:33,000
then they went net user and actually

339
00:11:33,000 --> 00:11:35,760
pulled information specifically about a

340
00:11:35,760 --> 00:11:38,339
single user now this seems super basic

341
00:11:38,339 --> 00:11:39,779
and it is

342
00:11:39,779 --> 00:11:42,000
so why is it in the slide deck well

343
00:11:42,000 --> 00:11:44,339
you'd be shocked about how many

344
00:11:44,339 --> 00:11:46,680
adversaries land on a box and

345
00:11:46,680 --> 00:11:47,880
immediately start running Discovery

346
00:11:47,880 --> 00:11:50,579
commands whether that's netstat who am I

347
00:11:50,579 --> 00:11:53,700
uh net group net user it is something we

348
00:11:53,700 --> 00:11:55,860
see almost universally across all of our

349
00:11:55,860 --> 00:11:57,839
intrusions and so I don't want to

350
00:11:57,839 --> 00:11:59,880
underplay this this is a very important

351
00:11:59,880 --> 00:12:02,579
piece and um think about what users in

352
00:12:02,579 --> 00:12:04,140
your organization are also running these

353
00:12:04,140 --> 00:12:06,899
commands maybe admins

354
00:12:06,899 --> 00:12:08,399
you got an accounting shouldn't be

355
00:12:08,399 --> 00:12:09,600
running who am I he probably doesn't

356
00:12:09,600 --> 00:12:12,120
even know what that is right and so keep

357
00:12:12,120 --> 00:12:13,800
an eye on your your Discovery commands

358
00:12:13,800 --> 00:12:16,079
we saw a few others we saw netstat being

359
00:12:16,079 --> 00:12:18,000
ran which is going to pull live

360
00:12:18,000 --> 00:12:20,760
connections and that tells a you know an

361
00:12:20,760 --> 00:12:22,079
organization a little bit about where

362
00:12:22,079 --> 00:12:23,820
Services may be running on other boxes

363
00:12:23,820 --> 00:12:26,279
where other hosts may be or what

364
00:12:26,279 --> 00:12:27,959
services are running locally

365
00:12:27,959 --> 00:12:30,600
and the last piece is Q user this will

366
00:12:30,600 --> 00:12:32,100
come in important in a bit this is a

367
00:12:32,100 --> 00:12:34,260
query user command and this lets lets

368
00:12:34,260 --> 00:12:36,000
them know who's actively connected to

369
00:12:36,000 --> 00:12:37,500
the box and so that'll be relevant here

370
00:12:37,500 --> 00:12:39,800
in a bit

371
00:12:39,959 --> 00:12:42,240
next we saw some pretty basic uh

372
00:12:42,240 --> 00:12:43,320
persistence

373
00:12:43,320 --> 00:12:45,300
so we saw an account creation and then

374
00:12:45,300 --> 00:12:46,860
that account immediately got added to

375
00:12:46,860 --> 00:12:49,079
local administrators once again nothing

376
00:12:49,079 --> 00:12:50,760
crazy here that's going to be a running

377
00:12:50,760 --> 00:12:52,320
theme throughout this

378
00:12:52,320 --> 00:12:54,540
um we will get this more Technical and

379
00:12:54,540 --> 00:12:56,639
more interesting things but at no point

380
00:12:56,639 --> 00:12:59,700
was I like yeah the they went from this

381
00:12:59,700 --> 00:13:01,980
box to this box using magic

382
00:13:01,980 --> 00:13:04,139
um these adversaries are limited by the

383
00:13:04,139 --> 00:13:06,959
same TCP stocks and operating systems as

384
00:13:06,959 --> 00:13:09,480
we are and so a little bit of this is to

385
00:13:09,480 --> 00:13:12,600
demystify what they're using right sure

386
00:13:12,600 --> 00:13:14,279
are there more advanced versions of

387
00:13:14,279 --> 00:13:17,040
these techniques yeah absolutely but a

388
00:13:17,040 --> 00:13:18,000
lot of time we're seeing some Garden

389
00:13:18,000 --> 00:13:19,800
variety stuff even from nation state

390
00:13:19,800 --> 00:13:21,959
actors

391
00:13:21,959 --> 00:13:24,000
so a little bit more interesting

392
00:13:24,000 --> 00:13:24,779
um

393
00:13:24,779 --> 00:13:28,440
piece here for the persistence is they

394
00:13:28,440 --> 00:13:30,540
used a web show now something

395
00:13:30,540 --> 00:13:33,060
interesting depending on

396
00:13:33,060 --> 00:13:35,160
how an EDR agent or how you're

397
00:13:35,160 --> 00:13:37,500
collecting things from a host is working

398
00:13:37,500 --> 00:13:40,740
if they RDP into a box

399
00:13:40,740 --> 00:13:43,260
you may actually not see the commands

400
00:13:43,260 --> 00:13:45,899
ran because they're not using a you know

401
00:13:45,899 --> 00:13:47,880
a CMD they're not using a terminal they

402
00:13:47,880 --> 00:13:49,980
may be clicking through windows and so

403
00:13:49,980 --> 00:13:51,660
the you know all these previous ones the

404
00:13:51,660 --> 00:13:53,519
net user the account creation all that

405
00:13:53,519 --> 00:13:55,680
was done using command line and all of

406
00:13:55,680 --> 00:13:58,260
it was captured uh very clearly

407
00:13:58,260 --> 00:14:00,360
what if they just click on something

408
00:14:00,360 --> 00:14:02,579
how do we track that and so we're not

409
00:14:02,579 --> 00:14:04,560
this is not a forensics course this is

410
00:14:04,560 --> 00:14:05,880
not a forensics talk so we're not going

411
00:14:05,880 --> 00:14:08,040
to dive super deep into this

412
00:14:08,040 --> 00:14:09,120
um but I'm going to convince you by the

413
00:14:09,120 --> 00:14:10,440
end of this talk that Windows is spying

414
00:14:10,440 --> 00:14:11,639
on you and we can use that to our

415
00:14:11,639 --> 00:14:12,899
advantage

416
00:14:12,899 --> 00:14:17,339
so over here uh I have what I consider a

417
00:14:17,339 --> 00:14:19,200
mini start menu and so when you right

418
00:14:19,200 --> 00:14:21,000
click on an application it'll show you

419
00:14:21,000 --> 00:14:22,620
what you've opened recently with that

420
00:14:22,620 --> 00:14:25,440
super convenient anytime there's any of

421
00:14:25,440 --> 00:14:27,420
that convenience built in inherently we

422
00:14:27,420 --> 00:14:28,980
all know in this room that Windows must

423
00:14:28,980 --> 00:14:30,600
be tracking that somewhere

424
00:14:30,600 --> 00:14:34,139
and so this is called a jump list and

425
00:14:34,139 --> 00:14:35,700
this is it's kind of interesting because

426
00:14:35,700 --> 00:14:38,220
they don't make it super obvious

427
00:14:38,220 --> 00:14:40,260
um what jump list is associated with

428
00:14:40,260 --> 00:14:42,120
what application

429
00:14:42,120 --> 00:14:44,579
but this string up here this hideous

430
00:14:44,579 --> 00:14:45,600
string

431
00:14:45,600 --> 00:14:48,120
equates to notepad now how do we know

432
00:14:48,120 --> 00:14:50,880
that there are people who um have put in

433
00:14:50,880 --> 00:14:52,260
a lot more dedication a lot more time

434
00:14:52,260 --> 00:14:54,540
than I have and they've gone through and

435
00:14:54,540 --> 00:14:56,820
they've they've identified over 500

436
00:14:56,820 --> 00:14:59,100
different applications

437
00:14:59,100 --> 00:15:01,199
um and what jump lists are associated

438
00:15:01,199 --> 00:15:03,600
with those uh I've got the the site down

439
00:15:03,600 --> 00:15:05,699
here now of course that's unreadable for

440
00:15:05,699 --> 00:15:06,779
those of you in the back and then

441
00:15:06,779 --> 00:15:08,699
probably not useful for anyone wanting

442
00:15:08,699 --> 00:15:11,459
to jot it down but those jump list

443
00:15:11,459 --> 00:15:14,100
um indexes exist and it's super useful

444
00:15:14,100 --> 00:15:15,600
if you're wanting to kind of step back

445
00:15:15,600 --> 00:15:17,940
into something here so what we know from

446
00:15:17,940 --> 00:15:20,100
this slide is that they open Notepad

447
00:15:20,100 --> 00:15:22,139
that doesn't necessarily mean that they

448
00:15:22,139 --> 00:15:24,360
created a local web show

449
00:15:24,360 --> 00:15:26,820
but now we have link files link files

450
00:15:26,820 --> 00:15:29,519
are just shortcut files and anytime you

451
00:15:29,519 --> 00:15:31,800
see anything inside of the recent files

452
00:15:31,800 --> 00:15:35,639
section in your your Explorer you can

453
00:15:35,639 --> 00:15:37,980
actually navigate there you can go to

454
00:15:37,980 --> 00:15:40,079
your app data roaming Microsoft Windows

455
00:15:40,079 --> 00:15:42,060
recent and you can see what files have

456
00:15:42,060 --> 00:15:43,680
recently been accessed

457
00:15:43,680 --> 00:15:45,959
matter of fact I have what now seems to

458
00:15:45,959 --> 00:15:49,320
be a very small GIF a kind of showcasing

459
00:15:49,320 --> 00:15:51,360
this I'm opening things using the GUI

460
00:15:51,360 --> 00:15:54,060
and we're seeing them populate here

461
00:15:54,060 --> 00:15:57,959
we're not seeing it well but that's okay

462
00:15:57,959 --> 00:15:59,940
um and we also see a jump list being

463
00:15:59,940 --> 00:16:02,459
created here and as a result now we can

464
00:16:02,459 --> 00:16:04,019
leverage that and so keep in mind

465
00:16:04,019 --> 00:16:06,480
anytime there's Microsoft knows what you

466
00:16:06,480 --> 00:16:07,620
want to do whether that's from a

467
00:16:07,620 --> 00:16:09,240
performance perspective or a convenience

468
00:16:09,240 --> 00:16:11,160
perspective that's probably documented

469
00:16:11,160 --> 00:16:12,720
somewhere

470
00:16:12,720 --> 00:16:14,519
so they created a web show

471
00:16:14,519 --> 00:16:16,019
that's interesting on the local box

472
00:16:16,019 --> 00:16:17,399
right

473
00:16:17,399 --> 00:16:19,560
but then we start to see remote uh web

474
00:16:19,560 --> 00:16:21,839
show creation and this is something that

475
00:16:21,839 --> 00:16:23,279
I'll be honest I wasn't aware that you

476
00:16:23,279 --> 00:16:24,660
could do

477
00:16:24,660 --> 00:16:27,420
you can run notepad followed by a UNC

478
00:16:27,420 --> 00:16:28,500
path

479
00:16:28,500 --> 00:16:31,139
and you can just write a file it opens

480
00:16:31,139 --> 00:16:33,000
up notepad right on your machine you're

481
00:16:33,000 --> 00:16:35,160
modifying it you save it and boom it

482
00:16:35,160 --> 00:16:37,199
goes over to the other file pre-slick

483
00:16:37,199 --> 00:16:39,480
logical right I'm not surprised by this

484
00:16:39,480 --> 00:16:42,360
I just had never done it and so they did

485
00:16:42,360 --> 00:16:44,220
that across multiple machines I think

486
00:16:44,220 --> 00:16:47,279
five in total impacting multiple as uh

487
00:16:47,279 --> 00:16:50,399
PX files which are related to uh in this

488
00:16:50,399 --> 00:16:52,380
case an ISS server

489
00:16:52,380 --> 00:16:53,699
so

490
00:16:53,699 --> 00:16:54,779
of course

491
00:16:54,779 --> 00:16:57,060
they've modified configuration files now

492
00:16:57,060 --> 00:16:58,980
they need to restart the service

493
00:16:58,980 --> 00:17:01,620
and so I'm not going to go into this

494
00:17:01,620 --> 00:17:03,240
slide and how ugly this is but the

495
00:17:03,240 --> 00:17:04,559
things you need to know is there's a

496
00:17:04,559 --> 00:17:07,020
cache creation a task ran and a task

497
00:17:07,020 --> 00:17:08,099
deletion

498
00:17:08,099 --> 00:17:09,660
now if we make that a little bit easier

499
00:17:09,660 --> 00:17:11,280
to read

500
00:17:11,280 --> 00:17:13,199
we can see in here that they created

501
00:17:13,199 --> 00:17:14,880
something called server managements with

502
00:17:14,880 --> 00:17:17,220
an S not not sure why they they thought

503
00:17:17,220 --> 00:17:19,260
that was super stealthy

504
00:17:19,260 --> 00:17:20,579
um they're the schedule they're going to

505
00:17:20,579 --> 00:17:22,980
run it once and the command is ISS

506
00:17:22,980 --> 00:17:24,599
restart

507
00:17:24,599 --> 00:17:26,520
is really what it is they're resetting

508
00:17:26,520 --> 00:17:28,319
that server they have remote systems

509
00:17:28,319 --> 00:17:31,620
they have the admin credentials uh in

510
00:17:31,620 --> 00:17:33,179
this case it's a it's a fill-in but they

511
00:17:33,179 --> 00:17:35,220
have some user credentials and they want

512
00:17:35,220 --> 00:17:37,380
to run it as system and the start time

513
00:17:37,380 --> 00:17:39,059
is six o'clock it's now we think great

514
00:17:39,059 --> 00:17:43,500
now we just wait oh no they they created

515
00:17:43,500 --> 00:17:46,679
it and then they ran a command to run it

516
00:17:46,679 --> 00:17:48,780
and then they deleted it and so it's

517
00:17:48,780 --> 00:17:50,340
really just a way to execute a command

518
00:17:50,340 --> 00:17:52,080
on another machine

519
00:17:52,080 --> 00:17:54,840
so if this is I think an important piece

520
00:17:54,840 --> 00:17:57,000
here now they waited 27 minutes between

521
00:17:57,000 --> 00:17:59,280
the file modification and the scheduled

522
00:17:59,280 --> 00:18:01,140
task creation

523
00:18:01,140 --> 00:18:03,960
um the piece here is that if you're

524
00:18:03,960 --> 00:18:06,059
running periodic queries on your

525
00:18:06,059 --> 00:18:07,980
scheduled task you may think that you're

526
00:18:07,980 --> 00:18:09,360
able to find anything related to

527
00:18:09,360 --> 00:18:11,039
scheduled tasks but if you're running it

528
00:18:11,039 --> 00:18:12,960
at five minute intervals there's a

529
00:18:12,960 --> 00:18:14,039
pretty good chance you actually missed

530
00:18:14,039 --> 00:18:15,780
this one it was only alive for about a

531
00:18:15,780 --> 00:18:17,640
minute God forbid you're doing every 30

532
00:18:17,640 --> 00:18:20,580
minutes and so those types of defenses

533
00:18:20,580 --> 00:18:22,500
are work great against a long-term

534
00:18:22,500 --> 00:18:23,700
persistence if they're wanting to

535
00:18:23,700 --> 00:18:26,580
re-establish a a shell but in this case

536
00:18:26,580 --> 00:18:28,320
you probably missed it because it was

537
00:18:28,320 --> 00:18:29,460
just up for a second to execute

538
00:18:29,460 --> 00:18:30,480
something

539
00:18:30,480 --> 00:18:33,080
foreign

540
00:18:33,140 --> 00:18:35,460
we switched from persistence to lateral

541
00:18:35,460 --> 00:18:37,740
movement because it's it's complicated

542
00:18:37,740 --> 00:18:38,580
it's complicated when you start

543
00:18:38,580 --> 00:18:40,140
bucketizing things but it's that same

544
00:18:40,140 --> 00:18:41,580
technique they use for persistence now

545
00:18:41,580 --> 00:18:43,740
they're moving laterally uh and able to

546
00:18:43,740 --> 00:18:47,179
get those web shows on other boxes

547
00:18:49,919 --> 00:18:52,140
so this is an interesting one this is

548
00:18:52,140 --> 00:18:54,000
interesting because I was 100 wrong

549
00:18:54,000 --> 00:18:56,280
about what I thought it did

550
00:18:56,280 --> 00:18:59,039
this is a registry key along the top and

551
00:18:59,039 --> 00:19:01,320
it's for terminal services

552
00:19:01,320 --> 00:19:03,780
and the value is I'm sorry the key is

553
00:19:03,780 --> 00:19:05,039
shadow

554
00:19:05,039 --> 00:19:06,720
and you can actually set this Shadow

555
00:19:06,720 --> 00:19:09,780
value to one or zero through four so you

556
00:19:09,780 --> 00:19:10,980
have five options

557
00:19:10,980 --> 00:19:13,020
and it equates to

558
00:19:13,020 --> 00:19:15,360
um you know going through the system and

559
00:19:15,360 --> 00:19:17,820
actually modifying uh my spotlight's not

560
00:19:17,820 --> 00:19:18,960
working but on the right hand side you

561
00:19:18,960 --> 00:19:21,419
see the GUI version of that it allows

562
00:19:21,419 --> 00:19:23,700
you to say hey when I Shadow a session

563
00:19:23,700 --> 00:19:26,160
either I can full out deny remote

564
00:19:26,160 --> 00:19:28,620
control I can obtain the user permission

565
00:19:28,620 --> 00:19:32,220
to view or edit or um I can just bypass

566
00:19:32,220 --> 00:19:34,260
that and don't ask for anything and

567
00:19:34,260 --> 00:19:35,640
that's absolutely what they did they set

568
00:19:35,640 --> 00:19:37,080
it to two

569
00:19:37,080 --> 00:19:39,360
now when I went to go test this I said

570
00:19:39,360 --> 00:19:42,000
great this is for RDP completely

571
00:19:42,000 --> 00:19:43,140
ignoring the fact that it's a shadow

572
00:19:43,140 --> 00:19:44,340
value

573
00:19:44,340 --> 00:19:45,780
um I was like great this is for RDP and

574
00:19:45,780 --> 00:19:47,220
I tested that out and there's a prompt

575
00:19:47,220 --> 00:19:49,380
for that but this specifically is to

576
00:19:49,380 --> 00:19:51,539
piggyback off of the existing RDP

577
00:19:51,539 --> 00:19:53,580
connections right shadowing sessions

578
00:19:53,580 --> 00:19:55,500
that already existing and so that's why

579
00:19:55,500 --> 00:19:57,900
that Q user was important they can see

580
00:19:57,900 --> 00:20:00,480
what what sessions exist

581
00:20:00,480 --> 00:20:03,059
little little flow chart here

582
00:20:03,059 --> 00:20:06,059
um so that would allow an adversary to

583
00:20:06,059 --> 00:20:10,080
run this mstfc which is used for RDP

584
00:20:10,080 --> 00:20:12,660
they can run the shadow command

585
00:20:12,660 --> 00:20:15,900
um they can this is the session uh that

586
00:20:15,900 --> 00:20:16,860
they're actually wanting to Shadow

587
00:20:16,860 --> 00:20:18,840
they're wanting to control versus view

588
00:20:18,840 --> 00:20:19,679
it

589
00:20:19,679 --> 00:20:21,299
and the last piece is the no consent

590
00:20:21,299 --> 00:20:22,799
prompt now you may think that should be

591
00:20:22,799 --> 00:20:25,020
enough if they run that there's probably

592
00:20:25,020 --> 00:20:26,280
still going to be a problem depending on

593
00:20:26,280 --> 00:20:27,539
the settings of that machine that

594
00:20:27,539 --> 00:20:29,280
they're wanting to remote into and then

595
00:20:29,280 --> 00:20:31,799
it's up to the the admin or the user on

596
00:20:31,799 --> 00:20:33,539
that box to say yes I want to allow this

597
00:20:33,539 --> 00:20:36,360
or no I don't and so if they say no you

598
00:20:36,360 --> 00:20:37,980
get kicked right out if they say yes

599
00:20:37,980 --> 00:20:39,840
great you have that shadow session

600
00:20:39,840 --> 00:20:42,780
established once you set that registry

601
00:20:42,780 --> 00:20:44,400
key you're bypassing that entirely and

602
00:20:44,400 --> 00:20:45,900
you're shadowing a meteor

603
00:20:45,900 --> 00:20:47,700
and so that's where these things become

604
00:20:47,700 --> 00:20:50,460
a little bit spooky

605
00:20:50,460 --> 00:20:52,860
next one up once again Windows is spying

606
00:20:52,860 --> 00:20:54,240
on you so anytime you click on a drop

607
00:20:54,240 --> 00:20:55,260
down and she's like great these are

608
00:20:55,260 --> 00:20:56,640
things that I've used this is useful

609
00:20:56,640 --> 00:20:59,520
that's stored somewhere and in a lot of

610
00:20:59,520 --> 00:21:01,980
cases it's it's beneficial for us to be

611
00:21:01,980 --> 00:21:03,960
able to go look at those and and pull

612
00:21:03,960 --> 00:21:06,480
that information but a little bit more

613
00:21:06,480 --> 00:21:07,679
advanced adversaries are starting to

614
00:21:07,679 --> 00:21:09,179
clear these out as they move throughout

615
00:21:09,179 --> 00:21:10,440
an environment and that's exactly what

616
00:21:10,440 --> 00:21:11,940
happened here you can see in the top

617
00:21:11,940 --> 00:21:14,820
right or top left a delete command for

618
00:21:14,820 --> 00:21:16,799
this registry key terminal servers

619
00:21:16,799 --> 00:21:19,620
server client servers and default

620
00:21:19,620 --> 00:21:21,360
so if we look over here on the right

621
00:21:21,360 --> 00:21:24,480
hand side it's fairly illegible you also

622
00:21:24,480 --> 00:21:26,160
have to take my word for it but under

623
00:21:26,160 --> 00:21:28,679
terminal server client we see the IPS

624
00:21:28,679 --> 00:21:30,780
listed here that are the same in the

625
00:21:30,780 --> 00:21:31,799
drop down

626
00:21:31,799 --> 00:21:33,419
we can see a gif here of clearing those

627
00:21:33,419 --> 00:21:35,520
out and what actually happens and so we

628
00:21:35,520 --> 00:21:37,260
see a lot of adversaries starting to

629
00:21:37,260 --> 00:21:38,940
clean up after themselves

630
00:21:38,940 --> 00:21:40,559
um especially the better known register

631
00:21:40,559 --> 00:21:43,020
Keys such as something like this

632
00:21:43,020 --> 00:21:45,539
um we'll see that closed and it opens

633
00:21:45,539 --> 00:21:48,600
back up fun fact we still have at least

634
00:21:48,600 --> 00:21:50,100
one value in there and I don't know

635
00:21:50,100 --> 00:21:51,539
where that's stored so that's a little

636
00:21:51,539 --> 00:21:54,240
bit more research for me to figure out

637
00:21:54,240 --> 00:21:56,039
um I expected this to be a lot cleaner

638
00:21:56,039 --> 00:21:57,960
but all those drop downs are gone so

639
00:21:57,960 --> 00:21:59,940
that's still stored somewhere more work

640
00:21:59,940 --> 00:22:03,020
is is required there

641
00:22:03,480 --> 00:22:05,580
next thing this is a fun one

642
00:22:05,580 --> 00:22:09,240
um W digest is is has been used in the

643
00:22:09,240 --> 00:22:10,020
past

644
00:22:10,020 --> 00:22:12,900
um by adversaries because when a user

645
00:22:12,900 --> 00:22:14,460
would log in

646
00:22:14,460 --> 00:22:16,260
they would store credentials in clear

647
00:22:16,260 --> 00:22:19,260
text and obviously that's that's a

648
00:22:19,260 --> 00:22:20,760
that's not good for a lot of reasons to

649
00:22:20,760 --> 00:22:22,740
store them in clear text in memory and

650
00:22:22,740 --> 00:22:25,740
so around 2014 Windows said great we've

651
00:22:25,740 --> 00:22:27,539
got to fix this this is a problem

652
00:22:27,539 --> 00:22:30,299
and they removed that registry key

653
00:22:30,299 --> 00:22:32,580
but in 2022 as I stand on this stage

654
00:22:32,580 --> 00:22:34,860
right now if you go create that registry

655
00:22:34,860 --> 00:22:36,080
key

656
00:22:36,080 --> 00:22:41,400
and set it to use logon credential it

657
00:22:41,400 --> 00:22:43,200
actually re-enables this and so it's

658
00:22:43,200 --> 00:22:44,460
kind of interesting that like their

659
00:22:44,460 --> 00:22:45,720
patch was just like we'll get rid of it

660
00:22:45,720 --> 00:22:47,100
and like nobody will think to add it

661
00:22:47,100 --> 00:22:48,179
back

662
00:22:48,179 --> 00:22:50,039
um but I mean like that's the

663
00:22:50,039 --> 00:22:51,539
technological debt that Windows also has

664
00:22:51,539 --> 00:22:53,340
to work through right they have systems

665
00:22:53,340 --> 00:22:55,380
that rely on register keys that have

666
00:22:55,380 --> 00:22:56,640
been around for ages right and it's

667
00:22:56,640 --> 00:22:59,220
built stacks on Stacks and stacks

668
00:22:59,220 --> 00:23:01,140
um so what do we see them do originally

669
00:23:01,140 --> 00:23:03,720
is they they query this W digest and

670
00:23:03,720 --> 00:23:05,820
they try to find the string use logon

671
00:23:05,820 --> 00:23:07,140
credential

672
00:23:07,140 --> 00:23:09,780
and this is a screenshot from my machine

673
00:23:09,780 --> 00:23:12,059
but I have a feeling this is what the

674
00:23:12,059 --> 00:23:14,000
adversary saw because

675
00:23:14,000 --> 00:23:16,320
if they they didn't find that used

676
00:23:16,320 --> 00:23:19,679
logarithm credential as a as a value

677
00:23:19,679 --> 00:23:21,179
they probably added it and that's

678
00:23:21,179 --> 00:23:22,919
exactly what they did now this is a bad

679
00:23:22,919 --> 00:23:24,179
example because I think I copied and

680
00:23:24,179 --> 00:23:26,280
pasted this should say add and they

681
00:23:26,280 --> 00:23:28,620
added the use logon credential and so

682
00:23:28,620 --> 00:23:30,179
what does that do for them when they add

683
00:23:30,179 --> 00:23:33,179
that now we didn't see Mimi cats were in

684
00:23:33,179 --> 00:23:34,919
um we didn't see any indication that the

685
00:23:34,919 --> 00:23:37,080
LSS process was pulled or any other kind

686
00:23:37,080 --> 00:23:39,840
of credential pulls but think about that

687
00:23:39,840 --> 00:23:43,320
it stores credentials in clear text

688
00:23:43,320 --> 00:23:46,039
it doesn't convert existing sessions

689
00:23:46,039 --> 00:23:48,600
credentials into memory you have to wait

690
00:23:48,600 --> 00:23:50,280
until somebody else logs in and so this

691
00:23:50,280 --> 00:23:52,140
shows a little bit about intent that

692
00:23:52,140 --> 00:23:54,480
shows that they're probably going to lie

693
00:23:54,480 --> 00:23:55,799
low for a little bit wait for some

694
00:23:55,799 --> 00:23:57,120
people to log in maybe that's instant

695
00:23:57,120 --> 00:23:58,860
responders with domain credentials right

696
00:23:58,860 --> 00:24:01,679
and pull those credentials out and so of

697
00:24:01,679 --> 00:24:03,780
course I'm I'm not as talented on red

698
00:24:03,780 --> 00:24:05,940
team as many of our adversaries and so I

699
00:24:05,940 --> 00:24:07,799
just installed mimikats and disabled a

700
00:24:07,799 --> 00:24:08,820
bunch of stuff

701
00:24:08,820 --> 00:24:11,039
and uh when I ran it before the password

702
00:24:11,039 --> 00:24:12,360
was null

703
00:24:12,360 --> 00:24:14,400
and when I pulled W digest after I set

704
00:24:14,400 --> 00:24:16,740
that register key we see the password in

705
00:24:16,740 --> 00:24:18,299
plain text there and so there's not even

706
00:24:18,299 --> 00:24:21,120
any any uh you know cracking that needs

707
00:24:21,120 --> 00:24:23,600
to be done there

708
00:24:23,700 --> 00:24:25,740
so with all that said what do we what do

709
00:24:25,740 --> 00:24:27,419
we do about all that

710
00:24:27,419 --> 00:24:30,240
we break down everything we saw

711
00:24:30,240 --> 00:24:32,159
there's really four things that concern

712
00:24:32,159 --> 00:24:33,240
me here

713
00:24:33,240 --> 00:24:34,919
um you know that you could you I left

714
00:24:34,919 --> 00:24:37,140
out the the web shell uh creation it's

715
00:24:37,140 --> 00:24:38,640
really hard to be like I'm gonna audit

716
00:24:38,640 --> 00:24:40,260
every time somebody changes a text file

717
00:24:40,260 --> 00:24:42,659
like that's that's kind of tough

718
00:24:42,659 --> 00:24:44,880
um but we can look at account Creations

719
00:24:44,880 --> 00:24:46,799
Discovery commands schedule tasks and

720
00:24:46,799 --> 00:24:49,380
register Keys register changes those are

721
00:24:49,380 --> 00:24:51,059
all valid things that I think we can get

722
00:24:51,059 --> 00:24:55,740
a handle on as as a community right

723
00:24:55,740 --> 00:24:57,960
uh this may be a little bit small to see

724
00:24:57,960 --> 00:25:00,000
but I I've put some data sources you're

725
00:25:00,000 --> 00:25:01,080
going to need to be able to do anything

726
00:25:01,080 --> 00:25:03,480
with these not an extensive list I'm

727
00:25:03,480 --> 00:25:05,820
sure there are some um interesting uh

728
00:25:05,820 --> 00:25:07,380
virtual registry keys that I've missed

729
00:25:07,380 --> 00:25:09,960
from a blue team perspective but a lot

730
00:25:09,960 --> 00:25:10,980
of these

731
00:25:10,980 --> 00:25:13,320
um are some some fairly loving fruit to

732
00:25:13,320 --> 00:25:14,940
gather

733
00:25:14,940 --> 00:25:16,679
some companies don't have EDR and so you

734
00:25:16,679 --> 00:25:18,179
have Windows Event IDs that'll cover

735
00:25:18,179 --> 00:25:20,400
most of the stuff that we need to look

736
00:25:20,400 --> 00:25:21,480
at

737
00:25:21,480 --> 00:25:22,740
um but ideally you'd want to get that

738
00:25:22,740 --> 00:25:24,900
EDR Telemetry because now you're not

739
00:25:24,900 --> 00:25:26,760
worried about audit policies you're not

740
00:25:26,760 --> 00:25:28,140
worried about forwarding logs you're not

741
00:25:28,140 --> 00:25:30,120
worried about any of those queuing

742
00:25:30,120 --> 00:25:32,279
Services a lot of the time

743
00:25:32,279 --> 00:25:34,200
and if you're if you're Gathering that

744
00:25:34,200 --> 00:25:35,820
that host Telemetry you want to look at

745
00:25:35,820 --> 00:25:38,100
command line scheduled task created

746
00:25:38,100 --> 00:25:39,720
users and then usually being added a

747
00:25:39,720 --> 00:25:41,820
tasks right now can't look at all of

748
00:25:41,820 --> 00:25:43,140
those so we'll go over some techniques

749
00:25:43,140 --> 00:25:44,820
and some some methods to look at that

750
00:25:44,820 --> 00:25:47,460
and then last but not least querying

751
00:25:47,460 --> 00:25:49,260
Live host right you need some way to do

752
00:25:49,260 --> 00:25:51,179
that to find existing scheduled tasks

753
00:25:51,179 --> 00:25:53,760
existing register keys

754
00:25:53,760 --> 00:25:56,760
so first up account Creations you got to

755
00:25:56,760 --> 00:25:57,960
figure out how accounts are created in

756
00:25:57,960 --> 00:26:00,299
your environment right um it's one thing

757
00:26:00,299 --> 00:26:01,740
to go by a set of benchmarks and say

758
00:26:01,740 --> 00:26:03,419
this should happen this way and that's

759
00:26:03,419 --> 00:26:04,140
it

760
00:26:04,140 --> 00:26:06,000
guess what if you have some automated

761
00:26:06,000 --> 00:26:08,520
system to create users and it's you know

762
00:26:08,520 --> 00:26:10,080
handed from one service account over to

763
00:26:10,080 --> 00:26:11,460
another and all of a sudden you have an

764
00:26:11,460 --> 00:26:12,659
account at the end of this magical

765
00:26:12,659 --> 00:26:14,700
pipeline that the devops have created

766
00:26:14,700 --> 00:26:16,559
you probably can't use the same auto

767
00:26:16,559 --> 00:26:18,360
policy as somebody who you know Bob

768
00:26:18,360 --> 00:26:20,580
admin down the hallway is creating users

769
00:26:20,580 --> 00:26:22,380
so you need to figure out what that path

770
00:26:22,380 --> 00:26:24,419
looks like for your users and find

771
00:26:24,419 --> 00:26:26,039
deviations from that so find out when

772
00:26:26,039 --> 00:26:27,419
that service account isn't the one that

773
00:26:27,419 --> 00:26:30,960
created uh that user now this last one

774
00:26:30,960 --> 00:26:32,940
this seems silly I'll be honest this

775
00:26:32,940 --> 00:26:34,559
last bullet is investigative account

776
00:26:34,559 --> 00:26:37,260
Creations during off work hours hey I

777
00:26:37,260 --> 00:26:38,220
don't know about you I don't have that

778
00:26:38,220 --> 00:26:39,960
many off work hours I'm always working

779
00:26:39,960 --> 00:26:41,940
in summer yard but then you have people

780
00:26:41,940 --> 00:26:43,500
around the world my team has split up

781
00:26:43,500 --> 00:26:45,419
over the UK and Australia and so just

782
00:26:45,419 --> 00:26:47,400
our team alone there's no such thing as

783
00:26:47,400 --> 00:26:49,020
normal working hours you'd have to go

784
00:26:49,020 --> 00:26:51,299
admin by admin and kind of set those

785
00:26:51,299 --> 00:26:52,500
parameters so a little bit more

786
00:26:52,500 --> 00:26:56,100
difficult to do now that we're postcoded

787
00:26:56,100 --> 00:26:58,799
Discovery commands if I were moving into

788
00:26:58,799 --> 00:27:00,779
an environment right now

789
00:27:00,779 --> 00:27:02,760
um and I wanted to say man I would

790
00:27:02,760 --> 00:27:04,140
really like to make sure that we're

791
00:27:04,140 --> 00:27:05,640
catching adversaries that are getting

792
00:27:05,640 --> 00:27:07,860
through our perimeter I'll be honest

793
00:27:07,860 --> 00:27:09,720
this is where I would start I would

794
00:27:09,720 --> 00:27:12,179
build a handful of rules looking for

795
00:27:12,179 --> 00:27:14,460
basic Discovery commands and I would

796
00:27:14,460 --> 00:27:17,039
batch those together under some category

797
00:27:17,039 --> 00:27:19,320
I would look for hosts that have those

798
00:27:19,320 --> 00:27:21,240
firing more than three or four times now

799
00:27:21,240 --> 00:27:23,460
once again you're inevitably gonna come

800
00:27:23,460 --> 00:27:25,620
across something that is you know a

801
00:27:25,620 --> 00:27:28,020
scheduled task or something that your

802
00:27:28,020 --> 00:27:31,500
your I.T staff has put in place uh to to

803
00:27:31,500 --> 00:27:33,360
make sure something exists before they

804
00:27:33,360 --> 00:27:35,159
run another piece of automation exclude

805
00:27:35,159 --> 00:27:36,360
those

806
00:27:36,360 --> 00:27:38,039
but I want to see where this happened

807
00:27:38,039 --> 00:27:39,779
more three or four times odds are you're

808
00:27:39,779 --> 00:27:41,700
going to catch a lot of admins logging

809
00:27:41,700 --> 00:27:43,260
into servers making sure they are who

810
00:27:43,260 --> 00:27:45,059
they say they are making sure they have

811
00:27:45,059 --> 00:27:47,340
the connections troubleshooting but I'm

812
00:27:47,340 --> 00:27:48,900
telling you when an adversary hits a box

813
00:27:48,900 --> 00:27:50,580
they're running these commands to figure

814
00:27:50,580 --> 00:27:52,020
out where they're at and where they can

815
00:27:52,020 --> 00:27:54,200
go

816
00:27:54,720 --> 00:27:56,520
scheduled task this is a bit more fun

817
00:27:56,520 --> 00:27:57,900
and I talked about this a little bit

818
00:27:57,900 --> 00:28:00,240
before establishment Baseline is

819
00:28:00,240 --> 00:28:02,460
important right so you're talking about

820
00:28:02,460 --> 00:28:03,659
an environment that doesn't have any

821
00:28:03,659 --> 00:28:05,880
monitoring you want to go out and you

822
00:28:05,880 --> 00:28:07,200
want to query those hosts you want to

823
00:28:07,200 --> 00:28:10,279
see what's existing now you're going to

