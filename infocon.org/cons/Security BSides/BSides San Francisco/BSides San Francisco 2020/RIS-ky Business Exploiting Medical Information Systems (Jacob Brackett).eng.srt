1
00:00:00,030 --> 00:00:05,430
okay hello thank you for coming

2
00:00:03,750 --> 00:00:07,140
I'd like to introduce Shaco Brackett

3
00:00:05,430 --> 00:00:09,599
from one medical please give me your

4
00:00:07,140 --> 00:00:12,530
attention and respect as you go through

5
00:00:09,599 --> 00:00:17,910
his slides and please refrain from

6
00:00:12,530 --> 00:00:20,070
questions until the end okay thanks cool

7
00:00:17,910 --> 00:00:22,198
yeah my name is Jacob Brackett I'm an

8
00:00:20,070 --> 00:00:24,960
application security engineer at one

9
00:00:22,199 --> 00:00:27,240
medical I'm here to talk to you today

10
00:00:24,960 --> 00:00:30,179
about some research we did as part of

11
00:00:27,240 --> 00:00:32,930
our vendor security program which is

12
00:00:30,179 --> 00:00:35,699
attacking radiology information systems

13
00:00:32,930 --> 00:00:37,950
so you may have seen in the news that

14
00:00:35,700 --> 00:00:39,809
there's medical devices are kind of a

15
00:00:37,950 --> 00:00:41,550
hot topic in the security world right

16
00:00:39,809 --> 00:00:43,769
now you may have seen other talks or

17
00:00:41,550 --> 00:00:46,890
read about some high profile attacks

18
00:00:43,770 --> 00:00:49,559
that have been really announced and

19
00:00:46,890 --> 00:00:51,660
talked about recently medical devices

20
00:00:49,559 --> 00:00:55,410
are definitely becoming a real attack

21
00:00:51,660 --> 00:00:57,660
vector for ransomware for criminals to

22
00:00:55,410 --> 00:01:01,620
gain a foothold into hospital networks

23
00:00:57,660 --> 00:01:04,229
or other medical device works

24
00:01:01,620 --> 00:01:06,330
the FDA has actually stepped in to issue

25
00:01:04,229 --> 00:01:08,908
some guidance and regulation in the

26
00:01:06,330 --> 00:01:11,460
space it's definitely a hot topic in the

27
00:01:08,909 --> 00:01:14,909
security world for sure but this talk is

28
00:01:11,460 --> 00:01:16,649
not about medical devices what this talk

29
00:01:14,909 --> 00:01:18,570
is about is the medical device

30
00:01:16,650 --> 00:01:21,180
information systems that power these

31
00:01:18,570 --> 00:01:23,158
devices that they send their data to so

32
00:01:21,180 --> 00:01:24,570
you know it's where all the data lives

33
00:01:23,159 --> 00:01:27,030
the patient data is sent to a

34
00:01:24,570 --> 00:01:28,649
centralized location it's kind of the

35
00:01:27,030 --> 00:01:29,880
golden egg the treasure trove for

36
00:01:28,650 --> 00:01:31,619
attackers if they're able to gain access

37
00:01:29,880 --> 00:01:34,048
to this system they don't just get

38
00:01:31,619 --> 00:01:36,180
access to the information stored on a

39
00:01:34,049 --> 00:01:39,500
single medical device they're able to

40
00:01:36,180 --> 00:01:42,750
get access to all of the patient data

41
00:01:39,500 --> 00:01:44,759
great so what are we going to talk about

42
00:01:42,750 --> 00:01:46,619
today at a high level we're gonna we're

43
00:01:44,759 --> 00:01:48,570
gonna look at an example hospital setup

44
00:01:46,619 --> 00:01:50,700
we're gonna talk about the DICOM

45
00:01:48,570 --> 00:01:53,100
protocol and we'll get into what that is

46
00:01:50,700 --> 00:01:54,509
a bit later and then we're gonna talk

47
00:01:53,100 --> 00:01:56,610
about how attackers can leverage that

48
00:01:54,509 --> 00:01:58,890
protocol in order to attack these

49
00:01:56,610 --> 00:02:04,259
information systems and gain access to

50
00:01:58,890 --> 00:02:06,180
them great so let's say you are a

51
00:02:04,259 --> 00:02:09,060
hospital and you purchase one of these

52
00:02:06,180 --> 00:02:11,129
for the first time this is an x-ray it's

53
00:02:09,060 --> 00:02:12,490
meant to do chest x-rays the patient

54
00:02:11,129 --> 00:02:14,200
lays down and

55
00:02:12,490 --> 00:02:16,840
they make an image of the patient's

56
00:02:14,200 --> 00:02:18,070
chest you've set up your room you've got

57
00:02:16,840 --> 00:02:19,780
lead-lined walls

58
00:02:18,070 --> 00:02:21,609
you may notice something might be

59
00:02:19,780 --> 00:02:23,890
missing from this picture there's no

60
00:02:21,610 --> 00:02:25,750
place for for a doctor to actually go in

61
00:02:23,890 --> 00:02:28,029
and take a look at the image that came

62
00:02:25,750 --> 00:02:31,120
out all there is is kind of the camera

63
00:02:28,030 --> 00:02:33,610
if you will the x-ray device itself so

64
00:02:31,120 --> 00:02:37,300
what you may have to do is figure out a

65
00:02:33,610 --> 00:02:39,520
way for that device that device to send

66
00:02:37,300 --> 00:02:41,950
its data outward in order for doctors to

67
00:02:39,520 --> 00:02:45,370
look at that so first step may be you

68
00:02:41,950 --> 00:02:46,839
route it to a local computer but maybe

69
00:02:45,370 --> 00:02:48,130
you want something that scales so if you

70
00:02:46,840 --> 00:02:50,230
have a hospital network across the

71
00:02:48,130 --> 00:02:52,390
country so you maybe you set up

72
00:02:50,230 --> 00:02:53,980
something like this so here is kind of

73
00:02:52,390 --> 00:02:57,579
an example we've got your x-ray machine

74
00:02:53,980 --> 00:02:58,899
there on the Left you've got now you've

75
00:02:57,580 --> 00:03:01,450
got that laptop that if writer is

76
00:02:58,900 --> 00:03:03,790
viewing images on it's serving as kind

77
00:03:01,450 --> 00:03:05,980
of a gateway or a router that you'll

78
00:03:03,790 --> 00:03:08,200
send your image to that initial on-site

79
00:03:05,980 --> 00:03:09,519
place because the x-ray itself is in a

80
00:03:08,200 --> 00:03:11,049
lead-lined room it can't send it

81
00:03:09,520 --> 00:03:12,100
directly to the Internet you probably

82
00:03:11,050 --> 00:03:13,750
don't want your medical devices

83
00:03:12,100 --> 00:03:15,790
connected directly to the internet

84
00:03:13,750 --> 00:03:17,500
anyway so you've set up some sort of

85
00:03:15,790 --> 00:03:19,570
intermediary you maybe you've locked

86
00:03:17,500 --> 00:03:21,580
that down and then that gets sent to

87
00:03:19,570 --> 00:03:23,380
your shared imaging cloud if that's

88
00:03:21,580 --> 00:03:25,480
maybe that's owned by you if you're a

89
00:03:23,380 --> 00:03:27,160
huge Hospital Network maybe that's owned

90
00:03:25,480 --> 00:03:29,799
by a third party if you're that you've

91
00:03:27,160 --> 00:03:31,810
hired out four doctors to go in in

92
00:03:29,800 --> 00:03:33,610
teleradiology is what that's referred to

93
00:03:31,810 --> 00:03:36,130
when you have other doctors going in and

94
00:03:33,610 --> 00:03:37,300
doing if you're smaller company that's

95
00:03:36,130 --> 00:03:38,740
probably what your setup looks like

96
00:03:37,300 --> 00:03:42,190
you've hired contractors that actually

97
00:03:38,740 --> 00:03:44,560
go in and do your imaging cool so before

98
00:03:42,190 --> 00:03:46,329
we talk about that let's get into some

99
00:03:44,560 --> 00:03:49,000
definitions I mentioned DICOM earlier

100
00:03:46,330 --> 00:03:51,190
where that stands for is digital imaging

101
00:03:49,000 --> 00:03:53,020
and communications it is the protocol

102
00:03:51,190 --> 00:03:55,600
it's a standard for medical imaging

103
00:03:53,020 --> 00:03:58,030
transfers no matter what type of image

104
00:03:55,600 --> 00:04:00,430
whether it's an x-ray CT ultrasound if

105
00:03:58,030 --> 00:04:02,550
you if you've gone to Urgent Care and

106
00:04:00,430 --> 00:04:05,410
got some sort of medical image taken

107
00:04:02,550 --> 00:04:07,240
likely that image was translated into

108
00:04:05,410 --> 00:04:09,190
DICOM and sent over the Internet

109
00:04:07,240 --> 00:04:10,600
it's both a file format and a network

110
00:04:09,190 --> 00:04:13,630
protocol and we'll talk about both of

111
00:04:10,600 --> 00:04:15,760
those elements later the next topic

112
00:04:13,630 --> 00:04:17,829
we're going to talk about is a packs or

113
00:04:15,760 --> 00:04:20,409
a pack system that stands for picture

114
00:04:17,829 --> 00:04:22,659
archiving and communication system it's

115
00:04:20,410 --> 00:04:25,000
basically the web UI where the it

116
00:04:22,660 --> 00:04:26,410
provides diagnostic quality images

117
00:04:25,000 --> 00:04:27,910
allows the doc

118
00:04:26,410 --> 00:04:29,680
to go in and actually make their

119
00:04:27,910 --> 00:04:32,170
diagnosis all their annotations happen

120
00:04:29,680 --> 00:04:34,330
in that application its where actually

121
00:04:32,170 --> 00:04:36,550
the actual Diagnostics happen and that

122
00:04:34,330 --> 00:04:37,900
may be on a web server somewhere that

123
00:04:36,550 --> 00:04:41,080
you can browse the internet it might be

124
00:04:37,900 --> 00:04:43,060
internal on an actual laptop but there

125
00:04:41,080 --> 00:04:44,740
is a PAC system that your doctor will be

126
00:04:43,060 --> 00:04:46,330
logging in to perform their work and

127
00:04:44,740 --> 00:04:49,300
then finally we're going to talk about

128
00:04:46,330 --> 00:04:51,909
radiology Information Systems which is

129
00:04:49,300 --> 00:04:54,370
kind of the related to a pax in that

130
00:04:51,910 --> 00:04:56,530
it's it is a pax as a part of it kind of

131
00:04:54,370 --> 00:04:58,240
it's it's where it's the higher level

132
00:04:56,530 --> 00:05:00,159
the business logic side of the pack so

133
00:04:58,240 --> 00:05:02,170
where the pack whereas the pax is where

134
00:05:00,160 --> 00:05:04,060
you go in and view images the risk is

135
00:05:02,170 --> 00:05:06,550
where you go in manage provider

136
00:05:04,060 --> 00:05:08,440
schedules it allows you to click at a

137
00:05:06,550 --> 00:05:09,940
certain appointment time and then view

138
00:05:08,440 --> 00:05:12,850
the images that were associated to that

139
00:05:09,940 --> 00:05:15,040
appointment cool so now your radiology

140
00:05:12,850 --> 00:05:17,110
expert you know all the terms let's look

141
00:05:15,040 --> 00:05:19,210
at our diagram from before and take a

142
00:05:17,110 --> 00:05:21,640
look at what that actually looks like so

143
00:05:19,210 --> 00:05:24,370
we've got our introduced one quick term

144
00:05:21,640 --> 00:05:26,950
here the modality is your actual device

145
00:05:24,370 --> 00:05:28,240
it's your x-ray or CT etc or whatever

146
00:05:26,950 --> 00:05:31,630
that device might be that's referred to

147
00:05:28,240 --> 00:05:34,150
as a modality in DICOM that would be

148
00:05:31,630 --> 00:05:36,940
talking DICOM so either DICOM rod DICOM

149
00:05:34,150 --> 00:05:39,250
which is unencrypted or DICOM over TLS

150
00:05:36,940 --> 00:05:41,440
for some more modern devices although

151
00:05:39,250 --> 00:05:44,500
it's usually a very modern device if

152
00:05:41,440 --> 00:05:47,080
it's speaking to I come over TLS locally

153
00:05:44,500 --> 00:05:48,669
over your network to a DICOM gateway in

154
00:05:47,080 --> 00:05:52,180
this case it's a it's a Raspberry Pi

155
00:05:48,669 --> 00:05:53,919
we've seen that set up or it's may be a

156
00:05:52,180 --> 00:05:56,380
Windows computer something a little more

157
00:05:53,919 --> 00:05:58,240
sophisticated but at the end of the day

158
00:05:56,380 --> 00:06:01,750
that has to get into your centralized

159
00:05:58,240 --> 00:06:04,150
risks or PAC system so that is done over

160
00:06:01,750 --> 00:06:05,890
the Internet either over VPN which is

161
00:06:04,150 --> 00:06:08,859
the the common more traditional way to

162
00:06:05,890 --> 00:06:11,560
do it but more and more as does more

163
00:06:08,860 --> 00:06:13,480
systems or going into teleradiology that

164
00:06:11,560 --> 00:06:15,640
doesn't necessarily work if you have to

165
00:06:13,480 --> 00:06:16,870
set up a VPN to each of your hundred

166
00:06:15,640 --> 00:06:20,080
clients and some of these clients are

167
00:06:16,870 --> 00:06:22,660
very small and TLS is kind of sufficient

168
00:06:20,080 --> 00:06:25,330
so a lot of them will just setup DICOM

169
00:06:22,660 --> 00:06:28,330
over TLS or maybe they forget to set up

170
00:06:25,330 --> 00:06:31,030
TLS but they shove DICOM over TLS set

171
00:06:28,330 --> 00:06:33,490
over the internet to connect to the risk

172
00:06:31,030 --> 00:06:35,020
system so the images are sent encrypted

173
00:06:33,490 --> 00:06:38,620
hopefully over the wire over the

174
00:06:35,020 --> 00:06:42,139
Internet great first let's talk about

175
00:06:38,620 --> 00:06:44,480
the the DICOM Network

176
00:06:42,139 --> 00:06:46,330
so first of all what are some things you

177
00:06:44,480 --> 00:06:48,440
can do with the DICOM network protocol

178
00:06:46,330 --> 00:06:50,479
the they're kind of broken down is

179
00:06:48,440 --> 00:06:52,160
different composite operations the main

180
00:06:50,479 --> 00:06:54,740
two we're going to talk about today and

181
00:06:52,160 --> 00:06:56,570
there's more are see find which is kind

182
00:06:54,740 --> 00:06:58,430
of your generic query retrieval service

183
00:06:56,570 --> 00:07:00,650
it's kind of how you do execute search

184
00:06:58,430 --> 00:07:03,470
operations if you if you want to pull

185
00:07:00,650 --> 00:07:05,750
out patient data you can use see fine

186
00:07:03,470 --> 00:07:07,400
to do that and then the next operation

187
00:07:05,750 --> 00:07:10,130
we're going to talk about is C store

188
00:07:07,400 --> 00:07:12,799
which is your ability to upload a DICOM

189
00:07:10,130 --> 00:07:15,110
study so that's take a DICOM file take

190
00:07:12,800 --> 00:07:17,690
an image that your x-ray is doing a

191
00:07:15,110 --> 00:07:19,820
c-store to that system eventually

192
00:07:17,690 --> 00:07:21,889
there's a few other like C print is one

193
00:07:19,820 --> 00:07:25,040
C move a few operations that would be

194
00:07:21,889 --> 00:07:26,960
kind of database operations so let's

195
00:07:25,040 --> 00:07:29,330
dive into what that actual protocol

196
00:07:26,960 --> 00:07:30,950
looks like it's a classic kind of

197
00:07:29,330 --> 00:07:33,380
client-server model there's two

198
00:07:30,950 --> 00:07:35,840
components the the client is referred to

199
00:07:33,380 --> 00:07:37,760
as a service class user in DICOM or the

200
00:07:35,840 --> 00:07:40,549
SCU and then we have the service class

201
00:07:37,760 --> 00:07:42,590
provider which is the server in DICOM so

202
00:07:40,550 --> 00:07:45,620
it's kind of the initial handshake

203
00:07:42,590 --> 00:07:47,960
period happens where the to serve the

204
00:07:45,620 --> 00:07:49,340
client asks for an association we'll

205
00:07:47,960 --> 00:07:51,020
dive into that a little bit later that

206
00:07:49,340 --> 00:07:53,690
the service class provider either

207
00:07:51,020 --> 00:07:56,150
accepts or rejects that association

208
00:07:53,690 --> 00:07:57,740
based on what was provided and then once

209
00:07:56,150 --> 00:07:59,900
that association is established you've

210
00:07:57,740 --> 00:08:01,550
got that channel of communication in

211
00:07:59,900 --> 00:08:03,500
this case we're doing at C fine so that

212
00:08:01,550 --> 00:08:05,510
client makes the C find request for the

213
00:08:03,500 --> 00:08:08,419
data that it wants and then the server

214
00:08:05,510 --> 00:08:09,830
is that the SCP is responding with all

215
00:08:08,419 --> 00:08:12,139
of the C fine records that match

216
00:08:09,830 --> 00:08:13,700
whatever the client had requested it

217
00:08:12,139 --> 00:08:15,560
sends that final one with special flag

218
00:08:13,700 --> 00:08:17,510
to indicate that it's done and then that

219
00:08:15,560 --> 00:08:19,250
association it can be closed and so

220
00:08:17,510 --> 00:08:20,900
there's kind of a session that happens

221
00:08:19,250 --> 00:08:24,380
as part of that referred to as an

222
00:08:20,900 --> 00:08:27,020
association cool and so let's dive into

223
00:08:24,380 --> 00:08:28,750
that association process your security

224
00:08:27,020 --> 00:08:32,000
minded so you're probably thinking

225
00:08:28,750 --> 00:08:33,559
what's going on here so there's three

226
00:08:32,000 --> 00:08:35,900
items that a service class user is

227
00:08:33,559 --> 00:08:38,869
sending with that Association process so

228
00:08:35,900 --> 00:08:42,409
the first is the called application any

229
00:08:38,870 --> 00:08:44,690
title basically it's a 16 character host

230
00:08:42,409 --> 00:08:46,459
name that's configured when the SCP is

231
00:08:44,690 --> 00:08:49,880
set up the service class provider the

232
00:08:46,459 --> 00:08:51,589
server is set up and so that is has to

233
00:08:49,880 --> 00:08:53,630
match the client sends it and that that

234
00:08:51,589 --> 00:08:54,150
has to match with what the client had

235
00:08:53,630 --> 00:08:55,710
said

236
00:08:54,150 --> 00:08:57,900
so you're talking to the right person

237
00:08:55,710 --> 00:08:59,340
and then the calling application any

238
00:08:57,900 --> 00:09:01,110
title is also specified you have to

239
00:08:59,340 --> 00:09:03,150
identify yourself with your own host

240
00:09:01,110 --> 00:09:05,850
name your application and adhi title or

241
00:09:03,150 --> 00:09:08,130
AE title and then finally the

242
00:09:05,850 --> 00:09:09,960
presentation context is it's basically

243
00:09:08,130 --> 00:09:12,270
the data format it's what operation

244
00:09:09,960 --> 00:09:14,490
you're going to do on the server to make

245
00:09:12,270 --> 00:09:16,439
sure that the server can support it and

246
00:09:14,490 --> 00:09:18,600
then based on those three fields the

247
00:09:16,440 --> 00:09:21,240
service class provider responds with and

248
00:09:18,600 --> 00:09:23,910
accept or reject those are the three

249
00:09:21,240 --> 00:09:26,190
things that are said you may be thinking

250
00:09:23,910 --> 00:09:28,530
where's the authentication we're talking

251
00:09:26,190 --> 00:09:31,470
about host names well that's not built

252
00:09:28,530 --> 00:09:33,209
into DICOM so this is that basically the

253
00:09:31,470 --> 00:09:35,880
only authentication that happens for a

254
00:09:33,210 --> 00:09:37,740
DICOM association is a check to make

255
00:09:35,880 --> 00:09:40,020
sure that the called application any

256
00:09:37,740 --> 00:09:42,180
title so that the client knows who it's

257
00:09:40,020 --> 00:09:43,770
talking to the host name it matches the

258
00:09:42,180 --> 00:09:45,300
application ID title that was configured

259
00:09:43,770 --> 00:09:46,920
when the service class provider was set

260
00:09:45,300 --> 00:09:50,310
up you know the host name of the server

261
00:09:46,920 --> 00:09:52,770
you're talking to in some ways and then

262
00:09:50,310 --> 00:09:54,209
sometimes that calling application any

263
00:09:52,770 --> 00:09:56,310
title how this how the client is

264
00:09:54,210 --> 00:09:58,560
identifying itself is checked against a

265
00:09:56,310 --> 00:10:00,989
list of recognized devices so below

266
00:09:58,560 --> 00:10:07,380
here's the class from an open source

267
00:10:00,990 --> 00:10:09,810
now-defunct pack server called a clear

268
00:10:07,380 --> 00:10:11,610
canvas here's the class association

269
00:10:09,810 --> 00:10:13,650
verifier and you can see that what's

270
00:10:11,610 --> 00:10:15,510
doing at the comment there is mentioning

271
00:10:13,650 --> 00:10:17,550
that it's checking against a list of

272
00:10:15,510 --> 00:10:19,080
configured calling application and any

273
00:10:17,550 --> 00:10:23,969
tiles to make sure that it's a device

274
00:10:19,080 --> 00:10:25,770
that it knows it's talking to so we now

275
00:10:23,970 --> 00:10:27,240
know everything we we now know

276
00:10:25,770 --> 00:10:29,069
everything to set up an association and

277
00:10:27,240 --> 00:10:32,160
start querying a server so what does

278
00:10:29,070 --> 00:10:35,760
that look like this is using a Python

279
00:10:32,160 --> 00:10:38,310
library a an API for DICOM called pine

280
00:10:35,760 --> 00:10:41,760
net DICOM for the the network protocol

281
00:10:38,310 --> 00:10:44,339
we're gonna query a patient name of star

282
00:10:41,760 --> 00:10:46,439
so matching any patient record that the

283
00:10:44,340 --> 00:10:49,020
server has we're gonna initialize our a

284
00:10:46,440 --> 00:10:51,240
title with with a a e title of hacker

285
00:10:49,020 --> 00:10:53,370
obviously the server isn't checking that

286
00:10:51,240 --> 00:10:55,230
calling a title in this case and we're

287
00:10:53,370 --> 00:10:57,780
gonna call that Association or the

288
00:10:55,230 --> 00:11:00,390
server with an AE title of gateway and

289
00:10:57,780 --> 00:11:02,400
so let's say that Gateway matches the

290
00:11:00,390 --> 00:11:03,960
configured SCP what it was set up with

291
00:11:02,400 --> 00:11:06,540
that application any title is valid so

292
00:11:03,960 --> 00:11:08,130
the server will respond and then if

293
00:11:06,540 --> 00:11:09,810
printing the records as we receive them

294
00:11:08,130 --> 00:11:11,160
here's what that might look like so

295
00:11:09,810 --> 00:11:14,310
there's three different patient records

296
00:11:11,160 --> 00:11:16,260
since those all match star that the

297
00:11:14,310 --> 00:11:21,449
server will respond with every record

298
00:11:16,260 --> 00:11:22,950
that it has for patients so AE titles

299
00:11:21,450 --> 00:11:26,430
are the main portion of authentication

300
00:11:22,950 --> 00:11:29,610
on for DICOM so kind of how realistic is

301
00:11:26,430 --> 00:11:32,670
it to guess in AE title well it turns

302
00:11:29,610 --> 00:11:34,230
out that these aren't really passwords

303
00:11:32,670 --> 00:11:37,140
sixteen characters for a password

304
00:11:34,230 --> 00:11:39,540
alphanumeric doesn't sound too bad but

305
00:11:37,140 --> 00:11:41,819
consider that these are often made to be

306
00:11:39,540 --> 00:11:43,349
readable and recognizable by someone

307
00:11:41,820 --> 00:11:45,390
that's looking at it so human readable

308
00:11:43,350 --> 00:11:47,760
so they're configured with names like

309
00:11:45,390 --> 00:11:50,490
one medical if that's who your client is

310
00:11:47,760 --> 00:11:52,980
or one medical - four six seven eight

311
00:11:50,490 --> 00:11:54,240
nine if that's if you want to add some

312
00:11:52,980 --> 00:11:56,520
random values at the end to make it a

313
00:11:54,240 --> 00:11:58,110
little bit harder to guess or they're

314
00:11:56,520 --> 00:12:00,420
configured with default values so

315
00:11:58,110 --> 00:12:02,190
Gateway could be the AE title for your

316
00:12:00,420 --> 00:12:04,290
DICOM gateway the router that we talked

317
00:12:02,190 --> 00:12:06,360
about or you have something like find

318
00:12:04,290 --> 00:12:08,910
seu for the service class user that's

319
00:12:06,360 --> 00:12:12,930
doing a CE fine so some kind of default

320
00:12:08,910 --> 00:12:16,140
values also it's you may want to find a

321
00:12:12,930 --> 00:12:18,150
way for on the web portion of your pack

322
00:12:16,140 --> 00:12:19,920
server in order to easily disambiguate

323
00:12:18,150 --> 00:12:21,510
between different clients let's say you

324
00:12:19,920 --> 00:12:23,610
set up a DICOM server and you have a

325
00:12:21,510 --> 00:12:25,710
hundred clients that you want to send

326
00:12:23,610 --> 00:12:28,470
records to that server has some route

327
00:12:25,710 --> 00:12:30,660
images to the correct place so what you

328
00:12:28,470 --> 00:12:32,520
can do is configure a hundred different

329
00:12:30,660 --> 00:12:35,790
application any titles that are all

330
00:12:32,520 --> 00:12:37,980
valid for your DICOM server but route to

331
00:12:35,790 --> 00:12:39,510
different clients so it's it's slower

332
00:12:37,980 --> 00:12:40,980
lowers the attack service for what you

333
00:12:39,510 --> 00:12:43,620
can actually pull from records if you're

334
00:12:40,980 --> 00:12:45,450
able to guess one of those but now

335
00:12:43,620 --> 00:12:47,520
you're you're the ability to brute force

336
00:12:45,450 --> 00:12:50,340
now you have basically a hundred valid

337
00:12:47,520 --> 00:12:52,319
passwords almost in your system and then

338
00:12:50,340 --> 00:12:53,940
let's say you have the web UI portion

339
00:12:52,320 --> 00:12:56,940
where doctors actually have to go in and

340
00:12:53,940 --> 00:12:58,560
select different information in order to

341
00:12:56,940 --> 00:12:59,670
let's say they're logging in they have

342
00:12:58,560 --> 00:13:02,310
to figure out which client they're

343
00:12:59,670 --> 00:13:03,540
authenticating to so what what I've

344
00:13:02,310 --> 00:13:05,670
actually seen what we've actually seen

345
00:13:03,540 --> 00:13:07,980
during some testing is that some PAC

346
00:13:05,670 --> 00:13:09,959
servers will actually expose the

347
00:13:07,980 --> 00:13:12,420
application any titles to that web UI

348
00:13:09,960 --> 00:13:14,190
sometimes before authentication so you

349
00:13:12,420 --> 00:13:16,500
just have to select the application any

350
00:13:14,190 --> 00:13:18,630
title that you want to log into before

351
00:13:16,500 --> 00:13:19,390
you authenticate and so the attacker

352
00:13:18,630 --> 00:13:21,160
right away

353
00:13:19,390 --> 00:13:23,439
could get a list just by browsing to

354
00:13:21,160 --> 00:13:25,449
your packs web server of every valid

355
00:13:23,440 --> 00:13:27,850
application any title for your system so

356
00:13:25,450 --> 00:13:30,370
that can be that can cause definitely

357
00:13:27,850 --> 00:13:32,290
problems for associating or of course

358
00:13:30,370 --> 00:13:35,080
you just forget to check them at all so

359
00:13:32,290 --> 00:13:37,390
there's this research done at in

360
00:13:35,080 --> 00:13:38,950
September of last year of some

361
00:13:37,390 --> 00:13:43,210
Australian researchers that were able to

362
00:13:38,950 --> 00:13:45,190
pull out a DICOM Records with that we're

363
00:13:43,210 --> 00:13:47,200
not checking applications any titles at

364
00:13:45,190 --> 00:13:49,030
all and we're left exposed completely on

365
00:13:47,200 --> 00:13:50,740
the internet so they were just able to

366
00:13:49,030 --> 00:13:52,959
download some DICOM viewing software

367
00:13:50,740 --> 00:13:54,520
download all the images look at all the

368
00:13:52,960 --> 00:13:59,680
patient information and look at all

369
00:13:54,520 --> 00:14:01,090
those images in daikon so let's say

370
00:13:59,680 --> 00:14:02,709
you've come across the daikon server

371
00:14:01,090 --> 00:14:04,420
you're either able to guess the

372
00:14:02,710 --> 00:14:05,860
application any title or it's just

373
00:14:04,420 --> 00:14:08,530
sitting on the Internet exposed and you

374
00:14:05,860 --> 00:14:10,900
kind of want to see what it can do well

375
00:14:08,530 --> 00:14:13,360
it turns out DICOM doesn't have a nice

376
00:14:10,900 --> 00:14:14,380
little help function so there's no when

377
00:14:13,360 --> 00:14:16,300
you're talking to a daikon server

378
00:14:14,380 --> 00:14:18,790
there's no way to just get it to spit

379
00:14:16,300 --> 00:14:22,359
out what operations it supports so you

380
00:14:18,790 --> 00:14:23,860
end up having to make requests to - with

381
00:14:22,360 --> 00:14:25,720
all the things that you want to do and

382
00:14:23,860 --> 00:14:28,480
the and what see whether or not your

383
00:14:25,720 --> 00:14:30,310
association was accepted or rejected and

384
00:14:28,480 --> 00:14:31,900
that happens that negotiation happens

385
00:14:30,310 --> 00:14:34,770
during that that third field in the

386
00:14:31,900 --> 00:14:39,010
association that presentation context

387
00:14:34,770 --> 00:14:40,180
hopefully pie net DICOM has a dictionary

388
00:14:39,010 --> 00:14:42,640
it has a built some built-in

389
00:14:40,180 --> 00:14:44,920
presentation context which are basically

390
00:14:42,640 --> 00:14:46,800
lists of actual operations so they're

391
00:14:44,920 --> 00:14:50,530
more human readable it's things like

392
00:14:46,800 --> 00:14:51,790
move presentation context or store

393
00:14:50,530 --> 00:14:53,350
presentation context where they

394
00:14:51,790 --> 00:14:55,510
correspond to the actual composite

395
00:14:53,350 --> 00:14:57,670
operation that you're trying to do so

396
00:14:55,510 --> 00:14:59,980
you can actually use those and in a

397
00:14:57,670 --> 00:15:02,050
simple Python loop just request six or

398
00:14:59,980 --> 00:15:03,640
seven I think there's 16 in total

399
00:15:02,050 --> 00:15:06,010
actually if you want to enumerate

400
00:15:03,640 --> 00:15:08,439
everything send though that many

401
00:15:06,010 --> 00:15:10,360
Association requests see if you can see

402
00:15:08,440 --> 00:15:12,550
which ones are either accepted or

403
00:15:10,360 --> 00:15:13,750
rejected by the server and that's how

404
00:15:12,550 --> 00:15:18,099
you know what operations you can

405
00:15:13,750 --> 00:15:20,110
actually perform on that server so see

406
00:15:18,100 --> 00:15:22,360
find is obviously dangerous that's the

407
00:15:20,110 --> 00:15:25,120
way you can query patient records if you

408
00:15:22,360 --> 00:15:27,460
are configuring a DICOM server o or a

409
00:15:25,120 --> 00:15:29,800
PAC server setup on the internet you do

410
00:15:27,460 --> 00:15:31,660
not want to find so let's restrict that

411
00:15:29,800 --> 00:15:32,829
DICOM allows you to restrict certain

412
00:15:31,660 --> 00:15:36,089
operations look

413
00:15:32,830 --> 00:15:38,590
only allow c-store what could go wrong

414
00:15:36,090 --> 00:15:40,030
let's talk about DICOM files that's the

415
00:15:38,590 --> 00:15:42,180
second half of the daikon protocol and

416
00:15:40,030 --> 00:15:45,160
it's both a network and a file protocol

417
00:15:42,180 --> 00:15:48,310
this is the header of a daikon file

418
00:15:45,160 --> 00:15:51,040
basically all a daikon file is is a JPEG

419
00:15:48,310 --> 00:15:52,959
image with kind of a fancy hat a nice

420
00:15:51,040 --> 00:15:56,020
header there that's got some metadata

421
00:15:52,960 --> 00:15:58,030
information about what the image was

422
00:15:56,020 --> 00:15:59,680
actually taken so this is generated by

423
00:15:58,030 --> 00:16:02,740
your modality so let's say we're taking

424
00:15:59,680 --> 00:16:04,180
an x-ray image the the the provider that

425
00:16:02,740 --> 00:16:06,730
would take that image beforehand would

426
00:16:04,180 --> 00:16:08,859
enter in the patient ID from their

427
00:16:06,730 --> 00:16:11,800
electronic medical record system their

428
00:16:08,860 --> 00:16:14,200
name their own the physicians name

429
00:16:11,800 --> 00:16:16,810
that's doing the the study they would

430
00:16:14,200 --> 00:16:19,120
enter the series number some IDs that

431
00:16:16,810 --> 00:16:21,400
can tie multiple images taking a single

432
00:16:19,120 --> 00:16:23,070
session together so that the PAC system

433
00:16:21,400 --> 00:16:25,060
can take ten different images

434
00:16:23,070 --> 00:16:27,490
asynchronously and then tie that into

435
00:16:25,060 --> 00:16:29,050
one single DICOM study so you can kind

436
00:16:27,490 --> 00:16:31,900
of see a time lapse of different images

437
00:16:29,050 --> 00:16:33,880
or different angles across the body so

438
00:16:31,900 --> 00:16:36,459
that's kind of how the DICOM file

439
00:16:33,880 --> 00:16:38,830
protocol works if you put on your

440
00:16:36,460 --> 00:16:41,620
offensive security hat for a second you

441
00:16:38,830 --> 00:16:44,230
you can see that these are generated by

442
00:16:41,620 --> 00:16:47,470
a machine usually but they are user

443
00:16:44,230 --> 00:16:49,420
generated value so potentially ripe for

444
00:16:47,470 --> 00:16:51,850
injection attacks especially for web

445
00:16:49,420 --> 00:16:53,800
frameworks that may not expect DICOM

446
00:16:51,850 --> 00:16:55,270
information to actually be user

447
00:16:53,800 --> 00:16:57,339
controllable if you're developing a PAC

448
00:16:55,270 --> 00:16:59,590
system you may not realize that you have

449
00:16:57,340 --> 00:17:02,200
to actually sanitize user input that was

450
00:16:59,590 --> 00:17:03,790
pulled from a daikon study because you

451
00:17:02,200 --> 00:17:05,050
implicitly trust the devices that you

452
00:17:03,790 --> 00:17:06,790
connect your medical devices that

453
00:17:05,050 --> 00:17:08,909
connect to the system the only thing

454
00:17:06,790 --> 00:17:11,470
that can route to it so let's dig into

455
00:17:08,910 --> 00:17:14,350
cross-site scripting as an example we're

456
00:17:11,470 --> 00:17:16,569
gonna use pine net DICOM which is a

457
00:17:14,349 --> 00:17:17,889
sister library of we're gonna use pi

458
00:17:16,569 --> 00:17:20,550
daikon which is the sister library

459
00:17:17,890 --> 00:17:23,110
phenom pine net daikon to work on files

460
00:17:20,550 --> 00:17:25,329
this is how you can use it we're gonna

461
00:17:23,109 --> 00:17:27,639
open we're gonna download a file a test

462
00:17:25,329 --> 00:17:30,639
file from daikon library we're gonna

463
00:17:27,640 --> 00:17:33,310
read that file in we're gonna set that

464
00:17:30,640 --> 00:17:36,250
modality which is the the identification

465
00:17:33,310 --> 00:17:37,300
this would say like x-ray or CT for the

466
00:17:36,250 --> 00:17:39,370
different device that's our

467
00:17:37,300 --> 00:17:41,970
identification we're gonna set that to

468
00:17:39,370 --> 00:17:44,439
our cross-site scripting payload

469
00:17:41,970 --> 00:17:46,450
next we're gonna save that file make

470
00:17:44,440 --> 00:17:50,470
sure that actually gets written to disk

471
00:17:46,450 --> 00:17:52,000
before we send it off to the server so

472
00:17:50,470 --> 00:17:55,149
with just a few different method calls

473
00:17:52,000 --> 00:17:56,549
we've got our malicious daikon file next

474
00:17:55,149 --> 00:17:59,949
we're gonna use an open source tool

475
00:17:56,549 --> 00:18:02,168
called DCM TK we're use the store as the

476
00:17:59,950 --> 00:18:04,630
use of a c-store a service class user

477
00:18:02,169 --> 00:18:06,159
we're gonna call the server AE because

478
00:18:04,630 --> 00:18:08,230
we've guessed the AE title or it's not

479
00:18:06,159 --> 00:18:09,309
checking in this case just local oats

480
00:18:08,230 --> 00:18:11,980
but we're gonna upload that file that

481
00:18:09,309 --> 00:18:14,860
tests d kea DCM file that daikon

482
00:18:11,980 --> 00:18:16,929
malicious daikon file the association is

483
00:18:14,860 --> 00:18:20,529
valid and so the c-store request

484
00:18:16,929 --> 00:18:22,000
completes successfully now we're gonna

485
00:18:20,529 --> 00:18:26,080
look at it on the provider side so let's

486
00:18:22,000 --> 00:18:28,179
say this is our open source defunct PAC

487
00:18:26,080 --> 00:18:30,460
system called clear canvas we're gonna

488
00:18:28,179 --> 00:18:35,260
login with our super secure credentials

489
00:18:30,460 --> 00:18:37,480
admin admin we're in we're gonna ignore

490
00:18:35,260 --> 00:18:40,149
that last class we can remember that one

491
00:18:37,480 --> 00:18:42,039
we're gonna search for for new studies

492
00:18:40,149 --> 00:18:43,779
that came in maybe this is our queue we

493
00:18:42,039 --> 00:18:46,000
double click on it and then that that

494
00:18:43,779 --> 00:18:48,460
payload file fires so cross-site

495
00:18:46,000 --> 00:18:49,840
scripting we've bypassed all that

496
00:18:48,460 --> 00:18:52,149
authentication we haven't had the brute

497
00:18:49,840 --> 00:18:54,158
force any any providers if there was to

498
00:18:52,149 --> 00:18:57,908
if a configured which this server allows

499
00:18:54,159 --> 00:18:59,860
you to do we bypassed that great so

500
00:18:57,909 --> 00:19:02,799
let's talk about some kind of lessons

501
00:18:59,860 --> 00:19:05,408
learned and next steps let's say you

502
00:19:02,799 --> 00:19:07,779
you've set up an x-ray device on your

503
00:19:05,409 --> 00:19:09,730
network and you protect that you you can

504
00:19:07,779 --> 00:19:11,830
make sure that it can only send to valid

505
00:19:09,730 --> 00:19:13,210
so no one can send can create a reverse

506
00:19:11,830 --> 00:19:14,830
shell on that and send back to their own

507
00:19:13,210 --> 00:19:16,600
systems the only thing you can talk to

508
00:19:14,830 --> 00:19:18,760
you is your PAC system well clearly

509
00:19:16,600 --> 00:19:20,799
you're not entirely safe because you can

510
00:19:18,760 --> 00:19:23,289
upload malicious daikon files to that

511
00:19:20,799 --> 00:19:25,059
with injection payloads that get routed

512
00:19:23,289 --> 00:19:26,710
make you have to make sure that your

513
00:19:25,059 --> 00:19:29,769
your PAC server is actually following

514
00:19:26,710 --> 00:19:31,389
following OS 10 best practices and make

515
00:19:29,769 --> 00:19:33,970
sure you do your due diligence when

516
00:19:31,389 --> 00:19:35,799
choosing a PAC system in order for your

517
00:19:33,970 --> 00:19:38,679
providers to log in and do their in

518
00:19:35,799 --> 00:19:42,429
their data we talked a lot about DICOM

519
00:19:38,679 --> 00:19:44,679
and authentication it's worth noting

520
00:19:42,429 --> 00:19:47,260
that in the new versions of the DICOM

521
00:19:44,679 --> 00:19:49,539
standard that there's this new concept

522
00:19:47,260 --> 00:19:51,279
called a user identity negotiation where

523
00:19:49,539 --> 00:19:52,870
it's they've kind of realized that a

524
00:19:51,279 --> 00:19:54,279
titles don't aren't really

525
00:19:52,870 --> 00:19:55,539
authentication and they don't want to

526
00:19:54,279 --> 00:19:57,309
instead of building something on top of

527
00:19:55,539 --> 00:19:58,658
it here's something that the protocol

528
00:19:57,309 --> 00:19:59,860
actually supports you can actually use a

529
00:19:58,659 --> 00:20:02,200
Kerberos server stick

530
00:19:59,860 --> 00:20:04,510
or sam'l assertion if you have SSO

531
00:20:02,200 --> 00:20:06,429
configured in order to log in and send

532
00:20:04,510 --> 00:20:08,799
images to your to your DICOM server so

533
00:20:06,429 --> 00:20:11,440
you can have your you can have your

534
00:20:08,799 --> 00:20:13,870
x-ray authenticate to single sign-on as

535
00:20:11,440 --> 00:20:16,570
a machine account and then before it

536
00:20:13,870 --> 00:20:18,428
uploads the server remember though if

537
00:20:16,570 --> 00:20:19,240
you're using a username or just use name

538
00:20:18,429 --> 00:20:21,130
and passcode

539
00:20:19,240 --> 00:20:23,170
I'm not sure how much I would trust my

540
00:20:21,130 --> 00:20:25,059
medical devices that I've set up to

541
00:20:23,170 --> 00:20:27,580
actually store user name and password

542
00:20:25,059 --> 00:20:31,000
securely or in a way that those devices

543
00:20:27,580 --> 00:20:32,350
don't get compromised so as much as you

544
00:20:31,000 --> 00:20:34,690
can abstract and remove that

545
00:20:32,350 --> 00:20:36,428
authentication piece so that no actual

546
00:20:34,690 --> 00:20:38,679
pass codes or hard-coded data is stored

547
00:20:36,429 --> 00:20:41,200
on your actual medical devices the

548
00:20:38,679 --> 00:20:44,260
better and then finally a note for all

549
00:20:41,200 --> 00:20:47,110
you blue teamers out there understand

550
00:20:44,260 --> 00:20:48,400
what protocols are on your network dicot

551
00:20:47,110 --> 00:20:50,620
if you're configuring a hospital

552
00:20:48,400 --> 00:20:52,900
network.com may be missed or not

553
00:20:50,620 --> 00:20:54,549
monitored by your tools so make sure

554
00:20:52,900 --> 00:20:57,220
that you're you're actually your tools

555
00:20:54,549 --> 00:20:59,110
can interpret DICOM and look for

556
00:20:57,220 --> 00:21:01,410
malicious activity if your server

557
00:20:59,110 --> 00:21:03,809
suddenly starts sending see fine

558
00:21:01,410 --> 00:21:06,130
responds with every single record

559
00:21:03,809 --> 00:21:07,629
potentially you have problems so make

560
00:21:06,130 --> 00:21:09,580
sure that you're actually monitoring

561
00:21:07,630 --> 00:21:11,080
those networks just make sure you're not

562
00:21:09,580 --> 00:21:13,030
logging patient data in your logs and

563
00:21:11,080 --> 00:21:15,309
storing those unencrypted just make sure

564
00:21:13,030 --> 00:21:16,899
Hiep you all your best practices are

565
00:21:15,309 --> 00:21:19,360
followed with those logs because again

566
00:21:16,900 --> 00:21:21,309
this is a pH I that you're dealing with

567
00:21:19,360 --> 00:21:23,439
here protected health information so

568
00:21:21,309 --> 00:21:29,790
there's higher standards long around

569
00:21:23,440 --> 00:21:29,790
those great thank you

570
00:21:30,310 --> 00:21:37,030
[Applause]

