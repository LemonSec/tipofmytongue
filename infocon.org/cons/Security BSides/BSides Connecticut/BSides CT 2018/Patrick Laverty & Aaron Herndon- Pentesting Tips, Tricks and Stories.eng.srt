1
00:00:00,230 --> 00:00:05,310
all right so thank you again everyone

2
00:00:02,790 --> 00:00:06,960
for coming and staying and obviously we

3
00:00:05,310 --> 00:00:09,149
have a lot of prizes at the end and and

4
00:00:06,960 --> 00:00:11,340
giveaways so be sure to stay till the

5
00:00:09,150 --> 00:00:13,500
end but but I would like to introduce

6
00:00:11,340 --> 00:00:15,960
these two guys I found outside the hall

7
00:00:13,500 --> 00:00:18,420
here to present last second just kidding

8
00:00:15,960 --> 00:00:20,189
Patrick and Erin they're from rapid7

9
00:00:18,420 --> 00:00:26,849
they have a great presentation so thank

10
00:00:20,189 --> 00:00:29,698
you well thanks everybody for sticking

11
00:00:26,849 --> 00:00:31,109
around I'm really gonna have a tough

12
00:00:29,699 --> 00:00:32,790
time with this kind of thing so I'm used

13
00:00:31,109 --> 00:00:34,890
to running around when I give

14
00:00:32,790 --> 00:00:36,180
presentations but I got a stay near the

15
00:00:34,890 --> 00:00:37,590
microphone because we're recording and

16
00:00:36,180 --> 00:00:39,210
all that so if you seen you start

17
00:00:37,590 --> 00:00:41,520
wandering over I already told Erin to

18
00:00:39,210 --> 00:00:44,969
make sure to chain me back down here oh

19
00:00:41,520 --> 00:00:46,980
yeah well I guess we'll yeah so just

20
00:00:44,969 --> 00:00:50,370
tell me to get back or whatever so who

21
00:00:46,980 --> 00:00:52,739
are these guys we'll start off my name

22
00:00:50,370 --> 00:00:56,160
is Erin or a Ron as I get called all the

23
00:00:52,739 --> 00:00:57,599
freaking time can't go anywhere without

24
00:00:56,160 --> 00:00:58,410
it so I just have a shirt and I accept

25
00:00:57,600 --> 00:01:00,809
it now it's Who I am

26
00:00:58,410 --> 00:01:03,328
so I previously was a Knicks

27
00:01:00,809 --> 00:01:06,060
administrator I guess kind of doing like

28
00:01:03,329 --> 00:01:08,640
SEC DevOps stuff before the second

29
00:01:06,060 --> 00:01:09,869
DevOps movement but it was they just

30
00:01:08,640 --> 00:01:12,000
called me a Knicks admin I get a fancy

31
00:01:09,869 --> 00:01:14,280
title and then I worked as a security

32
00:01:12,000 --> 00:01:16,200
admin financial sector and now I pentest

33
00:01:14,280 --> 00:01:17,729
over at rapid7 during the financial

34
00:01:16,200 --> 00:01:19,049
sector I did a lot of Blue Team and Red

35
00:01:17,729 --> 00:01:21,179
Team type stuff and that kind of

36
00:01:19,049 --> 00:01:24,090
transition into my pentest consulting

37
00:01:21,180 --> 00:01:26,810
career so it's been fun so far my name

38
00:01:24,090 --> 00:01:30,000
is Patrick and I'm a pen tester I

39
00:01:26,810 --> 00:01:32,670
previously worked at the Akamai cert but

40
00:01:30,000 --> 00:01:34,979
been doing web dev as anybody watched

41
00:01:32,670 --> 00:01:37,380
security weekly ever ooh

42
00:01:34,979 --> 00:01:40,200
so sometimes Paul lets me be on that

43
00:01:37,380 --> 00:01:42,750
whenever Larry has to travel I got a Def

44
00:01:40,200 --> 00:01:44,310
Con 401 group up there and I'm also the

45
00:01:42,750 --> 00:01:46,020
one that if you follow the layer eight

46
00:01:44,310 --> 00:01:47,909
conference Twitter account I spam the

47
00:01:46,020 --> 00:01:50,369
heck out of you with messages constantly

48
00:01:47,909 --> 00:01:51,930
and if you've been following that as

49
00:01:50,369 --> 00:01:54,299
well we're gonna give away a free ticket

50
00:01:51,930 --> 00:01:55,710
to the lair a conference at the very end

51
00:01:54,299 --> 00:01:58,320
I get a special person that's gonna

52
00:01:55,710 --> 00:02:01,048
throw one of our little swag balls out

53
00:01:58,320 --> 00:02:02,729
at the end so we'll do that for anybody

54
00:02:01,049 --> 00:02:05,700
else that is interested in that kind of

55
00:02:02,729 --> 00:02:06,810
thing but first before we start let's

56
00:02:05,700 --> 00:02:08,580
give a round of applause to the

57
00:02:06,810 --> 00:02:10,878
organizers and the volunteers of this

58
00:02:08,580 --> 00:02:10,879
conference

59
00:02:12,680 --> 00:02:18,719
stock up putting on a conference like

60
00:02:16,499 --> 00:02:20,670
this is a crap ton of work I sometimes

61
00:02:18,719 --> 00:02:22,319
help out it another b-sides that's a

62
00:02:20,670 --> 00:02:25,170
little bit north of here at some small

63
00:02:22,319 --> 00:02:27,420
town and they're just kind of a lot of

64
00:02:25,170 --> 00:02:29,578
work so those are the people that do it

65
00:02:27,420 --> 00:02:31,200
so make sure you thank them what else

66
00:02:29,579 --> 00:02:34,739
we're gonna be talking about today let's

67
00:02:31,200 --> 00:02:35,518
see type of pen test that we do at

68
00:02:34,739 --> 00:02:37,019
rapid7

69
00:02:35,519 --> 00:02:39,389
these are all the different types that

70
00:02:37,019 --> 00:02:42,299
we can sometimes do web apps mobile apps

71
00:02:39,389 --> 00:02:45,780
internal external network testing all

72
00:02:42,299 --> 00:02:48,810
types of social engineering code reviews

73
00:02:45,780 --> 00:02:50,699
red team engagements IOT lots of fun

74
00:02:48,810 --> 00:02:51,930
stuff but there's only a couple that

75
00:02:50,699 --> 00:02:54,409
we're going to be talking about because

76
00:02:51,930 --> 00:02:56,400
we're gonna be kind of telling stories

77
00:02:54,409 --> 00:02:58,679
tell you different ways that we've done

78
00:02:56,400 --> 00:03:00,510
some of these types of tests as well as

79
00:02:58,680 --> 00:03:02,489
mitigations as well so you can kind of

80
00:03:00,510 --> 00:03:05,250
take these things back and fix them so

81
00:03:02,489 --> 00:03:12,840
yeah well kind of tell some stories with

82
00:03:05,250 --> 00:03:14,159
them starting with the external so like

83
00:03:12,840 --> 00:03:15,689
patrick said we'll have stories and just

84
00:03:14,159 --> 00:03:17,759
basic bones you know there's nothing

85
00:03:15,689 --> 00:03:19,828
rocket science here it's all super super

86
00:03:17,759 --> 00:03:22,078
basic that's why you know the title is

87
00:03:19,829 --> 00:03:24,389
easy ways to make our job harder really

88
00:03:22,079 --> 00:03:27,060
easy things to fix really easy ways we

89
00:03:24,389 --> 00:03:28,949
get in you know I'd like my job to be

90
00:03:27,060 --> 00:03:30,269
more than 30 minutes on a Monday to

91
00:03:28,949 --> 00:03:32,549
getting into your network because I'd

92
00:03:30,269 --> 00:03:34,979
like to actually you know do challenging

93
00:03:32,549 --> 00:03:36,090
attacks and yeah but you find boring

94
00:03:34,979 --> 00:03:39,120
ways all the time so we're gonna go over

95
00:03:36,090 --> 00:03:40,739
the boring ways please fix those yeah if

96
00:03:39,120 --> 00:03:42,209
you work on that side of the house so

97
00:03:40,739 --> 00:03:44,189
favorite methods we have like week

98
00:03:42,209 --> 00:03:46,590
domain passwords week egress filtering

99
00:03:44,189 --> 00:03:48,209
lack of multi-factor authentication and

100
00:03:46,590 --> 00:03:50,310
exposed web admin panels we're gonna get

101
00:03:48,209 --> 00:03:52,639
over those get into each of those but

102
00:03:50,310 --> 00:03:55,949
you know this is very external network

103
00:03:52,639 --> 00:03:58,109
so weak domain passwords the downfall of

104
00:03:55,949 --> 00:03:59,400
pretty much every company who has to use

105
00:03:58,109 --> 00:04:01,319
passwords as their sole form of

106
00:03:59,400 --> 00:04:03,840
authentication will get to multi-factor

107
00:04:01,319 --> 00:04:05,759
or later but we usually discover this

108
00:04:03,840 --> 00:04:08,430
through a password spraying or a lack of

109
00:04:05,759 --> 00:04:10,048
network egress controls so passwords

110
00:04:08,430 --> 00:04:11,519
bringing type stuff before we can

111
00:04:10,049 --> 00:04:13,590
password spray a portal we have to

112
00:04:11,519 --> 00:04:15,989
somehow get usernames and Thank You

113
00:04:13,590 --> 00:04:17,370
handy tools like websites like linkedin

114
00:04:15,989 --> 00:04:20,070
where everyone wants to say where they

115
00:04:17,370 --> 00:04:20,880
work in their names and then you can do

116
00:04:20,070 --> 00:04:22,800
Osen and

117
00:04:20,880 --> 00:04:26,630
other ways you know the harvester recon

118
00:04:22,800 --> 00:04:29,160
ng mal ta go pastebin dumb census data

119
00:04:26,630 --> 00:04:30,540
Google you know if they have no sessions

120
00:04:29,160 --> 00:04:33,720
they're internally can ask the domain

121
00:04:30,540 --> 00:04:36,380
controller one of the other kind of fun

122
00:04:33,720 --> 00:04:38,250
things with this I remember one of the

123
00:04:36,380 --> 00:04:41,250
stories I guess a little bit already

124
00:04:38,250 --> 00:04:43,080
real quick couple weeks ago had a

125
00:04:41,250 --> 00:04:45,000
university and one of the nice things

126
00:04:43,080 --> 00:04:47,460
about universities is they have the

127
00:04:45,000 --> 00:04:48,960
address books so one of the first things

128
00:04:47,460 --> 00:04:51,270
that I wanted to do was to get names

129
00:04:48,960 --> 00:04:52,919
because that's the first step that we're

130
00:04:51,270 --> 00:04:54,930
actually trying to get here is user

131
00:04:52,920 --> 00:04:57,330
names so the way we get user names is

132
00:04:54,930 --> 00:04:58,830
through names and the way that we kind

133
00:04:57,330 --> 00:05:00,479
of get names is through all these kinds

134
00:04:58,830 --> 00:05:01,890
of sources if you're not really familiar

135
00:05:00,480 --> 00:05:03,630
with these kinds of things like the

136
00:05:01,890 --> 00:05:04,380
harvester is a tool that's in Cali it's

137
00:05:03,630 --> 00:05:06,570
pretty awesome

138
00:05:04,380 --> 00:05:08,370
recon ng Tim tomes built that it's also

139
00:05:06,570 --> 00:05:10,170
pretty awesome with modules in there as

140
00:05:08,370 --> 00:05:11,490
well but one of my favorites is the

141
00:05:10,170 --> 00:05:12,840
company address book does anybody have a

142
00:05:11,490 --> 00:05:17,130
company address book don't raise your

143
00:05:12,840 --> 00:05:18,539
hand because I loved it when they have

144
00:05:17,130 --> 00:05:21,000
these kind of things because let's see

145
00:05:18,540 --> 00:05:22,740
if you work for like Acme comm one of

146
00:05:21,000 --> 00:05:23,940
the things that we love to do is we'll

147
00:05:22,740 --> 00:05:26,160
just go to your address book and put in

148
00:05:23,940 --> 00:05:28,860
at Acme calm and guess what most address

149
00:05:26,160 --> 00:05:30,720
books do they're gonna output everything

150
00:05:28,860 --> 00:05:31,890
maybe you got to put in like a wild card

151
00:05:30,720 --> 00:05:34,470
or something like that in front of it

152
00:05:31,890 --> 00:05:36,479
but it was super easy just kind of

153
00:05:34,470 --> 00:05:38,610
dumped the entire company first name

154
00:05:36,480 --> 00:05:39,930
last name kind of thing from there it

155
00:05:38,610 --> 00:05:41,820
was just going to be a matter of

156
00:05:39,930 --> 00:05:45,750
figuring out what was the actual

157
00:05:41,820 --> 00:05:46,950
username format it's very very common I

158
00:05:45,750 --> 00:05:48,330
mean especially if you work in a

159
00:05:46,950 --> 00:05:50,729
government type organization when you're

160
00:05:48,330 --> 00:05:51,659
doing pen tests for cities or anything

161
00:05:50,730 --> 00:05:53,610
where you have to have that data

162
00:05:51,660 --> 00:05:55,890
publicly exposed because they're you

163
00:05:53,610 --> 00:05:57,510
know working in the public sector pretty

164
00:05:55,890 --> 00:05:59,190
common to go out there and look up and

165
00:05:57,510 --> 00:06:01,020
be able to find an employee directory

166
00:05:59,190 --> 00:06:02,940
and sometimes it'll be like the web page

167
00:06:01,020 --> 00:06:05,010
is slash hey show me everyone who starts

168
00:06:02,940 --> 00:06:07,020
with a slash B and so you just write a

169
00:06:05,010 --> 00:06:09,090
quick bash grip you know curl go grab

170
00:06:07,020 --> 00:06:10,380
all those pages parse it all grab the

171
00:06:09,090 --> 00:06:11,640
user names with some said a knock foo

172
00:06:10,380 --> 00:06:13,890
and next thing you know you have a list

173
00:06:11,640 --> 00:06:16,919
of usernames that your spring against

174
00:06:13,890 --> 00:06:19,140
something huh I'll get the domain

175
00:06:16,920 --> 00:06:22,380
controller on the internal later yeah I

176
00:06:19,140 --> 00:06:23,640
know so he bring up ask the domain

177
00:06:22,380 --> 00:06:24,300
controller we'll talk about that a

178
00:06:23,640 --> 00:06:25,830
little bit

179
00:06:24,300 --> 00:06:27,570
no sessions later on we get to the

180
00:06:25,830 --> 00:06:29,190
internal side but if you expose your

181
00:06:27,570 --> 00:06:32,760
domain controller to the internet one

182
00:06:29,190 --> 00:06:33,930
well that's a problem too you should fix

183
00:06:32,760 --> 00:06:35,130
that to start

184
00:06:33,930 --> 00:06:36,390
- once you're on an internal network

185
00:06:35,130 --> 00:06:38,040
sometimes you can just be like hey

186
00:06:36,390 --> 00:06:40,320
domain controller give me a list of all

187
00:06:38,040 --> 00:06:41,400
users movie through sessions where it

188
00:06:40,320 --> 00:06:43,500
doesn't require a username and password

189
00:06:41,400 --> 00:06:45,179
except anonymous login like you guys

190
00:06:43,500 --> 00:06:47,460
know maybe the net user command and the

191
00:06:45,180 --> 00:06:48,720
Windows domain same thing it's basically

192
00:06:47,460 --> 00:06:50,729
that's all it's doing it's asking the

193
00:06:48,720 --> 00:06:52,440
domain controller st. give me all your

194
00:06:50,730 --> 00:06:53,850
user names you can do the same thing or

195
00:06:52,440 --> 00:06:55,170
if you've compromised credentials that's

196
00:06:53,850 --> 00:06:56,940
a great way to get all the other user

197
00:06:55,170 --> 00:06:59,600
names and service accounts and start

198
00:06:56,940 --> 00:07:01,770
password spurring them another option

199
00:06:59,600 --> 00:07:04,200
some companies think they're you know

200
00:07:01,770 --> 00:07:06,090
stealthy and they go oh well if we don't

201
00:07:04,200 --> 00:07:08,099
use first name last name or first

202
00:07:06,090 --> 00:07:10,020
initial last name something like that

203
00:07:08,100 --> 00:07:12,330
people can't guess our user name so here

204
00:07:10,020 --> 00:07:16,229
there's an example the company uses AI

205
00:07:12,330 --> 00:07:19,050
UHT 18 what does that mean I have no

206
00:07:16,230 --> 00:07:20,460
clue but we were able to use Foca which

207
00:07:19,050 --> 00:07:23,460
is an open-source intelligence gathering

208
00:07:20,460 --> 00:07:25,950
tool to go scan the internet for

209
00:07:23,460 --> 00:07:27,599
documents and pull metadata so focus

210
00:07:25,950 --> 00:07:29,250
best light specializes and getting

211
00:07:27,600 --> 00:07:30,960
metadata from documents so if you

212
00:07:29,250 --> 00:07:33,270
publish like Word documents to the

213
00:07:30,960 --> 00:07:34,710
internet PDFs they have metadata they

214
00:07:33,270 --> 00:07:37,469
usually have authors and then if you can

215
00:07:34,710 --> 00:07:39,150
find the username format you know since

216
00:07:37,470 --> 00:07:41,520
they were so brilliant and decided that

217
00:07:39,150 --> 00:07:43,859
we're gonna hide our user names and use

218
00:07:41,520 --> 00:07:48,349
these really obscure user names they

219
00:07:43,860 --> 00:07:50,760
incrementing them so AI UHT 19 20 21 22

220
00:07:48,350 --> 00:07:52,350
so instead of me having to go search all

221
00:07:50,760 --> 00:07:54,150
these user names I was pretty much able

222
00:07:52,350 --> 00:07:57,780
to incrementally go through them and

223
00:07:54,150 --> 00:07:59,159
find them and then oh so then you can

224
00:07:57,780 --> 00:08:00,840
start password spraying at that point

225
00:07:59,160 --> 00:08:02,970
and user name enumeration will let him

226
00:08:00,840 --> 00:08:05,760
take that over so a couple of the other

227
00:08:02,970 --> 00:08:08,880
ways that we often find what's the valid

228
00:08:05,760 --> 00:08:10,170
user name format a lot of times it's

229
00:08:08,880 --> 00:08:12,240
just whatever's in front of the @ sign

230
00:08:10,170 --> 00:08:13,770
in your email so that's one of the first

231
00:08:12,240 --> 00:08:15,060
places first things that I'll try is

232
00:08:13,770 --> 00:08:16,500
just kind of go look to see what the

233
00:08:15,060 --> 00:08:18,120
email addresses and see what's in front

234
00:08:16,500 --> 00:08:20,490
of there another website that you can

235
00:08:18,120 --> 00:08:21,870
take a look at hunter IO is kind of nice

236
00:08:20,490 --> 00:08:23,820
where they tell you what a lot of

237
00:08:21,870 --> 00:08:25,500
different username formats are for

238
00:08:23,820 --> 00:08:28,620
companies so that kind of works as well

239
00:08:25,500 --> 00:08:30,780
so once we get user names we're trying

240
00:08:28,620 --> 00:08:32,960
to actually get access into the company

241
00:08:30,780 --> 00:08:35,549
we're trying to log in and get

242
00:08:32,960 --> 00:08:37,800
authentication so we got user names

243
00:08:35,549 --> 00:08:40,579
that's half the equation the other half

244
00:08:37,799 --> 00:08:42,809
that we need is passwords so

245
00:08:40,580 --> 00:08:45,300
what we're gonna try to do now is just

246
00:08:42,809 --> 00:08:47,130
kind of guess at passwords but instead

247
00:08:45,300 --> 00:08:48,359
of doing brute forcing

248
00:08:47,130 --> 00:08:49,949
we're gonna do password spring and

249
00:08:48,360 --> 00:08:51,660
there's actually a difference because

250
00:08:49,949 --> 00:08:53,099
one of the things that people will often

251
00:08:51,660 --> 00:08:54,389
say when we say that we're gonna try to

252
00:08:53,100 --> 00:08:55,769
guess password it's like well I get a

253
00:08:54,389 --> 00:08:57,810
count lockout so I don't really worry

254
00:08:55,769 --> 00:08:59,910
about that it's like okay those account

255
00:08:57,810 --> 00:09:01,469
lockout sir those are nice

256
00:08:59,910 --> 00:09:03,240
but it's really not gonna stop against

257
00:09:01,470 --> 00:09:04,980
this kind of thing so much because what

258
00:09:03,240 --> 00:09:07,440
we're doing when you think of the brute

259
00:09:04,980 --> 00:09:09,240
forcing and what the lock outs are going

260
00:09:07,440 --> 00:09:11,310
to do is you start thinking that we're

261
00:09:09,240 --> 00:09:13,170
just going to go get the top 1000

262
00:09:11,310 --> 00:09:14,489
passwords off of the LinkedIn dump or

263
00:09:13,170 --> 00:09:16,949
something like that and throw it at

264
00:09:14,490 --> 00:09:19,139
users that's not what we're gonna do

265
00:09:16,949 --> 00:09:20,819
that wouldn't work too well so what we

266
00:09:19,139 --> 00:09:23,459
do is we have a pretty good idea of what

267
00:09:20,819 --> 00:09:25,529
passwords your people like to use and

268
00:09:23,459 --> 00:09:27,949
we're gonna show some passwords that I

269
00:09:25,529 --> 00:09:30,449
can guarantee are in your network or

270
00:09:27,949 --> 00:09:31,949
might even be some people in those rooms

271
00:09:30,449 --> 00:09:34,829
passwords I've given this presentation

272
00:09:31,949 --> 00:09:36,329
similar presentation before usually to

273
00:09:34,829 --> 00:09:37,589
non security people and they come up to

274
00:09:36,329 --> 00:09:42,269
me after and go I could have changed my

275
00:09:37,589 --> 00:09:44,000
password now okay that's good good to

276
00:09:42,269 --> 00:09:47,790
know what was your password by the way

277
00:09:44,000 --> 00:09:49,050
they didn't tell me so what we were what

278
00:09:47,790 --> 00:09:50,880
we're going to do is since we know what

279
00:09:49,050 --> 00:09:52,258
common passwords are so we're gonna go

280
00:09:50,880 --> 00:09:55,170
get all those usernames and try one

281
00:09:52,259 --> 00:09:57,120
password is that gonna lock out that's

282
00:09:55,170 --> 00:09:59,069
not gonna that's one guess that's not

283
00:09:57,120 --> 00:10:01,439
gonna lock out and if we have a pretty

284
00:09:59,069 --> 00:10:03,540
good idea of what these pretty weak

285
00:10:01,439 --> 00:10:05,639
passwords are eventually we're gonna

286
00:10:03,540 --> 00:10:06,990
guess them and one of the things that

287
00:10:05,639 --> 00:10:08,459
I've kind of noticed is once you start

288
00:10:06,990 --> 00:10:11,459
getting up over three hundred four

289
00:10:08,459 --> 00:10:13,018
hundred users accounts we're probably

290
00:10:11,459 --> 00:10:14,969
gonna get at least one once you start

291
00:10:13,019 --> 00:10:17,550
getting up in the thousands we sometimes

292
00:10:14,970 --> 00:10:20,279
get dozens with these weak passwords so

293
00:10:17,550 --> 00:10:22,709
there's three that I try to tell people

294
00:10:20,279 --> 00:10:24,240
do not let anybody in your network use

295
00:10:22,709 --> 00:10:25,829
these passwords because these are the

296
00:10:24,240 --> 00:10:28,380
ones we're going to guess and these work

297
00:10:25,829 --> 00:10:32,209
100% of the time at least one of them

298
00:10:28,380 --> 00:10:35,100
usually all three what's one of them

299
00:10:32,209 --> 00:10:38,149
okay some variation of password we

300
00:10:35,100 --> 00:10:40,620
always see that how is that still there

301
00:10:38,149 --> 00:10:42,449
once in a great while I do see literally

302
00:10:40,620 --> 00:10:43,800
all lowercase password and that person's

303
00:10:42,449 --> 00:10:47,160
just not even trying anymore they just

304
00:10:43,800 --> 00:10:49,560
gave up but we do see some of these

305
00:10:47,160 --> 00:10:51,439
really secure ones like P at signed

306
00:10:49,560 --> 00:10:53,699
dollar sign dollar sign knowing that's

307
00:10:51,439 --> 00:10:54,800
like super secure I guess because

308
00:10:53,699 --> 00:10:59,189
somebody told them that

309
00:10:54,800 --> 00:11:00,579
yeah that's leet stuff so that's one

310
00:10:59,189 --> 00:11:03,939
password is virtually

311
00:11:00,579 --> 00:11:07,569
always in there what's next good shut it

312
00:11:03,939 --> 00:11:13,959
out there we go a variation of company

313
00:11:07,569 --> 00:11:15,759
name it'll take that for 200 so yeah

314
00:11:13,959 --> 00:11:17,049
something about the company name that's

315
00:11:15,759 --> 00:11:18,399
one of the next things that I'm always

316
00:11:17,049 --> 00:11:20,139
gonna throw in there whatever your

317
00:11:18,399 --> 00:11:22,059
company name is then maybe the year

318
00:11:20,139 --> 00:11:24,309
maybe an exclamation point something

319
00:11:22,059 --> 00:11:26,639
like that is always going to be there

320
00:11:24,309 --> 00:11:28,809
what's next

321
00:11:26,639 --> 00:11:32,439
there we go these guys are on top of

322
00:11:28,809 --> 00:11:34,600
this season year why does season year

323
00:11:32,439 --> 00:11:36,670
work and that's because of our password

324
00:11:34,600 --> 00:11:39,220
policies think of what your password

325
00:11:36,670 --> 00:11:41,229
policy is your password policy is

326
00:11:39,220 --> 00:11:42,910
generally going to be you need three out

327
00:11:41,230 --> 00:11:45,670
of four uppercase lowercase special

328
00:11:42,910 --> 00:11:47,259
number right and then we also require

329
00:11:45,670 --> 00:11:49,689
that they change their password once

330
00:11:47,259 --> 00:11:52,899
every three months makes sense right

331
00:11:49,689 --> 00:11:53,889
because for security so once every three

332
00:11:52,899 --> 00:11:57,279
month what else happens every three

333
00:11:53,889 --> 00:11:58,629
months seasons change and if you just

334
00:11:57,279 --> 00:12:00,249
put the year at the end you're gonna get

335
00:11:58,629 --> 00:12:03,970
something new every time so if we do

336
00:12:00,249 --> 00:12:05,649
Summer 2018 fall 2018 with an uppercase

337
00:12:03,970 --> 00:12:07,269
F for an uppercase s we have our

338
00:12:05,649 --> 00:12:08,799
uppercase lowercase in our number and if

339
00:12:07,269 --> 00:12:10,779
we really want to be secure we'll put an

340
00:12:08,799 --> 00:12:15,429
exclamation point at the end so we get

341
00:12:10,779 --> 00:12:17,919
all four okay so yeah those kinds of

342
00:12:15,429 --> 00:12:19,988
things are virtually always going to be

343
00:12:17,919 --> 00:12:21,399
there so the next thing where do we

344
00:12:19,989 --> 00:12:23,889
spray these kind of things where are we

345
00:12:21,399 --> 00:12:26,169
going to try them well login portals is

346
00:12:23,889 --> 00:12:28,149
certainly a great place VPN is one of my

347
00:12:26,169 --> 00:12:30,040
favorite places because once that works

348
00:12:28,149 --> 00:12:31,600
we're in you know a VPN gives you an

349
00:12:30,040 --> 00:12:34,509
access to the internal network and

350
00:12:31,600 --> 00:12:37,089
another one is your outlook web access

351
00:12:34,509 --> 00:12:40,149
your Ola and Ola is pretty awesome

352
00:12:37,089 --> 00:12:41,470
because there's Metasploit modules for

353
00:12:40,149 --> 00:12:43,779
it that lets you do these kind of things

354
00:12:41,470 --> 00:12:45,850
as well there's a Metasploit module

355
00:12:43,779 --> 00:12:48,129
called auxilary scanner HTTP oh login

356
00:12:45,850 --> 00:12:50,679
where all you got to do is just point it

357
00:12:48,129 --> 00:12:52,529
at the IP address for OA with a whole

358
00:12:50,679 --> 00:12:55,269
big file of these usernames that we just

359
00:12:52,529 --> 00:12:57,369
scavenged up from somewhere and put in

360
00:12:55,269 --> 00:12:59,829
one password and say go and it's gonna

361
00:12:57,369 --> 00:13:01,989
tell us which ones are valid even better

362
00:12:59,829 --> 00:13:03,849
is it kind of does user name enumeration

363
00:13:01,989 --> 00:13:06,160
for us we kind of see up there where it

364
00:13:03,850 --> 00:13:09,189
is showing us you know a failed login

365
00:13:06,160 --> 00:13:10,389
isn't any good but even better there's

366
00:13:09,189 --> 00:13:11,860
another one says failed login but

367
00:13:10,389 --> 00:13:13,620
username is valid so it's doing that

368
00:13:11,860 --> 00:13:16,020
user name enumeration for us

369
00:13:13,620 --> 00:13:18,600
so sometimes when I'm trying to figure

370
00:13:16,020 --> 00:13:20,699
out what is the proper username format

371
00:13:18,600 --> 00:13:22,680
I'll just throw it into this module and

372
00:13:20,700 --> 00:13:24,030
it'll tell me I just use that this week

373
00:13:22,680 --> 00:13:27,599
and I did my little happy dance when I

374
00:13:24,030 --> 00:13:29,339
guessed right but even better is it'll

375
00:13:27,600 --> 00:13:33,390
also tell us when we have a successful

376
00:13:29,340 --> 00:13:36,420
login ok so this is again going to be

377
00:13:33,390 --> 00:13:38,550
that that same Metasploit module and it

378
00:13:36,420 --> 00:13:40,349
probably looks pretty bad and I know a

379
00:13:38,550 --> 00:13:42,120
lot of times when we do our

380
00:13:40,350 --> 00:13:43,980
presentations we create these little

381
00:13:42,120 --> 00:13:45,750
contrived models to put up here so that

382
00:13:43,980 --> 00:13:49,500
we don't actually show customer data

383
00:13:45,750 --> 00:13:51,720
this is customer data this was on a pen

384
00:13:49,500 --> 00:13:53,430
test that I did he kind of get an idea

385
00:13:51,720 --> 00:13:56,610
by the username admin admin that was

386
00:13:53,430 --> 00:13:58,199
probably something higher level so most

387
00:13:56,610 --> 00:14:00,240
people have an idea of how these levels

388
00:13:58,200 --> 00:14:02,760
kind of go you have your regular domain

389
00:14:00,240 --> 00:14:04,340
user that's not what this is then

390
00:14:02,760 --> 00:14:08,490
sometimes you have a local administrator

391
00:14:04,340 --> 00:14:11,070
that's not what this is then you have a

392
00:14:08,490 --> 00:14:13,470
domain administrator right that's not

393
00:14:11,070 --> 00:14:19,110
what this is then you have an enterprise

394
00:14:13,470 --> 00:14:21,480
administrator that's what this is I put

395
00:14:19,110 --> 00:14:23,010
this through and because I had this

396
00:14:21,480 --> 00:14:24,960
access I was able to see all the groups

397
00:14:23,010 --> 00:14:27,060
in the domain controller and looked up

398
00:14:24,960 --> 00:14:28,860
what groups is admin admin in and it was

399
00:14:27,060 --> 00:14:30,989
in the enterprise admins group I went

400
00:14:28,860 --> 00:14:32,880
over to my person I was working with I

401
00:14:30,990 --> 00:14:34,740
was like did you know that the password

402
00:14:32,880 --> 00:14:37,200
for your enterprise administrator is one

403
00:14:34,740 --> 00:14:43,800
two three four five he said that's the

404
00:14:37,200 --> 00:14:46,500
password for my luggage okay anyway all

405
00:14:43,800 --> 00:14:48,089
right so yet that's kind of some of the

406
00:14:46,500 --> 00:14:50,910
ways that we are able to do these kind

407
00:14:48,090 --> 00:14:53,010
of things as far as the the password

408
00:14:50,910 --> 00:14:54,900
guessing and of course you know worrying

409
00:14:53,010 --> 00:14:58,140
about our getting our best summer ever

410
00:14:54,900 --> 00:15:00,000
as well so I guess that's some stories

411
00:14:58,140 --> 00:15:01,290
but this is one I can't remember if this

412
00:15:00,000 --> 00:15:05,010
is where we want to tell that kind of

413
00:15:01,290 --> 00:15:06,810
fun story anyway like we'll go for it so

414
00:15:05,010 --> 00:15:09,480
I was doing this password guessing on

415
00:15:06,810 --> 00:15:12,119
this one test and sure enough best

416
00:15:09,480 --> 00:15:14,730
summer ever it worked I had you know all

417
00:15:12,120 --> 00:15:17,010
my users I start throwing it out and one

418
00:15:14,730 --> 00:15:20,280
gets me in so I was spraying against the

419
00:15:17,010 --> 00:15:21,870
VPN and I see that I got access and I

420
00:15:20,280 --> 00:15:23,850
see that the password was just Summer

421
00:15:21,870 --> 00:15:25,860
2018 I'm like okay this is pretty cool

422
00:15:23,850 --> 00:15:26,810
but sure enough it's just about always

423
00:15:25,860 --> 00:15:30,380
going to work

424
00:15:26,810 --> 00:15:32,300
so just by chance I was like well let's

425
00:15:30,380 --> 00:15:34,280
make sure now that I'm in because I you

426
00:15:32,300 --> 00:15:35,810
know got my you know inside shell and

427
00:15:34,280 --> 00:15:37,670
all that I'm kind of zipping around the

428
00:15:35,810 --> 00:15:39,920
network like let me just kind of check

429
00:15:37,670 --> 00:15:41,390
this with crack map exact that's another

430
00:15:39,920 --> 00:15:43,310
tool that we like to use against a

431
00:15:41,390 --> 00:15:45,860
domain controller one of the nice things

432
00:15:43,310 --> 00:15:48,229
about crack map exec when you use it to

433
00:15:45,860 --> 00:15:49,910
log into a host it'll tell you if it's a

434
00:15:48,230 --> 00:15:52,280
local administrator on that host by

435
00:15:49,910 --> 00:15:54,770
saying pwned you know you you own this

436
00:15:52,280 --> 00:15:55,250
machine so I took that user that I

437
00:15:54,770 --> 00:15:57,050
guessed

438
00:15:55,250 --> 00:15:59,210
summer 2018 to get through the VPN and

439
00:15:57,050 --> 00:15:59,839
used crack map exec on a domain

440
00:15:59,210 --> 00:16:03,080
controller

441
00:15:59,840 --> 00:16:05,540
it said pwned I'm like you gotta be

442
00:16:03,080 --> 00:16:09,530
kidding me this user with summer 2018 is

443
00:16:05,540 --> 00:16:11,990
a domain admin and sure enough because

444
00:16:09,530 --> 00:16:13,579
of some other privileges the person was

445
00:16:11,990 --> 00:16:15,320
actually just like an accountant or

446
00:16:13,580 --> 00:16:18,050
something but for some reason the

447
00:16:15,320 --> 00:16:19,640
accountants had full local administrator

448
00:16:18,050 --> 00:16:21,410
rights on a domain controller which I

449
00:16:19,640 --> 00:16:24,350
didn't understand and I think they

450
00:16:21,410 --> 00:16:26,420
didn't either so we kind of worked our

451
00:16:24,350 --> 00:16:28,970
way through that one as well what our

452
00:16:26,420 --> 00:16:32,240
remediation well we know that we want

453
00:16:28,970 --> 00:16:33,710
stronger better passwords it's probably

454
00:16:32,240 --> 00:16:35,720
not a good idea to make people be

455
00:16:33,710 --> 00:16:37,280
changing I think NIST also just updated

456
00:16:35,720 --> 00:16:39,380
their guidelines recently to tell you

457
00:16:37,280 --> 00:16:42,140
don't make people change their their

458
00:16:39,380 --> 00:16:44,390
passwords because of that summer 20:18

459
00:16:42,140 --> 00:16:47,300
fall 2018 kind of problem that people

460
00:16:44,390 --> 00:16:48,620
are creating weaker passwords the only

461
00:16:47,300 --> 00:16:50,209
time that you really want them to be

462
00:16:48,620 --> 00:16:51,830
changing their passwords is if there's

463
00:16:50,210 --> 00:16:53,480
any kind of indication of compromised if

464
00:16:51,830 --> 00:16:55,580
you have a reason to believe that you've

465
00:16:53,480 --> 00:16:56,540
been compromised change the password if

466
00:16:55,580 --> 00:16:58,670
there's no reason to believe that

467
00:16:56,540 --> 00:17:02,780
there's a compromise going on just let

468
00:16:58,670 --> 00:17:05,020
them stick with it as is yeah of course

469
00:17:02,780 --> 00:17:07,270
we don't really want to just worry about

470
00:17:05,020 --> 00:17:10,460
the security of usernames and passwords

471
00:17:07,270 --> 00:17:12,139
so let's put that MFA on things if you

472
00:17:10,460 --> 00:17:13,970
can get people to use password managers

473
00:17:12,140 --> 00:17:15,650
that's great too I know some people say

474
00:17:13,970 --> 00:17:16,940
well that's scary having all your

475
00:17:15,650 --> 00:17:19,100
passwords in one place

476
00:17:16,940 --> 00:17:22,010
well what's the alternative I guess we

477
00:17:19,099 --> 00:17:23,480
can kind of discuss at some point but

478
00:17:22,010 --> 00:17:25,490
anytime that we're up against

479
00:17:23,480 --> 00:17:27,440
multi-factor authentication it makes our

480
00:17:25,490 --> 00:17:29,440
life much harder and that was kind of

481
00:17:27,440 --> 00:17:32,060
the title of this make our lives harder

482
00:17:29,440 --> 00:17:34,190
so that's one of the ways with that as

483
00:17:32,060 --> 00:17:35,678
well so I think Aaron's going to talk to

484
00:17:34,190 --> 00:17:37,330
you about

485
00:17:35,679 --> 00:17:38,860
yeah real quick before jumping to that

486
00:17:37,330 --> 00:17:40,299
to actually want to back up just a

487
00:17:38,860 --> 00:17:43,209
little bit yeah now the story I want to

488
00:17:40,299 --> 00:17:45,789
throw a couple things in there so first

489
00:17:43,210 --> 00:17:46,869
you have your own login that Patrick was

490
00:17:45,789 --> 00:17:48,220
talking about before we don't have a

491
00:17:46,869 --> 00:17:50,289
slide in here for it but it was worth a

492
00:17:48,220 --> 00:17:53,230
shout out how many of you using outlook

493
00:17:50,289 --> 00:17:54,908
365 instead of like you know oh your own

494
00:17:53,230 --> 00:17:56,320
local instance got a few of you in the

495
00:17:54,909 --> 00:17:58,239
crowd right how many of you are using

496
00:17:56,320 --> 00:18:01,269
Active Directory Federation services in

497
00:17:58,239 --> 00:18:03,100
front of that all right we got we got a

498
00:18:01,269 --> 00:18:05,889
couple okay it's a fun fact for you if

499
00:18:03,100 --> 00:18:09,189
you're not using a DFS and using 365 all

500
00:18:05,889 --> 00:18:11,320
in the cloud it takes your domain the

501
00:18:09,190 --> 00:18:13,239
past or the NTDs date file basically

502
00:18:11,320 --> 00:18:15,668
which has all the ntlm hashes of user

503
00:18:13,239 --> 00:18:17,590
names passwords syncs that up to the

504
00:18:15,669 --> 00:18:19,539
cloud and then authentication happens

505
00:18:17,590 --> 00:18:20,769
against that up in your o 365 instance

506
00:18:19,539 --> 00:18:23,080
it never communicates back to your

507
00:18:20,769 --> 00:18:25,480
Active Directory server because of that

508
00:18:23,080 --> 00:18:27,340
Microsoft you know feature not bug

509
00:18:25,480 --> 00:18:28,450
doesn't want to count lock out it

510
00:18:27,340 --> 00:18:30,699
doesn't actually enforce the account

511
00:18:28,450 --> 00:18:32,350
lock outs for o 365 so passwords

512
00:18:30,700 --> 00:18:34,840
throwing up there is awesome here's

513
00:18:32,350 --> 00:18:36,719
another thing passwords bring in o 365

514
00:18:34,840 --> 00:18:39,100
the activities logs that they give you

515
00:18:36,720 --> 00:18:40,149
they suck I'll throw that out there

516
00:18:39,100 --> 00:18:42,059
people have been saying you know you

517
00:18:40,149 --> 00:18:44,830
need a better way to correlate passwords

518
00:18:42,059 --> 00:18:46,840
so there's these giant logs of all these

519
00:18:44,830 --> 00:18:49,449
failed logins and you can look up failed

520
00:18:46,840 --> 00:18:52,899
logins by IP but you can't look up ok

521
00:18:49,450 --> 00:18:54,789
did the same IP login to try a failed

522
00:18:52,899 --> 00:18:56,168
login across multiple accounts and so

523
00:18:54,789 --> 00:18:58,149
you can't detect that password spray

524
00:18:56,169 --> 00:18:59,679
without actually dumping all the logs

525
00:18:58,149 --> 00:19:02,258
and writing your own parsing tool to do

526
00:18:59,679 --> 00:19:03,879
that we I wrote a PowerShell script with

527
00:19:02,259 --> 00:19:05,799
a buddy recently to kind of do that and

528
00:19:03,879 --> 00:19:07,299
then look for wherever successful logins

529
00:19:05,799 --> 00:19:09,220
happen from an IP doing password

530
00:19:07,299 --> 00:19:11,559
spraying we wrote it into the activities

531
00:19:09,220 --> 00:19:13,029
API earlier this summer two days before

532
00:19:11,559 --> 00:19:14,950
we released the two old mark software

533
00:19:13,029 --> 00:19:16,950
the activities API is evil people are

534
00:19:14,950 --> 00:19:20,249
using it for bad and they took it away

535
00:19:16,950 --> 00:19:22,480
so it came back about a month later

536
00:19:20,249 --> 00:19:23,679
after they fixed some things in it but

537
00:19:22,480 --> 00:19:24,909
they took away a lot of the

538
00:19:23,679 --> 00:19:27,309
functionality we were using to do that

539
00:19:24,909 --> 00:19:28,600
correlation so now you have to export it

540
00:19:27,309 --> 00:19:29,918
to an Excel spreadsheet to do that

541
00:19:28,600 --> 00:19:31,928
unless you're feeding everything to

542
00:19:29,919 --> 00:19:33,730
assume or you're using Active Directory

543
00:19:31,929 --> 00:19:36,940
Federation services that's why I brought

544
00:19:33,730 --> 00:19:38,830
that up at the start a TFS is basically

545
00:19:36,940 --> 00:19:41,470
you log in through there and it relays

546
00:19:38,830 --> 00:19:42,580
the communication back to oh and it

547
00:19:41,470 --> 00:19:43,990
works directly with your domain

548
00:19:42,580 --> 00:19:46,830
controller so you can enforce lock outs

549
00:19:43,990 --> 00:19:48,600
you can for stricter access controls

550
00:19:46,830 --> 00:19:50,399
and you can you know get those logs to

551
00:19:48,600 --> 00:19:56,449
your sim a lot easier anyway I just want

552
00:19:50,400 --> 00:19:56,450
to give a shout out on that moving yeah

553
00:20:01,070 --> 00:20:05,370
yeah so secondary physical device as a

554
00:20:03,570 --> 00:20:07,679
key let's say you're you know using a

555
00:20:05,370 --> 00:20:09,330
Yubikey something like that to you

556
00:20:07,680 --> 00:20:10,440
basically you plug it in and then you

557
00:20:09,330 --> 00:20:11,939
have to have that key you plugged into

558
00:20:10,440 --> 00:20:14,160
your laptop when you log in with the

559
00:20:11,940 --> 00:20:16,130
password so it's something you have like

560
00:20:14,160 --> 00:20:18,450
something you own and something you know

561
00:20:16,130 --> 00:20:20,310
yeah it's like not SMS you know you're

562
00:20:18,450 --> 00:20:21,990
not using your phone at that point you

563
00:20:20,310 --> 00:20:23,730
could use the phone as well but some

564
00:20:21,990 --> 00:20:25,620
people prefer to use maybe an RSA token

565
00:20:23,730 --> 00:20:27,930
you have a you know physical token that

566
00:20:25,620 --> 00:20:30,030
generates your key a lot of banks like

567
00:20:27,930 --> 00:20:31,890
to use those I've seen that being pretty

568
00:20:30,030 --> 00:20:33,210
common until employees leave them in

569
00:20:31,890 --> 00:20:35,340
their desk with a little wafer locks

570
00:20:33,210 --> 00:20:38,960
that take point to seconds to pick and

571
00:20:35,340 --> 00:20:42,110
that's another rant for another time

572
00:20:38,960 --> 00:20:45,240
yeah anything else on the slide awesome

573
00:20:42,110 --> 00:20:47,010
so SMB egress we want to talk a little

574
00:20:45,240 --> 00:20:49,860
bit here about okay I couldn't guess the

575
00:20:47,010 --> 00:20:51,300
password or maybe I guessed a couple

576
00:20:49,860 --> 00:20:53,729
accounts but they don't have VPN access

577
00:20:51,300 --> 00:20:56,399
they don't have email access externally

578
00:20:53,730 --> 00:20:57,840
not much to do there so another way we

579
00:20:56,400 --> 00:21:00,120
like to capture passwords is we'd like

580
00:20:57,840 --> 00:21:02,280
to send emails with HTML image tags and

581
00:21:00,120 --> 00:21:04,949
them or put on an Internet Explorer or

582
00:21:02,280 --> 00:21:06,389
sorry a web page a image tag in it but

583
00:21:04,950 --> 00:21:08,070
it's not a normal image tag it's an

584
00:21:06,390 --> 00:21:10,860
image tag that's making a file reference

585
00:21:08,070 --> 00:21:13,950
so instead of like HTTP website name dot

586
00:21:10,860 --> 00:21:16,830
jpg for our file its file colon slash

587
00:21:13,950 --> 00:21:18,660
slash and then the path to our server

588
00:21:16,830 --> 00:21:20,699
and what that tries to do is windows alt

589
00:21:18,660 --> 00:21:22,290
is awesome by the way it tries to

590
00:21:20,700 --> 00:21:24,990
authenticate everything for you like

591
00:21:22,290 --> 00:21:26,159
seamless integration tell me to go here

592
00:21:24,990 --> 00:21:28,860
and I'm gonna you know send your creds

593
00:21:26,160 --> 00:21:30,990
along with it and so when Windows

594
00:21:28,860 --> 00:21:33,620
authenticates over SMB they use the hash

595
00:21:30,990 --> 00:21:36,000
called ntlm v2 or net ntlm v2 and

596
00:21:33,620 --> 00:21:37,590
whenever you connect to a file share or

597
00:21:36,000 --> 00:21:39,240
connect to something on pork for four or

598
00:21:37,590 --> 00:21:41,280
five if your windows and that file share

599
00:21:39,240 --> 00:21:42,570
says you need to authenticate the first

600
00:21:41,280 --> 00:21:44,399
thing Windows does is it takes the

601
00:21:42,570 --> 00:21:45,990
logged in user password that's trying to

602
00:21:44,400 --> 00:21:48,570
get to that file share it takes the hash

603
00:21:45,990 --> 00:21:50,010
of that the net and the ntlm hash it

604
00:21:48,570 --> 00:21:51,689
does kind of a handshake and

605
00:21:50,010 --> 00:21:53,790
authentication attempt sends over the

606
00:21:51,690 --> 00:21:54,870
net ntlm v2 hash which you can crack

607
00:21:53,790 --> 00:21:56,820
offline

608
00:21:54,870 --> 00:21:58,520
we can crack passwords offline a lot

609
00:21:56,820 --> 00:22:00,590
quicker than we can guess them

610
00:21:58,520 --> 00:22:02,810
you know millions of attempts per second

611
00:22:00,590 --> 00:22:04,189
so we try to capture hashes and then we

612
00:22:02,810 --> 00:22:06,470
crack those you know more obscure

613
00:22:04,190 --> 00:22:08,480
passwords and we do that by putting in

614
00:22:06,470 --> 00:22:09,920
this image tag in an email because like

615
00:22:08,480 --> 00:22:11,390
I said Microsoft likes to authenticate

616
00:22:09,920 --> 00:22:13,520
to everything if you open it up and

617
00:22:11,390 --> 00:22:15,020
outlook when you open that image tag in

618
00:22:13,520 --> 00:22:17,000
Outlook since it's a Microsoft product

619
00:22:15,020 --> 00:22:18,620
it tries to connect out to the Internet

620
00:22:17,000 --> 00:22:20,330
if four four five is allowed to egress

621
00:22:18,620 --> 00:22:21,800
from your internal network out to the

622
00:22:20,330 --> 00:22:23,210
Internet and you're running on windows

623
00:22:21,800 --> 00:22:24,710
opening in an Outlook it's gonna

624
00:22:23,210 --> 00:22:26,540
automatically try to authenticate to my

625
00:22:24,710 --> 00:22:29,690
rogue server so what do we do first

626
00:22:26,540 --> 00:22:32,420
things are exploiting it we stand up an

627
00:22:29,690 --> 00:22:34,370
SMB server and the SMB server is

628
00:22:32,420 --> 00:22:36,020
basically pretending to be a file share

629
00:22:34,370 --> 00:22:38,449
whenever something connects to it over

630
00:22:36,020 --> 00:22:39,889
SMB it says oh wait I need you to

631
00:22:38,450 --> 00:22:42,020
authenticate with this challenge hash

632
00:22:39,890 --> 00:22:43,700
goes back to the client the client goes

633
00:22:42,020 --> 00:22:46,340
okay let me take my Windows password

634
00:22:43,700 --> 00:22:47,600
hash it with your challenge you know

635
00:22:46,340 --> 00:22:49,760
we're gonna send it over and then they

636
00:22:47,600 --> 00:22:51,830
send it over as a net NT Lumbee to then

637
00:22:49,760 --> 00:22:53,629
you can start to crack it offline so we

638
00:22:51,830 --> 00:22:55,939
stand up our server now we gotta send

639
00:22:53,630 --> 00:22:58,220
that email to them I created an outlook

640
00:22:55,940 --> 00:23:00,140
plugin because putting HTML and outlook

641
00:22:58,220 --> 00:23:01,460
emails it's a little finicky you can

642
00:23:00,140 --> 00:23:04,220
only do it if you're using like an VB

643
00:23:01,460 --> 00:23:06,890
script so I created a nice little smiley

644
00:23:04,220 --> 00:23:09,470
face button plug-in and basically you

645
00:23:06,890 --> 00:23:11,900
click on it it you fill out your path

646
00:23:09,470 --> 00:23:13,760
here really hard to see in text wise but

647
00:23:11,900 --> 00:23:16,460
over here you'd fill out the IP address

648
00:23:13,760 --> 00:23:18,110
like file colon two backslashes your IP

649
00:23:16,460 --> 00:23:19,850
address or your server and then

650
00:23:18,110 --> 00:23:22,399
backslash again some random image

651
00:23:19,850 --> 00:23:25,100
signature JPEG whatever and then you

652
00:23:22,400 --> 00:23:27,070
send it and it shows up as they failed

653
00:23:25,100 --> 00:23:29,899
to render image when someone opens it

654
00:23:27,070 --> 00:23:30,770
they have to click download HTML images

655
00:23:29,900 --> 00:23:32,000
that's the caveat

656
00:23:30,770 --> 00:23:34,820
unless it's automatically set to

657
00:23:32,000 --> 00:23:36,260
download HTML images but people like to

658
00:23:34,820 --> 00:23:37,429
click that when they see this little X

659
00:23:36,260 --> 00:23:40,490
they're like oh maybe that's something

660
00:23:37,430 --> 00:23:41,960
important download images and then cool

661
00:23:40,490 --> 00:23:44,420
we get a bite when someone opens it up

662
00:23:41,960 --> 00:23:45,950
we get their hash and then we have their

663
00:23:44,420 --> 00:23:48,890
hash to try and crack it offline and

664
00:23:45,950 --> 00:23:50,600
find other passwords you know this one

665
00:23:48,890 --> 00:23:51,830
was winter 2018 exclamation point I

666
00:23:50,600 --> 00:23:53,600
guess we could have guessed that as well

667
00:23:51,830 --> 00:23:56,090
but here's an example of kind of what

668
00:23:53,600 --> 00:23:58,520
the net ntlm v2 hash looks like we use

669
00:23:56,090 --> 00:24:00,169
hash cat we put a word list at it and

670
00:23:58,520 --> 00:24:01,550
then we like mutate it with a bunch of

671
00:24:00,170 --> 00:24:03,800
different rules so we take all these

672
00:24:01,550 --> 00:24:05,419
common dictionary words and try every

673
00:24:03,800 --> 00:24:07,580
permutation of it using app signs or a

674
00:24:05,420 --> 00:24:09,380
symbols adding exclamation points to the

675
00:24:07,580 --> 00:24:09,909
end you know common user behavior rules

676
00:24:09,380 --> 00:24:12,730
that you

677
00:24:09,910 --> 00:24:14,530
see we modify our list with that and run

678
00:24:12,730 --> 00:24:18,480
it through hash cut and you know try and

679
00:24:14,530 --> 00:24:21,340
crack things so quick story on that

680
00:24:18,480 --> 00:24:23,470
flashback for a second when I talked

681
00:24:21,340 --> 00:24:25,780
about you had to click download images

682
00:24:23,470 --> 00:24:27,880
that's true you have to click download

683
00:24:25,780 --> 00:24:29,530
images and outlook however what if

684
00:24:27,880 --> 00:24:31,480
someone forwards that email internally

685
00:24:29,530 --> 00:24:32,649
when you send it from an external

686
00:24:31,480 --> 00:24:34,420
standpoint they have to click download

687
00:24:32,650 --> 00:24:36,160
images because an untrusted sender it's

688
00:24:34,420 --> 00:24:38,320
an unknown sender but if you're inside

689
00:24:36,160 --> 00:24:41,590
an organization and you send that email

690
00:24:38,320 --> 00:24:42,970
to another employee and you know it

691
00:24:41,590 --> 00:24:46,330
becomes a trusted email and it

692
00:24:42,970 --> 00:24:48,730
automatically downloads the images you

693
00:24:46,330 --> 00:24:51,399
know my fake SMB images here and so I

694
00:24:48,730 --> 00:24:53,290
had a test and I had figured out the

695
00:24:51,400 --> 00:24:55,360
head for four four four four five egress

696
00:24:53,290 --> 00:24:56,950
enabled and I'm like okay how can I get

697
00:24:55,360 --> 00:24:58,840
there sock I want to start cracking

698
00:24:56,950 --> 00:25:00,490
everyone in the sock I'm like well what

699
00:24:58,840 --> 00:25:01,629
do users usually do when they get a

700
00:25:00,490 --> 00:25:03,220
phishing email what's the first thing

701
00:25:01,630 --> 00:25:07,330
they do with that phishing email anyone

702
00:25:03,220 --> 00:25:10,390
know okay send a security team a a smart

703
00:25:07,330 --> 00:25:11,830
process for that is to save it or have a

704
00:25:10,390 --> 00:25:13,150
button that automatically does it for

705
00:25:11,830 --> 00:25:15,340
the user but if you're gonna train them

706
00:25:13,150 --> 00:25:17,680
then train them on the response of save

707
00:25:15,340 --> 00:25:18,939
the email to a message file attach that

708
00:25:17,680 --> 00:25:20,260
and send it over to you so you can

709
00:25:18,940 --> 00:25:22,000
analyze it and that preserves all the

710
00:25:20,260 --> 00:25:24,490
initial headers what a lot of users just

711
00:25:22,000 --> 00:25:26,410
go oh no bad email forward put an

712
00:25:24,490 --> 00:25:28,210
information security distro list we're

713
00:25:26,410 --> 00:25:29,920
good to go so that's what we did we sent

714
00:25:28,210 --> 00:25:31,540
an email and we just put like some

715
00:25:29,920 --> 00:25:33,340
Russian text in there and just made it

716
00:25:31,540 --> 00:25:35,170
look super fishy intentionally with our

717
00:25:33,340 --> 00:25:36,520
little you know image in there we

718
00:25:35,170 --> 00:25:37,720
thought I was sent it to the whole

719
00:25:36,520 --> 00:25:39,070
accounting team and one of them are

720
00:25:37,720 --> 00:25:40,870
gonna freak out and send it over to

721
00:25:39,070 --> 00:25:42,790
security thinking they're savvy and so

722
00:25:40,870 --> 00:25:44,739
they did security gets it it's

723
00:25:42,790 --> 00:25:47,500
automatically trusted now it's forwarded

724
00:25:44,740 --> 00:25:49,000
from one of the users internally it hits

725
00:25:47,500 --> 00:25:50,230
the sock team and before they knew what

726
00:25:49,000 --> 00:25:51,790
was going on all they have to do is

727
00:25:50,230 --> 00:25:52,900
click an Outlook the preview button like

728
00:25:51,790 --> 00:25:55,030
you don't have to open the email just

729
00:25:52,900 --> 00:25:56,860
click preview there hashes are rolling

730
00:25:55,030 --> 00:25:59,680
in and then we start cracking them and

731
00:25:56,860 --> 00:26:03,399
you know sock elevated users they have

732
00:25:59,680 --> 00:26:05,050
access to everything go in you can and

733
00:26:03,400 --> 00:26:06,460
we'll talk about pass the hash later if

734
00:26:05,050 --> 00:26:07,930
four four five is open externally what

735
00:26:06,460 --> 00:26:11,080
yeah well talk about that a little bit

736
00:26:07,930 --> 00:26:13,480
but not pass the hash though not with

737
00:26:11,080 --> 00:26:14,860
net ntlm be to you can do relaying the

738
00:26:13,480 --> 00:26:17,010
hash and so we'll talk about the

739
00:26:14,860 --> 00:26:19,959
differences when we get to the internal

740
00:26:17,010 --> 00:26:21,400
but yeah so we got that hash and we got

741
00:26:19,960 --> 00:26:23,309
a bunch of hashes flying in we start

742
00:26:21,400 --> 00:26:25,110
cracking the sock user hashes and

743
00:26:23,309 --> 00:26:28,950
someone had a password it was like um

744
00:26:25,110 --> 00:26:30,389
Splunk admin 29 or sorry 2018 something

745
00:26:28,950 --> 00:26:31,769
random like that maybe they just got

746
00:26:30,389 --> 00:26:33,840
done with flunked training they thought

747
00:26:31,769 --> 00:26:35,460
they were clever to do that you know and

748
00:26:33,840 --> 00:26:38,129
so they put it in there we cracked it in

749
00:26:35,460 --> 00:26:39,649
a few minutes we had access as then they

750
00:26:38,129 --> 00:26:42,809
had to factor enabled on everything

751
00:26:39,649 --> 00:26:44,489
except for their email setup well their

752
00:26:42,809 --> 00:26:46,379
VPN required a certificate that was the

753
00:26:44,490 --> 00:26:49,889
first part you had to have a SSL cert to

754
00:26:46,379 --> 00:26:51,600
get on to the VPN SSL cert but they you

755
00:26:49,889 --> 00:26:52,949
know client certificate so it's kind of

756
00:26:51,600 --> 00:26:54,199
two factors something you have and

757
00:26:52,950 --> 00:26:56,909
something you know with your password

758
00:26:54,200 --> 00:26:59,129
but they also had it set up so that

759
00:26:56,909 --> 00:27:02,039
their Outlook externally they had the

760
00:26:59,129 --> 00:27:03,869
EWS path open and so EWS is kind of like

761
00:27:02,039 --> 00:27:05,730
how your phone authenticates it's also

762
00:27:03,869 --> 00:27:07,769
kind of for API calls and you can

763
00:27:05,730 --> 00:27:09,960
authenticate and dump an entire email

764
00:27:07,769 --> 00:27:11,879
INBOX bypassing two-factor you can't put

765
00:27:09,960 --> 00:27:14,879
two factor on EWS if you leave that

766
00:27:11,879 --> 00:27:17,129
endpoint open on outlook web access they

767
00:27:14,879 --> 00:27:20,100
left it open we use this password dumped

768
00:27:17,129 --> 00:27:21,629
all his emails and lo and behold he was

769
00:27:20,100 --> 00:27:23,219
kind of a new hire and someone had sent

770
00:27:21,629 --> 00:27:25,049
him like Oh his or maybe it was a his

771
00:27:23,220 --> 00:27:26,789
cert that's what was his had expired the

772
00:27:25,049 --> 00:27:28,440
year before for his VPN and someone

773
00:27:26,789 --> 00:27:29,970
emailed him the new cert for the VPN

774
00:27:28,440 --> 00:27:32,249
access then you did for the Cisco buses

775
00:27:29,970 --> 00:27:33,809
that will be PN I'm like awesome I have

776
00:27:32,249 --> 00:27:35,850
your cert I have your password and I

777
00:27:33,809 --> 00:27:38,908
logged into VPN it's a sock employee and

778
00:27:35,850 --> 00:27:42,059
now we're internal so yeah SMB image

779
00:27:38,909 --> 00:27:43,710
tags great way to get hashes make sure

780
00:27:42,059 --> 00:27:45,418
you don't allow for four or five egress

781
00:27:43,710 --> 00:27:48,899
to the Internet you don't need it most

782
00:27:45,419 --> 00:27:51,690
ISPs block this intentionally under

783
00:27:48,899 --> 00:27:53,639
mediation but most ISPs block this from

784
00:27:51,690 --> 00:27:55,769
home users so it's hard to test this at

785
00:27:53,639 --> 00:27:57,389
your home because your ISP is like you

786
00:27:55,769 --> 00:27:58,619
don't need file share access to the

787
00:27:57,389 --> 00:27:59,969
Internet over four four five that's a

788
00:27:58,619 --> 00:28:01,980
bad idea we're gonna block it for you

789
00:27:59,970 --> 00:28:03,840
but for companies they're like you do it

790
00:28:01,980 --> 00:28:05,159
your problem not mine so they leave all

791
00:28:03,840 --> 00:28:07,678
your ports open they have to for

792
00:28:05,159 --> 00:28:11,369
business use your cases but yeah make

793
00:28:07,679 --> 00:28:13,110
sure you restrict that alright you want

794
00:28:11,369 --> 00:28:14,879
to take over the exposed or oh no

795
00:28:13,110 --> 00:28:19,439
actually sorry I'm gonna continue in

796
00:28:14,879 --> 00:28:21,418
here yeah yeah cuz the next story so

797
00:28:19,440 --> 00:28:22,710
next one we like to look for is exposed

798
00:28:21,419 --> 00:28:23,159
administrative dashboards to the

799
00:28:22,710 --> 00:28:25,320
Internet

800
00:28:23,159 --> 00:28:27,119
so we get hashes we get login usernames

801
00:28:25,320 --> 00:28:28,590
all that sometimes we can't get them

802
00:28:27,119 --> 00:28:30,119
them or sometimes everything's too

803
00:28:28,590 --> 00:28:31,799
factored there's no way we're getting in

804
00:28:30,119 --> 00:28:34,389
that way so we're gonna look for some

805
00:28:31,799 --> 00:28:37,450
kind of admin dashboard PHP myadmin is

806
00:28:34,390 --> 00:28:40,480
option WordPress admin printers web

807
00:28:37,450 --> 00:28:41,950
cameras Tomcat and JBoss the thing is

808
00:28:40,480 --> 00:28:43,780
when you have an admin dashboard for a

809
00:28:41,950 --> 00:28:46,240
web page admin dashboards usually that

810
00:28:43,780 --> 00:28:48,520
you deploy new web pages or deploy code

811
00:28:46,240 --> 00:28:51,070
for example Tomcat lets you deploy war

812
00:28:48,520 --> 00:28:54,250
files or you know you and war files can

813
00:28:51,070 --> 00:28:55,750
run retort or shellcode upload that PHP

814
00:28:54,250 --> 00:28:57,310
myadmin you can do a bunch of different

815
00:28:55,750 --> 00:28:58,750
sequel injection type commands you can

816
00:28:57,310 --> 00:29:01,990
also deploy modules out there and have

817
00:28:58,750 --> 00:29:04,270
it run things custom admin panels

818
00:29:01,990 --> 00:29:07,060
usually have some kind of feature and so

819
00:29:04,270 --> 00:29:10,300
a story of that is we were doing a pen

820
00:29:07,060 --> 00:29:12,190
test and the devs had a admin panel out

821
00:29:10,300 --> 00:29:14,020
on the internet and no one was opening

822
00:29:12,190 --> 00:29:15,850
our SMB image tags or maybe egress

823
00:29:14,020 --> 00:29:17,560
wasn't allowed from client workstations

824
00:29:15,850 --> 00:29:18,879
that was all blocked but they had this

825
00:29:17,560 --> 00:29:20,110
admin server out on the internet that

826
00:29:18,880 --> 00:29:21,970
and they were working on this new dev

827
00:29:20,110 --> 00:29:24,100
website and there was no customer data

828
00:29:21,970 --> 00:29:26,740
on it so they thought okay who cares if

829
00:29:24,100 --> 00:29:29,860
we exposed the panel and the login for

830
00:29:26,740 --> 00:29:31,870
this panel was admin admin so great

831
00:29:29,860 --> 00:29:33,310
passwords again if you find a theme

832
00:29:31,870 --> 00:29:35,199
throughout our entire talk it's that

833
00:29:33,310 --> 00:29:38,500
people are terrible at making passwords

834
00:29:35,200 --> 00:29:40,480
so don't only rely on passwords but

835
00:29:38,500 --> 00:29:43,360
anyway so we find this admin panel we

836
00:29:40,480 --> 00:29:44,680
log in and very limited functionality so

837
00:29:43,360 --> 00:29:47,080
maybe again that's why I didn't care at

838
00:29:44,680 --> 00:29:50,010
the time they had the ability to pretty

839
00:29:47,080 --> 00:29:52,960
much set a log file path location to

840
00:29:50,010 --> 00:29:55,810
change the username and password and I

841
00:29:52,960 --> 00:29:57,940
think it was to modify it use it modify

842
00:29:55,810 --> 00:29:59,050
like the index.html page so I guess you

843
00:29:57,940 --> 00:30:01,030
could you know inject some malicious

844
00:29:59,050 --> 00:30:02,680
JavaScript there but there wasn't any

845
00:30:01,030 --> 00:30:04,840
way to upload like a malicious page at

846
00:30:02,680 --> 00:30:06,760
all I couldn't upload like an ASP page

847
00:30:04,840 --> 00:30:09,040
but we noticed the whole thing was

848
00:30:06,760 --> 00:30:10,870
running on a Windows server and so we

849
00:30:09,040 --> 00:30:12,940
thought maybe the server can SMB egress

850
00:30:10,870 --> 00:30:14,979
to the Internet and there was a log file

851
00:30:12,940 --> 00:30:17,770
path well like I said before if you put

852
00:30:14,980 --> 00:30:20,170
in you know the URI path using a file

853
00:30:17,770 --> 00:30:21,760
share reference instead of like HTTP so

854
00:30:20,170 --> 00:30:23,500
he used two backslashes to a remote

855
00:30:21,760 --> 00:30:25,300
server it's gonna try and connect to it

856
00:30:23,500 --> 00:30:27,460
so we did two backslashes to a remote

857
00:30:25,300 --> 00:30:27,940
server which was our server on the

858
00:30:27,460 --> 00:30:29,800
Internet

859
00:30:27,940 --> 00:30:31,510
apparently this server was in their DMZ

860
00:30:29,800 --> 00:30:33,879
which he didn't allow or didn't have any

861
00:30:31,510 --> 00:30:35,980
four-45 egress restrictions and then we

862
00:30:33,880 --> 00:30:37,150
you know saved the log file location and

863
00:30:35,980 --> 00:30:38,830
next thing you know the server's trying

864
00:30:37,150 --> 00:30:40,750
to output log files to our server and

865
00:30:38,830 --> 00:30:41,260
we're replying back with authenticate to

866
00:30:40,750 --> 00:30:43,570
me first

867
00:30:41,260 --> 00:30:45,879
and so it authenticates and it's running

868
00:30:43,570 --> 00:30:47,980
as the domain administrator user for

869
00:30:45,880 --> 00:30:49,809
their company so it's just administrator

870
00:30:47,980 --> 00:30:51,970
with their domains we have that hash and

871
00:30:49,809 --> 00:30:54,040
that hatch was or we cracked it and it

872
00:30:51,970 --> 00:30:56,799
was like Heinz ketchup 500 something

873
00:30:54,040 --> 00:30:58,750
like that I just cracked it pretty quick

874
00:30:56,799 --> 00:31:00,549
um and now we have the domain admin hash

875
00:30:58,750 --> 00:31:02,140
and that was pretty awesome you know

876
00:31:00,549 --> 00:31:04,059
from external straight to domain admin

877
00:31:02,140 --> 00:31:05,380
hash we still had to find another chink

878
00:31:04,059 --> 00:31:07,899
in the armor to get internal at that

879
00:31:05,380 --> 00:31:10,299
point but it's still another easy way to

880
00:31:07,900 --> 00:31:11,650
capture a password hash and then once we

881
00:31:10,299 --> 00:31:14,918
get internal access we'll kick it over

882
00:31:11,650 --> 00:31:21,520
to Patrick for that I'm gonna back up on

883
00:31:14,919 --> 00:31:23,230
him now so this is one of my favorite

884
00:31:21,520 --> 00:31:24,910
things to kind of do on the pen test as

885
00:31:23,230 --> 00:31:26,490
well and one of the ways that you can do

886
00:31:24,910 --> 00:31:28,750
this there's a tool called eyewitness

887
00:31:26,490 --> 00:31:32,110
that will go ahead and screenshot

888
00:31:28,750 --> 00:31:33,490
whatever is at the web ports so one of

889
00:31:32,110 --> 00:31:35,709
the things you can do is you can kind of

890
00:31:33,490 --> 00:31:37,540
go through and find all your open web

891
00:31:35,710 --> 00:31:39,730
ports point eyewitness at it and it'll

892
00:31:37,540 --> 00:31:42,520
show you a screenshot of whatever is at

893
00:31:39,730 --> 00:31:44,860
that point and a lot of times what we do

894
00:31:42,520 --> 00:31:46,059
you know we'll also do this with the

895
00:31:44,860 --> 00:31:47,678
internal but it's fun to do with the

896
00:31:46,059 --> 00:31:49,750
externals as well to see what's there

897
00:31:47,679 --> 00:31:51,429
and sometimes when we get things like

898
00:31:49,750 --> 00:31:53,080
JBoss like Tomcat and these kind of

899
00:31:51,429 --> 00:31:56,169
things or some of the other

900
00:31:53,080 --> 00:31:58,360
administrative dashboards web cameras

901
00:31:56,169 --> 00:32:00,760
and these kind of fun things Google is

902
00:31:58,360 --> 00:32:02,290
your friend so one of my favorite things

903
00:32:00,760 --> 00:32:04,330
to do at that point is what is the

904
00:32:02,290 --> 00:32:08,409
default password for whatever the

905
00:32:04,330 --> 00:32:10,030
service is and some - way too high

906
00:32:08,410 --> 00:32:13,559
percentage of the time whatever the

907
00:32:10,030 --> 00:32:16,960
default password is does get us in I

908
00:32:13,559 --> 00:32:20,830
remember being at one company one time

909
00:32:16,960 --> 00:32:23,049
and found a web camera that was wide

910
00:32:20,830 --> 00:32:24,580
open wasn't even a password on it and it

911
00:32:23,049 --> 00:32:26,429
was pointed what looked like you know

912
00:32:24,580 --> 00:32:29,230
I'm looking in there and I see like

913
00:32:26,429 --> 00:32:31,179
server racks and cages in front of it

914
00:32:29,230 --> 00:32:33,160
I'm like this looks an awful like a data

915
00:32:31,179 --> 00:32:34,540
center and you can kind of move the

916
00:32:33,160 --> 00:32:36,429
camera around you can see people walking

917
00:32:34,540 --> 00:32:38,379
around like this is wide open to the

918
00:32:36,429 --> 00:32:40,090
internet anybody can kind of see this

919
00:32:38,380 --> 00:32:41,530
kind of thing so I'm doing the the

920
00:32:40,090 --> 00:32:44,290
debrief at the end of the week with the

921
00:32:41,530 --> 00:32:45,340
customer and kind of waiting I saved

922
00:32:44,290 --> 00:32:46,600
that one for the end because we're

923
00:32:45,340 --> 00:32:49,270
sitting in the room with all the c-level

924
00:32:46,600 --> 00:32:50,620
people and all the other managers and

925
00:32:49,270 --> 00:32:52,570
things like that and I'd popped that one

926
00:32:50,620 --> 00:32:54,520
up at the end and it was just a

927
00:32:52,570 --> 00:32:56,290
screenshot of the the web camera being

928
00:32:54,520 --> 00:32:57,460
wide open to the Internet they're all

929
00:32:56,290 --> 00:32:59,710
looking and it's like is that our data

930
00:32:57,460 --> 00:33:01,290
center and the guy the one that was in

931
00:32:59,710 --> 00:33:03,690
charge of the whole network was like

932
00:33:01,290 --> 00:33:05,879
yeah that's our data center open to the

933
00:33:03,690 --> 00:33:08,220
Internet and they were like why can you

934
00:33:05,880 --> 00:33:10,080
just get access to that and I'm looking

935
00:33:08,220 --> 00:33:13,170
I'm like I have no idea why it's that

936
00:33:10,080 --> 00:33:14,850
way and he just kind of really got mad

937
00:33:13,170 --> 00:33:17,580
he's like next time we get a phone call

938
00:33:14,850 --> 00:33:18,870
at 3:00 a.m. from our NOC you can deal

939
00:33:17,580 --> 00:33:20,850
with that kind of thing I'm just like

940
00:33:18,870 --> 00:33:22,800
all I care about is that you password

941
00:33:20,850 --> 00:33:24,120
protect him and I don't I don't care if

942
00:33:22,800 --> 00:33:25,800
it's still available to the Internet

943
00:33:24,120 --> 00:33:26,969
kind of thing but yeah so those are some

944
00:33:25,800 --> 00:33:28,740
of the ways that you can do it I witness

945
00:33:26,970 --> 00:33:30,390
is a great tool to find these kind of

946
00:33:28,740 --> 00:33:32,280
things and then once you find these open

947
00:33:30,390 --> 00:33:34,380
dashboards on your own networks that you

948
00:33:32,280 --> 00:33:35,720
can play with test out some default

949
00:33:34,380 --> 00:33:39,150
passwords and see if they've been

950
00:33:35,720 --> 00:33:41,400
changed all right so we get our internal

951
00:33:39,150 --> 00:33:43,110
access so fortunately about halfway

952
00:33:41,400 --> 00:33:45,060
through and halfway through our slide so

953
00:33:43,110 --> 00:33:47,520
that kind of works out pretty well here

954
00:33:45,060 --> 00:33:49,169
are some of the favorite ways and by

955
00:33:47,520 --> 00:33:52,470
favorite we mean like super easy because

956
00:33:49,170 --> 00:33:53,670
we're lazy we want the easiest way in so

957
00:33:52,470 --> 00:33:55,650
whatever is gonna be the easiest way in

958
00:33:53,670 --> 00:33:57,540
is kind of what we're gonna try first

959
00:33:55,650 --> 00:33:58,950
and these are some of the first ones

960
00:33:57,540 --> 00:34:01,110
that we are going to look for some of

961
00:33:58,950 --> 00:34:03,900
these things like the the black of least

962
00:34:01,110 --> 00:34:05,429
privilege we go for the LOA Minard like

963
00:34:03,900 --> 00:34:07,260
basically we just sit there listening

964
00:34:05,430 --> 00:34:08,909
saying can we have your hashes and

965
00:34:07,260 --> 00:34:12,060
sometimes network said yeah sure there

966
00:34:08,909 --> 00:34:14,340
you go whether you have the SMB signing

967
00:34:12,060 --> 00:34:16,469
on so we can then start relaying hashes

968
00:34:14,340 --> 00:34:18,120
around the network of playing with

969
00:34:16,469 --> 00:34:20,428
things like mini cats looking to see if

970
00:34:18,120 --> 00:34:27,929
your clear text passwords are just kind

971
00:34:20,429 --> 00:34:35,850
of stored in memory yeah oh sit with the

972
00:34:27,929 --> 00:34:37,918
LM in r1 yeah all right so the question

973
00:34:35,850 --> 00:34:39,418
is are we sitting on the inside network

974
00:34:37,918 --> 00:34:41,730
with a sniffer we're sitting on the

975
00:34:39,418 --> 00:34:43,168
inside Network for some of these will

976
00:34:41,730 --> 00:34:45,418
use a sniffer but others it might be

977
00:34:43,168 --> 00:34:47,158
that we just plugged in so sometimes

978
00:34:45,418 --> 00:34:48,750
just being in a network tap is good

979
00:34:47,159 --> 00:34:50,730
enough kind of refrig it and another

980
00:34:48,750 --> 00:34:52,320
word too so yeah this is basically we

981
00:34:50,730 --> 00:34:54,690
showed some ways we get in externally

982
00:34:52,320 --> 00:34:57,060
now we're internal so we got in from the

983
00:34:54,690 --> 00:34:58,710
external maybe we got on your VPN we

984
00:34:57,060 --> 00:35:00,660
broke out of Citrix and now we're

985
00:34:58,710 --> 00:35:02,340
internal we sent a phishing email we're

986
00:35:00,660 --> 00:35:04,259
internal whatever way we did to go from

987
00:35:02,340 --> 00:35:07,530
external to internal that's where this

988
00:35:04,260 --> 00:35:09,510
begins or you just hired us to plop down

989
00:35:07,530 --> 00:35:12,770
inside your network and start finding

990
00:35:09,510 --> 00:35:15,970
fun things well

991
00:35:12,770 --> 00:35:18,890
I am I don't want to speak for you but

992
00:35:15,970 --> 00:35:20,509
yeah and I remember one time going for a

993
00:35:18,890 --> 00:35:21,890
programmers job one time and I don't

994
00:35:20,510 --> 00:35:23,180
know if anybody else ever asks this

995
00:35:21,890 --> 00:35:24,950
question of programmers it's one of the

996
00:35:23,180 --> 00:35:26,930
best questions to ask somebody that's a

997
00:35:24,950 --> 00:35:28,480
developer programmer and to see if they

998
00:35:26,930 --> 00:35:31,779
really understand it just as a

999
00:35:28,480 --> 00:35:33,920
programmer developer are you lazy I

1000
00:35:31,780 --> 00:35:35,990
remember the first time thinking like

1001
00:35:33,920 --> 00:35:38,750
are they asking this question for and

1002
00:35:35,990 --> 00:35:40,520
the correct answers yes I'm lazy and the

1003
00:35:38,750 --> 00:35:41,750
reason that you want a developer

1004
00:35:40,520 --> 00:35:42,920
programmer to say yes they're lazy

1005
00:35:41,750 --> 00:35:44,930
because you don't want them rewriting

1006
00:35:42,920 --> 00:35:46,250
the same code over and over again you

1007
00:35:44,930 --> 00:35:48,680
want a good developer that knows how to

1008
00:35:46,250 --> 00:35:51,820
okay but we're not talking about that

1009
00:35:48,680 --> 00:35:55,520
stuff today all right so the first thing

1010
00:35:51,820 --> 00:35:59,900
we have our lack of principle of least

1011
00:35:55,520 --> 00:36:02,360
privilege I think one of the the notes

1012
00:35:59,900 --> 00:36:04,490
that I have in here is to make sure that

1013
00:36:02,360 --> 00:36:06,080
your administrators are using their

1014
00:36:04,490 --> 00:36:09,200
proper administrator accounts like they

1015
00:36:06,080 --> 00:36:12,350
should be notice that your domain

1016
00:36:09,200 --> 00:36:14,990
administrator privilege or account is

1017
00:36:12,350 --> 00:36:17,930
not called the check email or surf the

1018
00:36:14,990 --> 00:36:20,089
Internet level of privilege so anybody

1019
00:36:17,930 --> 00:36:22,220
that is a domain admin should only be

1020
00:36:20,090 --> 00:36:23,780
using that account to do domain

1021
00:36:22,220 --> 00:36:25,520
administration if they're doing anything

1022
00:36:23,780 --> 00:36:27,380
else they're doing it wrong okay and

1023
00:36:25,520 --> 00:36:29,090
they should certainly have different

1024
00:36:27,380 --> 00:36:30,890
accounts for those kinds of things as

1025
00:36:29,090 --> 00:36:33,260
well so make sure that we have the

1026
00:36:30,890 --> 00:36:34,609
proper levels of privilege with these

1027
00:36:33,260 --> 00:36:37,310
accounts because these are the kinds of

1028
00:36:34,610 --> 00:36:39,080
accounts that we're looking for and when

1029
00:36:37,310 --> 00:36:40,000
they get misused and they're using them

1030
00:36:39,080 --> 00:36:42,890
in the wrong places

1031
00:36:40,000 --> 00:36:44,570
there might be a pen tester coming by or

1032
00:36:42,890 --> 00:36:49,879
somebody worse they just kind of scoop

1033
00:36:44,570 --> 00:36:51,710
that kind of stuff up as well and one of

1034
00:36:49,880 --> 00:36:54,080
the other kind of fun things to do as

1035
00:36:51,710 --> 00:36:57,350
well sometimes when they tell us that

1036
00:36:54,080 --> 00:36:59,600
they have Network segregation right yeah

1037
00:36:57,350 --> 00:37:02,839
separate networks that aren't really

1038
00:36:59,600 --> 00:37:04,910
connected all that well okay so once we

1039
00:37:02,840 --> 00:37:06,020
kind of get one domain admin account one

1040
00:37:04,910 --> 00:37:07,430
of the first things that we're gonna try

1041
00:37:06,020 --> 00:37:09,440
to do it can we log into the other one

1042
00:37:07,430 --> 00:37:11,720
with that same account and all too often

1043
00:37:09,440 --> 00:37:13,040
that answer is yes so we want to make

1044
00:37:11,720 --> 00:37:16,310
sure that those kinds of things are

1045
00:37:13,040 --> 00:37:17,630
separate as well this one isn't really

1046
00:37:16,310 --> 00:37:19,310
going to be a principle of least

1047
00:37:17,630 --> 00:37:21,290
privilege but more of a bad thing that I

1048
00:37:19,310 --> 00:37:24,470
see a lot do you see anything in common

1049
00:37:21,290 --> 00:37:26,560
with these two or if you don't really

1050
00:37:24,470 --> 00:37:29,870
see it immediately how about now

1051
00:37:26,560 --> 00:37:31,490
okay oh I see this way too often it's

1052
00:37:29,870 --> 00:37:32,390
one of my favorite things to do and it's

1053
00:37:31,490 --> 00:37:35,419
one of those things that make

1054
00:37:32,390 --> 00:37:36,890
administrators hate me is that I will go

1055
00:37:35,420 --> 00:37:38,990
through and I will find the

1056
00:37:36,890 --> 00:37:40,970
administrator password hash and your

1057
00:37:38,990 --> 00:37:43,339
regular user password hash for the same

1058
00:37:40,970 --> 00:37:45,680
person and compare them because guess

1059
00:37:43,340 --> 00:37:48,200
what if the two hashes are the same the

1060
00:37:45,680 --> 00:37:49,640
passwords the same so to me that's the

1061
00:37:48,200 --> 00:37:53,930
same account if you have the same

1062
00:37:49,640 --> 00:37:55,549
password on both so all too often this

1063
00:37:53,930 --> 00:37:57,529
is the case in there once we start

1064
00:37:55,550 --> 00:38:02,890
pulling out the hashes we see that kind

1065
00:37:57,530 --> 00:38:06,050
of thing as well so yeah now we have our

1066
00:38:02,890 --> 00:38:09,859
legacy broadcast we have our element our

1067
00:38:06,050 --> 00:38:12,020
NetBIOS kinds of things which is really

1068
00:38:09,860 --> 00:38:14,780
just a way to that's the best way to

1069
00:38:12,020 --> 00:38:20,030
describe eliminar not BIOS kinds of

1070
00:38:14,780 --> 00:38:21,890
things all these workstations are

1071
00:38:20,030 --> 00:38:24,740
talking on the network and they're

1072
00:38:21,890 --> 00:38:26,240
constantly asking who is this and you

1073
00:38:24,740 --> 00:38:27,410
know that person's supposed to reply or

1074
00:38:26,240 --> 00:38:30,259
somebody's supposed to reply and say I

1075
00:38:27,410 --> 00:38:32,060
know who that is but you know instead we

1076
00:38:30,260 --> 00:38:34,850
reply and say I'm that person give me

1077
00:38:32,060 --> 00:38:36,320
your hash and they authenticate to us

1078
00:38:34,850 --> 00:38:37,670
because like I said Windows loves to

1079
00:38:36,320 --> 00:38:39,890
just authenticate to everything I can

1080
00:38:37,670 --> 00:38:41,270
authenticate to that's probably the best

1081
00:38:39,890 --> 00:38:43,279
way down that's my that's kind of a good

1082
00:38:41,270 --> 00:38:45,710
way that a machine might be looking for

1083
00:38:43,280 --> 00:38:47,660
let's say a file share I mean it says

1084
00:38:45,710 --> 00:38:50,930
hey DNS where do I find this file share

1085
00:38:47,660 --> 00:38:52,460
in DNS goes I don't know so it says okay

1086
00:38:50,930 --> 00:38:54,589
well then how about by this IP address

1087
00:38:52,460 --> 00:38:56,660
who is this IP address in the file share

1088
00:38:54,590 --> 00:38:58,070
should say that's me but one of the

1089
00:38:56,660 --> 00:38:59,509
things that we like to do is we kind of

1090
00:38:58,070 --> 00:39:01,280
sit in between and we create this like

1091
00:38:59,510 --> 00:39:04,340
race condition and say no that's me and

1092
00:39:01,280 --> 00:39:07,010
since like Aaron said Windows loves to

1093
00:39:04,340 --> 00:39:08,510
help and loves to authenticate once we

1094
00:39:07,010 --> 00:39:10,760
say nope that's actually awesome say

1095
00:39:08,510 --> 00:39:12,860
okay here's here's my password hash and

1096
00:39:10,760 --> 00:39:17,360
we have tools that we kind of use that

1097
00:39:12,860 --> 00:39:18,590
for as well so one of the best tools and

1098
00:39:17,360 --> 00:39:20,270
this is usually like one of the first

1099
00:39:18,590 --> 00:39:22,040
things that I'll actually do when I am

1100
00:39:20,270 --> 00:39:23,630
working inside the network even before

1101
00:39:22,040 --> 00:39:25,100
I've done anything else at all I'll

1102
00:39:23,630 --> 00:39:27,620
start up this tool called responder and

1103
00:39:25,100 --> 00:39:29,270
what responder does is it just sits

1104
00:39:27,620 --> 00:39:31,609
there and listens for this kind of

1105
00:39:29,270 --> 00:39:35,120
traffic and one of the nice things is

1106
00:39:31,610 --> 00:39:38,480
that if it if the network is going to be

1107
00:39:35,120 --> 00:39:40,609
vulnerable to this then as soon as

1108
00:39:38,480 --> 00:39:42,920
responder is able to detect that

1109
00:39:40,609 --> 00:39:44,900
somebody one of the machines inside of

1110
00:39:42,920 --> 00:39:47,809
the network is looking and can't find

1111
00:39:44,900 --> 00:39:50,180
exactly what it's looking for responder

1112
00:39:47,809 --> 00:39:51,799
will tell that that machine that's me

1113
00:39:50,180 --> 00:39:53,118
give me your password hash and it

1114
00:39:51,799 --> 00:39:54,559
immediately comes back once I see if

1115
00:39:53,119 --> 00:39:56,299
there's any kind of traffic going on

1116
00:39:54,559 --> 00:39:57,950
there I kind of get a little bit excited

1117
00:39:56,299 --> 00:39:59,509
and happy and it starts setting up other

1118
00:39:57,950 --> 00:40:01,279
things I'm gonna be a little bit more

1119
00:39:59,510 --> 00:40:02,900
fun to do with this well there's also a

1120
00:40:01,279 --> 00:40:05,510
Metasploit module it does the same thing

1121
00:40:02,900 --> 00:40:07,369
but when you have responder set up and

1122
00:40:05,510 --> 00:40:11,240
it's as easy as just typing in responder

1123
00:40:07,369 --> 00:40:13,069
- i eth0 off it goes it runs it's all

1124
00:40:11,240 --> 00:40:15,410
kind of nice capturing hashes that way

1125
00:40:13,069 --> 00:40:17,990
and responders gonna capture one of

1126
00:40:15,410 --> 00:40:22,460
those ntlm v2 hashes so again we just

1127
00:40:17,990 --> 00:40:25,399
have to crack that offline or what we

1128
00:40:22,460 --> 00:40:26,599
can do is we can relay it which so

1129
00:40:25,400 --> 00:40:28,609
coming back to the question you asked

1130
00:40:26,599 --> 00:40:31,970
earlier can we pass an NT LMB to hash

1131
00:40:28,609 --> 00:40:33,319
the answer is no ntlm v2 is salted every

1132
00:40:31,970 --> 00:40:34,669
single one is different that's what that

1133
00:40:33,319 --> 00:40:36,829
challenge response code is that

1134
00:40:34,670 --> 00:40:37,609
responder provides maybe in one of our

1135
00:40:36,829 --> 00:40:39,260
slides for the Metasploit module

1136
00:40:37,609 --> 00:40:41,990
actually you saw I was like a string of

1137
00:40:39,260 --> 00:40:44,029
1 1 2 2 3 4 going all the way to 8 at

1138
00:40:41,990 --> 00:40:46,459
the end that's a challenge response hash

1139
00:40:44,029 --> 00:40:48,319
and so Windows is actually going to take

1140
00:40:46,460 --> 00:40:50,480
and create a unique hash salted with

1141
00:40:48,319 --> 00:40:52,759
that response so every single time you

1142
00:40:50,480 --> 00:40:54,980
get a hash for even the same user it's

1143
00:40:52,759 --> 00:40:57,109
going to be different and you have to

1144
00:40:54,980 --> 00:40:59,480
crack it and so it makes it a little

1145
00:40:57,109 --> 00:41:01,220
slower to crack and that ntlm v2 hash

1146
00:40:59,480 --> 00:41:04,009
simply because it's not like you can

1147
00:41:01,220 --> 00:41:07,399
take you know ten different ntlm v2

1148
00:41:04,009 --> 00:41:09,589
hashes and take each one of them compile

1149
00:41:07,400 --> 00:41:11,990
it to an ntlm v2 without any kind of

1150
00:41:09,589 --> 00:41:13,339
salt or anything and then compare them

1151
00:41:11,990 --> 00:41:14,240
against those other ntlm v2 so it

1152
00:41:13,339 --> 00:41:15,799
doesn't work so you can't do like

1153
00:41:14,240 --> 00:41:17,808
rainbow table attacks instead you have

1154
00:41:15,799 --> 00:41:19,910
to compute every single word in your

1155
00:41:17,809 --> 00:41:23,569
dictionary when you're cracking to that

1156
00:41:19,910 --> 00:41:25,129
ntlm - v2 with the specific salt to get

1157
00:41:23,569 --> 00:41:26,240
the you know final hash that it should

1158
00:41:25,130 --> 00:41:28,430
be to compare and see if they're the

1159
00:41:26,240 --> 00:41:29,808
same so that means you also can't pass

1160
00:41:28,430 --> 00:41:31,368
it because it's not something you can

1161
00:41:29,809 --> 00:41:33,079
just say you know have my hash here it

1162
00:41:31,369 --> 00:41:34,940
works as authentication if we were to

1163
00:41:33,079 --> 00:41:36,710
backup let me see many slides back it is

1164
00:41:34,940 --> 00:41:39,410
yeah I'm just gonna fly back I'm sorry

1165
00:41:36,710 --> 00:41:41,720
so if you see these hashes here these

1166
00:41:39,410 --> 00:41:42,920
are ntlm hashes these are the hashes

1167
00:41:41,720 --> 00:41:45,169
that are on your domain controller for

1168
00:41:42,920 --> 00:41:47,300
all your users and that NTDs that file I

1169
00:41:45,170 --> 00:41:50,840
was talking about these are passable

1170
00:41:47,300 --> 00:41:52,520
you can take the ntlm hash and you can

1171
00:41:50,840 --> 00:41:54,950
pass it as a form of authentication over

1172
00:41:52,520 --> 00:41:56,509
port four or five and windows just

1173
00:41:54,950 --> 00:41:57,890
accepts it because it's pretty much the

1174
00:41:56,510 --> 00:41:59,420
equivalent of having the password unless

1175
00:41:57,890 --> 00:42:00,950
you're logging in like a web panel that

1176
00:41:59,420 --> 00:42:04,580
requires you know having the password

1177
00:42:00,950 --> 00:42:06,009
instead of ntlm so yeah just reference

1178
00:42:04,580 --> 00:42:08,960
that and so now we can talk about

1179
00:42:06,010 --> 00:42:12,560
replaying then so while we can't pass

1180
00:42:08,960 --> 00:42:13,850
the hash with a net ntlm v2 which is

1181
00:42:12,560 --> 00:42:16,460
what we're gonna capture with responder

1182
00:42:13,850 --> 00:42:17,870
or SMB image tag or by you know standing

1183
00:42:16,460 --> 00:42:19,370
up a rogue SMB server and somehow

1184
00:42:17,870 --> 00:42:22,160
getting someone to authenticate to our

1185
00:42:19,370 --> 00:42:24,140
server we can relay it and the relaying

1186
00:42:22,160 --> 00:42:25,819
process is pretty simple there's one

1187
00:42:24,140 --> 00:42:27,650
thing required though I don't know if we

1188
00:42:25,820 --> 00:42:30,650
have it up there oh yeah so find SMB

1189
00:42:27,650 --> 00:42:33,500
host without message signing required if

1190
00:42:30,650 --> 00:42:35,630
you it's a default for Windows so

1191
00:42:33,500 --> 00:42:36,830
Windows port 45 SMB if you were to scan

1192
00:42:35,630 --> 00:42:38,330
your network with the ball and scanner

1193
00:42:36,830 --> 00:42:40,430
and it comes back and it says you know

1194
00:42:38,330 --> 00:42:42,410
you don't require or require SMB signing

1195
00:42:40,430 --> 00:42:43,700
you should pay attention to let that's

1196
00:42:42,410 --> 00:42:45,560
bad because people can relay these

1197
00:42:43,700 --> 00:42:48,710
hashes now so make sure all of your

1198
00:42:45,560 --> 00:42:50,720
hosts require SMB signing oh if you

1199
00:42:48,710 --> 00:42:52,280
don't require SMB signing we can do a

1200
00:42:50,720 --> 00:42:53,990
very simple man and middle attack I

1201
00:42:52,280 --> 00:42:55,130
apologize it might be hard to read some

1202
00:42:53,990 --> 00:42:57,140
of the texts I'm gonna try and walk

1203
00:42:55,130 --> 00:42:59,180
through right here though this if I can

1204
00:42:57,140 --> 00:43:01,069
turn this so I can point more all right

1205
00:42:59,180 --> 00:43:03,859
can you guys still hear me are we good

1206
00:43:01,070 --> 00:43:05,720
okay away from mic just a little bit so

1207
00:43:03,860 --> 00:43:07,610
we're gonna start with our attacker our

1208
00:43:05,720 --> 00:43:09,109
attacker is gonna be running responder

1209
00:43:07,610 --> 00:43:10,100
he's gonna be replying to people on the

1210
00:43:09,110 --> 00:43:12,080
network trying to get people to

1211
00:43:10,100 --> 00:43:13,910
authenticate to it once you get someone

1212
00:43:12,080 --> 00:43:15,470
to authenticate so in this case step one

1213
00:43:13,910 --> 00:43:17,180
is the victim up top the green line

1214
00:43:15,470 --> 00:43:18,529
there and the victims go into the

1215
00:43:17,180 --> 00:43:20,450
attacker because the attacker got them

1216
00:43:18,530 --> 00:43:22,490
to do it and they're saying hey can I

1217
00:43:20,450 --> 00:43:24,919
have fun a cape to you the attacker over

1218
00:43:22,490 --> 00:43:25,459
SMB and the attacker is like yeah hold

1219
00:43:24,920 --> 00:43:27,200
on hold on

1220
00:43:25,460 --> 00:43:29,150
I server over here this target without

1221
00:43:27,200 --> 00:43:31,310
SMB signing can I have found a Kate over

1222
00:43:29,150 --> 00:43:32,690
SMB and the server is like yeah but

1223
00:43:31,310 --> 00:43:35,120
all's you have to do is encrypt this

1224
00:43:32,690 --> 00:43:36,890
challenge I'm giving you with your

1225
00:43:35,120 --> 00:43:38,299
password hash and then send it back to

1226
00:43:36,890 --> 00:43:39,830
me and the attacker is like I hold on

1227
00:43:38,300 --> 00:43:41,900
server let's go back to the victim

1228
00:43:39,830 --> 00:43:43,730
victim here's this challenge I got you

1229
00:43:41,900 --> 00:43:45,530
just need to encrypt it with your you

1230
00:43:43,730 --> 00:43:47,510
know password hash and send it back to

1231
00:43:45,530 --> 00:43:49,130
me and the victims like okay cool here's

1232
00:43:47,510 --> 00:43:50,360
my encrypted challenge and the attacker

1233
00:43:49,130 --> 00:43:52,340
is like all right now I got the

1234
00:43:50,360 --> 00:43:54,440
encrypted challenge hey target server

1235
00:43:52,340 --> 00:43:56,240
you know here it all is I'm technically

1236
00:43:54,440 --> 00:43:58,970
this victim over here can I authenticate

1237
00:43:56,240 --> 00:44:00,529
to you and the server is like sure

1238
00:43:58,970 --> 00:44:02,509
access granted authenticate

1239
00:44:00,530 --> 00:44:03,890
over port 445 we're good to go the

1240
00:44:02,510 --> 00:44:06,020
attackers like awesome execute this

1241
00:44:03,890 --> 00:44:07,970
command you know four four five is great

1242
00:44:06,020 --> 00:44:09,920
for Windows administration type stuff so

1243
00:44:07,970 --> 00:44:12,049
you can use WMI the windows management

1244
00:44:09,920 --> 00:44:15,890
instrumentation and implementation yeah

1245
00:44:12,050 --> 00:44:17,660
either way PS exec is another option you

1246
00:44:15,890 --> 00:44:19,100
know be calm you have all these

1247
00:44:17,660 --> 00:44:20,810
different options to go ahead and

1248
00:44:19,100 --> 00:44:22,400
execute commands remotely over port four

1249
00:44:20,810 --> 00:44:24,230
or five if they're a local admin on the

1250
00:44:22,400 --> 00:44:25,820
server but not a local admin on the

1251
00:44:24,230 --> 00:44:27,170
server you can still try and dump

1252
00:44:25,820 --> 00:44:28,610
session information like if it's a

1253
00:44:27,170 --> 00:44:29,930
domain controller you can dump all the

1254
00:44:28,610 --> 00:44:32,480
users in the domain and all the groups

1255
00:44:29,930 --> 00:44:33,830
that way so that's another option but

1256
00:44:32,480 --> 00:44:36,080
usually we're trying to relay admin

1257
00:44:33,830 --> 00:44:37,279
hashes at this point and then we go back

1258
00:44:36,080 --> 00:44:39,500
to the victim at the very end and we're

1259
00:44:37,280 --> 00:44:40,670
like a sorry access is denied but the

1260
00:44:39,500 --> 00:44:42,200
attacker has already established a

1261
00:44:40,670 --> 00:44:45,770
session with the target so that's how

1262
00:44:42,200 --> 00:44:48,710
relaying works remediation for both

1263
00:44:45,770 --> 00:44:51,290
responder and for SME relaying the first

1264
00:44:48,710 --> 00:44:53,240
is disabled ll M&R and NB TNS on your

1265
00:44:51,290 --> 00:44:54,920
network these are legacy broadcast

1266
00:44:53,240 --> 00:44:56,779
protocols they're not needed anymore but

1267
00:44:54,920 --> 00:44:58,580
they're on by default in Windows so go

1268
00:44:56,780 --> 00:45:00,050
ahead and disable them you can do it

1269
00:44:58,580 --> 00:45:01,759
through group policy it's pretty simple

1270
00:45:00,050 --> 00:45:03,110
follow a principle of least privilege

1271
00:45:01,760 --> 00:45:04,880
because like I said we're looking for

1272
00:45:03,110 --> 00:45:07,190
those admin hashes we're trying to use

1273
00:45:04,880 --> 00:45:08,930
admin hashes to get them into a you know

1274
00:45:07,190 --> 00:45:10,250
relay I'm do a server or crack them so

1275
00:45:08,930 --> 00:45:12,560
we can just do all of our lateral

1276
00:45:10,250 --> 00:45:14,330
movement over port 4 or 4 or 5 but if

1277
00:45:12,560 --> 00:45:16,190
your users aren't running as a domain

1278
00:45:14,330 --> 00:45:18,049
admin on their workstations then they're

1279
00:45:16,190 --> 00:45:20,000
not authenticating to our SMB server as

1280
00:45:18,050 --> 00:45:21,380
domain admin and therefore we can't

1281
00:45:20,000 --> 00:45:23,450
really use their hash to go do something

1282
00:45:21,380 --> 00:45:25,190
bad so make sure users on their

1283
00:45:23,450 --> 00:45:27,669
workstations when they log in they're

1284
00:45:25,190 --> 00:45:29,600
not logging in as at a privileged user

1285
00:45:27,670 --> 00:45:31,480
we'll get into that later when we talk

1286
00:45:29,600 --> 00:45:34,580
about mimic at 2i it's another bad idea

1287
00:45:31,480 --> 00:45:36,880
finally if you also require SMB signing

1288
00:45:34,580 --> 00:45:40,100
this is going to prevent your relaying

1289
00:45:36,880 --> 00:45:42,410
so we can't just relay hashes because it

1290
00:45:40,100 --> 00:45:44,480
requires a special signing between the

1291
00:45:42,410 --> 00:45:45,680
client and the server and so the

1292
00:45:44,480 --> 00:45:47,360
attacker can't be in the center doing

1293
00:45:45,680 --> 00:45:50,299
that man the middle attack and then

1294
00:45:47,360 --> 00:45:51,110
another option for preventing well if

1295
00:45:50,300 --> 00:45:53,930
you're doing principle of least

1296
00:45:51,110 --> 00:45:56,030
privilege using laps as well might not

1297
00:45:53,930 --> 00:45:57,770
apply for the SMB type stuff there but

1298
00:45:56,030 --> 00:45:59,600
if we're able to compromise a host and

1299
00:45:57,770 --> 00:46:01,759
we have to dump that host so over port 4

1300
00:45:59,600 --> 00:46:03,529
4 5 we dumped the local admin hash on a

1301
00:46:01,760 --> 00:46:04,910
server or we dumped the local admin hash

1302
00:46:03,530 --> 00:46:07,010
on another workstation let's say we

1303
00:46:04,910 --> 00:46:08,720
relay your hash back to our workstation

1304
00:46:07,010 --> 00:46:10,460
and all users in the domain are also

1305
00:46:08,720 --> 00:46:11,750
local admins on workstations domain

1306
00:46:10,460 --> 00:46:13,490
users equals in local

1307
00:46:11,750 --> 00:46:15,140
group we didn't dump the hashes off

1308
00:46:13,490 --> 00:46:17,569
those workstations with that one relay

1309
00:46:15,140 --> 00:46:18,830
if that local admin hashed that ntlm

1310
00:46:17,570 --> 00:46:20,750
hash because when you dump those off of

1311
00:46:18,830 --> 00:46:22,040
workstation there the ntlm we can pass

1312
00:46:20,750 --> 00:46:24,530
it to all the other workstations and

1313
00:46:22,040 --> 00:46:26,420
servers in the network and if you're

1314
00:46:24,530 --> 00:46:27,680
using the same password across all your

1315
00:46:26,420 --> 00:46:29,210
servers and workstations for the local

1316
00:46:27,680 --> 00:46:32,210
admin account we now have access to all

1317
00:46:29,210 --> 00:46:34,060
of them so laps is basically it's a

1318
00:46:32,210 --> 00:46:36,380
password solution inside Microsoft

1319
00:46:34,060 --> 00:46:38,509
inside Windows that automatically

1320
00:46:36,380 --> 00:46:42,290
randomizes at the local admin password

1321
00:46:38,510 --> 00:46:44,450
across all of your workstations and your

1322
00:46:42,290 --> 00:46:46,220
domain or your main servers and then you

1323
00:46:44,450 --> 00:46:48,830
can take and get that by being a domain

1324
00:46:46,220 --> 00:46:50,509
admin and pulling it from the Active

1325
00:46:48,830 --> 00:46:51,770
Directory domain controller you can go

1326
00:46:50,510 --> 00:46:52,820
into Active Directory and look up the

1327
00:46:51,770 --> 00:46:54,830
local admin password for each

1328
00:46:52,820 --> 00:46:56,450
workstation and server so we always

1329
00:46:54,830 --> 00:47:01,009
recommend lamps that was a mouthful

1330
00:46:56,450 --> 00:47:02,960
sorry let's have a story so I had this

1331
00:47:01,010 --> 00:47:05,390
client and we've conducted pen test

1332
00:47:02,960 --> 00:47:07,100
forum for three years and we beat them

1333
00:47:05,390 --> 00:47:07,850
to death with weak passwords and finally

1334
00:47:07,100 --> 00:47:10,460
they said screw it

1335
00:47:07,850 --> 00:47:11,990
16 character passwords for is not sorry

1336
00:47:10,460 --> 00:47:13,550
12 character passwords for standard

1337
00:47:11,990 --> 00:47:15,799
users they had complexity that

1338
00:47:13,550 --> 00:47:18,410
dictionary checking and then any admin

1339
00:47:15,800 --> 00:47:20,900
user had to have 24 character password

1340
00:47:18,410 --> 00:47:22,520
and above that's strong I mean well if

1341
00:47:20,900 --> 00:47:23,930
they're not using common dictionary

1342
00:47:22,520 --> 00:47:25,640
words or if they're chaining them

1343
00:47:23,930 --> 00:47:26,930
together in a random format I'm not

1344
00:47:25,640 --> 00:47:29,060
going to crack them even if I get the

1345
00:47:26,930 --> 00:47:30,830
ntlm BTU hash and so that's what I did I

1346
00:47:29,060 --> 00:47:32,660
got the ntlm v2 hash and I couldn't

1347
00:47:30,830 --> 00:47:34,580
crack it and my point of contact just

1348
00:47:32,660 --> 00:47:36,200
had a smirky grin on his face like aha

1349
00:47:34,580 --> 00:47:39,020
can't get into any of my stuff now

1350
00:47:36,200 --> 00:47:41,270
because we had used his hash to the past

1351
00:47:39,020 --> 00:47:43,130
three years prior cracked it and then

1352
00:47:41,270 --> 00:47:44,480
gotten anything so it's always great

1353
00:47:43,130 --> 00:47:46,070
when you uncover you're pouring a

1354
00:47:44,480 --> 00:47:48,290
contacts password they hate you for it

1355
00:47:46,070 --> 00:47:50,360
and you love yourself for it uh-huh so

1356
00:47:48,290 --> 00:47:51,680
he really challenged us was here it's

1357
00:47:50,360 --> 00:47:53,180
like you're not gonna use my account for

1358
00:47:51,680 --> 00:47:55,430
anything but the one thing they didn't

1359
00:47:53,180 --> 00:47:56,899
do is they did not implement a principle

1360
00:47:55,430 --> 00:47:58,879
of least privilege and we told them over

1361
00:47:56,900 --> 00:48:00,410
and over but they're like no well every

1362
00:47:58,880 --> 00:48:04,160
user needs to be a local admin on their

1363
00:48:00,410 --> 00:48:05,899
workstation I give up like why don't you

1364
00:48:04,160 --> 00:48:07,250
just have like a second account that

1365
00:48:05,900 --> 00:48:09,350
when they need to do that local admin

1366
00:48:07,250 --> 00:48:11,780
stuff they can privilege escalate to it

1367
00:48:09,350 --> 00:48:12,830
briefly you know just it popped up the

1368
00:48:11,780 --> 00:48:14,660
prompt and so it Center you know

1369
00:48:12,830 --> 00:48:16,730
username a password enter a user admin

1370
00:48:14,660 --> 00:48:18,190
user and a password that there so it's

1371
00:48:16,730 --> 00:48:19,910
not like you're logged in as that user

1372
00:48:18,190 --> 00:48:20,859
anyway we were beaten the dead horse

1373
00:48:19,910 --> 00:48:22,680
they're asking them

1374
00:48:20,859 --> 00:48:25,089
and they kept saying no year-over-year

1375
00:48:22,680 --> 00:48:27,640
so then we came in and we did SMB

1376
00:48:25,089 --> 00:48:28,839
relaying and we sat down first thing we

1377
00:48:27,640 --> 00:48:31,569
did was we sent him an email with an

1378
00:48:28,839 --> 00:48:33,130
image tag and he thought he was gonna be

1379
00:48:31,569 --> 00:48:34,749
cocky and so he immediately clicked

1380
00:48:33,130 --> 00:48:36,460
download images because he's like you

1381
00:48:34,749 --> 00:48:38,319
can't crack my hash ha I don't care if

1382
00:48:36,460 --> 00:48:39,730
download images but what we had at doing

1383
00:48:38,319 --> 00:48:42,640
was relaying back to his own workstation

1384
00:48:39,730 --> 00:48:44,019
if you do it over one port and then like

1385
00:48:42,640 --> 00:48:47,739
we had him do it for like a cred is

1386
00:48:44,019 --> 00:48:50,919
purely was like coming over port 80 or

1387
00:48:47,739 --> 00:48:52,180
443 for HTML off prompt like a basic

1388
00:48:50,920 --> 00:48:54,400
auth prompt and then you can relay that

1389
00:48:52,180 --> 00:48:55,629
back to 445 on his own host we knew he's

1390
00:48:54,400 --> 00:48:57,400
a local admin on his own host

1391
00:48:55,630 --> 00:48:58,869
so basically when he clicked download

1392
00:48:57,400 --> 00:49:00,640
images we just relayed it back to his

1393
00:48:58,869 --> 00:49:02,440
laptop and then dumped the local admin

1394
00:49:00,640 --> 00:49:03,819
hash off his laptop and you know it's

1395
00:49:02,440 --> 00:49:05,079
only for his laptop so we pwned his

1396
00:49:03,819 --> 00:49:07,269
laptop in the first 10 minutes we were

1397
00:49:05,079 --> 00:49:08,859
there once we did that we dumped his

1398
00:49:07,269 --> 00:49:09,939
password from clear text in memory and

1399
00:49:08,859 --> 00:49:12,730
that actually brings us to our next

1400
00:49:09,940 --> 00:49:14,079
finding credentials cache in memory so

1401
00:49:12,730 --> 00:49:15,970
how many of you guys have you know I've

1402
00:49:14,079 --> 00:49:18,160
heard about credentials being cached on

1403
00:49:15,970 --> 00:49:19,839
Windows it's very common thing a lot all

1404
00:49:18,160 --> 00:49:22,089
right awesome so here all aware of the

1405
00:49:19,839 --> 00:49:23,558
dangers of LS ass and everything Windows

1406
00:49:22,089 --> 00:49:26,499
tries to do to protect passwords and

1407
00:49:23,559 --> 00:49:28,150
they fail at ahead you want actually

1408
00:49:26,499 --> 00:49:31,899
take away else ass you know I'll keep

1409
00:49:28,150 --> 00:49:33,700
talking on so for else ass stuff it else

1410
00:49:31,900 --> 00:49:36,519
ass runs on every system this is the

1411
00:49:33,700 --> 00:49:38,410
local system authentication authority

1412
00:49:36,519 --> 00:49:43,808
I'm blanking on terms are in ours up to

1413
00:49:38,410 --> 00:49:45,460
late drinking Oh security authority

1414
00:49:43,809 --> 00:49:46,059
subsystem service thank you I was way

1415
00:49:45,460 --> 00:49:48,009
off Wow

1416
00:49:46,059 --> 00:49:50,380
anyway I just known as L SAS IC l SAS

1417
00:49:48,009 --> 00:49:51,039
and I go for that process to dump creds

1418
00:49:50,380 --> 00:49:53,319
from memory

1419
00:49:51,039 --> 00:49:55,299
anyway runs in every window system it's

1420
00:49:53,319 --> 00:49:57,849
gonna cash the credentials in clear text

1421
00:49:55,299 --> 00:49:59,920
in memory if you you know have it

1422
00:49:57,849 --> 00:50:02,319
configured that way which any Windows

1423
00:49:59,920 --> 00:50:04,480
host Windows 7 and below Windows Server

1424
00:50:02,319 --> 00:50:06,609
2008 and Windows 7 they're automatically

1425
00:50:04,480 --> 00:50:08,470
set to cache credentials clear text in

1426
00:50:06,609 --> 00:50:10,960
memory so if I become local admin on a

1427
00:50:08,470 --> 00:50:13,689
workstation I can grab the L SAS process

1428
00:50:10,960 --> 00:50:15,489
by elevating to the system user and once

1429
00:50:13,690 --> 00:50:17,980
I grab that I can scan through it with

1430
00:50:15,489 --> 00:50:20,019
like mini cats let's say it's a tool and

1431
00:50:17,980 --> 00:50:21,880
mini cats will pull out all those clear

1432
00:50:20,019 --> 00:50:23,410
text passwords that are cached and so

1433
00:50:21,880 --> 00:50:24,569
you can have a super long password I'm

1434
00:50:23,410 --> 00:50:27,220
still gonna grab it out of memory

1435
00:50:24,569 --> 00:50:28,329
windows 8.1 they're like alright you

1436
00:50:27,220 --> 00:50:30,368
know what we can't can't they're all

1437
00:50:28,329 --> 00:50:33,130
sorry backup windows 7 you can patch

1438
00:50:30,369 --> 00:50:33,650
this there's a past you could apply for

1439
00:50:33,130 --> 00:50:35,180
the new

1440
00:50:33,650 --> 00:50:36,980
to have to set a registry key to say

1441
00:50:35,180 --> 00:50:39,259
don't cash aw digest passwords in

1442
00:50:36,980 --> 00:50:41,180
clear-text but it still caches the hash

1443
00:50:39,260 --> 00:50:42,650
the ntlm hash that's good enough for me

1444
00:50:41,180 --> 00:50:45,288
if I grab the hash I can pass it around

1445
00:50:42,650 --> 00:50:45,650
the network so I can still get access to

1446
00:50:45,289 --> 00:50:48,289
it

1447
00:50:45,650 --> 00:50:50,569
Windows 8 Windows 10 they tried to

1448
00:50:48,289 --> 00:50:53,059
create the L SAS process as a very

1449
00:50:50,569 --> 00:50:55,520
elevated process which even system can't

1450
00:50:53,059 --> 00:50:57,200
access anymore the system user should

1451
00:50:55,520 --> 00:50:58,910
not be able to access else ass unless

1452
00:50:57,200 --> 00:51:00,799
you've reboot the machine with a

1453
00:50:58,910 --> 00:51:02,480
registry key set to say bring it out of

1454
00:51:00,799 --> 00:51:04,579
this privileged mode so that I can

1455
00:51:02,480 --> 00:51:07,069
access it again I don't know why I see

1456
00:51:04,579 --> 00:51:08,750
organizations without that set all the

1457
00:51:07,069 --> 00:51:11,119
time so make sure that set at least that

1458
00:51:08,750 --> 00:51:12,650
L SAS is running above system level so

1459
00:51:11,119 --> 00:51:15,559
we can't access it and dump you know

1460
00:51:12,650 --> 00:51:17,029
credentials from memory but yeah the

1461
00:51:15,559 --> 00:51:19,609
whole goal of else s get clear text

1462
00:51:17,029 --> 00:51:21,020
credentials or get hashes to pass so

1463
00:51:19,609 --> 00:51:22,910
mini cats the tool I had mentioned

1464
00:51:21,020 --> 00:51:24,740
there's plenty of ways to get this to

1465
00:51:22,910 --> 00:51:26,089
run on a box you have to be local admin

1466
00:51:24,740 --> 00:51:28,520
or sorry not local admin if you have to

1467
00:51:26,089 --> 00:51:30,980
have admin rights on the box to be able

1468
00:51:28,520 --> 00:51:33,349
to grab the L SAS process you can run

1469
00:51:30,980 --> 00:51:35,869
tools like crack map exec and say login

1470
00:51:33,349 --> 00:51:38,480
over 4 or 5 with this hash and give me

1471
00:51:35,869 --> 00:51:40,700
credentials for memory you know run this

1472
00:51:38,480 --> 00:51:42,770
mini cats PowerShell script basically a

1473
00:51:40,700 --> 00:51:45,828
PowerShell umpire has one reporter

1474
00:51:42,770 --> 00:51:47,660
Metasploit has one powersport has one my

1475
00:51:45,829 --> 00:51:48,829
personal favorite method if you're not

1476
00:51:47,660 --> 00:51:51,319
trying to automate and do things very

1477
00:51:48,829 --> 00:51:53,750
fast is just logging into the box with

1478
00:51:51,319 --> 00:51:56,210
RDP or just getting onto it for 45 and

1479
00:51:53,750 --> 00:51:58,400
get a command shell and then use proc

1480
00:51:56,210 --> 00:52:00,500
dump so marks off sysinternals tool or

1481
00:51:58,400 --> 00:52:03,170
just right-clicking taxman jerem proc

1482
00:52:00,500 --> 00:52:05,839
dump you do a dump file of else ass to

1483
00:52:03,170 --> 00:52:07,279
else a CMP is the default it goes to you

1484
00:52:05,839 --> 00:52:09,140
take that offline and then you analyze

1485
00:52:07,279 --> 00:52:10,670
it offline with movie cats that way

1486
00:52:09,140 --> 00:52:12,589
you're not running mini cats on a box

1487
00:52:10,670 --> 00:52:14,900
which pretty much every antivirus

1488
00:52:12,589 --> 00:52:15,740
solution knows what it is a lot of

1489
00:52:14,900 --> 00:52:17,720
next-gen AVS

1490
00:52:15,740 --> 00:52:19,098
see you touching the L SAS process and

1491
00:52:17,720 --> 00:52:20,450
they freak out and they alert on it at

1492
00:52:19,099 --> 00:52:21,680
least they might not be able to stop you

1493
00:52:20,450 --> 00:52:24,919
they try to what they might not be able

1494
00:52:21,680 --> 00:52:26,839
to and so they at least alert on L SAS

1495
00:52:24,920 --> 00:52:28,910
being dumped so that's a good thing a

1496
00:52:26,839 --> 00:52:31,220
positive of next-gen a B unless you're

1497
00:52:28,910 --> 00:52:33,170
running one that can be bypassed by just

1498
00:52:31,220 --> 00:52:35,419
moving the directory that it's running

1499
00:52:33,170 --> 00:52:36,740
in I'm not gonna say the name cuz they

1500
00:52:35,420 --> 00:52:40,369
asked everyone to remove that from the

1501
00:52:36,740 --> 00:52:42,049
internet censorship anyway so we have

1502
00:52:40,369 --> 00:52:43,430
mini cats running in Metasploit so we

1503
00:52:42,049 --> 00:52:45,680
have a shell on a host

1504
00:52:43,430 --> 00:52:46,910
I know missus Empire I'm sorry we have

1505
00:52:45,680 --> 00:52:48,710
an empire module running

1506
00:52:46,910 --> 00:52:50,180
we're running as admin and we just type

1507
00:52:48,710 --> 00:52:53,329
in mini cats it's as easy as that

1508
00:52:50,180 --> 00:52:54,980
we got the ntlm password hash and then w

1509
00:52:53,329 --> 00:52:56,920
digest is gonna cash it in clear-text

1510
00:52:54,980 --> 00:52:59,150
and so we see justin has the password

1511
00:52:56,920 --> 00:53:00,170
exclamation point J and then one two

1512
00:52:59,150 --> 00:53:03,400
three four five six seven eight nine

1513
00:53:00,170 --> 00:53:05,990
zero super secure Justin but it is lab

1514
00:53:03,400 --> 00:53:07,730
so yeah that's you know you can use mini

1515
00:53:05,990 --> 00:53:10,009
cats through multiple means to get

1516
00:53:07,730 --> 00:53:11,780
hashes another option if you want to

1517
00:53:10,010 --> 00:53:15,170
just be rogue and be a bull in a china

1518
00:53:11,780 --> 00:53:16,700
shop crack map exact with SMB once

1519
00:53:15,170 --> 00:53:17,960
you've captured one account that can

1520
00:53:16,700 --> 00:53:20,029
login everywhere so let's say I get that

1521
00:53:17,960 --> 00:53:22,849
local admin hash you're not using laps

1522
00:53:20,030 --> 00:53:24,770
everywhere and I want to try and get

1523
00:53:22,849 --> 00:53:26,450
clear text passwords from all your users

1524
00:53:24,770 --> 00:53:28,880
all your DA's so I can just have the

1525
00:53:26,450 --> 00:53:31,040
clear text passwords to use elsewhere I

1526
00:53:28,880 --> 00:53:33,020
can use crack meth exec pass in the

1527
00:53:31,040 --> 00:53:34,750
local admin hash and spray it across the

1528
00:53:33,020 --> 00:53:36,650
whole network or a port for four or five

1529
00:53:34,750 --> 00:53:38,119
authenticates to all these machines and

1530
00:53:36,650 --> 00:53:39,559
these machines run mini cats for me

1531
00:53:38,119 --> 00:53:40,849
because crack map exec is telling them

1532
00:53:39,559 --> 00:53:42,380
hey run this PowerShell mini cats

1533
00:53:40,849 --> 00:53:43,520
command and give me the output and so

1534
00:53:42,380 --> 00:53:45,680
now I'm just dumping clear text

1535
00:53:43,520 --> 00:53:47,869
passwords from tons of different targets

1536
00:53:45,680 --> 00:53:49,190
and you know sometimes they might not be

1537
00:53:47,869 --> 00:53:51,200
clear text because they could have W

1538
00:53:49,190 --> 00:53:53,059
digests clear text disabled but at least

1539
00:53:51,200 --> 00:53:55,460
I get their ntlm password hash and I can

1540
00:53:53,059 --> 00:53:57,020
pass it anywhere after that so that's a

1541
00:53:55,460 --> 00:53:59,140
really quick way to spray the whole

1542
00:53:57,020 --> 00:54:01,670
network and just get way too many creds

1543
00:53:59,140 --> 00:54:03,529
if you're using a tool to detect you

1544
00:54:01,670 --> 00:54:05,480
know logins across the network rapidly

1545
00:54:03,530 --> 00:54:08,780
like that then you know again detect

1546
00:54:05,480 --> 00:54:09,950
this attack it's not very stealthy but a

1547
00:54:08,780 --> 00:54:11,359
lot of people still don't do that they

1548
00:54:09,950 --> 00:54:12,770
don't have logging to look for you know

1549
00:54:11,359 --> 00:54:14,660
the same account just logged into a

1550
00:54:12,770 --> 00:54:16,400
thousand servers in one second like I

1551
00:54:14,660 --> 00:54:18,319
think that's a red flag I don't know man

1552
00:54:16,400 --> 00:54:30,230
maybe it's not maybe your admins do that

1553
00:54:18,319 --> 00:54:31,579
all the time but yeah yes yes yep

1554
00:54:30,230 --> 00:54:38,270
people take it out of that I don't know

1555
00:54:31,579 --> 00:54:39,619
why so yeah sis admin life so yeah

1556
00:54:38,270 --> 00:54:41,780
remediation like I was talking about you

1557
00:54:39,619 --> 00:54:44,150
have Windows 7 Windows 8 2008 if you

1558
00:54:41,780 --> 00:54:45,680
have these operating systems 8 actually

1559
00:54:44,150 --> 00:54:48,710
I'm sorry 8 doesn't run in the

1560
00:54:45,680 --> 00:54:51,649
privileged so you can still get the ntlm

1561
00:54:48,710 --> 00:54:53,599
hashes it's well eight didn't 8.1 does

1562
00:54:51,650 --> 00:54:56,660
so I misspoke earlier when I just said 8

1563
00:54:53,599 --> 00:54:58,430
blanket but yeah if you're running on

1564
00:54:56,660 --> 00:54:59,990
the older and you haven't migrated up

1565
00:54:58,430 --> 00:55:01,940
yet if you're still running Windows 7

1566
00:54:59,990 --> 00:55:03,740
because you know everyone knows it took

1567
00:55:01,940 --> 00:55:05,270
10 years to get off xp for people so

1568
00:55:03,740 --> 00:55:08,270
it's gonna take 10 to 12 years for

1569
00:55:05,270 --> 00:55:10,490
Windows 7 to 10 or above you can you're

1570
00:55:08,270 --> 00:55:11,780
not you know you're not out of luck you

1571
00:55:10,490 --> 00:55:14,089
can at least get rid of the clear text

1572
00:55:11,780 --> 00:55:17,329
passwords by setting this registry key

1573
00:55:14,089 --> 00:55:19,640
and installing that patch but the ntlm

1574
00:55:17,329 --> 00:55:21,140
hashes can still be extracted so that's

1575
00:55:19,640 --> 00:55:22,940
the risk you balance you should probably

1576
00:55:21,140 --> 00:55:24,470
run laps and make sure that no one's

1577
00:55:22,940 --> 00:55:25,940
logging in as local admin on their

1578
00:55:24,470 --> 00:55:26,480
workstation or sorry domain admin on the

1579
00:55:25,940 --> 00:55:28,329
workstation

1580
00:55:26,480 --> 00:55:31,819
because then you can grab that hash

1581
00:55:28,329 --> 00:55:33,710
Windows 8.1 you prevents access to LS

1582
00:55:31,819 --> 00:55:36,079
ass a print 1 @ above you prevent access

1583
00:55:33,710 --> 00:55:39,079
to LS ass there's a less a registry key

1584
00:55:36,079 --> 00:55:41,960
to prevent you from grabbing that so

1585
00:55:39,079 --> 00:55:43,940
yeah make sure your reg key is set all

1586
00:55:41,960 --> 00:55:49,010
right storytime so did you want to do

1587
00:55:43,940 --> 00:55:50,720
the multi relay here yeah sure

1588
00:55:49,010 --> 00:55:53,720
fly by I actually pulled this through a

1589
00:55:50,720 --> 00:55:57,618
tldr basically there's another great way

1590
00:55:53,720 --> 00:55:59,629
for cache credentials the central kaz

1591
00:55:57,619 --> 00:56:02,329
server so central authentication server

1592
00:55:59,630 --> 00:56:03,619
these are like a goldmine everyone in

1593
00:56:02,329 --> 00:56:05,180
the year company authenticates to them

1594
00:56:03,619 --> 00:56:06,589
if you can ever get to that and dump

1595
00:56:05,180 --> 00:56:08,779
credentials and clear text and memory

1596
00:56:06,589 --> 00:56:10,339
there you pretty much get everyone's

1597
00:56:08,780 --> 00:56:11,900
credentials in clear text so the story

1598
00:56:10,339 --> 00:56:14,058
was just basically you find a cache and

1599
00:56:11,900 --> 00:56:16,250
SS admins like the name their cat server

1600
00:56:14,059 --> 00:56:17,839
like cazzo one domain com

1601
00:56:16,250 --> 00:56:19,040
so you find it that way and then you

1602
00:56:17,839 --> 00:56:20,690
target it and you dump everyone's

1603
00:56:19,040 --> 00:56:24,650
credentials in clear-text and it's great

1604
00:56:20,690 --> 00:56:26,930
test you or the password alright do you

1605
00:56:24,650 --> 00:56:28,910
be password storage so another option is

1606
00:56:26,930 --> 00:56:30,348
if you're not using laps if you're

1607
00:56:28,910 --> 00:56:31,640
trying to set the same local admin

1608
00:56:30,349 --> 00:56:33,770
password across all these workstations

1609
00:56:31,640 --> 00:56:37,549
you might use group policy preferences

1610
00:56:33,770 --> 00:56:38,990
which is Microsoft they released the

1611
00:56:37,549 --> 00:56:41,150
option to do this where you could use

1612
00:56:38,990 --> 00:56:43,578
group policy preferences enact group

1613
00:56:41,150 --> 00:56:46,549
stuff XML file to store the local admin

1614
00:56:43,579 --> 00:56:48,319
password and AES 256-bit encrypted

1615
00:56:46,549 --> 00:56:49,640
string and then whenever your

1616
00:56:48,319 --> 00:56:51,140
workstations got it they decree

1617
00:56:49,640 --> 00:56:53,480
to date and they set their local admin

1618
00:56:51,140 --> 00:56:55,700
password to this while Microsoft and

1619
00:56:53,480 --> 00:56:57,650
sometime before 2012 was amazing like

1620
00:56:55,700 --> 00:57:00,288
they always are and they disclosed AES

1621
00:56:57,650 --> 00:57:01,880
private key on MSDN and so that key

1622
00:57:00,289 --> 00:57:03,019
meant we could decrypt that password and

1623
00:57:01,880 --> 00:57:05,480
it was the same across all environments

1624
00:57:03,019 --> 00:57:07,430
and so any user who has actually

1625
00:57:05,480 --> 00:57:09,079
successful which is every domain user

1626
00:57:07,430 --> 00:57:10,250
domain users gets to assist Paul because

1627
00:57:09,079 --> 00:57:12,829
that's your login scripts that's

1628
00:57:10,250 --> 00:57:14,750
everything was able to go and find the

1629
00:57:12,829 --> 00:57:16,400
group's out XML file and then decrypt

1630
00:57:14,750 --> 00:57:17,809
your local admin password which is used

1631
00:57:16,400 --> 00:57:19,430
across your entire environment because

1632
00:57:17,809 --> 00:57:20,960
you're setting it the same so the first

1633
00:57:19,430 --> 00:57:22,819
thing we do when we get creds is well

1634
00:57:20,960 --> 00:57:24,890
you know let's say we responder we crack

1635
00:57:22,819 --> 00:57:26,089
a hash it's a local account we connect

1636
00:57:24,890 --> 00:57:28,519
to the domain controller or four four

1637
00:57:26,089 --> 00:57:30,470
five look for groups that XML decrypt

1638
00:57:28,519 --> 00:57:31,910
that password and you know get local

1639
00:57:30,470 --> 00:57:35,269
admin to everything in the environment

1640
00:57:31,910 --> 00:57:38,359
any user can do it and so Metasploit has

1641
00:57:35,269 --> 00:57:40,069
a module SMB enum GPP super simple put

1642
00:57:38,359 --> 00:57:41,900
in username put in password put in

1643
00:57:40,069 --> 00:57:47,390
domain controller go search for that

1644
00:57:41,900 --> 00:57:48,680
file and it decrypts it okay so real

1645
00:57:47,390 --> 00:57:51,470
quick forgetting this is a quick story

1646
00:57:48,680 --> 00:57:53,269
how we got the username we were doing a

1647
00:57:51,470 --> 00:57:55,098
pen test one time and we have any user

1648
00:57:53,269 --> 00:57:56,899
names passwords ring wasn't working but

1649
00:57:55,099 --> 00:58:00,369
instead we were able to go to a printer

1650
00:57:56,900 --> 00:58:03,259
a Xerox printer and that Xerox printer

1651
00:58:00,369 --> 00:58:04,880
had their credentials to get to the

1652
00:58:03,259 --> 00:58:07,640
address book from the domain controller

1653
00:58:04,880 --> 00:58:10,069
so we were able to go to the Xerox

1654
00:58:07,640 --> 00:58:12,348
printer login as admin admin the default

1655
00:58:10,069 --> 00:58:14,089
admin for their web page login changed

1656
00:58:12,349 --> 00:58:16,220
the LDAP server that was authenticating

1657
00:58:14,089 --> 00:58:17,960
to to say authenticate to me and Xerox

1658
00:58:16,220 --> 00:58:19,669
instead of passing any kind of hash or

1659
00:58:17,960 --> 00:58:21,440
anything fat with LDAP just straight up

1660
00:58:19,670 --> 00:58:23,059
sends you the credentials and clear text

1661
00:58:21,440 --> 00:58:25,069
so we open the netcat listener on our

1662
00:58:23,059 --> 00:58:26,900
server change the LDAP server for Xerox

1663
00:58:25,069 --> 00:58:29,299
it passes the domain username and

1664
00:58:26,900 --> 00:58:30,559
password we logged in with that dump GPP

1665
00:58:29,299 --> 00:58:31,910
credentials and we're domain admin

1666
00:58:30,559 --> 00:58:34,789
within like the first 15 minutes of

1667
00:58:31,910 --> 00:58:35,538
walking insight to this company it

1668
00:58:34,789 --> 00:58:38,420
happens all the time

1669
00:58:35,539 --> 00:58:39,920
remediation first apply a patch GPP is

1670
00:58:38,420 --> 00:58:41,299
not valid anymore Microsoft doesn't

1671
00:58:39,920 --> 00:58:43,430
recommend it they say use laps

1672
00:58:41,299 --> 00:58:45,230
big issue though once you apply this

1673
00:58:43,430 --> 00:58:46,730
patch it doesn't delete groups out XML

1674
00:58:45,230 --> 00:58:48,710
if you still have sis admins using

1675
00:58:46,730 --> 00:58:51,259
groups out XML from ten years ago five

1676
00:58:48,710 --> 00:58:52,670
years ago whatever it's still out there

1677
00:58:51,259 --> 00:58:54,230
if they haven't deleted it and you can

1678
00:58:52,670 --> 00:58:55,460
still go get that password hash and I'm

1679
00:58:54,230 --> 00:58:58,130
willing to bet money that that password

1680
00:58:55,460 --> 00:58:58,599
or sorry that not password hash but

1681
00:58:58,130 --> 00:59:00,190
local

1682
00:58:58,599 --> 00:59:01,299
password I'm willing about money it's

1683
00:59:00,190 --> 00:59:02,680
reused somewhere else in your

1684
00:59:01,299 --> 00:59:04,660
environment so we spray that same

1685
00:59:02,680 --> 00:59:06,538
password and find other you know legacy

1686
00:59:04,660 --> 00:59:11,410
accounts configured with that password

1687
00:59:06,539 --> 00:59:13,239
and if you want to fly under this this

1688
00:59:11,410 --> 00:59:15,069
is my father were taken so long I told

1689
00:59:13,239 --> 00:59:18,329
Aaron that we needed to talk for a

1690
00:59:15,069 --> 00:59:21,220
longer and clearly we've done that so a

1691
00:59:18,329 --> 00:59:24,759
couple more real quick ways does anybody

1692
00:59:21,220 --> 00:59:26,769
remember eternal blue ms 17 not pet yet

1693
00:59:24,759 --> 00:59:27,670
kind of stuff that was released in April

1694
00:59:26,769 --> 00:59:30,399
of 2017

1695
00:59:27,670 --> 00:59:32,259
and Microsoft released this patch well

1696
00:59:30,400 --> 00:59:35,589
it's all still going to be vulnerable

1697
00:59:32,259 --> 00:59:37,210
and you also remember MSO 8 o 67 and how

1698
00:59:35,589 --> 00:59:38,859
nice that really was where you just kind

1699
00:59:37,210 --> 00:59:40,660
of like do a buffer overflow and you get

1700
00:59:38,859 --> 00:59:44,049
system level access that's what this is

1701
00:59:40,660 --> 00:59:45,970
this is the new MSO 8 o 67 still exists

1702
00:59:44,049 --> 00:59:48,940
we don't need creds anything like that

1703
00:59:45,970 --> 00:59:50,649
to get system level access so it's a

1704
00:59:48,940 --> 00:59:53,140
Metasploit module that we can kind of

1705
00:59:50,650 --> 00:59:56,019
just not really the easiest thing to see

1706
00:59:53,140 --> 00:59:56,979
but we just kind of find out which host

1707
00:59:56,019 --> 00:59:58,868
is gonna be vulnerable

1708
00:59:56,979 --> 01:00:02,499
throw this Metasploit module at it gets

1709
00:59:58,869 --> 01:00:04,029
us some meterpreter shell full system

1710
01:00:02,499 --> 01:00:04,959
level access and now we can do all the

1711
01:00:04,029 --> 01:00:08,920
kind of stuff that you saw earlier

1712
01:00:04,960 --> 01:00:10,390
especially with like mini cats yep there

1713
01:00:08,920 --> 01:00:11,890
we go we see our meterpreter how to

1714
01:00:10,390 --> 01:00:13,479
patch that kind of thing have good patch

1715
01:00:11,890 --> 01:00:16,719
management it's that simple as just

1716
01:00:13,479 --> 01:00:18,910
patching for MS 1701 zero same thing

1717
01:00:16,719 --> 01:00:21,759
with Kerberos if you've not heard about

1718
01:00:18,910 --> 01:00:24,339
Kerberos it's again going to be a

1719
01:00:21,759 --> 01:00:26,619
feature not a bug where this is just how

1720
01:00:24,339 --> 01:00:29,710
it works once we get any kind of level

1721
01:00:26,619 --> 01:00:31,839
of user creds in the system there are

1722
01:00:29,710 --> 01:00:35,289
lots of different tools that you can

1723
01:00:31,839 --> 01:00:37,509
kind of use that says find all the SP NS

1724
01:00:35,289 --> 01:00:39,460
inside of Kerberos and give us the

1725
01:00:37,509 --> 01:00:41,890
Kerberos hashes that we can then crack

1726
01:00:39,460 --> 01:00:46,690
offline again it's just how it works

1727
01:00:41,890 --> 01:00:48,129
once we get a level of creds in order to

1728
01:00:46,690 --> 01:00:50,710
be able to get in how do we fix this

1729
01:00:48,130 --> 01:00:53,349
kind of thing just patch it

1730
01:00:50,710 --> 01:00:58,630
no even Sir Paul knows that we just want

1731
01:00:53,349 --> 01:01:01,210
to patch things up sorry yep so strong

1732
01:00:58,630 --> 01:01:02,979
passwords so if we can't crack that

1733
01:01:01,210 --> 01:01:05,200
Kerberos hash that we get then it's

1734
01:01:02,979 --> 01:01:07,359
useless for us Thanks overall

1735
01:01:05,200 --> 01:01:08,979
mitigations you know kind of get a slide

1736
01:01:07,359 --> 01:01:11,140
for all the kind of stuff that we went

1737
01:01:08,979 --> 01:01:11,919
through seems that we're recording so

1738
01:01:11,140 --> 01:01:13,600
you can kind of go through

1739
01:01:11,920 --> 01:01:15,280
but we're also more than happy to share

1740
01:01:13,600 --> 01:01:18,130
our slides with anybody that wants these

1741
01:01:15,280 --> 01:01:20,920
kinds of things and you can contact us

1742
01:01:18,130 --> 01:01:22,630
with these kinds of things it seems that

1743
01:01:20,920 --> 01:01:24,460
we kind of used more than all of our

1744
01:01:22,630 --> 01:01:26,230
time so and I am more than happy to take

1745
01:01:24,460 --> 01:01:28,360
questions outside the room so we don't

1746
01:01:26,230 --> 01:01:31,330
distract anything like that but we also

1747
01:01:28,360 --> 01:01:33,640
want to McKenna I got my security girl

1748
01:01:31,330 --> 01:01:35,440
here to throw the ball out to give if

1749
01:01:33,640 --> 01:01:37,480
anybody wants to come to layer eight

1750
01:01:35,440 --> 01:01:39,730
conference on June 8th and Provence all

1751
01:01:37,480 --> 01:01:41,950
about social engineering OSINT gathering

1752
01:01:39,730 --> 01:01:43,600
a whole conference all about that she's

1753
01:01:41,950 --> 01:01:48,189
gonna turn her back and throw it if

1754
01:01:43,600 --> 01:01:49,630
anybody back up so if anybody wants to

1755
01:01:48,190 --> 01:01:50,560
come if you if you catch the ball and

1756
01:01:49,630 --> 01:01:51,760
you don't want to come just give it to

1757
01:01:50,560 --> 01:01:52,420
somebody else who does and it gets you a

1758
01:01:51,760 --> 01:01:54,190
free ticket

1759
01:01:52,420 --> 01:02:06,190
come see me with it and we'll we'll get

1760
01:01:54,190 --> 01:02:10,920
you in backup nobody wins it's okay a

1761
01:02:06,190 --> 01:02:10,920
profit thank you very much thank you

