1
00:00:02,290 --> 00:00:07,200
[Music]

2
00:00:07,200 --> 00:00:08,720
all right so let's get this started how

3
00:00:08,720 --> 00:00:09,679
y'all doing

4
00:00:09,679 --> 00:00:12,719
um my name is lauren and

5
00:00:12,719 --> 00:00:15,920
this talk is uh in the schedule it's

6
00:00:15,920 --> 00:00:16,400
called

7
00:00:16,400 --> 00:00:18,000
y'all trying to understand azure 80 and

8
00:00:18,000 --> 00:00:19,920
are back and not but um i decided to

9
00:00:19,920 --> 00:00:20,800
change it

10
00:00:20,800 --> 00:00:24,240
um simply because uh i think

11
00:00:24,240 --> 00:00:26,480
this title is more appropriate and also

12
00:00:26,480 --> 00:00:28,480
because i'm giving this talk

13
00:00:28,480 --> 00:00:30,240
and another conference at another point

14
00:00:30,240 --> 00:00:32,238
in time and uh

15
00:00:32,238 --> 00:00:34,079
i thought you might as well just be

16
00:00:34,079 --> 00:00:36,239
consistent so this talk is called y'all

17
00:00:36,239 --> 00:00:37,760
trying to numerate azure ad

18
00:00:37,760 --> 00:00:39,840
in arm or nah and we're going to talk

19
00:00:39,840 --> 00:00:41,680
about azure id we'll talk about arm

20
00:00:41,680 --> 00:00:42,480
which is as

21
00:00:42,480 --> 00:00:47,360
azure resource manager and how the

22
00:00:47,920 --> 00:00:50,559
how the the two services relate so who

23
00:00:50,559 --> 00:00:51,600
am i

24
00:00:51,600 --> 00:00:52,719
so my name is lauren as i mentioned

25
00:00:52,719 --> 00:00:55,520
before i am on the azure red team at

26
00:00:55,520 --> 00:00:56,399
microsoft

27
00:00:56,399 --> 00:00:58,399
notice some of the other red teamers had

28
00:00:58,399 --> 00:01:00,879
a presentation earlier from a

29
00:01:00,879 --> 00:01:04,000
different red team at microsoft and uh

30
00:01:04,000 --> 00:01:07,280
you know had to represent you know um

31
00:01:07,280 --> 00:01:09,360
i go by daddy coco man so if you see me

32
00:01:09,360 --> 00:01:11,040
in the chat or if you see my handle on a

33
00:01:11,040 --> 00:01:12,159
slack somewhere

34
00:01:12,159 --> 00:01:14,240
uh feel free to you know say hi or

35
00:01:14,240 --> 00:01:15,439
whatever

36
00:01:15,439 --> 00:01:17,119
i have a website you can check out my

37
00:01:17,119 --> 00:01:19,840
github i'm also a nerd core rapper by

38
00:01:19,840 --> 00:01:21,920
the name of omai

39
00:01:21,920 --> 00:01:24,640
you can check out my website uh the ssl

40
00:01:24,640 --> 00:01:27,040
certificate expired but you know

41
00:01:27,040 --> 00:01:30,320
who renews those nobody i know um

42
00:01:30,320 --> 00:01:32,000
and i was actually on the the defcon

43
00:01:32,000 --> 00:01:33,600
tape this year so if you

44
00:01:33,600 --> 00:01:35,280
happen to have the defcon tape uh you

45
00:01:35,280 --> 00:01:36,400
can check that out check out one of my

46
00:01:36,400 --> 00:01:38,000
songs cool you always gotta promote my

47
00:01:38,000 --> 00:01:39,360
music check my soundcloud check my

48
00:01:39,360 --> 00:01:40,880
bandcamp you know

49
00:01:40,880 --> 00:01:44,240
i was in the navy for 10 years i got out

50
00:01:44,240 --> 00:01:46,799
about two years ago and i became a web

51
00:01:46,799 --> 00:01:47,920
app pen tester

52
00:01:47,920 --> 00:01:50,240
and now here i am at microsoft on the

53
00:01:50,240 --> 00:01:52,240
azure red team

54
00:01:52,240 --> 00:01:55,280
and i love python and pythonic things so

55
00:01:55,280 --> 00:01:57,200
um you'll constantly see me talk about

56
00:01:57,200 --> 00:01:58,560
python on twitter

57
00:01:58,560 --> 00:02:00,560
or um if you have any questions about

58
00:02:00,560 --> 00:02:02,000
like you know how to get started

59
00:02:02,000 --> 00:02:04,159
or the things you can do or challenges

60
00:02:04,159 --> 00:02:05,920
you can do uh hit me up

61
00:02:05,920 --> 00:02:08,720
and uh i'll hook you up with some stuff

62
00:02:08,720 --> 00:02:09,199
so

63
00:02:09,199 --> 00:02:10,560
today we're going to talk about azure

64
00:02:10,560 --> 00:02:12,879
active directory active resource manager

65
00:02:12,879 --> 00:02:14,640
um tools for interacting with both of

66
00:02:14,640 --> 00:02:16,959
those and i'll give a demonstration at

67
00:02:16,959 --> 00:02:17,760
the end

68
00:02:17,760 --> 00:02:20,239
of a tool that was written called storm

69
00:02:20,239 --> 00:02:21,040
spotter

70
00:02:21,040 --> 00:02:24,959
which allows you to visualize azure ad

71
00:02:24,959 --> 00:02:27,200
and azure resource manager and sort of

72
00:02:27,200 --> 00:02:28,520
find um

73
00:02:28,520 --> 00:02:32,959
misconfigurations let's talk about aed

74
00:02:32,959 --> 00:02:36,560
so azure active azure active identity

75
00:02:36,560 --> 00:02:40,000
excuse me azure active directory or aed

76
00:02:40,000 --> 00:02:42,560
is a cloud-based identity and access

77
00:02:42,560 --> 00:02:43,760
management service

78
00:02:43,760 --> 00:02:46,319
so you have all of these objects that

79
00:02:46,319 --> 00:02:47,120
are

80
00:02:47,120 --> 00:02:48,560
listed on the left or you have users

81
00:02:48,560 --> 00:02:50,319
groups external identities

82
00:02:50,319 --> 00:02:52,640
all these objects are uh within azure

83
00:02:52,640 --> 00:02:53,760
active directory

84
00:02:53,760 --> 00:02:57,200
so basically it's like active directory

85
00:02:57,200 --> 00:03:00,159
but in azure wow who to thunk it right

86
00:03:00,159 --> 00:03:01,840
it's a pretty clear-cut name

87
00:03:01,840 --> 00:03:05,120
um but it definitely has parallels to

88
00:03:05,120 --> 00:03:06,000
what you would find

89
00:03:06,000 --> 00:03:08,879
for um active directory on a windows

90
00:03:08,879 --> 00:03:10,000
domain

91
00:03:10,000 --> 00:03:11,920
but because it's in the cloud things are

92
00:03:11,920 --> 00:03:13,440
managed slightly differently

93
00:03:13,440 --> 00:03:16,959
and you have a lot more options for

94
00:03:16,959 --> 00:03:18,319
the things you can do with these

95
00:03:18,319 --> 00:03:20,000
identities

96
00:03:20,000 --> 00:03:21,840
so let's talk about these objects we

97
00:03:21,840 --> 00:03:24,000
have users which is your standard user

98
00:03:24,000 --> 00:03:25,440
right uh someone who will log

99
00:03:25,440 --> 00:03:28,239
in we have groups which is a collection

100
00:03:28,239 --> 00:03:29,120
of objects

101
00:03:29,120 --> 00:03:30,879
so it can be users it could be groups

102
00:03:30,879 --> 00:03:32,560
service principles etc

103
00:03:32,560 --> 00:03:35,680
just other objects that are in um

104
00:03:35,680 --> 00:03:38,720
azure active or 80

105
00:03:38,720 --> 00:03:41,840
of applications and applications are

106
00:03:41,840 --> 00:03:43,519
used to create service principal objects

107
00:03:43,519 --> 00:03:44,959
we'll talk more about this later god

108
00:03:44,959 --> 00:03:46,480
this is pretty important

109
00:03:46,480 --> 00:03:49,040
we have service principles and a service

110
00:03:49,040 --> 00:03:51,040
principle is a local representation

111
00:03:51,040 --> 00:03:54,319
of an application instance uh within

112
00:03:54,319 --> 00:03:57,360
a tenant and this will all be explained

113
00:03:57,360 --> 00:03:58,560
more as we go along

114
00:03:58,560 --> 00:04:00,959
but then we also have devices which are

115
00:04:00,959 --> 00:04:02,560
managed devices that you can add to

116
00:04:02,560 --> 00:04:03,200
azure

117
00:04:03,200 --> 00:04:06,879
active directory and we have roles

118
00:04:06,879 --> 00:04:09,920
so a role is a set of permissions

119
00:04:09,920 --> 00:04:12,879
that is given to an aad object so it can

120
00:04:12,879 --> 00:04:14,239
be something like a global company

121
00:04:14,239 --> 00:04:15,040
administrator

122
00:04:15,040 --> 00:04:17,040
a user account administrator directory

123
00:04:17,040 --> 00:04:19,120
members these are all the names of roles

124
00:04:19,120 --> 00:04:21,279
that you can apply to an active

125
00:04:21,279 --> 00:04:22,639
directory object

126
00:04:22,639 --> 00:04:26,639
basic aed object let's talk about users

127
00:04:26,639 --> 00:04:28,639
they are a normal user they can be

128
00:04:28,639 --> 00:04:30,080
internal or external

129
00:04:30,080 --> 00:04:32,400
the way you can tell is because the

130
00:04:32,400 --> 00:04:33,120
internal

131
00:04:33,120 --> 00:04:37,120
will have the alias at the tenant

132
00:04:37,120 --> 00:04:40,560
and dot on microsoft.com

133
00:04:40,560 --> 00:04:43,199
an external will have an alias followed

134
00:04:43,199 --> 00:04:44,560
by an underscore

135
00:04:44,560 --> 00:04:46,800
then the name of their home tenant

136
00:04:46,800 --> 00:04:48,560
followed by

137
00:04:48,560 --> 00:04:51,199
octothorpe i'm using the fancy word

138
00:04:51,199 --> 00:04:52,240
octothorpe

139
00:04:52,240 --> 00:04:57,840
ext octothorpe tenet.on

140
00:04:58,160 --> 00:05:00,800
so for example you can have laurent.gray

141
00:05:00,800 --> 00:05:03,759
at stormspotter.onmicrosoft.com

142
00:05:03,759 --> 00:05:06,720
or you can have laurent.gray underscore

143
00:05:06,720 --> 00:05:08,160
microsoft.com

144
00:05:08,160 --> 00:05:11,199
optothorpe ext octothorpe

145
00:05:11,199 --> 00:05:13,840
at stormspotter.onmicrosoft.com i've

146
00:05:13,840 --> 00:05:15,199
never said that word so many times in my

147
00:05:15,199 --> 00:05:16,639
life and it just feels like really

148
00:05:16,639 --> 00:05:18,880
refreshing to use a new word

149
00:05:18,880 --> 00:05:21,360
so if you look at the what a user looks

150
00:05:21,360 --> 00:05:22,240
like in

151
00:05:22,240 --> 00:05:25,360
um aed this is a if you look in the

152
00:05:25,360 --> 00:05:26,080
portal

153
00:05:26,080 --> 00:05:29,639
here we have kelly santana at

154
00:05:29,639 --> 00:05:31,199
stormspotter.onmicrosoft.com

155
00:05:31,199 --> 00:05:34,479
and each object in azure active

156
00:05:34,479 --> 00:05:35,440
directory

157
00:05:35,440 --> 00:05:37,520
is given an object id that's how it's

158
00:05:37,520 --> 00:05:39,840
referenced so anytime you see

159
00:05:39,840 --> 00:05:44,240
an object id it's used to um

160
00:05:44,240 --> 00:05:47,280
as a way for for azure

161
00:05:47,280 --> 00:05:48,960
active directory to know about that

162
00:05:48,960 --> 00:05:51,440
object and to

163
00:05:51,440 --> 00:05:55,039
provide relationships to other

164
00:05:55,840 --> 00:05:57,520
roles or permissions or other objects

165
00:05:57,520 --> 00:05:59,039
that are in active

166
00:05:59,039 --> 00:06:01,600
azure active directory then we have

167
00:06:01,600 --> 00:06:04,000
groups which is pretty self-explanatory

168
00:06:04,000 --> 00:06:06,160
a group is a group of objects so you can

169
00:06:06,160 --> 00:06:07,280
have users groups

170
00:06:07,280 --> 00:06:09,919
devices you can have service principles

171
00:06:09,919 --> 00:06:11,520
and it's just uh just a logical

172
00:06:11,520 --> 00:06:12,400
collection

173
00:06:12,400 --> 00:06:14,560
of groups this is the same that you

174
00:06:14,560 --> 00:06:16,960
would have in a a normal

175
00:06:16,960 --> 00:06:18,400
active directory environment where you

176
00:06:18,400 --> 00:06:20,240
have a group for membership

177
00:06:20,240 --> 00:06:24,080
this applies uh the very same way

178
00:06:24,080 --> 00:06:26,319
so we have direct members of a group

179
00:06:26,319 --> 00:06:27,120
which are

180
00:06:27,120 --> 00:06:30,160
those who are explicitly assigned

181
00:06:30,160 --> 00:06:33,360
to a group so in this

182
00:06:33,360 --> 00:06:35,199
instance i forgot to put the actual name

183
00:06:35,199 --> 00:06:36,479
of the the group here it's

184
00:06:36,479 --> 00:06:38,319
the actual group is called sales and

185
00:06:38,319 --> 00:06:39,680
under sales we have

186
00:06:39,680 --> 00:06:42,160
uh caroline catherine jason we have a

187
00:06:42,160 --> 00:06:43,600
group another group called sales

188
00:06:43,600 --> 00:06:45,600
cashiers so we have a nested group here

189
00:06:45,600 --> 00:06:48,080
we have kelly and kyle and if we look at

190
00:06:48,080 --> 00:06:49,120
all the members

191
00:06:49,120 --> 00:06:50,720
right we can see that it actually

192
00:06:50,720 --> 00:06:53,039
unrolls the other

193
00:06:53,039 --> 00:06:55,120
groups that are inside of this group and

194
00:06:55,120 --> 00:06:56,720
lists all the members of that group

195
00:06:56,720 --> 00:06:58,720
so johnny anderson kristen howell and

196
00:06:58,720 --> 00:07:00,720
dave frank are all actually members of

197
00:07:00,720 --> 00:07:01,120
the

198
00:07:01,120 --> 00:07:03,520
sales cashiers group but since we're

199
00:07:03,520 --> 00:07:05,120
looking at all the members of the sales

200
00:07:05,120 --> 00:07:05,520
group

201
00:07:05,520 --> 00:07:07,599
they're going to show up here too this

202
00:07:07,599 --> 00:07:09,199
is really important because

203
00:07:09,199 --> 00:07:10,960
sometimes and a really common

204
00:07:10,960 --> 00:07:12,400
misconfiguration

205
00:07:12,400 --> 00:07:14,720
is that you have groups that are part of

206
00:07:14,720 --> 00:07:16,319
other groups who accidentally inherit

207
00:07:16,319 --> 00:07:17,759
permissions that they're not supposed to

208
00:07:17,759 --> 00:07:18,560
have

209
00:07:18,560 --> 00:07:22,319
so um this is actually a a fairly common

210
00:07:22,319 --> 00:07:25,759
thing that you can mess up into uh

211
00:07:25,759 --> 00:07:27,599
in azure active directory the same way

212
00:07:27,599 --> 00:07:29,520
you could probably mess it up in

213
00:07:29,520 --> 00:07:33,520
active directory so groups can also have

214
00:07:33,520 --> 00:07:35,440
owners right so you can have an owner of

215
00:07:35,440 --> 00:07:36,160
an object

216
00:07:36,160 --> 00:07:38,000
but the owner doesn't have to be a

217
00:07:38,000 --> 00:07:39,280
member of

218
00:07:39,280 --> 00:07:42,400
that group so in this case we have this

219
00:07:42,400 --> 00:07:45,440
group called sales and we have

220
00:07:45,440 --> 00:07:47,360
all these users and the sales cashiers

221
00:07:47,360 --> 00:07:49,759
group but the owner

222
00:07:49,759 --> 00:07:52,000
is not only kelly but also a service

223
00:07:52,000 --> 00:07:52,800
principal called

224
00:07:52,800 --> 00:07:56,080
sales aed spn why is that there

225
00:07:56,080 --> 00:07:57,280
i don't know that's probably a

226
00:07:57,280 --> 00:07:59,280
misconfiguration um

227
00:07:59,280 --> 00:08:01,840
there's no reason but well there's

228
00:08:01,840 --> 00:08:03,440
there's not really a reason that it's

229
00:08:03,440 --> 00:08:05,199
not a common reason to have a service

230
00:08:05,199 --> 00:08:06,240
principle in charge

231
00:08:06,240 --> 00:08:08,560
uh have ownership over a group but um

232
00:08:08,560 --> 00:08:09,919
that's definitely something

233
00:08:09,919 --> 00:08:12,080
you can look into if you were to see

234
00:08:12,080 --> 00:08:14,960
that i'd question it myself

235
00:08:14,960 --> 00:08:17,360
so what applications so an application

236
00:08:17,360 --> 00:08:18,560
is a template

237
00:08:18,560 --> 00:08:19,919
used to create a service principle for

238
00:08:19,919 --> 00:08:21,680
authentication so basically

239
00:08:21,680 --> 00:08:23,759
an application is like you make a a

240
00:08:23,759 --> 00:08:25,440
website right um

241
00:08:25,440 --> 00:08:26,310
i don't know

242
00:08:26,310 --> 00:08:28,840
[Music]

243
00:08:28,840 --> 00:08:30,479
stormspotter.azurewebsites.net

244
00:08:30,479 --> 00:08:33,039
and you create this application inside

245
00:08:33,039 --> 00:08:33,519
of

246
00:08:33,519 --> 00:08:36,719
azure and then you give it an

247
00:08:36,719 --> 00:08:38,799
ad application and you say this

248
00:08:38,799 --> 00:08:41,279
application is responsible for

249
00:08:41,279 --> 00:08:44,880
authorizing you to access

250
00:08:46,200 --> 00:08:48,000
stormspotter.azurewebsites.net

251
00:08:48,000 --> 00:08:51,600
so you can set up a you know a website

252
00:08:51,600 --> 00:08:52,800
or whatever and have

253
00:08:52,800 --> 00:08:54,800
the ad authentication automatically done

254
00:08:54,800 --> 00:08:56,480
through the use of this aav application

255
00:08:56,480 --> 00:08:58,160
object

256
00:08:58,160 --> 00:09:00,080
so applications can be single tenant or

257
00:09:00,080 --> 00:09:01,360
multi-tenant

258
00:09:01,360 --> 00:09:03,920
um what this means is that you can have

259
00:09:03,920 --> 00:09:05,200
an application that's

260
00:09:05,200 --> 00:09:07,200
made specifically for your own company

261
00:09:07,200 --> 00:09:10,240
your own organization

262
00:09:10,240 --> 00:09:12,640
or you can have an application that's

263
00:09:12,640 --> 00:09:13,519
meant for

264
00:09:13,519 --> 00:09:16,720
anyone and when you um

265
00:09:16,720 --> 00:09:18,959
when you create a multi-tenant app that

266
00:09:18,959 --> 00:09:20,320
really means multi-tenant that means

267
00:09:20,320 --> 00:09:22,399
that any organization

268
00:09:22,399 --> 00:09:25,600
has access to that application

269
00:09:25,600 --> 00:09:27,839
there's been a recent history over the

270
00:09:27,839 --> 00:09:29,120
last couple years of

271
00:09:29,120 --> 00:09:30,640
of attackers making malicious

272
00:09:30,640 --> 00:09:32,560
applications multi-center applications

273
00:09:32,560 --> 00:09:35,760
which then create a service principal

274
00:09:35,760 --> 00:09:37,519
and the target tenant and then all of a

275
00:09:37,519 --> 00:09:39,839
sudden they have some sort of permission

276
00:09:39,839 --> 00:09:42,959
and a tenant that they're not supposed

277
00:09:42,959 --> 00:09:43,519
to have

278
00:09:43,519 --> 00:09:45,760
because maybe the administrators forgot

279
00:09:45,760 --> 00:09:47,920
to turn off the ability for users

280
00:09:47,920 --> 00:09:51,040
to add applications to the tenant so

281
00:09:51,040 --> 00:09:52,399
um it's it's something that you

282
00:09:52,399 --> 00:09:54,240
definitely want to be careful of uh when

283
00:09:54,240 --> 00:09:54,560
you're

284
00:09:54,560 --> 00:09:57,920
talking about applications because a

285
00:09:57,920 --> 00:09:59,920
application with too many permissions

286
00:09:59,920 --> 00:10:01,200
that is not yours

287
00:10:01,200 --> 00:10:03,519
um or even if it is yours can be pretty

288
00:10:03,519 --> 00:10:05,200
troublesome

289
00:10:05,200 --> 00:10:08,000
so here's what an application looks like

290
00:10:08,000 --> 00:10:08,560
uh

291
00:10:08,560 --> 00:10:12,560
in the portal it has an application id

292
00:10:12,560 --> 00:10:14,320
and it has an object id so remember the

293
00:10:14,320 --> 00:10:16,640
object id is what azure active directory

294
00:10:16,640 --> 00:10:18,720
uses to reference it but the application

295
00:10:18,720 --> 00:10:19,440
id

296
00:10:19,440 --> 00:10:21,760
is the application that is unique to

297
00:10:21,760 --> 00:10:23,360
this

298
00:10:23,360 --> 00:10:24,959
there is the id that's unique to this

299
00:10:24,959 --> 00:10:28,720
application because again we can have

300
00:10:28,720 --> 00:10:31,120
multiple you can have a multi-tenant

301
00:10:31,120 --> 00:10:32,880
application with different service

302
00:10:32,880 --> 00:10:33,680
principles

303
00:10:33,680 --> 00:10:35,440
right in different tenants but they're

304
00:10:35,440 --> 00:10:36,640
all going to point to this one

305
00:10:36,640 --> 00:10:39,439
application id

306
00:10:39,600 --> 00:10:42,240
so we talk about service principles

307
00:10:42,240 --> 00:10:43,600
right it's an instance of an 80

308
00:10:43,600 --> 00:10:44,480
application that's

309
00:10:44,480 --> 00:10:46,000
somewhere out there right whether it's

310
00:10:46,000 --> 00:10:48,079
in your channel or somebody else's

311
00:10:48,079 --> 00:10:50,000
um the credentials that you you can add

312
00:10:50,000 --> 00:10:51,360
credentials to service principle

313
00:10:51,360 --> 00:10:53,279
and you can use it to log in as that

314
00:10:53,279 --> 00:10:54,640
particular identity

315
00:10:54,640 --> 00:10:56,320
uh it's usually usually think of it like

316
00:10:56,320 --> 00:10:57,760
a service account right you don't want

317
00:10:57,760 --> 00:10:59,120
you don't need a user

318
00:10:59,120 --> 00:11:01,680
to log in to do this action or maybe you

319
00:11:01,680 --> 00:11:03,360
have some sort of automation setup

320
00:11:03,360 --> 00:11:06,079
you use a service principle to do that

321
00:11:06,079 --> 00:11:08,480
you can add a password to it

322
00:11:08,480 --> 00:11:10,480
or you can add a certificate to it for

323
00:11:10,480 --> 00:11:12,399
authentication

324
00:11:12,399 --> 00:11:14,640
and if you create a service principle

325
00:11:14,640 --> 00:11:15,440
directly

326
00:11:15,440 --> 00:11:17,440
it will also create an application

327
00:11:17,440 --> 00:11:18,880
behind it automatically

328
00:11:18,880 --> 00:11:20,959
so even if you don't create the

329
00:11:20,959 --> 00:11:22,320
application yourself

330
00:11:22,320 --> 00:11:24,079
um creating a service principle directly

331
00:11:24,079 --> 00:11:25,760
will create that application

332
00:11:25,760 --> 00:11:27,200
because it needs to be tied to some

333
00:11:27,200 --> 00:11:31,120
application some sort of application id

334
00:11:31,120 --> 00:11:33,200
so here's what i mentioned before we

335
00:11:33,200 --> 00:11:34,800
have the application

336
00:11:34,800 --> 00:11:36,640
uh and it has that application id on the

337
00:11:36,640 --> 00:11:38,399
left side and on the right side we have

338
00:11:38,399 --> 00:11:39,600
the service principle

339
00:11:39,600 --> 00:11:41,600
that represents that application inside

340
00:11:41,600 --> 00:11:42,800
of this tenant

341
00:11:42,800 --> 00:11:45,600
and the application id for the two are

342
00:11:45,600 --> 00:11:46,720
the same

343
00:11:46,720 --> 00:11:48,720
but the object id for the two are

344
00:11:48,720 --> 00:11:50,160
different because they're two different

345
00:11:50,160 --> 00:11:51,279
objects as far as

346
00:11:51,279 --> 00:11:56,720
azure active directory is concerned

347
00:11:56,720 --> 00:11:59,600
let's talk about devices devices are uh

348
00:11:59,600 --> 00:12:00,480
can be joined

349
00:12:00,480 --> 00:12:03,279
or registered you typically find joined

350
00:12:03,279 --> 00:12:05,040
devices for corporate resources

351
00:12:05,040 --> 00:12:07,839
right so you have like a desktop or some

352
00:12:07,839 --> 00:12:10,720
some managed device by your organization

353
00:12:10,720 --> 00:12:14,079
and you would join that that to aad

354
00:12:14,079 --> 00:12:18,399
or you can have a registered device

355
00:12:18,399 --> 00:12:20,560
um and those registered ones are usually

356
00:12:20,560 --> 00:12:22,000
bring your own device so they're like a

357
00:12:22,000 --> 00:12:22,880
mobile device

358
00:12:22,880 --> 00:12:25,839
that maybe a uh an employee has a phone

359
00:12:25,839 --> 00:12:27,839
and they've allowed you to manage

360
00:12:27,839 --> 00:12:30,399
or they've allowed you they've enrolled

361
00:12:30,399 --> 00:12:31,519
it so that they can access corporate

362
00:12:31,519 --> 00:12:32,720
resources

363
00:12:32,720 --> 00:12:36,160
and they're not really joined because

364
00:12:36,160 --> 00:12:37,600
it's their own personal device

365
00:12:37,600 --> 00:12:40,800
but they are registered so here's an

366
00:12:40,800 --> 00:12:41,360
example

367
00:12:41,360 --> 00:12:44,560
um the first one uh in this

368
00:12:44,560 --> 00:12:47,920
list is an azure 80 joined windows

369
00:12:47,920 --> 00:12:50,399
post and the other ones all registered

370
00:12:50,399 --> 00:12:52,160
right they're not managed by

371
00:12:52,160 --> 00:12:55,680
uh by the by the active directory

372
00:12:55,680 --> 00:12:57,279
but it allows me to access some of the

373
00:12:57,279 --> 00:12:59,360
resources because i am

374
00:12:59,360 --> 00:13:02,240
i'm known to the i'm known to azure

375
00:13:02,240 --> 00:13:04,959
active directory

376
00:13:05,040 --> 00:13:07,440
let's talk about roles so roles define

377
00:13:07,440 --> 00:13:08,160
permissions

378
00:13:08,160 --> 00:13:11,519
for other aad objects uh they have a

379
00:13:11,519 --> 00:13:13,120
built-in

380
00:13:13,120 --> 00:13:14,320
they have there are built-in roles you

381
00:13:14,320 --> 00:13:15,760
can make your own but they have a

382
00:13:15,760 --> 00:13:16,639
predefined

383
00:13:16,639 --> 00:13:19,279
set of permissions so you can make your

384
00:13:19,279 --> 00:13:20,079
own but

385
00:13:20,079 --> 00:13:22,160
um you should definitely check your

386
00:13:22,160 --> 00:13:23,760
permissions that you add to them

387
00:13:23,760 --> 00:13:26,959
there's a lot of very granular aed roles

388
00:13:26,959 --> 00:13:27,760
already

389
00:13:27,760 --> 00:13:29,760
if you need to make one feel free to go

390
00:13:29,760 --> 00:13:31,279
ahead but you want to make sure that

391
00:13:31,279 --> 00:13:32,880
your roles aren't too permissive and you

392
00:13:32,880 --> 00:13:33,680
should probably

393
00:13:33,680 --> 00:13:35,600
check to see if it's already covered by

394
00:13:35,600 --> 00:13:37,600
a built-in role just so you don't make

395
00:13:37,600 --> 00:13:38,880
no mess of something up it's like

396
00:13:38,880 --> 00:13:40,240
rolling your own crypto right there's

397
00:13:40,240 --> 00:13:41,199
already crypto there

398
00:13:41,199 --> 00:13:43,519
right don't try to roll your own if it

399
00:13:43,519 --> 00:13:44,399
you know

400
00:13:44,399 --> 00:13:47,839
if it exists already uh here's what it

401
00:13:47,839 --> 00:13:49,199
would look like in portal

402
00:13:49,199 --> 00:13:52,240
so if you look at the list of aed roles

403
00:13:52,240 --> 00:13:53,519
you'll have all these lists

404
00:13:53,519 --> 00:13:54,720
and they're all they all end with

405
00:13:54,720 --> 00:13:56,639
administrator for the most part

406
00:13:56,639 --> 00:13:58,959
um or with exceptional things like

407
00:13:58,959 --> 00:14:00,480
global reader but most of these roles

408
00:14:00,480 --> 00:14:01,760
are administrative roles

409
00:14:01,760 --> 00:14:03,680
because they have some sort of power

410
00:14:03,680 --> 00:14:05,519
over another aed object

411
00:14:05,519 --> 00:14:06,959
the one that i have highlighted here is

412
00:14:06,959 --> 00:14:08,800
global administrator which can manage

413
00:14:08,800 --> 00:14:09,120
all

414
00:14:09,120 --> 00:14:10,880
aspects of azure id and microsoft

415
00:14:10,880 --> 00:14:13,040
services that is that is the top

416
00:14:13,040 --> 00:14:15,600
administ almost the top administrator

417
00:14:15,600 --> 00:14:17,040
you can actually elevate from that

418
00:14:17,040 --> 00:14:18,880
into another role but um global

419
00:14:18,880 --> 00:14:20,240
administrators are the accounts that you

420
00:14:20,240 --> 00:14:21,360
definitely 100

421
00:14:21,360 --> 00:14:24,560
percent want to protect through mfa and

422
00:14:24,560 --> 00:14:26,079
perhaps a separate account from the

423
00:14:26,079 --> 00:14:27,440
different user account the same way that

424
00:14:27,440 --> 00:14:28,480
you would treat a domain

425
00:14:28,480 --> 00:14:30,959
a domain administrator so you don't use

426
00:14:30,959 --> 00:14:32,560
your regular account to do

427
00:14:32,560 --> 00:14:35,120
domain administrative work i hope uh you

428
00:14:35,120 --> 00:14:36,079
have a separate account

429
00:14:36,079 --> 00:14:38,000
that you would log into in order to do

430
00:14:38,000 --> 00:14:41,040
that level of activity

431
00:14:41,040 --> 00:14:41,920
some of the other ones that are

432
00:14:41,920 --> 00:14:44,399
highlighted here are

433
00:14:44,399 --> 00:14:45,920
i mean all these administrative roles

434
00:14:45,920 --> 00:14:47,760
are are interesting but some of the

435
00:14:47,760 --> 00:14:49,360
other ones highlighted ones are

436
00:14:49,360 --> 00:14:51,519
for example the help desk administrator

437
00:14:51,519 --> 00:14:52,959
which can reset passwords for

438
00:14:52,959 --> 00:14:54,320
non-administrators and help desk

439
00:14:54,320 --> 00:14:56,000
administrators which basically gives you

440
00:14:56,000 --> 00:14:58,079
the ability to reset any user's password

441
00:14:58,079 --> 00:14:59,279
and then you know log in as

442
00:14:59,279 --> 00:15:03,600
them assuming like there's no

443
00:15:03,600 --> 00:15:07,760
mfa involved or anything like that so um

444
00:15:07,760 --> 00:15:08,800
you should definitely look through these

445
00:15:08,800 --> 00:15:10,839
roles see if

446
00:15:10,839 --> 00:15:14,959
uh if if there's something that

447
00:15:14,959 --> 00:15:17,440
you may want to use and apply to a

448
00:15:17,440 --> 00:15:19,600
particular set of objects before you

449
00:15:19,600 --> 00:15:22,160
try to create your own uh groups or your

450
00:15:22,160 --> 00:15:24,800
own roles excuse me

451
00:15:24,800 --> 00:15:27,440
um here's what it looks like um if you

452
00:15:27,440 --> 00:15:28,720
look at the summary

453
00:15:28,720 --> 00:15:29,839
you'll if you're looking portal you'll

454
00:15:29,839 --> 00:15:30,959
get a summary of the roll will give you

455
00:15:30,959 --> 00:15:32,000
the description

456
00:15:32,000 --> 00:15:35,040
but more importantly these uh

457
00:15:35,040 --> 00:15:36,800
roles have are a set of permissions so

458
00:15:36,800 --> 00:15:38,639
each permission has a namespace

459
00:15:38,639 --> 00:15:40,480
an object in the namespace and sometimes

460
00:15:40,480 --> 00:15:42,320
some properties and an action that you

461
00:15:42,320 --> 00:15:42,959
can do

462
00:15:42,959 --> 00:15:46,000
on that object uh you can look at the

463
00:15:46,000 --> 00:15:49,360
the site there um and you can just go

464
00:15:49,360 --> 00:15:50,639
bing i'm gonna say bings we talk about

465
00:15:50,639 --> 00:15:52,480
microsoft today right if you decide to

466
00:15:52,480 --> 00:15:54,800
bing

467
00:15:54,800 --> 00:15:57,759
directory assignment admin roles you can

468
00:15:57,759 --> 00:16:00,000
check that out

469
00:16:00,000 --> 00:16:02,720
um so the role permissions are some look

470
00:16:02,720 --> 00:16:04,160
like this right they have

471
00:16:04,160 --> 00:16:05,680
microsoft directory which is the name

472
00:16:05,680 --> 00:16:08,720
space then you have these users objects

473
00:16:08,720 --> 00:16:11,519
and as a help desk administrator i can

474
00:16:11,519 --> 00:16:13,279
invalidate all their refresh tokens that

475
00:16:13,279 --> 00:16:14,160
would be the first one

476
00:16:14,160 --> 00:16:15,759
in that list right and all these

477
00:16:15,759 --> 00:16:17,440
permissions are

478
00:16:17,440 --> 00:16:20,160
are laid out so you know exactly what

479
00:16:20,160 --> 00:16:23,839
each role is able to do

480
00:16:25,279 --> 00:16:29,040
let's talk about azure resource manager

481
00:16:29,440 --> 00:16:31,360
oh one thing i didn't cover um and i

482
00:16:31,360 --> 00:16:32,800
realized this morning that i didn't put

483
00:16:32,800 --> 00:16:35,519
it in the slides that really have time

484
00:16:35,519 --> 00:16:39,040
we're managed identities um so

485
00:16:39,040 --> 00:16:42,240
a managed identity is an identity that

486
00:16:42,240 --> 00:16:44,560
you can give to a resource

487
00:16:44,560 --> 00:16:46,320
in azure like a virtual machine or

488
00:16:46,320 --> 00:16:47,680
something like that

489
00:16:47,680 --> 00:16:50,079
you can give that a managed identity so

490
00:16:50,079 --> 00:16:51,839
that you can access other resources

491
00:16:51,839 --> 00:16:54,000
those managed identities will show up in

492
00:16:54,000 --> 00:16:55,759
azure active directory

493
00:16:55,759 --> 00:16:59,680
so you can treat it just like an actual

494
00:16:59,680 --> 00:17:02,720
identity for that for that resource

495
00:17:02,720 --> 00:17:05,199
but anyway so let's move on to uh azure

496
00:17:05,199 --> 00:17:07,119
resource manager

497
00:17:07,119 --> 00:17:09,119
so it is the deployment and management

498
00:17:09,119 --> 00:17:10,720
service for azure resources

499
00:17:10,720 --> 00:17:13,280
sources it used to be called asm um

500
00:17:13,280 --> 00:17:14,559
azure service manager

501
00:17:14,559 --> 00:17:16,319
way back when i don't know how long back

502
00:17:16,319 --> 00:17:18,559
when before i join microsoft at least

503
00:17:18,559 --> 00:17:21,359
um and it's now known as classic so if

504
00:17:21,359 --> 00:17:22,240
you see something like

505
00:17:22,240 --> 00:17:24,480
classic administrator or classic storage

506
00:17:24,480 --> 00:17:25,760
or classic resource

507
00:17:25,760 --> 00:17:28,480
they're talking about services that were

508
00:17:28,480 --> 00:17:29,120
provisioned

509
00:17:29,120 --> 00:17:32,160
under azure service manager

510
00:17:32,160 --> 00:17:34,160
the azure resource manager is

511
00:17:34,160 --> 00:17:35,280
essentially a

512
00:17:35,280 --> 00:17:38,160
set of apis that are used to talk to all

513
00:17:38,160 --> 00:17:39,120
of the resource

514
00:17:39,120 --> 00:17:42,640
providers within azure so you can access

515
00:17:42,640 --> 00:17:43,440
it through portal

516
00:17:43,440 --> 00:17:45,440
through powershell through the cli

517
00:17:45,440 --> 00:17:46,559
address cli

518
00:17:46,559 --> 00:17:48,559
or through just simply just a rest

519
00:17:48,559 --> 00:17:49,600
client right you can

520
00:17:49,600 --> 00:17:51,679
talk to it directly or with curl or you

521
00:17:51,679 --> 00:17:53,360
know whatever um

522
00:17:53,360 --> 00:17:56,559
api talking tool you like to use

523
00:17:56,559 --> 00:17:59,200
and um you can access you can talk to

524
00:17:59,200 --> 00:18:00,080
the

525
00:18:00,080 --> 00:18:02,559
uh the resource providers that are in

526
00:18:02,559 --> 00:18:04,160
azure

527
00:18:04,160 --> 00:18:05,600
so here's some terminology you need to

528
00:18:05,600 --> 00:18:08,160
know there's a the tenant

529
00:18:08,160 --> 00:18:09,840
which is the representation of an

530
00:18:09,840 --> 00:18:11,520
organization so when you log

531
00:18:11,520 --> 00:18:14,720
in um so for example uh

532
00:18:14,720 --> 00:18:17,280
uh microsoft.com or microsoft would be a

533
00:18:17,280 --> 00:18:18,000
tenant right

534
00:18:18,000 --> 00:18:20,880
um and but microsoft may it as an

535
00:18:20,880 --> 00:18:21,600
organization

536
00:18:21,600 --> 00:18:24,000
may have other sub organizations so you

537
00:18:24,000 --> 00:18:24,720
can have

538
00:18:24,720 --> 00:18:28,080
an organization for microsoft part one

539
00:18:28,080 --> 00:18:29,600
a different tenant for microsoft part

540
00:18:29,600 --> 00:18:31,360
two microsoft part three

541
00:18:31,360 --> 00:18:33,760
and uh you just know that a tenant

542
00:18:33,760 --> 00:18:35,840
represents an organization as it's

543
00:18:35,840 --> 00:18:38,720
um defined by however your organization

544
00:18:38,720 --> 00:18:40,000
wants to define

545
00:18:40,000 --> 00:18:42,480
its organizations uh there's no set way

546
00:18:42,480 --> 00:18:43,280
but usually

547
00:18:43,280 --> 00:18:45,280
you have the top level uh tenant and

548
00:18:45,280 --> 00:18:47,200
then you may have other tenants that are

549
00:18:47,200 --> 00:18:48,960
alongside that are provisioned by an

550
00:18:48,960 --> 00:18:51,200
organization

551
00:18:51,200 --> 00:18:54,640
uh you have uh subscriptions which is a

552
00:18:54,640 --> 00:18:56,160
logical collection of resource groups

553
00:18:56,160 --> 00:18:57,360
and they're usually separated for

554
00:18:57,360 --> 00:18:58,320
billing purposes

555
00:18:58,320 --> 00:19:00,559
so you can have a subscription maybe for

556
00:19:00,559 --> 00:19:02,160
uh your sales department

557
00:19:02,160 --> 00:19:03,919
one for your it department that's how

558
00:19:03,919 --> 00:19:05,360
you should do it um

559
00:19:05,360 --> 00:19:06,320
particularly when you talk about like

560
00:19:06,320 --> 00:19:08,640
billing so you know who's using what

561
00:19:08,640 --> 00:19:09,919
resources and if there's different

562
00:19:09,919 --> 00:19:10,559
funding

563
00:19:10,559 --> 00:19:13,440
levels right you can manage it that way

564
00:19:13,440 --> 00:19:14,720
if you have a resource group which is

565
00:19:14,720 --> 00:19:17,120
just a collection of resources

566
00:19:17,120 --> 00:19:20,080
you have a resource a resource is any

567
00:19:20,080 --> 00:19:21,679
manageable item in azure

568
00:19:21,679 --> 00:19:23,120
includes virtual machines web apps

569
00:19:23,120 --> 00:19:24,559
storage key vaults anything you can

570
00:19:24,559 --> 00:19:25,120
manage

571
00:19:25,120 --> 00:19:27,360
which means that subscriptions and

572
00:19:27,360 --> 00:19:28,880
resource groups are also

573
00:19:28,880 --> 00:19:31,280
considered resources because you can

574
00:19:31,280 --> 00:19:33,200
manage those directly

575
00:19:33,200 --> 00:19:34,880
because they come from a what's called a

576
00:19:34,880 --> 00:19:36,559
resource provider

577
00:19:36,559 --> 00:19:39,120
so a resource provider is a service that

578
00:19:39,120 --> 00:19:40,799
provides a type of resource

579
00:19:40,799 --> 00:19:44,000
wow right so um for a storage account

580
00:19:44,000 --> 00:19:45,919
you would have microsoft dot storage

581
00:19:45,919 --> 00:19:47,600
for the resource provider for

582
00:19:47,600 --> 00:19:49,120
subscription you would have microsoft

583
00:19:49,120 --> 00:19:51,559
subscription um you have

584
00:19:51,559 --> 00:19:52,880
microsoft.compute

585
00:19:52,880 --> 00:19:55,440
for like virtual machines and other uh

586
00:19:55,440 --> 00:19:56,240
compute

587
00:19:56,240 --> 00:19:59,919
um resources that you can um provision

588
00:19:59,919 --> 00:20:03,440
within the portal and then finally we

589
00:20:03,440 --> 00:20:05,120
have this concept of role based access

590
00:20:05,120 --> 00:20:06,240
controls

591
00:20:06,240 --> 00:20:08,480
and role-based access controls are a set

592
00:20:08,480 --> 00:20:10,159
of permissions that a user may take on a

593
00:20:10,159 --> 00:20:11,840
resource

594
00:20:11,840 --> 00:20:13,919
the resource is defined in scope and

595
00:20:13,919 --> 00:20:16,799
also these are not the same as aed roles

596
00:20:16,799 --> 00:20:20,320
so keep in mind that aad and arm are

597
00:20:20,320 --> 00:20:22,080
are separate they're they're not dates

598
00:20:22,080 --> 00:20:24,320
they can you know correlate information

599
00:20:24,320 --> 00:20:25,280
but

600
00:20:25,280 --> 00:20:28,320
but their their identities and services

601
00:20:28,320 --> 00:20:28,640
are

602
00:20:28,640 --> 00:20:31,360
are separate right ad manages your

603
00:20:31,360 --> 00:20:32,400
identities

604
00:20:32,400 --> 00:20:36,080
while r manages your resources

605
00:20:36,960 --> 00:20:38,799
so here's a list of resource providers

606
00:20:38,799 --> 00:20:40,080
um i talked about

607
00:20:40,080 --> 00:20:43,520
this in the last slide really um

608
00:20:43,520 --> 00:20:45,120
and if you look at them there's there's

609
00:20:45,120 --> 00:20:46,960
one resource provider for

610
00:20:46,960 --> 00:20:48,960
almost every for literally every

611
00:20:48,960 --> 00:20:50,240
resource that you can

612
00:20:50,240 --> 00:20:52,159
have in azure sometimes you may see

613
00:20:52,159 --> 00:20:54,000
these service principles pop up

614
00:20:54,000 --> 00:20:57,760
um under your um in your aad

615
00:20:57,760 --> 00:20:59,200
and it's because when you provision a

616
00:20:59,200 --> 00:21:00,799
resource right

617
00:21:00,799 --> 00:21:04,240
azure needs to know azure needs to

618
00:21:04,240 --> 00:21:05,840
provide the service principle for that

619
00:21:05,840 --> 00:21:07,840
application so that it can provision

620
00:21:07,840 --> 00:21:10,000
those resources within your organization

621
00:21:10,000 --> 00:21:12,159
so before we talk about how applications

622
00:21:12,159 --> 00:21:13,840
have a service principle

623
00:21:13,840 --> 00:21:17,200
uh no represent uh service principle

624
00:21:17,200 --> 00:21:18,960
for representation in a local tenant

625
00:21:18,960 --> 00:21:20,240
that's what that is so

626
00:21:20,240 --> 00:21:22,480
you'll see these um around depending on

627
00:21:22,480 --> 00:21:23,760
what type of resources

628
00:21:23,760 --> 00:21:26,799
you have in your environment

629
00:21:27,280 --> 00:21:28,799
let's talk about the control plane

630
00:21:28,799 --> 00:21:30,799
versus the data plane is also very

631
00:21:30,799 --> 00:21:31,679
important

632
00:21:31,679 --> 00:21:34,559
um operations in an arm are divided into

633
00:21:34,559 --> 00:21:36,559
two categories one is control or

634
00:21:36,559 --> 00:21:39,919
management as you may hear it called and

635
00:21:39,919 --> 00:21:42,000
the other is the data plane so the

636
00:21:42,000 --> 00:21:43,200
control plane

637
00:21:43,200 --> 00:21:46,080
is for managing the resource within

638
00:21:46,080 --> 00:21:49,360
azure research manager or arm

639
00:21:49,360 --> 00:21:52,799
requests for these con for the control

640
00:21:52,799 --> 00:21:55,120
plane are sent to the resource provider

641
00:21:55,120 --> 00:21:57,679
right so microsoft.storage if i want to

642
00:21:57,679 --> 00:21:59,039
add a new

643
00:21:59,039 --> 00:22:01,440
storage account for example but the data

644
00:22:01,440 --> 00:22:03,679
point is is for managing the operations

645
00:22:03,679 --> 00:22:06,320
of the resource so if i can if i have

646
00:22:06,320 --> 00:22:07,440
something like

647
00:22:07,440 --> 00:22:09,840
a virtual machine i can create and

648
00:22:09,840 --> 00:22:11,039
delete a virtual machine

649
00:22:11,039 --> 00:22:12,400
on the control plane or the management

650
00:22:12,400 --> 00:22:14,159
plane but

651
00:22:14,159 --> 00:22:16,720
i have to rdp on the data plane if i can

652
00:22:16,720 --> 00:22:17,760
create a storage account

653
00:22:17,760 --> 00:22:19,360
on the control plane but if i want to

654
00:22:19,360 --> 00:22:20,720
read and write data to the storage

655
00:22:20,720 --> 00:22:21,919
account

656
00:22:21,919 --> 00:22:23,679
i need to have permissions on the data

657
00:22:23,679 --> 00:22:25,280
plan right

658
00:22:25,280 --> 00:22:27,440
it's a very important concept for

659
00:22:27,440 --> 00:22:28,640
understanding

660
00:22:28,640 --> 00:22:31,520
role-based access control because these

661
00:22:31,520 --> 00:22:33,440
are two different sets of permissions

662
00:22:33,440 --> 00:22:35,440
that can affect what is essentially the

663
00:22:35,440 --> 00:22:36,640
same resource

664
00:22:36,640 --> 00:22:39,039
and then um the instance of that

665
00:22:39,039 --> 00:22:41,840
resource

666
00:22:44,480 --> 00:22:46,440
so the road based access control is the

667
00:22:46,440 --> 00:22:48,480
authorization system that was built

668
00:22:48,480 --> 00:22:52,559
on top of arm that allows you to access

669
00:22:52,559 --> 00:22:54,080
or at least control or manage your

670
00:22:54,080 --> 00:22:56,480
access to resources

671
00:22:56,480 --> 00:22:57,840
and our back role is based on three

672
00:22:57,840 --> 00:23:00,080
parts you have the security principle

673
00:23:00,080 --> 00:23:02,400
which is an aed object so a user group a

674
00:23:02,400 --> 00:23:05,200
service principle manage identity etc

675
00:23:05,200 --> 00:23:07,360
you have a role definition which is the

676
00:23:07,360 --> 00:23:10,320
collection of permissions

677
00:23:10,320 --> 00:23:11,919
and then we have the scope that it

678
00:23:11,919 --> 00:23:14,480
applies to

679
00:23:16,080 --> 00:23:17,919
so you have again you have the the the

680
00:23:17,919 --> 00:23:19,679
object that you are giving

681
00:23:19,679 --> 00:23:21,200
uh the permissions to you have the

682
00:23:21,200 --> 00:23:22,640
permissions that you are giving to that

683
00:23:22,640 --> 00:23:23,039
object

684
00:23:23,039 --> 00:23:25,840
and then you have what scope that those

685
00:23:25,840 --> 00:23:29,600
permissions are going to be valid for

686
00:23:29,760 --> 00:23:31,679
so here are some general arbac rules

687
00:23:31,679 --> 00:23:33,039
you'll see you hear about your

688
00:23:33,039 --> 00:23:33,919
contributor

689
00:23:33,919 --> 00:23:36,320
owner and reader are three very common

690
00:23:36,320 --> 00:23:37,039
roles and

691
00:23:37,039 --> 00:23:39,919
pretty generic roles um contribute owner

692
00:23:39,919 --> 00:23:40,720
being

693
00:23:40,720 --> 00:23:42,799
as far as their resource goes uh one of

694
00:23:42,799 --> 00:23:44,880
the the most powerful

695
00:23:44,880 --> 00:23:48,159
uh not the most powerful but pretty high

696
00:23:48,159 --> 00:23:49,039
up there

697
00:23:49,039 --> 00:23:51,200
um on managing that resource because it

698
00:23:51,200 --> 00:23:53,279
gives you access to manage all of it

699
00:23:53,279 --> 00:23:55,360
and then you have contributor which is a

700
00:23:55,360 --> 00:23:56,640
next level down

701
00:23:56,640 --> 00:23:58,320
because it grants you access to manage

702
00:23:58,320 --> 00:23:59,919
the resources but it doesn't allow you

703
00:23:59,919 --> 00:24:02,480
to add additional rbac roles and then

704
00:24:02,480 --> 00:24:03,200
you have reader

705
00:24:03,200 --> 00:24:05,440
right um reader just allows you to view

706
00:24:05,440 --> 00:24:06,640
the resources but you can't make any

707
00:24:06,640 --> 00:24:08,640
changes at all

708
00:24:08,640 --> 00:24:09,679
right and then you also have the

709
00:24:09,679 --> 00:24:12,080
specific are back roles so in this list

710
00:24:12,080 --> 00:24:13,120
right here we have

711
00:24:13,120 --> 00:24:16,559
the ability to uh you have contributor

712
00:24:16,559 --> 00:24:18,240
on an smb share

713
00:24:18,240 --> 00:24:19,679
which is in storage and it's very

714
00:24:19,679 --> 00:24:21,360
specific right this role

715
00:24:21,360 --> 00:24:23,600
gives you the ability only the ability

716
00:24:23,600 --> 00:24:24,559
to

717
00:24:24,559 --> 00:24:26,799
uh read write and delete access on files

718
00:24:26,799 --> 00:24:29,440
and directories and add your file shares

719
00:24:29,440 --> 00:24:31,840
like that's very specific and so when

720
00:24:31,840 --> 00:24:32,720
you start

721
00:24:32,720 --> 00:24:34,640
giving out your permissions in azure 80

722
00:24:34,640 --> 00:24:36,240
you want to make sure that you're

723
00:24:36,240 --> 00:24:37,679
trying to give that least privileged

724
00:24:37,679 --> 00:24:39,440
concept right you don't need to give

725
00:24:39,440 --> 00:24:40,240
someone

726
00:24:40,240 --> 00:24:43,279
a contributor over the entire resource

727
00:24:43,279 --> 00:24:43,840
group

728
00:24:43,840 --> 00:24:46,320
or the entire resource itself you can

729
00:24:46,320 --> 00:24:47,840
give a very specific part of that

730
00:24:47,840 --> 00:24:48,400
resource

731
00:24:48,400 --> 00:24:50,320
you can give access to a very specific

732
00:24:50,320 --> 00:24:53,600
part of that resource if you wanted to

733
00:24:55,600 --> 00:24:58,640
so role definitions affect

734
00:24:58,640 --> 00:25:00,400
both management and data planes and the

735
00:25:00,400 --> 00:25:02,480
way it's organized is that here is a

736
00:25:02,480 --> 00:25:04,880
role called the state of blob storage

737
00:25:04,880 --> 00:25:06,400
blob data reader

738
00:25:06,400 --> 00:25:08,320
right you have these management actions

739
00:25:08,320 --> 00:25:09,520
and you have these not

740
00:25:09,520 --> 00:25:12,320
actions so on the management plane right

741
00:25:12,320 --> 00:25:14,240
i can read the containers that are in a

742
00:25:14,240 --> 00:25:15,600
storage account

743
00:25:15,600 --> 00:25:18,720
um i can also uh generate keys

744
00:25:18,720 --> 00:25:21,919
um but focusing right now on the uh this

745
00:25:21,919 --> 00:25:24,000
being able to read the container and

746
00:25:24,000 --> 00:25:24,960
then you have

747
00:25:24,960 --> 00:25:27,120
on the data plane the ability to read

748
00:25:27,120 --> 00:25:28,480
the blobs within the

749
00:25:28,480 --> 00:25:30,640
uh the container so these are very two

750
00:25:30,640 --> 00:25:31,840
different permissions you can have

751
00:25:31,840 --> 00:25:32,880
access to

752
00:25:32,880 --> 00:25:34,640
the the storage account itself but if

753
00:25:34,640 --> 00:25:36,000
you don't have permissions to read the

754
00:25:36,000 --> 00:25:36,799
blobs

755
00:25:36,799 --> 00:25:40,159
then you won't be able to read the blobs

756
00:25:40,159 --> 00:25:42,480
um again the management access is not

757
00:25:42,480 --> 00:25:44,159
adhering to that data for that specific

758
00:25:44,159 --> 00:25:47,039
reason i just mentioned

759
00:25:48,080 --> 00:25:49,360
i'm actually getting ahead of myself so

760
00:25:49,360 --> 00:25:51,120
yeah the

761
00:25:51,120 --> 00:25:52,559
the the permissions to read the

762
00:25:52,559 --> 00:25:54,240
container in a storage account does not

763
00:25:54,240 --> 00:25:55,760
give you permissions to read the blobs

764
00:25:55,760 --> 00:25:56,880
um

765
00:25:56,880 --> 00:26:00,400
the way not actions work is that it's

766
00:26:00,400 --> 00:26:02,799
it it you get a list of actions that you

767
00:26:02,799 --> 00:26:03,600
can do

768
00:26:03,600 --> 00:26:06,000
and sometimes these actions will be have

769
00:26:06,000 --> 00:26:07,760
like an asterisk for example

770
00:26:07,760 --> 00:26:10,559
so um maybe instead of microsoft dot

771
00:26:10,559 --> 00:26:11,120
storage

772
00:26:11,120 --> 00:26:12,880
storage accounts i have microsoft

773
00:26:12,880 --> 00:26:14,640
storage slash asterisk

774
00:26:14,640 --> 00:26:16,159
and what that means is that all the

775
00:26:16,159 --> 00:26:17,840
resources under

776
00:26:17,840 --> 00:26:19,760
microsoft that storage resource provider

777
00:26:19,760 --> 00:26:22,559
i have uh this level of access to

778
00:26:22,559 --> 00:26:24,960
um what the way not actions works is

779
00:26:24,960 --> 00:26:26,400
that it subtracts

780
00:26:26,400 --> 00:26:29,360
the roles that you have in your actions

781
00:26:29,360 --> 00:26:30,640
and it says

782
00:26:30,640 --> 00:26:33,279
well if that was an asterisk maybe i

783
00:26:33,279 --> 00:26:35,120
don't want you to read storage accounts

784
00:26:35,120 --> 00:26:38,720
so you can put um a not action

785
00:26:38,720 --> 00:26:41,279
in that field um but also but not

786
00:26:41,279 --> 00:26:43,520
actions i learned just recently a couple

787
00:26:43,520 --> 00:26:44,159
days ago

788
00:26:44,159 --> 00:26:46,960
was that not actions are not uh don't

789
00:26:46,960 --> 00:26:48,799
have any precedence over

790
00:26:48,799 --> 00:26:52,320
uh the actions so if you have

791
00:26:52,320 --> 00:26:55,600
um an action that is

792
00:26:55,600 --> 00:26:58,000
that is uh covered and then you have

793
00:26:58,000 --> 00:27:00,080
that not action

794
00:27:00,080 --> 00:27:01,919
and they both reference the same

795
00:27:01,919 --> 00:27:03,679
permission you will have

796
00:27:03,679 --> 00:27:07,520
you will have access uh to that

797
00:27:07,520 --> 00:27:09,360
permission simply because it's in the

798
00:27:09,360 --> 00:27:11,600
actions so not actions is not a

799
00:27:11,600 --> 00:27:14,640
uh it is not like a higher priority it's

800
00:27:14,640 --> 00:27:16,880
just an easier way to manage

801
00:27:16,880 --> 00:27:20,240
what your permissions are

802
00:27:20,240 --> 00:27:22,320
yeah that's a lot uh i had to read up on

803
00:27:22,320 --> 00:27:23,440
that a couple days ago and

804
00:27:23,440 --> 00:27:26,399
it was i did not know that so i learned

805
00:27:26,399 --> 00:27:27,120
something new

806
00:27:27,120 --> 00:27:30,159
someone on the actual red team right um

807
00:27:30,159 --> 00:27:32,799
so here the uh the actions permissions

808
00:27:32,799 --> 00:27:34,320
and operations

809
00:27:34,320 --> 00:27:38,240
um you you have these list of operations

810
00:27:38,240 --> 00:27:39,039
that you can do

811
00:27:39,039 --> 00:27:41,520
on the left so maybe get blob metadata

812
00:27:41,520 --> 00:27:42,240
and here are the

813
00:27:42,240 --> 00:27:45,600
the permissions that are required to

814
00:27:45,600 --> 00:27:46,960
perform that action

815
00:27:46,960 --> 00:27:49,840
so if i want to snapshot a blob which

816
00:27:49,840 --> 00:27:50,399
means just

817
00:27:50,399 --> 00:27:52,159
sort of like a version history thing and

818
00:27:52,159 --> 00:27:53,520
i need to have the ability

819
00:27:53,520 --> 00:27:55,840
to write blobs or i need to have the

820
00:27:55,840 --> 00:27:56,799
ability to add

821
00:27:56,799 --> 00:27:59,840
slash action on blobs and this can get

822
00:27:59,840 --> 00:28:04,480
um pretty uh confusing at times

823
00:28:04,480 --> 00:28:09,520
because sometimes actions don't always

824
00:28:09,520 --> 00:28:11,039
don't clearly represent um what

825
00:28:11,039 --> 00:28:13,200
permissions that they have

826
00:28:13,200 --> 00:28:15,279
so this happened a few days ago and i

827
00:28:15,279 --> 00:28:16,559
decided to put this one in

828
00:28:16,559 --> 00:28:18,399
but someone asked me on slack they were

829
00:28:18,399 --> 00:28:19,919
like hey i have this

830
00:28:19,919 --> 00:28:22,080
uh permission for storage queue data

831
00:28:22,080 --> 00:28:23,200
reader i'm trying to

832
00:28:23,200 --> 00:28:25,440
read the messages that are in my queue

833
00:28:25,440 --> 00:28:26,960
but it won't work

834
00:28:26,960 --> 00:28:27,919
and i thought that was pretty

835
00:28:27,919 --> 00:28:31,120
interesting so i looked into it and

836
00:28:31,120 --> 00:28:34,320
the permissions that are that that it

837
00:28:34,320 --> 00:28:34,880
gives you

838
00:28:34,880 --> 00:28:36,640
um that this role gives you is the

839
00:28:36,640 --> 00:28:38,559
ability to read messages

840
00:28:38,559 --> 00:28:41,120
right so you can peek or retrieve it

841
00:28:41,120 --> 00:28:42,559
says retrieve but you can pick one of

842
00:28:42,559 --> 00:28:44,960
the messages from a queue

843
00:28:44,960 --> 00:28:46,720
but the way cues work is that when you

844
00:28:46,720 --> 00:28:48,960
read a messages it also pops the message

845
00:28:48,960 --> 00:28:49,600
off the cue

846
00:28:49,600 --> 00:28:51,360
right just like any other cue which

847
00:28:51,360 --> 00:28:52,799
means that

848
00:28:52,799 --> 00:28:55,120
if you want to get a message you also

849
00:28:55,120 --> 00:28:56,720
need to have the ability to delete

850
00:28:56,720 --> 00:28:59,440
that message from the queue so it's two

851
00:28:59,440 --> 00:29:01,279
explicit permissions one for reading

852
00:29:01,279 --> 00:29:04,080
and one for deleting if you don't have

853
00:29:04,080 --> 00:29:05,360
the delete permission

854
00:29:05,360 --> 00:29:07,520
then you can't actually get the message

855
00:29:07,520 --> 00:29:08,880
you can just look at the message and

856
00:29:08,880 --> 00:29:11,039
leave it there

857
00:29:11,039 --> 00:29:14,240
so um here are the actions for the

858
00:29:14,240 --> 00:29:16,159
the uh the storage queue data reader

859
00:29:16,159 --> 00:29:17,840
which is what this person tried to apply

860
00:29:17,840 --> 00:29:19,039
to the user

861
00:29:19,039 --> 00:29:21,120
but what they really wanted was a

862
00:29:21,120 --> 00:29:23,360
storage queue data message processor

863
00:29:23,360 --> 00:29:25,840
which gives you the read permission but

864
00:29:25,840 --> 00:29:26,799
it also gives you

865
00:29:26,799 --> 00:29:28,559
the process slash action permission

866
00:29:28,559 --> 00:29:29,840
which satisfies

867
00:29:29,840 --> 00:29:31,840
the uh requirements in order to get

868
00:29:31,840 --> 00:29:33,440
messages so

869
00:29:33,440 --> 00:29:36,480
um it's it's a matter of understanding

870
00:29:36,480 --> 00:29:38,159
what the permissions are that you're

871
00:29:38,159 --> 00:29:40,320
what action you're trying to take on the

872
00:29:40,320 --> 00:29:41,520
type of resource that you're trying to

873
00:29:41,520 --> 00:29:42,320
take

874
00:29:42,320 --> 00:29:44,640
uh getting a message uh getting a cue

875
00:29:44,640 --> 00:29:46,080
message just sounds like you're reading

876
00:29:46,080 --> 00:29:46,960
it but really you

877
00:29:46,960 --> 00:29:48,640
also have to delete it so you need that

878
00:29:48,640 --> 00:29:51,200
delete permission as well

879
00:29:51,200 --> 00:29:53,840
i'm going to speed up here because i'm

880
00:29:53,840 --> 00:29:55,679
so here's an example of applying

881
00:29:55,679 --> 00:29:59,760
an r back roll to uh

882
00:29:59,840 --> 00:30:02,880
to a an object right or just applying or

883
00:30:02,880 --> 00:30:03,200
back

884
00:30:03,200 --> 00:30:07,200
excuse me uh a role assignment here's a

885
00:30:07,200 --> 00:30:09,760
example of a role assignment wow um so

886
00:30:09,760 --> 00:30:11,200
you have these 80 objects that are part

887
00:30:11,200 --> 00:30:13,200
of the marketing group

888
00:30:13,200 --> 00:30:14,799
and the marketing group is assigned

889
00:30:14,799 --> 00:30:16,320
contributor access

890
00:30:16,320 --> 00:30:19,600
to a scope which is the pharma sales

891
00:30:19,600 --> 00:30:22,320
resource group so the marketing group

892
00:30:22,320 --> 00:30:23,440
now has

893
00:30:23,440 --> 00:30:25,279
full access to all resources in the

894
00:30:25,279 --> 00:30:26,720
pharmaceutics resource group

895
00:30:26,720 --> 00:30:29,440
but they can't assign additional our

896
00:30:29,440 --> 00:30:33,360
back roles to that group to other people

897
00:30:34,799 --> 00:30:36,559
let's talk about interacting with aed

898
00:30:36,559 --> 00:30:38,880
and arm

899
00:30:38,880 --> 00:30:40,320
the most common way they should do it is

900
00:30:40,320 --> 00:30:42,200
through the portal you log into

901
00:30:42,200 --> 00:30:44,000
portal.azure.com

902
00:30:44,000 --> 00:30:45,919
um depending on the cloud environment

903
00:30:45,919 --> 00:30:47,279
that you're in if you

904
00:30:47,279 --> 00:30:49,279
are working in the us government world

905
00:30:49,279 --> 00:30:50,960
it might be ported on azure that us

906
00:30:50,960 --> 00:30:53,200
for germany china they all have their

907
00:30:53,200 --> 00:30:55,120
different urls that they use to access

908
00:30:55,120 --> 00:30:56,240
the portal but it all

909
00:30:56,240 --> 00:30:58,480
essentially looks the same um microsoft

910
00:30:58,480 --> 00:30:59,840
tries to aim for

911
00:30:59,840 --> 00:31:03,679
um parity against all cloud environments

912
00:31:03,679 --> 00:31:04,240
so

913
00:31:04,240 --> 00:31:06,080
you'll find that it generally looks the

914
00:31:06,080 --> 00:31:08,320
same

915
00:31:08,320 --> 00:31:10,320
you have the azure cli um it's written

916
00:31:10,320 --> 00:31:12,640
in python which means that

917
00:31:12,640 --> 00:31:16,000
when you install azure cli you're also

918
00:31:16,000 --> 00:31:18,240
installing python on your system

919
00:31:18,240 --> 00:31:20,399
um that's just a note for anybody who

920
00:31:20,399 --> 00:31:22,399
does like any sort of risk assessment or

921
00:31:22,399 --> 00:31:23,519
whatever

922
00:31:23,519 --> 00:31:25,039
because it's written in python there's

923
00:31:25,039 --> 00:31:26,640
actually an instance of python that gets

924
00:31:26,640 --> 00:31:28,240
installed with the azure cli

925
00:31:28,240 --> 00:31:31,440
so if you're worried about like um uh

926
00:31:31,440 --> 00:31:33,039
being able to know what all your users

927
00:31:33,039 --> 00:31:34,880
are doing because like you know

928
00:31:34,880 --> 00:31:36,399
you have like script block logging on

929
00:31:36,399 --> 00:31:37,679
powershell or something like that and

930
00:31:37,679 --> 00:31:39,039
you're trying to lock down a host

931
00:31:39,039 --> 00:31:41,039
um the address cli is actually something

932
00:31:41,039 --> 00:31:42,320
you may want to look

933
00:31:42,320 --> 00:31:45,120
at to see if it's installed because it

934
00:31:45,120 --> 00:31:45,679
doesn't really

935
00:31:45,679 --> 00:31:48,240
explicitly explain that it's installing

936
00:31:48,240 --> 00:31:49,679
python but

937
00:31:49,679 --> 00:31:52,159
uh it does and the way you would log in

938
00:31:52,159 --> 00:31:53,360
with the address cli

939
00:31:53,360 --> 00:31:56,399
is with the azlogin command

940
00:31:56,399 --> 00:31:58,880
when you do this and you log in your

941
00:31:58,880 --> 00:32:00,080
access tokens

942
00:32:00,080 --> 00:32:03,440
that are used to talk to these endpoints

943
00:32:03,440 --> 00:32:06,960
uh they're just uh they're just jwt

944
00:32:06,960 --> 00:32:11,600
that uh i forgot what jwt stands for

945
00:32:11,600 --> 00:32:14,399
but those tokens yeah um they get saved

946
00:32:14,399 --> 00:32:15,120
in your

947
00:32:15,120 --> 00:32:18,559
azure folder under accesstokens.json

948
00:32:18,559 --> 00:32:21,600
um so here's an example right i can list

949
00:32:21,600 --> 00:32:22,880
the key vaults

950
00:32:22,880 --> 00:32:26,720
in um this the the subscription that

951
00:32:26,720 --> 00:32:28,559
i've logged into

952
00:32:28,559 --> 00:32:31,760
um i can show i can interact with

953
00:32:31,760 --> 00:32:33,919
the azure active directory by listing

954
00:32:33,919 --> 00:32:35,600
the user so here i'm listing kelly's

955
00:32:35,600 --> 00:32:36,559
antenna

956
00:32:36,559 --> 00:32:38,559
and i can see the properties that are

957
00:32:38,559 --> 00:32:41,679
attached to that user

958
00:32:41,679 --> 00:32:43,760
powershell there's a lot of powershell

959
00:32:43,760 --> 00:32:44,960
modules uh

960
00:32:44,960 --> 00:32:48,640
for azure az powershell is the newest

961
00:32:48,640 --> 00:32:50,159
version for interacting with azure this

962
00:32:50,159 --> 00:32:52,320
is the one you should probably be using

963
00:32:52,320 --> 00:32:57,360
um if you're not you should try to

964
00:32:57,360 --> 00:33:00,000
get there um it can't exist with the

965
00:33:00,000 --> 00:33:01,760
azure rm module

966
00:33:01,760 --> 00:33:04,640
um and the way you log in is with

967
00:33:04,640 --> 00:33:06,000
connect.az account

968
00:33:06,000 --> 00:33:09,120
the azure rn module is the older version

969
00:33:09,120 --> 00:33:11,200
of the az powershell module

970
00:33:11,200 --> 00:33:13,919
for interacting with azure um they count

971
00:33:13,919 --> 00:33:14,880
the

972
00:33:14,880 --> 00:33:17,679
the uh the module names all have like

973
00:33:17,679 --> 00:33:19,679
azure rm in them the same way that the

974
00:33:19,679 --> 00:33:20,799
az powershell

975
00:33:20,799 --> 00:33:23,440
accounts have connect dash az something

976
00:33:23,440 --> 00:33:24,559
or whatever

977
00:33:24,559 --> 00:33:26,399
um it but it can't exist with the azp

978
00:33:26,399 --> 00:33:28,080
powershell module so you may have some

979
00:33:28,080 --> 00:33:29,840
older scripts that use

980
00:33:29,840 --> 00:33:32,320
azure rm uh you may want to upgrade

981
00:33:32,320 --> 00:33:32,960
those

982
00:33:32,960 --> 00:33:36,000
to ac powershell

983
00:33:36,000 --> 00:33:39,200
then you have the azure ad module

984
00:33:39,200 --> 00:33:40,880
which is for interacting with azure

985
00:33:40,880 --> 00:33:42,640
active directory um

986
00:33:42,640 --> 00:33:44,240
a the current versions work with

987
00:33:44,240 --> 00:33:46,399
microsoft graph this is

988
00:33:46,399 --> 00:33:48,399
fairly recent because previously uh it

989
00:33:48,399 --> 00:33:50,080
did not

990
00:33:50,080 --> 00:33:53,200
and it also works in powershell core uh

991
00:33:53,200 --> 00:33:55,440
before azure ad was working with uh

992
00:33:55,440 --> 00:33:56,480
microsoft graph

993
00:33:56,480 --> 00:33:59,600
there was another one called ms online

994
00:33:59,600 --> 00:34:02,159
so if you see this um i i think i saw

995
00:34:02,159 --> 00:34:03,679
like some uh some blog posts

996
00:34:03,679 --> 00:34:05,200
recently this year that was using ms

997
00:34:05,200 --> 00:34:07,760
online and i

998
00:34:07,760 --> 00:34:10,800
i was like okay sure um but you can use

999
00:34:10,800 --> 00:34:11,839
the azure ad

1000
00:34:11,839 --> 00:34:15,520
um one instead and it also does not work

1001
00:34:15,520 --> 00:34:16,800
in powershell course if you're running

1002
00:34:16,800 --> 00:34:17,839
it from like linux or something like

1003
00:34:17,839 --> 00:34:19,760
that or wsl

1004
00:34:19,760 --> 00:34:21,679
you won't have any luck with that and

1005
00:34:21,679 --> 00:34:23,918
then there's the azure powershell module

1006
00:34:23,918 --> 00:34:25,839
which sounds like what you may want to

1007
00:34:25,839 --> 00:34:27,119
interact with azure

1008
00:34:27,119 --> 00:34:29,839
but it's not uh unless you have classic

1009
00:34:29,839 --> 00:34:32,399
resources in your address

1010
00:34:32,399 --> 00:34:34,639
tenant right it's explicitly used for

1011
00:34:34,639 --> 00:34:35,760
that um

1012
00:34:35,760 --> 00:34:37,040
some organizations still have those

1013
00:34:37,040 --> 00:34:38,560
types of resources or they have those

1014
00:34:38,560 --> 00:34:40,320
classic management certificates that

1015
00:34:40,320 --> 00:34:40,800
they

1016
00:34:40,800 --> 00:34:43,839
use to manage um their azure what was

1017
00:34:43,839 --> 00:34:45,199
azure service

1018
00:34:45,199 --> 00:34:48,000
manager so you want to use the azure

1019
00:34:48,000 --> 00:34:50,000
powershell module for that

1020
00:34:50,000 --> 00:34:52,639
so again there are five of them but the

1021
00:34:52,639 --> 00:34:54,480
the two that you really want are a z

1022
00:34:54,480 --> 00:34:55,440
powershell

1023
00:34:55,440 --> 00:34:58,640
and azure ad if you're using um if you

1024
00:34:58,640 --> 00:35:00,720
decide to interact with powershell

1025
00:35:00,720 --> 00:35:03,359
then you have the azure sdks um they

1026
00:35:03,359 --> 00:35:03,839
come in

1027
00:35:03,839 --> 00:35:05,359
a bunch of different languages they're

1028
00:35:05,359 --> 00:35:07,440
broken up into management libraries and

1029
00:35:07,440 --> 00:35:09,040
the data point libraries so you can

1030
00:35:09,040 --> 00:35:10,640
interact with the management plan or the

1031
00:35:10,640 --> 00:35:11,440
data plane

1032
00:35:11,440 --> 00:35:13,680
as was described before earlier in the

1033
00:35:13,680 --> 00:35:15,359
talk

1034
00:35:15,359 --> 00:35:16,960
um there's been a lot of refactoring for

1035
00:35:16,960 --> 00:35:18,880
these libraries particularly for the

1036
00:35:18,880 --> 00:35:20,400
python libraries they've changed a lot

1037
00:35:20,400 --> 00:35:20,880
this year

1038
00:35:20,880 --> 00:35:23,839
they've gotten a lot better um they were

1039
00:35:23,839 --> 00:35:25,040
kind of messy before

1040
00:35:25,040 --> 00:35:26,960
but um everything is definitely a lot

1041
00:35:26,960 --> 00:35:28,240
more streamlined now

1042
00:35:28,240 --> 00:35:30,240
so but if you're updating your libraries

1043
00:35:30,240 --> 00:35:31,280
from an older tool

1044
00:35:31,280 --> 00:35:33,520
you should definitely test before you

1045
00:35:33,520 --> 00:35:35,359
update um

1046
00:35:35,359 --> 00:35:37,119
and implement a new library because a

1047
00:35:37,119 --> 00:35:38,800
lot of things have changed particularly

1048
00:35:38,800 --> 00:35:39,520
around

1049
00:35:39,520 --> 00:35:40,800
managing different identities for

1050
00:35:40,800 --> 00:35:42,960
logging in with these sdks

1051
00:35:42,960 --> 00:35:45,000
you can check that out at

1052
00:35:45,000 --> 00:35:46,320
azure.github.io

1053
00:35:46,320 --> 00:35:48,800
azure sdk and you'll see all the

1054
00:35:48,800 --> 00:35:50,480
languages

1055
00:35:50,480 --> 00:35:53,520
and you'll see the

1056
00:35:53,520 --> 00:35:55,440
the client and management libraries that

1057
00:35:55,440 --> 00:35:58,560
come for that language

1058
00:35:58,560 --> 00:36:00,640
and then if you really want to you can

1059
00:36:00,640 --> 00:36:02,400
use the rest apis

1060
00:36:02,400 --> 00:36:03,760
there's a lot of those i'm not going to

1061
00:36:03,760 --> 00:36:05,280
go into them but the documentation is

1062
00:36:05,280 --> 00:36:06,240
there

1063
00:36:06,240 --> 00:36:10,160
um it allows you to talk to any resource

1064
00:36:10,160 --> 00:36:13,280
or or a graph or or whatever

1065
00:36:13,280 --> 00:36:16,400
um you can just look through those the

1066
00:36:16,400 --> 00:36:17,280
documentation

1067
00:36:17,280 --> 00:36:19,680
um if you're really curious about using

1068
00:36:19,680 --> 00:36:22,640
these things directly

1069
00:36:22,640 --> 00:36:26,000
so let's talk about storm spotter

1070
00:36:26,000 --> 00:36:29,200
storm swatter is a tool that uh

1071
00:36:29,200 --> 00:36:31,200
the azure red team has presented this

1072
00:36:31,200 --> 00:36:33,119
year uh publicly

1073
00:36:33,119 --> 00:36:35,200
and it is used to create an attack graph

1074
00:36:35,200 --> 00:36:36,640
of azure ad

1075
00:36:36,640 --> 00:36:38,320
and azure resource manager we use the

1076
00:36:38,320 --> 00:36:39,920
term attack graph because we are a red

1077
00:36:39,920 --> 00:36:40,400
team

1078
00:36:40,400 --> 00:36:43,599
but realistically um you can use it to

1079
00:36:43,599 --> 00:36:44,320
just sort of

1080
00:36:44,320 --> 00:36:48,560
look at and audit your own uh

1081
00:36:48,560 --> 00:36:51,680
uh the tenant

1082
00:36:51,680 --> 00:36:54,000
based on the types of resources that you

1083
00:36:54,000 --> 00:36:55,200
have

1084
00:36:55,200 --> 00:36:56,880
it's backed by neo4j which means that

1085
00:36:56,880 --> 00:36:58,640
we'll be using some cipher

1086
00:36:58,640 --> 00:37:01,440
query language it's written in primarily

1087
00:37:01,440 --> 00:37:02,400
in python

1088
00:37:02,400 --> 00:37:05,040
for the back end and the front end was

1089
00:37:05,040 --> 00:37:07,359
written in view

1090
00:37:07,359 --> 00:37:10,240
look i know the software engineer in my

1091
00:37:10,240 --> 00:37:11,119
title

1092
00:37:11,119 --> 00:37:13,680
but i am trash when it comes to a lot of

1093
00:37:13,680 --> 00:37:15,040
actual developing

1094
00:37:15,040 --> 00:37:18,720
like professionally right so um

1095
00:37:18,720 --> 00:37:20,160
if you happen to look at storm spotter

1096
00:37:20,160 --> 00:37:22,160
and you see how messy this view just

1097
00:37:22,160 --> 00:37:22,640
running

1098
00:37:22,640 --> 00:37:25,760
is whoops all right so it enables red

1099
00:37:25,760 --> 00:37:27,359
teams and pen testers to visualize the

1100
00:37:27,359 --> 00:37:28,640
attack surface

1101
00:37:28,640 --> 00:37:31,440
and pivot opportunities within a tank

1102
00:37:31,440 --> 00:37:33,119
and i mentioned again it can be used by

1103
00:37:33,119 --> 00:37:35,200
defenders to audit themselves one thing

1104
00:37:35,200 --> 00:37:36,880
to note though this is not an official

1105
00:37:36,880 --> 00:37:38,079
microsoft project

1106
00:37:38,079 --> 00:37:39,599
it's just a tool that we wrote as a red

1107
00:37:39,599 --> 00:37:41,680
team uh when we released this i saw

1108
00:37:41,680 --> 00:37:43,599
articles come out but like

1109
00:37:43,599 --> 00:37:45,760
microsoft releases azure storm spotter

1110
00:37:45,760 --> 00:37:47,119
and i'm kind of like

1111
00:37:47,119 --> 00:37:48,480
there's no azure in the name i guess

1112
00:37:48,480 --> 00:37:50,079
it's like a whole like legality thing

1113
00:37:50,079 --> 00:37:51,680
that comes with putting azure

1114
00:37:51,680 --> 00:37:52,880
in the name but it's just called storm

1115
00:37:52,880 --> 00:37:55,520
spotter all right and it's still in beta

1116
00:37:55,520 --> 00:37:55,920
so

1117
00:37:55,920 --> 00:38:00,000
um it works but it does not work as well

1118
00:38:00,000 --> 00:38:02,960
as it could be there's still a long way

1119
00:38:02,960 --> 00:38:03,760
to go

1120
00:38:03,760 --> 00:38:07,280
for uh getting it

1121
00:38:07,839 --> 00:38:11,119
on point so why does it exist so

1122
00:38:11,119 --> 00:38:12,800
we want to use it to understand the

1123
00:38:12,800 --> 00:38:14,880
configuration of

1124
00:38:14,880 --> 00:38:19,280
the environment um understanding

1125
00:38:19,280 --> 00:38:22,480
that should be effects not effect wow um

1126
00:38:22,480 --> 00:38:26,079
grammar um so

1127
00:38:26,400 --> 00:38:29,520
no actually never mind never mind

1128
00:38:29,520 --> 00:38:32,079
um whoops so um yeah you want to

1129
00:38:32,079 --> 00:38:32,720
understand

1130
00:38:32,720 --> 00:38:35,359
uh the security of the environment and

1131
00:38:35,359 --> 00:38:37,040
relationships are easy to understand

1132
00:38:37,040 --> 00:38:38,000
when they're visualized

1133
00:38:38,000 --> 00:38:39,520
right we have tools like bloodhound

1134
00:38:39,520 --> 00:38:41,440
which are used for active directory

1135
00:38:41,440 --> 00:38:44,400
um enumeration that have been proven to

1136
00:38:44,400 --> 00:38:46,640
work right it gives everyone a better

1137
00:38:46,640 --> 00:38:47,359
display

1138
00:38:47,359 --> 00:38:50,560
of how these uh how relationships work

1139
00:38:50,560 --> 00:38:51,200
within

1140
00:38:51,200 --> 00:38:52,560
active directory so we want to provide

1141
00:38:52,560 --> 00:38:55,119
that sort of similar concept within

1142
00:38:55,119 --> 00:38:59,520
azure for aad and arm

1143
00:38:59,680 --> 00:39:02,240
so would you rather look at this text

1144
00:39:02,240 --> 00:39:02,800
output

1145
00:39:02,800 --> 00:39:06,079
right if i want to see the owner of a

1146
00:39:06,079 --> 00:39:07,440
service principal

1147
00:39:07,440 --> 00:39:09,920
right who happens to be kelly santana

1148
00:39:09,920 --> 00:39:11,920
would you rather look at this output

1149
00:39:11,920 --> 00:39:13,359
or would you rather look at this nice

1150
00:39:13,359 --> 00:39:15,440
graph that says that

1151
00:39:15,440 --> 00:39:18,480
kelly santana owns this web application

1152
00:39:18,480 --> 00:39:21,520
our aed application and

1153
00:39:21,520 --> 00:39:23,920
this application is represented by the

1154
00:39:23,920 --> 00:39:24,720
sales

1155
00:39:24,720 --> 00:39:28,160
ad spn within the environment personally

1156
00:39:28,160 --> 00:39:30,480
i know i'd rather look at the second

1157
00:39:30,480 --> 00:39:32,480
so i'm going to demonstrate that real

1158
00:39:32,480 --> 00:39:34,160
quick

1159
00:39:34,160 --> 00:39:35,440
um the requirements for using storm

1160
00:39:35,440 --> 00:39:37,359
spotter though for aed

1161
00:39:37,359 --> 00:39:38,880
you must have read access to either

1162
00:39:38,880 --> 00:39:41,200
azure ad

1163
00:39:41,200 --> 00:39:43,599
or microsoft graph so the reason why

1164
00:39:43,599 --> 00:39:44,800
azure id

1165
00:39:44,800 --> 00:39:47,040
is listed here is legacy is because it's

1166
00:39:47,040 --> 00:39:48,640
considered to be a legacy

1167
00:39:48,640 --> 00:39:50,400
permission right azure ad is still the

1168
00:39:50,400 --> 00:39:52,640
name of of of the uh

1169
00:39:52,640 --> 00:39:56,240
the service but the permission itself

1170
00:39:56,240 --> 00:39:58,800
is considered legacy because it falls

1171
00:39:58,800 --> 00:40:00,720
under graph.windows.net

1172
00:40:00,720 --> 00:40:02,560
and microsoft is trying to move everyone

1173
00:40:02,560 --> 00:40:05,280
to graph.microsoft.com however

1174
00:40:05,280 --> 00:40:08,160
for some spotter purposes we try to

1175
00:40:08,160 --> 00:40:08,800
access

1176
00:40:08,800 --> 00:40:12,079
azure ad graph.windows.net first

1177
00:40:12,079 --> 00:40:13,040
because there's a little more

1178
00:40:13,040 --> 00:40:16,000
information in there that hasn't

1179
00:40:16,000 --> 00:40:18,240
yet been filled into ms graph but

1180
00:40:18,240 --> 00:40:19,040
eventually

1181
00:40:19,040 --> 00:40:21,680
um graph that would design it i think

1182
00:40:21,680 --> 00:40:23,520
may go away i'm not sure

1183
00:40:23,520 --> 00:40:25,599
but um they're definitely trying to move

1184
00:40:25,599 --> 00:40:27,440
everyone into graph.microsoft.com

1185
00:40:27,440 --> 00:40:29,440
i think back in july they stopped they

1186
00:40:29,440 --> 00:40:30,720
said that they're no longer going to add

1187
00:40:30,720 --> 00:40:32,160
any new features

1188
00:40:32,160 --> 00:40:33,839
and are really pushing people towards

1189
00:40:33,839 --> 00:40:36,160
the new service

1190
00:40:36,160 --> 00:40:38,240
for azure resource manager you must have

1191
00:40:38,240 --> 00:40:39,839
reader access to at least a subscription

1192
00:40:39,839 --> 00:40:40,400
level

1193
00:40:40,400 --> 00:40:42,079
and that's because enumeration of the

1194
00:40:42,079 --> 00:40:44,000
resources happens at the subscription

1195
00:40:44,000 --> 00:40:44,480
level

1196
00:40:44,480 --> 00:40:46,480
based on the way that ids are structured

1197
00:40:46,480 --> 00:40:47,760
um

1198
00:40:47,760 --> 00:40:49,040
i didn't talk about this but the way

1199
00:40:49,040 --> 00:40:50,800
that um

1200
00:40:50,800 --> 00:40:52,319
i'll show it to you in a bit so the way

1201
00:40:52,319 --> 00:40:54,720
that that uh azure research manager ids

1202
00:40:54,720 --> 00:40:56,480
for a resource is structured it's

1203
00:40:56,480 --> 00:40:58,560
usually like subscription

1204
00:40:58,560 --> 00:41:01,359
slash the subscription id slash resource

1205
00:41:01,359 --> 00:41:01,920
groups

1206
00:41:01,920 --> 00:41:03,520
slash the name of the resource group

1207
00:41:03,520 --> 00:41:06,640
slash the type of resource provider

1208
00:41:06,640 --> 00:41:08,560
slash the resource and it's it's pretty

1209
00:41:08,560 --> 00:41:10,800
wild but enumeration

1210
00:41:10,800 --> 00:41:12,560
for these client libraries happens at

1211
00:41:12,560 --> 00:41:15,040
the subscription level

1212
00:41:15,040 --> 00:41:17,440
currently only azure cli and service

1213
00:41:17,440 --> 00:41:20,079
principal logins are supported

1214
00:41:20,079 --> 00:41:23,359
so i'm going to show you this demo

1215
00:41:32,079 --> 00:41:36,400
there we go all right

1216
00:41:38,480 --> 00:41:42,000
so i've actually already logged in as uh

1217
00:41:42,000 --> 00:41:46,400
kelly santana i can show you this by

1218
00:41:47,200 --> 00:41:49,520
listing the account here i've already

1219
00:41:49,520 --> 00:41:50,960
logged in as kelly santana we'll just

1220
00:41:50,960 --> 00:41:51,760
say that i've

1221
00:41:51,760 --> 00:41:54,720
somehow found kelly's credentials uh on

1222
00:41:54,720 --> 00:41:55,839
a

1223
00:41:55,839 --> 00:41:57,839
on twitter or something whoops took a

1224
00:41:57,839 --> 00:41:59,520
picture accidentally posted

1225
00:41:59,520 --> 00:42:01,200
a password on sticky note or something

1226
00:42:01,200 --> 00:42:02,640
however i got the credentials

1227
00:42:02,640 --> 00:42:05,520
uh i've logged in ask kelly and i kind

1228
00:42:05,520 --> 00:42:06,800
of want to see

1229
00:42:06,800 --> 00:42:09,599
what storm spotter what kelly has access

1230
00:42:09,599 --> 00:42:10,240
to

1231
00:42:10,240 --> 00:42:12,160
so you could use the azcla you can use

1232
00:42:12,160 --> 00:42:13,359
powershell to do all this sort of

1233
00:42:13,359 --> 00:42:14,960
enumeration there are some other tools

1234
00:42:14,960 --> 00:42:16,240
that people have written this year

1235
00:42:16,240 --> 00:42:20,400
uh to um view what azure resources that

1236
00:42:20,400 --> 00:42:21,520
uh people have

1237
00:42:21,520 --> 00:42:23,920
but um we're just gonna do this with

1238
00:42:23,920 --> 00:42:25,119
storm spotter

1239
00:42:25,119 --> 00:42:28,480
so uh let's see

1240
00:42:28,480 --> 00:42:31,839
directly in

1241
00:42:37,760 --> 00:42:40,720
so i'm going to run

1242
00:42:40,800 --> 00:42:45,440
the collector tool

1243
00:42:45,440 --> 00:42:48,240
as soon as i remember

1244
00:42:48,640 --> 00:42:49,760
because i was definitely in the wrong

1245
00:42:49,760 --> 00:42:53,040
folder um

1246
00:42:53,359 --> 00:42:56,240
and if i look at this

1247
00:42:57,680 --> 00:43:00,960
it's just a uh a python zip file

1248
00:43:00,960 --> 00:43:02,640
and i can you know work through my way

1249
00:43:02,640 --> 00:43:05,599
through the uh

1250
00:43:05,599 --> 00:43:07,119
through the help options just as you

1251
00:43:07,119 --> 00:43:08,800
would any other tool

1252
00:43:08,800 --> 00:43:10,480
um i'm not really gonna explain any of

1253
00:43:10,480 --> 00:43:12,240
this now but the most important thing

1254
00:43:12,240 --> 00:43:13,280
that you can take from this

1255
00:43:13,280 --> 00:43:15,520
uh what's on the screen right now is

1256
00:43:15,520 --> 00:43:17,440
that uh you can specify whether or not

1257
00:43:17,440 --> 00:43:18,480
you want to just scan

1258
00:43:18,480 --> 00:43:22,160
azure or scan ad

1259
00:43:22,160 --> 00:43:24,640
you can also specify the subs that you

1260
00:43:24,640 --> 00:43:26,000
want to scan if you

1261
00:43:26,000 --> 00:43:27,760
want to specify if you want to be

1262
00:43:27,760 --> 00:43:30,240
specific so

1263
00:43:30,240 --> 00:43:32,560
um i'm going to run this tool i've

1264
00:43:32,560 --> 00:43:34,319
already logged in via the cli

1265
00:43:34,319 --> 00:43:36,960
so i can just use the cli authentication

1266
00:43:36,960 --> 00:43:38,400
first thing that happens

1267
00:43:38,400 --> 00:43:41,520
is i authenticate successfully i started

1268
00:43:41,520 --> 00:43:42,720
numeration

1269
00:43:42,720 --> 00:43:45,760
started numeration for um azure resource

1270
00:43:45,760 --> 00:43:46,400
manager

1271
00:43:46,400 --> 00:43:47,599
and all this is happening at the same

1272
00:43:47,599 --> 00:43:48,960
time so there's like thousands of

1273
00:43:48,960 --> 00:43:50,240
requests going out

1274
00:43:50,240 --> 00:43:53,040
uh you know depending on how large your

1275
00:43:53,040 --> 00:43:54,400
organization is

1276
00:43:54,400 --> 00:43:57,599
um sorry enumerating azure id uh started

1277
00:43:57,599 --> 00:43:59,680
all the queries for each type that is

1278
00:43:59,680 --> 00:44:02,480
currently uh supported by storm spotter

1279
00:44:02,480 --> 00:44:04,000
then i also started enumerating the

1280
00:44:04,000 --> 00:44:05,839
subscriptions as well

1281
00:44:05,839 --> 00:44:08,240
they found one subscription it tried to

1282
00:44:08,240 --> 00:44:09,680
enumerate the management search which is

1283
00:44:09,680 --> 00:44:10,480
a classic

1284
00:44:10,480 --> 00:44:14,160
resource but um i didn't not only do i

1285
00:44:14,160 --> 00:44:15,119
not have

1286
00:44:15,119 --> 00:44:16,640
management certs but i also don't have

1287
00:44:16,640 --> 00:44:18,400
permissions ask kelly's antenna so just

1288
00:44:18,400 --> 00:44:19,359
let you know that's

1289
00:44:19,359 --> 00:44:20,960
this is fine if you if you see this

1290
00:44:20,960 --> 00:44:22,720
warning that's a good thing if you don't

1291
00:44:22,720 --> 00:44:24,160
see it this morning

1292
00:44:24,160 --> 00:44:26,880
that is something to look into for sure

1293
00:44:26,880 --> 00:44:28,880
um

1294
00:44:28,880 --> 00:44:31,440
so it finishes all the querying and this

1295
00:44:31,440 --> 00:44:32,000
is

1296
00:44:32,000 --> 00:44:33,200
this happened to me yesterday and i

1297
00:44:33,200 --> 00:44:34,640
didn't realize what what what caused

1298
00:44:34,640 --> 00:44:36,000
this

1299
00:44:36,000 --> 00:44:39,680
i had actually signed up for the

1300
00:44:39,680 --> 00:44:43,680
azure security free tier

1301
00:44:43,680 --> 00:44:46,640
and this is telling me that there are

1302
00:44:46,640 --> 00:44:48,000
some resources that

1303
00:44:48,000 --> 00:44:50,160
kelly cannot access kelly knows that

1304
00:44:50,160 --> 00:44:51,599
that they're there

1305
00:44:51,599 --> 00:44:54,000
but can't actually access the resource

1306
00:44:54,000 --> 00:44:55,760
in order to enumerate it

1307
00:44:55,760 --> 00:44:58,640
so um these warnings are fine it prints

1308
00:44:58,640 --> 00:45:00,640
out these things that

1309
00:45:00,640 --> 00:45:02,400
tell you that you can't access this

1310
00:45:02,400 --> 00:45:05,760
resource and then it prints out

1311
00:45:05,760 --> 00:45:08,319
it zips up the output and it puts it in

1312
00:45:08,319 --> 00:45:19,839
this file

1313
00:45:20,800 --> 00:45:22,960
so i'm going to open this real quick

1314
00:45:22,960 --> 00:45:25,280
this was the most recent one

1315
00:45:25,280 --> 00:45:28,960
and it's a bunch of sqlite files so

1316
00:45:28,960 --> 00:45:33,839
if i open up one for example for users

1317
00:45:34,319 --> 00:45:36,319
i can actually look at the data uh in

1318
00:45:36,319 --> 00:45:37,520
the sqlite file

1319
00:45:37,520 --> 00:45:40,400
the way it's a way to organize is that

1320
00:45:40,400 --> 00:45:42,079
it's just a json output

1321
00:45:42,079 --> 00:45:44,160
um in the file because it was the

1322
00:45:44,160 --> 00:45:46,960
easiest in the in the excuse me in the

1323
00:45:46,960 --> 00:45:48,720
column because it's just the easiest way

1324
00:45:48,720 --> 00:45:50,319
to handle all these different object

1325
00:45:50,319 --> 00:45:50,880
types

1326
00:45:50,880 --> 00:45:53,200
as opposed to putting each property into

1327
00:45:53,200 --> 00:45:54,640
an individual column

1328
00:45:54,640 --> 00:45:56,079
but i really don't care so much for

1329
00:45:56,079 --> 00:45:57,839
querying this data directly although you

1330
00:45:57,839 --> 00:45:58,240
could

1331
00:45:58,240 --> 00:46:00,400
right it is sql so you could query it

1332
00:46:00,400 --> 00:46:01,280
that way

1333
00:46:01,280 --> 00:46:04,079
i am going to

1334
00:46:04,800 --> 00:46:07,839
start up storm spotter

1335
00:46:10,160 --> 00:46:15,839
with docker

1336
00:46:16,640 --> 00:46:20,799
up let's go build it real quick

1337
00:46:22,640 --> 00:46:24,000
and this actually doesn't take very long

1338
00:46:24,000 --> 00:46:26,319
at all uh because i've already built it

1339
00:46:26,319 --> 00:46:29,200
so there's the front end starting up

1340
00:46:29,200 --> 00:46:31,440
here's the back end starting up

1341
00:46:31,440 --> 00:46:34,560
waiting for neo4j

1342
00:46:36,960 --> 00:46:39,200
which

1343
00:46:41,200 --> 00:46:44,319
cool so we're gonna go there

1344
00:46:50,400 --> 00:46:51,760
and i'm gonna visit the storm spotter

1345
00:46:51,760 --> 00:46:55,760
page so here's the login screen

1346
00:46:55,760 --> 00:46:57,680
the default password is of course

1347
00:46:57,680 --> 00:47:00,879
password because why not

1348
00:47:07,760 --> 00:47:10,720
and i've logged in and already i have no

1349
00:47:10,720 --> 00:47:12,400
results because i haven't uploaded

1350
00:47:12,400 --> 00:47:13,599
anything

1351
00:47:13,599 --> 00:47:15,599
to make this slightly bigger there we go

1352
00:47:15,599 --> 00:47:17,359
all right so we'll upload the file

1353
00:47:17,359 --> 00:47:21,359
that we just got from

1354
00:47:22,000 --> 00:47:25,599
from the storm spotter collection

1355
00:47:25,599 --> 00:47:27,359
there's no indication currently on the

1356
00:47:27,359 --> 00:47:29,119
front end that

1357
00:47:29,119 --> 00:47:32,720
uh it's finished but as it's going

1358
00:47:32,720 --> 00:47:33,200
through

1359
00:47:33,200 --> 00:47:34,480
it starts enumerating all these

1360
00:47:34,480 --> 00:47:38,319
different node types in the uh

1361
00:47:38,319 --> 00:47:41,839
on from the database if i wanted to see

1362
00:47:41,839 --> 00:47:44,079
if it was finished i would look

1363
00:47:44,079 --> 00:47:47,760
uh at the back end logs

1364
00:47:48,000 --> 00:47:50,000
eventually i will find a way to show it

1365
00:47:50,000 --> 00:47:52,000
on the front end whatever happening was

1366
00:47:52,000 --> 00:47:54,559
uh i happened to have like a 10 gigabyte

1367
00:47:54,559 --> 00:47:56,559
file one time when i was testing this

1368
00:47:56,559 --> 00:47:59,040
and it was just it became so unwieldy

1369
00:47:59,040 --> 00:48:00,559
and took so long

1370
00:48:00,559 --> 00:48:03,920
that uh uh showing it

1371
00:48:03,920 --> 00:48:05,920
that progress on the front end was a

1372
00:48:05,920 --> 00:48:08,079
design choice that i haven't

1373
00:48:08,079 --> 00:48:11,359
fully decided on yet so uh finish

1374
00:48:11,359 --> 00:48:12,720
the ingestion so we can start looking at

1375
00:48:12,720 --> 00:48:14,880
things the first thing i want to know

1376
00:48:14,880 --> 00:48:17,280
is who am i global administrators right

1377
00:48:17,280 --> 00:48:18,480
so if i go over here

1378
00:48:18,480 --> 00:48:20,800
to this queries tab there's some preset

1379
00:48:20,800 --> 00:48:22,960
queries in here

1380
00:48:22,960 --> 00:48:24,800
and i want to know who my global

1381
00:48:24,800 --> 00:48:26,880
administrators are

1382
00:48:26,880 --> 00:48:28,559
and here we get this this nice little

1383
00:48:28,559 --> 00:48:30,240
graph we're going to ignore

1384
00:48:30,240 --> 00:48:33,119
brag real quick or ignore myself ignore

1385
00:48:33,119 --> 00:48:33,680
these three

1386
00:48:33,680 --> 00:48:34,720
these are the two that i really care

1387
00:48:34,720 --> 00:48:37,520
about um

1388
00:48:37,599 --> 00:48:39,920
because these are are the members of in

1389
00:48:39,920 --> 00:48:41,359
the storm spotter tenant

1390
00:48:41,359 --> 00:48:44,559
so we have this account called choc

1391
00:48:44,559 --> 00:48:46,960
latte and we have this count called glow

1392
00:48:46,960 --> 00:48:48,720
bull

1393
00:48:48,720 --> 00:48:52,480
and global has this administrator

1394
00:48:52,720 --> 00:48:55,680
account name so when i click on an

1395
00:48:55,680 --> 00:48:56,160
object

1396
00:48:56,160 --> 00:48:58,480
i can see the properties of this object

1397
00:48:58,480 --> 00:49:00,240
on the right side

1398
00:49:00,240 --> 00:49:02,000
there are some properties that aren't

1399
00:49:02,000 --> 00:49:04,400
shown here and if i wanted to see that

1400
00:49:04,400 --> 00:49:06,240
directly i can click on the raw data

1401
00:49:06,240 --> 00:49:08,079
this is supposed to be json indented but

1402
00:49:08,079 --> 00:49:09,119
i haven't figured out why it doesn't

1403
00:49:09,119 --> 00:49:09,680
work yet

1404
00:49:09,680 --> 00:49:10,720
i've been struggling on that one for

1405
00:49:10,720 --> 00:49:13,599
days but um i i just blame it on

1406
00:49:13,599 --> 00:49:14,640
javascript

1407
00:49:14,640 --> 00:49:18,160
so um i can see all the properties and i

1408
00:49:18,160 --> 00:49:20,079
can see the relationships so here i have

1409
00:49:20,079 --> 00:49:20,800
global

1410
00:49:20,800 --> 00:49:23,680
and chocolate who are both members of

1411
00:49:23,680 --> 00:49:25,040
the company administrator right that

1412
00:49:25,040 --> 00:49:26,319
makes them targets uh

1413
00:49:26,319 --> 00:49:29,119
in my eyes if i were someone who had

1414
00:49:29,119 --> 00:49:30,880
stolen kelly santana's

1415
00:49:30,880 --> 00:49:34,720
um uh identity

1416
00:49:34,720 --> 00:49:38,160
but in order to uh see what kelly has

1417
00:49:38,160 --> 00:49:39,440
access to

1418
00:49:39,440 --> 00:49:42,880
we're going to look her up real quick uh

1419
00:49:42,880 --> 00:49:45,839
where

1420
00:49:54,160 --> 00:49:57,200
and here's kelly's uh node

1421
00:49:57,200 --> 00:50:00,800
or id so we can click on

1422
00:50:00,800 --> 00:50:03,040
expanding expand outgoing which shows

1423
00:50:03,040 --> 00:50:04,400
which relationships have

1424
00:50:04,400 --> 00:50:06,960
or which nodes have a relation from

1425
00:50:06,960 --> 00:50:07,440
kelly

1426
00:50:07,440 --> 00:50:10,240
to that node and we see that kelly has a

1427
00:50:10,240 --> 00:50:11,200
couple of

1428
00:50:11,200 --> 00:50:13,520
of interesting things right kelly owns

1429
00:50:13,520 --> 00:50:15,680
the sales cashier

1430
00:50:15,680 --> 00:50:17,359
she owns the service principle the

1431
00:50:17,359 --> 00:50:19,040
application that we talked about

1432
00:50:19,040 --> 00:50:22,640
earlier she owns the sales group

1433
00:50:22,640 --> 00:50:24,640
and she's a member of the sales so kelly

1434
00:50:24,640 --> 00:50:25,760
is probably like a sales

1435
00:50:25,760 --> 00:50:27,839
manager or something like that um she is

1436
00:50:27,839 --> 00:50:28,800
a contributor

1437
00:50:28,800 --> 00:50:31,920
to some to a subscription

1438
00:50:31,920 --> 00:50:34,160
which

1439
00:50:35,119 --> 00:50:36,960
that is probably a bug uh because that

1440
00:50:36,960 --> 00:50:38,400
subscription is right here

1441
00:50:38,400 --> 00:50:40,880
so i figure out why that showed up um

1442
00:50:40,880 --> 00:50:42,880
she's a contributor for subscription

1443
00:50:42,880 --> 00:50:44,000
and this is probably the most

1444
00:50:44,000 --> 00:50:45,920
interesting thing because

1445
00:50:45,920 --> 00:50:48,079
for some reason kelly has contributed

1446
00:50:48,079 --> 00:50:50,240
level access to the subscription

1447
00:50:50,240 --> 00:50:51,119
so i want to see what's in this

1448
00:50:51,119 --> 00:50:53,680
subscription

1449
00:50:53,680 --> 00:50:54,960
i'm going to change the way the graph

1450
00:50:54,960 --> 00:50:57,359
looks just to make it easier

1451
00:50:57,359 --> 00:51:00,000
so in this subscription we have a bunch

1452
00:51:00,000 --> 00:51:01,839
of different resource groups

1453
00:51:01,839 --> 00:51:06,000
and we noticed that glow was a

1454
00:51:06,000 --> 00:51:08,079
global was a global administrator

1455
00:51:08,079 --> 00:51:09,680
earlier and here's a resource group

1456
00:51:09,680 --> 00:51:10,400
called glow

1457
00:51:10,400 --> 00:51:11,920
so i want to know what's in here what

1458
00:51:11,920 --> 00:51:13,760
what does kelly

1459
00:51:13,760 --> 00:51:17,040
from sales what permissions that you

1460
00:51:17,040 --> 00:51:18,480
have on glow's

1461
00:51:18,480 --> 00:51:21,680
resource group and although this gets a

1462
00:51:21,680 --> 00:51:23,599
little messy so let's filter this down

1463
00:51:23,599 --> 00:51:26,880
and expand it and change how that looks

1464
00:51:26,880 --> 00:51:29,440
right so the glow resource group has a

1465
00:51:29,440 --> 00:51:30,640
key vault

1466
00:51:30,640 --> 00:51:34,000
it has a public-facing ip

1467
00:51:34,000 --> 00:51:36,480
that is likely attached to this virtual

1468
00:51:36,480 --> 00:51:37,680
machine

1469
00:51:37,680 --> 00:51:40,319
and there's a disk here as well so if i

1470
00:51:40,319 --> 00:51:42,480
start expanding on this virtual machine

1471
00:51:42,480 --> 00:51:47,040
uh it gets to be a lot actually but

1472
00:51:47,040 --> 00:51:50,000
i can see that this virtual machine uh

1473
00:51:50,000 --> 00:51:50,400
has

1474
00:51:50,400 --> 00:51:53,440
rdp open on three three eight nine so

1475
00:51:53,440 --> 00:51:56,880
now i have an ip address

1476
00:51:57,440 --> 00:52:00,480
i have an ip address i have

1477
00:52:00,480 --> 00:52:04,559
uh a virtual i have um rdp access

1478
00:52:04,559 --> 00:52:07,680
and as a contributor i would be able to

1479
00:52:07,680 --> 00:52:10,640
log in to this ip address i'm going to

1480
00:52:10,640 --> 00:52:11,920
i'm running out of time but

1481
00:52:11,920 --> 00:52:13,680
i'm going to show you how this can be

1482
00:52:13,680 --> 00:52:18,480
used real quick

1483
00:52:18,480 --> 00:52:22,640
so um since i have contributor level

1484
00:52:22,640 --> 00:52:23,119
access

1485
00:52:23,119 --> 00:52:26,079
on that virtual machine right by a

1486
00:52:26,079 --> 00:52:27,040
transit of

1487
00:52:27,040 --> 00:52:32,720
by misconfiguration i can actually

1488
00:52:32,720 --> 00:52:36,480
let's see oops sorry about that

1489
00:52:36,480 --> 00:52:40,319
a vm user update

1490
00:52:40,319 --> 00:52:44,079
i can i can update the administrator

1491
00:52:44,079 --> 00:52:46,079
uh update the virtual machine with

1492
00:52:46,079 --> 00:52:47,920
administrator my own administrator and

1493
00:52:47,920 --> 00:52:48,640
password

1494
00:52:48,640 --> 00:52:54,319
so i can do um i like being admin

1495
00:52:55,119 --> 00:52:58,839
uh the name of the resource group was

1496
00:52:58,839 --> 00:53:00,000
glow

1497
00:53:00,000 --> 00:53:04,880
the username we'll call it

1498
00:53:04,880 --> 00:53:15,119
temp admin actually you know what

1499
00:53:15,119 --> 00:53:16,559
i'm gonna go up in my history real quick

1500
00:53:16,559 --> 00:53:18,240
because

1501
00:53:18,240 --> 00:53:19,760
i actually already had this setup

1502
00:53:19,760 --> 00:53:24,400
somewhere and i didn't copy and paste it

1503
00:53:25,839 --> 00:53:27,760
anyway um and then i'll give it a

1504
00:53:27,760 --> 00:53:29,920
password uh

1505
00:53:29,920 --> 00:53:33,359
test password one bang

1506
00:53:33,359 --> 00:53:36,559
and what this does is um

1507
00:53:36,559 --> 00:53:39,200
it creates a user on this virtual

1508
00:53:39,200 --> 00:53:40,720
machine

1509
00:53:40,720 --> 00:53:42,400
um which i shouldn't have which kelly

1510
00:53:42,400 --> 00:53:44,720
shouldn't have access to uh because it's

1511
00:53:44,720 --> 00:53:47,680
not in sales or anything like that uh

1512
00:53:47,680 --> 00:53:49,200
it's a misconfiguration

1513
00:53:49,200 --> 00:53:51,440
so kelly has access to this first

1514
00:53:51,440 --> 00:53:53,520
machine let's set up a username

1515
00:53:53,520 --> 00:53:55,760
google temp admin with the password and

1516
00:53:55,760 --> 00:53:57,599
then i can rdp

1517
00:53:57,599 --> 00:54:01,359
into this virtual machine that glow

1518
00:54:01,359 --> 00:54:04,319
uses and i can look around and see what

1519
00:54:04,319 --> 00:54:06,400
is on glow's virtual machine

1520
00:54:06,400 --> 00:54:09,440
um it's

1521
00:54:09,440 --> 00:54:12,160
it's uh

1522
00:54:12,880 --> 00:54:14,800
it's very important to understand what

1523
00:54:14,800 --> 00:54:16,400
these permissions do

1524
00:54:16,400 --> 00:54:18,240
um i'm gonna let this finish but since

1525
00:54:18,240 --> 00:54:19,280
i'm running out of time i'm actually

1526
00:54:19,280 --> 00:54:19,920
gonna

1527
00:54:19,920 --> 00:54:23,119
finish up the slides real quick

1528
00:54:23,440 --> 00:54:25,520
although i kind of just want to let you

1529
00:54:25,520 --> 00:54:26,720
see that it succeeds

1530
00:54:26,720 --> 00:54:30,480
and me being able to um

1531
00:54:32,319 --> 00:54:33,839
change the username and password you

1532
00:54:33,839 --> 00:54:35,760
notice that i i did give you an ip

1533
00:54:35,760 --> 00:54:36,240
address

1534
00:54:36,240 --> 00:54:38,000
and i gave you a username and i gave you

1535
00:54:38,000 --> 00:54:39,680
a password but you actually won't be

1536
00:54:39,680 --> 00:54:41,040
able to log into this because i have

1537
00:54:41,040 --> 00:54:42,240
some uh permissions

1538
00:54:42,240 --> 00:54:46,240
set up explicitly for me so um

1539
00:54:46,240 --> 00:54:49,680
don't do that uh so just to close this

1540
00:54:49,680 --> 00:54:50,079
out

1541
00:54:50,079 --> 00:54:53,920
um real quick um aed arm permissions can

1542
00:54:53,920 --> 00:54:55,440
be pretty complex

1543
00:54:55,440 --> 00:54:57,119
uh you should check your audit you

1544
00:54:57,119 --> 00:54:58,480
should regularly audit your permissions

1545
00:54:58,480 --> 00:54:59,920
to check for changes

1546
00:54:59,920 --> 00:55:01,599
and follow the least privileged rules so

1547
00:55:01,599 --> 00:55:02,880
you don't need access to an entire

1548
00:55:02,880 --> 00:55:04,240
subscription or resource group just to

1549
00:55:04,240 --> 00:55:06,799
access a resource and users who manage

1550
00:55:06,799 --> 00:55:08,319
resources should only be given access to

1551
00:55:08,319 --> 00:55:10,000
the resources that they need

1552
00:55:10,000 --> 00:55:13,119
so um yeah uh

1553
00:55:13,119 --> 00:55:15,200
if you have any questions uh you hit me

1554
00:55:15,200 --> 00:55:17,200
up at mcohmi

1555
00:55:17,200 --> 00:55:19,680
it's mcomi i'm on twitter instagram

1556
00:55:19,680 --> 00:55:20,400
whatever

1557
00:55:20,400 --> 00:55:22,240
uh where everyone hit me up at um you

1558
00:55:22,240 --> 00:55:23,920
can hit me up on my email which is

1559
00:55:23,920 --> 00:55:25,839
daddycockman gmail.com

1560
00:55:25,839 --> 00:55:29,040
or you can add me on linkedin um if you

1561
00:55:29,040 --> 00:55:31,040
uh add me on linkedin just put in b-side

1562
00:55:31,040 --> 00:55:32,400
seattle so that i know

1563
00:55:32,400 --> 00:55:35,599
uh where you came from and that is my

1564
00:55:35,599 --> 00:55:37,520
time so i will take questions in the

1565
00:55:37,520 --> 00:55:38,240
discord

1566
00:55:38,240 --> 00:55:41,280
because the next talker is going to come

1567
00:55:41,280 --> 00:55:42,400
up right carrie

1568
00:55:42,400 --> 00:55:49,839
yeah absolutely thanks lauren

1569
00:55:56,240 --> 00:55:58,319
you

