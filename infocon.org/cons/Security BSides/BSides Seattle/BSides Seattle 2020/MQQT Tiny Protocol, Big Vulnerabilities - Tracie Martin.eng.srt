1
00:00:02,310 --> 00:00:07,440
[Music]

2
00:00:07,440 --> 00:00:09,200
all right thanks folks thank you for

3
00:00:09,200 --> 00:00:10,400
joining me in this

4
00:00:10,400 --> 00:00:13,519
first virtual besides i'm super excited

5
00:00:13,519 --> 00:00:14,719
this is my first time

6
00:00:14,719 --> 00:00:16,800
speaking actually at b-sides i've

7
00:00:16,800 --> 00:00:18,160
volunteered for

8
00:00:18,160 --> 00:00:20,800
a few years and i've talked to a bunch

9
00:00:20,800 --> 00:00:21,520
of the con

10
00:00:21,520 --> 00:00:23,199
organizers because they helped me out

11
00:00:23,199 --> 00:00:25,199
with defend con so i'm super excited to

12
00:00:25,199 --> 00:00:26,640
be speaking to you today

13
00:00:26,640 --> 00:00:30,000
on mqtt security tiny protocol with big

14
00:00:30,000 --> 00:00:31,439
vulnerabilities

15
00:00:31,439 --> 00:00:34,320
all right well so let's get started oh

16
00:00:34,320 --> 00:00:35,360
maybe let's get started

17
00:00:35,360 --> 00:00:38,480
slide slides

18
00:00:38,559 --> 00:00:41,520
virtual there we go there we go there

19
00:00:41,520 --> 00:00:42,719
now we can get started

20
00:00:42,719 --> 00:00:44,879
a little bit about me i am a principal

21
00:00:44,879 --> 00:00:46,079
security engineer

22
00:00:46,079 --> 00:00:48,640
in iot which is why i'm talking to you

23
00:00:48,640 --> 00:00:50,320
today about mqtt

24
00:00:50,320 --> 00:00:52,079
i've worked in security for about 20

25
00:00:52,079 --> 00:00:54,559
years now um i've worked in iot for

26
00:00:54,559 --> 00:00:56,000
about 45 days

27
00:00:56,000 --> 00:00:59,039
and the reason i bring that up is there

28
00:00:59,039 --> 00:01:00,399
are probably people sitting in the

29
00:01:00,399 --> 00:01:02,160
audience right now who may be

30
00:01:02,160 --> 00:01:04,159
more junior to the industry or maybe

31
00:01:04,159 --> 00:01:05,760
they're starting in a different niche of

32
00:01:05,760 --> 00:01:07,200
the industry like me

33
00:01:07,200 --> 00:01:09,600
and maybe you've thought i'm too new i

34
00:01:09,600 --> 00:01:11,360
don't have enough to speak because

35
00:01:11,360 --> 00:01:13,680
everybody already knows what i know

36
00:01:13,680 --> 00:01:15,680
well about two months ago i didn't know

37
00:01:15,680 --> 00:01:17,520
what i'm about to present on today it

38
00:01:17,520 --> 00:01:18,080
wasn't

39
00:01:18,080 --> 00:01:20,240
part of my job and so i've been spending

40
00:01:20,240 --> 00:01:21,680
the last few months getting really

41
00:01:21,680 --> 00:01:23,360
familiar with iot

42
00:01:23,360 --> 00:01:25,119
and applying my background in security

43
00:01:25,119 --> 00:01:26,479
to that new space

44
00:01:26,479 --> 00:01:28,640
so the reason i bring that up is so that

45
00:01:28,640 --> 00:01:30,640
i hope folks in the audience who are

46
00:01:30,640 --> 00:01:32,240
thinking that you don't have enough

47
00:01:32,240 --> 00:01:34,240
knowledge to speak or you don't you know

48
00:01:34,240 --> 00:01:35,439
you don't want to put yourself

49
00:01:35,439 --> 00:01:37,600
out there encourage you to join the

50
00:01:37,600 --> 00:01:39,439
community and help folks that maybe

51
00:01:39,439 --> 00:01:41,040
don't know what you already know right

52
00:01:41,040 --> 00:01:42,000
now

53
00:01:42,000 --> 00:01:44,320
uh some of you who know me probably know

54
00:01:44,320 --> 00:01:45,920
me from defence

55
00:01:45,920 --> 00:01:48,799
we are in a break year uh which actually

56
00:01:48,799 --> 00:01:49,920
kind of worked out

57
00:01:49,920 --> 00:01:51,840
uh because kovid messed everybody's

58
00:01:51,840 --> 00:01:54,320
plans up so kudos to the con organizers

59
00:01:54,320 --> 00:01:56,079
at b-sides for pulling off this virtual

60
00:01:56,079 --> 00:01:57,759
event it's amazing

61
00:01:57,759 --> 00:01:59,759
we are hoping to bring defence back in

62
00:01:59,759 --> 00:02:01,520
2021 as a virtual event

63
00:02:01,520 --> 00:02:03,360
but we're still ironing out all the

64
00:02:03,360 --> 00:02:06,000
details because it is a lot of work

65
00:02:06,000 --> 00:02:08,720
i'm a us air force veteran i spent some

66
00:02:08,720 --> 00:02:10,080
time with the army

67
00:02:10,080 --> 00:02:12,000
i've done counterintelligence missile

68
00:02:12,000 --> 00:02:13,120
defense

69
00:02:13,120 --> 00:02:16,400
uh i have done basically a ton of

70
00:02:16,400 --> 00:02:17,200
different things

71
00:02:17,200 --> 00:02:20,239
in the military and federal space

72
00:02:20,239 --> 00:02:23,200
and i my hobbies are open source

73
00:02:23,200 --> 00:02:24,640
information

74
00:02:24,640 --> 00:02:26,400
collection so you'll see some of my

75
00:02:26,400 --> 00:02:27,920
talks on disinformation

76
00:02:27,920 --> 00:02:30,400
is more traditionally what i speak on i

77
00:02:30,400 --> 00:02:31,680
also do photography

78
00:02:31,680 --> 00:02:34,560
and i raise a small child which takes an

79
00:02:34,560 --> 00:02:36,800
awful lot of my time so

80
00:02:36,800 --> 00:02:39,280
i have a full plate and i'm i'm happy to

81
00:02:39,280 --> 00:02:40,959
be able to be here to do this on a

82
00:02:40,959 --> 00:02:42,480
weekend while my husband

83
00:02:42,480 --> 00:02:45,040
is guarding my child so that's very

84
00:02:45,040 --> 00:02:46,720
always very exciting

85
00:02:46,720 --> 00:02:48,160
all right so the first thing we need to

86
00:02:48,160 --> 00:02:50,319
figure out is what exactly is the

87
00:02:50,319 --> 00:02:51,440
internet of things

88
00:02:51,440 --> 00:02:52,560
now there's a bunch of different

89
00:02:52,560 --> 00:02:54,879
definitions and i think they overlap a

90
00:02:54,879 --> 00:02:56,800
bit and it causes some confusion

91
00:02:56,800 --> 00:02:59,040
basically the most common definition is

92
00:02:59,040 --> 00:03:01,760
that it is a set of physical things

93
00:03:01,760 --> 00:03:04,239
with embedded software or sensors that's

94
00:03:04,239 --> 00:03:06,080
then connected to the internet to talk

95
00:03:06,080 --> 00:03:07,280
to other things

96
00:03:07,280 --> 00:03:09,840
so the most common explanation of this

97
00:03:09,840 --> 00:03:11,920
is like your home automation system so

98
00:03:11,920 --> 00:03:13,840
your smart lights your smart doors

99
00:03:13,840 --> 00:03:16,400
that's where most people kind of get

100
00:03:16,400 --> 00:03:18,400
exposed to internet of things

101
00:03:18,400 --> 00:03:20,159
but what i think a lot of people don't

102
00:03:20,159 --> 00:03:21,599
realize is that it's actually much

103
00:03:21,599 --> 00:03:23,680
bigger than that so you have a huge

104
00:03:23,680 --> 00:03:26,159
medical industry that has an internet of

105
00:03:26,159 --> 00:03:28,319
things presence manufacturing

106
00:03:28,319 --> 00:03:31,280
power grid nuclear power plants anything

107
00:03:31,280 --> 00:03:32,959
you can think of there's now a military

108
00:03:32,959 --> 00:03:34,319
internet of things so

109
00:03:34,319 --> 00:03:38,399
there's a ton of applications of iot

110
00:03:40,319 --> 00:03:42,239
uh sorry guys this isn't good for me so

111
00:03:42,239 --> 00:03:44,400
it's a little wonky uh there's a ton of

112
00:03:44,400 --> 00:03:45,040
iot

113
00:03:45,040 --> 00:03:46,959
implications that span more than just

114
00:03:46,959 --> 00:03:48,319
whether i can turn on and off your

115
00:03:48,319 --> 00:03:49,680
lights at home

116
00:03:49,680 --> 00:03:52,080
this technology reached 100 billion

117
00:03:52,080 --> 00:03:53,760
dollars in market revenue

118
00:03:53,760 --> 00:03:56,319
in 2017 and it's expected to grow even

119
00:03:56,319 --> 00:03:58,799
more than that in the future

120
00:03:58,799 --> 00:04:02,959
so what is mqtt mq telemetry transport

121
00:04:02,959 --> 00:04:05,040
or message queuing telemetry transport

122
00:04:05,040 --> 00:04:06,480
is an open standard

123
00:04:06,480 --> 00:04:08,239
basically designed to be lightweight

124
00:04:08,239 --> 00:04:10,080
publish and subscribe it's a way of

125
00:04:10,080 --> 00:04:10,560
getting

126
00:04:10,560 --> 00:04:13,840
iot devices to talk to other iot devices

127
00:04:13,840 --> 00:04:15,280
and the reason it was invented

128
00:04:15,280 --> 00:04:18,079
is that iot unlike traditional computing

129
00:04:18,079 --> 00:04:18,959
environments

130
00:04:18,959 --> 00:04:21,440
often operates in areas of high latency

131
00:04:21,440 --> 00:04:23,120
low connectivity

132
00:04:23,120 --> 00:04:25,440
where there's not a lot of power and

133
00:04:25,440 --> 00:04:27,120
there's not a lot of

134
00:04:27,120 --> 00:04:29,600
uh ability to get messages to other

135
00:04:29,600 --> 00:04:30,720
things because you never know what's

136
00:04:30,720 --> 00:04:32,560
really going to be online or not

137
00:04:32,560 --> 00:04:34,639
it's designed for devices with really

138
00:04:34,639 --> 00:04:36,560
small footprints right really small code

139
00:04:36,560 --> 00:04:38,240
footprints really low power

140
00:04:38,240 --> 00:04:40,880
these things can exist out in the

141
00:04:40,880 --> 00:04:42,080
environment for

142
00:04:42,080 --> 00:04:44,560
five to ten years on a battery and they

143
00:04:44,560 --> 00:04:46,479
may never see the inside of an actual

144
00:04:46,479 --> 00:04:48,080
physical place they are put out in a

145
00:04:48,080 --> 00:04:50,639
farm somewhere and forgotten about

146
00:04:50,639 --> 00:04:53,440
so what are the benefits of mqtt uh it's

147
00:04:53,440 --> 00:04:55,120
scalable you can connect a bunch of

148
00:04:55,120 --> 00:04:56,720
devices to it and that's really

149
00:04:56,720 --> 00:04:58,639
big because when you're dealing in iot

150
00:04:58,639 --> 00:05:00,240
you're usually dealing in

151
00:05:00,240 --> 00:05:02,080
hundreds of thousands if not millions of

152
00:05:02,080 --> 00:05:03,520
devices at the same time

153
00:05:03,520 --> 00:05:05,520
it's also packet agnostic and what that

154
00:05:05,520 --> 00:05:07,680
means is that it's basically just a

155
00:05:07,680 --> 00:05:09,280
sender think of it like a mail

156
00:05:09,280 --> 00:05:11,199
envelope i can put anything i want

157
00:05:11,199 --> 00:05:12,960
inside the envelope as long as i have

158
00:05:12,960 --> 00:05:14,960
the correct addressing on the outside i

159
00:05:14,960 --> 00:05:17,039
know it's going to get to my destination

160
00:05:17,039 --> 00:05:19,280
and that can be text messaging that can

161
00:05:19,280 --> 00:05:21,680
be binary data program data

162
00:05:21,680 --> 00:05:23,759
it can be really anything which is good

163
00:05:23,759 --> 00:05:25,440
but it can also be really bad

164
00:05:25,440 --> 00:05:28,160
it's also really reliable so unlike more

165
00:05:28,160 --> 00:05:29,039
traditional

166
00:05:29,039 --> 00:05:31,840
low footprint protocols like udp which

167
00:05:31,840 --> 00:05:34,160
is fire and forget and you may not know

168
00:05:34,160 --> 00:05:36,479
if your end destination gets the message

169
00:05:36,479 --> 00:05:39,280
mqtt actually has reliability built in

170
00:05:39,280 --> 00:05:40,960
through quality of service levels

171
00:05:40,960 --> 00:05:42,479
so you can actually set it so that you

172
00:05:42,479 --> 00:05:44,479
know the end destination will eventually

173
00:05:44,479 --> 00:05:45,759
get your message

174
00:05:45,759 --> 00:05:48,160
it's also decoupled in design and what

175
00:05:48,160 --> 00:05:49,440
that means is that

176
00:05:49,440 --> 00:05:51,440
sometimes the server's offline sometimes

177
00:05:51,440 --> 00:05:53,199
the end device is offline they don't

178
00:05:53,199 --> 00:05:55,600
have to be online at the same time which

179
00:05:55,600 --> 00:05:57,360
is really important when you're thinking

180
00:05:57,360 --> 00:05:58,000
about these

181
00:05:58,000 --> 00:06:00,560
geographically distributed devices in

182
00:06:00,560 --> 00:06:01,840
areas that may not have great

183
00:06:01,840 --> 00:06:03,120
connectivity

184
00:06:03,120 --> 00:06:05,360
it's also really really efficient it's

185
00:06:05,360 --> 00:06:06,880
very very lightweight

186
00:06:06,880 --> 00:06:08,639
it's designed to operate in networks

187
00:06:08,639 --> 00:06:10,240
that have very

188
00:06:10,240 --> 00:06:13,520
very low bandwidth and it also is

189
00:06:13,520 --> 00:06:15,199
designed to operate in areas where it

190
00:06:15,199 --> 00:06:17,600
has high latency

191
00:06:17,600 --> 00:06:19,199
so there's some key ideas you need to

192
00:06:19,199 --> 00:06:22,080
understand about mqtt

193
00:06:22,080 --> 00:06:24,000
and the first is a publisher so

194
00:06:24,000 --> 00:06:25,840
publisher is exactly what it sounds like

195
00:06:25,840 --> 00:06:28,080
it's somebody who publishes a message

196
00:06:28,080 --> 00:06:30,080
usually this is the actual thing right

197
00:06:30,080 --> 00:06:31,919
the actual thing in the environment like

198
00:06:31,919 --> 00:06:34,160
the light bulb or the sensor

199
00:06:34,160 --> 00:06:36,880
that actually is sending information to

200
00:06:36,880 --> 00:06:38,639
some kind of controller

201
00:06:38,639 --> 00:06:40,240
that's pushed through what's called a

202
00:06:40,240 --> 00:06:41,919
broker which acts as a middleman

203
00:06:41,919 --> 00:06:43,840
it sits in the middle of if any of you

204
00:06:43,840 --> 00:06:45,520
guys have done the network plus

205
00:06:45,520 --> 00:06:47,280
exam you remember the star network

206
00:06:47,280 --> 00:06:50,000
design very very similar idea in this

207
00:06:50,000 --> 00:06:52,080
broker sits in the middle it's accepting

208
00:06:52,080 --> 00:06:54,560
published messages from end devices

209
00:06:54,560 --> 00:06:55,680
now on the other side of that

210
00:06:55,680 --> 00:06:57,680
transaction is a subscriber so you can

211
00:06:57,680 --> 00:06:58,400
think of this

212
00:06:58,400 --> 00:07:00,639
like if you have ring or nest you have

213
00:07:00,639 --> 00:07:02,240
an app on your phone

214
00:07:02,240 --> 00:07:04,400
it is the subscriber to messages about

215
00:07:04,400 --> 00:07:06,800
your light bulbs or your garage door

216
00:07:06,800 --> 00:07:09,039
um basically it's the thing that

217
00:07:09,039 --> 00:07:10,000
controls the

218
00:07:10,000 --> 00:07:12,160
messages in the in the infrastructure

219
00:07:12,160 --> 00:07:13,280
and then there's something called

220
00:07:13,280 --> 00:07:15,280
topics and topics you can think of like

221
00:07:15,280 --> 00:07:16,880
sections of a newspaper

222
00:07:16,880 --> 00:07:18,479
imagine if you could subscribe to the

223
00:07:18,479 --> 00:07:20,240
new york times but only the sports

224
00:07:20,240 --> 00:07:20,960
section

225
00:07:20,960 --> 00:07:23,360
or only the finance section that's what

226
00:07:23,360 --> 00:07:26,000
you can do with mqtt only subscribe to

227
00:07:26,000 --> 00:07:27,520
the information that you want to know

228
00:07:27,520 --> 00:07:28,080
about

229
00:07:28,080 --> 00:07:29,440
and that way you can act on that

230
00:07:29,440 --> 00:07:31,120
information without getting spammed with

231
00:07:31,120 --> 00:07:32,639
a bunch of other information you don't

232
00:07:32,639 --> 00:07:34,479
really care about

233
00:07:34,479 --> 00:07:37,280
so it's history it's created way back in

234
00:07:37,280 --> 00:07:38,720
1999

235
00:07:38,720 --> 00:07:41,840
by engineers from ibm and eurotech

236
00:07:41,840 --> 00:07:44,479
it was created for oil pipelines so

237
00:07:44,479 --> 00:07:46,479
again that's a very traditional use case

238
00:07:46,479 --> 00:07:48,080
right you've got these oil rigs out in

239
00:07:48,080 --> 00:07:50,080
the middle of basically nowhere

240
00:07:50,080 --> 00:07:52,000
they often operate with satellite

241
00:07:52,000 --> 00:07:53,759
connections which are incredibly

242
00:07:53,759 --> 00:07:56,080
lossy and bandwidth constrained so there

243
00:07:56,080 --> 00:07:56,800
had to be

244
00:07:56,800 --> 00:07:59,120
a way of getting that information back

245
00:07:59,120 --> 00:08:01,280
to the controller that was usually

246
00:08:01,280 --> 00:08:04,080
in a mainland installation so they

247
00:08:04,080 --> 00:08:06,000
created this protocol this super

248
00:08:06,000 --> 00:08:07,680
lightweight but the problem is

249
00:08:07,680 --> 00:08:10,240
just like when http was first invented

250
00:08:10,240 --> 00:08:12,160
they really didn't think about security

251
00:08:12,160 --> 00:08:13,680
because that just wasn't a concern for

252
00:08:13,680 --> 00:08:14,800
them at the time

253
00:08:14,800 --> 00:08:17,199
so authentication wasn't even really

254
00:08:17,199 --> 00:08:18,319
thought of until

255
00:08:18,319 --> 00:08:21,599
very recently in version 3.1

256
00:08:21,599 --> 00:08:24,319
so this is basically what it looks like

257
00:08:24,319 --> 00:08:26,319
it's a very very simple idea so this is

258
00:08:26,319 --> 00:08:27,360
an ir sensor

259
00:08:27,360 --> 00:08:30,080
uh you could use this i have one that

260
00:08:30,080 --> 00:08:31,360
monitors the water level

261
00:08:31,360 --> 00:08:33,839
in my cat's water dish because it's in

262
00:08:33,839 --> 00:08:34,559
our

263
00:08:34,559 --> 00:08:36,159
back room and i'm really bad about

264
00:08:36,159 --> 00:08:38,240
remembering to check it so now i have an

265
00:08:38,240 --> 00:08:40,080
ir sensor that sends me an alert when it

266
00:08:40,080 --> 00:08:41,919
gets to a certain level so that my cat

267
00:08:41,919 --> 00:08:44,480
doesn't die of dehydration because

268
00:08:44,480 --> 00:08:46,160
i am a terrible human and that would

269
00:08:46,160 --> 00:08:48,560
probably happen um in the middle is a

270
00:08:48,560 --> 00:08:49,360
broker

271
00:08:49,360 --> 00:08:50,959
and the broker like i said acts as a

272
00:08:50,959 --> 00:08:52,560
middleman think of it as like a little

273
00:08:52,560 --> 00:08:54,080
male person sitting in the middle of the

274
00:08:54,080 --> 00:08:56,080
network directing all the traffic

275
00:08:56,080 --> 00:08:57,920
um below it you'll see a database this

276
00:08:57,920 --> 00:09:00,399
isn't required for mqtt but in

277
00:09:00,399 --> 00:09:02,959
any large mqtt installation you'll

278
00:09:02,959 --> 00:09:04,399
probably see one

279
00:09:04,399 --> 00:09:06,240
this allows the broker to store and

280
00:09:06,240 --> 00:09:08,399
buffer a lot a lot more messages than it

281
00:09:08,399 --> 00:09:09,279
would if you were

282
00:09:09,279 --> 00:09:11,920
relying on the on device broker and then

283
00:09:11,920 --> 00:09:13,920
on the far right you'll see a smart

284
00:09:13,920 --> 00:09:15,680
phone this can be a smartphone it can be

285
00:09:15,680 --> 00:09:17,360
a control unit it can be

286
00:09:17,360 --> 00:09:19,839
an automotive control unit head um it

287
00:09:19,839 --> 00:09:21,600
can be really anything that has the

288
00:09:21,600 --> 00:09:23,279
automation programming

289
00:09:23,279 --> 00:09:25,920
to understand the message and act on it

290
00:09:25,920 --> 00:09:26,959
and you'll notice that

291
00:09:26,959 --> 00:09:29,839
the ir sensor is a publish under sensors

292
00:09:29,839 --> 00:09:30,720
and distance

293
00:09:30,720 --> 00:09:32,959
so it's in a group of topics called

294
00:09:32,959 --> 00:09:34,000
sensors

295
00:09:34,000 --> 00:09:36,080
underneath that distance and what that

296
00:09:36,080 --> 00:09:37,360
is is if you think of it

297
00:09:37,360 --> 00:09:39,760
kind of like your folder structure in a

298
00:09:39,760 --> 00:09:41,920
in a file system on an operating system

299
00:09:41,920 --> 00:09:44,480
you have a big group a smaller group an

300
00:09:44,480 --> 00:09:46,080
even smaller group and that way it's

301
00:09:46,080 --> 00:09:48,839
easy to categorize and understand

302
00:09:48,839 --> 00:09:50,240
information

303
00:09:50,240 --> 00:09:53,519
so use cases where is mqtt used

304
00:09:53,519 --> 00:09:55,519
honestly it's used just about everywhere

305
00:09:55,519 --> 00:09:56,880
iot is used

306
00:09:56,880 --> 00:09:59,040
um you can think of it in automotive

307
00:09:59,040 --> 00:10:00,080
instances

308
00:10:00,080 --> 00:10:03,519
uh manufacturing instances power grid

309
00:10:03,519 --> 00:10:06,320
healthcare cardiac monitors if you can

310
00:10:06,320 --> 00:10:08,560
think of an iot instance odds are

311
00:10:08,560 --> 00:10:11,600
mqtt is probably hanging out there

312
00:10:11,600 --> 00:10:14,480
which is great because it allows this

313
00:10:14,480 --> 00:10:16,640
protocol to be very standard

314
00:10:16,640 --> 00:10:19,360
but it also is bad when you start to

315
00:10:19,360 --> 00:10:20,720
think of some of the vulnerabilities

316
00:10:20,720 --> 00:10:22,800
that exist within it

317
00:10:22,800 --> 00:10:24,560
all right so let's talk about some of

318
00:10:24,560 --> 00:10:26,480
the types of attacks we can think on

319
00:10:26,480 --> 00:10:28,800
and this is where you know i as i said

320
00:10:28,800 --> 00:10:30,399
i'm a little new to iot but the good

321
00:10:30,399 --> 00:10:32,720
news is for those of us who came up

322
00:10:32,720 --> 00:10:34,800
you know older than we care to admit

323
00:10:34,800 --> 00:10:37,519
security doesn't really change that much

324
00:10:37,519 --> 00:10:39,360
it just is a different application of

325
00:10:39,360 --> 00:10:40,959
the same old principles

326
00:10:40,959 --> 00:10:43,600
so when we start to think of mqtt we

327
00:10:43,600 --> 00:10:45,519
look at denial of service attacks

328
00:10:45,519 --> 00:10:48,320
we look at poorer authentication we look

329
00:10:48,320 --> 00:10:49,120
at poor

330
00:10:49,120 --> 00:10:51,360
authorization we look at software

331
00:10:51,360 --> 00:10:53,440
vulnerabilities mqtt the broker

332
00:10:53,440 --> 00:10:55,440
is just an application like any other

333
00:10:55,440 --> 00:10:57,120
application

334
00:10:57,120 --> 00:10:59,120
transport security how do we actually

335
00:10:59,120 --> 00:11:00,720
protect the communication across the

336
00:11:00,720 --> 00:11:02,880
wire because remember that mqtt

337
00:11:02,880 --> 00:11:05,519
was not designed to be secure it has no

338
00:11:05,519 --> 00:11:06,640
native encryption

339
00:11:06,640 --> 00:11:08,399
in the application so all of the

340
00:11:08,399 --> 00:11:10,399
encryption has to be on the wire

341
00:11:10,399 --> 00:11:13,519
so deny all of service um basically i

342
00:11:13,519 --> 00:11:14,160
can do this

343
00:11:14,160 --> 00:11:16,079
by seizing all the available broker

344
00:11:16,079 --> 00:11:17,760
connections so basically just spamming

345
00:11:17,760 --> 00:11:18,399
the broker

346
00:11:18,399 --> 00:11:20,399
and consuming its ability to respond to

347
00:11:20,399 --> 00:11:21,920
authorized clients

348
00:11:21,920 --> 00:11:24,320
i can also spoof client ids to bump

349
00:11:24,320 --> 00:11:26,160
legitimate client ids off so

350
00:11:26,160 --> 00:11:28,240
one of the recommendations is that you

351
00:11:28,240 --> 00:11:30,399
have unique client identifiers which is

352
00:11:30,399 --> 00:11:31,360
great

353
00:11:31,360 --> 00:11:33,120
except if i can get your client

354
00:11:33,120 --> 00:11:35,440
identifier and get to the broker first

355
00:11:35,440 --> 00:11:37,360
it'll actually bump an authorized client

356
00:11:37,360 --> 00:11:37,680
off

357
00:11:37,680 --> 00:11:40,880
in favor of my request you can also do

358
00:11:40,880 --> 00:11:42,000
multiple unauthorized

359
00:11:42,000 --> 00:11:43,920
publish and subscribe so this assumes

360
00:11:43,920 --> 00:11:46,000
that you have some low-level credentials

361
00:11:46,000 --> 00:11:47,200
on the broker but

362
00:11:47,200 --> 00:11:48,640
you just keep trying to subscribe to

363
00:11:48,640 --> 00:11:50,560
topics that you're not authorized to and

364
00:11:50,560 --> 00:11:51,600
eventually the

365
00:11:51,600 --> 00:11:53,279
broker falls over and then there's

366
00:11:53,279 --> 00:11:55,680
malform packets uh this is again a very

367
00:11:55,680 --> 00:11:58,079
typical application security attack

368
00:11:58,079 --> 00:11:59,839
if you just start throwing bad packets

369
00:11:59,839 --> 00:12:01,839
at it eventually the broker crokes falls

370
00:12:01,839 --> 00:12:03,600
over and then because it's a star

371
00:12:03,600 --> 00:12:06,320
type network if you make the broker fall

372
00:12:06,320 --> 00:12:06,959
over

373
00:12:06,959 --> 00:12:10,160
everybody else falls over too poor

374
00:12:10,160 --> 00:12:11,120
authentication

375
00:12:11,120 --> 00:12:13,519
so again like i said by default there is

376
00:12:13,519 --> 00:12:14,880
no authentication

377
00:12:14,880 --> 00:12:16,079
they didn't add support for

378
00:12:16,079 --> 00:12:18,560
authentication until version 3.1

379
00:12:18,560 --> 00:12:21,200
uh version 5 is out now but it's still

380
00:12:21,200 --> 00:12:22,959
not required you can still

381
00:12:22,959 --> 00:12:24,639
when you install it you don't have to

382
00:12:24,639 --> 00:12:26,480
put any kind of authentication

383
00:12:26,480 --> 00:12:28,560
and the bad thing is that even if you do

384
00:12:28,560 --> 00:12:29,680
go the extra step

385
00:12:29,680 --> 00:12:32,480
of deploying authentication it's sent in

386
00:12:32,480 --> 00:12:34,160
the clear there's no native support for

387
00:12:34,160 --> 00:12:36,000
encryption

388
00:12:36,000 --> 00:12:37,600
when people deploy these think that

389
00:12:37,600 --> 00:12:39,200
they're deploying them to multiple

390
00:12:39,200 --> 00:12:40,720
millions of devices

391
00:12:40,720 --> 00:12:43,279
so doing individual user credentials can

392
00:12:43,279 --> 00:12:45,279
be really really hard so what happens a

393
00:12:45,279 --> 00:12:46,959
lot of times is that usernames and

394
00:12:46,959 --> 00:12:48,480
client ids

395
00:12:48,480 --> 00:12:50,480
are sourced from really easily guessable

396
00:12:50,480 --> 00:12:52,560
information like serial numbers

397
00:12:52,560 --> 00:12:55,920
or mac addresses or things that are

398
00:12:55,920 --> 00:12:58,880
very um sequential so user one user two

399
00:12:58,880 --> 00:12:59,760
user three

400
00:12:59,760 --> 00:13:02,320
things like that um you could also have

401
00:13:02,320 --> 00:13:03,600
a lot of default

402
00:13:03,600 --> 00:13:05,519
device credentials so even when people

403
00:13:05,519 --> 00:13:06,800
are trying to do the right thing with

404
00:13:06,800 --> 00:13:09,200
authentication and using certificates

405
00:13:09,200 --> 00:13:11,040
a lot of times they'll just use the same

406
00:13:11,040 --> 00:13:12,800
certificate for every single device on

407
00:13:12,800 --> 00:13:13,680
the network

408
00:13:13,680 --> 00:13:15,279
which if you're sitting in the middle of

409
00:13:15,279 --> 00:13:16,800
the network or you're able to gain

410
00:13:16,800 --> 00:13:18,240
access to the hardware

411
00:13:18,240 --> 00:13:19,839
you can then grab that certificate and

412
00:13:19,839 --> 00:13:23,040
become an authorized user

413
00:13:23,120 --> 00:13:24,560
all right so we've talked a lot about

414
00:13:24,560 --> 00:13:26,160
authentication now let's talk about

415
00:13:26,160 --> 00:13:27,200
authorization

416
00:13:27,200 --> 00:13:28,560
i think if anybody's worked in an

417
00:13:28,560 --> 00:13:29,920
enterprise environment you know that

418
00:13:29,920 --> 00:13:31,920
permissions are hard permissions

419
00:13:31,920 --> 00:13:34,079
are a lot of work and especially on a

420
00:13:34,079 --> 00:13:36,480
network of billions of devices with

421
00:13:36,480 --> 00:13:39,440
hundreds of topics it takes work to get

422
00:13:39,440 --> 00:13:41,360
really really good permissioning

423
00:13:41,360 --> 00:13:43,199
and unfortunately like in our

424
00:13:43,199 --> 00:13:44,800
traditional compute environments that

425
00:13:44,800 --> 00:13:45,760
doesn't always

426
00:13:45,760 --> 00:13:47,920
happen so a lot of times what happens is

427
00:13:47,920 --> 00:13:49,839
that they'll just allow any authorized

428
00:13:49,839 --> 00:13:50,560
person

429
00:13:50,560 --> 00:13:52,560
any i'm sorry any authenticated person

430
00:13:52,560 --> 00:13:54,720
to just subscribe to all the topics

431
00:13:54,720 --> 00:13:56,720
so that means if i can get a very low

432
00:13:56,720 --> 00:13:58,560
level let's say i take over a light bulb

433
00:13:58,560 --> 00:14:00,079
but i'm in an industrial

434
00:14:00,079 --> 00:14:02,959
setting i can maybe get topics on the

435
00:14:02,959 --> 00:14:04,320
manufacturing

436
00:14:04,320 --> 00:14:07,199
robots or i can get information on you

437
00:14:07,199 --> 00:14:08,800
know the power conduits for things that

438
00:14:08,800 --> 00:14:10,240
i'm not really supposed to be able to

439
00:14:10,240 --> 00:14:11,680
have as a light bulb

440
00:14:11,680 --> 00:14:14,160
um it also has a lot of support for wild

441
00:14:14,160 --> 00:14:15,040
cards

442
00:14:15,040 --> 00:14:17,199
um by the way that's my cat sorry she's

443
00:14:17,199 --> 00:14:18,320
fine she's not dying

444
00:14:18,320 --> 00:14:21,040
uh she just acts like it so wild cards

445
00:14:21,040 --> 00:14:22,639
are plus and hash so plush

446
00:14:22,639 --> 00:14:24,240
plus you can figure out if i don't know

447
00:14:24,240 --> 00:14:26,320
the root of the folder i put a plus

448
00:14:26,320 --> 00:14:27,760
hash is if i don't know the

449
00:14:27,760 --> 00:14:29,600
subdirectories so

450
00:14:29,600 --> 00:14:31,120
the reason it was designed like this is

451
00:14:31,120 --> 00:14:32,880
again it's supposed to be really easy to

452
00:14:32,880 --> 00:14:33,360
use

453
00:14:33,360 --> 00:14:35,040
which makes it really easy to hack

454
00:14:35,040 --> 00:14:37,040
unfortunately so

455
00:14:37,040 --> 00:14:38,720
the other problem we have is poor device

456
00:14:38,720 --> 00:14:41,040
segregation when i'm deploying something

457
00:14:41,040 --> 00:14:43,360
in an iot environment a lot of these

458
00:14:43,360 --> 00:14:45,440
networks are legacy they came from the

459
00:14:45,440 --> 00:14:48,000
idea of industrial iot spaces where your

460
00:14:48,000 --> 00:14:49,680
network was protected

461
00:14:49,680 --> 00:14:50,959
by the fact that it really wasn't

462
00:14:50,959 --> 00:14:53,279
connected to the world wide web

463
00:14:53,279 --> 00:14:55,360
it might have been connected to an

464
00:14:55,360 --> 00:14:57,040
internal network but you assume that

465
00:14:57,040 --> 00:14:58,800
anyone who could get into the building

466
00:14:58,800 --> 00:15:01,839
probably had off access to be there

467
00:15:01,839 --> 00:15:03,040
then we talked about software

468
00:15:03,040 --> 00:15:05,680
vulnerabilities so the mqtt broker

469
00:15:05,680 --> 00:15:06,800
doesn't have a ton of

470
00:15:06,800 --> 00:15:08,959
discovered vulnerabilities right now i

471
00:15:08,959 --> 00:15:11,199
expect that as it becomes more widely

472
00:15:11,199 --> 00:15:13,040
known and more widely adopted

473
00:15:13,040 --> 00:15:15,120
there'll be more cves published on it

474
00:15:15,120 --> 00:15:16,880
but the vulnerabilities that do exist

475
00:15:16,880 --> 00:15:18,560
are actually quite severe things like

476
00:15:18,560 --> 00:15:19,920
being able to gain

477
00:15:19,920 --> 00:15:22,160
all kinds of credentials or information

478
00:15:22,160 --> 00:15:23,120
disclosure

479
00:15:23,120 --> 00:15:24,880
so anytime you have an application

480
00:15:24,880 --> 00:15:26,240
that's record that's

481
00:15:26,240 --> 00:15:27,680
functioning like this you have the

482
00:15:27,680 --> 00:15:30,160
possibility that that application itself

483
00:15:30,160 --> 00:15:32,959
could be taken out uh you also have

484
00:15:32,959 --> 00:15:34,880
vulnerabilities in data aggregation and

485
00:15:34,880 --> 00:15:36,000
facilitation

486
00:15:36,000 --> 00:15:38,000
dashboards so if you use like i said a

487
00:15:38,000 --> 00:15:39,360
home automation solution

488
00:15:39,360 --> 00:15:41,279
or a home router a lot of times they'll

489
00:15:41,279 --> 00:15:42,720
have an admin console

490
00:15:42,720 --> 00:15:44,480
that aggregates this data for the user

491
00:15:44,480 --> 00:15:46,720
and that admin console may not actually

492
00:15:46,720 --> 00:15:47,120
have

493
00:15:47,120 --> 00:15:49,839
good authentication and authorization so

494
00:15:49,839 --> 00:15:51,759
you can log into the dashboard

495
00:15:51,759 --> 00:15:54,000
and then publish and subscribe to mqtt

496
00:15:54,000 --> 00:15:57,120
messages and topics

497
00:15:57,120 --> 00:15:58,800
so transport security we talked a little

498
00:15:58,800 --> 00:16:00,399
bit about this

499
00:16:00,399 --> 00:16:03,440
traditional mqtt environments are clear

500
00:16:03,440 --> 00:16:05,519
text over the wire so you really have to

501
00:16:05,519 --> 00:16:06,560
depend

502
00:16:06,560 --> 00:16:09,680
on the transport layer security which

503
00:16:09,680 --> 00:16:11,759
is hard in a small footprint device

504
00:16:11,759 --> 00:16:12,959
because encryption is

505
00:16:12,959 --> 00:16:15,440
costly especially modern encryption

506
00:16:15,440 --> 00:16:17,040
suites like tls

507
00:16:17,040 --> 00:16:19,199
they are very expensive to run over the

508
00:16:19,199 --> 00:16:20,480
wire so

509
00:16:20,480 --> 00:16:21,839
what happens is then you get these

510
00:16:21,839 --> 00:16:23,600
lightweight versions of cryptographic

511
00:16:23,600 --> 00:16:25,120
algorithms and some of them are really

512
00:16:25,120 --> 00:16:25,920
really great

513
00:16:25,920 --> 00:16:28,079
some of them are less great uh some of

514
00:16:28,079 --> 00:16:30,000
them by lightweight they actually just

515
00:16:30,000 --> 00:16:30,480
mean

516
00:16:30,480 --> 00:16:33,279
really cryptographically and secure uh

517
00:16:33,279 --> 00:16:34,720
one of the problems you run into

518
00:16:34,720 --> 00:16:36,000
especially when you're using

519
00:16:36,000 --> 00:16:37,440
the device itself to generate a

520
00:16:37,440 --> 00:16:39,440
certificate is that because it's low

521
00:16:39,440 --> 00:16:40,160
power

522
00:16:40,160 --> 00:16:42,800
it often lacks sufficient entropy to

523
00:16:42,800 --> 00:16:44,639
create truly random numbers so the

524
00:16:44,639 --> 00:16:47,040
certificates become easily guessable

525
00:16:47,040 --> 00:16:49,360
um basically just doing crypto without a

526
00:16:49,360 --> 00:16:50,720
lot of overhead compute

527
00:16:50,720 --> 00:16:54,160
is really hard to get right

528
00:16:54,240 --> 00:16:57,120
so where's the problem who cares if i

529
00:16:57,120 --> 00:16:59,440
can publish and subscribe to mqtt

530
00:16:59,440 --> 00:17:00,800
we assume that people are doing the

531
00:17:00,800 --> 00:17:02,800
right thing and you know at least doing

532
00:17:02,800 --> 00:17:05,280
the basics of security for those of you

533
00:17:05,280 --> 00:17:07,119
chuckling in the background who've been

534
00:17:07,119 --> 00:17:08,400
doing security for

535
00:17:08,400 --> 00:17:10,240
you know longer than 15 minutes you'll

536
00:17:10,240 --> 00:17:11,919
know that assuming that users are doing

537
00:17:11,919 --> 00:17:13,760
the right thing is probably a bad

538
00:17:13,760 --> 00:17:16,880
bet every time so we go over to

539
00:17:16,880 --> 00:17:19,679
a fun tool of hackers in iot everywhere

540
00:17:19,679 --> 00:17:20,799
showdam

541
00:17:20,799 --> 00:17:23,039
and we can search for iot devices that

542
00:17:23,039 --> 00:17:25,280
are listening on port 1883

543
00:17:25,280 --> 00:17:28,400
and that's the default port for mqtt

544
00:17:28,400 --> 00:17:30,640
brokers who operate without ssl

545
00:17:30,640 --> 00:17:32,559
we can also see if we can attempt to

546
00:17:32,559 --> 00:17:34,400
connect to sysbroker which is

547
00:17:34,400 --> 00:17:36,720
basically the default route of most mqtt

548
00:17:36,720 --> 00:17:37,679
brokers

549
00:17:37,679 --> 00:17:39,280
and if i can connect to that i can

550
00:17:39,280 --> 00:17:40,559
pretty much be assured that i can

551
00:17:40,559 --> 00:17:42,400
connect to everything else

552
00:17:42,400 --> 00:17:45,440
so when i did a scan of mqtt

553
00:17:45,440 --> 00:17:47,679
on showdown i came up with roughly 38

554
00:17:47,679 --> 00:17:49,200
000 results

555
00:17:49,200 --> 00:17:52,160
these are mqtt brokers across the world

556
00:17:52,160 --> 00:17:53,280
that

557
00:17:53,280 --> 00:17:55,120
have absolutely no authentication

558
00:17:55,120 --> 00:17:56,880
whatsoever we'll let you publish and

559
00:17:56,880 --> 00:17:58,400
subscribe to topics

560
00:17:58,400 --> 00:18:00,799
from anywhere on the internet no

561
00:18:00,799 --> 00:18:03,120
questions asked no passwords required

562
00:18:03,120 --> 00:18:06,000
um when you think about it in terms of

563
00:18:06,000 --> 00:18:08,320
total devices that number's not

564
00:18:08,320 --> 00:18:10,960
really that big but when you start to

565
00:18:10,960 --> 00:18:13,760
dig into these you'll see that these are

566
00:18:13,760 --> 00:18:16,799
healthcare instances and power grids and

567
00:18:16,799 --> 00:18:18,720
you know water dams and things that

568
00:18:18,720 --> 00:18:20,000
could potentially have

569
00:18:20,000 --> 00:18:22,640
very negative consequences if you were

570
00:18:22,640 --> 00:18:24,000
able to publish and subscribe to

571
00:18:24,000 --> 00:18:26,720
messages that you weren't supposed to

572
00:18:26,720 --> 00:18:29,360
um so now that i know this i was kind of

573
00:18:29,360 --> 00:18:30,160
like well okay

574
00:18:30,160 --> 00:18:32,960
i've got these 40 000 devices roughly

575
00:18:32,960 --> 00:18:34,160
well

576
00:18:34,160 --> 00:18:36,880
what do i do with it uh i'm too cheap to

577
00:18:36,880 --> 00:18:38,320
pay for a showdown subscription i think

578
00:18:38,320 --> 00:18:39,760
it's a fantastic tool

579
00:18:39,760 --> 00:18:42,559
um but it is quite pricey if you're

580
00:18:42,559 --> 00:18:44,720
gonna be running a lot of queries

581
00:18:44,720 --> 00:18:47,280
so i found this tool called mass scan

582
00:18:47,280 --> 00:18:49,039
and i am super in love with it

583
00:18:49,039 --> 00:18:51,360
it's like nmap on steroids and it's

584
00:18:51,360 --> 00:18:53,200
legitimately designed to scan

585
00:18:53,200 --> 00:18:56,240
the whole internet um it's published by

586
00:18:56,240 --> 00:18:56,880
robert

587
00:18:56,880 --> 00:18:58,799
davidgram you can get it at that github

588
00:18:58,799 --> 00:19:00,880
link it also works with common in-map

589
00:19:00,880 --> 00:19:02,240
syntax so if you

590
00:19:02,240 --> 00:19:04,400
have used nmap in the past this will be

591
00:19:04,400 --> 00:19:05,600
a really easy

592
00:19:05,600 --> 00:19:08,640
learning curve for you

593
00:19:08,640 --> 00:19:12,080
this is where i get to do my psa of the

594
00:19:12,080 --> 00:19:13,039
talk

595
00:19:13,039 --> 00:19:14,960
just because you can scan the whole

596
00:19:14,960 --> 00:19:16,400
internet don't

597
00:19:16,400 --> 00:19:19,120
scan the whole internet uh for folks

598
00:19:19,120 --> 00:19:20,799
that are starting out

599
00:19:20,799 --> 00:19:22,960
um this can be really tempting and even

600
00:19:22,960 --> 00:19:24,000
folks that have been doing this

601
00:19:24,000 --> 00:19:26,160
a long time remember that you should

602
00:19:26,160 --> 00:19:27,840
really only be scanning things that you

603
00:19:27,840 --> 00:19:29,360
have access to scan

604
00:19:29,360 --> 00:19:31,360
hopefully with a written pen test

605
00:19:31,360 --> 00:19:33,440
agreement

606
00:19:33,440 --> 00:19:35,520
and a clearly scoped agreement on what

607
00:19:35,520 --> 00:19:37,039
you can and can't touch

608
00:19:37,039 --> 00:19:38,559
there are parts of the internet that

609
00:19:38,559 --> 00:19:42,400
react extremely poorly to being scanned

610
00:19:42,400 --> 00:19:45,280
uh in 2016 there was a whole kerfuffle

611
00:19:45,280 --> 00:19:46,000
about

612
00:19:46,000 --> 00:19:47,600
people were trying to hack one of the

613
00:19:47,600 --> 00:19:49,440
state's election boards because they got

614
00:19:49,440 --> 00:19:51,200
an nmap scan

615
00:19:51,200 --> 00:19:52,720
maybe they were trying to hack it maybe

616
00:19:52,720 --> 00:19:54,480
it was a board script kitty i don't know

617
00:19:54,480 --> 00:19:56,400
and neither do they but nobody wants

618
00:19:56,400 --> 00:19:57,600
suits at your door

619
00:19:57,600 --> 00:20:00,320
asking why you tried to scan the mqtt

620
00:20:00,320 --> 00:20:01,760
broker for

621
00:20:01,760 --> 00:20:04,880
uh the power grid in alabama

622
00:20:04,880 --> 00:20:08,400
so but hypothetically if you work for a

623
00:20:08,400 --> 00:20:09,360
large

624
00:20:09,360 --> 00:20:12,240
cloud service provider um you might have

625
00:20:12,240 --> 00:20:14,720
access to a lot of ip addresses that you

626
00:20:14,720 --> 00:20:16,799
are within your purview to scan

627
00:20:16,799 --> 00:20:18,159
and so that's where mass scan can be

628
00:20:18,159 --> 00:20:20,000
really useful same if you're a pen

629
00:20:20,000 --> 00:20:21,280
tester working on one of these

630
00:20:21,280 --> 00:20:22,799
engagements with a cloud service or a

631
00:20:22,799 --> 00:20:25,120
very very large enterprise environment

632
00:20:25,120 --> 00:20:28,799
mascan can be super useful all right

633
00:20:28,799 --> 00:20:32,799
so this is a really boring screenshot of

634
00:20:32,799 --> 00:20:33,600
my

635
00:20:33,600 --> 00:20:37,919
math scan um this is where i confess

636
00:20:37,919 --> 00:20:39,280
that i made a typo

637
00:20:39,280 --> 00:20:42,320
and cider notation is is real fun and

638
00:20:42,320 --> 00:20:43,360
real finicky

639
00:20:43,360 --> 00:20:45,840
so if you make a typo sometimes instead

640
00:20:45,840 --> 00:20:48,000
of scanning 64 000 addresses

641
00:20:48,000 --> 00:20:51,760
you can scan 16 million addresses so

642
00:20:51,760 --> 00:20:53,840
shame to me i should not have done that

643
00:20:53,840 --> 00:20:55,120
that was an oops but

644
00:20:55,120 --> 00:20:57,280
you know now i have the data so i can't

645
00:20:57,280 --> 00:20:59,280
give it back so that's fine

646
00:20:59,280 --> 00:21:01,760
um so basically what you can do with

647
00:21:01,760 --> 00:21:03,840
this is you can figure out

648
00:21:03,840 --> 00:21:06,799
okay from that data i had 225 000 hosts

649
00:21:06,799 --> 00:21:07,600
that were alive

650
00:21:07,600 --> 00:21:10,159
225 000 hosts that responded back to me

651
00:21:10,159 --> 00:21:11,840
and either said yes that port is open

652
00:21:11,840 --> 00:21:14,960
no that port is closed of those 225

653
00:21:14,960 --> 00:21:17,919
000 i had roughly 2500 hosts that had

654
00:21:17,919 --> 00:21:19,280
either port open

655
00:21:19,280 --> 00:21:20,960
and then about a thousand hosts that had

656
00:21:20,960 --> 00:21:23,840
specifically port 1883 open

657
00:21:23,840 --> 00:21:27,200
now not saying you should disregard the

658
00:21:27,200 --> 00:21:28,480
remainder of

659
00:21:28,480 --> 00:21:31,520
those machines on 8883 but

660
00:21:31,520 --> 00:21:34,159
if you have limited time and limited um

661
00:21:34,159 --> 00:21:35,360
ability in your

662
00:21:35,360 --> 00:21:37,200
test environment and you really want to

663
00:21:37,200 --> 00:21:38,880
go after the low-hanging fruit

664
00:21:38,880 --> 00:21:41,280
i'd recommend just sticking with the um

665
00:21:41,280 --> 00:21:43,280
the non-tls version because it's just a

666
00:21:43,280 --> 00:21:44,159
little bit easier

667
00:21:44,159 --> 00:21:46,640
to hack and so you want to kind of take

668
00:21:46,640 --> 00:21:47,280
care of those

669
00:21:47,280 --> 00:21:48,960
things first and then move on to the

670
00:21:48,960 --> 00:21:50,880
harder challenges

671
00:21:50,880 --> 00:21:53,120
so now that i know sort of the hosts i

672
00:21:53,120 --> 00:21:54,640
would want to scan i have to become

673
00:21:54,640 --> 00:21:55,679
really familiar with how

674
00:21:55,679 --> 00:21:58,720
mqtt actually responds and how it

675
00:21:58,720 --> 00:22:00,880
responds much like http is with response

676
00:22:00,880 --> 00:22:01,760
codes

677
00:22:01,760 --> 00:22:03,679
um and this is the list of the response

678
00:22:03,679 --> 00:22:05,760
codes and the the goal or the thing you

679
00:22:05,760 --> 00:22:06,799
hope to get

680
00:22:06,799 --> 00:22:08,960
is zero connection accepted right so i

681
00:22:08,960 --> 00:22:10,559
wrote this little python script

682
00:22:10,559 --> 00:22:12,320
uh this is just a snippet of it

683
00:22:12,320 --> 00:22:14,400
basically you can iterate through a list

684
00:22:14,400 --> 00:22:17,520
of ip addresses um connect to the mqtt

685
00:22:17,520 --> 00:22:19,120
port on 1883

686
00:22:19,120 --> 00:22:21,360
see if you get a reset uh or an rc code

687
00:22:21,360 --> 00:22:22,559
zero back and if it

688
00:22:22,559 --> 00:22:24,320
is then that is probably a host that

689
00:22:24,320 --> 00:22:26,000
will allow you to kind of dig in and

690
00:22:26,000 --> 00:22:29,280
manipulate stuff around

691
00:22:30,240 --> 00:22:32,480
now that's not to say that you should

692
00:22:32,480 --> 00:22:34,640
disregard any other of these return code

693
00:22:34,640 --> 00:22:35,760
responses because

694
00:22:35,760 --> 00:22:38,080
for example if you get a number two code

695
00:22:38,080 --> 00:22:40,799
back it means the connection was refused

696
00:22:40,799 --> 00:22:42,400
but just because your identifier was

697
00:22:42,400 --> 00:22:44,320
wrong so that means that they have some

698
00:22:44,320 --> 00:22:46,080
kind of client id scheme that they're

699
00:22:46,080 --> 00:22:47,360
enforcing

700
00:22:47,360 --> 00:22:50,080
if you're able to figure out what it is

701
00:22:50,080 --> 00:22:51,440
it's possible that that's all they're

702
00:22:51,440 --> 00:22:53,360
doing is just a client id

703
00:22:53,360 --> 00:22:55,840
one of the interesting things about mqtt

704
00:22:55,840 --> 00:22:56,400
is that

705
00:22:56,400 --> 00:22:58,320
you can set a username with no password

706
00:22:58,320 --> 00:23:00,159
so you just because their username or a

707
00:23:00,159 --> 00:23:01,760
client id exists doesn't actually mean

708
00:23:01,760 --> 00:23:03,520
it's protected in any real way

709
00:23:03,520 --> 00:23:06,400
so you may be able to either guess from

710
00:23:06,400 --> 00:23:08,080
a serial number or guess from a mac

711
00:23:08,080 --> 00:23:09,280
address or just start

712
00:23:09,280 --> 00:23:12,240
trying things until it lets you in um

713
00:23:12,240 --> 00:23:13,039
same thing with

714
00:23:13,039 --> 00:23:16,400
bad username or password um

715
00:23:16,400 --> 00:23:17,679
you can just start trying a lot of

716
00:23:17,679 --> 00:23:20,080
passwords i'm sure if you have been

717
00:23:20,080 --> 00:23:21,600
around security for a minute you'll know

718
00:23:21,600 --> 00:23:23,520
that password one two three and admin

719
00:23:23,520 --> 00:23:25,520
admin and all of those things are still

720
00:23:25,520 --> 00:23:28,240
pretty much the same uh so don't just

721
00:23:28,240 --> 00:23:30,559
disregard them unless you're on a really

722
00:23:30,559 --> 00:23:32,400
limited time engagement but for this

723
00:23:32,400 --> 00:23:34,840
particular

724
00:23:34,840 --> 00:23:38,720
example i

725
00:23:38,720 --> 00:23:40,720
accepted uh just kind of see what i

726
00:23:40,720 --> 00:23:42,000
could muck around with

727
00:23:42,000 --> 00:23:43,760
so i spent some time playing with pajo

728
00:23:43,760 --> 00:23:45,360
mqtt and

729
00:23:45,360 --> 00:23:48,480
um i'm much more the engineer that likes

730
00:23:48,480 --> 00:23:50,000
to grab other people's code and see if i

731
00:23:50,000 --> 00:23:51,760
can modify it and actually write my own

732
00:23:51,760 --> 00:23:53,279
code that's just really more my style

733
00:23:53,279 --> 00:23:54,559
because i'm a little bit lazy

734
00:23:54,559 --> 00:23:56,240
and i found this awesome awesome tool

735
00:23:56,240 --> 00:23:58,400
called mqtt pwn by akamai

736
00:23:58,400 --> 00:24:00,159
highly highly recommend that downloading

737
00:24:00,159 --> 00:24:01,520
it if you're gonna get into this area of

738
00:24:01,520 --> 00:24:02,400
research it's

739
00:24:02,400 --> 00:24:05,200
so so so much fun uh and it's also

740
00:24:05,200 --> 00:24:07,440
really easy because it comes there's two

741
00:24:07,440 --> 00:24:08,960
variants you can use you can use it

742
00:24:08,960 --> 00:24:11,360
locally uh with python

743
00:24:11,360 --> 00:24:13,520
or you can use it in a docker container

744
00:24:13,520 --> 00:24:15,120
and the docker container is

745
00:24:15,120 --> 00:24:17,200
magical i love it so much i cannot

746
00:24:17,200 --> 00:24:19,120
understand how much i love this tool

747
00:24:19,120 --> 00:24:21,600
um it has modules for brute forcing

748
00:24:21,600 --> 00:24:23,520
username and passwords it has a module

749
00:24:23,520 --> 00:24:25,679
for sort of creating your own botnets

750
00:24:25,679 --> 00:24:28,240
it has a module for topic enumeration

751
00:24:28,240 --> 00:24:29,440
reconnaissance

752
00:24:29,440 --> 00:24:30,799
basically anything you'd want to do in

753
00:24:30,799 --> 00:24:33,279
the mqtt space is probably in this tool

754
00:24:33,279 --> 00:24:33,919
and it's just

755
00:24:33,919 --> 00:24:37,120
really really well written um so

756
00:24:37,120 --> 00:24:38,720
one of the things i started to do was

757
00:24:38,720 --> 00:24:40,320
look at topic enumeration because i

758
00:24:40,320 --> 00:24:42,000
specifically wanted to know

759
00:24:42,000 --> 00:24:44,080
what types of information i could grab

760
00:24:44,080 --> 00:24:45,760
from these hosts that were allowing me

761
00:24:45,760 --> 00:24:47,200
to connect to them

762
00:24:47,200 --> 00:24:50,240
so this is just a snapshot from one of

763
00:24:50,240 --> 00:24:52,080
the services that i was able to grab

764
00:24:52,080 --> 00:24:55,039
kind of in the middle mainly because uh

765
00:24:55,039 --> 00:24:55,840
this host

766
00:24:55,840 --> 00:24:58,240
uh the top ones were the top ones were

767
00:24:58,240 --> 00:24:59,679
kind of very specific about what kind of

768
00:24:59,679 --> 00:25:01,760
host it was and i didn't really want to

769
00:25:01,760 --> 00:25:03,600
put that in a slide deck but you can see

770
00:25:03,600 --> 00:25:05,360
here that i can subscribe to all of the

771
00:25:05,360 --> 00:25:07,520
messages received in the last 15 minutes

772
00:25:07,520 --> 00:25:09,360
all the messages sent in the last 15

773
00:25:09,360 --> 00:25:11,120
minutes so that would be really useful

774
00:25:11,120 --> 00:25:12,720
information for me

775
00:25:12,720 --> 00:25:14,799
um it allows me to kind of figure out

776
00:25:14,799 --> 00:25:16,799
what this actual machine does what the

777
00:25:16,799 --> 00:25:17,919
broker is doing

778
00:25:17,919 --> 00:25:20,640
and then also what kind of information i

779
00:25:20,640 --> 00:25:21,039
can

780
00:25:21,039 --> 00:25:24,720
get from it so

781
00:25:24,720 --> 00:25:28,559
real world use cases i could talk to you

782
00:25:28,559 --> 00:25:29,120
today

783
00:25:29,120 --> 00:25:32,320
about really important things like power

784
00:25:32,320 --> 00:25:33,679
grid or

785
00:25:33,679 --> 00:25:35,840
how you know hospitals could be

786
00:25:35,840 --> 00:25:38,080
overtaken by you know rogue published

787
00:25:38,080 --> 00:25:39,520
messages

788
00:25:39,520 --> 00:25:42,400
uh how dams could be opened in flood

789
00:25:42,400 --> 00:25:43,039
cities

790
00:25:43,039 --> 00:25:44,320
but i don't want to talk to you about

791
00:25:44,320 --> 00:25:45,679
that today i want to talk to you about

792
00:25:45,679 --> 00:25:48,080
something even more important

793
00:25:48,080 --> 00:25:49,520
i want to talk about the internet of

794
00:25:49,520 --> 00:25:51,520
cows because i feel like this just

795
00:25:51,520 --> 00:25:53,120
doesn't get the news coverage that it

796
00:25:53,120 --> 00:25:54,799
deserves

797
00:25:54,799 --> 00:25:57,360
so there is this is a true story i'm not

798
00:25:57,360 --> 00:25:58,880
making this up you can google it after

799
00:25:58,880 --> 00:26:00,720
this talk internet of cows it's a real

800
00:26:00,720 --> 00:26:01,120
thing

801
00:26:01,120 --> 00:26:03,120
cows are becoming increasingly more

802
00:26:03,120 --> 00:26:05,600
connected to the world wide web

803
00:26:05,600 --> 00:26:09,120
um a particular company makes a

804
00:26:09,120 --> 00:26:11,440
device that is basically like a remote

805
00:26:11,440 --> 00:26:13,279
cow steering device if you can think of

806
00:26:13,279 --> 00:26:15,120
it it sits on the cow's back and sort of

807
00:26:15,120 --> 00:26:16,880
nudges them when they get

808
00:26:16,880 --> 00:26:19,440
off-piste so the gps will kind of set

809
00:26:19,440 --> 00:26:20,799
back to the controller it's like hey

810
00:26:20,799 --> 00:26:22,240
you're not supposed to be there and

811
00:26:22,240 --> 00:26:25,360
it nudges the cow and the cow walks away

812
00:26:25,360 --> 00:26:28,799
uh a lot of these don't have the

813
00:26:28,799 --> 00:26:31,520
best security uh don't have the best

814
00:26:31,520 --> 00:26:33,360
implementation of these protocols

815
00:26:33,360 --> 00:26:36,400
and so imagine if you will that you

816
00:26:36,400 --> 00:26:38,080
could disable the tracking and guidance

817
00:26:38,080 --> 00:26:39,840
system so now you have cows sort of

818
00:26:39,840 --> 00:26:42,000
loose on the prairie running around

819
00:26:42,000 --> 00:26:44,159
or maybe you know you just do it to

820
00:26:44,159 --> 00:26:45,600
annoy the cow if you're a really crappy

821
00:26:45,600 --> 00:26:46,400
person

822
00:26:46,400 --> 00:26:50,320
um but what if what if

823
00:26:50,320 --> 00:26:52,640
i could get access to the guidance

824
00:26:52,640 --> 00:26:56,240
system and drive these herds of cows

825
00:26:56,240 --> 00:26:58,880
and create the internet of zombie cows

826
00:26:58,880 --> 00:26:59,919
think of that

827
00:26:59,919 --> 00:27:01,200
think of that when you go to sleep

828
00:27:01,200 --> 00:27:03,760
tonight about why iot is important

829
00:27:03,760 --> 00:27:05,520
do you want to get attacked by zombie

830
00:27:05,520 --> 00:27:07,200
cows no you do not

831
00:27:07,200 --> 00:27:10,240
so that's why iot imp security is so

832
00:27:10,240 --> 00:27:12,159
very important

833
00:27:12,159 --> 00:27:13,679
all right but the good news is it's

834
00:27:13,679 --> 00:27:15,200
getting better it's don't worry it's in

835
00:27:15,200 --> 00:27:15,919
the cloud

836
00:27:15,919 --> 00:27:17,279
everything is awesome in the cloud

837
00:27:17,279 --> 00:27:19,679
that's everything is awesome it's in the

838
00:27:19,679 --> 00:27:20,640
cloud

839
00:27:20,640 --> 00:27:22,320
there is part of that that's really true

840
00:27:22,320 --> 00:27:23,679
um because a lot of

841
00:27:23,679 --> 00:27:25,919
devices are migrating to cloud services

842
00:27:25,919 --> 00:27:28,159
cloud services are able to make security

843
00:27:28,159 --> 00:27:30,720
easier to onboard to and less friction

844
00:27:30,720 --> 00:27:32,559
tls and ssl enforcement is

845
00:27:32,559 --> 00:27:34,960
much more broadly adopted by people who

846
00:27:34,960 --> 00:27:36,799
are entering the space because they make

847
00:27:36,799 --> 00:27:38,480
it a requirement to onboard to most

848
00:27:38,480 --> 00:27:40,080
cloud service providers

849
00:27:40,080 --> 00:27:42,799
um the better mqtt you'll notice i make

850
00:27:42,799 --> 00:27:44,480
this typo a lot it was a typo in the

851
00:27:44,480 --> 00:27:45,360
slide

852
00:27:45,360 --> 00:27:48,720
or in the topic i am really dyslexic and

853
00:27:48,720 --> 00:27:49,760
i do

854
00:27:49,760 --> 00:27:52,960
not well double comments mqtt broker

855
00:27:52,960 --> 00:27:54,480
defaults are a lot better in the cloud

856
00:27:54,480 --> 00:27:55,840
because they're managed by cloud service

857
00:27:55,840 --> 00:27:56,720
providers

858
00:27:56,720 --> 00:27:58,559
um there's also the ability to use a lot

859
00:27:58,559 --> 00:28:01,039
more detection and automation

860
00:28:01,039 --> 00:28:03,279
uh because you get access to cloud

861
00:28:03,279 --> 00:28:04,240
services that

862
00:28:04,240 --> 00:28:07,120
monitor your logs and send alerts and

863
00:28:07,120 --> 00:28:08,720
can kind of protect you from ddos in the

864
00:28:08,720 --> 00:28:09,600
on the cloud layer

865
00:28:09,600 --> 00:28:12,720
so it's it's it is better there are

866
00:28:12,720 --> 00:28:14,240
things that are better but there are

867
00:28:14,240 --> 00:28:15,600
potential downsides

868
00:28:15,600 --> 00:28:17,120
cloud environments are highly

869
00:28:17,120 --> 00:28:18,799
configurable which is good that's a good

870
00:28:18,799 --> 00:28:20,320
thing right we want to make it easy for

871
00:28:20,320 --> 00:28:22,159
the customer to join and onboard to the

872
00:28:22,159 --> 00:28:23,279
cloud

873
00:28:23,279 --> 00:28:25,679
but if you worked with users you know

874
00:28:25,679 --> 00:28:27,919
that if you give them the possibility to

875
00:28:27,919 --> 00:28:29,279
undo security

876
00:28:29,279 --> 00:28:30,960
there will be a situation where it

877
00:28:30,960 --> 00:28:33,440
happens so the cloud kind of does make

878
00:28:33,440 --> 00:28:35,360
it easier to do bad things

879
00:28:35,360 --> 00:28:38,000
at scale it means that you can now

880
00:28:38,000 --> 00:28:39,919
connect billions and billions of devices

881
00:28:39,919 --> 00:28:41,760
and then turn off all the security

882
00:28:41,760 --> 00:28:44,640
which is bad um you can imagine that

883
00:28:44,640 --> 00:28:45,360
systems

884
00:28:45,360 --> 00:28:46,960
may not be designed with the appropriate

885
00:28:46,960 --> 00:28:48,880
redundancy if you're relying on the

886
00:28:48,880 --> 00:28:51,200
cloud for your mqtt broker services

887
00:28:51,200 --> 00:28:54,080
say in a factory you really have to

888
00:28:54,080 --> 00:28:55,360
think about what you do

889
00:28:55,360 --> 00:28:57,440
when the cloud is down and if there's a

890
00:28:57,440 --> 00:28:58,720
cloud outage

891
00:28:58,720 --> 00:29:01,200
uh it's something that people are really

892
00:29:01,200 --> 00:29:02,480
starting to grapple with

893
00:29:02,480 --> 00:29:04,559
now as they move their iot installations

894
00:29:04,559 --> 00:29:05,919
to the cloud and it's something they

895
00:29:05,919 --> 00:29:07,279
have to be really careful with when

896
00:29:07,279 --> 00:29:10,159
they're designing their systems

897
00:29:10,159 --> 00:29:12,960
so key takeaways mqtt is a lightweight

898
00:29:12,960 --> 00:29:15,120
widely adopted protocol used for iot

899
00:29:15,120 --> 00:29:16,960
publish and subscribe actions

900
00:29:16,960 --> 00:29:19,279
it can be and often is insecure because

901
00:29:19,279 --> 00:29:21,120
it doesn't support security

902
00:29:21,120 --> 00:29:23,039
security natively except for username

903
00:29:23,039 --> 00:29:25,600
and password which is set in clear text

904
00:29:25,600 --> 00:29:28,159
when deploying iot devices with mqtt

905
00:29:28,159 --> 00:29:30,159
brokers it's highly recommended that you

906
00:29:30,159 --> 00:29:32,159
use over-the-wire encryption

907
00:29:32,159 --> 00:29:34,159
and also on device encryption because if

908
00:29:34,159 --> 00:29:36,080
i can get your username and password by

909
00:29:36,080 --> 00:29:37,360
getting one of your devices

910
00:29:37,360 --> 00:29:39,679
odds are i can still get to your broker

911
00:29:39,679 --> 00:29:42,080
um the ideal situation is that you have

912
00:29:42,080 --> 00:29:44,559
very specific access control policies

913
00:29:44,559 --> 00:29:46,000
and device certificates

914
00:29:46,000 --> 00:29:48,399
per device so that your light bulbs

915
00:29:48,399 --> 00:29:49,760
can't access your garage door and your

916
00:29:49,760 --> 00:29:51,520
garage door can't access your coffee pot

917
00:29:51,520 --> 00:29:53,440
and so on and so forth

918
00:29:53,440 --> 00:29:56,399
um resources i will be putting the

919
00:29:56,399 --> 00:29:57,200
slides up

920
00:29:57,200 --> 00:29:59,600
on my website which is very very tragic

921
00:29:59,600 --> 00:30:00,559
right now it's really just

922
00:30:00,559 --> 00:30:02,799
a place where i dump my slides uh but

923
00:30:02,799 --> 00:30:05,279
mass scan is the tool that i used to

924
00:30:05,279 --> 00:30:06,640
enumerate some of these hosts

925
00:30:06,640 --> 00:30:09,360
mqtt pwn i talked about that's the the

926
00:30:09,360 --> 00:30:11,200
repository where you can get it

927
00:30:11,200 --> 00:30:13,440
um i also if you're looking to get into

928
00:30:13,440 --> 00:30:15,120
iot and you you really

929
00:30:15,120 --> 00:30:18,399
haven't um had a chance i really really

930
00:30:18,399 --> 00:30:20,080
love this instructables

931
00:30:20,080 --> 00:30:23,120
uh document i think it's four or five

932
00:30:23,120 --> 00:30:24,480
parts it walks you through creating an

933
00:30:24,480 --> 00:30:26,399
iot device with raspberry pi setting up

934
00:30:26,399 --> 00:30:28,080
an mqtt broker

935
00:30:28,080 --> 00:30:29,760
and then hopefully once you get that set

936
00:30:29,760 --> 00:30:31,520
up you can use mqtt phone and kind of

937
00:30:31,520 --> 00:30:33,200
play around and figure out

938
00:30:33,200 --> 00:30:36,080
the vulnerabilities in mqtt yourself uh

939
00:30:36,080 --> 00:30:37,039
you can follow me

940
00:30:37,039 --> 00:30:40,080
at that security check on twitter

941
00:30:40,080 --> 00:30:51,840
and that is the end of my presentation

942
00:30:51,840 --> 00:30:53,918
you

