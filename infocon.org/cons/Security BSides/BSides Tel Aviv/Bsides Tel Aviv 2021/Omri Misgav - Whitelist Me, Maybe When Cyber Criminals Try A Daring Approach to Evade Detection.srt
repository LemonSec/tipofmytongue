1
00:00:00,000 --> 00:00:03,120
and now i'm going to invite our next

2
00:00:03,120 --> 00:00:03,840
speaker

3
00:00:03,840 --> 00:00:06,640
who is a returned speaker to besides tel

4
00:00:06,640 --> 00:00:07,359
aviv

5
00:00:07,359 --> 00:00:10,719
our next speaker is omri misgov

6
00:00:10,719 --> 00:00:13,599
omri is the cto can yes you can join me

7
00:00:13,599 --> 00:00:14,000
here

8
00:00:14,000 --> 00:00:16,160
2 meters apart for socially distance

9
00:00:16,160 --> 00:00:17,680
omri is the cto

10
00:00:17,680 --> 00:00:20,560
of the security threat research group at

11
00:00:20,560 --> 00:00:21,600
fortinet

12
00:00:21,600 --> 00:00:24,560
and he's focused on operating system os

13
00:00:24,560 --> 00:00:25,359
internals

14
00:00:25,359 --> 00:00:27,840
now he's spoken besides tel aviv before

15
00:00:27,840 --> 00:00:28,560
but now

16
00:00:28,560 --> 00:00:31,599
he's going to talk to us about some very

17
00:00:31,599 --> 00:00:34,559
clever some very creative criminals who

18
00:00:34,559 --> 00:00:35,680
want to get

19
00:00:35,680 --> 00:00:39,120
into his white list let's welcome hombre

20
00:00:39,120 --> 00:00:42,160
to the beside serving stage everyone

21
00:00:42,160 --> 00:00:45,840
hi everyone so first thing first

22
00:00:45,840 --> 00:00:50,079
cheers disinfectant

23
00:00:50,079 --> 00:00:52,480
thank you

24
00:00:53,440 --> 00:00:56,960
okay good morning i'm happy

25
00:00:56,960 --> 00:00:58,719
very happy to be here my name is

26
00:00:58,719 --> 00:01:01,520
guaranty introduced me i won't

27
00:01:01,520 --> 00:01:03,760
do the introductions again uh the

28
00:01:03,760 --> 00:01:06,080
research i'm going to talk about today

29
00:01:06,080 --> 00:01:09,680
um that we did was led by rotem

30
00:01:09,680 --> 00:01:12,799
our malware research team lead

31
00:01:12,799 --> 00:01:14,880
he's here in the crowd and you can also

32
00:01:14,880 --> 00:01:16,000
find him in the booth

33
00:01:16,000 --> 00:01:19,280
in our booth today so if you feel free

34
00:01:19,280 --> 00:01:21,040
if you can feel free later on to give

35
00:01:21,040 --> 00:01:24,610
him high five for the great work

36
00:01:24,610 --> 00:01:25,680
[Music]

37
00:01:25,680 --> 00:01:27,280
so we today i'm going to talk to you

38
00:01:27,280 --> 00:01:29,119
about an interesting case we had earlier

39
00:01:29,119 --> 00:01:29,920
this year

40
00:01:29,920 --> 00:01:32,240
uh when basically cyber criminals

41
00:01:32,240 --> 00:01:33,360
decided to

42
00:01:33,360 --> 00:01:35,680
hand us their malware and ask us very

43
00:01:35,680 --> 00:01:36,560
nicely

44
00:01:36,560 --> 00:01:39,680
um to remove our detection from it

45
00:01:39,680 --> 00:01:41,840
because it bothered them we'll talk

46
00:01:41,840 --> 00:01:43,920
about how we what we investigated

47
00:01:43,920 --> 00:01:46,799
how they approached us and everything we

48
00:01:46,799 --> 00:01:48,799
found later on

49
00:01:48,799 --> 00:01:52,840
uh which eventually led us to discover

50
00:01:52,840 --> 00:01:54,720
uh

51
00:01:54,720 --> 00:01:57,759
malware delivery infrastructure

52
00:01:57,759 --> 00:02:00,640
which is written in written in golang so

53
00:02:00,640 --> 00:02:01,680
at least

54
00:02:01,680 --> 00:02:04,719
regarding the conference agenda today

55
00:02:04,719 --> 00:02:06,320
somebody really knew

56
00:02:06,320 --> 00:02:09,598
what he did with the with the timing

57
00:02:09,598 --> 00:02:13,200
um but before we begin just

58
00:02:13,200 --> 00:02:16,480
one warning um as i compiled the slides

59
00:02:16,480 --> 00:02:17,920
i realized i'm

60
00:02:17,920 --> 00:02:22,879
really really bad the graphic designer

61
00:02:22,879 --> 00:02:26,560
yeah so we prepared

62
00:02:26,560 --> 00:02:30,720
we preferred to put our money um

63
00:02:30,720 --> 00:02:33,440
for for like for the ice cream that we

64
00:02:33,440 --> 00:02:34,800
give out in our booth so

65
00:02:34,800 --> 00:02:36,879
feel free to grab the scope later on i

66
00:02:36,879 --> 00:02:39,120
think it's a much better

67
00:02:39,120 --> 00:02:41,840
location of our resources than using

68
00:02:41,840 --> 00:02:44,640
graphic designer

69
00:02:44,800 --> 00:02:48,000
and so let's begin so

70
00:02:48,000 --> 00:02:50,239
you can see here we got an email that we

71
00:02:50,239 --> 00:02:51,840
got it was on

72
00:02:51,840 --> 00:02:54,560
february uh the email was sent to the

73
00:02:54,560 --> 00:02:56,800
ceo and cto of the company

74
00:02:56,800 --> 00:02:59,599
uh ken and michael and another and a few

75
00:02:59,599 --> 00:03:00,800
other sea level

76
00:03:00,800 --> 00:03:04,159
executives um if we go over it briefly

77
00:03:04,159 --> 00:03:08,560
so i read it really really quickly

78
00:03:08,560 --> 00:03:11,280
i was referred to ken by ted kim no idea

79
00:03:11,280 --> 00:03:12,959
who it is

80
00:03:12,959 --> 00:03:16,080
and advised that this team could help

81
00:03:16,080 --> 00:03:17,440
with an urgent issue

82
00:03:17,440 --> 00:03:20,400
we have it at our company we are

83
00:03:20,400 --> 00:03:22,159
suffering from false positive on our

84
00:03:22,159 --> 00:03:23,920
application update and it's hurting our

85
00:03:23,920 --> 00:03:24,959
business

86
00:03:24,959 --> 00:03:29,680
uh heavily you're finding

87
00:03:29,680 --> 00:03:32,480
false positive in our software states as

88
00:03:32,480 --> 00:03:33,920
such and such

89
00:03:33,920 --> 00:03:36,640
how can we work together so we can get

90
00:03:36,640 --> 00:03:38,080
whitelisted for the future

91
00:03:38,080 --> 00:03:40,159
and avoid false positives or company

92
00:03:40,159 --> 00:03:42,159
image

93
00:03:42,159 --> 00:03:45,120
and a user and and for the company image

94
00:03:45,120 --> 00:03:46,480
won't earth and we have

95
00:03:46,480 --> 00:03:48,640
further installations you can find the

96
00:03:48,640 --> 00:03:50,080
download here

97
00:03:50,080 --> 00:03:54,000
the link to download here just take it

98
00:03:54,000 --> 00:03:55,920
we also run it in vt and you can see

99
00:03:55,920 --> 00:03:59,040
that we are not bluffing

100
00:03:59,040 --> 00:04:02,000
pretty much and uh well that that

101
00:04:02,000 --> 00:04:03,040
concluded

102
00:04:03,040 --> 00:04:05,439
uh so we had no idea what the sender was

103
00:04:05,439 --> 00:04:06,080
again

104
00:04:06,080 --> 00:04:08,799
um we had no idea with this ted kim that

105
00:04:08,799 --> 00:04:10,159
referred to us

106
00:04:10,159 --> 00:04:12,840
um but you can see all the grammar

107
00:04:12,840 --> 00:04:15,599
mistakes uppercase lowercase and space

108
00:04:15,599 --> 00:04:18,639
and extra spacing all over the place

109
00:04:18,639 --> 00:04:21,120
so we decided to start having a look

110
00:04:21,120 --> 00:04:22,639
first thing we did

111
00:04:22,639 --> 00:04:27,199
was doing forensics on the email message

112
00:04:27,199 --> 00:04:29,040
we checked the structure there wasn't

113
00:04:29,040 --> 00:04:30,960
any extra data

114
00:04:30,960 --> 00:04:34,080
any attachments or whatever uh

115
00:04:34,080 --> 00:04:36,560
and the link the text of the link was

116
00:04:36,560 --> 00:04:38,080
the same as the address

117
00:04:38,080 --> 00:04:42,320
so nobody tried to play to play with us

118
00:04:42,320 --> 00:04:44,639
next we looked at the headers to the

119
00:04:44,639 --> 00:04:46,800
smtp headers to see from where the

120
00:04:46,800 --> 00:04:50,400
email came from everything was checked

121
00:04:50,400 --> 00:04:50,960
out

122
00:04:50,960 --> 00:04:53,360
all the servers on the way seemed

123
00:04:53,360 --> 00:04:54,320
trusted

124
00:04:54,320 --> 00:04:57,840
well known no signature was a mess to it

125
00:04:57,840 --> 00:05:00,720
the data wasn't changed during transit

126
00:05:00,720 --> 00:05:02,880
but it did came from a custom mailing

127
00:05:02,880 --> 00:05:03,759
app

128
00:05:03,759 --> 00:05:07,360
which wasn't really familiar

129
00:05:07,360 --> 00:05:10,320
so now we have to decide what to do next

130
00:05:10,320 --> 00:05:11,919
um so

131
00:05:11,919 --> 00:05:14,400
well we kind of click the link as one

132
00:05:14,400 --> 00:05:16,240
would expect

133
00:05:16,240 --> 00:05:19,600
we reached the site that promised us

134
00:05:19,600 --> 00:05:22,080
good money without doing anything which

135
00:05:22,080 --> 00:05:22,800
is also

136
00:05:22,800 --> 00:05:26,479
always sounds like a great promise um

137
00:05:26,479 --> 00:05:29,919
why not actually and then we started

138
00:05:29,919 --> 00:05:31,440
looking for the

139
00:05:31,440 --> 00:05:34,320
for the same link that we were sent but

140
00:05:34,320 --> 00:05:36,240
we didn't find it

141
00:05:36,240 --> 00:05:39,600
instead we could see that the download

142
00:05:39,600 --> 00:05:41,759
link that you can see here

143
00:05:41,759 --> 00:05:44,880
led to a different url this the files

144
00:05:44,880 --> 00:05:46,720
that we got was

145
00:05:46,720 --> 00:05:48,880
were in totally different sizes and

146
00:05:48,880 --> 00:05:51,360
significantly different sizes

147
00:05:51,360 --> 00:05:53,039
when we started looking at them we saw

148
00:05:53,039 --> 00:05:55,360
that they have different icons

149
00:05:55,360 --> 00:05:58,960
um they were totally different uh

150
00:05:58,960 --> 00:06:01,520
software one is what was in what the

151
00:06:01,520 --> 00:06:03,440
file that we got was in golang

152
00:06:03,440 --> 00:06:05,039
and from the file we got from the

153
00:06:05,039 --> 00:06:08,400
website was anansis installer for an ogs

154
00:06:08,400 --> 00:06:10,800
application

155
00:06:10,800 --> 00:06:12,880
and they were both of the files were

156
00:06:12,880 --> 00:06:15,650
signed with the same certificate

157
00:06:15,650 --> 00:06:17,520
[Music]

158
00:06:17,520 --> 00:06:19,759
so we had to when we move forward we

159
00:06:19,759 --> 00:06:20,720
started looking at

160
00:06:20,720 --> 00:06:23,520
the signatures to see if this file was

161
00:06:23,520 --> 00:06:24,960
somehow altered or

162
00:06:24,960 --> 00:06:29,120
what not even though you see that the

163
00:06:29,120 --> 00:06:32,160
certificate is isn't valid it was

164
00:06:32,160 --> 00:06:34,319
because it was revoked

165
00:06:34,319 --> 00:06:36,720
but for at least a certain period of

166
00:06:36,720 --> 00:06:40,400
time it was valid as we can see

167
00:06:40,400 --> 00:06:44,880
the the original on the right the

168
00:06:44,880 --> 00:06:46,720
file we got from the site the official

169
00:06:46,720 --> 00:06:49,360
installer as we call it

170
00:06:49,360 --> 00:06:51,919
was signed with a timestamp so it means

171
00:06:51,919 --> 00:06:53,440
that somebody else validated the

172
00:06:53,440 --> 00:06:54,319
signature

173
00:06:54,319 --> 00:06:57,440
when the file was created and another

174
00:06:57,440 --> 00:06:58,479
thing that

175
00:06:58,479 --> 00:07:01,360
popped up is that the email address has

176
00:07:01,360 --> 00:07:02,800
nothing on the certificate that has

177
00:07:02,800 --> 00:07:05,440
nothing to do with the company

178
00:07:05,440 --> 00:07:07,520
which is really strange and when you

179
00:07:07,520 --> 00:07:08,800
look at the domain

180
00:07:08,800 --> 00:07:12,160
it's uh it's something that is related

181
00:07:12,160 --> 00:07:13,199
to

182
00:07:13,199 --> 00:07:17,120
apple icloud accounts from back at 2012.

183
00:07:17,120 --> 00:07:19,039
if you opened an account before that you

184
00:07:19,039 --> 00:07:21,120
got a few other domains with it

185
00:07:21,120 --> 00:07:24,639
so has nothing that seems even relevant

186
00:07:24,639 --> 00:07:27,280
to the files

187
00:07:28,160 --> 00:07:29,919
we continue on looking at the company we

188
00:07:29,919 --> 00:07:31,919
wanted to see uh maybe

189
00:07:31,919 --> 00:07:35,199
somebody tried to uh kind of play with

190
00:07:35,199 --> 00:07:37,360
us and use the real company or maybe the

191
00:07:37,360 --> 00:07:38,800
company was fake

192
00:07:38,800 --> 00:07:42,560
so we couldn't find any reference to

193
00:07:42,560 --> 00:07:44,080
that to the entities that

194
00:07:44,080 --> 00:07:47,120
we talked about the packet the llc

195
00:07:47,120 --> 00:07:49,680
and other and other comp in the secure

196
00:07:49,680 --> 00:07:53,120
network stacks that is in signature

197
00:07:53,120 --> 00:07:56,240
there are no profiles of employees

198
00:07:56,240 --> 00:07:57,759
online

199
00:07:57,759 --> 00:07:59,360
which is kind of funny because lee was

200
00:07:59,360 --> 00:08:00,800
supposed to be the cto

201
00:08:00,800 --> 00:08:03,840
expect somebody somebody like that to

202
00:08:03,840 --> 00:08:06,400
have some presence online

203
00:08:06,400 --> 00:08:10,479
and the site was up for two years

204
00:08:10,479 --> 00:08:12,400
which is quite a lot of time if somebody

205
00:08:12,400 --> 00:08:14,400
wants to create him create himself a

206
00:08:14,400 --> 00:08:15,599
cover story and just

207
00:08:15,599 --> 00:08:18,400
keep it keep it running and then use it

208
00:08:18,400 --> 00:08:20,400
after

209
00:08:20,400 --> 00:08:23,520
such amount of time besides

210
00:08:23,520 --> 00:08:26,000
the in addition to the website the other

211
00:08:26,000 --> 00:08:28,400
also the twitter account

212
00:08:28,400 --> 00:08:30,560
it wasn't very active there was some

213
00:08:30,560 --> 00:08:34,000
user reviews for the product on google

214
00:08:34,000 --> 00:08:36,240
which weren't really that positive when

215
00:08:36,240 --> 00:08:39,039
we think about it

216
00:08:39,360 --> 00:08:40,799
and the code signing certificates

217
00:08:40,799 --> 00:08:42,640
themselves well to get a certificate you

218
00:08:42,640 --> 00:08:44,240
usually have to pay to someone

219
00:08:44,240 --> 00:08:47,519
uh but those specific certificates

220
00:08:47,519 --> 00:08:50,640
uh without extended validation means

221
00:08:50,640 --> 00:08:53,360
they are cheaper and usually getting

222
00:08:53,360 --> 00:08:55,120
them is much more easier and don't

223
00:08:55,120 --> 00:08:56,480
require any

224
00:08:56,480 --> 00:08:59,040
more complicated authentication by the

225
00:08:59,040 --> 00:09:02,079
certificate authority

226
00:09:03,440 --> 00:09:05,440
so at this point we aren't sure if we

227
00:09:05,440 --> 00:09:07,200
are at a dead end

228
00:09:07,200 --> 00:09:10,320
we start reversing the binary the go

229
00:09:10,320 --> 00:09:11,279
executable that

230
00:09:11,279 --> 00:09:14,399
we got it wasn't it didn't look like it

231
00:09:14,399 --> 00:09:15,519
really installed it

232
00:09:15,519 --> 00:09:18,640
in any way uh didn't have the ui didn't

233
00:09:18,640 --> 00:09:20,160
create any files

234
00:09:20,160 --> 00:09:23,279
it did register itself as a service

235
00:09:23,279 --> 00:09:26,640
and it could update itself during its uh

236
00:09:26,640 --> 00:09:30,080
run time and the famous

237
00:09:30,080 --> 00:09:32,240
bandwidth sharing functionality uh it

238
00:09:32,240 --> 00:09:35,200
didn't add anything like that

239
00:09:35,200 --> 00:09:38,160
uh so we just couldn't see anything

240
00:09:38,160 --> 00:09:39,120
really malicious

241
00:09:39,120 --> 00:09:42,480
but still not something that we could

242
00:09:42,480 --> 00:09:44,959
ignore but not something that really

243
00:09:44,959 --> 00:09:46,399
screams at us

244
00:09:46,399 --> 00:09:50,880
danger so we decided to keep on digging

245
00:09:50,880 --> 00:09:53,519
we had two ways that we could go from

246
00:09:53,519 --> 00:09:54,720
here

247
00:09:54,720 --> 00:09:57,040
one was trying to figure out the

248
00:09:57,040 --> 00:09:59,519
timeline and when stuff changed

249
00:09:59,519 --> 00:10:02,640
and go back and find original

250
00:10:02,640 --> 00:10:04,399
installers like all the original

251
00:10:04,399 --> 00:10:06,079
installers and

252
00:10:06,079 --> 00:10:07,760
try and look for other files that are

253
00:10:07,760 --> 00:10:10,000
similar to the one that we got on the

254
00:10:10,000 --> 00:10:11,600
email

255
00:10:11,600 --> 00:10:13,839
doing it it was pretty easy we could use

256
00:10:13,839 --> 00:10:14,880
the certificate

257
00:10:14,880 --> 00:10:18,079
the icon the strings a few quick

258
00:10:18,079 --> 00:10:21,120
searches and queries on virustotal and

259
00:10:21,120 --> 00:10:23,519
in our internal systems we got a few

260
00:10:23,519 --> 00:10:25,839
hits

261
00:10:25,920 --> 00:10:30,320
we found an older an older installer

262
00:10:30,320 --> 00:10:32,240
on the official installer we can see

263
00:10:32,240 --> 00:10:34,800
that it was a different certificate with

264
00:10:34,800 --> 00:10:36,640
a different validity period

265
00:10:36,640 --> 00:10:38,800
and the email was relevant to the

266
00:10:38,800 --> 00:10:40,399
company

267
00:10:40,399 --> 00:10:44,240
so that really kept us going

268
00:10:44,240 --> 00:10:46,399
when we tried to look for new files as

269
00:10:46,399 --> 00:10:48,320
we said similar to one that we got

270
00:10:48,320 --> 00:10:51,360
the one we got we found uh a

271
00:10:51,360 --> 00:10:54,240
binary that's called netel per gui dot

272
00:10:54,240 --> 00:10:55,519
exe

273
00:10:55,519 --> 00:10:57,279
which was signed with a similar stat

274
00:10:57,279 --> 00:10:58,800
with the same certificate as

275
00:10:58,800 --> 00:11:00,880
the file that we were sent and the size

276
00:11:00,880 --> 00:11:03,279
was nearly identical

277
00:11:03,279 --> 00:11:07,600
when we been differed them both the

278
00:11:07,600 --> 00:11:10,959
both of the files we saw that they

279
00:11:10,959 --> 00:11:12,560
matched pretty

280
00:11:12,560 --> 00:11:16,560
almost completely um this one

281
00:11:16,560 --> 00:11:18,480
was first seen in the while two days

282
00:11:18,480 --> 00:11:20,720
after we got the email

283
00:11:20,720 --> 00:11:23,600
and when we did that we when we looked

284
00:11:23,600 --> 00:11:25,600
at the specific code changes

285
00:11:25,600 --> 00:11:29,440
um this is a graph disassembly

286
00:11:29,440 --> 00:11:32,320
of the main function we can see on the

287
00:11:32,320 --> 00:11:34,079
lower right

288
00:11:34,079 --> 00:11:37,360
that there is a few add a few new

289
00:11:37,360 --> 00:11:40,959
basic blocks so

290
00:11:40,959 --> 00:11:44,000
what we did is when we ran it

291
00:11:44,000 --> 00:11:47,040
uh we we saw the the flow

292
00:11:47,040 --> 00:11:50,560
that happens um so first of all it

293
00:11:50,560 --> 00:11:52,639
checks if the service is not installed

294
00:11:52,639 --> 00:11:55,200
and in case it it isn't it's the first

295
00:11:55,200 --> 00:11:57,120
time it's been executed

296
00:11:57,120 --> 00:12:00,560
uh it will call a function that will

297
00:12:00,560 --> 00:12:03,040
download and execute another executable

298
00:12:03,040 --> 00:12:05,040
named prograpper.exe

299
00:12:05,040 --> 00:12:07,120
which we'll talk about uh just in just a

300
00:12:07,120 --> 00:12:08,560
bit

301
00:12:08,560 --> 00:12:11,040
and then it will go ahead to install

302
00:12:11,040 --> 00:12:13,120
itself as a service

303
00:12:13,120 --> 00:12:15,600
and restart it as a service what the

304
00:12:15,600 --> 00:12:16,800
service will do

305
00:12:16,800 --> 00:12:19,680
um is when it will start this the main

306
00:12:19,680 --> 00:12:21,120
function will run

307
00:12:21,120 --> 00:12:23,279
uh it registers a timer every five

308
00:12:23,279 --> 00:12:25,760
minutes it will check for an update

309
00:12:25,760 --> 00:12:28,880
um this update is uh being you

310
00:12:28,880 --> 00:12:31,920
being done using uh an open source

311
00:12:31,920 --> 00:12:32,959
library

312
00:12:32,959 --> 00:12:36,079
um as as

313
00:12:36,079 --> 00:12:39,279
mentioned previously

314
00:12:39,279 --> 00:12:41,760
sorry as mentioned previously go as a

315
00:12:41,760 --> 00:12:43,600
very

316
00:12:43,600 --> 00:12:47,120
very significant open source ecosystem

317
00:12:47,120 --> 00:12:50,560
and if the update is available

318
00:12:50,560 --> 00:12:53,839
thank you

319
00:12:54,399 --> 00:12:57,360
give it up to the team

320
00:12:57,920 --> 00:13:01,279
and when the update is available it will

321
00:13:01,279 --> 00:13:05,360
simply fetch it and restart itself

322
00:13:05,360 --> 00:13:07,680
so the tools that we found uh we named

323
00:13:07,680 --> 00:13:08,959
them netbonds we'll

324
00:13:08,959 --> 00:13:12,240
see why in a bit in a second just why

325
00:13:12,240 --> 00:13:15,680
um so the safe update capability that we

326
00:13:15,680 --> 00:13:16,480
mentioned

327
00:13:16,480 --> 00:13:19,519
is used using the equinox package

328
00:13:19,519 --> 00:13:21,760
it's both an sdk and a public paid

329
00:13:21,760 --> 00:13:22,880
service meaning

330
00:13:22,880 --> 00:13:25,839
that they offer you they offer offer the

331
00:13:25,839 --> 00:13:27,519
ability for you to pay them and then

332
00:13:27,519 --> 00:13:29,680
they will lost you and

333
00:13:29,680 --> 00:13:31,839
you pretty much don't have to ma to deal

334
00:13:31,839 --> 00:13:33,600
with all the logistics of the

335
00:13:33,600 --> 00:13:37,760
updates and they also have a pretty

336
00:13:37,760 --> 00:13:40,880
good documentation and

337
00:13:40,880 --> 00:13:43,120
that code we find it we found it copy

338
00:13:43,120 --> 00:13:44,800
pasted inside of the

339
00:13:44,800 --> 00:13:49,839
malware pretty much without changes

340
00:13:50,560 --> 00:13:53,839
and we can see that

341
00:13:53,839 --> 00:13:57,120
on the left of the screen we can see

342
00:13:57,120 --> 00:14:00,880
the it also took the code as is and

343
00:14:00,880 --> 00:14:04,000
didn't change it a bit on the right

344
00:14:04,000 --> 00:14:08,320
this is post update they changed the the

345
00:14:08,320 --> 00:14:11,839
the package name alongside changing the

346
00:14:11,839 --> 00:14:14,480
default values for the download url

347
00:14:14,480 --> 00:14:18,000
and a user agent

348
00:14:18,000 --> 00:14:20,639
another change was that the first on the

349
00:14:20,639 --> 00:14:21,040
first

350
00:14:21,040 --> 00:14:23,839
in this first stage the pre-update

351
00:14:23,839 --> 00:14:24,639
version

352
00:14:24,639 --> 00:14:28,880
had a hard-coded app id

353
00:14:28,880 --> 00:14:32,000
while the following the update

354
00:14:32,000 --> 00:14:34,480
they changed to uh an app id that is

355
00:14:34,480 --> 00:14:36,000
generated by the machine

356
00:14:36,000 --> 00:14:38,800
serial number

357
00:14:39,360 --> 00:14:42,480
so another capability that we found

358
00:14:42,480 --> 00:14:44,880
was the reverse proxy this this

359
00:14:44,880 --> 00:14:46,399
capability was in the

360
00:14:46,399 --> 00:14:49,440
post update uh sample

361
00:14:49,440 --> 00:14:52,639
um maybe you could think that it's the

362
00:14:52,639 --> 00:14:55,680
promised bandwidth sharing functionality

363
00:14:55,680 --> 00:14:58,320
but at least it's partially true you

364
00:14:58,320 --> 00:15:01,600
would just won't get any money out of it

365
00:15:01,600 --> 00:15:05,040
um it you also used another open source

366
00:15:05,040 --> 00:15:10,160
uh from ago the tunnel package

367
00:15:10,160 --> 00:15:13,360
and it was also changed slightly

368
00:15:13,360 --> 00:15:16,160
um just in order to allow the attackers

369
00:15:16,160 --> 00:15:17,040
to

370
00:15:17,040 --> 00:15:20,800
um to decide on where they can redirect

371
00:15:20,800 --> 00:15:23,360
the traffic the package by default

372
00:15:23,360 --> 00:15:25,360
uh does the redirection only locally

373
00:15:25,360 --> 00:15:26,880
only on the localhost

374
00:15:26,880 --> 00:15:30,399
so you can see that the formatting is

375
00:15:30,399 --> 00:15:33,440
just slightly different

376
00:15:33,759 --> 00:15:36,800
so just to recap for a second we had two

377
00:15:36,800 --> 00:15:40,240
stages the pre-update and post update

378
00:15:40,240 --> 00:15:42,480
and the pre-update can lead to an

379
00:15:42,480 --> 00:15:43,279
execution

380
00:15:43,279 --> 00:15:47,440
execution of a different program

381
00:15:47,440 --> 00:15:49,199
it's called programper we'll talk about

382
00:15:49,199 --> 00:15:50,720
it in a second

383
00:15:50,720 --> 00:15:53,040
it has a persistency for itself and the

384
00:15:53,040 --> 00:15:53,920
update that

385
00:15:53,920 --> 00:15:57,759
is redirected to equinox and post update

386
00:15:57,759 --> 00:16:00,240
the updates goes through the net bounce

387
00:16:00,240 --> 00:16:02,639
domain

388
00:16:02,800 --> 00:16:06,720
so what is the program we ask ourselves

389
00:16:06,720 --> 00:16:09,600
if we reached an actual payload because

390
00:16:09,600 --> 00:16:10,240
like

391
00:16:10,240 --> 00:16:12,079
up until now it was only the delivery

392
00:16:12,079 --> 00:16:13,680
phase

393
00:16:13,680 --> 00:16:17,120
so no not entirely but it's

394
00:16:17,120 --> 00:16:18,560
it was also signed with the same

395
00:16:18,560 --> 00:16:20,839
certificate the same fake

396
00:16:20,839 --> 00:16:24,079
certificate it basically

397
00:16:24,079 --> 00:16:26,800
also download and executes another

398
00:16:26,800 --> 00:16:28,880
program but it does some basic check

399
00:16:28,880 --> 00:16:29,600
before that

400
00:16:29,600 --> 00:16:32,639
it fetches some sort of configuration it

401
00:16:32,639 --> 00:16:33,040
checks

402
00:16:33,040 --> 00:16:36,160
whether a file or a registry key exists

403
00:16:36,160 --> 00:16:38,880
on the machine beforehand and if not

404
00:16:38,880 --> 00:16:39,920
then it will

405
00:16:39,920 --> 00:16:43,439
download it and execute it

406
00:16:44,160 --> 00:16:47,440
so the payload that we got the output

407
00:16:47,440 --> 00:16:49,279
40. exe

408
00:16:49,279 --> 00:16:53,199
turned out to be infostiller

409
00:16:53,199 --> 00:16:55,030
it was packed with a few

410
00:16:55,030 --> 00:16:56,560
[Music]

411
00:16:56,560 --> 00:16:59,680
with a few layers that also seem to be

412
00:16:59,680 --> 00:17:01,360
related to

413
00:17:01,360 --> 00:17:04,400
this malware infrastructure malware

414
00:17:04,400 --> 00:17:07,280
delivery infrastructure

415
00:17:07,280 --> 00:17:09,039
the payload that we saw was figure

416
00:17:09,039 --> 00:17:11,359
steeler that at the time was relatively

417
00:17:11,359 --> 00:17:12,880
new it was

418
00:17:12,880 --> 00:17:16,559
less than six months old reports linked

419
00:17:16,559 --> 00:17:19,359
it mainly to hansitor

420
00:17:19,359 --> 00:17:22,480
it's developer installed in russian

421
00:17:22,480 --> 00:17:24,319
hacking phones and it's developer

422
00:17:24,319 --> 00:17:26,000
actually handed it out for a review

423
00:17:26,000 --> 00:17:27,679
you can find it online it's very funny

424
00:17:27,679 --> 00:17:29,039
to see uh

425
00:17:29,039 --> 00:17:31,600
trend google translate does a really

426
00:17:31,600 --> 00:17:33,440
good job on that

427
00:17:33,440 --> 00:17:36,080
it's written in rust up until now most

428
00:17:36,080 --> 00:17:36,559
of our

429
00:17:36,559 --> 00:17:40,400
uh most of the files were developed in

430
00:17:40,400 --> 00:17:41,039
go but

431
00:17:41,039 --> 00:17:44,880
this one is in rust uh and it also

432
00:17:44,880 --> 00:17:47,360
eventually also as its own download and

433
00:17:47,360 --> 00:17:47,919
execute

434
00:17:47,919 --> 00:17:51,039
capability um

435
00:17:51,039 --> 00:17:54,640
and one other thing that is interesting

436
00:17:54,640 --> 00:17:58,080
is that we can see the tracking folder

437
00:17:58,080 --> 00:18:00,480
start

438
00:18:02,160 --> 00:18:04,080
this was this is the actual first

439
00:18:04,080 --> 00:18:05,760
operation that happens

440
00:18:05,760 --> 00:18:08,880
in this variant of the figure steeler

441
00:18:08,880 --> 00:18:12,160
we went back and for previous

442
00:18:12,160 --> 00:18:15,520
variants it wasn't there go back for a

443
00:18:15,520 --> 00:18:18,000
second

444
00:18:18,559 --> 00:18:20,880
this is this this is a similar path to

445
00:18:20,880 --> 00:18:22,240
what we get

446
00:18:22,240 --> 00:18:26,400
from the configuration of the downloader

447
00:18:27,520 --> 00:18:29,520
so it's another interesting link between

448
00:18:29,520 --> 00:18:31,679
them

449
00:18:32,080 --> 00:18:35,120
so at this point we did this this cycle

450
00:18:35,120 --> 00:18:35,600
a bit

451
00:18:35,600 --> 00:18:37,679
a few times more and every time we got a

452
00:18:37,679 --> 00:18:39,120
new piece of information we

453
00:18:39,120 --> 00:18:42,880
chased it we also found support for

454
00:18:42,880 --> 00:18:45,760
cross-platform and variants for mac

455
00:18:45,760 --> 00:18:49,039
which we found via hunting

456
00:18:49,520 --> 00:18:52,640
it used the same

457
00:18:52,640 --> 00:18:56,559
the same app id and similar urls for

458
00:18:56,559 --> 00:18:57,679
download

459
00:18:57,679 --> 00:19:00,960
um basically we found an app package

460
00:19:00,960 --> 00:19:02,880
with the post installation script

461
00:19:02,880 --> 00:19:06,400
that fetches the the first stage uh

462
00:19:06,400 --> 00:19:10,080
first stage variant and then executes it

463
00:19:10,080 --> 00:19:13,600
we also find the linux sample

464
00:19:13,600 --> 00:19:17,440
a few actually and here we did a nicer

465
00:19:17,440 --> 00:19:18,400
trick

466
00:19:18,400 --> 00:19:25,280
basically since since the

467
00:19:25,280 --> 00:19:27,760
since the download the updating

468
00:19:27,760 --> 00:19:28,799
capabilities

469
00:19:28,799 --> 00:19:32,480
in implement implemented by the same

470
00:19:32,480 --> 00:19:36,000
equinox sdk we kind of figure out how

471
00:19:36,000 --> 00:19:40,559
um how the links to the binaries on the

472
00:19:40,559 --> 00:19:42,799
server looks like we relied on that

473
00:19:42,799 --> 00:19:45,919
that relied on the fact that uh

474
00:19:45,919 --> 00:19:48,400
if the client is equinox the server side

475
00:19:48,400 --> 00:19:50,400
might be equinox as well and

476
00:19:50,400 --> 00:19:54,240
started trying started figuring out

477
00:19:54,400 --> 00:19:56,640
all the all the details that it sends on

478
00:19:56,640 --> 00:19:57,760
the protocol

479
00:19:57,760 --> 00:20:00,559
and how it builds the the url to

480
00:20:00,559 --> 00:20:02,000
download the file so

481
00:20:02,000 --> 00:20:03,840
basically uses the name of the

482
00:20:03,840 --> 00:20:05,039
executable

483
00:20:05,039 --> 00:20:07,919
with the version os and the business the

484
00:20:07,919 --> 00:20:09,039
architecture

485
00:20:09,039 --> 00:20:10,720
and then we've just started messing with

486
00:20:10,720 --> 00:20:13,600
it until we this we managed to fetch the

487
00:20:13,600 --> 00:20:17,039
fetch samples from the server

488
00:20:17,039 --> 00:20:20,559
from the network server

489
00:20:20,559 --> 00:20:24,240
the infection vector we found to be from

490
00:20:24,240 --> 00:20:29,039
zip archives and msi installers

491
00:20:29,039 --> 00:20:30,640
which makes sense because that's the

492
00:20:30,640 --> 00:20:32,880
first time

493
00:20:32,880 --> 00:20:35,919
when if when the first time the pre

494
00:20:35,919 --> 00:20:38,960
uh pre-update stage one variants are

495
00:20:38,960 --> 00:20:41,360
being uh

496
00:20:41,360 --> 00:20:44,480
executed the the service is not

497
00:20:44,480 --> 00:20:45,440
installed yet so

498
00:20:45,440 --> 00:20:48,880
it will also it will also do the uh

499
00:20:48,880 --> 00:20:50,880
the update the download and execute the

500
00:20:50,880 --> 00:20:52,240
extra download and execute of the

501
00:20:52,240 --> 00:20:54,799
program up

502
00:20:55,280 --> 00:20:58,080
they also had a program up here and the

503
00:20:58,080 --> 00:20:58,880
stage

504
00:20:58,880 --> 00:21:01,760
one also in the stage one variant also

505
00:21:01,760 --> 00:21:02,400
had

506
00:21:02,400 --> 00:21:03,919
shared code the same download and

507
00:21:03,919 --> 00:21:05,520
execute function

508
00:21:05,520 --> 00:21:08,879
was pretty much the same

509
00:21:10,000 --> 00:21:12,960
and we got other payloads we also found

510
00:21:12,960 --> 00:21:16,880
a program wrapper variant with reversiel

511
00:21:16,880 --> 00:21:20,000
mini backdoor if you want

512
00:21:20,000 --> 00:21:23,280
it added the command

513
00:21:23,280 --> 00:21:26,799
command functionality and

514
00:21:26,799 --> 00:21:28,480
for some reason it decided to use the

515
00:21:28,480 --> 00:21:30,240
net bounce

516
00:21:30,240 --> 00:21:33,360
user agent we also capture more info

517
00:21:33,360 --> 00:21:34,240
stealers

518
00:21:34,240 --> 00:21:37,760
such as the wider steeler and

519
00:21:37,760 --> 00:21:42,000
the other variants of the packer that

520
00:21:42,000 --> 00:21:44,000
basically worked a bit differently but

521
00:21:44,000 --> 00:21:45,520
though this

522
00:21:45,520 --> 00:21:50,480
the state the layers were pretty similar

523
00:21:50,480 --> 00:21:54,159
so if i just have to recap for a second

524
00:21:54,159 --> 00:21:56,840
and now we when we have the entire

525
00:21:56,840 --> 00:21:58,640
picture

526
00:21:58,640 --> 00:22:00,960
all what all what we see circle in red

527
00:22:00,960 --> 00:22:03,039
is what we call the net bounce

528
00:22:03,039 --> 00:22:06,480
tool set which is pretty complex

529
00:22:06,480 --> 00:22:09,039
operation

530
00:22:09,440 --> 00:22:13,200
the c2 infrastructure that we saw

531
00:22:13,200 --> 00:22:16,720
going a bit about it pretty quickly

532
00:22:16,720 --> 00:22:18,400
many of the domains were registered but

533
00:22:18,400 --> 00:22:20,559
the same entity even though it was

534
00:22:20,559 --> 00:22:21,760
private you can see still

535
00:22:21,760 --> 00:22:24,480
you can still see it's the same same

536
00:22:24,480 --> 00:22:26,640
account that did that

537
00:22:26,640 --> 00:22:29,840
sub domains are the same and

538
00:22:29,840 --> 00:22:32,400
some use the same subdomain and some use

539
00:22:32,400 --> 00:22:33,039
the same

540
00:22:33,039 --> 00:22:35,840
very similar distinct pattern even

541
00:22:35,840 --> 00:22:38,080
though it's not really

542
00:22:38,080 --> 00:22:41,840
let's say complicated all the domains

543
00:22:41,840 --> 00:22:43,520
were resolved to the same ips on the

544
00:22:43,520 --> 00:22:45,280
same subnet

545
00:22:45,280 --> 00:22:47,520
and some domain some different domains

546
00:22:47,520 --> 00:22:49,679
also pointed to the same servers

547
00:22:49,679 --> 00:22:52,880
same ip addresses

548
00:22:53,039 --> 00:22:55,440
uh we could also see when we looked on

549
00:22:55,440 --> 00:22:57,520
passive dns data we can see the

550
00:22:57,520 --> 00:23:01,520
uh the lifetime of the campaign um

551
00:23:01,520 --> 00:23:05,120
we we got the email on the 12th

552
00:23:05,120 --> 00:23:07,600
and pretty soon after we could see that

553
00:23:07,600 --> 00:23:08,559
the

554
00:23:08,559 --> 00:23:10,559
fret actor decided to start changing the

555
00:23:10,559 --> 00:23:12,400
domains

556
00:23:12,400 --> 00:23:14,400
maybe because we didn't respond to their

557
00:23:14,400 --> 00:23:16,720
call

558
00:23:17,919 --> 00:23:20,480
and here our investigation ended we

559
00:23:20,480 --> 00:23:21,440
decided that

560
00:23:21,440 --> 00:23:24,720
that's it and we can move on to our next

561
00:23:24,720 --> 00:23:25,200
thing

562
00:23:25,200 --> 00:23:28,640
our conclusions were um

563
00:23:28,640 --> 00:23:31,600
that the sample that they sent us that

564
00:23:31,600 --> 00:23:32,720
they pointed us

565
00:23:32,720 --> 00:23:36,480
at is sterilized stage 2

566
00:23:36,480 --> 00:23:40,400
post update it had the net bounce

567
00:23:40,400 --> 00:23:43,520
version of the update mechanism

568
00:23:43,520 --> 00:23:45,919
and no program upper no download and

569
00:23:45,919 --> 00:23:47,279
execute

570
00:23:47,279 --> 00:23:50,480
and no reverse proxy so maybe it will be

571
00:23:50,480 --> 00:23:51,440
a bit less

572
00:23:51,440 --> 00:23:54,880
suspicious and they did it in order to

573
00:23:54,880 --> 00:23:56,240
trick us and

574
00:23:56,240 --> 00:23:58,080
so we could widely whitelist them and

575
00:23:58,080 --> 00:24:01,039
not in order to infect us

576
00:24:01,039 --> 00:24:03,760
and their end goal is using a smashing

577
00:24:03,760 --> 00:24:05,039
grab steelers such as

578
00:24:05,039 --> 00:24:08,080
figure and wider

579
00:24:08,080 --> 00:24:11,679
so just to wrap

580
00:24:11,679 --> 00:24:15,520
up basically they were very confident

581
00:24:15,520 --> 00:24:16,159
that

582
00:24:16,159 --> 00:24:18,799
the fret actor he was very confident

583
00:24:18,799 --> 00:24:20,159
with their

584
00:24:20,159 --> 00:24:22,720
let's say cover story tooling and they

585
00:24:22,720 --> 00:24:24,000
decided to try and

586
00:24:24,000 --> 00:24:27,840
use it directly against the security

587
00:24:27,840 --> 00:24:28,559
vendor

588
00:24:28,559 --> 00:24:32,000
with social engineering maybe if you

589
00:24:32,000 --> 00:24:33,760
can't beat them then ask them nicely to

590
00:24:33,760 --> 00:24:35,200
let you go

591
00:24:35,200 --> 00:24:38,640
um we saw a pretty

592
00:24:38,640 --> 00:24:41,360
complex multi-stage infection mechanism

593
00:24:41,360 --> 00:24:43,279
it can be activated at any point in time

594
00:24:43,279 --> 00:24:43,840
and it

595
00:24:43,840 --> 00:24:46,960
even after it works for the first time

596
00:24:46,960 --> 00:24:49,200
it stays there and they can reuse it

597
00:24:49,200 --> 00:24:51,840
again and again

598
00:24:53,120 --> 00:24:56,640
since all the tools were written in a go

599
00:24:56,640 --> 00:25:00,880
it was really really helpful

600
00:25:00,880 --> 00:25:04,159
it was at least for the attackers uh it

601
00:25:04,159 --> 00:25:06,000
really cut them cut down of the work

602
00:25:06,000 --> 00:25:08,240
time

603
00:25:08,240 --> 00:25:12,080
and they they only needed to use

604
00:25:12,080 --> 00:25:14,240
like open source that had all the

605
00:25:14,240 --> 00:25:15,919
functionality that they need with really

606
00:25:15,919 --> 00:25:18,480
minimalistic changes uh to support the

607
00:25:18,480 --> 00:25:20,159
different uh

608
00:25:20,159 --> 00:25:22,720
uh operating operating system they only

609
00:25:22,720 --> 00:25:25,919
had to to switch the compilation target

610
00:25:25,919 --> 00:25:29,440
and that's pretty much

611
00:25:29,440 --> 00:25:33,520
it almost

612
00:25:33,520 --> 00:25:38,080
just almost i have to admit

613
00:25:38,080 --> 00:25:40,320
that when i prepare the slides for this

614
00:25:40,320 --> 00:25:42,320
talk i was a bit bummed down

615
00:25:42,320 --> 00:25:44,159
[Music]

616
00:25:44,159 --> 00:25:46,880
i came i started working on it and i saw

617
00:25:46,880 --> 00:25:48,880
that

618
00:25:48,880 --> 00:25:50,320
basically i'm going to do a talk about

619
00:25:50,320 --> 00:25:52,080
the malware infrastructure that is six

620
00:25:52,080 --> 00:25:53,120
months old

621
00:25:53,120 --> 00:25:56,159
and is not very active anymore but

622
00:25:56,159 --> 00:25:58,080
apparently up until this week i was

623
00:25:58,080 --> 00:26:00,320
wrong

624
00:26:00,559 --> 00:26:03,360
introducing mosaic loader so the day

625
00:26:03,360 --> 00:26:04,559
before last

626
00:26:04,559 --> 00:26:08,080
we defender published a report

627
00:26:08,799 --> 00:26:12,480
about it uh it's another it looks really

628
00:26:12,480 --> 00:26:13,679
similar to ours

629
00:26:13,679 --> 00:26:16,000
it shares the same infrastructure same

630
00:26:16,000 --> 00:26:17,200
ttps

631
00:26:17,200 --> 00:26:20,320
uh same installer theme

632
00:26:20,320 --> 00:26:22,840
signed binaries look the same

633
00:26:22,840 --> 00:26:24,320
multi-stage

634
00:26:24,320 --> 00:26:28,159
infection mechanism and the same program

635
00:26:28,159 --> 00:26:30,159
up here it's pretty much all the same

636
00:26:30,159 --> 00:26:32,400
code and yeah as i mentioned

637
00:26:32,400 --> 00:26:35,039
shares the domain and ips it also

638
00:26:35,039 --> 00:26:37,600
delivers infostealers

639
00:26:37,600 --> 00:26:39,520
it's basically seems like a port to

640
00:26:39,520 --> 00:26:41,120
delphi so

641
00:26:41,120 --> 00:26:43,440
when we looked about it we i looked a

642
00:26:43,440 --> 00:26:46,880
bit very briefly and it seems that like

643
00:26:46,880 --> 00:26:50,720
three weeks after we we published our

644
00:26:50,720 --> 00:26:51,600
work

645
00:26:51,600 --> 00:26:53,440
the attacker switched and this campaign

646
00:26:53,440 --> 00:26:54,720
new campaign began

647
00:26:54,720 --> 00:26:56,159
so it is interesting to see that they

648
00:26:56,159 --> 00:26:58,080
are still active

649
00:26:58,080 --> 00:27:00,799
any questions

650
00:27:02,400 --> 00:27:07,760
thank you thank you so much

