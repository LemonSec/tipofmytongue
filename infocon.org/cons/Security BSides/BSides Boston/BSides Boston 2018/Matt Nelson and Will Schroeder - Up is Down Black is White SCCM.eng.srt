1
00:00:07,970 --> 00:00:13,219
up is down black is why using secm for

2
00:00:11,780 --> 00:00:15,829
and right we're gonna kind of go over

3
00:00:13,220 --> 00:00:17,240
some of the offensive s you see him and

4
00:00:15,830 --> 00:00:30,890
defensive s he seemed stuff we've used

5
00:00:17,240 --> 00:00:32,628
in the field okay all right so that's me

6
00:00:30,890 --> 00:00:34,370
that's my Twitter handle I'm a

7
00:00:32,628 --> 00:00:36,739
penetration tester and Red Team occur

8
00:00:34,370 --> 00:00:39,849
very adaptive threat division I've been

9
00:00:36,739 --> 00:00:42,709
there for about a year and it's amazing

10
00:00:39,850 --> 00:00:44,690
I'm an active developer on the parks on

11
00:00:42,710 --> 00:00:47,090
fire framework so if anybody's used or

12
00:00:44,690 --> 00:00:48,379
heard of Empires anyone heard of empire

13
00:00:47,090 --> 00:00:51,770
suite

14
00:00:48,380 --> 00:00:53,540
right on I love offensive powershell the

15
00:00:51,770 --> 00:00:56,960
day parcel dies is a day that I go back

16
00:00:53,540 --> 00:00:59,420
to Indiana and start farming corn was a

17
00:00:56,960 --> 00:01:01,640
sysadmin while in college that's the SEC

18
00:00:59,420 --> 00:01:03,350
em stuff I actually administered SEC him

19
00:01:01,640 --> 00:01:06,110
for about a year and a half before I

20
00:01:03,350 --> 00:01:08,720
started the offensive stuff and I smoked

21
00:01:06,110 --> 00:01:12,140
spoken at shmoo the fire talks and

22
00:01:08,720 --> 00:01:13,580
besides DC so this is my third cop so

23
00:01:12,140 --> 00:01:14,300
he's getting the hang of it starting to

24
00:01:13,580 --> 00:01:16,429
get the hang of it

25
00:01:14,300 --> 00:01:18,560
so I'm will trader my handles harm joy

26
00:01:16,430 --> 00:01:20,150
I'm a security researcher at red teamer

27
00:01:18,560 --> 00:01:22,369
for the same thing man I need that the

28
00:01:20,150 --> 00:01:23,869
threat division my co-founder and kind

29
00:01:22,369 --> 00:01:25,970
of active offensive developer and can

30
00:01:23,869 --> 00:01:27,380
blow up projects so I helped found and

31
00:01:25,970 --> 00:01:29,240
write a big chunk at the veil framework

32
00:01:27,380 --> 00:01:31,009
which I talked about two years ago here

33
00:01:29,240 --> 00:01:33,619
be sighs Boston some of the obfuscated

34
00:01:31,009 --> 00:01:35,030
in PI installer stuff I wrote Power View

35
00:01:33,619 --> 00:01:36,590
power up a lot of the offensive

36
00:01:35,030 --> 00:01:38,810
PowerShell toolkit that we use on our

37
00:01:36,590 --> 00:01:40,880
red team engagements I'm a co-founder

38
00:01:38,810 --> 00:01:42,770
active developer of empire and also

39
00:01:40,880 --> 00:01:44,839
we've recently released Python Empire

40
00:01:42,770 --> 00:01:46,670
for OS X we're trying to combine the

41
00:01:44,840 --> 00:01:48,320
projects and if anyone wants to talk

42
00:01:46,670 --> 00:01:50,570
about anything else that's either SDC

43
00:01:48,320 --> 00:01:52,039
and we're not SCCM after we're gone to

44
00:01:50,570 --> 00:01:54,020
the hallway when you love just to talk

45
00:01:52,040 --> 00:01:56,210
to anybody about anything I'm an active

46
00:01:54,020 --> 00:01:57,829
powersploit developer now and I was

47
00:01:56,210 --> 00:01:59,960
recently awarded the Microsoft

48
00:01:57,829 --> 00:02:01,850
PowerShell MVP so I got to go do some of

49
00:01:59,960 --> 00:02:03,860
the summits and all that spoken to a few

50
00:02:01,850 --> 00:02:05,570
cons and I was at besides Boston two

51
00:02:03,860 --> 00:02:07,070
years ago like I mentioned so I love

52
00:02:05,570 --> 00:02:10,660
this con it's awesome I don't have a

53
00:02:07,070 --> 00:02:10,660
great time full conversations there

54
00:02:11,250 --> 00:02:15,430
all right so a little bit about this

55
00:02:13,450 --> 00:02:17,470
talk we're gonna kind of go over what

56
00:02:15,430 --> 00:02:20,200
red teaming is versus what pentesting is

57
00:02:17,470 --> 00:02:21,370
and how we tend to define it um and then

58
00:02:20,200 --> 00:02:23,950
kind of the difference between humming

59
00:02:21,370 --> 00:02:25,990
an incident response and how that you

60
00:02:23,950 --> 00:02:28,239
know works into as you see in a little

61
00:02:25,990 --> 00:02:30,490
bit and we're gonna cover the basics of

62
00:02:28,240 --> 00:02:33,340
se soon so what is it we're gonna be

63
00:02:30,490 --> 00:02:35,950
used for how to not administer it and

64
00:02:33,340 --> 00:02:37,390
then how we typically CSU team set up in

65
00:02:35,950 --> 00:02:39,880
the enterprise and so this isn't like

66
00:02:37,390 --> 00:02:41,829
here's how you should set it up and be

67
00:02:39,880 --> 00:02:43,990
safe with it it's a how do we see a lot

68
00:02:41,830 --> 00:02:45,370
of the organization's tend to follow a

69
00:02:43,990 --> 00:02:47,140
pattern of how they set it up and how

70
00:02:45,370 --> 00:02:49,420
we're able to abuse that to to do what

71
00:02:47,140 --> 00:02:51,579
we want so that's gonna move us into

72
00:02:49,420 --> 00:02:53,559
using and abusing SCCM and so we're

73
00:02:51,580 --> 00:02:55,690
gonna kind of cover you know how to back

74
00:02:53,560 --> 00:02:57,880
and set up a little bit how we can use

75
00:02:55,690 --> 00:03:01,630
it as an attack platform how we're able

76
00:02:57,880 --> 00:03:03,190
to push out agents to you know host

77
00:03:01,630 --> 00:03:05,650
inside the network how are you able to

78
00:03:03,190 --> 00:03:08,109
use that to hunt you know for different

79
00:03:05,650 --> 00:03:09,700
users computers and use integrated

80
00:03:08,110 --> 00:03:11,320
technology within the network to

81
00:03:09,700 --> 00:03:13,690
accomplish our goals without introducing

82
00:03:11,320 --> 00:03:15,459
anything foreign and then we're gonna

83
00:03:13,690 --> 00:03:17,260
kind of go over a little bit of using su

84
00:03:15,459 --> 00:03:19,350
scheme for good for funding in response

85
00:03:17,260 --> 00:03:22,000
and how that can be applied for

86
00:03:19,350 --> 00:03:24,910
detecting that and then it'll be a demo

87
00:03:22,000 --> 00:03:29,500
I'm using it very briefly for some

88
00:03:24,910 --> 00:03:30,609
offensive stuff cool so a little bit of

89
00:03:29,500 --> 00:03:33,520
background you get everyone on the same

90
00:03:30,610 --> 00:03:35,170
page these are you know the the stock

91
00:03:33,520 --> 00:03:36,850
this is kind of like what we're talking

92
00:03:35,170 --> 00:03:38,589
about this what we mean by haunting does

93
00:03:36,850 --> 00:03:42,850
what how we define red teaming and pen

94
00:03:38,590 --> 00:03:44,200
testing so pen testing sure is a lot of

95
00:03:42,850 --> 00:03:45,880
people know like who's actually who does

96
00:03:44,200 --> 00:03:47,440
pen testing a red teaming feel like okay

97
00:03:45,880 --> 00:03:49,870
there there's a chunk of people to do

98
00:03:47,440 --> 00:03:51,489
this so like you know there's no

99
00:03:49,870 --> 00:03:53,380
Universal definition of like what's a

100
00:03:51,489 --> 00:03:56,470
red team versus what's a pen test right

101
00:03:53,380 --> 00:03:58,120
so for pen testing we've seen to find a

102
00:03:56,470 --> 00:03:59,920
could be anything from a single person

103
00:03:58,120 --> 00:04:01,450
running a vulnerability scan putting

104
00:03:59,920 --> 00:04:03,220
their company's logo on it not that any

105
00:04:01,450 --> 00:04:04,540
company has ever done that or we none of

106
00:04:03,220 --> 00:04:07,090
us have ever read the reports of that

107
00:04:04,540 --> 00:04:08,829
happening it could be a few testers for

108
00:04:07,090 --> 00:04:10,810
you know one or two weeks or it could be

109
00:04:08,830 --> 00:04:12,580
a multi-week assault you know for with

110
00:04:10,810 --> 00:04:16,470
the large team over long period

111
00:04:12,580 --> 00:04:20,620
we view we personally view pentesting as

112
00:04:16,470 --> 00:04:21,640
kind of a breath breath first focus you

113
00:04:20,620 --> 00:04:22,870
know we're not saying that we have the

114
00:04:21,640 --> 00:04:24,909
right definition this is just how we

115
00:04:22,870 --> 00:04:26,820
interpret it so we feel like the the

116
00:04:24,910 --> 00:04:29,500
goal of intestine is fine as many

117
00:04:26,820 --> 00:04:31,420
problems and security issues as possible

118
00:04:29,500 --> 00:04:32,950
in a particular environment then we kind

119
00:04:31,420 --> 00:04:34,690
of combine that a little bit with we try

120
00:04:32,950 --> 00:04:36,370
to escalate as far as we can but we're

121
00:04:34,690 --> 00:04:38,500
focused on trying to find a breadth of

122
00:04:36,370 --> 00:04:41,500
vulnerabilities for a company right so

123
00:04:38,500 --> 00:04:42,940
this definitely has its place and you

124
00:04:41,500 --> 00:04:44,380
know you have a limited time frame in

125
00:04:42,940 --> 00:04:46,330
general you're gonna use open source

126
00:04:44,380 --> 00:04:47,560
tools you're not gonna use a super

127
00:04:46,330 --> 00:04:49,359
custom malware you're not gonna do

128
00:04:47,560 --> 00:04:53,020
whatever else because the stuff cost

129
00:04:49,360 --> 00:04:56,020
money and time right we view red teaming

130
00:04:53,020 --> 00:04:57,640
as just a little bit different in for us

131
00:04:56,020 --> 00:04:58,930
the definitions have started to kind of

132
00:04:57,640 --> 00:05:01,780
blur based on the tool sets we've

133
00:04:58,930 --> 00:05:04,690
developed but we really kind of view red

134
00:05:01,780 --> 00:05:07,059
teaming as the the chance to test the

135
00:05:04,690 --> 00:05:09,969
instant response process for a company

136
00:05:07,060 --> 00:05:12,150
so we view it as a training opportunity

137
00:05:09,970 --> 00:05:15,100
for defenders so we don't remove logs

138
00:05:12,150 --> 00:05:16,719
and ideally for us certain parts of a

139
00:05:15,100 --> 00:05:17,950
red team are caught and certain parts

140
00:05:16,720 --> 00:05:19,690
aren't we want to find the noise

141
00:05:17,950 --> 00:05:21,550
threshold for a company you know we

142
00:05:19,690 --> 00:05:23,260
don't want to say look we you didn't

143
00:05:21,550 --> 00:05:25,090
detect a single thing we're super super

144
00:05:23,260 --> 00:05:27,099
stealthy and like look at us or super

145
00:05:25,090 --> 00:05:29,200
crazy awesome apt simulators or

146
00:05:27,100 --> 00:05:31,120
something there's no L small elements of

147
00:05:29,200 --> 00:05:33,010
that but we're not trying to prove we're

148
00:05:31,120 --> 00:05:35,620
smarter than all this and responders we

149
00:05:33,010 --> 00:05:37,270
want to help them get better so you know

150
00:05:35,620 --> 00:05:38,710
maybe we start stealthy and if they

151
00:05:37,270 --> 00:05:40,270
don't detect anything over the course of

152
00:05:38,710 --> 00:05:42,280
engagement we might start dialing the

153
00:05:40,270 --> 00:05:44,349
noise up until they actually figure out

154
00:05:42,280 --> 00:05:46,330
that we are there so we can see you like

155
00:05:44,350 --> 00:05:47,560
this are you properly imaging a box or

156
00:05:46,330 --> 00:05:49,000
you point drives or you do the memory

157
00:05:47,560 --> 00:05:51,910
dumps you know how does your instant

158
00:05:49,000 --> 00:05:53,710
response process work so but in general

159
00:05:51,910 --> 00:05:55,330
you try to simulate a bit more of an

160
00:05:53,710 --> 00:05:56,890
advanced adversary it's usually at least

161
00:05:55,330 --> 00:06:00,640
like a three week time frame for us

162
00:05:56,890 --> 00:06:03,820
sometimes more yeah and sometimes we'll

163
00:06:00,640 --> 00:06:05,080
write custom tools we'll develop custom

164
00:06:03,820 --> 00:06:07,330
tradecraft for an engagement

165
00:06:05,080 --> 00:06:09,520
so this SCCM stuff actually came about

166
00:06:07,330 --> 00:06:11,050
from some of the right teams so you know

167
00:06:09,520 --> 00:06:13,210
we didn't on a one-week pen test we

168
00:06:11,050 --> 00:06:15,070
didn't custom roll and you know what Oh

169
00:06:13,210 --> 00:06:16,870
PowerShell module it does like you can

170
00:06:15,070 --> 00:06:18,760
assess DCM exploitation but because we

171
00:06:16,870 --> 00:06:20,620
have the time and opportunity and

172
00:06:18,760 --> 00:06:25,360
but kind of latitude to do that in a red

173
00:06:20,620 --> 00:06:27,160
team enable time so instant response you

174
00:06:25,360 --> 00:06:28,960
know kind of a similar analogy like we

175
00:06:27,160 --> 00:06:30,640
view like 10 testing to hunt is kind of

176
00:06:28,960 --> 00:06:32,770
our pen testing the red teaming is kind

177
00:06:30,640 --> 00:06:34,360
of in response to hunt in general assent

178
00:06:32,770 --> 00:06:36,190
responses you know the five alarm fire

179
00:06:34,360 --> 00:06:38,680
concept it's kicked off by network

180
00:06:36,190 --> 00:06:41,440
monitoring tools alerts it's very

181
00:06:38,680 --> 00:06:42,940
reactive by the time that you detect

182
00:06:41,440 --> 00:06:45,190
something happy with instant response

183
00:06:42,940 --> 00:06:48,790
it's often it might be a little bit too

184
00:06:45,190 --> 00:06:50,650
late but you know that's ideally you

185
00:06:48,790 --> 00:06:52,750
want to be a bit more proactive which is

186
00:06:50,650 --> 00:06:54,700
kind of what we mean by hunting it's a

187
00:06:52,750 --> 00:06:56,050
US Department of Defense concept just

188
00:06:54,700 --> 00:06:57,640
kind of like red teaming a lot of these

189
00:06:56,050 --> 00:06:58,960
concepts came from groups they've been

190
00:06:57,640 --> 00:07:00,940
doing them for a long time which was

191
00:06:58,960 --> 00:07:02,799
basically the US government agencies are

192
00:07:00,940 --> 00:07:05,080
more advanced advanced types of groups

193
00:07:02,800 --> 00:07:06,340
so it's the blue version of the assumed

194
00:07:05,080 --> 00:07:08,770
breach mentality which I'll talk about

195
00:07:06,340 --> 00:07:10,960
quickly in a second and this is you know

196
00:07:08,770 --> 00:07:12,849
the the standard lingo for hunting is

197
00:07:10,960 --> 00:07:15,370
detection investigation response deny

198
00:07:12,850 --> 00:07:17,680
degrade destruct manipulate so it's hunt

199
00:07:15,370 --> 00:07:20,620
it's going you're going out and looking

200
00:07:17,680 --> 00:07:22,120
for bad guys in your network before it

201
00:07:20,620 --> 00:07:25,510
stripped off by a navy alert or

202
00:07:22,120 --> 00:07:27,310
something right assume breach is the

203
00:07:25,510 --> 00:07:29,740
mentality of assuming that there's

204
00:07:27,310 --> 00:07:32,020
already an adversary in your network so

205
00:07:29,740 --> 00:07:34,380
this ties into red teaming so you know

206
00:07:32,020 --> 00:07:36,549
we might manipulate kind of how we

207
00:07:34,380 --> 00:07:38,110
approach the engagement with the

208
00:07:36,550 --> 00:07:40,750
assumption of an embedded advanced

209
00:07:38,110 --> 00:07:42,280
adversary and with hunting like well you

210
00:07:40,750 --> 00:07:44,200
don't have any AV alerts or we don't

211
00:07:42,280 --> 00:07:45,460
have any similar to but there's probably

212
00:07:44,200 --> 00:07:47,860
somebody there if they're good enough

213
00:07:45,460 --> 00:07:49,539
so let's develop techniques to go find

214
00:07:47,860 --> 00:07:52,060
where they are this is one of my

215
00:07:49,540 --> 00:07:54,040
favorite quotes is from the Microsoft

216
00:07:52,060 --> 00:07:56,110
Enterprise Cloud red teaming white paper

217
00:07:54,040 --> 00:07:58,480
which is if you hadn't if you haven't

218
00:07:56,110 --> 00:08:00,220
read definitely go read it it's free by

219
00:07:58,480 --> 00:08:01,900
Microsoft is like 40 pages but they had

220
00:08:00,220 --> 00:08:04,060
this great quote from Michael Hayden is

221
00:08:01,900 --> 00:08:05,739
the former director of the CIA NSA Singh

222
00:08:04,060 --> 00:08:08,590
fundamentally someone was to get in

223
00:08:05,740 --> 00:08:10,510
they're getting in except that but we

224
00:08:08,590 --> 00:08:11,650
told clients is number one you're in the

225
00:08:10,510 --> 00:08:13,150
fight whether you thought you are not

226
00:08:11,650 --> 00:08:15,159
and number two you are most certainly

227
00:08:13,150 --> 00:08:16,299
penetrating this doesn't mean just throw

228
00:08:15,160 --> 00:08:17,920
up your hands and say well there's

229
00:08:16,300 --> 00:08:20,190
nothing we can do let's just you know

230
00:08:17,920 --> 00:08:22,889
call it a day and go home it's just

231
00:08:20,190 --> 00:08:23,939
realizing that you're not gonna stop

232
00:08:22,889 --> 00:08:28,409
permanent nothing I was there with

233
00:08:23,939 --> 00:08:31,409
enough funding so now we're going to

234
00:08:28,409 --> 00:08:34,200
talk about s you see him a little bit so

235
00:08:31,409 --> 00:08:36,450
what is s you see M stands for Microsoft

236
00:08:34,200 --> 00:08:40,560
System Center Configuration Manager and

237
00:08:36,450 --> 00:08:42,510
so in a very short synopsis it allows

238
00:08:40,559 --> 00:08:45,119
you to push out applications and updates

239
00:08:42,510 --> 00:08:46,769
kind of like wsus a little bit where you

240
00:08:45,120 --> 00:08:49,589
can manage you know like flash chrome

241
00:08:46,769 --> 00:08:52,019
command your endpoints with the

242
00:08:49,589 --> 00:08:54,149
centralized management point i'm itself

243
00:08:52,019 --> 00:08:56,490
maintained and since that the clients

244
00:08:54,149 --> 00:08:58,350
have agents installed and then they are

245
00:08:56,490 --> 00:09:01,019
calling back to a server so it's a lot

246
00:08:58,350 --> 00:09:03,269
like an internal rat if you gain control

247
00:09:01,019 --> 00:09:04,949
of it you can essentially just use that

248
00:09:03,269 --> 00:09:08,040
ease or communicant role without - ete

249
00:09:04,949 --> 00:09:09,479
grows and so will periodically check in

250
00:09:08,040 --> 00:09:11,490
to get new stuff

251
00:09:09,480 --> 00:09:13,589
the check-in times vary from client to

252
00:09:11,490 --> 00:09:16,440
client they can set it up in a set of

253
00:09:13,589 --> 00:09:18,720
itself the package that we made can

254
00:09:16,440 --> 00:09:20,730
force the device check in so you don't

255
00:09:18,720 --> 00:09:23,670
photo waiting around forever and we'll

256
00:09:20,730 --> 00:09:25,380
go over all the details and yeah one

257
00:09:23,670 --> 00:09:27,260
other thing to mention the SDM is is not

258
00:09:25,380 --> 00:09:29,610
just command and control it also does

259
00:09:27,260 --> 00:09:31,709
kind of all automatic information

260
00:09:29,610 --> 00:09:32,670
gathering so by default it'll see like

261
00:09:31,709 --> 00:09:34,290
one of the recently launched

262
00:09:32,670 --> 00:09:36,060
applications where the install packages

263
00:09:34,290 --> 00:09:37,740
where the shares and there's a lot of

264
00:09:36,060 --> 00:09:39,390
different options you can have to tune

265
00:09:37,740 --> 00:09:40,769
it together even more information with

266
00:09:39,390 --> 00:09:42,480
your existing architecture and we'll go

267
00:09:40,769 --> 00:09:44,209
over some of the defensive tuning

268
00:09:42,480 --> 00:09:46,470
components later on in the presentation

269
00:09:44,209 --> 00:09:48,209
if so how we typically see in an

270
00:09:46,470 --> 00:09:50,220
enterprise is it will have one central

271
00:09:48,209 --> 00:09:52,199
server and then a lot of distribution

272
00:09:50,220 --> 00:09:53,279
points and so they all this stuff gets

273
00:09:52,199 --> 00:09:55,290
replicated out to the distribution

274
00:09:53,279 --> 00:09:57,180
points which can be widespread

275
00:09:55,290 --> 00:09:59,730
throughout the country

276
00:09:57,180 --> 00:10:02,189
they're supposed to kind of have it set

277
00:09:59,730 --> 00:10:04,350
up so that you know there are service

278
00:10:02,190 --> 00:10:06,960
accounts that run you know to pushed

279
00:10:04,350 --> 00:10:09,810
update so that when the sec and pushes

280
00:10:06,960 --> 00:10:11,910
out clients to host that half staff will

281
00:10:09,810 --> 00:10:13,619
fly them in to install it so they're the

282
00:10:11,910 --> 00:10:15,900
way we see it most is they've got a

283
00:10:13,620 --> 00:10:17,330
domain admin service account that is

284
00:10:15,900 --> 00:10:21,360
installing and pushing this stuff out

285
00:10:17,330 --> 00:10:23,400
and so as far as the applications ago a

286
00:10:21,360 --> 00:10:25,710
big way that hosted up on an open share

287
00:10:23,400 --> 00:10:28,050
so that you know the endpoints can reach

288
00:10:25,710 --> 00:10:30,450
out and grab the packages one thing that

289
00:10:28,050 --> 00:10:31,709
I've seen the most of is admins and you

290
00:10:30,450 --> 00:10:33,150
shared what we've installed those

291
00:10:31,710 --> 00:10:33,900
install scripts that have credentials

292
00:10:33,150 --> 00:10:35,459
mmmm

293
00:10:33,900 --> 00:10:37,740
nine times out of ten for the service

294
00:10:35,460 --> 00:10:40,080
account that's a domain admin that's

295
00:10:37,740 --> 00:10:41,940
running on the associate box and so

296
00:10:40,080 --> 00:10:43,560
admins are gonna happen what makes fun

297
00:10:41,940 --> 00:10:45,210
of me for saying that but it never fails

298
00:10:43,560 --> 00:10:48,029
everybody always somewhere leaves

299
00:10:45,210 --> 00:10:50,130
something going to share that allows us

300
00:10:48,029 --> 00:10:51,630
to kind of abuse FCC no I'm the

301
00:10:50,130 --> 00:10:54,029
important thing to note about this is

302
00:10:51,630 --> 00:10:55,860
that this isn't here's how you go CONUS

303
00:10:54,029 --> 00:10:58,620
you see him it's how once you have

304
00:10:55,860 --> 00:11:00,750
access to it how can you use it to the

305
00:10:58,620 --> 00:11:03,600
further you know operate any network

306
00:11:00,750 --> 00:11:05,580
yeah this is a post exploitation concept

307
00:11:03,600 --> 00:11:07,770
in this presentation on the offensive

308
00:11:05,580 --> 00:11:09,300
side so we're not exploiting a CCM if

309
00:11:07,770 --> 00:11:11,449
it's set up correctly there's not really

310
00:11:09,300 --> 00:11:16,079
anything you can do to attack it but

311
00:11:11,450 --> 00:11:17,520
that's very very rarely set up typically

312
00:11:16,080 --> 00:11:19,800
there have managed via control groups

313
00:11:17,520 --> 00:11:21,360
and so you get access to you guys for

314
00:11:19,800 --> 00:11:23,099
that control group who's not a domain

315
00:11:21,360 --> 00:11:24,420
admin but can administer us you see him

316
00:11:23,100 --> 00:11:26,600
and you can use that to pivot your way

317
00:11:24,420 --> 00:11:26,599
up

318
00:11:27,470 --> 00:11:32,160
hey skipper sir no that's kind of what

319
00:11:30,540 --> 00:11:33,540
the architecture looks like in a very

320
00:11:32,160 --> 00:11:34,620
high level so you've got your primary

321
00:11:33,540 --> 00:11:36,930
site server then you've got your

322
00:11:34,620 --> 00:11:38,850
distribution points and then you know

323
00:11:36,930 --> 00:11:39,959
you've got different domains and your

324
00:11:38,850 --> 00:11:41,730
clients are reaching out to whatever

325
00:11:39,960 --> 00:11:48,510
distribution points closest to them and

326
00:11:41,730 --> 00:11:50,130
then it's all replicated so SCCM has two

327
00:11:48,510 --> 00:11:52,020
kind of backing components there's a

328
00:11:50,130 --> 00:11:56,339
sequel database which stores a lot of

329
00:11:52,020 --> 00:11:58,380
information and WMI back in which also

330
00:11:56,339 --> 00:12:01,830
stores a lot of information it's

331
00:11:58,380 --> 00:12:04,620
important to note that the stuff you see

332
00:12:01,830 --> 00:12:07,440
in the console press caesium is not even

333
00:12:04,620 --> 00:12:09,420
a fraction of the amount of information

334
00:12:07,440 --> 00:12:12,420
as you seen actually quite so they

335
00:12:09,420 --> 00:12:14,069
concluded back in W my and classes in

336
00:12:12,420 --> 00:12:15,270
the single database it's mind-blowing

337
00:12:14,070 --> 00:12:20,550
the amount of information that's

338
00:12:15,270 --> 00:12:21,960
actually gathered so the way that high

339
00:12:20,550 --> 00:12:25,170
res digium works is were able to

340
00:12:21,960 --> 00:12:27,480
manipulate the sequel database and W my

341
00:12:25,170 --> 00:12:28,920
classes directly to the backend without

342
00:12:27,480 --> 00:12:30,660
going through the friend interface and

343
00:12:28,920 --> 00:12:32,760
so we're able to hide a lot of things

344
00:12:30,660 --> 00:12:34,170
from the actual you know front-end the

345
00:12:32,760 --> 00:12:36,630
admins are gonna see when they log in

346
00:12:34,170 --> 00:12:38,010
and the key here is there's two ways to

347
00:12:36,630 --> 00:12:39,990
interface with it

348
00:12:38,010 --> 00:12:41,700
the sequel interface tends to be better

349
00:12:39,990 --> 00:12:43,830
for defense because you can get a lot of

350
00:12:41,700 --> 00:12:46,170
these link tables and a lot a lot more

351
00:12:43,830 --> 00:12:48,029
like detailed contextual information but

352
00:12:46,170 --> 00:12:49,170
it's very difficult to modify it so you

353
00:12:48,029 --> 00:12:50,370
have all these store procedures and

354
00:12:49,170 --> 00:12:52,110
everything's linked and whatever else

355
00:12:50,370 --> 00:12:53,490
though it's it was difficult for us to

356
00:12:52,110 --> 00:12:54,839
figure out how do we create a malicious

357
00:12:53,490 --> 00:12:57,300
package and push it out there pure

358
00:12:54,839 --> 00:12:58,560
sequel but W mine's a lot simpler you

359
00:12:57,300 --> 00:12:59,819
don't have as much information because

360
00:12:58,560 --> 00:13:02,520
you can't do the equivalent of linked

361
00:12:59,820 --> 00:13:04,950
tables but it makes it much easier to

362
00:13:02,520 --> 00:13:07,439
manipulate and create components so we

363
00:13:04,950 --> 00:13:09,089
use we recommend sequel the sequel

364
00:13:07,440 --> 00:13:11,400
approach in the sequel interface or

365
00:13:09,089 --> 00:13:12,900
defense and W microphones will show up a

366
00:13:11,400 --> 00:13:15,110
query or the difference between the two

367
00:13:12,900 --> 00:13:20,750
for a simple coin the same information

368
00:13:15,110 --> 00:13:23,720
they look like here so sequel it's just

369
00:13:20,750 --> 00:13:25,579
a normal you know sequel back in there's

370
00:13:23,720 --> 00:13:27,110
nothing crazy about it I'm not a sequel

371
00:13:25,579 --> 00:13:28,819
dev so I don't do a single stuff so I

372
00:13:27,110 --> 00:13:32,450
see sicko Mike oh my god it's ugly give

373
00:13:28,820 --> 00:13:34,070
it away it's great for as well as thing

374
00:13:32,450 --> 00:13:35,839
it's great for gathering information so

375
00:13:34,070 --> 00:13:37,970
it clot it collects a lot of a lot of

376
00:13:35,839 --> 00:13:42,200
really juicy information that might not

377
00:13:37,970 --> 00:13:43,399
be stored in W my the issue is sequel to

378
00:13:42,200 --> 00:13:46,220
be able to pull all that information

379
00:13:43,399 --> 00:13:48,260
directly you have to have a relatively

380
00:13:46,220 --> 00:13:50,390
decent background or in depth knowledge

381
00:13:48,260 --> 00:13:51,980
of the database itself and how all the

382
00:13:50,390 --> 00:13:53,480
tables and stuff work out and that's

383
00:13:51,980 --> 00:13:56,089
because this is what the schema looks

384
00:13:53,480 --> 00:13:58,070
like it's not properly documented it's

385
00:13:56,089 --> 00:14:00,500
kind of documented by Microsoft not a

386
00:13:58,070 --> 00:14:03,170
hundred percent so I spend about four

387
00:14:00,500 --> 00:14:04,790
days straight trying to parse through

388
00:14:03,170 --> 00:14:06,260
every single one of these tables and

389
00:14:04,790 --> 00:14:08,180
then the same bit of information of

390
00:14:06,260 --> 00:14:09,769
saying show me installed applications

391
00:14:08,180 --> 00:14:11,779
it's in like four different places and

392
00:14:09,769 --> 00:14:13,399
there's a few then there's one with some

393
00:14:11,779 --> 00:14:14,630
information on other information some of

394
00:14:13,399 --> 00:14:17,510
it links to the clients some of it

395
00:14:14,630 --> 00:14:20,510
doesn't some of randomized SIDS so I

396
00:14:17,510 --> 00:14:23,329
if anyone's a sequel admin or a DBA I

397
00:14:20,510 --> 00:14:25,040
don't envy your job because this was not

398
00:14:23,329 --> 00:14:26,660
fun trying to like basic

399
00:14:25,040 --> 00:14:28,069
reverse-engineer how the schema is

400
00:14:26,660 --> 00:14:29,930
actually set up and how everything is

401
00:14:28,070 --> 00:14:31,850
linked and then each one of these tables

402
00:14:29,930 --> 00:14:33,949
in each field all these views are kind

403
00:14:31,850 --> 00:14:36,079
of essentially mapped to whittle and W

404
00:14:33,949 --> 00:14:38,660
my classes in the backend but again

405
00:14:36,079 --> 00:14:42,140
that's not documented so we we did our

406
00:14:38,660 --> 00:14:43,519
best with our SCCM to abstract away loss

407
00:14:42,140 --> 00:14:44,899
complexity so you don't have to memorize

408
00:14:43,519 --> 00:14:48,649
all these queries exactly where it's

409
00:14:44,899 --> 00:14:49,940
going but it's not complete I guess at

410
00:14:48,649 --> 00:14:52,910
the point so we're because we're not

411
00:14:49,940 --> 00:14:55,699
sequel experts we did our best but no

412
00:14:52,910 --> 00:14:57,170
guarantees so I'm not gonna go through

413
00:14:55,699 --> 00:14:58,459
all these but this is a small example of

414
00:14:57,170 --> 00:15:01,069
some of the really interesting tables

415
00:14:58,459 --> 00:15:03,050
you know show me the current processes

416
00:15:01,070 --> 00:15:04,250
you know view GS from pro of course that

417
00:15:03,050 --> 00:15:06,439
makes sense I have no idea about the

418
00:15:04,250 --> 00:15:07,820
naming scheme or historical processes HS

419
00:15:06,440 --> 00:15:09,829
doesn't actually stand for historical

420
00:15:07,820 --> 00:15:12,140
stance or something else in in certain

421
00:15:09,829 --> 00:15:15,040
fields these are switched in GSS

422
00:15:12,140 --> 00:15:17,720
historical and HS has non historical so

423
00:15:15,040 --> 00:15:19,880
whatever but you can do tons of stuff

424
00:15:17,720 --> 00:15:23,480
like browser helper objects software

425
00:15:19,880 --> 00:15:24,590
files drivers open shares currently

426
00:15:23,480 --> 00:15:26,030
logged on user

427
00:15:24,590 --> 00:15:28,100
there's a huge amount of stuff that if

428
00:15:26,030 --> 00:15:29,750
you tune up the collection component you

429
00:15:28,100 --> 00:15:31,490
get some awesome stuff that you can

430
00:15:29,750 --> 00:15:33,170
either manually search from the

431
00:15:31,490 --> 00:15:34,550
defensive CyberPower cesium or throw

432
00:15:33,170 --> 00:15:35,959
into something like spelunking we'll

433
00:15:34,550 --> 00:15:37,459
have a slide I'm kind of configuring

434
00:15:35,960 --> 00:15:39,950
hooking all that stuff up for your

435
00:15:37,460 --> 00:15:42,050
Center but tons and tons of stuff I

436
00:15:39,950 --> 00:15:44,330
think the browser helper objects kind of

437
00:15:42,050 --> 00:15:45,920
blew my mind auto starts you could find

438
00:15:44,330 --> 00:15:51,530
a lot of really basic persistence and

439
00:15:45,920 --> 00:15:54,680
things like that and then Debbie my you

440
00:15:51,530 --> 00:15:57,079
know uses WOL the women free language

441
00:15:54,680 --> 00:15:58,880
and so you can interact with this really

442
00:15:57,080 --> 00:16:01,070
easily with PowerShell via to get W my

443
00:15:58,880 --> 00:16:03,920
object which is how we end up doing it

444
00:16:01,070 --> 00:16:05,540
on the back end what we're saying

445
00:16:03,920 --> 00:16:09,140
earlier that be my it's so much easier

446
00:16:05,540 --> 00:16:10,969
to update you just a one-line thing

447
00:16:09,140 --> 00:16:15,530
versus like spinning three and a half

448
00:16:10,970 --> 00:16:18,170
hours crafting a sequel query the the

449
00:16:15,530 --> 00:16:19,790
neat thing about WMI is that you can if

450
00:16:18,170 --> 00:16:21,650
you match up all the properties you can

451
00:16:19,790 --> 00:16:23,000
just throw it the glasses and it'll

452
00:16:21,650 --> 00:16:24,620
update the stuff in the backend

453
00:16:23,000 --> 00:16:27,740
so some of like an application package

454
00:16:24,620 --> 00:16:29,180
requires a non-trivial XML schema to

455
00:16:27,740 --> 00:16:30,530
actually describe everything so instead

456
00:16:29,180 --> 00:16:32,270
of having to figure out how to link that

457
00:16:30,530 --> 00:16:34,130
in the database we can just push that

458
00:16:32,270 --> 00:16:35,270
out to one dummy my class property and

459
00:16:34,130 --> 00:16:36,590
then the backend takes care of

460
00:16:35,270 --> 00:16:38,720
everything it does all the awesome stuff

461
00:16:36,590 --> 00:16:40,340
that's not super documented either so I

462
00:16:38,720 --> 00:16:41,840
had to push out applications and then

463
00:16:40,340 --> 00:16:43,610
pull the XML and figure out what was

464
00:16:41,840 --> 00:16:45,530
required and we're Microsoft doesn't

465
00:16:43,610 --> 00:16:47,330
have a MSDN about here's how you create

466
00:16:45,530 --> 00:16:48,680
a hidden malicious package it doesn't

467
00:16:47,330 --> 00:16:54,200
touch the testings an se I don't know

468
00:16:48,680 --> 00:16:57,199
why they do that that's kind what it

469
00:16:54,200 --> 00:16:58,610
looks like this is to be my Explorer

470
00:16:57,200 --> 00:17:00,470
everybody use that it's an amazing

471
00:16:58,610 --> 00:17:02,600
resource to to browse they be my pretty

472
00:17:00,470 --> 00:17:04,400
quickly under the estimate any choice

473
00:17:02,600 --> 00:17:06,410
everything's under the root SMS and then

474
00:17:04,400 --> 00:17:08,540
the slight underscored in the site code

475
00:17:06,410 --> 00:17:10,280
that's operating out of and then there's

476
00:17:08,540 --> 00:17:12,168
just an incredible amount of different

477
00:17:10,280 --> 00:17:14,959
classes that you can see you can

478
00:17:12,169 --> 00:17:16,639
with yep so peace allah was spending

479
00:17:14,959 --> 00:17:18,169
four days looking to the sequel schema

480
00:17:16,638 --> 00:17:19,819
he spent about four days looking through

481
00:17:18,169 --> 00:17:21,470
the WMI schema to try to find a quick

482
00:17:19,819 --> 00:17:23,449
monster and the name of the naming

483
00:17:21,470 --> 00:17:25,608
scheme for the classes versus sequel

484
00:17:23,449 --> 00:17:27,649
that's equally as frustrating because

485
00:17:25,608 --> 00:17:28,970
none of the names make sense and so

486
00:17:27,648 --> 00:17:30,889
you're like oh this seems like maybe

487
00:17:28,970 --> 00:17:32,440
this is something I need and it turns

488
00:17:30,889 --> 00:17:35,600
out to be something completely different

489
00:17:32,440 --> 00:17:37,269
so this is the difference this is to get

490
00:17:35,600 --> 00:17:39,678
all applications

491
00:17:37,269 --> 00:17:42,950
WMI that's the query and that's what we

492
00:17:39,679 --> 00:17:45,710
need is for sequel so a lot of the

493
00:17:42,950 --> 00:17:47,779
functions in power cesium will wrap a

494
00:17:45,710 --> 00:17:49,190
super-long sequel query with all the

495
00:17:47,779 --> 00:17:51,139
arguments and everything abstracted out

496
00:17:49,190 --> 00:17:52,429
so you don't have to worry about it but

497
00:17:51,139 --> 00:17:53,689
if you want to throw into like a custom

498
00:17:52,429 --> 00:17:55,429
sim and gesture or something like that

499
00:17:53,690 --> 00:17:57,080
you can just pull the raw query straight

500
00:17:55,429 --> 00:17:59,269
out of the power SC same package and do

501
00:17:57,080 --> 00:18:02,269
it manually if you like this really this

502
00:17:59,269 --> 00:18:04,039
really shines and where you have a lot

503
00:18:02,269 --> 00:18:06,109
more you can get much more granular with

504
00:18:04,039 --> 00:18:07,850
SQL in the sense that you can do all of

505
00:18:06,109 --> 00:18:10,100
this you can craft a really detailed

506
00:18:07,850 --> 00:18:12,289
specific queries or says WMI are kind of

507
00:18:10,100 --> 00:18:13,519
they're kind of limited into what the

508
00:18:12,289 --> 00:18:16,100
classes or properties are actually

509
00:18:13,519 --> 00:18:18,139
available to you which is what makes

510
00:18:16,100 --> 00:18:19,959
sequel a lot nicer from having all that

511
00:18:18,139 --> 00:18:24,340
good stuff

512
00:18:19,960 --> 00:18:34,900
cool time so that that's enough of us

513
00:18:24,340 --> 00:18:36,550
complaining about how yes yeah I mean

514
00:18:34,900 --> 00:18:38,020
it's so the question was you know or

515
00:18:36,550 --> 00:18:39,250
what assumptions are you making as far

516
00:18:38,020 --> 00:18:41,470
as the open ports and different things

517
00:18:39,250 --> 00:18:43,240
like that so it's it's standard windows

518
00:18:41,470 --> 00:18:45,910
functionality is the same court that w

519
00:18:43,240 --> 00:18:47,830
my uses for remote sequel connections as

520
00:18:45,910 --> 00:18:49,540
the same port that you know sequel users

521
00:18:47,830 --> 00:18:50,980
it's hard to block because in the

522
00:18:49,540 --> 00:18:53,710
clients check-in that's that's getting

523
00:18:50,980 --> 00:18:55,510
updated yeah so in general the ports and

524
00:18:53,710 --> 00:18:57,880
everything tend to be relatively opening

525
00:18:55,510 --> 00:19:00,010
on the SCCM servers themselves because

526
00:18:57,880 --> 00:19:01,300
it's you know if they try to lock down

527
00:19:00,010 --> 00:19:03,400
everything you know it probably

528
00:19:01,300 --> 00:19:05,590
introduces issues when they're using in

529
00:19:03,400 --> 00:19:06,940
production so more often than not they

530
00:19:05,590 --> 00:19:09,850
like drop a lot of the firewall rules

531
00:19:06,940 --> 00:19:10,930
and make it relatively open so enough of

532
00:19:09,850 --> 00:19:13,360
us complaining about how terrible

533
00:19:10,930 --> 00:19:15,220
schemas and the super exciting we're

534
00:19:13,360 --> 00:19:17,350
gonna go over the power AC same package

535
00:19:15,220 --> 00:19:19,570
which is a proper PowerShell module that

536
00:19:17,350 --> 00:19:21,790
we published for this stuff it's not on

537
00:19:19,570 --> 00:19:23,110
the PowerShell gallery it's on we'll

538
00:19:21,790 --> 00:19:25,180
have links at the end it's on the the

539
00:19:23,110 --> 00:19:27,399
PowerShell mafia group repo that has

540
00:19:25,180 --> 00:19:29,380
like power sploit paresthesia min a

541
00:19:27,400 --> 00:19:33,330
bunch of the really cool proper packages

542
00:19:29,380 --> 00:19:35,710
we've been developing so background

543
00:19:33,330 --> 00:19:38,560
along with you know if you're trying to

544
00:19:35,710 --> 00:19:41,440
abuse SCCM properly in the field along

545
00:19:38,560 --> 00:19:42,460
with Nene not knowledge about the WMI

546
00:19:41,440 --> 00:19:43,540
scheme in the sequel scheme and

547
00:19:42,460 --> 00:19:45,820
everything else you have to have a

548
00:19:43,540 --> 00:19:47,320
pretty detailed knowledge about SCCM so

549
00:19:45,820 --> 00:19:49,780
what you wanted to abstract away a lot

550
00:19:47,320 --> 00:19:51,310
of the complexity and bring a lot of

551
00:19:49,780 --> 00:19:52,899
this functionality to people on

552
00:19:51,310 --> 00:19:54,310
engagements and on offense and defensive

553
00:19:52,900 --> 00:19:56,380
side to use it without having to be

554
00:19:54,310 --> 00:19:58,659
experts in this stuff so there's not a

555
00:19:56,380 --> 00:20:01,840
lot of public information on abusing

556
00:19:58,660 --> 00:20:04,870
SCCM the only presentation we're aware

557
00:20:01,840 --> 00:20:07,929
of was Dave Canadian Dave and Dave de

558
00:20:04,870 --> 00:20:09,969
Simone's Def Con 20 only wanted to rule

559
00:20:07,930 --> 00:20:11,950
them all presentation is it's super cool

560
00:20:09,970 --> 00:20:13,360
we'll definitely go check it out and I

561
00:20:11,950 --> 00:20:15,100
think this functional is actually

562
00:20:13,360 --> 00:20:17,229
actually introduced into the social

563
00:20:15,100 --> 00:20:18,850
engineering toolkit so you can push some

564
00:20:17,230 --> 00:20:20,770
stuff out that will like pack some

565
00:20:18,850 --> 00:20:22,209
existing SCC in packages and push out

566
00:20:20,770 --> 00:20:24,820
agents to a large number of machines

567
00:20:22,210 --> 00:20:26,770
this is great this is a few years ago we

568
00:20:24,820 --> 00:20:28,090
saw this we're kind of inspired and we

569
00:20:26,770 --> 00:20:30,160
want to take this to the next level

570
00:20:28,090 --> 00:20:31,939
instead of saying mass ownage how about

571
00:20:30,160 --> 00:20:33,950
we hunt for exactly we're sort

572
00:20:31,940 --> 00:20:35,480
Larr and create targeted collections and

573
00:20:33,950 --> 00:20:41,870
a very hidden kind of more like read

574
00:20:35,480 --> 00:20:43,460
teeny type way so basic usage for the

575
00:20:41,870 --> 00:20:45,620
package you import your PowerShell

576
00:20:43,460 --> 00:20:49,039
module and we have assessed a session

577
00:20:45,620 --> 00:20:50,840
based model and FCM so very similar to

578
00:20:49,039 --> 00:20:54,259
sim sessions and like windows remoting

579
00:20:50,840 --> 00:20:56,720
sessions we have like new SCCM session

580
00:20:54,259 --> 00:20:58,700
which you can specify WMI or sequel it

581
00:20:56,720 --> 00:21:00,440
registers it saves it off as an object

582
00:20:58,700 --> 00:21:01,879
with all the configurations and then you

583
00:21:00,440 --> 00:21:05,539
pass those objects in the powershell

584
00:21:01,879 --> 00:21:07,490
pipeline to any of the query or abuse

585
00:21:05,539 --> 00:21:09,980
type functionality that you need so you

586
00:21:07,490 --> 00:21:11,779
know get SCCM session you know get a CCM

587
00:21:09,980 --> 00:21:13,580
application so if you're not used to

588
00:21:11,779 --> 00:21:15,259
powershell this is a bit weird but we

589
00:21:13,580 --> 00:21:17,750
were trying to do it like properly in

590
00:21:15,259 --> 00:21:20,120
PowerShell II because my boss being Mac

591
00:21:17,750 --> 00:21:21,230
braver manifestation he said that I

592
00:21:20,120 --> 00:21:22,459
actually have the right proper

593
00:21:21,230 --> 00:21:25,610
PowerShell now instead of just writing

594
00:21:22,460 --> 00:21:27,169
scripts so yeah removing remove SCCM

595
00:21:25,610 --> 00:21:29,389
session will kill a session and one

596
00:21:27,169 --> 00:21:30,799
thing that dimension before is if you're

597
00:21:29,389 --> 00:21:32,360
trying to determine where these site

598
00:21:30,799 --> 00:21:33,860
servers are and all these site codes are

599
00:21:32,360 --> 00:21:36,979
we have functionality they'll let you do

600
00:21:33,860 --> 00:21:38,990
that as well too so if you line a local

601
00:21:36,980 --> 00:21:40,460
machine you can use fine local ICC MFO

602
00:21:38,990 --> 00:21:42,559
and they'll return all the configuration

603
00:21:40,460 --> 00:21:44,330
stuff all the site codes if you know

604
00:21:42,559 --> 00:21:46,158
where the FCC observer is we have

605
00:21:44,330 --> 00:21:47,658
interfaces that let you a numerate all

606
00:21:46,159 --> 00:21:50,419
the sites and distribution points

607
00:21:47,659 --> 00:21:52,669
remotely so pretty much anything we can

608
00:21:50,419 --> 00:21:53,750
think of for normal functionality how we

609
00:21:52,669 --> 00:21:55,129
would use it we tried to build

610
00:21:53,750 --> 00:21:58,820
commandments that would automate this

611
00:21:55,129 --> 00:22:00,620
yes what permissions are required whoo

612
00:21:58,820 --> 00:22:03,590
yeah he'll go over that just a little

613
00:22:00,620 --> 00:22:05,360
bit in the attack side but you need you

614
00:22:03,590 --> 00:22:07,939
know administrative access on the SCCM

615
00:22:05,360 --> 00:22:10,580
server right so again like he had said

616
00:22:07,940 --> 00:22:13,370
that ideally in a perfect world there's

617
00:22:10,580 --> 00:22:15,049
no way you could do that but there's you

618
00:22:13,370 --> 00:22:16,758
don't need domain admin to actually

619
00:22:15,049 --> 00:22:19,570
administer an SEM server which a lot of

620
00:22:16,759 --> 00:22:19,570
people think yes

621
00:22:20,640 --> 00:22:25,600
can you use on a box it's not domain I

622
00:22:23,170 --> 00:22:27,520
we integrated credential objects

623
00:22:25,600 --> 00:22:29,559
external prudential objects into this

624
00:22:27,520 --> 00:22:31,750
project we did do extensive testing as

625
00:22:29,559 --> 00:22:34,149
far as like an on-demand join machine we

626
00:22:31,750 --> 00:22:35,950
typically just used it on a regular

627
00:22:34,150 --> 00:22:38,620
domain join machine for the most part

628
00:22:35,950 --> 00:22:40,450
what you fish your initial user but with

629
00:22:38,620 --> 00:22:42,189
additional credential objects if you

630
00:22:40,450 --> 00:22:44,049
don't have to have you know a DEA

631
00:22:42,190 --> 00:22:45,309
contacts running in order to interact

632
00:22:44,049 --> 00:22:48,670
with it you can pass the credential

633
00:22:45,309 --> 00:22:51,190
object so there's an example you know

634
00:22:48,670 --> 00:22:52,570
import power SCCM new SCC obsession you

635
00:22:51,190 --> 00:22:54,610
know doing the computer name for the

636
00:22:52,570 --> 00:22:56,350
SCCM site server where the site code is

637
00:22:54,610 --> 00:22:58,080
and in this particular instance we're

638
00:22:56,350 --> 00:23:00,580
gonna use sequel this will connect off

639
00:22:58,080 --> 00:23:02,500
save everything up you see all the

640
00:23:00,580 --> 00:23:06,549
particular sequel permissions like those

641
00:23:02,500 --> 00:23:08,290
connections or stuff this is how you

642
00:23:06,549 --> 00:23:10,000
would actually use it just like in the

643
00:23:08,290 --> 00:23:11,710
previous slide example I showed this is

644
00:23:10,000 --> 00:23:13,809
what the output will look like you'll

645
00:23:11,710 --> 00:23:15,429
get a ton ton ton of stuff these are all

646
00:23:13,809 --> 00:23:16,960
proper PowerShell objects so if you're

647
00:23:15,429 --> 00:23:19,270
used to like dole turning the pipeline

648
00:23:16,960 --> 00:23:22,210
and all that it should work correctly

649
00:23:19,270 --> 00:23:23,799
was this SEO services yeah so in that

650
00:23:22,210 --> 00:23:25,660
particular machine that particular IP

651
00:23:23,799 --> 00:23:28,720
address it'll list all the running

652
00:23:25,660 --> 00:23:30,309
services right nothing too great but you

653
00:23:28,720 --> 00:23:31,890
can start to do some cool stuff with it

654
00:23:30,309 --> 00:23:35,320
at the end

655
00:23:31,890 --> 00:23:36,850
so using SDM is an attack pop this is

656
00:23:35,320 --> 00:23:38,740
the cool stuff this is defense is lame

657
00:23:36,850 --> 00:23:40,659
whatever I did do that but what's that

658
00:23:38,740 --> 00:23:43,030
offenses the cool stuff so in our red

659
00:23:40,660 --> 00:23:44,590
team as we tend to stay towards or

660
00:23:43,030 --> 00:23:47,168
operate more towards using admin tools

661
00:23:44,590 --> 00:23:48,909
against them so we're an authorized

662
00:23:47,169 --> 00:23:50,500
domain admins is the way that we see it

663
00:23:48,910 --> 00:23:55,090
is we just go in and administer stuff

664
00:23:50,500 --> 00:23:56,950
for them so the nice thing about su

665
00:23:55,090 --> 00:23:58,449
scheme is it already exists and so

666
00:23:56,950 --> 00:23:59,179
you're not introducing anything new into

667
00:23:58,450 --> 00:24:02,269
the environment

668
00:23:59,179 --> 00:24:03,679
- maybe your us point so traffic's

669
00:24:02,269 --> 00:24:05,690
completely normal

670
00:24:03,679 --> 00:24:07,580
a lot of people don't think of looking

671
00:24:05,690 --> 00:24:09,769
at a forensic or hunt or incident

672
00:24:07,580 --> 00:24:11,570
response level of hey maybe something

673
00:24:09,769 --> 00:24:13,789
happened in secm life we should go look

674
00:24:11,570 --> 00:24:16,099
at this and something that's not a

675
00:24:13,789 --> 00:24:18,200
solved problem that we know publicly you

676
00:24:16,099 --> 00:24:20,178
know if attackers are abusing secm how

677
00:24:18,200 --> 00:24:21,830
do you do forensics on SCCM server

678
00:24:20,179 --> 00:24:24,379
itself in the database and how can you

679
00:24:21,830 --> 00:24:25,789
detect these packages this does leave a

680
00:24:24,379 --> 00:24:27,498
lot of artifacts in there so that'd be

681
00:24:25,789 --> 00:24:29,929
something for someone to look into I

682
00:24:27,499 --> 00:24:32,059
think would be very interesting yeah and

683
00:24:29,929 --> 00:24:35,409
there have been rumors of some actors

684
00:24:32,059 --> 00:24:38,690
actually using a cesium to mass deploy

685
00:24:35,409 --> 00:24:40,700
in VR wipers after they're done there

686
00:24:38,690 --> 00:24:42,169
was a actually crime or gang and the

687
00:24:40,700 --> 00:24:43,909
news a couple months ago they use SD

688
00:24:42,169 --> 00:24:45,919
seem to push out cryptolocker for an

689
00:24:43,909 --> 00:24:47,389
entire domain so instead of one machine

690
00:24:45,919 --> 00:24:50,419
it's like oh let me found this yeah

691
00:24:47,389 --> 00:24:52,129
everything's crypto logger so looking

692
00:24:50,419 --> 00:24:53,839
normal greatly reduces your chances of

693
00:24:52,129 --> 00:25:01,728
actually getting caught which is what

694
00:24:53,839 --> 00:25:03,049
we're relatively confident in so this

695
00:25:01,729 --> 00:25:05,149
goes to the permission question

696
00:25:03,049 --> 00:25:06,859
attacking us you seem that da when we

697
00:25:05,149 --> 00:25:08,629
initially introduced a concept we got a

698
00:25:06,859 --> 00:25:10,009
lot of pushback of like oh if you have

699
00:25:08,629 --> 00:25:12,379
da it's already over type of thing

700
00:25:10,009 --> 00:25:14,419
that's why we like to stress that this

701
00:25:12,379 --> 00:25:16,428
is a variance is very much of a post

702
00:25:14,419 --> 00:25:19,460
exploitation thing and not an initial

703
00:25:16,429 --> 00:25:21,259
vector thing and so the way they are

704
00:25:19,460 --> 00:25:23,899
supposed to set it up is you don't run

705
00:25:21,259 --> 00:25:25,369
everything as da you know that'll get

706
00:25:23,899 --> 00:25:27,830
your groups out when they give access to

707
00:25:25,369 --> 00:25:29,928
what's needed so people will have that

708
00:25:27,830 --> 00:25:31,489
cesium atoms and so using something like

709
00:25:29,929 --> 00:25:33,799
Power View you can go in hunt

710
00:25:31,489 --> 00:25:35,359
rescue team admins you know find a way

711
00:25:33,799 --> 00:25:38,290
to get it once you actually get their

712
00:25:35,359 --> 00:25:40,210
credentials or access or whatever

713
00:25:38,290 --> 00:25:42,550
you might not have access to the entire

714
00:25:40,210 --> 00:25:44,410
network but you can use that to pivots

715
00:25:42,550 --> 00:25:47,139
throughout the network in a different

716
00:25:44,410 --> 00:25:48,610
way than what might be normal to get to

717
00:25:47,140 --> 00:25:56,350
your crown jewels here your other

718
00:25:48,610 --> 00:25:57,909
elevated accounts so as I mentioned

719
00:25:56,350 --> 00:25:59,350
earlier getting a group you can kind of

720
00:25:57,910 --> 00:26:00,970
hunt for some other groups that have su

721
00:25:59,350 --> 00:26:03,310
seam in them this will give you a good

722
00:26:00,970 --> 00:26:04,930
ideas of a good idea of what user do you

723
00:26:03,310 --> 00:26:07,360
want to go home and that first step is

724
00:26:04,930 --> 00:26:09,790
you know figuring out what's the naming

725
00:26:07,360 --> 00:26:11,469
scheme this kind of goes it blends with

726
00:26:09,790 --> 00:26:13,030
the offensive Active Directory stuff so

727
00:26:11,470 --> 00:26:15,580
we're not gonna go heavily into that

728
00:26:13,030 --> 00:26:17,230
because those are yeah it's a huge other

729
00:26:15,580 --> 00:26:18,490
like you know bit of knowledge but we're

730
00:26:17,230 --> 00:26:20,350
happy to talk about it later but

731
00:26:18,490 --> 00:26:22,900
identify who you want to who you want to

732
00:26:20,350 --> 00:26:24,490
go after start group you know if you

733
00:26:22,900 --> 00:26:28,440
haven't seen wills talking gibberish

734
00:26:24,490 --> 00:26:33,520
2016 about carve you could check it out

735
00:26:28,440 --> 00:26:34,960
so using sec for code execution so like

736
00:26:33,520 --> 00:26:37,510
I said mention but like I mentioned

737
00:26:34,960 --> 00:26:39,190
earlier the clients check in to the

738
00:26:37,510 --> 00:26:40,690
server if there's a new application or

739
00:26:39,190 --> 00:26:43,030
package and it'll download it and

740
00:26:40,690 --> 00:26:45,550
execute it and so what this means is

741
00:26:43,030 --> 00:26:47,680
that if we can gain access we can post a

742
00:26:45,550 --> 00:26:50,260
binary tailored on the share or we can

743
00:26:47,680 --> 00:26:53,290
create some sort of malicious deployment

744
00:26:50,260 --> 00:26:56,290
or application and win the code the way

745
00:26:53,290 --> 00:26:58,540
that we set power s UTM up is it

746
00:26:56,290 --> 00:27:00,430
actually it's all using PowerShell so

747
00:26:58,540 --> 00:27:02,710
there's no you know new binaries or any

748
00:27:00,430 --> 00:27:04,930
of that stuff so normally you would RDP

749
00:27:02,710 --> 00:27:07,480
into the GUI right so you compromised an

750
00:27:04,930 --> 00:27:10,270
SDC madman or the server itself and then

751
00:27:07,480 --> 00:27:12,039
just RDP in and use the exact same FCC

752
00:27:10,270 --> 00:27:13,749
Mebane functionality that

753
00:27:12,039 --> 00:27:17,619
otherwise and we got tired of doing that

754
00:27:13,749 --> 00:27:21,450
so there's no package yeah and then it

755
00:27:17,619 --> 00:27:21,449
runs a systems that's nice

756
00:27:22,779 --> 00:27:28,749
so using for evil these are kind of the

757
00:27:25,690 --> 00:27:31,090
offensive commandments and I'm coming

758
00:27:28,749 --> 00:27:32,559
over them a little bit new and we'll go

759
00:27:31,090 --> 00:27:34,029
over the whole process of grouping the

760
00:27:32,559 --> 00:27:35,739
users putting the applications and

761
00:27:34,029 --> 00:27:37,210
weekend rating together so there's more

762
00:27:35,739 --> 00:27:38,739
for reference will tweet out these

763
00:27:37,210 --> 00:27:40,419
slides right after the presentation so

764
00:27:38,739 --> 00:27:41,889
we're not gonna wait detail every single

765
00:27:40,419 --> 00:27:42,639
command like these that would be super

766
00:27:41,889 --> 00:27:44,799
exciting

767
00:27:42,639 --> 00:27:46,178
so hunting for users you know you can do

768
00:27:44,799 --> 00:27:48,549
that with carve you already the nice

769
00:27:46,179 --> 00:27:50,979
thing about SEM is it logs and collects

770
00:27:48,549 --> 00:27:52,418
where users are logged in you know what

771
00:27:50,979 --> 00:27:54,309
time they logged in what boxes are

772
00:27:52,419 --> 00:27:57,399
walking on and so you can actually use

773
00:27:54,309 --> 00:27:59,889
that to to pull out targets and so you

774
00:27:57,399 --> 00:28:01,478
can use get se team computer if you know

775
00:27:59,889 --> 00:28:03,580
a little bit about PowerShell I plan on

776
00:28:01,479 --> 00:28:05,440
fixing this so you can just pass user

777
00:28:03,580 --> 00:28:07,928
name but right now you can just pull out

778
00:28:05,440 --> 00:28:09,519
the last log on user name and um if it's

779
00:28:07,929 --> 00:28:12,369
equals whatever you're looking for we

780
00:28:09,519 --> 00:28:13,599
return the target and you can go about

781
00:28:12,369 --> 00:28:15,639
what you want to do with it

782
00:28:13,599 --> 00:28:17,499
there's also the get system console

783
00:28:15,639 --> 00:28:20,738
usage so as she assumed collects data in

784
00:28:17,499 --> 00:28:23,950
different ways and so sometimes the last

785
00:28:20,739 --> 00:28:25,539
log on username can be finicky and might

786
00:28:23,950 --> 00:28:27,009
not be yes that's more like the windows

787
00:28:25,539 --> 00:28:28,690
session kind of component and this is

788
00:28:27,009 --> 00:28:32,080
going to be logging the actual command

789
00:28:28,690 --> 00:28:34,149
line execution so yeah occasionally it's

790
00:28:32,080 --> 00:28:35,769
not 100% accurate and sometimes FCC

791
00:28:34,149 --> 00:28:37,418
misses information in certain ways so

792
00:28:35,769 --> 00:28:39,700
it's just two different ways to get to

793
00:28:37,419 --> 00:28:41,049
the same same console usage is enabled

794
00:28:39,700 --> 00:28:42,580
by default and that's been the most

795
00:28:41,049 --> 00:28:44,408
accurate from what I've seen I'm it

796
00:28:42,580 --> 00:28:46,300
almost instantaneous tells you who's

797
00:28:44,409 --> 00:28:48,550
logged in

798
00:28:46,300 --> 00:28:50,110
so this is kind of hunting for users

799
00:28:48,550 --> 00:28:55,750
look like just give any other name and

800
00:28:50,110 --> 00:28:57,939
it's like here are your targets so

801
00:28:55,750 --> 00:28:59,710
that's kind of the first step or step

802
00:28:57,940 --> 00:29:01,000
point five is figuring out where the

803
00:28:59,710 --> 00:29:03,130
groups and everything else you want to

804
00:29:01,000 --> 00:29:07,330
target then the regular first step is

805
00:29:03,130 --> 00:29:08,740
okay who like where are my actual target

806
00:29:07,330 --> 00:29:10,360
users logged in where's that instant

807
00:29:08,740 --> 00:29:12,010
response staff logged in like what's the

808
00:29:10,360 --> 00:29:14,229
group that I'm going after and this is

809
00:29:12,010 --> 00:29:16,780
kind of step two yeah so after you have

810
00:29:14,230 --> 00:29:19,240
your targets what you're doing next is

811
00:29:16,780 --> 00:29:21,639
throw them in a collection is what SEM

812
00:29:19,240 --> 00:29:23,890
calls our collective you have all of the

813
00:29:21,640 --> 00:29:25,540
the devices or user objects that you

814
00:29:23,890 --> 00:29:27,280
want to put an application on okay so

815
00:29:25,540 --> 00:29:29,678
you can get really granular with like

816
00:29:27,280 --> 00:29:32,410
these computers only get a certain

817
00:29:29,679 --> 00:29:33,940
application and so that allows you to

818
00:29:32,410 --> 00:29:35,410
create collections for your target so

819
00:29:33,940 --> 00:29:36,820
you just gather up all your target storm

820
00:29:35,410 --> 00:29:38,790
in a collection then you're only pushing

821
00:29:36,820 --> 00:29:40,750
out your code to specific targets

822
00:29:38,790 --> 00:29:42,370
instead of like the whole entire

823
00:29:40,750 --> 00:29:44,350
enterprise like I said just trying to

824
00:29:42,370 --> 00:29:45,699
take that to the next level it'd be easy

825
00:29:44,350 --> 00:29:48,820
enough to push an application out to

826
00:29:45,700 --> 00:29:50,710
every single machine but we're to us

827
00:29:48,820 --> 00:29:53,710
that's not the best tradecraft always on

828
00:29:50,710 --> 00:29:55,240
a red team and also we're lazy we don't

829
00:29:53,710 --> 00:29:57,340
wanna have to clean up everything and

830
00:29:55,240 --> 00:29:58,840
say I'm managing you know a thousand

831
00:29:57,340 --> 00:30:00,340
agents coming back and get a little bit

832
00:29:58,840 --> 00:30:04,030
tricky and Empire will crash and

833
00:30:00,340 --> 00:30:05,559
everything because episode masculine

834
00:30:04,030 --> 00:30:08,980
just bad target controller means it's

835
00:30:05,559 --> 00:30:10,540
good also a mix for Anna logging you

836
00:30:08,980 --> 00:30:11,240
only have an info of target if key card

837
00:30:10,540 --> 00:30:14,040
goes

838
00:30:11,240 --> 00:30:17,640
so this is how you would group on your

839
00:30:14,040 --> 00:30:19,139
targets using para su cm you can just do

840
00:30:17,640 --> 00:30:21,060
a new as you seem collection and give it

841
00:30:19,140 --> 00:30:22,440
a name and then a collection type and so

842
00:30:21,060 --> 00:30:25,050
that you have two collection pipe to

843
00:30:22,440 --> 00:30:28,050
your users and devices and so I haven't

844
00:30:25,050 --> 00:30:30,990
seen people set up as CCM to actually

845
00:30:28,050 --> 00:30:33,510
like have user objects or user groups

846
00:30:30,990 --> 00:30:35,970
I've always seen it just devices and

847
00:30:33,510 --> 00:30:37,200
somewhat workers might use users the

848
00:30:35,970 --> 00:30:38,970
functionalities are there if you want to

849
00:30:37,200 --> 00:30:40,830
create a user collection see instead of

850
00:30:38,970 --> 00:30:43,170
pushing it out to just these host names

851
00:30:40,830 --> 00:30:46,080
you can push it out to these users and

852
00:30:43,170 --> 00:30:47,130
whatever workstations associated with

853
00:30:46,080 --> 00:30:49,320
that user he doesn't want to work with

854
00:30:47,130 --> 00:30:51,330
it but all that crazy dummy my stuff in

855
00:30:49,320 --> 00:30:52,830
the backend just super easy all the time

856
00:30:51,330 --> 00:30:54,210
completely cool commandment so you don't

857
00:30:52,830 --> 00:30:56,280
have to worry about all the crust in the

858
00:30:54,210 --> 00:30:58,260
background now once you create the

859
00:30:56,280 --> 00:30:59,760
collection it creates it empty and then

860
00:30:58,260 --> 00:31:01,980
you can use the a destined seam device

861
00:30:59,760 --> 00:31:03,420
to a collection to actually add the

862
00:31:01,980 --> 00:31:05,490
computer named a targets that you want

863
00:31:03,420 --> 00:31:07,200
to see to that collection and start

864
00:31:05,490 --> 00:31:10,350
adding them up and once everything send

865
00:31:07,200 --> 00:31:13,740
a group then you're able to just push it

866
00:31:10,350 --> 00:31:15,240
out this is the coolest part of this

867
00:31:13,740 --> 00:31:17,190
took a really long time for me to figure

868
00:31:15,240 --> 00:31:18,870
out and was like I got a fair-sized

869
00:31:17,190 --> 00:31:20,900
makes no sense and I saw like I've no

870
00:31:18,870 --> 00:31:20,899
idea

871
00:31:21,260 --> 00:31:29,480
so you can create a malicious

872
00:31:23,370 --> 00:31:31,560
application directly via W mine which

873
00:31:29,480 --> 00:31:33,060
there's that there's an is hidden

874
00:31:31,560 --> 00:31:34,740
property that you can say this is the

875
00:31:33,060 --> 00:31:36,149
part that blows our minds normally when

876
00:31:34,740 --> 00:31:37,500
you create an application right in the

877
00:31:36,150 --> 00:31:39,720
GUI it shows up right

878
00:31:37,500 --> 00:31:42,270
there's a hidden fuel we just said is

879
00:31:39,720 --> 00:31:43,950
hidden which I can't think of a

880
00:31:42,270 --> 00:31:45,090
legitimate reason thought to exist like

881
00:31:43,950 --> 00:31:47,160
why would you want to hide an

882
00:31:45,090 --> 00:31:48,929
application but when we create the

883
00:31:47,160 --> 00:31:51,450
malicious application on malicious logic

884
00:31:48,930 --> 00:31:53,910
if regular SCCM admin pulled up the

885
00:31:51,450 --> 00:31:55,320
regular GUI they don't see any of the

886
00:31:53,910 --> 00:31:57,300
malicious logic I was talking about

887
00:31:55,320 --> 00:32:00,000
trying to do forensics and stuff on this

888
00:31:57,300 --> 00:32:02,820
I think would be really interesting so

889
00:32:00,000 --> 00:32:04,500
we did some you know in the backend uses

890
00:32:02,820 --> 00:32:06,780
that be mine then it takes a giant XML

891
00:32:04,500 --> 00:32:08,310
blob and just patches in you know the

892
00:32:06,780 --> 00:32:10,530
code that we want to push and it shoves

893
00:32:08,310 --> 00:32:13,220
it up into the W my class and it's it's

894
00:32:10,530 --> 00:32:15,360
an error hidden and nobody can see it

895
00:32:13,220 --> 00:32:17,910
and so you can do this with new SD

896
00:32:15,360 --> 00:32:19,830
scheme application we just pass it a

897
00:32:17,910 --> 00:32:22,410
name and then there are a few options

898
00:32:19,830 --> 00:32:24,300
there's you know you can push out binary

899
00:32:22,410 --> 00:32:26,310
packages are preferences obviously

900
00:32:24,300 --> 00:32:29,340
PowerShell so I can fire like the output

901
00:32:26,310 --> 00:32:32,580
space 64 so you can just throw on you

902
00:32:29,340 --> 00:32:34,250
know base64 blob and it'll run in a

903
00:32:32,580 --> 00:32:37,039
PowerShell tacky and CNN over

904
00:32:34,250 --> 00:32:39,530
so you're not interfacing any additional

905
00:32:37,039 --> 00:32:41,120
binaries this is and one other kind of

906
00:32:39,530 --> 00:32:43,158
cool thing we ran into is normally with

907
00:32:41,120 --> 00:32:44,629
SCCM there's when you're wanting the

908
00:32:43,159 --> 00:32:45,919
application there's a length limit on

909
00:32:44,630 --> 00:32:48,679
what you're actually about to run right

910
00:32:45,919 --> 00:32:50,630
so normal functionality is taking MSR

911
00:32:48,679 --> 00:32:51,890
and exe and on a share and then have a

912
00:32:50,630 --> 00:32:54,200
launching command that reaches back

913
00:32:51,890 --> 00:32:56,030
there we wanted to do PowerShell without

914
00:32:54,200 --> 00:32:58,640
touching this but the Empire stages are

915
00:32:56,030 --> 00:33:02,120
too long to run it in one swoop so we

916
00:32:58,640 --> 00:33:04,850
stuff all that logic into a custom WI

917
00:33:02,120 --> 00:33:06,979
class on the SCCM server we messed up

918
00:33:04,850 --> 00:33:09,530
the ACL so any user on the domain could

919
00:33:06,980 --> 00:33:11,450
read that w my class so and then we push

920
00:33:09,530 --> 00:33:13,639
that out with the launcher the client

921
00:33:11,450 --> 00:33:15,679
will run the command read all the reach

922
00:33:13,640 --> 00:33:19,549
back read all the data from the WI class

923
00:33:15,679 --> 00:33:20,659
that that's opened up run it once they

924
00:33:19,549 --> 00:33:21,980
press the payload then we clean

925
00:33:20,659 --> 00:33:23,659
everything up after so there's no

926
00:33:21,980 --> 00:33:26,059
evidence left as far as the lodging so

927
00:33:23,659 --> 00:33:28,789
this lets us run arbitrarily long

928
00:33:26,059 --> 00:33:30,889
powershell scripts without it's without

929
00:33:28,789 --> 00:33:31,970
touching disk it's in a w my schema

930
00:33:30,890 --> 00:33:33,260
component in the backend so it's

931
00:33:31,970 --> 00:33:36,260
technically on disk but it's not a

932
00:33:33,260 --> 00:33:38,090
traditional file that's on this and the

933
00:33:36,260 --> 00:33:40,220
clients reaching out when it in the code

934
00:33:38,090 --> 00:33:42,020
executing it it's reaching out back to

935
00:33:40,220 --> 00:33:45,020
the SE team server so it's not entirely

936
00:33:42,020 --> 00:33:50,210
odd to say yeah this doesn't look too

937
00:33:45,020 --> 00:33:52,760
weird and that's what it looks like it

938
00:33:50,210 --> 00:33:54,650
gives you some lead verbose output for

939
00:33:52,760 --> 00:33:56,750
the actual like command lets aren't that

940
00:33:54,650 --> 00:33:58,730
great which I plan on fixing as well but

941
00:33:56,750 --> 00:34:00,770
you can see the to launch the MV is what

942
00:33:58,730 --> 00:34:02,510
will actually execute on the system and

943
00:34:00,770 --> 00:34:04,879
when applications push down see you know

944
00:34:02,510 --> 00:34:07,740
space 64 to code this stuff and you see

945
00:34:04,880 --> 00:34:09,810
this is the custom WI class we do that

946
00:34:07,740 --> 00:34:12,500
and it pulls it from the prop out or the

947
00:34:09,810 --> 00:34:12,500
problem yep

948
00:34:17,900 --> 00:34:24,300
um it W might they would see the W my

949
00:34:21,540 --> 00:34:27,120
traffic coming back might not be super

950
00:34:24,300 --> 00:34:28,830
typical for traditional SCCM like

951
00:34:27,120 --> 00:34:30,779
execution but everything else is I

952
00:34:28,830 --> 00:34:33,000
forget what protocol it is but it's you

953
00:34:30,780 --> 00:34:37,410
know the the normal SCCM like reach back

954
00:34:33,000 --> 00:34:41,070
to land type stuff so it's not I don't

955
00:34:37,409 --> 00:34:43,639
think so I probably should we'd have to

956
00:34:41,070 --> 00:34:43,640
dive in a bit more

957
00:34:44,880 --> 00:34:55,860
it's arcade yes so when you query

958
00:34:53,520 --> 00:34:57,390
through WMI or sequel and the schema

959
00:34:55,860 --> 00:34:59,520
back-end the hidden applications will

960
00:34:57,390 --> 00:35:01,830
show up they just don't show up in the

961
00:34:59,520 --> 00:35:03,509
Google so you can take this and back and

962
00:35:01,830 --> 00:35:05,490
run a few of sec and run it and see if

963
00:35:03,510 --> 00:35:08,070
Aaron even application as I said we

964
00:35:05,490 --> 00:35:09,540
don't really know um there's a couple of

965
00:35:08,070 --> 00:35:11,880
projects out there that we're kind of

966
00:35:09,540 --> 00:35:13,920
similar from just an admin standpoint of

967
00:35:11,880 --> 00:35:16,380
interacting with the SEC and remotely we

968
00:35:13,920 --> 00:35:18,540
don't know of anyone that uses them so

969
00:35:16,380 --> 00:35:23,190
every single time we've seen a deployed

970
00:35:18,540 --> 00:35:24,750
people just using yeah so after the

971
00:35:23,190 --> 00:35:27,150
application is created you can then just

972
00:35:24,750 --> 00:35:28,950
push it out and so you know like I said

973
00:35:27,150 --> 00:35:30,840
earlier we have our targets into a group

974
00:35:28,950 --> 00:35:32,759
and then you can just do a job with new

975
00:35:30,840 --> 00:35:35,790
SCCM application deployment and just

976
00:35:32,760 --> 00:35:37,470
pass it the name creating the group of

977
00:35:35,790 --> 00:35:39,150
users creating the malicious application

978
00:35:37,470 --> 00:35:40,890
and this is what binds it together to

979
00:35:39,150 --> 00:35:41,820
absolutely get to that collection so

980
00:35:40,890 --> 00:35:43,410
there are three or four steps and

981
00:35:41,820 --> 00:35:44,790
actually getting it all out and you have

982
00:35:43,410 --> 00:35:46,920
a lot of control through each step of

983
00:35:44,790 --> 00:35:52,020
making sure you're not touching a target

984
00:35:46,920 --> 00:35:53,580
you cannot touch and then this this is

985
00:35:52,020 --> 00:35:55,290
kind of cool I'm still kind of working

986
00:35:53,580 --> 00:35:58,080
through the research of like how this

987
00:35:55,290 --> 00:35:59,640
exactly works but there's a function

988
00:35:58,080 --> 00:36:03,720
called invoke s and seem device check in

989
00:35:59,640 --> 00:36:05,279
that will execute a WMI method on the

990
00:36:03,720 --> 00:36:07,379
back end of that same service that will

991
00:36:05,280 --> 00:36:10,920
force members of a collection that

992
00:36:07,380 --> 00:36:12,600
check-in so instead of waiting three

993
00:36:10,920 --> 00:36:13,670
hours for these clients to check-in

994
00:36:12,600 --> 00:36:17,240
depending on

995
00:36:13,670 --> 00:36:19,819
this company has their stuff set up you

996
00:36:17,240 --> 00:36:21,410
can trigger this in most of the time it

997
00:36:19,819 --> 00:36:23,180
will force depending on the check-ins

998
00:36:21,410 --> 00:36:25,220
got it will force the actual collection

999
00:36:23,180 --> 00:36:26,660
members to check-in so you don't have to

1000
00:36:25,220 --> 00:36:27,980
like to sit over on so it kind of has

1001
00:36:26,660 --> 00:36:30,140
like a lightweight heartbeat that it

1002
00:36:27,980 --> 00:36:31,700
does pretty frequently and then every

1003
00:36:30,140 --> 00:36:33,440
few hours were of the deployment cycle

1004
00:36:31,700 --> 00:36:35,000
is that she says okay give me any

1005
00:36:33,440 --> 00:36:36,920
applications are going to be pushed down

1006
00:36:35,000 --> 00:36:38,690
so he just closes the window on that

1007
00:36:36,920 --> 00:36:40,490
initial little heartbeat it forces them

1008
00:36:38,690 --> 00:36:42,230
to pull down whatever new application

1009
00:36:40,490 --> 00:36:45,200
appointments are scheduled yes oh no

1010
00:36:42,230 --> 00:36:46,940
chaotic we check in and then if there's

1011
00:36:45,200 --> 00:36:53,200
a new application or package that's

1012
00:36:46,940 --> 00:36:55,250
available to be a point oh boy cool so

1013
00:36:53,200 --> 00:36:58,939
unfortunately gonna have to kind of

1014
00:36:55,250 --> 00:37:00,440
cruise to the defense stuff a bit

1015
00:36:58,940 --> 00:37:05,750
because we want to make sure we can

1016
00:37:00,440 --> 00:37:07,309
actually show a video demo so ACC visit

1017
00:37:05,750 --> 00:37:09,260
if that's a solution just like behind

1018
00:37:07,309 --> 00:37:11,270
the noise or red teaming if you're a

1019
00:37:09,260 --> 00:37:13,339
defender you don't want to tip your hand

1020
00:37:11,270 --> 00:37:15,230
to any like advanced adversaries out

1021
00:37:13,339 --> 00:37:17,569
there you also like to hide in normal

1022
00:37:15,230 --> 00:37:19,099
functionality so there are attackers

1023
00:37:17,569 --> 00:37:20,750
that are sophisticated enough to work

1024
00:37:19,099 --> 00:37:23,510
they just see there's some kind of

1025
00:37:20,750 --> 00:37:24,980
defensive imaging product or IR things

1026
00:37:23,510 --> 00:37:27,440
been up on a machine they can actually

1027
00:37:24,980 --> 00:37:28,849
change their actions chat agents down so

1028
00:37:27,440 --> 00:37:32,030
you don't yeah you don't want to take

1029
00:37:28,849 --> 00:37:33,260
her game there's a lot of really cool

1030
00:37:32,030 --> 00:37:36,140
kind of previous defensive work

1031
00:37:33,260 --> 00:37:37,940
absolutely with SCCM there's youth

1032
00:37:36,140 --> 00:37:42,650
neccessity and violate best practices

1033
00:37:37,940 --> 00:37:44,930
you know like ir so it's like a chair a

1034
00:37:42,650 --> 00:37:46,790
lot of good stuff a lot of the defense

1035
00:37:44,930 --> 00:37:48,319
was drawn off of this existing work

1036
00:37:46,790 --> 00:37:50,839
there's a presentation a few years ago

1037
00:37:48,319 --> 00:37:56,450
and understand clements it just using

1038
00:37:50,839 --> 00:37:58,220
actually use an SDC of so I'll go over

1039
00:37:56,450 --> 00:38:00,439
tuning in some of the commandments by

1040
00:37:58,220 --> 00:38:01,819
default STC MOU collect a large amount

1041
00:38:00,440 --> 00:38:03,470
of a good chunk of an interesting

1042
00:38:01,819 --> 00:38:05,029
information but like I mentioned before

1043
00:38:03,470 --> 00:38:07,399
there's lots of you can tune enough to

1044
00:38:05,030 --> 00:38:08,780
get even more things so if you want to

1045
00:38:07,400 --> 00:38:10,520
have a lot of startup software a browser

1046
00:38:08,780 --> 00:38:13,099
helper objects drivers and all that you

1047
00:38:10,520 --> 00:38:15,349
have to enable this manually in your sec

1048
00:38:13,099 --> 00:38:16,790
employment luckily you're not installing

1049
00:38:15,349 --> 00:38:18,770
you software you're changing a couple

1050
00:38:16,790 --> 00:38:19,350
settings that is this tells the sec the

1051
00:38:18,770 --> 00:38:20,910
agency

1052
00:38:19,350 --> 00:38:23,640
more information from the coast go to

1053
00:38:20,910 --> 00:38:25,470
check things checks back end pretty easy

1054
00:38:23,640 --> 00:38:28,020
to do despite settings you know hardware

1055
00:38:25,470 --> 00:38:30,180
inventory and enable you and other type

1056
00:38:28,020 --> 00:38:31,470
of classes a part of that suggests for

1057
00:38:30,180 --> 00:38:33,569
reference that people actually want to

1058
00:38:31,470 --> 00:38:35,189
use this afterwards this was you know a

1059
00:38:33,570 --> 00:38:38,570
couple days we went through the saying

1060
00:38:35,190 --> 00:38:41,280
what would actually be interesting uses

1061
00:38:38,570 --> 00:38:43,200
also you want to make sure that software

1062
00:38:41,280 --> 00:38:45,300
metering is enables and some of is

1063
00:38:43,200 --> 00:38:46,620
sometimes it isn't this gives you like a

1064
00:38:45,300 --> 00:38:48,510
lot more of the recently launched

1065
00:38:46,620 --> 00:38:50,430
applications and the storm a stuff which

1066
00:38:48,510 --> 00:38:53,430
is one of the more useful components or

1067
00:38:50,430 --> 00:38:56,279
catching bad guys like we might logging

1068
00:38:53,430 --> 00:38:57,899
right without having to set it up on

1069
00:38:56,280 --> 00:38:59,190
post on the windows event for being the

1070
00:38:57,900 --> 00:39:02,100
kind of stuff this will pretty much

1071
00:38:59,190 --> 00:39:05,160
argue more for kind of reference to make

1072
00:39:02,100 --> 00:39:07,640
sure we have that enabled the last part

1073
00:39:05,160 --> 00:39:11,700
or to mean with the software inventory

1074
00:39:07,640 --> 00:39:14,609
you want to you can have sec inhibitory

1075
00:39:11,700 --> 00:39:16,649
every instance of a file of a particular

1076
00:39:14,610 --> 00:39:17,940
pattern on the coastal it won't give you

1077
00:39:16,650 --> 00:39:20,880
any fives but I'll give you like

1078
00:39:17,940 --> 00:39:23,280
publishers like authors the names of

1079
00:39:20,880 --> 00:39:25,380
arguments on what kind of stuff so we

1080
00:39:23,280 --> 00:39:27,630
like to recommend saying an inventory

1081
00:39:25,380 --> 00:39:29,940
every single executable on every single

1082
00:39:27,630 --> 00:39:31,770
host environment pull that all back and

1083
00:39:29,940 --> 00:39:33,690
you can find some very interesting stuff

1084
00:39:31,770 --> 00:39:40,320
a lot of commodity stuff but also some

1085
00:39:33,690 --> 00:39:41,880
malicious and defensive commandlets you

1086
00:39:40,320 --> 00:39:43,110
know again it's referencing in process

1087
00:39:41,880 --> 00:39:49,530
history and recent news application

1088
00:39:43,110 --> 00:39:51,150
drivers are pretty cool oh these are

1089
00:39:49,530 --> 00:39:55,380
some of the cooler kind of metaphor tips

1090
00:39:51,150 --> 00:39:58,050
so some post exploitation told like

1091
00:39:55,380 --> 00:40:00,000
maybe cats will have you know it's

1092
00:39:58,050 --> 00:40:01,530
Weddell be justin.tv his name will be

1093
00:40:00,000 --> 00:40:04,440
like the poster information so the

1094
00:40:01,530 --> 00:40:06,570
packers change the name of the app most

1095
00:40:04,440 --> 00:40:07,800
of them they don't really know what

1096
00:40:06,570 --> 00:40:10,250
they're doing aren't going to actually

1097
00:40:07,800 --> 00:40:11,840
go through and properties that the exe

1098
00:40:10,250 --> 00:40:13,730
they're using so some of these

1099
00:40:11,840 --> 00:40:16,340
Commandments will find all instances of

1100
00:40:13,730 --> 00:40:19,070
guinea cats in your environment if it's

1101
00:40:16,340 --> 00:40:20,330
on this and it's not a silver bullet I

1102
00:40:19,070 --> 00:40:23,119
think that's what it means

1103
00:40:20,330 --> 00:40:25,730
liberate but you can start to build more

1104
00:40:23,119 --> 00:40:28,130
interesting than actually make abilities

1105
00:40:25,730 --> 00:40:31,070
by by correlating some of the publisher

1106
00:40:28,130 --> 00:40:32,930
like nothing there's a couple of other

1107
00:40:31,070 --> 00:40:37,580
fields and telling some executives

1108
00:40:32,930 --> 00:40:41,509
together and us cool things with defense

1109
00:40:37,580 --> 00:40:43,730
is you can actually hook up the SCC of

1110
00:40:41,510 --> 00:40:46,340
sequel database into a jesters for your

1111
00:40:43,730 --> 00:40:49,250
almond soup solution so this blog post

1112
00:40:46,340 --> 00:40:51,530
that I assign in the references watch

1113
00:40:49,250 --> 00:40:53,570
you through how to link up SC seem to be

1114
00:40:51,530 --> 00:40:56,119
directly in this one so you have to

1115
00:40:53,570 --> 00:40:58,310
power a single browser and you can just

1116
00:40:56,119 --> 00:40:59,840
ingest all this information from the

1117
00:40:58,310 --> 00:41:02,029
sequel back then directly and start

1118
00:40:59,840 --> 00:41:03,680
doing heuristics and analytics and build

1119
00:41:02,030 --> 00:41:05,150
your own custom queries works on this

1120
00:41:03,680 --> 00:41:06,589
are a lot of people if you have a

1121
00:41:05,150 --> 00:41:08,869
solution this is probably the best

1122
00:41:06,590 --> 00:41:11,000
approach for defense or Sony's overhead

1123
00:41:08,869 --> 00:41:12,800
and it's literally just connecting up a

1124
00:41:11,000 --> 00:41:15,550
consumer and then you get a huge move

1125
00:41:12,800 --> 00:41:17,690
data 70 people may use more for us is

1126
00:41:15,550 --> 00:41:19,460
trying to change the perspective and

1127
00:41:17,690 --> 00:41:21,589
defenders of like yes you have this huge

1128
00:41:19,460 --> 00:41:32,060
amount of data why not and those that

1129
00:41:21,589 --> 00:41:34,490
follow Jesus not connected so sorry

1130
00:41:32,060 --> 00:41:38,160
protects a little small amount of said

1131
00:41:34,490 --> 00:41:40,899
the way is it set up through

1132
00:41:38,160 --> 00:41:43,230
Fox there were different on the favorite

1133
00:41:40,900 --> 00:41:43,230
environment

1134
00:41:53,250 --> 00:41:57,460
yeah this is Wallace fortunately for

1135
00:41:55,420 --> 00:41:59,170
that concession and type 2 whatever

1136
00:41:57,460 --> 00:42:01,780
command what you can have multiple

1137
00:41:59,170 --> 00:42:03,550
sessions going so you need a multiple

1138
00:42:01,780 --> 00:42:05,850
site surgical sites you want a more

1139
00:42:03,550 --> 00:42:05,850
granular

1140
00:42:12,770 --> 00:42:16,619
so we're hunting for a user and the

1141
00:42:15,210 --> 00:42:19,260
battery towards the turns the

1142
00:42:16,619 --> 00:42:21,260
workstation name that they're logged

1143
00:42:19,260 --> 00:42:24,150
into and we can use that for targeting

1144
00:42:21,260 --> 00:42:26,400
and then next to conduction creating a

1145
00:42:24,150 --> 00:42:29,880
collection and then adding like the

1146
00:42:26,400 --> 00:42:31,200
device to the collection I would be

1147
00:42:29,880 --> 00:42:33,180
cautious of what you mean in it because

1148
00:42:31,200 --> 00:42:38,339
the question is new shot that said you

1149
00:42:33,180 --> 00:42:40,560
name it like targets lol or red team

1150
00:42:38,340 --> 00:42:42,690
targets or something we hope there's not

1151
00:42:40,560 --> 00:42:49,440
an instant to the collections

1152
00:42:42,690 --> 00:42:50,460
unfortunately something to do the

1153
00:42:49,440 --> 00:42:56,610
question do you have a creative

1154
00:42:50,460 --> 00:42:58,200
collection so it's building this is just

1155
00:42:56,610 --> 00:43:00,300
validating that was created by using

1156
00:42:58,200 --> 00:43:03,359
innocence and collection which the

1157
00:43:00,300 --> 00:43:04,950
collections that are created that's

1158
00:43:03,360 --> 00:43:07,680
almost nice to just validate that it was

1159
00:43:04,950 --> 00:43:09,149
actually created for safety sake and

1160
00:43:07,680 --> 00:43:12,149
then you can even actually adding the

1161
00:43:09,150 --> 00:43:17,840
device in a collection and I hope that

1162
00:43:12,150 --> 00:43:17,840
they can see em at once or an homage

1163
00:43:18,170 --> 00:43:23,720
especially pipes a name and a lot

1164
00:43:22,290 --> 00:43:25,640
actually added

1165
00:43:23,720 --> 00:43:27,470
and then like I said like the output

1166
00:43:25,640 --> 00:43:29,930
itself is and see overdose in the eye

1167
00:43:27,470 --> 00:43:35,270
and it works like him doesn't it right

1168
00:43:29,930 --> 00:43:36,740
Texas a common everywhere the ninja

1169
00:43:35,270 --> 00:43:38,480
movement to create the application

1170
00:43:36,740 --> 00:43:40,040
itself that we actually have the device

1171
00:43:38,480 --> 00:43:42,140
that we're gonna target and a question

1172
00:43:40,040 --> 00:43:46,550
that we wanna have that device

1173
00:43:42,140 --> 00:43:48,828
differently and then you're using a

1174
00:43:46,550 --> 00:43:50,599
comment in our payload already generated

1175
00:43:48,829 --> 00:43:52,490
you'll just take them back to a sixty

1176
00:43:50,599 --> 00:43:54,349
four o'clock and it's Unicode so if you

1177
00:43:52,490 --> 00:43:56,810
assess make sure they use the basics

1178
00:43:54,349 --> 00:43:59,140
before Unicode American different option

1179
00:43:56,810 --> 00:43:59,140
is state

1180
00:44:13,119 --> 00:44:18,109
and we can actually do the double

1181
00:44:15,020 --> 00:44:22,880
teaming and specifying the athlete you

1182
00:44:18,109 --> 00:44:27,848
need to make it we're not long as you

1183
00:44:22,880 --> 00:44:27,849
see interpretation with rights with all

1184
00:44:30,130 --> 00:44:37,180
it's implicitly so and and you can

1185
00:44:33,680 --> 00:44:37,180
unhide it if you want

1186
00:44:37,319 --> 00:44:42,449
the check in return application name

1187
00:44:40,259 --> 00:44:46,049
when it successfully created it and then

1188
00:44:42,449 --> 00:44:47,309
you can specify it and the collection

1189
00:44:46,049 --> 00:44:48,809
that you were forced to check in and

1190
00:44:47,309 --> 00:44:52,019
then it will execute that'll be my

1191
00:44:48,809 --> 00:44:54,660
method and 50 seconds should get a name

1192
00:44:52,019 --> 00:44:56,578
check that this is kind of header

1193
00:44:54,660 --> 00:44:59,058
actually invoking the checking the

1194
00:44:56,579 --> 00:45:05,309
internet sometimes I think it'll be the

1195
00:44:59,059 --> 00:45:08,219
schedule of our Gator alright the fall

1196
00:45:05,309 --> 00:45:11,430
car SEC of runs coded system you can

1197
00:45:08,219 --> 00:45:14,699
only change it 71 just don't know why

1198
00:45:11,430 --> 00:45:16,859
you would even just is running as our

1199
00:45:14,699 --> 00:45:19,349
shell because actual process that have

1200
00:45:16,859 --> 00:45:23,729
started as Street out to be my question

1201
00:45:19,349 --> 00:45:25,559
actually rabbit there's a cleanup

1202
00:45:23,729 --> 00:45:27,209
function I attended groupies and the

1203
00:45:25,559 --> 00:45:28,589
like of the things right now they're

1204
00:45:27,209 --> 00:45:30,299
separate and so you're going to reduce

1205
00:45:28,589 --> 00:45:31,949
its actual obligation we have to do this

1206
00:45:30,299 --> 00:45:36,319
in a specific order because things are

1207
00:45:31,949 --> 00:45:36,319
things together it's a cop I actually

1208
00:45:36,460 --> 00:45:42,220
did you happen to meet the collection we

1209
00:45:39,430 --> 00:45:44,919
have visible walk disability services

1210
00:45:42,220 --> 00:45:49,660
him under the series long we need to

1211
00:45:44,920 --> 00:45:54,330
rent any step through all possibly

1212
00:45:49,660 --> 00:45:57,549
happen it's just we clean up lines

1213
00:45:54,330 --> 00:45:59,710
there's no like successes treatment like

1214
00:45:57,550 --> 00:46:04,510
I said like in comments ready proof I

1215
00:45:59,710 --> 00:46:08,200
mean that is some I guess this is

1216
00:46:04,510 --> 00:46:10,119
welcome to come together yeah so now

1217
00:46:08,200 --> 00:46:13,348
it's done it's removed there's not

1218
00:46:10,119 --> 00:46:13,349
anything we have

1219
00:46:21,700 --> 00:46:41,859
yep image it well yeah you know Tommy

1220
00:46:27,790 --> 00:46:43,420
probably never question the question is

1221
00:46:41,859 --> 00:46:46,509
can you send it up to people learning in

1222
00:46:43,420 --> 00:46:49,809
particular people and I mean you might

1223
00:46:46,510 --> 00:46:52,420
be able to see like Orioles giving that

1224
00:46:49,809 --> 00:46:58,270
direct connection out to like back in

1225
00:46:52,420 --> 00:47:00,040
like WI it's more of like an information

1226
00:46:58,270 --> 00:47:04,119
like reach out query model it's not as

1227
00:47:00,040 --> 00:47:08,170
much I don't think I push alerts down

1228
00:47:04,119 --> 00:47:09,910
cause 92 the backend Queens kind of

1229
00:47:08,170 --> 00:47:12,490
excited secret documented and it's kind

1230
00:47:09,910 --> 00:47:14,230
of the Korean Wave being around yourself

1231
00:47:12,490 --> 00:47:17,848
was in there are no blood it's just

1232
00:47:14,230 --> 00:47:17,849
relying on traditions in the day

