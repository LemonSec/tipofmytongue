1
00:00:03,120 --> 00:00:04,080
sure

2
00:00:04,080 --> 00:00:06,319
um and let's start that

3
00:00:06,319 --> 00:00:09,280
to be fair i have so many content so i i

4
00:00:09,280 --> 00:00:11,440
would like to chat with you um i would

5
00:00:11,440 --> 00:00:13,759
be happy but so many things i want to

6
00:00:13,759 --> 00:00:16,480
show you uh so let's get started

7
00:00:16,480 --> 00:00:17,520
um

8
00:00:17,520 --> 00:00:19,680
hello hello hello hello hello hello

9
00:00:19,680 --> 00:00:20,640
thank you

10
00:00:20,640 --> 00:00:22,400
thanks that you

11
00:00:22,400 --> 00:00:24,080
allow me to speak here that's my

12
00:00:24,080 --> 00:00:26,320
pleasure and especially i like barcelona

13
00:00:26,320 --> 00:00:28,240
and i'm missing that i haven't been

14
00:00:28,240 --> 00:00:29,679
there for for

15
00:00:29,679 --> 00:00:31,599
for a few years

16
00:00:31,599 --> 00:00:32,320
so

17
00:00:32,320 --> 00:00:34,000
hopefully someday

18
00:00:34,000 --> 00:00:34,800
so

19
00:00:34,800 --> 00:00:38,399
uh in the next 45 minutes i'm gonna uh

20
00:00:38,399 --> 00:00:42,079
talk about um azure um or azure house

21
00:00:42,079 --> 00:00:44,480
some people call that or azure um in the

22
00:00:44,480 --> 00:00:46,239
as they called azure so i'm going to

23
00:00:46,239 --> 00:00:49,440
talk about azure and um about how we can

24
00:00:49,440 --> 00:00:52,320
uh find different mis configurations in

25
00:00:52,320 --> 00:00:55,039
azure a typical misconfiguration i found

26
00:00:55,039 --> 00:00:57,760
when i work with my customers

27
00:00:57,760 --> 00:00:59,199
so this session called offensive azure

28
00:00:59,199 --> 00:01:01,280
security so it means that i'm gonna i'm

29
00:01:01,280 --> 00:01:03,120
gonna show you how we can

30
00:01:03,120 --> 00:01:05,280
uh pen test azure services around

31
00:01:05,280 --> 00:01:07,439
assessments and find out what may be not

32
00:01:07,439 --> 00:01:09,119
configured properly i mean from the

33
00:01:09,119 --> 00:01:12,080
security standpoint my name is sergey um

34
00:01:12,080 --> 00:01:14,159
i'm from russia uh thanks christian that

35
00:01:14,159 --> 00:01:16,960
you mentioned about that um and so let

36
00:01:16,960 --> 00:01:18,720
me say a few words about myself and then

37
00:01:18,720 --> 00:01:20,799
i'm going to start my sessions right

38
00:01:20,799 --> 00:01:24,159
away um i mean start the content um so

39
00:01:24,159 --> 00:01:26,799
what i usually do i work with companies

40
00:01:26,799 --> 00:01:28,799
that and and they're on finance

41
00:01:28,799 --> 00:01:31,119
different some some few companies and

42
00:01:31,119 --> 00:01:34,000
they're on 10 tests for their customers

43
00:01:34,000 --> 00:01:36,799
um assessments and after this implement

44
00:01:36,799 --> 00:01:39,200
services to fix all of this like clouds

45
00:01:39,200 --> 00:01:41,360
and quite often work with the cloud also

46
00:01:41,360 --> 00:01:45,360
i'm an instructor and i teach people um

47
00:01:45,360 --> 00:01:48,159
cloud and security i speak at different

48
00:01:48,159 --> 00:01:50,159
conferences i was also speaking on

49
00:01:50,159 --> 00:01:52,960
global azure uh security b sites some

50
00:01:52,960 --> 00:01:55,280
other besides wild west i can fast

51
00:01:55,280 --> 00:01:56,960
defcon as well

52
00:01:56,960 --> 00:01:59,119
so many conferences if you want to

53
00:01:59,119 --> 00:02:01,119
contact me so here's the linkedin i

54
00:02:01,119 --> 00:02:02,799
don't have twitter to be fair so

55
00:02:02,799 --> 00:02:05,360
linkedin that's the best way to to find

56
00:02:05,360 --> 00:02:06,320
me

57
00:02:06,320 --> 00:02:09,038
i'm also microsoft azure mvp which means

58
00:02:09,038 --> 00:02:11,360
that most valuable professional oscp or

59
00:02:11,360 --> 00:02:12,239
sap

60
00:02:12,239 --> 00:02:13,680
and and many many many other

61
00:02:13,680 --> 00:02:15,760
certifications i think it's not super

62
00:02:15,760 --> 00:02:18,959
important to talk about certifications

63
00:02:18,959 --> 00:02:22,000
since we don't have so a lot of time let

64
00:02:22,000 --> 00:02:25,120
me without being said start the actual

65
00:02:25,120 --> 00:02:27,120
content one one last thing i wanna i'm

66
00:02:27,120 --> 00:02:30,720
gonna say uh i don't like slides so you

67
00:02:30,720 --> 00:02:33,360
will not see many slides on this session

68
00:02:33,360 --> 00:02:35,599
most of the time you will see

69
00:02:35,599 --> 00:02:37,200
live demos so

70
00:02:37,200 --> 00:02:40,160
i hope you live live live that you love

71
00:02:40,160 --> 00:02:43,280
live demos like i do so

72
00:02:43,280 --> 00:02:45,360
let's get started

73
00:02:45,360 --> 00:02:48,800
um in the next slide that's my agenda

74
00:02:48,800 --> 00:02:50,480
you may say what that's that's that

75
00:02:50,480 --> 00:02:52,080
that's uh

76
00:02:52,080 --> 00:02:55,120
this three shapes that that's agenda uh

77
00:02:55,120 --> 00:02:57,920
yeah so in my in in my session whatever

78
00:02:57,920 --> 00:03:00,319
what i want to do i want to show

79
00:03:00,319 --> 00:03:03,360
uh three primary things first of all um

80
00:03:03,360 --> 00:03:05,599
i wanna i wanna compromise three

81
00:03:05,599 --> 00:03:07,120
environments so first of all i will

82
00:03:07,120 --> 00:03:09,280
compromise hybrid active directory so

83
00:03:09,280 --> 00:03:11,440
when we have on-prem id

84
00:03:11,440 --> 00:03:14,239
and integrate into the cloud so how we

85
00:03:14,239 --> 00:03:16,800
can try to compromise that environment

86
00:03:16,800 --> 00:03:18,560
what may what typical misconfigurations

87
00:03:18,560 --> 00:03:20,879
may be found there or what what usually

88
00:03:20,879 --> 00:03:23,599
we find when we work with our customers

89
00:03:23,599 --> 00:03:26,879
then i'm gonna show you how we can fan

90
00:03:26,879 --> 00:03:28,959
test and find out

91
00:03:28,959 --> 00:03:31,200
something in virtual machines so when

92
00:03:31,200 --> 00:03:32,560
companies they use virtual machines to

93
00:03:32,560 --> 00:03:34,239
run their applications what we can find

94
00:03:34,239 --> 00:03:35,920
in virtual machines

95
00:03:35,920 --> 00:03:37,519
and finally the largest scenario so

96
00:03:37,519 --> 00:03:39,840
that's the largest shape

97
00:03:39,840 --> 00:03:40,959
um

98
00:03:40,959 --> 00:03:41,760
so

99
00:03:41,760 --> 00:03:44,480
web applications so when we

100
00:03:44,480 --> 00:03:45,280
we

101
00:03:45,280 --> 00:03:48,000
in the third scenario we don't use

102
00:03:48,000 --> 00:03:50,159
virtual machines anymore we are using

103
00:03:50,159 --> 00:03:52,720
pass services so web up

104
00:03:52,720 --> 00:03:56,239
sql sql database in azure so we don't we

105
00:03:56,239 --> 00:03:59,120
use azure native services we don't use

106
00:03:59,120 --> 00:04:00,959
virtual machines anymore

107
00:04:00,959 --> 00:04:03,200
so what we can do there from security

108
00:04:03,200 --> 00:04:05,200
standpoint of course

109
00:04:05,200 --> 00:04:07,439
so that's my agenda and let's get

110
00:04:07,439 --> 00:04:09,200
started so first scenario in first

111
00:04:09,200 --> 00:04:10,720
scenario i have

112
00:04:10,720 --> 00:04:13,760
uh on-prem active directory and azure ag

113
00:04:13,760 --> 00:04:16,079
connect which is variable known tool to

114
00:04:16,079 --> 00:04:17,839
synchronize your your identities from

115
00:04:17,839 --> 00:04:19,680
on-prem to the cloud let's take a look

116
00:04:19,680 --> 00:04:21,120
what we can do there

117
00:04:21,120 --> 00:04:23,199
and let me jump to demo

118
00:04:23,199 --> 00:04:25,440
so i don't know if you work with ad

119
00:04:25,440 --> 00:04:27,199
connect or not quite quite often i speak

120
00:04:27,199 --> 00:04:29,600
at microsoft conferences and many people

121
00:04:29,600 --> 00:04:32,800
that are there uh they know it pretty

122
00:04:32,800 --> 00:04:34,880
well but here it's a

123
00:04:34,880 --> 00:04:36,720
that's that's security conference i i

124
00:04:36,720 --> 00:04:38,080
don't know if you have experience with

125
00:04:38,080 --> 00:04:39,600
with this tool or not

126
00:04:39,600 --> 00:04:41,919
uh but this this this one is quite well

127
00:04:41,919 --> 00:04:44,560
known so with azure ad connect we

128
00:04:44,560 --> 00:04:46,880
synchronize identities from on-premises

129
00:04:46,880 --> 00:04:48,639
to the cloud with this tool

130
00:04:48,639 --> 00:04:50,960
uh what is interesting about about about

131
00:04:50,960 --> 00:04:52,800
this tool um let me show you a few

132
00:04:52,800 --> 00:04:54,960
things first and then again i will show

133
00:04:54,960 --> 00:04:57,440
you the problem so when we configure ad

134
00:04:57,440 --> 00:04:58,800
connect

135
00:04:58,800 --> 00:05:00,960
one thing one of the things we must do

136
00:05:00,960 --> 00:05:03,440
we must create an account that will have

137
00:05:03,440 --> 00:05:06,479
access to on premises first because

138
00:05:06,479 --> 00:05:08,800
because ad connect must have credentials

139
00:05:08,800 --> 00:05:10,720
to you know to read

140
00:05:10,720 --> 00:05:14,720
uh user names uh to read uh groups and

141
00:05:14,720 --> 00:05:16,720
so ons or read properties from active

142
00:05:16,720 --> 00:05:18,880
directory so some sort of account must

143
00:05:18,880 --> 00:05:22,080
be associated with um ad connect

144
00:05:22,080 --> 00:05:23,680
so this account will be created during

145
00:05:23,680 --> 00:05:25,759
the installation and the most

146
00:05:25,759 --> 00:05:28,000
recommended option is to allow ad

147
00:05:28,000 --> 00:05:30,479
connect create account for you

148
00:05:30,479 --> 00:05:32,479
so in this case nobody will know

149
00:05:32,479 --> 00:05:35,360
password so um so the first option is

150
00:05:35,360 --> 00:05:37,840
recommended uh you just need to uh enter

151
00:05:37,840 --> 00:05:40,080
enterprise button credentials once you

152
00:05:40,080 --> 00:05:41,680
uh so the account will not have

153
00:05:41,680 --> 00:05:43,919
underpercent credentials in the future

154
00:05:43,919 --> 00:05:45,520
uh let me show you this account how it

155
00:05:45,520 --> 00:05:46,560
looks like

156
00:05:46,560 --> 00:05:48,000
i'm gonna jump back to the main

157
00:05:48,000 --> 00:05:51,280
controller and here is a massill

158
00:05:51,280 --> 00:05:54,240
underscore and and different numbers

159
00:05:54,240 --> 00:05:56,160
maybe in your case it will be different

160
00:05:56,160 --> 00:05:58,800
uh not in my case nine cc zero four and

161
00:05:58,800 --> 00:06:02,400
so on so if i look at this account

162
00:06:02,400 --> 00:06:06,000
um go to membership where's that uh

163
00:06:06,000 --> 00:06:09,680
member of so it's just the main user so

164
00:06:09,680 --> 00:06:10,880
noth

165
00:06:10,880 --> 00:06:12,720
so it's not an enterprise admin or the

166
00:06:12,720 --> 00:06:14,720
main admin just a regular user so

167
00:06:14,720 --> 00:06:16,319
probably this account is not dangerous

168
00:06:16,319 --> 00:06:18,880
right i mean it can't do any anything

169
00:06:18,880 --> 00:06:21,039
but let me jump back to slides

170
00:06:21,039 --> 00:06:23,759
and tell you one more thing so uh in a

171
00:06:23,759 --> 00:06:26,560
typical installation of ad connect

172
00:06:26,560 --> 00:06:28,639
uh microsoft three commands and not only

173
00:06:28,639 --> 00:06:31,120
microsoft but almost everyone recommends

174
00:06:31,120 --> 00:06:33,199
to enable feature called password hash

175
00:06:33,199 --> 00:06:36,639
sync so password hashing means that uh

176
00:06:36,639 --> 00:06:38,800
users and their passwords i mean not of

177
00:06:38,800 --> 00:06:40,960
course not passwords but hashes will be

178
00:06:40,960 --> 00:06:42,960
synchronized from on premises to the

179
00:06:42,960 --> 00:06:45,280
cloud as well so in that case cloud will

180
00:06:45,280 --> 00:06:47,039
be independent from from on premises and

181
00:06:47,039 --> 00:06:48,960
if you look connectivity to uh so users

182
00:06:48,960 --> 00:06:50,880
will be able to log in also you will

183
00:06:50,880 --> 00:06:52,560
have detection of the credentials so

184
00:06:52,560 --> 00:06:54,639
many benefits from from password hashing

185
00:06:54,639 --> 00:06:56,960
it's highly recommended feature at the

186
00:06:56,960 --> 00:06:59,199
same time if you enable that

187
00:06:59,199 --> 00:07:02,319
account will have extra permissions like

188
00:07:02,319 --> 00:07:03,840
this

189
00:07:03,840 --> 00:07:06,160
um so in that case account

190
00:07:06,160 --> 00:07:07,680
i showed you before

191
00:07:07,680 --> 00:07:09,919
uh will have those permissions replicate

192
00:07:09,919 --> 00:07:11,440
directly changes and replicate there

193
00:07:11,440 --> 00:07:13,599
they changes all maybe you know how to

194
00:07:13,599 --> 00:07:15,360
use those those permissions i will show

195
00:07:15,360 --> 00:07:18,240
you that slightly later let me quickly

196
00:07:18,240 --> 00:07:20,160
show you those for about those

197
00:07:20,160 --> 00:07:22,000
permissions first i'm going to go to

198
00:07:22,000 --> 00:07:23,759
properties of my domain

199
00:07:23,759 --> 00:07:27,280
go to security find out msl

200
00:07:27,280 --> 00:07:30,319
and here are permissions so they are

201
00:07:30,319 --> 00:07:31,759
automatically configured because i

202
00:07:31,759 --> 00:07:34,720
enable that password hash sync feature

203
00:07:34,720 --> 00:07:36,240
all right now

204
00:07:36,240 --> 00:07:38,800
um first of all um maybe you already

205
00:07:38,800 --> 00:07:40,240
know how to use those permissions i will

206
00:07:40,240 --> 00:07:42,160
show you that slightly later but we have

207
00:07:42,160 --> 00:07:44,960
the first dilemma we know that we have

208
00:07:44,960 --> 00:07:46,720
an account so let's say we want to

209
00:07:46,720 --> 00:07:48,720
compromise that account and we want to

210
00:07:48,720 --> 00:07:50,639
use those permissions we know that we

211
00:07:50,639 --> 00:07:52,160
have this account

212
00:07:52,160 --> 00:07:54,240
but we don't know the password because

213
00:07:54,240 --> 00:07:55,919
when we when we made installation ad

214
00:07:55,919 --> 00:07:58,639
connect manage manage account

215
00:07:58,639 --> 00:08:02,319
itself so you will not know the passport

216
00:08:02,319 --> 00:08:04,400
so let's go back to ad connect and

217
00:08:04,400 --> 00:08:06,240
probably if adconnect manage manage the

218
00:08:06,240 --> 00:08:08,400
password adconnect must know the

219
00:08:08,400 --> 00:08:09,520
password

220
00:08:09,520 --> 00:08:11,120
so where does pass where this password

221
00:08:11,120 --> 00:08:14,400
is stored if i go to to two

222
00:08:14,400 --> 00:08:16,160
program files

223
00:08:16,160 --> 00:08:18,879
uh and find ad

224
00:08:18,879 --> 00:08:21,840
microsoft adc folder

225
00:08:21,840 --> 00:08:23,319
here is

226
00:08:23,319 --> 00:08:27,280
database so a password will be stored in

227
00:08:27,280 --> 00:08:29,360
this database let me just connect a

228
00:08:29,360 --> 00:08:30,720
database

229
00:08:30,720 --> 00:08:33,120
uh using sql mention studio and look at

230
00:08:33,120 --> 00:08:34,399
the table

231
00:08:34,399 --> 00:08:37,200
called management agent and select top

232
00:08:37,200 --> 00:08:40,200
thousand

233
00:08:40,559 --> 00:08:42,719
so let me also remove number of columns

234
00:08:42,719 --> 00:08:44,959
i don't need so just to make it more

235
00:08:44,959 --> 00:08:46,970
simple um

236
00:08:46,970 --> 00:08:48,800
[Music]

237
00:08:48,800 --> 00:08:51,680
let me just keep let me leave just

238
00:08:51,680 --> 00:08:53,519
those columns that's enough let's

239
00:08:53,519 --> 00:08:54,880
execute

240
00:08:54,880 --> 00:08:56,800
expand that

241
00:08:56,800 --> 00:08:59,600
and let's take a look here we go

242
00:08:59,600 --> 00:09:02,399
here we go so here's the account

243
00:09:02,399 --> 00:09:04,959
a username and it says password but

244
00:09:04,959 --> 00:09:06,880
password is encrypted

245
00:09:06,880 --> 00:09:08,240
wow

246
00:09:08,240 --> 00:09:10,560
so password is there but password is

247
00:09:10,560 --> 00:09:12,240
encrypted so it's not that easy it's not

248
00:09:12,240 --> 00:09:13,440
just you know

249
00:09:13,440 --> 00:09:15,120
i can't just take password in the plain

250
00:09:15,120 --> 00:09:17,440
text but who can decrypt the password

251
00:09:17,440 --> 00:09:19,440
because it must be decrypted to been

252
00:09:19,440 --> 00:09:21,200
used must be decrypted

253
00:09:21,200 --> 00:09:24,160
and now the first problem we i commonly

254
00:09:24,160 --> 00:09:26,720
see in customer environment let me show

255
00:09:26,720 --> 00:09:27,839
this real quick

256
00:09:27,839 --> 00:09:32,320
uh so local administrator of this server

257
00:09:32,320 --> 00:09:34,640
so member of administrators group can

258
00:09:34,640 --> 00:09:37,040
decrypt the password uh by the way also

259
00:09:37,040 --> 00:09:39,760
a member of agcm admins also can decrypt

260
00:09:39,760 --> 00:09:40,959
this password

261
00:09:40,959 --> 00:09:42,160
um so

262
00:09:42,160 --> 00:09:44,160
i will in the end of the session i'll

263
00:09:44,160 --> 00:09:46,240
quickly talk about mitigations but the

264
00:09:46,240 --> 00:09:49,600
problem that we usually see is like a

265
00:09:49,600 --> 00:09:51,920
companies allow regular administrators

266
00:09:51,920 --> 00:09:54,080
like server admins sometimes even help

267
00:09:54,080 --> 00:09:56,640
desk administrators allow administration

268
00:09:56,640 --> 00:09:58,320
of ad connect because ad connect is not

269
00:09:58,320 --> 00:09:59,600
a controller

270
00:09:59,600 --> 00:10:00,880
let me show you what maybe the problem

271
00:10:00,880 --> 00:10:04,720
here so let me open powershell

272
00:10:04,720 --> 00:10:06,160
and let's

273
00:10:06,160 --> 00:10:08,000
extract the password

274
00:10:08,000 --> 00:10:10,079
you made it manually but it's quite

275
00:10:10,079 --> 00:10:12,399
tedious and takes a while but there is a

276
00:10:12,399 --> 00:10:14,079
script you may find on the internet on

277
00:10:14,079 --> 00:10:17,200
the github called ad connect done

278
00:10:17,200 --> 00:10:19,600
so let me run the screen

279
00:10:19,600 --> 00:10:21,839
and look at this so there's a username

280
00:10:21,839 --> 00:10:23,920
and there's a crazy password here as

281
00:10:23,920 --> 00:10:26,240
well so i'm gonna i'm gonna open another

282
00:10:26,240 --> 00:10:28,560
machine uh called client

283
00:10:28,560 --> 00:10:30,959
let me open that as administrator

284
00:10:30,959 --> 00:10:33,279
command prompt here

285
00:10:33,279 --> 00:10:34,320
come on

286
00:10:34,320 --> 00:10:36,640
and the same time i'm gonna open cmd

287
00:10:36,640 --> 00:10:37,680
again

288
00:10:37,680 --> 00:10:39,360
as a different user

289
00:10:39,360 --> 00:10:41,760
and i'm gonna type this crazy password

290
00:10:41,760 --> 00:10:44,800
and username msl underscore

291
00:10:44,800 --> 00:10:47,920
so um let's first check who am i in the

292
00:10:47,920 --> 00:10:50,240
first command prompt i'm a user jdo

293
00:10:50,240 --> 00:10:51,680
let's check if i have permissions to

294
00:10:51,680 --> 00:10:53,519
access my controller

295
00:10:53,519 --> 00:10:55,760
uh no i don't access denied

296
00:10:55,760 --> 00:10:57,279
uh all right so let's wait before the

297
00:10:57,279 --> 00:10:59,200
second cmg appears because it takes some

298
00:10:59,200 --> 00:11:01,600
time on using this account

299
00:11:01,600 --> 00:11:06,640
it's usually our 30 seconds 40 is 30.

300
00:11:06,640 --> 00:11:09,360
come on i don't have time thank you

301
00:11:09,360 --> 00:11:11,600
so who am i

302
00:11:11,600 --> 00:11:14,320
am i still underscore so let's check

303
00:11:14,320 --> 00:11:15,360
also

304
00:11:15,360 --> 00:11:17,200
uh max denied so i cannot plug it i

305
00:11:17,200 --> 00:11:18,399
cannot

306
00:11:18,399 --> 00:11:19,839
enumerate the c drive for the main

307
00:11:19,839 --> 00:11:21,680
controller so looks like i don't have

308
00:11:21,680 --> 00:11:23,600
permissions to list my controller c

309
00:11:23,600 --> 00:11:25,519
drive but what i can do

310
00:11:25,519 --> 00:11:28,079
so let me go back to the slide once

311
00:11:28,079 --> 00:11:29,839
again i have permission to replicate

312
00:11:29,839 --> 00:11:32,160
directory changes so maybe you know what

313
00:11:32,160 --> 00:11:34,320
it what what what what it means if

314
00:11:34,320 --> 00:11:36,000
you're if you're using mimikats or some

315
00:11:36,000 --> 00:11:38,240
tools like this you may replicate

316
00:11:38,240 --> 00:11:40,320
information about any user in active

317
00:11:40,320 --> 00:11:41,680
directory including the mail

318
00:11:41,680 --> 00:11:44,800
administrator so if i go back

319
00:11:44,800 --> 00:11:46,480
and open mimic ads

320
00:11:46,480 --> 00:11:48,320
uh don't ask me why it's running because

321
00:11:48,320 --> 00:11:49,519
yeah of course it's inclusive of

322
00:11:49,519 --> 00:11:52,480
exclusion of antivirus but

323
00:11:52,480 --> 00:11:53,600
i have a separate session about

324
00:11:53,600 --> 00:11:55,440
antivirus evasion

325
00:11:55,440 --> 00:11:58,240
it's possible to offer skip mimic ads um

326
00:11:58,240 --> 00:12:00,320
oh it's not a topic here

327
00:12:00,320 --> 00:12:02,880
so i'm gonna run command called dc sync

328
00:12:02,880 --> 00:12:05,200
and i wanna take and i'm gonna find hash

329
00:12:05,200 --> 00:12:08,000
of user trainer who is the administrator

330
00:12:08,000 --> 00:12:09,600
let's run that

331
00:12:09,600 --> 00:12:11,120
and that's working

332
00:12:11,120 --> 00:12:13,680
look at this ntlm hash of domain

333
00:12:13,680 --> 00:12:16,560
administrator now if i open mimikatz

334
00:12:16,560 --> 00:12:19,920
again on a different command prompt

335
00:12:19,920 --> 00:12:22,720
as local admin

336
00:12:22,720 --> 00:12:25,519
and run command very well known past the

337
00:12:25,519 --> 00:12:27,600
hash probably not security conference

338
00:12:27,600 --> 00:12:29,360
everyone knows about that what is that

339
00:12:29,360 --> 00:12:31,279
or most of you knows

340
00:12:31,279 --> 00:12:33,200
um so and

341
00:12:33,200 --> 00:12:35,440
let's check the last time if i have

342
00:12:35,440 --> 00:12:38,560
access to the main controller yay i do

343
00:12:38,560 --> 00:12:40,560
so i became the main administrator just

344
00:12:40,560 --> 00:12:42,639
because i had permissions to administer

345
00:12:42,639 --> 00:12:45,519
ad connect so i think you know what to

346
00:12:45,519 --> 00:12:48,160
do here don't don't have don't provide

347
00:12:48,160 --> 00:12:49,680
uh permissions to access the main

348
00:12:49,680 --> 00:12:51,680
controller officer dummy controller 80

349
00:12:51,680 --> 00:12:54,560
connector middle level admin um but

350
00:12:54,560 --> 00:12:56,800
that's the first scenario so we here

351
00:12:56,800 --> 00:12:58,240
compromised

352
00:12:58,240 --> 00:13:01,279
um active directory uh using ad connect

353
00:13:01,279 --> 00:13:04,160
and now the next target will be virtual

354
00:13:04,160 --> 00:13:06,320
machines in azure so for this purpose i

355
00:13:06,320 --> 00:13:09,279
deploy i deployed uh application on

356
00:13:09,279 --> 00:13:11,680
virtual machines jenkins to be fair it's

357
00:13:11,680 --> 00:13:13,360
not really important which application i

358
00:13:13,360 --> 00:13:15,920
deploy just just for the for the example

359
00:13:15,920 --> 00:13:18,160
uh the the main idea here i have one

360
00:13:18,160 --> 00:13:21,360
linux machine and one windows machine

361
00:13:21,360 --> 00:13:24,160
and now my goal is to compromise

362
00:13:24,160 --> 00:13:27,360
that to virtual machines let me go back

363
00:13:27,360 --> 00:13:29,279
to demo

364
00:13:29,279 --> 00:13:30,399
and

365
00:13:30,399 --> 00:13:33,279
somehow i must connect to virtual

366
00:13:33,279 --> 00:13:34,480
machines

367
00:13:34,480 --> 00:13:36,800
uh from my current state so now

368
00:13:36,800 --> 00:13:39,600
currently i'm a domain administrator

369
00:13:39,600 --> 00:13:41,760
if i'm domain administrator

370
00:13:41,760 --> 00:13:43,760
probably i can connect to any

371
00:13:43,760 --> 00:13:46,160
workstation on the network right

372
00:13:46,160 --> 00:13:47,519
so the main administrators usually

373
00:13:47,519 --> 00:13:49,199
usually they don't have

374
00:13:49,199 --> 00:13:51,120
many restrictions of course even if they

375
00:13:51,120 --> 00:13:53,600
if they do they may

376
00:13:53,600 --> 00:13:55,839
disable those restrictions right away

377
00:13:55,839 --> 00:13:58,959
so if i'm the administrator let's say i

378
00:13:58,959 --> 00:14:00,839
i'm connected to

379
00:14:00,839 --> 00:14:04,160
workstation of

380
00:14:04,160 --> 00:14:06,880
azure admin or azure developer let me

381
00:14:06,880 --> 00:14:09,279
open cmd here

382
00:14:09,279 --> 00:14:12,399
and let's type something like

383
00:14:12,399 --> 00:14:14,959
a azvm list

384
00:14:14,959 --> 00:14:17,199
and output as a table so i want to just

385
00:14:17,199 --> 00:14:19,199
uh list virtual machines and i can see

386
00:14:19,199 --> 00:14:20,800
here there's number virtual machines and

387
00:14:20,800 --> 00:14:22,720
some of them are using for for this demo

388
00:14:22,720 --> 00:14:25,920
as well and my target is jenkins master

389
00:14:25,920 --> 00:14:27,839
and jenkins slave

390
00:14:27,839 --> 00:14:28,880
now

391
00:14:28,880 --> 00:14:31,279
um let's do the same on a different cmd

392
00:14:31,279 --> 00:14:33,600
on a different command prompt

393
00:14:33,600 --> 00:14:36,720
um let's do it again here

394
00:14:36,720 --> 00:14:39,040
this time it should fail so please cross

395
00:14:39,040 --> 00:14:41,279
your fingers it must fail yeah that's

396
00:14:41,279 --> 00:14:44,480
fail it failed so why i open cmp on one

397
00:14:44,480 --> 00:14:46,560
machine it works fine and i open cmd

398
00:14:46,560 --> 00:14:48,240
another machine it doesn't work and it

399
00:14:48,240 --> 00:14:51,040
says i must log in first the reason is

400
00:14:51,040 --> 00:14:53,360
because after login after i type ac

401
00:14:53,360 --> 00:14:55,199
login for the first time

402
00:14:55,199 --> 00:14:56,800
uh the token

403
00:14:56,800 --> 00:14:59,680
will be cached in user profile so look

404
00:14:59,680 --> 00:15:00,720
at this

405
00:15:00,720 --> 00:15:03,279
uh there's a folder called that azure

406
00:15:03,279 --> 00:15:05,519
and so that's the folder where token of

407
00:15:05,519 --> 00:15:08,160
this user will be cached so access token

408
00:15:08,160 --> 00:15:09,920
and the refresh token that usually a

409
00:15:09,920 --> 00:15:12,160
refresh action access token will be will

410
00:15:12,160 --> 00:15:14,399
be cached here x talking expires in one

411
00:15:14,399 --> 00:15:16,560
hour but a refresh token

412
00:15:16,560 --> 00:15:19,279
that leaves for a long time so what what

413
00:15:19,279 --> 00:15:22,160
if i take this token uh our zip that in

414
00:15:22,160 --> 00:15:24,959
an archive uh so what if i take this

415
00:15:24,959 --> 00:15:27,199
token you can just zip everything here

416
00:15:27,199 --> 00:15:28,959
in this folder or or some of the

417
00:15:28,959 --> 00:15:31,199
separate files like access token

418
00:15:31,199 --> 00:15:32,480
and profile

419
00:15:32,480 --> 00:15:35,519
but i i took all of them so if i zip

420
00:15:35,519 --> 00:15:38,160
this i um this azure folder

421
00:15:38,160 --> 00:15:41,839
and copy this content

422
00:15:42,079 --> 00:15:43,920
to to

423
00:15:43,920 --> 00:15:46,880
a different machine

424
00:15:47,270 --> 00:15:50,329
[Music]

425
00:15:50,880 --> 00:15:53,120
paste here

426
00:15:53,120 --> 00:15:56,160
and extract

427
00:15:57,120 --> 00:15:58,880
all right now i have the same profile

428
00:15:58,880 --> 00:16:00,959
and with this with this token which was

429
00:16:00,959 --> 00:16:03,199
cached and fingers crossed now it should

430
00:16:03,199 --> 00:16:06,560
work here without any easy login

431
00:16:06,560 --> 00:16:09,199
come on yay

432
00:16:09,199 --> 00:16:10,639
so now

433
00:16:10,639 --> 00:16:13,759
uh i can run commands so i can i i have

434
00:16:13,759 --> 00:16:16,399
some sort of command line command prompt

435
00:16:16,399 --> 00:16:18,000
in the cloud

436
00:16:18,000 --> 00:16:20,480
so let me jump back jump this time to

437
00:16:20,480 --> 00:16:22,639
the portal azure portal and let me show

438
00:16:22,639 --> 00:16:23,759
you real quick

439
00:16:23,759 --> 00:16:26,880
that we have here um few machine virtual

440
00:16:26,880 --> 00:16:29,360
machines and here are machines jenkins

441
00:16:29,360 --> 00:16:32,079
master jenkins slave so let's say i want

442
00:16:32,079 --> 00:16:34,480
to log into those machines i want to

443
00:16:34,480 --> 00:16:37,680
explore the opera like operating system

444
00:16:37,680 --> 00:16:39,759
file system and so on so if i want to

445
00:16:39,759 --> 00:16:41,839
log in to jenkins master for example i

446
00:16:41,839 --> 00:16:44,160
must click connect rdp or might just

447
00:16:44,160 --> 00:16:45,680
take this ip address

448
00:16:45,680 --> 00:16:49,040
um so let's say mstc and it asked me for

449
00:16:49,040 --> 00:16:51,759
password uh and the same will be with

450
00:16:51,759 --> 00:16:53,040
linux of course

451
00:16:53,040 --> 00:16:55,759
um so i don't know the password so i

452
00:16:55,759 --> 00:16:58,399
want to log into the machine but i don't

453
00:16:58,399 --> 00:17:01,120
know the password is it possible to do

454
00:17:01,120 --> 00:17:05,280
um yes if you have permissions

455
00:17:05,280 --> 00:17:07,520
to run command

456
00:17:07,520 --> 00:17:09,760
so there's a fee there's a feature in

457
00:17:09,760 --> 00:17:12,240
azure so you may run command instead of

458
00:17:12,240 --> 00:17:13,599
operating system

459
00:17:13,599 --> 00:17:14,400
um

460
00:17:14,400 --> 00:17:16,880
without logging to the machine and so

461
00:17:16,880 --> 00:17:18,559
what i can do i can run the command they

462
00:17:18,559 --> 00:17:19,520
want

463
00:17:19,520 --> 00:17:21,199
on windows i can run powershell script

464
00:17:21,199 --> 00:17:22,799
on linux it will be patch script of

465
00:17:22,799 --> 00:17:24,720
course shell script

466
00:17:24,720 --> 00:17:26,720
i can run command here um right now

467
00:17:26,720 --> 00:17:27,919
command here

468
00:17:27,919 --> 00:17:30,559
so now let me jump back to

469
00:17:30,559 --> 00:17:32,400
this machine and now what i want to do i

470
00:17:32,400 --> 00:17:34,640
want to run my first command oh before

471
00:17:34,640 --> 00:17:36,559
that sorry sorry

472
00:17:36,559 --> 00:17:39,580
i want to establish my netcat listener

473
00:17:39,580 --> 00:17:41,600
[Music]

474
00:17:41,600 --> 00:17:43,440
and

475
00:17:43,440 --> 00:17:46,320
here as well

476
00:17:46,320 --> 00:17:47,600
a different

477
00:17:47,600 --> 00:17:48,220
board

478
00:17:48,220 --> 00:17:50,480
[Music]

479
00:17:50,480 --> 00:17:52,559
and now let's try to

480
00:17:52,559 --> 00:17:54,880
to to run this command what this command

481
00:17:54,880 --> 00:17:57,440
is all about that's a shell

482
00:17:57,440 --> 00:17:59,520
so if everything will be fine

483
00:17:59,520 --> 00:18:01,440
hopefully

484
00:18:01,440 --> 00:18:03,919
then i will get a shell to linux and

485
00:18:03,919 --> 00:18:06,300
let's try the same for windows

486
00:18:06,300 --> 00:18:08,960
[Music]

487
00:18:08,960 --> 00:18:11,090
so let's try windows

488
00:18:11,090 --> 00:18:13,360
[Music]

489
00:18:13,360 --> 00:18:15,679
and let's try windows as well now let's

490
00:18:15,679 --> 00:18:18,240
take a look

491
00:18:20,559 --> 00:18:22,480
uh fingers crossed

492
00:18:22,480 --> 00:18:24,880
should give me a shell uh it takes so

493
00:18:24,880 --> 00:18:27,600
those commands do not they do not run

494
00:18:27,600 --> 00:18:28,559
immediately

495
00:18:28,559 --> 00:18:30,799
so it might take some time

496
00:18:30,799 --> 00:18:31,230
um

497
00:18:31,230 --> 00:18:33,280
[Music]

498
00:18:33,280 --> 00:18:36,480
i hope it will not take super long

499
00:18:36,480 --> 00:18:38,720
because i don't really have time to wait

500
00:18:38,720 --> 00:18:40,559
here

501
00:18:40,559 --> 00:18:44,799
um but anyway so i think don't just oh

502
00:18:44,799 --> 00:18:46,480
succeed

503
00:18:46,480 --> 00:18:49,679
shell script bad oh damn it that was bad

504
00:18:49,679 --> 00:18:50,720
character

505
00:18:50,720 --> 00:18:52,320
um all right

506
00:18:52,320 --> 00:18:54,720
this one bad character will be maybe

507
00:18:54,720 --> 00:18:56,960
windows will be better oh yeah i have a

508
00:18:56,960 --> 00:18:58,640
show on windows at least

509
00:18:58,640 --> 00:19:01,600
so let's say who am i

510
00:19:01,600 --> 00:19:04,719
um and

511
00:19:04,880 --> 00:19:07,440
a local system and by the way windows is

512
00:19:07,440 --> 00:19:10,400
my masternode so let's try to

513
00:19:10,400 --> 00:19:14,160
um check if we have

514
00:19:14,160 --> 00:19:16,799
um access so let's see let's go to my

515
00:19:16,799 --> 00:19:18,799
master node

516
00:19:18,799 --> 00:19:20,880
let's copy this

517
00:19:20,880 --> 00:19:23,540
jenkins has port 8080

518
00:19:23,540 --> 00:19:26,889
[Music]

519
00:19:27,039 --> 00:19:29,760
let's see if it will be available

520
00:19:29,760 --> 00:19:32,080
so and one one more thing that i want to

521
00:19:32,080 --> 00:19:34,240
do i want to check

522
00:19:34,240 --> 00:19:37,600
um airlock because an airlock i may find

523
00:19:37,600 --> 00:19:40,880
sometimes password initial password oh

524
00:19:40,880 --> 00:19:43,360
look at this so that is initial password

525
00:19:43,360 --> 00:19:45,760
of jenkins let's see if i can

526
00:19:45,760 --> 00:19:46,880
oh

527
00:19:46,880 --> 00:19:48,400
looks like it doesn't want to connect

528
00:19:48,400 --> 00:19:51,039
from from outside um because i didn't

529
00:19:51,039 --> 00:19:53,120
configure jenkins for i just i just

530
00:19:53,120 --> 00:19:55,280
installed that but i didn't i didn't say

531
00:19:55,280 --> 00:19:57,600
uh set up the password uh looks like

532
00:19:57,600 --> 00:20:01,039
that's the reason anyway so i found uh

533
00:20:01,039 --> 00:20:02,799
that's not what my goal was to just get

534
00:20:02,799 --> 00:20:04,159
into virtual machine i don't really care

535
00:20:04,159 --> 00:20:05,120
if i can

536
00:20:05,120 --> 00:20:06,880
log into jenkins or not

537
00:20:06,880 --> 00:20:10,000
but i have access to virtual machine now

538
00:20:10,000 --> 00:20:12,320
um

539
00:20:12,400 --> 00:20:15,120
uh let's go back to slides

540
00:20:15,120 --> 00:20:18,240
and so we here compromised windows and

541
00:20:18,240 --> 00:20:20,960
linux machines uh not limits to be fair

542
00:20:20,960 --> 00:20:22,799
i just i i

543
00:20:22,799 --> 00:20:25,280
i i in a script i i use the wrong

544
00:20:25,280 --> 00:20:27,520
command so uh looks like it doesn't

545
00:20:27,520 --> 00:20:30,320
accept on this modern limits machine i

546
00:20:30,320 --> 00:20:32,320
just need to have to use the different

547
00:20:32,320 --> 00:20:36,080
reverse shell but anyway um so

548
00:20:36,080 --> 00:20:38,240
in a similar manner we can run that on

549
00:20:38,240 --> 00:20:39,280
linux

550
00:20:39,280 --> 00:20:40,880
all right so

551
00:20:40,880 --> 00:20:41,919
now

552
00:20:41,919 --> 00:20:43,840
let's start the

553
00:20:43,840 --> 00:20:46,000
third module and the third another

554
00:20:46,000 --> 00:20:48,000
module but third scenario where we're

555
00:20:48,000 --> 00:20:49,280
going to have more complex

556
00:20:49,280 --> 00:20:50,960
infrastructure

557
00:20:50,960 --> 00:20:53,679
so now we have

558
00:20:53,679 --> 00:20:55,360
a web application

559
00:20:55,360 --> 00:20:58,720
with backend in sql database

560
00:20:58,720 --> 00:21:00,400
and of course when application connects

561
00:21:00,400 --> 00:21:03,280
to sql it must have credentials right

562
00:21:03,280 --> 00:21:05,600
um so it must connect to sql it must be

563
00:21:05,600 --> 00:21:07,280
authenticated the request and so

564
00:21:07,280 --> 00:21:09,840
credentials should not be stored locally

565
00:21:09,840 --> 00:21:11,520
on web applications so that's a very bad

566
00:21:11,520 --> 00:21:12,559
practice

567
00:21:12,559 --> 00:21:14,840
i'm storing credentials in key

568
00:21:14,840 --> 00:21:17,840
vault and also i rotate those

569
00:21:17,840 --> 00:21:20,000
credentials so periodically

570
00:21:20,000 --> 00:21:22,240
uh it changed the

571
00:21:22,240 --> 00:21:24,320
the credentials in keyboard and change

572
00:21:24,320 --> 00:21:27,280
credentials in sql database as well

573
00:21:27,280 --> 00:21:30,000
now let's take a look how we can uh how

574
00:21:30,000 --> 00:21:32,320
can we do that how we can

575
00:21:32,320 --> 00:21:34,159
test this environment what

576
00:21:34,159 --> 00:21:36,799
misconfigurations possibly may exist in

577
00:21:36,799 --> 00:21:38,240
this environment

578
00:21:38,240 --> 00:21:40,480
so i'm gonna start from oh let me first

579
00:21:40,480 --> 00:21:42,799
show you credentials that they exist

580
00:21:42,799 --> 00:21:45,760
i'm gonna switch to my portal

581
00:21:45,760 --> 00:21:47,760
um and let's go to

582
00:21:47,760 --> 00:21:49,039
two

583
00:21:49,039 --> 00:21:50,240
uh

584
00:21:50,240 --> 00:21:52,240
cable

585
00:21:52,240 --> 00:21:54,880
and here's my key vault let me show you

586
00:21:54,880 --> 00:21:56,840
that i should not have access to

587
00:21:56,840 --> 00:21:59,280
credentials yeah so look at this so you

588
00:21:59,280 --> 00:22:01,280
don't have permissions to list

589
00:22:01,280 --> 00:22:04,320
now let me just go to access policies

590
00:22:04,320 --> 00:22:06,559
very quickly i'm gonna give myself

591
00:22:06,559 --> 00:22:08,320
permissions just to show you that those

592
00:22:08,320 --> 00:22:09,760
credentials exist

593
00:22:09,760 --> 00:22:12,480
uh let's say list just list is enough

594
00:22:12,480 --> 00:22:15,039
um and let's say

595
00:22:15,039 --> 00:22:17,200
i want to give permissions to myself

596
00:22:17,200 --> 00:22:19,120
let's

597
00:22:19,120 --> 00:22:20,559
find my

598
00:22:20,559 --> 00:22:22,879
all right

599
00:22:24,880 --> 00:22:27,919
add save

600
00:22:27,919 --> 00:22:30,320
go back to secrets

601
00:22:30,320 --> 00:22:33,440
and so username and password are there i

602
00:22:33,440 --> 00:22:34,960
cannot i

603
00:22:34,960 --> 00:22:36,880
actually give my game myself on the list

604
00:22:36,880 --> 00:22:39,280
so i cannot get actual secret but you

605
00:22:39,280 --> 00:22:40,880
can see here there are two secrets

606
00:22:40,880 --> 00:22:43,679
username and password in keyboard and so

607
00:22:43,679 --> 00:22:45,280
so they will not be stored on the

608
00:22:45,280 --> 00:22:46,559
application locally they will be

609
00:22:46,559 --> 00:22:48,640
retrieved from keyboard

610
00:22:48,640 --> 00:22:50,640
um now let me just remove permission

611
00:22:50,640 --> 00:22:54,679
from from that

612
00:22:55,840 --> 00:22:57,600
now let's go back

613
00:22:57,600 --> 00:23:00,559
so where the problem exists in my

614
00:23:00,559 --> 00:23:02,240
environment in my environment i don't

615
00:23:02,240 --> 00:23:04,080
want to say it's it's commonly used i

616
00:23:04,080 --> 00:23:06,480
don't want to say i i see that often but

617
00:23:06,480 --> 00:23:10,559
i saw that um one more one or two times

618
00:23:10,559 --> 00:23:12,799
uh so when com and comp when companies

619
00:23:12,799 --> 00:23:14,480
use credential rotation it's recommended

620
00:23:14,480 --> 00:23:16,240
by microsoft as well

621
00:23:16,240 --> 00:23:17,120
um

622
00:23:17,120 --> 00:23:18,960
um so how it looks like so there's a

623
00:23:18,960 --> 00:23:21,280
special function function application

624
00:23:21,280 --> 00:23:24,000
which will automatically rotate based on

625
00:23:24,000 --> 00:23:25,600
the sum events

626
00:23:25,600 --> 00:23:28,400
based on triggers uh credentials here

627
00:23:28,400 --> 00:23:31,440
and and here in the target as well so uh

628
00:23:31,440 --> 00:23:33,120
the secret in the key vault will be

629
00:23:33,120 --> 00:23:35,760
changed and the password in in sql will

630
00:23:35,760 --> 00:23:38,080
be updated as well so that's that's the

631
00:23:38,080 --> 00:23:40,799
rotation the problem is a function

632
00:23:40,799 --> 00:23:43,120
application has permissions

633
00:23:43,120 --> 00:23:45,520
to modify keyboard and of course

634
00:23:45,520 --> 00:23:47,600
extract data from keyboard

635
00:23:47,600 --> 00:23:50,720
and if function application doesn't have

636
00:23:50,720 --> 00:23:54,400
prop appropriate uh configuration so so

637
00:23:54,400 --> 00:23:57,279
for example i i saw that i saw that so

638
00:23:57,279 --> 00:23:59,360
key vault configured securely

639
00:23:59,360 --> 00:24:01,200
using access policy in key volt but

640
00:24:01,200 --> 00:24:03,279
function application has a bit more

641
00:24:03,279 --> 00:24:05,520
permissions so people that manage

642
00:24:05,520 --> 00:24:06,960
function up they have some permissions

643
00:24:06,960 --> 00:24:09,039
on function application so

644
00:24:09,039 --> 00:24:10,640
my entry point may become function

645
00:24:10,640 --> 00:24:13,360
application if i if i can modify this

646
00:24:13,360 --> 00:24:14,480
function

647
00:24:14,480 --> 00:24:16,880
i can extract data from key vault so let

648
00:24:16,880 --> 00:24:19,120
me jump back to demo let me show you

649
00:24:19,120 --> 00:24:20,640
quick the function

650
00:24:20,640 --> 00:24:22,799
and then i'm going to start to my

651
00:24:22,799 --> 00:24:26,000
modification so let's find function

652
00:24:26,000 --> 00:24:27,520
up

653
00:24:27,520 --> 00:24:31,279
so here's the akv rotation

654
00:24:31,279 --> 00:24:33,440
and so let's go to

655
00:24:33,440 --> 00:24:35,039
to

656
00:24:35,039 --> 00:24:38,320
deployment center i guess

657
00:24:38,880 --> 00:24:40,480
uh a little deployment center will be

658
00:24:40,480 --> 00:24:42,159
used slightly late let me first show you

659
00:24:42,159 --> 00:24:44,240
functions so i have two functions here

660
00:24:44,240 --> 00:24:47,520
uh one e one that i want to show you is

661
00:24:47,520 --> 00:24:49,520
triggered by https request

662
00:24:49,520 --> 00:24:51,600
let me click on this function

663
00:24:51,600 --> 00:24:52,640
by the way that's a function from

664
00:24:52,640 --> 00:24:54,799
microsoft so you may find on the github

665
00:24:54,799 --> 00:24:58,440
let me show you the code

666
00:25:00,000 --> 00:25:01,840
so this function based on powershell so

667
00:25:01,840 --> 00:25:03,360
let's show the original one so that's

668
00:25:03,360 --> 00:25:04,400
the original function based on

669
00:25:04,400 --> 00:25:05,679
powershell

670
00:25:05,679 --> 00:25:07,679
um and what i want to do

671
00:25:07,679 --> 00:25:10,640
i want to add my own function here my

672
00:25:10,640 --> 00:25:11,360
old

673
00:25:11,360 --> 00:25:13,200
own code and so i already did that i

674
00:25:13,200 --> 00:25:15,200
will show you how i did that and so this

675
00:25:15,200 --> 00:25:17,200
code should extract data from keyboard

676
00:25:17,200 --> 00:25:18,799
let me show you how we can modify how we

677
00:25:18,799 --> 00:25:21,520
can modify this function uh one of the

678
00:25:21,520 --> 00:25:23,760
default configurations and functions

679
00:25:23,760 --> 00:25:26,559
is accessed through ftp so if you go to

680
00:25:26,559 --> 00:25:29,120
to to configuration

681
00:25:29,120 --> 00:25:30,559
um

682
00:25:30,559 --> 00:25:31,200
come on

683
00:25:31,200 --> 00:25:32,960
[Music]

684
00:25:32,960 --> 00:25:34,640
um and in configuration if i go to

685
00:25:34,640 --> 00:25:37,679
general so ftp state all allowed is just

686
00:25:37,679 --> 00:25:39,840
by default it's it's default i didn't

687
00:25:39,840 --> 00:25:40,880
change that

688
00:25:40,880 --> 00:25:44,080
and so if i have permissions to access

689
00:25:44,080 --> 00:25:45,520
this this function

690
00:25:45,520 --> 00:25:47,520
i mean to read this function i can get

691
00:25:47,520 --> 00:25:49,279
ftp credentials

692
00:25:49,279 --> 00:25:51,919
and so they are here so i can click show

693
00:25:51,919 --> 00:25:53,760
here and you will see the username and

694
00:25:53,760 --> 00:25:54,880
password

695
00:25:54,880 --> 00:25:57,279
i don't have 3d interface access

696
00:25:57,279 --> 00:25:59,520
oh by the way let's break those shells

697
00:25:59,520 --> 00:26:01,440
um

698
00:26:01,440 --> 00:26:04,080
i don't have um i don't have

699
00:26:04,080 --> 00:26:07,520
access open jump to this one

700
00:26:07,520 --> 00:26:10,159
i don't have access to to interface so

701
00:26:10,159 --> 00:26:11,600
let me do it from command prompt so

702
00:26:11,600 --> 00:26:13,520
let's say first of all i want to find

703
00:26:13,520 --> 00:26:17,360
url to this function application

704
00:26:17,360 --> 00:26:19,440
so that's that's the url let me copy

705
00:26:19,440 --> 00:26:20,640
that

706
00:26:20,640 --> 00:26:23,200
and paste into

707
00:26:23,200 --> 00:26:24,559
filezilla

708
00:26:24,559 --> 00:26:28,320
then i want to get credentials

709
00:26:29,200 --> 00:26:34,000
so let's do that and here is username

710
00:26:34,000 --> 00:26:39,279
and here is passport as well

711
00:26:39,279 --> 00:26:42,559
all right let's connect okay

712
00:26:42,559 --> 00:26:46,000
and look at this so here's my function

713
00:26:46,000 --> 00:26:49,360
and let me go there and i i just add

714
00:26:49,360 --> 00:26:51,600
another font another another script with

715
00:26:51,600 --> 00:26:54,000
this name so it will it so the script

716
00:26:54,000 --> 00:26:56,400
with name run that ps1 will run

717
00:26:56,400 --> 00:26:58,799
automatically and so i renamed the

718
00:26:58,799 --> 00:27:01,760
original one to run around one uh and i

719
00:27:01,760 --> 00:27:04,159
placed my own script here now i just

720
00:27:04,159 --> 00:27:07,039
need to run my function using http http

721
00:27:07,039 --> 00:27:09,679
trader and that should work by the way

722
00:27:09,679 --> 00:27:11,360
it's hard to predict for how long this

723
00:27:11,360 --> 00:27:13,600
function will work usually it takes 30

724
00:27:13,600 --> 00:27:16,960
40 60 seconds but a few times it took

725
00:27:16,960 --> 00:27:20,000
much longer so fingers crossed it will

726
00:27:20,000 --> 00:27:23,279
it will work i mean it will show me the

727
00:27:23,279 --> 00:27:25,600
result here if not

728
00:27:25,600 --> 00:27:28,399
uh i know i know password anyway but so

729
00:27:28,399 --> 00:27:30,799
here's just a request to this

730
00:27:30,799 --> 00:27:32,559
try to trigger this function

731
00:27:32,559 --> 00:27:35,520
um and um so my script will do

732
00:27:35,520 --> 00:27:37,279
everything everything

733
00:27:37,279 --> 00:27:38,399
for me

734
00:27:38,399 --> 00:27:40,720
i'm just i'm just i'm just send the oh

735
00:27:40,720 --> 00:27:41,919
look good

736
00:27:41,919 --> 00:27:44,880
username oh look at this so username is

737
00:27:44,880 --> 00:27:48,320
weba and password is passport

738
00:27:48,320 --> 00:27:50,320
um all right now

739
00:27:50,320 --> 00:27:53,520
uh i want to connect the sql with those

740
00:27:53,520 --> 00:27:56,240
credentials so first of all let me try

741
00:27:56,240 --> 00:27:59,760
to connect to sql from here

742
00:27:59,760 --> 00:28:01,600
let's say connect

743
00:28:01,600 --> 00:28:03,440
and from here as well let's click

744
00:28:03,440 --> 00:28:04,640
connect

745
00:28:04,640 --> 00:28:09,039
so the first machine i'm trying to use

746
00:28:09,039 --> 00:28:10,799
is

747
00:28:10,799 --> 00:28:12,880
web

748
00:28:12,880 --> 00:28:13,840
sport

749
00:28:13,840 --> 00:28:17,200
is my on-prem machine and look at this

750
00:28:17,200 --> 00:28:20,000
it says connected database oh no that's

751
00:28:20,000 --> 00:28:21,279
not different there

752
00:28:21,279 --> 00:28:22,960
uh let me double check what the hell is

753
00:28:22,960 --> 00:28:25,039
that what the hell is going on with my

754
00:28:25,039 --> 00:28:27,520
database

755
00:28:27,760 --> 00:28:30,799
uh online that's fine

756
00:28:30,799 --> 00:28:32,480
interesting

757
00:28:32,480 --> 00:28:33,679
um

758
00:28:33,679 --> 00:28:37,360
let me copy this address just in case

759
00:28:37,360 --> 00:28:37,680
uh

760
00:28:37,680 --> 00:28:39,840
[Music]

761
00:28:39,840 --> 00:28:42,320
should be fine

762
00:28:42,320 --> 00:28:44,399
uh i can connect the database could not

763
00:28:44,399 --> 00:28:46,399
resolve user realm

764
00:28:46,399 --> 00:28:48,559
uh azurity oh sorry that's a sql

765
00:28:48,559 --> 00:28:49,919
authentication

766
00:28:49,919 --> 00:28:52,320
my bad

767
00:28:52,640 --> 00:28:54,720
all right so now it says hey

768
00:28:54,720 --> 00:28:56,720
firewall does not allow you to connect

769
00:28:56,720 --> 00:28:57,840
so even if you know username and

770
00:28:57,840 --> 00:29:00,000
password firewall will not allow you to

771
00:29:00,000 --> 00:29:02,720
connect because we have firewall just

772
00:29:02,720 --> 00:29:05,679
just just just by default um in the in

773
00:29:05,679 --> 00:29:08,240
azure so let me click on this firewall

774
00:29:08,240 --> 00:29:10,799
and by default firewall configured where

775
00:29:10,799 --> 00:29:14,080
properly so firewall will will

776
00:29:14,080 --> 00:29:16,960
will not allow you to connect at all so

777
00:29:16,960 --> 00:29:19,279
you must configure your firewall and and

778
00:29:19,279 --> 00:29:22,000
that's the most that that's what i see

779
00:29:22,000 --> 00:29:24,960
almost every time very very often so

780
00:29:24,960 --> 00:29:27,039
there's a configuration that says allow

781
00:29:27,039 --> 00:29:29,039
azure services and the resources to

782
00:29:29,039 --> 00:29:31,200
access the server and many companies

783
00:29:31,200 --> 00:29:32,640
enable this

784
00:29:32,640 --> 00:29:34,880
so it means like azure services they

785
00:29:34,880 --> 00:29:37,440
should have access to this sql server

786
00:29:37,440 --> 00:29:39,679
let me let me check that

787
00:29:39,679 --> 00:29:41,760
and let's let's say help me type

788
00:29:41,760 --> 00:29:42,960
password

789
00:29:42,960 --> 00:29:45,039
click connect and yeah i can connect to

790
00:29:45,039 --> 00:29:46,559
this sql server

791
00:29:46,559 --> 00:29:48,159
but one of the problems with this with

792
00:29:48,159 --> 00:29:49,600
this configuration

793
00:29:49,600 --> 00:29:51,919
and it's not really described here on

794
00:29:51,919 --> 00:29:53,760
the portal because it says connection

795
00:29:53,760 --> 00:29:55,760
from api specified below provides access

796
00:29:55,760 --> 00:29:58,159
to all databases the problem is

797
00:29:58,159 --> 00:30:02,159
um it will not be your services so many

798
00:30:02,159 --> 00:30:04,080
people think like oh it's my

799
00:30:04,080 --> 00:30:06,640
subscription so services from my azure

800
00:30:06,640 --> 00:30:07,919
subscription

801
00:30:07,919 --> 00:30:10,159
they will be able to connect

802
00:30:10,159 --> 00:30:11,600
ah no

803
00:30:11,600 --> 00:30:14,399
no it means that any

804
00:30:14,399 --> 00:30:17,200
service any ip address not service any

805
00:30:17,200 --> 00:30:18,720
ip address

806
00:30:18,720 --> 00:30:21,440
belongs to azure will be able to connect

807
00:30:21,440 --> 00:30:24,080
so if i if i live in a different country

808
00:30:24,080 --> 00:30:25,840
um and

809
00:30:25,840 --> 00:30:27,360
and and and

810
00:30:27,360 --> 00:30:29,360
and around the different companies so

811
00:30:29,360 --> 00:30:31,520
but i have virtual machine and azure i

812
00:30:31,520 --> 00:30:33,279
will be able to connect of course i must

813
00:30:33,279 --> 00:30:35,039
use them and password but firewall will

814
00:30:35,039 --> 00:30:37,039
not be will not stop me

815
00:30:37,039 --> 00:30:38,720
so that's not the most secure

816
00:30:38,720 --> 00:30:42,320
configuration so let me disable that

817
00:30:46,080 --> 00:30:48,080
and so let me

818
00:30:48,080 --> 00:30:49,760
uh enable what's what is we can what is

819
00:30:49,760 --> 00:30:51,360
more command from security standpoint

820
00:30:51,360 --> 00:30:53,840
deny public access a public network

821
00:30:53,840 --> 00:30:56,559
access so that means now

822
00:30:56,559 --> 00:30:59,039
access will be provided only internally

823
00:30:59,039 --> 00:31:02,240
so my my resources in azure connected to

824
00:31:02,240 --> 00:31:04,320
virtual network in the cloud will be

825
00:31:04,320 --> 00:31:07,279
able to connect but not any services

826
00:31:07,279 --> 00:31:09,840
that use public endpoints

827
00:31:09,840 --> 00:31:12,559
now let's try to to to connect again

828
00:31:12,559 --> 00:31:14,799
from my azure azure machine so let's say

829
00:31:14,799 --> 00:31:16,080
disconnect

830
00:31:16,080 --> 00:31:20,720
click connect again i use password

831
00:31:20,720 --> 00:31:23,279
oops doesn't work and it says a public

832
00:31:23,279 --> 00:31:25,919
public access network is set to yes

833
00:31:25,919 --> 00:31:28,240
all right so now

834
00:31:28,240 --> 00:31:32,159
um what i can do with that uh if i'm if

835
00:31:32,159 --> 00:31:33,919
i'm a pen tester if i'm an attacker what

836
00:31:33,919 --> 00:31:36,080
i can do that so

837
00:31:36,080 --> 00:31:36,960
um

838
00:31:36,960 --> 00:31:39,120
let me check maybe i have permissions to

839
00:31:39,120 --> 00:31:40,399
access web applications so our

840
00:31:40,399 --> 00:31:42,720
application has access to uh to backend

841
00:31:42,720 --> 00:31:44,720
database right so front end has access

842
00:31:44,720 --> 00:31:47,360
to back end somehow directly on

843
00:31:47,360 --> 00:31:49,120
indirectly um

844
00:31:49,120 --> 00:31:51,519
of course ideally is the front end

845
00:31:51,519 --> 00:31:54,000
doesn't have permissions to access sql

846
00:31:54,000 --> 00:31:55,760
backend directly and there's a must be

847
00:31:55,760 --> 00:31:57,919
another tier between them but in my case

848
00:31:57,919 --> 00:31:58,240
i have

849
00:31:58,240 --> 00:31:58,960
[Music]

850
00:31:58,960 --> 00:31:59,600
a web

851
00:31:59,600 --> 00:32:02,559
web web tier here web up and back end

852
00:32:02,559 --> 00:32:04,559
and no middle tiers

853
00:32:04,559 --> 00:32:07,679
so this one should have have access

854
00:32:07,679 --> 00:32:10,720
now let's try to jump the web up to

855
00:32:10,720 --> 00:32:12,799
jump jump back to portal and let's see

856
00:32:12,799 --> 00:32:15,440
what web application i have

857
00:32:15,440 --> 00:32:17,679
uh

858
00:32:21,039 --> 00:32:23,519
come on

859
00:32:24,000 --> 00:32:25,679
yeah that's that's just just a regular

860
00:32:25,679 --> 00:32:28,080
application uh very simple with simple

861
00:32:28,080 --> 00:32:30,559
registration form uh let me register

862
00:32:30,559 --> 00:32:32,000
real quick let's say

863
00:32:32,000 --> 00:32:33,039
uh

864
00:32:33,039 --> 00:32:34,559
b sites

865
00:32:34,559 --> 00:32:37,120
besides

866
00:32:37,120 --> 00:32:39,200
bcm that's going to be my name and the

867
00:32:39,200 --> 00:32:42,600
email will be beside bcn

868
00:32:42,600 --> 00:32:45,679
whatever.com so let me click submit and

869
00:32:45,679 --> 00:32:48,000
you're registered well done good

870
00:32:48,000 --> 00:32:48,799
now

871
00:32:48,799 --> 00:32:50,799
let's try to get into the database using

872
00:32:50,799 --> 00:32:52,799
this web application

873
00:32:52,799 --> 00:32:55,039
i'm going to jump back to my demo

874
00:32:55,039 --> 00:32:57,760
and now let me clear the screen and so

875
00:32:57,760 --> 00:33:01,360
web application has the same issue as uh

876
00:33:01,360 --> 00:33:02,480
functions

877
00:33:02,480 --> 00:33:05,360
they have ftp access allowed and so i

878
00:33:05,360 --> 00:33:07,600
can do i can repeat the same steps

879
00:33:07,600 --> 00:33:09,519
absolutely

880
00:33:09,519 --> 00:33:11,760
so i have ftp

881
00:33:11,760 --> 00:33:14,399
url

882
00:33:15,440 --> 00:33:19,519
let's just create a new tab

883
00:33:20,240 --> 00:33:21,600
and let's take

884
00:33:21,600 --> 00:33:25,040
credentials as well

885
00:33:25,040 --> 00:33:27,519
[Music]

886
00:33:27,519 --> 00:33:29,840
good

887
00:33:30,720 --> 00:33:32,000
and

888
00:33:32,000 --> 00:33:36,399
this could this password as well

889
00:33:37,039 --> 00:33:38,399
connect

890
00:33:38,399 --> 00:33:39,440
yes

891
00:33:39,440 --> 00:33:42,480
and look at this uh yeah i i already put

892
00:33:42,480 --> 00:33:44,080
some files there so here's my

893
00:33:44,080 --> 00:33:46,720
application one pager and so if i have

894
00:33:46,720 --> 00:33:49,760
access to ftp to this

895
00:33:49,760 --> 00:33:53,760
uh to file system what i can do i can

896
00:33:53,760 --> 00:33:54,640
uh

897
00:33:54,640 --> 00:33:55,840
it's either

898
00:33:55,840 --> 00:33:58,480
i can upload my own php file i can see

899
00:33:58,480 --> 00:34:02,080
it's php so let me upload my own php

900
00:34:02,080 --> 00:34:03,919
called myself.php

901
00:34:03,919 --> 00:34:05,919
and now let's try to navigate to this my

902
00:34:05,919 --> 00:34:07,120
shell

903
00:34:07,120 --> 00:34:10,239
my shell dot php

904
00:34:10,239 --> 00:34:11,280
yay

905
00:34:11,280 --> 00:34:13,839
i have access to i have a shell web

906
00:34:13,839 --> 00:34:15,918
shell yeah of course web shell is not

907
00:34:15,918 --> 00:34:17,199
the best

908
00:34:17,199 --> 00:34:19,599
shell in the world so let me uh

909
00:34:19,599 --> 00:34:22,719
establish the normal netcat shell

910
00:34:22,719 --> 00:34:24,239
whoa whoa whoa whoa whoa that's a roman

911
00:34:24,239 --> 00:34:26,560
sorry that's the wrong plan um

912
00:34:26,560 --> 00:34:27,100
this one

913
00:34:27,100 --> 00:34:30,139
[Music]

914
00:34:30,480 --> 00:34:32,320
and now i have netka shell

915
00:34:32,320 --> 00:34:34,639
all right so

916
00:34:34,639 --> 00:34:36,000
so so so

917
00:34:36,000 --> 00:34:37,599
uh let's see who am i

918
00:34:37,599 --> 00:34:40,000
um who am i

919
00:34:40,000 --> 00:34:42,719
and i'm i'm dub dub dub data i i

920
00:34:42,719 --> 00:34:44,960
definitely i'm definitely not root i

921
00:34:44,960 --> 00:34:47,679
don't have id i'm not root

922
00:34:47,679 --> 00:34:48,800
so

923
00:34:48,800 --> 00:34:51,280
if i want to access database i need to

924
00:34:51,280 --> 00:34:53,040
have some tools before i want to access

925
00:34:53,040 --> 00:34:55,679
from command prompt i need some tools

926
00:34:55,679 --> 00:35:00,160
and tools to i must install them but

927
00:35:00,160 --> 00:35:01,040
but

928
00:35:01,040 --> 00:35:02,800
um i don't have permissions to install

929
00:35:02,800 --> 00:35:05,440
so let me go back to my ftp and what i'm

930
00:35:05,440 --> 00:35:08,160
using is special tool called usql so

931
00:35:08,160 --> 00:35:10,560
this tool may connect the database

932
00:35:10,560 --> 00:35:12,560
without so it made me it's a tool to

933
00:35:12,560 --> 00:35:14,720
connect the sql database without uh

934
00:35:14,720 --> 00:35:16,960
without installation so let's connect

935
00:35:16,960 --> 00:35:19,359
using this usql

936
00:35:19,359 --> 00:35:21,200
and looks like i connected let's try to

937
00:35:21,200 --> 00:35:22,720
list tables

938
00:35:22,720 --> 00:35:24,640
um

939
00:35:24,640 --> 00:35:27,200
and i can see the registration tbl

940
00:35:27,200 --> 00:35:30,079
all right let's try to to to get the

941
00:35:30,079 --> 00:35:31,260
table content

942
00:35:31,260 --> 00:35:33,520
[Music]

943
00:35:33,520 --> 00:35:37,040
and look at this uh b sides bcn whatever

944
00:35:37,040 --> 00:35:39,680
so i can see this table

945
00:35:39,680 --> 00:35:41,359
alright so that

946
00:35:41,359 --> 00:35:43,119
and

947
00:35:43,119 --> 00:35:47,520
like that and so that is

948
00:35:48,079 --> 00:35:50,640
my web application and

949
00:35:50,640 --> 00:35:51,680
sql

950
00:35:51,680 --> 00:35:53,920
backend as well

951
00:35:53,920 --> 00:35:55,119
compromised

952
00:35:55,119 --> 00:35:56,960
so

953
00:35:56,960 --> 00:35:58,640
now we have the last piece here and i

954
00:35:58,640 --> 00:36:01,040
think i have seven minutes and for q a

955
00:36:01,040 --> 00:36:02,320
can you advise me if i have any

956
00:36:02,320 --> 00:36:04,240
questions so we will have do we have

957
00:36:04,240 --> 00:36:05,359
questions

958
00:36:05,359 --> 00:36:09,520
should i reserve time for q a um

959
00:36:09,520 --> 00:36:11,000
uh so

960
00:36:11,000 --> 00:36:12,480
[Music]

961
00:36:12,480 --> 00:36:14,960
i haven't i didn't hear you but anyway

962
00:36:14,960 --> 00:36:17,040
um so last piece we have here

963
00:36:17,040 --> 00:36:18,960
application gateway uh so it's

964
00:36:18,960 --> 00:36:21,280
application firewall that does not allow

965
00:36:21,280 --> 00:36:24,720
me to uh get into the web app

966
00:36:24,720 --> 00:36:27,599
from outside so i just just quickly want

967
00:36:27,599 --> 00:36:30,240
to show you that um

968
00:36:30,240 --> 00:36:33,680
if if i protect with with with buff

969
00:36:33,680 --> 00:36:37,200
let's try to run sql injection

970
00:36:37,200 --> 00:36:39,119
sequence

971
00:36:39,119 --> 00:36:42,240
sorry where's my injection here we go

972
00:36:42,240 --> 00:36:45,200
so uh it was error-based injections so i

973
00:36:45,200 --> 00:36:48,400
can see that like a path to the my to my

974
00:36:48,400 --> 00:36:50,800
php file i can see the information about

975
00:36:50,800 --> 00:36:52,079
database

976
00:36:52,079 --> 00:36:54,480
um so it reveals some information

977
00:36:54,480 --> 00:36:58,000
uh driver and so on so it's exceptional

978
00:36:58,000 --> 00:37:00,480
exception now what i want to do i want

979
00:37:00,480 --> 00:37:03,839
to show you one last thing if i try if

980
00:37:03,839 --> 00:37:05,839
i have another application i have

981
00:37:05,839 --> 00:37:08,720
another application

982
00:37:09,440 --> 00:37:10,720
and

983
00:37:10,720 --> 00:37:12,720
this application will be protected by

984
00:37:12,720 --> 00:37:15,520
vav let me open that quickly application

985
00:37:15,520 --> 00:37:17,280
gateway

986
00:37:17,280 --> 00:37:18,160
um

987
00:37:18,160 --> 00:37:21,799
here's the ap address

988
00:37:22,240 --> 00:37:23,440
um

989
00:37:23,440 --> 00:37:27,920
and if i try to run injection

990
00:37:28,880 --> 00:37:31,520
whoa whoa

991
00:37:31,520 --> 00:37:33,599
or one equals one

992
00:37:33,599 --> 00:37:36,160
whoops accident doesn't allow me to do

993
00:37:36,160 --> 00:37:38,720
it if i try some other way other other

994
00:37:38,720 --> 00:37:42,570
things like no bytes um or

995
00:37:42,570 --> 00:37:43,839
[Music]

996
00:37:43,839 --> 00:37:46,079
uh

997
00:37:46,079 --> 00:37:47,920
cross-site scripting whatever so let's

998
00:37:47,920 --> 00:37:50,160
say script

999
00:37:50,160 --> 00:37:53,359
that's not sorry my bad

1000
00:37:53,359 --> 00:37:55,040
script doesn't work either and so on let

1001
00:37:55,040 --> 00:37:57,359
me try i try i can try many things and

1002
00:37:57,359 --> 00:37:59,760
what i did i used waft ninja which is

1003
00:37:59,760 --> 00:38:00,720
fuzzer

1004
00:38:00,720 --> 00:38:02,800
and just check all of that and look at

1005
00:38:02,800 --> 00:38:04,960
this on the right so all

1006
00:38:04,960 --> 00:38:08,560
all all attempts to bypass the firewall

1007
00:38:08,560 --> 00:38:10,160
they are blocked

1008
00:38:10,160 --> 00:38:12,640
all right so let me jump back to slides

1009
00:38:12,640 --> 00:38:13,680
now

1010
00:38:13,680 --> 00:38:16,400
i hope that that demo and that session

1011
00:38:16,400 --> 00:38:18,640
was informative and gave you some ideas

1012
00:38:18,640 --> 00:38:20,400
what you can do to

1013
00:38:20,400 --> 00:38:22,320
uh fix

1014
00:38:22,320 --> 00:38:25,119
uh so to to to protect your your azure

1015
00:38:25,119 --> 00:38:26,720
environment better so first of all if we

1016
00:38:26,720 --> 00:38:28,960
have first scenario here it's very

1017
00:38:28,960 --> 00:38:31,200
important that adconnect must be managed

1018
00:38:31,200 --> 00:38:33,359
by the administrator

1019
00:38:33,359 --> 00:38:36,320
do not allow middle level administrators

1020
00:38:36,320 --> 00:38:39,440
access and admin access to ad connect

1021
00:38:39,440 --> 00:38:40,079
it

1022
00:38:40,079 --> 00:38:42,160
you may have problems with that

1023
00:38:42,160 --> 00:38:44,079
um if we talk if we're talking about

1024
00:38:44,079 --> 00:38:46,720
virtual machines here we need so there's

1025
00:38:46,720 --> 00:38:50,160
no way to stop this execution of those

1026
00:38:50,160 --> 00:38:52,240
commands but you may not allow

1027
00:38:52,240 --> 00:38:54,240
permission we may not give permissions

1028
00:38:54,240 --> 00:38:54,960
to

1029
00:38:54,960 --> 00:38:56,960
uh around those commands so be careful

1030
00:38:56,960 --> 00:38:58,839
permissions that you provide to

1031
00:38:58,839 --> 00:39:00,960
users um

1032
00:39:00,960 --> 00:39:01,900
because

1033
00:39:01,900 --> 00:39:03,200
[Music]

1034
00:39:03,200 --> 00:39:05,359
uh you know

1035
00:39:05,359 --> 00:39:07,440
some people may do something like this

1036
00:39:07,440 --> 00:39:09,599
and the last one the last scenario um

1037
00:39:09,599 --> 00:39:11,520
here i can give you many advices first

1038
00:39:11,520 --> 00:39:12,560
of all

1039
00:39:12,560 --> 00:39:15,920
if you are using a credential rotation

1040
00:39:15,920 --> 00:39:17,440
try to

1041
00:39:17,440 --> 00:39:20,240
keep permissions to this similar to kivo

1042
00:39:20,240 --> 00:39:22,160
because if you don't have if permissions

1043
00:39:22,160 --> 00:39:24,960
are different then someone may use

1044
00:39:24,960 --> 00:39:27,440
this one to access keyboard and then you

1045
00:39:27,440 --> 00:39:28,410
will be able to

1046
00:39:28,410 --> 00:39:30,000
[Music]

1047
00:39:30,000 --> 00:39:32,960
um compromise actual database and of

1048
00:39:32,960 --> 00:39:35,359
course database should should if if

1049
00:39:35,359 --> 00:39:37,680
possible have only private access and

1050
00:39:37,680 --> 00:39:40,160
the application should be protected with

1051
00:39:40,160 --> 00:39:42,880
application firewall as well and also

1052
00:39:42,880 --> 00:39:46,240
the last thing disable ftp so

1053
00:39:46,240 --> 00:39:49,599
who who needs ftp nowadays we use devops

1054
00:39:49,599 --> 00:39:52,079
process continuous deployment process we

1055
00:39:52,079 --> 00:39:54,400
don't use ftp to be fair but let's say

1056
00:39:54,400 --> 00:39:56,560
it's allowed by default disable that

1057
00:39:56,560 --> 00:39:58,720
don't forget to disable that

1058
00:39:58,720 --> 00:40:00,000
all right so

1059
00:40:00,000 --> 00:40:01,760
um and that's that's the last slide

1060
00:40:01,760 --> 00:40:03,599
where i can handle questions so first of

1061
00:40:03,599 --> 00:40:04,640
all thank you very much for your

1062
00:40:04,640 --> 00:40:07,520
participation um i hope that demo was

1063
00:40:07,520 --> 00:40:09,359
informative and

1064
00:40:09,359 --> 00:40:11,760
you spend your time here with me

1065
00:40:11,760 --> 00:40:13,680
and that was nothing vain

1066
00:40:13,680 --> 00:40:16,160
um and now i'm ready i have two few

1067
00:40:16,160 --> 00:40:17,680
minutes to handle your questions maybe

1068
00:40:17,680 --> 00:40:19,520
i'll get some extra time if you have if

1069
00:40:19,520 --> 00:40:21,839
i have many questions

1070
00:40:21,839 --> 00:40:24,400
so thank you sergey that was very

1071
00:40:24,400 --> 00:40:26,000
interesting and i have to say you're a

1072
00:40:26,000 --> 00:40:27,760
brave person

1073
00:40:27,760 --> 00:40:30,319
going and doing a full presentation

1074
00:40:30,319 --> 00:40:32,640
basically on full demo

1075
00:40:32,640 --> 00:40:34,480
that that is brave

1076
00:40:34,480 --> 00:40:36,240
thank you there are no questions on the

1077
00:40:36,240 --> 00:40:38,560
q a but i do have a couple of questions

1078
00:40:38,560 --> 00:40:39,839
um

1079
00:40:39,839 --> 00:40:43,119
one was about the run script um

1080
00:40:43,119 --> 00:40:45,119
if i understand correctly transcript

1081
00:40:45,119 --> 00:40:47,839
cannot be disabled you can only like

1082
00:40:47,839 --> 00:40:50,000
change permissions to allow people to

1083
00:40:50,000 --> 00:40:52,000
run it or not but it cannot be disabled

1084
00:40:52,000 --> 00:40:54,079
together uh yeah that's that's the

1085
00:40:54,079 --> 00:40:57,440
built-in feature uh in azure so the idea

1086
00:40:57,440 --> 00:41:00,560
is uh so the console of the cloud like

1087
00:41:00,560 --> 00:41:03,280
do not log into machines to administer

1088
00:41:03,280 --> 00:41:04,800
them so do it

1089
00:41:04,800 --> 00:41:07,680
uh some somehow differently so do not

1090
00:41:07,680 --> 00:41:09,359
log into each machine though to

1091
00:41:09,359 --> 00:41:11,599
administer but if you need to administer

1092
00:41:11,599 --> 00:41:13,200
uh just

1093
00:41:13,200 --> 00:41:16,079
use the portal or some other ways

1094
00:41:16,079 --> 00:41:18,319
without logging into the machines so

1095
00:41:18,319 --> 00:41:19,839
yeah that's the built-in feature and

1096
00:41:19,839 --> 00:41:22,400
they it can't be disabled so run command

1097
00:41:22,400 --> 00:41:24,000
will be with you the only thing you can

1098
00:41:24,000 --> 00:41:26,160
do is not allow

1099
00:41:26,160 --> 00:41:28,720
other people to run commands but you can

1100
00:41:28,720 --> 00:41:30,240
disable this feature completely from

1101
00:41:30,240 --> 00:41:32,160
from azure so let's

1102
00:41:32,160 --> 00:41:33,440
build it right and

1103
00:41:33,440 --> 00:41:35,200
my other question was about

1104
00:41:35,200 --> 00:41:36,880
configuration of the stuff because like

1105
00:41:36,880 --> 00:41:38,400
as you mentioned like some of this stuff

1106
00:41:38,400 --> 00:41:40,400
is basically misconfigurations i'm sorry

1107
00:41:40,400 --> 00:41:41,839
about my card is mirroring in the

1108
00:41:41,839 --> 00:41:44,160
background uh

1109
00:41:44,160 --> 00:41:46,000
is there any way to control

1110
00:41:46,000 --> 00:41:47,760
configurations globally like for

1111
00:41:47,760 --> 00:41:49,440
instance i don't want to go on every

1112
00:41:49,440 --> 00:41:50,400
single

1113
00:41:50,400 --> 00:41:51,119
uh

1114
00:41:51,119 --> 00:41:53,359
web application and disable ftp i would

1115
00:41:53,359 --> 00:41:55,680
like to have like globally ftp is

1116
00:41:55,680 --> 00:41:58,640
disabled when you create an application

1117
00:41:58,640 --> 00:42:02,240
um so in that case we have what's called

1118
00:42:02,240 --> 00:42:04,800
templates so in the cloud we don't

1119
00:42:04,800 --> 00:42:07,760
deploy uh hopefully we don't uh deploy

1120
00:42:07,760 --> 00:42:09,839
anything manually so we should have a

1121
00:42:09,839 --> 00:42:12,400
proof template uh proof configuration

1122
00:42:12,400 --> 00:42:14,880
that we're using for deployment uh so in

1123
00:42:14,880 --> 00:42:16,640
the cloud we just it's uh that's like

1124
00:42:16,640 --> 00:42:19,280
arm template we use thera form for that

1125
00:42:19,280 --> 00:42:21,839
um so there's a number of

1126
00:42:21,839 --> 00:42:24,240
ways to deploy and so terraform is like

1127
00:42:24,240 --> 00:42:26,319
maybe you may deploy in aws and then

1128
00:42:26,319 --> 00:42:28,880
azure at the same time um so arm

1129
00:42:28,880 --> 00:42:30,560
templates more specifically it's more

1130
00:42:30,560 --> 00:42:33,440
specific to azure uh so yeah use

1131
00:42:33,440 --> 00:42:34,880
templates you you create a proof

1132
00:42:34,880 --> 00:42:37,200
configuration and you can and then you

1133
00:42:37,200 --> 00:42:39,440
deploy from that template and you do not

1134
00:42:39,440 --> 00:42:41,520
deploy it manually and each time do not

1135
00:42:41,520 --> 00:42:44,160
reconfigure it because yeah if you do if

1136
00:42:44,160 --> 00:42:46,319
you have to do it every time

1137
00:42:46,319 --> 00:42:48,079
you will forget that one someday you

1138
00:42:48,079 --> 00:42:50,720
will forget to disable ftp or this or or

1139
00:42:50,720 --> 00:42:53,359
enable some other security features so

1140
00:42:53,359 --> 00:42:55,680
templates approve templates use only

1141
00:42:55,680 --> 00:42:57,599
them for deployment

1142
00:42:57,599 --> 00:42:59,760
cool so um

1143
00:42:59,760 --> 00:43:01,920
that's great and also one kind of a

1144
00:43:01,920 --> 00:43:04,960
follow-up question is i do have more

1145
00:43:04,960 --> 00:43:06,640
experience with aws i don't have a lot

1146
00:43:06,640 --> 00:43:08,960
of experience with azure and in aws

1147
00:43:08,960 --> 00:43:11,040
there is a service called aws config

1148
00:43:11,040 --> 00:43:12,880
which is something that if you are

1149
00:43:12,880 --> 00:43:14,480
familiar with it you

1150
00:43:14,480 --> 00:43:18,079
kind of create rules that will alert you

1151
00:43:18,079 --> 00:43:20,240
or do something when something happens

1152
00:43:20,240 --> 00:43:22,160
right so it could mean like for instance

1153
00:43:22,160 --> 00:43:24,400
you configure the template to not allow

1154
00:43:24,400 --> 00:43:26,880
ftp but someone goes and enable that

1155
00:43:26,880 --> 00:43:28,800
afterwards right so the template is not

1156
00:43:28,800 --> 00:43:31,040
enough maybe you want to also know or

1157
00:43:31,040 --> 00:43:32,720
even execute something automatically

1158
00:43:32,720 --> 00:43:35,359
like disabled ftp as soon as it is

1159
00:43:35,359 --> 00:43:38,640
enabled is that a similar service

1160
00:43:38,640 --> 00:43:42,000
yeah um in in azure it's called policy

1161
00:43:42,000 --> 00:43:45,119
so uh it's not the same as uh uh as a

1162
00:43:45,119 --> 00:43:47,760
config as aws config but it may do

1163
00:43:47,760 --> 00:43:50,160
similar things so uh you may secretly

1164
00:43:50,160 --> 00:43:52,480
like a policy and say so

1165
00:43:52,480 --> 00:43:53,359
uh

1166
00:43:53,359 --> 00:43:56,240
this is so deployment in that

1167
00:43:56,240 --> 00:43:59,040
subscription must be done only with that

1168
00:43:59,040 --> 00:44:01,119
configuration so you can deploy for

1169
00:44:01,119 --> 00:44:04,480
example ubuntu 1604 because it's it's

1170
00:44:04,480 --> 00:44:07,400
absolute so you may only deploy ubuntu

1171
00:44:07,400 --> 00:44:10,880
20.4 because now it's an approved image

1172
00:44:10,880 --> 00:44:13,920
um and so that's called a policy and

1173
00:44:13,920 --> 00:44:17,200
also policy may uh may not only deny

1174
00:44:17,200 --> 00:44:20,079
to do something but also policy may uh

1175
00:44:20,079 --> 00:44:22,160
monitor and say okay so that

1176
00:44:22,160 --> 00:44:24,640
configuration it is not something that

1177
00:44:24,640 --> 00:44:25,359
we

1178
00:44:25,359 --> 00:44:27,520
want to see and it will report about

1179
00:44:27,520 --> 00:44:30,000
this so yeah that's called azure policy

1180
00:44:30,000 --> 00:44:31,040
and so

1181
00:44:31,040 --> 00:44:33,599
if you just open the other portal and

1182
00:44:33,599 --> 00:44:34,839
find

1183
00:44:34,839 --> 00:44:36,400
policy

1184
00:44:36,400 --> 00:44:37,839
policy

1185
00:44:37,839 --> 00:44:39,440
you will find number of built-in

1186
00:44:39,440 --> 00:44:41,760
templates so the definitions

1187
00:44:41,760 --> 00:44:42,720
um

1188
00:44:42,720 --> 00:44:45,920
and uh policy and here's the long list

1189
00:44:45,920 --> 00:44:47,839
of built-in things so for example here's

1190
00:44:47,839 --> 00:44:50,240
my custom policy only allows certain vm

1191
00:44:50,240 --> 00:44:52,720
platform image uh so audit version uh

1192
00:44:52,720 --> 00:44:54,240
here's the other built-in policy that

1193
00:44:54,240 --> 00:44:55,440
all the virtual machines without this is

1194
00:44:55,440 --> 00:44:58,160
recovery configured and so on so yes we

1195
00:44:58,160 --> 00:44:59,280
can do

1196
00:44:59,280 --> 00:45:01,640
something like this in azure as well

1197
00:45:01,640 --> 00:45:03,040
[Music]

1198
00:45:03,040 --> 00:45:04,640
and we can combine by the way policy

1199
00:45:04,640 --> 00:45:06,400
with deployment template in a special

1200
00:45:06,400 --> 00:45:08,640
service called blueprint where we can

1201
00:45:08,640 --> 00:45:12,480
deploy policy and the resources together

1202
00:45:12,480 --> 00:45:14,240
so it deploys a resource and deploy

1203
00:45:14,240 --> 00:45:17,680
policy on top of that of that

1204
00:45:17,680 --> 00:45:20,720
cool thank you very much so those were

1205
00:45:20,720 --> 00:45:23,520
all my questions on the note q a and

1206
00:45:23,520 --> 00:45:25,440
that's all the time we had thank you

1207
00:45:25,440 --> 00:45:28,079
very much for for your talk uh i enjoy

1208
00:45:28,079 --> 00:45:28,960
it

1209
00:45:28,960 --> 00:45:32,400
thank you um stay safe

1210
00:45:32,400 --> 00:45:34,480
and hope to see you next time hopefully

1211
00:45:34,480 --> 00:45:37,200
in barcelona

1212
00:45:37,200 --> 00:45:40,200
bye

