1
00:00:02,580 --> 00:00:08,440
all right so yeah this is a presentation

2
00:00:07,809 --> 00:00:14,460
there we go

3
00:00:08,440 --> 00:00:16,720
so it's it's it's very light so it's so

4
00:00:14,460 --> 00:00:20,500
malware malware is a good thing to do

5
00:00:16,720 --> 00:00:23,288
read all right either way so so what to

6
00:00:20,500 --> 00:00:25,600
expect so today we're gonna do a rough

7
00:00:23,289 --> 00:00:27,310
I've only got about 20 minutes 30

8
00:00:25,600 --> 00:00:28,380
minutes so I will talk quickly and some

9
00:00:27,310 --> 00:00:30,520
of it will be a little bit higher level

10
00:00:28,380 --> 00:00:31,960
but effectively you are here today

11
00:00:30,520 --> 00:00:33,219
making sure you're in the right

12
00:00:31,960 --> 00:00:35,140
presentation the sample 78

13
00:00:33,219 --> 00:00:38,289
deconstruction of the Linux adversarial

14
00:00:35,140 --> 00:00:39,879
toolkit caveat did appears the little

15
00:00:38,289 --> 00:00:41,679
clicker didn't particularly work with my

16
00:00:39,879 --> 00:00:43,780
Mac so I may be backwards and forwards

17
00:00:41,679 --> 00:00:46,719
pressing a spacebar so bear with me all

18
00:00:43,780 --> 00:00:49,120
right so Who am I just some guy that

19
00:00:46,719 --> 00:00:51,399
likes computers some random dude and

20
00:00:49,120 --> 00:00:52,479
just stumbled up on the stage if you

21
00:00:51,399 --> 00:00:53,589
wanted to know a bit more about me I

22
00:00:52,479 --> 00:00:55,839
won't waste your time there's some

23
00:00:53,589 --> 00:00:58,539
information about me in the schedule

24
00:00:55,839 --> 00:01:01,030
pamphlet and you come chat to me later

25
00:00:58,539 --> 00:01:04,210
if you found interesting or tell me off

26
00:01:01,030 --> 00:01:06,160
either way so some things that you

27
00:01:04,209 --> 00:01:08,250
probably should have to get some value

28
00:01:06,160 --> 00:01:09,880
out of this presentation so it's

29
00:01:08,250 --> 00:01:12,520
imperative you actually know what a

30
00:01:09,880 --> 00:01:14,250
computer is aside from that knowing what

31
00:01:12,520 --> 00:01:17,110
Linux is is probably a good step as well

32
00:01:14,250 --> 00:01:18,130
being scared of system calls is probably

33
00:01:17,110 --> 00:01:20,679
not a very good thing for this

34
00:01:18,130 --> 00:01:23,729
presentation being able to read a very

35
00:01:20,680 --> 00:01:26,620
light amount of assembly is welcome

36
00:01:23,730 --> 00:01:27,880
however a lot of the stuff that you will

37
00:01:26,620 --> 00:01:29,710
be reading is in source code so it's not

38
00:01:27,880 --> 00:01:31,960
too bad it's important you know what

39
00:01:29,710 --> 00:01:33,940
implants and controllers are and most

40
00:01:31,960 --> 00:01:35,890
importantly you can get over the fact to

41
00:01:33,940 --> 00:01:37,990
think that it's only Windows that has

42
00:01:35,890 --> 00:01:39,640
malware malicious actors do compromise

43
00:01:37,990 --> 00:01:45,310
other platforms that is definitely a

44
00:01:39,640 --> 00:01:47,200
thing so let's go what to expect inside

45
00:01:45,310 --> 00:01:49,510
this presentation so in the theme of

46
00:01:47,200 --> 00:01:53,380
summer gnats expects a full tear down

47
00:01:49,510 --> 00:01:57,400
and rebuild of a Linux adversarial in

48
00:01:53,380 --> 00:01:59,470
use implant it's not like some implant

49
00:01:57,400 --> 00:02:00,940
that found on the internet from like ten

50
00:01:59,470 --> 00:02:03,220
years ago whatever it was this is an in

51
00:02:00,940 --> 00:02:05,440
use implant expect the analysis the

52
00:02:03,220 --> 00:02:07,240
original binary expect the

53
00:02:05,440 --> 00:02:09,969
re-implementation of the original binary

54
00:02:07,240 --> 00:02:11,980
back to source code and also expect an

55
00:02:09,969 --> 00:02:14,200
implementation of a compatible

56
00:02:11,980 --> 00:02:14,940
replacement controller so the controller

57
00:02:14,200 --> 00:02:19,440
was never available

58
00:02:14,940 --> 00:02:20,790
to me so I thought whatever just rot my

59
00:02:19,440 --> 00:02:22,230
own so just quickly I was gonna get back

60
00:02:20,790 --> 00:02:23,250
here - Who am I so the only thing I'm

61
00:02:22,230 --> 00:02:25,590
gonna tell you right here I need a

62
00:02:23,250 --> 00:02:27,330
caveat here as I am a Queenslander so we

63
00:02:25,590 --> 00:02:28,830
are by up by all means the most

64
00:02:27,330 --> 00:02:32,640
Australian people that live in Australia

65
00:02:28,830 --> 00:02:36,120
so I will try extremely hard to behave

66
00:02:32,640 --> 00:02:38,250
myself but the way I would have said

67
00:02:36,120 --> 00:02:40,440
that last point in Queensland Oh would

68
00:02:38,250 --> 00:02:41,880
have been it I didn't have the

69
00:02:40,440 --> 00:02:43,980
controller so I just write it myself all

70
00:02:41,880 --> 00:02:46,350
right so just please be aware I will try

71
00:02:43,980 --> 00:02:47,850
to behave please know this presentation

72
00:02:46,350 --> 00:02:50,910
if it seems a lot on the details come

73
00:02:47,850 --> 00:02:53,100
see me afterwards a chat it was a lot of

74
00:02:50,910 --> 00:02:55,350
work that I pumped into this before I

75
00:02:53,100 --> 00:02:57,060
got to slides and I had to condense this

76
00:02:55,350 --> 00:02:57,989
thing into under 30 minutes I just

77
00:02:57,060 --> 00:02:59,700
please keep that in mind if you think

78
00:02:57,990 --> 00:03:01,020
its life but I can answer any question

79
00:02:59,700 --> 00:03:05,399
that you have about the thing under the

80
00:03:01,020 --> 00:03:08,130
hood alright so second caveat copyright

81
00:03:05,400 --> 00:03:09,720
information I did not write this implant

82
00:03:08,130 --> 00:03:11,430
the implant the original one is not mine

83
00:03:09,720 --> 00:03:15,090
if there's a person in the audience

84
00:03:11,430 --> 00:03:15,710
thinks that it's your implant I'm cool

85
00:03:15,090 --> 00:03:18,540
with that

86
00:03:15,710 --> 00:03:21,180
would you hand up your lap if you're a

87
00:03:18,540 --> 00:03:22,230
bit weird about that happy to come and

88
00:03:21,180 --> 00:03:24,209
have a chat with me later I do have

89
00:03:22,230 --> 00:03:27,709
questions and if you're not weirded out

90
00:03:24,209 --> 00:03:31,220
I did make some bug fixes so if your

91
00:03:27,709 --> 00:03:35,160
your organization takes commits upstream

92
00:03:31,220 --> 00:03:37,200
more than happy to make some our promise

93
00:03:35,160 --> 00:03:41,190
I won't include any back doors to your

94
00:03:37,200 --> 00:03:42,810
back door promise that's a price all

95
00:03:41,190 --> 00:03:44,940
right so the sample so this particular

96
00:03:42,810 --> 00:03:47,250
sample is one binary within a suite of

97
00:03:44,940 --> 00:03:48,810
tools used by an active actor and when I

98
00:03:47,250 --> 00:03:51,510
say active actor locked in the last six

99
00:03:48,810 --> 00:03:54,000
months it become an analysis candidate

100
00:03:51,510 --> 00:03:56,609
due to the fact that during Bonnie

101
00:03:54,000 --> 00:03:58,410
binary triage it appeared to have some

102
00:03:56,610 --> 00:04:01,680
really novel and interesting features

103
00:03:58,410 --> 00:04:03,420
and siding that I figured your mails

104
00:04:01,680 --> 00:04:05,670
well dig into this thing and see where

105
00:04:03,420 --> 00:04:09,359
this is going to lead it is a 64 bit elf

106
00:04:05,670 --> 00:04:11,760
binary so 64 bit Azzam 64 bit into a

107
00:04:09,360 --> 00:04:14,700
platform assembly and it was built on

108
00:04:11,760 --> 00:04:16,829
target using GCC so that's no indication

109
00:04:14,700 --> 00:04:19,608
at all of how how I knew or how recent

110
00:04:16,829 --> 00:04:22,859
it was it's just the particular bill was

111
00:04:19,608 --> 00:04:24,960
447 which is circa 2012 that's fine

112
00:04:22,860 --> 00:04:26,550
we're looking at about 58 cave of binary

113
00:04:24,960 --> 00:04:29,859
so we're looking at

114
00:04:26,550 --> 00:04:31,180
all right so as far as the analysis

115
00:04:29,860 --> 00:04:32,740
component goes we have two parts there's

116
00:04:31,180 --> 00:04:35,320
presentation there's an Ulster component

117
00:04:32,740 --> 00:04:38,110
and I've got to have a small number of

118
00:04:35,320 --> 00:04:40,000
slides for reconstruction but then we

119
00:04:38,110 --> 00:04:41,020
just go into a demo because if we do the

120
00:04:40,000 --> 00:04:43,360
analysis you don't really need to see me

121
00:04:41,020 --> 00:04:45,760
do it twice so it's so as far as the

122
00:04:43,360 --> 00:04:47,590
analysis goes static only it's only

123
00:04:45,760 --> 00:04:48,909
saying as some of the other day when one

124
00:04:47,590 --> 00:04:50,560
of my mates one of my colleagues we're

125
00:04:48,910 --> 00:04:52,030
having a chat about I hear dynamic

126
00:04:50,560 --> 00:04:53,020
static and I'm like whatever mate I like

127
00:04:52,030 --> 00:04:54,789
to read the book and I like people

128
00:04:53,020 --> 00:04:57,490
reading it to me so I just artic

129
00:04:54,790 --> 00:05:00,430
analysis this will be my last Ida Pro

130
00:04:57,490 --> 00:05:02,140
project from next week unfortunately

131
00:05:00,430 --> 00:05:04,570
I've already installed the JDK under my

132
00:05:02,140 --> 00:05:06,700
machine and from next week I will be

133
00:05:04,570 --> 00:05:09,640
using exclusively Ghidorah so get on

134
00:05:06,700 --> 00:05:11,140
that bandwagon nice and fast so this is

135
00:05:09,640 --> 00:05:12,460
a full reverse-engineer like full

136
00:05:11,140 --> 00:05:13,719
software reverse engineer of a sample

137
00:05:12,460 --> 00:05:16,000
back to complete source which is not my

138
00:05:13,720 --> 00:05:17,020
typical way to perform analysis for

139
00:05:16,000 --> 00:05:19,360
those that in the audience and I'm sure

140
00:05:17,020 --> 00:05:21,969
there's lots that do analysis usually

141
00:05:19,360 --> 00:05:23,440
it's fairly surgical you typically

142
00:05:21,970 --> 00:05:26,740
approach analysis for binary with a

143
00:05:23,440 --> 00:05:28,390
subset of questions and if people

144
00:05:26,740 --> 00:05:29,350
request the analysis of you look if

145
00:05:28,390 --> 00:05:31,419
that's the kind of business that you're

146
00:05:29,350 --> 00:05:34,090
in and you reverse binaries for a living

147
00:05:31,420 --> 00:05:35,890
as part of an organization typically you

148
00:05:34,090 --> 00:05:37,150
get really off when people asked

149
00:05:35,890 --> 00:05:40,030
you just tell me what this thing does

150
00:05:37,150 --> 00:05:41,650
because that is by no means anywhere

151
00:05:40,030 --> 00:05:43,059
near providing some kind of app

152
00:05:41,650 --> 00:05:45,429
specification for you to do in a timely

153
00:05:43,060 --> 00:05:47,310
fashion however in this case that is

154
00:05:45,430 --> 00:05:50,290
exactly what I've done so I've gone from

155
00:05:47,310 --> 00:05:53,230
sample binary sample back to complete

156
00:05:50,290 --> 00:05:54,370
pretty close back to complete source and

157
00:05:53,230 --> 00:05:55,690
I was looking about few capacity hours

158
00:05:54,370 --> 00:05:59,260
of a soft reverse engineering to do that

159
00:05:55,690 --> 00:06:01,570
for a small sample 58 case ample alright

160
00:05:59,260 --> 00:06:02,830
so as far as analysis goes there's two

161
00:06:01,570 --> 00:06:05,200
things when I have a quick talk about so

162
00:06:02,830 --> 00:06:05,859
one we got protections and command and

163
00:06:05,200 --> 00:06:08,830
control because they're the most

164
00:06:05,860 --> 00:06:10,419
interesting things well everyone will

165
00:06:08,830 --> 00:06:12,669
just leave if we have a chat about how

166
00:06:10,419 --> 00:06:15,669
it took me maybe I don't know five six

167
00:06:12,669 --> 00:06:17,500
hours to reverse their custom argument

168
00:06:15,669 --> 00:06:18,460
passing for like argh see and I'd be

169
00:06:17,500 --> 00:06:21,190
that's not very exciting

170
00:06:18,460 --> 00:06:23,979
so protections so this particular sample

171
00:06:21,190 --> 00:06:25,510
had a few novel low sophistication user

172
00:06:23,980 --> 00:06:25,960
mode protections there's binary is user

173
00:06:25,510 --> 00:06:27,490
mode

174
00:06:25,960 --> 00:06:29,739
there's no kernel mode component to it

175
00:06:27,490 --> 00:06:31,360
had some anti static analysis some

176
00:06:29,740 --> 00:06:32,830
heavily obfuscated strings can't thing

177
00:06:31,360 --> 00:06:34,840
you'd expect in a typical sample we're

178
00:06:32,830 --> 00:06:36,789
not going to cover that in the slide or

179
00:06:34,840 --> 00:06:38,409
is presentation it did have some anti

180
00:06:36,789 --> 00:06:39,620
dynamic analysis and it also had some

181
00:06:38,410 --> 00:06:42,080
anti forensics as well

182
00:06:39,620 --> 00:06:45,150
so let's let's hit off on some of those

183
00:06:42,080 --> 00:06:46,889
so I know this might be small for some

184
00:06:45,150 --> 00:06:50,099
people to read but if you can there is

185
00:06:46,889 --> 00:06:52,559
value in there so the particular binary

186
00:06:50,099 --> 00:06:54,719
had a function which is now back into

187
00:06:52,559 --> 00:06:56,849
source code and this particular function

188
00:06:54,719 --> 00:07:00,240
did a few things mostly for anti debug

189
00:06:56,849 --> 00:07:02,069
and it would ensure that your ancestry

190
00:07:00,240 --> 00:07:04,379
so your parent process that is calling

191
00:07:02,069 --> 00:07:06,659
this process is what you expected expect

192
00:07:04,379 --> 00:07:09,930
it to be so at the top there we have

193
00:07:06,659 --> 00:07:11,969
some hard-coded names of expected

194
00:07:09,930 --> 00:07:15,419
processes which include what we got like

195
00:07:11,969 --> 00:07:17,219
start proc que order D system so thing

196
00:07:15,419 --> 00:07:21,919
processes that you consider to be legal

197
00:07:17,219 --> 00:07:24,330
not anti debug or not debuggers and not

198
00:07:21,919 --> 00:07:24,979
processes that may be nasty to you're

199
00:07:24,330 --> 00:07:27,748
nasty

200
00:07:24,979 --> 00:07:29,520
and on top of that as well it does

201
00:07:27,749 --> 00:07:31,289
another nice thing so I saw it from just

202
00:07:29,520 --> 00:07:32,609
checking who your parent process is it

203
00:07:31,289 --> 00:07:34,649
also actually does some debugger

204
00:07:32,610 --> 00:07:36,029
detection as well so and this gets

205
00:07:34,649 --> 00:07:37,680
called in various places inside the

206
00:07:36,029 --> 00:07:38,939
implant just to make sure everything is

207
00:07:37,680 --> 00:07:41,279
shipshape and things have been changed

208
00:07:38,939 --> 00:07:42,389
as is performed execution and there's

209
00:07:41,279 --> 00:07:43,649
two different ways this particular

210
00:07:42,389 --> 00:07:45,689
function will operate so it'll either

211
00:07:43,649 --> 00:07:46,949
give you a soft exit so it'll just

212
00:07:45,689 --> 00:07:48,589
return with a return code then you can

213
00:07:46,949 --> 00:07:51,149
decide the calling function what to do

214
00:07:48,589 --> 00:07:52,499
once it's returns if it says it's found

215
00:07:51,149 --> 00:07:54,810
something it's not supposed to be there

216
00:07:52,499 --> 00:07:57,959
or alternatively it's got a strict mode

217
00:07:54,810 --> 00:07:59,849
where you can exit hard and you just

218
00:07:57,959 --> 00:08:02,099
quit out of the environment and again

219
00:07:59,849 --> 00:08:03,719
this is not just again to reinforce this

220
00:08:02,099 --> 00:08:05,219
is what was implemented I just went

221
00:08:03,719 --> 00:08:06,839
backwards so it's none of these heat

222
00:08:05,219 --> 00:08:08,759
things in here my mod mark modifications

223
00:08:06,839 --> 00:08:09,839
so one of the interesting two in here

224
00:08:08,759 --> 00:08:11,699
though towards the top you've got a

225
00:08:09,839 --> 00:08:14,129
function called P trace me or I call PP

226
00:08:11,699 --> 00:08:16,319
trays me and for those people that have

227
00:08:14,129 --> 00:08:17,909
done some debugging in Linux or they've

228
00:08:16,319 --> 00:08:19,139
hit any debugger stuff in Linux before

229
00:08:17,909 --> 00:08:21,599
you might be filled in with familiar

230
00:08:19,139 --> 00:08:24,419
with a system called called P trace so P

231
00:08:21,599 --> 00:08:27,419
trace is what all your typical debuggers

232
00:08:24,419 --> 00:08:29,549
use so gdb s trace et cetera et cetera

233
00:08:27,419 --> 00:08:31,529
P trace system call it allows you to be

234
00:08:29,550 --> 00:08:34,589
able to debug a process and give control

235
00:08:31,529 --> 00:08:37,260
of the process to another process or

236
00:08:34,589 --> 00:08:40,529
alternatively a tracer can request

237
00:08:37,260 --> 00:08:42,510
access to another process interesting

238
00:08:40,529 --> 00:08:44,819
things about P trace is that only one

239
00:08:42,510 --> 00:08:46,860
process is permitted to it be attached

240
00:08:44,819 --> 00:08:48,750
one process submitted attachment at a

241
00:08:46,860 --> 00:08:51,329
time so you can't have multiple

242
00:08:48,750 --> 00:08:52,840
processes actually attaching to your

243
00:08:51,329 --> 00:08:54,609
process to debugger at a time

244
00:08:52,840 --> 00:08:56,410
that significant another significant

245
00:08:54,610 --> 00:08:58,390
factor as well in particular function

246
00:08:56,410 --> 00:09:00,100
that was called inside this implant is

247
00:08:58,390 --> 00:09:01,330
that it call something called P trace me

248
00:09:00,100 --> 00:09:02,710
so there's a whole lot of different ways

249
00:09:01,330 --> 00:09:04,360
you can call P trace with a whole lot of

250
00:09:02,710 --> 00:09:06,160
different requests this is one and this

251
00:09:04,360 --> 00:09:08,080
is the only particular one that a trace

252
00:09:06,160 --> 00:09:09,969
you can call as opposed to a tracer and

253
00:09:08,080 --> 00:09:11,590
if that doesn't work

254
00:09:09,970 --> 00:09:13,480
say for example someone's already

255
00:09:11,590 --> 00:09:15,720
holding your process it'll return an

256
00:09:13,480 --> 00:09:17,830
error code of negative one didn't work

257
00:09:15,720 --> 00:09:20,830
this is this is what it looked like in

258
00:09:17,830 --> 00:09:21,670
the binary so if you can see here if

259
00:09:20,830 --> 00:09:22,840
you're not familiar the symbol that's

260
00:09:21,670 --> 00:09:24,939
totally farm and you'll see it called a

261
00:09:22,840 --> 00:09:28,510
P trace you'll see the number one being

262
00:09:24,940 --> 00:09:31,150
loaded into EDX which is saying call me

263
00:09:28,510 --> 00:09:32,350
with the P trace me option and if the

264
00:09:31,150 --> 00:09:35,829
thing doesn't work you'll see on the

265
00:09:32,350 --> 00:09:39,040
right hand side if it's less than what's

266
00:09:35,830 --> 00:09:41,770
expected it'll call it'll call exit with

267
00:09:39,040 --> 00:09:44,349
a one so what that you're seeing there

268
00:09:41,770 --> 00:09:46,210
is that if it tries to say yes please

269
00:09:44,350 --> 00:09:48,160
trace me whatever it is and it's already

270
00:09:46,210 --> 00:09:50,230
being traced it will itself and

271
00:09:48,160 --> 00:09:52,360
quit out so a TD button

272
00:09:50,230 --> 00:09:54,670
novel small but does the job call the

273
00:09:52,360 --> 00:09:55,660
multiple place in the binary so this

274
00:09:54,670 --> 00:09:57,010
particular binary also had an

275
00:09:55,660 --> 00:09:59,890
implementation for anti forensics as

276
00:09:57,010 --> 00:10:00,910
well so incident responders and forensic

277
00:09:59,890 --> 00:10:02,890
caterers in the audience would be very

278
00:10:00,910 --> 00:10:05,469
familiar with the concept of you know

279
00:10:02,890 --> 00:10:08,080
disc analysis or metadata analysis and

280
00:10:05,470 --> 00:10:10,630
chronological order of artifacts and you

281
00:10:08,080 --> 00:10:12,520
know timestamp metadata time metadata

282
00:10:10,630 --> 00:10:15,100
creation/modification times inside file

283
00:10:12,520 --> 00:10:16,480
systems this one here all this implant

284
00:10:15,100 --> 00:10:18,670
also had a very novel way to actually

285
00:10:16,480 --> 00:10:20,050
deal with that as well and employers

286
00:10:18,670 --> 00:10:22,360
anti forensic technique which we call

287
00:10:20,050 --> 00:10:23,680
time stomping and what it does here so

288
00:10:22,360 --> 00:10:26,080
this particular function which again is

289
00:10:23,680 --> 00:10:28,239
called in a few different places what it

290
00:10:26,080 --> 00:10:31,930
does is you give it you give the

291
00:10:28,240 --> 00:10:33,100
function your destination file that you

292
00:10:31,930 --> 00:10:34,270
want to stomp that you want to change

293
00:10:33,100 --> 00:10:36,010
this file time because you want to move

294
00:10:34,270 --> 00:10:37,540
it within your timeline your

295
00:10:36,010 --> 00:10:40,150
chronological order to sort of throw

296
00:10:37,540 --> 00:10:41,920
apart the investigative ability of a

297
00:10:40,150 --> 00:10:43,090
friend's account list so you give it a

298
00:10:41,920 --> 00:10:45,459
destination but you can also give it a

299
00:10:43,090 --> 00:10:47,440
source as well so it will copy its time

300
00:10:45,460 --> 00:10:49,420
and then update its own modification

301
00:10:47,440 --> 00:10:51,300
time and its own access time to

302
00:10:49,420 --> 00:10:53,349
effectively blend into the environment

303
00:10:51,300 --> 00:10:55,060
so that's exactly what this does here

304
00:10:53,350 --> 00:10:56,440
using function calls within the Linux

305
00:10:55,060 --> 00:10:58,599
called stack so you can call stat on a

306
00:10:56,440 --> 00:11:00,220
file in Linux it will give you its

307
00:10:58,600 --> 00:11:03,340
honored information and inside that

308
00:11:00,220 --> 00:11:04,930
inode information it will have meted

309
00:11:03,340 --> 00:11:06,460
time metadata information in there

310
00:11:04,930 --> 00:11:08,500
so it copies that and then it

311
00:11:06,460 --> 00:11:10,330
users you time or update time to then

312
00:11:08,500 --> 00:11:12,520
write it back to the nasty to the nasty

313
00:11:10,330 --> 00:11:14,260
that you're trying to hide there is

314
00:11:12,520 --> 00:11:16,030
flaws in this

315
00:11:14,260 --> 00:11:19,390
I don't half the original developer of

316
00:11:16,030 --> 00:11:21,010
cared or knew whatever but the thing is

317
00:11:19,390 --> 00:11:23,199
with using you time it only actually

318
00:11:21,010 --> 00:11:26,290
updates access time modification time

319
00:11:23,200 --> 00:11:28,840
so there is a anti forensic floor in

320
00:11:26,290 --> 00:11:32,469
there your creation time will remain as

321
00:11:28,840 --> 00:11:33,910
it was nice to know all right so let's

322
00:11:32,470 --> 00:11:35,680
move on to command control I've no idea

323
00:11:33,910 --> 00:11:36,850
how I'm gonna put on them either all

324
00:11:35,680 --> 00:11:39,130
right let's move on to command control

325
00:11:36,850 --> 00:11:40,870
so this particular sample so what made

326
00:11:39,130 --> 00:11:42,910
this sample interesting sorry from those

327
00:11:40,870 --> 00:11:45,250
few novel techniques for for protections

328
00:11:42,910 --> 00:11:48,969
was the way it went about its command

329
00:11:45,250 --> 00:11:50,740
and control it used a novel method that

330
00:11:48,970 --> 00:11:52,750
you know when you read these things

331
00:11:50,740 --> 00:11:53,920
you're like ah like what am I think

332
00:11:52,750 --> 00:11:55,570
of that lot I should have done that you

333
00:11:53,920 --> 00:11:57,880
know mainly it's what the person that

334
00:11:55,570 --> 00:11:58,540
invented the potato peeler is like that

335
00:11:57,880 --> 00:12:00,160
was a good idea

336
00:11:58,540 --> 00:12:05,260
people like to peel stuff you know mean

337
00:12:00,160 --> 00:12:06,880
works so I said use a novel method which

338
00:12:05,260 --> 00:12:10,000
is what's highlighted a sample for me to

339
00:12:06,880 --> 00:12:12,640
tell you about it today and aside from

340
00:12:10,000 --> 00:12:14,260
its the way that it talked to the sample

341
00:12:12,640 --> 00:12:16,600
so way there you know the unknown

342
00:12:14,260 --> 00:12:19,170
controller that we never have a copy of

343
00:12:16,600 --> 00:12:20,830
talk to the sample which is cool

344
00:12:19,170 --> 00:12:22,990
implementation of the actual implant

345
00:12:20,830 --> 00:12:24,940
itself was functionality that you would

346
00:12:22,990 --> 00:12:25,960
expect from a typical backdoor rat so

347
00:12:24,940 --> 00:12:29,080
that's the kind of stuff that's inside

348
00:12:25,960 --> 00:12:30,220
the sample all right so it's now we're

349
00:12:29,080 --> 00:12:32,200
going to see that solders talk through

350
00:12:30,220 --> 00:12:35,080
it so effectively what this sample has

351
00:12:32,200 --> 00:12:37,510
doing at a very very high level to be

352
00:12:35,080 --> 00:12:39,400
able to talk three up for the controller

353
00:12:37,510 --> 00:12:40,480
to be able to talk to it typically in a

354
00:12:39,400 --> 00:12:41,740
network environment you've got oh you

355
00:12:40,480 --> 00:12:43,120
know if you've done some soccer

356
00:12:41,740 --> 00:12:44,860
programming in the past II but listen

357
00:12:43,120 --> 00:12:47,260
for a socket you know you've got a your

358
00:12:44,860 --> 00:12:48,790
to bind to a port and carry on and

359
00:12:47,260 --> 00:12:50,380
around whatever they say in this

360
00:12:48,790 --> 00:12:52,000
particular case here in this particular

361
00:12:50,380 --> 00:12:53,170
case you and that and that's not very

362
00:12:52,000 --> 00:12:54,610
good because like if you're on linux and

363
00:12:53,170 --> 00:12:57,459
you see like you know like a net stat

364
00:12:54,610 --> 00:12:58,990
like what tln it's like are there's some

365
00:12:57,460 --> 00:13:00,100
we something weird listening on there

366
00:12:58,990 --> 00:13:02,200
and look at the process and I found the

367
00:13:00,100 --> 00:13:03,430
badness so that's as far as OPSEC that's

368
00:13:02,200 --> 00:13:05,920
not that's not a really amazing thing to

369
00:13:03,430 --> 00:13:06,910
do so I'm sure I'm Jimmy there's a few

370
00:13:05,920 --> 00:13:08,620
people in the audience that have like

371
00:13:06,910 --> 00:13:12,490
used like Wireshark and stuff before

372
00:13:08,620 --> 00:13:14,020
I'm sure me that's not a and I'm unknown

373
00:13:12,490 --> 00:13:15,510
concept to some people and be able to

374
00:13:14,020 --> 00:13:18,400
like you know look at a packet capture

375
00:13:15,510 --> 00:13:20,180
for some people that I've used Y shark

376
00:13:18,400 --> 00:13:21,829
I'm sure you've also used it too

377
00:13:20,180 --> 00:13:22,819
actually perform packet capture as well

378
00:13:21,830 --> 00:13:24,410
so I'm not just like look at someone

379
00:13:22,820 --> 00:13:27,920
else's pickup actually take your own

380
00:13:24,410 --> 00:13:30,140
pickup so why shark and it's command

381
00:13:27,920 --> 00:13:33,050
line brother TCP dump actually use a

382
00:13:30,140 --> 00:13:34,430
library call we pick up and this implant

383
00:13:33,050 --> 00:13:37,030
also does that as well

384
00:13:34,430 --> 00:13:41,060
so what this particular implant does is

385
00:13:37,030 --> 00:13:43,780
instead of doing soccer programming it

386
00:13:41,060 --> 00:13:47,209
decides to do lead pcap programming and

387
00:13:43,780 --> 00:13:49,100
it writes a filter so well first it

388
00:13:47,210 --> 00:13:52,160
listens on the any device so the any

389
00:13:49,100 --> 00:13:53,720
device is using lead pcap it allows you

390
00:13:52,160 --> 00:13:55,850
to listen on it on any of the devices

391
00:13:53,720 --> 00:13:58,100
that are actually present or resident on

392
00:13:55,850 --> 00:14:00,620
the machine that does have a few caveats

393
00:13:58,100 --> 00:14:01,970
because with the any device so if I was

394
00:14:00,620 --> 00:14:02,840
to write this implant I would not use

395
00:14:01,970 --> 00:14:05,270
that and because I reckon that's a

396
00:14:02,840 --> 00:14:06,560
really bad way to do it so if there are

397
00:14:05,270 --> 00:14:08,180
some cabinets for the any of any devices

398
00:14:06,560 --> 00:14:10,910
that you can't put into promiscuous mode

399
00:14:08,180 --> 00:14:12,530
so the IP packets have to be destined

400
00:14:10,910 --> 00:14:13,850
for your machine and if I was trying to

401
00:14:12,530 --> 00:14:16,130
do something clever I would just like

402
00:14:13,850 --> 00:14:17,540
not do that at all and just listen

403
00:14:16,130 --> 00:14:19,460
actually look at what the common device

404
00:14:17,540 --> 00:14:21,349
is that I want to use and I would just

405
00:14:19,460 --> 00:14:24,080
listen on that device turn the thing

406
00:14:21,350 --> 00:14:25,610
into promiscuous mode and then I could

407
00:14:24,080 --> 00:14:27,170
fire packets to anywhere inside the

408
00:14:25,610 --> 00:14:28,100
segment and I could just task on that

409
00:14:27,170 --> 00:14:29,599
so there's fire if you're if you're

410
00:14:28,100 --> 00:14:31,940
doing packet capture on some kind of

411
00:14:29,600 --> 00:14:33,890
like IDs and I'm not a network guy so if

412
00:14:31,940 --> 00:14:35,330
you know me you'd know how much I love

413
00:14:33,890 --> 00:14:38,030
ragging on people that do network stuff

414
00:14:35,330 --> 00:14:41,090
so it's so if you're if you're like you

415
00:14:38,030 --> 00:14:44,540
know I got this new beaut ids/ips packet

416
00:14:41,090 --> 00:14:45,710
capture layer to whatever ain't got to

417
00:14:44,540 --> 00:14:48,020
do nothing for you because you're going

418
00:14:45,710 --> 00:14:49,670
to see telemetry going to or tasking

419
00:14:48,020 --> 00:14:51,590
going to some random device in the

420
00:14:49,670 --> 00:14:53,060
network and meanwhile your implants

421
00:14:51,590 --> 00:14:54,350
sitting another host and there's just

422
00:14:53,060 --> 00:14:55,790
sniffing stuff and promiscuous modes

423
00:14:54,350 --> 00:14:58,820
that's why all I've done it I would have

424
00:14:55,790 --> 00:15:01,730
done a lot this spilling so what it does

425
00:14:58,820 --> 00:15:05,030
listen to the any device packets that

426
00:15:01,730 --> 00:15:07,420
are destined for it it then filters

427
00:15:05,030 --> 00:15:09,829
those ones outs or only wants TCP and

428
00:15:07,420 --> 00:15:12,290
even though it's only wants TCP it takes

429
00:15:09,830 --> 00:15:14,120
any packets on any port so any packets

430
00:15:12,290 --> 00:15:17,949
that come in is TCP Don the entire port

431
00:15:14,120 --> 00:15:20,600
range and what it does then it's

432
00:15:17,950 --> 00:15:22,850
processes those packets so when you do

433
00:15:20,600 --> 00:15:25,250
lib pickup programming you eventually go

434
00:15:22,850 --> 00:15:26,630
into this pcap loop and then you give it

435
00:15:25,250 --> 00:15:28,730
a callback function and you're able to

436
00:15:26,630 --> 00:15:30,680
process the pcaps as they come in to do

437
00:15:28,730 --> 00:15:32,850
whatever you read them you know

438
00:15:30,680 --> 00:15:34,890
transform them do whatever you want

439
00:15:32,850 --> 00:15:37,290
it's very roughly how very basic like

440
00:15:34,890 --> 00:15:38,730
IPS or IDs works and that's what this

441
00:15:37,290 --> 00:15:40,910
does so reads the packets coming in on

442
00:15:38,730 --> 00:15:43,710
the network completely skips the hold

443
00:15:40,910 --> 00:15:46,410
TCP completely skip the whole soccer

444
00:15:43,710 --> 00:15:48,060
program paradigm so that's that's great

445
00:15:46,410 --> 00:15:49,980
so what is what is this callback do so

446
00:15:48,060 --> 00:15:52,140
what this callback does it actually goes

447
00:15:49,980 --> 00:15:53,970
and parses so again this is this is not

448
00:15:52,140 --> 00:15:57,030
leap big cap code this is code from the

449
00:15:53,970 --> 00:15:58,740
implant but the code goes and goes and

450
00:15:57,030 --> 00:16:01,500
passes the data structures and make sure

451
00:15:58,740 --> 00:16:02,850
that the IPS version for it goes through

452
00:16:01,500 --> 00:16:04,800
and you know checks some lengths and

453
00:16:02,850 --> 00:16:06,240
whatever some other garbage so but then

454
00:16:04,800 --> 00:16:10,260
interestingly it goes on to check that

455
00:16:06,240 --> 00:16:12,870
certain flags of your packets are set

456
00:16:10,260 --> 00:16:14,970
for tasking to fire and then if those

457
00:16:12,870 --> 00:16:16,980
particular flags are set it will then go

458
00:16:14,970 --> 00:16:18,870
and read the TCP payload it will process

459
00:16:16,980 --> 00:16:20,700
that and then after that's process then

460
00:16:18,870 --> 00:16:22,950
it will schoo and do your execution so

461
00:16:20,700 --> 00:16:24,450
that's the way that works so you'll see

462
00:16:22,950 --> 00:16:26,490
in the demo so I won't keep waffling on

463
00:16:24,450 --> 00:16:28,050
so in a nutshell so listens to roared

464
00:16:26,490 --> 00:16:30,960
traffic on any device filters that

465
00:16:28,050 --> 00:16:32,640
traffic checks the presence of the the

466
00:16:30,960 --> 00:16:35,790
acknowledge and the push Internet

467
00:16:32,640 --> 00:16:37,319
Protocol flags if it passes that it then

468
00:16:35,790 --> 00:16:39,569
it decodes and decrypt the TCP payload

469
00:16:37,320 --> 00:16:42,690
and then a processes and then executes

470
00:16:39,570 --> 00:16:43,920
that payload all right so control so

471
00:16:42,690 --> 00:16:47,400
what kind of tasks we'll be looking at

472
00:16:43,920 --> 00:16:49,020
so interestingly the first thing it does

473
00:16:47,400 --> 00:16:50,340
so this is inside the decrypted payload

474
00:16:49,020 --> 00:16:52,100
so once we're inside the decrypted pilot

475
00:16:50,340 --> 00:16:55,170
the first thing it does is it checks a

476
00:16:52,100 --> 00:16:57,080
password that's interesting silent

477
00:16:55,170 --> 00:16:59,400
inside the inside the payload itself

478
00:16:57,080 --> 00:17:02,220
which I would deem to be actually be a

479
00:16:59,400 --> 00:17:04,530
campaign code hard-coded in written for

480
00:17:02,220 --> 00:17:06,180
the food for the individual victim and

481
00:17:04,530 --> 00:17:08,579
then it goes on to check to see if it's

482
00:17:06,180 --> 00:17:10,860
one of seven different tasks so we have

483
00:17:08,579 --> 00:17:13,589
you know about this password and a semi

484
00:17:10,859 --> 00:17:15,449
colon a colon and then we have the the

485
00:17:13,589 --> 00:17:17,639
task string and another colon and then

486
00:17:15,450 --> 00:17:20,400
if the particular task requires

487
00:17:17,640 --> 00:17:22,280
arguments to it and IP address a string

488
00:17:20,400 --> 00:17:25,560
whatever it is that all comes after and

489
00:17:22,280 --> 00:17:27,389
then after it's been processed we hand

490
00:17:25,560 --> 00:17:29,159
it to the execution function and the

491
00:17:27,390 --> 00:17:31,410
execution function is what does the

492
00:17:29,160 --> 00:17:32,910
business so and what this does here

493
00:17:31,410 --> 00:17:35,430
doesn't do it inside its processes Forks

494
00:17:32,910 --> 00:17:39,090
off a process does the execution the

495
00:17:35,430 --> 00:17:40,950
parent waits does it stuff so in the

496
00:17:39,090 --> 00:17:42,300
original sample a few interesting things

497
00:17:40,950 --> 00:17:44,010
now like above like just the boiler

498
00:17:42,300 --> 00:17:45,610
itself but the original sample had four

499
00:17:44,010 --> 00:17:48,250
tasks sorry

500
00:17:45,610 --> 00:17:51,129
seven tasks but only four of those tasks

501
00:17:48,250 --> 00:17:53,290
had a couple me implementations so even

502
00:17:51,130 --> 00:17:56,470
though the binary the network protocol

503
00:17:53,290 --> 00:17:57,790
is geared to at least take seven that we

504
00:17:56,470 --> 00:18:00,299
know of commands

505
00:17:57,790 --> 00:18:03,190
it's only been implemented for four I

506
00:18:00,299 --> 00:18:04,809
only had three in mine because two of

507
00:18:03,190 --> 00:18:06,940
them were very very close some 40 or

508
00:18:04,809 --> 00:18:08,678
whatever keep going so so of the three

509
00:18:06,940 --> 00:18:10,270
tasks that were in there that override

510
00:18:08,679 --> 00:18:12,610
implemented so we've got cabe it to

511
00:18:10,270 --> 00:18:16,150
which you give like an IP address and a

512
00:18:12,610 --> 00:18:17,918
port which is a number password so we

513
00:18:16,150 --> 00:18:19,390
have a password protected which is again

514
00:18:17,919 --> 00:18:21,580
that passwords hard-coded just into the

515
00:18:19,390 --> 00:18:23,740
into the implant a reverse shell and

516
00:18:21,580 --> 00:18:24,970
this has no terminal support which is

517
00:18:23,740 --> 00:18:26,650
very very different to something that

518
00:18:24,970 --> 00:18:28,660
you'd expect to use like you know SSH

519
00:18:26,650 --> 00:18:30,820
that has you know for you know PT wire

520
00:18:28,660 --> 00:18:32,320
support which is effectively what KB did

521
00:18:30,820 --> 00:18:34,540
so it's why sort of mush them into two

522
00:18:32,320 --> 00:18:36,428
for the sake of timeliness it has

523
00:18:34,540 --> 00:18:38,440
another another command string command

524
00:18:36,429 --> 00:18:40,080
called tack bow where you can give it a

525
00:18:38,440 --> 00:18:42,520
string it is executing arbitrary command

526
00:18:40,080 --> 00:18:43,720
but you don't get anything back it's

527
00:18:42,520 --> 00:18:45,129
just a single shot so you don't get

528
00:18:43,720 --> 00:18:46,480
anything back coming back to you so

529
00:18:45,130 --> 00:18:48,340
nothing from standard standard error or

530
00:18:46,480 --> 00:18:50,169
standard out and also has a lead command

531
00:18:48,340 --> 00:18:52,389
a IPT which actually disables the

532
00:18:50,169 --> 00:18:54,429
firewall so if you look back here you

533
00:18:52,390 --> 00:18:56,710
can sort of see up there you can see

534
00:18:54,429 --> 00:18:59,020
like the task number six effectively all

535
00:18:56,710 --> 00:19:02,320
is doing is just firing down like an

536
00:18:59,020 --> 00:19:03,340
Diane iptables configuration command for

537
00:19:02,320 --> 00:19:05,590
you to accept everything it's pretty

538
00:19:03,340 --> 00:19:08,470
cool alright it's a reconstruction so

539
00:19:05,590 --> 00:19:11,049
the original sample I have reimplemented

540
00:19:08,470 --> 00:19:14,620
in ANSI c99 it's pretty much 80%

541
00:19:11,049 --> 00:19:15,730
complete I will finish the rest the

542
00:19:14,620 --> 00:19:17,229
proof asam's a proof of concept

543
00:19:15,730 --> 00:19:20,410
controller was written in Python because

544
00:19:17,230 --> 00:19:22,360
that is like way faster and my objective

545
00:19:20,410 --> 00:19:24,160
was to ensure that my implant and my

546
00:19:22,360 --> 00:19:26,549
controller were interoperable with the

547
00:19:24,160 --> 00:19:29,140
original sample which I can test and

548
00:19:26,549 --> 00:19:31,240
hopefully the unknown controller that

549
00:19:29,140 --> 00:19:33,070
may be used for one day all right so

550
00:19:31,240 --> 00:19:34,360
some considerations though so descent

551
00:19:33,070 --> 00:19:35,470
ask him to the control and we sort of

552
00:19:34,360 --> 00:19:36,159
already talked about this before with

553
00:19:35,470 --> 00:19:38,440
you know like

554
00:19:36,160 --> 00:19:39,900
socket programming descendent asking to

555
00:19:38,440 --> 00:19:42,610
the controller you need to transmit

556
00:19:39,900 --> 00:19:45,490
be encapsulated traffic so the

557
00:19:42,610 --> 00:19:49,030
encapsulated tasking inside a valid TCP

558
00:19:45,490 --> 00:19:50,230
network paté like encapsulated in TCP

559
00:19:49,030 --> 00:19:52,510
protocol

560
00:19:50,230 --> 00:19:54,730
typically this requires to connect them

561
00:19:52,510 --> 00:19:56,710
to a listening port on the machine so in

562
00:19:54,730 --> 00:19:58,450
this way here so you know as we just

563
00:19:56,710 --> 00:19:58,870
said before we know the way the implant

564
00:19:58,450 --> 00:20:01,059
listens

565
00:19:58,870 --> 00:20:02,979
tasking it hasn't bonded to a socket

566
00:20:01,059 --> 00:20:05,500
it's not listening so how do you connect

567
00:20:02,980 --> 00:20:06,880
to this thing so typically the way you

568
00:20:05,500 --> 00:20:08,590
would go about this is you may say

569
00:20:06,880 --> 00:20:10,210
connect to like a an existing port you

570
00:20:08,590 --> 00:20:11,620
might do like a like a some kind of a

571
00:20:10,210 --> 00:20:13,240
scan the environment see what ports are

572
00:20:11,620 --> 00:20:16,570
open and you might connect to say like

573
00:20:13,240 --> 00:20:18,850
SSH whatever 80 HTTP whatever it may be

574
00:20:16,570 --> 00:20:20,409
and then even though you're at the

575
00:20:18,850 --> 00:20:21,879
application layer it has no idea what's

576
00:20:20,410 --> 00:20:23,650
going on you just fire the stuff anyway

577
00:20:21,880 --> 00:20:26,200
and that's enough you've passed enough

578
00:20:23,650 --> 00:20:28,210
gates at this point for your implant to

579
00:20:26,200 --> 00:20:29,590
know that it's that the traffic is for

580
00:20:28,210 --> 00:20:31,059
it so even though you're seeing stuff

581
00:20:29,590 --> 00:20:32,649
coming on 80 it's actually going to

582
00:20:31,059 --> 00:20:35,230
something that's that's not listening on

583
00:20:32,650 --> 00:20:37,480
anything at all they're on I thought

584
00:20:35,230 --> 00:20:39,730
that was a bit so my controller

585
00:20:37,480 --> 00:20:42,490
actually implements its own one-sided

586
00:20:39,730 --> 00:20:44,380
skeleton tcp/ip stack and so what I can

587
00:20:42,490 --> 00:20:46,300
do so just the transmit side so what I

588
00:20:44,380 --> 00:20:48,400
can do I can descend raw packets to it I

589
00:20:46,300 --> 00:20:49,659
can skip the triple handshake and I

590
00:20:48,400 --> 00:20:51,550
don't need to bind to a port at all I

591
00:20:49,660 --> 00:20:54,550
can just send whatever I want whatever I

592
00:20:51,550 --> 00:20:56,800
want it doesn't matter all right let's

593
00:20:54,550 --> 00:20:58,840
do demo yesterday what if this gonna

594
00:20:56,800 --> 00:21:02,200
work so I had done live demos in the

595
00:20:58,840 --> 00:21:07,659
past that was a bad idea so I've got a

596
00:21:02,200 --> 00:21:12,309
movie all right okay so what I've got

597
00:21:07,660 --> 00:21:14,440
here so I've got two VMs do everything

598
00:21:12,309 --> 00:21:15,910
in console I've got an attacker and a

599
00:21:14,440 --> 00:21:17,590
victim just want to say how awesome

600
00:21:15,910 --> 00:21:21,040
vagrant is so if you're not a Hoshi Corp

601
00:21:17,590 --> 00:21:22,480
user become one it's fantastic so so we

602
00:21:21,040 --> 00:21:23,440
have attacker on top and a victim and

603
00:21:22,480 --> 00:21:26,679
I'll talk you through as we go along

604
00:21:23,440 --> 00:21:28,179
here we go all right so just to

605
00:21:26,679 --> 00:21:31,030
demonstrate me this is just to

606
00:21:28,179 --> 00:21:33,760
demonstrate some stuff say yep saying

607
00:21:31,030 --> 00:21:37,830
Who am I one of our ID

608
00:21:33,760 --> 00:21:40,330
yep the victim the attacker whatever

609
00:21:37,830 --> 00:21:41,710
it's interesting to what's important to

610
00:21:40,330 --> 00:21:43,210
prove to you that we're actually on two

611
00:21:41,710 --> 00:21:44,920
different hosts within the network so

612
00:21:43,210 --> 00:21:47,530
there we go there's the first one you

613
00:21:44,920 --> 00:21:49,000
see dot one three six it's fine sitting

614
00:21:47,530 --> 00:21:52,120
on the same subnet and the victim should

615
00:21:49,000 --> 00:21:53,470
be close by probably next one over one

616
00:21:52,120 --> 00:21:56,919
three five that's fine

617
00:21:53,470 --> 00:21:58,360
it's totally okay to like go and break

618
00:21:56,920 --> 00:22:02,020
into your neighbor's house it's exactly

619
00:21:58,360 --> 00:22:03,520
what gonna do here we go so netstat so

620
00:22:02,020 --> 00:22:05,550
just to show you as we go through you

621
00:22:03,520 --> 00:22:07,510
know what's listening what's going on so

622
00:22:05,550 --> 00:22:08,530
the only reason I got a tea is cuz I

623
00:22:07,510 --> 00:22:09,160
install the package just before this

624
00:22:08,530 --> 00:22:11,950
that's awkward

625
00:22:09,160 --> 00:22:12,640
so it's netstat so it's all we've got

626
00:22:11,950 --> 00:22:16,020
there is 20

627
00:22:12,640 --> 00:22:22,900
SSH saying for the victim SSH

628
00:22:16,020 --> 00:22:24,960
what's next it's like watching movies

629
00:22:22,900 --> 00:22:27,520
awesome

630
00:22:24,960 --> 00:22:31,240
my son thought this is so wicked I tried

631
00:22:27,520 --> 00:22:33,220
on him we thought it's fantastic alright

632
00:22:31,240 --> 00:22:34,900
so just to prove to you I wrote this

633
00:22:33,220 --> 00:22:40,960
thing so I got an implant let's see

634
00:22:34,900 --> 00:22:42,250
that's compiled are we going I'm sure

635
00:22:40,960 --> 00:22:44,680
lots pill that right see that it's like

636
00:22:42,250 --> 00:22:48,250
what option comes neck on GCC is takes

637
00:22:44,680 --> 00:22:53,200
so long I mean here we go implants uses

638
00:22:48,250 --> 00:22:54,760
lip pick up implants threaded there we

639
00:22:53,200 --> 00:23:00,190
go so never happen implant that's right

640
00:22:54,760 --> 00:23:01,930
see what that does it runs but your

641
00:23:00,190 --> 00:23:03,490
runners route so in the implementation

642
00:23:01,930 --> 00:23:05,170
it actually checks to make sure it is

643
00:23:03,490 --> 00:23:06,430
route which is very important for a few

644
00:23:05,170 --> 00:23:07,540
of the features inside the implant one

645
00:23:06,430 --> 00:23:09,730
of them being is that you can't perform

646
00:23:07,540 --> 00:23:12,460
packet capture you can't connect to the

647
00:23:09,730 --> 00:23:14,020
to the raw PF socket unless your route

648
00:23:12,460 --> 00:23:15,880
it's very important so has to be route

649
00:23:14,020 --> 00:23:18,070
it's not an issue it's not a mess this

650
00:23:15,880 --> 00:23:19,900
is not the implant was not about proved

651
00:23:18,070 --> 00:23:21,100
esque it wasn't about persistence you

652
00:23:19,900 --> 00:23:23,560
can do that in other ways that's totally

653
00:23:21,100 --> 00:23:24,879
fine it's a backdoor so you assume at

654
00:23:23,560 --> 00:23:27,310
this point that it's not a big deal

655
00:23:24,880 --> 00:23:29,290
that's fun alright so we've run it

656
00:23:27,310 --> 00:23:31,030
nothing is listening as we expect it's

657
00:23:29,290 --> 00:23:33,970
listening listening for packets on out

658
00:23:31,030 --> 00:23:39,190
of out of P capture packet capture it's

659
00:23:33,970 --> 00:23:41,290
a controller in the game so

660
00:23:39,190 --> 00:23:42,850
intentionally put in a typo just so you

661
00:23:41,290 --> 00:23:46,389
know that this is not like machine

662
00:23:42,850 --> 00:23:47,860
learning AI whatever your sense all

663
00:23:46,390 --> 00:23:49,330
right so here we go so my controller so

664
00:23:47,860 --> 00:23:52,510
I've got all the all the particular

665
00:23:49,330 --> 00:23:54,280
commands as I said the implement there

666
00:23:52,510 --> 00:23:57,129
the implementation in the implant

667
00:23:54,280 --> 00:23:57,730
doesn't support all the commands so I'll

668
00:23:57,130 --> 00:24:02,200
put that in as well

669
00:23:57,730 --> 00:24:05,200
that's fine let's do some stuff let's do

670
00:24:02,200 --> 00:24:07,510
some stuff here we go so the first one I

671
00:24:05,200 --> 00:24:10,270
said so execute arbitrary commands so

672
00:24:07,510 --> 00:24:12,190
tak bow that's important so we do an LS

673
00:24:10,270 --> 00:24:13,240
and in our home directory we just got

674
00:24:12,190 --> 00:24:16,200
the implant we don't have anything else

675
00:24:13,240 --> 00:24:16,200
okay

676
00:24:18,940 --> 00:24:24,530
didn't want to retype your buttons push

677
00:24:20,960 --> 00:24:28,490
up so let's do that and let's give it a

678
00:24:24,530 --> 00:24:31,059
string and let's just slide oh no I'm

679
00:24:28,490 --> 00:24:35,480
always touched when people create files

680
00:24:31,059 --> 00:24:36,530
it's very moving so let's just touch

681
00:24:35,480 --> 00:24:40,250
your file on the other person's file

682
00:24:36,530 --> 00:24:42,410
system that's fine and this is very

683
00:24:40,250 --> 00:24:48,890
forensically friendly telling people at

684
00:24:42,410 --> 00:24:52,429
their owned it's fine okay I'm using a

685
00:24:48,890 --> 00:24:54,200
follow text interesting say it's nothing

686
00:24:52,429 --> 00:24:56,120
is listening but it's there there we go

687
00:24:54,200 --> 00:24:59,030
just appears that's pretty cool that's

688
00:24:56,120 --> 00:25:00,530
pretty cool times there we go

689
00:24:59,030 --> 00:25:05,750
so we know our implants working that's

690
00:25:00,530 --> 00:25:08,139
pretty sweet still nothing that's pretty

691
00:25:05,750 --> 00:25:12,020
cool it's not nothing

692
00:25:08,140 --> 00:25:15,080
all right so something next so if you've

693
00:25:12,020 --> 00:25:17,240
got say for example your admin is like

694
00:25:15,080 --> 00:25:18,678
doing string searches like has a really

695
00:25:17,240 --> 00:25:20,630
cool cron job where like every 20

696
00:25:18,679 --> 00:25:21,500
seconds he looks for text files that

697
00:25:20,630 --> 00:25:23,000
contain pwned

698
00:25:21,500 --> 00:25:26,030
alright that seems like a fairly

699
00:25:23,000 --> 00:25:27,890
reasonable way to do detection so on top

700
00:25:26,030 --> 00:25:29,570
of that so say for example you continue

701
00:25:27,890 --> 00:25:31,490
on and if you do that then you just go

702
00:25:29,570 --> 00:25:33,080
oh well I didn't see any internet

703
00:25:31,490 --> 00:25:35,570
connection so you must be hitting

704
00:25:33,080 --> 00:25:37,100
me over ICMP whatever yeah I mean so

705
00:25:35,570 --> 00:25:40,000
it's I don't know why but that's just

706
00:25:37,100 --> 00:25:42,230
must be so let's just block all outgoing

707
00:25:40,000 --> 00:25:43,520
ICMP let's just do that for no

708
00:25:42,230 --> 00:25:47,150
particular reason it seems like a really

709
00:25:43,520 --> 00:25:50,960
fun thing to do there we go all right

710
00:25:47,150 --> 00:25:53,660
that's fine that works we can list it

711
00:25:50,960 --> 00:25:58,780
there we go that's done droppable ICMP

712
00:25:53,660 --> 00:25:58,780
packets and we'll just ping the machine

713
00:26:02,810 --> 00:26:11,990
there we go as expected as expected all

714
00:26:09,170 --> 00:26:14,150
right so luckily our implant in our

715
00:26:11,990 --> 00:26:16,600
control I had the ability to annihilate

716
00:26:14,150 --> 00:26:18,560
someone's firewall so let's do that

717
00:26:16,600 --> 00:26:23,230
doesn't need any options this time it's

718
00:26:18,560 --> 00:26:27,370
the command done there we go out we go

719
00:26:23,230 --> 00:26:30,140
sucking sucked in mate sucked in all

720
00:26:27,370 --> 00:26:31,340
right so we've got our last commands so

721
00:26:30,140 --> 00:26:33,080
we've got through I got three out of the

722
00:26:31,340 --> 00:26:35,330
four three and four were pretty much the

723
00:26:33,080 --> 00:26:38,510
same as I said the full implementation

724
00:26:35,330 --> 00:26:40,010
of the last one is any differences

725
00:26:38,510 --> 00:26:42,740
between well you know how much extra

726
00:26:40,010 --> 00:26:44,420
effort was in there to dev for full

727
00:26:42,740 --> 00:26:46,040
terminal support so you get all the

728
00:26:44,420 --> 00:26:48,380
extra nice bits and pieces you get with

729
00:26:46,040 --> 00:26:49,490
you know like line endings and colors

730
00:26:48,380 --> 00:26:50,600
and all that kind of stuff so it was

731
00:26:49,490 --> 00:26:52,310
pretty much the same those session

732
00:26:50,600 --> 00:26:54,199
leaders and you know all the right

733
00:26:52,310 --> 00:26:56,060
stuffs but for the sake of this

734
00:26:54,200 --> 00:26:58,040
demonstration this one is fine so we

735
00:26:56,060 --> 00:26:59,300
still had nothing listening as long as

736
00:26:58,040 --> 00:27:01,430
great we'd like scribble these file will

737
00:26:59,300 --> 00:27:02,810
give me a farm but now less is less like

738
00:27:01,430 --> 00:27:06,860
let's take a shell on this machine let's

739
00:27:02,810 --> 00:27:12,409
do that so our final commands for the

740
00:27:06,860 --> 00:27:12,979
controller and kabat - mr. check there

741
00:27:12,410 --> 00:27:16,810
it is

742
00:27:12,980 --> 00:27:16,810
give it to you give it an IP and a port

743
00:27:20,080 --> 00:27:23,659
and I know this some people it's like I

744
00:27:22,610 --> 00:27:25,399
we're Christians written another shell

745
00:27:23,660 --> 00:27:28,030
why what it is use netcat but it's

746
00:27:25,400 --> 00:27:30,470
a and i do actually in a second but the

747
00:27:28,030 --> 00:27:32,480
it's important to know that this is

748
00:27:30,470 --> 00:27:34,040
we've gotten to the point now we've read

749
00:27:32,480 --> 00:27:35,540
an implant and we've actually been able

750
00:27:34,040 --> 00:27:37,430
to make a replacement controller for it

751
00:27:35,540 --> 00:27:39,590
so this is talking to like the real

752
00:27:37,430 --> 00:27:42,830
stuff there we go ask for a password

753
00:27:39,590 --> 00:27:44,419
there we go all right now we've got a

754
00:27:42,830 --> 00:27:46,520
connection now we got a connection

755
00:27:44,420 --> 00:27:50,960
I'm port one one three seven one three

756
00:27:46,520 --> 00:27:53,110
three seven there it is all right so

757
00:27:50,960 --> 00:27:55,610
once a password we give it a password

758
00:27:53,110 --> 00:27:57,139
again password is this isn't the

759
00:27:55,610 --> 00:27:58,250
original password passed where they came

760
00:27:57,140 --> 00:28:00,740
from the implant I didn't make it up

761
00:27:58,250 --> 00:28:02,420
magic syrup that's what came out of the

762
00:28:00,740 --> 00:28:04,070
implant Holly obvious skated obviously

763
00:28:02,420 --> 00:28:04,460
but that's what it was now we have a

764
00:28:04,070 --> 00:28:05,870
shell

765
00:28:04,460 --> 00:28:06,980
what do you first thing you're doing you

766
00:28:05,870 --> 00:28:09,830
have a show here where my there we go

767
00:28:06,980 --> 00:28:13,650
root there we go we're inside the other

768
00:28:09,830 --> 00:28:15,779
box blade main do some LSE's

769
00:28:13,650 --> 00:28:17,700
like LS route I've no idea what I did

770
00:28:15,779 --> 00:28:19,200
that for but I wasn't going to recall my

771
00:28:17,700 --> 00:28:20,159
presentation at this point I was too far

772
00:28:19,200 --> 00:28:27,090
in was in too deep

773
00:28:20,159 --> 00:28:28,919
oh whatever it's fine it's cool yeah

774
00:28:27,090 --> 00:28:30,240
this is the one I was supposed to do and

775
00:28:28,919 --> 00:28:32,850
there it is there's our file there's our

776
00:28:30,240 --> 00:28:36,330
implant and if you still don't believe

777
00:28:32,850 --> 00:28:37,740
me if you still don't believe me I was

778
00:28:36,330 --> 00:28:38,820
like oh I'm gonna wigs it but like maybe

779
00:28:37,740 --> 00:28:42,830
the audience doesn't believe me there we

780
00:28:38,820 --> 00:28:46,710
go so it's IP show the IP address and

781
00:28:42,830 --> 00:28:48,449
come on top faster and we're inside that

782
00:28:46,710 --> 00:28:51,630
neighbor we're inside 135 there we go

783
00:28:48,450 --> 00:28:54,559
owned owned owns using someone's own

784
00:28:51,630 --> 00:28:59,549
implant the best way to do it all right

785
00:28:54,559 --> 00:29:03,350
so then we got the time the end already

786
00:28:59,549 --> 00:29:09,120
we are you demo all right c3 right

787
00:29:03,350 --> 00:29:10,799
questions however I don't take questions

788
00:29:09,120 --> 00:29:12,209
because like one like people ought to

789
00:29:10,799 --> 00:29:13,289
ask me questions where there don't

790
00:29:12,210 --> 00:29:14,940
really want to know the answer that's

791
00:29:13,289 --> 00:29:15,360
want to tell me the answer so I'm not

792
00:29:14,940 --> 00:29:18,179
gonna do that

793
00:29:15,360 --> 00:29:20,010
that's a waste of my time and the one

794
00:29:18,179 --> 00:29:21,630
question that everyone always wants to

795
00:29:20,010 --> 00:29:22,860
ask at this point it's like I sweet so

796
00:29:21,630 --> 00:29:24,779
you found this implant Christian was

797
00:29:22,860 --> 00:29:26,340
really interesting don't really give a

798
00:29:24,779 --> 00:29:27,419
 about the talk about cigs and like

799
00:29:26,340 --> 00:29:29,490
oh you know this found some really

800
00:29:27,419 --> 00:29:31,320
really cool like compiler up them into

801
00:29:29,490 --> 00:29:32,850
optimizations let's have a chat about

802
00:29:31,320 --> 00:29:34,168
that and how many less cycles it takes

803
00:29:32,850 --> 00:29:35,668
people right now I'm gonna about

804
00:29:34,169 --> 00:29:37,140
that I want to know where the binary

805
00:29:35,669 --> 00:29:38,490
came from I don't know about attribution

806
00:29:37,140 --> 00:29:42,210
that's what I want to know about so as

807
00:29:38,490 --> 00:29:43,409
we saw the password so this is very no I

808
00:29:42,210 --> 00:29:45,539
don't do attribution for a living so

809
00:29:43,409 --> 00:29:48,059
this is just observations that I've made

810
00:29:45,539 --> 00:29:49,770
along my travels and I will let you to

811
00:29:48,059 --> 00:29:52,590
decide for yourself alright okay

812
00:29:49,770 --> 00:29:54,570
the password was magic Sarah that's a

813
00:29:52,590 --> 00:29:56,189
thing so Google is an awesome way to do

814
00:29:54,570 --> 00:29:57,539
attribution you just push it into Google

815
00:29:56,190 --> 00:30:01,260
and attribution comes out alright

816
00:29:57,539 --> 00:30:03,120
so magic syrup is a thing made by magic

817
00:30:01,260 --> 00:30:04,350
so the reverse shield password is a

818
00:30:03,120 --> 00:30:06,510
popular seasoning made in the

819
00:30:04,350 --> 00:30:08,820
Philippines it's big interesting and the

820
00:30:06,510 --> 00:30:12,179
tasking strings were all likely derived

821
00:30:08,820 --> 00:30:14,760
from Cebuano which is a very popular

822
00:30:12,179 --> 00:30:16,380
language spoken in the Philippines Cabot

823
00:30:14,760 --> 00:30:18,090
is actually trained roughly translated

824
00:30:16,380 --> 00:30:20,880
to the word attached so that's our shell

825
00:30:18,090 --> 00:30:23,730
attached to the machine tech bars run as

826
00:30:20,880 --> 00:30:24,990
an exercise but yeah run commands so and

827
00:30:23,730 --> 00:30:26,399
there was also another set of strings

828
00:30:24,990 --> 00:30:27,120
and saw this binary which I'm not going

829
00:30:26,399 --> 00:30:28,979
to share today but

830
00:30:27,120 --> 00:30:33,929
that were overtly declaring the actor

831
00:30:28,980 --> 00:30:35,600
was Philippine politically motivated but

832
00:30:33,930 --> 00:30:37,800
all right Philippines have a

833
00:30:35,600 --> 00:30:38,929
sophisticated see any program probably

834
00:30:37,800 --> 00:30:43,379
not

835
00:30:38,930 --> 00:30:47,460
Cyclops misinformation probably probably

836
00:30:43,380 --> 00:30:50,100
all right so in my spare time did I have

837
00:30:47,460 --> 00:30:53,300
much off I like to read blogs watch

838
00:30:50,100 --> 00:30:55,500
presentations at home I work from home

839
00:30:53,300 --> 00:30:56,730
and I particular like I work in a cyber

840
00:30:55,500 --> 00:30:59,790
shared which is a converted cardboard

841
00:30:56,730 --> 00:31:01,220
and not a particular like go in a lot of

842
00:30:59,790 --> 00:31:03,180
places so I watched most of my

843
00:31:01,220 --> 00:31:04,950
presentations stuff in the cyber shed

844
00:31:03,180 --> 00:31:09,090
you can always find me this option all

845
00:31:04,950 --> 00:31:10,290
right so it's so as a result don't go to

846
00:31:09,090 --> 00:31:12,600
really go to many conferences anymore

847
00:31:10,290 --> 00:31:17,070
used to but over that so you know I

848
00:31:12,600 --> 00:31:19,290
watch people's press so in December fire

849
00:31:17,070 --> 00:31:20,879
I had this lava defense summit and they

850
00:31:19,290 --> 00:31:22,139
got really excited people get really

851
00:31:20,880 --> 00:31:23,820
excited when they talk about actors you

852
00:31:22,140 --> 00:31:27,060
don't see very often platinum in this

853
00:31:23,820 --> 00:31:28,919
case they got up on stage and you know

854
00:31:27,060 --> 00:31:30,570
carry on about year we found platinum

855
00:31:28,920 --> 00:31:32,850
and we've done some attribution whatever

856
00:31:30,570 --> 00:31:34,350
you know Microsoft report about it's

857
00:31:32,850 --> 00:31:38,129
been a while like no one ever sees

858
00:31:34,350 --> 00:31:39,360
platinum alright and true to their work

859
00:31:38,130 --> 00:31:42,360
so I've given you guys a little bit more

860
00:31:39,360 --> 00:31:44,790
than most people give you but true to

861
00:31:42,360 --> 00:31:47,189
most info stack presentations they give

862
00:31:44,790 --> 00:31:48,389
you sweet FA like you're hunting I think

863
00:31:47,190 --> 00:31:50,690
I've seen this presentation made about

864
00:31:48,390 --> 00:31:53,520
forty times now trying to derive

865
00:31:50,690 --> 00:31:55,920
intelligence from the slides or from

866
00:31:53,520 --> 00:31:57,629
what they say trying to write Yara cigs

867
00:31:55,920 --> 00:31:58,770
or whatever whatever I can get out of

868
00:31:57,630 --> 00:32:01,200
this thing I've tried to well and truly

869
00:31:58,770 --> 00:32:02,760
squeeze blood from this stone we have

870
00:32:01,200 --> 00:32:03,840
the slide here so it's particular sample

871
00:32:02,760 --> 00:32:05,070
that they've found so this is a window

872
00:32:03,840 --> 00:32:06,090
sample it's not an example particularly

873
00:32:05,070 --> 00:32:11,220
sample that they've seen that they've

874
00:32:06,090 --> 00:32:13,020
happily attributed to platinum and they

875
00:32:11,220 --> 00:32:14,130
talked about this password thing so it's

876
00:32:13,020 --> 00:32:15,270
not on the slide but when the guy is

877
00:32:14,130 --> 00:32:16,860
actually talking he actually says

878
00:32:15,270 --> 00:32:18,510
campaign password I'm like I'll it's a

879
00:32:16,860 --> 00:32:21,330
bit interesting that's a bit interesting

880
00:32:18,510 --> 00:32:22,770
alright and if you look here as far as

881
00:32:21,330 --> 00:32:24,240
the format goes this is actually inside

882
00:32:22,770 --> 00:32:26,129
again like when they talk about this is

883
00:32:24,240 --> 00:32:28,050
actually inside their payload so this is

884
00:32:26,130 --> 00:32:29,160
inside their malicious actor payload

885
00:32:28,050 --> 00:32:31,139
their implants whatever so it's

886
00:32:29,160 --> 00:32:32,970
encrypted and you've got this password

887
00:32:31,140 --> 00:32:34,500
and a colon and more stuff that that I

888
00:32:32,970 --> 00:32:37,560
tell you about just you know try and

889
00:32:34,500 --> 00:32:39,570
lead you on inside there slide and if

890
00:32:37,560 --> 00:32:41,010
you remember when we went back to what

891
00:32:39,570 --> 00:32:42,899
my process text looks like

892
00:32:41,010 --> 00:32:45,000
we have something that I call a campaign

893
00:32:42,900 --> 00:32:49,080
code and it's format is pretty much

894
00:32:45,000 --> 00:32:50,940
identical to that one so yeah it's a

895
00:32:49,080 --> 00:32:52,168
light lead I got a little bit more

896
00:32:50,940 --> 00:32:53,570
reversing to do at some of the Crypt to

897
00:32:52,169 --> 00:32:56,610
finish that's usually a good indication

898
00:32:53,570 --> 00:32:58,379
but I don't know no one's ever said that

899
00:32:56,610 --> 00:33:02,699
they've spotted a platinum Linux sample

900
00:32:58,380 --> 00:33:05,480
that's pretty sweet but stay tuned there

901
00:33:02,700 --> 00:33:05,480
we go any real questions

902
00:33:10,980 --> 00:33:13,040
you

