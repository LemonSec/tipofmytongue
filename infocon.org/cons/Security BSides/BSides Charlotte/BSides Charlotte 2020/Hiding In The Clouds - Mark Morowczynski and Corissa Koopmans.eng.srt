1
00:00:04,319 --> 00:00:05,279
all right

2
00:00:05,279 --> 00:00:07,120
uh welcome to hiding in the clouds how

3
00:00:07,120 --> 00:00:08,639
attackers can use applications for

4
00:00:08,639 --> 00:00:10,880
sustained persistence and how to find it

5
00:00:10,880 --> 00:00:12,639
i'm mark and i'm here with carissa and

6
00:00:12,639 --> 00:00:14,160
we are program managers in the identity

7
00:00:14,160 --> 00:00:15,759
division at microsoft

8
00:00:15,759 --> 00:00:19,039
so we work on active directory our adfs

9
00:00:19,039 --> 00:00:21,359
as well as azure active directory and we

10
00:00:21,359 --> 00:00:23,039
work on a team that helps customers

11
00:00:23,039 --> 00:00:23,920
deploy

12
00:00:23,920 --> 00:00:25,199
azure active directory and we take those

13
00:00:25,199 --> 00:00:26,640
learnings and feedbacks from those

14
00:00:26,640 --> 00:00:27,439
deployments

15
00:00:27,439 --> 00:00:29,679
we work it back into the product to make

16
00:00:29,679 --> 00:00:32,880
it easier and better for everybody else

17
00:00:32,880 --> 00:00:34,559
so for this talk um of course you know

18
00:00:34,559 --> 00:00:36,239
the next slide is um

19
00:00:36,239 --> 00:00:37,360
i'm talking about this thing called

20
00:00:37,360 --> 00:00:39,520
application consent and application

21
00:00:39,520 --> 00:00:40,719
permissions and things like that which

22
00:00:40,719 --> 00:00:42,239
some people may not be aware of so first

23
00:00:42,239 --> 00:00:44,079
we want to make sure you understand what

24
00:00:44,079 --> 00:00:45,760
do we mean by application consent and

25
00:00:45,760 --> 00:00:47,200
really why you should care about this if

26
00:00:47,200 --> 00:00:48,320
you haven't started looking

27
00:00:48,320 --> 00:00:50,239
at this already then we're going to talk

28
00:00:50,239 --> 00:00:51,680
about some key permissions you should be

29
00:00:51,680 --> 00:00:53,039
looking for in your environment as well

30
00:00:53,039 --> 00:00:54,800
as how to go investigate

31
00:00:54,800 --> 00:00:56,559
these consent grants in your environment

32
00:00:56,559 --> 00:00:58,239
and then lastly we're going to cover

33
00:00:58,239 --> 00:00:59,680
some best practices you can do to

34
00:00:59,680 --> 00:01:01,199
protect yourself from these application

35
00:01:01,199 --> 00:01:04,399
consent type of attacks

36
00:01:04,959 --> 00:01:06,960
so if you haven't started looking at

37
00:01:06,960 --> 00:01:09,280
your applications and your data access

38
00:01:09,280 --> 00:01:11,600
you really need to so on average there's

39
00:01:11,600 --> 00:01:13,280
about 140 apps

40
00:01:13,280 --> 00:01:15,360
in an organization but this number can

41
00:01:15,360 --> 00:01:16,720
can vary greatly

42
00:01:16,720 --> 00:01:17,840
depending on the size of your

43
00:01:17,840 --> 00:01:19,280
organization chris and i work with some

44
00:01:19,280 --> 00:01:21,280
very large and complex customers

45
00:01:21,280 --> 00:01:23,119
and they have thousands and thousands of

46
00:01:23,119 --> 00:01:24,799
applications so 140

47
00:01:24,799 --> 00:01:26,159
is kind of an average number but it

48
00:01:26,159 --> 00:01:27,520
really you'll know your environment

49
00:01:27,520 --> 00:01:29,439
better than anybody else this could be

50
00:01:29,439 --> 00:01:31,520
less than this or much much larger than

51
00:01:31,520 --> 00:01:33,439
this and 87

52
00:01:33,439 --> 00:01:35,600
of users can consent to applications

53
00:01:35,600 --> 00:01:37,600
today and the act of consenting to an

54
00:01:37,600 --> 00:01:38,640
application

55
00:01:38,640 --> 00:01:41,360
isn't bad in itself but as

56
00:01:41,360 --> 00:01:43,439
administrators here and defenders here

57
00:01:43,439 --> 00:01:45,520
at b-side charlotte we want to make sure

58
00:01:45,520 --> 00:01:47,439
that we understand

59
00:01:47,439 --> 00:01:50,079
what we're allowing people to do and

60
00:01:50,079 --> 00:01:51,680
that we're okay with it from an

61
00:01:51,680 --> 00:01:53,280
administrative side of the house because

62
00:01:53,280 --> 00:01:54,960
we want people to be able to do

63
00:01:54,960 --> 00:01:56,719
what they need to do to do their job but

64
00:01:56,719 --> 00:01:57,600
we also want to make sure we're not

65
00:01:57,600 --> 00:01:59,200
putting the organization at risk so the

66
00:01:59,200 --> 00:02:00,479
act of consent

67
00:02:00,479 --> 00:02:02,240
is not bad itself and we're going to get

68
00:02:02,240 --> 00:02:03,840
into some of this but we want to make

69
00:02:03,840 --> 00:02:05,119
sure we're doing it in a way that we're

70
00:02:05,119 --> 00:02:06,320
okay with

71
00:02:06,320 --> 00:02:09,520
and then also 80 of employees are using

72
00:02:09,520 --> 00:02:11,120
non-approved work apps this is the

73
00:02:11,120 --> 00:02:12,640
shadow it type of stuff that's been

74
00:02:12,640 --> 00:02:13,920
around for a little bit

75
00:02:13,920 --> 00:02:15,680
again this doesn't mean it's malicious

76
00:02:15,680 --> 00:02:17,040
maybe for example

77
00:02:17,040 --> 00:02:19,360
that the cloud storage provider that we

78
00:02:19,360 --> 00:02:20,239
want our

79
00:02:20,239 --> 00:02:22,480
business to use is is either one drive

80
00:02:22,480 --> 00:02:23,520
or dropbox

81
00:02:23,520 --> 00:02:24,959
and then this other business unit is

82
00:02:24,959 --> 00:02:26,879
using is using box and

83
00:02:26,879 --> 00:02:27,920
they're not doing it because they're bad

84
00:02:27,920 --> 00:02:28,800
they're just using it because that's

85
00:02:28,800 --> 00:02:30,160
what they prefer to use or they didn't

86
00:02:30,160 --> 00:02:31,760
know they should be using something else

87
00:02:31,760 --> 00:02:34,160
so we want to make sure that we have um

88
00:02:34,160 --> 00:02:35,440
some guardrails around this type of

89
00:02:35,440 --> 00:02:36,959
stuff and we're letting people use those

90
00:02:36,959 --> 00:02:38,000
approved apps for

91
00:02:38,000 --> 00:02:41,120
work so from an application

92
00:02:41,120 --> 00:02:44,000
consent perspective um if you haven't

93
00:02:44,000 --> 00:02:46,160
heard of it or looked into an azure id

94
00:02:46,160 --> 00:02:47,760
that's okay we're gonna cover a bunch of

95
00:02:47,760 --> 00:02:49,760
that here today but you probably have

96
00:02:49,760 --> 00:02:50,080
seen

97
00:02:50,080 --> 00:02:52,319
this in your day-to-day life as on your

98
00:02:52,319 --> 00:02:54,160
cell phone so let's say you install some

99
00:02:54,160 --> 00:02:55,360
new application

100
00:02:55,360 --> 00:02:57,920
and that application lets you put some

101
00:02:57,920 --> 00:02:59,599
funny faces and things like that

102
00:02:59,599 --> 00:03:01,599
on pictures so it's gonna ask for your

103
00:03:01,599 --> 00:03:02,800
access to your camera

104
00:03:02,800 --> 00:03:04,319
it's going to ask for access to your

105
00:03:04,319 --> 00:03:05,840
photos and it's also going to ask for

106
00:03:05,840 --> 00:03:07,680
access to your contacts because it wants

107
00:03:07,680 --> 00:03:09,120
to be able to send those photos

108
00:03:09,120 --> 00:03:10,879
that you just made directly from the app

109
00:03:10,879 --> 00:03:12,239
to your friends and family

110
00:03:12,239 --> 00:03:14,239
and you as the owner of that phone can

111
00:03:14,239 --> 00:03:15,440
make a choice to say

112
00:03:15,440 --> 00:03:17,120
i'm okay with it having access to this

113
00:03:17,120 --> 00:03:19,040
or i'm not the application

114
00:03:19,040 --> 00:03:21,120
azure d permissions model works in a

115
00:03:21,120 --> 00:03:23,040
very very similar way so there's going

116
00:03:23,040 --> 00:03:24,959
to be applications that need access to

117
00:03:24,959 --> 00:03:26,480
organizational data

118
00:03:26,480 --> 00:03:28,319
that organizational data is going to be

119
00:03:28,319 --> 00:03:30,720
accessed through these resource apis and

120
00:03:30,720 --> 00:03:32,159
in our case here in azure idea it's

121
00:03:32,159 --> 00:03:33,040
going to usually be going through

122
00:03:33,040 --> 00:03:34,560
microsoft graph

123
00:03:34,560 --> 00:03:36,480
and that permission that are going to be

124
00:03:36,480 --> 00:03:37,840
granted are going to come through this

125
00:03:37,840 --> 00:03:39,920
thing called an application consent

126
00:03:39,920 --> 00:03:42,000
and end users can consent to some of

127
00:03:42,000 --> 00:03:43,920
these things or an admin can consent to

128
00:03:43,920 --> 00:03:45,120
and we'll kind of cover the differences

129
00:03:45,120 --> 00:03:48,560
of that here in a little bit

130
00:03:48,560 --> 00:03:51,200
so to kind of align that previous slide

131
00:03:51,200 --> 00:03:51,599
to

132
00:03:51,599 --> 00:03:53,760
some of the openid connect protocols

133
00:03:53,760 --> 00:03:55,439
like more of an enterprise

134
00:03:55,439 --> 00:03:58,080
type of spec we have a few different

135
00:03:58,080 --> 00:03:59,920
pieces we have that client application

136
00:03:59,920 --> 00:04:01,439
which can be a mobile app

137
00:04:01,439 --> 00:04:03,200
it can be a web app or it can be a

138
00:04:03,200 --> 00:04:04,720
something that runs in the background

139
00:04:04,720 --> 00:04:05,519
and this is what's going to be

140
00:04:05,519 --> 00:04:07,840
requesting access to data on behalf of

141
00:04:07,840 --> 00:04:08,720
that user

142
00:04:08,720 --> 00:04:10,400
then we have that resource application

143
00:04:10,400 --> 00:04:12,640
which is usually a web api in our case

144
00:04:12,640 --> 00:04:14,080
like i said microsoft graph

145
00:04:14,080 --> 00:04:15,840
that's going to expose this data or

146
00:04:15,840 --> 00:04:18,320
functionality to that client application

147
00:04:18,320 --> 00:04:19,600
and then we have those permissions this

148
00:04:19,600 --> 00:04:21,519
is what that client application is going

149
00:04:21,519 --> 00:04:22,000
to be

150
00:04:22,000 --> 00:04:24,320
performing on that data that's owned by

151
00:04:24,320 --> 00:04:26,000
some sort of resource application this

152
00:04:26,000 --> 00:04:27,759
picture that you see right here

153
00:04:27,759 --> 00:04:29,919
is that application consent dialog box

154
00:04:29,919 --> 00:04:31,520
so here we can see that this application

155
00:04:31,520 --> 00:04:33,360
is a contoso test app

156
00:04:33,360 --> 00:04:34,880
it's trying to read user and share

157
00:04:34,880 --> 00:04:36,880
contacts share calendars and sign in to

158
00:04:36,880 --> 00:04:38,400
read that user profile and as an end

159
00:04:38,400 --> 00:04:39,040
user

160
00:04:39,040 --> 00:04:41,520
you can click accept i can consent to

161
00:04:41,520 --> 00:04:42,560
this application

162
00:04:42,560 --> 00:04:44,160
or as an admin you can do some other

163
00:04:44,160 --> 00:04:46,160
things as well but uh chris is going to

164
00:04:46,160 --> 00:04:47,440
show you a demo of that here in a little

165
00:04:47,440 --> 00:04:49,360
bit but this is the application consent

166
00:04:49,360 --> 00:04:50,960
dialog box if you haven't seen it if you

167
00:04:50,960 --> 00:04:52,400
haven't seen it that's okay chris is

168
00:04:52,400 --> 00:04:53,520
going to show you a demo of it here in a

169
00:04:53,520 --> 00:04:55,600
little bit

170
00:04:55,600 --> 00:04:59,680
so in terms of consent uh terminology

171
00:04:59,680 --> 00:05:01,759
that consent prompt that dialog box that

172
00:05:01,759 --> 00:05:03,759
we just showed you is that consent

173
00:05:03,759 --> 00:05:05,199
uh prompt and it's asking for those

174
00:05:05,199 --> 00:05:07,120
types of permissions for the user to

175
00:05:07,120 --> 00:05:08,479
consent to that and the act of saying

176
00:05:08,479 --> 00:05:09,199
yes

177
00:05:09,199 --> 00:05:11,759
is a consent grant now here's where we

178
00:05:11,759 --> 00:05:13,199
go a little bit different from that

179
00:05:13,199 --> 00:05:15,039
phone example here is with a concept of

180
00:05:15,039 --> 00:05:16,639
called admin consent or administrative

181
00:05:16,639 --> 00:05:17,600
consent

182
00:05:17,600 --> 00:05:19,039
which is where an applica an

183
00:05:19,039 --> 00:05:20,720
administrator is going to consent to

184
00:05:20,720 --> 00:05:21,919
that application

185
00:05:21,919 --> 00:05:24,320
there's a few reasons why you would need

186
00:05:24,320 --> 00:05:25,440
to do that

187
00:05:25,440 --> 00:05:26,720
the first reason is maybe this

188
00:05:26,720 --> 00:05:28,479
application is asking for

189
00:05:28,479 --> 00:05:30,240
a lot of privileges and we're going to

190
00:05:30,240 --> 00:05:31,840
cover permissions and things like that

191
00:05:31,840 --> 00:05:32,960
here in a little bit

192
00:05:32,960 --> 00:05:34,960
but let's say this application is a

193
00:05:34,960 --> 00:05:36,479
application that's used to

194
00:05:36,479 --> 00:05:39,039
enhance your search in sharepoint or in

195
00:05:39,039 --> 00:05:40,880
exchange so it's going to ask for

196
00:05:40,880 --> 00:05:43,120
the ability to read and read all

197
00:05:43,120 --> 00:05:44,880
mailboxes in the organization or read

198
00:05:44,880 --> 00:05:47,520
all sharepoint sites in the organization

199
00:05:47,520 --> 00:05:50,320
end users do not have the ability and we

200
00:05:50,320 --> 00:05:51,759
don't want them to have that ability to

201
00:05:51,759 --> 00:05:53,280
can say that that is okay for my

202
00:05:53,280 --> 00:05:54,160
organization

203
00:05:54,160 --> 00:05:56,319
at that point for these high permission

204
00:05:56,319 --> 00:05:57,360
privileges

205
00:05:57,360 --> 00:05:59,440
we need to get an admin involved to say

206
00:05:59,440 --> 00:06:01,120
we understand what this application is

207
00:06:01,120 --> 00:06:01,680
doing

208
00:06:01,680 --> 00:06:03,440
and we are okay with it so they're going

209
00:06:03,440 --> 00:06:04,800
to consent to that so it's we need

210
00:06:04,800 --> 00:06:06,400
someone that has more privileges to say

211
00:06:06,400 --> 00:06:06,880
that this

212
00:06:06,880 --> 00:06:09,039
high privileged operation is okay for

213
00:06:09,039 --> 00:06:10,080
our environment

214
00:06:10,080 --> 00:06:13,039
the second example is that when an admin

215
00:06:13,039 --> 00:06:15,199
consents to an application

216
00:06:15,199 --> 00:06:17,120
they're consenting to the application

217
00:06:17,120 --> 00:06:18,960
for all of the users

218
00:06:18,960 --> 00:06:20,720
in the organization so a good example of

219
00:06:20,720 --> 00:06:22,800
this is the the native mail client

220
00:06:22,800 --> 00:06:24,800
in ios when you go to connect it to your

221
00:06:24,800 --> 00:06:26,400
mailbox in exchange online

222
00:06:26,400 --> 00:06:28,400
you'll get that same type of consent

223
00:06:28,400 --> 00:06:30,080
dialog box up it will show you this is

224
00:06:30,080 --> 00:06:31,919
made by apple the app is verified we're

225
00:06:31,919 --> 00:06:32,800
going to cover some of that here in a

226
00:06:32,800 --> 00:06:33,520
little bit

227
00:06:33,520 --> 00:06:35,360
and then user can say yes i'm okay with

228
00:06:35,360 --> 00:06:36,639
this they click okay

229
00:06:36,639 --> 00:06:38,560
and the application works that's fine

230
00:06:38,560 --> 00:06:41,360
but now as an organization we can say

231
00:06:41,360 --> 00:06:42,720
you know what we're okay with this

232
00:06:42,720 --> 00:06:44,960
application being used um so i'm gonna

233
00:06:44,960 --> 00:06:46,639
go in there as an admin and consent to

234
00:06:46,639 --> 00:06:47,039
it

235
00:06:47,039 --> 00:06:48,800
so all of my users in my directory can

236
00:06:48,800 --> 00:06:50,319
now use this application so the next

237
00:06:50,319 --> 00:06:51,680
person that goes to

238
00:06:51,680 --> 00:06:54,000
sign in with the native mail client ios

239
00:06:54,000 --> 00:06:54,880
they will not

240
00:06:54,880 --> 00:06:56,560
get that consent dialog box because an

241
00:06:56,560 --> 00:06:58,800
admin has consented to it

242
00:06:58,800 --> 00:07:02,639
for the entire organization

243
00:07:02,639 --> 00:07:04,639
so there's different types of

244
00:07:04,639 --> 00:07:06,560
permissions for applications that we're

245
00:07:06,560 --> 00:07:08,639
consenting to the two types here

246
00:07:08,639 --> 00:07:10,160
are delegated permissions and

247
00:07:10,160 --> 00:07:11,840
application permissions

248
00:07:11,840 --> 00:07:14,080
delegated permissions is what we want

249
00:07:14,080 --> 00:07:15,759
most of our applications to be using

250
00:07:15,759 --> 00:07:16,000
this

251
00:07:16,000 --> 00:07:18,639
requires the user to be signed in and

252
00:07:18,639 --> 00:07:20,080
present for that application to make

253
00:07:20,080 --> 00:07:21,039
those calls

254
00:07:21,039 --> 00:07:22,880
on behalf of the user these are the

255
00:07:22,880 --> 00:07:24,080
types of permissions

256
00:07:24,080 --> 00:07:25,280
that i just talked about that the end

257
00:07:25,280 --> 00:07:27,440
user can consent to as well as if an

258
00:07:27,440 --> 00:07:28,800
admin consents to it because it has

259
00:07:28,800 --> 00:07:30,639
higher privileges or

260
00:07:30,639 --> 00:07:32,319
it's we're going to consent to it to for

261
00:07:32,319 --> 00:07:33,759
all users in the organization that's the

262
00:07:33,759 --> 00:07:35,360
delegated permissions

263
00:07:35,360 --> 00:07:37,599
now the effective permissions of those

264
00:07:37,599 --> 00:07:39,039
delegated permissions is where people

265
00:07:39,039 --> 00:07:40,479
tend to get a little bit tripped up if

266
00:07:40,479 --> 00:07:42,160
they don't understand this correctly

267
00:07:42,160 --> 00:07:44,319
so let's say that application is asking

268
00:07:44,319 --> 00:07:46,560
for the ability to do

269
00:07:46,560 --> 00:07:48,400
um you know read all mailboxes or read

270
00:07:48,400 --> 00:07:50,080
all sharepoint sites and we've consented

271
00:07:50,080 --> 00:07:51,199
to that as an admin

272
00:07:51,199 --> 00:07:53,199
but the user has the ability to only

273
00:07:53,199 --> 00:07:54,479
look at their mailbox or their

274
00:07:54,479 --> 00:07:55,840
sharepoint sites

275
00:07:55,840 --> 00:07:58,080
when they use that application the

276
00:07:58,080 --> 00:07:59,280
effective permissions

277
00:07:59,280 --> 00:08:02,000
is the intersection of that user's

278
00:08:02,000 --> 00:08:03,440
underlying permissions

279
00:08:03,440 --> 00:08:05,199
and the permissions that the application

280
00:08:05,199 --> 00:08:06,720
has been granted to you so say that

281
00:08:06,720 --> 00:08:08,000
another way

282
00:08:08,000 --> 00:08:10,400
we're not elevating those end users

283
00:08:10,400 --> 00:08:12,000
permissions they don't get to see all

284
00:08:12,000 --> 00:08:14,160
the mailboxes now or all the sharepoint

285
00:08:14,160 --> 00:08:15,199
sites because they don't have that

286
00:08:15,199 --> 00:08:16,639
ability themselves

287
00:08:16,639 --> 00:08:18,160
so it's the intersection of what that

288
00:08:18,160 --> 00:08:19,840
user has access to do and what the

289
00:08:19,840 --> 00:08:21,759
application has access to do

290
00:08:21,759 --> 00:08:23,360
now this is sometimes referred to as

291
00:08:23,360 --> 00:08:26,000
scopes oauth2 permission grants

292
00:08:26,000 --> 00:08:28,479
or app plus user permissions the second

293
00:08:28,479 --> 00:08:29,840
type of permissions here

294
00:08:29,840 --> 00:08:32,000
is application permissions and these are

295
00:08:32,000 --> 00:08:33,599
very very powerful permissions because

296
00:08:33,599 --> 00:08:35,760
these can run these applications can run

297
00:08:35,760 --> 00:08:37,440
without the user being signed in or

298
00:08:37,440 --> 00:08:40,000
present at all and whatever permissions

299
00:08:40,000 --> 00:08:40,399
that

300
00:08:40,399 --> 00:08:42,958
we've consented to that an admin has to

301
00:08:42,958 --> 00:08:45,360
consent to for application permissions

302
00:08:45,360 --> 00:08:48,160
that application has the ability to do

303
00:08:48,160 --> 00:08:49,600
so if an application is asking for the

304
00:08:49,600 --> 00:08:50,480
ability to

305
00:08:50,480 --> 00:08:52,560
read and write to everyone's mailbox or

306
00:08:52,560 --> 00:08:54,000
do directory read write all

307
00:08:54,000 --> 00:08:56,160
and an admin consents to it that

308
00:08:56,160 --> 00:08:57,360
application

309
00:08:57,360 --> 00:08:59,279
has those permissions and has the

310
00:08:59,279 --> 00:09:00,959
ability to do those types of things and

311
00:09:00,959 --> 00:09:02,240
we're going to show you a demo of that

312
00:09:02,240 --> 00:09:02,880
later

313
00:09:02,880 --> 00:09:04,080
just to kind of hopefully really hammer

314
00:09:04,080 --> 00:09:06,560
that home that this could be a very very

315
00:09:06,560 --> 00:09:08,080
privileged operation if we're not

316
00:09:08,080 --> 00:09:09,600
careful to what we're allowing people

317
00:09:09,600 --> 00:09:11,279
our applications to do

318
00:09:11,279 --> 00:09:12,720
they may have some adverse effects in

319
00:09:12,720 --> 00:09:14,480
our environment now this is sometimes

320
00:09:14,480 --> 00:09:15,120
called

321
00:09:15,120 --> 00:09:18,800
roles app roles or app only permissions

322
00:09:18,800 --> 00:09:20,720
okay so i know this has been a lot so

323
00:09:20,720 --> 00:09:22,000
the next slide here is just kind of

324
00:09:22,000 --> 00:09:24,000
giving you a hopefully a nice recap for

325
00:09:24,000 --> 00:09:25,680
you so delegated permissions is what we

326
00:09:25,680 --> 00:09:26,080
want

327
00:09:26,080 --> 00:09:28,000
applications to be using this is going

328
00:09:28,000 --> 00:09:29,360
to be those mobile apps

329
00:09:29,360 --> 00:09:31,920
those web apps or those spa apps which

330
00:09:31,920 --> 00:09:33,839
are you know single page applications

331
00:09:33,839 --> 00:09:36,720
end users can consent to it an

332
00:09:36,720 --> 00:09:38,240
administrator can consent to it for all

333
00:09:38,240 --> 00:09:39,040
users

334
00:09:39,040 --> 00:09:40,640
in their organization and the effective

335
00:09:40,640 --> 00:09:42,720
permissions model is the intersection

336
00:09:42,720 --> 00:09:44,000
between what the application has the

337
00:09:44,000 --> 00:09:44,880
ability to do

338
00:09:44,880 --> 00:09:46,399
and what the end user has the ability to

339
00:09:46,399 --> 00:09:47,920
do but there's nothing in there

340
00:09:47,920 --> 00:09:49,200
we're not elevating the user's

341
00:09:49,200 --> 00:09:50,640
permissions to do something they didn't

342
00:09:50,640 --> 00:09:52,399
already have access to do

343
00:09:52,399 --> 00:09:54,240
the application permission model those

344
00:09:54,240 --> 00:09:55,920
run without a user being signed in at

345
00:09:55,920 --> 00:09:56,160
all

346
00:09:56,160 --> 00:09:57,760
so these like your service or daemon

347
00:09:57,760 --> 00:10:00,880
accounts only it administrators

348
00:10:00,880 --> 00:10:03,120
can grant access to applications to do

349
00:10:03,120 --> 00:10:04,480
this we want to be very very careful

350
00:10:04,480 --> 00:10:05,279
about that

351
00:10:05,279 --> 00:10:06,959
and whatever permissions you grant to an

352
00:10:06,959 --> 00:10:09,440
application that application has the

353
00:10:09,440 --> 00:10:10,800
ability to do so we want to make sure

354
00:10:10,800 --> 00:10:12,880
we're very very careful and clear about

355
00:10:12,880 --> 00:10:14,560
what those applications has the ability

356
00:10:14,560 --> 00:10:17,440
to do in our environment

357
00:10:17,440 --> 00:10:18,720
and with that i think chris is going to

358
00:10:18,720 --> 00:10:20,640
do a demo here of the application

359
00:10:20,640 --> 00:10:22,800
consent experience

360
00:10:22,800 --> 00:10:24,800
yes all right so thanks mark so i'm

361
00:10:24,800 --> 00:10:25,839
gonna

362
00:10:25,839 --> 00:10:29,120
do a demo experience as if i am a user

363
00:10:29,120 --> 00:10:30,880
and an admin so you can see what that

364
00:10:30,880 --> 00:10:32,079
permission experience

365
00:10:32,079 --> 00:10:34,240
is and so first i'm going to be signing

366
00:10:34,240 --> 00:10:36,160
in as lisa smith into um

367
00:10:36,160 --> 00:10:39,440
the wood grove tenant so i sign in

368
00:10:39,440 --> 00:10:41,920
and it's accessing the wood grove

369
00:10:41,920 --> 00:10:42,560
shipping

370
00:10:42,560 --> 00:10:44,399
application and there are some

371
00:10:44,399 --> 00:10:46,480
permissions that i don't have um

372
00:10:46,480 --> 00:10:48,480
the rights to yet so it's saying that

373
00:10:48,480 --> 00:10:49,920
approval is required

374
00:10:49,920 --> 00:10:51,760
and you can see in this permission box

375
00:10:51,760 --> 00:10:53,600
that there's you can

376
00:10:53,600 --> 00:10:55,040
uh look into the type of permissions

377
00:10:55,040 --> 00:10:56,399
there are some that are specific for

378
00:10:56,399 --> 00:10:57,120
users

379
00:10:57,120 --> 00:10:58,839
there's some that are specific for the

380
00:10:58,839 --> 00:11:01,120
applications and i would need to enter a

381
00:11:01,120 --> 00:11:03,839
justification of why i want to request

382
00:11:03,839 --> 00:11:06,880
this application and then i would just

383
00:11:06,880 --> 00:11:08,160
hit request approval

384
00:11:08,160 --> 00:11:11,279
and this will be sent off to the admin

385
00:11:11,279 --> 00:11:13,519
now if i were actually signed in as an

386
00:11:13,519 --> 00:11:15,040
admin there's a slightly different

387
00:11:15,040 --> 00:11:17,600
experience as mark was mentioning

388
00:11:17,600 --> 00:11:20,079
so now i'm signed into the woodgrove

389
00:11:20,079 --> 00:11:22,560
tenant as an admin

390
00:11:22,560 --> 00:11:24,399
and go to the link of that same

391
00:11:24,399 --> 00:11:25,680
woodgrove shipping

392
00:11:25,680 --> 00:11:28,160
application and now here you can see

393
00:11:28,160 --> 00:11:30,000
that permission is requested to review

394
00:11:30,000 --> 00:11:31,440
for your organization

395
00:11:31,440 --> 00:11:34,079
i see that is an unverified application

396
00:11:34,079 --> 00:11:35,519
i'm looking at the permissions that it's

397
00:11:35,519 --> 00:11:36,720
asking to do

398
00:11:36,720 --> 00:11:38,800
and then in the end i can either accept

399
00:11:38,800 --> 00:11:39,920
or cancel it

400
00:11:39,920 --> 00:11:41,519
and if i accept it i'm going to be

401
00:11:41,519 --> 00:11:43,440
accepting it on behalf of the entire

402
00:11:43,440 --> 00:11:44,160
organization

403
00:11:44,160 --> 00:11:46,320
and then no longer will any of the users

404
00:11:46,320 --> 00:11:47,680
receive that pop-up

405
00:11:47,680 --> 00:11:49,519
because now um it's registered and good

406
00:11:49,519 --> 00:11:51,839
to go

407
00:11:52,480 --> 00:11:54,000
so with that i'm going to hand it back

408
00:11:54,000 --> 00:11:55,839
to

409
00:11:55,839 --> 00:11:58,399
okay so what actually happens under the

410
00:11:58,399 --> 00:11:59,839
covers when we click

411
00:11:59,839 --> 00:12:03,040
uh yes consent to this thing so in azure

412
00:12:03,040 --> 00:12:03,360
id

413
00:12:03,360 --> 00:12:04,800
there's two areas if you haven't looked

414
00:12:04,800 --> 00:12:06,639
at it yet there's the app registrations

415
00:12:06,639 --> 00:12:08,160
and there's the enterprise apps

416
00:12:08,160 --> 00:12:10,880
the app registrations is the definition

417
00:12:10,880 --> 00:12:12,800
of the application so the way to think

418
00:12:12,800 --> 00:12:13,360
about this

419
00:12:13,360 --> 00:12:15,360
is this is kind of the back of the back

420
00:12:15,360 --> 00:12:17,040
of the house type of configuration of

421
00:12:17,040 --> 00:12:18,800
that application so is this application

422
00:12:18,800 --> 00:12:19,600
going to be

423
00:12:19,600 --> 00:12:21,920
a single tenant app only used by your

424
00:12:21,920 --> 00:12:23,680
company is this application going to be

425
00:12:23,680 --> 00:12:25,680
a multi-tenant app that can be used by

426
00:12:25,680 --> 00:12:26,959
multiple different companies is it going

427
00:12:26,959 --> 00:12:28,639
to be only for azure ad users is going

428
00:12:28,639 --> 00:12:30,480
to be for also msa users this is all the

429
00:12:30,480 --> 00:12:32,000
type of configuration

430
00:12:32,000 --> 00:12:34,320
that you'll do you'll set in the app

431
00:12:34,320 --> 00:12:36,079
registrations

432
00:12:36,079 --> 00:12:38,480
the enterprise apps has what's called a

433
00:12:38,480 --> 00:12:39,839
service principle and we'll talk about

434
00:12:39,839 --> 00:12:41,360
that here in the next slide but this is

435
00:12:41,360 --> 00:12:42,720
very very important because this is the

436
00:12:42,720 --> 00:12:44,000
representation

437
00:12:44,000 --> 00:12:45,680
of that application this is you can

438
00:12:45,680 --> 00:12:47,040
think about this as kind of the the

439
00:12:47,040 --> 00:12:48,560
front of the house this is

440
00:12:48,560 --> 00:12:50,720
do you have to do mfa to actually get

441
00:12:50,720 --> 00:12:52,480
into this application this is who has

442
00:12:52,480 --> 00:12:54,480
access to that application that's all

443
00:12:54,480 --> 00:12:57,440
configured there in the enterprise apps

444
00:12:57,440 --> 00:12:58,880
so to make this clear here an example

445
00:12:58,880 --> 00:13:00,399
let's say i'm tenant one

446
00:13:00,399 --> 00:13:02,320
and we make a time keeping application

447
00:13:02,320 --> 00:13:03,600
chris and i make that

448
00:13:03,600 --> 00:13:05,040
and we sell this to other companies so

449
00:13:05,040 --> 00:13:06,959
in our tenant there will be an app

450
00:13:06,959 --> 00:13:08,079
registration

451
00:13:08,079 --> 00:13:10,560
for that timekeeping application but we

452
00:13:10,560 --> 00:13:12,399
also use that application as a company

453
00:13:12,399 --> 00:13:14,079
so we will have that as a service

454
00:13:14,079 --> 00:13:14,959
principle

455
00:13:14,959 --> 00:13:17,360
in the enterprise apps and when we sell

456
00:13:17,360 --> 00:13:18,480
this application to

457
00:13:18,480 --> 00:13:20,480
other companies when they go to add it

458
00:13:20,480 --> 00:13:22,079
to their azure id tenant what they will

459
00:13:22,079 --> 00:13:22,639
see

460
00:13:22,639 --> 00:13:25,040
is a service principal in their tenant

461
00:13:25,040 --> 00:13:26,480
they will not see the app registration

462
00:13:26,480 --> 00:13:28,160
they will only see a service principle

463
00:13:28,160 --> 00:13:28,880
so

464
00:13:28,880 --> 00:13:30,240
to make this real if you check your

465
00:13:30,240 --> 00:13:32,320
tenant and you look for exchange online

466
00:13:32,320 --> 00:13:34,480
or sharepoint or salesforce or workday

467
00:13:34,480 --> 00:13:36,240
or any of those types of applications

468
00:13:36,240 --> 00:13:38,560
what you will see is a service principle

469
00:13:38,560 --> 00:13:40,639
in enterprise apps you will not see

470
00:13:40,639 --> 00:13:42,639
an app registration but if you are

471
00:13:42,639 --> 00:13:43,839
moving like a line of business

472
00:13:43,839 --> 00:13:45,199
application that's only going to be

473
00:13:45,199 --> 00:13:47,120
be used by your company and you're

474
00:13:47,120 --> 00:13:48,880
moving that up there you're going to see

475
00:13:48,880 --> 00:13:51,279
a app registration for it as well as

476
00:13:51,279 --> 00:13:52,800
that service principle

477
00:13:52,800 --> 00:13:54,639
the service principle here is really

478
00:13:54,639 --> 00:13:57,279
really important

479
00:13:57,279 --> 00:13:59,600
so the service principle is really

480
00:13:59,600 --> 00:14:00,480
important

481
00:14:00,480 --> 00:14:03,199
because this is also the security

482
00:14:03,199 --> 00:14:04,079
principle

483
00:14:04,079 --> 00:14:06,480
for the application and this can have be

484
00:14:06,480 --> 00:14:08,160
granted access to things

485
00:14:08,160 --> 00:14:09,440
as you can see here so we already talked

486
00:14:09,440 --> 00:14:11,040
about the two permissions the delegated

487
00:14:11,040 --> 00:14:12,480
permissions model and the app only

488
00:14:12,480 --> 00:14:13,519
permissions model

489
00:14:13,519 --> 00:14:15,920
but these things can also have beyond

490
00:14:15,920 --> 00:14:18,079
acls for azure key vault

491
00:14:18,079 --> 00:14:20,639
service principles can hold role

492
00:14:20,639 --> 00:14:21,920
assignments in azure

493
00:14:21,920 --> 00:14:23,600
service principles can hold role

494
00:14:23,600 --> 00:14:25,360
assignments in the directory

495
00:14:25,360 --> 00:14:28,480
service principles can own groups

496
00:14:28,480 --> 00:14:30,720
other applications and other service

497
00:14:30,720 --> 00:14:31,519
principles

498
00:14:31,519 --> 00:14:32,959
so the service principle you can kind of

499
00:14:32,959 --> 00:14:35,120
think of it like a service account you

500
00:14:35,120 --> 00:14:36,480
may be an on-prem active directory if

501
00:14:36,480 --> 00:14:37,440
you're familiar with that

502
00:14:37,440 --> 00:14:38,880
but this is very very important because

503
00:14:38,880 --> 00:14:40,720
this has access to things in your

504
00:14:40,720 --> 00:14:41,680
environment

505
00:14:41,680 --> 00:14:44,959
and we just released um last week

506
00:14:44,959 --> 00:14:45,760
actually

507
00:14:45,760 --> 00:14:47,839
in the azure id signing logs you will

508
00:14:47,839 --> 00:14:49,680
now see all the sign ins

509
00:14:49,680 --> 00:14:51,839
for things like service principles and

510
00:14:51,839 --> 00:14:53,360
manage service identities which is a

511
00:14:53,360 --> 00:14:54,800
type of service principle

512
00:14:54,800 --> 00:14:56,240
and those have access to things you can

513
00:14:56,240 --> 00:14:58,240
see exactly today in your environment

514
00:14:58,240 --> 00:14:59,680
what these things are doing and what

515
00:14:59,680 --> 00:15:01,360
they have access to do in your

516
00:15:01,360 --> 00:15:03,680
environment

517
00:15:03,680 --> 00:15:05,760
so i know somebody here is probably

518
00:15:05,760 --> 00:15:06,720
thinking

519
00:15:06,720 --> 00:15:08,320
at this point they're thinking exactly

520
00:15:08,320 --> 00:15:09,760
like grandpa simpson

521
00:15:09,760 --> 00:15:13,440
that this cloud is nothing but trouble

522
00:15:13,440 --> 00:15:15,680
i knew it from the beginning so i have

523
00:15:15,680 --> 00:15:17,040
and now in my tenant when i go look at

524
00:15:17,040 --> 00:15:18,000
this stuff

525
00:15:18,000 --> 00:15:20,160
i have all these mystery applications i

526
00:15:20,160 --> 00:15:22,079
have no idea where they came from

527
00:15:22,079 --> 00:15:23,600
with a bunch of users assigned

528
00:15:23,600 --> 00:15:25,839
applications i have no idea how anybody

529
00:15:25,839 --> 00:15:27,680
got assigned to these applications

530
00:15:27,680 --> 00:15:29,680
and there's a bunch of permissions that

531
00:15:29,680 --> 00:15:31,199
i do not understand

532
00:15:31,199 --> 00:15:32,639
what's happening in my environment this

533
00:15:32,639 --> 00:15:34,800
is all the cloud's fault

534
00:15:34,800 --> 00:15:36,399
and we have some stuff that will make

535
00:15:36,399 --> 00:15:37,839
this easier for you we have some scripts

536
00:15:37,839 --> 00:15:39,440
that we'll give you at the end of this

537
00:15:39,440 --> 00:15:40,720
talk you can run it in your environment

538
00:15:40,720 --> 00:15:42,959
we'll cover all that but i dare you to

539
00:15:42,959 --> 00:15:43,759
ask these same

540
00:15:43,759 --> 00:15:46,720
questions about your on-prem environment

541
00:15:46,720 --> 00:15:48,079
if you don't have a very good

542
00:15:48,079 --> 00:15:48,880
application

543
00:15:48,880 --> 00:15:51,360
inventory which lots of customers do not

544
00:15:51,360 --> 00:15:52,320
have

545
00:15:52,320 --> 00:15:53,759
i dare you to ask these same questions

546
00:15:53,759 --> 00:15:55,440
about you about those on-prem apps do

547
00:15:55,440 --> 00:15:56,079
you know

548
00:15:56,079 --> 00:15:57,519
where all those apps have come from do

549
00:15:57,519 --> 00:15:59,279
you know who has what

550
00:15:59,279 --> 00:16:00,959
assignment to what applications do you

551
00:16:00,959 --> 00:16:03,040
know what permissions these applications

552
00:16:03,040 --> 00:16:03,680
need

553
00:16:03,680 --> 00:16:06,079
so this is the point here is that this

554
00:16:06,079 --> 00:16:07,440
is not a unique

555
00:16:07,440 --> 00:16:09,600
challenge to the cloud you probably have

556
00:16:09,600 --> 00:16:11,199
this problem already on prem

557
00:16:11,199 --> 00:16:14,399
you may just not be realizing it and the

558
00:16:14,399 --> 00:16:16,399
reason you want to

559
00:16:16,399 --> 00:16:17,680
start looking at this and go to the next

560
00:16:17,680 --> 00:16:19,120
slide chris is because we're starting to

561
00:16:19,120 --> 00:16:20,000
see

562
00:16:20,000 --> 00:16:22,399
some malware campaigns around this so

563
00:16:22,399 --> 00:16:24,320
traditionally from a malware campaign

564
00:16:24,320 --> 00:16:27,040
right we have this invoice attachment we

565
00:16:27,040 --> 00:16:28,480
have some sort of

566
00:16:28,480 --> 00:16:30,160
macro we're trying to get the person to

567
00:16:30,160 --> 00:16:32,560
run and in this covet 19

568
00:16:32,560 --> 00:16:34,639
type of campaign we're starting to see

569
00:16:34,639 --> 00:16:35,680
these people are

570
00:16:35,680 --> 00:16:37,839
you know just the utmost scum of the

571
00:16:37,839 --> 00:16:38,800
earth they're

572
00:16:38,800 --> 00:16:40,240
trying to impersonate the cdc they're

573
00:16:40,240 --> 00:16:41,519
preying on people's fear and they're

574
00:16:41,519 --> 00:16:43,120
still trying to get people to

575
00:16:43,120 --> 00:16:44,399
to run these attachments and these

576
00:16:44,399 --> 00:16:45,839
macros and this is the traditional type

577
00:16:45,839 --> 00:16:46,800
of fishing

578
00:16:46,800 --> 00:16:48,720
that you probably as you know

579
00:16:48,720 --> 00:16:51,040
administrators and you know defenders or

580
00:16:51,040 --> 00:16:52,399
even like attackers you know internal

581
00:16:52,399 --> 00:16:54,240
attackers trying to to get people to do

582
00:16:54,240 --> 00:16:55,680
stuff this is the type of thing

583
00:16:55,680 --> 00:16:58,639
that you're probably used to seeing but

584
00:16:58,639 --> 00:17:00,880
from an application consent

585
00:17:00,880 --> 00:17:03,199
um that's something as a new thing we're

586
00:17:03,199 --> 00:17:04,240
starting to see you can go to the next

587
00:17:04,240 --> 00:17:05,439
slide karissa

588
00:17:05,439 --> 00:17:08,240
um where we're not seeing this like in

589
00:17:08,240 --> 00:17:10,319
effect this the most common types of

590
00:17:10,319 --> 00:17:12,000
attacks we still see

591
00:17:12,000 --> 00:17:14,000
are going to be the traditional phishing

592
00:17:14,000 --> 00:17:15,119
the traditional

593
00:17:15,119 --> 00:17:17,039
password reuse the traditional like

594
00:17:17,039 --> 00:17:18,799
legacy authentication is open nobody's

595
00:17:18,799 --> 00:17:20,559
using mfa so they're getting password

596
00:17:20,559 --> 00:17:21,439
sprayed

597
00:17:21,439 --> 00:17:23,679
but we're starting to see this as an

598
00:17:23,679 --> 00:17:24,959
evolved threat

599
00:17:24,959 --> 00:17:26,959
where instead of trying to get you to

600
00:17:26,959 --> 00:17:28,640
download that excel document

601
00:17:28,640 --> 00:17:31,039
or run that word document run that macro

602
00:17:31,039 --> 00:17:32,640
they want you to consent

603
00:17:32,640 --> 00:17:34,720
to an application so here you can see

604
00:17:34,720 --> 00:17:37,600
this office 365 access application

605
00:17:37,600 --> 00:17:39,440
and that logo like looks kind of

606
00:17:39,440 --> 00:17:41,280
familiar but it's probably not quite

607
00:17:41,280 --> 00:17:42,000
right

608
00:17:42,000 --> 00:17:43,360
and we can see that it wants to read

609
00:17:43,360 --> 00:17:44,960
your contacts and read your profile that

610
00:17:44,960 --> 00:17:46,160
looks like some applications that i've

611
00:17:46,160 --> 00:17:47,200
done before

612
00:17:47,200 --> 00:17:48,960
if i'm not paying too close attention it

613
00:17:48,960 --> 00:17:50,400
also wants to be able to

614
00:17:50,400 --> 00:17:52,480
read all my onenote notebooks i also

615
00:17:52,480 --> 00:17:53,520
wants to be able to read and write to

616
00:17:53,520 --> 00:17:54,960
all my mailbox settings

617
00:17:54,960 --> 00:17:56,960
it has full access to all my stuff so if

618
00:17:56,960 --> 00:17:58,640
i'm not paying attention

619
00:17:58,640 --> 00:18:01,039
this i'm granting this permission or

620
00:18:01,039 --> 00:18:02,320
this application

621
00:18:02,320 --> 00:18:05,840
very powerful permissions to my account

622
00:18:05,840 --> 00:18:07,520
and we've seen a few customers get hit

623
00:18:07,520 --> 00:18:09,679
with this type of phishing attack and

624
00:18:09,679 --> 00:18:11,120
that this is where we talk about you

625
00:18:11,120 --> 00:18:12,840
know the title says sustain

626
00:18:12,840 --> 00:18:16,559
persistence um your traditional types of

627
00:18:16,559 --> 00:18:17,200
malware

628
00:18:17,200 --> 00:18:20,320
tools here aren't going to work because

629
00:18:20,320 --> 00:18:21,280
there isn't anything

630
00:18:21,280 --> 00:18:23,440
run on the local workstation right this

631
00:18:23,440 --> 00:18:24,640
is in the service

632
00:18:24,640 --> 00:18:26,799
this application has now requested

633
00:18:26,799 --> 00:18:28,480
access to things that has access to this

634
00:18:28,480 --> 00:18:29,919
person's mailbox

635
00:18:29,919 --> 00:18:32,799
so even if you go in and you find this

636
00:18:32,799 --> 00:18:34,000
application as bad and we're going to

637
00:18:34,000 --> 00:18:35,440
show you how to do that

638
00:18:35,440 --> 00:18:37,520
and you remove it you need to do a

639
00:18:37,520 --> 00:18:39,679
little more digger deeping to eradicate

640
00:18:39,679 --> 00:18:41,200
this because if this application had the

641
00:18:41,200 --> 00:18:42,240
ability

642
00:18:42,240 --> 00:18:45,039
to create mailbox forwarding rules those

643
00:18:45,039 --> 00:18:46,400
forwarding rules are still going to be

644
00:18:46,400 --> 00:18:48,080
on those mailboxes even after you

645
00:18:48,080 --> 00:18:48,880
removed

646
00:18:48,880 --> 00:18:51,440
that application okay so we want to make

647
00:18:51,440 --> 00:18:52,640
sure this is why it's really important

648
00:18:52,640 --> 00:18:53,840
to understand

649
00:18:53,840 --> 00:18:55,200
what people have consented to in the

650
00:18:55,200 --> 00:18:57,200
environment what those permissions that

651
00:18:57,200 --> 00:18:58,720
those applications have the ability to

652
00:18:58,720 --> 00:18:59,120
do

653
00:18:59,120 --> 00:19:01,039
and when we do find something that's

654
00:19:01,039 --> 00:19:03,039
malicious we are looking in the right

655
00:19:03,039 --> 00:19:04,640
places we're not just running a scan of

656
00:19:04,640 --> 00:19:06,080
that local workstation go yeah it looks

657
00:19:06,080 --> 00:19:06,559
fine

658
00:19:06,559 --> 00:19:08,080
oh yeah we deleted the app you have to

659
00:19:08,080 --> 00:19:09,120
do more than that you need to be able to

660
00:19:09,120 --> 00:19:10,880
look to see what that application had

661
00:19:10,880 --> 00:19:12,160
the permissions to do

662
00:19:12,160 --> 00:19:13,520
and did it make any changes in other

663
00:19:13,520 --> 00:19:15,840
places like mailbox forwarding rules did

664
00:19:15,840 --> 00:19:17,440
it make any changes into one or things

665
00:19:17,440 --> 00:19:18,480
like that those are all things that are

666
00:19:18,480 --> 00:19:18,799
really

667
00:19:18,799 --> 00:19:21,918
important that we want to take a look at

668
00:19:22,000 --> 00:19:24,160
okay so hopefully at this point if you

669
00:19:24,160 --> 00:19:25,760
didn't know about application consent

670
00:19:25,760 --> 00:19:27,360
and you didn't care about it then you

671
00:19:27,360 --> 00:19:28,799
hopefully care about now so let's talk

672
00:19:28,799 --> 00:19:30,160
about some of those key permissions that

673
00:19:30,160 --> 00:19:31,440
you should be looking for

674
00:19:31,440 --> 00:19:33,360
in your environment so this is really

675
00:19:33,360 --> 00:19:34,720
for your reference

676
00:19:34,720 --> 00:19:36,960
but any of these really types of highly

677
00:19:36,960 --> 00:19:38,400
privileged permissions

678
00:19:38,400 --> 00:19:39,840
we want to make sure we understand and

679
00:19:39,840 --> 00:19:41,200
just because an application is asking

680
00:19:41,200 --> 00:19:42,640
for the ability to do

681
00:19:42,640 --> 00:19:44,720
mail read write all or directory read

682
00:19:44,720 --> 00:19:45,919
write all or any of these types of

683
00:19:45,919 --> 00:19:47,360
permissions that are just very very

684
00:19:47,360 --> 00:19:48,480
privileged

685
00:19:48,480 --> 00:19:51,200
doesn't mean the application is bad it

686
00:19:51,200 --> 00:19:52,480
could just mean a few different things

687
00:19:52,480 --> 00:19:52,960
one

688
00:19:52,960 --> 00:19:55,120
the application might need this if you

689
00:19:55,120 --> 00:19:56,640
have an e-discovery application you're

690
00:19:56,640 --> 00:19:57,440
using

691
00:19:57,440 --> 00:19:59,840
it's going to need a lot of permissions

692
00:19:59,840 --> 00:20:01,679
in your exchange online mail environment

693
00:20:01,679 --> 00:20:03,280
to be able to search through things and

694
00:20:03,280 --> 00:20:04,720
search through sharepoint and find those

695
00:20:04,720 --> 00:20:06,640
types of things for legal discovery

696
00:20:06,640 --> 00:20:09,280
that's okay the point though as

697
00:20:09,280 --> 00:20:10,400
defenders and

698
00:20:10,400 --> 00:20:13,120
um you know application administrators

699
00:20:13,120 --> 00:20:14,400
we want to make sure we really

700
00:20:14,400 --> 00:20:15,440
understand

701
00:20:15,440 --> 00:20:17,520
does that application really need those

702
00:20:17,520 --> 00:20:19,280
permissions and if it's okay

703
00:20:19,280 --> 00:20:20,799
then that's okay it can do that but we

704
00:20:20,799 --> 00:20:22,480
want to make sure the other scenario

705
00:20:22,480 --> 00:20:23,440
here is that

706
00:20:23,440 --> 00:20:24,559
um and we'll talk about this a little

707
00:20:24,559 --> 00:20:26,799
bit later as well is that developers are

708
00:20:26,799 --> 00:20:27,360
just

709
00:20:27,360 --> 00:20:31,039
kind of lazy and they don't actually

710
00:20:31,039 --> 00:20:33,120
sometimes do the work to understand what

711
00:20:33,120 --> 00:20:34,320
permissions they need and this is not a

712
00:20:34,320 --> 00:20:35,120
new problem

713
00:20:35,120 --> 00:20:37,360
i'm sure everybody here has had some

714
00:20:37,360 --> 00:20:38,159
business unit

715
00:20:38,159 --> 00:20:40,559
buy an application and say please set

716
00:20:40,559 --> 00:20:41,520
this up for us

717
00:20:41,520 --> 00:20:43,120
and you get that install guy and it says

718
00:20:43,120 --> 00:20:44,799
it needs to uh domain admin

719
00:20:44,799 --> 00:20:46,320
enterprise admin and scheme admin and

720
00:20:46,320 --> 00:20:47,760
you're like what in the world is this

721
00:20:47,760 --> 00:20:48,720
application doing

722
00:20:48,720 --> 00:20:50,080
it does it really need those application

723
00:20:50,080 --> 00:20:51,760
permissions no it does not need those

724
00:20:51,760 --> 00:20:52,880
directory permissions at all

725
00:20:52,880 --> 00:20:54,400
they just don't know they didn't do the

726
00:20:54,400 --> 00:20:55,520
work to figure out what the permissions

727
00:20:55,520 --> 00:20:56,640
need so you're going to see the same

728
00:20:56,640 --> 00:20:57,840
types of thing here so any of those

729
00:20:57,840 --> 00:20:59,200
types of permissions like this

730
00:20:59,200 --> 00:21:01,520
we just want to be really really careful

731
00:21:01,520 --> 00:21:03,039
about what we let them do

732
00:21:03,039 --> 00:21:04,240
because it might have those very

733
00:21:04,240 --> 00:21:05,440
privileged permissions and it can do

734
00:21:05,440 --> 00:21:06,640
some damage and we'll show you that here

735
00:21:06,640 --> 00:21:09,039
in a demo a little bit

736
00:21:09,039 --> 00:21:11,120
all right some other low impact

737
00:21:11,120 --> 00:21:12,720
permissions too that you need to think

738
00:21:12,720 --> 00:21:13,440
about

739
00:21:13,440 --> 00:21:16,000
as administrators is that you know this

740
00:21:16,000 --> 00:21:16,880
is basic stuff

741
00:21:16,880 --> 00:21:18,480
any user can see their own email their

742
00:21:18,480 --> 00:21:21,200
profile user.read and that's that's okay

743
00:21:21,200 --> 00:21:23,840
but we had a customer where some they

744
00:21:23,840 --> 00:21:25,600
want some end user wanted to use this

745
00:21:25,600 --> 00:21:27,600
like directory application and they

746
00:21:27,600 --> 00:21:29,039
the directory application asks for these

747
00:21:29,039 --> 00:21:30,400
types of permissions the end user had

748
00:21:30,400 --> 00:21:31,360
the ability

749
00:21:31,360 --> 00:21:33,600
to say yes it went to the consent prompt

750
00:21:33,600 --> 00:21:35,039
is that yes you can do that

751
00:21:35,039 --> 00:21:36,880
and it went on their normal way they did

752
00:21:36,880 --> 00:21:38,320
their job what they needed to do

753
00:21:38,320 --> 00:21:40,000
then six months later one of their

754
00:21:40,000 --> 00:21:41,760
executives went to this directory

755
00:21:41,760 --> 00:21:42,480
website

756
00:21:42,480 --> 00:21:44,720
and saw their internal profile picture

757
00:21:44,720 --> 00:21:46,159
their first name last name and email

758
00:21:46,159 --> 00:21:47,600
address and they said

759
00:21:47,600 --> 00:21:51,200
we've been hacked well no end users have

760
00:21:51,200 --> 00:21:52,799
this ability this is basic

761
00:21:52,799 --> 00:21:55,200
stuff that's in the gal right like

762
00:21:55,200 --> 00:21:56,880
people's profile picture is in the gal

763
00:21:56,880 --> 00:21:58,400
people's email address is in the gow

764
00:21:58,400 --> 00:22:00,000
anyone can read and see this type of

765
00:22:00,000 --> 00:22:00,720
thing

766
00:22:00,720 --> 00:22:02,480
but if you don't realize that other

767
00:22:02,480 --> 00:22:04,240
applications will have this ability to

768
00:22:04,240 --> 00:22:05,280
do this

769
00:22:05,280 --> 00:22:06,799
even though this is a low impact

770
00:22:06,799 --> 00:22:08,880
permission you need to understand

771
00:22:08,880 --> 00:22:11,600
what they can do in your environment so

772
00:22:11,600 --> 00:22:13,039
when you think about policies and chris

773
00:22:13,039 --> 00:22:14,159
is going to talk about this a little bit

774
00:22:14,159 --> 00:22:15,280
later

775
00:22:15,280 --> 00:22:16,640
these are the things to think about are

776
00:22:16,640 --> 00:22:18,320
we okay with an end user

777
00:22:18,320 --> 00:22:20,799
letting some application you know see

778
00:22:20,799 --> 00:22:22,320
our profile pictures and see our email

779
00:22:22,320 --> 00:22:23,280
addresses

780
00:22:23,280 --> 00:22:25,360
it's not dangerous but maybe for some

781
00:22:25,360 --> 00:22:26,960
customers it is other customers it's not

782
00:22:26,960 --> 00:22:28,240
so these are things to go ahead and

783
00:22:28,240 --> 00:22:30,559
think about

784
00:22:30,559 --> 00:22:31,919
and now at this point chris is going to

785
00:22:31,919 --> 00:22:33,440
show you this really cool demo about

786
00:22:33,440 --> 00:22:34,799
showing you what application permissions

787
00:22:34,799 --> 00:22:35,679
can actually do

788
00:22:35,679 --> 00:22:39,440
in your environment yeah so thanks mark

789
00:22:39,440 --> 00:22:42,720
so in the previous demo you saw that i

790
00:22:42,720 --> 00:22:45,280
tried to access a demo that i didn't

791
00:22:45,280 --> 00:22:45,760
have

792
00:22:45,760 --> 00:22:48,400
um rights to so now we're gonna look at

793
00:22:48,400 --> 00:22:48,880
um

794
00:22:48,880 --> 00:22:50,720
what an application that is actually in

795
00:22:50,720 --> 00:22:52,080
our environment and the type of

796
00:22:52,080 --> 00:22:54,000
permissions it has so i'm going into

797
00:22:54,000 --> 00:22:55,760
the woodgrove immunity passports

798
00:22:55,760 --> 00:22:57,919
application and here inside the portal i

799
00:22:57,919 --> 00:22:59,520
can look at the api permissions that are

800
00:22:59,520 --> 00:23:00,640
allowed for it

801
00:23:00,640 --> 00:23:03,200
and if you look through there's a few

802
00:23:03,200 --> 00:23:04,720
concerning things here one

803
00:23:04,720 --> 00:23:06,480
is if you look at the top of the name of

804
00:23:06,480 --> 00:23:08,320
the application there's three o's so

805
00:23:08,320 --> 00:23:08,799
it's

806
00:23:08,799 --> 00:23:10,240
that's definitely not how my tenant is

807
00:23:10,240 --> 00:23:12,080
spelled so i should be watching out for

808
00:23:12,080 --> 00:23:13,760
those type of misspellings

809
00:23:13,760 --> 00:23:15,760
the second thing to look at is like look

810
00:23:15,760 --> 00:23:17,679
at how many different types

811
00:23:17,679 --> 00:23:19,520
of permissions this application has

812
00:23:19,520 --> 00:23:21,039
there's a ton of application permissions

813
00:23:21,039 --> 00:23:22,400
and you can see there's some delegated

814
00:23:22,400 --> 00:23:24,080
permissions as well

815
00:23:24,080 --> 00:23:25,919
and one of the main ones i'm going to

816
00:23:25,919 --> 00:23:27,919
point out as mark said is the user read

817
00:23:27,919 --> 00:23:28,960
write all like

818
00:23:28,960 --> 00:23:32,000
it may not be dangerous but we should be

819
00:23:32,000 --> 00:23:33,600
aware that this application has this

820
00:23:33,600 --> 00:23:35,039
because a user does not need to be

821
00:23:35,039 --> 00:23:36,159
signed in

822
00:23:36,159 --> 00:23:38,799
for the application to change things and

823
00:23:38,799 --> 00:23:40,400
i'm going to illustrate that

824
00:23:40,400 --> 00:23:42,799
with using the graph explorer which does

825
00:23:42,799 --> 00:23:44,240
have user read write all

826
00:23:44,240 --> 00:23:46,320
privileges and just to show you what

827
00:23:46,320 --> 00:23:47,679
that can do

828
00:23:47,679 --> 00:23:49,919
so i'm looking here at lisa that was the

829
00:23:49,919 --> 00:23:51,919
user profile that i signed in earlier

830
00:23:51,919 --> 00:23:52,720
and i can see

831
00:23:52,720 --> 00:23:55,200
her information here and what i'm going

832
00:23:55,200 --> 00:23:57,039
to do is i'm just going to change this

833
00:23:57,039 --> 00:24:00,799
to whatever i want

834
00:24:01,679 --> 00:24:05,840
and i'm going to patch it

835
00:24:08,320 --> 00:24:13,520
okay i'm going to rerun the query

836
00:24:13,520 --> 00:24:16,000
and now lisa's profile has mark morrow

837
00:24:16,000 --> 00:24:17,520
as a display name

838
00:24:17,520 --> 00:24:20,159
so what does that mean for lisa and her

839
00:24:20,159 --> 00:24:21,200
profile

840
00:24:21,200 --> 00:24:25,039
so i'm going to pull up lisa's profile

841
00:24:27,600 --> 00:24:28,960
and normally it looks like this right

842
00:24:28,960 --> 00:24:30,640
this is her my account where she does

843
00:24:30,640 --> 00:24:32,000
all her self-service

844
00:24:32,000 --> 00:24:34,480
management of her of her passwords and

845
00:24:34,480 --> 00:24:35,360
privacy

846
00:24:35,360 --> 00:24:39,520
and so i'm going to refresh it

847
00:24:42,640 --> 00:24:46,159
one more time for good measure

848
00:24:46,159 --> 00:24:48,240
and now lisa smith has turned into mark

849
00:24:48,240 --> 00:24:50,240
morrow again this is just showing like

850
00:24:50,240 --> 00:24:51,919
what you can do with that privilege and

851
00:24:51,919 --> 00:24:53,360
that is a very high privilege for an

852
00:24:53,360 --> 00:24:54,960
application to have

853
00:24:54,960 --> 00:24:56,480
especially when a user does not even

854
00:24:56,480 --> 00:25:01,200
need to be present

855
00:25:01,200 --> 00:25:04,880
right so that's a very uh hopefully

856
00:25:04,880 --> 00:25:07,039
concerning demo and again just because

857
00:25:07,039 --> 00:25:08,159
it has those permissions

858
00:25:08,159 --> 00:25:10,000
doesn't make the application bad it just

859
00:25:10,000 --> 00:25:11,600
has those permissions to do those types

860
00:25:11,600 --> 00:25:13,039
of things in your environment so we want

861
00:25:13,039 --> 00:25:14,559
to make sure we understand what those

862
00:25:14,559 --> 00:25:15,600
applications are

863
00:25:15,600 --> 00:25:16,720
and why they need those types of

864
00:25:16,720 --> 00:25:18,480
permissions so at this point i'm

865
00:25:18,480 --> 00:25:19,679
guessing if you did not know about any

866
00:25:19,679 --> 00:25:20,960
of this stuff you may be a little

867
00:25:20,960 --> 00:25:22,000
worried about

868
00:25:22,000 --> 00:25:23,440
what's in my environment and how do i

869
00:25:23,440 --> 00:25:25,520
like go deal with this so let's talk

870
00:25:25,520 --> 00:25:27,120
about like how you can go investigate

871
00:25:27,120 --> 00:25:28,799
these types of things

872
00:25:28,799 --> 00:25:31,279
so the first place here is if you only

873
00:25:31,279 --> 00:25:33,120
have a few applications

874
00:25:33,120 --> 00:25:35,360
in the office 365 portal you can look

875
00:25:35,360 --> 00:25:36,799
for some indicators of compromise you

876
00:25:36,799 --> 00:25:37,679
can go through the security and

877
00:25:37,679 --> 00:25:38,960
compliance center look at those audit

878
00:25:38,960 --> 00:25:39,600
logs

879
00:25:39,600 --> 00:25:41,120
if you see anything that says admin

880
00:25:41,120 --> 00:25:43,760
consent set to true that means a global

881
00:25:43,760 --> 00:25:44,559
admin

882
00:25:44,559 --> 00:25:46,720
had to go in there and approve

883
00:25:46,720 --> 00:25:47,600
permissions

884
00:25:47,600 --> 00:25:49,360
okay so again those are going to be

885
00:25:49,360 --> 00:25:51,200
those very privileged permissions

886
00:25:51,200 --> 00:25:52,720
and you know if you were an attacker and

887
00:25:52,720 --> 00:25:54,640
maybe you tricked a global admin

888
00:25:54,640 --> 00:25:56,559
to consent to a lot of permissions

889
00:25:56,559 --> 00:25:57,840
though that that

890
00:25:57,840 --> 00:25:59,840
application now has the ability to do

891
00:25:59,840 --> 00:26:01,120
those types of things so we want to make

892
00:26:01,120 --> 00:26:02,240
sure we look at that

893
00:26:02,240 --> 00:26:03,840
you can also see this in the azure ad

894
00:26:03,840 --> 00:26:05,120
portal under the enterprise apps

895
00:26:05,120 --> 00:26:06,480
permissions that chris has showed you as

896
00:26:06,480 --> 00:26:08,000
well as in those audit logs

897
00:26:08,000 --> 00:26:10,559
but i'm guessing that most of you will

898
00:26:10,559 --> 00:26:11,919
probably not have a few apps you will

899
00:26:11,919 --> 00:26:12,960
probably have

900
00:26:12,960 --> 00:26:14,880
lots of apps remember the average app is

901
00:26:14,880 --> 00:26:16,320
like 140 or whatever

902
00:26:16,320 --> 00:26:18,080
you probably have much more than that so

903
00:26:18,080 --> 00:26:19,520
we have a script for you

904
00:26:19,520 --> 00:26:22,640
if you go to ak that ms slash get

905
00:26:22,640 --> 00:26:24,960
azure av permissions this is a github

906
00:26:24,960 --> 00:26:26,640
repository of a script that you can run

907
00:26:26,640 --> 00:26:27,600
in powershell

908
00:26:27,600 --> 00:26:29,039
and this will dump out all of the

909
00:26:29,039 --> 00:26:30,960
applications and their permissions

910
00:26:30,960 --> 00:26:32,799
in your directory this is probably the

911
00:26:32,799 --> 00:26:34,480
easiest and fastest way

912
00:26:34,480 --> 00:26:37,120
to go ahead and do this if you also have

913
00:26:37,120 --> 00:26:38,960
uh microsoft cloud app security which is

914
00:26:38,960 --> 00:26:39,679
part of the

915
00:26:39,679 --> 00:26:41,919
our casb solution that can also be used

916
00:26:41,919 --> 00:26:44,880
to look for a high privilege permissions

917
00:26:44,880 --> 00:26:47,679
so once you run this script and chris is

918
00:26:47,679 --> 00:26:48,720
going to show you this here in a demo

919
00:26:48,720 --> 00:26:50,320
what should you look for so first of all

920
00:26:50,320 --> 00:26:51,440
look for anything

921
00:26:51,440 --> 00:26:53,600
that has those all principles this means

922
00:26:53,600 --> 00:26:55,039
it's applying to

923
00:26:55,039 --> 00:26:58,320
all users in the tenant so any of those

924
00:26:58,320 --> 00:27:00,400
non-microsoft apps like exchange online

925
00:27:00,400 --> 00:27:01,760
is going to have the sharepoint online

926
00:27:01,760 --> 00:27:03,120
those are things that you would expect

927
00:27:03,120 --> 00:27:04,640
to have those types of permissions but

928
00:27:04,640 --> 00:27:06,880
any other types of applications you want

929
00:27:06,880 --> 00:27:08,559
to make sure you understand again

930
00:27:08,559 --> 00:27:10,720
what is this application and why does it

931
00:27:10,720 --> 00:27:12,080
need these permissions

932
00:27:12,080 --> 00:27:13,520
then start looking for any of those

933
00:27:13,520 --> 00:27:15,039
permissions that have those from the

934
00:27:15,039 --> 00:27:15,840
previous slide

935
00:27:15,840 --> 00:27:17,919
anything read write anything start at

936
00:27:17,919 --> 00:27:19,600
all those are all types of permissions

937
00:27:19,600 --> 00:27:20,880
that we want to make sure we look for so

938
00:27:20,880 --> 00:27:21,279
here

939
00:27:21,279 --> 00:27:22,720
in the slide there's an application

940
00:27:22,720 --> 00:27:25,760
called uipath spo bot file

941
00:27:25,760 --> 00:27:27,520
and it wants the ability to do files

942
00:27:27,520 --> 00:27:30,000
read write all that may be okay

943
00:27:30,000 --> 00:27:31,760
that may not be okay i don't know what

944
00:27:31,760 --> 00:27:33,200
that ui path

945
00:27:33,200 --> 00:27:35,279
spo bot is doing but we want to make

946
00:27:35,279 --> 00:27:36,640
sure we understand that as

947
00:27:36,640 --> 00:27:40,159
administrators and defenders a few other

948
00:27:40,159 --> 00:27:42,399
things we should be looking for as well

949
00:27:42,399 --> 00:27:45,120
we want to look for those high profile

950
00:27:45,120 --> 00:27:46,799
high impact users

951
00:27:46,799 --> 00:27:48,399
these are those types of users that if

952
00:27:48,399 --> 00:27:50,640
someone said did you see it happen to

953
00:27:50,640 --> 00:27:51,760
so-and-so's account

954
00:27:51,760 --> 00:27:54,640
somebody says oh no but they probably

955
00:27:54,640 --> 00:27:56,159
don't use the word no they probably use

956
00:27:56,159 --> 00:27:56,720
an adult

957
00:27:56,720 --> 00:27:58,559
adult word right because those are the

958
00:27:58,559 --> 00:28:00,000
people that have access to very

959
00:28:00,000 --> 00:28:02,080
sensitive data we want to be very very

960
00:28:02,080 --> 00:28:04,320
sure what those people have consented to

961
00:28:04,320 --> 00:28:06,159
their their targets first types of spear

962
00:28:06,159 --> 00:28:07,520
phishing and things like that so look

963
00:28:07,520 --> 00:28:08,480
for those ones

964
00:28:08,480 --> 00:28:09,679
you know who those people are in your

965
00:28:09,679 --> 00:28:11,279
environment go look in this spreadsheet

966
00:28:11,279 --> 00:28:12,000
to see

967
00:28:12,000 --> 00:28:14,640
what have they consented to then we have

968
00:28:14,640 --> 00:28:18,000
the traditional types of you know

969
00:28:18,000 --> 00:28:19,679
malware types of hiding things so things

970
00:28:19,679 --> 00:28:21,520
that are trying to hide right

971
00:28:21,520 --> 00:28:24,480
this app is called email it needs file

972
00:28:24,480 --> 00:28:25,440
read write all

973
00:28:25,440 --> 00:28:27,440
for all principles on microsoft graph

974
00:28:27,440 --> 00:28:28,480
that seems

975
00:28:28,480 --> 00:28:30,480
kind of suspicious apps that have

976
00:28:30,480 --> 00:28:32,080
misspelled names here so this one we got

977
00:28:32,080 --> 00:28:32,720
that

978
00:28:32,720 --> 00:28:34,399
driver's edge with the elite speak in

979
00:28:34,399 --> 00:28:36,159
there chris also showed you that

980
00:28:36,159 --> 00:28:38,159
in her sample we had wood grove but it

981
00:28:38,159 --> 00:28:39,520
was spelled with three

982
00:28:39,520 --> 00:28:41,360
o's instead of the normal two trying to

983
00:28:41,360 --> 00:28:43,520
blend in or just any of those weird

984
00:28:43,520 --> 00:28:44,559
hacker sounding names

985
00:28:44,559 --> 00:28:46,320
intelligence this thing wants data

986
00:28:46,320 --> 00:28:48,399
rewrite all for all principles again

987
00:28:48,399 --> 00:28:50,000
very very privileged what is this

988
00:28:50,000 --> 00:28:53,279
application why does it need that

989
00:28:53,279 --> 00:28:54,880
and then some other things to consider

990
00:28:54,880 --> 00:28:56,320
here as well so

991
00:28:56,320 --> 00:28:58,080
this is just a general indicators that

992
00:28:58,080 --> 00:28:59,440
compromise stuff to look for

993
00:28:59,440 --> 00:29:00,720
this is going to be suspicious

994
00:29:00,720 --> 00:29:02,559
activities outside of like normal office

995
00:29:02,559 --> 00:29:03,360
hours

996
00:29:03,360 --> 00:29:05,200
deviations from their normal behavior

997
00:29:05,200 --> 00:29:07,200
based on you know why is this person in

998
00:29:07,200 --> 00:29:08,640
one department doing something in some

999
00:29:08,640 --> 00:29:10,640
other app they have no business doing

1000
00:29:10,640 --> 00:29:13,279
um date and time of applications being

1001
00:29:13,279 --> 00:29:15,360
created so we've seen this as well where

1002
00:29:15,360 --> 00:29:17,120
the application was created a few days

1003
00:29:17,120 --> 00:29:18,960
ago and now it's being used

1004
00:29:18,960 --> 00:29:21,279
think of this just like how people

1005
00:29:21,279 --> 00:29:22,320
defenders do this

1006
00:29:22,320 --> 00:29:24,720
for domain names right this domain name

1007
00:29:24,720 --> 00:29:25,600
was created

1008
00:29:25,600 --> 00:29:26,880
three or four days ago now we're getting

1009
00:29:26,880 --> 00:29:28,720
a bunch of you know suspicious looking

1010
00:29:28,720 --> 00:29:29,520
emails from it

1011
00:29:29,520 --> 00:29:31,440
that's pretty suspicious same thing with

1012
00:29:31,440 --> 00:29:32,399
applications if we can see the

1013
00:29:32,399 --> 00:29:34,080
application date time was created a few

1014
00:29:34,080 --> 00:29:35,840
days ago looks very suspicious

1015
00:29:35,840 --> 00:29:37,039
we want to go ahead and take a look at

1016
00:29:37,039 --> 00:29:39,279
that as well

1017
00:29:39,279 --> 00:29:40,399
and chris is going to show you the

1018
00:29:40,399 --> 00:29:43,279
output of this script

1019
00:29:43,279 --> 00:29:46,320
yes so if you go ahead and follow the

1020
00:29:46,320 --> 00:29:47,679
guidance from that github

1021
00:29:47,679 --> 00:29:49,679
link you will get and run it in your

1022
00:29:49,679 --> 00:29:51,039
powershell in your environment

1023
00:29:51,039 --> 00:29:53,200
you're going to get a csv file that

1024
00:29:53,200 --> 00:29:54,880
looks kind of like this

1025
00:29:54,880 --> 00:29:56,720
and basically it's just gonna be a bunch

1026
00:29:56,720 --> 00:29:57,760
of columns it's gonna show your

1027
00:29:57,760 --> 00:29:58,640
permission type

1028
00:29:58,640 --> 00:30:01,120
object id display name it's also gonna

1029
00:30:01,120 --> 00:30:02,080
show you like

1030
00:30:02,080 --> 00:30:04,399
um like mark said like look at the the

1031
00:30:04,399 --> 00:30:05,760
consent type if it's going to all

1032
00:30:05,760 --> 00:30:06,799
principles or not

1033
00:30:06,799 --> 00:30:09,360
the type permissions it has and if

1034
00:30:09,360 --> 00:30:10,880
you're a data nerd like me then you

1035
00:30:10,880 --> 00:30:12,240
might want to just like quickly put it

1036
00:30:12,240 --> 00:30:13,679
into some pivot tables

1037
00:30:13,679 --> 00:30:15,120
this way you can quickly see by

1038
00:30:15,120 --> 00:30:16,880
permission and

1039
00:30:16,880 --> 00:30:18,880
the name of the application you can see

1040
00:30:18,880 --> 00:30:20,640
how many have application permissions or

1041
00:30:20,640 --> 00:30:22,159
delegated permissions

1042
00:30:22,159 --> 00:30:24,320
you can also start filtering out by

1043
00:30:24,320 --> 00:30:25,600
directory read write all

1044
00:30:25,600 --> 00:30:27,760
or user read write all things like that

1045
00:30:27,760 --> 00:30:28,720
so

1046
00:30:28,720 --> 00:30:30,720
i definitely recommend doing this it's a

1047
00:30:30,720 --> 00:30:33,200
great tool to learn your environment

1048
00:30:33,200 --> 00:30:35,760
very valuable in in in protecting

1049
00:30:35,760 --> 00:30:37,200
yourself from these type of consent

1050
00:30:37,200 --> 00:30:39,520
attacks

1051
00:30:40,480 --> 00:30:42,399
yeah so go ahead and run that script um

1052
00:30:42,399 --> 00:30:44,480
we're continuing to make improvements to

1053
00:30:44,480 --> 00:30:45,679
it so use that same

1054
00:30:45,679 --> 00:30:47,520
uh same url we'll continue to add things

1055
00:30:47,520 --> 00:30:48,799
to it so okay

1056
00:30:48,799 --> 00:30:51,840
so at this point you've run that script

1057
00:30:51,840 --> 00:30:53,279
you've looked at that output and you

1058
00:30:53,279 --> 00:30:55,840
find something that does not look great

1059
00:30:55,840 --> 00:30:57,519
so how do i start investigating this

1060
00:30:57,519 --> 00:30:59,200
type of stuff so first

1061
00:30:59,200 --> 00:31:01,600
um if it's an office 365 type of

1062
00:31:01,600 --> 00:31:03,120
application so like one of those ones

1063
00:31:03,120 --> 00:31:04,000
that's maybe

1064
00:31:04,000 --> 00:31:05,919
made changes to mailbox rules and things

1065
00:31:05,919 --> 00:31:08,080
like that you can use the

1066
00:31:08,080 --> 00:31:10,799
security and compliance console here to

1067
00:31:10,799 --> 00:31:12,399
search through those logs

1068
00:31:12,399 --> 00:31:13,760
and you can look for those indicators to

1069
00:31:13,760 --> 00:31:15,440
compromise in those keyword settings

1070
00:31:15,440 --> 00:31:16,240
there

1071
00:31:16,240 --> 00:31:19,440
if you know the scope of the attack so

1072
00:31:19,440 --> 00:31:19,760
it's

1073
00:31:19,760 --> 00:31:21,679
it's just exchange or it's just one

1074
00:31:21,679 --> 00:31:24,159
drive selecting that location

1075
00:31:24,159 --> 00:31:26,320
will cut this way down in terms of

1076
00:31:26,320 --> 00:31:27,440
search time you don't have to search for

1077
00:31:27,440 --> 00:31:29,279
everything in office 365 so that's a

1078
00:31:29,279 --> 00:31:30,559
good tip there for you when you're

1079
00:31:30,559 --> 00:31:32,159
starting to investigate

1080
00:31:32,159 --> 00:31:34,559
so you've taken a look there and now

1081
00:31:34,559 --> 00:31:36,399
you're you've confirmed an attack has

1082
00:31:36,399 --> 00:31:36,880
happened

1083
00:31:36,880 --> 00:31:38,960
it's time to start your incident

1084
00:31:38,960 --> 00:31:41,200
response process so the first question i

1085
00:31:41,200 --> 00:31:42,960
want everybody to think about here

1086
00:31:42,960 --> 00:31:46,159
is does your ir process cover this

1087
00:31:46,159 --> 00:31:48,240
scenario of application consent and if

1088
00:31:48,240 --> 00:31:49,360
it doesn't

1089
00:31:49,360 --> 00:31:51,200
that's okay this is the time to start

1090
00:31:51,200 --> 00:31:52,960
thinking about it to talk about it

1091
00:31:52,960 --> 00:31:54,080
to work with that with your different

1092
00:31:54,080 --> 00:31:57,279
teams because if you don't realize

1093
00:31:57,279 --> 00:31:59,039
what's happening with these applications

1094
00:31:59,039 --> 00:32:00,799
and how those permissions works and what

1095
00:32:00,799 --> 00:32:02,399
those things can do

1096
00:32:02,399 --> 00:32:04,720
your traditional ir process will

1097
00:32:04,720 --> 00:32:06,159
probably not cover this and like i said

1098
00:32:06,159 --> 00:32:06,720
earlier

1099
00:32:06,720 --> 00:32:08,240
when you run your tools on the local

1100
00:32:08,240 --> 00:32:10,640
workstation and you don't see anything

1101
00:32:10,640 --> 00:32:11,840
you're not going to see anything because

1102
00:32:11,840 --> 00:32:12,960
it didn't actually take place on that

1103
00:32:12,960 --> 00:32:14,000
workstation there was no

1104
00:32:14,000 --> 00:32:15,600
macro that ran all those traditional

1105
00:32:15,600 --> 00:32:17,039
tools where we work through those types

1106
00:32:17,039 --> 00:32:17,440
of

1107
00:32:17,440 --> 00:32:19,760
you know time-based analysis don't work

1108
00:32:19,760 --> 00:32:20,640
greater on that

1109
00:32:20,640 --> 00:32:22,320
client because it didn't happen on the

1110
00:32:22,320 --> 00:32:23,840
client it happened on the server side so

1111
00:32:23,840 --> 00:32:24,960
we want to make sure

1112
00:32:24,960 --> 00:32:27,760
that our ir process covers this scenario

1113
00:32:27,760 --> 00:32:29,279
and the time to start going through this

1114
00:32:29,279 --> 00:32:30,960
is now not when you've had an attack

1115
00:32:30,960 --> 00:32:33,360
again this isn't something we're seeing

1116
00:32:33,360 --> 00:32:34,720
happening all the time

1117
00:32:34,720 --> 00:32:36,159
but it's starting to emerge so this is

1118
00:32:36,159 --> 00:32:38,159
the time to go build this into your ir

1119
00:32:38,159 --> 00:32:40,000
process so what should you do

1120
00:32:40,000 --> 00:32:41,360
again here disable that malicious

1121
00:32:41,360 --> 00:32:42,880
service principle service principles are

1122
00:32:42,880 --> 00:32:43,919
very important here

1123
00:32:43,919 --> 00:32:46,080
we want to revoke the consent for those

1124
00:32:46,080 --> 00:32:47,679
applications you can revoke

1125
00:32:47,679 --> 00:32:49,279
any of those role assignments remember

1126
00:32:49,279 --> 00:32:50,720
service principles can have roles so

1127
00:32:50,720 --> 00:32:52,159
maybe the application did that

1128
00:32:52,159 --> 00:32:54,080
you can disable a sign in for this and

1129
00:32:54,080 --> 00:32:55,600
then we want to remove any of those

1130
00:32:55,600 --> 00:32:57,120
persistent mechanisms that the

1131
00:32:57,120 --> 00:32:58,880
application may have added

1132
00:32:58,880 --> 00:33:00,880
remember if it adds those mailbox

1133
00:33:00,880 --> 00:33:02,240
forwarding rules and you

1134
00:33:02,240 --> 00:33:04,399
you don't check for that and you just

1135
00:33:04,399 --> 00:33:05,919
remove the application

1136
00:33:05,919 --> 00:33:07,840
you have not removed the attacker those

1137
00:33:07,840 --> 00:33:09,440
mailbox rules are still going to be

1138
00:33:09,440 --> 00:33:10,640
forwarding mail and those things that

1139
00:33:10,640 --> 00:33:11,360
they did so

1140
00:33:11,360 --> 00:33:12,880
we want to make sure we're looking into

1141
00:33:12,880 --> 00:33:14,399
that to make sure

1142
00:33:14,399 --> 00:33:16,640
we fully remove it we don't just remove

1143
00:33:16,640 --> 00:33:17,600
the app or

1144
00:33:17,600 --> 00:33:18,960
disable the application we need to go

1145
00:33:18,960 --> 00:33:20,799
see what they actually change and remove

1146
00:33:20,799 --> 00:33:21,760
those types of

1147
00:33:21,760 --> 00:33:25,840
persistent mechanisms as well

1148
00:33:26,880 --> 00:33:28,240
and with that chris is going to cover

1149
00:33:28,240 --> 00:33:30,159
some best practices we can do to go

1150
00:33:30,159 --> 00:33:31,679
forward here

1151
00:33:31,679 --> 00:33:33,919
yeah so thanks mark so one of the first

1152
00:33:33,919 --> 00:33:34,960
best practices

1153
00:33:34,960 --> 00:33:36,640
that we're recommending to protect

1154
00:33:36,640 --> 00:33:38,399
yourself from app consent attacks

1155
00:33:38,399 --> 00:33:41,120
is to set up some policies and inside

1156
00:33:41,120 --> 00:33:43,120
the azure portal you can decide who can

1157
00:33:43,120 --> 00:33:44,799
consent to applications within your

1158
00:33:44,799 --> 00:33:45,840
organization

1159
00:33:45,840 --> 00:33:48,000
so as you can see in the screenshot on

1160
00:33:48,000 --> 00:33:50,000
the left you have three buttons you can

1161
00:33:50,000 --> 00:33:50,799
prohibit

1162
00:33:50,799 --> 00:33:52,240
all your users from consenting to

1163
00:33:52,240 --> 00:33:54,399
applications whatsoever you can also

1164
00:33:54,399 --> 00:33:56,159
allow all your users to consent to

1165
00:33:56,159 --> 00:33:57,440
applications

1166
00:33:57,440 --> 00:33:58,720
both of these we don't think are the

1167
00:33:58,720 --> 00:34:00,399
best decisions unless it's very specific

1168
00:34:00,399 --> 00:34:01,519
to your environment

1169
00:34:01,519 --> 00:34:03,600
what we do recommend is the middle one

1170
00:34:03,600 --> 00:34:05,840
which is to allow users to consent to

1171
00:34:05,840 --> 00:34:06,480
apps

1172
00:34:06,480 --> 00:34:08,719
that are from verified publishers and

1173
00:34:08,719 --> 00:34:10,239
they're for selected permissions that

1174
00:34:10,239 --> 00:34:12,239
you decided as an organization are

1175
00:34:12,239 --> 00:34:13,040
considered

1176
00:34:13,040 --> 00:34:16,159
low impact and safe so another option

1177
00:34:16,159 --> 00:34:18,239
shown on the right hand side in the

1178
00:34:18,239 --> 00:34:19,760
right hand side screenshot there

1179
00:34:19,760 --> 00:34:21,679
is if you have mcas which is microsoft

1180
00:34:21,679 --> 00:34:23,280
cloud app security that mark mentioned

1181
00:34:23,280 --> 00:34:23,918
earlier

1182
00:34:23,918 --> 00:34:26,159
you can set up app permission policies

1183
00:34:26,159 --> 00:34:27,839
which will automatically revoke

1184
00:34:27,839 --> 00:34:30,719
an app or a user from a specific app

1185
00:34:30,719 --> 00:34:32,839
based on certain detections in your

1186
00:34:32,839 --> 00:34:35,839
environment

1187
00:34:37,119 --> 00:34:38,480
so the second best practice that we

1188
00:34:38,480 --> 00:34:40,560
recommend is to use and track

1189
00:34:40,560 --> 00:34:43,679
risk-based user consent so what is this

1190
00:34:43,679 --> 00:34:46,480
step up consent when a risky request is

1191
00:34:46,480 --> 00:34:47,280
detected

1192
00:34:47,280 --> 00:34:48,719
the request will be stepped up to

1193
00:34:48,719 --> 00:34:50,800
require admin approval so as you saw in

1194
00:34:50,800 --> 00:34:51,679
my demo

1195
00:34:51,679 --> 00:34:53,760
users and admins will see this warning

1196
00:34:53,760 --> 00:34:55,440
but the admins will have the ability to

1197
00:34:55,440 --> 00:34:56,560
approve it

1198
00:34:56,560 --> 00:34:58,640
on behalf of the entire organization so

1199
00:34:58,640 --> 00:34:59,839
when this happens

1200
00:34:59,839 --> 00:35:02,400
also an audit event will be logged and

1201
00:35:02,400 --> 00:35:03,359
as we all know

1202
00:35:03,359 --> 00:35:05,920
like logs are only as useful if we use

1203
00:35:05,920 --> 00:35:07,599
them and check them and take action on

1204
00:35:07,599 --> 00:35:08,320
them so

1205
00:35:08,320 --> 00:35:10,240
as admins you want to have a process in

1206
00:35:10,240 --> 00:35:12,480
place with your requests coming in

1207
00:35:12,480 --> 00:35:14,079
don't just let them hang there it's

1208
00:35:14,079 --> 00:35:15,599
important to assign owners

1209
00:35:15,599 --> 00:35:17,280
to clarify which factors could be

1210
00:35:17,280 --> 00:35:18,960
considered should be considered

1211
00:35:18,960 --> 00:35:22,000
um to grant or deny permissions and then

1212
00:35:22,000 --> 00:35:22,960
once that admin

1213
00:35:22,960 --> 00:35:24,960
grants consent no other users will see

1214
00:35:24,960 --> 00:35:26,880
that warning for that particular app

1215
00:35:26,880 --> 00:35:31,839
and it will be now in your environment

1216
00:35:32,320 --> 00:35:34,960
so number three is to detect risky oauth

1217
00:35:34,960 --> 00:35:35,520
apps

1218
00:35:35,520 --> 00:35:37,119
so now that you've protected yourself

1219
00:35:37,119 --> 00:35:38,720
from any illicit apps you might

1220
00:35:38,720 --> 00:35:40,800
encounter in the future you can't forget

1221
00:35:40,800 --> 00:35:42,560
about the apps that might already be

1222
00:35:42,560 --> 00:35:42,960
there

1223
00:35:42,960 --> 00:35:45,680
so there's a good better best approach

1224
00:35:45,680 --> 00:35:46,560
to this

1225
00:35:46,560 --> 00:35:47,920
but most importantly we just want you to

1226
00:35:47,920 --> 00:35:49,680
do something about it and to monitor it

1227
00:35:49,680 --> 00:35:50,800
on the regular

1228
00:35:50,800 --> 00:35:52,880
so the script i showed you go do that

1229
00:35:52,880 --> 00:35:54,960
it's a great place to start

1230
00:35:54,960 --> 00:35:56,480
it does require like i said a little bit

1231
00:35:56,480 --> 00:35:57,839
of manual work and looking through the

1232
00:35:57,839 --> 00:35:58,560
data

1233
00:35:58,560 --> 00:36:00,240
but you'll get to know your environment

1234
00:36:00,240 --> 00:36:01,599
by combing through the apps and the

1235
00:36:01,599 --> 00:36:02,480
permissions

1236
00:36:02,480 --> 00:36:04,480
and identifying anything that might look

1237
00:36:04,480 --> 00:36:06,880
over privileged or questionable

1238
00:36:06,880 --> 00:36:09,680
so better yet we recommend using azure

1239
00:36:09,680 --> 00:36:11,280
monitor to set up alerts that will

1240
00:36:11,280 --> 00:36:13,280
automate that process for you so

1241
00:36:13,280 --> 00:36:15,520
you can set up notifications that when

1242
00:36:15,520 --> 00:36:16,880
an oauth

1243
00:36:16,880 --> 00:36:19,200
requires super high security permissions

1244
00:36:19,200 --> 00:36:20,320
or um

1245
00:36:20,320 --> 00:36:22,079
is authorized for a big chunk of users

1246
00:36:22,079 --> 00:36:23,680
you'll get notifications and emails for

1247
00:36:23,680 --> 00:36:25,520
that

1248
00:36:25,520 --> 00:36:27,680
and then the ideal option is to do some

1249
00:36:27,680 --> 00:36:30,079
risky app hunting with a cosby solution

1250
00:36:30,079 --> 00:36:32,720
such as mcas you can filter and find

1251
00:36:32,720 --> 00:36:34,480
apps that are potentially very risky or

1252
00:36:34,480 --> 00:36:34,960
that

1253
00:36:34,960 --> 00:36:36,720
users consented to not knowing the

1254
00:36:36,720 --> 00:36:38,560
potential risk so some of the things you

1255
00:36:38,560 --> 00:36:39,359
can filter on

1256
00:36:39,359 --> 00:36:42,320
are high permissions not common use or

1257
00:36:42,320 --> 00:36:46,320
authorizations by external users

1258
00:36:48,079 --> 00:36:51,200
and the fourth one is for developers so

1259
00:36:51,200 --> 00:36:51,920
developers

1260
00:36:51,920 --> 00:36:54,320
check your app it might be and it

1261
00:36:54,320 --> 00:36:55,520
probably is

1262
00:36:55,520 --> 00:36:57,599
over privileged we're seeing new

1263
00:36:57,599 --> 00:36:59,040
permissions and we're putting out new

1264
00:36:59,040 --> 00:37:00,640
permissions all the time

1265
00:37:00,640 --> 00:37:02,640
here at microsoft so it makes it really

1266
00:37:02,640 --> 00:37:04,560
easy to scope with granular

1267
00:37:04,560 --> 00:37:06,560
scope your app to granular permissions

1268
00:37:06,560 --> 00:37:08,320
and one of the common things that we see

1269
00:37:08,320 --> 00:37:10,480
with line of business apps especially

1270
00:37:10,480 --> 00:37:12,000
is that devs are not following least

1271
00:37:12,000 --> 00:37:14,240
privilege so this is by no means a new

1272
00:37:14,240 --> 00:37:15,119
problem as you

1273
00:37:15,119 --> 00:37:17,200
heard mark mentioned earlier but we

1274
00:37:17,200 --> 00:37:18,800
really want to encourage developers to

1275
00:37:18,800 --> 00:37:19,920
follow these privilege

1276
00:37:19,920 --> 00:37:22,720
and only ask for what is necessary take

1277
00:37:22,720 --> 00:37:24,320
a look at the guidance that we put here

1278
00:37:24,320 --> 00:37:25,200
in the deck

1279
00:37:25,200 --> 00:37:26,880
those are super helpful links to get

1280
00:37:26,880 --> 00:37:28,640
started

1281
00:37:28,640 --> 00:37:30,400
and then in terms of teams it's becoming

1282
00:37:30,400 --> 00:37:31,680
more and more popular

1283
00:37:31,680 --> 00:37:33,200
we want to make sure that apps can only

1284
00:37:33,200 --> 00:37:35,119
access the teams they really need so

1285
00:37:35,119 --> 00:37:37,119
take a look here at the team's specific

1286
00:37:37,119 --> 00:37:38,560
permissions we've

1287
00:37:38,560 --> 00:37:42,079
included a link as well and last but not

1288
00:37:42,079 --> 00:37:44,320
least we highly recommend

1289
00:37:44,320 --> 00:37:46,560
this developer guidance it's a identity

1290
00:37:46,560 --> 00:37:48,400
identity developer series

1291
00:37:48,400 --> 00:37:51,119
but we recommend it for all it pros and

1292
00:37:51,119 --> 00:37:52,640
all devs to watch

1293
00:37:52,640 --> 00:37:55,520
so i you will not regret it i watched it

1294
00:37:55,520 --> 00:37:57,280
and you'll learn so much from this video

1295
00:37:57,280 --> 00:37:58,720
series i don't have a developer

1296
00:37:58,720 --> 00:37:59,599
background

1297
00:37:59,599 --> 00:38:02,240
but i made i learned a ton about api

1298
00:38:02,240 --> 00:38:02,800
calls

1299
00:38:02,800 --> 00:38:05,040
you know to microsoft graph permissions

1300
00:38:05,040 --> 00:38:05,839
and scopes

1301
00:38:05,839 --> 00:38:08,240
access tokens client credential flow all

1302
00:38:08,240 --> 00:38:09,680
of this is super valuable and

1303
00:38:09,680 --> 00:38:12,240
we recommend it both to it pros and devs

1304
00:38:12,240 --> 00:38:14,560
alike

1305
00:38:15,520 --> 00:38:17,839
and finally make sure to report

1306
00:38:17,839 --> 00:38:19,440
suspicious apps back to us

1307
00:38:19,440 --> 00:38:20,960
you can report them directly on the

1308
00:38:20,960 --> 00:38:22,640
consent screen as you see in the

1309
00:38:22,640 --> 00:38:24,000
screenshot here

1310
00:38:24,000 --> 00:38:27,359
or using mcas

1311
00:38:28,480 --> 00:38:30,560
all right so let's recap with some go

1312
00:38:30,560 --> 00:38:31,680
do's so

1313
00:38:31,680 --> 00:38:33,920
do inventory your applications and their

1314
00:38:33,920 --> 00:38:35,599
permissions it's always important to

1315
00:38:35,599 --> 00:38:36,880
know what's in your environment so this

1316
00:38:36,880 --> 00:38:38,320
is not a waste of time and you know

1317
00:38:38,320 --> 00:38:38,720
we've

1318
00:38:38,720 --> 00:38:40,880
shown you some great tools to do so

1319
00:38:40,880 --> 00:38:43,280
automate threat response where possible

1320
00:38:43,280 --> 00:38:44,960
educate your org on these consent

1321
00:38:44,960 --> 00:38:46,480
attacks as mark

1322
00:38:46,480 --> 00:38:47,760
mentioned this is not something that

1323
00:38:47,760 --> 00:38:49,599
we're seeing a ton of yet but it is

1324
00:38:49,599 --> 00:38:51,040
starting to happen and we want people to

1325
00:38:51,040 --> 00:38:52,720
be aware of it

1326
00:38:52,720 --> 00:38:54,640
and then lastly educate your developers

1327
00:38:54,640 --> 00:38:55,839
to make sure they follow the best

1328
00:38:55,839 --> 00:39:00,720
security practices will leave you with

1329
00:39:00,720 --> 00:39:02,160
some helpful resources

1330
00:39:02,160 --> 00:39:03,920
and then before we open up to questions

1331
00:39:03,920 --> 00:39:05,200
and answers so

1332
00:39:05,200 --> 00:39:07,599
thank you for attending b-sides and we

1333
00:39:07,599 --> 00:39:09,119
really look forward to your feedback on

1334
00:39:09,119 --> 00:39:14,000
our session

