1
00:00:15,700 --> 00:00:21,430
my name is Wes Widener I'm from mcafee

2
00:00:21,430 --> 00:00:23,380
global threat intelligence and most

3
00:00:23,380 --> 00:00:27,040
recently with Norse if you you're

4
00:00:27,040 --> 00:00:28,900
looking for some good lols go Google

5
00:00:28,900 --> 00:00:34,450
Norse lots of fun stories there so while

6
00:00:34,450 --> 00:00:37,180
it Norse I was tasked with setting up a

7
00:00:37,180 --> 00:00:39,219
malware pipeline and that's where all of

8
00:00:39,219 --> 00:00:41,130
this talk comes from it's basically a

9
00:00:41,130 --> 00:00:42,940
presentation I wish I had given to

10
00:00:42,940 --> 00:00:45,870
myself before I started on this project

11
00:00:45,870 --> 00:00:48,340
there was a lot of lessons learned and a

12
00:00:48,340 --> 00:00:51,430
lot of a lot of wrong avenues to go down

13
00:00:51,430 --> 00:00:55,630
so first off need to talk about what a

14
00:00:55,630 --> 00:00:58,000
pipeline is some of you may be familiar

15
00:00:58,000 --> 00:01:00,370
with pipelining instructions through a

16
00:01:00,370 --> 00:01:04,089
CPU simply put a pipeline is just an

17
00:01:04,089 --> 00:01:07,240
operation on a set of objects in order

18
00:01:07,240 --> 00:01:10,960
to produce some sort of outcome but

19
00:01:10,960 --> 00:01:13,329
what's a malware pipeline malware

20
00:01:13,329 --> 00:01:16,090
pipeline is taking malware as you might

21
00:01:16,090 --> 00:01:18,579
imagine as the the raw feed coming in

22
00:01:18,579 --> 00:01:21,880
and coming up with intelligence based

23
00:01:21,880 --> 00:01:24,009
off of that malware now we'll get into

24
00:01:24,009 --> 00:01:26,319
what that really means later what type

25
00:01:26,319 --> 00:01:29,109
of intelligence to bring out but another

26
00:01:29,109 --> 00:01:30,969
key thing to keep in mind is that the

27
00:01:30,969 --> 00:01:33,909
malware doesn't want to be analyzed most

28
00:01:33,909 --> 00:01:36,159
people don't realize it but malware

29
00:01:36,159 --> 00:01:38,590
actually has a natural enemy that is the

30
00:01:38,590 --> 00:01:41,380
automated researcher who will go through

31
00:01:41,380 --> 00:01:42,880
and just download a buttload of malware

32
00:01:42,880 --> 00:01:45,850
try to pull it apart and then pick out

33
00:01:45,850 --> 00:01:49,649
interesting bits from it so malware

34
00:01:49,649 --> 00:01:52,779
routinely employees what would be their

35
00:01:52,779 --> 00:01:55,689
version of an antivirus or an anti mount

36
00:01:55,689 --> 00:01:58,840
and anti hunting hunting stuff and we'll

37
00:01:58,840 --> 00:02:01,869
talk about the unique challenges that

38
00:02:01,869 --> 00:02:04,869
poses at every step of the pipeline so

39
00:02:04,869 --> 00:02:10,330
at McAfee Norse now at CrowdStrike

40
00:02:10,330 --> 00:02:12,580
common theme in my careers that I've

41
00:02:12,580 --> 00:02:14,140
worked in the intersection of big data

42
00:02:14,140 --> 00:02:18,340
and threat intelligence malicious stuff

43
00:02:18,340 --> 00:02:20,590
and before I keep on going I want to

44
00:02:20,590 --> 00:02:21,940
point out that pretty much everything

45
00:02:21,940 --> 00:02:23,170
that I'm going to reference here is

46
00:02:23,170 --> 00:02:29,250
malicious so buyer beware the

47
00:02:29,250 --> 00:02:32,230
so intersection of big data and malware

48
00:02:32,230 --> 00:02:37,000
that means that I'm trying to use tools

49
00:02:37,000 --> 00:02:40,270
to automatically pull in and run

50
00:02:40,270 --> 00:02:42,400
intelligence run it run analysis on this

51
00:02:42,400 --> 00:02:45,790
data but it's not just big data in the

52
00:02:45,790 --> 00:02:48,550
in the typical sense this is data that

53
00:02:48,550 --> 00:02:54,000
fights back at every step of the way so

54
00:02:54,000 --> 00:02:57,040
another key point why would you want to

55
00:02:57,040 --> 00:03:00,400
set up a malware pipeline it's not just

56
00:03:00,400 --> 00:03:05,110
for security companies anymore malware

57
00:03:05,110 --> 00:03:07,150
pipelines are used all over the place

58
00:03:07,150 --> 00:03:09,010
but here are some of the products that

59
00:03:09,010 --> 00:03:11,640
you can pull out of a malware pipeline

60
00:03:11,640 --> 00:03:15,610
seed data for malware researchers like

61
00:03:15,610 --> 00:03:17,440
the gentleman that was just here before

62
00:03:17,440 --> 00:03:18,910
me and I think the one that's going to

63
00:03:18,910 --> 00:03:20,950
come after me both malware researchers

64
00:03:20,950 --> 00:03:23,489
malware pipelines help augment their

65
00:03:23,489 --> 00:03:28,209
their efforts presenting relationship

66
00:03:28,209 --> 00:03:29,890
between threats we're talking about

67
00:03:29,890 --> 00:03:32,829
different classes of threats so file

68
00:03:32,829 --> 00:03:37,750
threats to ip's domains all of that ends

69
00:03:37,750 --> 00:03:39,760
up building what's called a threat map

70
00:03:39,760 --> 00:03:43,090
or a threat graph so all of that stuff

71
00:03:43,090 --> 00:03:47,860
is related to each other previously just

72
00:03:47,860 --> 00:03:49,420
to give you an idea of what's changed in

73
00:03:49,420 --> 00:03:52,660
the industry at McAfee in the global

74
00:03:52,660 --> 00:03:54,850
threat intelligence department they

75
00:03:54,850 --> 00:03:57,250
would track each threat as a separate

76
00:03:57,250 --> 00:04:00,459
category so malicious domains over here

77
00:04:00,459 --> 00:04:02,950
malicious files over here malicious IPS

78
00:04:02,950 --> 00:04:06,150
over here but the problem is a threat is

79
00:04:06,150 --> 00:04:09,810
really a combination of these different

80
00:04:09,810 --> 00:04:13,930
utilities so it would be helpful to show

81
00:04:13,930 --> 00:04:16,570
people the the connection and that's

82
00:04:16,570 --> 00:04:17,709
actually one of the things that Norse

83
00:04:17,709 --> 00:04:19,839
was known for was the map where we

84
00:04:19,839 --> 00:04:23,800
combined some of that data so third

85
00:04:23,800 --> 00:04:26,260
point here or third product of a malware

86
00:04:26,260 --> 00:04:30,880
pipeline is providing data to train

87
00:04:30,880 --> 00:04:34,570
predictive models there is an enormous

88
00:04:34,570 --> 00:04:37,539
amount of malware that is out there but

89
00:04:37,539 --> 00:04:39,330
there's not a whole lot of new malware

90
00:04:39,330 --> 00:04:41,620
how many of you have ever played around

91
00:04:41,620 --> 00:04:42,409
with a malware

92
00:04:42,409 --> 00:04:45,039
building application like meterpreter or

93
00:04:45,039 --> 00:04:47,689
there used to be something way back when

94
00:04:47,689 --> 00:04:50,839
I was in Middle School of a malware lab

95
00:04:50,839 --> 00:04:52,309
where you could just point and click I

96
00:04:52,309 --> 00:04:54,949
want this capability and this capability

97
00:04:54,949 --> 00:04:56,659
and it would actually go and build the

98
00:04:56,659 --> 00:04:59,809
dot-com file at the or the dot exe that

99
00:04:59,809 --> 00:05:03,469
those types of tools make it easy to

100
00:05:03,469 --> 00:05:05,719
generate a brand new piece of malware

101
00:05:05,719 --> 00:05:08,139
brand new meaning that it has a new hash

102
00:05:08,139 --> 00:05:11,719
so we need a better way to detect

103
00:05:11,719 --> 00:05:16,339
malware not just hash based in fact many

104
00:05:16,339 --> 00:05:18,559
people realize several years ago that

105
00:05:18,559 --> 00:05:21,739
hash based analysis is pretty much

106
00:05:21,739 --> 00:05:23,360
broken it's dying and it's never going

107
00:05:23,360 --> 00:05:27,919
to come back so predictive models along

108
00:05:27,919 --> 00:05:30,409
with that generating rules for automated

109
00:05:30,409 --> 00:05:32,419
protection systems like Yara rules or

110
00:05:32,419 --> 00:05:34,639
snort rules someone asked in the last

111
00:05:34,639 --> 00:05:38,659
session about Yara rules generating Yara

112
00:05:38,659 --> 00:05:42,259
rules to find ransomware there's

113
00:05:42,259 --> 00:05:44,179
different ways to generate Yara rules

114
00:05:44,179 --> 00:05:46,849
the most basic would be if you see this

115
00:05:46,849 --> 00:05:49,939
hash then it's bad that's pretty much it

116
00:05:49,939 --> 00:05:52,879
would be one of the fastest but also not

117
00:05:52,879 --> 00:05:57,649
one of the most expansive so generating

118
00:05:57,649 --> 00:05:59,929
better rules is what we're here or is

119
00:05:59,929 --> 00:06:01,519
what we're looking for with a malware

120
00:06:01,519 --> 00:06:03,909
pipeline what we'd like to do is say

121
00:06:03,909 --> 00:06:05,479
here's a bunch of different

122
00:06:05,479 --> 00:06:08,209
characteristics that these files display

123
00:06:08,209 --> 00:06:11,329
and if they show these characteristics

124
00:06:11,329 --> 00:06:15,649
block and we can only do that with a

125
00:06:15,649 --> 00:06:20,719
large sample set so another product of a

126
00:06:20,719 --> 00:06:22,159
malware pipeline is to build better

127
00:06:22,159 --> 00:06:27,259
malware some clients really just don't

128
00:06:27,259 --> 00:06:30,649
want to blue team or block malware they

129
00:06:30,649 --> 00:06:32,929
would like to peek over the fence and

130
00:06:32,929 --> 00:06:36,559
see what others have been doing how

131
00:06:36,559 --> 00:06:39,039
they've been hiding from different

132
00:06:39,039 --> 00:06:43,489
detection systems and yeah use that to

133
00:06:43,489 --> 00:06:45,829
build better malware and the final one

134
00:06:45,829 --> 00:06:49,969
is just for lulz and profit it's

135
00:06:49,969 --> 00:06:51,499
actually kind of fun to go through and

136
00:06:51,499 --> 00:06:55,699
play with malware and we saw a video

137
00:06:55,699 --> 00:06:56,510
presentation

138
00:06:56,510 --> 00:06:58,310
now we're taking over a system that

139
00:06:58,310 --> 00:07:00,860
thick stuff is kind of fun and I'll tell

140
00:07:00,860 --> 00:07:02,420
you about some of my exploits on that in

141
00:07:02,420 --> 00:07:06,070
just a little bit oh and this is a

142
00:07:06,070 --> 00:07:11,030
smaller sample size of people so if you

143
00:07:11,030 --> 00:07:13,280
have any questions feel free to throw

144
00:07:13,280 --> 00:07:14,840
them out at me I don't want it to just

145
00:07:14,840 --> 00:07:18,500
be a information dump but if there's no

146
00:07:18,500 --> 00:07:19,940
questions and I'm just going to keep on

147
00:07:19,940 --> 00:07:23,750
cruising so who uses malware pipelines I

148
00:07:23,750 --> 00:07:27,320
was asking earlier about the security

149
00:07:27,320 --> 00:07:29,000
community around here and what it looks

150
00:07:29,000 --> 00:07:31,340
like because most communities have a

151
00:07:31,340 --> 00:07:34,640
different flavor for example Huntsville

152
00:07:34,640 --> 00:07:38,420
tends to be more aerospace and Augusta

153
00:07:38,420 --> 00:07:41,270
tends to be more that's where the cyber

154
00:07:41,270 --> 00:07:43,760
security headquarters of the nation is

155
00:07:43,760 --> 00:07:46,670
kind of moving so now we're pipelines

156
00:07:46,670 --> 00:07:49,720
though are used all over the place in

157
00:07:49,720 --> 00:07:52,970
well of course by infoset companies by

158
00:07:52,970 --> 00:07:55,750
big real big box realtor realest or

159
00:07:55,750 --> 00:08:00,760
retail giant's banks airlines and

160
00:08:00,760 --> 00:08:03,740
manufacturers everybody has their own

161
00:08:03,740 --> 00:08:06,140
malware pipeline these days for a good

162
00:08:06,140 --> 00:08:08,180
reason to if you really want to protect

163
00:08:08,180 --> 00:08:10,460
your users one of the best things you

164
00:08:10,460 --> 00:08:13,910
can do as us as a security team is to

165
00:08:13,910 --> 00:08:16,970
stand up one or more computers that no

166
00:08:16,970 --> 00:08:19,100
one is going to actually use for work

167
00:08:19,100 --> 00:08:21,380
but they're basically honey pots in your

168
00:08:21,380 --> 00:08:23,660
network they mimic what a user would

169
00:08:23,660 --> 00:08:26,210
have so if you're if you're getting a

170
00:08:26,210 --> 00:08:27,650
whole bunch of emails that are coming in

171
00:08:27,650 --> 00:08:31,310
that looks suspicious have a clean

172
00:08:31,310 --> 00:08:33,860
system set up that you can open those on

173
00:08:33,860 --> 00:08:38,780
and see if they are malicious and I

174
00:08:38,780 --> 00:08:43,840
guess I'm supposed to add the obligatory

175
00:08:43,840 --> 00:08:46,190
firewall that system off and all that

176
00:08:46,190 --> 00:08:49,670
other good stuff otherwise you could

177
00:08:49,670 --> 00:08:56,020
shoot yourself in the foot yes exactly

178
00:08:56,020 --> 00:09:00,050
so this talk used to have three

179
00:09:00,050 --> 00:09:03,410
different sections sources mining and I

180
00:09:03,410 --> 00:09:05,870
would go into the data mining part but I

181
00:09:05,870 --> 00:09:07,730
realized that the data mining part

182
00:09:07,730 --> 00:09:10,200
actually stretched it way too far

183
00:09:10,200 --> 00:09:12,210
so I supplemented that with more hands

184
00:09:12,210 --> 00:09:14,280
on how to do this stuff so now we're

185
00:09:14,280 --> 00:09:17,700
just going to do sources and feature

186
00:09:17,700 --> 00:09:19,980
generation out of those sources but if

187
00:09:19,980 --> 00:09:21,510
you want to know about the data mining

188
00:09:21,510 --> 00:09:25,260
portion email me afterwards and out I'll

189
00:09:25,260 --> 00:09:26,610
give you some more information on that

190
00:09:26,610 --> 00:09:32,750
so to start with sources I guess my

191
00:09:32,750 --> 00:09:35,160
daughters pretty much learned that if

192
00:09:35,160 --> 00:09:39,930
she comes upon a minecraft mod and it

193
00:09:39,930 --> 00:09:43,650
looks suspicious she'sshe's I've drilled

194
00:09:43,650 --> 00:09:45,420
it into her take her computer to dad dad

195
00:09:45,420 --> 00:09:47,820
will be ecstatically happy that there's

196
00:09:47,820 --> 00:09:49,620
more malware for me whenever somebody

197
00:09:49,620 --> 00:09:53,130
sends a whenever I get something like

198
00:09:53,130 --> 00:09:57,900
this an email which I haven't looked at

199
00:09:57,900 --> 00:09:59,790
oh maybe I don't have it on this

200
00:09:59,790 --> 00:10:03,750
computer nope so anyway whenever I get a

201
00:10:03,750 --> 00:10:06,090
malicious word document or PDF or

202
00:10:06,090 --> 00:10:08,100
something like that I'll stash those to

203
00:10:08,100 --> 00:10:11,840
the side and look at those later but

204
00:10:11,840 --> 00:10:14,930
even though we stumble upon malware

205
00:10:14,930 --> 00:10:17,700
setting up a pipeline is actually not

206
00:10:17,700 --> 00:10:20,640
that easy you can find one or two pieces

207
00:10:20,640 --> 00:10:23,430
of malware pretty simply but what we're

208
00:10:23,430 --> 00:10:26,160
looking for here is a flood of malware

209
00:10:26,160 --> 00:10:30,120
so there's basically two to general

210
00:10:30,120 --> 00:10:33,900
broad areas of where to find malware the

211
00:10:33,900 --> 00:10:36,120
most important are the one that if

212
00:10:36,120 --> 00:10:37,590
you're in the threat intelligence

213
00:10:37,590 --> 00:10:39,900
business the one that everybody wants is

214
00:10:39,900 --> 00:10:42,000
the organic malware these are live

215
00:10:42,000 --> 00:10:46,440
malicious links these are these are the

216
00:10:46,440 --> 00:10:48,720
malware in the wild actively malicious

217
00:10:48,720 --> 00:10:52,590
now the problem with that is malware has

218
00:10:52,590 --> 00:10:55,700
a half-life of less than 24 hours

219
00:10:55,700 --> 00:11:02,960
especially URLs because sites like um Oh

220
00:11:03,530 --> 00:11:06,360
AWS and Rackspace and all these hosting

221
00:11:06,360 --> 00:11:08,130
sites they're very quick to take these

222
00:11:08,130 --> 00:11:11,520
links down because of that malware has

223
00:11:11,520 --> 00:11:14,580
gotten highly automated one of the

224
00:11:14,580 --> 00:11:17,700
automated things that malware uses a lot

225
00:11:17,700 --> 00:11:19,890
of is called domain generated algorithms

226
00:11:19,890 --> 00:11:23,730
a malware author will reg

227
00:11:23,730 --> 00:11:27,570
sir hundred or so domain names and then

228
00:11:27,570 --> 00:11:30,209
their malware will be set up in such a

229
00:11:30,209 --> 00:11:32,310
way that it would generate one of those

230
00:11:32,310 --> 00:11:35,130
domain names to reach out to and so they

231
00:11:35,130 --> 00:11:37,260
basically have their own ad hoc network

232
00:11:37,260 --> 00:11:40,380
that they've set up so they count on

233
00:11:40,380 --> 00:11:43,680
being taken down very quickly as someone

234
00:11:43,680 --> 00:11:46,079
who wants to go find that I have to keep

235
00:11:46,079 --> 00:11:48,600
that in mind because what that looks

236
00:11:48,600 --> 00:11:51,180
like is if I'm running an automated

237
00:11:51,180 --> 00:11:53,579
script to go pull malware first I'm

238
00:11:53,579 --> 00:11:55,740
going to have to find lists of malware

239
00:11:55,740 --> 00:11:58,290
to go find and I actually have a handout

240
00:11:58,290 --> 00:11:59,699
that accompanies this talk that has

241
00:11:59,699 --> 00:12:01,350
several different free lists that you

242
00:12:01,350 --> 00:12:05,670
can use if you want but one thing about

243
00:12:05,670 --> 00:12:07,649
these lists are you're going to have a

244
00:12:07,649 --> 00:12:10,440
very low yield of actual bad malware

245
00:12:10,440 --> 00:12:12,209
that comes from that you're able to

246
00:12:12,209 --> 00:12:14,760
download number one just because of this

247
00:12:14,760 --> 00:12:17,459
the host get taken down so fast the

248
00:12:17,459 --> 00:12:21,779
second thing is a lot of these links are

249
00:12:21,779 --> 00:12:23,880
set up to not actually give you the

250
00:12:23,880 --> 00:12:26,130
payload of malware unless you prove that

251
00:12:26,130 --> 00:12:27,839
you're that you're a user that you're a

252
00:12:27,839 --> 00:12:31,019
gullible user because of that we need to

253
00:12:31,019 --> 00:12:32,850
set up what are called either honey pots

254
00:12:32,850 --> 00:12:36,889
or honey clients a honey pot is just a

255
00:12:36,889 --> 00:12:40,230
think of it as a computer that signals

256
00:12:40,230 --> 00:12:41,730
that it's really vulnerable and you

257
00:12:41,730 --> 00:12:44,069
could come and do bad things to it or a

258
00:12:44,069 --> 00:12:45,810
honey client is the same thing but with

259
00:12:45,810 --> 00:12:51,120
a browser and there are two free

260
00:12:51,120 --> 00:12:54,870
utilities I want to point out here along

261
00:12:54,870 --> 00:12:58,050
those lines in the talk I don't know if

262
00:12:58,050 --> 00:13:00,180
the description pointed out that I I was

263
00:13:00,180 --> 00:13:02,550
going to use some docker examples what's

264
00:13:02,550 --> 00:13:05,730
that in the description it doesn't

265
00:13:05,730 --> 00:13:08,970
matter yeah I think I pointed that out

266
00:13:08,970 --> 00:13:10,829
in the description but anyway one of the

267
00:13:10,829 --> 00:13:12,329
cool things about this and I have a

268
00:13:12,329 --> 00:13:14,130
slide on this a little bit later a lot

269
00:13:14,130 --> 00:13:18,089
of these security tools are pull or are

270
00:13:18,089 --> 00:13:22,500
freely available from docker as a full

271
00:13:22,500 --> 00:13:26,130
complete system so the first one that I

272
00:13:26,130 --> 00:13:32,209
point out is mal trev

273
00:13:40,429 --> 00:13:45,300
so mal triva is a utility that has all

274
00:13:45,300 --> 00:13:48,540
kinds of free malware sources and these

275
00:13:48,540 --> 00:13:50,730
are usually these are organic and for

276
00:13:50,730 --> 00:13:52,290
those of you taking notes I'll have a

277
00:13:52,290 --> 00:13:54,660
handout that i'll send you a little bit

278
00:13:54,660 --> 00:13:57,990
I guess their network here is not going

279
00:13:57,990 --> 00:14:00,720
to allow me to pull down malware that's

280
00:14:00,720 --> 00:14:03,540
kind of sad but any rate this utility

281
00:14:03,540 --> 00:14:06,179
will go out pull from these lists of

282
00:14:06,179 --> 00:14:07,949
free malware sources and then go try to

283
00:14:07,949 --> 00:14:11,720
download those pieces of malware the I

284
00:14:11,720 --> 00:14:14,189
think I'm competing with others for

285
00:14:14,189 --> 00:14:16,619
wireless space too but thankfully I

286
00:14:16,619 --> 00:14:19,439
travel with an entire hard drive of

287
00:14:19,439 --> 00:14:21,809
malware just because it makes me feel

288
00:14:21,809 --> 00:14:25,259
all warm and fuzzy the somme altri will

289
00:14:25,259 --> 00:14:28,019
go out and it will pull down malware

290
00:14:28,019 --> 00:14:31,889
usually in well look at that get into

291
00:14:31,889 --> 00:14:33,899
that in just second the other utility is

292
00:14:33,899 --> 00:14:39,449
called Thug thug is a honey client it it

293
00:14:39,449 --> 00:14:42,959
mimics of vulnerable browsers so there

294
00:14:42,959 --> 00:14:48,929
was some the dire that dy re these

295
00:14:48,929 --> 00:14:51,149
pronounce that I've only seen it in text

296
00:14:51,149 --> 00:14:55,529
you don't know do what dry it dried it

297
00:14:55,529 --> 00:14:58,470
yeah that flavor of malware there was at

298
00:14:58,470 --> 00:15:00,720
least one strain that wouldn't download

299
00:15:00,720 --> 00:15:04,499
unless you unless it detected several

300
00:15:04,499 --> 00:15:07,170
features in the browser like one very

301
00:15:07,170 --> 00:15:09,179
obvious one the browser had to have a

302
00:15:09,179 --> 00:15:11,100
view window of greater than zero by the

303
00:15:11,100 --> 00:15:13,619
hero pixels because headless browsers

304
00:15:13,619 --> 00:15:16,259
that's what they report and that's

305
00:15:16,259 --> 00:15:18,240
pretty easy for the malware author to

306
00:15:18,240 --> 00:15:20,639
say it's probably a spider and I'm not

307
00:15:20,639 --> 00:15:24,389
going to give you the payload so other

308
00:15:24,389 --> 00:15:26,790
places to look for organic sources p

309
00:15:26,790 --> 00:15:29,279
caps I didn't put it on here but spam if

310
00:15:29,279 --> 00:15:32,879
you're a network admin you can probably

311
00:15:32,879 --> 00:15:34,499
pull these out off of your network

312
00:15:34,499 --> 00:15:40,310
pretty easily weird on honey clients

313
00:15:40,310 --> 00:15:43,970
like I said malware is well malware is

314
00:15:43,970 --> 00:15:46,670
big business hundreds of millions of

315
00:15:46,670 --> 00:15:48,830
dollars for these ransomware and other

316
00:15:48,830 --> 00:15:51,980
types of malware and zero day exploits

317
00:15:51,980 --> 00:15:55,100
are really expensive to get off of the

318
00:15:55,100 --> 00:15:57,500
darknet because of that they're not

319
00:15:57,500 --> 00:15:59,150
going to give these up really easily so

320
00:15:59,150 --> 00:16:02,089
that's why we have honey clients and

321
00:16:02,089 --> 00:16:03,320
there's actually several different

322
00:16:03,320 --> 00:16:06,190
flavors of honey clients and that's a

323
00:16:06,190 --> 00:16:11,270
hot area of research exploits cost money

324
00:16:11,270 --> 00:16:15,290
especially zero-day exploits and malware

325
00:16:15,290 --> 00:16:17,600
plays hard to get not only do they want

326
00:16:17,600 --> 00:16:19,279
to know that you're a viable user but

327
00:16:19,279 --> 00:16:21,170
part of that being a viable user is

328
00:16:21,170 --> 00:16:24,020
having the right operating system having

329
00:16:24,020 --> 00:16:26,240
the right behavior a lot of malware now

330
00:16:26,240 --> 00:16:28,130
will actually have you go through

331
00:16:28,130 --> 00:16:30,290
several steps to show that you're

332
00:16:30,290 --> 00:16:32,570
interacting with the website or

333
00:16:32,570 --> 00:16:36,220
interacting with the malware in some way

334
00:16:37,180 --> 00:16:41,390
so the second type of source is a

335
00:16:41,390 --> 00:16:46,700
synthetic source synthetic is a feed of

336
00:16:46,700 --> 00:16:48,650
malware that somebody has put together

337
00:16:48,650 --> 00:16:50,660
some vendors put together and they will

338
00:16:50,660 --> 00:16:52,400
give you this is what they've seen it's

339
00:16:52,400 --> 00:16:53,600
usually because they've put together

340
00:16:53,600 --> 00:16:55,640
their own honey client or honey pots or

341
00:16:55,640 --> 00:16:59,600
some other honey network and there's

342
00:16:59,600 --> 00:17:01,310
there's a lot of them that are free in

343
00:17:01,310 --> 00:17:03,800
fact if you ask really nicely to a lot

344
00:17:03,800 --> 00:17:05,510
of these companies they'll give you a

345
00:17:05,510 --> 00:17:10,040
researcher feed especially if you tell

346
00:17:10,040 --> 00:17:11,689
them if you promise and pinky swear that

347
00:17:11,689 --> 00:17:13,310
you're not going to resell it to someone

348
00:17:13,310 --> 00:17:16,339
else and there's also been initiatives

349
00:17:16,339 --> 00:17:18,439
from the the White House to kind of put

350
00:17:18,439 --> 00:17:22,189
together an official malware feed that

351
00:17:22,189 --> 00:17:25,220
any researcher can look at one of the

352
00:17:25,220 --> 00:17:28,670
best though is virus share calm it's

353
00:17:28,670 --> 00:17:33,550
Georgia Tech initiative they offer

354
00:17:36,330 --> 00:17:40,750
virus share calm you have to ask him

355
00:17:40,750 --> 00:17:50,200
really nicely yay I did save that

356
00:17:50,200 --> 00:17:53,110
password all right if you ask him really

357
00:17:53,110 --> 00:17:55,210
nicely they'll give you a log into it

358
00:17:55,210 --> 00:17:57,580
it's not done they don't charge for it

359
00:17:57,580 --> 00:18:02,470
but you see the size of some of these

360
00:18:02,470 --> 00:18:08,350
files these are huge roll-ups 3337 gigs

361
00:18:08,350 --> 00:18:11,409
I think it's basically 7 terabytes of

362
00:18:11,409 --> 00:18:18,909
malware here do it yeah yeah these are

363
00:18:18,909 --> 00:18:23,799
huge so and lately in the last few

364
00:18:23,799 --> 00:18:25,419
months they've started doing multiple

365
00:18:25,419 --> 00:18:27,700
drops per month to kind of break up that

366
00:18:27,700 --> 00:18:32,260
huge file size so this is honestly the

367
00:18:32,260 --> 00:18:34,950
bread and butter of where I pull most of

368
00:18:34,950 --> 00:18:40,059
most of my malware samples well and a

369
00:18:40,059 --> 00:18:41,919
certain vendor that has an affinity for

370
00:18:41,919 --> 00:18:45,820
me so if you're just looking for a

371
00:18:45,820 --> 00:18:47,710
specific piece of malware if you're

372
00:18:47,710 --> 00:18:52,809
looking for a dryer or ransomware or

373
00:18:52,809 --> 00:18:54,370
something like that you can pull down

374
00:18:54,370 --> 00:18:56,289
their md5 list and just search through

375
00:18:56,289 --> 00:18:59,860
that and find just the pieces or find

376
00:18:59,860 --> 00:19:02,590
which dump that those pieces of malware

377
00:19:02,590 --> 00:19:05,500
in that way you're not just blindly

378
00:19:05,500 --> 00:19:09,630
pulling down a huge roll up of malware

379
00:19:10,540 --> 00:19:14,340
so one thing about synthetic is that

380
00:19:14,340 --> 00:19:17,730
you're going to get a lot of malware and

381
00:19:17,730 --> 00:19:21,460
usually vendors aren't particular about

382
00:19:21,460 --> 00:19:22,630
selling you you know this is just

383
00:19:22,630 --> 00:19:24,730
windows malware this is just ransomware

384
00:19:24,730 --> 00:19:26,740
or something like that they're usually

385
00:19:26,740 --> 00:19:29,860
just a feed of malware and then you have

386
00:19:29,860 --> 00:19:34,780
to filter it yourself the two points to

387
00:19:34,780 --> 00:19:37,360
note on synthetic malware feeds you need

388
00:19:37,360 --> 00:19:39,330
to pay attention to quality and overlap

389
00:19:39,330 --> 00:19:42,790
so what we did was we would pull down

390
00:19:42,790 --> 00:19:45,550
virus or virus share and then we would

391
00:19:45,550 --> 00:19:47,890
measure every other vendor against virus

392
00:19:47,890 --> 00:19:50,350
you and see how much of a delta

393
00:19:50,350 --> 00:19:52,770
difference they have against virus share

394
00:19:52,770 --> 00:19:55,830
another one to use is virustotal

395
00:19:55,830 --> 00:20:02,770
virustotal is a online service to look

396
00:20:02,770 --> 00:20:05,020
up hashes and information about malware

397
00:20:05,020 --> 00:20:08,200
it's run by Microsoft I believe that's

398
00:20:08,200 --> 00:20:10,990
where Windows Defender dumps all of

399
00:20:10,990 --> 00:20:13,530
their hashes and a lot of other places

400
00:20:13,530 --> 00:20:17,830
dumped into there as well so we'll get

401
00:20:17,830 --> 00:20:20,170
into that just second of information to

402
00:20:20,170 --> 00:20:26,850
pull off of malware yes Google okay I

403
00:20:26,850 --> 00:20:29,380
thought they were owned by my Microsoft

404
00:20:29,380 --> 00:20:32,410
huh i guess i will explain why they're

405
00:20:32,410 --> 00:20:37,840
on Google App Engine any rate synthetic

406
00:20:37,840 --> 00:20:40,000
feeds are also usually enriched with

407
00:20:40,000 --> 00:20:42,310
data that the vendor is provided about

408
00:20:42,310 --> 00:20:44,500
the malware usually things like what

409
00:20:44,500 --> 00:20:49,000
they think the malware family is some of

410
00:20:49,000 --> 00:20:50,560
the better ones will try to tell you

411
00:20:50,560 --> 00:20:56,200
what cluster they've put it in so like I

412
00:20:56,200 --> 00:20:58,480
said earlier there's a lot of similar

413
00:20:58,480 --> 00:21:00,520
malware so fingerprinting the malware

414
00:21:00,520 --> 00:21:01,930
we're getting into just second as one of

415
00:21:01,930 --> 00:21:05,530
the is a hot area right now the last

416
00:21:05,530 --> 00:21:07,990
part about synthetics is they're usually

417
00:21:07,990 --> 00:21:09,910
really smooth so you're not going to

418
00:21:09,910 --> 00:21:13,240
have a whole lot of hiccups downloading

419
00:21:13,240 --> 00:21:15,310
it from these vendors as opposed to

420
00:21:15,310 --> 00:21:17,140
having to beat up the organic sources

421
00:21:17,140 --> 00:21:19,840
just to get them to give you one out of

422
00:21:19,840 --> 00:21:21,760
a thousand pieces of malware that shut

423
00:21:21,760 --> 00:21:24,000
down

424
00:21:25,130 --> 00:21:29,490
so with that quality control for organic

425
00:21:29,490 --> 00:21:32,970
you want to know what the yield is the

426
00:21:32,970 --> 00:21:35,130
yield being the percentage of URLs that

427
00:21:35,130 --> 00:21:37,980
you get the raw feed / the valid

428
00:21:37,980 --> 00:21:40,259
binaries that you get and also

429
00:21:40,259 --> 00:21:44,929
controlling for duplicates because some

430
00:21:44,929 --> 00:21:48,539
some URL feed vendors who aren't either

431
00:21:48,539 --> 00:21:50,309
aren't paying attention or just want to

432
00:21:50,309 --> 00:21:51,960
inflate their numbers they'll give you a

433
00:21:51,960 --> 00:21:54,330
huge feed but it turns out that most of

434
00:21:54,330 --> 00:21:55,590
them are all pointing to the same piece

435
00:21:55,590 --> 00:21:58,350
of malware one guy actually yelled at us

436
00:21:58,350 --> 00:22:02,009
while i was at norse that his site ended

437
00:22:02,009 --> 00:22:04,860
up in a hundred different places because

438
00:22:04,860 --> 00:22:07,889
he had one compromised link on his

439
00:22:07,889 --> 00:22:10,590
wordpress site and every link pointed

440
00:22:10,590 --> 00:22:13,350
back to that so it just came up in the

441
00:22:13,350 --> 00:22:15,899
reports that this guy had a huge

442
00:22:15,899 --> 00:22:18,000
treasure trove of malware on a site and

443
00:22:18,000 --> 00:22:21,409
it was funny because we weren't the only

444
00:22:21,409 --> 00:22:24,179
spider there's actually a friends of

445
00:22:24,179 --> 00:22:27,779
mine who did a research project besides

446
00:22:27,779 --> 00:22:30,539
DC as their talk for it where they did

447
00:22:30,539 --> 00:22:32,399
they crafted a piece of malware and put

448
00:22:32,399 --> 00:22:34,799
it out on de virustotal just to see how

449
00:22:34,799 --> 00:22:37,259
many other security vendors would go and

450
00:22:37,259 --> 00:22:38,909
get that kind of like a cuckoo for

451
00:22:38,909 --> 00:22:41,039
security vendors what they found out is

452
00:22:41,039 --> 00:22:43,559
that like I said earlier we're not the

453
00:22:43,559 --> 00:22:44,700
only ones that are running a malware

454
00:22:44,700 --> 00:22:46,500
pipeline there's a ton of people that

455
00:22:46,500 --> 00:22:51,179
are running malware pipelines so valid

456
00:22:51,179 --> 00:22:52,860
binaries and then the diversity of

457
00:22:52,860 --> 00:22:56,269
domains you find a lot of overlap there

458
00:22:56,269 --> 00:23:00,899
synthetic what's their volume look like

459
00:23:00,899 --> 00:23:02,600
and is it reliable there's a lot of

460
00:23:02,600 --> 00:23:05,610
one-off shops that show up and they say

461
00:23:05,610 --> 00:23:08,399
we've got this feed of malware and they

462
00:23:08,399 --> 00:23:11,309
really just have one or two dumps of

463
00:23:11,309 --> 00:23:13,559
malware and that's it it's not a feed

464
00:23:13,559 --> 00:23:16,200
it's just a dump now a lot of the

465
00:23:16,200 --> 00:23:17,820
security vendors are good enough to say

466
00:23:17,820 --> 00:23:21,029
this is just a rollup it's not a feed

467
00:23:21,029 --> 00:23:24,080
that you can look at forevermore and

468
00:23:24,080 --> 00:23:28,529
others they kind of go stale so another

469
00:23:28,529 --> 00:23:30,480
part of synthetic like I said do they

470
00:23:30,480 --> 00:23:33,649
provide additional intelligence

471
00:23:34,380 --> 00:23:37,450
like the the malware family name and the

472
00:23:37,450 --> 00:23:39,520
key is whether or not they try to

473
00:23:39,520 --> 00:23:45,280
fingerprint the file that's it for

474
00:23:45,280 --> 00:23:47,470
sources might have any questions about

475
00:23:47,470 --> 00:23:52,600
sources where to go get malware lots of

476
00:23:52,600 --> 00:23:57,790
malware just using that well using the

477
00:23:57,790 --> 00:23:59,260
free sources and we did have some

478
00:23:59,260 --> 00:24:01,480
vendors that fed us that was what

479
00:24:01,480 --> 00:24:03,430
accounted for the terabytes of malware

480
00:24:03,430 --> 00:24:07,990
that we were able to amass fun stuff so

481
00:24:07,990 --> 00:24:10,450
refining the data getting all of that

482
00:24:10,450 --> 00:24:14,230
data in is one thing but refining it is

483
00:24:14,230 --> 00:24:15,640
what we're all after that's the

484
00:24:15,640 --> 00:24:17,440
intelligence in the threat intelligence

485
00:24:17,440 --> 00:24:22,360
business this is where I slipped the

486
00:24:22,360 --> 00:24:24,010
docker stuff in how many of you have

487
00:24:24,010 --> 00:24:26,610
ever worked with docker before yeah

488
00:24:26,610 --> 00:24:30,040
awesome so why did I put docker in here

489
00:24:30,040 --> 00:24:31,930
was it just to add another buzzword to

490
00:24:31,930 --> 00:24:36,630
my presentation yes but that's not all

491
00:24:36,630 --> 00:24:40,060
it's also in there because docker helps

492
00:24:40,060 --> 00:24:46,960
make things nicer so if you have you

493
00:24:46,960 --> 00:24:48,490
have ever tried to set up a project

494
00:24:48,490 --> 00:24:52,020
called cuckoo you will appreciate this

495
00:24:52,020 --> 00:24:54,550
that it's all wrapped up and cleanly

496
00:24:54,550 --> 00:24:57,280
available into a docker package that's

497
00:24:57,280 --> 00:24:59,800
important because setting up cuckoo is a

498
00:24:59,800 --> 00:25:03,190
pain in the ass by itself there's a lot

499
00:25:03,190 --> 00:25:04,840
of other good stuff to do to spend your

500
00:25:04,840 --> 00:25:07,030
time on not setting up cuckoo same goes

501
00:25:07,030 --> 00:25:08,410
for a lot of these security tools

502
00:25:08,410 --> 00:25:11,820
they're really great and the security

503
00:25:11,820 --> 00:25:15,490
researcher who puts it together bless

504
00:25:15,490 --> 00:25:17,590
their heart it works with the specific

505
00:25:17,590 --> 00:25:19,680
libraries that they put it together

506
00:25:19,680 --> 00:25:23,440
usually security researchers aren't the

507
00:25:23,440 --> 00:25:26,110
most diligent about good software

508
00:25:26,110 --> 00:25:28,930
building techniques so anyway a lot of

509
00:25:28,930 --> 00:25:31,350
these security tools are available as

510
00:25:31,350 --> 00:25:36,430
docker images that also has the side

511
00:25:36,430 --> 00:25:39,100
benefit of making it easily deployable

512
00:25:39,100 --> 00:25:42,010
in any sort of pipeline scenario that

513
00:25:42,010 --> 00:25:44,950
you want to put together that means that

514
00:25:44,950 --> 00:25:47,290
your pipeline scenario if you Bill

515
00:25:47,290 --> 00:25:49,590
off of these darker tools is

516
00:25:49,590 --> 00:25:53,380
horizontally scalable so that's great

517
00:25:53,380 --> 00:25:56,200
especially as we've got tons of malware

518
00:25:56,200 --> 00:26:02,110
to analyze so when we go to analyze

519
00:26:02,110 --> 00:26:07,300
malware there's three different roughly

520
00:26:07,300 --> 00:26:10,210
three different categories from an

521
00:26:10,210 --> 00:26:12,070
automation perspective the first one is

522
00:26:12,070 --> 00:26:14,680
the very quick surface analysis we're

523
00:26:14,680 --> 00:26:16,560
talking about Yara rules earlier about

524
00:26:16,560 --> 00:26:19,450
matching hashes that would be what this

525
00:26:19,450 --> 00:26:22,720
is just a quick hash lookup or bytes in

526
00:26:22,720 --> 00:26:25,510
a certain order specifically the magic

527
00:26:25,510 --> 00:26:30,010
bites when you run file over a over a

528
00:26:30,010 --> 00:26:32,860
file that's looking at the magic bytes

529
00:26:32,860 --> 00:26:44,020
so so running file over all the files

530
00:26:44,020 --> 00:26:45,520
that i've downloaded here and this is

531
00:26:45,520 --> 00:26:49,360
from a previous download attempt so it's

532
00:26:49,360 --> 00:26:51,160
a little bit old by now but you can see

533
00:26:51,160 --> 00:26:55,180
that there's a mix of p32 and HTML files

534
00:26:55,180 --> 00:26:57,400
in here does anybody know why there's so

535
00:26:57,400 --> 00:27:01,140
many HTML files in this malware feet

536
00:27:01,140 --> 00:27:08,110
yeah yeah yeahs emails malicious links

537
00:27:08,110 --> 00:27:15,780
yeah um sorry yeah

538
00:27:16,650 --> 00:27:20,140
yeah yeah when we set up the malware

539
00:27:20,140 --> 00:27:23,500
pipeline initially the question we had

540
00:27:23,500 --> 00:27:25,000
to come up with was are we going to log

541
00:27:25,000 --> 00:27:28,150
error pages from the server because they

542
00:27:28,150 --> 00:27:30,130
could be just valid 404 pages like

543
00:27:30,130 --> 00:27:32,590
you're saying they could also be the

544
00:27:32,590 --> 00:27:34,630
malware authors attempt to trick the

545
00:27:34,630 --> 00:27:37,090
firewall into not caching that page and

546
00:27:37,090 --> 00:27:42,520
regenerating the page every time so your

547
00:27:42,520 --> 00:27:45,910
mileage may vary we chose to capture

548
00:27:45,910 --> 00:27:48,400
everything so we also get a bunch of

549
00:27:48,400 --> 00:27:49,900
things like this anybody know why this

550
00:27:49,900 --> 00:27:56,850
XML file is in here macro or windows

551
00:27:56,850 --> 00:27:59,980
internet explorer had a well older

552
00:27:59,980 --> 00:28:01,870
version still have this bug in it where

553
00:28:01,870 --> 00:28:04,090
the XML parser would allow a buffer

554
00:28:04,090 --> 00:28:05,860
overflow and you could exploit it that

555
00:28:05,860 --> 00:28:07,930
way so what you're getting from organic

556
00:28:07,930 --> 00:28:09,700
sources is also going to be mostly

557
00:28:09,700 --> 00:28:14,230
exploits the gentleman came up here

558
00:28:14,230 --> 00:28:16,720
previously talked about first stage

559
00:28:16,720 --> 00:28:18,730
second stage third stage of malware

560
00:28:18,730 --> 00:28:21,640
infection the first stage is usually the

561
00:28:21,640 --> 00:28:24,690
exploit its finding a hole in some

562
00:28:24,690 --> 00:28:27,190
application something that they can get

563
00:28:27,190 --> 00:28:31,900
through to that would be PDF or Word

564
00:28:31,900 --> 00:28:35,260
documents or something in the browser

565
00:28:35,260 --> 00:28:37,510
itself just some way that they can

566
00:28:37,510 --> 00:28:40,060
execute their own what it's called

567
00:28:40,060 --> 00:28:42,610
shellcode the shellcode then we'll reach

568
00:28:42,610 --> 00:28:44,530
out it's a very small tailored piece of

569
00:28:44,530 --> 00:28:47,320
code it'll reach out and grab what's

570
00:28:47,320 --> 00:28:50,320
known as a dropper the droppers job is

571
00:28:50,320 --> 00:28:53,110
to go and get a bigger payload and put

572
00:28:53,110 --> 00:28:56,470
it in place the dropper then that bigger

573
00:28:56,470 --> 00:28:58,150
payload that it gets is usually the

574
00:28:58,150 --> 00:29:00,330
advanced persistent threat that's the

575
00:29:00,330 --> 00:29:03,400
the full payload of the the malicious

576
00:29:03,400 --> 00:29:07,690
file so usually well if you're doing an

577
00:29:07,690 --> 00:29:10,030
automated pipeline you kind of want to

578
00:29:10,030 --> 00:29:11,740
break down what you're getting into

579
00:29:11,740 --> 00:29:14,650
those three categories as well in that

580
00:29:14,650 --> 00:29:17,080
respect most of these HTML files and the

581
00:29:17,080 --> 00:29:19,300
XML files are going to be the dropper

582
00:29:19,300 --> 00:29:22,960
first stage the pe32 s probably going to

583
00:29:22,960 --> 00:29:26,980
be the later stage malware and also I

584
00:29:26,980 --> 00:29:30,429
want to point out that the pe32 s

585
00:29:30,429 --> 00:29:33,730
are not all created equal you have all

586
00:29:33,730 --> 00:29:36,129
kinds of different variations within the

587
00:29:36,129 --> 00:29:38,110
P 32s and we'll get into that in just a

588
00:29:38,110 --> 00:29:43,509
second the another another one that you

589
00:29:43,509 --> 00:29:47,200
run into the archives the zip files that

590
00:29:47,200 --> 00:29:59,249
we that we saw and so there's Java so

591
00:29:59,249 --> 00:30:02,860
along the the counts of malware p32

592
00:30:02,860 --> 00:30:05,350
reigns supreme that is the windows

593
00:30:05,350 --> 00:30:09,159
execute packed executables right next to

594
00:30:09,159 --> 00:30:11,879
it and way down the ladder is Java

595
00:30:11,879 --> 00:30:14,980
executable or jar files and then way

596
00:30:14,980 --> 00:30:19,509
down from that would be exotic things

597
00:30:19,509 --> 00:30:23,950
like linux or mac or i think out of our

598
00:30:23,950 --> 00:30:28,720
entire library we had 3 iOS malicious

599
00:30:28,720 --> 00:30:32,769
iOS files mostly because it's so hard to

600
00:30:32,769 --> 00:30:37,629
get that to run so the vast majority of

601
00:30:37,629 --> 00:30:38,830
your pipeline is going to be working

602
00:30:38,830 --> 00:30:43,149
with probably pe32 unless I mean I

603
00:30:43,149 --> 00:30:45,190
started to stand up a pipeline just for

604
00:30:45,190 --> 00:30:49,809
Mac malware it's the biggest thing is

605
00:30:49,809 --> 00:30:53,019
filtering out all of the p32 what's what

606
00:30:53,019 --> 00:30:55,840
you're left with is maybe 300 a year or

607
00:30:55,840 --> 00:30:57,789
something this year it's supposed to

608
00:30:57,789 --> 00:30:59,440
double or quadruple which would be a

609
00:30:59,440 --> 00:31:03,070
grand you know two thousand or so not a

610
00:31:03,070 --> 00:31:07,179
whole lot so surface scan very quick the

611
00:31:07,179 --> 00:31:09,610
idea here is an order of one operation

612
00:31:09,610 --> 00:31:11,799
so those of you who are familiar with

613
00:31:11,799 --> 00:31:13,749
the big o notation this is very

614
00:31:13,749 --> 00:31:16,990
important in big data because in our in

615
00:31:16,990 --> 00:31:19,749
our series of analysis we need to go

616
00:31:19,749 --> 00:31:24,279
from very fast to the slower so with our

617
00:31:24,279 --> 00:31:26,110
surface analysis we're looking at bit

618
00:31:26,110 --> 00:31:30,369
locations sha-1 values things like that

619
00:31:30,369 --> 00:31:32,679
and it's in this surface analysis that

620
00:31:32,679 --> 00:31:34,869
will also probably send these hashes out

621
00:31:34,869 --> 00:31:37,240
to something like virustotal and ask

622
00:31:37,240 --> 00:31:40,450
them have you seen this file I think

623
00:31:40,450 --> 00:31:43,480
virustotal is rate limited for the

624
00:31:43,480 --> 00:31:44,290
average you

625
00:31:44,290 --> 00:31:47,980
to what 10,000 a day or something so

626
00:31:47,980 --> 00:32:03,910
what for what just for oh yeah yes yeah

627
00:32:03,910 --> 00:32:05,170
if you pay them a good chunk of money

628
00:32:05,170 --> 00:32:07,090
than they love it but if you're asking

629
00:32:07,090 --> 00:32:08,590
them the same questions over and over

630
00:32:08,590 --> 00:32:09,970
again then they send you a nasty email

631
00:32:09,970 --> 00:32:12,370
and you have to fix that all the kinds

632
00:32:12,370 --> 00:32:15,760
of stuff so the another key here is no

633
00:32:15,760 --> 00:32:19,720
dependencies that is this is not the

634
00:32:19,720 --> 00:32:22,030
place to do debugging or anything else

635
00:32:22,030 --> 00:32:24,220
and what we're trying to do is filter

636
00:32:24,220 --> 00:32:26,830
out if we can if we can with confidence

637
00:32:26,830 --> 00:32:28,990
say this is something that everybody's

638
00:32:28,990 --> 00:32:31,830
seen then we don't need to go into it

639
00:32:31,830 --> 00:32:36,130
now we're Mauer stays out in the wild

640
00:32:36,130 --> 00:32:38,830
for a really really long time long past

641
00:32:38,830 --> 00:32:41,950
the active campaign you'll see echoes of

642
00:32:41,950 --> 00:32:43,600
campaigns that are just shared around

643
00:32:43,600 --> 00:32:44,860
it's kind of like the celebrities that

644
00:32:44,860 --> 00:32:47,410
keep dying every year because they

645
00:32:47,410 --> 00:32:49,690
haven't been heard from similar thing

646
00:32:49,690 --> 00:32:52,540
happens with malware people just share

647
00:32:52,540 --> 00:32:54,250
it around all the time even if there's

648
00:32:54,250 --> 00:32:55,870
even if the command and control servers

649
00:32:55,870 --> 00:32:57,670
that service that malware are no longer

650
00:32:57,670 --> 00:33:02,380
in existence so the second step once

651
00:33:02,380 --> 00:33:03,970
you've found something that looks like

652
00:33:03,970 --> 00:33:06,760
it's unknown or reasonably interesting

653
00:33:06,760 --> 00:33:12,100
would be a static analysis a lot of

654
00:33:12,100 --> 00:33:17,470
malware is packed or compressed or self

655
00:33:17,470 --> 00:33:19,960
executable files are also packed so

656
00:33:19,960 --> 00:33:22,030
malware tries to encrypt itself and hide

657
00:33:22,030 --> 00:33:24,220
itself like I said it it fights you at

658
00:33:24,220 --> 00:33:26,920
every step of the way and this is this

659
00:33:26,920 --> 00:33:28,810
is the next real place where it fights

660
00:33:28,810 --> 00:33:34,840
you they there's a lot of malware

661
00:33:34,840 --> 00:33:37,860
authors who will intentionally add in

662
00:33:37,860 --> 00:33:43,240
tricks for a debugger to try to throw it

663
00:33:43,240 --> 00:33:46,870
off and if you if you really want to get

664
00:33:46,870 --> 00:33:48,970
into reverse engineering malware at the

665
00:33:48,970 --> 00:33:51,880
bite level open security com is a great

666
00:33:51,880 --> 00:33:54,070
place to start they have really good

667
00:33:54,070 --> 00:33:56,860
courses for malware analysis one of the

668
00:33:56,860 --> 00:33:58,090
things that they'll point

669
00:33:58,090 --> 00:34:03,390
is these like immunity debugger ore-ida

670
00:34:03,390 --> 00:34:07,630
pro they try to map out the sections of

671
00:34:07,630 --> 00:34:10,149
code for you automatically well malware

672
00:34:10,149 --> 00:34:12,219
authors they know what you're after and

673
00:34:12,219 --> 00:34:15,399
so they're going to put bite they're

674
00:34:15,399 --> 00:34:16,810
going to put code in there to try to

675
00:34:16,810 --> 00:34:18,909
trick the debugger and try to break the

676
00:34:18,909 --> 00:34:21,070
debugger so there's a wonderful cat and

677
00:34:21,070 --> 00:34:23,679
mouse game there's also I noticed a

678
00:34:23,679 --> 00:34:26,889
really I think they're going to give out

679
00:34:26,889 --> 00:34:28,989
some of these goodies down here in the

680
00:34:28,989 --> 00:34:32,440
bottom I'll go ahead and point this out

681
00:34:32,440 --> 00:34:34,710
this is a really great book on that so

682
00:34:34,710 --> 00:34:38,739
black hat python by justin seats that's

683
00:34:38,739 --> 00:34:41,199
building a debugger in python and

684
00:34:41,199 --> 00:34:44,020
running that so a programmatic debugging

685
00:34:44,020 --> 00:34:45,609
which is great when you're setting up a

686
00:34:45,609 --> 00:34:47,889
pipeline you can set up breakpoints you

687
00:34:47,889 --> 00:34:49,510
can also do a lot of the stuff that you

688
00:34:49,510 --> 00:34:54,609
would do in manual analysis there's a

689
00:34:54,609 --> 00:34:56,859
lot of companies that specialize in

690
00:34:56,859 --> 00:35:01,300
unpack errs so there was one recent

691
00:35:01,300 --> 00:35:03,480
malware campaign that was using the

692
00:35:03,480 --> 00:35:07,540
nullsoft installation package does

693
00:35:07,540 --> 00:35:09,580
anybody know what nullsoft is also used

694
00:35:09,580 --> 00:35:15,970
for any other application it is an

695
00:35:15,970 --> 00:35:18,130
installer but what do you know what

696
00:35:18,130 --> 00:35:19,990
software package that it's used to

697
00:35:19,990 --> 00:35:25,960
install no winamp when app is one of the

698
00:35:25,960 --> 00:35:28,300
ones that started that also used I

699
00:35:28,300 --> 00:35:31,150
believe for VLC as well it's an open

700
00:35:31,150 --> 00:35:35,040
source install installation utility but

701
00:35:35,040 --> 00:35:37,420
installers they generate usually you'll

702
00:35:37,420 --> 00:35:40,180
see msi packages they have a bunch of

703
00:35:40,180 --> 00:35:42,310
other files packed into it and that's

704
00:35:42,310 --> 00:35:45,910
what that's an unpacker so so malware

705
00:35:45,910 --> 00:35:49,089
authors they'll use sometimes they'll

706
00:35:49,089 --> 00:35:51,010
use something like a nullsoft installer

707
00:35:51,010 --> 00:35:53,470
but more often than not they'll make

708
00:35:53,470 --> 00:35:56,859
their own package system and it's not

709
00:35:56,859 --> 00:35:59,589
because there's is more compact or

710
00:35:59,589 --> 00:36:01,450
anything else it's because again they're

711
00:36:01,450 --> 00:36:03,339
trying to hide from the automated

712
00:36:03,339 --> 00:36:07,660
detection so there's a whole range of

713
00:36:07,660 --> 00:36:09,670
vendors who will sell just unpacking

714
00:36:09,670 --> 00:36:11,650
utilities

715
00:36:11,650 --> 00:36:13,420
and they pride themselves on the number

716
00:36:13,420 --> 00:36:17,160
of unpack errs that they can support so

717
00:36:17,160 --> 00:36:21,550
that's a there's also some free ones but

718
00:36:21,550 --> 00:36:22,750
that's that's where you get in the

719
00:36:22,750 --> 00:36:24,850
difference between free and professional

720
00:36:24,850 --> 00:36:28,060
is the number of options the

721
00:36:28,060 --> 00:36:33,370
professional ones support so some other

722
00:36:33,370 --> 00:36:38,890
static operations checksums in the

723
00:36:38,890 --> 00:36:41,920
malware organic check sums are usually

724
00:36:41,920 --> 00:36:44,380
going to well there's a couple of

725
00:36:44,380 --> 00:36:45,910
reasons why the check sums are important

726
00:36:45,910 --> 00:36:48,910
one is if the checksum is invalid in the

727
00:36:48,910 --> 00:36:51,610
p.e that is the header of the PE if the

728
00:36:51,610 --> 00:36:54,820
checksum is invalid then it will give an

729
00:36:54,820 --> 00:36:58,750
invalid on memory layout for the file

730
00:36:58,750 --> 00:37:00,940
and that would be really easy for the

731
00:37:00,940 --> 00:37:02,890
malware author to write something to

732
00:37:02,890 --> 00:37:06,100
jump around in the file so that's one

733
00:37:06,100 --> 00:37:07,840
reason that check sums could be invalid

734
00:37:07,840 --> 00:37:09,250
another reason that check sums could be

735
00:37:09,250 --> 00:37:13,600
invalid is that the a lot of the big

736
00:37:13,600 --> 00:37:16,720
feeds of malware they pull not just from

737
00:37:16,720 --> 00:37:18,670
malware that's on disk but malware

738
00:37:18,670 --> 00:37:21,490
that's in memory and if the malware is

739
00:37:21,490 --> 00:37:23,500
in memory as it's being run and

740
00:37:23,500 --> 00:37:27,190
something like an anti-virus program

741
00:37:27,190 --> 00:37:29,170
grabs a snapshot of it and pulls it up

742
00:37:29,170 --> 00:37:32,860
to the cloud then the memory locations

743
00:37:32,860 --> 00:37:34,420
are not going to match up with what the

744
00:37:34,420 --> 00:37:37,150
file has reported as especially if

745
00:37:37,150 --> 00:37:39,370
you're doing a process hollowing which

746
00:37:39,370 --> 00:37:43,090
is good process starts up and then the

747
00:37:43,090 --> 00:37:45,190
malware just takes over that process and

748
00:37:45,190 --> 00:37:47,620
then an antivirus program or something

749
00:37:47,620 --> 00:37:50,500
like that oh I know that Windows

750
00:37:50,500 --> 00:37:53,170
Defender does this to some degree takes

751
00:37:53,170 --> 00:37:56,110
a snapshot of it puts it up online now

752
00:37:56,110 --> 00:37:57,790
the header will be wrong there and that

753
00:37:57,790 --> 00:38:00,130
that's important because if you're doing

754
00:38:00,130 --> 00:38:03,520
automated analysis you can't assume if

755
00:38:03,520 --> 00:38:05,500
the check if the header is invalid you

756
00:38:05,500 --> 00:38:07,150
can't assume that you could just walk

757
00:38:07,150 --> 00:38:08,920
the file like it would be a normal file

758
00:38:08,920 --> 00:38:10,870
to debug you have to kind of guard

759
00:38:10,870 --> 00:38:14,860
against that that has programmatic

760
00:38:14,860 --> 00:38:20,860
debugging implications the last two one

761
00:38:20,860 --> 00:38:23,860
here generating an abstract syntax tree

762
00:38:23,860 --> 00:38:25,250
AST

763
00:38:25,250 --> 00:38:27,200
that's what if you've ever used a

764
00:38:27,200 --> 00:38:29,300
debugging program like Ollie debug or

765
00:38:29,300 --> 00:38:32,390
immunity or Ida pro when they first load

766
00:38:32,390 --> 00:38:34,400
the file you have this wonderful tree of

767
00:38:34,400 --> 00:38:36,970
execution that tree of execution is the

768
00:38:36,970 --> 00:38:42,100
abstract syntax tree so a lot of malware

769
00:38:42,100 --> 00:38:45,740
will try to short circuit itself if it

770
00:38:45,740 --> 00:38:47,500
sees anything that's out of the ordinary

771
00:38:47,500 --> 00:38:51,470
so out of the ordinary used to just mean

772
00:38:51,470 --> 00:38:52,930
if it's running in a virtual machine

773
00:38:52,930 --> 00:38:56,030
there was a time when when malware just

774
00:38:56,030 --> 00:38:58,400
would not run on a virtual machine there

775
00:38:58,400 --> 00:39:01,100
was a well-known trick called the red

776
00:39:01,100 --> 00:39:02,840
pill that malware authors would

777
00:39:02,840 --> 00:39:04,730
incorporate it's just a few bites and

778
00:39:04,730 --> 00:39:06,860
all it does is it would check to see if

779
00:39:06,860 --> 00:39:11,240
it was running on VMware or really just

780
00:39:11,240 --> 00:39:13,610
VMware I mean they had some checks for

781
00:39:13,610 --> 00:39:16,010
virtual box as well but that wasn't as

782
00:39:16,010 --> 00:39:19,280
prolific so companies like McAfee would

783
00:39:19,280 --> 00:39:21,170
try to run a whole bank of systems

784
00:39:21,170 --> 00:39:23,930
running in VMware and just like this

785
00:39:23,930 --> 00:39:26,240
they would run their pipeline so malware

786
00:39:26,240 --> 00:39:28,730
authors would in the abstract syntax

787
00:39:28,730 --> 00:39:30,590
tree what it would look like is one

788
00:39:30,590 --> 00:39:33,500
block check see if its virtual machine

789
00:39:33,500 --> 00:39:36,500
and then quit execution well in a

790
00:39:36,500 --> 00:39:38,360
pipeline what you probably want to do is

791
00:39:38,360 --> 00:39:40,760
this other point up here patch the

792
00:39:40,760 --> 00:39:44,690
execution flow so it's it's a type of

793
00:39:44,690 --> 00:39:49,340
fuzzing fuzzing to get into that a

794
00:39:49,340 --> 00:39:52,370
little bit is usually when you think of

795
00:39:52,370 --> 00:39:56,030
fuzzing you think of finding holes in

796
00:39:56,030 --> 00:39:57,440
software that you could exploit that

797
00:39:57,440 --> 00:39:59,450
could that you could use from a red team

798
00:39:59,450 --> 00:40:02,170
perspective and and inject code into

799
00:40:02,170 --> 00:40:05,450
from a malware pipeline perspective I

800
00:40:05,450 --> 00:40:08,300
fuzz the malware to see I want it to run

801
00:40:08,300 --> 00:40:10,610
to completion because I want to see

802
00:40:10,610 --> 00:40:13,220
everything that it does so from a static

803
00:40:13,220 --> 00:40:16,040
analysis perspective I want to see all

804
00:40:16,040 --> 00:40:20,060
the way down through reaching out to the

805
00:40:20,060 --> 00:40:22,280
command and control servers if you look

806
00:40:22,280 --> 00:40:28,190
at it as you know if you gamify it the

807
00:40:28,190 --> 00:40:30,100
whole process of malware analysis

808
00:40:30,100 --> 00:40:33,820
finding the c2 servers is the jackpot

809
00:40:33,820 --> 00:40:35,990
because if we can find that then we can

810
00:40:35,990 --> 00:40:38,000
shut down the central

811
00:40:38,000 --> 00:40:40,160
the points that control the malware and

812
00:40:40,160 --> 00:40:42,860
the rest of it kind of dries up so

813
00:40:42,860 --> 00:40:44,570
there's other things that are

814
00:40:44,570 --> 00:40:46,130
interesting to mine out of malware as

815
00:40:46,130 --> 00:40:49,960
well but that's one of the biggest ones

816
00:40:50,860 --> 00:40:54,500
opcodes there's certain opcodes that

817
00:40:54,500 --> 00:40:57,350
malware uses that most normal software

818
00:40:57,350 --> 00:41:02,090
won't use so I mean for exploits it

819
00:41:02,090 --> 00:41:03,860
would probably be an op sled something

820
00:41:03,860 --> 00:41:07,310
like that so and the opcodes and

821
00:41:07,310 --> 00:41:10,130
combination of op codes is one of the

822
00:41:10,130 --> 00:41:11,840
things that machine learning is used for

823
00:41:11,840 --> 00:41:14,750
you take the file you pull out the

824
00:41:14,750 --> 00:41:17,660
opcodes and you have a whole bunch of op

825
00:41:17,660 --> 00:41:20,630
codes listed so for every one of these

826
00:41:20,630 --> 00:41:24,020
files especially for the PE 32s we pull

827
00:41:24,020 --> 00:41:26,030
out all of the opcodes and then we would

828
00:41:26,030 --> 00:41:29,360
compare those op codes and then there's

829
00:41:29,360 --> 00:41:31,250
a pattern that would emerge from the

830
00:41:31,250 --> 00:41:34,520
opcodes now this also requires you to

831
00:41:34,520 --> 00:41:37,880
have a really good control list to train

832
00:41:37,880 --> 00:41:40,100
your algorithms and and things like that

833
00:41:40,100 --> 00:41:43,610
but just suffice to say static analysis

834
00:41:43,610 --> 00:41:47,800
one thing to pull out of it is op codes

835
00:41:50,080 --> 00:41:54,110
and the last one the last type of

836
00:41:54,110 --> 00:41:56,840
analysis for malware and arguably the

837
00:41:56,840 --> 00:42:00,500
sexiest is the dynamic analysis this is

838
00:42:00,500 --> 00:42:06,050
where I mentioned cuckoo earlier before

839
00:42:06,050 --> 00:42:09,140
i get to static i meant to show a few

840
00:42:09,140 --> 00:42:13,790
more of these so i kind of went off the

841
00:42:13,790 --> 00:42:18,200
rails so raid air and PE scanner are two

842
00:42:18,200 --> 00:42:25,060
static analysis tools to use with docker

843
00:42:25,060 --> 00:42:28,430
so right air is a static is a

844
00:42:28,430 --> 00:42:33,200
programmatic debugging sweet and PE

845
00:42:33,200 --> 00:42:35,030
scanner is something that you could use

846
00:42:35,030 --> 00:42:38,390
to pull out header information things

847
00:42:38,390 --> 00:42:43,779
like that the other static bits of data

848
00:42:44,470 --> 00:42:47,630
so dynamic analysis I mentioned cuckoo

849
00:42:47,630 --> 00:42:50,080
earlier cuckoo is an open sourced

850
00:42:50,080 --> 00:42:51,710
dynamic analysis

851
00:42:51,710 --> 00:42:55,520
this platform coo coo works by the

852
00:42:55,520 --> 00:42:58,130
general idea is you have a virtual

853
00:42:58,130 --> 00:43:01,130
machine that is that has a snapshot to a

854
00:43:01,130 --> 00:43:04,609
clean state you inject malware into that

855
00:43:04,609 --> 00:43:08,060
that virtual machine you run it and you

856
00:43:08,060 --> 00:43:11,000
wait and see what it does and then when

857
00:43:11,000 --> 00:43:12,950
you're done you reset it back to the

858
00:43:12,950 --> 00:43:14,869
clean snapshot state and do it all over

859
00:43:14,869 --> 00:43:18,890
again that's basically what you're doing

860
00:43:18,890 --> 00:43:21,770
with dynamic analysis the problem though

861
00:43:21,770 --> 00:43:23,810
the trick is one getting the malware to

862
00:43:23,810 --> 00:43:26,750
run malware is actually tailor-made to

863
00:43:26,750 --> 00:43:29,480
certain operating systems in order to

864
00:43:29,480 --> 00:43:32,810
make the malware smaller and leave less

865
00:43:32,810 --> 00:43:35,450
of a footprint malware authors will make

866
00:43:35,450 --> 00:43:37,250
a lot of assumptions about where they're

867
00:43:37,250 --> 00:43:39,170
running they'll assume that certain

868
00:43:39,170 --> 00:43:41,510
dll's are available so you'll probably

869
00:43:41,510 --> 00:43:44,390
notice you've probably seen this a user

870
00:43:44,390 --> 00:43:47,030
gets infected and you see a bunch of

871
00:43:47,030 --> 00:43:50,510
errors that pop up about MVC 40 dll or

872
00:43:50,510 --> 00:43:52,730
something the malware author is assuming

873
00:43:52,730 --> 00:43:54,410
that that file is available for them to

874
00:43:54,410 --> 00:43:56,660
use and it doesn't really matter in

875
00:43:56,660 --> 00:44:00,380
their minds whether it crashes on forty

876
00:44:00,380 --> 00:44:03,020
percent of systems it's just got to run

877
00:44:03,020 --> 00:44:04,369
on a few of those in order for them to

878
00:44:04,369 --> 00:44:07,369
infect and own that machine as a dying

879
00:44:07,369 --> 00:44:10,940
as a as someone who's putting up a

880
00:44:10,940 --> 00:44:14,330
pipeline the interesting bit for me is I

881
00:44:14,330 --> 00:44:17,300
need to have a variety of machines

882
00:44:17,300 --> 00:44:19,880
running and so I also need to kind of

883
00:44:19,880 --> 00:44:22,130
tailor which piece of malware I'm going

884
00:44:22,130 --> 00:44:24,230
to run in which machine so if I'm

885
00:44:24,230 --> 00:44:26,810
looking at the PE header file I need to

886
00:44:26,810 --> 00:44:29,570
match like the dotnet version that it

887
00:44:29,570 --> 00:44:31,670
was compiled against with the machine

888
00:44:31,670 --> 00:44:34,150
that I'm going to run it on otherwise

889
00:44:34,150 --> 00:44:41,359
going back to virus share if you'll

890
00:44:41,359 --> 00:44:45,020
notice the files here start in 2012 the

891
00:44:45,020 --> 00:44:48,530
files in that archive in 2012 a lot of

892
00:44:48,530 --> 00:44:51,859
those are going to target XP or younger

893
00:44:51,859 --> 00:44:56,150
systems so they're not going you end up

894
00:44:56,150 --> 00:44:58,070
patching the virus out if you're running

895
00:44:58,070 --> 00:45:02,060
it on 2003 or 8 or 12 so you have to

896
00:45:02,060 --> 00:45:05,499
match the system to the virus

897
00:45:05,499 --> 00:45:07,549
unfortunately virus authors aren't going

898
00:45:07,549 --> 00:45:09,499
to help you with that by letting you

899
00:45:09,499 --> 00:45:12,199
know but like I said earlier if you're

900
00:45:12,199 --> 00:45:14,959
setting this up for your environment if

901
00:45:14,959 --> 00:45:16,689
you're if you're protecting a network

902
00:45:16,689 --> 00:45:20,299
then you you were usually in a dynamic

903
00:45:20,299 --> 00:45:22,009
environment just want to set up the

904
00:45:22,009 --> 00:45:23,900
machines that are behind your firewall

905
00:45:23,900 --> 00:45:26,089
the ones that you know about I don't

906
00:45:26,089 --> 00:45:28,579
know what the school here runs but say

907
00:45:28,579 --> 00:45:32,569
that they run windows seven or so then

908
00:45:32,569 --> 00:45:35,209
set up a bunch of windows seven machines

909
00:45:35,209 --> 00:45:38,119
with varying different installation

910
00:45:38,119 --> 00:45:39,589
packages like different versions of

911
00:45:39,589 --> 00:45:42,319
office that might be run inside the

912
00:45:42,319 --> 00:45:46,209
organization PDF viewers stuff like that

913
00:45:46,209 --> 00:45:48,319
anything that doesn't run on those

914
00:45:48,319 --> 00:45:54,469
systems you can safely ignore as a as a

915
00:45:54,469 --> 00:45:57,949
pipeline as a pipeline architect i also

916
00:45:57,949 --> 00:46:00,949
want to turn off as many patches as

917
00:46:00,949 --> 00:46:02,569
possible i want to give them malware

918
00:46:02,569 --> 00:46:06,739
enough chance to run so it's another tip

919
00:46:06,739 --> 00:46:09,169
that i learned don't go through and do

920
00:46:09,169 --> 00:46:11,839
the updates like you normally otherwise

921
00:46:11,839 --> 00:46:13,339
you get kind of frustrated because none

922
00:46:13,339 --> 00:46:16,939
of the bow horse running so a key with

923
00:46:16,939 --> 00:46:20,179
dynamic analysis is the hypervisor so

924
00:46:20,179 --> 00:46:24,019
the hypervisor is vmware or virtual box

925
00:46:24,019 --> 00:46:28,489
or qemu the the hypervisor is what runs

926
00:46:28,489 --> 00:46:31,519
the system that's on top of it along

927
00:46:31,519 --> 00:46:36,919
those lines there's also zero wine zero

928
00:46:36,919 --> 00:46:41,179
wine is a a utility for running malware

929
00:46:41,179 --> 00:46:48,559
in a in a wine type environment now 01

930
00:46:48,559 --> 00:46:50,299
unfortunately hasn't been updated in

931
00:46:50,299 --> 00:46:59,150
quite a while they also use qemu so the

932
00:46:59,150 --> 00:47:02,150
point is everything with malware

933
00:47:02,150 --> 00:47:06,259
analysis comes down to the hypervisor if

934
00:47:06,259 --> 00:47:09,650
I'm injecting malware into my cuckoo

935
00:47:09,650 --> 00:47:12,079
sandbox and I'm waiting for it to do

936
00:47:12,079 --> 00:47:14,299
something then what's the easiest way

937
00:47:14,299 --> 00:47:16,400
for a malware author to evade my

938
00:47:16,400 --> 00:47:18,759
detection

939
00:47:18,760 --> 00:47:22,210
do what yeah we were talking about it

940
00:47:22,210 --> 00:47:25,000
earlier malware but would just wait for

941
00:47:25,000 --> 00:47:26,500
a couple of days or so before it

942
00:47:26,500 --> 00:47:29,290
executes its nothing to them but it

943
00:47:29,290 --> 00:47:31,720
aggravates the fool out of me so if I

944
00:47:31,720 --> 00:47:33,760
own the hypervisor for the system and I

945
00:47:33,760 --> 00:47:35,560
guess another good way to demonstrate

946
00:47:35,560 --> 00:47:37,540
this with a slide background would be

947
00:47:37,540 --> 00:47:39,640
inception if I owned the environment

948
00:47:39,640 --> 00:47:41,710
then I can tell you all kinds of crazy

949
00:47:41,710 --> 00:47:44,440
stuff for example I can start the

950
00:47:44,440 --> 00:47:46,510
execution of the malware and then speed

951
00:47:46,510 --> 00:47:48,400
up the system clock and kind of warp it

952
00:47:48,400 --> 00:47:53,140
into the future that way you think that

953
00:47:53,140 --> 00:47:55,150
you're you know a year or so in the

954
00:47:55,150 --> 00:47:57,280
future and I need to execute now or

955
00:47:57,280 --> 00:48:00,220
something like that combine that with

956
00:48:00,220 --> 00:48:06,100
fuzzing earlier great stuff so another

957
00:48:06,100 --> 00:48:08,920
factor in dynamic analysis with these

958
00:48:08,920 --> 00:48:11,920
environments it's you're probably not

959
00:48:11,920 --> 00:48:13,210
going to have a good time if you're

960
00:48:13,210 --> 00:48:14,980
malware can't get out to the internet a

961
00:48:14,980 --> 00:48:17,560
lot of malware first thing it does is it

962
00:48:17,560 --> 00:48:20,080
issues of pain to see if it's in a sane

963
00:48:20,080 --> 00:48:22,090
environment so I've had friends that

964
00:48:22,090 --> 00:48:26,560
have put together malware sandboxes in

965
00:48:26,560 --> 00:48:30,520
an air gaps environment that is no

966
00:48:30,520 --> 00:48:33,730
connection to the outside world unless

967
00:48:33,730 --> 00:48:35,290
it's malware that's specifically

968
00:48:35,290 --> 00:48:38,710
targeting like programmable logic chips

969
00:48:38,710 --> 00:48:41,740
something like that like Stuxnet it's

970
00:48:41,740 --> 00:48:44,770
not going to run it's just going to try

971
00:48:44,770 --> 00:48:46,570
to reach out to the internet not find

972
00:48:46,570 --> 00:48:48,700
anything and assume that there's nothing

973
00:48:48,700 --> 00:48:52,330
you can do the days of malware just

974
00:48:52,330 --> 00:48:56,440
being a nuisance or just wrecking havoc

975
00:48:56,440 --> 00:48:59,430
on a system without any further goal are

976
00:48:59,430 --> 00:49:03,460
pretty much gone so malware now has a

977
00:49:03,460 --> 00:49:05,530
purpose so it's going to try to reach

978
00:49:05,530 --> 00:49:08,080
out and do you know it's going to make

979
00:49:08,080 --> 00:49:10,690
sure that it can get to its and it's not

980
00:49:10,690 --> 00:49:12,430
reaching directly out to its command and

981
00:49:12,430 --> 00:49:15,570
control servers it's reaching out to I

982
00:49:15,570 --> 00:49:19,060
forget what you call that tier of proxy

983
00:49:19,060 --> 00:49:21,400
servers kind of the the ones that mask

984
00:49:21,400 --> 00:49:24,640
the c2 servers it's going to try to

985
00:49:24,640 --> 00:49:30,690
reach out to one of those so

986
00:49:31,940 --> 00:49:35,190
now that we've got those two basic

987
00:49:35,190 --> 00:49:37,620
pieces now what do we would do with them

988
00:49:37,620 --> 00:49:41,220
out with a pipeline well we can feed it

989
00:49:41,220 --> 00:49:43,620
back into itself now we're usually

990
00:49:43,620 --> 00:49:46,950
baguettes malware so you end up with

991
00:49:46,950 --> 00:49:50,220
this blooming problem where if you let

992
00:49:50,220 --> 00:49:52,170
it run for long enough it will go find

993
00:49:52,170 --> 00:49:53,910
more like I said droppers that's what

994
00:49:53,910 --> 00:49:56,250
they do it was mentioned in the last

995
00:49:56,250 --> 00:49:59,370
session that someone asked about a zip

996
00:49:59,370 --> 00:50:01,020
that contained three different pieces of

997
00:50:01,020 --> 00:50:04,050
malware well malware authors aren't dumb

998
00:50:04,050 --> 00:50:06,660
they know that they get there's power in

999
00:50:06,660 --> 00:50:08,790
numbers so one of those files you're

1000
00:50:08,790 --> 00:50:09,810
going to click on and one of those

1001
00:50:09,810 --> 00:50:11,490
exploit mechanisms is probably going to

1002
00:50:11,490 --> 00:50:15,150
work so all three of those represent a

1003
00:50:15,150 --> 00:50:17,940
new piece of malware for us to put

1004
00:50:17,940 --> 00:50:20,030
through the system and see what it does

1005
00:50:20,030 --> 00:50:22,530
chances are they all go to the same c2

1006
00:50:22,530 --> 00:50:25,080
server so and if we know that they came

1007
00:50:25,080 --> 00:50:26,490
in the same package we can kind of

1008
00:50:26,490 --> 00:50:28,260
associate them together and say this was

1009
00:50:28,260 --> 00:50:36,000
used as part of a set one key thing with

1010
00:50:36,000 --> 00:50:37,500
a malware pipeline and threat

1011
00:50:37,500 --> 00:50:39,420
intelligence in general is to cut out

1012
00:50:39,420 --> 00:50:42,450
the noise there's an awful lot of noise

1013
00:50:42,450 --> 00:50:47,370
and just by noise I mean in a cuckoo

1014
00:50:47,370 --> 00:50:49,620
installation you're going to see a ton

1015
00:50:49,620 --> 00:50:52,680
of requests out to Microsoft every time

1016
00:50:52,680 --> 00:50:54,900
the system runs it's going to call it's

1017
00:50:54,900 --> 00:50:56,840
going to phone home that's just a

1018
00:50:56,840 --> 00:50:59,880
background bit of noise there's a whole

1019
00:50:59,880 --> 00:51:02,880
bunch of other tools that just that

1020
00:51:02,880 --> 00:51:06,030
phone home for no good reason we were

1021
00:51:06,030 --> 00:51:08,220
talking about it earlier on my TV phones

1022
00:51:08,220 --> 00:51:13,950
home don't know why so because of that

1023
00:51:13,950 --> 00:51:16,470
we need to establish baselines this will

1024
00:51:16,470 --> 00:51:19,560
also help in your organization to to say

1025
00:51:19,560 --> 00:51:21,810
this is what a clean system looks like

1026
00:51:21,810 --> 00:51:24,840
this is what it does just left by itself

1027
00:51:24,840 --> 00:51:26,790
it's not malicious it just does that

1028
00:51:26,790 --> 00:51:30,620
good example would be a friend of mine

1029
00:51:30,620 --> 00:51:33,690
emailed me a while back and asked what

1030
00:51:33,690 --> 00:51:39,990
11 e100 calm what that domain was and if

1031
00:51:39,990 --> 00:51:41,910
she was infected anybody know what that

1032
00:51:41,910 --> 00:51:43,810
domain is

1033
00:51:43,810 --> 00:51:46,660
yeah google it's one of Google's

1034
00:51:46,660 --> 00:51:49,210
back-end services and that the

1035
00:51:49,210 --> 00:51:51,100
interesting thing is if you if you run

1036
00:51:51,100 --> 00:51:55,170
it through who is it some that Martin

1037
00:51:55,170 --> 00:51:57,580
markmonitor yeah it's markmonitor

1038
00:51:57,580 --> 00:51:59,830
registered to mark monitor so you unless

1039
00:51:59,830 --> 00:52:02,470
you knew the baseline you wouldn't you

1040
00:52:02,470 --> 00:52:03,550
know that that does kind of look

1041
00:52:03,550 --> 00:52:05,860
suspicious because it kind of looks to

1042
00:52:05,860 --> 00:52:07,660
the untrained eye like a domain

1043
00:52:07,660 --> 00:52:09,940
generated algorithm domain generated

1044
00:52:09,940 --> 00:52:11,590
algorithms have a whole lot of

1045
00:52:11,590 --> 00:52:13,660
randomness in but most people don't

1046
00:52:13,660 --> 00:52:20,680
really know that so with that I give you

1047
00:52:20,680 --> 00:52:22,840
the link to the handout which has a lot

1048
00:52:22,840 --> 00:52:24,520
more of the sources plus all of the

1049
00:52:24,520 --> 00:52:28,600
utilities that I mentioned here and if

1050
00:52:28,600 --> 00:52:30,910
you have any comments or questions feel

1051
00:52:30,910 --> 00:52:33,310
free to ask now or tweet or email me

1052
00:52:33,310 --> 00:52:37,480
later so with that I'll open it up and

1053
00:52:37,480 --> 00:52:39,640
ask questions I know that the next

1054
00:52:39,640 --> 00:52:42,220
speaker is probably ready to come up

1055
00:52:42,220 --> 00:52:45,880
here aging to come up here right you

1056
00:52:45,880 --> 00:52:57,400
don't know okay yeah all right any

1057
00:52:57,400 --> 00:53:01,980
questions yeah

1058
00:53:20,430 --> 00:53:25,090
so yeah the question is um the specific

1059
00:53:25,090 --> 00:53:27,820
tools i use for static analysis and i

1060
00:53:27,820 --> 00:53:30,160
raided your goodie box up here and found

1061
00:53:30,160 --> 00:53:31,750
one of the books i assume that you're

1062
00:53:31,750 --> 00:53:33,640
going to give this away i would love it

1063
00:53:33,640 --> 00:53:35,020
if you could give this book away during

1064
00:53:35,020 --> 00:53:36,220
this talk because this is actually

1065
00:53:36,220 --> 00:53:38,609
really related to what you were asking I

1066
00:53:38,609 --> 00:53:40,990
I will try to think of a challenge in

1067
00:53:40,990 --> 00:53:43,150
just a second so along those lines to

1068
00:53:43,150 --> 00:53:47,400
your question there are an awful lot of

1069
00:53:47,400 --> 00:53:52,090
Python based tools so PE info or P file

1070
00:53:52,090 --> 00:53:55,690
or P frame p info there's just a ton of

1071
00:53:55,690 --> 00:54:00,099
Python utilities and I think Justin

1072
00:54:00,099 --> 00:54:01,510
points out in this book that there's

1073
00:54:01,510 --> 00:54:03,880
there's a lot of libraries that he uses

1074
00:54:03,880 --> 00:54:08,800
so programmatically that just fits hand

1075
00:54:08,800 --> 00:54:11,170
in hand if we've got all these utilities

1076
00:54:11,170 --> 00:54:13,119
that are already built on some of them

1077
00:54:13,119 --> 00:54:15,369
like Mastiff things like that they're I

1078
00:54:15,369 --> 00:54:18,910
mean they're a full suite but not a lot

1079
00:54:18,910 --> 00:54:22,330
of those are programmer friendly so

1080
00:54:22,330 --> 00:54:24,160
that's the real key is is it programmer

1081
00:54:24,160 --> 00:54:27,099
friendly Ida Pro has a way to hook into

1082
00:54:27,099 --> 00:54:30,910
it with Python so and of course if you

1083
00:54:30,910 --> 00:54:32,560
build your own debugger than you can you

1084
00:54:32,560 --> 00:54:34,540
have even more control so for static

1085
00:54:34,540 --> 00:54:38,890
analysis we actually version one of the

1086
00:54:38,890 --> 00:54:40,990
pipeline we scrapped in favor of

1087
00:54:40,990 --> 00:54:43,660
reimplemented it all in Python just

1088
00:54:43,660 --> 00:54:45,130
because of the amount of libraries that

1089
00:54:45,130 --> 00:54:50,580
are out there now there are vendors like

1090
00:54:52,440 --> 00:54:55,390
reversing labs and you're going to pay

1091
00:54:55,390 --> 00:54:57,010
these guys a buttload of money because

1092
00:54:57,010 --> 00:54:59,320
they're good at what they do but there

1093
00:54:59,320 --> 00:55:01,150
are vendors that will help you they will

1094
00:55:01,150 --> 00:55:03,640
sell you static analysis tools now these

1095
00:55:03,640 --> 00:55:06,580
guys specialize in unpack errs that's

1096
00:55:06,580 --> 00:55:08,380
all they talk about they get kind of

1097
00:55:08,380 --> 00:55:10,540
annoying about it but they are pretty

1098
00:55:10,540 --> 00:55:14,740
decent about that so yeah we use a

1099
00:55:14,740 --> 00:55:21,419
mixture of free and paid

1100
00:55:30,839 --> 00:55:33,940
yeah from what I've seen it's either

1101
00:55:33,940 --> 00:55:37,750
free or it is just oh my God where did

1102
00:55:37,750 --> 00:55:39,910
you come up with that number we actually

1103
00:55:39,910 --> 00:55:42,490
had that with vendors as well so one of

1104
00:55:42,490 --> 00:55:43,930
the things that I did for the organic

1105
00:55:43,930 --> 00:55:47,710
URLs is I would actually price at per

1106
00:55:47,710 --> 00:55:49,810
URL and there was one vendor that came

1107
00:55:49,810 --> 00:55:51,849
out to like two hundred dollars a URL

1108
00:55:51,849 --> 00:55:53,980
when everybody else was running like 50

1109
00:55:53,980 --> 00:55:56,560
cents or so and we had to go back to him

1110
00:55:56,560 --> 00:56:02,730
that was a weird conversation yeah good

1111
00:56:18,780 --> 00:56:22,720
um yeah actually your discovery and

1112
00:56:22,720 --> 00:56:24,450
where you go with the pipeline is

1113
00:56:24,450 --> 00:56:26,650
radically different based on which one

1114
00:56:26,650 --> 00:56:29,140
you're ingesting so if it's just the PE

1115
00:56:29,140 --> 00:56:31,480
files then you're going to be you're

1116
00:56:31,480 --> 00:56:33,820
going to be in peel & D buggy or you

1117
00:56:33,820 --> 00:56:35,920
know disassembling windows files and

1118
00:56:35,920 --> 00:56:37,570
doing all that stuff but if you're

1119
00:56:37,570 --> 00:56:40,119
pulling organic URLs there's an

1120
00:56:40,119 --> 00:56:42,369
interesting thing that happens there

1121
00:56:42,369 --> 00:56:44,530
you're actually following the links

1122
00:56:44,530 --> 00:56:46,420
online and you're basically you end up

1123
00:56:46,420 --> 00:56:49,750
building a Google of malware spidering

1124
00:56:49,750 --> 00:56:52,330
out there infrastructure and what you

1125
00:56:52,330 --> 00:56:56,410
find is you may start with an HTML that

1126
00:56:56,410 --> 00:56:59,020
points to an XML and in the XML it has a

1127
00:56:59,020 --> 00:57:01,540
seat I or C data payload that you have

1128
00:57:01,540 --> 00:57:04,390
to undo it's very similar to the capture

1129
00:57:04,390 --> 00:57:07,450
the flag stuff so you have to follow in

1130
00:57:07,450 --> 00:57:09,609
and each you know the pipeline has to be

1131
00:57:09,609 --> 00:57:11,800
built in such a way that oh I found this

1132
00:57:11,800 --> 00:57:13,599
file and it had this blob of data I need

1133
00:57:13,599 --> 00:57:17,940
to reverse that and go into it so and

1134
00:57:17,940 --> 00:57:20,500
for non threat intelligence companies

1135
00:57:20,500 --> 00:57:22,000
for most of these others that I've

1136
00:57:22,000 --> 00:57:23,650
showed you like them the big box

1137
00:57:23,650 --> 00:57:26,109
retailers all they care about is an

1138
00:57:26,109 --> 00:57:28,960
attachment to an email so if it's not

1139
00:57:28,960 --> 00:57:31,510
that and plus they can control the

1140
00:57:31,510 --> 00:57:32,830
firewall a little bit better they can

1141
00:57:32,830 --> 00:57:34,000
just say we're going to

1142
00:57:34,000 --> 00:57:37,120
block all of these other domains and

1143
00:57:37,120 --> 00:57:39,550
usually they have other security vendors

1144
00:57:39,550 --> 00:57:41,710
in front of them that they can leverage

1145
00:57:41,710 --> 00:57:46,450
as well so yeah it really depends what

1146
00:57:46,450 --> 00:57:49,660
you ingest depends on or that determines

1147
00:57:49,660 --> 00:57:52,380
where you're going to go after it yeah

1148
00:57:52,380 --> 00:57:55,780
so it's really it's not just a pipeline

1149
00:57:55,780 --> 00:57:59,380
it ends up being a malware graph so it

1150
00:57:59,380 --> 00:58:03,820
goes from this node at every piece of it

1151
00:58:03,820 --> 00:58:08,380
ends up being really interesting all

1152
00:58:08,380 --> 00:58:14,550
right all right well thank you guys

