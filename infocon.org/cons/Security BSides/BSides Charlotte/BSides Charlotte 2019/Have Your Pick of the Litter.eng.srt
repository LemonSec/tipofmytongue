1
00:00:00,000 --> 00:00:02,310
stornes Bauer Staters and Enterprise

2
00:00:02,310 --> 00:00:04,680
Services all right this is a very

3
00:00:04,680 --> 00:00:07,290
interesting topic at least for me and

4
00:00:07,290 --> 00:00:08,670
possibly for you which is why you're

5
00:00:08,670 --> 00:00:11,309
here it's kind of the agenda would talk

6
00:00:11,309 --> 00:00:12,960
about really kind of games with history

7
00:00:12,960 --> 00:00:15,719
give some examples of actually put this

8
00:00:15,719 --> 00:00:18,840
into use will kind of wrap up with some

9
00:00:18,840 --> 00:00:22,590
other training free training in this

10
00:00:22,590 --> 00:00:23,939
environment in which you can practice

11
00:00:23,939 --> 00:00:25,949
some skills what happening but as we

12
00:00:25,949 --> 00:00:28,890
started this is me I think what the DoD

13
00:00:28,890 --> 00:00:31,740
for about 18 years really enjoy what I

14
00:00:31,740 --> 00:00:33,719
do in that space technically director

15
00:00:33,719 --> 00:00:36,809
for cyber operations center very much in

16
00:00:36,809 --> 00:00:38,160
love with PowerShell you'll kind of see

17
00:00:38,160 --> 00:00:41,340
that right throughout but so much so

18
00:00:41,340 --> 00:00:43,200
that I'd like to develop tools in that

19
00:00:43,200 --> 00:00:46,110
space weather is Blue Team Red Team what

20
00:00:46,110 --> 00:00:48,450
have you and then also like to kind of

21
00:00:48,450 --> 00:00:50,309
give that right because you're a Dave

22
00:00:50,309 --> 00:00:52,440
talk about kind of how everybody gets to

23
00:00:52,440 --> 00:00:54,510
start and I got my start because I'm I

24
00:00:54,510 --> 00:00:58,350
took some time and kind of helped so as

25
00:00:58,350 --> 00:01:00,690
we started talking about this we first

26
00:01:00,690 --> 00:01:03,480
kind of have to define about right we're

27
00:01:03,480 --> 00:01:04,920
talking about stages let's define

28
00:01:04,920 --> 00:01:07,920
malware first right this may be a two TL

29
00:01:07,920 --> 00:01:10,409
DR type thing so we'll kind of sum it up

30
00:01:10,409 --> 00:01:11,670
and essentially we're talking about

31
00:01:11,670 --> 00:01:13,619
malicious software that's designed to

32
00:01:13,619 --> 00:01:15,450
infiltrate and do things to a machine

33
00:01:15,450 --> 00:01:18,330
without actual consent right and that

34
00:01:18,330 --> 00:01:20,970
the cordis would malware looks to do so

35
00:01:20,970 --> 00:01:23,700
where did it really all begin well it

36
00:01:23,700 --> 00:01:28,149
began roughly about 1971 with a

37
00:01:28,149 --> 00:01:30,609
the Thomas who actually created the

38
00:01:30,609 --> 00:01:32,710
creeper Fowler it really it wasn't

39
00:01:32,710 --> 00:01:34,659
thought to be malicious at the time it

40
00:01:34,659 --> 00:01:37,090
was really can I make this execute on

41
00:01:37,090 --> 00:01:39,850
another machine through some type of

42
00:01:39,850 --> 00:01:41,590
connection so at the time it was our

43
00:01:41,590 --> 00:01:43,240
phonetic right so before there was

44
00:01:43,240 --> 00:01:46,090
actual internet itself and then it

45
00:01:46,090 --> 00:01:47,829
wasn't meant to be malicious in nature

46
00:01:47,829 --> 00:01:50,709
and as such the replication or how would

47
00:01:50,709 --> 00:01:52,420
propagate was really provide based upon

48
00:01:52,420 --> 00:01:54,219
human interaction and then there was a

49
00:01:54,219 --> 00:01:56,679
time in which somebody looked to make it

50
00:01:56,679 --> 00:01:58,450
in a more brutal fashion and when she

51
00:01:58,450 --> 00:02:00,759
could replicate on this home that's

52
00:02:00,759 --> 00:02:03,340
where in my new to when we look at where

53
00:02:03,340 --> 00:02:05,469
we're at today it warm red today

54
00:02:05,469 --> 00:02:07,060
definitely more sophisticated than

55
00:02:07,060 --> 00:02:09,489
anything else all right we have not word

56
00:02:09,489 --> 00:02:12,610
is polymorphic we have this whole

57
00:02:12,610 --> 00:02:14,620
cat-and-mouse game right you heard Dave

58
00:02:14,620 --> 00:02:17,049
talk about adding the care of stores so

59
00:02:17,049 --> 00:02:20,040
as a somebody of malicious intent is

60
00:02:20,040 --> 00:02:22,629
developing malware and as a defender is

61
00:02:22,629 --> 00:02:25,150
coming about and actually having that

62
00:02:25,150 --> 00:02:27,160
malware and or criminal detectives to

63
00:02:27,160 --> 00:02:29,230
defend against it the defender I'm sorry

64
00:02:29,230 --> 00:02:31,450
to on this person is constantly looking

65
00:02:31,450 --> 00:02:34,030
for new ways to really go and get around

66
00:02:34,030 --> 00:02:37,359
them so it's a mouse game system and as

67
00:02:37,359 --> 00:02:40,900
always going on but at the core now your

68
00:02:40,900 --> 00:02:42,970
words burn to space in which this is

69
00:02:42,970 --> 00:02:45,669
almost like a business where people are

70
00:02:45,669 --> 00:02:47,829
backing individuals that develop say

71
00:02:47,829 --> 00:02:49,690
about whether it's through financial

72
00:02:49,690 --> 00:02:51,549
gain or whether it is through ingest the

73
00:02:51,549 --> 00:02:54,130
equipment itself but you know while we

74
00:02:54,130 --> 00:02:56,109
still have people who are lone Ranger's

75
00:02:56,109 --> 00:02:58,299
if you will will get to the point of it

76
00:02:58,299 --> 00:03:00,069
being an organized crime estate sponsor

77
00:03:00,069 --> 00:03:01,840
who really started to change the game we

78
00:03:01,840 --> 00:03:04,510
see that we're very rapid in his base

79
00:03:04,510 --> 00:03:05,620
today

80
00:03:05,620 --> 00:03:07,360
we look at the different types that are

81
00:03:07,360 --> 00:03:09,190
out there now this isn't all-inclusive

82
00:03:09,190 --> 00:03:11,379
but just kind of someone was that a

83
00:03:11,379 --> 00:03:13,450
prevalence till the day I think viruses

84
00:03:13,450 --> 00:03:14,860
it weren't those kind of go without

85
00:03:14,860 --> 00:03:17,140
saying with ransomware in this space

86
00:03:17,140 --> 00:03:19,810
right really really huge it's good to

87
00:03:19,810 --> 00:03:21,730
the point where people are in portrayal

88
00:03:21,730 --> 00:03:22,379
machine

89
00:03:22,379 --> 00:03:24,849
encrypting to set files of folders or

90
00:03:24,849 --> 00:03:26,860
just data period and then you're holding

91
00:03:26,860 --> 00:03:28,930
them for ransom until somebody pays some

92
00:03:28,930 --> 00:03:31,900
fee to never give those files back the

93
00:03:31,900 --> 00:03:34,330
less that fee is being paid rootkits

94
00:03:34,330 --> 00:03:35,890
have been the bank continued to be a

95
00:03:35,890 --> 00:03:38,260
thing very very stealthy in danger all

96
00:03:38,260 --> 00:03:41,620
right actually how I never really

97
00:03:41,620 --> 00:03:44,110
difficult for what to do trojans

98
00:03:44,110 --> 00:03:47,500
keyloggers adware really great weird but

99
00:03:47,500 --> 00:03:50,890
cool others definitely make an a a ramp

100
00:03:50,890 --> 00:03:54,400
up in this space as well and then when

101
00:03:54,400 --> 00:03:56,079
we talk about really hiding our malware

102
00:03:56,079 --> 00:03:57,700
or somebody trying to hide their malware

103
00:03:57,700 --> 00:03:59,890
whether they have Packers so now they're

104
00:03:59,890 --> 00:04:01,780
trying to compress the actual true

105
00:04:01,780 --> 00:04:04,989
binary let's say it's some standalone

106
00:04:04,989 --> 00:04:07,209
you know BG info or what have you

107
00:04:07,209 --> 00:04:08,769
you're trying to compress that so they

108
00:04:08,769 --> 00:04:10,750
can allow their malware to be wrapped

109
00:04:10,750 --> 00:04:12,760
with it it will be self contained so

110
00:04:12,760 --> 00:04:15,220
upon execution it starts to do its own

111
00:04:15,220 --> 00:04:17,500
self extraction we have people using

112
00:04:17,500 --> 00:04:20,228
critters so that way if the binary is

113
00:04:20,228 --> 00:04:23,400
found whether it's an actual exe or DLL

114
00:04:23,400 --> 00:04:25,840
it's some type of a form of encryption

115
00:04:25,840 --> 00:04:29,349
or ex-ored applied to it so it's not as

116
00:04:29,349 --> 00:04:32,289
easily pick table the whole polymorphic

117
00:04:32,289 --> 00:04:34,750
aspect very stealthy in nature makes it

118
00:04:34,750 --> 00:04:37,150
much more difficult for a defender to

119
00:04:37,150 --> 00:04:39,160
actually find it why because it is

120
00:04:39,160 --> 00:04:40,690
consistently changing this form of the

121
00:04:40,690 --> 00:04:43,430
fashion from system or platform

122
00:04:43,430 --> 00:04:45,380
and we get to the point we talk start

123
00:04:45,380 --> 00:04:46,790
talking about stages and really this is

124
00:04:46,790 --> 00:04:50,300
the basis for the sexual talk so stages

125
00:04:50,300 --> 00:04:52,699
themselves right at the core of that

126
00:04:52,699 --> 00:04:55,130
that's gonna allow us to learn a little

127
00:04:55,130 --> 00:04:57,139
bit about the machine before we bring in

128
00:04:57,139 --> 00:04:58,790
an actual real payload that we care

129
00:04:58,790 --> 00:05:00,650
about and when we take the second to

130
00:05:00,650 --> 00:05:02,600
really define stagers alright we're

131
00:05:02,600 --> 00:05:04,820
talking about something known as a

132
00:05:04,820 --> 00:05:06,199
dropper some people call them

133
00:05:06,199 --> 00:05:10,070
downloaders right or effective as if you

134
00:05:10,070 --> 00:05:12,919
will but at the core these are tiny and

135
00:05:12,919 --> 00:05:16,070
major pieces of code that did shift or

136
00:05:16,070 --> 00:05:18,380
package which are initial payload so

137
00:05:18,380 --> 00:05:20,090
maybe we have some an exploit that's

138
00:05:20,090 --> 00:05:21,919
going to be our initial access best our

139
00:05:21,919 --> 00:05:24,229
moment vector on a machine rather didn't

140
00:05:24,229 --> 00:05:26,060
bring the actual real payload in which

141
00:05:26,060 --> 00:05:27,889
we care about not really understanding

142
00:05:27,889 --> 00:05:29,539
the state of the machine whether a bee

143
00:05:29,539 --> 00:05:31,520
is going to pick it up or maybe it's

144
00:05:31,520 --> 00:05:33,830
some you know good defender that's going

145
00:05:33,830 --> 00:05:35,300
to be able to highlight our stuff will

146
00:05:35,300 --> 00:05:37,100
first put something lightweight on there

147
00:05:37,100 --> 00:05:40,340
that's going to allow us to protect our

148
00:05:40,340 --> 00:05:42,260
equities the very thing that we maybe

149
00:05:42,260 --> 00:05:44,470
spend time money resources in developing

150
00:05:44,470 --> 00:05:47,419
and if we essentially an allow our state

151
00:05:47,419 --> 00:05:49,070
there to look around and figure out that

152
00:05:49,070 --> 00:05:49,940
the coast is clear

153
00:05:49,940 --> 00:05:52,160
that's really really great for us but

154
00:05:52,160 --> 00:05:54,020
that state is going to allow the system

155
00:05:54,020 --> 00:05:56,000
to initiate some connection back to our

156
00:05:56,000 --> 00:05:58,700
c2 server or servers alright because we

157
00:05:58,700 --> 00:06:00,530
will get a bound traffic typically that

158
00:06:00,530 --> 00:06:02,979
goes a little bit more on notice did

159
00:06:02,979 --> 00:06:05,180
somebody actually try to be get into

160
00:06:05,180 --> 00:06:08,660
your regime but at the core lessons are

161
00:06:08,660 --> 00:06:10,520
below if our toolset is found because

162
00:06:10,520 --> 00:06:12,470
again this danger is going to be very

163
00:06:12,470 --> 00:06:13,760
very small we'll look at a couple of

164
00:06:13,760 --> 00:06:16,160
examples here and regardless of what

165
00:06:16,160 --> 00:06:17,810
malware we're using it's going to be

166
00:06:17,810 --> 00:06:18,320
expensive

167
00:06:18,320 --> 00:06:20,050
we feed they're spent the time and money

168
00:06:20,050 --> 00:06:23,510
on buying it or we spent the time and

169
00:06:23,510 --> 00:06:26,360
resources and actually developing it so

170
00:06:26,360 --> 00:06:28,280
our delivering that that kind of looks

171
00:06:28,280 --> 00:06:30,550
something like so

172
00:06:30,550 --> 00:06:33,160
have actual machine it gets exploitive

173
00:06:33,160 --> 00:06:35,650
the stager may be attached with it

174
00:06:35,650 --> 00:06:37,540
this is just an example it would always

175
00:06:37,540 --> 00:06:41,560
be this case we have that stager on the

176
00:06:41,560 --> 00:06:43,540
machine that stator didn't initiate some

177
00:06:43,540 --> 00:06:45,370
communication or some type of traffic

178
00:06:45,370 --> 00:06:48,160
back to our c2 server or a subset of

179
00:06:48,160 --> 00:06:50,110
servers all right we may have it to

180
00:06:50,110 --> 00:06:52,000
where it reaches out to a number of

181
00:06:52,000 --> 00:06:53,680
servers so it's not static in nature

182
00:06:53,680 --> 00:06:56,260
each time and it once it reaches out to

183
00:06:56,260 --> 00:06:58,990
that machine that c2 server would have a

184
00:06:58,990 --> 00:07:02,350
second set of instructions maybe go we

185
00:07:02,350 --> 00:07:04,900
go surveyed the machine or give me this

186
00:07:04,900 --> 00:07:07,030
type of data or execute this next

187
00:07:07,030 --> 00:07:09,370
payload or just go to sleep for a period

188
00:07:09,370 --> 00:07:11,200
of time and then reach back out to me

189
00:07:11,200 --> 00:07:15,010
later on but at any rate typically that

190
00:07:15,010 --> 00:07:16,930
next stage if not that first stage is

191
00:07:16,930 --> 00:07:18,070
going to be encrypted

192
00:07:18,070 --> 00:07:19,990
I want to be able to protect that data

193
00:07:19,990 --> 00:07:23,290
and a communication most as possible but

194
00:07:23,290 --> 00:07:26,200
that second part is really where we look

195
00:07:26,200 --> 00:07:28,630
to see damn our whether it is a virus

196
00:07:28,630 --> 00:07:30,880
whether it is a worm rootkit key logger

197
00:07:30,880 --> 00:07:33,700
or what have you that's really where we

198
00:07:33,700 --> 00:07:38,080
start to see that being done the common

199
00:07:38,080 --> 00:07:40,030
test not only inclusive but generally

200
00:07:40,030 --> 00:07:43,600
speaking before somebody maybe myself

201
00:07:43,600 --> 00:07:45,520
invests a lot of time and effort into a

202
00:07:45,520 --> 00:07:47,200
machine I want to know if that machine

203
00:07:47,200 --> 00:07:50,020
is clear I want to know with what the

204
00:07:50,020 --> 00:07:51,520
state of the machine is is some other

205
00:07:51,520 --> 00:07:53,860
active there maybe the exploit that I

206
00:07:53,860 --> 00:07:56,200
have the follow-on payload maybe it's

207
00:07:56,200 --> 00:07:58,390
not susceptible on that machine so we

208
00:07:58,390 --> 00:08:00,010
would look to probably surveyed a little

209
00:08:00,010 --> 00:08:02,530
bit some babies are better than others

210
00:08:02,530 --> 00:08:04,180
right what is the state of the machine

211
00:08:04,180 --> 00:08:06,370
what does the environment like put it on

212
00:08:06,370 --> 00:08:08,590
what that comes back is then our next

213
00:08:08,590 --> 00:08:11,490
follow-on steps will be done quarterly

214
00:08:11,490 --> 00:08:13,680
and in some cases we may look to start

215
00:08:13,680 --> 00:08:16,140
terminating services in order to ensure

216
00:08:16,140 --> 00:08:18,990
our equities are taken care of we want

217
00:08:18,990 --> 00:08:20,850
to validate afford a virtual machine now

218
00:08:20,850 --> 00:08:22,860
if the environment runs on nothing but a

219
00:08:22,860 --> 00:08:24,810
virtualized infrastructure that this is

220
00:08:24,810 --> 00:08:27,720
a goal point but in some cases us

221
00:08:27,720 --> 00:08:29,220
writing the virtual machine could not

222
00:08:29,220 --> 00:08:31,950
like that somebody's trying to conduct

223
00:08:31,950 --> 00:08:34,860
some type of analysis on us and at the

224
00:08:34,860 --> 00:08:37,919
core we can get execution of our payload

225
00:08:37,919 --> 00:08:40,500
of our stager either through somebody

226
00:08:40,500 --> 00:08:43,440
opening XQ or not it's people file could

227
00:08:43,440 --> 00:08:46,470
be some web link could be just based

228
00:08:46,470 --> 00:08:49,500
upon a number of conditions ie this

229
00:08:49,500 --> 00:08:52,620
timeframe has hacked it now execute or

230
00:08:52,620 --> 00:08:54,900
when a particular user logs on not

231
00:08:54,900 --> 00:08:58,020
execute but we have the ability to

232
00:08:58,020 --> 00:09:01,290
really hard code that it and have some

233
00:09:01,290 --> 00:09:04,260
granularity into how a lie-in may

234
00:09:04,260 --> 00:09:06,630
execute and not ever environment is

235
00:09:06,630 --> 00:09:11,250
going to be the same some people will

236
00:09:11,250 --> 00:09:12,780
look to follow some type of methodology

237
00:09:12,780 --> 00:09:15,420
as far as trying to terminate this who's

238
00:09:15,420 --> 00:09:18,180
heard of cyber kill chain okay cool

239
00:09:18,180 --> 00:09:21,360
there's this is a framework much like a

240
00:09:21,360 --> 00:09:23,580
few other ones but when we look at this

241
00:09:23,580 --> 00:09:25,380
is broken down into reconnaissance

242
00:09:25,380 --> 00:09:27,810
weaponization delivery instrumentation

243
00:09:27,810 --> 00:09:30,030
you kind of see it there why people are

244
00:09:30,030 --> 00:09:32,850
developed this back in 2011 and it's not

245
00:09:32,850 --> 00:09:34,770
a bad framework I'm not going to say

246
00:09:34,770 --> 00:09:36,210
which one is better than the next but as

247
00:09:36,210 --> 00:09:37,650
long as you're following some framework

248
00:09:37,650 --> 00:09:39,390
with some type of methodology that's

249
00:09:39,390 --> 00:09:42,300
great it's linear so we're going to go

250
00:09:42,300 --> 00:09:44,220
one stage after the other it really the

251
00:09:44,220 --> 00:09:47,610
idea is to if you're defending is to get

252
00:09:47,610 --> 00:09:51,030
ahead in which this may take place so we

253
00:09:51,030 --> 00:09:51,840
know someone is going to do

254
00:09:51,840 --> 00:09:52,920
reconnaissance and they're going to work

255
00:09:52,920 --> 00:09:54,720
their way down if you start to see

256
00:09:54,720 --> 00:09:56,370
something like reconnaissance or maybe

257
00:09:56,370 --> 00:09:58,230
what organization that we're in a place

258
00:09:58,230 --> 00:09:59,940
at which you can see it happening then

259
00:09:59,940 --> 00:10:01,740
you may want to jump down one or two and

260
00:10:01,740 --> 00:10:03,030
figure out how you can stop their

261
00:10:03,030 --> 00:10:05,160
listing come on you don't want to follow

262
00:10:05,160 --> 00:10:06,840
somebody down that same path

263
00:10:06,840 --> 00:10:09,060
go because inevitably you're not going

264
00:10:09,060 --> 00:10:10,860
to be able to catch up with it

265
00:10:10,860 --> 00:10:13,380
but when we break this down a little bit

266
00:10:13,380 --> 00:10:15,210
we look at reconnaissance front

267
00:10:15,210 --> 00:10:16,950
perspective of somebody just trying to

268
00:10:16,950 --> 00:10:18,750
gain an understanding of our

269
00:10:18,750 --> 00:10:21,120
organization that could be as simple as

270
00:10:21,120 --> 00:10:24,089
to what's published about this from a

271
00:10:24,089 --> 00:10:26,400
open source perspective online things

272
00:10:26,400 --> 00:10:29,010
that you know could be found out it

273
00:10:29,010 --> 00:10:31,500
against this and some respect if you're

274
00:10:31,500 --> 00:10:35,130
in this space the spouse significant

275
00:10:35,130 --> 00:10:37,230
other parents cousins typically those

276
00:10:37,230 --> 00:10:39,000
are most weakest links because you could

277
00:10:39,000 --> 00:10:40,529
do everything your power to lock down

278
00:10:40,529 --> 00:10:41,940
some of your social media and everything

279
00:10:41,940 --> 00:10:43,770
else but some of your friends and family

280
00:10:43,770 --> 00:10:45,630
may not believe in that same thought

281
00:10:45,630 --> 00:10:47,880
process so people can leverage those

282
00:10:47,880 --> 00:10:49,170
type of people to kind of gain some

283
00:10:49,170 --> 00:10:50,670
information about you as well

284
00:10:50,670 --> 00:10:53,279
and if we're totally from an

285
00:10:53,279 --> 00:10:55,620
organization perspective not visible

286
00:10:55,620 --> 00:10:57,720
online it kind of makes it a little bit

287
00:10:57,720 --> 00:10:59,190
difficult for people to understand a

288
00:10:59,190 --> 00:11:01,800
product or an e-commerce in which we're

289
00:11:01,800 --> 00:11:05,220
trying to sell or use so from a

290
00:11:05,220 --> 00:11:07,140
weaponization perspective after we've

291
00:11:07,140 --> 00:11:09,150
gained enough knowledge from the

292
00:11:09,150 --> 00:11:10,710
reconnaissance perspective and we're

293
00:11:10,710 --> 00:11:13,260
going to look to craft or even some

294
00:11:13,260 --> 00:11:15,660
cases the vulnerabilities against that

295
00:11:15,660 --> 00:11:18,450
organization whether it be a zero-day

296
00:11:18,450 --> 00:11:20,520
again maybe that's not the space you run

297
00:11:20,520 --> 00:11:22,440
in but I'll tell you zero days are

298
00:11:22,440 --> 00:11:24,270
almost equivalent to eight days in my

299
00:11:24,270 --> 00:11:26,490
opinion all right because how often are

300
00:11:26,490 --> 00:11:28,080
people that are run out the next day and

301
00:11:28,080 --> 00:11:30,810
update their machines some organizations

302
00:11:30,810 --> 00:11:32,040
maybe yes but there's still some

303
00:11:32,040 --> 00:11:34,710
organizations running XP Tech I went to

304
00:11:34,710 --> 00:11:37,080
an organization head server 2000 still

305
00:11:37,080 --> 00:11:39,120
running all that infrastructure and let

306
00:11:39,120 --> 00:11:41,310
them tell it it was a vital piece and

307
00:11:41,310 --> 00:11:43,710
still as a vital piece from that

308
00:11:43,710 --> 00:11:45,780
perspective we go down into the delivery

309
00:11:45,780 --> 00:11:47,700
aspect and now we're trying to figure

310
00:11:47,700 --> 00:11:50,100
out how we can actually get it on the

311
00:11:50,100 --> 00:11:51,810
machine so we we've done some

312
00:11:51,810 --> 00:11:52,530
reconnaissance

313
00:11:52,530 --> 00:11:54,480
we've done some weaponization as far as

314
00:11:54,480 --> 00:11:56,670
our payload or initial payload now we

315
00:11:56,670 --> 00:11:58,589
just gotta get it actually to the

316
00:11:58,589 --> 00:12:00,889
machine itself and

317
00:12:00,889 --> 00:12:03,559
ease into the exploitation itself and

318
00:12:03,559 --> 00:12:05,629
then from there we're trying to install

319
00:12:05,629 --> 00:12:08,359
something now for the perspective of our

320
00:12:08,359 --> 00:12:10,549
stager this is where we start to come in

321
00:12:10,549 --> 00:12:12,049
we're trying to get our stager on a

322
00:12:12,049 --> 00:12:13,399
machine we're trying to put it in a

323
00:12:13,399 --> 00:12:15,410
subject place and which is not really

324
00:12:15,410 --> 00:12:17,629
installed but it's definitely there so

325
00:12:17,629 --> 00:12:19,970
it can be called upon once we have that

326
00:12:19,970 --> 00:12:21,919
executing that we actually are

327
00:12:21,919 --> 00:12:23,720
communicating with our situ server or

328
00:12:23,720 --> 00:12:26,419
servers from there we get to the point

329
00:12:26,419 --> 00:12:28,459
of going after whatever our objectives

330
00:12:28,459 --> 00:12:30,379
are but really the key piece that we're

331
00:12:30,379 --> 00:12:31,850
going to focus on is really these two

332
00:12:31,850 --> 00:12:33,470
things the installation of command and

333
00:12:33,470 --> 00:12:35,509
control that is really the basis for

334
00:12:35,509 --> 00:12:37,609
this talk right we've already assumed

335
00:12:37,609 --> 00:12:38,359
you've done some reconnaissance

336
00:12:38,359 --> 00:12:40,489
weaponization you've got it on the

337
00:12:40,489 --> 00:12:42,319
system and now you're at a point where

338
00:12:42,319 --> 00:12:44,119
you're actually just trying to get it

339
00:12:44,119 --> 00:12:45,980
installed so you can reach back out to

340
00:12:45,980 --> 00:12:51,559
your C to serve in way in which one

341
00:12:51,559 --> 00:12:54,350
could do that is kind of like so it

342
00:12:54,350 --> 00:12:57,319
would take the data it would convert it

343
00:12:57,319 --> 00:13:01,389
to bytes then base64 and then store it

344
00:13:01,389 --> 00:13:05,059
that's one way you could do this in

345
00:13:05,059 --> 00:13:07,040
reverse order you could do one of them

346
00:13:07,040 --> 00:13:08,569
all of them none of them it doesn't

347
00:13:08,569 --> 00:13:10,519
matter right like there is no wrong way

348
00:13:10,519 --> 00:13:12,679
to eat a Reese's there's really no wrong

349
00:13:12,679 --> 00:13:15,230
way to do this unless the defender has

350
00:13:15,230 --> 00:13:16,549
some type of device that's going to

351
00:13:16,549 --> 00:13:18,910
highlight it but this is not a

352
00:13:18,910 --> 00:13:21,410
one-size-fits-all thought process but

353
00:13:21,410 --> 00:13:23,480
this is definitely a way and we've

354
00:13:23,480 --> 00:13:24,799
already highlighted we're talking about

355
00:13:24,799 --> 00:13:25,910
this from a post exploitation

356
00:13:25,910 --> 00:13:28,009
perspective you're already on the

357
00:13:28,009 --> 00:13:30,860
machine cool we need to figure out the

358
00:13:30,860 --> 00:13:32,689
state of it or maybe the coast isn't

359
00:13:32,689 --> 00:13:33,949
clear for us to lay down some type of

360
00:13:33,949 --> 00:13:35,869
binary so from that perspective we are

361
00:13:35,869 --> 00:13:37,850
going to take a file this approach again

362
00:13:37,850 --> 00:13:38,989
our state there's going to be nothing

363
00:13:38,989 --> 00:13:41,059
but some actual code that's going to run

364
00:13:41,059 --> 00:13:43,309
out against something else for us the

365
00:13:43,309 --> 00:13:45,110
good thing about it is is there when we

366
00:13:45,110 --> 00:13:47,569
need so we don't have to keep going in

367
00:13:47,569 --> 00:13:50,180
there and then

368
00:13:50,180 --> 00:13:54,330
so for this presentation I'm gonna use

369
00:13:54,330 --> 00:13:58,140
the what shovel out before us so I'm

370
00:13:58,140 --> 00:14:00,270
going to utilize the power shell here

371
00:14:00,270 --> 00:14:04,680
I'm going to reach out to a c2 server

372
00:14:04,680 --> 00:14:06,450
that I'm gonna say is one or two one six

373
00:14:06,450 --> 00:14:08,250
eight zero at one hundred right now I

374
00:14:08,250 --> 00:14:11,910
have an on run over HTTP we can do HTTP

375
00:14:11,910 --> 00:14:13,350
we're gonna do some manual it as well

376
00:14:13,350 --> 00:14:15,570
but for a simplistic perspective that's

377
00:14:15,570 --> 00:14:17,430
what we're doing now the next line

378
00:14:17,430 --> 00:14:19,590
eventually converted into bytes and in

379
00:14:19,590 --> 00:14:21,140
the third line I'm gonna switch it to

380
00:14:21,140 --> 00:14:24,030
base64 and I'm gonna spit there base64

381
00:14:24,030 --> 00:14:27,420
out to the screen my c2 server I'm gonna

382
00:14:27,420 --> 00:14:29,940
call back on quad fours and in my

383
00:14:29,940 --> 00:14:31,980
payload was going to be a stage or dat

384
00:14:31,980 --> 00:14:35,610
ps1 I could just name it s or a right

385
00:14:35,610 --> 00:14:37,200
this is the good thing about this

386
00:14:37,200 --> 00:14:40,440
because ultimately this base64 encoded

387
00:14:40,440 --> 00:14:41,610
string is what's going to be on the

388
00:14:41,610 --> 00:14:42,180
system

389
00:14:42,180 --> 00:14:44,820
somebody decodes that what do I lose I

390
00:14:44,820 --> 00:14:47,850
lose that URL being an IP address domain

391
00:14:47,850 --> 00:14:50,100
I lose that port and I lose whatever

392
00:14:50,100 --> 00:14:52,850
that file name is now States at that ps1

393
00:14:52,850 --> 00:14:54,810
couldn't say any way to a person that

394
00:14:54,810 --> 00:14:56,670
this is a power show script goodness any

395
00:14:56,670 --> 00:14:58,530
way that it is a stager so if we name is

396
00:14:58,530 --> 00:15:01,320
something like a when a defender I'm

397
00:15:01,320 --> 00:15:03,990
looking at it I don't know what it is or

398
00:15:03,990 --> 00:15:06,240
what is this a I don't know it's

399
00:15:06,240 --> 00:15:08,310
whatever is hosted there at the time so

400
00:15:08,310 --> 00:15:09,990
at nine o'clock in the morning it could

401
00:15:09,990 --> 00:15:12,000
be some text that changes your screen

402
00:15:12,000 --> 00:15:14,460
blue at ten o'clock in the morning that

403
00:15:14,460 --> 00:15:16,950
same file could change your text for it

404
00:15:16,950 --> 00:15:20,030
so the good thing about it is is very

405
00:15:20,030 --> 00:15:22,440
agile in the sense of what we can do

406
00:15:22,440 --> 00:15:23,400
with it all right

407
00:15:23,400 --> 00:15:25,350
we're just posting whatever we need at

408
00:15:25,350 --> 00:15:28,670
the time and the place

409
00:15:28,800 --> 00:15:31,060
all right so the first one we're going

410
00:15:31,060 --> 00:15:33,040
to actually use is active directory

411
00:15:33,040 --> 00:15:36,130
directory is a great enterprise service

412
00:15:36,130 --> 00:15:37,360
it's going to provide some

413
00:15:37,360 --> 00:15:39,459
authentication and authorization across

414
00:15:39,459 --> 00:15:41,589
an enterprise if you're in the Windows

415
00:15:41,589 --> 00:15:43,660
environment especially the domain

416
00:15:43,660 --> 00:15:44,890
environment you're definitely going to

417
00:15:44,890 --> 00:15:47,260
have at the directory the objects in

418
00:15:47,260 --> 00:15:49,380
there are usually a rate in the sense of

419
00:15:49,380 --> 00:15:53,230
users computers there's some rooms but

420
00:15:53,230 --> 00:15:54,760
largely they're separated into

421
00:15:54,760 --> 00:15:58,870
organizational units for simplicity the

422
00:15:58,870 --> 00:16:01,390
database itself what we see word stored

423
00:16:01,390 --> 00:16:04,870
system 32 in TDs and it's going to be

424
00:16:04,870 --> 00:16:07,330
locked by default but no harm no foul

425
00:16:07,330 --> 00:16:09,880
for us we're not trying to take it when

426
00:16:09,880 --> 00:16:12,100
we look at the direct that week we see

427
00:16:12,100 --> 00:16:14,080
something like so now every apartment is

428
00:16:14,080 --> 00:16:15,520
going to be a little bit different in

429
00:16:15,520 --> 00:16:17,320
this perspective on the left hand side

430
00:16:17,320 --> 00:16:19,000
we have an East Coast

431
00:16:19,000 --> 00:16:21,550
oh you followed by Boston oh you and

432
00:16:21,550 --> 00:16:23,950
then we have some oh use under it with

433
00:16:23,950 --> 00:16:27,029
into Boston oh you we see a number of

434
00:16:27,029 --> 00:16:29,709
users some groups we see some

435
00:16:29,709 --> 00:16:31,779
descriptions all this good stuff so this

436
00:16:31,779 --> 00:16:34,600
is great this is typically how an admin

437
00:16:34,600 --> 00:16:36,520
would actually administer at the

438
00:16:36,520 --> 00:16:39,399
directory and we utilize this GUI some

439
00:16:39,399 --> 00:16:41,170
people look to utilize it through

440
00:16:41,170 --> 00:16:43,690
command line whether it be power show or

441
00:16:43,690 --> 00:16:46,149
some other of their party tool from the

442
00:16:46,149 --> 00:16:48,850
power show perspective we can see how

443
00:16:48,850 --> 00:16:50,950
we're using an AV user and we're able to

444
00:16:50,950 --> 00:16:52,959
get the same information from that to

445
00:16:52,959 --> 00:16:55,930
directly now this is good because you

446
00:16:55,930 --> 00:16:57,760
probably are in an organization been to

447
00:16:57,760 --> 00:16:59,980
an organization in which there's people

448
00:16:59,980 --> 00:17:01,600
who haven't worked there in some time

449
00:17:01,600 --> 00:17:03,760
and they're kind of still there or

450
00:17:03,760 --> 00:17:06,010
there's some service account who's

451
00:17:06,010 --> 00:17:07,709
trying to log into a computer and

452
00:17:07,709 --> 00:17:11,140
they're felling that authentication on a

453
00:17:11,140 --> 00:17:12,939
day to day basis right maybe they have a

454
00:17:12,939 --> 00:17:15,579
service account set up to perform some

455
00:17:15,579 --> 00:17:18,010
service and the Machine no longer exists

456
00:17:18,010 --> 00:17:21,140
or the password change or what have you

457
00:17:21,140 --> 00:17:23,569
here is that this is a goldmine for us

458
00:17:23,569 --> 00:17:26,720
so when we look at one individual object

459
00:17:26,720 --> 00:17:29,840
we'll see something like the above here

460
00:17:29,840 --> 00:17:31,580
and if I'm a power show perspective

461
00:17:31,580 --> 00:17:33,140
we're seeing some of that same data the

462
00:17:33,140 --> 00:17:35,060
interesting thing about Active Directory

463
00:17:35,060 --> 00:17:37,070
is that there's roughly 50 properties

464
00:17:37,070 --> 00:17:39,350
for us to actually use some of them have

465
00:17:39,350 --> 00:17:41,090
science limitations that were cognizant

466
00:17:41,090 --> 00:17:42,950
of that but the good thing about it is

467
00:17:42,950 --> 00:17:45,560
by default domain users can read Active

468
00:17:45,560 --> 00:17:47,480
Directory that's good seems like that

469
00:17:47,480 --> 00:17:49,370
just need to get some code in there and

470
00:17:49,370 --> 00:17:51,350
in no matter what machine and I'm trying

471
00:17:51,350 --> 00:17:53,690
to have a point out my second part of my

472
00:17:53,690 --> 00:17:55,400
code they'll be able to read their

473
00:17:55,400 --> 00:17:57,400
property and then go out and execute

474
00:17:57,400 --> 00:18:01,190
okay also now from the perspective of

475
00:18:01,190 --> 00:18:03,050
what that really looks like we can

476
00:18:03,050 --> 00:18:05,390
utilize so now up front when I was

477
00:18:05,390 --> 00:18:07,940
talking about my stager my base64 code

478
00:18:07,940 --> 00:18:10,370
will always be an encoded text for the

479
00:18:10,370 --> 00:18:13,610
context of this this brief so I'm going

480
00:18:13,610 --> 00:18:15,560
to utilize one of the three properties

481
00:18:15,560 --> 00:18:18,680
that isn't shown by default is it shown

482
00:18:18,680 --> 00:18:21,200
by default so if I were to go into the

483
00:18:21,200 --> 00:18:23,600
gooey aspect of Active Directory I

484
00:18:23,600 --> 00:18:26,030
wouldn't be able to see employee ID

485
00:18:26,030 --> 00:18:28,910
employee number or division except for

486
00:18:28,910 --> 00:18:31,250
with an attribute editor there's no

487
00:18:31,250 --> 00:18:32,960
other place that is shown right there by

488
00:18:32,960 --> 00:18:34,940
default wouldn't that have been cut that

489
00:18:34,940 --> 00:18:37,700
on maybe right but again this is all

490
00:18:37,700 --> 00:18:39,680
about being on my environment I say nine

491
00:18:39,680 --> 00:18:42,290
times out of ten they would so I have

492
00:18:42,290 --> 00:18:43,820
the ability where I'm going to call upon

493
00:18:43,820 --> 00:18:45,530
the user in this case I'm gonna do big

494
00:18:45,530 --> 00:18:47,540
shake and then I'm gonna set that 80

495
00:18:47,540 --> 00:18:50,060
users division property with whatever

496
00:18:50,060 --> 00:18:52,580
that base64 encode is again if they

497
00:18:52,580 --> 00:18:54,530
wouldn't the natural be a deterrent be

498
00:18:54,530 --> 00:18:57,350
able to see it now I could get a little

499
00:18:57,350 --> 00:19:00,890
more stealthy in this and I can add an

500
00:19:00,890 --> 00:19:04,310
actual property that big looks looks

501
00:19:04,310 --> 00:19:05,840
like it makes sense with division and

502
00:19:05,840 --> 00:19:08,120
push that down but for me simplistic

503
00:19:08,120 --> 00:19:09,440
perspective

504
00:19:09,440 --> 00:19:11,480
there now when I call upon it from the

505
00:19:11,480 --> 00:19:13,850
command line we see it as below yeah

506
00:19:13,850 --> 00:19:15,710
again I need somebody to go in an

507
00:19:15,710 --> 00:19:17,480
attribute editor it's actually look at

508
00:19:17,480 --> 00:19:20,570
that the fact is I would rather take my

509
00:19:20,570 --> 00:19:21,889
chances with this because I don't

510
00:19:21,889 --> 00:19:23,240
believe in end it's going to go on air

511
00:19:23,240 --> 00:19:25,370
and do it nor what it is sent out to a

512
00:19:25,370 --> 00:19:28,429
point in which they did would it be

513
00:19:28,429 --> 00:19:31,669
something that causes concern for the

514
00:19:31,669 --> 00:19:33,559
next one was the registry now that's my

515
00:19:33,559 --> 00:19:36,289
favorite actually because I was up that

516
00:19:36,289 --> 00:19:38,059
Microsoft and Charlotte actually like

517
00:19:38,059 --> 00:19:40,429
two weeks ago and I was having this

518
00:19:40,429 --> 00:19:41,929
conversation about the registry and

519
00:19:41,929 --> 00:19:44,149
there's so many keys there's so many

520
00:19:44,149 --> 00:19:47,480
values in the registry that I was

521
00:19:47,480 --> 00:19:49,700
willing to make a bet a 50-cent bet that

522
00:19:49,700 --> 00:19:51,350
there's no admin in a world who can tell

523
00:19:51,350 --> 00:19:53,600
you about every key every value and

524
00:19:53,600 --> 00:19:55,309
Windows machine all right there's just

525
00:19:55,309 --> 00:19:57,320
so much stuff and with that plethora of

526
00:19:57,320 --> 00:19:59,120
data that's there that seems like a good

527
00:19:59,120 --> 00:20:02,480
place for somebody to stage your code in

528
00:20:02,480 --> 00:20:04,039
my example I'm going to do one layer

529
00:20:04,039 --> 00:20:06,679
deep but largely speaking we want to go

530
00:20:06,679 --> 00:20:11,149
several layers deep so the registry is

531
00:20:11,149 --> 00:20:13,250
really formed like so we have our

532
00:20:13,250 --> 00:20:16,399
registry files on disk and then as we go

533
00:20:16,399 --> 00:20:18,350
through a process either the Windows

534
00:20:18,350 --> 00:20:20,870
system is self booting up or user log in

535
00:20:20,870 --> 00:20:23,330
those highs on disk it loaded into

536
00:20:23,330 --> 00:20:26,450
memory and then they become our actual

537
00:20:26,450 --> 00:20:29,059
hklm or HKC you the things that were

538
00:20:29,059 --> 00:20:30,950
customers seeing in the registry while

539
00:20:30,950 --> 00:20:33,529
we're logged on while the person is long

540
00:20:33,529 --> 00:20:35,269
gone those things are actually locked

541
00:20:35,269 --> 00:20:38,419
and they're not editable by a user the

542
00:20:38,419 --> 00:20:40,340
things that get loaded and where they

543
00:20:40,340 --> 00:20:42,470
sit on disk are as follows so we have

544
00:20:42,470 --> 00:20:44,779
Sam security software system default

545
00:20:44,779 --> 00:20:47,899
those all get loaded into H tell them or

546
00:20:47,899 --> 00:20:50,419
HK users and then we have the NT users

547
00:20:50,419 --> 00:20:52,940
our data and in actual user class like

548
00:20:52,940 --> 00:20:55,370
that those two sit in the users profile

549
00:20:55,370 --> 00:20:57,740
and they get voted into current user if

550
00:20:57,740 --> 00:20:59,870
I was logged on and we just did switch

551
00:20:59,870 --> 00:21:02,960
user rather than my NT user that getting

552
00:21:02,960 --> 00:21:05,929
unloaded I would then have my user hai

553
00:21:05,929 --> 00:21:09,340
moved over to HK users

554
00:21:09,340 --> 00:21:11,690
further perspective of the registry

555
00:21:11,690 --> 00:21:14,330
though again I'm one layer deep so on

556
00:21:14,330 --> 00:21:18,620
hklm software and I created a key I'm

557
00:21:18,620 --> 00:21:21,860
sorry value called updater 32 because

558
00:21:21,860 --> 00:21:25,190
frankly speaking if we had 32 or 64 onto

559
00:21:25,190 --> 00:21:27,410
majority of everything in Windows most

560
00:21:27,410 --> 00:21:29,210
people look at it but okay that looks

561
00:21:29,210 --> 00:21:32,510
legit and then we've added our code here

562
00:21:32,510 --> 00:21:35,630
again from a PowerShell perspective I'm

563
00:21:35,630 --> 00:21:37,610
just adding a new item and I see it

564
00:21:37,610 --> 00:21:40,070
there now if I get to the point where

565
00:21:40,070 --> 00:21:43,400
maybe this is too loud then again I

566
00:21:43,400 --> 00:21:45,230
would put in some patent to push it off

567
00:21:45,230 --> 00:21:47,750
the screen make it into where it is it

568
00:21:47,750 --> 00:21:49,100
would actually had the double-click and

569
00:21:49,100 --> 00:21:51,170
open it and with my padding I would have

570
00:21:51,170 --> 00:21:54,410
some other verbage up front one layer of

571
00:21:54,410 --> 00:21:55,880
deep right now we'd go like four or five

572
00:21:55,880 --> 00:21:58,970
layers it would be tough for admin to be

573
00:21:58,970 --> 00:22:00,620
able to see it there it will talk about

574
00:22:00,620 --> 00:22:05,360
some mitigation techniques though all

575
00:22:05,360 --> 00:22:07,970
right we have event logs now the bit

576
00:22:07,970 --> 00:22:10,010
bones are very interested from a good

577
00:22:10,010 --> 00:22:12,920
perspective we have Event Viewer these

578
00:22:12,920 --> 00:22:14,810
essentially provide some form of

579
00:22:14,810 --> 00:22:16,910
notification detailed notification of

580
00:22:16,910 --> 00:22:19,160
things happening on a system while the

581
00:22:19,160 --> 00:22:20,720
event mode provides a lot of information

582
00:22:20,720 --> 00:22:24,260
out the box a number of good injuries

583
00:22:24,260 --> 00:22:26,180
need to be in able to use an oddity and

584
00:22:26,180 --> 00:22:27,800
that's not really what we're here to

585
00:22:27,800 --> 00:22:29,870
talk about what we're looking to do is

586
00:22:29,870 --> 00:22:32,690
take advantage of the fact is good

587
00:22:32,690 --> 00:22:35,930
places for our code will be really

588
00:22:35,930 --> 00:22:38,210
anywhere that's cumbersome with a lot of

589
00:22:38,210 --> 00:22:40,700
data that an admin can overlook and a

590
00:22:40,700 --> 00:22:43,040
good thing here is this is a good place

591
00:22:43,040 --> 00:22:46,190
so the bad thing about it is typically

592
00:22:46,190 --> 00:22:48,530
these things are circular so as events

593
00:22:48,530 --> 00:22:51,110
howl up the code that we have in there

594
00:22:51,110 --> 00:22:53,960
could be overweight so really come back

595
00:22:53,960 --> 00:22:55,910
this will look at make it our own but

596
00:22:55,910 --> 00:22:57,410
when we talk about there's a lot of logs

597
00:22:57,410 --> 00:23:00,500
in here we're talking to the tune of 386

598
00:23:00,500 --> 00:23:04,270
ish just off of the server 2016 machine

599
00:23:04,270 --> 00:23:06,460
alright so

600
00:23:06,460 --> 00:23:08,130
that's a good place for us to be

601
00:23:08,130 --> 00:23:10,270
particularly speaking if we could name

602
00:23:10,270 --> 00:23:13,330
it in such a way at 32 or 64 or

603
00:23:13,330 --> 00:23:16,120
something on it which could be bypassed

604
00:23:16,120 --> 00:23:20,380
by an admin so I talked about making our

605
00:23:20,380 --> 00:23:22,570
own event logs and the reason for that

606
00:23:22,570 --> 00:23:25,120
is because if we look to put our stuff

607
00:23:25,120 --> 00:23:28,420
in application or the firewall or one of

608
00:23:28,420 --> 00:23:31,120
these other logs again our stuff may be

609
00:23:31,120 --> 00:23:33,460
overwritten and essentially put off the

610
00:23:33,460 --> 00:23:35,950
system when we put our stuff in our own

611
00:23:35,950 --> 00:23:38,680
custom log and it wraps some other stuff

612
00:23:38,680 --> 00:23:41,530
around it to make it look legit we stand

613
00:23:41,530 --> 00:23:43,710
a chance to live in any event bugs a lot

614
00:23:43,710 --> 00:23:46,300
so what we'll do is we'll create a new

615
00:23:46,300 --> 00:23:48,310
event log I'm going to call it Windows

616
00:23:48,310 --> 00:23:51,180
updater and I'm gonna create a source

617
00:23:51,180 --> 00:23:54,130
the source is nothing more then you'll

618
00:23:54,130 --> 00:23:55,960
see the top of the event log here where

619
00:23:55,960 --> 00:23:58,150
it says updater 64 it's da identifier

620
00:23:58,150 --> 00:24:01,000
for that actual log itself so we'll

621
00:24:01,000 --> 00:24:03,760
write out to the event log R a coded

622
00:24:03,760 --> 00:24:06,670
message so now I have my base 64 sitting

623
00:24:06,670 --> 00:24:09,310
there I can go back at another time and

624
00:24:09,310 --> 00:24:11,980
just make sure it's there and from there

625
00:24:11,980 --> 00:24:14,410
I have the ability to read that file

626
00:24:14,410 --> 00:24:17,110
call upon the message field and then

627
00:24:17,110 --> 00:24:18,520
type into something that's going to

628
00:24:18,520 --> 00:24:21,850
execute it again this contains my stager

629
00:24:21,850 --> 00:24:25,470
that sticker was nothing more than a URL

630
00:24:25,470 --> 00:24:27,910
wrapped in system that met that web

631
00:24:27,910 --> 00:24:30,490
client no harm no foul of this gets

632
00:24:30,490 --> 00:24:32,740
found I lose an IP address maybe a

633
00:24:32,740 --> 00:24:36,910
domain I lose essentially bad right in

634
00:24:36,910 --> 00:24:39,400
this case they see stated up on ps1 but

635
00:24:39,400 --> 00:24:41,080
they don't have access to that file they

636
00:24:41,080 --> 00:24:42,700
just see what I wouldn't be going out to

637
00:24:42,700 --> 00:24:46,470
get now they could get a little you know

638
00:24:46,470 --> 00:24:48,940
bicurious and go out there and try to

639
00:24:48,940 --> 00:24:50,860
have any gate to my server we're not

640
00:24:50,860 --> 00:24:52,300
really talking about how we're gonna

641
00:24:52,300 --> 00:24:54,220
stop that which we would be able to

642
00:24:54,220 --> 00:24:56,680
we're just more or less identify where

643
00:24:56,680 --> 00:24:59,020
we can store this stuff so we can go

644
00:24:59,020 --> 00:24:59,810
back and get stuff

645
00:24:59,810 --> 00:25:05,510
later on we also have group policy from

646
00:25:05,510 --> 00:25:08,720
policy is a little iffy but we looked at

647
00:25:08,720 --> 00:25:10,490
group policy to self that's going to be

648
00:25:10,490 --> 00:25:13,010
the hierarchical infrastructure that's

649
00:25:13,010 --> 00:25:14,510
going to be used to implement specific

650
00:25:14,510 --> 00:25:16,880
things whether it's probably miss

651
00:25:16,880 --> 00:25:19,940
elation settings or just really any

652
00:25:19,940 --> 00:25:21,320
other configuration that we could think

653
00:25:21,320 --> 00:25:24,440
of from an enterprise perspective we

654
00:25:24,440 --> 00:25:27,650
have policy management from a local

655
00:25:27,650 --> 00:25:30,230
system perspective we have the actual

656
00:25:30,230 --> 00:25:34,160
loop room policy itself does it really

657
00:25:34,160 --> 00:25:35,690
matter which one we're going to use we

658
00:25:35,690 --> 00:25:38,030
have the ability to store a code there

659
00:25:38,030 --> 00:25:40,730
from a management perspective we're

660
00:25:40,730 --> 00:25:42,620
going to utilize the description field

661
00:25:42,620 --> 00:25:45,920
well there's a number of editable things

662
00:25:45,920 --> 00:25:48,230
with a group policy that we can use the

663
00:25:48,230 --> 00:25:50,030
last thing we want to do is put our code

664
00:25:50,030 --> 00:25:52,190
in something that has some adverse

665
00:25:52,190 --> 00:25:54,800
action on the box so we'll look to put

666
00:25:54,800 --> 00:25:57,500
it in the actual comment field able to

667
00:25:57,500 --> 00:25:59,060
do that we'll call upon our default

668
00:25:59,060 --> 00:26:00,350
domain policy because I thought it's

669
00:26:00,350 --> 00:26:02,870
going to be implemented everywhere and

670
00:26:02,870 --> 00:26:05,150
then we're going to store our encoded

671
00:26:05,150 --> 00:26:07,760
text and description now when we do that

672
00:26:07,760 --> 00:26:10,400
I see it just at the bottom there and I

673
00:26:10,400 --> 00:26:12,620
could comment normally I wouldn't care

674
00:26:12,620 --> 00:26:14,780
as much but this is one of those things

675
00:26:14,780 --> 00:26:17,270
that I feel like an admin would be in

676
00:26:17,270 --> 00:26:19,370
group policy clicking around and it

677
00:26:19,370 --> 00:26:21,830
would stand out so I'm not too keen

678
00:26:21,830 --> 00:26:25,040
about leaving out there what I look to

679
00:26:25,040 --> 00:26:28,790
do following this was to add in seven

680
00:26:28,790 --> 00:26:30,590
new lines so what powers oh we're just

681
00:26:30,590 --> 00:26:32,810
adding in new lines and then I want to

682
00:26:32,810 --> 00:26:35,390
put my encoded text so I'll look to see

683
00:26:35,390 --> 00:26:37,850
what that does for me and lo and behold

684
00:26:37,850 --> 00:26:41,150
that actually pushes that code down okay

685
00:26:41,150 --> 00:26:42,320
I'm on to something

686
00:26:42,320 --> 00:26:45,230
seven new lines pushed it down so now I

687
00:26:45,230 --> 00:26:47,360
look to do that a little bit more and in

688
00:26:47,360 --> 00:26:50,840
this case ended up doing 20 when I do

689
00:26:50,840 --> 00:26:53,120
that based upon the screen there's no

690
00:26:53,120 --> 00:26:55,220
size that the user can make it in which

691
00:26:55,220 --> 00:26:58,250
there they be able to see that however I

692
00:26:58,250 --> 00:26:58,940
don't look

693
00:26:58,940 --> 00:27:00,680
from a PowerShell perspective they call

694
00:27:00,680 --> 00:27:02,780
upon it and in this case I have a

695
00:27:02,780 --> 00:27:05,420
variable called retrieve I see that

696
00:27:05,420 --> 00:27:07,400
blank space essentially those 20 new

697
00:27:07,400 --> 00:27:10,580
lines and then I see my code this is a

698
00:27:10,580 --> 00:27:12,050
good chance that I'm willing to take at

699
00:27:12,050 --> 00:27:14,510
the moment not knowing who the admin is

700
00:27:14,510 --> 00:27:16,790
nor do I know how they actually do their

701
00:27:16,790 --> 00:27:19,460
job but I know one thing most admins are

702
00:27:19,460 --> 00:27:21,050
not going to be using a command line to

703
00:27:21,050 --> 00:27:24,020
to administer policy they're going to be

704
00:27:24,020 --> 00:27:26,720
in group policy management or the local

705
00:27:26,720 --> 00:27:29,330
group policy window itself and they

706
00:27:29,330 --> 00:27:31,480
won't be able to see that to the screen

707
00:27:31,480 --> 00:27:34,250
and then us will actually execute that

708
00:27:34,250 --> 00:27:36,800
there's nothing more than calling upon

709
00:27:36,800 --> 00:27:38,420
it and pass it into some type of

710
00:27:38,420 --> 00:27:41,120
execution engine and on actually demo of

711
00:27:41,120 --> 00:27:47,000
doing one of these at the end then we

712
00:27:47,000 --> 00:27:49,370
have alternate data streams now what's

713
00:27:49,370 --> 00:27:51,140
interesting about that is if you've been

714
00:27:51,140 --> 00:27:52,490
in this space for a while you may be

715
00:27:52,490 --> 00:27:54,620
saying well alternate data streams isn't

716
00:27:54,620 --> 00:27:59,060
new I recognize that but it still works

717
00:27:59,060 --> 00:28:01,610
all right so as long as it works we're

718
00:28:01,610 --> 00:28:03,980
still going to use it now what maybe do

719
00:28:03,980 --> 00:28:06,440
is that we're gonna put some malicious

720
00:28:06,440 --> 00:28:08,540
code in here people hiding data in there

721
00:28:08,540 --> 00:28:11,630
yeah it's been anything but when we look

722
00:28:11,630 --> 00:28:13,790
at alternate data streams definitely

723
00:28:13,790 --> 00:28:15,410
something as part of NTFS file system

724
00:28:15,410 --> 00:28:18,170
was made as a cross compatibility for

725
00:28:18,170 --> 00:28:23,030
Mac OS by default has a stream of dollar

726
00:28:23,030 --> 00:28:25,030
sign data

727
00:28:25,030 --> 00:28:27,100
also the dentist rooms also used by

728
00:28:27,100 --> 00:28:28,840
Internet Explorer depending on if you

729
00:28:28,840 --> 00:28:31,630
have your internet itself set up have

730
00:28:31,630 --> 00:28:33,159
you ever downloaded something trying to

731
00:28:33,159 --> 00:28:35,260
execute it it tells you hey this came

732
00:28:35,260 --> 00:28:36,700
from the internet you shouldn't trust it

733
00:28:36,700 --> 00:28:38,409
or what have you it's like well happy

734
00:28:38,409 --> 00:28:40,360
you know that well there's an alternate

735
00:28:40,360 --> 00:28:41,830
data stream associated with the causes

736
00:28:41,830 --> 00:28:45,010
of the identifier and it has a tag Adir

737
00:28:45,010 --> 00:28:46,870
telling you that the file came from the

738
00:28:46,870 --> 00:28:49,570
Internet we can easily remove it we can

739
00:28:49,570 --> 00:28:51,760
easily add some stuff to it that's

740
00:28:51,760 --> 00:28:53,860
interesting so in this case we'll look

741
00:28:53,860 --> 00:28:56,530
to make our own so we can actually get

742
00:28:56,530 --> 00:28:59,679
around it now as we look at this I'm

743
00:28:59,679 --> 00:29:01,390
going to get the metadata associated

744
00:29:01,390 --> 00:29:04,270
with this item and it's called my file

745
00:29:04,270 --> 00:29:06,880
all I did was make a blank file or empty

746
00:29:06,880 --> 00:29:09,880
file and I see the link is 0 I'm gonna

747
00:29:09,880 --> 00:29:12,280
write some green eggs and ham type stuff

748
00:29:12,280 --> 00:29:14,470
to a alternate data stream that I called

749
00:29:14,470 --> 00:29:16,720
my stream when I look at it it's going

750
00:29:16,720 --> 00:29:20,409
to be $35.99 bytes but again the size of

751
00:29:20,409 --> 00:29:22,450
the original file the host file itself

752
00:29:22,450 --> 00:29:26,200
isn't altered so that's cool now I need

753
00:29:26,200 --> 00:29:27,700
to figure out the place to put it and

754
00:29:27,700 --> 00:29:29,620
wish this thing doesn't get overwritten

755
00:29:29,620 --> 00:29:33,750
or messed with what on a local machine

756
00:29:33,750 --> 00:29:36,220
then this is a good place right

757
00:29:36,220 --> 00:29:39,130
it's hijos definitely not to be there

758
00:29:39,130 --> 00:29:41,830
you're not going to touch it feel pretty

759
00:29:41,830 --> 00:29:43,419
confident about this know the

760
00:29:43,419 --> 00:29:45,610
environment won't dictate where is a

761
00:29:45,610 --> 00:29:48,340
good place but as he host seems good for

762
00:29:48,340 --> 00:29:50,950
me so I'm going to take that file that's

763
00:29:50,950 --> 00:29:53,289
already there I'm gonna add content to

764
00:29:53,289 --> 00:29:55,150
it and the content that I'm going to add

765
00:29:55,150 --> 00:29:58,059
is a alternate data stream called secret

766
00:29:58,059 --> 00:29:59,950
stream the thing I'm going to fill with

767
00:29:59,950 --> 00:30:02,980
it is encoded text so for me to actually

768
00:30:02,980 --> 00:30:05,049
see this I'm going to need either power

769
00:30:05,049 --> 00:30:06,940
show or some other tool could be able to

770
00:30:06,940 --> 00:30:08,830
see that all to the data stream in this

771
00:30:08,830 --> 00:30:10,390
case at the bottom I'm going to go and

772
00:30:10,390 --> 00:30:14,040
read that and I see my color

773
00:30:14,040 --> 00:30:18,080
again this is nothing more than a stager

774
00:30:19,580 --> 00:30:22,559
all right then we have the environment

775
00:30:22,559 --> 00:30:25,880
variables all right these things are

776
00:30:25,880 --> 00:30:28,410
dynamic in our environment and they're

777
00:30:28,410 --> 00:30:30,840
really based upon the system itself so

778
00:30:30,840 --> 00:30:33,660
when we had up here a while ago when

779
00:30:33,660 --> 00:30:35,820
dirt we that was essentially a

780
00:30:35,820 --> 00:30:38,280
environment variable and say you waited

781
00:30:38,280 --> 00:30:39,900
we're out when those directory was on

782
00:30:39,900 --> 00:30:42,540
that machine there is a number of them

783
00:30:42,540 --> 00:30:44,850
there but it makes it to where you don't

784
00:30:44,850 --> 00:30:47,250
have to hard code stuff in some people

785
00:30:47,250 --> 00:30:49,890
would do the baseline installation when

786
00:30:49,890 --> 00:30:51,780
it comes to windows other people install

787
00:30:51,780 --> 00:30:53,910
windows on that say their D Drive so

788
00:30:53,910 --> 00:30:56,580
Alton I'm sorry if our new variables

789
00:30:56,580 --> 00:30:58,470
help us with that there's two types

790
00:30:58,470 --> 00:31:00,900
there's going to be user specific and

791
00:31:00,900 --> 00:31:02,309
then there's going to be system once

792
00:31:02,309 --> 00:31:04,559
system one's a global nature going to

793
00:31:04,559 --> 00:31:07,590
persist past reboots so this seems like

794
00:31:07,590 --> 00:31:10,320
an awesome place for us to put things in

795
00:31:10,320 --> 00:31:14,600
so we can go back and grab them later on

796
00:31:14,870 --> 00:31:17,340
the way we would do that is like so

797
00:31:17,340 --> 00:31:20,250
we'll create a new environment variable

798
00:31:20,250 --> 00:31:22,049
I'm going to call it program common

799
00:31:22,049 --> 00:31:26,580
program W 64y because there's already a

800
00:31:26,580 --> 00:31:30,809
common program W there okay so I put 64

801
00:31:30,809 --> 00:31:32,700
next to it most people will say this

802
00:31:32,700 --> 00:31:34,290
legit and keep going about their

803
00:31:34,290 --> 00:31:34,740
business

804
00:31:34,740 --> 00:31:39,090
so we'll store it in our deucer run

805
00:31:39,090 --> 00:31:41,429
space first and then the second line is

806
00:31:41,429 --> 00:31:42,750
us doing it from a system-wide

807
00:31:42,750 --> 00:31:44,549
perspective the reason why we're going

808
00:31:44,549 --> 00:31:46,200
to put in our user space first is

809
00:31:46,200 --> 00:31:48,630
because what we add the system-wide one

810
00:31:48,630 --> 00:31:50,880
it doesn't kick in or take effect until

811
00:31:50,880 --> 00:31:53,130
we reboot the box so I don't want to

812
00:31:53,130 --> 00:31:53,880
affect

813
00:31:53,880 --> 00:31:56,340
whatever system I'm on but I do want to

814
00:31:56,340 --> 00:31:58,200
be able to get after the task I'm using

815
00:31:58,200 --> 00:32:01,860
right now so when we do this we had

816
00:32:01,860 --> 00:32:06,179
something like so we have it being

817
00:32:06,179 --> 00:32:09,330
written to the registry we have to be

818
00:32:09,330 --> 00:32:11,400
written to the actual environment drive

819
00:32:11,400 --> 00:32:13,320
within PowerShell and what we wouldn't

820
00:32:13,320 --> 00:32:15,750
looked at our system variables like

821
00:32:15,750 --> 00:32:18,419
right clicking computer properties we

822
00:32:18,419 --> 00:32:21,510
see in there now I'm not concerned what

823
00:32:21,510 --> 00:32:22,890
people looking at it for PowerShell

824
00:32:22,890 --> 00:32:25,890
that's a one-off skill or one-off thing

825
00:32:25,890 --> 00:32:27,409
that people would actually use that

826
00:32:27,409 --> 00:32:29,669
necessarily looked worried about people

827
00:32:29,669 --> 00:32:31,289
looking at it from the registry I don't

828
00:32:31,289 --> 00:32:33,210
see evidence doing that too often if

829
00:32:33,210 --> 00:32:36,630
anything and it may look there if

830
00:32:36,630 --> 00:32:40,289
anything so we'll look to push that off

831
00:32:40,289 --> 00:32:42,659
so and the way we will look to do that

832
00:32:42,659 --> 00:32:44,850
is kind of like what we did before with

833
00:32:44,850 --> 00:32:46,950
some padding instead of doing new lines

834
00:32:46,950 --> 00:32:49,080
we'll just add some padding to up front

835
00:32:49,080 --> 00:32:52,230
in this case that it was like seven or

836
00:32:52,230 --> 00:32:55,799
eight spaces that we had in there we're

837
00:32:55,799 --> 00:32:57,600
doing a little bit more and now we've

838
00:32:57,600 --> 00:32:59,730
totally pushed it off the screen again

839
00:32:59,730 --> 00:33:01,350
if I was concerned about somebody

840
00:33:01,350 --> 00:33:03,120
double-clicking it they would be able to

841
00:33:03,120 --> 00:33:05,820
see it but if I'm concerned about that I

842
00:33:05,820 --> 00:33:08,210
can add some text in there maybe I could

843
00:33:08,210 --> 00:33:11,340
see one of those something right and in

844
00:33:11,340 --> 00:33:13,559
a number of padded characters just a

845
00:33:13,559 --> 00:33:15,210
push to rest up it off the screen and

846
00:33:15,210 --> 00:33:17,370
then when we call upon this key we can

847
00:33:17,370 --> 00:33:20,190
get rid of the fake text and the padding

848
00:33:20,190 --> 00:33:22,409
and then executed but from this

849
00:33:22,409 --> 00:33:24,360
perspective we have the ability to

850
00:33:24,360 --> 00:33:27,990
actually store this on our system

851
00:33:27,990 --> 00:33:31,930
and the full code looks like so so that

852
00:33:31,930 --> 00:33:35,800
very first line we have a space and then

853
00:33:35,800 --> 00:33:38,020
we're going to Pat it with 116 of them

854
00:33:38,020 --> 00:33:39,910
and then we're going to add in our

855
00:33:39,910 --> 00:33:42,220
encoded text and it would just continue

856
00:33:42,220 --> 00:33:46,140
at all like we've created it before

857
00:33:50,010 --> 00:33:54,000
all right and then we have WMI and sim

858
00:33:54,000 --> 00:33:55,290
so when those management instrumentation

859
00:33:55,290 --> 00:33:59,190
and then common information model WMI

860
00:33:59,190 --> 00:34:04,890
was Microsoft's response to w bill all

861
00:34:04,890 --> 00:34:07,290
right so it's gonna be the whole web

862
00:34:07,290 --> 00:34:09,690
based enterprise management aspect which

863
00:34:09,690 --> 00:34:12,899
was really a initiative to get after how

864
00:34:12,899 --> 00:34:14,520
do we share information amongst the

865
00:34:14,520 --> 00:34:16,379
system and a number of the system so

866
00:34:16,379 --> 00:34:18,449
Microsoft's implementation event is w

867
00:34:18,449 --> 00:34:20,520
online W Maya has been around for a long

868
00:34:20,520 --> 00:34:22,710
time we're talking about roughly 1990s

869
00:34:22,710 --> 00:34:24,869
and it was made available within

870
00:34:24,869 --> 00:34:27,899
PowerShell up until version 2 with

871
00:34:27,899 --> 00:34:29,969
version 3 Arkansas has done away with

872
00:34:29,969 --> 00:34:31,590
that and they've come out with the

873
00:34:31,590 --> 00:34:34,649
common information model I also work

874
00:34:34,649 --> 00:34:36,600
when we start talking about modern

875
00:34:36,600 --> 00:34:38,100
version of Windows modern version of

876
00:34:38,100 --> 00:34:40,260
power shelves that's the method in which

877
00:34:40,260 --> 00:34:43,889
they're going forth with WM I assume it

878
00:34:43,889 --> 00:34:46,109
utilizes a number of classes and

879
00:34:46,109 --> 00:34:49,530
namespaces largely these things are way

880
00:34:49,530 --> 00:34:51,780
too large for an end to be able to

881
00:34:51,780 --> 00:34:54,090
understand but nonetheless we'll dive a

882
00:34:54,090 --> 00:34:56,699
little bit deeper to these namespaces of

883
00:34:56,699 --> 00:34:59,190
organizations of classes themselves so

884
00:34:59,190 --> 00:35:02,850
let's say we had 130 to process for

885
00:35:02,850 --> 00:35:05,280
example that allows us to get running

886
00:35:05,280 --> 00:35:08,910
processes off of a machine and then that

887
00:35:08,910 --> 00:35:11,609
itself as a class would fall under some

888
00:35:11,609 --> 00:35:12,869
type of namespace

889
00:35:12,869 --> 00:35:14,340
maybe that namespace would have

890
00:35:14,340 --> 00:35:18,170
processes services the ability to read

891
00:35:18,170 --> 00:35:20,310
environment variables or a number of

892
00:35:20,310 --> 00:35:22,619
other things so namespaces are

893
00:35:22,619 --> 00:35:25,140
essentially buckets and in the classes

894
00:35:25,140 --> 00:35:27,750
themselves actually allow us to get the

895
00:35:27,750 --> 00:35:29,590
information the class

896
00:35:29,590 --> 00:35:32,080
so they have properties and methods so

897
00:35:32,080 --> 00:35:33,670
when we look at properties those are

898
00:35:33,670 --> 00:35:35,500
going to be essentially attributes about

899
00:35:35,500 --> 00:35:37,570
something and when we look at methods

900
00:35:37,570 --> 00:35:39,610
those are going to be actions that we

901
00:35:39,610 --> 00:35:41,710
can take so this is all kind of

902
00:35:41,710 --> 00:35:44,290
interesting because we can utilize that

903
00:35:44,290 --> 00:35:47,140
your lie and really sim to get after our

904
00:35:47,140 --> 00:35:49,510
task of finding a place to store our

905
00:35:49,510 --> 00:35:52,390
code and we're going to do that outside

906
00:35:52,390 --> 00:35:54,280
of what they already have we're going to

907
00:35:54,280 --> 00:35:56,410
make our own because if we make our own

908
00:35:56,410 --> 00:35:59,320
there's no signature for it but

909
00:35:59,320 --> 00:36:01,930
depending on our machine the number of

910
00:36:01,930 --> 00:36:06,370
these classes kind of they swing in a

911
00:36:06,370 --> 00:36:08,260
sense of number on the machine that I

912
00:36:08,260 --> 00:36:09,820
was on to think this wasn't Windows 10 I

913
00:36:09,820 --> 00:36:10,630
did this on

914
00:36:10,630 --> 00:36:13,570
I had roughly 10,000 classes roughly

915
00:36:13,570 --> 00:36:15,670
10,000 right

916
00:36:15,670 --> 00:36:18,340
that's huge these classes are made

917
00:36:18,340 --> 00:36:19,870
available based upon what type of

918
00:36:19,870 --> 00:36:21,430
software we have we'll install it on the

919
00:36:21,430 --> 00:36:25,240
machine but let's be real 10000 like

920
00:36:25,240 --> 00:36:27,790
that that's going to be difficult for a

921
00:36:27,790 --> 00:36:30,010
admin to transfer they don't want to get

922
00:36:30,010 --> 00:36:33,040
after it another way and we're going to

923
00:36:33,040 --> 00:36:38,140
do that is when I walk through so I got

924
00:36:38,140 --> 00:36:41,100
a machine here

925
00:36:45,870 --> 00:36:52,000
okay cool so I have a website that is

926
00:36:52,000 --> 00:36:55,300
being hosted by PowerShell it's nothing

927
00:36:55,300 --> 00:36:57,940
more than a a simple web server so if

928
00:36:57,940 --> 00:36:59,590
you're used to Python if you've heard of

929
00:36:59,590 --> 00:37:02,050
simple HTTP server the same thing in

930
00:37:02,050 --> 00:37:07,870
PowerShell and it's literally roughly 18

931
00:37:07,870 --> 00:37:12,089
lines so oh you know seeing in this

932
00:37:21,950 --> 00:37:24,530
okay now you see cool so we're talking

933
00:37:24,530 --> 00:37:27,859
roughly eighteen lines makes up this web

934
00:37:27,859 --> 00:37:28,130
show

935
00:37:28,130 --> 00:37:30,079
interesting about this I will shut up

936
00:37:30,079 --> 00:37:33,170
this website is it serves up everything

937
00:37:33,170 --> 00:37:37,640
that's on my actual desktop so we can

938
00:37:37,640 --> 00:37:43,640
come in here and from a command line

939
00:37:43,640 --> 00:37:46,390
perspective

940
00:37:49,059 --> 00:37:50,919
we'll just see if we can interact with

941
00:37:50,919 --> 00:37:54,009
the website and we can so the very thing

942
00:37:54,009 --> 00:37:57,279
that we call it upon stated ps1 if you

943
00:37:57,279 --> 00:37:59,319
look at the third line under was being

944
00:37:59,319 --> 00:38:02,019
returned it has a comm object which it's

945
00:38:02,019 --> 00:38:05,499
going to spit out a by the text form if

946
00:38:05,499 --> 00:38:08,199
you will right by the pop up box in this

947
00:38:08,199 --> 00:38:10,089
case is just a pop up box but you could

948
00:38:10,089 --> 00:38:12,069
really host whatever you want all right

949
00:38:12,069 --> 00:38:14,469
it could be another piece of code that

950
00:38:14,469 --> 00:38:17,169
is called upon another site to download

951
00:38:17,169 --> 00:38:19,209
something the good thing about how we're

952
00:38:19,209 --> 00:38:21,489
doing is is that that script that we're

953
00:38:21,489 --> 00:38:23,559
downloading at stay for that ps1 never

954
00:38:23,559 --> 00:38:25,929
touches this system the contents of it

955
00:38:25,929 --> 00:38:28,779
are downloaded and stored in memory all

956
00:38:28,779 --> 00:38:30,249
right for the context of wishes

957
00:38:30,249 --> 00:38:32,109
processes write it in so the Pentagon

958
00:38:32,109 --> 00:38:35,439
would type of ap we may have this spent

959
00:38:35,439 --> 00:38:37,390
a high chance of not being caught all

960
00:38:37,390 --> 00:38:39,039
right because I would expect my Navy to

961
00:38:39,039 --> 00:38:40,449
catch anything that I put on my disk

962
00:38:40,449 --> 00:38:43,479
malicious with anything not maybe not so

963
00:38:43,479 --> 00:38:48,400
much so I'm going to create a new class

964
00:38:48,400 --> 00:38:53,949
called 132 defend 64 it does not exist

965
00:38:53,949 --> 00:38:57,219
and the way we do that is we're going to

966
00:38:57,219 --> 00:39:00,969
create a new object and then we're going

967
00:39:00,969 --> 00:39:04,449
to actually save it cool so I have a new

968
00:39:04,449 --> 00:39:08,079
class that I'm gonna call when 32 61 230

969
00:39:08,079 --> 00:39:11,499
to defend 64 from there I'm going to

970
00:39:11,499 --> 00:39:13,630
create a new property and as you will

971
00:39:13,630 --> 00:39:15,009
call the properties were nothing more

972
00:39:15,009 --> 00:39:17,229
than attributes so I'm going to call

973
00:39:17,229 --> 00:39:21,039
this property my property I'll store

974
00:39:21,039 --> 00:39:23,519
there just a string and it's going to be

975
00:39:23,519 --> 00:39:26,079
you know just a simple test to see if I

976
00:39:26,079 --> 00:39:27,969
can actually write that to it I'll go

977
00:39:27,969 --> 00:39:30,219
back and verify that it's there and we

978
00:39:30,219 --> 00:39:33,159
can see down below the second line there

979
00:39:33,159 --> 00:39:35,919
it says value this is just a test to see

980
00:39:35,919 --> 00:39:37,590
if data could be stored

981
00:39:37,590 --> 00:39:40,230
okay awesome so David can't be stored

982
00:39:40,230 --> 00:39:44,240
I'm going to go back through and take my

983
00:39:44,240 --> 00:39:48,030
stagers drink and now I'm going to start

984
00:39:48,030 --> 00:39:53,550
the process of converting it to base64

985
00:39:53,550 --> 00:39:58,290
so I can save it but as such I just have

986
00:39:58,290 --> 00:40:01,580
my strengths cool

987
00:40:01,580 --> 00:40:04,860
so then we'll convert it to bytes will

988
00:40:04,860 --> 00:40:07,620
convert it to base64 and then we'll

989
00:40:07,620 --> 00:40:11,400
verify that it's there and this is what

990
00:40:11,400 --> 00:40:15,570
I'm stored on disk so very mental if we

991
00:40:15,570 --> 00:40:17,700
see that this amount of characters is

992
00:40:17,700 --> 00:40:20,160
what's rendered would just add strength

993
00:40:20,160 --> 00:40:21,750
imagine if we were trying to put a

994
00:40:21,750 --> 00:40:24,930
binary imagine if that binary cost us

995
00:40:24,930 --> 00:40:27,630
some money right maybe it was through

996
00:40:27,630 --> 00:40:29,670
man-hours of development maybe we pushed

997
00:40:29,670 --> 00:40:31,560
purchased it from some other type of

998
00:40:31,560 --> 00:40:35,160
organization but nonetheless let's think

999
00:40:35,160 --> 00:40:37,200
about the cost associated with it

1000
00:40:37,200 --> 00:40:39,750
so I'm going to create another property

1001
00:40:39,750 --> 00:40:43,080
I'll call it pad and then I'll store it

1002
00:40:43,080 --> 00:40:47,220
near my actual base64 code and then when

1003
00:40:47,220 --> 00:40:49,290
I go back to actually look at it I see

1004
00:40:49,290 --> 00:40:52,080
my base64 code I also see that strength

1005
00:40:52,080 --> 00:40:54,870
up top that we call it boner earlier so

1006
00:40:54,870 --> 00:40:56,670
now it's sitting here I can restart the

1007
00:40:56,670 --> 00:40:58,830
box I can go about my very married

1008
00:40:58,830 --> 00:41:00,900
business I can come back to one flater

1009
00:41:00,900 --> 00:41:03,570
and I can utilize this code as here so

1010
00:41:03,570 --> 00:41:05,850
long as this box doesn't get we start

1011
00:41:05,850 --> 00:41:08,760
that we started we formatted or gone

1012
00:41:08,760 --> 00:41:11,460
offline I have it there for as long as I

1013
00:41:11,460 --> 00:41:13,760
need you

1014
00:41:14,779 --> 00:41:17,460
when it's time for me to actually run it

1015
00:41:17,460 --> 00:41:21,450
I can call upon it like so verifying

1016
00:41:21,450 --> 00:41:25,049
that's there and then we can actually

1017
00:41:25,049 --> 00:41:27,839
execute it in this case is just a pop-up

1018
00:41:27,839 --> 00:41:31,559
box again maybe it's a next stage

1019
00:41:31,559 --> 00:41:33,930
downloader where it goes out to my site

1020
00:41:33,930 --> 00:41:35,849
and instead of pulling back this little

1021
00:41:35,849 --> 00:41:38,489
pop-up box it pulls down a binary maybe

1022
00:41:38,489 --> 00:41:41,220
I tell it to survey the system telling

1023
00:41:41,220 --> 00:41:43,170
me you know what users log on was to

1024
00:41:43,170 --> 00:41:45,299
architecture was to help the status as

1025
00:41:45,299 --> 00:41:48,599
far as how often they updated maybe I

1026
00:41:48,599 --> 00:41:51,029
tell it to execute a key logger for a

1027
00:41:51,029 --> 00:41:52,319
period of time and it bring that

1028
00:41:52,319 --> 00:41:55,789
information back really the

1029
00:41:55,789 --> 00:41:58,109
opportunities D the things that we could

1030
00:41:58,109 --> 00:42:00,119
be worth endless and I don't even have

1031
00:42:00,119 --> 00:42:02,249
to change the name of this so right now

1032
00:42:02,249 --> 00:42:05,190
it's danger got ps1 but on my c2 server

1033
00:42:05,190 --> 00:42:07,979
I can just open that up put some other

1034
00:42:07,979 --> 00:42:09,690
stuff in there and then the next time it

1035
00:42:09,690 --> 00:42:11,549
comes to reach back and grab it it

1036
00:42:11,549 --> 00:42:14,309
executes stat so it's very dynamic and

1037
00:42:14,309 --> 00:42:17,660
modular in that perspective

1038
00:42:23,810 --> 00:42:26,010
now about the first person that dick

1039
00:42:26,010 --> 00:42:28,670
about stagers all right so as we look at

1040
00:42:28,670 --> 00:42:31,470
1971 with the creeper bow where to where

1041
00:42:31,470 --> 00:42:33,750
we're at now there's a lot of people in

1042
00:42:33,750 --> 00:42:36,780
between more so in the last 10 years

1043
00:42:36,780 --> 00:42:39,000
that really have jumped on this where we

1044
00:42:39,000 --> 00:42:42,420
see a number of threat sets that are

1045
00:42:42,420 --> 00:42:44,730
starting to use multi stage or a stage

1046
00:42:44,730 --> 00:42:46,950
malware and from my perspective I think

1047
00:42:46,950 --> 00:42:48,750
it's more common than what we believe

1048
00:42:48,750 --> 00:42:51,030
right but we see people using proxies

1049
00:42:51,030 --> 00:42:52,710
I'm in order to retrieve additional

1050
00:42:52,710 --> 00:42:55,770
payloads why because the malware which

1051
00:42:55,770 --> 00:42:57,450
they want to lay on that system too

1052
00:42:57,450 --> 00:42:59,130
costly for them to go out there and just

1053
00:42:59,130 --> 00:43:01,580
do it from the beginning we have them

1054
00:43:01,580 --> 00:43:04,320
utilizing that payload or really Dennis

1055
00:43:04,320 --> 00:43:06,510
danger to understand the Machine we see

1056
00:43:06,510 --> 00:43:09,180
that's where backspace does again why

1057
00:43:09,180 --> 00:43:12,270
would I take time to to install or lay

1058
00:43:12,270 --> 00:43:13,710
down something that we've spent a lot of

1059
00:43:13,710 --> 00:43:15,840
time and money on just to have it set up

1060
00:43:15,840 --> 00:43:18,750
by some type of heavy burners and then

1061
00:43:18,750 --> 00:43:20,670
we see stuff like muddy water all right

1062
00:43:20,670 --> 00:43:23,280
muddy water at the bottom it utilizes it

1063
00:43:23,280 --> 00:43:24,930
so they can download the numeration

1064
00:43:24,930 --> 00:43:26,910
scripts to better understand the machine

1065
00:43:26,910 --> 00:43:30,660
before it goes on now nothing in life

1066
00:43:30,660 --> 00:43:33,480
comes without you know some good and bad

1067
00:43:33,480 --> 00:43:36,480
in this case we have some pros very

1068
00:43:36,480 --> 00:43:38,310
lightweight you see that that was

1069
00:43:38,310 --> 00:43:40,830
essentially a one-liner of sorts I can

1070
00:43:40,830 --> 00:43:43,020
wrap that whole on delivery perspective

1071
00:43:43,020 --> 00:43:45,690
a bolide machine good tactical machine

1072
00:43:45,690 --> 00:43:47,520
and it really all I'm putting on target

1073
00:43:47,520 --> 00:43:51,120
is actual base64 itself very low equity

1074
00:43:51,120 --> 00:43:53,310
what do I lose if that gets caught

1075
00:43:53,310 --> 00:43:54,390
nothing

1076
00:43:54,390 --> 00:43:56,700
it's modular so I can change that code

1077
00:43:56,700 --> 00:43:58,950
at any time then we could host it

1078
00:43:58,950 --> 00:44:01,620
wherever we want now some of the cons in

1079
00:44:01,620 --> 00:44:05,130
this is depending on the visibility of

1080
00:44:05,130 --> 00:44:06,339
that effort

1081
00:44:06,339 --> 00:44:08,260
it could be very visible that we're

1082
00:44:08,260 --> 00:44:12,280
going out and downloading stuff also it

1083
00:44:12,280 --> 00:44:14,530
may spike or really present to somebody

1084
00:44:14,530 --> 00:44:16,869
that we're doing something nefarious if

1085
00:44:16,869 --> 00:44:18,970
they're unfamiliar with the sites at

1086
00:44:18,970 --> 00:44:20,829
which we're gonna downloaded from and

1087
00:44:20,829 --> 00:44:24,460
then if our stager becomes blocked or

1088
00:44:24,460 --> 00:44:26,859
really an RC 2 server becomes blocked at

1089
00:44:26,859 --> 00:44:29,109
any time then we kind of lose visibility

1090
00:44:29,109 --> 00:44:31,359
and the ability to affect anything on

1091
00:44:31,359 --> 00:44:34,150
there so some mitigation techniques well

1092
00:44:34,150 --> 00:44:36,430
least privileged you heard Dave talk

1093
00:44:36,430 --> 00:44:38,160
about segmentation and isolation

1094
00:44:38,160 --> 00:44:40,559
absolutely application whitelisting

1095
00:44:40,559 --> 00:44:44,500
definitely difficult to actually do time

1096
00:44:44,500 --> 00:44:46,690
intensive but man I tell you probably

1097
00:44:46,690 --> 00:44:49,089
provides the most bang for a buck as far

1098
00:44:49,089 --> 00:44:51,849
as reward and in detection you can't

1099
00:44:51,849 --> 00:44:53,290
detect what you don't have so if you're

1100
00:44:53,290 --> 00:44:55,690
not logging you're already losing and

1101
00:44:55,690 --> 00:44:57,609
then from a proactive perspective

1102
00:44:57,609 --> 00:45:00,010
they're inducing thread honey and some

1103
00:45:00,010 --> 00:45:02,680
analysis well we're not infiltrated I

1104
00:45:02,680 --> 00:45:04,569
don't see anything well that's because

1105
00:45:04,569 --> 00:45:05,890
you're not looking hard enough for the

1106
00:45:05,890 --> 00:45:07,839
people who's in your network are very

1107
00:45:07,839 --> 00:45:08,440
quired

1108
00:45:08,440 --> 00:45:10,030
but at the end of the day there's a

1109
00:45:10,030 --> 00:45:13,329
couple ways to get around it now as I

1110
00:45:13,329 --> 00:45:15,160
started to wrap up here all right you

1111
00:45:15,160 --> 00:45:17,650
see we use PowerShell very heavily well

1112
00:45:17,650 --> 00:45:20,500
I run two PowerShell training sites one

1113
00:45:20,500 --> 00:45:22,089
is called under the water under the wire

1114
00:45:22,089 --> 00:45:24,839
I've seen a lot of 70,000 people since

1115
00:45:24,839 --> 00:45:26,109
2015

1116
00:45:26,109 --> 00:45:29,559
roughly players from 78 ofthe 193 issue

1117
00:45:29,559 --> 00:45:32,140
countries and essentially under no wire

1118
00:45:32,140 --> 00:45:35,650
allows you to SSH into a Windows

1119
00:45:35,650 --> 00:45:37,690
environment will present you what they

1120
00:45:37,690 --> 00:45:40,180
task and then whatever the answer is to

1121
00:45:40,180 --> 00:45:42,430
that task becomes the password to the

1122
00:45:42,430 --> 00:45:45,010
next user and you're essentially going

1123
00:45:45,010 --> 00:45:46,370
about the game of that matter

1124
00:45:46,370 --> 00:45:49,820
this design to give people access to a

1125
00:45:49,820 --> 00:45:51,320
power show interact the PowerShell

1126
00:45:51,320 --> 00:45:53,420
environment and to provide training it's

1127
00:45:53,420 --> 00:45:55,520
all free all right it is linear in

1128
00:45:55,520 --> 00:45:57,440
nature and we're talking about roughly

1129
00:45:57,440 --> 00:46:01,940
75 challenges now if that's not

1130
00:46:01,940 --> 00:46:04,040
difficult enough for you as we talk

1131
00:46:04,040 --> 00:46:06,380
about the whole purple team Blue Team

1132
00:46:06,380 --> 00:46:08,720
Red Team well then we have Tosh hunter

1133
00:46:08,720 --> 00:46:11,060
Tosh unders roughly 90 challenges that

1134
00:46:11,060 --> 00:46:13,970
allows you to from a situation scenario

1135
00:46:13,970 --> 00:46:16,220
based perspective go through and utilize

1136
00:46:16,220 --> 00:46:19,160
PowerShell to answer particular

1137
00:46:19,160 --> 00:46:19,760
questions

1138
00:46:19,760 --> 00:46:22,430
one minute you're some blue team guy and

1139
00:46:22,430 --> 00:46:24,980
the sock the next minute you're some red

1140
00:46:24,980 --> 00:46:27,410
team guy on some engagement but

1141
00:46:27,410 --> 00:46:29,450
nonetheless all you have is PowerShell

1142
00:46:29,450 --> 00:46:31,280
don't get to see how people were using

1143
00:46:31,280 --> 00:46:33,260
it from a day-to-day perspective you'll

1144
00:46:33,260 --> 00:46:35,960
get to gain more familiarity with it and

1145
00:46:35,960 --> 00:46:37,370
take it back to your environment which

1146
00:46:37,370 --> 00:46:39,350
is what I think anybody and everybody

1147
00:46:39,350 --> 00:46:41,930
would like to have so with that that

1148
00:46:41,930 --> 00:46:44,570
brings us to the end I'll pause for any

1149
00:46:44,570 --> 00:46:46,280
questions there's some information about

1150
00:46:46,280 --> 00:46:48,080
me if you want to keep in touch or any

1151
00:46:48,080 --> 00:46:50,450
that type of stuff this presentation is

1152
00:46:50,450 --> 00:46:54,170
that that site if you're interested all

1153
00:46:54,170 --> 00:46:56,620
right awesome

