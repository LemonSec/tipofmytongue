1
00:00:06,990 --> 00:00:11,770
so Oh going back a little bit the how I

2
00:00:11,770 --> 00:00:14,710
got here so I am former accountant

3
00:00:14,710 --> 00:00:16,900
picked that because it was safe I really

4
00:00:16,900 --> 00:00:18,939
know what I wanted to do I think I

5
00:00:18,939 --> 00:00:22,900
graduated college with 170 180 semester

6
00:00:22,900 --> 00:00:25,689
hours so it's a degree and a half if

7
00:00:25,689 --> 00:00:28,779
you're not trapping and ended up joining

8
00:00:28,779 --> 00:00:30,250
the military I still don't know what I

9
00:00:30,250 --> 00:00:32,340
wanted to do and when I got the military

10
00:00:32,340 --> 00:00:35,320
one got my MBA in computer information

11
00:00:35,320 --> 00:00:37,660
systems ended up just walking out of a

12
00:00:37,660 --> 00:00:40,629
job as an accountant and luckily got a

13
00:00:40,629 --> 00:00:42,430
job in help desk and kind of learned

14
00:00:42,430 --> 00:00:44,710
about ethical hacking thought it sounded

15
00:00:44,710 --> 00:00:46,780
sexy and kind of pursued that

16
00:00:46,780 --> 00:00:49,809
so pretty much studied day and night I

17
00:00:49,809 --> 00:00:52,540
you know got my applause that plus

18
00:00:52,540 --> 00:00:53,799
security plus everything you were

19
00:00:53,799 --> 00:00:55,479
supposed to do work my way through

20
00:00:55,479 --> 00:00:58,989
certifications and landed a job as a

21
00:00:58,989 --> 00:01:00,790
senior network engineer at a National

22
00:01:00,790 --> 00:01:02,949
Lab and then ended up being a pen tester

23
00:01:02,949 --> 00:01:05,979
after that so from health best day one

24
00:01:05,979 --> 00:01:08,470
two pen tester was approximately two

25
00:01:08,470 --> 00:01:10,690
years and this is just one of those

26
00:01:10,690 --> 00:01:12,190
fields if you're looking to get into it

27
00:01:12,190 --> 00:01:13,510
that if you want to be a pen tester you

28
00:01:13,510 --> 00:01:14,740
just kind of got to put in the work you

29
00:01:14,740 --> 00:01:15,880
got to study and that's really what

30
00:01:15,880 --> 00:01:17,920
makes a difference between somebody who

31
00:01:17,920 --> 00:01:19,150
wants to be in the field and somebody is

32
00:01:19,150 --> 00:01:20,380
going to make it into the field is the

33
00:01:20,380 --> 00:01:21,730
people that are willing to put in their

34
00:01:21,730 --> 00:01:24,400
effort and those people that you know

35
00:01:24,400 --> 00:01:26,200
this is a field that changes what seems

36
00:01:26,200 --> 00:01:27,340
like every day there's something new

37
00:01:27,340 --> 00:01:29,290
every day so if you're willing to put in

38
00:01:29,290 --> 00:01:31,180
that effort study keep up with the times

39
00:01:31,180 --> 00:01:33,880
this is the field for you so that's kind

40
00:01:33,880 --> 00:01:36,610
of kind of Holland from accountant into

41
00:01:36,610 --> 00:01:41,440
a pen tester and so on to this talk so

42
00:01:41,440 --> 00:01:43,600
we're gonna be talking about internal

43
00:01:43,600 --> 00:01:45,430
networks and I have another next screen

44
00:01:45,430 --> 00:01:48,880
but internal is basically maybe assume

45
00:01:48,880 --> 00:01:50,979
compromise you just assume that either I

46
00:01:50,979 --> 00:01:53,020
drop the box in your network or I fished

47
00:01:53,020 --> 00:01:54,090
you not in it doesn't

48
00:01:54,090 --> 00:01:55,920
we're in your network so it's not coming

49
00:01:55,920 --> 00:01:57,060
from the outside we're already inside

50
00:01:57,060 --> 00:01:59,250
and it's going to be mostly of talking

51
00:01:59,250 --> 00:02:01,340
about Active Directory attacks since

52
00:02:01,340 --> 00:02:04,170
fortune 500 I think 95 percent or

53
00:02:04,170 --> 00:02:06,420
greater uses Active Directory so this

54
00:02:06,420 --> 00:02:07,860
whole talk is going to focus around

55
00:02:07,860 --> 00:02:10,860
Active Directory attacks so why this

56
00:02:10,860 --> 00:02:11,580
talk

57
00:02:11,580 --> 00:02:13,560
well there's offense defense and

58
00:02:13,560 --> 00:02:16,230
awareness so if you're a baby pentesters

59
00:02:16,230 --> 00:02:17,640
might be good for you if you're looking

60
00:02:17,640 --> 00:02:18,930
to get in the field this might be good

61
00:02:18,930 --> 00:02:21,209
for you if you're seeing your pet tester

62
00:02:21,209 --> 00:02:24,000
it's probably redundant information but

63
00:02:24,000 --> 00:02:27,000
if you can learn how to leverage these

64
00:02:27,000 --> 00:02:28,200
attacks and then you can learn how to

65
00:02:28,200 --> 00:02:29,549
defend against these attacks we'll talk

66
00:02:29,549 --> 00:02:31,380
about offense and defense on this side

67
00:02:31,380 --> 00:02:33,690
and just for general awareness so if

68
00:02:33,690 --> 00:02:35,400
you're a c-level or anybody else just

69
00:02:35,400 --> 00:02:37,019
like hey I know about these attacks

70
00:02:37,019 --> 00:02:39,090
here's how here's what the common ones

71
00:02:39,090 --> 00:02:40,440
are and here's how we can defend against

72
00:02:40,440 --> 00:02:43,890
them so some notes before we get started

73
00:02:43,890 --> 00:02:47,430
again internally as inside network this

74
00:02:47,430 --> 00:02:49,530
talk is based on my experience as a pen

75
00:02:49,530 --> 00:02:51,420
tester your experience and your mileage

76
00:02:51,420 --> 00:02:53,670
may vary so you may have a different top

77
00:02:53,670 --> 00:02:55,140
five that I do you might have different

78
00:02:55,140 --> 00:02:57,290
recommendations for defenses than I do

79
00:02:57,290 --> 00:03:00,030
and then this talk is going to have live

80
00:03:00,030 --> 00:03:01,950
demonstrations I'm on like fun Wi-Fi so

81
00:03:01,950 --> 00:03:05,310
we'll see how that goes but please hold

82
00:03:05,310 --> 00:03:07,890
questions until the end if you can come

83
00:03:07,890 --> 00:03:09,540
see me afterwards I do have stickers or

84
00:03:09,540 --> 00:03:11,250
business cards if you want a pen test

85
00:03:11,250 --> 00:03:14,250
but other than that where you get

86
00:03:14,250 --> 00:03:17,970
started so number one item number one is

87
00:03:17,970 --> 00:03:20,970
LLM an hour poisoning so what is Ella

88
00:03:20,970 --> 00:03:23,310
I'm an arts answer legal multiply cast

89
00:03:23,310 --> 00:03:25,410
name resolution we use this to identify

90
00:03:25,410 --> 00:03:29,220
hosts when DNS fails previously it was

91
00:03:29,220 --> 00:03:33,060
used by what was called MB TNS so if the

92
00:03:33,060 --> 00:03:35,790
chain would be a llamar than mb t and s

93
00:03:35,790 --> 00:03:37,709
if element R fails then you go down n be

94
00:03:37,709 --> 00:03:41,250
TNS and the key flaw of this is that it

95
00:03:41,250 --> 00:03:44,010
uses a user's username and their ntlm B

96
00:03:44,010 --> 00:03:46,799
to hash when they are propably responded

97
00:03:46,799 --> 00:03:48,060
to so we're going to use a tool called

98
00:03:48,060 --> 00:03:50,730
responder to respond to these requests

99
00:03:50,730 --> 00:03:51,900
do Amanda Mills

100
00:03:51,900 --> 00:03:53,400
and we'll talk about this attack a

101
00:03:53,400 --> 00:03:57,060
little bit more in depth so let's assume

102
00:03:57,060 --> 00:04:00,030
here that we have a victim and a server

103
00:04:00,030 --> 00:04:01,500
the victim is going to say hey can you

104
00:04:01,500 --> 00:04:04,590
connect me to this file share and for

105
00:04:04,590 --> 00:04:05,850
whatever reason they type the file share

106
00:04:05,850 --> 00:04:07,950
and wrong or there's a you know a little

107
00:04:07,950 --> 00:04:09,660
share out there it's just not resolving

108
00:04:09,660 --> 00:04:11,670
and the server has no idea what's going

109
00:04:11,670 --> 00:04:14,040
on do you this isn't working so then the

110
00:04:14,040 --> 00:04:15,180
victim is going to send out a broadcast

111
00:04:15,180 --> 00:04:17,970
message and it's going to say hey does

112
00:04:17,970 --> 00:04:20,190
anybody know how to connect to this and

113
00:04:20,190 --> 00:04:22,200
we'll say I do go ahead just sent me

114
00:04:22,200 --> 00:04:24,900
send your hash my way and I'll get you

115
00:04:24,900 --> 00:04:26,340
connected and then those send over the

116
00:04:26,340 --> 00:04:29,460
hash and we'll just intercept it so this

117
00:04:29,460 --> 00:04:31,650
is what I do before I even run any nmap

118
00:04:31,650 --> 00:04:33,990
scans and he necessary thing I'm firing

119
00:04:33,990 --> 00:04:35,880
this up first thing in the morning

120
00:04:35,880 --> 00:04:37,590
usually or at lunch time when people are

121
00:04:37,590 --> 00:04:39,300
generating a lot of traffic this is the

122
00:04:39,300 --> 00:04:41,520
best time for it but when you can

123
00:04:41,520 --> 00:04:42,840
generate some traffic as well with your

124
00:04:42,840 --> 00:04:44,310
dead map scans so I kind of run this

125
00:04:44,310 --> 00:04:47,310
prior to so let's go ahead and we'll

126
00:04:47,310 --> 00:04:50,030
take a look at a live demonstration and

127
00:04:50,030 --> 00:04:54,260
cross our fingers that actually works

128
00:05:22,389 --> 00:05:23,979
all right so I got my little cheat

129
00:05:23,979 --> 00:05:25,270
sheets I don't have to sit here and type

130
00:05:25,270 --> 00:05:27,599
this out

131
00:05:32,670 --> 00:05:35,090
and

132
00:05:52,630 --> 00:05:55,830
all right so we're loading up responders

133
00:05:55,830 --> 00:06:00,610
and all we're doing here is we're doing

134
00:06:00,610 --> 00:06:01,660
the man in the middle over to sake

135
00:06:01,660 --> 00:06:03,310
responder he listed on this tunnel that

136
00:06:03,310 --> 00:06:04,870
I'm connected to which is just a VPN

137
00:06:04,870 --> 00:06:07,420
into my network here so in case you're

138
00:06:07,420 --> 00:06:09,370
wondering you can see the poisoners here

139
00:06:09,370 --> 00:06:12,520
at LNR and meet again s dns I've got

140
00:06:12,520 --> 00:06:13,300
some servers running

141
00:06:13,300 --> 00:06:14,680
we're just listening for any sort of

142
00:06:14,680 --> 00:06:18,520
events and to nudge this along I'm going

143
00:06:18,520 --> 00:06:20,590
to go ahead and just push it at end so

144
00:06:20,590 --> 00:06:25,120
we're going to come down here and I'm

145
00:06:25,120 --> 00:06:26,860
just going to point a file share it

146
00:06:26,860 --> 00:06:29,040
myself

147
00:06:39,630 --> 00:06:45,710
okay and go back and nothing's happening

148
00:06:45,710 --> 00:06:48,930
okay so that's how the live demo works

149
00:06:48,930 --> 00:06:51,360
right we'll see if I trigger them a

150
00:06:51,360 --> 00:06:52,620
little more time you see if I give the

151
00:06:52,620 --> 00:06:58,490
word if not that's all right what's that

152
00:06:58,490 --> 00:07:03,740
just a bit of it what's fine

153
00:07:05,870 --> 00:07:08,740
so I'm gonna

154
00:07:22,060 --> 00:07:24,680
all right so it's not going to work

155
00:07:24,680 --> 00:07:27,770
that's fine that's why we have backup

156
00:07:27,770 --> 00:07:30,700
slides so

157
00:07:34,710 --> 00:07:38,520
all right so we run responder we submit

158
00:07:38,520 --> 00:07:41,250
this as you saw and what we come through

159
00:07:41,250 --> 00:07:44,400
is a hash it looks like this so on the

160
00:07:44,400 --> 00:07:46,440
hash you can see that we are getting a

161
00:07:46,440 --> 00:07:49,160
hash from 10.0 down three done seven and

162
00:07:49,160 --> 00:07:51,930
the person we're taking the hash from is

163
00:07:51,930 --> 00:07:55,199
Marvel /s castle this is Frank Castle

164
00:07:55,199 --> 00:07:57,900
aka the Punisher so he grabbed this ntlm

165
00:07:57,900 --> 00:08:00,060
b2 hash now there's a couple options we

166
00:08:00,060 --> 00:08:02,639
can do from here step one what we're

167
00:08:02,639 --> 00:08:05,100
gonna do is this part and then step two

168
00:08:05,100 --> 00:08:06,810
you'll see later as an alternative

169
00:08:06,810 --> 00:08:11,009
option so we're going to take this hash

170
00:08:11,009 --> 00:08:13,740
and we're going to run it off line the

171
00:08:13,740 --> 00:08:17,280
hash cap down there is modulo 5,600 for

172
00:08:17,280 --> 00:08:20,070
this type of attack I just put this to

173
00:08:20,070 --> 00:08:21,419
rock you because I knew the password was

174
00:08:21,419 --> 00:08:23,520
weak but you run this against a

175
00:08:23,520 --> 00:08:25,289
worthless cut somewhere of those how it

176
00:08:25,289 --> 00:08:28,080
works try to cut the password and then

177
00:08:28,080 --> 00:08:31,110
see what happens in this event this is

178
00:08:31,110 --> 00:08:32,520
very very common by the way it's

179
00:08:32,520 --> 00:08:33,690
probably one of the most common is that

180
00:08:33,690 --> 00:08:36,120
we just crack these these easy or these

181
00:08:36,120 --> 00:08:39,870
weak passwords so here is the mitigation

182
00:08:39,870 --> 00:08:42,419
strategy now the top parts just kind of

183
00:08:42,419 --> 00:08:43,740
like the you know here's how you turn it

184
00:08:43,740 --> 00:08:46,440
off the best this idea is to show at all

185
00:08:46,440 --> 00:08:49,050
of an R and M V T and s so because one

186
00:08:49,050 --> 00:08:50,490
is a failover to the other you have to

187
00:08:50,490 --> 00:08:53,640
turn off both but if you can't do that

188
00:08:53,640 --> 00:08:54,900
or you're use to do that for whatever

189
00:08:54,900 --> 00:08:57,089
reason the other option network access

190
00:08:57,089 --> 00:08:58,740
control make it a little bit more

191
00:08:58,740 --> 00:09:00,240
difficult so he goes and plugs into your

192
00:09:00,240 --> 00:09:01,650
network they don't just leave a drop box

193
00:09:01,650 --> 00:09:04,110
and get right on the network the other

194
00:09:04,110 --> 00:09:06,120
option as well is she requires strong

195
00:09:06,120 --> 00:09:09,180
passwords still to this day I have a pen

196
00:09:09,180 --> 00:09:10,560
test coming up in a couple weeks and

197
00:09:10,560 --> 00:09:12,990
they're using six character passwords at

198
00:09:12,990 --> 00:09:17,400
a major major university so honestly 14

199
00:09:17,400 --> 00:09:18,660
characters is good

200
00:09:18,660 --> 00:09:21,510
I even belong ger the better less you're

201
00:09:21,510 --> 00:09:22,980
gonna hear me harp on this a lot

202
00:09:22,980 --> 00:09:24,390
password policies probably one of the

203
00:09:24,390 --> 00:09:28,079
biggest things but if you can use non

204
00:09:28,079 --> 00:09:30,450
common words like my password one two

205
00:09:30,450 --> 00:09:33,120
three is a long password but it's still

206
00:09:33,120 --> 00:09:35,010
you know it still got common words and

207
00:09:35,010 --> 00:09:37,140
will get cracked I think the longest we

208
00:09:37,140 --> 00:09:39,540
practice 19 characters that's because it

209
00:09:39,540 --> 00:09:42,630
was a Bible verse so like you're not

210
00:09:42,630 --> 00:09:44,460
being smart unfortunately like so the

211
00:09:44,460 --> 00:09:45,810
longer if you can do a full sentence

212
00:09:45,810 --> 00:09:48,180
like 40 40 characters or whatever in

213
00:09:48,180 --> 00:09:50,490
full sentence that's fine but the longer

214
00:09:50,490 --> 00:09:54,779
the better just a rapid over Packham all

215
00:09:54,779 --> 00:10:00,660
right so moving on the the second most

216
00:10:00,660 --> 00:10:03,750
common is past the password / past the

217
00:10:03,750 --> 00:10:07,140
hash and what are this well if we crack

218
00:10:07,140 --> 00:10:08,700
the password like we just did we can

219
00:10:08,700 --> 00:10:11,400
attempt to pass it around or if we can

220
00:10:11,400 --> 00:10:12,870
get on to a machine with something that

221
00:10:12,870 --> 00:10:15,390
we captured then we can try to dump the

222
00:10:15,390 --> 00:10:18,180
Sam on a Windows machine and use those

223
00:10:18,180 --> 00:10:20,339
hashes for lateral movement I'm not

224
00:10:20,339 --> 00:10:23,810
going to attempt any live demo here so

225
00:10:23,810 --> 00:10:26,610
we can use a tool called crack map exact

226
00:10:26,610 --> 00:10:29,490
crack rock music is really good here all

227
00:10:29,490 --> 00:10:31,230
I'm doing is you saw that was in the top

228
00:10:31,230 --> 00:10:33,180
three Network I'm just sweeping that

229
00:10:33,180 --> 00:10:34,529
whole network with that user that we

230
00:10:34,529 --> 00:10:37,170
found in the domain and the password and

231
00:10:37,170 --> 00:10:38,279
you can see it's spreading across

232
00:10:38,279 --> 00:10:40,380
there's a DC that I found it found the

233
00:10:40,380 --> 00:10:41,970
Punisher machine if I don't spider-man's

234
00:10:41,970 --> 00:10:44,250
machine well if you look through with a

235
00:10:44,250 --> 00:10:46,680
poem on the right hand side here we own

236
00:10:46,680 --> 00:10:49,380
the Punisher which we expected and we

237
00:10:49,380 --> 00:10:52,589
don't spider-man so it means we are also

238
00:10:52,589 --> 00:10:53,850
an administrator on the spider-man

239
00:10:53,850 --> 00:10:56,430
machine and now we can go over there and

240
00:10:56,430 --> 00:10:57,990
try to get a shell on that machine using

241
00:10:57,990 --> 00:11:01,200
the credentials that we just found so

242
00:11:01,200 --> 00:11:02,970
with that we could run something like PS

243
00:11:02,970 --> 00:11:04,890
exact say we get the shell and then

244
00:11:04,890 --> 00:11:08,310
we're a system on the machine we just

245
00:11:08,310 --> 00:11:10,620
run hash done and you can see by the the

246
00:11:10,620 --> 00:11:12,990
500 ID that that's the administrator and

247
00:11:12,990 --> 00:11:14,670
we just grab the second part of that

248
00:11:14,670 --> 00:11:16,140
hash there

249
00:11:16,140 --> 00:11:19,380
and this turns into pass the hash so you

250
00:11:19,380 --> 00:11:21,779
can use crack nap exact same thing use

251
00:11:21,779 --> 00:11:23,640
the user of s castle just happened to be

252
00:11:23,640 --> 00:11:26,279
the admin on the machine and then the

253
00:11:26,279 --> 00:11:28,560
hash of that - local you pass it around

254
00:11:28,560 --> 00:11:31,050
here we didn't give anything extra out

255
00:11:31,050 --> 00:11:33,930
of it but I have had pen tests where I

256
00:11:33,930 --> 00:11:35,700
passed the administrator password and

257
00:11:35,700 --> 00:11:37,200
got every single computer in the network

258
00:11:37,200 --> 00:11:38,959
because they were reusing that password

259
00:11:38,959 --> 00:11:41,519
so if you're imaging the same password

260
00:11:41,519 --> 00:11:43,470
over and over and over this is where we

261
00:11:43,470 --> 00:11:46,140
get you and then you'll see some other

262
00:11:46,140 --> 00:11:47,700
attacks like token impersonation and

263
00:11:47,700 --> 00:11:49,170
things we're going to talk about where

264
00:11:49,170 --> 00:11:50,670
all we have to do is start moving

265
00:11:50,670 --> 00:11:52,290
laterally to these machines maybe this

266
00:11:52,290 --> 00:11:54,120
machine doesn't find anything but maybe

267
00:11:54,120 --> 00:11:56,190
the next machine might have you know IT

268
00:11:56,190 --> 00:11:58,320
information or a user on it that we can

269
00:11:58,320 --> 00:12:00,180
leverage or anything it's all about

270
00:12:00,180 --> 00:12:02,279
moving laterally until they came to

271
00:12:02,279 --> 00:12:05,670
vertically so this is kind of what

272
00:12:05,670 --> 00:12:07,079
passed the hatch looks like we'll talk

273
00:12:07,079 --> 00:12:10,200
mitigation so limit your account reuse

274
00:12:10,200 --> 00:12:12,420
don't reuse your local administrator

275
00:12:12,420 --> 00:12:14,430
passwords you can disable your guest an

276
00:12:14,430 --> 00:12:16,980
administrator talents and limit who is a

277
00:12:16,980 --> 00:12:20,100
local administrator so too many too many

278
00:12:20,100 --> 00:12:21,899
places let everybody be an admin on

279
00:12:21,899 --> 00:12:23,850
their computers and let people be admin

280
00:12:23,850 --> 00:12:25,470
on multiple computers and this is kind

281
00:12:25,470 --> 00:12:27,899
of where we take advantage of this same

282
00:12:27,899 --> 00:12:29,430
thing harpy again is the strong

283
00:12:29,430 --> 00:12:31,769
passwords so if we can't get onto your

284
00:12:31,769 --> 00:12:33,510
machine we can't crack a password then

285
00:12:33,510 --> 00:12:35,790
you know it's going to be a lot more

286
00:12:35,790 --> 00:12:37,670
difficult life for us independent server

287
00:12:37,670 --> 00:12:42,029
and then lastly Pam is out now cribbage

288
00:12:42,029 --> 00:12:43,829
access management so tools like

289
00:12:43,829 --> 00:12:45,570
psychotic or cyber are where you have a

290
00:12:45,570 --> 00:12:48,420
check-in checkout function of a account

291
00:12:48,420 --> 00:12:50,790
so that what that does is you check in

292
00:12:50,790 --> 00:12:52,740
the account or you check out the account

293
00:12:52,740 --> 00:12:54,180
it rotates the pass or it gives it to

294
00:12:54,180 --> 00:12:55,769
you for eight hours and then it

295
00:12:55,769 --> 00:12:57,269
automatically checks back and rotates

296
00:12:57,269 --> 00:12:58,560
the account again so you only have a

297
00:12:58,560 --> 00:13:00,060
password for a temporary amount of time

298
00:13:00,060 --> 00:13:02,399
and they're storing them at fifteen to

299
00:13:02,399 --> 00:13:03,899
thirty characters in length depending on

300
00:13:03,899 --> 00:13:05,519
the sensitivity and everything else so

301
00:13:05,519 --> 00:13:07,649
that's where a lot of the fortune 500

302
00:13:07,649 --> 00:13:11,779
are moving to this pan type of solution

303
00:13:13,040 --> 00:13:15,990
all right so third is token

304
00:13:15,990 --> 00:13:19,140
impersonation so tokens are temporary

305
00:13:19,140 --> 00:13:21,000
keys you can think of them as cookies

306
00:13:21,000 --> 00:13:23,100
for computers they allow you to have

307
00:13:23,100 --> 00:13:24,930
access without having to provide

308
00:13:24,930 --> 00:13:26,580
credentials each time you access a file

309
00:13:26,580 --> 00:13:28,740
and there's going to be two types of

310
00:13:28,740 --> 00:13:30,750
tokens there's a delegate token and

311
00:13:30,750 --> 00:13:32,580
there's an impersonator token so

312
00:13:32,580 --> 00:13:34,710
delegates like you remote desktop into a

313
00:13:34,710 --> 00:13:36,570
computer and it person AIT's not

314
00:13:36,570 --> 00:13:38,250
interactive so it's like attaching your

315
00:13:38,250 --> 00:13:42,350
network drive and let's see why it's bad

316
00:13:42,350 --> 00:13:46,590
so we've got a user here we've got say

317
00:13:46,590 --> 00:13:48,120
we've got this shelf and we list the

318
00:13:48,120 --> 00:13:50,370
tokens and right now you can see the get

319
00:13:50,370 --> 00:13:53,400
UID at the top or authority system and I

320
00:13:53,400 --> 00:13:55,320
say listen tokens with this tool called

321
00:13:55,320 --> 00:13:57,330
incognito which is built-in or you could

322
00:13:57,330 --> 00:13:59,850
load it from meterpreter you see here

323
00:13:59,850 --> 00:14:02,670
marvel desk castle we'll go ahead and

324
00:14:02,670 --> 00:14:04,800
just do a click Who am I will

325
00:14:04,800 --> 00:14:06,870
impersonate the user up top and then go

326
00:14:06,870 --> 00:14:08,250
into a shell and you can see that we've

327
00:14:08,250 --> 00:14:10,920
impersonated this user and we are now as

328
00:14:10,920 --> 00:14:14,940
castle and if we try to run a MeetMe

329
00:14:14,940 --> 00:14:17,640
cats try to dump hashes with BB cats you

330
00:14:17,640 --> 00:14:18,900
can see that we're getting an access

331
00:14:18,900 --> 00:14:21,330
denied there that's because we're not a

332
00:14:21,330 --> 00:14:24,390
domain administrator if we repeat the

333
00:14:24,390 --> 00:14:27,030
process and we impersonate a domain

334
00:14:27,030 --> 00:14:31,820
administrator scroll through really fast

335
00:14:31,820 --> 00:14:35,330
you'll see that we don't the hatches so

336
00:14:35,330 --> 00:14:38,000
this happens when say somebody is a

337
00:14:38,000 --> 00:14:39,710
domain administrator at the remoting in

338
00:14:39,710 --> 00:14:42,200
two computers to fix problems or just to

339
00:14:42,200 --> 00:14:43,940
remote it or you know you don't have

340
00:14:43,940 --> 00:14:46,190
that account segregation and I've got

341
00:14:46,190 --> 00:14:48,050
the Kerberos ticket granting ticket

342
00:14:48,050 --> 00:14:50,300
account highlighted because we use that

343
00:14:50,300 --> 00:14:52,640
to generate what's called a golden

344
00:14:52,640 --> 00:14:54,050
ticket we generate that golden ticket

345
00:14:54,050 --> 00:14:55,640
we're getting on your domain controller

346
00:14:55,640 --> 00:14:57,530
it's game over so we could dump this

347
00:14:57,530 --> 00:14:59,380
this is pretty much over

348
00:14:59,380 --> 00:15:03,790
so again we'll talk mitigation here but

349
00:15:03,790 --> 00:15:06,830
you should really limit your user group

350
00:15:06,830 --> 00:15:08,840
token token creation permissions and

351
00:15:08,840 --> 00:15:10,310
really when it comes down to is account

352
00:15:10,310 --> 00:15:12,140
tearing your domain administrators

353
00:15:12,140 --> 00:15:13,520
should only be using their domain

354
00:15:13,520 --> 00:15:15,740
accounts to access the domain controller

355
00:15:15,740 --> 00:15:17,870
and things that are important they

356
00:15:17,870 --> 00:15:19,310
should not be using it for anything and

357
00:15:19,310 --> 00:15:20,600
everything so you should ideally have

358
00:15:20,600 --> 00:15:22,280
two separate accounts ones like there

359
00:15:22,280 --> 00:15:23,630
everyday use the other one is your

360
00:15:23,630 --> 00:15:25,970
domain administrator account same thing

361
00:15:25,970 --> 00:15:27,680
with the local admin restriction we need

362
00:15:27,680 --> 00:15:29,780
administrator on the computer to

363
00:15:29,780 --> 00:15:30,860
actually be able to do token

364
00:15:30,860 --> 00:15:32,060
impersonation you saw your authority

365
00:15:32,060 --> 00:15:34,340
system so it still boils down to

366
00:15:34,340 --> 00:15:37,070
limiting those local admin rights to

367
00:15:37,070 --> 00:15:41,840
prevent this in the first place all

368
00:15:41,840 --> 00:15:42,110
right

369
00:15:42,110 --> 00:15:44,780
so playing off of number one which was

370
00:15:44,780 --> 00:15:46,130
fellow of an hour poisoning we have

371
00:15:46,130 --> 00:15:48,950
something called SMB relay so an SMB

372
00:15:48,950 --> 00:15:51,500
relay attack uses responder and captures

373
00:15:51,500 --> 00:15:53,660
the hatches but instead of capturing

374
00:15:53,660 --> 00:15:55,370
them and trying to cocktail offline we

375
00:15:55,370 --> 00:15:57,320
can just pass them across the network to

376
00:15:57,320 --> 00:15:59,270
a different machine and try to leverage

377
00:15:59,270 --> 00:16:02,180
a shell that way so there are some

378
00:16:02,180 --> 00:16:04,070
requirements SMB signing must be

379
00:16:04,070 --> 00:16:06,050
disabled and that is disabled by default

380
00:16:06,050 --> 00:16:08,720
on all Windows machines except servers

381
00:16:08,720 --> 00:16:11,270
so you're not gonna get on the domain

382
00:16:11,270 --> 00:16:12,500
controller with this unless for some

383
00:16:12,500 --> 00:16:14,120
reason they disabled it but you can move

384
00:16:14,120 --> 00:16:16,940
on or really pretty easily so if SMB

385
00:16:16,940 --> 00:16:18,200
signing is disabled and you can push

386
00:16:18,200 --> 00:16:19,970
just across it's pretty straightforward

387
00:16:19,970 --> 00:16:23,300
so the relay credentials unless being

388
00:16:23,300 --> 00:16:25,170
added on the machine is

389
00:16:25,170 --> 00:16:26,819
why'd you dump ashes or do anything that

390
00:16:26,819 --> 00:16:29,429
you use so we could take a look first

391
00:16:29,429 --> 00:16:30,809
thing here we just make a small change

392
00:16:30,809 --> 00:16:32,939
to responder so you know the

393
00:16:32,939 --> 00:16:35,639
configuration should not intercept the

394
00:16:35,639 --> 00:16:37,410
SMB or HTTP because we're actually just

395
00:16:37,410 --> 00:16:39,959
going to relay these and that's kind of

396
00:16:39,959 --> 00:16:44,309
what it looks like now and then we boot

397
00:16:44,309 --> 00:16:46,859
up this one here is Python forward NT om

398
00:16:46,859 --> 00:16:48,660
relay acts as part of in packets or

399
00:16:48,660 --> 00:16:50,009
responders part of in packet

400
00:16:50,009 --> 00:16:51,660
this is part of impact it's a really

401
00:16:51,660 --> 00:16:53,389
good tool kit for an internal pentesting

402
00:16:53,389 --> 00:16:55,829
so we're just booting this up and this

403
00:16:55,829 --> 00:16:57,149
relay is just going to be listening for

404
00:16:57,149 --> 00:16:58,410
the hash to come through and then you

405
00:16:58,410 --> 00:16:59,910
specify the target in your target

406
00:16:59,910 --> 00:17:01,859
subtext what you want to attack in this

407
00:17:01,859 --> 00:17:03,720
instance we're going to attack sparta

408
00:17:03,720 --> 00:17:05,130
man because he saw earlier that we

409
00:17:05,130 --> 00:17:07,648
already had access to spider-man so this

410
00:17:07,648 --> 00:17:09,779
is going to function but we're just

411
00:17:09,779 --> 00:17:11,459
going to trigger that and then trigger

412
00:17:11,459 --> 00:17:15,119
an event and then here's what happens

413
00:17:15,119 --> 00:17:17,970
now you see that if at the top it says

414
00:17:17,970 --> 00:17:20,069
we're going to try to connect 2.6 as

415
00:17:20,069 --> 00:17:23,490
Marvel s Castle it succeeded and you

416
00:17:23,490 --> 00:17:25,409
look at the bottom it starts dumping the

417
00:17:25,409 --> 00:17:27,779
local sand hashes for the machine now

418
00:17:27,779 --> 00:17:29,549
this is a proof of concept you can take

419
00:17:29,549 --> 00:17:30,990
this a lot further get a show with

420
00:17:30,990 --> 00:17:34,049
meterpreter and Empire whatever etc and

421
00:17:34,049 --> 00:17:36,720
go farther than this but just because

422
00:17:36,720 --> 00:17:39,419
the SME signing is disabled and we don't

423
00:17:39,419 --> 00:17:40,889
ever have to know the password of the

424
00:17:40,889 --> 00:17:42,840
account that we're intercepting so

425
00:17:42,840 --> 00:17:44,519
that's that's what's key takeaway here

426
00:17:44,519 --> 00:17:47,340
is because of that we just leverage you

427
00:17:47,340 --> 00:17:49,470
could have 20 30 40 character passwords

428
00:17:49,470 --> 00:17:53,159
and we're so good at this so let's talk

429
00:17:53,159 --> 00:17:55,150
mitigation

430
00:17:55,150 --> 00:17:57,400
first of all enable SME signing all of

431
00:17:57,400 --> 00:17:59,800
Isis the pro here is a complete stop C

432
00:17:59,800 --> 00:18:01,960
attack the con is it can cause

433
00:18:01,960 --> 00:18:03,340
performance issues when you're copying

434
00:18:03,340 --> 00:18:07,240
files so what I've read in her is

435
00:18:07,240 --> 00:18:10,780
fifteen percent increase in time I pearl

436
00:18:10,780 --> 00:18:14,400
saw her longer than that as well so

437
00:18:14,400 --> 00:18:16,360
depending you know you might get some

438
00:18:16,360 --> 00:18:18,580
people complaining you're you know

439
00:18:18,580 --> 00:18:20,760
admins pushing back from this and that's

440
00:18:20,760 --> 00:18:23,860
one of the reasons there so the other

441
00:18:23,860 --> 00:18:25,660
option is to disable ntlm authentication

442
00:18:25,660 --> 00:18:27,550
completely stops the attack but if

443
00:18:27,550 --> 00:18:28,900
Kerberos stops working either you have

444
00:18:28,900 --> 00:18:30,460
issues where we have to revert back to

445
00:18:30,460 --> 00:18:33,700
ntlm and you're back at the same spot

446
00:18:33,700 --> 00:18:36,190
you were the other options here are

447
00:18:36,190 --> 00:18:37,660
account tearing which I've been harping

448
00:18:37,660 --> 00:18:39,460
on and local admin research in which

449
00:18:39,460 --> 00:18:43,360
I've been harping on so honestly it

450
00:18:43,360 --> 00:18:46,030
comes down to SMB signing and just

451
00:18:46,030 --> 00:18:47,380
enabling that across the network that's

452
00:18:47,380 --> 00:18:48,730
the main recommendation but if people

453
00:18:48,730 --> 00:18:50,170
fight back you kind of have these other

454
00:18:50,170 --> 00:18:51,670
options and these are just best practice

455
00:18:51,670 --> 00:18:55,600
as it goes anyway all right let's talk

456
00:18:55,600 --> 00:18:59,770
about the last one real quick so this is

457
00:18:59,770 --> 00:19:01,690
Kerberos state and if you know what

458
00:19:01,690 --> 00:19:04,540
Kerberos is it's a authentication method

459
00:19:04,540 --> 00:19:07,570
used by Windows and they use tickets so

460
00:19:07,570 --> 00:19:10,240
if you see here one two two basically we

461
00:19:10,240 --> 00:19:12,040
have a domain controller or a server and

462
00:19:12,040 --> 00:19:13,450
we're going to call it a KDC which is a

463
00:19:13,450 --> 00:19:15,490
key distribution center the key

464
00:19:15,490 --> 00:19:17,410
distribution center we're gonna request

465
00:19:17,410 --> 00:19:18,820
a ticket from so we're gonna request

466
00:19:18,820 --> 00:19:21,010
this TDT its ticket granting ticket and

467
00:19:21,010 --> 00:19:24,160
the server is going to say okay we'll

468
00:19:24,160 --> 00:19:25,210
grant you a ticket you bought that

469
00:19:25,210 --> 00:19:26,170
indicated

470
00:19:26,170 --> 00:19:29,410
now see we have a application server

471
00:19:29,410 --> 00:19:31,030
down here can be sequel could be

472
00:19:31,030 --> 00:19:33,550
whatever you want it to be from here

473
00:19:33,550 --> 00:19:36,070
what we can do is to the KDC we could

474
00:19:36,070 --> 00:19:37,840
say hey I want this service ticket which

475
00:19:37,840 --> 00:19:40,030
is called the TGS I want the service

476
00:19:40,030 --> 00:19:42,400
ticket the server says ok I'll give you

477
00:19:42,400 --> 00:19:44,620
the service ticket and while we're at it

478
00:19:44,620 --> 00:19:46,450
we're going to encrypt these servers

479
00:19:46,450 --> 00:19:48,490
account hash so they're gonna tell them

480
00:19:48,490 --> 00:19:50,320
hash or however words if not it's a

481
00:19:50,320 --> 00:19:52,420
Kerberos ticket hash actually so the

482
00:19:52,420 --> 00:19:54,370
Kerberos ticket hash comes through and

483
00:19:54,370 --> 00:19:56,680
you take that and you're supposed to

484
00:19:56,680 --> 00:19:59,710
present it to the application server and

485
00:19:59,710 --> 00:20:01,360
that's where it decrypts the hash and

486
00:20:01,360 --> 00:20:03,370
says okay do you have permissions do you

487
00:20:03,370 --> 00:20:04,510
not have permissions to actually use

488
00:20:04,510 --> 00:20:06,430
this service and then it allows you in

489
00:20:06,430 --> 00:20:08,980
well we don't have to do five and six we

490
00:20:08,980 --> 00:20:11,230
can stop at four and take the hash and

491
00:20:11,230 --> 00:20:14,500
try to crack it so we can use something

492
00:20:14,500 --> 00:20:16,540
out of it packet as well called get user

493
00:20:16,540 --> 00:20:18,670
SPN so SPNs service principle name

494
00:20:18,670 --> 00:20:21,160
that's used by services so we'll look

495
00:20:21,160 --> 00:20:23,860
for the SPS using our credential that we

496
00:20:23,860 --> 00:20:26,410
found so all we have to have here for

497
00:20:26,410 --> 00:20:28,150
this to work and I think it said that up

498
00:20:28,150 --> 00:20:30,580
there is no it didn't say all you have

499
00:20:30,580 --> 00:20:32,110
to have is a valid ticket so once you

500
00:20:32,110 --> 00:20:33,760
have the ticket meaning you have a valid

501
00:20:33,760 --> 00:20:36,760
login with the user here we point to the

502
00:20:36,760 --> 00:20:39,130
GC for our request we make the request

503
00:20:39,130 --> 00:20:43,180
and you can see we get this hydrated DC

504
00:20:43,180 --> 00:20:45,970
we get a service sequel service and if

505
00:20:45,970 --> 00:20:47,410
you look over in the member of it's in

506
00:20:47,410 --> 00:20:50,110
my room domain admins so you see service

507
00:20:50,110 --> 00:20:51,940
counts all the time with improper

508
00:20:51,940 --> 00:20:54,780
permissions domain admin for what

509
00:20:54,780 --> 00:20:57,960
reason and here we get this big the long

510
00:20:57,960 --> 00:21:01,170
hash this Kerberos hash and if we were

511
00:21:01,170 --> 00:21:04,200
to take it and try to crack it

512
00:21:04,200 --> 00:21:07,260
you can see that with hash cap of 13 100

513
00:21:07,260 --> 00:21:10,820
as the module my password 1 2 3 pound

514
00:21:10,820 --> 00:21:12,930
technically meets the 14 character

515
00:21:12,930 --> 00:21:15,600
requirement but still is found with just

516
00:21:15,600 --> 00:21:18,420
rock you so we could love her just

517
00:21:18,420 --> 00:21:20,340
account now has a domain admin and that

518
00:21:20,340 --> 00:21:21,810
would be game over or for lateral

519
00:21:21,810 --> 00:21:23,610
movements they had appropriate

520
00:21:23,610 --> 00:21:28,640
permissions so mitigation strategies

521
00:21:28,640 --> 00:21:32,640
strong passwords least privilege I'm a

522
00:21:32,640 --> 00:21:34,260
broken record up here but this is really

523
00:21:34,260 --> 00:21:36,150
really comes down strong passwords least

524
00:21:36,150 --> 00:21:39,390
privilege eliminating users what they

525
00:21:39,390 --> 00:21:41,940
can and can't do in the network and

526
00:21:41,940 --> 00:21:44,550
again this is this is top 5 this is the

527
00:21:44,550 --> 00:21:46,170
basics these have been around for a

528
00:21:46,170 --> 00:21:48,240
while if you're seeing your pen testers

529
00:21:48,240 --> 00:21:49,950
I see some of you in here it's not some

530
00:21:49,950 --> 00:21:52,500
new news it's all news but it's still

531
00:21:52,500 --> 00:21:54,990
coming up and it's still coming up

532
00:21:54,990 --> 00:21:56,460
because these are just a lot of this

533
00:21:56,460 --> 00:21:58,440
just common defaults in a network right

534
00:21:58,440 --> 00:22:01,650
table Windows comes by standard nobody

535
00:22:01,650 --> 00:22:03,390
changes it they just install it and they

536
00:22:03,390 --> 00:22:05,730
let it run you let your users have 6

537
00:22:05,730 --> 00:22:07,560
character a character passwords we're

538
00:22:07,560 --> 00:22:10,020
gonna have a field day so I mean that's

539
00:22:10,020 --> 00:22:11,550
that's really what it boils down to you

540
00:22:11,550 --> 00:22:15,240
so I've set the same four or five things

541
00:22:15,240 --> 00:22:17,010
across the board you eliminate those

542
00:22:17,010 --> 00:22:18,420
four or five things you make it a lot

543
00:22:18,420 --> 00:22:22,010
more difficult on us as a pen tester

544
00:22:23,220 --> 00:22:26,220
questions

545
00:22:27,630 --> 00:22:31,230
perfect thank you

546
00:22:31,740 --> 00:22:34,750
I've got a YouTube video of it already

547
00:22:34,750 --> 00:22:37,000
if you want to watch it now I can give

548
00:22:37,000 --> 00:22:43,630
science to anybody else perfect thank

549
00:22:43,630 --> 00:22:45,840
you guys

