1
00:00:00,060 --> 00:00:03,210
all right so our next talk is no

2
00:00:03,210 --> 00:00:06,870
disassembly required Brian cetera with a

3
00:00:06,870 --> 00:00:18,500
readout okay

4
00:00:18,500 --> 00:00:22,220
I was like can you still hear me is that

5
00:00:22,220 --> 00:00:24,869
alright well we'll try this microphone

6
00:00:24,869 --> 00:00:26,250
and if it doesn't work I'll switch back

7
00:00:26,250 --> 00:00:33,719
to the other microphone okay if somebody

8
00:00:33,719 --> 00:00:39,540
can grab the doors so I am Brian cetera

9
00:00:39,540 --> 00:00:42,450
and this is no disassembly required

10
00:00:42,450 --> 00:00:45,300
which is a terrible pun and fully

11
00:00:45,300 --> 00:00:48,780
intended is the subject of this talk

12
00:00:48,780 --> 00:00:50,010
we'll be talking about script based

13
00:00:50,010 --> 00:00:52,289
malware but it's also going to be kind

14
00:00:52,289 --> 00:00:55,350
of an exhortation if you're not am our

15
00:00:55,350 --> 00:00:57,449
analyst to not be afraid to start doing

16
00:00:57,449 --> 00:01:01,350
malware analysis so I'll talk a little

17
00:01:01,350 --> 00:01:03,960
bit about some VBS malware talk about

18
00:01:03,960 --> 00:01:07,229
some offensive PowerShell and some other

19
00:01:07,229 --> 00:01:10,680
some other types of script based malware

20
00:01:10,680 --> 00:01:13,229
the important parts upfront you can

21
00:01:13,229 --> 00:01:15,630
follow me on Twitter I've read out with

22
00:01:15,630 --> 00:01:18,479
a three I get home page I have an open

23
00:01:18,479 --> 00:01:21,270
source projects that I'm working on and

24
00:01:21,270 --> 00:01:23,310
we're starting up and running I over the

25
00:01:23,310 --> 00:01:25,200
past year done a lot of Mac OS related

26
00:01:25,200 --> 00:01:27,570
security stuff some free scripts up

27
00:01:27,570 --> 00:01:29,159
there for hardening Mac OS and some

28
00:01:29,159 --> 00:01:31,680
other materials related to that previous

29
00:01:31,680 --> 00:01:33,540
talks they've given and you can follow

30
00:01:33,540 --> 00:01:36,840
me on my blog at blog read out on IO

31
00:01:36,840 --> 00:01:40,470
again with a three which again currently

32
00:01:40,470 --> 00:01:42,720
is mostly some Mac security related

33
00:01:42,720 --> 00:01:44,700
stuff if anybody's interested in that

34
00:01:44,700 --> 00:01:47,880
and using an OS query for EDR some

35
00:01:47,880 --> 00:01:50,759
tutorials up on that but the stuff from

36
00:01:50,759 --> 00:01:52,710
the training yesterday and from this

37
00:01:52,710 --> 00:01:54,299
talk will kind of be going up on there

38
00:01:54,299 --> 00:01:58,799
as a series of blogs hopefully soon so a

39
00:01:58,799 --> 00:02:00,439
little bit about me

40
00:02:00,439 --> 00:02:03,960
not really I usually kind of like the

41
00:02:03,960 --> 00:02:05,219
idea that you know talk should kind of

42
00:02:05,219 --> 00:02:07,439
stay on its own don't believe like the

43
00:02:07,439 --> 00:02:10,229
lab coat commercial philosophy right

44
00:02:10,229 --> 00:02:11,879
well I'm standing in a lab coat so by

45
00:02:11,879 --> 00:02:13,000
our product

46
00:02:13,000 --> 00:02:15,610
but just because people have asked me

47
00:02:15,610 --> 00:02:16,960
like yesterday at the training that we

48
00:02:16,960 --> 00:02:20,020
did you know how did you become of our

49
00:02:20,020 --> 00:02:21,460
analyst or how do I become a malware

50
00:02:21,460 --> 00:02:23,200
analyst or how did you get started in

51
00:02:23,200 --> 00:02:26,290
security brief in the background so I am

52
00:02:26,290 --> 00:02:28,330
originally this furred got out of the

53
00:02:28,330 --> 00:02:30,550
military went back to school and GI Bill

54
00:02:30,550 --> 00:02:32,260
University of Pittsburgh had in

55
00:02:32,260 --> 00:02:33,880
information security program at their

56
00:02:33,880 --> 00:02:36,310
School of Information science like your

57
00:02:36,310 --> 00:02:37,960
graduate program went back to do that

58
00:02:37,960 --> 00:02:41,140
but really ended up getting into what I

59
00:02:41,140 --> 00:02:44,440
do now doing an internship with NC FTA

60
00:02:44,440 --> 00:02:46,360
which I know there's some people here

61
00:02:46,360 --> 00:02:49,540
today with NC FTA or hence the FTA alums

62
00:02:49,540 --> 00:02:52,210
as well you know where I got to work

63
00:02:52,210 --> 00:02:53,590
with federal law enforcement and see

64
00:02:53,590 --> 00:02:57,460
what they do and started just learning

65
00:02:57,460 --> 00:03:01,570
by doing right so way before your tax

66
00:03:01,570 --> 00:03:04,510
dollars paid for me to go to a $5,000

67
00:03:04,510 --> 00:03:07,630
sans course with Lenny zeltser thank you

68
00:03:07,630 --> 00:03:11,980
uh-huh as a government our analyst I I

69
00:03:11,980 --> 00:03:14,620
was just learning by doing as you know a

70
00:03:14,620 --> 00:03:17,400
guy working as an intern unpaid intern

71
00:03:17,400 --> 00:03:20,740
who was told go learn C go write a

72
00:03:20,740 --> 00:03:23,920
HelloWorld C program you know can pile

73
00:03:23,920 --> 00:03:25,930
it and throw the assembly and Ida Pro or

74
00:03:25,930 --> 00:03:30,340
Olli and see what it does right so and

75
00:03:30,340 --> 00:03:32,740
since then I've done kind of a InfoSec

76
00:03:32,740 --> 00:03:34,600
jack-of-all-trades

77
00:03:34,600 --> 00:03:36,910
it's like two of some background in

78
00:03:36,910 --> 00:03:38,980
intelligence like as an Intel analyst so

79
00:03:38,980 --> 00:03:40,390
it helps stand up some threatenings all

80
00:03:40,390 --> 00:03:44,140
programs and done a variety of other

81
00:03:44,140 --> 00:03:45,760
things too but you know I consider

82
00:03:45,760 --> 00:03:47,860
myself mainly a reverse engineer I see a

83
00:03:47,860 --> 00:03:49,120
reverse engineer instead of am our

84
00:03:49,120 --> 00:03:51,760
analyst in part because I've probably

85
00:03:51,760 --> 00:03:54,010
spent my work 5050 working on industrial

86
00:03:54,010 --> 00:03:58,090
control systems and embedded stuff from

87
00:03:58,090 --> 00:04:00,670
a vulnerability analyst standpoint some

88
00:04:00,670 --> 00:04:03,970
more offensive ranted but also kind of a

89
00:04:03,970 --> 00:04:06,340
is a philosophical point and that I

90
00:04:06,340 --> 00:04:08,890
think it's more than just blog hunting

91
00:04:08,890 --> 00:04:10,930
or in the case of malware analysis

92
00:04:10,930 --> 00:04:13,150
throwing something in a sandbox and

93
00:04:13,150 --> 00:04:15,430
finding quote-unquote IOC s you know

94
00:04:15,430 --> 00:04:17,380
getting indicators that compromise its

95
00:04:17,380 --> 00:04:19,089
really understanding what does something

96
00:04:19,089 --> 00:04:22,000
really do not what the person who wrote

97
00:04:22,000 --> 00:04:24,280
the code thinks it does not what you

98
00:04:24,280 --> 00:04:26,700
originally at the outset thought it

99
00:04:26,700 --> 00:04:29,010
but what can it really do what does it

100
00:04:29,010 --> 00:04:30,870
really do how does it really work and

101
00:04:30,870 --> 00:04:32,070
that's kind of the essence of hacking

102
00:04:32,070 --> 00:04:34,710
right is discovering things can really

103
00:04:34,710 --> 00:04:40,860
do is this talk for you so by a show of

104
00:04:40,860 --> 00:04:42,630
hands regardless of what your job title

105
00:04:42,630 --> 00:04:45,210
is you know how many people here have

106
00:04:45,210 --> 00:04:48,890
ever or on a relatively routine basis

107
00:04:48,890 --> 00:04:53,210
get asked to look at phishing emails

108
00:04:53,210 --> 00:04:56,310
okay how many people like get asked to

109
00:04:56,310 --> 00:04:58,980
do sort of EDR even if it's just your

110
00:04:58,980 --> 00:05:02,280
Joe helpdesk and hey go reimage this box

111
00:05:02,280 --> 00:05:04,710
right okay

112
00:05:04,710 --> 00:05:06,300
now out of all those people feel free to

113
00:05:06,300 --> 00:05:08,780
put your hands back up and put them down

114
00:05:08,780 --> 00:05:12,750
you know how many of you if this is not

115
00:05:12,750 --> 00:05:14,940
the case how many of you your company

116
00:05:14,940 --> 00:05:17,370
just says oh you want to go take a

117
00:05:17,370 --> 00:05:20,010
$6,000 sans course or you want ten grand

118
00:05:20,010 --> 00:05:22,580
to go fly out to Vegas to go to blackhat

119
00:05:22,580 --> 00:05:27,120
no problem any anybody anybody so so a

120
00:05:27,120 --> 00:05:29,160
few people and I've been lucky enough

121
00:05:29,160 --> 00:05:31,620
that I've had companies both working on

122
00:05:31,620 --> 00:05:33,360
the government side and or certain

123
00:05:33,360 --> 00:05:36,180
companies that work for where I had the

124
00:05:36,180 --> 00:05:38,490
opportunity to do that usually because I

125
00:05:38,490 --> 00:05:41,160
controlled a budget and myself to go do

126
00:05:41,160 --> 00:05:45,780
that but but not everybody does right

127
00:05:45,780 --> 00:05:48,510
and and out of all the people who raised

128
00:05:48,510 --> 00:05:50,160
your hands how many of you your actual

129
00:05:50,160 --> 00:05:53,940
title is you're a malware analyst okay

130
00:05:53,940 --> 00:05:55,320
so not as many right

131
00:05:55,320 --> 00:05:58,320
so my point them trying to get across

132
00:05:58,320 --> 00:06:00,720
with this talk is just you know maybe

133
00:06:00,720 --> 00:06:03,150
you don't know where to start maybe your

134
00:06:03,150 --> 00:06:05,010
idea of malware analysis is well I'm not

135
00:06:05,010 --> 00:06:07,230
a malware analyst I don't have the right

136
00:06:07,230 --> 00:06:08,850
tools and/or the right environment I

137
00:06:08,850 --> 00:06:09,720
don't have the training the

138
00:06:09,720 --> 00:06:12,690
certifications I just I can't really do

139
00:06:12,690 --> 00:06:13,980
anything other than just throw stuff in

140
00:06:13,980 --> 00:06:17,130
a sandbox and you know really all you

141
00:06:17,130 --> 00:06:19,590
need is the curiosity and persistence

142
00:06:19,590 --> 00:06:21,480
and the persistence is not to be

143
00:06:21,480 --> 00:06:23,490
underestimated right the unless you have

144
00:06:23,490 --> 00:06:25,520
the persistence almost to the point of

145
00:06:25,520 --> 00:06:29,130
masochism of I'm gonna do a really hard

146
00:06:29,130 --> 00:06:32,100
so doq puzzle or crossword puzzle and

147
00:06:32,100 --> 00:06:33,480
get to the end and realize I have to

148
00:06:33,480 --> 00:06:35,940
start over that's the type of

149
00:06:35,940 --> 00:06:38,910
persistence I'm talking about you know

150
00:06:38,910 --> 00:06:40,249
really just have to

151
00:06:40,249 --> 00:06:43,009
to to want to learn and I would say

152
00:06:43,009 --> 00:06:45,109
bottom line up front for anybody who

153
00:06:45,109 --> 00:06:46,909
suddenly has to go take a phone call or

154
00:06:46,909 --> 00:06:51,139
whatever you know like they always say

155
00:06:51,139 --> 00:06:52,819
tell people we were gonna tell them and

156
00:06:52,819 --> 00:06:54,259
tell them and then tell them what you

157
00:06:54,259 --> 00:06:57,829
told them you know start with

158
00:06:57,829 --> 00:06:59,269
script-based our this is this was an

159
00:06:59,269 --> 00:07:02,239
epiphany that actually I kind of had but

160
00:07:02,239 --> 00:07:04,099
really all credit a friend of a friend

161
00:07:04,099 --> 00:07:07,129
of mine and former former coworker I had

162
00:07:07,129 --> 00:07:09,079
and we were talking to our analyst one

163
00:07:09,079 --> 00:07:11,029
of the better ones I've known had the

164
00:07:11,029 --> 00:07:13,759
Epiphany that you know 10 years ago

165
00:07:13,759 --> 00:07:15,559
or you know if we could tell somebody

166
00:07:15,559 --> 00:07:16,909
today like where should you start you

167
00:07:16,909 --> 00:07:18,199
know you have one day to train somebody

168
00:07:18,199 --> 00:07:20,149
that sort of thing that we would have

169
00:07:20,149 --> 00:07:22,869
you know before we did the whole

170
00:07:22,869 --> 00:07:26,689
learning sea and windows API and Windows

171
00:07:26,689 --> 00:07:29,719
internals and spending a lot of time

172
00:07:29,719 --> 00:07:33,289
staring it assembly in Ida we would have

173
00:07:33,289 --> 00:07:34,849
started with script based malware or

174
00:07:34,849 --> 00:07:38,179
scripts right so it's just sort of the

175
00:07:38,179 --> 00:07:42,229
most bang for the buck the second point

176
00:07:42,229 --> 00:07:43,969
I would make is that it's it's it's not

177
00:07:43,969 --> 00:07:47,360
magic it's just code so even if you say

178
00:07:47,360 --> 00:07:49,249
I'm not a developer I've never written a

179
00:07:49,249 --> 00:07:51,589
line of code in my life write a

180
00:07:51,589 --> 00:07:53,449
HelloWorld script pictus pick a

181
00:07:53,449 --> 00:07:55,639
scripting language I guarantee you and

182
00:07:55,639 --> 00:07:57,259
if you already know something stick with

183
00:07:57,259 --> 00:07:59,299
that I guarantee you there's malware

184
00:07:59,299 --> 00:08:00,649
written in it I mean how many people

185
00:08:00,649 --> 00:08:04,999
here are Lua developers nobody right is

186
00:08:04,999 --> 00:08:06,829
can anyone here you know my show hands

187
00:08:06,829 --> 00:08:09,409
even even familiar with anything vaguely

188
00:08:09,409 --> 00:08:12,589
important written in Lua it's like maybe

189
00:08:12,589 --> 00:08:14,899
a handful of people and out of any of

190
00:08:14,899 --> 00:08:18,829
those people is your answer not world of

191
00:08:18,829 --> 00:08:24,319
warcraft mods the other thing would be a

192
00:08:24,319 --> 00:08:26,569
bunch of Stuxnet and some some related

193
00:08:26,569 --> 00:08:28,729
stuff related implants there's been

194
00:08:28,729 --> 00:08:30,619
plenty of our written in Lua and it's

195
00:08:30,619 --> 00:08:33,948
pretty obscure language doesn't require

196
00:08:33,948 --> 00:08:36,409
any special software right it's

197
00:08:36,409 --> 00:08:38,479
literally all you need is a VM and

198
00:08:38,479 --> 00:08:41,870
notepad or some text editor and you can

199
00:08:41,870 --> 00:08:44,569
analyze script based malware it's not

200
00:08:44,569 --> 00:08:46,309
going to be the ideal environment maybe

201
00:08:46,309 --> 00:08:47,209
there are some other things that would

202
00:08:47,209 --> 00:08:49,069
help but you guys are going to see

203
00:08:49,069 --> 00:08:50,720
that's that's really about as basic as

204
00:08:50,720 --> 00:08:53,940
it gets and you know you

205
00:08:53,940 --> 00:08:56,370
smarter than a sandbox so if I had like

206
00:08:56,370 --> 00:08:59,130
a single tagline for this talk that you

207
00:08:59,130 --> 00:09:01,610
are as a team or as a defender

208
00:09:01,610 --> 00:09:03,390
regardless of what you think you're

209
00:09:03,390 --> 00:09:04,890
capable of doing you are smarter than a

210
00:09:04,890 --> 00:09:06,900
sandbox and malware authors aren't

211
00:09:06,900 --> 00:09:09,240
stupid right they're putting in all

212
00:09:09,240 --> 00:09:11,760
sorts of anti forensics they might have

213
00:09:11,760 --> 00:09:15,420
fake call-outs they might have you know

214
00:09:15,420 --> 00:09:18,000
a weight that you don't know about and

215
00:09:18,000 --> 00:09:19,740
if all you ever did was detonate

216
00:09:19,740 --> 00:09:21,870
something in a sandbox and then go oh

217
00:09:21,870 --> 00:09:24,630
yeah I got the hyper tease you know we

218
00:09:24,630 --> 00:09:27,270
got this domain and that domain maybe

219
00:09:27,270 --> 00:09:28,710
you did maybe you didn't get the right

220
00:09:28,710 --> 00:09:31,500
payload you know maybe you didn't get

221
00:09:31,500 --> 00:09:33,060
the right situ you might not actually

222
00:09:33,060 --> 00:09:35,430
know that unless you've really looked at

223
00:09:35,430 --> 00:09:36,870
the malware and done some manual

224
00:09:36,870 --> 00:09:38,640
analysis and that's not to say that

225
00:09:38,640 --> 00:09:40,650
automation doesn't have its place right

226
00:09:40,650 --> 00:09:43,500
for triage and things like that but it

227
00:09:43,500 --> 00:09:45,420
should be the first step and just that

228
00:09:45,420 --> 00:09:49,200
triage step right okay so enough on the

229
00:09:49,200 --> 00:09:51,480
soapbox I said that this was gonna be

230
00:09:51,480 --> 00:09:53,790
your best bang for the buck so this is

231
00:09:53,790 --> 00:09:55,320
kind of the Pareto principle anybody

232
00:09:55,320 --> 00:09:56,360
here familiar with the Pareto principle

233
00:09:56,360 --> 00:10:00,360
maybe a few people so this is alfredo

234
00:10:00,360 --> 00:10:02,300
Pareto he was an Italian economist

235
00:10:02,300 --> 00:10:05,400
clearly clear clearly a wise incredible

236
00:10:05,400 --> 00:10:10,860
man based on his beard it's actually an

237
00:10:10,860 --> 00:10:12,780
apocryphal attribution that I've only

238
00:10:12,780 --> 00:10:14,790
ever heard from people with MBAs or like

239
00:10:14,790 --> 00:10:16,830
from a business school background as

240
00:10:16,830 --> 00:10:18,480
somebody with an econ Amish degree once

241
00:10:18,480 --> 00:10:22,110
upon a time you know it's it's not an

242
00:10:22,110 --> 00:10:23,550
actual economics thing and they think

243
00:10:23,550 --> 00:10:25,710
that it's like an apocryphal attribution

244
00:10:25,710 --> 00:10:29,130
by an engineer he did come up with

245
00:10:29,130 --> 00:10:31,140
Pareto optimality which is a real thing

246
00:10:31,140 --> 00:10:32,730
and like game theory but that's all

247
00:10:32,730 --> 00:10:34,950
other pull their talk

248
00:10:34,950 --> 00:10:40,110
my other nerd out area of expertise yeah

249
00:10:40,110 --> 00:10:42,660
so it's the idea is 20% of effort to get

250
00:10:42,660 --> 00:10:45,839
80% of the return right so why not do

251
00:10:45,839 --> 00:10:47,430
that up front and start seeing an

252
00:10:47,430 --> 00:10:50,430
immediate ROI you know if I when I when

253
00:10:50,430 --> 00:10:52,290
I train interns or I've trained like new

254
00:10:52,290 --> 00:10:54,630
malware analysts this is always this is

255
00:10:54,630 --> 00:10:56,430
now like my standard approach because I

256
00:10:56,430 --> 00:10:58,320
can get them immediately doing useful

257
00:10:58,320 --> 00:11:00,839
work and feeling confident and feeling

258
00:11:00,839 --> 00:11:02,280
like they know how to do something right

259
00:11:02,280 --> 00:11:04,020
rather than having somebody stumble

260
00:11:04,020 --> 00:11:07,110
around learning learning

261
00:11:07,110 --> 00:11:10,860
assembly so phishing email attachments

262
00:11:10,860 --> 00:11:13,410
drive-by downloads live off the land

263
00:11:13,410 --> 00:11:15,180
activity how many people have heard that

264
00:11:15,180 --> 00:11:17,310
buzzword right that's sort of like been

265
00:11:17,310 --> 00:11:19,320
the flavor of the month for a lot of

266
00:11:19,320 --> 00:11:23,550
months now so scripts what are they good

267
00:11:23,550 --> 00:11:25,589
for you know everybody here familiar

268
00:11:25,589 --> 00:11:28,800
with miter attack model or like Lockheed

269
00:11:28,800 --> 00:11:31,560
Martin cyber kill chain whatever model

270
00:11:31,560 --> 00:11:33,390
you want to use to kind of look at

271
00:11:33,390 --> 00:11:37,019
attacker behavior most of your stages or

272
00:11:37,019 --> 00:11:39,480
activities or something that an attacker

273
00:11:39,480 --> 00:11:43,470
can do with script based malware of some

274
00:11:43,470 --> 00:11:45,149
sort without portable executable files

275
00:11:45,149 --> 00:11:49,050
in many cases today may be doing without

276
00:11:49,050 --> 00:11:51,839
compiled binaries just because that live

277
00:11:51,839 --> 00:11:55,250
off the land principle of using

278
00:11:55,250 --> 00:11:56,910
components that are going to be

279
00:11:56,910 --> 00:11:58,380
whitelisted things that are going to be

280
00:11:58,380 --> 00:12:00,779
kind of found tools that systems and

281
00:12:00,779 --> 00:12:04,920
ministers use and so on and so forth so

282
00:12:04,920 --> 00:12:07,160
let me start you start by getting into

283
00:12:07,160 --> 00:12:10,260
VB right into an example of this and

284
00:12:10,260 --> 00:12:12,899
that's the visual basic scripting and

285
00:12:12,899 --> 00:12:17,880
phishing emails so it would not be a

286
00:12:17,880 --> 00:12:19,800
malware talk without a little bit of the

287
00:12:19,800 --> 00:12:21,420
wayback machine talking about malware

288
00:12:21,420 --> 00:12:23,640
that nobody remembers maybe somebody

289
00:12:23,640 --> 00:12:24,990
some people in the room do you remember

290
00:12:24,990 --> 00:12:27,240
I love you were it was one of the first

291
00:12:27,240 --> 00:12:32,329
really big really big phishing email

292
00:12:32,329 --> 00:12:35,550
campaigns like mass mailer sort of thing

293
00:12:35,550 --> 00:12:37,649
and it was just two students from the

294
00:12:37,649 --> 00:12:40,560
Philippines who wrote this in VBS and

295
00:12:40,560 --> 00:12:43,079
this is just a part of the code the main

296
00:12:43,079 --> 00:12:45,630
method or they may be you know the main

297
00:12:45,630 --> 00:12:49,589
function and sub in the script but it's

298
00:12:49,589 --> 00:12:51,029
estimated it affected something like

299
00:12:51,029 --> 00:12:52,560
forty five million users around the

300
00:12:52,560 --> 00:12:54,959
world unintentionally and this wasn't

301
00:12:54,959 --> 00:12:57,089
really a deliberate part of what the

302
00:12:57,089 --> 00:12:58,589
malware were supposed to do but it was

303
00:12:58,589 --> 00:13:00,930
just so successful that when it was

304
00:13:00,930 --> 00:13:04,410
going around looking in people's email

305
00:13:04,410 --> 00:13:07,199
outlet contacts and then remaining it

306
00:13:07,199 --> 00:13:09,420
copies of itself as an attachment as a

307
00:13:09,420 --> 00:13:12,540
phishing attachment it ended up crashing

308
00:13:12,540 --> 00:13:14,730
Outlook servers and and being like into

309
00:13:14,730 --> 00:13:17,819
a service attack on huge huge companies

310
00:13:17,819 --> 00:13:20,640
and governments around the world

311
00:13:20,640 --> 00:13:22,950
and it was pretty malicious despite the

312
00:13:22,950 --> 00:13:24,649
claim so the two students that wrote it

313
00:13:24,649 --> 00:13:28,040
it looked for document and other

314
00:13:28,040 --> 00:13:30,329
specific file extensions and over wrote

315
00:13:30,329 --> 00:13:33,240
things so it's pretty disruptive the

316
00:13:33,240 --> 00:13:35,760
point is it was written in VBS and it

317
00:13:35,760 --> 00:13:40,230
was written in VBS with API API code

318
00:13:40,230 --> 00:13:43,140
that you know standard code that is

319
00:13:43,140 --> 00:13:45,870
still around in Windows 10 or some

320
00:13:45,870 --> 00:13:49,140
version of it it might be a new CLS IDE

321
00:13:49,140 --> 00:13:51,360
and a new you know a new version of

322
00:13:51,360 --> 00:13:53,190
something but it's like the same comm

323
00:13:53,190 --> 00:13:55,470
objects are still to be found on a

324
00:13:55,470 --> 00:14:00,329
Windows system today and so in terms of

325
00:14:00,329 --> 00:14:01,560
that mitre attack we're talking about

326
00:14:01,560 --> 00:14:04,380
you know initial access we're talking

327
00:14:04,380 --> 00:14:09,680
about initial delivery and installation

328
00:14:10,760 --> 00:14:13,110
there's still stuff around today I've

329
00:14:13,110 --> 00:14:15,510
looked at phishing emails in the past

330
00:14:15,510 --> 00:14:17,940
year that we're not really that similar

331
00:14:17,940 --> 00:14:19,470
from something like I love you worm

332
00:14:19,470 --> 00:14:20,760
other than the fact that they were

333
00:14:20,760 --> 00:14:23,490
heavily obvious gated which which it did

334
00:14:23,490 --> 00:14:25,050
not have to be because there wasn't

335
00:14:25,050 --> 00:14:27,899
anybody looking to detect it so eighteen

336
00:14:27,899 --> 00:14:29,310
years later is still pointing strong

337
00:14:29,310 --> 00:14:30,930
which in a certain sense is kind of

338
00:14:30,930 --> 00:14:33,660
depressing in another sense though I

339
00:14:33,660 --> 00:14:36,180
think kind of makes the point that I was

340
00:14:36,180 --> 00:14:37,769
trying to make about the value of

341
00:14:37,769 --> 00:14:39,000
starting with scripts and learning

342
00:14:39,000 --> 00:14:42,060
something very simple can help solve you

343
00:14:42,060 --> 00:14:44,610
know a lot of problems or help give you

344
00:14:44,610 --> 00:14:49,560
a lot of capability so today primarily

345
00:14:49,560 --> 00:14:51,870
you're gonna see this VB these types of

346
00:14:51,870 --> 00:14:55,230
VBS scripts used for staging payloads

347
00:14:55,230 --> 00:14:57,390
rather than as necessarily the main

348
00:14:57,390 --> 00:14:59,640
payload and what I mean by that for

349
00:14:59,640 --> 00:15:01,800
those who aren't familiar you know is

350
00:15:01,800 --> 00:15:04,050
either droppers or downloaders so a

351
00:15:04,050 --> 00:15:05,910
dropper we have might have an embedded

352
00:15:05,910 --> 00:15:09,720
executable not necessarily a VBS

353
00:15:09,720 --> 00:15:12,029
contacts but remember couple years ago

354
00:15:12,029 --> 00:15:14,730
it was a thing where people were using

355
00:15:14,730 --> 00:15:18,360
to compile dotnet files and the actual

356
00:15:18,360 --> 00:15:19,920
payload was just a variable that

357
00:15:19,920 --> 00:15:22,019
contained you know and encoded or

358
00:15:22,019 --> 00:15:23,610
encrypted string and they were just

359
00:15:23,610 --> 00:15:26,670
using it as a carrier file to get around

360
00:15:26,670 --> 00:15:29,459
defenses and specifically as an anti

361
00:15:29,459 --> 00:15:34,560
forensics against oxes downloaders right

362
00:15:34,560 --> 00:15:37,800
so it might just be a short snippet of

363
00:15:37,800 --> 00:15:41,460
EBS using a handful of calm objects to

364
00:15:41,460 --> 00:15:44,240
go out and download the real payload and

365
00:15:44,240 --> 00:15:47,340
or it could the the real people could be

366
00:15:47,340 --> 00:15:50,430
scripts but so why would we do this this

367
00:15:50,430 --> 00:15:51,810
is making things a little bit more

368
00:15:51,810 --> 00:15:54,029
complicated than it needs to be well you

369
00:15:54,029 --> 00:15:55,140
know think about it this way would you

370
00:15:55,140 --> 00:15:57,570
rather write if you've got your new cool

371
00:15:57,570 --> 00:16:00,750
banking Trojan written in C or C++ or

372
00:16:00,750 --> 00:16:03,029
whatever and it took you six months to

373
00:16:03,029 --> 00:16:05,279
write or you paid for it from some guy

374
00:16:05,279 --> 00:16:06,690
in the Ukraine who it took him six

375
00:16:06,690 --> 00:16:09,240
months to write do you want that to get

376
00:16:09,240 --> 00:16:10,410
burned if you're a phishing email

377
00:16:10,410 --> 00:16:13,560
campaign go sideways or would you rather

378
00:16:13,560 --> 00:16:15,900
just have a Java Script downloader that

379
00:16:15,900 --> 00:16:17,520
took you a half hour to write get burned

380
00:16:17,520 --> 00:16:20,370
and and I'd be the end of it and of

381
00:16:20,370 --> 00:16:23,460
course cybercrime you know is is a

382
00:16:23,460 --> 00:16:25,290
business and and there's not always

383
00:16:25,290 --> 00:16:28,230
vertical integration so I might be just

384
00:16:28,230 --> 00:16:31,410
delivering payload for a client and I

385
00:16:31,410 --> 00:16:34,230
want it to be sort of agnostic right and

386
00:16:34,230 --> 00:16:36,000
then to the defense evasion which I kind

387
00:16:36,000 --> 00:16:39,780
of already mentioned so in terms of

388
00:16:39,780 --> 00:16:41,910
tools I mean really you're just starting

389
00:16:41,910 --> 00:16:45,420
with a text editor and a VM now I would

390
00:16:45,420 --> 00:16:47,690
recommend using more of a full-featured

391
00:16:47,690 --> 00:16:50,250
text editor something like notepad plus

392
00:16:50,250 --> 00:16:53,490
plus that is intended for developers

393
00:16:53,490 --> 00:16:55,640
especially people who do scripting a lot

394
00:16:55,640 --> 00:16:57,990
and where you can kind of set it to a

395
00:16:57,990 --> 00:16:59,700
particular scripting language and it'll

396
00:16:59,700 --> 00:17:01,710
highlight all the keywords that it

397
00:17:01,710 --> 00:17:04,530
recognizes as being associated with that

398
00:17:04,530 --> 00:17:07,319
scripting language but that's not

399
00:17:07,319 --> 00:17:08,849
necessary I mean you could just use

400
00:17:08,849 --> 00:17:10,829
notepad or something or G edit or

401
00:17:10,829 --> 00:17:15,619
whatever VI if you're really adventurous

402
00:17:15,619 --> 00:17:20,449
no VI event no VI them them fans okay

403
00:17:20,449 --> 00:17:22,170
that was a joke

404
00:17:22,170 --> 00:17:24,359
I would I would not I would smash my

405
00:17:24,359 --> 00:17:27,569
hand in a car door before I analyzed

406
00:17:27,569 --> 00:17:32,040
however but VI yeah

407
00:17:32,040 --> 00:17:36,210
so of course internet access we always

408
00:17:36,210 --> 00:17:39,150
want to be safe don't have your VM set

409
00:17:39,150 --> 00:17:41,820
to a bridge or an added connection ran

410
00:17:41,820 --> 00:17:43,110
into this yesterday with the training

411
00:17:43,110 --> 00:17:44,429
there were some folks who really didn't

412
00:17:44,429 --> 00:17:46,470
quite get the concept of hosts only

413
00:17:46,470 --> 00:17:47,790
networks and we're asking questions

414
00:17:47,790 --> 00:17:48,510
about that

415
00:17:48,510 --> 00:17:50,460
so I'm not trying to oversimplify things

416
00:17:50,460 --> 00:17:53,400
but some people you know are not clear

417
00:17:53,400 --> 00:17:57,210
on that yeah I generally don't use real

418
00:17:57,210 --> 00:18:00,150
debuggers for most of the script power

419
00:18:00,150 --> 00:18:02,790
because it's so a lot of it is just

420
00:18:02,790 --> 00:18:04,500
simple downloaders and they're not real

421
00:18:04,500 --> 00:18:06,600
expensive I generally haven't found a

422
00:18:06,600 --> 00:18:08,309
super big need to use like a

423
00:18:08,309 --> 00:18:11,460
full-featured debugger but if you did

424
00:18:11,460 --> 00:18:13,440
want to like if you install Microsoft

425
00:18:13,440 --> 00:18:17,460
Visual Studio there is and there is with

426
00:18:17,460 --> 00:18:21,540
CS C script Exe E and like W script

427
00:18:21,540 --> 00:18:24,600
there's an option like a forward slash

428
00:18:24,600 --> 00:18:25,890
ax that you can start

429
00:18:25,890 --> 00:18:28,740
Ronna VBS script in like a debugger a

430
00:18:28,740 --> 00:18:31,530
real debugger mode and I think set set

431
00:18:31,530 --> 00:18:33,929
set points and things like that I don't

432
00:18:33,929 --> 00:18:34,980
do that

433
00:18:34,980 --> 00:18:37,740
my poor man's debugger is just using

434
00:18:37,740 --> 00:18:38,669
message box

435
00:18:38,669 --> 00:18:42,870
so in VBS if you just you'll see it in a

436
00:18:42,870 --> 00:18:44,190
minute but if you just put things in a

437
00:18:44,190 --> 00:18:45,570
message box you can get an immediate

438
00:18:45,570 --> 00:18:48,600
feed out our output and feedback of what

439
00:18:48,600 --> 00:18:51,990
the code was doing similar thing if

440
00:18:51,990 --> 00:18:53,490
you're working with malicious JavaScript

441
00:18:53,490 --> 00:18:56,660
or just using like an alert box right

442
00:18:56,660 --> 00:18:59,330
general strategy for these VBS

443
00:18:59,330 --> 00:19:03,600
downloader phishing emails you've got to

444
00:19:03,600 --> 00:19:05,100
first extract it from source and

445
00:19:05,100 --> 00:19:06,750
sometimes this is the hardest part and

446
00:19:06,750 --> 00:19:09,330
that's a whole talk onto itself it's a

447
00:19:09,330 --> 00:19:13,320
whole talk for another day but and I'll

448
00:19:13,320 --> 00:19:15,419
go through an exam I'll go through some

449
00:19:15,419 --> 00:19:18,059
of it and my example that we have coming

450
00:19:18,059 --> 00:19:20,220
up here in a minute but you know it's

451
00:19:20,220 --> 00:19:23,669
generally gonna involve extracting like

452
00:19:23,669 --> 00:19:27,900
an O le object from interact extracting

453
00:19:27,900 --> 00:19:29,160
something from a word document and

454
00:19:29,160 --> 00:19:30,929
carving it out and then getting it into

455
00:19:30,929 --> 00:19:34,559
your text editor finding unobvious gated

456
00:19:34,559 --> 00:19:38,429
code keywords and cleaning up line

457
00:19:38,429 --> 00:19:39,960
written generally cleaning up the code

458
00:19:39,960 --> 00:19:43,290
so in fee BS you'll have the whole

459
00:19:43,290 --> 00:19:45,179
script will be shoved together with

460
00:19:45,179 --> 00:19:48,809
colons which which act is like a line

461
00:19:48,809 --> 00:19:51,090
continuation and so breaking those out

462
00:19:51,090 --> 00:19:53,130
just so it's more readable and then as I

463
00:19:53,130 --> 00:19:54,150
said if you're using something like

464
00:19:54,150 --> 00:19:56,340
notepad plus plus anything that's uh

465
00:19:56,340 --> 00:19:58,860
Navia skated which there's always going

466
00:19:58,860 --> 00:20:00,090
to be some code that they've left

467
00:20:00,090 --> 00:20:02,410
unobvious gated it's going to go ahead

468
00:20:02,410 --> 00:20:04,150
highlight that for you and that gives

469
00:20:04,150 --> 00:20:06,250
you like a better fun better starting

470
00:20:06,250 --> 00:20:08,140
point right of determining hey this is a

471
00:20:08,140 --> 00:20:10,630
worse of function starts and stops or

472
00:20:10,630 --> 00:20:12,340
something like that even if I can't read

473
00:20:12,340 --> 00:20:17,530
what it does sometimes iOS user just in

474
00:20:17,530 --> 00:20:18,910
plain text as you'll see a little bit

475
00:20:18,910 --> 00:20:21,160
later but as I said don't believe it

476
00:20:21,160 --> 00:20:22,210
because you don't know what took me it's

477
00:20:22,210 --> 00:20:25,090
high forensics are going on try finding

478
00:20:25,090 --> 00:20:27,100
eval or execute functions and

479
00:20:27,100 --> 00:20:28,750
substituting them with message box

480
00:20:28,750 --> 00:20:33,010
that's like the go-to first Jose maybe

481
00:20:33,010 --> 00:20:35,800
25% something less than 50% with a

482
00:20:35,800 --> 00:20:38,560
sizeable chunk of VBS malware you can

483
00:20:38,560 --> 00:20:40,510
defeat the obvious case in just with

484
00:20:40,510 --> 00:20:43,180
that right because it's they're being

485
00:20:43,180 --> 00:20:45,310
lazy they just want to avoid basic

486
00:20:45,310 --> 00:20:48,370
detection and they're just running

487
00:20:48,370 --> 00:20:50,890
everything through eval and you can do

488
00:20:50,890 --> 00:20:52,540
the same thing too and just output with

489
00:20:52,540 --> 00:20:55,300
message box the unobvious gated copy of

490
00:20:55,300 --> 00:20:58,900
the code get rid of obvious garbage

491
00:20:58,900 --> 00:21:05,230
functions you know look for the DD the

492
00:21:05,230 --> 00:21:07,950
decoder or D obvious keishon functions

493
00:21:07,950 --> 00:21:10,690
because they have to be in the sample

494
00:21:10,690 --> 00:21:13,660
somewhere maybe possibly if this was

495
00:21:13,660 --> 00:21:16,030
like a second stage to some other

496
00:21:16,030 --> 00:21:17,500
malware there might be some other

497
00:21:17,500 --> 00:21:19,000
component that does the decoding and

498
00:21:19,000 --> 00:21:22,240
decrypting but generally you're gonna

499
00:21:22,240 --> 00:21:24,880
have some type of decoder function like

500
00:21:24,880 --> 00:21:26,800
that the simplest method being that eval

501
00:21:26,800 --> 00:21:29,830
statement that's gonna be in the malware

502
00:21:29,830 --> 00:21:31,690
itself so if you can find that first you

503
00:21:31,690 --> 00:21:33,460
can write it a quick decoder and

504
00:21:33,460 --> 00:21:35,050
whatever scripting language you're

505
00:21:35,050 --> 00:21:36,370
comfortable with doesn't have to be the

506
00:21:36,370 --> 00:21:37,990
same scripting language I mean I've had

507
00:21:37,990 --> 00:21:40,210
people ask me that just because I'm

508
00:21:40,210 --> 00:21:41,920
looking at VBS doesn't mean that I can't

509
00:21:41,920 --> 00:21:44,560
use Python to write my decoder and

510
00:21:44,560 --> 00:21:46,270
especially if I'm seeing the same type

511
00:21:46,270 --> 00:21:48,370
of thing over and over again and the

512
00:21:48,370 --> 00:21:50,050
same type of phishing emails over and

513
00:21:50,050 --> 00:21:52,090
over again you might start to have a

514
00:21:52,090 --> 00:21:54,700
payoff to writing those decoders and and

515
00:21:54,700 --> 00:21:56,790
making them a little more robust

516
00:21:56,790 --> 00:21:58,900
identify the really useful bits it's

517
00:21:58,900 --> 00:22:01,600
typically gonna be common really common

518
00:22:01,600 --> 00:22:03,430
or run-of-the-mill common seem calm

519
00:22:03,430 --> 00:22:06,070
objects over and over again you'll see

520
00:22:06,070 --> 00:22:08,860
and we'll see all this coming up in the

521
00:22:08,860 --> 00:22:11,530
example renaming functions to something

522
00:22:11,530 --> 00:22:14,590
meaningful and commenting your code this

523
00:22:14,590 --> 00:22:15,480
is even more

524
00:22:15,480 --> 00:22:17,880
in our analysis than it is and I think

525
00:22:17,880 --> 00:22:21,360
in being a developer because ultimately

526
00:22:21,360 --> 00:22:24,000
you have to communicate your results and

527
00:22:24,000 --> 00:22:26,340
your information to someone else for

528
00:22:26,340 --> 00:22:28,130
your work to be a value whether that's

529
00:22:28,130 --> 00:22:30,450
reporting to management whether that's

530
00:22:30,450 --> 00:22:32,100
talking to thread Intel guys who aren't

531
00:22:32,100 --> 00:22:34,110
as technical as you are or whether

532
00:22:34,110 --> 00:22:36,300
that's communicating information so you

533
00:22:36,300 --> 00:22:39,630
can write a yarder rule or a signature

534
00:22:39,630 --> 00:22:42,330
for an IDs or something so you want to

535
00:22:42,330 --> 00:22:44,100
right off the bat start commenting your

536
00:22:44,100 --> 00:22:46,590
code as you go and renaming things in a

537
00:22:46,590 --> 00:22:49,200
way that's gonna help help that and I

538
00:22:49,200 --> 00:22:50,820
think them like the miter attack model

539
00:22:50,820 --> 00:22:53,070
or something along those lines is a good

540
00:22:53,070 --> 00:22:54,510
way to standardize your language in

541
00:22:54,510 --> 00:22:56,480
terminology when you do that

542
00:22:56,480 --> 00:22:58,260
establishing sequence of files and

543
00:22:58,260 --> 00:23:01,620
processes noting anti forensics the last

544
00:23:01,620 --> 00:23:04,080
the only thing I'll hit on here is this

545
00:23:04,080 --> 00:23:06,090
last point it's a little bit of a

546
00:23:06,090 --> 00:23:08,970
soapbox point but that observables are

547
00:23:08,970 --> 00:23:12,600
not indicators so you know I once got an

548
00:23:12,600 --> 00:23:14,760
Excel spreadsheet from an analyst at a

549
00:23:14,760 --> 00:23:18,450
fortune 500 sock that was more or less

550
00:23:18,450 --> 00:23:22,020
just a big list of ip's and I was kind

551
00:23:22,020 --> 00:23:23,250
of like it was like did you get those

552
00:23:23,250 --> 00:23:27,330
indicators yeah so are these IP

553
00:23:27,330 --> 00:23:31,320
addresses you know hosting second-stage

554
00:23:31,320 --> 00:23:34,800
payloads is this a c2 server what is

555
00:23:34,800 --> 00:23:37,560
this right it's that contacts that makes

556
00:23:37,560 --> 00:23:38,850
an indicator and indicator and

557
00:23:38,850 --> 00:23:40,890
actionable and so again when you're

558
00:23:40,890 --> 00:23:42,870
you're you know making your notes and

559
00:23:42,870 --> 00:23:45,600
you're saying I'm trying to find IFC's

560
00:23:45,600 --> 00:23:48,030
make sure you're finding actual IOC s

561
00:23:48,030 --> 00:23:49,140
and have all the information

562
00:23:49,140 --> 00:23:54,660
sorry soapbox point so let's go through

563
00:23:54,660 --> 00:23:56,220
an example I think this is going to be a

564
00:23:56,220 --> 00:23:59,190
little bit more clear VBS downloader so

565
00:23:59,190 --> 00:24:01,980
phishing email was received forwarded to

566
00:24:01,980 --> 00:24:05,250
security to an organization there was an

567
00:24:05,250 --> 00:24:07,230
embedded it was embedded in a word

568
00:24:07,230 --> 00:24:09,330
document the word document was password

569
00:24:09,330 --> 00:24:11,610
protected so going back to answer

570
00:24:11,610 --> 00:24:15,510
forensics we had a cuckoo beast like

571
00:24:15,510 --> 00:24:19,710
sandbox farm setup that we could throw

572
00:24:19,710 --> 00:24:21,510
samples through and we were actually

573
00:24:21,510 --> 00:24:25,740
more using that for kind of threat

574
00:24:25,740 --> 00:24:27,540
emulation and helping develop blue team

575
00:24:27,540 --> 00:24:28,980
tactics then

576
00:24:28,980 --> 00:24:30,690
like operationally focused malware

577
00:24:30,690 --> 00:24:33,510
analysis but the point is is that that

578
00:24:33,510 --> 00:24:35,820
that kind of broke that model right and

579
00:24:35,820 --> 00:24:38,070
broke the idea of just detonating it in

580
00:24:38,070 --> 00:24:40,440
cuckoo even though we had cuckoo sandbox

581
00:24:40,440 --> 00:24:44,490
is set up with with were office in them

582
00:24:44,490 --> 00:24:46,290
and we typically could just detonate

583
00:24:46,290 --> 00:24:49,549
office documents and get get information

584
00:24:49,549 --> 00:24:54,530
so how to use used ms ms ms em sock

585
00:24:54,530 --> 00:25:00,150
which is a ms o le or excuse me an MS

586
00:25:00,150 --> 00:25:02,760
password removal tool third a number of

587
00:25:02,760 --> 00:25:04,500
them out there this is just a free one

588
00:25:04,500 --> 00:25:06,660
that I think has a github page and then

589
00:25:06,660 --> 00:25:10,620
carved out the the script in from word

590
00:25:10,620 --> 00:25:13,559
and he had just in this case it was easy

591
00:25:13,559 --> 00:25:16,320
enough to do it once it was decrypted or

592
00:25:16,320 --> 00:25:18,780
decompressed the password correction was

593
00:25:18,780 --> 00:25:21,990
removed to do it it was a hex editor but

594
00:25:21,990 --> 00:25:23,610
you know you may do that with some other

595
00:25:23,610 --> 00:25:28,350
tools like Baldwin's ma office mal

596
00:25:28,350 --> 00:25:31,530
scanner or the de collage I forget the

597
00:25:31,530 --> 00:25:32,669
actual name of the tool but the site is

598
00:25:32,669 --> 00:25:36,660
de collage that have the Oh le extractor

599
00:25:36,660 --> 00:25:40,230
tool that they have there you can google

600
00:25:40,230 --> 00:25:43,080
for them this is a little you know and

601
00:25:43,080 --> 00:25:44,010
then it was just a matter of starting

602
00:25:44,010 --> 00:25:47,190
the base and cleanup so as I said to

603
00:25:47,190 --> 00:25:49,200
kind of focus on the actual script part

604
00:25:49,200 --> 00:25:51,090
is that first part is sort of its own

605
00:25:51,090 --> 00:25:54,540
art form as well on the right here you

606
00:25:54,540 --> 00:25:56,790
can see that is the obvious gated copy

607
00:25:56,790 --> 00:25:59,070
where I've just done an initial cleanup

608
00:25:59,070 --> 00:26:04,020
of breaking out those line continuations

609
00:26:04,020 --> 00:26:05,700
so that it's a little bit more readable

610
00:26:05,700 --> 00:26:07,830
and you can see that notepad plus plus

611
00:26:07,830 --> 00:26:10,530
has identified functions and so I'm able

612
00:26:10,530 --> 00:26:13,230
to say okay this is a function here's

613
00:26:13,230 --> 00:26:14,640
the name of the function it's not a

614
00:26:14,640 --> 00:26:17,010
human readable name it's sort of a

615
00:26:17,010 --> 00:26:18,870
garbage name but I can highlight that

616
00:26:18,870 --> 00:26:20,940
and then search to see is this function

617
00:26:20,940 --> 00:26:23,730
even called anywhere else in the script

618
00:26:23,730 --> 00:26:26,309
and if not it's probably just garbage

619
00:26:26,309 --> 00:26:28,590
code there to distract me and I can

620
00:26:28,590 --> 00:26:30,600
delete it out at least out of a copy of

621
00:26:30,600 --> 00:26:33,390
the script and start working from that

622
00:26:33,390 --> 00:26:35,700
assumption and I'm gradually reducing

623
00:26:35,700 --> 00:26:37,110
this stuff I actually have to look at

624
00:26:37,110 --> 00:26:42,700
right so after I've eliminated some

625
00:26:42,700 --> 00:26:45,220
of the garbage code I'm going through t

626
00:26:45,220 --> 00:26:47,320
obvious Gatien so I've identified this

627
00:26:47,320 --> 00:26:49,000
function which you can see up there

628
00:26:49,000 --> 00:26:51,940
which is actually three functions that

629
00:26:51,940 --> 00:26:54,580
were the main obvious Gatien functions

630
00:26:54,580 --> 00:26:56,410
or I should say D obvious Kishin

631
00:26:56,410 --> 00:26:59,050
functions to undo what they had done in

632
00:26:59,050 --> 00:27:03,520
the in the in the script the top one was

633
00:27:03,520 --> 00:27:05,290
just a modulus function that they

634
00:27:05,290 --> 00:27:06,940
implemented themselves for some reason

635
00:27:06,940 --> 00:27:09,760
probably just to avoid having that VBS

636
00:27:09,760 --> 00:27:13,360
keyword in the file plain text I don't

637
00:27:13,360 --> 00:27:15,490
really know but that's what they did and

638
00:27:15,490 --> 00:27:18,810
they just did some math operations on

639
00:27:18,810 --> 00:27:20,950
strings that they had converted from a

640
00:27:20,950 --> 00:27:23,200
character to the number value of the

641
00:27:23,200 --> 00:27:24,900
character and so they were doing math

642
00:27:24,900 --> 00:27:29,350
operations on them an XOR fun that they

643
00:27:29,350 --> 00:27:32,230
did that they were using well we'll see

644
00:27:32,230 --> 00:27:33,700
what it was used for in a second and

645
00:27:33,700 --> 00:27:36,340
then the main decode function that was

646
00:27:36,340 --> 00:27:38,370
used for the main obvious keishon of

647
00:27:38,370 --> 00:27:42,940
like the body of the code and so then

648
00:27:42,940 --> 00:27:44,530
from there I was able to take that main

649
00:27:44,530 --> 00:27:47,770
D obvious Gatien function and write a

650
00:27:47,770 --> 00:27:52,270
quick decoder and start clearing up the

651
00:27:52,270 --> 00:27:54,670
useful code that actually did something

652
00:27:54,670 --> 00:27:57,310
and it wasn't junk code and as I said I

653
00:27:57,310 --> 00:27:59,260
came up with some fairly common comm

654
00:27:59,260 --> 00:28:02,770
objects so in this case they're creating

655
00:28:02,770 --> 00:28:05,890
an XML HTTP object so typically you're

656
00:28:05,890 --> 00:28:07,660
gonna see either that or you're gonna

657
00:28:07,660 --> 00:28:10,330
see an Internet Explorer object being

658
00:28:10,330 --> 00:28:12,670
created sort of as a headless browser to

659
00:28:12,670 --> 00:28:15,220
go out and pull down some other content

660
00:28:15,220 --> 00:28:18,070
that's a pretty good indication or

661
00:28:18,070 --> 00:28:19,930
potentially to push information up to a

662
00:28:19,930 --> 00:28:22,450
c2 server it's more often has in this

663
00:28:22,450 --> 00:28:25,780
case a downloader and yeah I don't know

664
00:28:25,780 --> 00:28:26,980
if you can see this but in the open

665
00:28:26,980 --> 00:28:28,420
statement they're using a get request

666
00:28:28,420 --> 00:28:31,120
method and then that queue v70 I

667
00:28:31,120 --> 00:28:32,860
probably should have renamed for this

668
00:28:32,860 --> 00:28:35,350
just for this screenshot for everybody

669
00:28:35,350 --> 00:28:37,510
but that was the URL so I was then able

670
00:28:37,510 --> 00:28:40,300
to find they had a function that was

671
00:28:40,300 --> 00:28:43,180
essentially doing a URL chooser it

672
00:28:43,180 --> 00:28:44,830
wasn't exactly like a domain generation

673
00:28:44,830 --> 00:28:46,990
algorithm it was just choosing from a

674
00:28:46,990 --> 00:28:49,690
list of hard-coded URLs to use and there

675
00:28:49,690 --> 00:28:52,630
were some anti forensics measures beyond

676
00:28:52,630 --> 00:28:55,000
that like we times and things like that

677
00:28:55,000 --> 00:28:56,260
so if I just thrown the

678
00:28:56,260 --> 00:28:58,630
into a sandbox and rolled with the first

679
00:28:58,630 --> 00:29:00,460
thing I got or had been running like

680
00:29:00,460 --> 00:29:03,100
fake net and G or something I might have

681
00:29:03,100 --> 00:29:04,780
gotten a domain name that wasn't even

682
00:29:04,780 --> 00:29:07,540
being used actively by the attacker I

683
00:29:07,540 --> 00:29:09,610
may have gotten one that was no longer

684
00:29:09,610 --> 00:29:11,560
being used or whatever the case may be I

685
00:29:11,560 --> 00:29:13,980
would not have gotten all of the URLs

686
00:29:13,980 --> 00:29:19,240
all of those out of the file and then

687
00:29:19,240 --> 00:29:21,400
the XOR function was actually discovered

688
00:29:21,400 --> 00:29:23,890
was not being used and you can see this

689
00:29:23,890 --> 00:29:25,900
at the bottom there is a selection that

690
00:29:25,900 --> 00:29:28,960
can ISM for what byte key to use and

691
00:29:28,960 --> 00:29:32,770
just you know level set here for

692
00:29:32,770 --> 00:29:35,740
everybody you know if you're not

693
00:29:35,740 --> 00:29:37,690
familiar I mean XOR is one of the more

694
00:29:37,690 --> 00:29:40,360
common methods of obvious Gatien simple

695
00:29:40,360 --> 00:29:42,640
obvious Gatien that people use it's

696
00:29:42,640 --> 00:29:43,930
pretty convenient because as I said

697
00:29:43,930 --> 00:29:46,480
whatever you do you have to undo so if I

698
00:29:46,480 --> 00:29:48,790
have converted things to a number and

699
00:29:48,790 --> 00:29:52,780
then I X or if I X or a byte stream

700
00:29:52,780 --> 00:29:56,020
right by some bike key and then I XOR it

701
00:29:56,020 --> 00:30:00,000
again by the same bike key I get back

702
00:30:00,000 --> 00:30:04,180
anybody the same thing I started with

703
00:30:04,180 --> 00:30:05,710
right it's kind of convenient that way

704
00:30:05,710 --> 00:30:09,060
so this was just their method of

705
00:30:09,060 --> 00:30:11,800
decoding the payload that they were

706
00:30:11,800 --> 00:30:14,410
going out and getting so in order to

707
00:30:14,410 --> 00:30:16,840
decode this payloads when I would go out

708
00:30:16,840 --> 00:30:19,180
and curl the second stage or you some

709
00:30:19,180 --> 00:30:21,010
some manner to go out and get the second

710
00:30:21,010 --> 00:30:22,990
stage and if you're gonna do that curl

711
00:30:22,990 --> 00:30:25,720
kind of keying on the red team talk that

712
00:30:25,720 --> 00:30:27,400
just happened you know it know to people

713
00:30:27,400 --> 00:30:28,750
that if you use you know you can use

714
00:30:28,750 --> 00:30:30,730
tools like curl and set up your own

715
00:30:30,730 --> 00:30:32,920
profile so that you're not just using

716
00:30:32,920 --> 00:30:35,320
the default header like that's basic

717
00:30:35,320 --> 00:30:37,870
practice you should be creating a

718
00:30:37,870 --> 00:30:40,030
spoofed spoofed header with a spoofed

719
00:30:40,030 --> 00:30:41,740
user agent and all that stuff so that

720
00:30:41,740 --> 00:30:44,320
you don't look like and a blue team er

721
00:30:44,320 --> 00:30:46,870
going out and getting a sec payload you

722
00:30:46,870 --> 00:30:51,130
look like a dick yeah so then I was able

723
00:30:51,130 --> 00:30:53,020
to decode the second-stage payload so

724
00:30:53,020 --> 00:30:54,490
lessons learned dynamic analysis

725
00:30:54,490 --> 00:30:57,160
wouldn't miss stuff you need those XOR

726
00:30:57,160 --> 00:30:58,810
keys who's able to recover those and

727
00:30:58,810 --> 00:31:02,020
it's just reuse of basic comm objects'

728
00:31:02,020 --> 00:31:04,120
like a handful of common objects is this

729
00:31:04,120 --> 00:31:06,340
you can see the file system object in

730
00:31:06,340 --> 00:31:08,830
the second part and

731
00:31:08,830 --> 00:31:11,740
you know typically some type of W script

732
00:31:11,740 --> 00:31:14,470
shell object because you can use those

733
00:31:14,470 --> 00:31:17,769
to do a headless command line and run

734
00:31:17,769 --> 00:31:20,019
files run files with an argument to it

735
00:31:20,019 --> 00:31:20,950
that sort of thing

736
00:31:20,950 --> 00:31:24,669
edit registry keys so on and so forth so

737
00:31:24,669 --> 00:31:28,269
if you learn in like JavaScript let's

738
00:31:28,269 --> 00:31:33,429
say or VBS you learn the example cut you

739
00:31:33,429 --> 00:31:37,809
look at SS 64 calm or MSDN and you look

740
00:31:37,809 --> 00:31:40,750
at api's and you look at how to use a

741
00:31:40,750 --> 00:31:42,639
basic set of maybe four or five

742
00:31:42,639 --> 00:31:45,669
different comma objects the ones I just

743
00:31:45,669 --> 00:31:49,510
named being most of them you can you can

744
00:31:49,510 --> 00:31:52,529
a do be stream objects with the other

745
00:31:52,529 --> 00:31:55,600
you can you can pretty much understand

746
00:31:55,600 --> 00:31:59,289
and identify the important parts of the

747
00:31:59,289 --> 00:32:02,010
vast majority of like VBS or JavaScript

748
00:32:02,010 --> 00:32:04,210
download or phishing email code that

749
00:32:04,210 --> 00:32:06,549
you're gonna look at so you don't have

750
00:32:06,549 --> 00:32:08,830
to be a hundred percent proficient

751
00:32:08,830 --> 00:32:11,740
expert in VBS you just have to be able

752
00:32:11,740 --> 00:32:13,510
to recognize those important parts and

753
00:32:13,510 --> 00:32:17,440
kind of understand how they work this

754
00:32:17,440 --> 00:32:18,970
was just some stuff that I think I've

755
00:32:18,970 --> 00:32:21,269
already kind of covered about string

756
00:32:21,269 --> 00:32:24,399
string manipulations and character

757
00:32:24,399 --> 00:32:27,100
manipulations with the ASC key you would

758
00:32:27,100 --> 00:32:29,260
see the opposite of it the undoing of it

759
00:32:29,260 --> 00:32:31,360
is going to be done with the reversing

760
00:32:31,360 --> 00:32:32,710
of that it's gonna be done with a CHR

761
00:32:32,710 --> 00:32:34,899
like with a kid that character function

762
00:32:34,899 --> 00:32:37,870
to get it back to a character that's

763
00:32:37,870 --> 00:32:41,380
that's an example this dim foo they're

764
00:32:41,380 --> 00:32:44,200
just storing in that variable the whole

765
00:32:44,200 --> 00:32:46,809
script is a big long string and then

766
00:32:46,809 --> 00:32:49,389
running it through execute and so this

767
00:32:49,389 --> 00:32:51,340
is one of those cases where as I said if

768
00:32:51,340 --> 00:32:54,399
I just substitute execute with message

769
00:32:54,399 --> 00:33:03,399
box I get the DD obvious gated script so

770
00:33:03,399 --> 00:33:09,190
rolling rolling right along PowerShell

771
00:33:09,190 --> 00:33:12,450
scripting try and knock through this

772
00:33:12,450 --> 00:33:14,769
sure everybody here is familiar with our

773
00:33:14,769 --> 00:33:16,240
shell anybody not familiar with

774
00:33:16,240 --> 00:33:16,750
PowerShell

775
00:33:16,750 --> 00:33:21,279
right no ok good so you know basic idea

776
00:33:21,279 --> 00:33:22,150
was more

777
00:33:22,150 --> 00:33:24,460
or Bosch like experience more powerful

778
00:33:24,460 --> 00:33:28,630
for systems administration features like

779
00:33:28,630 --> 00:33:32,800
command command dot exe above blue 2012

780
00:33:32,800 --> 00:33:34,720
was sort of the year of PowerShell

781
00:33:34,720 --> 00:33:37,150
I mean PowerShell came out in 2006 but

782
00:33:37,150 --> 00:33:39,730
the offensive PowerShell use really

783
00:33:39,730 --> 00:33:42,640
kicked off in high gear 2012 with all

784
00:33:42,640 --> 00:33:44,740
these big talks at blackhat and der beek

785
00:33:44,740 --> 00:33:47,650
on DEFCON all the conferences yet Dave

786
00:33:47,650 --> 00:33:49,420
Kennedy and Josh Kelly I think there's

787
00:33:49,420 --> 00:33:50,740
actually another Ian his name I

788
00:33:50,740 --> 00:33:54,160
misspelled it doing their talk that oMFG

789
00:33:54,160 --> 00:33:56,680
talk at blackhat Matt graver you had

790
00:33:56,680 --> 00:33:58,230
tools coming out like power sploit

791
00:33:58,230 --> 00:34:01,720
followed by you know Empire and the

792
00:34:01,720 --> 00:34:05,260
Shang and so on and so forth and a team

793
00:34:05,260 --> 00:34:07,450
really has sort of led the way on this

794
00:34:07,450 --> 00:34:09,668
this philosophy and this live off the

795
00:34:09,668 --> 00:34:12,250
land methodology but the advanced

796
00:34:12,250 --> 00:34:14,889
persistent threat actors and you know

797
00:34:14,889 --> 00:34:17,020
various actual malicious actors have

798
00:34:17,020 --> 00:34:19,418
adopted the same techniques because they

799
00:34:19,418 --> 00:34:21,120
work because there are all of these

800
00:34:21,120 --> 00:34:23,830
legitimate InfoSec professionals doing

801
00:34:23,830 --> 00:34:26,860
all the development work for them and

802
00:34:26,860 --> 00:34:28,330
this this chart on the right was just to

803
00:34:28,330 --> 00:34:30,969
show that again with PowerShell we can

804
00:34:30,969 --> 00:34:32,860
do pretty much all the stuff that we

805
00:34:32,860 --> 00:34:35,820
need to do especially in that middle box

806
00:34:35,820 --> 00:34:38,409
which is this sort of actions on

807
00:34:38,409 --> 00:34:42,250
objectives in this ekc terminology this

808
00:34:42,250 --> 00:34:44,620
is where the offensive PowerShell really

809
00:34:44,620 --> 00:34:46,960
shines right and that lateral movement

810
00:34:46,960 --> 00:34:49,540
privilege escalation so on and so forth

811
00:34:49,540 --> 00:34:52,719
and so I mean how many people here have

812
00:34:52,719 --> 00:34:54,880
not heard that you might live off the

813
00:34:54,880 --> 00:34:57,250
land or fireless intrusions usually in

814
00:34:57,250 --> 00:34:58,930
the sales pitch if some vendor who

815
00:34:58,930 --> 00:35:00,490
claims they can detect it and defend it

816
00:35:00,490 --> 00:35:03,090
and defeat it and make you cappuccino

817
00:35:03,090 --> 00:35:06,790
live off the land oh really how I sort

818
00:35:06,790 --> 00:35:08,800
of interpret it is using white list of

819
00:35:08,800 --> 00:35:10,630
applications tool scripting engines

820
00:35:10,630 --> 00:35:13,210
stuff that your admins use so that it

821
00:35:13,210 --> 00:35:15,370
doesn't look unusual you're making a

822
00:35:15,370 --> 00:35:16,690
smaller footprint you're making a

823
00:35:16,690 --> 00:35:20,320
smaller footprint for EDR Geoff fewer

824
00:35:20,320 --> 00:35:21,850
artifacts in the endpoint you're not

825
00:35:21,850 --> 00:35:24,400
writing as much stuff to file and you

826
00:35:24,400 --> 00:35:26,020
also have fewer artifacts you're

827
00:35:26,020 --> 00:35:27,520
downloading that are gonna be in network

828
00:35:27,520 --> 00:35:31,480
traffic file ish file this intrusion I

829
00:35:31,480 --> 00:35:32,890
think to the extent that it has a

830
00:35:32,890 --> 00:35:35,550
meaning beyond a buzz word or

831
00:35:35,550 --> 00:35:39,540
eles pitch is you know just this idea

832
00:35:39,540 --> 00:35:41,070
that we're writing fewer artifacts to

833
00:35:41,070 --> 00:35:43,560
disk and PowerShell is sort of uniquely

834
00:35:43,560 --> 00:35:45,390
capable of that

835
00:35:45,390 --> 00:35:46,650
because of the remote management

836
00:35:46,650 --> 00:35:48,990
features that has so I can run a

837
00:35:48,990 --> 00:35:52,710
PowerShell script on my system or on a

838
00:35:52,710 --> 00:35:54,000
system that I'm using as a pivot point

839
00:35:54,000 --> 00:35:58,410
and run it on a remote host and it's not

840
00:35:58,410 --> 00:36:00,720
gonna get rid own to write the file to

841
00:36:00,720 --> 00:36:03,510
disk on that system it's gonna be in

842
00:36:03,510 --> 00:36:06,030
memory and maybe if they have a script

843
00:36:06,030 --> 00:36:07,350
block logging enabled they're gonna

844
00:36:07,350 --> 00:36:10,230
catch it in script lock logs and like a

845
00:36:10,230 --> 00:36:13,020
Windows Event 4104 which I'll get to in

846
00:36:13,020 --> 00:36:13,770
a second here

847
00:36:13,770 --> 00:36:15,630
and so these are some of the basic

848
00:36:15,630 --> 00:36:18,840
methods that you commonly see again one

849
00:36:18,840 --> 00:36:20,220
of the advantages is with like the

850
00:36:20,220 --> 00:36:22,590
invoke command you can run this not just

851
00:36:22,590 --> 00:36:24,480
against one target you can run it

852
00:36:24,480 --> 00:36:27,990
against multiple target hosts the term

853
00:36:27,990 --> 00:36:30,180
cradles so I'm sure people here have

854
00:36:30,180 --> 00:36:32,340
heard maybe the term like PowerShell

855
00:36:32,340 --> 00:36:34,650
cradles and wondered exactly what that

856
00:36:34,650 --> 00:36:36,660
means other than jargon and buzzwords

857
00:36:36,660 --> 00:36:39,690
this came out of like raffia lodges talk

858
00:36:39,690 --> 00:36:42,990
and 2015 the flying a Cylon Raider which

859
00:36:42,990 --> 00:36:45,090
you can read the PDF version from sands

860
00:36:45,090 --> 00:36:47,820
of that this is a great example

861
00:36:47,820 --> 00:36:49,980
you're commonly gonna see right is this

862
00:36:49,980 --> 00:36:53,040
invoke expression which that's aliased

863
00:36:53,040 --> 00:36:55,290
and then creating a dotnet web client I

864
00:36:55,290 --> 00:36:58,080
kind of had in my previous slide you've

865
00:36:58,080 --> 00:37:00,300
got access to everything dotnet natively

866
00:37:00,300 --> 00:37:03,180
so and commonly used we're going to use

867
00:37:03,180 --> 00:37:05,310
the download string method instead of a

868
00:37:05,310 --> 00:37:07,470
download file method just because it

869
00:37:07,470 --> 00:37:09,590
allows me to do that running of a remote

870
00:37:09,590 --> 00:37:13,170
grab that remotely hosted powershell

871
00:37:13,170 --> 00:37:15,540
script and run it without writing it to

872
00:37:15,540 --> 00:37:19,980
disk first on the local system and of

873
00:37:19,980 --> 00:37:21,480
course other tools were adopted to take

874
00:37:21,480 --> 00:37:22,260
advantage of that

875
00:37:22,260 --> 00:37:24,300
so the invoke mimic ats version of

876
00:37:24,300 --> 00:37:31,680
running mimic adds one of the cost of

877
00:37:31,680 --> 00:37:34,230
putting putting this in context where

878
00:37:34,230 --> 00:37:36,150
you may see stuff like this getting used

879
00:37:36,150 --> 00:37:38,400
if you're looking at phishing emails

880
00:37:38,400 --> 00:37:39,750
since a lot of people said that they

881
00:37:39,750 --> 00:37:42,030
looked at phishing emails would be and

882
00:37:42,030 --> 00:37:44,820
each a files anybody here run into like

883
00:37:44,820 --> 00:37:47,730
malicious HTA phishing emails I see a

884
00:37:47,730 --> 00:37:48,430
few

885
00:37:48,430 --> 00:37:49,660
heads nodding and some people putting

886
00:37:49,660 --> 00:37:52,630
hands in the air yeah so in 2017 there

887
00:37:52,630 --> 00:37:56,290
was a CVE 2017 199 which really wasn't

888
00:37:56,290 --> 00:37:58,270
it wasn't a bug or anything it was just

889
00:37:58,270 --> 00:38:00,070
Microsoft function how it either could

890
00:38:00,070 --> 00:38:02,080
be abused which is always the best part

891
00:38:02,080 --> 00:38:03,310
and that's why I said in the beginning

892
00:38:03,310 --> 00:38:05,620
of my talk reverse engineering is more

893
00:38:05,620 --> 00:38:07,570
than just finding a bug right sometimes

894
00:38:07,570 --> 00:38:11,560
it's a feature and this allowed HTA

895
00:38:11,560 --> 00:38:14,140
files to just be opened in a Word file

896
00:38:14,140 --> 00:38:18,520
and was billed as like macro less macro

897
00:38:18,520 --> 00:38:20,710
less exploitative Word documents with

898
00:38:20,710 --> 00:38:23,860
EGA this has since been closed down that

899
00:38:23,860 --> 00:38:26,200
that loophole has sort of been closed

900
00:38:26,200 --> 00:38:29,170
down by Microsoft but there's still

901
00:38:29,170 --> 00:38:31,030
other methods to execute HTA's it's

902
00:38:31,030 --> 00:38:33,310
still used by attackers one thing is

903
00:38:33,310 --> 00:38:35,740
it's a defensive defensive asian measure

904
00:38:35,740 --> 00:38:38,050
because you're using a white listed

905
00:38:38,050 --> 00:38:41,710
legitimate application MSHDA dot exe to

906
00:38:41,710 --> 00:38:47,590
launch some other malicious content to

907
00:38:47,590 --> 00:38:48,970
look for this by the way in Windows

908
00:38:48,970 --> 00:38:53,170
event logs 46:56 queries to HTA related

909
00:38:53,170 --> 00:38:55,840
CLS IDs and your forty six eighty eight

910
00:38:55,840 --> 00:38:58,870
process creation from SH ta would be one

911
00:38:58,870 --> 00:39:02,200
way to start this this is an actual

912
00:39:02,200 --> 00:39:06,910
malicious ht8 downloader that courtesy

913
00:39:06,910 --> 00:39:09,640
Nick Carr from daily daily scriptlet guy

914
00:39:09,640 --> 00:39:11,830
if anybody follows him I would recommend

915
00:39:11,830 --> 00:39:14,320
it that he got emailed from somebody

916
00:39:14,320 --> 00:39:17,590
else another malware researcher and it's

917
00:39:17,590 --> 00:39:19,030
just kind of humorous because this is

918
00:39:19,030 --> 00:39:21,580
how not to obvious Khaitan HT a file or

919
00:39:21,580 --> 00:39:23,770
any other malware so you can see some of

920
00:39:23,770 --> 00:39:25,270
the similar stuff you saw in the earlier

921
00:39:25,270 --> 00:39:28,630
VBS script but they've left

922
00:39:28,630 --> 00:39:30,940
they've heavily obviously did it they're

923
00:39:30,940 --> 00:39:32,680
using PowerShell and sort of the middle

924
00:39:32,680 --> 00:39:34,210
part for the downloader there's

925
00:39:34,210 --> 00:39:36,370
PowerShell cradle and then they've

926
00:39:36,370 --> 00:39:38,800
decided to for some reason not obvious

927
00:39:38,800 --> 00:39:42,370
Kate the IOC s like the stuff that we

928
00:39:42,370 --> 00:39:45,010
would really be looking for right and

929
00:39:45,010 --> 00:39:47,530
you would still want to go ahead and you

930
00:39:47,530 --> 00:39:49,600
obviously this just to make sure that

931
00:39:49,600 --> 00:39:51,220
this isn't messing with you and some

932
00:39:51,220 --> 00:39:53,980
sort of anti forensics but this gives

933
00:39:53,980 --> 00:39:55,030
you a good look at what the

934
00:39:55,030 --> 00:39:57,400
functionality would be so I've got my

935
00:39:57,400 --> 00:40:00,220
HTML and then enclosed within my HTML

936
00:40:00,220 --> 00:40:01,910
I've got a VB script

937
00:40:01,910 --> 00:40:04,700
and the vbscript is really being used to

938
00:40:04,700 --> 00:40:06,680
do the filing handling of writing and

939
00:40:06,680 --> 00:40:08,839
running the file which they're

940
00:40:08,839 --> 00:40:10,010
temporarily storing into an

941
00:40:10,010 --> 00:40:11,510
environmental variable and then pulling

942
00:40:11,510 --> 00:40:13,579
it back out again and the actual

943
00:40:13,579 --> 00:40:16,910
downloading is being done with with the

944
00:40:16,910 --> 00:40:19,670
download file method of that dotnet web

945
00:40:19,670 --> 00:40:23,359
client object why they chose to do this

946
00:40:23,359 --> 00:40:25,670
instead of doing a one-liner with the

947
00:40:25,670 --> 00:40:27,890
download string I'm not 100% certain but

948
00:40:27,890 --> 00:40:31,069
that's what they did so again it's not

949
00:40:31,069 --> 00:40:32,869
too different from what you saw in the

950
00:40:32,869 --> 00:40:34,970
earlier VBS file but they're using

951
00:40:34,970 --> 00:40:39,220
PowerShell for that download or cradle

952
00:40:39,309 --> 00:40:41,690
we could sit here and talk for an hour

953
00:40:41,690 --> 00:40:44,660
just about or more her weeks well I

954
00:40:44,660 --> 00:40:46,369
couldn't because I don't know a week

955
00:40:46,369 --> 00:40:47,599
worth of material but there are people

956
00:40:47,599 --> 00:40:49,640
who do like Daniel Bohannon

957
00:40:49,640 --> 00:40:52,369
hunt powershell obvious gation it's a

958
00:40:52,369 --> 00:40:55,220
lot of the same games you know there's

959
00:40:55,220 --> 00:40:57,079
aliased expressions or aliased

960
00:40:57,079 --> 00:41:00,740
commandlets base64 encoding as you can

961
00:41:00,740 --> 00:41:04,210
see on the right using tick marks

962
00:41:04,210 --> 00:41:05,450
concatenations

963
00:41:05,450 --> 00:41:11,270
your dash F format feature is a really

964
00:41:11,270 --> 00:41:13,220
common string manipulation you see with

965
00:41:13,220 --> 00:41:17,089
the powershell and at the end of the day

966
00:41:17,089 --> 00:41:19,069
there's - there's too many to cover over

967
00:41:19,069 --> 00:41:21,230
here the end of the day the big point I

968
00:41:21,230 --> 00:41:22,789
would make is just that it led to this

969
00:41:22,789 --> 00:41:25,700
PowerShell arms race and you had the top

970
00:41:25,700 --> 00:41:28,039
some really top researchers like Daniel

971
00:41:28,039 --> 00:41:30,349
Bohannon from a Myint and the ALMS with

972
00:41:30,349 --> 00:41:32,000
Microsoft and Microsoft Azure who was

973
00:41:32,000 --> 00:41:33,289
one of the people who who originally

974
00:41:33,289 --> 00:41:36,220
wrote PowerShell script in PowerShell

975
00:41:36,220 --> 00:41:38,510
getting into this this cat and mouse

976
00:41:38,510 --> 00:41:40,880
game with who could create even more

977
00:41:40,880 --> 00:41:42,940
complicated obvious caissons and

978
00:41:42,940 --> 00:41:45,410
Microsoft introducing security features

979
00:41:45,410 --> 00:41:47,270
with each version of PowerShell so

980
00:41:47,270 --> 00:41:50,539
that's really behooves you to use five

981
00:41:50,539 --> 00:41:53,180
five one or if you're getting into using

982
00:41:53,180 --> 00:41:54,859
Linux systems as well

983
00:41:54,859 --> 00:41:57,349
version six engine because it built in

984
00:41:57,349 --> 00:41:59,690
just enough administration script lock

985
00:41:59,690 --> 00:42:02,630
logging and so forth and on the left you

986
00:42:02,630 --> 00:42:05,390
can see that script lock being caught

987
00:42:05,390 --> 00:42:09,250
with a 401 for when it is event log

988
00:42:09,250 --> 00:42:12,829
which you would not catch if people were

989
00:42:12,829 --> 00:42:14,390
running their PowerShell your

990
00:42:14,390 --> 00:42:15,240
administrators or

991
00:42:15,240 --> 00:42:18,540
using like v2 of PowerShell or the

992
00:42:18,540 --> 00:42:20,670
attacker has successfully downgraded to

993
00:42:20,670 --> 00:42:22,890
v2 and so that becomes another thing to

994
00:42:22,890 --> 00:42:24,060
look for as you're looking for the

995
00:42:24,060 --> 00:42:26,280
downgrade instead of instead of the

996
00:42:26,280 --> 00:42:28,950
malicious activity itself at least as a

997
00:42:28,950 --> 00:42:31,200
starting point and then of course you

998
00:42:31,200 --> 00:42:33,930
have the end of the PowerShell arms race

999
00:42:33,930 --> 00:42:36,960
cold war with damn Bohannon and Lee

1000
00:42:36,960 --> 00:42:39,510
homes coming together in 2017 and doing

1001
00:42:39,510 --> 00:42:41,190
like the revoke obvious Gatien and

1002
00:42:41,190 --> 00:42:42,960
revoke obvious ocation talks and that's

1003
00:42:42,960 --> 00:42:45,090
a really useful tool that I would

1004
00:42:45,090 --> 00:42:47,490
recommend and basically their point that

1005
00:42:47,490 --> 00:42:51,600
they arrived at was that it's so hard to

1006
00:42:51,600 --> 00:42:53,640
manually do view skate some of the stuff

1007
00:42:53,640 --> 00:42:55,980
you can create in terms of PowerShell

1008
00:42:55,980 --> 00:42:58,110
obvious keishon that you almost need to

1009
00:42:58,110 --> 00:43:01,710
adopt more of the logs and statistical

1010
00:43:01,710 --> 00:43:03,780
analysis based approach and that's a

1011
00:43:03,780 --> 00:43:06,030
part of what their tool does is it

1012
00:43:06,030 --> 00:43:07,800
facilitates that and reassembling

1013
00:43:07,800 --> 00:43:12,660
scripts that span multiple logs other

1014
00:43:12,660 --> 00:43:16,230
malware really quick since we are are

1015
00:43:16,230 --> 00:43:18,390
ticking down the clock I thought I

1016
00:43:18,390 --> 00:43:21,240
mentioned this one Mac OS malware so

1017
00:43:21,240 --> 00:43:23,670
this just shows you the scope of what

1018
00:43:23,670 --> 00:43:25,140
you can do just looking at script

1019
00:43:25,140 --> 00:43:28,560
malware so last year 2017 one of the big

1020
00:43:28,560 --> 00:43:32,160
big news items in Mac OS malware if

1021
00:43:32,160 --> 00:43:34,109
people follow that stuff Patrick Wordle

1022
00:43:34,109 --> 00:43:35,820
I would also recommend like Chris Chris

1023
00:43:35,820 --> 00:43:37,320
Ross from Spectre ops is a good guy on

1024
00:43:37,320 --> 00:43:42,240
that stuff was this fruit fly malware as

1025
00:43:42,240 --> 00:43:44,130
they called it and you had all these

1026
00:43:44,130 --> 00:43:46,440
InfoSec blogs and researchers who rushed

1027
00:43:46,440 --> 00:43:48,270
out this is clearly some

1028
00:43:48,270 --> 00:43:51,440
never-before-seen really stealthy apt

1029
00:43:51,440 --> 00:43:55,500
actor who was targeting very

1030
00:43:55,500 --> 00:43:58,890
specifically the biotech sector and in

1031
00:43:58,890 --> 00:44:02,640
these complicated theories based on what

1032
00:44:02,640 --> 00:44:04,920
was found on this professors laptop and

1033
00:44:04,920 --> 00:44:07,530
this university and so on and so forth

1034
00:44:07,530 --> 00:44:08,940
and of course as it turns out it was

1035
00:44:08,940 --> 00:44:10,560
really just this disgruntled software

1036
00:44:10,560 --> 00:44:14,340
engineer from Cleveland and named filthy

1037
00:44:14,340 --> 00:44:17,460
Phil juror chin ski and he has not been

1038
00:44:17,460 --> 00:44:19,020
convicted but he has been charged with

1039
00:44:19,020 --> 00:44:21,240
16 counts of everything you can do

1040
00:44:21,240 --> 00:44:23,609
naughty with a computer and he was

1041
00:44:23,609 --> 00:44:25,890
probably a Browns fan so is this really

1042
00:44:25,890 --> 00:44:27,480
surprising

1043
00:44:27,480 --> 00:44:33,119
ah you know so the point is is that he

1044
00:44:33,119 --> 00:44:35,250
infected systems like at police

1045
00:44:35,250 --> 00:44:37,440
departments and on US government systems

1046
00:44:37,440 --> 00:44:39,810
and had persistence for years on some of

1047
00:44:39,810 --> 00:44:41,540
the systems as far as anybody could tell

1048
00:44:41,540 --> 00:44:44,340
why he was using one of the most

1049
00:44:44,340 --> 00:44:47,340
low-hanging fruit no pun intended

1050
00:44:47,340 --> 00:44:49,140
persistence mechanisms you can use on

1051
00:44:49,140 --> 00:44:51,930
Mac OS which is just a P less item in

1052
00:44:51,930 --> 00:44:56,130
the uhland long n launch D um but nobody

1053
00:44:56,130 --> 00:44:57,900
was looking for him and nobody really

1054
00:44:57,900 --> 00:44:59,910
knew how to look for him and nobody was

1055
00:44:59,910 --> 00:45:02,130
analyzing his Mauer and it was just Perl

1056
00:45:02,130 --> 00:45:04,950
script so he was able to create a

1057
00:45:04,950 --> 00:45:07,950
completely workable rat entirely in Perl

1058
00:45:07,950 --> 00:45:11,040
script so there you go and in really old

1059
00:45:11,040 --> 00:45:13,080
libraries of Perl script that was that

1060
00:45:13,080 --> 00:45:14,430
was what people's interest they thought

1061
00:45:14,430 --> 00:45:16,830
it was some sort of anti forensic

1062
00:45:16,830 --> 00:45:18,540
stealth measure or something that he was

1063
00:45:18,540 --> 00:45:21,990
using out of date code malicious

1064
00:45:21,990 --> 00:45:24,480
JavaScript that again that's a whole

1065
00:45:24,480 --> 00:45:28,020
week worth of material I would refer you

1066
00:45:28,020 --> 00:45:29,550
to a wasp I think there was like kind of

1067
00:45:29,550 --> 00:45:31,859
a new hospital this morning but you know

1068
00:45:31,859 --> 00:45:33,869
JavaScript was intended to be able to do

1069
00:45:33,869 --> 00:45:35,760
client-side dynamic content for web

1070
00:45:35,760 --> 00:45:38,160
content and so you can just as easily

1071
00:45:38,160 --> 00:45:42,230
dynamically create bad stuff right and

1072
00:45:42,230 --> 00:45:45,869
tiny web shells same thing last ditch

1073
00:45:45,869 --> 00:45:48,780
effort backdoor doing government work

1074
00:45:48,780 --> 00:45:52,010
I've seen this a lot with apt actors

1075
00:45:52,010 --> 00:45:54,540
targeting government organizations that

1076
00:45:54,540 --> 00:45:57,660
is their backdoor of last resort after

1077
00:45:57,660 --> 00:45:59,400
they've been kicked off a network is

1078
00:45:59,400 --> 00:46:01,200
leaving behind you know it could be as

1079
00:46:01,200 --> 00:46:03,000
small with like China chopper is a 4k

1080
00:46:03,000 --> 00:46:07,770
file with just a simple PHP PHP code in

1081
00:46:07,770 --> 00:46:10,260
it to receive commands and run commands

1082
00:46:10,260 --> 00:46:12,300
on the web server and it's just a

1083
00:46:12,300 --> 00:46:14,580
toehold it's just you know propping open

1084
00:46:14,580 --> 00:46:16,410
the back door while you ransack the

1085
00:46:16,410 --> 00:46:20,180
house just in case right

1086
00:46:20,540 --> 00:46:24,320
so my final caveat I'll leave you with

1087
00:46:24,320 --> 00:46:27,180
so I would say that it is the 20% that

1088
00:46:27,180 --> 00:46:29,190
gets you the 80% looking at Script

1089
00:46:29,190 --> 00:46:30,480
malware and I would encourage everybody

1090
00:46:30,480 --> 00:46:32,730
to start there but if you're going to be

1091
00:46:32,730 --> 00:46:34,230
a full time our analyst if you want to

1092
00:46:34,230 --> 00:46:36,470
go work in a shop where all you do is

1093
00:46:36,470 --> 00:46:39,510
sit and go through a queue of malware

1094
00:46:39,510 --> 00:46:40,200
sample after

1095
00:46:40,200 --> 00:46:42,450
our sample you probably do want to get

1096
00:46:42,450 --> 00:46:46,320
your gram if you can you want to learn

1097
00:46:46,320 --> 00:46:49,349
see learn C++ and assembly maybe even

1098
00:46:49,349 --> 00:46:52,650
our arm as opposed to just x86 64 you're

1099
00:46:52,650 --> 00:46:54,180
gonna start looking at like Android

1100
00:46:54,180 --> 00:46:57,300
malware or something and start to

1101
00:46:57,300 --> 00:46:59,220
recognize control flow so write your own

1102
00:46:59,220 --> 00:47:01,560
hello world file compile it in different

1103
00:47:01,560 --> 00:47:03,900
compilers and then look at the

1104
00:47:03,900 --> 00:47:05,430
difference in the assembly when you open

1105
00:47:05,430 --> 00:47:08,849
it up in ida pro or a ladybug and you'll

1106
00:47:08,849 --> 00:47:10,230
see the differences that are just

1107
00:47:10,230 --> 00:47:12,839
artifacts and pilers right what is the

1108
00:47:12,839 --> 00:47:15,720
calling convention who call you know who

1109
00:47:15,720 --> 00:47:17,820
cleans up the stack is it the calling

1110
00:47:17,820 --> 00:47:20,220
function or is it the colleague that's

1111
00:47:20,220 --> 00:47:21,630
gonna vary from compiler to compiler

1112
00:47:21,630 --> 00:47:25,400
that's ocean Lotus rat it's a Mac OS

1113
00:47:25,400 --> 00:47:31,010
mock Oh binary in Ida just a random

1114
00:47:31,010 --> 00:47:33,359
gratuitous this is some water shot you

1115
00:47:33,359 --> 00:47:34,349
have to have one of those in the malware

1116
00:47:34,349 --> 00:47:37,380
talker it's not a malware talk learn

1117
00:47:37,380 --> 00:47:40,200
file formats like I said you learn to

1118
00:47:40,200 --> 00:47:42,240
use disassemblers and debuggers but

1119
00:47:42,240 --> 00:47:44,940
start with scripts and for most of us

1120
00:47:44,940 --> 00:47:46,740
who your job title is not an hour

1121
00:47:46,740 --> 00:47:48,930
analyst but you're you are a maori

1122
00:47:48,930 --> 00:47:50,280
analysts you're being asked to do it

1123
00:47:50,280 --> 00:47:52,020
you're being asked to look at malicious

1124
00:47:52,020 --> 00:47:54,690
phishing emails take take a look at a

1125
00:47:54,690 --> 00:47:56,460
time and if you you know if you're able

1126
00:47:56,460 --> 00:47:59,369
to remove the time and and just start

1127
00:47:59,369 --> 00:48:01,410
scripting start writing scripts and

1128
00:48:01,410 --> 00:48:03,270
looking at your own scripts start with

1129
00:48:03,270 --> 00:48:06,420
those basic calm calm functions or comma

1130
00:48:06,420 --> 00:48:08,130
objects so they talked about like the

1131
00:48:08,130 --> 00:48:11,520
ones that create web objects XML HTTP

1132
00:48:11,520 --> 00:48:13,680
and how to do that or the Internet

1133
00:48:13,680 --> 00:48:17,040
Explorer object and so again it's not

1134
00:48:17,040 --> 00:48:19,260
magic it's just code all you really need

1135
00:48:19,260 --> 00:48:21,630
is a VM in a text editor and some

1136
00:48:21,630 --> 00:48:24,270
persistence and you are smarter than a

1137
00:48:24,270 --> 00:48:28,440
sandbox so you can do it and I wish it

1138
00:48:28,440 --> 00:48:30,780
was as easy I love Dilbert but I wish it

1139
00:48:30,780 --> 00:48:32,940
was as easy as you know just getting a

1140
00:48:32,940 --> 00:48:34,290
software engineer to write an app for

1141
00:48:34,290 --> 00:48:35,640
that but there's no magic bullet

1142
00:48:35,640 --> 00:48:37,740
it's just persistence of doing it that's

1143
00:48:37,740 --> 00:48:40,339
that's how you become the Mauer analyst

1144
00:48:40,339 --> 00:48:42,630
special thanks yeah like I said just a

1145
00:48:42,630 --> 00:48:44,460
shout out to Adam swan and you can

1146
00:48:44,460 --> 00:48:46,140
follow those guys and Nate with Jennie

1147
00:48:46,140 --> 00:48:49,349
follow them on Twitter they're big elk

1148
00:48:49,349 --> 00:48:50,910
stack blue team er

1149
00:48:50,910 --> 00:48:54,520
guys and analysts who do cool stuff

1150
00:48:54,520 --> 00:48:55,870
well and help contribute to this talk

1151
00:48:55,870 --> 00:48:57,820
and these are some of the blogs that I

1152
00:48:57,820 --> 00:49:00,580
follow or Twitter feeds and I follow of

1153
00:49:00,580 --> 00:49:02,710
people who are relevant to what I just

1154
00:49:02,710 --> 00:49:04,600
talked about and who do a lot of good

1155
00:49:04,600 --> 00:49:06,010
work on what I just talked about and

1156
00:49:06,010 --> 00:49:08,350
I'll put the slides up at some point

1157
00:49:08,350 --> 00:49:11,800
like as a PDF on my github page which we

1158
00:49:11,800 --> 00:49:13,470
kind of saw it beginning and I just

1159
00:49:13,470 --> 00:49:16,660
weird out with a three and if you need

1160
00:49:16,660 --> 00:49:18,010
to find me the easiest way to google for

1161
00:49:18,010 --> 00:49:19,990
it is applesauce in the bucket

1162
00:49:19,990 --> 00:49:24,100
that's my Apple security repository and

1163
00:49:24,100 --> 00:49:25,420
it seems to be the one that pops up in

1164
00:49:25,420 --> 00:49:30,330
Google any questions we have just a

1165
00:49:30,330 --> 00:49:37,020
minute or something left questions yes

1166
00:49:37,020 --> 00:49:40,110
[Music]

1167
00:49:57,600 --> 00:50:01,660
yeah so yeah so so to speak to that

1168
00:50:01,660 --> 00:50:03,340
point really quickly two things okay

1169
00:50:03,340 --> 00:50:06,250
number one yeah there are sites you can

1170
00:50:06,250 --> 00:50:09,550
go out to websites that will obvious

1171
00:50:09,550 --> 00:50:11,860
skate or div escape stuff for you

1172
00:50:11,860 --> 00:50:13,960
automatically they don't always work and

1173
00:50:13,960 --> 00:50:15,640
more importantly if you're doing this

1174
00:50:15,640 --> 00:50:18,130
for reals for stuff from your company

1175
00:50:18,130 --> 00:50:20,260
and this is stuff you've gotten it's

1176
00:50:20,260 --> 00:50:22,780
just a matter of basic OPSEC that you

1177
00:50:22,780 --> 00:50:24,160
don't want to go out and just don't

1178
00:50:24,160 --> 00:50:27,670
paste that into an online tool and you

1179
00:50:27,670 --> 00:50:28,990
don't know whoever's running that site

1180
00:50:28,990 --> 00:50:30,670
or why they're running it and what

1181
00:50:30,670 --> 00:50:32,560
they're doing it's kind of like just

1182
00:50:32,560 --> 00:50:34,060
saying well I can just take the samples

1183
00:50:34,060 --> 00:50:35,650
and upload them all to virustotal

1184
00:50:35,650 --> 00:50:40,090
right it's an object thing it depends on

1185
00:50:40,090 --> 00:50:42,280
why you're doing the analysis and and so

1186
00:50:42,280 --> 00:50:43,150
on and so forth

1187
00:50:43,150 --> 00:50:44,860
and in terms of getting your hands dirty

1188
00:50:44,860 --> 00:50:46,360
I mean so the people who did the

1189
00:50:46,360 --> 00:50:48,670
training yesterday we did a whole

1190
00:50:48,670 --> 00:50:51,640
training I had them start out by writing

1191
00:50:51,640 --> 00:50:54,760
scripts rather than trying to div escape

1192
00:50:54,760 --> 00:50:56,680
real samples and that would be my

1193
00:50:56,680 --> 00:50:58,240
recommendation right so if you're not

1194
00:50:58,240 --> 00:50:59,650
you just said if you're not a coder

1195
00:50:59,650 --> 00:51:00,570
okay

1196
00:51:00,570 --> 00:51:04,230
I would start out by not trying to div

1197
00:51:04,230 --> 00:51:06,720
escape obvious gated samples that some

1198
00:51:06,720 --> 00:51:08,610
malware author is written I would start

1199
00:51:08,610 --> 00:51:11,790
out by writing my own really simple

1200
00:51:11,790 --> 00:51:13,860
downloader with two VMs and having an

1201
00:51:13,860 --> 00:51:16,320
Apache server with a text file on it and

1202
00:51:16,320 --> 00:51:19,500
writing my own VBS or JavaScript

1203
00:51:19,500 --> 00:51:21,930
downloader that downloads a file and

1204
00:51:21,930 --> 00:51:23,550
understanding that functionality and

1205
00:51:23,550 --> 00:51:25,320
then when you start to look at obvious

1206
00:51:25,320 --> 00:51:28,260
gated stuff you'll recognize even though

1207
00:51:28,260 --> 00:51:31,020
it's quote/unquote obvious gated you're

1208
00:51:31,020 --> 00:51:32,850
gonna recognize the basic structure of

1209
00:51:32,850 --> 00:51:35,700
what's going on does that help answer

1210
00:51:35,700 --> 00:51:43,530
your question yeah sure so that would be

1211
00:51:43,530 --> 00:51:44,670
the right way to do it if you're using

1212
00:51:44,670 --> 00:51:46,530
an automated tool would be to make sure

1213
00:51:46,530 --> 00:51:50,610
you had a local copy yep like I said

1214
00:51:50,610 --> 00:51:53,720
that may not always work though right

1215
00:51:53,720 --> 00:51:59,250
any other questions okay thank you

1216
00:51:59,250 --> 00:52:06,079
[Applause]

