1
00:00:00,319 --> 00:00:02,460
all right everybody we're gonna get

2
00:00:02,460 --> 00:00:04,859
started thanks again for coming to Pisa

3
00:00:04,859 --> 00:00:07,670
its Pittsburgh hope you had a good lunch

4
00:00:07,670 --> 00:00:10,139
so this afternoon we're gonna have a

5
00:00:10,139 --> 00:00:12,120
talk from Dan aster and Evan Parodi

6
00:00:12,120 --> 00:00:13,980
they're gonna be talking about heavy

7
00:00:13,980 --> 00:00:15,900
machinery and burly Lumberjacks and

8
00:00:15,900 --> 00:00:17,550
logging oh my so let's give them a round

9
00:00:17,550 --> 00:00:29,340
applause cool everyone here merit all

10
00:00:29,340 --> 00:00:30,410
right awesome

11
00:00:30,410 --> 00:00:33,600
so welcome to our talk heavy machinery

12
00:00:33,600 --> 00:00:38,460
burly Lumberjacks and logging oh my so

13
00:00:38,460 --> 00:00:42,510
I'm Dan Astor I'm a senior consultant at

14
00:00:42,510 --> 00:00:45,120
security risk advisors I've been doing

15
00:00:45,120 --> 00:00:47,010
sort of offensive pen testing red

16
00:00:47,010 --> 00:00:50,879
teaming for about five years I'm Evan I

17
00:00:50,879 --> 00:00:53,010
work a lot on side Dan and I've been

18
00:00:53,010 --> 00:00:56,089
doing this for about two years

19
00:00:57,920 --> 00:01:00,510
alright so real quick overview of what

20
00:01:00,510 --> 00:01:02,370
we're gonna cover today the first thing

21
00:01:02,370 --> 00:01:04,080
is just gonna be going over sort of what

22
00:01:04,080 --> 00:01:05,670
red teaming is how it differs from pen

23
00:01:05,670 --> 00:01:08,880
testing a little bit why we wanted to do

24
00:01:08,880 --> 00:01:11,310
a written sim we're gonna talk a little

25
00:01:11,310 --> 00:01:13,650
bit about the simp eye plane we're then

26
00:01:13,650 --> 00:01:15,780
gonna talk about logging and alerting

27
00:01:15,780 --> 00:01:18,119
within that sim and then I will cover

28
00:01:18,119 --> 00:01:20,549
off on sort of our setup and then some

29
00:01:20,549 --> 00:01:25,770
automation that we did with it okay so

30
00:01:25,770 --> 00:01:27,090
real quick I just kind of want to level

31
00:01:27,090 --> 00:01:29,250
set it with sort of what red teaming is

32
00:01:29,250 --> 00:01:31,200
if you're not familiar and sort of how

33
00:01:31,200 --> 00:01:33,600
it differs from standard pen testing and

34
00:01:33,600 --> 00:01:34,650
then we'll talk about the red team

35
00:01:34,650 --> 00:01:38,340
infrastructure itself so with t mean the

36
00:01:38,340 --> 00:01:40,619
goal of the engagement is instead of a

37
00:01:40,619 --> 00:01:42,000
pen test where it's just sort of to go

38
00:01:42,000 --> 00:01:44,909
in find different vulnerabilities prove

39
00:01:44,909 --> 00:01:46,710
impacting access to systems and things

40
00:01:46,710 --> 00:01:48,689
like that it's usually time box to about

41
00:01:48,689 --> 00:01:51,270
a week maybe two with a red team these

42
00:01:51,270 --> 00:01:53,000
are how much these are much longer

43
00:01:53,000 --> 00:01:55,619
engagements they tend to last you know

44
00:01:55,619 --> 00:01:58,290
several weeks to months even and with

45
00:01:58,290 --> 00:02:00,689
that that the infrastructure changes to

46
00:02:00,689 --> 00:02:02,070
with the standard pen test you might

47
00:02:02,070 --> 00:02:05,189
only have maybe one c2 server for your

48
00:02:05,189 --> 00:02:07,530
command control you might be only doing

49
00:02:07,530 --> 00:02:09,840
you know fishing for a limited time you

50
00:02:09,840 --> 00:02:11,970
might not have a full infrastructure so

51
00:02:11,970 --> 00:02:13,860
that just because you don't need it it's

52
00:02:13,860 --> 00:02:16,110
short engagement you know you're not

53
00:02:16,110 --> 00:02:17,490
necessarily worried about being detected

54
00:02:17,490 --> 00:02:19,740
all the time with a red team that's very

55
00:02:19,740 --> 00:02:21,420
different you're gonna have a lot of

56
00:02:21,420 --> 00:02:23,220
different infrastructure involved you're

57
00:02:23,220 --> 00:02:25,020
gonna have potentially multiple see to

58
00:02:25,020 --> 00:02:27,540
channel multiple c2 servers

59
00:02:27,540 --> 00:02:29,670
you're gonna have read erectors in front

60
00:02:29,670 --> 00:02:33,920
of those potentially payload servers

61
00:02:33,920 --> 00:02:36,840
this is just a quick example of what a

62
00:02:36,840 --> 00:02:39,120
team infrastructure may potentially look

63
00:02:39,120 --> 00:02:41,970
like so you have we have a primary and a

64
00:02:41,970 --> 00:02:44,820
secondary c2 these are behind but we're

65
00:02:44,820 --> 00:02:46,230
calling redirect errs and these

66
00:02:46,230 --> 00:02:48,660
basically will mask sort of the true

67
00:02:48,660 --> 00:02:50,820
destination of your c2 server so your c2

68
00:02:50,820 --> 00:02:53,070
servers won't get burned if the domain

69
00:02:53,070 --> 00:02:55,650
gets blocked or if they find sort of the

70
00:02:55,650 --> 00:02:57,570
origin of where your redirector is this

71
00:02:57,570 --> 00:03:00,660
just pushes the traffic back to your

72
00:03:00,660 --> 00:03:03,900
your c2 server the the nice thing with

73
00:03:03,900 --> 00:03:05,400
the redirect errs is they do give you

74
00:03:05,400 --> 00:03:07,680
the opportunity to sort of do some

75
00:03:07,680 --> 00:03:09,989
checks on hey you know where's this

76
00:03:09,989 --> 00:03:12,030
stuff coming from can I can I

77
00:03:12,030 --> 00:03:14,070
if this isn't my c2 traffic I want to

78
00:03:14,070 --> 00:03:15,510
send them to a different site so stuff

79
00:03:15,510 --> 00:03:17,760
like that for a red team you might also

80
00:03:17,760 --> 00:03:19,440
have a separate payload server because

81
00:03:19,440 --> 00:03:20,430
you don't want to be hosting your

82
00:03:20,430 --> 00:03:24,780
payloads which eventually beginning you

83
00:03:24,780 --> 00:03:27,030
know analyze things like that you don't

84
00:03:27,030 --> 00:03:28,290
want that to be hosted on your c2

85
00:03:28,290 --> 00:03:29,760
infrastructure because if the payload

86
00:03:29,760 --> 00:03:31,380
server gets burned you don't want your

87
00:03:31,380 --> 00:03:32,580
c2 servers to get burned

88
00:03:32,580 --> 00:03:34,860
and likewise with having phishing

89
00:03:34,860 --> 00:03:36,870
servers you know just another thing to

90
00:03:36,870 --> 00:03:38,730
add into the equation and you might even

91
00:03:38,730 --> 00:03:40,760
have you know some VPNs things like that

92
00:03:40,760 --> 00:03:42,959
so that's sort of the the infrastructure

93
00:03:42,959 --> 00:03:44,570
that we'll be talking about for this

94
00:03:44,570 --> 00:03:50,370
moving forward moving off of that with a

95
00:03:50,370 --> 00:03:51,840
red team engagement there are

96
00:03:51,840 --> 00:03:55,019
opportunity for the blue team to really

97
00:03:55,019 --> 00:03:57,709
kind of react and do things with this

98
00:03:57,709 --> 00:04:00,630
when we talk about the blue team from

99
00:04:00,630 --> 00:04:02,220
the red team perspective these are gonna

100
00:04:02,220 --> 00:04:04,140
be people that are either sort of active

101
00:04:04,140 --> 00:04:06,239
defenders like the security team in an

102
00:04:06,239 --> 00:04:07,980
organization they might be entering in

103
00:04:07,980 --> 00:04:09,780
like fake credentials to see hey you

104
00:04:09,780 --> 00:04:11,760
know we got this phishing campaign that

105
00:04:11,760 --> 00:04:13,440
hit us we're gonna enter in some

106
00:04:13,440 --> 00:04:14,880
credentials and see hey what are they

107
00:04:14,880 --> 00:04:16,918
doing where are they coming from what

108
00:04:16,918 --> 00:04:19,709
behavior are they doing maybe running

109
00:04:19,709 --> 00:04:21,959
things in sandboxes so things like that

110
00:04:21,959 --> 00:04:23,760
they might also actively be interacting

111
00:04:23,760 --> 00:04:25,650
with your infrastructure so they might

112
00:04:25,650 --> 00:04:27,270
be going out trying to profile you

113
00:04:27,270 --> 00:04:27,750
figure

114
00:04:27,750 --> 00:04:30,720
out where things are hosted trying you

115
00:04:30,720 --> 00:04:32,580
know attribute it to a potential threat

116
00:04:32,580 --> 00:04:35,220
after things like that and then the

117
00:04:35,220 --> 00:04:37,140
flipside you have sort of some instant

118
00:04:37,140 --> 00:04:38,850
responders or socket list these are

119
00:04:38,850 --> 00:04:41,370
people that are gonna have to deal with

120
00:04:41,370 --> 00:04:43,680
different alerts so let's say an Evo or

121
00:04:43,680 --> 00:04:45,210
gets tripped or someone reports a

122
00:04:45,210 --> 00:04:47,130
phishing email these are going to be the

123
00:04:47,130 --> 00:04:48,750
people that go through and so we're

124
00:04:48,750 --> 00:04:49,710
going to figure out hey is there

125
00:04:49,710 --> 00:04:51,750
something I need to deal with do I just

126
00:04:51,750 --> 00:04:53,310
need to reset credentials so they're

127
00:04:53,310 --> 00:04:54,840
gonna be the people doing that sort of

128
00:04:54,840 --> 00:04:57,930
doing the initial tier 1 triage let's

129
00:04:57,930 --> 00:04:59,550
say so these people are going to be

130
00:04:59,550 --> 00:05:01,020
dealing with sort of hundreds of cases

131
00:05:01,020 --> 00:05:02,940
throughout the week so quite a bit

132
00:05:02,940 --> 00:05:04,800
different sort of skill set in terms of

133
00:05:04,800 --> 00:05:09,600
what they're going to be doing so moving

134
00:05:09,600 --> 00:05:12,930
into sort of the the red team sim and

135
00:05:12,930 --> 00:05:16,770
why we wanted to do this the first thing

136
00:05:16,770 --> 00:05:18,870
was you have all of this infrastructure

137
00:05:18,870 --> 00:05:20,760
you have you know multiple servers that

138
00:05:20,760 --> 00:05:22,080
are out there you might even you know

139
00:05:22,080 --> 00:05:23,940
six to ten servers that are sort of in

140
00:05:23,940 --> 00:05:25,560
your infrastructure how do you manage

141
00:05:25,560 --> 00:05:27,540
that and particularly how do you manage

142
00:05:27,540 --> 00:05:29,880
all of the the services that are running

143
00:05:29,880 --> 00:05:31,650
on that how do you get the logs for that

144
00:05:31,650 --> 00:05:35,610
so in the past it's typically been doing

145
00:05:35,610 --> 00:05:38,250
SSH into the servers you know grepping

146
00:05:38,250 --> 00:05:39,810
through blog files to see if an event

147
00:05:39,810 --> 00:05:42,570
hit if someone hit the server from Skype

148
00:05:42,570 --> 00:05:46,260
ease taylean log files to see hey or

149
00:05:46,260 --> 00:05:48,419
phishing credentials being entered the

150
00:05:48,419 --> 00:05:50,610
flipside you also have to have sort of a

151
00:05:50,610 --> 00:05:51,840
Red Team operator

152
00:05:51,840 --> 00:05:53,580
you know that's losing potential

153
00:05:53,580 --> 00:05:55,169
resources because they have to monitor

154
00:05:55,169 --> 00:05:56,970
all that stuff for you so they're

155
00:05:56,970 --> 00:05:59,700
potentially losing out on having to just

156
00:05:59,700 --> 00:06:01,440
monitor things for you instead you could

157
00:06:01,440 --> 00:06:02,850
you know have them be doing something

158
00:06:02,850 --> 00:06:08,580
else the other thing that it gives us

159
00:06:08,580 --> 00:06:11,669
too is a centralized place for exporting

160
00:06:11,669 --> 00:06:14,820
data but also just for the data to be

161
00:06:14,820 --> 00:06:16,440
logged so let's say throughout the

162
00:06:16,440 --> 00:06:19,560
engagement you had some specific things

163
00:06:19,560 --> 00:06:21,300
that were done you want to go in and do

164
00:06:21,300 --> 00:06:23,250
a quick check to see hey when was this

165
00:06:23,250 --> 00:06:24,690
command first where and things like that

166
00:06:24,690 --> 00:06:26,850
you can go into the sim at that point do

167
00:06:26,850 --> 00:06:28,260
a quick search just like you would do

168
00:06:28,260 --> 00:06:30,300
you know for a standard you know

169
00:06:30,300 --> 00:06:32,400
enterprise sim go into a search figure

170
00:06:32,400 --> 00:06:33,870
out when those things first hit and

171
00:06:33,870 --> 00:06:35,479
build out your time line if you need to

172
00:06:35,479 --> 00:06:37,680
additionally it gives you the ability to

173
00:06:37,680 --> 00:06:40,320
just export all the data that's on all

174
00:06:40,320 --> 00:06:41,610
of the servers it's so

175
00:06:41,610 --> 00:06:43,460
you don't have to worry about going in

176
00:06:43,460 --> 00:06:46,560
trying to script everything being zipped

177
00:06:46,560 --> 00:06:48,210
up compressed and then pulling it down

178
00:06:48,210 --> 00:06:50,930
to store it central you can just backup

179
00:06:50,930 --> 00:06:53,099
everything from the same at that point

180
00:06:53,099 --> 00:06:55,280
and you have all the data that we need

181
00:06:55,280 --> 00:06:58,050
the flip side of this is sort of what

182
00:06:58,050 --> 00:06:59,909
you use a traditional sim for alerting

183
00:06:59,909 --> 00:07:02,699
so with alerting this gives us the

184
00:07:02,699 --> 00:07:05,250
ability to do counter ir so let's say

185
00:07:05,250 --> 00:07:07,460
once the blue team starts to be actively

186
00:07:07,460 --> 00:07:09,750
sort of checking into our things maybe

187
00:07:09,750 --> 00:07:12,180
there are running things in sandboxes we

188
00:07:12,180 --> 00:07:13,680
can start to create alerts around this

189
00:07:13,680 --> 00:07:17,219
and so we want to know hey when is our

190
00:07:17,219 --> 00:07:19,199
c2 potentially being investigated is

191
00:07:19,199 --> 00:07:21,120
this c2 gonna be burned soon do we need

192
00:07:21,120 --> 00:07:23,129
to switch to a noose to stand something

193
00:07:23,129 --> 00:07:25,710
else up to sort of adapt to that and

194
00:07:25,710 --> 00:07:28,349
then the last step is meantime to

195
00:07:28,349 --> 00:07:28,889
respond

196
00:07:28,889 --> 00:07:31,020
this is typically a term that gets used

197
00:07:31,020 --> 00:07:32,520
for the blue team on how quick they

198
00:07:32,520 --> 00:07:34,500
respond to an incident we're sort of

199
00:07:34,500 --> 00:07:36,300
flipping that and saying how long does

200
00:07:36,300 --> 00:07:38,610
it take the red team to respond to a red

201
00:07:38,610 --> 00:07:40,710
team event so let's say someone enters

202
00:07:40,710 --> 00:07:42,569
in phishing credentials how long does it

203
00:07:42,569 --> 00:07:45,330
take that person to sort of go in figure

204
00:07:45,330 --> 00:07:47,669
out they got entered in and then go and

205
00:07:47,669 --> 00:07:49,349
potentially use them to log into a

206
00:07:49,349 --> 00:07:51,779
service or the same with a c2 may be

207
00:07:51,779 --> 00:07:54,210
this c2 has been running you know with

208
00:07:54,210 --> 00:07:56,849
the show on a potential entry point for

209
00:07:56,849 --> 00:07:59,129
you know several hours that person may

210
00:07:59,129 --> 00:08:00,680
just go home reboot their computer

211
00:08:00,680 --> 00:08:03,120
something might get detected and your

212
00:08:03,120 --> 00:08:05,099
teams will have the ability to go in and

213
00:08:05,099 --> 00:08:06,330
quickly respond to it

214
00:08:06,330 --> 00:08:08,729
establish persistence move to you know a

215
00:08:08,729 --> 00:08:11,219
secondary server things like that so

216
00:08:11,219 --> 00:08:12,810
this gives us the ability to reduce the

217
00:08:12,810 --> 00:08:15,000
time it takes for the red team to

218
00:08:15,000 --> 00:08:18,979
actually do things that we care about

219
00:08:20,479 --> 00:08:22,949
real quick we'll just talk about sort of

220
00:08:22,949 --> 00:08:25,949
what we used for the sim choice as I'm

221
00:08:25,949 --> 00:08:28,379
sure a lot of you guys know in the same

222
00:08:28,379 --> 00:08:29,490
space there are tons of different

223
00:08:29,490 --> 00:08:32,279
products there's commercial tools

224
00:08:32,279 --> 00:08:34,529
there's open source tools there's just

225
00:08:34,529 --> 00:08:36,929
freeware out there that you can use all

226
00:08:36,929 --> 00:08:39,089
of these have different options that

227
00:08:39,089 --> 00:08:40,769
they support there's pros and cons to

228
00:08:40,769 --> 00:08:42,899
them for this we wanted to go with

229
00:08:42,899 --> 00:08:45,360
something that was fairly lightweight we

230
00:08:45,360 --> 00:08:47,010
wanted to try and keep cost down and we

231
00:08:47,010 --> 00:08:47,940
didn't really want to deal with

232
00:08:47,940 --> 00:08:50,520
licensing that much so for this we ended

233
00:08:50,520 --> 00:08:53,940
up going with elastic we thought that it

234
00:08:53,940 --> 00:08:55,350
has a pretty decent community

235
00:08:55,350 --> 00:08:57,480
support we like sort of what people are

236
00:08:57,480 --> 00:08:59,280
doing with it there's a lot of cool

237
00:08:59,280 --> 00:09:00,780
projects out there there's a lot of

238
00:09:00,780 --> 00:09:02,250
people doing things specifically in the

239
00:09:02,250 --> 00:09:05,520
security space we kind of like that and

240
00:09:05,520 --> 00:09:07,590
then additionally it's open source so

241
00:09:07,590 --> 00:09:11,520
that's a nice feature too so if you

242
00:09:11,520 --> 00:09:13,860
aren't familiar with the elastic stack

243
00:09:13,860 --> 00:09:15,660
its kind of made up of some core

244
00:09:15,660 --> 00:09:18,300
components the main one is elastic

245
00:09:18,300 --> 00:09:20,400
search which handles the the search

246
00:09:20,400 --> 00:09:22,980
feature of your stack so it'll take in

247
00:09:22,980 --> 00:09:24,750
all your log data and you can search

248
00:09:24,750 --> 00:09:26,280
through you can distribute these systems

249
00:09:26,280 --> 00:09:28,860
for us since our infrastructure set is

250
00:09:28,860 --> 00:09:30,960
kind of smaller we went with a single

251
00:09:30,960 --> 00:09:34,170
host for the entire stack the next

252
00:09:34,170 --> 00:09:36,720
component is log stash which will be the

253
00:09:36,720 --> 00:09:38,910
component taking your log data and

254
00:09:38,910 --> 00:09:40,890
performing any type of transformations

255
00:09:40,890 --> 00:09:42,330
on it so if you want to parse out your

256
00:09:42,330 --> 00:09:44,460
log data to get custom fields to search

257
00:09:44,460 --> 00:09:45,960
on you can you do that

258
00:09:45,960 --> 00:09:47,610
and then there's cabana which is a

259
00:09:47,610 --> 00:09:50,010
dashboard system you can create custom

260
00:09:50,010 --> 00:09:52,710
views for the data you're taking in to

261
00:09:52,710 --> 00:09:55,140
get kind of just quick over views of

262
00:09:55,140 --> 00:09:58,590
that data and then the other component

263
00:09:58,590 --> 00:10:00,090
that's kind of outside the stack are

264
00:10:00,090 --> 00:10:03,120
beets so these run on your clients so

265
00:10:03,120 --> 00:10:04,710
you're efficient server your c2 server

266
00:10:04,710 --> 00:10:07,530
and they forward the logs to your log

267
00:10:07,530 --> 00:10:09,390
stash and then ultimately into your

268
00:10:09,390 --> 00:10:12,360
elastic search so for us week focused on

269
00:10:12,360 --> 00:10:14,220
the two primary ones which were file

270
00:10:14,220 --> 00:10:16,320
beet so that's for pushing the log data

271
00:10:16,320 --> 00:10:18,890
itself so things like your Apache log

272
00:10:18,890 --> 00:10:21,450
and your cobalt strike logs and then we

273
00:10:21,450 --> 00:10:24,300
also had metric beets for pushing system

274
00:10:24,300 --> 00:10:27,300
metrics like resource utilization so we

275
00:10:27,300 --> 00:10:28,710
wanted to have some kind of alerting

276
00:10:28,710 --> 00:10:31,440
outside of just standard security

277
00:10:31,440 --> 00:10:33,750
information so if your server is getting

278
00:10:33,750 --> 00:10:35,580
high of resource utilization you want to

279
00:10:35,580 --> 00:10:38,100
be alerted of that in case that's going

280
00:10:38,100 --> 00:10:40,110
to cause some performance issues or

281
00:10:40,110 --> 00:10:43,190
certain VPS providers like Alibaba cloud

282
00:10:43,190 --> 00:10:45,540
well hard cutoff servers if they reach

283
00:10:45,540 --> 00:10:47,810
certain utilizations

284
00:10:47,810 --> 00:10:51,510
so for us we use AWS and for for the

285
00:10:51,510 --> 00:10:54,300
main portion of our c2 stuff so we went

286
00:10:54,300 --> 00:10:56,940
with iSeries instances because they give

287
00:10:56,940 --> 00:10:59,250
you in terms of pricing really good

288
00:10:59,250 --> 00:11:03,090
memory and storage options which elke is

289
00:11:03,090 --> 00:11:06,180
pretty intensive in terms of memory but

290
00:11:06,180 --> 00:11:07,230
you could go with something like a too

291
00:11:07,230 --> 00:11:09,470
large

292
00:11:09,730 --> 00:11:12,410
so so once you get your log pipeline

293
00:11:12,410 --> 00:11:13,970
kind of starting to flow all the

294
00:11:13,970 --> 00:11:15,680
information flowing into your ELQ stack

295
00:11:15,680 --> 00:11:17,480
you want to start alerting on the

296
00:11:17,480 --> 00:11:19,339
different types of information you're

297
00:11:19,339 --> 00:11:21,170
getting in it so we kind of broke this

298
00:11:21,170 --> 00:11:24,019
down into the three main categories the

299
00:11:24,019 --> 00:11:26,209
first is good alerts so these are things

300
00:11:26,209 --> 00:11:29,120
like a new c2 being established or

301
00:11:29,120 --> 00:11:31,550
getting credentials entered into a

302
00:11:31,550 --> 00:11:34,160
phishing server which you can log

303
00:11:34,160 --> 00:11:37,279
through like sequel query logs and we

304
00:11:37,279 --> 00:11:39,440
have bad alerts so maybe you did get a

305
00:11:39,440 --> 00:11:41,390
c2 but it's being run in a sandbox and

306
00:11:41,390 --> 00:11:43,130
you can start a learning on the the

307
00:11:43,130 --> 00:11:45,140
characteristics those sandbox present in

308
00:11:45,140 --> 00:11:47,480
terms of your infrastructure another

309
00:11:47,480 --> 00:11:49,220
thing we've noticed recently is some

310
00:11:49,220 --> 00:11:51,019
defenders entering in fake credentials

311
00:11:51,019 --> 00:11:52,940
into phishing sites once they get like

312
00:11:52,940 --> 00:11:54,740
like a good lead on that kind of thing

313
00:11:54,740 --> 00:11:57,620
so being able to quickly determine if

314
00:11:57,620 --> 00:11:59,920
those credentials seem legitimate and

315
00:11:59,920 --> 00:12:02,360
the last category are informational

316
00:12:02,360 --> 00:12:04,550
things so like the day to day operations

317
00:12:04,550 --> 00:12:06,860
of your Red Team operator so what

318
00:12:06,860 --> 00:12:08,720
commands they're running in the c2 you

319
00:12:08,720 --> 00:12:10,820
can push those logs to it get alerts on

320
00:12:10,820 --> 00:12:13,670
it or say you want to have good insight

321
00:12:13,670 --> 00:12:15,500
into your operational security of your

322
00:12:15,500 --> 00:12:18,290
your team members so you have you -

323
00:12:18,290 --> 00:12:20,269
you're blocking certain commands you

324
00:12:20,269 --> 00:12:21,470
want to be alerted when someone tries to

325
00:12:21,470 --> 00:12:23,510
run one of those commands so that you're

326
00:12:23,510 --> 00:12:25,010
quickly able to respond to anything that

327
00:12:25,010 --> 00:12:30,980
might come out of that since we went

328
00:12:30,980 --> 00:12:33,920
with elastic for the logging portion of

329
00:12:33,920 --> 00:12:36,829
it the alerting options are kind of

330
00:12:36,829 --> 00:12:39,500
limited to a few key areas are key

331
00:12:39,500 --> 00:12:42,010
products the first is X packs which is

332
00:12:42,010 --> 00:12:45,170
elastics first party commercial option

333
00:12:45,170 --> 00:12:48,529
and then the alternative is a last alert

334
00:12:48,529 --> 00:12:51,949
which is developed by Yelp it you can

335
00:12:51,949 --> 00:12:53,180
kind of generate these really simple

336
00:12:53,180 --> 00:12:57,110
rules which are using a yamo syntax and

337
00:12:57,110 --> 00:12:59,660
you can just define the fields what you

338
00:12:59,660 --> 00:13:02,420
want to look for how often you should be

339
00:13:02,420 --> 00:13:05,089
queried and then where the alerts go so

340
00:13:05,089 --> 00:13:07,279
this is an example of something for say

341
00:13:07,279 --> 00:13:09,079
credential hits so what you do is you

342
00:13:09,079 --> 00:13:11,329
enable query logging on your your sequel

343
00:13:11,329 --> 00:13:13,519
instance and push those to your elastic

344
00:13:13,519 --> 00:13:15,740
stack and then you can start say

345
00:13:15,740 --> 00:13:17,630
searching for those insert statements

346
00:13:17,630 --> 00:13:19,430
into wherever you're storing your victim

347
00:13:19,430 --> 00:13:21,190
information

348
00:13:21,190 --> 00:13:23,590
then you can say push it to webhook so

349
00:13:23,590 --> 00:13:25,870
we use teams at our company for just

350
00:13:25,870 --> 00:13:28,210
chat stuff it's similar to slack we use

351
00:13:28,210 --> 00:13:30,280
slack as well so this will just give you

352
00:13:30,280 --> 00:13:33,130
like a quick message in teams that

353
00:13:33,130 --> 00:13:37,900
someone entered in creds one thing we

354
00:13:37,900 --> 00:13:39,520
made a kind of stress is that while we

355
00:13:39,520 --> 00:13:41,950
did go with kind of freer options for

356
00:13:41,950 --> 00:13:44,080
all this stuff it's not because we were

357
00:13:44,080 --> 00:13:45,370
trying to be cheap with it it's just

358
00:13:45,370 --> 00:13:48,460
that a last alert offered the offerings

359
00:13:48,460 --> 00:13:50,320
it provides are good enough for our use

360
00:13:50,320 --> 00:13:52,870
case that we didn't need to seek out

361
00:13:52,870 --> 00:13:54,520
something like expect but if it didn't

362
00:13:54,520 --> 00:13:56,170
we probably would have gone down the

363
00:13:56,170 --> 00:13:57,820
route of that commercial option but

364
00:13:57,820 --> 00:13:59,670
having in not having to deal with

365
00:13:59,670 --> 00:14:02,680
commercial licenses is really helpful if

366
00:14:02,680 --> 00:14:04,540
you want reproducible quick automated

367
00:14:04,540 --> 00:14:13,270
deployments so another thing we wanted

368
00:14:13,270 --> 00:14:15,250
to stress with this is that while the

369
00:14:15,250 --> 00:14:16,810
Blue team can do so many different

370
00:14:16,810 --> 00:14:18,790
things on there and there's only a

371
00:14:18,790 --> 00:14:20,860
limited subset of that thing you can see

372
00:14:20,860 --> 00:14:27,670
as it pertains to yearn for struck so

373
00:14:27,670 --> 00:14:29,500
while blue team might be chasing down

374
00:14:29,500 --> 00:14:31,080
like a fishing lead on the back end

375
00:14:31,080 --> 00:14:33,940
clearing all these like you know threat

376
00:14:33,940 --> 00:14:35,470
intelligence sources looking at

377
00:14:35,470 --> 00:14:38,440
virustotal looking at some historical

378
00:14:38,440 --> 00:14:40,570
DNS stuff you might not be able to see a

379
00:14:40,570 --> 00:14:43,660
lot of that so the the alerting and the

380
00:14:43,660 --> 00:14:45,460
the logging we're focusing on here

381
00:14:45,460 --> 00:14:48,610
focuses on what exactly you can see on

382
00:14:48,610 --> 00:14:50,710
your infrastructure so breaking that

383
00:14:50,710 --> 00:14:53,320
down into fidelity related areas you

384
00:14:53,320 --> 00:14:56,110
have really high fidelity alerts so a

385
00:14:56,110 --> 00:14:57,400
new c2 is being established

386
00:14:57,400 --> 00:14:59,200
that's really high fidelity because it's

387
00:14:59,200 --> 00:15:00,970
either really good in that one of your

388
00:15:00,970 --> 00:15:02,650
campaigns paid off and you know I will

389
00:15:02,650 --> 00:15:04,450
put the holder on a system or it's

390
00:15:04,450 --> 00:15:05,890
really high fidelity because you're

391
00:15:05,890 --> 00:15:07,480
can't campaign just got caught by the

392
00:15:07,480 --> 00:15:09,339
blue team and you know they're analyzing

393
00:15:09,339 --> 00:15:12,880
something like a Samba on the other end

394
00:15:12,880 --> 00:15:14,110
of that though you have something like

395
00:15:14,110 --> 00:15:16,570
really low fidelity alerts so just

396
00:15:16,570 --> 00:15:18,370
something a DNS lookup of one of your

397
00:15:18,370 --> 00:15:21,040
fishing domains every bot on the

398
00:15:21,040 --> 00:15:22,960
Internet is scan is the Internet's being

399
00:15:22,960 --> 00:15:25,300
scanned continuously so if they're doing

400
00:15:25,300 --> 00:15:27,160
a web request that's DNS right there so

401
00:15:27,160 --> 00:15:29,290
these are not really actionable so for

402
00:15:29,290 --> 00:15:31,450
us we wanted to focus on actionable

403
00:15:31,450 --> 00:15:33,580
information that we could respond to

404
00:15:33,580 --> 00:15:34,899
immediately

405
00:15:34,899 --> 00:15:36,999
the common breakdown that everyone faces

406
00:15:36,999 --> 00:15:39,369
sort of you know in in the blue team

407
00:15:39,369 --> 00:15:40,869
space hey we have assumed how do we get

408
00:15:40,869 --> 00:15:43,119
good alerts out of that we sort of have

409
00:15:43,119 --> 00:15:44,499
the same problem just trying to figure

410
00:15:44,499 --> 00:15:45,910
out hey what do we actually wanna learn

411
00:15:45,910 --> 00:15:51,009
on that there's das so so of the

412
00:15:51,009 --> 00:15:52,929
activity that you'll see from a blue

413
00:15:52,929 --> 00:15:54,999
team there's certain things you want to

414
00:15:54,999 --> 00:15:56,920
break down into what you can profile out

415
00:15:56,920 --> 00:16:00,819
of it so a few broad categories are one

416
00:16:00,819 --> 00:16:02,470
the source location where they're coming

417
00:16:02,470 --> 00:16:03,009
from

418
00:16:03,009 --> 00:16:04,329
so are they coming from a certain

419
00:16:04,329 --> 00:16:07,119
geographic region a certain range owned

420
00:16:07,119 --> 00:16:10,300
by a known company how they're react how

421
00:16:10,300 --> 00:16:11,230
they're interacting with your

422
00:16:11,230 --> 00:16:13,209
infrastructure so is it being loaded on

423
00:16:13,209 --> 00:16:15,189
a browser versus command-line options

424
00:16:15,189 --> 00:16:17,709
things like that and then it's going to

425
00:16:17,709 --> 00:16:20,259
be very based on who's doing it so if

426
00:16:20,259 --> 00:16:21,850
you have just a target user that you

427
00:16:21,850 --> 00:16:24,399
sent a phishing link to they're probably

428
00:16:24,399 --> 00:16:27,699
coming from you know any old IP possibly

429
00:16:27,699 --> 00:16:29,740
in a something geographically close to

430
00:16:29,740 --> 00:16:32,319
where their headquarters are they're

431
00:16:32,319 --> 00:16:33,939
loading in and a browser they're loading

432
00:16:33,939 --> 00:16:35,379
and all the associated resources if

433
00:16:35,379 --> 00:16:36,550
you're loading it on a browser so the

434
00:16:36,550 --> 00:16:38,759
JavaScript to CSS stuff like that

435
00:16:38,759 --> 00:16:41,100
however a blue teamer

436
00:16:41,100 --> 00:16:44,790
there they could be coming from you know

437
00:16:44,790 --> 00:16:47,800
certain security vendors or loading it

438
00:16:47,800 --> 00:16:51,160
with security tool so with that you can

439
00:16:51,160 --> 00:16:52,720
kind of develop these indicators of

440
00:16:52,720 --> 00:16:55,120
analysis so if you're a blue team you're

441
00:16:55,120 --> 00:16:56,709
kind of familiar with the idea of an

442
00:16:56,709 --> 00:16:58,870
indicator of compromise this is like the

443
00:16:58,870 --> 00:17:00,850
red team side of it so what we can look

444
00:17:00,850 --> 00:17:02,410
at in terms of what the blue team is

445
00:17:02,410 --> 00:17:04,959
doing so if you're learning it from a

446
00:17:04,959 --> 00:17:07,119
command-line tool like curl or W get and

447
00:17:07,119 --> 00:17:08,230
you don't bother the change is user

448
00:17:08,230 --> 00:17:11,409
agent those are pretty like high to

449
00:17:11,409 --> 00:17:13,029
medium fidelity alerts that we can

450
00:17:13,029 --> 00:17:15,730
detect on our infrastructure if you're

451
00:17:15,730 --> 00:17:18,279
loading it so say you have a ticket open

452
00:17:18,279 --> 00:17:21,490
in ServiceNow and that our site is being

453
00:17:21,490 --> 00:17:23,439
loaded from ServiceNow it's likely

454
00:17:23,439 --> 00:17:25,569
coming from a tor exit node or if you

455
00:17:25,569 --> 00:17:27,699
just have anything coming from a Touareg

456
00:17:27,699 --> 00:17:29,470
- no really for that matter because the

457
00:17:29,470 --> 00:17:31,360
normal user isn't likely not coming from

458
00:17:31,360 --> 00:17:33,909
that another thing you can look at our

459
00:17:33,909 --> 00:17:35,980
sandbox characteristics so when you load

460
00:17:35,980 --> 00:17:39,279
a situ in a sandbox the thing loading it

461
00:17:39,279 --> 00:17:41,020
isn't going to look like a normal user

462
00:17:41,020 --> 00:17:43,720
usually you know have like no domain

463
00:17:43,720 --> 00:17:45,549
associated with it or I'll have a wonky

464
00:17:45,549 --> 00:17:48,440
name like apiary or Bob

465
00:17:48,440 --> 00:17:51,200
or it'll be you know local admin which

466
00:17:51,200 --> 00:17:54,950
is uncommon for c2 so these are all

467
00:17:54,950 --> 00:17:57,170
things you can look at when you get

468
00:17:57,170 --> 00:18:01,850
information in your sin so here we have

469
00:18:01,850 --> 00:18:05,330
some example alerts so we simulated the

470
00:18:05,330 --> 00:18:08,270
activity and then got the alert sent to

471
00:18:08,270 --> 00:18:10,610
our team's webhook so this first one is

472
00:18:10,610 --> 00:18:12,260
what it would look like if someone

473
00:18:12,260 --> 00:18:13,550
entered in credentials into your

474
00:18:13,550 --> 00:18:16,760
phishing site and the bottom one is if

475
00:18:16,760 --> 00:18:19,730
you get a new C - we call it beacon

476
00:18:19,730 --> 00:18:21,290
because we're using cobalt strike which

477
00:18:21,290 --> 00:18:27,160
is the name of its C - these are for

478
00:18:27,160 --> 00:18:29,900
potential blue team activity so like I

479
00:18:29,900 --> 00:18:32,630
said curl user agent those kind of

480
00:18:32,630 --> 00:18:34,760
command line tools detecting those user

481
00:18:34,760 --> 00:18:37,100
agents in your logs that bottom one

482
00:18:37,100 --> 00:18:39,980
again sandbox so once cobalt strike

483
00:18:39,980 --> 00:18:43,580
pushes the C to log you can look at you

484
00:18:43,580 --> 00:18:45,560
know what user is loading that C to

485
00:18:45,560 --> 00:18:50,960
answer that middle one there are well a

486
00:18:50,960 --> 00:18:53,780
SAP list of security vendor IPs

487
00:18:53,780 --> 00:18:56,170
things like what virus comes from

488
00:18:56,170 --> 00:18:59,540
classes things like that unlikely for a

489
00:18:59,540 --> 00:19:01,640
user to be sourcing from so what we've

490
00:19:01,640 --> 00:19:04,280
done is on our redirect errs have an HT

491
00:19:04,280 --> 00:19:06,110
access file that redirects those away

492
00:19:06,110 --> 00:19:09,470
from our origin C to server so what we

493
00:19:09,470 --> 00:19:11,780
can do is then take that redirect which

494
00:19:11,780 --> 00:19:14,270
is in the Apache era log and alert on it

495
00:19:14,270 --> 00:19:16,100
so when you get that specific redirect

496
00:19:16,100 --> 00:19:19,330
we now know that it's security source

497
00:19:19,330 --> 00:19:22,010
and it's preferable than having just

498
00:19:22,010 --> 00:19:25,070
that raw source we're using in the HT

499
00:19:25,070 --> 00:19:27,140
access file in the rules because it's

500
00:19:27,140 --> 00:19:32,210
much more manageable and this last one

501
00:19:32,210 --> 00:19:33,830
is kind of those informational alerts

502
00:19:33,830 --> 00:19:36,980
you're interested in seeing so in cobalt

503
00:19:36,980 --> 00:19:38,780
strike we use an aggressor script

504
00:19:38,780 --> 00:19:40,850
profile that'll limit the commands

505
00:19:40,850 --> 00:19:42,350
you're allowed to run so certain

506
00:19:42,350 --> 00:19:43,940
commands are pretty dangerous and are

507
00:19:43,940 --> 00:19:45,500
likely to get you caught pretty

508
00:19:45,500 --> 00:19:47,930
instantly so we want to block those but

509
00:19:47,930 --> 00:19:49,400
we also want to know when our people are

510
00:19:49,400 --> 00:19:50,930
using those commands that they shouldn't

511
00:19:50,930 --> 00:19:53,300
be using so we have an alert setup so

512
00:19:53,300 --> 00:19:55,100
that we can see that there they're

513
00:19:55,100 --> 00:19:56,780
running those commands and reacts

514
00:19:56,780 --> 00:19:58,430
appropriately these would be really

515
00:19:58,430 --> 00:20:00,950
beneficial to sort of like the red team

516
00:20:00,950 --> 00:20:02,150
manager or whoever

517
00:20:02,150 --> 00:20:03,710
is providing oversight for the

518
00:20:03,710 --> 00:20:06,110
engagement they can go in see hey you

519
00:20:06,110 --> 00:20:07,760
know you know maybe we're trying to

520
00:20:07,760 --> 00:20:10,880
let's say PS exact to something and PS

521
00:20:10,880 --> 00:20:12,350
exact a common command that's going to

522
00:20:12,350 --> 00:20:13,580
get flagged by a lot of different

523
00:20:13,580 --> 00:20:15,170
security tool sets that are out there

524
00:20:15,170 --> 00:20:19,880
that is a non safe OPSEC command that we

525
00:20:19,880 --> 00:20:22,370
are that we have and so this blocks it

526
00:20:22,370 --> 00:20:24,530
but by alerting on it it gives the

527
00:20:24,530 --> 00:20:26,450
Engagement Manager the ability to go and

528
00:20:26,450 --> 00:20:28,790
say hey who is the one who ran this look

529
00:20:28,790 --> 00:20:31,310
into it and then just give it a teaching

530
00:20:31,310 --> 00:20:34,730
moment for the team so and this second

531
00:20:34,730 --> 00:20:36,080
one is kind of a more generalized

532
00:20:36,080 --> 00:20:38,720
version of that so not related to OPSEC

533
00:20:38,720 --> 00:20:42,200
but just general commands alerting so

534
00:20:42,200 --> 00:20:43,610
you can have kind of a really quick

535
00:20:43,610 --> 00:20:45,470
audit ability of the commands you're

536
00:20:45,470 --> 00:20:47,570
running so if you want to maybe alert

537
00:20:47,570 --> 00:20:49,610
every time you run mimikatz logon

538
00:20:49,610 --> 00:20:51,590
passwords you can have that right there

539
00:20:51,590 --> 00:20:53,510
in your web hook rather than having to

540
00:20:53,510 --> 00:20:57,980
sift through all of your c2 logs we have

541
00:20:57,980 --> 00:21:00,010
a couple demos prep of just kind of

542
00:21:00,010 --> 00:21:03,230
these situations and Dan if you know

543
00:21:03,230 --> 00:21:14,990
sure all right so this is just a real

544
00:21:14,990 --> 00:21:17,720
quick one of us we're gonna go ahead and

545
00:21:17,720 --> 00:21:20,090
curl one of the pages that are redirect

546
00:21:20,090 --> 00:21:22,990
or hosted or that one of our readers has

547
00:21:22,990 --> 00:21:26,390
so we go ahead hit the curl command it

548
00:21:26,390 --> 00:21:29,210
goes ahead and attempts to pull down the

549
00:21:29,210 --> 00:21:33,490
page and then we see here in teams that

550
00:21:33,490 --> 00:21:38,480
we go ahead and get a new curl user

551
00:21:38,480 --> 00:21:41,990
agent alert scene that someone used curl

552
00:21:41,990 --> 00:21:44,330
to go ahead and pull this I pull down

553
00:21:44,330 --> 00:21:46,130
the page so something like that so

554
00:21:46,130 --> 00:21:48,980
potentially something an IR person is

555
00:21:48,980 --> 00:21:51,590
doing a Blue team person is doing just

556
00:21:51,590 --> 00:21:57,680
to alert us on that this next one this

557
00:21:57,680 --> 00:22:00,770
is just a generic phishing site that we

558
00:22:00,770 --> 00:22:02,930
put up because we definitely use this on

559
00:22:02,930 --> 00:22:06,320
red team's so this is just simulating

560
00:22:06,320 --> 00:22:08,090
someone that clicks on a phishing link

561
00:22:08,090 --> 00:22:11,480
we have a portal set up they're going to

562
00:22:11,480 --> 00:22:15,820
go ahead and enter in their credentials

563
00:22:16,690 --> 00:22:20,060
they log in they get a nice fluorophore

564
00:22:20,060 --> 00:22:23,630
and we go ahead and see here that we now

565
00:22:23,630 --> 00:22:27,070
have a credential hid in our team so

566
00:22:27,070 --> 00:22:29,990
there's a little bit of a delay I'd say

567
00:22:29,990 --> 00:22:31,880
probably what 30 seconds I think we've

568
00:22:31,880 --> 00:22:34,700
seen which you know if you guys use him

569
00:22:34,700 --> 00:22:35,990
you know there's always going to be some

570
00:22:35,990 --> 00:22:38,240
type of delay with getting the logs in

571
00:22:38,240 --> 00:22:41,660
but 30 seconds isn't bad for us for this

572
00:22:41,660 --> 00:22:44,810
so that one is our credential harvest

573
00:22:44,810 --> 00:22:50,530
and then this next one is using our

574
00:22:50,530 --> 00:22:53,000
command and control tool cobalt strike

575
00:22:53,000 --> 00:22:56,090
and so here we're just going to go ahead

576
00:22:56,090 --> 00:22:57,530
you can see we don't have any beacons

577
00:22:57,530 --> 00:22:59,870
and cobalt strike right now so we're

578
00:22:59,870 --> 00:23:03,020
gonna go ahead and get just a powershell

579
00:23:03,020 --> 00:23:06,500
one-liner just for testing purposes

580
00:23:06,500 --> 00:23:09,890
we'll go ahead and put it in in a victim

581
00:23:09,890 --> 00:23:12,380
system we go ahead we see we have a new

582
00:23:12,380 --> 00:23:15,080
c2 Channel established it's designated

583
00:23:15,080 --> 00:23:19,010
by that and then we go ahead and there's

584
00:23:19,010 --> 00:23:21,110
a new beacon hid in the team's Channel

585
00:23:21,110 --> 00:23:24,770
so this is just sort of a quick demo of

586
00:23:24,770 --> 00:23:26,720
sort of how this works what it looks

587
00:23:26,720 --> 00:23:29,600
like when you know an alert comes in so

588
00:23:29,600 --> 00:23:32,330
very similar and you know like Evan was

589
00:23:32,330 --> 00:23:34,010
saying if you use something like slack

590
00:23:34,010 --> 00:23:36,350
you know this could easily be ported

591
00:23:36,350 --> 00:23:41,270
into that you're just replacing that so

592
00:23:41,270 --> 00:23:44,030
with the work we've done for this we've

593
00:23:44,030 --> 00:23:46,340
also come up with some example rules

594
00:23:46,340 --> 00:23:48,050
that you can use for a less alert if you

595
00:23:48,050 --> 00:23:50,090
want to kind of go down this route these

596
00:23:50,090 --> 00:23:51,620
are all included and I get Hubley

597
00:23:51,620 --> 00:23:53,870
released today for this topic I will

598
00:23:53,870 --> 00:23:55,010
probably the link at the end of the talk

599
00:23:55,010 --> 00:23:56,360
and I'll also make the slides available

600
00:23:56,360 --> 00:23:59,470
as well so I can just run through these

601
00:23:59,470 --> 00:24:02,840
the first one which is getting a new c2

602
00:24:02,840 --> 00:24:06,650
beacon the second one is that up sack

603
00:24:06,650 --> 00:24:10,250
block the command block though there's

604
00:24:10,250 --> 00:24:11,600
another one for that that just

605
00:24:11,600 --> 00:24:13,640
generalized command 1 it's not shown

606
00:24:13,640 --> 00:24:17,030
here but it's it'll be available the

607
00:24:17,030 --> 00:24:20,990
third is just that Karl user-agent the

608
00:24:20,990 --> 00:24:23,330
fourth is the credential harvest hit and

609
00:24:23,330 --> 00:24:25,700
the one after that is a variation of

610
00:24:25,700 --> 00:24:28,850
that so if you know the domain that

611
00:24:28,850 --> 00:24:31,430
target is going to be on you can set an

612
00:24:31,430 --> 00:24:33,080
alert so that when credentials are

613
00:24:33,080 --> 00:24:34,430
entered that are of a different domain

614
00:24:34,430 --> 00:24:36,980
you get an alert so potentially someone

615
00:24:36,980 --> 00:24:40,090
entering in creds outside your target

616
00:24:40,090 --> 00:24:43,700
the one below that is looking for common

617
00:24:43,700 --> 00:24:47,150
you know users in sandboxes with a news

618
00:24:47,150 --> 00:24:51,050
beacon being established following that

619
00:24:51,050 --> 00:24:54,050
is just a general URI hit so if you have

620
00:24:54,050 --> 00:24:55,580
a specific path on your web server that

621
00:24:55,580 --> 00:24:56,360
gets a hit

622
00:24:56,360 --> 00:24:58,100
you can alert on that so this is pretty

623
00:24:58,100 --> 00:24:59,210
useful if you have something like a

624
00:24:59,210 --> 00:25:01,610
payload server and you want to know all

625
00:25:01,610 --> 00:25:03,320
the times that payload is pulled down

626
00:25:03,320 --> 00:25:05,330
you can get an alert on that using this

627
00:25:05,330 --> 00:25:07,580
and the last one is that vendor IP

628
00:25:07,580 --> 00:25:14,060
looking for the Apache redirect so this

629
00:25:14,060 --> 00:25:16,880
is sort of our just generic lifecycle

630
00:25:16,880 --> 00:25:18,500
we're gonna walk you through we called

631
00:25:18,500 --> 00:25:21,170
it from forest a fireplace to stick with

632
00:25:21,170 --> 00:25:23,810
the whole logging theme so sort of the

633
00:25:23,810 --> 00:25:25,760
first phase of this is going to be the

634
00:25:25,760 --> 00:25:28,280
attacker coming up with a phishing

635
00:25:28,280 --> 00:25:30,530
campaign hosting some type of payload

636
00:25:30,530 --> 00:25:33,260
and then sending that phishing email and

637
00:25:33,260 --> 00:25:35,960
so with this the next sort of phase with

638
00:25:35,960 --> 00:25:38,080
that would be some type of mail gateway

639
00:25:38,080 --> 00:25:41,150
email security appliance something gets

640
00:25:41,150 --> 00:25:43,070
that and potentially has the ability to

641
00:25:43,070 --> 00:25:44,570
start checking the link it can send a

642
00:25:44,570 --> 00:25:47,900
link or if they you send in sort of a

643
00:25:47,900 --> 00:25:50,330
macro enabled Word document that has

644
00:25:50,330 --> 00:25:53,060
sort of some weaponized code in there it

645
00:25:53,060 --> 00:25:54,530
has the ability to potentially you know

646
00:25:54,530 --> 00:25:56,120
you know check that out run it in a

647
00:25:56,120 --> 00:25:59,090
sandbox so sort of that mail gateway is

648
00:25:59,090 --> 00:26:01,190
sort of the next step and then assuming

649
00:26:01,190 --> 00:26:02,870
that your stuff is good it just

650
00:26:02,870 --> 00:26:05,810
continues it on to the end user who then

651
00:26:05,810 --> 00:26:08,630
executes your payload and you establish

652
00:26:08,630 --> 00:26:10,420
your initial situ into the environment

653
00:26:10,420 --> 00:26:12,650
from there you can start to move well I

654
00:26:12,650 --> 00:26:14,150
really do whatever you want go after

655
00:26:14,150 --> 00:26:15,860
your trophies escalate to whatever you

656
00:26:15,860 --> 00:26:18,770
need to you know get the flags that are

657
00:26:18,770 --> 00:26:21,170
required for the engagement let's say

658
00:26:21,170 --> 00:26:22,760
along the way you're dropping some

659
00:26:22,760 --> 00:26:25,760
harder facts for persistence or you know

660
00:26:25,760 --> 00:26:28,070
maybe something finally fired on you

661
00:26:28,070 --> 00:26:29,660
know the month of situ that you've been

662
00:26:29,660 --> 00:26:32,990
doing and the the blue team starts to

663
00:26:32,990 --> 00:26:35,420
check things up like oh let's let's

664
00:26:35,420 --> 00:26:37,250
start to correlate this back and find

665
00:26:37,250 --> 00:26:38,840
the initial email so maybe they'll take

666
00:26:38,840 --> 00:26:40,940
that and detonate the initial email into

667
00:26:40,940 --> 00:26:42,670
a sandbox and so

668
00:26:42,670 --> 00:26:44,620
you know you might have things that you

669
00:26:44,620 --> 00:26:46,720
can see that is being random sandbox and

670
00:26:46,720 --> 00:26:48,880
then sort of the last step of this is

671
00:26:48,880 --> 00:26:50,530
the blue team going through and

672
00:26:50,530 --> 00:26:52,900
performing manual inspection on your

673
00:26:52,900 --> 00:26:55,210
your infrastructure maybe they're

674
00:26:55,210 --> 00:26:57,520
checking out other payloads starting to

675
00:26:57,520 --> 00:26:59,110
sort of mess with the situ things like

676
00:26:59,110 --> 00:27:02,650
that it's sort of where the sim that we

677
00:27:02,650 --> 00:27:05,250
that we put together comes into play is

678
00:27:05,250 --> 00:27:07,750
after you send the initial email maybe

679
00:27:07,750 --> 00:27:09,160
you'll get an alert in the sim that

680
00:27:09,160 --> 00:27:11,410
something's being done from a known

681
00:27:11,410 --> 00:27:13,780
vendor source IP maybe it's trying to

682
00:27:13,780 --> 00:27:15,760
scan you know the link that you sent in

683
00:27:15,760 --> 00:27:18,250
or it's trying to detonate in a sandbox

684
00:27:18,250 --> 00:27:20,980
that's coming from one of their IPs

685
00:27:20,980 --> 00:27:23,050
the next one is we can get an alert when

686
00:27:23,050 --> 00:27:25,690
a new payload is delivered and a situ is

687
00:27:25,690 --> 00:27:27,340
established so that's something that the

688
00:27:27,340 --> 00:27:28,930
red team wants to know we can then start

689
00:27:28,930 --> 00:27:30,880
to you know continue out throughout the

690
00:27:30,880 --> 00:27:34,810
internal phase of the testing and then

691
00:27:34,810 --> 00:27:36,130
additionally we also want to know

692
00:27:36,130 --> 00:27:37,960
anytime something's potentially ran in

693
00:27:37,960 --> 00:27:39,730
the sandbox that the blue team's doing

694
00:27:39,730 --> 00:27:41,920
so there's potential indicators that we

695
00:27:41,920 --> 00:27:43,930
can alert on that we have sort of that

696
00:27:43,930 --> 00:27:46,510
rule for that we'll get the alert and

697
00:27:46,510 --> 00:27:47,980
then that last one is just sort of

698
00:27:47,980 --> 00:27:50,260
manual investigation from the blue team

699
00:27:50,260 --> 00:27:51,940
so some of those you know indicators of

700
00:27:51,940 --> 00:27:54,340
analysis that we outlined earlier those

701
00:27:54,340 --> 00:27:55,240
are things that we could potentially

702
00:27:55,240 --> 00:27:57,250
trigger on and then you know let us know

703
00:27:57,250 --> 00:27:58,990
that hey you know our stuffs you know

704
00:27:58,990 --> 00:28:02,470
being inspected we need to adapt you

705
00:28:02,470 --> 00:28:04,420
know move over to a different C to spin

706
00:28:04,420 --> 00:28:06,310
something else in so this is sort of the

707
00:28:06,310 --> 00:28:08,500
life cycle that we put together just for

708
00:28:08,500 --> 00:28:14,050
you know quick demo purposes so sort of

709
00:28:14,050 --> 00:28:16,240
the key takeaways of this what we wanted

710
00:28:16,240 --> 00:28:19,030
to put together why we did it the big

711
00:28:19,030 --> 00:28:21,490
one was getting log aggregation so

712
00:28:21,490 --> 00:28:23,440
obviously it's extremely difficult and

713
00:28:23,440 --> 00:28:25,390
taxing on the red team if they have to

714
00:28:25,390 --> 00:28:27,310
go in and manage each system separately

715
00:28:27,310 --> 00:28:31,210
go in you know SSH in grep out logs you

716
00:28:31,210 --> 00:28:34,060
know a tail things trying to identify if

717
00:28:34,060 --> 00:28:36,250
something you know happened things like

718
00:28:36,250 --> 00:28:38,650
that so having that all pushed to a

719
00:28:38,650 --> 00:28:40,210
central place that you could do searches

720
00:28:40,210 --> 00:28:42,550
on and then eventually you know create

721
00:28:42,550 --> 00:28:45,430
alerts for but also that the ability to

722
00:28:45,430 --> 00:28:47,410
export everything out is nice and to be

723
00:28:47,410 --> 00:28:48,790
able to search all from you know a

724
00:28:48,790 --> 00:28:51,120
single console that provides us with

725
00:28:51,120 --> 00:28:54,910
with a lot of good things the other part

726
00:28:54,910 --> 00:28:55,960
of this was the counter

727
00:28:55,960 --> 00:28:58,380
our perspective so we want to know when

728
00:28:58,380 --> 00:29:00,400
instant responders are doing something

729
00:29:00,400 --> 00:29:02,710
so we can sort of counter that you know

730
00:29:02,710 --> 00:29:05,110
we have the alerts created now we can go

731
00:29:05,110 --> 00:29:07,810
in and once one of those fires we know

732
00:29:07,810 --> 00:29:10,090
hey we need to change tactics or you

733
00:29:10,090 --> 00:29:11,770
know the the fake thing that we stood

734
00:29:11,770 --> 00:29:13,480
there you don't work they went to it and

735
00:29:13,480 --> 00:29:16,030
now we can you know continue with the

736
00:29:16,030 --> 00:29:18,640
other route other things like that and

737
00:29:18,640 --> 00:29:20,560
then give you an early warning signs too

738
00:29:20,560 --> 00:29:22,360
of you know hey you know this is getting

739
00:29:22,360 --> 00:29:24,760
ran in a sandbox maybe they're on to us

740
00:29:24,760 --> 00:29:26,590
and give you the idea that you need to

741
00:29:26,590 --> 00:29:29,080
start to change and adapt to it and then

742
00:29:29,080 --> 00:29:31,210
the last part of it was reduce mean time

743
00:29:31,210 --> 00:29:33,670
to respond for the red team to read team

744
00:29:33,670 --> 00:29:36,310
events so like I was saying earlier you

745
00:29:36,310 --> 00:29:37,720
don't have to worry about your situ

746
00:29:37,720 --> 00:29:40,150
being ran you know a beacon being ran

747
00:29:40,150 --> 00:29:42,130
for several hours before you respond to

748
00:29:42,130 --> 00:29:43,630
it you can get the alert right away that

749
00:29:43,630 --> 00:29:44,350
you have a new one

750
00:29:44,350 --> 00:29:46,540
have your team go in and start to do

751
00:29:46,540 --> 00:29:47,980
whatever they need to sort of get you

752
00:29:47,980 --> 00:29:49,540
some persistence or whatever you

753
00:29:49,540 --> 00:29:51,070
whatever you have for your methodology

754
00:29:51,070 --> 00:29:56,530
there and what would it be without some

755
00:29:56,530 --> 00:30:00,910
DevOps so along with this work we wanted

756
00:30:00,910 --> 00:30:03,910
to create or produce something that

757
00:30:03,910 --> 00:30:06,040
would allow us to do this continually so

758
00:30:06,040 --> 00:30:08,320
we don't have to spend that a long

759
00:30:08,320 --> 00:30:10,030
amount of time throwing up a new

760
00:30:10,030 --> 00:30:11,890
infrastructure for every engagement we

761
00:30:11,890 --> 00:30:13,540
can kind of just press a button and we

762
00:30:13,540 --> 00:30:16,720
have our elk stack up and ready so since

763
00:30:16,720 --> 00:30:18,460
we're going for kind of software

764
00:30:18,460 --> 00:30:20,230
installs and configuration one with

765
00:30:20,230 --> 00:30:22,750
ansible for configuration management we

766
00:30:22,750 --> 00:30:25,510
found this great resource that is for

767
00:30:25,510 --> 00:30:28,960
ansible elk snacks we kind of took it

768
00:30:28,960 --> 00:30:31,510
made some modifications to our needs

769
00:30:31,510 --> 00:30:35,260
added some coal strike support to it and

770
00:30:35,260 --> 00:30:37,330
so now we can have you know all our

771
00:30:37,330 --> 00:30:39,210
servers stood up and provisioned

772
00:30:39,210 --> 00:30:42,160
properly we can have the Elks a stack

773
00:30:42,160 --> 00:30:44,440
available and the clients pushing logs

774
00:30:44,440 --> 00:30:46,990
to them and going beyond that if you

775
00:30:46,990 --> 00:30:48,790
want to start provisioning your servers

776
00:30:48,790 --> 00:30:50,320
automatically you can use something like

777
00:30:50,320 --> 00:30:52,870
terraform which will allow you to kind

778
00:30:52,870 --> 00:30:54,340
of define the infrastructure you want

779
00:30:54,340 --> 00:30:57,910
and then deploy it so this kind of

780
00:30:57,910 --> 00:31:00,790
helped us you know speed it up for when

781
00:31:00,790 --> 00:31:03,460
we need this in production yeah so the

782
00:31:03,460 --> 00:31:06,010
big win with this one was hey we have a

783
00:31:06,010 --> 00:31:07,360
standard you know Red Team

784
00:31:07,360 --> 00:31:08,740
infrastructure that we're probably going

785
00:31:08,740 --> 00:31:09,890
to use this

786
00:31:09,890 --> 00:31:11,750
the majority of them at least gets us a

787
00:31:11,750 --> 00:31:14,660
skeleton that we can use by automating

788
00:31:14,660 --> 00:31:16,490
this whole thing you don't have to have

789
00:31:16,490 --> 00:31:18,830
a red team member now taking a week to

790
00:31:18,830 --> 00:31:20,120
stand up and configure all your

791
00:31:20,120 --> 00:31:22,190
infrastructure using something like

792
00:31:22,190 --> 00:31:24,350
terraform you just tell it hey I want

793
00:31:24,350 --> 00:31:26,420
these types of servers go ahead and

794
00:31:26,420 --> 00:31:28,550
stand them up in these regions or you

795
00:31:28,550 --> 00:31:30,050
know configure these security firewall

796
00:31:30,050 --> 00:31:32,660
settings on them things like that and

797
00:31:32,660 --> 00:31:35,030
then having ansible go in and you know

798
00:31:35,030 --> 00:31:36,740
configure hey this needs to be an Apache

799
00:31:36,740 --> 00:31:39,050
web server and configure you know mod

800
00:31:39,050 --> 00:31:41,690
rewrite for it this is a cobalt strike

801
00:31:41,690 --> 00:31:44,390
server so we need these specific things

802
00:31:44,390 --> 00:31:47,570
configured on it having ansible going in

803
00:31:47,570 --> 00:31:50,030
you know doing that setup and then the

804
00:31:50,030 --> 00:31:51,830
biggest part is honestly pushing beats

805
00:31:51,830 --> 00:31:53,900
to all of them and then configuring the

806
00:31:53,900 --> 00:31:56,120
logging so that that's all being pushed

807
00:31:56,120 --> 00:31:58,160
right back into your ELQ stack and you

808
00:31:58,160 --> 00:31:59,900
know you can do this so it saves you you

809
00:31:59,900 --> 00:32:04,040
know a week you can do this so we sort

810
00:32:04,040 --> 00:32:06,290
of get the that skeleton put together

811
00:32:06,290 --> 00:32:08,180
this gives you the ability to stand this

812
00:32:08,180 --> 00:32:10,190
up really quick it makes it repeatable

813
00:32:10,190 --> 00:32:11,990
which was sort of the whole goal of this

814
00:32:11,990 --> 00:32:14,600
because if it's not repeatable and it's

815
00:32:14,600 --> 00:32:16,640
extremely you know cumbersome to put

816
00:32:16,640 --> 00:32:18,230
together and it takes up a lot of time

817
00:32:18,230 --> 00:32:20,210
we're just not going to be able to do it

818
00:32:20,210 --> 00:32:23,420
so we can't add additional time to the

819
00:32:23,420 --> 00:32:25,010
prep for the engagement we just want to

820
00:32:25,010 --> 00:32:30,100
reduce that into this so we put together

821
00:32:30,100 --> 00:32:33,290
github repo of kind of all the resources

822
00:32:33,290 --> 00:32:35,900
we developed during our time looking

823
00:32:35,900 --> 00:32:38,570
into this so it includes some sample

824
00:32:38,570 --> 00:32:41,360
configurations for the out stuff it

825
00:32:41,360 --> 00:32:43,700
includes sample configuration for

826
00:32:43,700 --> 00:32:46,010
elastic as well as all the alerts we

827
00:32:46,010 --> 00:32:48,980
talked about it includes the ansible

828
00:32:48,980 --> 00:32:51,710
roles for deploying this the base ones

829
00:32:51,710 --> 00:32:53,780
that we referenced as well as the ones

830
00:32:53,780 --> 00:32:56,180
we added and then some shell scripts so

831
00:32:56,180 --> 00:32:57,260
if you don't want to go the ansible

832
00:32:57,260 --> 00:32:59,330
route and you just want to have a script

833
00:32:59,330 --> 00:33:00,920
to have your client start pushing logs

834
00:33:00,920 --> 00:33:03,140
to ELQ you can do it that way and not

835
00:33:03,140 --> 00:33:07,370
have to worry about ansible so this will

836
00:33:07,370 --> 00:33:09,920
be will make these slides available so

837
00:33:09,920 --> 00:33:10,820
you don't have to worry about kind of

838
00:33:10,820 --> 00:33:12,890
taking a picture of these this but these

839
00:33:12,890 --> 00:33:14,090
are some resources we thought were

840
00:33:14,090 --> 00:33:17,030
useful kind of going down this route the

841
00:33:17,030 --> 00:33:19,100
first one is the red team infrastructure

842
00:33:19,100 --> 00:33:20,600
key if you're not familiar with it and

843
00:33:20,600 --> 00:33:22,970
you do read teams this is invaluable

844
00:33:22,970 --> 00:33:25,480
the second is how to provision

845
00:33:25,480 --> 00:33:27,740
infrastructure using terraform with a

846
00:33:27,740 --> 00:33:29,900
focus on red teaming

847
00:33:29,900 --> 00:33:33,260
the third is red team logging so kind of

848
00:33:33,260 --> 00:33:35,180
a similar take to what we've done though

849
00:33:35,180 --> 00:33:38,360
this one used gray log the one after

850
00:33:38,360 --> 00:33:41,150
that is that htaccess file we referenced

851
00:33:41,150 --> 00:33:43,280
with all the known security vendor IPS

852
00:33:43,280 --> 00:33:45,920
and that last one is kind of the

853
00:33:45,920 --> 00:33:49,850
reference elk & elk stuff for ansible so

854
00:33:49,850 --> 00:33:51,860
these are all great resources that if

855
00:33:51,860 --> 00:33:53,000
you're going down this route you should

856
00:33:53,000 --> 00:34:04,220
check out yep so real quick well so this

857
00:34:04,220 --> 00:34:06,950
is the git repo that we put up this

858
00:34:06,950 --> 00:34:07,910
morning

859
00:34:07,910 --> 00:34:09,620
this is Evan was talking about we have

860
00:34:09,620 --> 00:34:12,469
everything up here we have a quick

861
00:34:12,469 --> 00:34:14,360
directory structure of sort of where

862
00:34:14,360 --> 00:34:17,030
things are outlined and then sort of a

863
00:34:17,030 --> 00:34:20,870
quick road map and then sort of inside

864
00:34:20,870 --> 00:34:22,940
of each of these folders are the

865
00:34:22,940 --> 00:34:25,100
different things that you need so if

866
00:34:25,100 --> 00:34:27,170
you're looking into the Alaska lured

867
00:34:27,170 --> 00:34:28,850
stuff here's the rules that we have for

868
00:34:28,850 --> 00:34:30,860
that quick description of sort of what

869
00:34:30,860 --> 00:34:33,290
everything does and you know the one

870
00:34:33,290 --> 00:34:35,420
caveat I will say is you know these

871
00:34:35,420 --> 00:34:36,980
these rules that you're putting together

872
00:34:36,980 --> 00:34:38,870
you'll you'll probably have to modify to

873
00:34:38,870 --> 00:34:40,699
sort of whatever use case you want so

874
00:34:40,699 --> 00:34:42,560
you might not necessarily want to alert

875
00:34:42,560 --> 00:34:44,840
on let's say like WMI usage from your

876
00:34:44,840 --> 00:34:46,520
red team or you want to have additional

877
00:34:46,520 --> 00:34:48,260
one so you can sort of go in and modify

878
00:34:48,260 --> 00:34:51,260
these to add in whatever you want to

879
00:34:51,260 --> 00:34:53,030
alert on but it at least gives you a

880
00:34:53,030 --> 00:34:57,490
simple configuration to start with

881
00:35:06,039 --> 00:35:10,640
so with that I know we finished a little

882
00:35:10,640 --> 00:35:13,549
bit early but we have a we have some

883
00:35:13,549 --> 00:35:17,230
time for questions if anyone has any

884
00:35:39,999 --> 00:35:43,279
yeah so we actually for this one and

885
00:35:43,279 --> 00:35:45,680
sort of the red team operators are sort

886
00:35:45,680 --> 00:35:46,819
of the blue team operators in this

887
00:35:46,819 --> 00:35:49,759
engagement so you know we don't have to

888
00:35:49,759 --> 00:35:52,819
worry about going in and Sara Lee

889
00:35:52,819 --> 00:35:54,529
patching things a lot of this has stood

890
00:35:54,529 --> 00:35:56,539
up right before the engagement starts so

891
00:35:56,539 --> 00:35:58,579
the majority of the updates and things

892
00:35:58,579 --> 00:36:01,249
we're gonna be using updated systems

893
00:36:01,249 --> 00:36:03,289
things like that the one thing that we

894
00:36:03,289 --> 00:36:05,509
would do is you know test against sort

895
00:36:05,509 --> 00:36:08,029
of your firewall configs making sure

896
00:36:08,029 --> 00:36:10,579
that your c2 servers are only accessible

897
00:36:10,579 --> 00:36:13,190
from let's say you know your source

898
00:36:13,190 --> 00:36:15,049
which is you know your VPN or something

899
00:36:15,049 --> 00:36:17,059
like that and your redirector is

900
00:36:17,059 --> 00:36:18,859
ensuring that you know no other traffic

901
00:36:18,859 --> 00:36:20,779
can get to it without going through sort

902
00:36:20,779 --> 00:36:23,210
of the approved means and you know it

903
00:36:23,210 --> 00:36:24,829
goes without saying making sure you're

904
00:36:24,829 --> 00:36:27,489
walking down anything doing everything

905
00:36:27,489 --> 00:36:30,019
you know sending things over securely

906
00:36:30,019 --> 00:36:31,999
doing the whole standard thing because

907
00:36:31,999 --> 00:36:33,859
you know the one thing that is within

908
00:36:33,859 --> 00:36:35,630
with red teams is you know there's a lot

909
00:36:35,630 --> 00:36:37,489
of sensitive data so ensuring that all

910
00:36:37,489 --> 00:36:39,200
of that is protected the entire way

911
00:36:39,200 --> 00:36:42,259
through so yes that is something that we

912
00:36:42,259 --> 00:36:44,859
do have to worry about

913
00:37:14,650 --> 00:37:25,160
yeah yeah so he was just saying that

914
00:37:25,160 --> 00:37:28,039
with a lot of you know Sims our elk in

915
00:37:28,039 --> 00:37:30,410
particular if you go ahead and do the

916
00:37:30,410 --> 00:37:32,420
five minutes of extra work that it takes

917
00:37:32,420 --> 00:37:34,759
to get all of your logs formatted into a

918
00:37:34,759 --> 00:37:37,849
JSON format and when it ships it over it

919
00:37:37,849 --> 00:37:42,099
gives you a lot of additional sort of

920
00:37:42,099 --> 00:37:44,599
capabilities with the sim itself so you

921
00:37:44,599 --> 00:37:45,950
get different values you can perform

922
00:37:45,950 --> 00:37:48,109
statistics on things like that so good

923
00:37:48,109 --> 00:37:50,348
point

924
00:38:04,190 --> 00:38:08,010
sure so a good question do we have any

925
00:38:08,010 --> 00:38:10,740
plans to implement alerts for things

926
00:38:10,740 --> 00:38:12,420
like honey tokens being you know pushed

927
00:38:12,420 --> 00:38:15,119
in that was one thing that we actually

928
00:38:15,119 --> 00:38:17,520
did not think about but it's definitely

929
00:38:17,520 --> 00:38:20,099
a move that I think a lot of instant

930
00:38:20,099 --> 00:38:21,720
responders and you know it's something

931
00:38:21,720 --> 00:38:23,220
that sans has sort of started pushing

932
00:38:23,220 --> 00:38:26,339
too so it's definitely a good idea to

933
00:38:26,339 --> 00:38:30,319
just sort to include so yeah good point

934
00:38:31,819 --> 00:38:38,760
any other questions all right well we'll

935
00:38:38,760 --> 00:38:40,559
be around after I'm just hanging out for

936
00:38:40,559 --> 00:38:42,320
a little bit so this

937
00:38:42,320 --> 00:38:48,519
[Applause]

