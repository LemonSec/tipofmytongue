1
00:00:00,399 --> 00:00:03,199
so a little bit about who i am um as you

2
00:00:03,199 --> 00:00:05,200
know my name is rick davis i'm a senior

3
00:00:05,200 --> 00:00:07,200
customer engineer with microsoft and

4
00:00:07,200 --> 00:00:08,960
what that means is i don't work

5
00:00:08,960 --> 00:00:10,960
internally i'm out working with our

6
00:00:10,960 --> 00:00:12,480
customers generally our largest

7
00:00:12,480 --> 00:00:14,880
enterprise customers everything from the

8
00:00:14,880 --> 00:00:17,119
very reactive such as incident response

9
00:00:17,119 --> 00:00:19,920
or threat hunting to the very proactive

10
00:00:19,920 --> 00:00:23,119
where i teach workshops i do assessments

11
00:00:23,119 --> 00:00:25,279
help customers deploy products design

12
00:00:25,279 --> 00:00:27,279
and architecture all of these kind of

13
00:00:27,279 --> 00:00:29,359
things over my career i've spent a

14
00:00:29,359 --> 00:00:31,840
tremendous amount of time with pki

15
00:00:31,840 --> 00:00:34,000
i probably spend about 30 percent of my

16
00:00:34,000 --> 00:00:35,440
time on it now

17
00:00:35,440 --> 00:00:38,320
it's been as high as 75 and 80 percent

18
00:00:38,320 --> 00:00:40,399
uh i have a hand in developing our

19
00:00:40,399 --> 00:00:42,719
workshops our assessments most of our

20
00:00:42,719 --> 00:00:45,520
proactive offerings around pki um if

21
00:00:45,520 --> 00:00:47,760
you're on twitter you can find me at the

22
00:00:47,760 --> 00:00:50,160
ratelin

23
00:00:50,160 --> 00:00:52,320
there with that said even though i work

24
00:00:52,320 --> 00:00:54,320
for microsoft and i i do like to mention

25
00:00:54,320 --> 00:00:56,480
it because cool company they're not

26
00:00:56,480 --> 00:00:59,199
representing here they didn't send me

27
00:00:59,199 --> 00:01:02,079
here all the thoughts opinions bad jokes

28
00:01:02,079 --> 00:01:04,879
sarcasm that's all mine so just like to

29
00:01:04,879 --> 00:01:06,720
call that out

30
00:01:06,720 --> 00:01:08,479
all right so

31
00:01:08,479 --> 00:01:10,960
why are we talking about pki

32
00:01:10,960 --> 00:01:13,200
over the last year in particular there's

33
00:01:13,200 --> 00:01:16,159
been a tremendous amount of press and

34
00:01:16,159 --> 00:01:18,880
new things happening um in

35
00:01:18,880 --> 00:01:22,159
relatively reverse order here

36
00:01:22,159 --> 00:01:24,560
golden certificate attacks new tools

37
00:01:24,560 --> 00:01:29,200
like certifried the pk in int

38
00:01:29,200 --> 00:01:31,600
patches vulnerabilities if you will and

39
00:01:31,600 --> 00:01:34,799
then tremendous work certified pre-owned

40
00:01:34,799 --> 00:01:36,960
that was put out amazing paper if you

41
00:01:36,960 --> 00:01:39,200
haven't seen that so all of these things

42
00:01:39,200 --> 00:01:41,840
are really great really good research

43
00:01:41,840 --> 00:01:42,720
really

44
00:01:42,720 --> 00:01:44,799
had a lot of organizations do a fire

45
00:01:44,799 --> 00:01:45,759
drill

46
00:01:45,759 --> 00:01:46,720
but

47
00:01:46,720 --> 00:01:49,119
there was kind of the problem of putting

48
00:01:49,119 --> 00:01:51,040
the cart before the horse

49
00:01:51,040 --> 00:01:52,560
so

50
00:01:52,560 --> 00:01:54,399
in all the time i've been working with

51
00:01:54,399 --> 00:01:56,640
pki i probably take a guess that i've

52
00:01:56,640 --> 00:02:00,159
seen about 600 or so different pki

53
00:02:00,159 --> 00:02:03,520
implementations in about 20 years

54
00:02:03,520 --> 00:02:04,560
and

55
00:02:04,560 --> 00:02:06,000
with all of that

56
00:02:06,000 --> 00:02:08,318
i see a lot of the same problems over

57
00:02:08,318 --> 00:02:10,318
and over and that's the purpose of this

58
00:02:10,318 --> 00:02:13,280
talk i want to call out a couple of the

59
00:02:13,280 --> 00:02:16,080
most common security and operational

60
00:02:16,080 --> 00:02:19,280
issues that i see because all of these

61
00:02:19,280 --> 00:02:20,879
new things happening they're really

62
00:02:20,879 --> 00:02:22,959
great and they're really things that you

63
00:02:22,959 --> 00:02:24,879
should pay attention to and deal with

64
00:02:24,879 --> 00:02:27,840
but if you haven't done the basic things

65
00:02:27,840 --> 00:02:29,599
it's not going to help a whole lot

66
00:02:29,599 --> 00:02:32,160
you're not going to get the roi in that

67
00:02:32,160 --> 00:02:33,200
and

68
00:02:33,200 --> 00:02:35,040
there's just better approaches so that's

69
00:02:35,040 --> 00:02:37,120
really the goal here i want to call out

70
00:02:37,120 --> 00:02:39,599
some of the big things that i see things

71
00:02:39,599 --> 00:02:42,080
that are very actionable things that

72
00:02:42,080 --> 00:02:44,480
anyone in an infrastructure or certainly

73
00:02:44,480 --> 00:02:47,280
a security role can go and look at and

74
00:02:47,280 --> 00:02:48,879
hopefully drive some change and

75
00:02:48,879 --> 00:02:50,879
improvement

76
00:02:50,879 --> 00:02:52,560
so with that said we'll start with just

77
00:02:52,560 --> 00:02:54,560
a little bit of kind of terminology

78
00:02:54,560 --> 00:02:56,720
around pki how a couple things work just

79
00:02:56,720 --> 00:02:58,879
at a high level just so we can level set

80
00:02:58,879 --> 00:03:00,400
everyone's knowledge make sure we're on

81
00:03:00,400 --> 00:03:02,560
the same page so if you look at a

82
00:03:02,560 --> 00:03:04,319
certificate in the gui on a windows

83
00:03:04,319 --> 00:03:06,239
system it'll look like this

84
00:03:06,239 --> 00:03:08,400
it's relatively straightforward all of

85
00:03:08,400 --> 00:03:10,000
the data that's represented there you

86
00:03:10,000 --> 00:03:12,159
can see on the command line and the same

87
00:03:12,159 --> 00:03:14,239
would be true in a linux environment or

88
00:03:14,239 --> 00:03:16,879
just about any other system so pki is

89
00:03:16,879 --> 00:03:18,640
standards-based so you're always going

90
00:03:18,640 --> 00:03:20,720
to see really the same fields and

91
00:03:20,720 --> 00:03:23,120
relatively the same structure and a

92
00:03:23,120 --> 00:03:24,799
couple items that are going to be very

93
00:03:24,799 --> 00:03:26,799
important for our discussion today

94
00:03:26,799 --> 00:03:29,280
the first is what we consider a subject

95
00:03:29,280 --> 00:03:31,519
or an identity so a certificate has to

96
00:03:31,519 --> 00:03:34,400
be issued to something

97
00:03:34,400 --> 00:03:37,120
after that we have who issued that

98
00:03:37,120 --> 00:03:38,879
certificate generally certificate

99
00:03:38,879 --> 00:03:41,680
authority and then finally

100
00:03:41,680 --> 00:03:43,920
a lifetime of the certificate so when a

101
00:03:43,920 --> 00:03:47,040
certificate gets issued by default it's

102
00:03:47,040 --> 00:03:49,920
going to have some time range baked in

103
00:03:49,920 --> 00:03:52,000
of when it's valid from and when it's

104
00:03:52,000 --> 00:03:54,720
valid until so keep these elements in

105
00:03:54,720 --> 00:03:56,239
mind because we're going to talk more

106
00:03:56,239 --> 00:03:58,080
about these as we go

107
00:03:58,080 --> 00:04:00,640
another big item that we'll talk around

108
00:04:00,640 --> 00:04:03,519
is what's called a crl a certificate

109
00:04:03,519 --> 00:04:05,040
revocation list

110
00:04:05,040 --> 00:04:06,720
so even though a certificate has a

111
00:04:06,720 --> 00:04:10,239
lifetime it can be revoked meaning an

112
00:04:10,239 --> 00:04:12,959
administrator can mark it as not to be

113
00:04:12,959 --> 00:04:15,360
trusted not to be used before it would

114
00:04:15,360 --> 00:04:18,160
naturally expire so the idea is let's

115
00:04:18,160 --> 00:04:20,478
say i issue a certificate to a server

116
00:04:20,478 --> 00:04:22,639
and that certificate is good for a year

117
00:04:22,639 --> 00:04:24,639
but two months later for whatever reason

118
00:04:24,639 --> 00:04:26,479
that server needs to be decommissioned

119
00:04:26,479 --> 00:04:28,639
and it's no longer used i shouldn't let

120
00:04:28,639 --> 00:04:31,280
that certificate live another 10 months

121
00:04:31,280 --> 00:04:33,440
i should revoke that certificate just

122
00:04:33,440 --> 00:04:35,440
good care and feeding of the environment

123
00:04:35,440 --> 00:04:37,440
now a lot of times that doesn't happen

124
00:04:37,440 --> 00:04:39,280
but it should

125
00:04:39,280 --> 00:04:41,919
the crls have to be somewhere where

126
00:04:41,919 --> 00:04:44,400
clients can get to them and that's what

127
00:04:44,400 --> 00:04:46,479
we're illustrating here one of the

128
00:04:46,479 --> 00:04:48,960
fields in every certificate instructs

129
00:04:48,960 --> 00:04:52,080
the client where to go to get that crl

130
00:04:52,080 --> 00:04:54,880
when it's checking a certificate so when

131
00:04:54,880 --> 00:04:57,520
we think about checking a certificate

132
00:04:57,520 --> 00:04:59,199
what happens

133
00:04:59,199 --> 00:05:02,000
a couple key items first we do a subject

134
00:05:02,000 --> 00:05:04,720
verification so if i go to

135
00:05:04,720 --> 00:05:07,720
www.microsoft.com

136
00:05:08,880 --> 00:05:10,960
i'm going to get presented a certificate

137
00:05:10,960 --> 00:05:13,440
in the browser and that certificate has

138
00:05:13,440 --> 00:05:16,880
to be issued to www.microsoft.com

139
00:05:16,880 --> 00:05:19,199
or an acceptable wild card and if it's

140
00:05:19,199 --> 00:05:21,520
not i'm going to get a warning

141
00:05:21,520 --> 00:05:23,280
now a browser is kind of a special case

142
00:05:23,280 --> 00:05:25,360
because i am going to get a warning and

143
00:05:25,360 --> 00:05:27,280
like any user i'm just going to click ok

144
00:05:27,280 --> 00:05:30,000
and it's going to keep going but most

145
00:05:30,000 --> 00:05:32,160
things that use a certificate happen

146
00:05:32,160 --> 00:05:34,880
programmatically so any failure stops

147
00:05:34,880 --> 00:05:37,199
something from happening but

148
00:05:37,199 --> 00:05:39,199
there's always that subject check we

149
00:05:39,199 --> 00:05:41,199
always make sure that verification is

150
00:05:41,199 --> 00:05:44,320
correct and then we check the time so is

151
00:05:44,320 --> 00:05:46,720
today's date and time between that valid

152
00:05:46,720 --> 00:05:50,240
from and valid to field so very quick

153
00:05:50,240 --> 00:05:52,240
checks that happen right off the bat and

154
00:05:52,240 --> 00:05:54,639
then there's that big revocation check

155
00:05:54,639 --> 00:05:56,240
so we'll talk a little bit more about

156
00:05:56,240 --> 00:05:57,039
this

157
00:05:57,039 --> 00:05:59,360
this is a really big deal

158
00:05:59,360 --> 00:06:01,440
this is one of the biggest reasons that

159
00:06:01,440 --> 00:06:04,560
pkis go down and outages with

160
00:06:04,560 --> 00:06:07,680
enterprises that relate to pkis go down

161
00:06:07,680 --> 00:06:09,759
the revocation information is very

162
00:06:09,759 --> 00:06:11,759
important regardless of the structure

163
00:06:11,759 --> 00:06:13,680
and the size of your pki

164
00:06:13,680 --> 00:06:15,840
every certificate authority has to be

165
00:06:15,840 --> 00:06:19,280
creating these crls and clients have to

166
00:06:19,280 --> 00:06:21,840
go and get them and they have to check

167
00:06:21,840 --> 00:06:24,080
any time a certificate is used to see if

168
00:06:24,080 --> 00:06:26,639
it's been revoked even if i checked 10

169
00:06:26,639 --> 00:06:27,759
minutes ago

170
00:06:27,759 --> 00:06:29,280
it might have been revoked eight minutes

171
00:06:29,280 --> 00:06:31,840
ago and there's some differences in how

172
00:06:31,840 --> 00:06:34,479
that's configured the timing how often

173
00:06:34,479 --> 00:06:36,800
they're issued how clients can cache

174
00:06:36,800 --> 00:06:39,039
them there's a lot of complexity there

175
00:06:39,039 --> 00:06:42,240
but one way or another clients have to

176
00:06:42,240 --> 00:06:44,080
feel that they've done that check

177
00:06:44,080 --> 00:06:46,319
according to the rules of the system and

178
00:06:46,319 --> 00:06:48,240
make sure that the certificate hasn't

179
00:06:48,240 --> 00:06:50,960
been revoked

180
00:06:51,840 --> 00:06:53,840
okay just got brighter

181
00:06:53,840 --> 00:06:55,520
all right so

182
00:06:55,520 --> 00:06:59,039
i would argue crls then are the most

183
00:06:59,039 --> 00:07:01,360
important part of a pki

184
00:07:01,360 --> 00:07:03,840
i've been at large organizations and

185
00:07:03,840 --> 00:07:06,319
i've seen crl's fail

186
00:07:06,319 --> 00:07:08,880
either they become unavailable

187
00:07:08,880 --> 00:07:11,360
someone drops a network rule or changes

188
00:07:11,360 --> 00:07:13,039
permissions to where they are supposed

189
00:07:13,039 --> 00:07:16,240
to live any of those kind of things crl

190
00:07:16,240 --> 00:07:18,479
is going down or being unavailable for a

191
00:07:18,479 --> 00:07:21,039
couple hours i've seen cost enterprises

192
00:07:21,039 --> 00:07:23,919
hundreds of millions of dollars so

193
00:07:23,919 --> 00:07:25,919
most organizations if you have an

194
00:07:25,919 --> 00:07:27,599
internal pki

195
00:07:27,599 --> 00:07:28,880
it's a critical piece of the

196
00:07:28,880 --> 00:07:31,440
infrastructure just like email just like

197
00:07:31,440 --> 00:07:34,160
domain services but most organizations

198
00:07:34,160 --> 00:07:36,080
don't treat it that way

199
00:07:36,080 --> 00:07:40,560
so when there's a problem it's big

200
00:07:40,560 --> 00:07:42,840
if the crl itself is

201
00:07:42,840 --> 00:07:46,560
expired certificates will fail by design

202
00:07:46,560 --> 00:07:48,560
because if i need to trust this

203
00:07:48,560 --> 00:07:51,120
certificate i need to know if it's been

204
00:07:51,120 --> 00:07:52,160
revoked

205
00:07:52,160 --> 00:07:54,560
but if i can't check to see if it's been

206
00:07:54,560 --> 00:07:55,599
revoked

207
00:07:55,599 --> 00:07:57,919
i'm not going to trust the certificate i

208
00:07:57,919 --> 00:08:00,240
would much rather not trust a

209
00:08:00,240 --> 00:08:02,560
certificate that may still be valid and

210
00:08:02,560 --> 00:08:05,280
trustworthy then possibly accept one

211
00:08:05,280 --> 00:08:07,520
that's been revoked because pki is a

212
00:08:07,520 --> 00:08:09,199
system of trust

213
00:08:09,199 --> 00:08:10,800
in addition to that

214
00:08:10,800 --> 00:08:14,080
if you can't find the crls same thing

215
00:08:14,080 --> 00:08:15,599
it's the same thing as them not being

216
00:08:15,599 --> 00:08:16,400
there

217
00:08:16,400 --> 00:08:19,360
if the crls are misnamed misconfigured

218
00:08:19,360 --> 00:08:22,160
in any way if it does not match up to

219
00:08:22,160 --> 00:08:24,000
what the client expects when they go to

220
00:08:24,000 --> 00:08:26,319
do that check that certificate's going

221
00:08:26,319 --> 00:08:27,360
to fail

222
00:08:27,360 --> 00:08:28,240
so

223
00:08:28,240 --> 00:08:32,799
these crls are incredibly important

224
00:08:32,799 --> 00:08:34,719
so that brings us to

225
00:08:34,719 --> 00:08:37,440
the biggest problem that i see out there

226
00:08:37,440 --> 00:08:41,039
operational issues around these crl

227
00:08:41,039 --> 00:08:43,440
so the cdp

228
00:08:43,440 --> 00:08:47,680
the cdp is the crl distribution point so

229
00:08:47,680 --> 00:08:50,160
if we think back a few slides to

230
00:08:50,160 --> 00:08:52,959
that screen clip of a certificate and it

231
00:08:52,959 --> 00:08:55,839
had that locations of crls that's what

232
00:08:55,839 --> 00:08:58,800
the cdp is so the cdp is the set of

233
00:08:58,800 --> 00:09:01,040
locations where clients can go and get

234
00:09:01,040 --> 00:09:02,560
these crls

235
00:09:02,560 --> 00:09:06,080
and ideally there is a lot to it it's

236
00:09:06,080 --> 00:09:08,399
not just one file server somewhere and

237
00:09:08,399 --> 00:09:10,640
hopefully it's not any actual file

238
00:09:10,640 --> 00:09:11,760
server

239
00:09:11,760 --> 00:09:14,800
so when you look at that list

240
00:09:14,800 --> 00:09:17,120
you've got a number of different options

241
00:09:17,120 --> 00:09:19,279
these options get figured configured at

242
00:09:19,279 --> 00:09:21,760
the ca level so if you have a number of

243
00:09:21,760 --> 00:09:23,680
different cas you're going to configure

244
00:09:23,680 --> 00:09:26,000
all these per ca

245
00:09:26,000 --> 00:09:27,120
some of the things that you might

246
00:09:27,120 --> 00:09:30,480
consider is how long the crl is going to

247
00:09:30,480 --> 00:09:34,160
live different types of crls and

248
00:09:34,160 --> 00:09:37,600
where the crl lives specifically there's

249
00:09:37,600 --> 00:09:39,920
a lot of options it could be

250
00:09:39,920 --> 00:09:43,279
sent over an http protocol on an iis

251
00:09:43,279 --> 00:09:45,680
system or something similar it can be

252
00:09:45,680 --> 00:09:47,680
stored in active directory so an ldap

253
00:09:47,680 --> 00:09:50,959
location in some cases it can be a file

254
00:09:50,959 --> 00:09:54,880
system an ftp all of these other things

255
00:09:54,880 --> 00:09:57,040
the key with this is we don't want

256
00:09:57,040 --> 00:09:59,519
points of failure and a lot of times

257
00:09:59,519 --> 00:10:02,000
pkis get built by someone following a

258
00:10:02,000 --> 00:10:04,480
guide online and clicking next next next

259
00:10:04,480 --> 00:10:06,800
next and yeah that works you're going to

260
00:10:06,800 --> 00:10:08,320
have a ca and it's going to issue

261
00:10:08,320 --> 00:10:10,640
certificates but when things go wrong

262
00:10:10,640 --> 00:10:13,360
they're going to go really wrong

263
00:10:13,360 --> 00:10:15,760
generally for design and architecture of

264
00:10:15,760 --> 00:10:17,200
a pki

265
00:10:17,200 --> 00:10:19,040
for an average organization is probably

266
00:10:19,040 --> 00:10:20,959
six months of work and it's white

267
00:10:20,959 --> 00:10:22,720
boarding it's discussions with different

268
00:10:22,720 --> 00:10:25,120
teams you can script out and build a

269
00:10:25,120 --> 00:10:27,760
whole pki in five or ten minutes but you

270
00:10:27,760 --> 00:10:30,480
need all of that good design work to get

271
00:10:30,480 --> 00:10:33,600
this right so

272
00:10:33,600 --> 00:10:35,920
that's our problem the problem is there

273
00:10:35,920 --> 00:10:38,640
are points of failure within these

274
00:10:38,640 --> 00:10:39,920
locations

275
00:10:39,920 --> 00:10:41,120
so

276
00:10:41,120 --> 00:10:43,279
more specifically what do we see and

277
00:10:43,279 --> 00:10:45,279
what can we do about them

278
00:10:45,279 --> 00:10:47,839
so one is out-of-band movement of the

279
00:10:47,839 --> 00:10:49,600
crl files

280
00:10:49,600 --> 00:10:52,560
so every ca has to make these files and

281
00:10:52,560 --> 00:10:55,279
what they should be doing is the ca

282
00:10:55,279 --> 00:10:57,200
should be configured to write the files

283
00:10:57,200 --> 00:10:59,040
directly where they're supposed to go

284
00:10:59,040 --> 00:11:01,839
directly to wherever the clients expect

285
00:11:01,839 --> 00:11:04,880
to go and find them so those iis boxes

286
00:11:04,880 --> 00:11:06,959
or the ldap locations or whatever that

287
00:11:06,959 --> 00:11:08,160
happens to be

288
00:11:08,160 --> 00:11:09,760
a lot of times i don't see that

289
00:11:09,760 --> 00:11:10,800
happening

290
00:11:10,800 --> 00:11:13,040
we see clients write the file just to

291
00:11:13,040 --> 00:11:14,480
the local file system

292
00:11:14,480 --> 00:11:16,399
and then they use some script or other

293
00:11:16,399 --> 00:11:18,480
process to move that file where it needs

294
00:11:18,480 --> 00:11:19,360
to go

295
00:11:19,360 --> 00:11:22,000
generally a bad idea and why is that

296
00:11:22,000 --> 00:11:24,959
so the cas do a really good job of

297
00:11:24,959 --> 00:11:26,640
letting you know when something's going

298
00:11:26,640 --> 00:11:29,360
wrong if you look for that but if you're

299
00:11:29,360 --> 00:11:31,760
now relying on something out of band the

300
00:11:31,760 --> 00:11:33,920
ca doesn't know that if you tell the ca

301
00:11:33,920 --> 00:11:35,600
just write it to the local file system

302
00:11:35,600 --> 00:11:36,959
because then you're going to move it

303
00:11:36,959 --> 00:11:38,800
well it does that it does its job and it

304
00:11:38,800 --> 00:11:40,560
thinks everything is happy it doesn't

305
00:11:40,560 --> 00:11:42,959
actually know if that file gets there so

306
00:11:42,959 --> 00:11:44,720
you're introducing more things that go

307
00:11:44,720 --> 00:11:45,680
wrong

308
00:11:45,680 --> 00:11:48,079
you could have a script now that could

309
00:11:48,079 --> 00:11:51,360
break something with permissions on that

310
00:11:51,360 --> 00:11:54,000
script or the location or

311
00:11:54,000 --> 00:11:56,000
in really bad cases that script gets

312
00:11:56,000 --> 00:11:58,079
hijacked by an attacker or some other

313
00:11:58,079 --> 00:12:00,240
process and it becomes a way to escalate

314
00:12:00,240 --> 00:12:03,120
privilege so all of this adds complexity

315
00:12:03,120 --> 00:12:05,279
that didn't need to be there because the

316
00:12:05,279 --> 00:12:08,079
ca already knows how to do this it knows

317
00:12:08,079 --> 00:12:10,880
how to write the file so this is a big

318
00:12:10,880 --> 00:12:13,120
problem we see this a lot and this

319
00:12:13,120 --> 00:12:14,639
shouldn't happen the ca should be

320
00:12:14,639 --> 00:12:17,360
writing the file where it needs to go

321
00:12:17,360 --> 00:12:19,360
in addition to that

322
00:12:19,360 --> 00:12:22,000
we see this concept of really kind of

323
00:12:22,000 --> 00:12:24,240
putting all of your eggs in one basket

324
00:12:24,240 --> 00:12:27,120
so even though the ca itself could

325
00:12:27,120 --> 00:12:30,160
actually host these crls so you can run

326
00:12:30,160 --> 00:12:33,360
iis on a ca but you shouldn't

327
00:12:33,360 --> 00:12:35,440
again points of failure

328
00:12:35,440 --> 00:12:36,160
so

329
00:12:36,160 --> 00:12:39,279
if i have a separate server that hosts

330
00:12:39,279 --> 00:12:42,880
my crls and my ca goes down i do have

331
00:12:42,880 --> 00:12:45,360
some problems so obviously if that ca is

332
00:12:45,360 --> 00:12:48,160
down i can't issue new certificates i

333
00:12:48,160 --> 00:12:51,040
can't re i can't revoke certificates i

334
00:12:51,040 --> 00:12:54,560
can't renew any certificates but my crls

335
00:12:54,560 --> 00:12:57,040
are somewhere out there safe likely with

336
00:12:57,040 --> 00:13:00,000
a lifetime of days or more so any

337
00:13:00,000 --> 00:13:02,800
certificate that's still out there works

338
00:13:02,800 --> 00:13:04,720
just fine so i haven't really taken the

339
00:13:04,720 --> 00:13:07,839
enterprise down but if i put everything

340
00:13:07,839 --> 00:13:09,279
on the ca

341
00:13:09,279 --> 00:13:11,600
now if the ca goes down i've lost

342
00:13:11,600 --> 00:13:13,760
everything so

343
00:13:13,760 --> 00:13:16,320
within pki there's a number of different

344
00:13:16,320 --> 00:13:18,560
roles and ancillary services that you

345
00:13:18,560 --> 00:13:20,959
might use outside of the certificate

346
00:13:20,959 --> 00:13:23,519
authority itself and the recommendation

347
00:13:23,519 --> 00:13:26,079
is generally to separate all of those

348
00:13:26,079 --> 00:13:27,200
roles

349
00:13:27,200 --> 00:13:29,200
they all have a vastly different attack

350
00:13:29,200 --> 00:13:31,680
surface different ports and protocols

351
00:13:31,680 --> 00:13:33,839
you might need different places at the

352
00:13:33,839 --> 00:13:36,079
enterprise different parts of a tier

353
00:13:36,079 --> 00:13:38,720
model so they should all be separated

354
00:13:38,720 --> 00:13:41,360
for that reason as far as the pki is

355
00:13:41,360 --> 00:13:44,000
concerned you separate that out to avoid

356
00:13:44,000 --> 00:13:47,120
these points of failure

357
00:13:47,199 --> 00:13:50,240
poor location design is

358
00:13:50,240 --> 00:13:52,399
probably the most important thing to

359
00:13:52,399 --> 00:13:55,440
consider and this is a little bit harder

360
00:13:55,440 --> 00:13:57,360
to wrap your head around

361
00:13:57,360 --> 00:13:59,920
so when we say location design is the

362
00:13:59,920 --> 00:14:02,480
location where these crls live

363
00:14:02,480 --> 00:14:04,720
there's a lot of different types and

364
00:14:04,720 --> 00:14:07,839
there's a lot of places where redundancy

365
00:14:07,839 --> 00:14:09,600
doesn't get noticed

366
00:14:09,600 --> 00:14:12,320
we want redundancy within a location

367
00:14:12,320 --> 00:14:16,480
type and between a location type when

368
00:14:16,480 --> 00:14:18,880
you configure these at the ca you

369
00:14:18,880 --> 00:14:21,600
configure them as a list it's an ordered

370
00:14:21,600 --> 00:14:24,959
list the client parses them specifically

371
00:14:24,959 --> 00:14:26,880
in the list as they're defined and this

372
00:14:26,880 --> 00:14:29,199
order matters so think about this for a

373
00:14:29,199 --> 00:14:30,720
second

374
00:14:30,720 --> 00:14:32,639
let's say that i'm using two kinds of

375
00:14:32,639 --> 00:14:35,760
locations i'm storing my crls on a web

376
00:14:35,760 --> 00:14:36,880
server

377
00:14:36,880 --> 00:14:38,720
and i'm storing my crls in active

378
00:14:38,720 --> 00:14:41,199
directory so an ldap location and let's

379
00:14:41,199 --> 00:14:43,360
say i have the ldap location listed

380
00:14:43,360 --> 00:14:44,639
first

381
00:14:44,639 --> 00:14:47,760
so what happens if i have a client on

382
00:14:47,760 --> 00:14:50,560
the domain and tries to get the crl so

383
00:14:50,560 --> 00:14:52,320
hopefully everything is great for them

384
00:14:52,320 --> 00:14:54,000
because they're on the domain

385
00:14:54,000 --> 00:14:56,160
domain controllers talk with everything

386
00:14:56,160 --> 00:14:58,240
they converge very quickly so that

387
00:14:58,240 --> 00:15:00,560
client is really happy they're able to

388
00:15:00,560 --> 00:15:02,320
get to those crl

389
00:15:02,320 --> 00:15:05,120
but what happens if i have a linux

390
00:15:05,120 --> 00:15:07,519
device or a mobile device something that

391
00:15:07,519 --> 00:15:10,079
can't or that i won't allow to bind to

392
00:15:10,079 --> 00:15:12,320
ldap to get that information so what

393
00:15:12,320 --> 00:15:14,160
happens in that case is eventually it's

394
00:15:14,160 --> 00:15:16,000
going to time out and there are some

395
00:15:16,000 --> 00:15:18,160
values built in for that

396
00:15:18,160 --> 00:15:21,600
in this list of crl locations by default

397
00:15:21,600 --> 00:15:25,040
you get 20 seconds for a timeout and

398
00:15:25,040 --> 00:15:28,079
it's separated out by the number of

399
00:15:28,079 --> 00:15:30,560
locations in that list so the first

400
00:15:30,560 --> 00:15:32,639
location in that list will wait up to 10

401
00:15:32,639 --> 00:15:35,040
seconds for a timeout and then it's half

402
00:15:35,040 --> 00:15:37,680
the remaining time of that maximum so

403
00:15:37,680 --> 00:15:40,880
with a 20 second maximum by default you

404
00:15:40,880 --> 00:15:43,519
get 10 seconds for the first location

405
00:15:43,519 --> 00:15:45,440
five seconds for the next two and a half

406
00:15:45,440 --> 00:15:47,279
seconds and so on

407
00:15:47,279 --> 00:15:48,079
now

408
00:15:48,079 --> 00:15:49,440
most cases

409
00:15:49,440 --> 00:15:52,240
this check happens very very quickly and

410
00:15:52,240 --> 00:15:54,639
clients cache this information based on

411
00:15:54,639 --> 00:15:57,120
the configuration so if everyone was

412
00:15:57,120 --> 00:15:59,279
waiting 10 seconds for every crl check

413
00:15:59,279 --> 00:16:01,920
the internet would grind to a halt but

414
00:16:01,920 --> 00:16:04,079
it's a maximum wait time

415
00:16:04,079 --> 00:16:06,000
so if i have something that can't talk

416
00:16:06,000 --> 00:16:08,320
to active directory it might be able to

417
00:16:08,320 --> 00:16:10,079
figure that out very quickly or

418
00:16:10,079 --> 00:16:12,480
potentially it could wait that maximum

419
00:16:12,480 --> 00:16:15,199
time out not a good experience

420
00:16:15,199 --> 00:16:16,079
but

421
00:16:16,079 --> 00:16:18,399
there's a bigger problem with that

422
00:16:18,399 --> 00:16:21,360
if my two locations were ldap and a web

423
00:16:21,360 --> 00:16:22,720
server

424
00:16:22,720 --> 00:16:25,440
if that ldap location is not available

425
00:16:25,440 --> 00:16:27,600
for some group of clients in effect i've

426
00:16:27,600 --> 00:16:29,920
designed in a point of failure i've

427
00:16:29,920 --> 00:16:32,240
designed in a lack of redundancy because

428
00:16:32,240 --> 00:16:34,560
now the only place those clients can go

429
00:16:34,560 --> 00:16:36,880
to are my web servers

430
00:16:36,880 --> 00:16:37,680
and

431
00:16:37,680 --> 00:16:39,360
if they go down or they become

432
00:16:39,360 --> 00:16:42,399
unavailable i don't have anything else

433
00:16:42,399 --> 00:16:45,839
so having an ldap location and an http

434
00:16:45,839 --> 00:16:48,880
location gives me redundancy between

435
00:16:48,880 --> 00:16:52,160
those locations and ldap itself provides

436
00:16:52,160 --> 00:16:55,120
redundancy within its location

437
00:16:55,120 --> 00:16:58,079
but that http location and on its own is

438
00:16:58,079 --> 00:16:59,279
a problem

439
00:16:59,279 --> 00:17:00,000
so

440
00:17:00,000 --> 00:17:02,320
a lot of times organizations will make

441
00:17:02,320 --> 00:17:05,760
multiple http clusters and this is a big

442
00:17:05,760 --> 00:17:07,679
point in design and architecture usually

443
00:17:07,679 --> 00:17:09,359
one of the biggest decisions that you'll

444
00:17:09,359 --> 00:17:11,199
face so

445
00:17:11,199 --> 00:17:13,199
we can do some things to make it better

446
00:17:13,199 --> 00:17:15,359
right off the bat we can make multiple

447
00:17:15,359 --> 00:17:17,679
iis boxes put a behind a vip and a load

448
00:17:17,679 --> 00:17:20,480
balancer but we still have that one url

449
00:17:20,480 --> 00:17:22,319
that we're hitting so

450
00:17:22,319 --> 00:17:25,359
we can use gtm and ltm technologies if

451
00:17:25,359 --> 00:17:26,799
we have other data centers or we're

452
00:17:26,799 --> 00:17:29,120
leveraging the cloud but more than

453
00:17:29,120 --> 00:17:30,559
likely we're still going to want

454
00:17:30,559 --> 00:17:32,640
multiple groupings of these systems in

455
00:17:32,640 --> 00:17:36,559
effect multiple locations so when i say

456
00:17:36,559 --> 00:17:38,720
http it's important to note we're not

457
00:17:38,720 --> 00:17:40,080
talking about a website that you're

458
00:17:40,080 --> 00:17:42,320
going to go to even though that can be

459
00:17:42,320 --> 00:17:44,720
made available it's not the intention

460
00:17:44,720 --> 00:17:47,280
we're simply using the http protocol to

461
00:17:47,280 --> 00:17:49,440
pass data around because it's very

462
00:17:49,440 --> 00:17:51,440
firewall and proxy friendly it's easy to

463
00:17:51,440 --> 00:17:54,240
monitor and every system every operating

464
00:17:54,240 --> 00:17:56,640
system embedded devices everything knows

465
00:17:56,640 --> 00:17:58,880
how to deal with http

466
00:17:58,880 --> 00:18:01,600
so this is one of the big problems with

467
00:18:01,600 --> 00:18:03,200
these locations

468
00:18:03,200 --> 00:18:05,760
a big decision point is do we even use

469
00:18:05,760 --> 00:18:07,360
ldap at all

470
00:18:07,360 --> 00:18:09,200
seven and ten years ago

471
00:18:09,200 --> 00:18:10,559
we wouldn't even ask the question

472
00:18:10,559 --> 00:18:12,160
everyone was using it it made a lot of

473
00:18:12,160 --> 00:18:13,280
sense

474
00:18:13,280 --> 00:18:15,679
now in the last three to five years i

475
00:18:15,679 --> 00:18:18,480
see fewer and fewer new implementations

476
00:18:18,480 --> 00:18:21,280
of pki using an ldap location

477
00:18:21,280 --> 00:18:23,200
just for that reason because everything

478
00:18:23,200 --> 00:18:25,840
can use an http location not everything

479
00:18:25,840 --> 00:18:28,480
can use an ldap location now if you have

480
00:18:28,480 --> 00:18:30,160
a large pki

481
00:18:30,160 --> 00:18:32,640
and you have some cas that you know are

482
00:18:32,640 --> 00:18:35,919
only issuing to domain based users and

483
00:18:35,919 --> 00:18:37,760
systems then it makes a lot of sense to

484
00:18:37,760 --> 00:18:40,320
use that location and that can be

485
00:18:40,320 --> 00:18:42,160
something that you think about as well

486
00:18:42,160 --> 00:18:44,480
because all of these settings are

487
00:18:44,480 --> 00:18:46,559
specific to a ca

488
00:18:46,559 --> 00:18:48,320
one of the reasons that you might have

489
00:18:48,320 --> 00:18:51,440
multiple cas are to change these kind of

490
00:18:51,440 --> 00:18:53,440
configurations based on the clients that

491
00:18:53,440 --> 00:18:55,760
they're serving but it is a tremendously

492
00:18:55,760 --> 00:18:58,720
big decision point

493
00:18:58,880 --> 00:19:01,520
and then we have that overall lack of

494
00:19:01,520 --> 00:19:04,400
redundancy so regardless of the

495
00:19:04,400 --> 00:19:07,679
locations that i use regardless of what

496
00:19:07,679 --> 00:19:10,880
i design you have to think through

497
00:19:10,880 --> 00:19:13,760
are there enough options and this is a

498
00:19:13,760 --> 00:19:15,760
tough question because you're never

499
00:19:15,760 --> 00:19:17,840
going to feel like you really came up

500
00:19:17,840 --> 00:19:20,400
with a good answer there's really no

501
00:19:20,400 --> 00:19:22,799
cookie cutter approach with pki

502
00:19:22,799 --> 00:19:25,200
it's very dependent on the needs that

503
00:19:25,200 --> 00:19:27,039
you have the kind of certificates you

504
00:19:27,039 --> 00:19:29,200
want to issue the design of your

505
00:19:29,200 --> 00:19:31,200
architecture in general and a lot of

506
00:19:31,200 --> 00:19:33,520
other things go into that so what's

507
00:19:33,520 --> 00:19:35,440
right for organization one will

508
00:19:35,440 --> 00:19:37,679
certainly not be right for number two or

509
00:19:37,679 --> 00:19:40,640
three or whatever i've been doing this

510
00:19:40,640 --> 00:19:43,120
for decades and i regularly see new

511
00:19:43,120 --> 00:19:45,440
things new designs that just weren't

512
00:19:45,440 --> 00:19:47,039
appropriate anywhere else and maybe i

513
00:19:47,039 --> 00:19:50,080
won't see it again so there's so much

514
00:19:50,080 --> 00:19:52,080
design and architecture work that has to

515
00:19:52,080 --> 00:19:54,480
go into doing this right for your

516
00:19:54,480 --> 00:19:55,760
organization

517
00:19:55,760 --> 00:19:58,320
but regardless of what's there

518
00:19:58,320 --> 00:20:00,480
you should be able to take a look and

519
00:20:00,480 --> 00:20:01,600
have a little bit of a thought

520
00:20:01,600 --> 00:20:03,600
experiment and figure out

521
00:20:03,600 --> 00:20:06,720
well if this goes down what else can the

522
00:20:06,720 --> 00:20:08,559
client do if this location goes down

523
00:20:08,559 --> 00:20:10,960
what else can the client do do i have

524
00:20:10,960 --> 00:20:13,360
more than one location so things that

525
00:20:13,360 --> 00:20:15,039
you can think through you don't

526
00:20:15,039 --> 00:20:18,559
necessarily need privileges on the pki

527
00:20:18,559 --> 00:20:21,200
or the cas to see these kind of settings

528
00:20:21,200 --> 00:20:22,240
because they're baked into the

529
00:20:22,240 --> 00:20:24,640
certificates now hopefully you have some

530
00:20:24,640 --> 00:20:27,280
of this documented not only the settings

531
00:20:27,280 --> 00:20:29,600
but the reasoning behind why it was done

532
00:20:29,600 --> 00:20:31,760
the way it was done and if no one can

533
00:20:31,760 --> 00:20:33,840
answer that it's time to maybe have some

534
00:20:33,840 --> 00:20:35,679
more design work and discussions around

535
00:20:35,679 --> 00:20:37,840
it

536
00:20:38,159 --> 00:20:39,760
so

537
00:20:39,760 --> 00:20:41,760
as good as you can be with the design

538
00:20:41,760 --> 00:20:44,400
and the architecture

539
00:20:44,400 --> 00:20:46,480
at the end of the day you've got

540
00:20:46,480 --> 00:20:49,039
locations that exist outside of the pki

541
00:20:49,039 --> 00:20:52,159
itself so we rely on these iis boxes or

542
00:20:52,159 --> 00:20:55,679
ldap so that means that forces outside

543
00:20:55,679 --> 00:20:59,360
of the pki can wreck your crls as well a

544
00:20:59,360 --> 00:21:01,760
network change that blocks access to

545
00:21:01,760 --> 00:21:03,200
these locations

546
00:21:03,200 --> 00:21:05,280
a permissions change on where you're

547
00:21:05,280 --> 00:21:07,039
storing the files

548
00:21:07,039 --> 00:21:08,159
um

549
00:21:08,159 --> 00:21:10,720
a dns change to one of the vips you know

550
00:21:10,720 --> 00:21:12,559
it's never dns so that couldn't happen

551
00:21:12,559 --> 00:21:13,679
but

552
00:21:13,679 --> 00:21:15,200
all of these things outside of the

553
00:21:15,200 --> 00:21:17,919
control of the pki and probably the pki

554
00:21:17,919 --> 00:21:20,559
team isn't really looking for it but you

555
00:21:20,559 --> 00:21:22,559
want to be looking for it you need a way

556
00:21:22,559 --> 00:21:25,760
to monitor that so either getting that

557
00:21:25,760 --> 00:21:29,280
visibility to the pki team or a knock or

558
00:21:29,280 --> 00:21:30,799
a sock depending on what your

559
00:21:30,799 --> 00:21:33,360
organization has so you want a way to

560
00:21:33,360 --> 00:21:34,240
know

561
00:21:34,240 --> 00:21:36,000
from the outside from the client's

562
00:21:36,000 --> 00:21:37,919
perspective you know is everything look

563
00:21:37,919 --> 00:21:41,280
normal is everything still accessible

564
00:21:41,280 --> 00:21:42,320
all right

565
00:21:42,320 --> 00:21:45,840
so then switching gears a little bit

566
00:21:46,000 --> 00:21:48,080
that's the big operational side we'll

567
00:21:48,080 --> 00:21:50,000
talk about a big item on the security

568
00:21:50,000 --> 00:21:51,840
side and for the most part it's

569
00:21:51,840 --> 00:21:53,760
privilege and permissions

570
00:21:53,760 --> 00:21:54,720
and

571
00:21:54,720 --> 00:21:57,600
it's really important

572
00:21:57,600 --> 00:21:58,720
cas

573
00:21:58,720 --> 00:22:00,640
specifically but really the pki as a

574
00:22:00,640 --> 00:22:01,840
whole

575
00:22:01,840 --> 00:22:03,760
is probably the next most important

576
00:22:03,760 --> 00:22:06,400
thing after your domain controllers

577
00:22:06,400 --> 00:22:08,000
by that i mean if an attacker

578
00:22:08,000 --> 00:22:09,919
compromises a ca

579
00:22:09,919 --> 00:22:11,919
they're going to own everything as if

580
00:22:11,919 --> 00:22:14,480
they compromised a domain controller

581
00:22:14,480 --> 00:22:16,640
more than that it's going to be very

582
00:22:16,640 --> 00:22:18,320
hard to notice

583
00:22:18,320 --> 00:22:20,799
most pki is kind of treated like a black

584
00:22:20,799 --> 00:22:22,960
box a little bit it seems like magic to

585
00:22:22,960 --> 00:22:24,400
a lot of people

586
00:22:24,400 --> 00:22:26,159
people don't know it very well but

587
00:22:26,159 --> 00:22:28,000
attackers know it with all the new

588
00:22:28,000 --> 00:22:30,559
research and tools there's a lot of ways

589
00:22:30,559 --> 00:22:31,919
so

590
00:22:31,919 --> 00:22:34,320
pki and certificate authorities are what

591
00:22:34,320 --> 00:22:36,880
we consider a tier zero resource just

592
00:22:36,880 --> 00:22:40,000
like adfs or an ad connect or the domain

593
00:22:40,000 --> 00:22:42,559
controllers if an attacker hits one

594
00:22:42,559 --> 00:22:44,960
you're done most organizations don't

595
00:22:44,960 --> 00:22:47,520
treat it that way or when they do they

596
00:22:47,520 --> 00:22:50,000
don't do their due diligence following

597
00:22:50,000 --> 00:22:52,159
all the paths to the ca like they would

598
00:22:52,159 --> 00:22:54,720
with a domain controller so

599
00:22:54,720 --> 00:22:57,120
having some of these rogue permissions

600
00:22:57,120 --> 00:22:59,280
and weird privilege is an easy

601
00:22:59,280 --> 00:23:01,919
escalation path for an attacker but it

602
00:23:01,919 --> 00:23:03,919
can be hard to manage

603
00:23:03,919 --> 00:23:05,919
every ca is basically its own little

604
00:23:05,919 --> 00:23:09,039
island so you need a way to monitor not

605
00:23:09,039 --> 00:23:11,600
only the cas but other things like

606
00:23:11,600 --> 00:23:13,520
templates that i'll talk about here as

607
00:23:13,520 --> 00:23:14,480
well

608
00:23:14,480 --> 00:23:17,360
you need some process you need policy

609
00:23:17,360 --> 00:23:19,280
you need documentation you need

610
00:23:19,280 --> 00:23:21,520
monitoring and there's really nothing

611
00:23:21,520 --> 00:23:23,840
out of the box to do these things you've

612
00:23:23,840 --> 00:23:25,679
probably already done these things with

613
00:23:25,679 --> 00:23:27,840
other applications and critical services

614
00:23:27,840 --> 00:23:30,320
in the environment but more times than

615
00:23:30,320 --> 00:23:33,600
not pki gets left out so we want you to

616
00:23:33,600 --> 00:23:37,520
start doing that with the pki

617
00:23:37,520 --> 00:23:39,520
so let's start with a template what is a

618
00:23:39,520 --> 00:23:40,720
template

619
00:23:40,720 --> 00:23:41,760
so

620
00:23:41,760 --> 00:23:44,559
templates is a construct of windows

621
00:23:44,559 --> 00:23:46,720
server based pki

622
00:23:46,720 --> 00:23:50,000
domain services based pki so microsoft

623
00:23:50,000 --> 00:23:52,640
didn't invent pki we follow the dot 509

624
00:23:52,640 --> 00:23:54,480
standard for the most part

625
00:23:54,480 --> 00:23:57,200
but templates is primarily a windows

626
00:23:57,200 --> 00:23:59,840
construct and it's a way to rapidly

627
00:23:59,840 --> 00:24:02,320
issue certificates and in a lot of cases

628
00:24:02,320 --> 00:24:05,360
without any real user input or impact

629
00:24:05,360 --> 00:24:07,520
so without templates if i want a

630
00:24:07,520 --> 00:24:08,880
certificate

631
00:24:08,880 --> 00:24:10,480
i have to supply

632
00:24:10,480 --> 00:24:12,640
all of the information that the ca needs

633
00:24:12,640 --> 00:24:15,039
to build it specific fields in a

634
00:24:15,039 --> 00:24:18,480
specific order in specific syntax

635
00:24:18,480 --> 00:24:21,120
tens and tens possibly hundreds of

636
00:24:21,120 --> 00:24:22,880
different items that have to be

637
00:24:22,880 --> 00:24:24,000
just right

638
00:24:24,000 --> 00:24:25,360
at worse

639
00:24:25,360 --> 00:24:27,600
it won't get issued and it'll error out

640
00:24:27,600 --> 00:24:30,000
or in really odd cases it will get

641
00:24:30,000 --> 00:24:32,240
issued and weird things will happen so

642
00:24:32,240 --> 00:24:34,240
it was very very difficult but in a

643
00:24:34,240 --> 00:24:36,799
template i can configure all of those

644
00:24:36,799 --> 00:24:39,279
things as an administrator and then i

645
00:24:39,279 --> 00:24:41,440
can get all of my users you know

646
00:24:41,440 --> 00:24:44,720
cookie-cutted certificates or all of my

647
00:24:44,720 --> 00:24:46,720
sql servers or all of my domain

648
00:24:46,720 --> 00:24:49,760
controllers very specific use cases that

649
00:24:49,760 --> 00:24:51,600
i can control

650
00:24:51,600 --> 00:24:54,960
so these are set once in the environment

651
00:24:54,960 --> 00:24:58,080
and then i load these templates wherever

652
00:24:58,080 --> 00:25:00,880
i want the cas to service them

653
00:25:00,880 --> 00:25:03,440
but the templates start with a lot of

654
00:25:03,440 --> 00:25:04,799
permissions

655
00:25:04,799 --> 00:25:06,559
take a look at a few of them you see in

656
00:25:06,559 --> 00:25:08,559
those little check boxes what we see

657
00:25:08,559 --> 00:25:10,799
there's not a lot of variants there's

658
00:25:10,799 --> 00:25:13,919
there's not a lot of uh off-the-wall

659
00:25:13,919 --> 00:25:14,960
options there they're pretty

660
00:25:14,960 --> 00:25:17,919
straightforward we can read meaning we

661
00:25:17,919 --> 00:25:20,799
can use command line we can go in a gui

662
00:25:20,799 --> 00:25:22,880
tool and we can see that the template is

663
00:25:22,880 --> 00:25:24,159
listed

664
00:25:24,159 --> 00:25:26,559
enroll allows us to do a manual

665
00:25:26,559 --> 00:25:28,960
enrollment process

666
00:25:28,960 --> 00:25:31,200
auto enrollment means with something

667
00:25:31,200 --> 00:25:34,159
like a gpo i can turn that on to work

668
00:25:34,159 --> 00:25:37,840
with a template and without anyone's

669
00:25:37,840 --> 00:25:41,039
input or impact i can issue certificates

670
00:25:41,039 --> 00:25:43,600
to anything domain joined

671
00:25:43,600 --> 00:25:45,840
but there's a few other items there and

672
00:25:45,840 --> 00:25:47,200
they're a problem

673
00:25:47,200 --> 00:25:48,000
so

674
00:25:48,000 --> 00:25:50,000
right and full control

675
00:25:50,000 --> 00:25:52,080
there's no reason that gets given out

676
00:25:52,080 --> 00:25:54,880
there should never well 99 percent of

677
00:25:54,880 --> 00:25:57,120
the time there should never be a right

678
00:25:57,120 --> 00:25:58,799
privilege given it just doesn't make

679
00:25:58,799 --> 00:25:59,679
sense

680
00:25:59,679 --> 00:26:02,400
full control will happen by default the

681
00:26:02,400 --> 00:26:04,480
last administrator that made a change to

682
00:26:04,480 --> 00:26:06,240
the template is going to have the full

683
00:26:06,240 --> 00:26:08,400
control rights or it might be the person

684
00:26:08,400 --> 00:26:10,400
who created the template

685
00:26:10,400 --> 00:26:13,520
but that should only be an administrator

686
00:26:13,520 --> 00:26:14,320
so

687
00:26:14,320 --> 00:26:16,400
there's a lot of stuff that needs clean

688
00:26:16,400 --> 00:26:19,279
up there as well

689
00:26:19,279 --> 00:26:22,000
first think about just overly broad

690
00:26:22,000 --> 00:26:24,640
rights i see this a lot so if you look

691
00:26:24,640 --> 00:26:26,880
in this the the second item from the

692
00:26:26,880 --> 00:26:29,120
bottom just above enterprise admin says

693
00:26:29,120 --> 00:26:31,520
domain computers so that was probably a

694
00:26:31,520 --> 00:26:34,000
default in this template and

695
00:26:34,000 --> 00:26:36,799
domain computers means every computer

696
00:26:36,799 --> 00:26:39,039
every server literally everything in the

697
00:26:39,039 --> 00:26:41,360
domain will have whatever those rights

698
00:26:41,360 --> 00:26:43,440
are if i were to click on that

699
00:26:43,440 --> 00:26:44,240
well

700
00:26:44,240 --> 00:26:46,159
if i'm only issuing

701
00:26:46,159 --> 00:26:48,640
certificates off this template to

702
00:26:48,640 --> 00:26:52,400
certain systems windows 10 devices sql

703
00:26:52,400 --> 00:26:54,960
servers exchange servers something

704
00:26:54,960 --> 00:26:57,840
then domain computers is a bit too broad

705
00:26:57,840 --> 00:27:00,320
and a lot of people don't trim that down

706
00:27:00,320 --> 00:27:02,880
and it absolutely should be

707
00:27:02,880 --> 00:27:05,600
any right and full control permissions

708
00:27:05,600 --> 00:27:07,679
definitely should be looked at and this

709
00:27:07,679 --> 00:27:09,600
is something that you should be alerting

710
00:27:09,600 --> 00:27:12,799
on auditing regularly and just have good

711
00:27:12,799 --> 00:27:15,360
care and feeding in the environment

712
00:27:15,360 --> 00:27:18,000
a lot of defaults are there and they're

713
00:27:18,000 --> 00:27:20,159
really bloat they're really there to get

714
00:27:20,159 --> 00:27:21,360
started

715
00:27:21,360 --> 00:27:23,440
for example domain admins and enterprise

716
00:27:23,440 --> 00:27:25,840
admins by default they have rights on

717
00:27:25,840 --> 00:27:27,600
every single template

718
00:27:27,600 --> 00:27:30,159
generally those people are not your ca

719
00:27:30,159 --> 00:27:31,200
admins

720
00:27:31,200 --> 00:27:34,159
the people who are my experts in pki

721
00:27:34,159 --> 00:27:36,080
they're probably not my experts in

722
00:27:36,080 --> 00:27:37,600
domain services

723
00:27:37,600 --> 00:27:39,200
now there might be some crossover there

724
00:27:39,200 --> 00:27:41,679
and there may be reason to to use them

725
00:27:41,679 --> 00:27:43,840
but it's probably not everyone in that

726
00:27:43,840 --> 00:27:45,840
group so it's very common to have a

727
00:27:45,840 --> 00:27:48,640
separate group for pki admin and strip

728
00:27:48,640 --> 00:27:51,440
some of that out in either case likely

729
00:27:51,440 --> 00:27:52,960
enterprise admins doesn't need to be

730
00:27:52,960 --> 00:27:55,360
there regardless and it'll be a little

731
00:27:55,360 --> 00:27:57,520
different per template based on your

732
00:27:57,520 --> 00:28:00,000
architecture based on your organization

733
00:28:00,000 --> 00:28:02,159
but all of these should be reviewed i

734
00:28:02,159 --> 00:28:03,440
guarantee

735
00:28:03,440 --> 00:28:06,080
everyone i would find at least one item

736
00:28:06,080 --> 00:28:08,000
of bloat if i look through templates

737
00:28:08,000 --> 00:28:11,360
that you had in an environment

738
00:28:12,480 --> 00:28:14,399
with the templates aside

739
00:28:14,399 --> 00:28:16,399
now let's think about the cas

740
00:28:16,399 --> 00:28:18,240
the cas have their own set of

741
00:28:18,240 --> 00:28:20,240
permissions just like templates do and

742
00:28:20,240 --> 00:28:22,399
we see a lot of the same problems but

743
00:28:22,399 --> 00:28:24,880
now it has much more impact

744
00:28:24,880 --> 00:28:27,440
so on the templates it's rather on the

745
00:28:27,440 --> 00:28:29,919
cas themselves just looking here at a

746
00:28:29,919 --> 00:28:32,000
clip of the gui just like a normal

747
00:28:32,000 --> 00:28:34,480
security tab a normal acl that we have

748
00:28:34,480 --> 00:28:36,799
here but we just have a few options

749
00:28:36,799 --> 00:28:37,679
so

750
00:28:37,679 --> 00:28:40,000
manage ca it's basically the service

751
00:28:40,000 --> 00:28:42,399
administrator for the ca they can change

752
00:28:42,399 --> 00:28:45,360
configuration they can stop services

753
00:28:45,360 --> 00:28:47,760
they can revoke certificates they can

754
00:28:47,760 --> 00:28:50,080
back up things they can change things

755
00:28:50,080 --> 00:28:53,200
they can really do anything they want

756
00:28:53,200 --> 00:28:55,600
issue and manage would be a right that

757
00:28:55,600 --> 00:28:57,919
you would delegate out if you had

758
00:28:57,919 --> 00:29:00,480
someone that needed to work with

759
00:29:00,480 --> 00:29:02,960
certificates to approve requests to

760
00:29:02,960 --> 00:29:05,440
revoke certificates but you don't want

761
00:29:05,440 --> 00:29:09,440
them being the service administrator

762
00:29:09,440 --> 00:29:10,320
so

763
00:29:10,320 --> 00:29:11,600
with that

764
00:29:11,600 --> 00:29:14,640
again we see bloat we see a lot of the

765
00:29:14,640 --> 00:29:17,039
defaults there again domain admins

766
00:29:17,039 --> 00:29:18,399
enterprise admins they probably don't

767
00:29:18,399 --> 00:29:21,520
need to be there in some cases there are

768
00:29:21,520 --> 00:29:23,760
other things that fall in based on the

769
00:29:23,760 --> 00:29:26,080
template that you're using based on how

770
00:29:26,080 --> 00:29:27,919
you configure the ca

771
00:29:27,919 --> 00:29:29,919
over time this is going to change as

772
00:29:29,919 --> 00:29:31,360
well

773
00:29:31,360 --> 00:29:34,799
pkis are generally living for decades in

774
00:29:34,799 --> 00:29:37,120
an environment sometimes more

775
00:29:37,120 --> 00:29:38,960
so if you have something that got built

776
00:29:38,960 --> 00:29:41,200
five years ago or 10 years ago

777
00:29:41,200 --> 00:29:43,440
you've probably gone through different

778
00:29:43,440 --> 00:29:45,919
naming structure of your groups

779
00:29:45,919 --> 00:29:48,480
organizational changes so you probably

780
00:29:48,480 --> 00:29:50,880
have groups that aren't right anymore

781
00:29:50,880 --> 00:29:52,880
people that don't exist in the

782
00:29:52,880 --> 00:29:54,559
organization anymore

783
00:29:54,559 --> 00:29:56,399
and you're just not catching it

784
00:29:56,399 --> 00:29:59,120
so it's important that again this gets

785
00:29:59,120 --> 00:30:01,600
audited this gets monitored

786
00:30:01,600 --> 00:30:03,840
service accounts are big

787
00:30:03,840 --> 00:30:04,720
so

788
00:30:04,720 --> 00:30:06,640
having a service account

789
00:30:06,640 --> 00:30:09,279
with privilege at the ca level

790
00:30:09,279 --> 00:30:11,440
is pretty dangerous now there are

791
00:30:11,440 --> 00:30:13,679
certainly reasons to do it but you think

792
00:30:13,679 --> 00:30:15,840
about where the cas fit in that

793
00:30:15,840 --> 00:30:18,480
structure again tier zero critical

794
00:30:18,480 --> 00:30:21,279
resources just like a domain controller

795
00:30:21,279 --> 00:30:23,760
so now if i have a service account

796
00:30:23,760 --> 00:30:26,480
that's an administrator on a ca

797
00:30:26,480 --> 00:30:28,399
now follow that attack path wherever

798
00:30:28,399 --> 00:30:30,799
that a service account goes whatever

799
00:30:30,799 --> 00:30:33,360
application or servers that it's a part

800
00:30:33,360 --> 00:30:35,600
of now that there's an attack path from

801
00:30:35,600 --> 00:30:36,559
there

802
00:30:36,559 --> 00:30:38,320
to my critical systems

803
00:30:38,320 --> 00:30:40,159
that also means that likely all the

804
00:30:40,159 --> 00:30:42,480
administrators of that application are

805
00:30:42,480 --> 00:30:46,480
in that attack path so a very very broad

806
00:30:46,480 --> 00:30:48,880
stroke here so putting

807
00:30:48,880 --> 00:30:50,880
service accounts

808
00:30:50,880 --> 00:30:53,360
accounts for other applications at the

809
00:30:53,360 --> 00:30:54,799
ca level

810
00:30:54,799 --> 00:30:56,159
is something that you have to be very

811
00:30:56,159 --> 00:30:57,760
careful about now i'm not saying don't

812
00:30:57,760 --> 00:30:59,760
do it there's absolutely reasons to do

813
00:30:59,760 --> 00:31:01,279
that things like mobile device

814
00:31:01,279 --> 00:31:03,440
management tools they'll need exactly

815
00:31:03,440 --> 00:31:06,320
this but when you do this you have to be

816
00:31:06,320 --> 00:31:09,519
aware of what's happening perhaps even

817
00:31:09,519 --> 00:31:11,120
build your structure so there's a

818
00:31:11,120 --> 00:31:13,679
separate ca with only that function so

819
00:31:13,679 --> 00:31:15,200
if there is a breach if there is an

820
00:31:15,200 --> 00:31:17,120
attacker if something goes wrong or

821
00:31:17,120 --> 00:31:19,039
doesn't behave well you can just cut

822
00:31:19,039 --> 00:31:21,679
that off without impacting the larger

823
00:31:21,679 --> 00:31:23,760
organization

824
00:31:23,760 --> 00:31:26,720
enrollment agents are the the big case

825
00:31:26,720 --> 00:31:29,440
for things like service accounts so an

826
00:31:29,440 --> 00:31:31,440
enrollment agent is something that can

827
00:31:31,440 --> 00:31:33,919
get a certificate on behalf of someone

828
00:31:33,919 --> 00:31:36,880
else also very dangerous so if i could

829
00:31:36,880 --> 00:31:38,000
do that

830
00:31:38,000 --> 00:31:39,840
i'm going to ask for a certificate in

831
00:31:39,840 --> 00:31:41,840
the name of your cfo

832
00:31:41,840 --> 00:31:44,320
or a certificate for my computer in the

833
00:31:44,320 --> 00:31:46,880
name of one of your domain controllers

834
00:31:46,880 --> 00:31:48,880
so dangerous

835
00:31:48,880 --> 00:31:50,880
there's reason to do that but when

836
00:31:50,880 --> 00:31:52,799
you're allowing this kind of behavior

837
00:31:52,799 --> 00:31:55,200
again tightly controlled and monitored

838
00:31:55,200 --> 00:31:57,360
most organizations don't have any of

839
00:31:57,360 --> 00:32:00,080
that and we regularly see attackers

840
00:32:00,080 --> 00:32:02,320
abusing exactly this kind of escalation

841
00:32:02,320 --> 00:32:04,559
path

842
00:32:04,880 --> 00:32:08,000
by and large local groups and bloat of

843
00:32:08,000 --> 00:32:10,880
administrators on any windows server is

844
00:32:10,880 --> 00:32:13,200
generally a problem for organizations

845
00:32:13,200 --> 00:32:16,960
but absolutely no place for it on a ca

846
00:32:16,960 --> 00:32:19,679
should absolutely be turning the knobs

847
00:32:19,679 --> 00:32:22,000
on that bringing that down to the bare

848
00:32:22,000 --> 00:32:24,399
minimum

849
00:32:25,519 --> 00:32:27,600
an extension to this now with the

850
00:32:27,600 --> 00:32:30,159
security issues

851
00:32:30,159 --> 00:32:33,279
what happens when powerful certificates

852
00:32:33,279 --> 00:32:34,880
become available and there's just a

853
00:32:34,880 --> 00:32:36,720
couple categories of this that i'm going

854
00:32:36,720 --> 00:32:37,760
to mention

855
00:32:37,760 --> 00:32:41,679
one is that if you allow the ca to

856
00:32:41,679 --> 00:32:44,080
accept input from a user when they're

857
00:32:44,080 --> 00:32:46,320
requesting a certificate like i just

858
00:32:46,320 --> 00:32:48,559
mentioned i'll request a certificate in

859
00:32:48,559 --> 00:32:51,200
the name of your cfo if as a user i

860
00:32:51,200 --> 00:32:53,440
could put in anything i want

861
00:32:53,440 --> 00:32:55,919
that's an issue so we say that in that

862
00:32:55,919 --> 00:32:58,880
case the ca is allowing enrollee

863
00:32:58,880 --> 00:33:01,360
supplied information in the request

864
00:33:01,360 --> 00:33:03,440
certainly a reason to do that in certain

865
00:33:03,440 --> 00:33:07,360
cases but for most cases there's not so

866
00:33:07,360 --> 00:33:09,600
if and when you are allowing that it

867
00:33:09,600 --> 00:33:11,919
needs to be monitored things should not

868
00:33:11,919 --> 00:33:14,559
get automatically issued in those cases

869
00:33:14,559 --> 00:33:16,399
administrators should be checking that

870
00:33:16,399 --> 00:33:18,240
request

871
00:33:18,240 --> 00:33:20,880
templates for very powerful systems like

872
00:33:20,880 --> 00:33:22,480
domain controllers

873
00:33:22,480 --> 00:33:24,240
you should be very clear on what's

874
00:33:24,240 --> 00:33:26,000
getting issued and when there should

875
00:33:26,000 --> 00:33:28,480
never be mistakes where a domain

876
00:33:28,480 --> 00:33:30,480
controller certificate lands on some

877
00:33:30,480 --> 00:33:32,559
other server or a code signing

878
00:33:32,559 --> 00:33:35,679
certificate goes to a random user

879
00:33:35,679 --> 00:33:37,519
anything that's powerful like that

880
00:33:37,519 --> 00:33:40,080
should be very carefully controlled

881
00:33:40,080 --> 00:33:42,240
and then sand names it's an interesting

882
00:33:42,240 --> 00:33:44,159
topic so a sand name a subject

883
00:33:44,159 --> 00:33:46,720
alternative name it's basically an alias

884
00:33:46,720 --> 00:33:47,440
so

885
00:33:47,440 --> 00:33:50,000
i will issue a certificate to a subject

886
00:33:50,000 --> 00:33:53,039
so maybe my name so i have a certificate

887
00:33:53,039 --> 00:33:55,279
literally issued to rick davis but i

888
00:33:55,279 --> 00:33:58,640
have a san configured and it's my email

889
00:33:58,640 --> 00:34:00,320
address

890
00:34:00,320 --> 00:34:01,760
things like that can happen they can be

891
00:34:01,760 --> 00:34:03,760
configured for whatever you want there

892
00:34:03,760 --> 00:34:06,080
are applications and services that

893
00:34:06,080 --> 00:34:08,719
require very specific sand names be

894
00:34:08,719 --> 00:34:10,800
entered so there's a real reason to use

895
00:34:10,800 --> 00:34:13,520
them but again if i can put in anything

896
00:34:13,520 --> 00:34:16,399
i want that becomes a security risk so

897
00:34:16,399 --> 00:34:19,119
the use of sand names is is really hard

898
00:34:19,119 --> 00:34:21,119
to catch there's not a lot of good

899
00:34:21,119 --> 00:34:23,679
monitoring for that so it comes down to

900
00:34:23,679 --> 00:34:25,599
the hygiene of the cas and your

901
00:34:25,599 --> 00:34:27,040
administrators

902
00:34:27,040 --> 00:34:29,040
and at the end of the day

903
00:34:29,040 --> 00:34:31,760
for all of these things monitoring

904
00:34:31,760 --> 00:34:34,639
alerting is incredibly important i kind

905
00:34:34,639 --> 00:34:37,119
of beat the dead horse with that because

906
00:34:37,119 --> 00:34:39,520
just about everyone fails at that

907
00:34:39,520 --> 00:34:40,560
initially

908
00:34:40,560 --> 00:34:42,560
once someone realizes hey we need to do

909
00:34:42,560 --> 00:34:45,359
better with our pki we want to start

910
00:34:45,359 --> 00:34:47,440
looking at it it's not until that point

911
00:34:47,440 --> 00:34:49,119
that they realize we don't really have

912
00:34:49,119 --> 00:34:51,918
any monitoring any auditing any alerting

913
00:34:51,918 --> 00:34:53,760
we don't really know what's going on

914
00:34:53,760 --> 00:34:57,359
even if you have dedicated staff for it

915
00:34:57,359 --> 00:34:58,240
so

916
00:34:58,240 --> 00:35:00,480
closing some of this out

917
00:35:00,480 --> 00:35:02,960
have an assessment of your pki

918
00:35:02,960 --> 00:35:04,640
i'm not trying to sell you one there's

919
00:35:04,640 --> 00:35:06,400
plenty of places that have them there's

920
00:35:06,400 --> 00:35:08,880
even free ones that you can get online

921
00:35:08,880 --> 00:35:11,200
scripted and through other services but

922
00:35:11,200 --> 00:35:13,760
get one just get an idea of where things

923
00:35:13,760 --> 00:35:14,800
stand

924
00:35:14,800 --> 00:35:18,000
whoever you have responsible for pki

925
00:35:18,000 --> 00:35:20,800
whether it's a dedicated team or person

926
00:35:20,800 --> 00:35:22,960
get them some formal training there's a

927
00:35:22,960 --> 00:35:24,960
lot of good resources out there both

928
00:35:24,960 --> 00:35:27,359
free and paid level set if you've got

929
00:35:27,359 --> 00:35:28,960
someone that's been doing it a long time

930
00:35:28,960 --> 00:35:30,640
i guarantee there's new stuff they don't

931
00:35:30,640 --> 00:35:32,720
know about if they've not been doing it

932
00:35:32,720 --> 00:35:34,560
a long time there's a steep learning

933
00:35:34,560 --> 00:35:37,119
curve and there's stuff they should know

934
00:35:37,119 --> 00:35:38,880
and then finally

935
00:35:38,880 --> 00:35:40,800
if you have a pki

936
00:35:40,800 --> 00:35:42,640
it's probably critical for your

937
00:35:42,640 --> 00:35:45,119
organization and unfortunately you're

938
00:35:45,119 --> 00:35:47,200
probably not treating it that way so it

939
00:35:47,200 --> 00:35:49,119
should be part of your dr plan it should

940
00:35:49,119 --> 00:35:51,520
be tested it should be just as important

941
00:35:51,520 --> 00:35:54,320
as things like domain controllers and

942
00:35:54,320 --> 00:35:56,800
sharepoint and email because if those

943
00:35:56,800 --> 00:35:58,640
things are using certificates and your

944
00:35:58,640 --> 00:36:02,079
certificates fail it's a big problem

945
00:36:02,079 --> 00:36:03,440
so

946
00:36:03,440 --> 00:36:05,599
that's all i had for you hopefully

947
00:36:05,599 --> 00:36:06,960
you're able to take some of this

948
00:36:06,960 --> 00:36:09,200
information back take a look at what you

949
00:36:09,200 --> 00:36:12,560
have and push for some improvement um

950
00:36:12,560 --> 00:36:14,720
i'll be around for most of the day if

951
00:36:14,720 --> 00:36:16,160
you have questions

952
00:36:16,160 --> 00:36:19,200
track me down i'd love to talk pki

953
00:36:19,200 --> 00:36:21,040
shoot me a message on twitter whatever

954
00:36:21,040 --> 00:36:23,440
that happens to be and hope you enjoy

955
00:36:23,440 --> 00:36:26,110
the rest of the conference

956
00:36:26,110 --> 00:36:31,939
[Applause]

