1
00:00:00,080 --> 00:00:02,399
good morning and welcome to b-sides las

2
00:00:02,399 --> 00:00:05,359
vegas common grounds this talk is

3
00:00:05,359 --> 00:00:07,120
understanding and using and monitoring

4
00:00:07,120 --> 00:00:10,000
aws app stream 2.0

5
00:00:10,000 --> 00:00:11,920
given by rodrigo

6
00:00:11,920 --> 00:00:14,559
montoro from tempest security

7
00:00:14,559 --> 00:00:16,400
a few announcements before we begin we'd

8
00:00:16,400 --> 00:00:18,240
like to thank our sponsors especially

9
00:00:18,240 --> 00:00:20,640
our diamond sponsors lastpass and palo

10
00:00:20,640 --> 00:00:23,279
alto networks and our gold sponsors

11
00:00:23,279 --> 00:00:26,000
amazon flextrac and google it's their

12
00:00:26,000 --> 00:00:28,240
support along with other sponsors donors

13
00:00:28,240 --> 00:00:29,840
and volunteers that make this event

14
00:00:29,840 --> 00:00:31,039
possible

15
00:00:31,039 --> 00:00:33,280
these talks are being streamed streamed

16
00:00:33,280 --> 00:00:35,520
live and as a courtesy to our speakers

17
00:00:35,520 --> 00:00:37,360
and audience we ask that you check to

18
00:00:37,360 --> 00:00:39,120
make sure your cell phones are set

19
00:00:39,120 --> 00:00:40,160
silent

20
00:00:40,160 --> 00:00:42,840
if you have a question use the audience

21
00:00:42,840 --> 00:00:45,039
microphone that i'm holding

22
00:00:45,039 --> 00:00:46,399
to

23
00:00:46,399 --> 00:00:48,719
so that way youtube can hear you

24
00:00:48,719 --> 00:00:51,199
now as a reminder the b-side las vegas

25
00:00:51,199 --> 00:00:53,520
photo policy prohibits taking pictures

26
00:00:53,520 --> 00:00:54,879
without the explicit permission of

27
00:00:54,879 --> 00:00:56,719
everyone in the frame these talks are

28
00:00:56,719 --> 00:00:58,800
being recorded and will be available on

29
00:00:58,800 --> 00:01:00,640
youtube in the future and we would like

30
00:01:00,640 --> 00:01:02,960
to you to please keep your masks on at

31
00:01:02,960 --> 00:01:05,440
all times

32
00:01:05,840 --> 00:01:08,240
all right

33
00:01:08,640 --> 00:01:11,040
all right so first thanks besides for

34
00:01:11,040 --> 00:01:13,760
having me here um i'm going to talk

35
00:01:13,760 --> 00:01:15,840
about understanding abusing and

36
00:01:15,840 --> 00:01:18,479
monitoring upstream if you look like the

37
00:01:18,479 --> 00:01:19,439
monitor

38
00:01:19,439 --> 00:01:20,640
is in bold

39
00:01:20,640 --> 00:01:22,640
and so like my main goal is the

40
00:01:22,640 --> 00:01:25,040
monitoring part but to do the monitor

41
00:01:25,040 --> 00:01:27,119
part i need to do the offensive part

42
00:01:27,119 --> 00:01:29,200
right but my main goal

43
00:01:29,200 --> 00:01:33,920
is to to to find the monitor parts uh

44
00:01:35,040 --> 00:01:37,200
my name is rodrigo i'm spooker labs i do

45
00:01:37,200 --> 00:01:39,200
research interactive texture engineer at

46
00:01:39,200 --> 00:01:41,280
tempest security in brazil

47
00:01:41,280 --> 00:01:43,439
and i live in the south of brazil it's a

48
00:01:43,439 --> 00:01:44,880
beautiful place if you want to visit

49
00:01:44,880 --> 00:01:47,119
brazil florianopolis is an island so

50
00:01:47,119 --> 00:01:49,520
it's pretty good to be there a proud dad

51
00:01:49,520 --> 00:01:52,079
and her husband in my spare time i do a

52
00:01:52,079 --> 00:01:54,799
lot of sports i used to do iron man but

53
00:01:54,799 --> 00:01:56,880
if you could look for me like i'm not

54
00:01:56,880 --> 00:02:00,000
doing anymore like too big for that

55
00:02:00,000 --> 00:02:02,640
and my twitter handle is spooker and the

56
00:02:02,640 --> 00:02:04,799
motivation about that

57
00:02:04,799 --> 00:02:07,200
it started when we

58
00:02:07,200 --> 00:02:09,360
a company called tempest about an

59
00:02:09,360 --> 00:02:12,640
incident response that was happening

60
00:02:12,640 --> 00:02:15,520
and they they told us like

61
00:02:15,520 --> 00:02:19,280
we got owned by a apps string instance

62
00:02:19,280 --> 00:02:22,000
that we used to have a administrator

63
00:02:22,000 --> 00:02:25,120
access role attach it and so when i was

64
00:02:25,120 --> 00:02:27,680
in the car my first stuff was like what

65
00:02:27,680 --> 00:02:30,080
is that stream like that time i have

66
00:02:30,080 --> 00:02:32,000
never heard before

67
00:02:32,000 --> 00:02:34,720
and my second thought was like if that

68
00:02:34,720 --> 00:02:37,040
company was our security operations

69
00:02:37,040 --> 00:02:39,599
center company would you would you

70
00:02:39,599 --> 00:02:41,120
detect that

71
00:02:41,120 --> 00:02:42,800
and the answer was no

72
00:02:42,800 --> 00:02:44,879
and so as i figure out oops i think you

73
00:02:44,879 --> 00:02:47,599
need to start to improve our detections

74
00:02:47,599 --> 00:02:48,720
and

75
00:02:48,720 --> 00:02:51,120
with that in mind

76
00:02:51,120 --> 00:02:53,440
uh i started to study a bit about app

77
00:02:53,440 --> 00:02:56,640
stream and talk with an uh with a shish

78
00:02:56,640 --> 00:02:59,040
from call secure podcast

79
00:02:59,040 --> 00:03:01,760
and we start thinking like maybe it's

80
00:03:01,760 --> 00:03:04,400
time to try to do some

81
00:03:04,400 --> 00:03:06,879
uncommon thread this detection response

82
00:03:06,879 --> 00:03:09,519
for aws for uncommon service because

83
00:03:09,519 --> 00:03:12,319
like we have a lot of works like for ec2

84
00:03:12,319 --> 00:03:16,400
instance s3 rds and lambda and more

85
00:03:16,400 --> 00:03:19,200
common service and when i talk about the

86
00:03:19,200 --> 00:03:22,159
aws service we have around

87
00:03:22,159 --> 00:03:24,000
300 servers

88
00:03:24,000 --> 00:03:26,239
and so there is a lot of room and a lot

89
00:03:26,239 --> 00:03:28,560
of opportunities for the attackers

90
00:03:28,560 --> 00:03:31,040
and so as a defensive guy i started

91
00:03:31,040 --> 00:03:33,280
figuring out okay and so this talk this

92
00:03:33,280 --> 00:03:36,319
research is a kind of proof of concept

93
00:03:36,319 --> 00:03:37,599
like

94
00:03:37,599 --> 00:03:40,400
what we should do with uncommon service

95
00:03:40,400 --> 00:03:42,159
or service that you have in our

96
00:03:42,159 --> 00:03:44,239
environment but we're not monitored by

97
00:03:44,239 --> 00:03:45,519
some reason

98
00:03:45,519 --> 00:03:47,440
and

99
00:03:47,440 --> 00:03:48,560
and and

100
00:03:48,560 --> 00:03:51,200
and and show like what we have

101
00:03:51,200 --> 00:03:52,959
there a lot of opportunities that you

102
00:03:52,959 --> 00:03:54,000
have here

103
00:03:54,000 --> 00:03:57,280
and how we could try to detect or maybe

104
00:03:57,280 --> 00:04:01,840
mitigate or or improve our security

105
00:04:02,080 --> 00:04:03,760
so i did a

106
00:04:03,760 --> 00:04:05,360
a very

107
00:04:05,360 --> 00:04:08,560
brief agenda so introduction app stream

108
00:04:08,560 --> 00:04:11,200
right um some

109
00:04:11,200 --> 00:04:13,360
recon attack flow like

110
00:04:13,360 --> 00:04:15,840
the way that i built this research

111
00:04:15,840 --> 00:04:16,798
and

112
00:04:16,798 --> 00:04:19,600
as i said like i'm a defensive guy and

113
00:04:19,600 --> 00:04:21,680
so like i'm not the

114
00:04:21,680 --> 00:04:23,600
maybe there is another way to do the

115
00:04:23,600 --> 00:04:26,560
attacks but i'm just based on my basic

116
00:04:26,560 --> 00:04:29,440
scenarios and so some scenarios are

117
00:04:29,440 --> 00:04:30,639
boosting

118
00:04:30,639 --> 00:04:32,400
some parts like

119
00:04:32,400 --> 00:04:33,759
this is not about finding

120
00:04:33,759 --> 00:04:35,840
vulnerabilities at the service it's

121
00:04:35,840 --> 00:04:37,840
about using the service and the features

122
00:04:37,840 --> 00:04:39,120
right

123
00:04:39,120 --> 00:04:41,360
and so the the important part for me

124
00:04:41,360 --> 00:04:43,680
like since i i do try the detection

125
00:04:43,680 --> 00:04:45,440
engineer like the monitoring detection

126
00:04:45,440 --> 00:04:47,840
mitigate and some future work and

127
00:04:47,840 --> 00:04:50,160
conclusions

128
00:04:50,160 --> 00:04:53,520
so introduction through app stream

129
00:04:53,520 --> 00:04:56,800
so what is app stream i i i got a couple

130
00:04:56,800 --> 00:04:58,479
of

131
00:04:58,479 --> 00:04:59,680
words and

132
00:04:59,680 --> 00:05:01,440
and

133
00:05:01,440 --> 00:05:03,759
and message from the the documentation

134
00:05:03,759 --> 00:05:05,840
so it's a desktop application for

135
00:05:05,840 --> 00:05:06,960
anywhere

136
00:05:06,960 --> 00:05:10,000
so anywhere means like anyone could get

137
00:05:10,000 --> 00:05:12,240
inside that or use that

138
00:05:12,240 --> 00:05:14,320
like the

139
00:05:14,320 --> 00:05:16,560
applications run inside your vpc and

140
00:05:16,560 --> 00:05:17,919
subnets

141
00:05:17,919 --> 00:05:20,000
so that's cool like i could put some

142
00:05:20,000 --> 00:05:21,600
application maybe some legacy

143
00:05:21,600 --> 00:05:22,720
application

144
00:05:22,720 --> 00:05:26,800
into my my my cloud environment and i

145
00:05:26,800 --> 00:05:29,039
have access to the vipsy and the subnet

146
00:05:29,039 --> 00:05:31,120
so you're attached to that but look on

147
00:05:31,120 --> 00:05:34,479
the attacks attacker sider attack site

148
00:05:34,479 --> 00:05:36,000
what what what's the problem like

149
00:05:36,000 --> 00:05:38,400
lateral movement so i could get inside

150
00:05:38,400 --> 00:05:40,479
break the perimeter and get network

151
00:05:40,479 --> 00:05:42,240
access

152
00:05:42,240 --> 00:05:44,560
and so x data and research that you have

153
00:05:44,560 --> 00:05:46,320
in your account

154
00:05:46,320 --> 00:05:48,560
and so that's pretty cool because i have

155
00:05:48,560 --> 00:05:50,400
a legacy application that needs to

156
00:05:50,400 --> 00:05:53,919
connect to my rds by some reason and so

157
00:05:53,919 --> 00:05:56,400
it's there i could connect to the rds so

158
00:05:56,400 --> 00:05:58,400
i attached a row that has permission

159
00:05:58,400 --> 00:05:59,840
through rds

160
00:05:59,840 --> 00:06:03,199
and like this is pretty cool but in this

161
00:06:03,199 --> 00:06:05,520
the view of the the attacker it's pretty

162
00:06:05,520 --> 00:06:08,400
good too because if i break that i could

163
00:06:08,400 --> 00:06:10,560
access that in resource

164
00:06:10,560 --> 00:06:12,160
right

165
00:06:12,160 --> 00:06:14,319
integrate with your active directors

166
00:06:14,319 --> 00:06:16,400
like pen testers loads active directors

167
00:06:16,400 --> 00:06:19,840
because you always have a problem right

168
00:06:19,840 --> 00:06:21,680
gpu processing so we have good

169
00:06:21,680 --> 00:06:23,440
processing there like maybe the crypto

170
00:06:23,440 --> 00:06:25,360
mining guys we would love to have some

171
00:06:25,360 --> 00:06:27,600
access

172
00:06:28,240 --> 00:06:30,639
and so how does it works like you

173
00:06:30,639 --> 00:06:33,520
basically you have a builder part and

174
00:06:33,520 --> 00:06:36,160
install your windows or linux or what

175
00:06:36,160 --> 00:06:38,400
you need you build your operation all

176
00:06:38,400 --> 00:06:40,080
this stuff you need

177
00:06:40,080 --> 00:06:43,039
and you you create the users you create

178
00:06:43,039 --> 00:06:45,520
the instance and so the user will have

179
00:06:45,520 --> 00:06:48,960
access to that application or this os

180
00:06:48,960 --> 00:06:51,919
like a better image like it's from a

181
00:06:51,919 --> 00:06:53,840
presentation from amazon

182
00:06:53,840 --> 00:06:55,919
like so basically you have the image

183
00:06:55,919 --> 00:06:58,000
builder parts so you could they have

184
00:06:58,000 --> 00:07:00,160
some pre-built applications but you

185
00:07:00,160 --> 00:07:02,319
could just install windows and do what

186
00:07:02,319 --> 00:07:03,199
you need

187
00:07:03,199 --> 00:07:05,520
to create application and so after you

188
00:07:05,520 --> 00:07:08,560
you work here everything red you go to

189
00:07:08,560 --> 00:07:11,280
the snapshot and it will go to the image

190
00:07:11,280 --> 00:07:14,400
headers and so you could add to

191
00:07:14,400 --> 00:07:15,520
the fleet

192
00:07:15,520 --> 00:07:17,680
and so fleet is where you

193
00:07:17,680 --> 00:07:19,520
you do some out scaling like you could

194
00:07:19,520 --> 00:07:21,440
do like the things so the user will

195
00:07:21,440 --> 00:07:24,160
always have that application

196
00:07:24,160 --> 00:07:25,599
uh red

197
00:07:25,599 --> 00:07:27,199
and so the user will connect the fleet

198
00:07:27,199 --> 00:07:29,599
and you have the stack part

199
00:07:29,599 --> 00:07:32,080
that you could do some prestan's data

200
00:07:32,080 --> 00:07:35,680
cloud star use s3 and because when you

201
00:07:35,680 --> 00:07:38,080
access you do your things and so the the

202
00:07:38,080 --> 00:07:40,800
instance is terminated so

203
00:07:40,800 --> 00:07:42,319
you don't have first test data and so

204
00:07:42,319 --> 00:07:44,720
you have this opportunity here

205
00:07:44,720 --> 00:07:46,960
most of my research

206
00:07:46,960 --> 00:07:48,720
of this proof of content i'm not i

207
00:07:48,720 --> 00:07:50,160
didn't get

208
00:07:50,160 --> 00:07:51,280
all the

209
00:07:51,280 --> 00:07:53,039
the steps here already

210
00:07:53,039 --> 00:07:54,960
mostly i'm i'm i'm talking about the

211
00:07:54,960 --> 00:07:57,599
image builder only and the image i have

212
00:07:57,599 --> 00:08:00,639
a bunch of stuff to do here and even if

213
00:08:00,639 --> 00:08:03,599
i i had the time to do all the stuffs i

214
00:08:03,599 --> 00:08:05,280
probably could not have time to speak

215
00:08:05,280 --> 00:08:07,520
about all the stuff because it would be

216
00:08:07,520 --> 00:08:09,759
so long

217
00:08:09,759 --> 00:08:12,400
and so how it works how my idea worked

218
00:08:12,400 --> 00:08:14,720
how in my mind like how i would build

219
00:08:14,720 --> 00:08:18,639
this recon and how it's going to work

220
00:08:18,639 --> 00:08:21,120
and so we'll have the initial phase so

221
00:08:21,120 --> 00:08:22,639
first

222
00:08:22,639 --> 00:08:24,479
what do you need we need to see if you

223
00:08:24,479 --> 00:08:27,599
have access should the actions relate to

224
00:08:27,599 --> 00:08:28,800
that

225
00:08:28,800 --> 00:08:30,960
to that service

226
00:08:30,960 --> 00:08:31,840
like

227
00:08:31,840 --> 00:08:34,080
uh over permissive

228
00:08:34,080 --> 00:08:36,799
policy is not a problem at aws like most

229
00:08:36,799 --> 00:08:38,159
of the time they have

230
00:08:38,159 --> 00:08:41,039
that they they do administrator stuff

231
00:08:41,039 --> 00:08:43,679
and so probably you you find some some

232
00:08:43,679 --> 00:08:45,120
some permissions here

233
00:08:45,120 --> 00:08:47,360
after that

234
00:08:47,360 --> 00:08:49,760
as i validate those permissions i show

235
00:08:49,760 --> 00:08:51,120
each permission you're going to need i

236
00:08:51,120 --> 00:08:53,680
have access type string right

237
00:08:53,680 --> 00:08:56,480
and when i have access wrap string to do

238
00:08:56,480 --> 00:08:58,640
some steps that i'm going to show later

239
00:08:58,640 --> 00:09:00,800
i need to do some enumeration

240
00:09:00,800 --> 00:09:01,839
about

241
00:09:01,839 --> 00:09:03,519
the app stream itself because you have

242
00:09:03,519 --> 00:09:05,519
some information there and about the

243
00:09:05,519 --> 00:09:08,399
general aws because you need to to know

244
00:09:08,399 --> 00:09:11,600
the the vpcs the subnets if you have

245
00:09:11,600 --> 00:09:14,399
some role that could be used with the

246
00:09:14,399 --> 00:09:16,560
app stream service and this

247
00:09:16,560 --> 00:09:18,240
this kind of thing and so i'll do the

248
00:09:18,240 --> 00:09:20,160
app stream enumeration and the general

249
00:09:20,160 --> 00:09:22,720
aws enumeration

250
00:09:22,720 --> 00:09:25,360
and on the side of general aws

251
00:09:25,360 --> 00:09:26,640
enumeration

252
00:09:26,640 --> 00:09:28,959
i i i would try to say like since i'm

253
00:09:28,959 --> 00:09:32,320
going to get inside the vpc i i would

254
00:09:32,320 --> 00:09:34,480
figure out like which vpc i want

255
00:09:34,480 --> 00:09:36,560
do they have like transgator direct

256
00:09:36,560 --> 00:09:38,240
connect and so i could figure out like

257
00:09:38,240 --> 00:09:40,399
how far it could go like maybe you could

258
00:09:40,399 --> 00:09:43,040
go for an app stream throw on premise

259
00:09:43,040 --> 00:09:45,040
and and do what what do you need so

260
00:09:45,040 --> 00:09:47,360
supernat security groups and this very

261
00:09:47,360 --> 00:09:50,080
important part like rules that have

262
00:09:50,080 --> 00:09:52,160
thrusted paulus

263
00:09:52,160 --> 00:09:54,160
for app stream so the app string when

264
00:09:54,160 --> 00:09:56,320
you you created the image you could

265
00:09:56,320 --> 00:09:59,279
build the image with that row

266
00:09:59,279 --> 00:10:01,519
and the app stream part i will see like

267
00:10:01,519 --> 00:10:04,000
the the image that they have are right

268
00:10:04,000 --> 00:10:07,920
there the image no aws image like when

269
00:10:07,920 --> 00:10:10,800
you have no aws image probably something

270
00:10:10,800 --> 00:10:13,040
you created and there you have some

271
00:10:13,040 --> 00:10:14,640
information from the company maybe

272
00:10:14,640 --> 00:10:16,079
something you want

273
00:10:16,079 --> 00:10:18,880
the fleet and stacks and and the builder

274
00:10:18,880 --> 00:10:20,880
image and the fleet part i'm not going

275
00:10:20,880 --> 00:10:22,240
to talk about the fleet part but the

276
00:10:22,240 --> 00:10:24,560
builder image they have the the the

277
00:10:24,560 --> 00:10:27,839
possibility about attacher row right and

278
00:10:27,839 --> 00:10:28,640
so

279
00:10:28,640 --> 00:10:30,880
when you can attach a roll or pass the

280
00:10:30,880 --> 00:10:32,480
roll

281
00:10:32,480 --> 00:10:34,399
that means that something could be much

282
00:10:34,399 --> 00:10:36,800
dangerous right when you have right uh

283
00:10:36,800 --> 00:10:38,320
permissions to this

284
00:10:38,320 --> 00:10:41,440
and personal storage

285
00:10:41,760 --> 00:10:42,560
and

286
00:10:42,560 --> 00:10:45,440
so it's it's a bit part of the the

287
00:10:45,440 --> 00:10:48,079
actions that we need like i i split here

288
00:10:48,079 --> 00:10:49,680
like image builder

289
00:10:49,680 --> 00:10:51,519
the part the image the fleet and the

290
00:10:51,519 --> 00:10:54,079
stack as i mentioned i'm mostly talk

291
00:10:54,079 --> 00:10:57,360
about image builder and i will mention

292
00:10:57,360 --> 00:10:59,760
image part because there is some

293
00:10:59,760 --> 00:11:02,880
easy stuff to do with that

294
00:11:02,880 --> 00:11:05,839
that is interesting and so the the verb

295
00:11:05,839 --> 00:11:08,240
first the privileged collision

296
00:11:08,240 --> 00:11:09,200
there is

297
00:11:09,200 --> 00:11:10,240
three

298
00:11:10,240 --> 00:11:14,240
three ways to have privileged collision

299
00:11:14,240 --> 00:11:16,800
uh the very first one like if you have a

300
00:11:16,800 --> 00:11:19,680
exist existing builder image with a role

301
00:11:19,680 --> 00:11:21,839
already running like someone is working

302
00:11:21,839 --> 00:11:24,079
right with a role and testing and doing

303
00:11:24,079 --> 00:11:25,839
stuff

304
00:11:25,839 --> 00:11:28,320
you just need app stream create image

305
00:11:28,320 --> 00:11:31,120
builder stream url i will show what this

306
00:11:31,120 --> 00:11:32,800
means

307
00:11:32,800 --> 00:11:34,480
and with this

308
00:11:34,480 --> 00:11:37,200
this section you guys are url and you

309
00:11:37,200 --> 00:11:39,360
type their url in your browser you get

310
00:11:39,360 --> 00:11:41,920
inside the machine as root and you could

311
00:11:41,920 --> 00:11:44,399
assume the role that is running with

312
00:11:44,399 --> 00:11:45,760
that and so

313
00:11:45,760 --> 00:11:49,040
depends on the combination of the facts

314
00:11:49,040 --> 00:11:50,959
with just this you could do the

315
00:11:50,959 --> 00:11:52,720
privilege collision

316
00:11:52,720 --> 00:11:53,519
if

317
00:11:53,519 --> 00:11:56,560
maybe you have some builder image there

318
00:11:56,560 --> 00:11:57,760
with

319
00:11:57,760 --> 00:12:01,680
a rule associated but that role

320
00:12:01,680 --> 00:12:03,519
that that instance is not running you

321
00:12:03,519 --> 00:12:05,680
stop it and so you you need the start

322
00:12:05,680 --> 00:12:08,079
image builder too and so you start the

323
00:12:08,079 --> 00:12:10,000
image and so after that you create the

324
00:12:10,000 --> 00:12:12,399
builder screen url and with that you

325
00:12:12,399 --> 00:12:14,320
access the machine

326
00:12:14,320 --> 00:12:15,760
and the

327
00:12:15,760 --> 00:12:16,800
the

328
00:12:16,800 --> 00:12:19,040
the most like common part like the most

329
00:12:19,040 --> 00:12:21,120
privileged collection for sure right you

330
00:12:21,120 --> 00:12:22,720
have the pedro

331
00:12:22,720 --> 00:12:24,639
and you have the app string create image

332
00:12:24,639 --> 00:12:26,079
builder and so you create the image

333
00:12:26,079 --> 00:12:29,200
builder you attach the the row and you

334
00:12:29,200 --> 00:12:30,160
have the

335
00:12:30,160 --> 00:12:32,160
access to the machine and you could use

336
00:12:32,160 --> 00:12:34,560
that row i i have a lot of scenarios i

337
00:12:34,560 --> 00:12:35,920
have some live

338
00:12:35,920 --> 00:12:38,320
not live gmail or record demo showing

339
00:12:38,320 --> 00:12:40,000
like part of this

340
00:12:40,000 --> 00:12:42,480
and so we have the first tense part

341
00:12:42,480 --> 00:12:43,279
right

342
00:12:43,279 --> 00:12:46,000
and so with create image builder and are

343
00:12:46,000 --> 00:12:47,440
using uh

344
00:12:47,440 --> 00:12:48,160
a

345
00:12:48,160 --> 00:12:50,399
a builder image that's there like you

346
00:12:50,399 --> 00:12:52,399
could create an image builder but you

347
00:12:52,399 --> 00:12:54,240
don't need the press roll so it just

348
00:12:54,240 --> 00:12:56,240
creates and you have a machine inside

349
00:12:56,240 --> 00:12:58,320
the vip c and the subnet

350
00:12:58,320 --> 00:13:00,880
and what what and when i'm talking about

351
00:13:00,880 --> 00:13:03,760
prestons that come to my mind like

352
00:13:03,760 --> 00:13:05,920
what's the problem with upstream on the

353
00:13:05,920 --> 00:13:07,839
detection side we don't have detection

354
00:13:07,839 --> 00:13:09,279
mostly and so if they don't have

355
00:13:09,279 --> 00:13:11,680
detection this kind of for instance we

356
00:13:11,680 --> 00:13:13,760
probably

357
00:13:13,760 --> 00:13:16,000
will be there forever because if i'm not

358
00:13:16,000 --> 00:13:18,160
looking for this kind of actions they

359
00:13:18,160 --> 00:13:19,600
will create that

360
00:13:19,600 --> 00:13:21,519
like if they don't create some large

361
00:13:21,519 --> 00:13:23,760
machine like to be like just a few bucks

362
00:13:23,760 --> 00:13:26,000
that you'll never notice

363
00:13:26,000 --> 00:13:27,360
and the person's parts is really

364
00:13:27,360 --> 00:13:29,600
interesting and you could have a

365
00:13:29,600 --> 00:13:32,000
presence with a privilege collision with

366
00:13:32,000 --> 00:13:34,800
your role attaches and so

367
00:13:34,800 --> 00:13:36,639
and so some that's filtration and

368
00:13:36,639 --> 00:13:38,399
resource exposure like when you have the

369
00:13:38,399 --> 00:13:40,560
create image builder streaming like if

370
00:13:40,560 --> 00:13:42,079
they have something there you just

371
00:13:42,079 --> 00:13:44,480
create the the string url and you have

372
00:13:44,480 --> 00:13:47,760
access to the machine and that's it and

373
00:13:47,760 --> 00:13:49,440
and and if they have applications

374
00:13:49,440 --> 00:13:50,639
secrets

375
00:13:50,639 --> 00:13:53,279
something encoded or hired coded on the

376
00:13:53,279 --> 00:13:55,920
code do you have access and the same

377
00:13:55,920 --> 00:13:57,839
lateral movement you could create an

378
00:13:57,839 --> 00:14:00,079
image builder as i mentioned and that's

379
00:14:00,079 --> 00:14:02,560
the part that i mentioned here sharon on

380
00:14:02,560 --> 00:14:04,000
arsenal too

381
00:14:04,000 --> 00:14:06,000
and what is this

382
00:14:06,000 --> 00:14:08,320
there is this permission

383
00:14:08,320 --> 00:14:11,519
app string update image permission and

384
00:14:11,519 --> 00:14:13,920
as i mentioned you go to the the builder

385
00:14:13,920 --> 00:14:16,160
part and you create your your own image

386
00:14:16,160 --> 00:14:18,160
you could create a good image for a good

387
00:14:18,160 --> 00:14:20,800
purpose or you could create a malicious

388
00:14:20,800 --> 00:14:22,880
image like oh this image i have all my

389
00:14:22,880 --> 00:14:25,920
tool set and now this this stuff and

390
00:14:25,920 --> 00:14:28,160
this stuff is on my account i create the

391
00:14:28,160 --> 00:14:30,399
image on my account and what i could do

392
00:14:30,399 --> 00:14:32,240
i could share that image with your

393
00:14:32,240 --> 00:14:33,279
account

394
00:14:33,279 --> 00:14:36,880
right and when i share this image

395
00:14:36,880 --> 00:14:38,399
with your account i will do all my

396
00:14:38,399 --> 00:14:41,199
account update image permissions and

397
00:14:41,199 --> 00:14:42,639
this

398
00:14:42,639 --> 00:14:44,720
this image will appear as in your

399
00:14:44,720 --> 00:14:46,000
account

400
00:14:46,000 --> 00:14:48,079
and you you don't need to allow that it

401
00:14:48,079 --> 00:14:49,120
will appear

402
00:14:49,120 --> 00:14:50,240
right

403
00:14:50,240 --> 00:14:51,680
and so

404
00:14:51,680 --> 00:14:54,639
if i have a create image builder

405
00:14:54,639 --> 00:14:55,680
and

406
00:14:55,680 --> 00:14:58,639
i i have i i create something malicious

407
00:14:58,639 --> 00:15:00,959
i cr i can create an image builder with

408
00:15:00,959 --> 00:15:02,639
my own image

409
00:15:02,639 --> 00:15:04,560
and the fun part is

410
00:15:04,560 --> 00:15:07,440
it's when you're sharing your image you

411
00:15:07,440 --> 00:15:10,079
that decides that they they could use on

412
00:15:10,079 --> 00:15:11,120
the fleet

413
00:15:11,120 --> 00:15:13,040
and on the the

414
00:15:13,040 --> 00:15:15,120
the builder part

415
00:15:15,120 --> 00:15:18,639
and not the the target account and so

416
00:15:18,639 --> 00:15:20,079
this kind of thing

417
00:15:20,079 --> 00:15:22,639
it is something that

418
00:15:22,639 --> 00:15:25,199
for attacker for a crypto mining that

419
00:15:25,199 --> 00:15:28,079
could be a problem because i could just

420
00:15:28,079 --> 00:15:30,000
create an image like with all the the

421
00:15:30,000 --> 00:15:32,079
mine stuff and so i just

422
00:15:32,079 --> 00:15:34,560
start that image and

423
00:15:34,560 --> 00:15:36,079
okay it's probably triggered like

424
00:15:36,079 --> 00:15:38,000
something quickly but

425
00:15:38,000 --> 00:15:40,160
in another point with this update image

426
00:15:40,160 --> 00:15:42,959
permissions you have in your account the

427
00:15:42,959 --> 00:15:44,720
your your application running that

428
00:15:44,720 --> 00:15:46,639
you're providing and so i could share

429
00:15:46,639 --> 00:15:49,199
that image with my account and so in my

430
00:15:49,199 --> 00:15:51,360
account i create the image builder and i

431
00:15:51,360 --> 00:15:55,600
have access to the content inside there

432
00:15:55,600 --> 00:15:57,519
and this kind of impacts that you're

433
00:15:57,519 --> 00:15:59,600
going to have like data leak network

434
00:15:59,600 --> 00:16:01,680
access that could like just the cloud

435
00:16:01,680 --> 00:16:04,079
part or maybe as i mentioned you could

436
00:16:04,079 --> 00:16:06,320
have the direct connection and people to

437
00:16:06,320 --> 00:16:08,800
the to the to the on-premise

438
00:16:08,800 --> 00:16:10,320
you could do crypto mine data

439
00:16:10,320 --> 00:16:13,279
destruction research for a deck

440
00:16:13,279 --> 00:16:16,320
mass user infection i'm not talking here

441
00:16:16,320 --> 00:16:18,800
exactly about the mass user infection

442
00:16:18,800 --> 00:16:19,600
but

443
00:16:19,600 --> 00:16:21,680
the the person's data for the users

444
00:16:21,680 --> 00:16:24,639
could be s3 and so i could have access

445
00:16:24,639 --> 00:16:26,800
to the s3 and modify something and like

446
00:16:26,800 --> 00:16:28,880
when the user access

447
00:16:28,880 --> 00:16:32,639
they will have some surprise right

448
00:16:32,720 --> 00:16:34,880
and so some scenarios that just drink

449
00:16:34,880 --> 00:16:37,839
some water quickly

450
00:16:43,920 --> 00:16:46,240
and so first enumeration as i mentioned

451
00:16:46,240 --> 00:16:48,000
that it's pretty hard to have some

452
00:16:48,000 --> 00:16:49,680
enumeration because you probably need

453
00:16:49,680 --> 00:16:50,720
some

454
00:16:50,720 --> 00:16:52,800
some some some part of this that's

455
00:16:52,800 --> 00:16:54,000
information

456
00:16:54,000 --> 00:16:54,880
and

457
00:16:54,880 --> 00:16:57,360
and so the the first part i i make sure

458
00:16:57,360 --> 00:17:00,399
that i have access right

459
00:17:00,399 --> 00:17:02,320
to those actions

460
00:17:02,320 --> 00:17:03,759
and so

461
00:17:03,759 --> 00:17:05,599
in this case i just have the create

462
00:17:05,599 --> 00:17:07,280
image builder

463
00:17:07,280 --> 00:17:09,919
i list their roles with apps to interest

464
00:17:09,919 --> 00:17:11,839
policy until i have these threes operate

465
00:17:11,839 --> 00:17:14,400
units right and so i don't know which

466
00:17:14,400 --> 00:17:17,039
one has more capabilities but i could

467
00:17:17,039 --> 00:17:18,880
check

468
00:17:18,880 --> 00:17:22,240
and the existing builder image so you

469
00:17:22,240 --> 00:17:24,720
have like those four here

470
00:17:24,720 --> 00:17:28,400
i'll stop it oh and the good points here

471
00:17:28,400 --> 00:17:29,840
when you have a

472
00:17:29,840 --> 00:17:32,400
roll attached it will show the role so

473
00:17:32,400 --> 00:17:34,720
if i have like to choose something here

474
00:17:34,720 --> 00:17:36,640
i'll probably try to use something that

475
00:17:36,640 --> 00:17:38,799
has a whole roll attached so i could do

476
00:17:38,799 --> 00:17:40,559
a lot of more things

477
00:17:40,559 --> 00:17:43,360
and so i'm mapping the security groups

478
00:17:43,360 --> 00:17:45,520
because another way to

479
00:17:45,520 --> 00:17:48,640
just to to have access you could do ssh

480
00:17:48,640 --> 00:17:51,360
to that image or you could do something

481
00:17:51,360 --> 00:17:54,799
uh i reverse uh reverse

482
00:17:54,799 --> 00:17:57,840
shell and so i will map the security

483
00:17:57,840 --> 00:18:00,320
group that probably has more parts

484
00:18:00,320 --> 00:18:02,240
allowed and so like i

485
00:18:02,240 --> 00:18:05,440
i'll do my life easier because maybe i

486
00:18:05,440 --> 00:18:08,400
can create an image and so instead of i

487
00:18:08,400 --> 00:18:10,880
keep access the control the control

488
00:18:10,880 --> 00:18:14,320
plane and and have access i could just

489
00:18:14,320 --> 00:18:16,000
make sure that i have a security group

490
00:18:16,000 --> 00:18:18,080
that allow me to to get inside that

491
00:18:18,080 --> 00:18:21,280
machine and so i add my my key there and

492
00:18:21,280 --> 00:18:24,320
i do just network traffic and so

493
00:18:24,320 --> 00:18:27,600
probably you're not going to notice

494
00:18:27,600 --> 00:18:29,600
and so listing souvenirs and so the

495
00:18:29,600 --> 00:18:32,080
souvenirs and the eyepiece and so like

496
00:18:32,080 --> 00:18:34,080
when i'm doing the paint testing the

497
00:18:34,080 --> 00:18:36,080
guys are doing what they need they this

498
00:18:36,080 --> 00:18:38,080
kind of information is pretty important

499
00:18:38,080 --> 00:18:40,320
so those informations together will

500
00:18:40,320 --> 00:18:42,400
allow me to do a lot of things and so

501
00:18:42,400 --> 00:18:44,720
first the image builder part a resource

502
00:18:44,720 --> 00:18:46,160
exposure

503
00:18:46,160 --> 00:18:49,440
and so uh all those demos are based that

504
00:18:49,440 --> 00:18:51,760
i have read only plus

505
00:18:51,760 --> 00:18:54,000
the specific action right so i could i

506
00:18:54,000 --> 00:18:56,480
could do something

507
00:18:56,480 --> 00:18:58,160
and so i have app stream create image

508
00:18:58,160 --> 00:19:00,240
builder here

509
00:19:00,240 --> 00:19:03,360
i i i know that this result research v2

510
00:19:03,360 --> 00:19:04,799
is running

511
00:19:04,799 --> 00:19:06,960
so i basically do app stream create the

512
00:19:06,960 --> 00:19:10,799
image builder stream url the name of the

513
00:19:10,799 --> 00:19:12,640
of the

514
00:19:12,640 --> 00:19:14,559
the builder image and so it will

515
00:19:14,559 --> 00:19:17,840
generate this url and anyone that typed

516
00:19:17,840 --> 00:19:20,559
this url in the browser it will open the

517
00:19:20,559 --> 00:19:21,919
shop

518
00:19:21,919 --> 00:19:24,559
there is no no there is there isn't an

519
00:19:24,559 --> 00:19:26,799
extra authentication on our extra need

520
00:19:26,799 --> 00:19:27,840
and

521
00:19:27,840 --> 00:19:30,960
a curious part like if like five guys

522
00:19:30,960 --> 00:19:33,440
use the same url like you see each other

523
00:19:33,440 --> 00:19:35,520
typing is a kind of google drive like

524
00:19:35,520 --> 00:19:36,240
for

525
00:19:36,240 --> 00:19:39,840
for a desktop

526
00:19:39,919 --> 00:19:42,400
and so when you put this

527
00:19:42,400 --> 00:19:45,360
in the the browser rail you are getting

528
00:19:45,360 --> 00:19:48,160
inside a machine like if they if you

529
00:19:48,160 --> 00:19:49,919
have like in this case i don't have a

530
00:19:49,919 --> 00:19:51,120
roll attached

531
00:19:51,120 --> 00:19:54,480
and so i could not try to devote to the

532
00:19:54,480 --> 00:19:56,559
to the contour plane

533
00:19:56,559 --> 00:19:58,000
but

534
00:19:58,000 --> 00:20:00,240
but i i have access to i'm inside the

535
00:20:00,240 --> 00:20:02,159
vipsy and the subnet so i could try to

536
00:20:02,159 --> 00:20:04,080
do some lateral movement use the network

537
00:20:04,080 --> 00:20:07,080
part

538
00:20:09,120 --> 00:20:11,520
and so i could create an image to do

539
00:20:11,520 --> 00:20:14,159
that the same right and so

540
00:20:14,159 --> 00:20:17,360
i'm just using here to

541
00:20:17,360 --> 00:20:20,240
to show like you create image builder

542
00:20:20,240 --> 00:20:21,760
you put some name

543
00:20:21,760 --> 00:20:23,919
is you choose the instance type like

544
00:20:23,919 --> 00:20:25,840
there is some large instance

545
00:20:25,840 --> 00:20:27,760
if they going to have

546
00:20:27,760 --> 00:20:29,919
uh default internet access

547
00:20:29,919 --> 00:20:32,559
the iron of the image you want to use

548
00:20:32,559 --> 00:20:34,559
like there is like i think by default

549
00:20:34,559 --> 00:20:38,240
third image there are different options

550
00:20:38,240 --> 00:20:39,280
and so

551
00:20:39,280 --> 00:20:41,760
those information that i i i mapped

552
00:20:41,760 --> 00:20:44,080
before like the vpc config the subnet

553
00:20:44,080 --> 00:20:46,880
ids and security group ids and so i

554
00:20:46,880 --> 00:20:49,520
probably use like the subnet the subnet

555
00:20:49,520 --> 00:20:52,880
if i know the ip that i i want to to to

556
00:20:52,880 --> 00:20:54,720
achieve it's easier to choose the

557
00:20:54,720 --> 00:20:56,480
subnets and the security group as i told

558
00:20:56,480 --> 00:20:57,520
before like

559
00:20:57,520 --> 00:21:00,080
as more parts open they have

560
00:21:00,080 --> 00:21:03,600
better it is right and so

561
00:21:03,600 --> 00:21:05,039
with this

562
00:21:05,039 --> 00:21:07,120
i could get inside and try to do my

563
00:21:07,120 --> 00:21:08,400
things and

564
00:21:08,400 --> 00:21:11,120
that's image iron it's that part like if

565
00:21:11,120 --> 00:21:12,080
i

566
00:21:12,080 --> 00:21:14,400
share my image with the

567
00:21:14,400 --> 00:21:15,600
the

568
00:21:15,600 --> 00:21:18,480
the target account i could use my image

569
00:21:18,480 --> 00:21:21,600
iron here and it will be my own my

570
00:21:21,600 --> 00:21:24,480
pre-built tool

571
00:21:24,960 --> 00:21:28,080
and so a privileged collision sample

572
00:21:28,080 --> 00:21:30,159
i i need the create image builder and

573
00:21:30,159 --> 00:21:32,720
press roll

574
00:21:33,600 --> 00:21:36,000
and the biggest difference between the

575
00:21:36,000 --> 00:21:38,880
other command and this is that i have

576
00:21:38,880 --> 00:21:41,280
the i am roll iron

577
00:21:41,280 --> 00:21:44,080
that will be the password and i i will

578
00:21:44,080 --> 00:21:45,840
need

579
00:21:45,840 --> 00:21:49,600
i will need to try to specify a a rule

580
00:21:49,600 --> 00:21:52,720
here and and i roll that i i have the

581
00:21:52,720 --> 00:21:54,799
trusted policy and so that's why the

582
00:21:54,799 --> 00:21:56,799
enumeration is very important

583
00:21:56,799 --> 00:21:59,360
if if you drop my mayo could send you

584
00:21:59,360 --> 00:22:01,440
the codes like the code is nothing than

585
00:22:01,440 --> 00:22:03,919
a cli with jq like you're doing some

586
00:22:03,919 --> 00:22:04,880
pricing

587
00:22:04,880 --> 00:22:07,360
there is nothing nothing

588
00:22:07,360 --> 00:22:10,000
different from that and so when you run

589
00:22:10,000 --> 00:22:12,559
and if you show that you have the i am

590
00:22:12,559 --> 00:22:14,720
really iron with the ar the the rule

591
00:22:14,720 --> 00:22:18,240
that you specified right

592
00:22:18,240 --> 00:22:20,400
and so that's the very first step

593
00:22:20,400 --> 00:22:22,799
the second step i will create image

594
00:22:22,799 --> 00:22:25,520
builder url right and with the same name

595
00:22:25,520 --> 00:22:29,039
research v3 research v3

596
00:22:29,039 --> 00:22:31,600
and i will access

597
00:22:31,600 --> 00:22:34,320
and the biggest difference like now they

598
00:22:34,320 --> 00:22:37,440
it's generated aws.config the config has

599
00:22:37,440 --> 00:22:39,520
this command inside

600
00:22:39,520 --> 00:22:41,919
and if you run that command you have the

601
00:22:41,919 --> 00:22:43,120
the keys

602
00:22:43,120 --> 00:22:45,280
the keys that you could configure in

603
00:22:45,280 --> 00:22:47,200
your machine right

604
00:22:47,200 --> 00:22:48,480
and

605
00:22:48,480 --> 00:22:51,360
i didn't test somebody asking and but i

606
00:22:51,360 --> 00:22:53,039
didn't have time to test like if guard

607
00:22:53,039 --> 00:22:55,360
dirty is going to trigger that because i

608
00:22:55,360 --> 00:22:57,600
know that where that has now some some

609
00:22:57,600 --> 00:22:59,919
new detections that if you have a rule

610
00:22:59,919 --> 00:23:02,080
attached with an instance if you pick

611
00:23:02,080 --> 00:23:04,720
that role by some reason and use outside

612
00:23:04,720 --> 00:23:06,880
or use it in another account it's going

613
00:23:06,880 --> 00:23:10,080
to trigger and so i didn't test that but

614
00:23:10,080 --> 00:23:11,919
you can use right

615
00:23:11,919 --> 00:23:13,200
and so

616
00:23:13,200 --> 00:23:15,360
this permission uh

617
00:23:15,360 --> 00:23:18,240
because it is a profile app stream

618
00:23:18,240 --> 00:23:20,000
machine role right the app stream

619
00:23:20,000 --> 00:23:21,760
machine role the profile if you want to

620
00:23:21,760 --> 00:23:25,679
use the aws cli from this this shell

621
00:23:25,679 --> 00:23:27,760
and you you could use and like it

622
00:23:27,760 --> 00:23:29,520
depends like probably what's happened

623
00:23:29,520 --> 00:23:31,919
with that customer because i was just on

624
00:23:31,919 --> 00:23:34,320
the call but it didn't finish like but

625
00:23:34,320 --> 00:23:36,960
just opened my mind

626
00:23:36,960 --> 00:23:37,840
and

627
00:23:37,840 --> 00:23:40,320
and probably like someone get this and

628
00:23:40,320 --> 00:23:41,840
grab the keys and

629
00:23:41,840 --> 00:23:43,760
do especially like if it is

630
00:23:43,760 --> 00:23:45,840
administrator access like

631
00:23:45,840 --> 00:23:49,399
game over right

632
00:23:50,240 --> 00:23:51,360
and

633
00:23:51,360 --> 00:23:53,200
so it starts uh

634
00:23:53,200 --> 00:23:55,039
existing image as i mentioned like you

635
00:23:55,039 --> 00:23:57,840
have running and running and so i

636
00:23:57,840 --> 00:24:00,000
probably i would prefer something that i

637
00:24:00,000 --> 00:24:01,600
have a road right

638
00:24:01,600 --> 00:24:03,440
and so i just

639
00:24:03,440 --> 00:24:08,159
start image builder and the name of the

640
00:24:08,480 --> 00:24:12,240
of the the machine the image builder

641
00:24:12,240 --> 00:24:16,080
and so here a quick demo

642
00:24:17,360 --> 00:24:20,080
and so i i just run that bunch of bunch

643
00:24:20,080 --> 00:24:20,799
of

644
00:24:20,799 --> 00:24:22,480
app streaming and so i i will show like

645
00:24:22,480 --> 00:24:25,520
oh i have created builder allow it

646
00:24:25,520 --> 00:24:28,159
here is the app stream trust police

647
00:24:28,159 --> 00:24:30,720
that i have so i could choose any of

648
00:24:30,720 --> 00:24:31,600
that

649
00:24:31,600 --> 00:24:34,559
and here i have uh

650
00:24:34,559 --> 00:24:36,880
machines and just one running with a app

651
00:24:36,880 --> 00:24:39,279
so with only this permission i could try

652
00:24:39,279 --> 00:24:42,720
to to use this

653
00:24:43,120 --> 00:24:46,480
and so what i did is i just tried to

654
00:24:46,480 --> 00:24:47,440
create

655
00:24:47,440 --> 00:24:50,320
the app stream image builder url to that

656
00:24:50,320 --> 00:24:53,919
instance running it will create the url

657
00:24:53,919 --> 00:24:56,640
and you go to your web browser and you

658
00:24:56,640 --> 00:24:58,080
paste

659
00:24:58,080 --> 00:25:00,880
and boom that's it you're inside the

660
00:25:00,880 --> 00:25:03,120
machine that's pretty

661
00:25:03,120 --> 00:25:04,880
simple and that's pretty scary and

662
00:25:04,880 --> 00:25:06,080
sometimes

663
00:25:06,080 --> 00:25:08,799
at the same time

664
00:25:08,960 --> 00:25:11,279
and you have the the full

665
00:25:11,279 --> 00:25:14,159
user that runs and you have the the app

666
00:25:14,159 --> 00:25:16,159
stream machine role that you just type

667
00:25:16,159 --> 00:25:18,320
that command and you have the

668
00:25:18,320 --> 00:25:21,360
the access to the key and so

669
00:25:21,360 --> 00:25:23,279
you could try to figure out what's going

670
00:25:23,279 --> 00:25:25,360
on and besides that you have access to

671
00:25:25,360 --> 00:25:27,520
the network the subnet and so with that

672
00:25:27,520 --> 00:25:29,200
you could

673
00:25:29,200 --> 00:25:31,120
it could do whatever you want

674
00:25:31,120 --> 00:25:32,480
internally

675
00:25:32,480 --> 00:25:33,919
and so

676
00:25:33,919 --> 00:25:36,640
when i i did all these research like

677
00:25:36,640 --> 00:25:39,120
those opportunities and

678
00:25:39,120 --> 00:25:42,720
those things i i started figure out okay

679
00:25:42,720 --> 00:25:44,480
i have those opportunities maybe there

680
00:25:44,480 --> 00:25:46,480
is another way to do the same thing but

681
00:25:46,480 --> 00:25:48,240
by the end of the day the cloud trail

682
00:25:48,240 --> 00:25:51,360
logs will be the same right

683
00:25:51,360 --> 00:25:54,720
and so i start okay now the parts that i

684
00:25:54,720 --> 00:25:57,039
really want and so

685
00:25:57,039 --> 00:25:59,360
it's not our offensive

686
00:25:59,360 --> 00:26:01,840
the idea here is to make blue team great

687
00:26:01,840 --> 00:26:04,880
again right so try to to do something

688
00:26:04,880 --> 00:26:06,960
more proactive because most of the

689
00:26:06,960 --> 00:26:09,279
textions that we created is based on

690
00:26:09,279 --> 00:26:11,679
someone else's research like that the

691
00:26:11,679 --> 00:26:13,760
attackers go there they do that and do

692
00:26:13,760 --> 00:26:15,840
that and we are incidentally responder

693
00:26:15,840 --> 00:26:18,320
or the text engineers okay now we have

694
00:26:18,320 --> 00:26:20,240
to create a detection for them my goal

695
00:26:20,240 --> 00:26:21,600
here is like okay let's create a

696
00:26:21,600 --> 00:26:24,159
detection before someone i read try to

697
00:26:24,159 --> 00:26:25,360
do that

698
00:26:25,360 --> 00:26:27,919
are they abusing that

699
00:26:27,919 --> 00:26:30,159
maybe i don't know i don't think so but

700
00:26:30,159 --> 00:26:31,520
maybe they are because since we don't

701
00:26:31,520 --> 00:26:32,880
have detection

702
00:26:32,880 --> 00:26:36,000
right we don't know

703
00:26:36,400 --> 00:26:38,640
so basically what i'm trying to look in

704
00:26:38,640 --> 00:26:40,720
here like from the create image builder

705
00:26:40,720 --> 00:26:42,640
stream url the app stream start the

706
00:26:42,640 --> 00:26:44,720
image builder

707
00:26:44,720 --> 00:26:47,440
they create image builder

708
00:26:47,440 --> 00:26:50,320
and they update image permissions

709
00:26:50,320 --> 00:26:52,400
and the key point like talking about

710
00:26:52,400 --> 00:26:54,159
monitoring detection like you need to

711
00:26:54,159 --> 00:26:55,760
have the detections like you need to

712
00:26:55,760 --> 00:26:57,360
have the visibility like since you have

713
00:26:57,360 --> 00:26:59,039
cloud trail logs and going to somewhere

714
00:26:59,039 --> 00:27:01,120
else you have the visibility but you

715
00:27:01,120 --> 00:27:03,360
need to have the triggers the detection

716
00:27:03,360 --> 00:27:05,279
and so the detections we are creating

717
00:27:05,279 --> 00:27:07,679
here and maybe you have another

718
00:27:07,679 --> 00:27:09,520
information to do the incident response

719
00:27:09,520 --> 00:27:12,320
and so part of the problem try to find

720
00:27:12,320 --> 00:27:14,799
like okay i triggered that the

721
00:27:14,799 --> 00:27:17,760
because of some event some action here

722
00:27:17,760 --> 00:27:19,600
but we only have all that the

723
00:27:19,600 --> 00:27:22,240
information that i need and so i i tried

724
00:27:22,240 --> 00:27:24,399
to to do something

725
00:27:24,399 --> 00:27:25,360
and so

726
00:27:25,360 --> 00:27:27,120
basically create image builders through

727
00:27:27,120 --> 00:27:29,200
url

728
00:27:29,200 --> 00:27:31,440
uh we have the request parameters and

729
00:27:31,440 --> 00:27:33,039
the url

730
00:27:33,039 --> 00:27:35,039
is high due to security reasons makes

731
00:27:35,039 --> 00:27:36,720
sense right

732
00:27:36,720 --> 00:27:39,200
if you're not attacker just look up the

733
00:27:39,200 --> 00:27:41,279
cloud trails and you should have access

734
00:27:41,279 --> 00:27:44,480
to the url and use their url right

735
00:27:44,480 --> 00:27:47,520
and so if you don't use it any create

736
00:27:47,520 --> 00:27:48,880
image builder streamer are always

737
00:27:48,880 --> 00:27:51,679
dangerous so if you have like this

738
00:27:51,679 --> 00:27:54,640
you're using app stream your company

739
00:27:54,640 --> 00:27:56,399
sony take care maybe you could monitor

740
00:27:56,399 --> 00:27:58,080
the search ip

741
00:27:58,080 --> 00:28:00,720
but the create stream url there is not

742
00:28:00,720 --> 00:28:02,399
much room for

743
00:28:02,399 --> 00:28:04,399
specific detections

744
00:28:04,399 --> 00:28:06,720
but when i talked about the crate image

745
00:28:06,720 --> 00:28:08,000
builder so you have more more

746
00:28:08,000 --> 00:28:09,440
information there

747
00:28:09,440 --> 00:28:12,320
so you have the iam roll yarn and and

748
00:28:12,320 --> 00:28:13,600
this cool like

749
00:28:13,600 --> 00:28:16,240
because when you have the the event name

750
00:28:16,240 --> 00:28:18,159
that has the request parameter i am

751
00:28:18,159 --> 00:28:20,720
really earned is where they pass the

752
00:28:20,720 --> 00:28:22,399
rule is happening

753
00:28:22,399 --> 00:28:25,440
and because the pass rule is not logged

754
00:28:25,440 --> 00:28:27,200
that's that's set but it's not logged

755
00:28:27,200 --> 00:28:30,399
and so this kind of event that

756
00:28:30,399 --> 00:28:32,960
we detect past the rule happens

757
00:28:32,960 --> 00:28:34,799
happening somewhere

758
00:28:34,799 --> 00:28:38,799
uh the vps and so you could like make

759
00:28:38,799 --> 00:28:41,039
sure that the the rule that's going to

760
00:28:41,039 --> 00:28:42,960
be used like for this kind of create

761
00:28:42,960 --> 00:28:45,440
image builder maybe something different

762
00:28:45,440 --> 00:28:47,840
maybe it's not supposed to use the role

763
00:28:47,840 --> 00:28:50,080
uh the vpc part like maybe they are

764
00:28:50,080 --> 00:28:52,240
putting their own subnets it's not

765
00:28:52,240 --> 00:28:54,640
supposed to go to this subnet

766
00:28:54,640 --> 00:28:56,399
how the the image builder should go

767
00:28:56,399 --> 00:28:58,640
through a specific subnet a specific

768
00:28:58,640 --> 00:29:00,480
security group and so

769
00:29:00,480 --> 00:29:03,279
and by the end like the image iron and

770
00:29:03,279 --> 00:29:05,919
if the the full internet access

771
00:29:05,919 --> 00:29:07,200
and so

772
00:29:07,200 --> 00:29:09,039
here you have a bunch of opportunities

773
00:29:09,039 --> 00:29:12,360
to create detections

774
00:29:12,559 --> 00:29:14,159
and

775
00:29:14,159 --> 00:29:16,799
they start image builder like mostly you

776
00:29:16,799 --> 00:29:19,200
have the search ip address and the name

777
00:29:19,200 --> 00:29:22,320
of the the image

778
00:29:23,520 --> 00:29:26,080
but as i said like if you don't user is

779
00:29:26,080 --> 00:29:27,840
not supposed to user the app stream your

780
00:29:27,840 --> 00:29:30,159
company like any action is

781
00:29:30,159 --> 00:29:31,760
supposed to be

782
00:29:31,760 --> 00:29:33,440
malicious because it's not supposed to

783
00:29:33,440 --> 00:29:36,559
be happening

784
00:29:37,200 --> 00:29:40,080
and the update image permission the

785
00:29:40,080 --> 00:29:42,240
update image permission you have some

786
00:29:42,240 --> 00:29:44,799
room here because as i mentioned like a

787
00:29:44,799 --> 00:29:47,919
low fleet and a low image builder like

788
00:29:47,919 --> 00:29:48,799
you

789
00:29:48,799 --> 00:29:50,399
that ex

790
00:29:50,399 --> 00:29:53,919
specify what the target account could do

791
00:29:53,919 --> 00:29:54,880
right

792
00:29:54,880 --> 00:29:57,679
and the shared account like here i have

793
00:29:57,679 --> 00:29:59,679
a shared account here

794
00:29:59,679 --> 00:30:02,799
and you could maybe have a white list of

795
00:30:02,799 --> 00:30:05,039
shared accounts that you're allowed to

796
00:30:05,039 --> 00:30:06,640
share by some reason

797
00:30:06,640 --> 00:30:09,279
and so you could create a kind of allow

798
00:30:09,279 --> 00:30:11,520
list

799
00:30:12,960 --> 00:30:13,760
and

800
00:30:13,760 --> 00:30:16,080
some incident problems that i detect

801
00:30:16,080 --> 00:30:19,200
like when i create a user

802
00:30:19,200 --> 00:30:22,080
besides search ip and user agent use aws

803
00:30:22,080 --> 00:30:23,520
internal

804
00:30:23,520 --> 00:30:26,320
and all the parameters i

805
00:30:26,320 --> 00:30:29,279
he didn't do security reasons so like

806
00:30:29,279 --> 00:30:31,520
it's it's it's terrible that

807
00:30:31,520 --> 00:30:33,440
like especially like when you need to do

808
00:30:33,440 --> 00:30:35,520
incidental response like how i know the

809
00:30:35,520 --> 00:30:38,799
user that what or what's created here

810
00:30:38,799 --> 00:30:40,880
because like for me it was pretty easy

811
00:30:40,880 --> 00:30:43,679
like i have the create user

812
00:30:43,679 --> 00:30:45,279
parts here

813
00:30:45,279 --> 00:30:47,919
and the email address because how it

814
00:30:47,919 --> 00:30:50,080
works like i'm not going to get in deep

815
00:30:50,080 --> 00:30:52,240
in that but like you create a user pool

816
00:30:52,240 --> 00:30:54,720
you add the user and the user receive

817
00:30:54,720 --> 00:30:56,960
email with their url and the user and

818
00:30:56,960 --> 00:30:58,559
pass

819
00:30:58,559 --> 00:31:01,360
so he probably needs to use some email

820
00:31:01,360 --> 00:31:03,679
address that's not part of the company

821
00:31:03,679 --> 00:31:04,720
right

822
00:31:04,720 --> 00:31:07,039
and so

823
00:31:07,039 --> 00:31:09,360
if i i at least have the mma or address

824
00:31:09,360 --> 00:31:11,279
i could just just create a detection

825
00:31:11,279 --> 00:31:14,000
like if create user has event name and

826
00:31:14,000 --> 00:31:15,919
some email address

827
00:31:15,919 --> 00:31:17,679
different for my domain that's a good a

828
00:31:17,679 --> 00:31:18,960
good detection

829
00:31:18,960 --> 00:31:20,559
but like if you have this kind of

830
00:31:20,559 --> 00:31:22,320
problem you probably need to go to the

831
00:31:22,320 --> 00:31:23,360
api

832
00:31:23,360 --> 00:31:25,200
list of the users you have there and

833
00:31:25,200 --> 00:31:27,840
compare like with which ones the new one

834
00:31:27,840 --> 00:31:29,840
is the different

835
00:31:29,840 --> 00:31:32,399
so it's important like just to be ready

836
00:31:32,399 --> 00:31:33,840
right that's that that's the point

837
00:31:33,840 --> 00:31:35,600
because when these things happen you

838
00:31:35,600 --> 00:31:37,679
need to you start to scratch the

839
00:31:37,679 --> 00:31:39,360
information try to

840
00:31:39,360 --> 00:31:42,159
to to to find what's going on

841
00:31:42,159 --> 00:31:43,279
and

842
00:31:43,279 --> 00:31:44,880
if you don't have that information like

843
00:31:44,880 --> 00:31:46,720
at least you know that you need to go

844
00:31:46,720 --> 00:31:49,519
somewhere else to have that information

845
00:31:49,519 --> 00:31:51,760
and another

846
00:31:51,760 --> 00:31:53,760
fun part that's happened here

847
00:31:53,760 --> 00:31:55,919
we have the this

848
00:31:55,919 --> 00:31:56,880
this

849
00:31:56,880 --> 00:31:58,480
the web console

850
00:31:58,480 --> 00:32:00,640
and the web console

851
00:32:00,640 --> 00:32:04,240
and here you have the the cli right

852
00:32:04,240 --> 00:32:06,640
but the web console the visibility is

853
00:32:06,640 --> 00:32:09,200
shared with others because we have the

854
00:32:09,200 --> 00:32:11,760
accounts here being shared right

855
00:32:11,760 --> 00:32:13,440
and so i figure out okay

856
00:32:13,440 --> 00:32:16,240
i will create a cs pen detection use the

857
00:32:16,240 --> 00:32:17,519
because i was supposed to go to create

858
00:32:17,519 --> 00:32:20,000
for a prowler and the product that time

859
00:32:20,000 --> 00:32:22,000
is using the cli

860
00:32:22,000 --> 00:32:24,159
but when i go to cli

861
00:32:24,159 --> 00:32:27,200
the visibility show lies private

862
00:32:27,200 --> 00:32:29,519
so like there is some mismatch here and

863
00:32:29,519 --> 00:32:32,399
so i talked to aws guys

864
00:32:32,399 --> 00:32:34,480
and they open internal tickets to fix

865
00:32:34,480 --> 00:32:36,159
that like

866
00:32:36,159 --> 00:32:37,760
because the information

867
00:32:37,760 --> 00:32:39,279
is not

868
00:32:39,279 --> 00:32:40,880
i don't know how to say but the

869
00:32:40,880 --> 00:32:42,880
information is not equal

870
00:32:42,880 --> 00:32:45,039
because it's very important to show like

871
00:32:45,039 --> 00:32:47,200
it's shared because

872
00:32:47,200 --> 00:32:48,799
maybe you're not supposed to be shared

873
00:32:48,799 --> 00:32:50,320
and so like if it's shared that's a

874
00:32:50,320 --> 00:32:52,320
problem already so

875
00:32:52,320 --> 00:32:56,000
there's a kind of problem that we detect

876
00:32:56,000 --> 00:32:57,519
and that's being said

877
00:32:57,519 --> 00:32:59,360
some grad derails

878
00:32:59,360 --> 00:33:02,080
and if you don't need to use app stream

879
00:33:02,080 --> 00:33:04,159
then i have stream right

880
00:33:04,159 --> 00:33:08,640
but it's going to save

881
00:33:09,200 --> 00:33:12,399
my my account or environment where as i

882
00:33:12,399 --> 00:33:15,120
mentioned we're talk like for something

883
00:33:15,120 --> 00:33:17,440
around 300 servers

884
00:33:17,440 --> 00:33:19,120
you're being protect for one but

885
00:33:19,120 --> 00:33:21,279
probably there is a lot of more room for

886
00:33:21,279 --> 00:33:22,320
attackers

887
00:33:22,320 --> 00:33:23,279
and so

888
00:33:23,279 --> 00:33:25,279
what in my opinion what you should do

889
00:33:25,279 --> 00:33:26,159
like

890
00:33:26,159 --> 00:33:28,559
allow only service you use like the most

891
00:33:28,559 --> 00:33:30,799
important service create a scp like if

892
00:33:30,799 --> 00:33:32,559
the services are not those

893
00:33:32,559 --> 00:33:34,240
10 12 30

894
00:33:34,240 --> 00:33:36,559
something else deny

895
00:33:36,559 --> 00:33:37,760
and

896
00:33:37,760 --> 00:33:40,000
if you need to use app stream like depth

897
00:33:40,000 --> 00:33:42,080
screen right actions

898
00:33:42,080 --> 00:33:44,960
and make sure that they have condition

899
00:33:44,960 --> 00:33:47,600
i i i like to say that ip search

900
00:33:47,600 --> 00:33:50,000
conditionals ip source address pretty

901
00:33:50,000 --> 00:33:52,720
cool because like okay the the the key

902
00:33:52,720 --> 00:33:54,640
liquid but i need to

903
00:33:54,640 --> 00:33:57,200
to have access to something else and

904
00:33:57,200 --> 00:33:58,320
maybe you have a bastion hold or

905
00:33:58,320 --> 00:34:00,240
something like that

906
00:34:00,240 --> 00:34:02,240
and monitor configuration with cs pen

907
00:34:02,240 --> 00:34:04,240
too because sometimes

908
00:34:04,240 --> 00:34:07,720
it could help

909
00:34:07,840 --> 00:34:12,000
and future work and conclusions

910
00:34:12,560 --> 00:34:15,119
uh maybe explore more fleet and stack as

911
00:34:15,119 --> 00:34:17,040
i mentioned i'm on the

912
00:34:17,040 --> 00:34:20,879
image the image builder part and a bit

913
00:34:20,879 --> 00:34:22,719
on the

914
00:34:22,719 --> 00:34:25,199
the image part they were used

915
00:34:25,199 --> 00:34:27,199
uh it should have to boost the person's

916
00:34:27,199 --> 00:34:28,079
data

917
00:34:28,079 --> 00:34:30,079
so maybe there is more opportunities

918
00:34:30,079 --> 00:34:31,520
there

919
00:34:31,520 --> 00:34:33,440
and stood more about the user pulling in

920
00:34:33,440 --> 00:34:36,399
the integrations

921
00:34:36,480 --> 00:34:38,320
create some sigma rules so i think it

922
00:34:38,320 --> 00:34:40,159
would be pretty interesting like create

923
00:34:40,159 --> 00:34:43,359
sigma rules and anyone could use the

924
00:34:43,359 --> 00:34:45,040
those detections

925
00:34:45,040 --> 00:34:48,159
oh add to paco framework right they they

926
00:34:48,159 --> 00:34:49,839
have like 22

927
00:34:49,839 --> 00:34:51,679
privilege collation stuff maybe we could

928
00:34:51,679 --> 00:34:55,520
add more and so when we're doing some

929
00:34:55,520 --> 00:34:57,520
some testing we probably could attack

930
00:34:57,520 --> 00:34:58,640
and maybe

931
00:34:58,640 --> 00:35:00,480
create a closed scenario so we could

932
00:35:00,480 --> 00:35:03,760
simulate and see how it works

933
00:35:03,760 --> 00:35:06,480
and my as i mentioned my main idea is to

934
00:35:06,480 --> 00:35:08,079
create an accidental response you cheat

935
00:35:08,079 --> 00:35:11,359
for oncomo aws service

936
00:35:11,359 --> 00:35:13,200
and when i am talking about like

937
00:35:13,200 --> 00:35:14,480
creating this

938
00:35:14,480 --> 00:35:16,160
is it's something like that the main

939
00:35:16,160 --> 00:35:18,400
idea is like to try to create an

940
00:35:18,400 --> 00:35:20,320
incident response plan

941
00:35:20,320 --> 00:35:23,119
that you are ready ready right and so

942
00:35:23,119 --> 00:35:25,200
know the service you you have no the

943
00:35:25,200 --> 00:35:27,680
service you you have no idea like what

944
00:35:27,680 --> 00:35:29,200
how they worked

945
00:35:29,200 --> 00:35:31,680
and like create detections understand

946
00:35:31,680 --> 00:35:33,520
what could go wrong and this kind of

947
00:35:33,520 --> 00:35:36,160
thing but you have 300 service right and

948
00:35:36,160 --> 00:35:38,000
so like the idea is to create something

949
00:35:38,000 --> 00:35:40,160
crowd sources because i would probably

950
00:35:40,160 --> 00:35:42,320
look at this because some companies

951
00:35:42,320 --> 00:35:45,680
customers have that and so someone some

952
00:35:45,680 --> 00:35:47,599
someone i also will look for something

953
00:35:47,599 --> 00:35:50,000
different

954
00:35:50,640 --> 00:35:52,640
and some conclusions deny what you don't

955
00:35:52,640 --> 00:35:53,520
need

956
00:35:53,520 --> 00:35:56,079
remove builder image you don't need

957
00:35:56,079 --> 00:35:58,960
right because like some problems that i

958
00:35:58,960 --> 00:36:01,599
i i mentioned there i i need to have an

959
00:36:01,599 --> 00:36:04,240
image builder a red built like and

960
00:36:04,240 --> 00:36:05,200
running

961
00:36:05,200 --> 00:36:07,440
and so if you have no image builder

962
00:36:07,440 --> 00:36:09,599
there like i need more

963
00:36:09,599 --> 00:36:10,839
more

964
00:36:10,839 --> 00:36:13,599
privilege and so if you

965
00:36:13,599 --> 00:36:15,359
need to keep doing something by some

966
00:36:15,359 --> 00:36:17,359
reason stop at least so i need two

967
00:36:17,359 --> 00:36:19,839
actions instead of one like

968
00:36:19,839 --> 00:36:21,359
use condition

969
00:36:21,359 --> 00:36:23,440
as i mentioned already understand and

970
00:36:23,440 --> 00:36:26,320
study service you use

971
00:36:26,320 --> 00:36:28,640
and most important part if you have some

972
00:36:28,640 --> 00:36:30,320
service running in your environment make

973
00:36:30,320 --> 00:36:32,800
sure you have some detection like like

974
00:36:32,800 --> 00:36:35,200
some understand like at least go for

975
00:36:35,200 --> 00:36:37,680
example for the emrk like

976
00:36:37,680 --> 00:36:39,599
permissions.cloud

977
00:36:39,599 --> 00:36:43,920
for aws pick the rights and maybe the

978
00:36:43,920 --> 00:36:46,079
the management actions about that

979
00:36:46,079 --> 00:36:48,160
service and try to see what you

980
00:36:48,160 --> 00:36:50,560
how they works on if something logged

981
00:36:50,560 --> 00:36:53,680
already or as i used to do like start to

982
00:36:53,680 --> 00:36:55,680
clicking everything and see what's going

983
00:36:55,680 --> 00:36:57,520
on what's being generated and this kind

984
00:36:57,520 --> 00:36:59,520
of thing

985
00:36:59,520 --> 00:37:02,240
i think i speak like

986
00:37:02,240 --> 00:37:03,119
okay

987
00:37:03,119 --> 00:37:05,599
third five thirty six minutes and that's

988
00:37:05,599 --> 00:37:07,119
it

989
00:37:07,119 --> 00:37:08,880
thank you very much

990
00:37:08,880 --> 00:37:13,749
[Applause]

