1
00:00:00,000 --> 00:00:02,879
all right hello good afternoon welcome

2
00:00:02,879 --> 00:00:05,160
to b-sides Las Vegas you are in breaking

3
00:00:05,160 --> 00:00:06,540
ground

4
00:00:06,540 --> 00:00:09,960
uh this talk is the north northern

5
00:00:09,960 --> 00:00:12,120
Virginia Shuffle lateral movement and

6
00:00:12,120 --> 00:00:14,040
other Creative Steps attackers take in

7
00:00:14,040 --> 00:00:16,320
AWS Cloud environments and how to detect

8
00:00:16,320 --> 00:00:18,720
them let's get started please welcome

9
00:00:18,720 --> 00:00:20,940
Philippe proteus

10
00:00:20,940 --> 00:00:24,190
[Applause]

11
00:00:24,480 --> 00:00:26,340
thank you everybody thank you for coming

12
00:00:26,340 --> 00:00:30,060
for my talk so my name is Philippe as

13
00:00:30,060 --> 00:00:33,540
you you heard from Pierce and my

14
00:00:33,540 --> 00:00:36,480
nickname is proteus so just my mom

15
00:00:36,480 --> 00:00:38,579
called Philip so

16
00:00:38,579 --> 00:00:40,920
you can Comfort us wherever you find me

17
00:00:40,920 --> 00:00:44,700
whenever so a little bit about me I have

18
00:00:44,700 --> 00:00:47,280
at least 10 years of experience in

19
00:00:47,280 --> 00:00:50,760
Security in general I'm a proud father

20
00:00:50,760 --> 00:00:52,020
of a girl

21
00:00:52,020 --> 00:00:54,480
and also blue team structure back in

22
00:00:54,480 --> 00:00:55,500
Brazil

23
00:00:55,500 --> 00:00:57,600
and I'm security researcher at Mt

24
00:00:57,600 --> 00:01:00,059
security did you think she's security is

25
00:01:00,059 --> 00:01:03,480
a startup company based uh focused in

26
00:01:03,480 --> 00:01:05,400
Cloud security and third-party risk

27
00:01:05,400 --> 00:01:08,520
management and as a asthma's role as

28
00:01:08,520 --> 00:01:10,020
security researcher

29
00:01:10,020 --> 00:01:12,920
part of my job is Googling around

30
00:01:12,920 --> 00:01:16,080
reading documentations and writing box

31
00:01:16,080 --> 00:01:17,939
to test for their abilities and this

32
00:01:17,939 --> 00:01:18,900
kind of stuff

33
00:01:18,900 --> 00:01:22,380
and sometimes we help our clients with

34
00:01:22,380 --> 00:01:25,979
with questions so I I was there one day

35
00:01:25,979 --> 00:01:29,159
Googling around reading docs and one of

36
00:01:29,159 --> 00:01:32,220
our clients came to us and asking about

37
00:01:32,220 --> 00:01:35,460
his Network diagram on AWS and he was

38
00:01:35,460 --> 00:01:37,380
doing all kinds of nasty stuff he was

39
00:01:37,380 --> 00:01:38,659
doing things like

40
00:01:38,659 --> 00:01:40,740
people's appearing between Dev and

41
00:01:40,740 --> 00:01:42,780
product environment draws accounts

42
00:01:42,780 --> 00:01:44,340
between that and project environments

43
00:01:44,340 --> 00:01:46,079
and I said no

44
00:01:46,079 --> 00:01:48,360
you're doing something really nasty here

45
00:01:48,360 --> 00:01:50,220
you shouldn't doing this because there's

46
00:01:50,220 --> 00:01:52,079
the problem of lateral movements and he

47
00:01:52,079 --> 00:01:54,659
says what and yeah and then I explain

48
00:01:54,659 --> 00:01:57,540
him and then something popped in my mind

49
00:01:57,540 --> 00:02:00,960
I just realized that uh Cloud security

50
00:02:00,960 --> 00:02:04,159
is more complex than on-premise security

51
00:02:04,159 --> 00:02:07,799
and I know that's a bold statement but I

52
00:02:07,799 --> 00:02:11,640
do have uh analogy or a metaphor to

53
00:02:11,640 --> 00:02:13,020
explain that

54
00:02:13,020 --> 00:02:14,120
so

55
00:02:14,120 --> 00:02:16,739
by the title of this talk

56
00:02:16,739 --> 00:02:20,040
when I submitted this talk to besides I

57
00:02:20,040 --> 00:02:23,099
was thinking well what things work

58
00:02:23,099 --> 00:02:26,160
laterally and doesn't work watery so I

59
00:02:26,160 --> 00:02:29,520
can think get a thing for my talk and

60
00:02:29,520 --> 00:02:31,319
the only thing that I could think was

61
00:02:31,319 --> 00:02:33,420
scraps but I don't like crabs I guess

62
00:02:33,420 --> 00:02:36,420
nobody like crabs so I was talking to my

63
00:02:36,420 --> 00:02:39,360
boss Sierra and he told me about this

64
00:02:39,360 --> 00:02:41,879
kind of dances it's called Texas Shuffle

65
00:02:41,879 --> 00:02:44,099
and for those who doesn't know which

66
00:02:44,099 --> 00:02:46,860
Texas Shuffle kind of dancing style is

67
00:02:46,860 --> 00:02:50,780
is something like this

68
00:03:13,980 --> 00:03:15,599
seems nice right

69
00:03:15,599 --> 00:03:18,120
but I'm a Brazilian and I'm from Rio

70
00:03:18,120 --> 00:03:21,000
Janeiro actually so I have to bring

71
00:03:21,000 --> 00:03:24,120
something for you for you guys to do a

72
00:03:24,120 --> 00:03:26,400
contrast between the Texas Shuffle and

73
00:03:26,400 --> 00:03:28,440
the dancing that I brought here today is

74
00:03:28,440 --> 00:03:30,599
something that we call pasino it's like

75
00:03:30,599 --> 00:03:36,738
a Brazilian thing so kind of like this

76
00:03:56,360 --> 00:04:00,060
yeah two different dancing styles with

77
00:04:00,060 --> 00:04:03,239
their respective differences

78
00:04:03,239 --> 00:04:06,000
but and you'll get a little bit more on

79
00:04:06,000 --> 00:04:07,739
this later

80
00:04:07,739 --> 00:04:12,200
but just keep those dancing in mind

81
00:04:13,980 --> 00:04:16,978
so when we talk about lateral movements

82
00:04:16,978 --> 00:04:20,459
and possibilities of lateral movements

83
00:04:20,459 --> 00:04:23,100
how many of you guys already did a pen

84
00:04:23,100 --> 00:04:26,160
test on on-prem's Networks

85
00:04:26,160 --> 00:04:28,919
how long did you guys take to get a

86
00:04:28,919 --> 00:04:32,220
domain to me more than a day or more

87
00:04:32,220 --> 00:04:33,419
than two days

88
00:04:33,419 --> 00:04:35,759
usually you just pivot pretty fast

89
00:04:35,759 --> 00:04:37,800
between all the networks find the domain

90
00:04:37,800 --> 00:04:41,340
to me uh get the credentials and becomes

91
00:04:41,340 --> 00:04:44,220
a domain administrator right so this can

92
00:04:44,220 --> 00:04:47,580
also be done on AWS

93
00:04:47,580 --> 00:04:48,780
but

94
00:04:48,780 --> 00:04:51,600
on AWS you can have separate accounts so

95
00:04:51,600 --> 00:04:53,759
you can have account a and account to be

96
00:04:53,759 --> 00:04:56,639
and for do this kind of things in AWS

97
00:04:56,639 --> 00:04:58,860
must have to be a VPC bearing between

98
00:04:58,860 --> 00:05:01,620
those accounts and those vpcs right

99
00:05:01,620 --> 00:05:04,199
so when an attacker usually attacker

100
00:05:04,199 --> 00:05:07,020
doesn't land when he went when they when

101
00:05:07,020 --> 00:05:09,180
when their objective is so he has to

102
00:05:09,180 --> 00:05:12,479
move laterally right so if he hackets

103
00:05:12,479 --> 00:05:15,600
are instance on the vpca

104
00:05:15,600 --> 00:05:18,360
he can find out on other networks and

105
00:05:18,360 --> 00:05:21,479
move laterally into the vpcb and so on

106
00:05:21,479 --> 00:05:25,500
this thing in AWS we call data plane and

107
00:05:25,500 --> 00:05:27,240
data plane is where your data lives

108
00:05:27,240 --> 00:05:28,440
actually

109
00:05:28,440 --> 00:05:32,400
but on cloud we also have another plane

110
00:05:32,400 --> 00:05:35,100
that's called the control plane and the

111
00:05:35,100 --> 00:05:37,740
control plane is like it's all the apis

112
00:05:37,740 --> 00:05:39,000
that you call

113
00:05:39,000 --> 00:05:40,440
to

114
00:05:40,440 --> 00:05:43,199
make requests to your cloud provider for

115
00:05:43,199 --> 00:05:46,259
example in AWS you called it the control

116
00:05:46,259 --> 00:05:49,680
plane to create a new VPC to create easy

117
00:05:49,680 --> 00:05:51,960
to ministers RS3 buckets or something

118
00:05:51,960 --> 00:05:53,460
things like that

119
00:05:53,460 --> 00:05:54,840
and

120
00:05:54,840 --> 00:05:58,199
the the thing with the data plane to get

121
00:05:58,199 --> 00:05:59,699
in you just have to get something

122
00:05:59,699 --> 00:06:02,100
exposed like an IP address or things

123
00:06:02,100 --> 00:06:04,199
like that but just to get in on the

124
00:06:04,199 --> 00:06:06,120
control plane you're gonna need a

125
00:06:06,120 --> 00:06:10,380
credential or a login password or AWS

126
00:06:10,380 --> 00:06:13,680
access three keys and so on in the

127
00:06:13,680 --> 00:06:15,600
control plane you have entities like

128
00:06:15,600 --> 00:06:20,100
users rows groups and things like that

129
00:06:20,100 --> 00:06:23,400
so how do you move it laterally on the

130
00:06:23,400 --> 00:06:25,860
control plane so here you have a row and

131
00:06:25,860 --> 00:06:27,539
in account a

132
00:06:27,539 --> 00:06:30,120
and this road can assume another road

133
00:06:30,120 --> 00:06:34,500
the road to in the same account

134
00:06:34,500 --> 00:06:36,180
but the thing is

135
00:06:36,180 --> 00:06:39,360
the the attacker who has who got the

136
00:06:39,360 --> 00:06:42,360
role well he could also Zack and create

137
00:06:42,360 --> 00:06:45,720
an instance on the vpca and then he can

138
00:06:45,720 --> 00:06:47,699
jump from the control plane into the

139
00:06:47,699 --> 00:06:49,380
data plane

140
00:06:49,380 --> 00:06:52,319
and if the attacker gotta is a first

141
00:06:52,319 --> 00:06:55,199
hackage aec2 instance and he find out

142
00:06:55,199 --> 00:06:57,180
that his institutions has a role

143
00:06:57,180 --> 00:06:59,520
attached to it he can assume that role

144
00:06:59,520 --> 00:07:01,800
and jump to the control plane

145
00:07:01,800 --> 00:07:05,340
and from there he can also find out on

146
00:07:05,340 --> 00:07:07,800
other networks and other accounts in AWS

147
00:07:07,800 --> 00:07:11,759
and jump from account a to account B

148
00:07:11,759 --> 00:07:14,639
and he could also from the same ec2

149
00:07:14,639 --> 00:07:16,680
instance if he find out another account

150
00:07:16,680 --> 00:07:19,020
he can jump from the institutions in

151
00:07:19,020 --> 00:07:22,380
account a to another role in a in

152
00:07:22,380 --> 00:07:26,220
account B so you can think

153
00:07:26,220 --> 00:07:28,080
pretty much see that this these things

154
00:07:28,080 --> 00:07:30,240
getting even more complex than on-premes

155
00:07:30,240 --> 00:07:31,979
Network right

156
00:07:31,979 --> 00:07:34,800
and even though uh the same attacker who

157
00:07:34,800 --> 00:07:36,419
has a role in account

158
00:07:36,419 --> 00:07:39,960
in account TB he can also exec and his

159
00:07:39,960 --> 00:07:42,419
due to create an instance on VPC on

160
00:07:42,419 --> 00:07:44,639
account to be so

161
00:07:44,639 --> 00:07:48,599
really really mess right so just to

162
00:07:48,599 --> 00:07:50,280
bring that comparison between those

163
00:07:50,280 --> 00:07:52,379
dances and I promise to my sister-in-law

164
00:07:52,379 --> 00:07:54,900
do not make comparisons between dances

165
00:07:54,900 --> 00:07:57,060
because that's not something that you

166
00:07:57,060 --> 00:07:59,819
should do but we can compare features

167
00:07:59,819 --> 00:08:03,060
between those dances so who thought that

168
00:08:03,060 --> 00:08:05,400
the Brazilian Frank would be more hard

169
00:08:05,400 --> 00:08:07,460
to learn

170
00:08:07,460 --> 00:08:10,259
uh oh well who thought that the

171
00:08:10,259 --> 00:08:11,580
Brazilian Funk would be harder to learn

172
00:08:11,580 --> 00:08:13,800
than Texas Shuffle anyway

173
00:08:13,800 --> 00:08:15,539
yeah

174
00:08:15,539 --> 00:08:18,539
but the thing is the Brazilian fact it's

175
00:08:18,539 --> 00:08:21,539
only fast he was dancing by himself fast

176
00:08:21,539 --> 00:08:23,400
moves yeah but there's him by himself

177
00:08:23,400 --> 00:08:26,699
the Texas Shuffle uh he has to interact

178
00:08:26,699 --> 00:08:28,199
that has interaction between the

179
00:08:28,199 --> 00:08:31,319
partners so they also can dance by

180
00:08:31,319 --> 00:08:33,839
themselves if you watch the

181
00:08:33,839 --> 00:08:36,419
the video clip again they also then

182
00:08:36,419 --> 00:08:38,159
separated between them but they also

183
00:08:38,159 --> 00:08:40,260
have to coordinate their weights and

184
00:08:40,260 --> 00:08:42,419
balance between them so there's much

185
00:08:42,419 --> 00:08:45,360
more aspects and complexity in Texas

186
00:08:45,360 --> 00:08:48,360
Shuffle than Brazilian passing you

187
00:08:48,360 --> 00:08:49,800
so

188
00:08:49,800 --> 00:08:52,320
the texture Shuffle should be our Cloud

189
00:08:52,320 --> 00:08:53,640
environment

190
00:08:53,640 --> 00:08:55,500
the comparison between data planning

191
00:08:55,500 --> 00:08:57,180
control plane and the balancing between

192
00:08:57,180 --> 00:08:59,540
those

193
00:09:01,860 --> 00:09:02,880
so

194
00:09:02,880 --> 00:09:04,220
uh

195
00:09:04,220 --> 00:09:07,760
I created not created actually I just

196
00:09:07,760 --> 00:09:10,800
copied from the Cupid Shuffle some steps

197
00:09:10,800 --> 00:09:13,440
to introduce you to the lateral

198
00:09:13,440 --> 00:09:16,320
movements so everybody knows that musk

199
00:09:16,320 --> 00:09:18,420
is that to the left to the left to the

200
00:09:18,420 --> 00:09:20,339
right to the right now click now kick

201
00:09:20,339 --> 00:09:22,800
now walking by yourself but that's a

202
00:09:22,800 --> 00:09:24,360
really Anthem

203
00:09:24,360 --> 00:09:27,060
um at least Cruisers and things like

204
00:09:27,060 --> 00:09:28,320
that in marriages

205
00:09:28,320 --> 00:09:31,080
so when we talk about lateral movements

206
00:09:31,080 --> 00:09:33,000
on the data plane

207
00:09:33,000 --> 00:09:34,620
uh

208
00:09:34,620 --> 00:09:37,320
you between two two easy two instances

209
00:09:37,320 --> 00:09:41,339
on different vpcs connected by a VPC

210
00:09:41,339 --> 00:09:42,600
peering

211
00:09:42,600 --> 00:09:45,060
some things doesn't work as expected for

212
00:09:45,060 --> 00:09:48,360
example iarp protocol RP protocol

213
00:09:48,360 --> 00:09:51,600
doesn't work as expected because in AWS

214
00:09:51,600 --> 00:09:53,360
you don't have the broadcast broadcast

215
00:09:53,360 --> 00:09:57,380
so if you enter in consult and do

216
00:09:57,380 --> 00:10:00,000
arp-a you won't see any machine just

217
00:10:00,000 --> 00:10:01,860
your machine in the router

218
00:10:01,860 --> 00:10:04,440
so there is no easy ways for an attacker

219
00:10:04,440 --> 00:10:06,839
to find out which other networks are

220
00:10:06,839 --> 00:10:09,480
connected to the to this account so the

221
00:10:09,480 --> 00:10:12,180
solution for this is to do a network

222
00:10:12,180 --> 00:10:15,660
scam so he can scan the whole range the

223
00:10:15,660 --> 00:10:18,779
whole slash eight range it's nice but

224
00:10:18,779 --> 00:10:22,620
effective it's gonna if you the

225
00:10:22,620 --> 00:10:24,779
if the blue team of that company has

226
00:10:24,779 --> 00:10:26,519
some flow logs and things like that

227
00:10:26,519 --> 00:10:29,060
you're gonna catch him

228
00:10:29,060 --> 00:10:32,899
but it's effective for the attacker so

229
00:10:32,899 --> 00:10:35,880
he couldn't find a new instance on those

230
00:10:35,880 --> 00:10:38,399
and other vpcs and on other sub networks

231
00:10:38,399 --> 00:10:40,980
and then hack it their way into this new

232
00:10:40,980 --> 00:10:43,399
instance

233
00:10:44,940 --> 00:10:48,480
another kind of lateral movement is when

234
00:10:48,480 --> 00:10:51,120
the attacker came from the ec2 he hacked

235
00:10:51,120 --> 00:10:53,100
the ec2 instance for example

236
00:10:53,100 --> 00:10:56,519
and or a Lambda or ECS or a batch job

237
00:10:56,519 --> 00:11:00,660
there's any kind of data plane uh

238
00:11:00,660 --> 00:11:04,260
things that can assume a role and he can

239
00:11:04,260 --> 00:11:06,480
just get those information enter on this

240
00:11:06,480 --> 00:11:08,760
machine if there is a role attached to

241
00:11:08,760 --> 00:11:11,339
it he can store these credentials and

242
00:11:11,339 --> 00:11:13,740
jump into the control plane

243
00:11:13,740 --> 00:11:16,320
by doing this something pretty much like

244
00:11:16,320 --> 00:11:19,860
this so the attacker lens so this is

245
00:11:19,860 --> 00:11:23,820
situ instance so he does a STS get

246
00:11:23,820 --> 00:11:26,160
caller identity to find out which hole

247
00:11:26,160 --> 00:11:28,860
he has and now you can see that he has

248
00:11:28,860 --> 00:11:30,899
the thing she easy to roll

249
00:11:30,899 --> 00:11:34,200
so you're going to dump credentials to

250
00:11:34,200 --> 00:11:36,779
jump to the control plane by doing this

251
00:11:36,779 --> 00:11:39,000
he is working he's using the metadata

252
00:11:39,000 --> 00:11:42,000
metadata is a service from AWS who gives

253
00:11:42,000 --> 00:11:44,760
a lot of information about the the role

254
00:11:44,760 --> 00:11:47,519
that that situ instance has and

255
00:11:47,519 --> 00:11:50,220
credentials and informations about that

256
00:11:50,220 --> 00:11:52,800
instance so here the attack would be

257
00:11:52,800 --> 00:11:56,100
able to get the credentials and then he

258
00:11:56,100 --> 00:11:58,380
can use uh some tools to post

259
00:11:58,380 --> 00:12:00,720
exploration that one of the tools is the

260
00:12:00,720 --> 00:12:04,200
paku it's a open source AWS exploitation

261
00:12:04,200 --> 00:12:06,360
framework developed by the Reno security

262
00:12:06,360 --> 00:12:09,779
guys so if you guys don't know this tool

263
00:12:09,779 --> 00:12:12,600
just download and play around pretty

264
00:12:12,600 --> 00:12:16,920
good too has some some

265
00:12:16,920 --> 00:12:19,200
defects I don't know how to say that but

266
00:12:19,200 --> 00:12:23,060
it's pretty good too in general

267
00:12:23,639 --> 00:12:25,079
so

268
00:12:25,079 --> 00:12:27,060
there is another kind of lateral

269
00:12:27,060 --> 00:12:29,820
movement that are called here step down

270
00:12:29,820 --> 00:12:32,579
and that means when when an attacker is

271
00:12:32,579 --> 00:12:35,160
able to get any kind of credentials or

272
00:12:35,160 --> 00:12:38,760
access keys or uh login password without

273
00:12:38,760 --> 00:12:42,060
MFA from a user or perhaps with MFA with

274
00:12:42,060 --> 00:12:44,760
phishing uh the attacker get

275
00:12:44,760 --> 00:12:46,500
discrimination connects the control

276
00:12:46,500 --> 00:12:50,579
plane and if he find out there is a VPC

277
00:12:50,579 --> 00:12:53,519
there and he wants to see what else

278
00:12:53,519 --> 00:12:55,560
hasn't that he doesn't have enough

279
00:12:55,560 --> 00:12:57,560
permissions to walking around that

280
00:12:57,560 --> 00:13:00,779
networks well he creates a new ec2

281
00:13:00,779 --> 00:13:03,480
instance then he sends a command for

282
00:13:03,480 --> 00:13:04,920
that institution instance for example

283
00:13:04,920 --> 00:13:09,240
using the SSM or loading the data inside

284
00:13:09,240 --> 00:13:11,339
the user data for that Institute

285
00:13:11,339 --> 00:13:13,920
instance and then he can jump to that

286
00:13:13,920 --> 00:13:16,680
easy to instance and execute code here

287
00:13:16,680 --> 00:13:19,920
in this example the attacker he sends an

288
00:13:19,920 --> 00:13:23,220
sscm sent comments to an instance and

289
00:13:23,220 --> 00:13:25,740
creating a reverse shell for here

290
00:13:25,740 --> 00:13:31,399
attacker IP address on part 31 3037

291
00:13:37,860 --> 00:13:41,160
so and when we talk about lateral

292
00:13:41,160 --> 00:13:43,620
movements on the control plane things

293
00:13:43,620 --> 00:13:45,300
are a little bit more trickier than on

294
00:13:45,300 --> 00:13:47,579
the data plane right so

295
00:13:47,579 --> 00:13:50,820
uh here we have three accounts let's

296
00:13:50,820 --> 00:13:52,139
assume that we have three accounts

297
00:13:52,139 --> 00:13:54,959
accounts a account B and account C if

298
00:13:54,959 --> 00:13:56,579
the attacker gets a credential and

299
00:13:56,579 --> 00:13:57,839
accounts a

300
00:13:57,839 --> 00:14:00,740
and the accounts B has this following

301
00:14:00,740 --> 00:14:04,079
policy here that says that the principle

302
00:14:04,079 --> 00:14:07,740
is a AWS any entity coming from the

303
00:14:07,740 --> 00:14:10,920
account a so a user is an entity from

304
00:14:10,920 --> 00:14:13,980
account hey can assume role so an

305
00:14:13,980 --> 00:14:15,720
attacker would be able to jump from the

306
00:14:15,720 --> 00:14:18,480
account a to the account B without no

307
00:14:18,480 --> 00:14:20,760
problem and assume this row

308
00:14:20,760 --> 00:14:23,880
but when you think uh an attacker got

309
00:14:23,880 --> 00:14:26,160
access to account B and he wants to jump

310
00:14:26,160 --> 00:14:29,459
to account C you think you you you're

311
00:14:29,459 --> 00:14:31,920
tempting to think that

312
00:14:31,920 --> 00:14:34,560
this policy must be enough for him to

313
00:14:34,560 --> 00:14:36,959
jump between accounts from account to be

314
00:14:36,959 --> 00:14:40,199
to account C but that's not true because

315
00:14:40,199 --> 00:14:43,940
when it happens when uh the the attacker

316
00:14:43,940 --> 00:14:46,260
assumed the role from accounting a to

317
00:14:46,260 --> 00:14:48,060
account to B and then try to assume a

318
00:14:48,060 --> 00:14:50,459
role in account C he is not actually

319
00:14:50,459 --> 00:14:53,279
coming from the account B it's coming

320
00:14:53,279 --> 00:14:56,579
from accounting a and this policy won't

321
00:14:56,579 --> 00:14:57,899
work

322
00:14:57,899 --> 00:15:00,420
the true pulse that has to work it's

323
00:15:00,420 --> 00:15:03,000
something like this it has to be uh

324
00:15:03,000 --> 00:15:06,420
assumed role for an account to be with a

325
00:15:06,420 --> 00:15:08,279
role and when you assume a rolling

326
00:15:08,279 --> 00:15:10,800
account you should you should usually

327
00:15:10,800 --> 00:15:15,000
you put a value like a testing or your

328
00:15:15,000 --> 00:15:17,639
name your username something like that

329
00:15:17,639 --> 00:15:20,160
and it also has to happen here in the

330
00:15:20,160 --> 00:15:22,079
policy on our company

331
00:15:22,079 --> 00:15:24,120
I would be pretty honest with you guys

332
00:15:24,120 --> 00:15:26,760
I've never seen this in any of our

333
00:15:26,760 --> 00:15:29,759
clients nothing like that so I suppose

334
00:15:29,759 --> 00:15:31,980
not work like this

335
00:15:31,980 --> 00:15:35,399
and the thing is that that thing that we

336
00:15:35,399 --> 00:15:37,740
call uh assuming role a summary rule on

337
00:15:37,740 --> 00:15:39,959
being a Sumo role on C it's called

338
00:15:39,959 --> 00:15:42,420
roller chaining and this has a hard

339
00:15:42,420 --> 00:15:46,380
limit of one hour from AWS so even

340
00:15:46,380 --> 00:15:48,540
though if you could be able to assume

341
00:15:48,540 --> 00:15:51,420
around be in a summer role on C uh the

342
00:15:51,420 --> 00:15:52,920
maximum time that you can assume that

343
00:15:52,920 --> 00:15:54,540
role is for one hour

344
00:15:54,540 --> 00:15:57,440
that's not much a big problem because

345
00:15:57,440 --> 00:16:00,899
all the apis from the AWS are real real

346
00:16:00,899 --> 00:16:03,420
well documented and attacker might

347
00:16:03,420 --> 00:16:05,519
script their way and creating

348
00:16:05,519 --> 00:16:08,820
persistence in back doors all over so

349
00:16:08,820 --> 00:16:12,420
this role chaining is not a big problem

350
00:16:12,420 --> 00:16:14,940
but an attacker can be creative right

351
00:16:14,940 --> 00:16:17,759
and usually they are so there's another

352
00:16:17,759 --> 00:16:20,100
kind of movement that are called now

353
00:16:20,100 --> 00:16:24,720
geek because when this policy comes from

354
00:16:24,720 --> 00:16:27,420
the accounts B the account B is the root

355
00:16:27,420 --> 00:16:30,240
an entity on an account to be right so

356
00:16:30,240 --> 00:16:32,339
if your attacker has the action or the

357
00:16:32,339 --> 00:16:35,220
ability to create an Institute instance

358
00:16:35,220 --> 00:16:38,120
he would be able

359
00:16:39,120 --> 00:16:42,120
whatever

360
00:16:44,100 --> 00:16:47,100
all right so when they are counting when

361
00:16:47,100 --> 00:16:51,240
an attacker in a county would be able to

362
00:16:51,240 --> 00:16:56,160
to exact uh create an ec2 instance on

363
00:16:56,160 --> 00:16:57,540
the same account

364
00:16:57,540 --> 00:17:00,240
the ac2 instance is a entity on this

365
00:17:00,240 --> 00:17:02,459
account so he would be able to assume a

366
00:17:02,459 --> 00:17:04,319
role give a permission to enter which is

367
00:17:04,319 --> 00:17:06,059
a situations to assume a role on account

368
00:17:06,059 --> 00:17:09,059
B and he jumps to account to be as an

369
00:17:09,059 --> 00:17:11,819
entity assumed by account a but he also

370
00:17:11,819 --> 00:17:13,980
could be able to create a new instance

371
00:17:13,980 --> 00:17:16,319
on accounts B

372
00:17:16,319 --> 00:17:19,140
and then jump to account B and then

373
00:17:19,140 --> 00:17:21,419
assume a rolling account receipt and

374
00:17:21,419 --> 00:17:24,599
would be something like this

375
00:17:24,599 --> 00:17:27,299
so he he went to the control plane down

376
00:17:27,299 --> 00:17:29,400
to the data plane back to the control

377
00:17:29,400 --> 00:17:31,679
plane down to the data plane and then

378
00:17:31,679 --> 00:17:33,900
back to the control plane again until he

379
00:17:33,900 --> 00:17:35,820
reached the account seat

380
00:17:35,820 --> 00:17:39,240
so that's the curse because AWS doesn't

381
00:17:39,240 --> 00:17:42,000
reach a situ instance uh

382
00:17:42,000 --> 00:17:45,419
a situations using roles as a rolly

383
00:17:45,419 --> 00:17:47,820
chaining thing so there's no limits

384
00:17:47,820 --> 00:17:50,400
there's a limit to up to 12 hours

385
00:17:50,400 --> 00:17:54,080
but it's a way to bypass that

386
00:17:55,500 --> 00:17:58,559
so what are the attacker requirements to

387
00:17:58,559 --> 00:18:01,200
make this thing work so it has to have

388
00:18:01,200 --> 00:18:04,500
enough privilege on AWS so he must have

389
00:18:04,500 --> 00:18:08,520
STS assumed role and preferably resource

390
00:18:08,520 --> 00:18:10,679
star that means that he can assume a

391
00:18:10,679 --> 00:18:12,419
role in any resource

392
00:18:12,419 --> 00:18:14,700
and he also has to know a related

393
00:18:14,700 --> 00:18:17,160
accounts on the same organizations so

394
00:18:17,160 --> 00:18:19,679
this can be found in cloudtrail I am

395
00:18:19,679 --> 00:18:22,200
policing through all things sometimes

396
00:18:22,200 --> 00:18:24,660
you go to the GitHub account from that

397
00:18:24,660 --> 00:18:26,580
organizations and find out they have

398
00:18:26,580 --> 00:18:29,700
like three or four other accounts

399
00:18:29,700 --> 00:18:32,100
uh which which account numbers shared

400
00:18:32,100 --> 00:18:33,960
there because account numbers are not

401
00:18:33,960 --> 00:18:37,380
really a secret right so you you can

402
00:18:37,380 --> 00:18:39,480
share it's not supposed to but you can

403
00:18:39,480 --> 00:18:42,539
and they also has to know a army of a

404
00:18:42,539 --> 00:18:44,580
role to assuming the new account so when

405
00:18:44,580 --> 00:18:46,440
you do an SDS assume role you have to

406
00:18:46,440 --> 00:18:48,480
know the art that you the irony of the

407
00:18:48,480 --> 00:18:50,520
role that you assume in the the new

408
00:18:50,520 --> 00:18:51,299
account

409
00:18:51,299 --> 00:18:53,400
this can be brute force it because

410
00:18:53,400 --> 00:18:55,679
usually it's created by humans so you

411
00:18:55,679 --> 00:18:57,780
can reinforce like a role like an

412
00:18:57,780 --> 00:19:00,419
account number roll admin administrator

413
00:19:00,419 --> 00:19:02,820
and things like that

414
00:19:02,820 --> 00:19:05,820
but there's a special case because when

415
00:19:05,820 --> 00:19:08,100
it's coming from the master accounts

416
00:19:08,100 --> 00:19:10,559
there's a special case for that

417
00:19:10,559 --> 00:19:12,539
so let's talk a little bit about

418
00:19:12,539 --> 00:19:14,400
privilege escalation

419
00:19:14,400 --> 00:19:17,160
privilege escalations a set of actions

420
00:19:17,160 --> 00:19:19,559
that allows a principle to increase

421
00:19:19,559 --> 00:19:22,700
their privileges for instance

422
00:19:22,700 --> 00:19:27,240
uh you can imagine a user with a really

423
00:19:27,240 --> 00:19:29,120
low privilege but with enough enough

424
00:19:29,120 --> 00:19:32,700
actions to improve his

425
00:19:32,700 --> 00:19:36,960
his actions his capabilities theirs was

426
00:19:36,960 --> 00:19:39,000
a great research by the late Spencer

427
00:19:39,000 --> 00:19:42,059
geitzen from Reno security labs and he

428
00:19:42,059 --> 00:19:45,960
found out at least 20 uh 28 no

429
00:19:45,960 --> 00:19:48,799
privileged Collision techniques

430
00:19:48,799 --> 00:19:51,720
and there's a there was a really new One

431
00:19:51,720 --> 00:19:53,760
released by spooker Labs today in his

432
00:19:53,760 --> 00:19:57,480
talk if you guys saw it on app stream

433
00:19:57,480 --> 00:20:00,179
about that upstream and there is even

434
00:20:00,179 --> 00:20:02,100
more possibilities because with

435
00:20:02,100 --> 00:20:04,500
combinations with eim pass role there's

436
00:20:04,500 --> 00:20:07,860
a this is an action on AWS and there's a

437
00:20:07,860 --> 00:20:09,799
really good research by Innova and Dam

438
00:20:09,799 --> 00:20:12,659
and when he find out new kind of

439
00:20:12,659 --> 00:20:14,880
privileged escalations combining eim

440
00:20:14,880 --> 00:20:18,659
pass role and other actions from AWS

441
00:20:18,659 --> 00:20:20,940
but the thing is not all privileged

442
00:20:20,940 --> 00:20:23,039
collisions are created equal

443
00:20:23,039 --> 00:20:26,460
let's take some examples a lot of the

444
00:20:26,460 --> 00:20:28,020
techniques have the same effective

445
00:20:28,020 --> 00:20:31,140
Effectiveness and allow you to become an

446
00:20:31,140 --> 00:20:34,679
administrator ASAP so here we have two

447
00:20:34,679 --> 00:20:37,620
techniques the first one is the IIM

448
00:20:37,620 --> 00:20:39,360
create pulse version

449
00:20:39,360 --> 00:20:41,640
that allows you to become assistant

450
00:20:41,640 --> 00:20:44,220
administrator as just creating a new

451
00:20:44,220 --> 00:20:46,260
policy version and becoming

452
00:20:46,260 --> 00:20:48,480
administrator right

453
00:20:48,480 --> 00:20:51,360
but that is the another technique called

454
00:20:51,360 --> 00:20:54,539
set default policy version that depends

455
00:20:54,539 --> 00:20:57,240
on you have another policy version that

456
00:20:57,240 --> 00:20:58,740
allows you to become administrator

457
00:20:58,740 --> 00:21:01,860
earlier so if you have the pulse version

458
00:21:01,860 --> 00:21:04,440
if you want here that allows you to set

459
00:21:04,440 --> 00:21:06,419
the photos version but the pulse version

460
00:21:06,419 --> 00:21:07,559
v0

461
00:21:07,559 --> 00:21:09,539
doesn't allows you to become a assistant

462
00:21:09,539 --> 00:21:12,299
administrator this this technique of

463
00:21:12,299 --> 00:21:14,100
privileged escalation might give you

464
00:21:14,100 --> 00:21:15,900
some more permissions the permissions of

465
00:21:15,900 --> 00:21:18,240
the version zero but not become a

466
00:21:18,240 --> 00:21:22,080
assistant administrator right

467
00:21:22,080 --> 00:21:24,720
so there is a tool there's called fault

468
00:21:24,720 --> 00:21:28,620
Spain anyone have ever used it

469
00:21:28,620 --> 00:21:31,200
yeah it's a good tool it was created by

470
00:21:31,200 --> 00:21:34,440
Kinder McQuaid he was working in a sales

471
00:21:34,440 --> 00:21:35,940
force at that time

472
00:21:35,940 --> 00:21:39,679
and release these two on April 30 2020

473
00:21:39,679 --> 00:21:42,840
and the current version is zero five oh

474
00:21:42,840 --> 00:21:45,299
but the good thing about this too is

475
00:21:45,299 --> 00:21:47,880
that it downloads your IAM policies

476
00:21:47,880 --> 00:21:51,240
online policies custom policies and AWS

477
00:21:51,240 --> 00:21:54,000
policies and analyze those policies

478
00:21:54,000 --> 00:21:55,980
looking for privileged Collision

479
00:21:55,980 --> 00:21:58,500
techniques data filtration possibilities

480
00:21:58,500 --> 00:22:00,960
of tactic situations resource exposure

481
00:22:00,960 --> 00:22:03,539
credential exposure and infrastructure

482
00:22:03,539 --> 00:22:06,360
modification so you generated this kind

483
00:22:06,360 --> 00:22:08,220
of reports 3D

484
00:22:08,220 --> 00:22:12,659
3D HTML Report with those texts and

485
00:22:12,659 --> 00:22:14,940
it is bar graph bars and things like

486
00:22:14,940 --> 00:22:17,039
that so turns out it's pretty easy to

487
00:22:17,039 --> 00:22:19,380
analyze privilege correlations with this

488
00:22:19,380 --> 00:22:21,740
tool

489
00:22:23,220 --> 00:22:26,700
so another attacker requirement is to

490
00:22:26,700 --> 00:22:29,039
know the I the account ID of a related

491
00:22:29,039 --> 00:22:30,900
account on the same organization right

492
00:22:30,900 --> 00:22:33,960
so this can be found on cloudtrail and

493
00:22:33,960 --> 00:22:36,900
here we have an example of a cloud

494
00:22:36,900 --> 00:22:41,720
straight of uh em role getting

495
00:22:42,200 --> 00:22:44,539
AWS API call

496
00:22:44,539 --> 00:22:48,240
uh it's closing an account ID

497
00:22:48,240 --> 00:22:50,760
and you can also be found in AIM

498
00:22:50,760 --> 00:22:52,440
policies because if you have cross

499
00:22:52,440 --> 00:22:54,059
account policies

500
00:22:54,059 --> 00:22:56,220
and those trust account has to have the

501
00:22:56,220 --> 00:22:58,679
number of the accounts uh to the

502
00:22:58,679 --> 00:23:00,659
destination right so you can find out

503
00:23:00,659 --> 00:23:03,059
new numbers there and also through of

504
00:23:03,059 --> 00:23:05,340
things uh as the example of the GitHub

505
00:23:05,340 --> 00:23:09,080
that I gave you guys before

506
00:23:09,900 --> 00:23:13,860
so and the the third thing and the third

507
00:23:13,860 --> 00:23:17,340
trick actually if the targets use AWS

508
00:23:17,340 --> 00:23:21,020
organizations or awsc Contour Tower

509
00:23:21,020 --> 00:23:24,480
uh the role that organization that AWS

510
00:23:24,480 --> 00:23:26,340
organization creates and control tower

511
00:23:26,340 --> 00:23:29,640
creates on the the child accounts on AWS

512
00:23:29,640 --> 00:23:32,340
it's a well-known name it's called

513
00:23:32,340 --> 00:23:34,679
organizational cards access roles and

514
00:23:34,679 --> 00:23:36,960
for the control tower is at AWS control

515
00:23:36,960 --> 00:23:39,720
tower execution and they have admin

516
00:23:39,720 --> 00:23:42,240
privileges in their child accounts by

517
00:23:42,240 --> 00:23:43,200
default

518
00:23:43,200 --> 00:23:44,640
so

519
00:23:44,640 --> 00:23:46,679
if an attacker gets access to the master

520
00:23:46,679 --> 00:23:49,440
account you will know by just doing our

521
00:23:49,440 --> 00:23:52,020
organization list the number of the the

522
00:23:52,020 --> 00:23:54,539
number of the accounts he has and he can

523
00:23:54,539 --> 00:23:57,240
also jump from his account from their

524
00:23:57,240 --> 00:23:58,980
Master accounts to any other accounts

525
00:23:58,980 --> 00:24:00,840
because he already know the rules for

526
00:24:00,840 --> 00:24:03,720
that like organization access or AWS

527
00:24:03,720 --> 00:24:04,980
control tower

528
00:24:04,980 --> 00:24:07,799
even though the AWS control tower is

529
00:24:07,799 --> 00:24:11,159
efficient role has two principles one is

530
00:24:11,159 --> 00:24:13,500
defined the services so control tower

531
00:24:13,500 --> 00:24:15,900
can also assume a role on on your

532
00:24:15,900 --> 00:24:18,240
account but the the thing is there is a

533
00:24:18,240 --> 00:24:19,799
principle here from the master account

534
00:24:19,799 --> 00:24:22,679
as any entity on the master account can

535
00:24:22,679 --> 00:24:26,039
also assume this role so you if an

536
00:24:26,039 --> 00:24:27,900
attacker got access to a master account

537
00:24:27,900 --> 00:24:31,080
it's done game over

538
00:24:31,080 --> 00:24:34,919
so let's run some some true scenarios on

539
00:24:34,919 --> 00:24:36,120
AWS

540
00:24:36,120 --> 00:24:39,419
some usually patterns that people do on

541
00:24:39,419 --> 00:24:42,720
AWS so the first button is called Hub

542
00:24:42,720 --> 00:24:43,740
and spoke

543
00:24:43,740 --> 00:24:46,200
when you have a multiple accounts which

544
00:24:46,200 --> 00:24:48,600
accounts for a production account for a

545
00:24:48,600 --> 00:24:51,360
development staging and so on and a

546
00:24:51,360 --> 00:24:55,140
shared account who shares like database

547
00:24:55,140 --> 00:24:57,720
and things like that so

548
00:24:57,720 --> 00:25:00,900
as a AWS administrator you can do some

549
00:25:00,900 --> 00:25:03,960
kind of mistakes for example for example

550
00:25:03,960 --> 00:25:06,480
creating IAC to instance on the shared

551
00:25:06,480 --> 00:25:08,220
VPC

552
00:25:08,220 --> 00:25:12,539
uh with the two Enis one were routing to

553
00:25:12,539 --> 00:25:14,580
account a and another one routing to

554
00:25:14,580 --> 00:25:16,919
accountancy what that means that means

555
00:25:16,919 --> 00:25:19,559
that if an attacker could hack any

556
00:25:19,559 --> 00:25:21,840
accounting act in any situ instance in

557
00:25:21,840 --> 00:25:24,740
account a find out there is an instance

558
00:25:24,740 --> 00:25:28,860
on on the shared vpcs have the shared

559
00:25:28,860 --> 00:25:30,900
vpcs here you will see that you have two

560
00:25:30,900 --> 00:25:33,240
NIS and then another one will allow you

561
00:25:33,240 --> 00:25:36,779
to allow him to jump to account C

562
00:25:36,779 --> 00:25:39,360
and the other things that you can do on

563
00:25:39,360 --> 00:25:42,299
this kind of scenario is do DPC peering

564
00:25:42,299 --> 00:25:43,980
so if you do VPC printing between

565
00:25:43,980 --> 00:25:46,980
account a to account B to account C you

566
00:25:46,980 --> 00:25:51,500
are basically making your network flat

567
00:25:52,440 --> 00:25:55,380
and there is another pattern there

568
00:25:55,380 --> 00:25:57,600
called cicd account

569
00:25:57,600 --> 00:26:00,779
it's like basically like this you have a

570
00:26:00,779 --> 00:26:03,000
master account and you have your cicg

571
00:26:03,000 --> 00:26:06,299
account and this ICD do deploy for that

572
00:26:06,299 --> 00:26:09,960
for stage infrastruct accounts

573
00:26:09,960 --> 00:26:12,720
and the master can access the dev and

574
00:26:12,720 --> 00:26:14,400
the stage a user in a master can access

575
00:26:14,400 --> 00:26:16,380
the depth and stage but he can use

576
00:26:16,380 --> 00:26:19,559
usually access their products account

577
00:26:19,559 --> 00:26:24,059
what our administrator can do to break

578
00:26:24,059 --> 00:26:26,760
this pattern is create a cross account

579
00:26:26,760 --> 00:26:29,640
between the dev and the cicd the

580
00:26:29,640 --> 00:26:32,279
backwards you see and when he do that

581
00:26:32,279 --> 00:26:36,120
the user might be able to get a

582
00:26:36,120 --> 00:26:37,620
credential and have

583
00:26:37,620 --> 00:26:43,340
then jump to cicd and then jump to prod

584
00:26:44,700 --> 00:26:47,159
just by assuming role between control

585
00:26:47,159 --> 00:26:49,260
planes

586
00:26:49,260 --> 00:26:53,100
so in order to help our customers and

587
00:26:53,100 --> 00:26:55,860
find out really easy ways to find out

588
00:26:55,860 --> 00:26:57,900
privilege lateral movements between

589
00:26:57,900 --> 00:26:59,940
accounts and those kind of things we

590
00:26:59,940 --> 00:27:02,340
tested a lot of tools but none of these

591
00:27:02,340 --> 00:27:05,640
what we expected them to do so it's time

592
00:27:05,640 --> 00:27:07,620
to build your own right we tested

593
00:27:07,620 --> 00:27:11,659
bmapper from NCC groups we tested

594
00:27:11,659 --> 00:27:17,100
AWS SPX from App secure labs and

595
00:27:17,100 --> 00:27:20,580
cloud mapper from Google Apps and a lot

596
00:27:20,580 --> 00:27:23,039
of tools but none of them did what we

597
00:27:23,039 --> 00:27:26,279
expected them to do easily actually

598
00:27:26,279 --> 00:27:28,740
so we had some some requirements right

599
00:27:28,740 --> 00:27:31,020
so we should use open source in free

600
00:27:31,020 --> 00:27:32,460
tools

601
00:27:32,460 --> 00:27:34,559
uh we should download automatically

602
00:27:34,559 --> 00:27:37,500
through the AWS apis all the necessary

603
00:27:37,500 --> 00:27:40,080
input to plot the graph

604
00:27:40,080 --> 00:27:42,600
from also from the control plane in data

605
00:27:42,600 --> 00:27:44,760
plane and also has to have a query

606
00:27:44,760 --> 00:27:47,100
language to allow racy alerts

607
00:27:47,100 --> 00:27:48,480
automatically

608
00:27:48,480 --> 00:27:51,659
so we decided to use Grambling as a

609
00:27:51,659 --> 00:27:54,840
graph database carry language and for

610
00:27:54,840 --> 00:27:57,000
doing this we are using a bash Tinker

611
00:27:57,000 --> 00:27:57,840
pop

612
00:27:57,840 --> 00:28:00,779
uh behind we are also using Cloud

613
00:28:00,779 --> 00:28:04,020
splaining to allow us to log in multiple

614
00:28:04,020 --> 00:28:06,240
accounts and download the all the

615
00:28:06,240 --> 00:28:09,600
information and also some uh splitted

616
00:28:09,600 --> 00:28:11,340
scripts to download information about

617
00:28:11,340 --> 00:28:12,299
the

618
00:28:12,299 --> 00:28:14,580
the code of the data plane things that

619
00:28:14,580 --> 00:28:17,580
we needed to to our project and we

620
00:28:17,580 --> 00:28:20,460
decided to use the 3js that's a amazing

621
00:28:20,460 --> 00:28:23,159
graph Library pretty easy to to make

622
00:28:23,159 --> 00:28:25,620
things on that so

623
00:28:25,620 --> 00:28:29,880
our model how we model that well all the

624
00:28:29,880 --> 00:28:31,620
squares that you guys saw in the

625
00:28:31,620 --> 00:28:34,320
presentation uh are things from the data

626
00:28:34,320 --> 00:28:38,700
plane like ec2 instance lambdas ECS or

627
00:28:38,700 --> 00:28:40,320
anything like that

628
00:28:40,320 --> 00:28:43,200
and everything there was Circle uh it's

629
00:28:43,200 --> 00:28:45,600
from one account and the colors

630
00:28:45,600 --> 00:28:47,700
different different makes the difference

631
00:28:47,700 --> 00:28:50,039
between accounts

632
00:28:50,039 --> 00:28:52,500
and also we have an arrow with a

633
00:28:52,500 --> 00:28:55,860
directional directional relationship

634
00:28:55,860 --> 00:29:00,120
and so it's double time the thing is

635
00:29:00,120 --> 00:29:03,539
this tool has no name yet so

636
00:29:03,539 --> 00:29:06,480
vote on Twitter I just make a boat this

637
00:29:06,480 --> 00:29:08,940
morning and you guys have this only

638
00:29:08,940 --> 00:29:11,460
these four options of names sorry but

639
00:29:11,460 --> 00:29:13,740
yeah that's what the Twitter let allowed

640
00:29:13,740 --> 00:29:17,039
me to to put on percentage on on as

641
00:29:17,039 --> 00:29:20,159
options and please vote

642
00:29:20,159 --> 00:29:23,100
and we will publish that too as soon as

643
00:29:23,100 --> 00:29:26,940
possible so it's demo time

644
00:29:26,940 --> 00:29:29,539
all right

645
00:29:33,600 --> 00:29:35,279
here

646
00:29:35,279 --> 00:29:38,399
this is the interface of our no name yet

647
00:29:38,399 --> 00:29:42,480
to as you can see right here on the left

648
00:29:42,480 --> 00:29:46,140
and use we base the this interface in a

649
00:29:46,140 --> 00:29:47,820
project from the GitHub the project

650
00:29:47,820 --> 00:29:49,700
called graph XP

651
00:29:49,700 --> 00:29:51,960
from a handle guide that I don't know

652
00:29:51,960 --> 00:29:55,679
him but it was kind of we just uh

653
00:29:55,679 --> 00:29:58,380
modificate a little bit the code to make

654
00:29:58,380 --> 00:30:01,679
this work the the he has a

655
00:30:01,679 --> 00:30:04,980
JavaScript grammling carry interface

656
00:30:04,980 --> 00:30:08,279
with the the Apache Tinker pop

657
00:30:08,279 --> 00:30:11,700
so just to grab I already loaded the all

658
00:30:11,700 --> 00:30:15,720
the information from the AWS

659
00:30:15,720 --> 00:30:19,380
and just click search you'll be able to

660
00:30:19,380 --> 00:30:22,200
to graph this information so you can see

661
00:30:22,200 --> 00:30:24,960
uh routes are

662
00:30:24,960 --> 00:30:28,260
control plane stuff uh squares are data

663
00:30:28,260 --> 00:30:30,740
playing stuff

664
00:30:32,520 --> 00:30:35,700
you can zoom in throughout pan for left

665
00:30:35,700 --> 00:30:38,480
to the right

666
00:30:41,100 --> 00:30:43,260
but the data that I show you guys here

667
00:30:43,260 --> 00:30:46,799
it's like a mock-up data from one of

668
00:30:46,799 --> 00:30:49,380
based on one of our clients who has hack

669
00:30:49,380 --> 00:30:53,580
it so the attacker would be was able to

670
00:30:53,580 --> 00:30:56,399
create to grab his credentials create an

671
00:30:56,399 --> 00:30:58,980
institution and just do that I'm hiding

672
00:30:58,980 --> 00:31:01,019
but the thing is if the attacker would

673
00:31:01,019 --> 00:31:04,019
be able to it was a bot so it was not

674
00:31:04,019 --> 00:31:06,000
smart enough to find out lateral

675
00:31:06,000 --> 00:31:08,279
movements but if it was a person if it

676
00:31:08,279 --> 00:31:11,039
was a real attacker and he find he could

677
00:31:11,039 --> 00:31:12,659
be able to find out lateral movements

678
00:31:12,659 --> 00:31:15,480
our clients would be screwed and I show

679
00:31:15,480 --> 00:31:18,140
you guys why

680
00:31:27,779 --> 00:31:31,220
you can you can move the the

681
00:31:31,220 --> 00:31:35,220
pieces around and this is the user

682
00:31:35,220 --> 00:31:38,580
hold on the credential liquid and the

683
00:31:38,580 --> 00:31:40,860
attacker was able to create an ec2

684
00:31:40,860 --> 00:31:41,760
instance

685
00:31:41,760 --> 00:31:44,100
and this is institutions was in the

686
00:31:44,100 --> 00:31:46,799
master account so he would be able to

687
00:31:46,799 --> 00:31:49,799
jump to all those other four accounts

688
00:31:49,799 --> 00:31:50,940
that he has

689
00:31:50,940 --> 00:31:53,460
there are the green the blue the orange

690
00:31:53,460 --> 00:31:56,880
and the light orange accounts

691
00:31:56,880 --> 00:31:59,940
and this client has also has a VPC

692
00:31:59,940 --> 00:32:01,799
viewing between other accounts the

693
00:32:01,799 --> 00:32:04,919
orange account so this instance he would

694
00:32:04,919 --> 00:32:06,059
be able to

695
00:32:06,059 --> 00:32:08,220
perhaps hack this instance and then jump

696
00:32:08,220 --> 00:32:10,380
to another instance and then also become

697
00:32:10,380 --> 00:32:12,419
assistant administrator because this

698
00:32:12,419 --> 00:32:14,880
instance here wasn't a private network

699
00:32:14,880 --> 00:32:18,480
but he has the administration role

700
00:32:18,480 --> 00:32:21,140
attach it to it

701
00:32:23,640 --> 00:32:26,880
and the easiest way to analyze things

702
00:32:26,880 --> 00:32:29,460
like that is to look for clusters like

703
00:32:29,460 --> 00:32:32,220
this one and this one the second the

704
00:32:32,220 --> 00:32:34,679
second clusters is from his cicd so

705
00:32:34,679 --> 00:32:36,720
there is account who will deploy here an

706
00:32:36,720 --> 00:32:38,279
account for deploy here and there is a

707
00:32:38,279 --> 00:32:40,620
easy two instance with Jenkins here to

708
00:32:40,620 --> 00:32:43,879
deploy it for those accounts

709
00:32:44,940 --> 00:32:48,179
and things like that are usually limited

710
00:32:48,179 --> 00:32:50,399
with a road because laminate has has a

711
00:32:50,399 --> 00:32:52,320
role attached to it

712
00:32:52,320 --> 00:32:54,179
and they're like sparse they are not

713
00:32:54,179 --> 00:32:57,380
connected to the whole graph

714
00:33:02,940 --> 00:33:05,340
and you can also use a filter like

715
00:33:05,340 --> 00:33:07,320
privilege escalation here and you'll see

716
00:33:07,320 --> 00:33:08,539
that if you

717
00:33:08,539 --> 00:33:10,440
Fade Out

718
00:33:10,440 --> 00:33:13,620
or raise the transparency the other

719
00:33:13,620 --> 00:33:16,919
nodes and there is a possibility of

720
00:33:16,919 --> 00:33:18,480
privilege escalation here from between

721
00:33:18,480 --> 00:33:20,340
those two rows

722
00:33:20,340 --> 00:33:23,159
and if you click on the edge you'd be

723
00:33:23,159 --> 00:33:27,000
able to see that there is a label Edge

724
00:33:27,000 --> 00:33:28,919
for privileged collection if they create

725
00:33:28,919 --> 00:33:31,019
positive version so you can also carry

726
00:33:31,019 --> 00:33:34,279
information between those nodes

727
00:33:45,960 --> 00:33:48,840
so we have some future work to do or our

728
00:33:48,840 --> 00:33:52,440
to-do list as we used to call so one

729
00:33:52,440 --> 00:33:54,179
thing that we want to put on this tool

730
00:33:54,179 --> 00:33:56,340
is to be able to evaluate restrictions

731
00:33:56,340 --> 00:33:58,500
of all privileged escalation techniques

732
00:33:58,500 --> 00:34:00,440
because

733
00:34:00,440 --> 00:34:03,360
uh for example the example that I did

734
00:34:03,360 --> 00:34:05,940
that I said before there are some kinds

735
00:34:05,940 --> 00:34:08,099
of uh the previous escalations that

736
00:34:08,099 --> 00:34:10,500
needs a situ instance that leads lambdas

737
00:34:10,500 --> 00:34:13,918
if there is no role with a in that that

738
00:34:13,918 --> 00:34:16,859
account with the permissions enough to

739
00:34:16,859 --> 00:34:18,719
that Lambda will not be a privileged

740
00:34:18,719 --> 00:34:20,460
escalation at all you won't be able to

741
00:34:20,460 --> 00:34:23,760
get more actions we all started like to

742
00:34:23,760 --> 00:34:25,980
edit support for other resources like S3

743
00:34:25,980 --> 00:34:27,480
and RTS

744
00:34:27,480 --> 00:34:30,119
support for his soft-based policies and

745
00:34:30,119 --> 00:34:31,980
a better visualization and featuring

746
00:34:31,980 --> 00:34:34,940
parties too

747
00:34:35,040 --> 00:34:37,079
and we can draw some conclusions from

748
00:34:37,079 --> 00:34:39,599
here well first of all is try to apply

749
00:34:39,599 --> 00:34:41,699
the least privileged IAM role

750
00:34:41,699 --> 00:34:43,800
permissions and I know that's easier

751
00:34:43,800 --> 00:34:45,119
said than done

752
00:34:45,119 --> 00:34:48,179
but you can abuse fscps and IM

753
00:34:48,179 --> 00:34:52,199
boundaries to limit uh most of most of

754
00:34:52,199 --> 00:34:53,699
what an attacker can do in your network

755
00:34:53,699 --> 00:34:56,280
another user resources start because

756
00:34:56,280 --> 00:34:58,320
when you do resources start you can do

757
00:34:58,320 --> 00:35:00,119
those actions that it has permissions in

758
00:35:00,119 --> 00:35:03,960
any source so a good thing would be

759
00:35:03,960 --> 00:35:06,540
restrict the kind of resources that uh

760
00:35:06,540 --> 00:35:10,140
this attacker can make moves so other

761
00:35:10,140 --> 00:35:12,240
thing is don't run local overloads in

762
00:35:12,240 --> 00:35:13,680
your master account so your master

763
00:35:13,680 --> 00:35:17,099
account in AWS from organizations should

764
00:35:17,099 --> 00:35:21,480
be empty uh as much as possible don't

765
00:35:21,480 --> 00:35:24,060
cross account don't cross any account to

766
00:35:24,060 --> 00:35:26,460
the master so that case on the CI CD

767
00:35:26,460 --> 00:35:29,040
when the there is a connection between

768
00:35:29,040 --> 00:35:31,680
the cicg and the dev and the dev back to

769
00:35:31,680 --> 00:35:34,079
cicd if you do this kind of thing things

770
00:35:34,079 --> 00:35:36,060
you're alone allowing privilege

771
00:35:36,060 --> 00:35:38,040
escalation privilegation I'm sorry

772
00:35:38,040 --> 00:35:41,460
you're allowing lateral movements and

773
00:35:41,460 --> 00:35:43,560
always review all your trusted across

774
00:35:43,560 --> 00:35:45,780
account policies and for sure segment

775
00:35:45,780 --> 00:35:47,460
your networking accounts as much as

776
00:35:47,460 --> 00:35:48,900
possible

777
00:35:48,900 --> 00:35:51,300
so thank you guys that's all I have for

778
00:35:51,300 --> 00:35:52,840
you today uh

779
00:35:52,840 --> 00:35:54,119
[Music]

780
00:35:54,119 --> 00:35:56,700
any questions the code will be released

781
00:35:56,700 --> 00:36:00,599
uh on YouTube security

782
00:36:00,599 --> 00:36:03,599
and hopefully soon

783
00:36:03,599 --> 00:36:05,940
any questions

784
00:36:05,940 --> 00:36:07,619
I've got the microphone here if anybody

785
00:36:07,619 --> 00:36:09,060
wants to have a question just raise your

786
00:36:09,060 --> 00:36:12,500
hand and I'll try to hand it off

787
00:36:20,339 --> 00:36:22,320
I'll ask a quick question a lot of the

788
00:36:22,320 --> 00:36:23,579
stuff you talked about today does that

789
00:36:23,579 --> 00:36:25,740
does it also apply to other Cloud

790
00:36:25,740 --> 00:36:27,720
providers like Azure or Google compute

791
00:36:27,720 --> 00:36:30,300
platform uh the lateral movement yeah

792
00:36:30,300 --> 00:36:33,000
it's possible you know all other Cloud

793
00:36:33,000 --> 00:36:35,400
providers but the things like uh AWS

794
00:36:35,400 --> 00:36:39,920
organizations are basically on AWS

795
00:36:40,200 --> 00:36:42,799
thank you

796
00:36:42,900 --> 00:36:45,920
thank you very much

