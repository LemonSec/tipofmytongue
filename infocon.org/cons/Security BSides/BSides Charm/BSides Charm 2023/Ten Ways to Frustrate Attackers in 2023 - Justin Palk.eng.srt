1
00:00:00,120 --> 00:00:03,120
foreign

2
00:00:06,020 --> 00:00:21,539
[Music]

3
00:00:21,539 --> 00:00:24,800
good afternoon everyone

4
00:00:25,080 --> 00:00:26,100
um

5
00:00:26,100 --> 00:00:28,680
and welcome to 10 ways to frustrate

6
00:00:28,680 --> 00:00:31,320
attackers in 2023

7
00:00:31,320 --> 00:00:33,899
[Music]

8
00:00:33,899 --> 00:00:36,660
my name is Justin Polk I'm a senior

9
00:00:36,660 --> 00:00:38,160
security consultant with red Siege

10
00:00:38,160 --> 00:00:40,800
information security I'm a pendant

11
00:00:40,800 --> 00:00:42,840
hello

12
00:00:42,840 --> 00:00:45,360
I'm a pen tester I do some tool

13
00:00:45,360 --> 00:00:48,180
development for us I play in ctfs not as

14
00:00:48,180 --> 00:00:50,280
much as I used to

15
00:00:50,280 --> 00:00:52,200
um I had sort of a weird course getting

16
00:00:52,200 --> 00:00:54,539
to where I am today I used to be a

17
00:00:54,539 --> 00:00:56,280
research scientist I used to be a local

18
00:00:56,280 --> 00:00:58,500
government reporter and a security

19
00:00:58,500 --> 00:01:00,600
auditor before getting into pen testing

20
00:01:00,600 --> 00:01:03,960
and every now and again I brew Mead and

21
00:01:03,960 --> 00:01:06,000
write a bit of cosmic horror

22
00:01:06,000 --> 00:01:08,939
so yay Cthulhu

23
00:01:08,939 --> 00:01:12,299
all right so uh I've got a very simple

24
00:01:12,299 --> 00:01:15,479
goal for this talk today and my goal

25
00:01:15,479 --> 00:01:18,720
is to help you make my life miserable

26
00:01:18,720 --> 00:01:20,700
uh I am something of a professional

27
00:01:20,700 --> 00:01:23,100
masochist at this point

28
00:01:23,100 --> 00:01:25,320
don't get me wrong I love getting into

29
00:01:25,320 --> 00:01:27,840
people's networks I love getting at all

30
00:01:27,840 --> 00:01:30,659
that lovely crunchy pii and sensitive

31
00:01:30,659 --> 00:01:32,100
business data and everything I love

32
00:01:32,100 --> 00:01:34,140
getting domain admin

33
00:01:34,140 --> 00:01:36,960
that said I really like it when I can't

34
00:01:36,960 --> 00:01:38,700
do a damn thing

35
00:01:38,700 --> 00:01:40,920
I like getting into a network and

36
00:01:40,920 --> 00:01:43,320
finding that I am blocked every which

37
00:01:43,320 --> 00:01:45,180
way

38
00:01:45,180 --> 00:01:48,659
so what I want to do is I want to help

39
00:01:48,659 --> 00:01:52,380
you make my life suck

40
00:01:52,380 --> 00:01:54,600
um there's two big ways to do that we're

41
00:01:54,600 --> 00:01:56,659
going to talk about today the first way

42
00:01:56,659 --> 00:01:59,880
is I'm going to tell you the five things

43
00:01:59,880 --> 00:02:03,420
that me and my co-workers found a lot

44
00:02:03,420 --> 00:02:05,640
last year that made things really easy

45
00:02:05,640 --> 00:02:08,399
for us the the easy wins the things that

46
00:02:08,399 --> 00:02:11,220
let us go right to domain admin you know

47
00:02:11,220 --> 00:02:13,860
all the things that made things simple

48
00:02:13,860 --> 00:02:16,020
I'm going to show you how to find them

49
00:02:16,020 --> 00:02:17,700
you know make recommendations about how

50
00:02:17,700 --> 00:02:20,580
to fix them and do it before you get a

51
00:02:20,580 --> 00:02:23,340
pen test so you don't have to pay us to

52
00:02:23,340 --> 00:02:25,140
find them for you because there's really

53
00:02:25,140 --> 00:02:27,599
no reason for that

54
00:02:27,599 --> 00:02:30,300
um the other thing is the second part is

55
00:02:30,300 --> 00:02:32,040
going to be you know implement the

56
00:02:32,040 --> 00:02:34,500
controls that leave me feeling like I'm

57
00:02:34,500 --> 00:02:36,599
a mime stuck in a glass box

58
00:02:36,599 --> 00:02:38,220
uh these are a little harder to do

59
00:02:38,220 --> 00:02:40,440
sometimes a lot harder to do they're

60
00:02:40,440 --> 00:02:42,840
often architectural uh they take a lot

61
00:02:42,840 --> 00:02:44,519
more planning and execution but when you

62
00:02:44,519 --> 00:02:48,920
do them they really work well

63
00:02:49,440 --> 00:02:54,379
so part one is no easy buttons

64
00:02:55,080 --> 00:02:58,140
um right now the easiest of easy buttons

65
00:02:58,140 --> 00:03:01,620
for us is adcs misconfigurations active

66
00:03:01,620 --> 00:03:04,260
directory certificate services

67
00:03:04,260 --> 00:03:08,340
so these issues really came to light in

68
00:03:08,340 --> 00:03:11,340
summer of 21 will Schroeder and Lee

69
00:03:11,340 --> 00:03:14,099
Christensen at Specter Ops uh published

70
00:03:14,099 --> 00:03:16,379
a paper called certified pre-owned they

71
00:03:16,379 --> 00:03:19,019
basically walked through all the ways

72
00:03:19,019 --> 00:03:21,379
that people can abuse adcs

73
00:03:21,379 --> 00:03:25,860
misconfigurations to prevask to gain

74
00:03:25,860 --> 00:03:28,500
persistence in a domain and do other

75
00:03:28,500 --> 00:03:29,760
things you know all the things you can

76
00:03:29,760 --> 00:03:32,220
do with certificates I'm also going to

77
00:03:32,220 --> 00:03:35,040
one note I'm gonna make is these slides

78
00:03:35,040 --> 00:03:37,140
are already up online there are links on

79
00:03:37,140 --> 00:03:39,780
the front and first and last slides and

80
00:03:39,780 --> 00:03:41,700
they'll have notes and you know all the

81
00:03:41,700 --> 00:03:43,379
URLs so you can go and pull them down

82
00:03:43,379 --> 00:03:46,080
after we're done

83
00:03:46,080 --> 00:03:48,299
so

84
00:03:48,299 --> 00:03:50,400
so how do I find these when I'm in your

85
00:03:50,400 --> 00:03:52,319
network I like to use a tool called

86
00:03:52,319 --> 00:03:53,580
certify

87
00:03:53,580 --> 00:03:55,860
and it's real simple I just need a

88
00:03:55,860 --> 00:03:58,080
regular domain user account

89
00:03:58,080 --> 00:04:00,840
I run certify and it will query the

90
00:04:00,840 --> 00:04:03,120
domain controller it'll find all the cas

91
00:04:03,120 --> 00:04:05,159
it'll query all the templates and then

92
00:04:05,159 --> 00:04:07,860
it will analyze them and say Here's what

93
00:04:07,860 --> 00:04:09,659
you need to do to exploit these here are

94
00:04:09,659 --> 00:04:12,180
all the vulnerable templates that are

95
00:04:12,180 --> 00:04:13,980
going to make it easy to attack this

96
00:04:13,980 --> 00:04:16,139
domain

97
00:04:16,139 --> 00:04:17,519
um

98
00:04:17,519 --> 00:04:19,798
so this what I'm showing here is an

99
00:04:19,798 --> 00:04:22,740
example of esc-1 one of the particular

100
00:04:22,740 --> 00:04:23,820
attacks

101
00:04:23,820 --> 00:04:25,500
so you see you know bullet one

102
00:04:25,500 --> 00:04:27,660
enrollment rights domain users so

103
00:04:27,660 --> 00:04:29,520
anybody can enroll in a certificate

104
00:04:29,520 --> 00:04:31,740
using this template number two client

105
00:04:31,740 --> 00:04:34,199
authentication the certificate you get

106
00:04:34,199 --> 00:04:37,979
can be used to log into something else

107
00:04:37,979 --> 00:04:40,080
problem is really number three there

108
00:04:40,080 --> 00:04:43,199
enrollee Supply subject what that means

109
00:04:43,199 --> 00:04:47,400
is I can go as you know regular domain

110
00:04:47,400 --> 00:04:49,740
user request a certificate but I can

111
00:04:49,740 --> 00:04:51,960
stick an alternate name on there

112
00:04:51,960 --> 00:04:54,180
and I can make that alternate name any

113
00:04:54,180 --> 00:04:56,460
other user I want including a domain

114
00:04:56,460 --> 00:04:58,560
admin and then I can take that

115
00:04:58,560 --> 00:05:00,720
certificate that I just got and I can

116
00:05:00,720 --> 00:05:02,160
take it to a domain controller and say

117
00:05:02,160 --> 00:05:06,000
hi I'm the domain admin let me in

118
00:05:06,000 --> 00:05:07,800
um now if I want to be lower and quiet I

119
00:05:07,800 --> 00:05:09,419
can you know make that a database admin

120
00:05:09,419 --> 00:05:11,040
or you know somebody in the legal

121
00:05:11,040 --> 00:05:13,199
department you'll get the specific thing

122
00:05:13,199 --> 00:05:16,020
that I want but I can be anybody I want

123
00:05:16,020 --> 00:05:18,000
with this

124
00:05:18,000 --> 00:05:20,040
and this take finding and exploiting

125
00:05:20,040 --> 00:05:23,180
this takes about 10 minutes

126
00:05:23,699 --> 00:05:26,639
so there's I think a total of like nine

127
00:05:26,639 --> 00:05:29,100
or ten esc's the various you know attack

128
00:05:29,100 --> 00:05:30,840
vectors for this right now some of the

129
00:05:30,840 --> 00:05:33,360
other key ones you've got esc3 but

130
00:05:33,360 --> 00:05:34,740
instead of you know requesting

131
00:05:34,740 --> 00:05:36,060
certificate with an alternate name

132
00:05:36,060 --> 00:05:37,979
you're specifically enrolling on behalf

133
00:05:37,979 --> 00:05:39,600
of another user

134
00:05:39,600 --> 00:05:41,940
yes C4

135
00:05:41,940 --> 00:05:43,800
um it's not a weakness in the template

136
00:05:43,800 --> 00:05:46,199
itself it's a permissions problem where

137
00:05:46,199 --> 00:05:49,080
a low privileged user can modify the

138
00:05:49,080 --> 00:05:51,060
template or even modify modify the

139
00:05:51,060 --> 00:05:53,460
certificate Authority itself and change

140
00:05:53,460 --> 00:05:55,500
it into an esc-1 template or one of

141
00:05:55,500 --> 00:05:59,400
these other issues and then esca is you

142
00:05:59,400 --> 00:06:02,220
know we've left web requests on for this

143
00:06:02,220 --> 00:06:05,699
and we can ntlm relay credentials to

144
00:06:05,699 --> 00:06:08,340
this adcs endpoint and request a

145
00:06:08,340 --> 00:06:10,080
certificate on behalf of whoever's

146
00:06:10,080 --> 00:06:13,340
credentials were relaying

147
00:06:15,660 --> 00:06:17,880
um how do you fix it step one remove any

148
00:06:17,880 --> 00:06:19,979
unnecessary templates if you're not

149
00:06:19,979 --> 00:06:22,560
using it just get rid of it

150
00:06:22,560 --> 00:06:23,940
um I mean that's that's a good general

151
00:06:23,940 --> 00:06:26,340
rule number two make sure your low

152
00:06:26,340 --> 00:06:27,960
privileged users do not have right

153
00:06:27,960 --> 00:06:30,419
permissions on Cas or templates this is

154
00:06:30,419 --> 00:06:31,919
critical infrastructure in your network

155
00:06:31,919 --> 00:06:34,500
low privileged users should not be able

156
00:06:34,500 --> 00:06:37,080
to modify these things

157
00:06:37,080 --> 00:06:38,880
number three

158
00:06:38,880 --> 00:06:41,220
if you need low privileged users to be

159
00:06:41,220 --> 00:06:43,560
able to request certificates that's fine

160
00:06:43,560 --> 00:06:45,240
there's another setting you can turn on

161
00:06:45,240 --> 00:06:47,280
that says oh by the way a third party

162
00:06:47,280 --> 00:06:49,199
has to sign off on this

163
00:06:49,199 --> 00:06:51,419
and if that third party is paying even a

164
00:06:51,419 --> 00:06:53,220
modicum of attention

165
00:06:53,220 --> 00:06:56,100
that will cut off most of this because

166
00:06:56,100 --> 00:06:59,400
you can't do it silently anymore

167
00:06:59,400 --> 00:07:02,819
and the last one disable you know HTTP

168
00:07:02,819 --> 00:07:05,039
https enrollment again if you're not

169
00:07:05,039 --> 00:07:08,360
neat if you're not using it

170
00:07:09,419 --> 00:07:11,160
all right next one dangerous active

171
00:07:11,160 --> 00:07:13,560
directory permissions

172
00:07:13,560 --> 00:07:15,120
um this is where you've got a low

173
00:07:15,120 --> 00:07:17,699
privileged user or more likely again

174
00:07:17,699 --> 00:07:20,460
probably all domain users who have some

175
00:07:20,460 --> 00:07:22,819
sort of control over a domain object

176
00:07:22,819 --> 00:07:26,880
like a group maybe a key computer maybe

177
00:07:26,880 --> 00:07:29,759
a GPO that they can manipulate to move

178
00:07:29,759 --> 00:07:33,240
laterally or escalate privileges

179
00:07:33,240 --> 00:07:35,520
um old gpos that have been lingering in

180
00:07:35,520 --> 00:07:37,380
active directory for years or

181
00:07:37,380 --> 00:07:39,780
potentially decades are really

182
00:07:39,780 --> 00:07:42,679
susceptible to this

183
00:07:42,900 --> 00:07:44,940
so how do I find it when I'm in your

184
00:07:44,940 --> 00:07:47,940
network uh bloodhound Bloodhound is a

185
00:07:47,940 --> 00:07:49,860
tool that uses graph Theory to identify

186
00:07:49,860 --> 00:07:51,720
exploitable relationships in active

187
00:07:51,720 --> 00:07:53,880
directory and it will literally draw you

188
00:07:53,880 --> 00:07:56,039
a map how to get from this thing that I

189
00:07:56,039 --> 00:07:58,979
own to this other thing that I want

190
00:07:58,979 --> 00:07:59,880
um

191
00:07:59,880 --> 00:08:01,919
use a tool which I'm showing you here

192
00:08:01,919 --> 00:08:04,319
sharp Hound to actually gather the data

193
00:08:04,319 --> 00:08:06,900
out of active directory

194
00:08:06,900 --> 00:08:09,240
and then once you've got it and you feed

195
00:08:09,240 --> 00:08:10,620
it into Bloodhound you get something

196
00:08:10,620 --> 00:08:12,780
that looks like this this is a snippet

197
00:08:12,780 --> 00:08:15,300
of the Bloodhound graph this is

198
00:08:15,300 --> 00:08:17,160
replicating something I actually

199
00:08:17,160 --> 00:08:19,259
encountered in a client Network a few

200
00:08:19,259 --> 00:08:21,060
months ago

201
00:08:21,060 --> 00:08:23,400
um where I I had some low privileged

202
00:08:23,400 --> 00:08:25,199
user who's you know obviously a member

203
00:08:25,199 --> 00:08:26,819
of domain users

204
00:08:26,819 --> 00:08:29,039
but they had generic right on this GPO

205
00:08:29,039 --> 00:08:33,839
that was linked at the Domain level

206
00:08:33,839 --> 00:08:36,839
and I have to say my the client I was

207
00:08:36,839 --> 00:08:38,458
working with on this home was great they

208
00:08:38,458 --> 00:08:40,020
really wanted you know a demonstration

209
00:08:40,020 --> 00:08:41,700
of impact so we talked through a few

210
00:08:41,700 --> 00:08:44,219
things they had me deploy a scheduled

211
00:08:44,219 --> 00:08:46,740
task the call that caused every computer

212
00:08:46,740 --> 00:08:49,320
that this GPO was applied to to just

213
00:08:49,320 --> 00:08:52,200
call back to me with the username it was

214
00:08:52,200 --> 00:08:55,320
running as and you know host the host

215
00:08:55,320 --> 00:08:57,600
name and a couple other bits of data

216
00:08:57,600 --> 00:09:00,180
after about 45 minutes when I'd gotten

217
00:09:00,180 --> 00:09:02,040
callbacks from 150 machines in the

218
00:09:02,040 --> 00:09:04,080
domain and their Sim was apparently

219
00:09:04,080 --> 00:09:05,339
screaming with alerts they said okay

220
00:09:05,339 --> 00:09:07,860
please cut it off we're done

221
00:09:07,860 --> 00:09:09,779
um but I really appreciated that that

222
00:09:09,779 --> 00:09:11,100
was a lot of fun

223
00:09:11,100 --> 00:09:14,760
but that GPO was literally old enough to

224
00:09:14,760 --> 00:09:17,640
drink it was like 23 years old

225
00:09:17,640 --> 00:09:19,920
um and no one was no one that they were

226
00:09:19,920 --> 00:09:21,360
able to get a hold of quickly even knew

227
00:09:21,360 --> 00:09:23,700
what it was doing there anymore

228
00:09:23,700 --> 00:09:26,580
so it just it had been created it they'd

229
00:09:26,580 --> 00:09:27,899
grown out of it but they'd never killed

230
00:09:27,899 --> 00:09:30,019
it

231
00:09:30,180 --> 00:09:32,700
okay so how do you fix it uh this is

232
00:09:32,700 --> 00:09:34,320
just you know it's an active directory

233
00:09:34,320 --> 00:09:37,200
audit you find it using Bloodhounds

234
00:09:37,200 --> 00:09:39,360
built-in queries

235
00:09:39,360 --> 00:09:40,560
um they've got they've got a whole

236
00:09:40,560 --> 00:09:41,940
section it's just labeled dangerous

237
00:09:41,940 --> 00:09:44,760
privileges that'll find all sorts of

238
00:09:44,760 --> 00:09:47,220
stuff like this and then you know

239
00:09:47,220 --> 00:09:49,500
anything that comes up in there figure

240
00:09:49,500 --> 00:09:51,440
out how to break that chain

241
00:09:51,440 --> 00:09:54,000
make sure that only your necessary users

242
00:09:54,000 --> 00:09:55,620
and groups have right permissions on key

243
00:09:55,620 --> 00:09:57,660
active directory objects and user groups

244
00:09:57,660 --> 00:10:00,839
and audit your group memberships

245
00:10:00,839 --> 00:10:03,540
um I should have said this up front but

246
00:10:03,540 --> 00:10:05,040
nothing I'm saying here is going to be

247
00:10:05,040 --> 00:10:06,839
new what I'm the whole point of this is

248
00:10:06,839 --> 00:10:10,800
this is what is working for us right now

249
00:10:10,800 --> 00:10:13,740
um so this this stuff is you know pretty

250
00:10:13,740 --> 00:10:16,200
classic for example we can reused

251
00:10:16,200 --> 00:10:17,519
passwords

252
00:10:17,519 --> 00:10:19,800
you know we get into a network we start

253
00:10:19,800 --> 00:10:21,300
password spring these are the first

254
00:10:21,300 --> 00:10:22,800
three things we're gonna guess season

255
00:10:22,800 --> 00:10:25,200
year organization organization name and

256
00:10:25,200 --> 00:10:26,880
year and password

257
00:10:26,880 --> 00:10:29,640
because we still find it

258
00:10:29,640 --> 00:10:31,380
um I think I last founded about two

259
00:10:31,380 --> 00:10:33,540
months ago

260
00:10:33,540 --> 00:10:34,440
um

261
00:10:34,440 --> 00:10:36,540
and the thing is a lot of these they'll

262
00:10:36,540 --> 00:10:38,160
meet complexity requirements basic

263
00:10:38,160 --> 00:10:39,300
complexity requirements you know

264
00:10:39,300 --> 00:10:42,480
uppercase lowercase digits uh special

265
00:10:42,480 --> 00:10:44,880
characters but the thing is the the

266
00:10:44,880 --> 00:10:46,560
basic pattern

267
00:10:46,560 --> 00:10:49,140
itself is weak and something that we can

268
00:10:49,140 --> 00:10:51,000
exploit

269
00:10:51,000 --> 00:10:52,800
um now the other place you will get hung

270
00:10:52,800 --> 00:10:55,200
up on this is if you have passwords

271
00:10:55,200 --> 00:10:57,779
where maybe you've got stronger

272
00:10:57,779 --> 00:10:59,640
requirements

273
00:10:59,640 --> 00:11:02,100
but you've got accounts that are set to

274
00:11:02,100 --> 00:11:05,040
never require a password change

275
00:11:05,040 --> 00:11:08,100
and so this password has been lingering

276
00:11:08,100 --> 00:11:11,279
in this environment for years uh this

277
00:11:11,279 --> 00:11:12,660
happens a lot with service accounts

278
00:11:12,660 --> 00:11:14,579
because people are understandably loathe

279
00:11:14,579 --> 00:11:16,500
to touch those because they're you know

280
00:11:16,500 --> 00:11:18,060
the longer it's been there the less

281
00:11:18,060 --> 00:11:19,200
certain they are about what's going to

282
00:11:19,200 --> 00:11:21,420
break if they try and change it

283
00:11:21,420 --> 00:11:23,880
so you know that's going to be part of

284
00:11:23,880 --> 00:11:26,220
what we're looking at here

285
00:11:26,220 --> 00:11:28,440
all right how do we find these so if I

286
00:11:28,440 --> 00:11:29,700
go into your network I'm going to be

287
00:11:29,700 --> 00:11:31,519
starting with password spring

288
00:11:31,519 --> 00:11:34,019
it's an okay option but I'm going to

289
00:11:34,019 --> 00:11:36,360
give you something better in a minute

290
00:11:36,360 --> 00:11:38,339
um you can use a tool called curb root

291
00:11:38,339 --> 00:11:40,560
it does Kerberos pre-authentication

292
00:11:40,560 --> 00:11:43,019
password checking

293
00:11:43,019 --> 00:11:45,060
normally if you're doing password sprays

294
00:11:45,060 --> 00:11:46,560
the regular way you're going to generate

295
00:11:46,560 --> 00:11:50,880
a 4625 Windows Event curb root will give

296
00:11:50,880 --> 00:11:52,040
you something else we'll give you that

297
00:11:52,040 --> 00:11:55,680
4771 this is more of a blue uh more of a

298
00:11:55,680 --> 00:11:56,820
sock thing

299
00:11:56,820 --> 00:11:59,220
you know people are often looking for

300
00:11:59,220 --> 00:12:02,399
the 4625 they'll miss the 4771. so from

301
00:12:02,399 --> 00:12:04,560
my perspective it's quieter it's also a

302
00:12:04,560 --> 00:12:06,660
bit faster

303
00:12:06,660 --> 00:12:09,740
um that said as a technique overall

304
00:12:09,740 --> 00:12:12,779
spraying is slow you've got to be

305
00:12:12,779 --> 00:12:14,459
careful that you're not doing password

306
00:12:14,459 --> 00:12:16,980
sprays too often otherwise you're going

307
00:12:16,980 --> 00:12:18,720
to end up locking out accounts and that

308
00:12:18,720 --> 00:12:22,260
will make people unhappy also you can't

309
00:12:22,260 --> 00:12:23,880
you know you can't test a lot of

310
00:12:23,880 --> 00:12:25,380
passwords at once that's the whole point

311
00:12:25,380 --> 00:12:27,720
with a spray

312
00:12:27,720 --> 00:12:29,399
better if you can just check them all

313
00:12:29,399 --> 00:12:30,920
offline at once

314
00:12:30,920 --> 00:12:35,060
do an actual password audit dump

315
00:12:35,060 --> 00:12:38,220
ntds.dit from your domain controller and

316
00:12:38,220 --> 00:12:40,079
then feed it into a password cracker

317
00:12:40,079 --> 00:12:42,360
using common word lists and see what you

318
00:12:42,360 --> 00:12:43,620
can get

319
00:12:43,620 --> 00:12:46,139
uh this does require a computer with a

320
00:12:46,139 --> 00:12:48,180
GPU but this doesn't mean you need

321
00:12:48,180 --> 00:12:49,800
anything fancy

322
00:12:49,800 --> 00:12:53,040
you know we use the gpus I mean they're

323
00:12:53,040 --> 00:12:54,779
they're good graphics cards but they're

324
00:12:54,779 --> 00:12:57,240
the gpus in our laptops we don't have a

325
00:12:57,240 --> 00:13:00,360
cracking rig with you know 30 or 40 gpus

326
00:13:00,360 --> 00:13:02,220
that we're using and we're still

327
00:13:02,220 --> 00:13:03,959
cracking passwords

328
00:13:03,959 --> 00:13:06,300
we do this partially to show people how

329
00:13:06,300 --> 00:13:08,040
low the barrier to entry for this is

330
00:13:08,040 --> 00:13:10,139
this is not something you know this is

331
00:13:10,139 --> 00:13:12,420
not rocket science it's not magic you

332
00:13:12,420 --> 00:13:16,459
can do it with a decent gaming laptop

333
00:13:16,560 --> 00:13:19,760
um so the tool that I use to dump

334
00:13:19,760 --> 00:13:21,899
ntds.dit is called secret stump it's

335
00:13:21,899 --> 00:13:24,660
part of the impacket package of tools

336
00:13:24,660 --> 00:13:26,880
and it'll give you a nice file you can

337
00:13:26,880 --> 00:13:29,579
feed right into hashcat for uh for

338
00:13:29,579 --> 00:13:30,480
cracking

339
00:13:30,480 --> 00:13:32,519
so here you see you know this is me

340
00:13:32,519 --> 00:13:35,220
running Secrets dump in my domain

341
00:13:35,220 --> 00:13:37,320
um the ones on the right those are the

342
00:13:37,320 --> 00:13:39,779
the ntlm hashes

343
00:13:39,779 --> 00:13:41,459
um those are the real password hashes in

344
00:13:41,459 --> 00:13:45,120
my test lab uh and uh secret stump will

345
00:13:45,120 --> 00:13:46,680
also give you the LM hashes which you

346
00:13:46,680 --> 00:13:50,279
see on the left there all those aad3b4

347
00:13:50,279 --> 00:13:52,680
Etc if you do this and you see anything

348
00:13:52,680 --> 00:13:55,139
other than that repeat that one hash

349
00:13:55,139 --> 00:13:56,940
repeated again and again and again on

350
00:13:56,940 --> 00:13:58,079
the left

351
00:13:58,079 --> 00:14:00,120
that's a problem because those

352
00:14:00,120 --> 00:14:02,100
functionally are not encrypted anymore

353
00:14:02,100 --> 00:14:05,339
you it is Trivial to break all of those

354
00:14:05,339 --> 00:14:07,680
so anything that's still encrypted you

355
00:14:07,680 --> 00:14:09,959
know LM style you need to clean up and

356
00:14:09,959 --> 00:14:11,700
get get rid of that should not be on a

357
00:14:11,700 --> 00:14:14,120
modern Network

358
00:14:14,820 --> 00:14:17,040
um you take that output from Secret dump

359
00:14:17,040 --> 00:14:20,760
you feed it into hashcat and hashcat it

360
00:14:20,760 --> 00:14:22,740
does what it says on the label it cracks

361
00:14:22,740 --> 00:14:24,420
all the hashes it's a highly optimized

362
00:14:24,420 --> 00:14:27,120
password cracker runs very well on a

363
00:14:27,120 --> 00:14:29,820
laptop with a decent GPU if you want to

364
00:14:29,820 --> 00:14:31,380
dump money into a cracking rig you can

365
00:14:31,380 --> 00:14:33,000
totally do that too

366
00:14:33,000 --> 00:14:34,680
uh the other part of this is you need

367
00:14:34,680 --> 00:14:36,300
word lists

368
00:14:36,300 --> 00:14:38,639
um word lists of common passwords you

369
00:14:38,639 --> 00:14:40,920
can get from crackstation.org or

370
00:14:40,920 --> 00:14:42,800
weakpass.com

371
00:14:42,800 --> 00:14:45,120
weekpass.com also has a nice tool where

372
00:14:45,120 --> 00:14:48,480
you can give it terms and it will spit

373
00:14:48,480 --> 00:14:51,360
back a list of passwords based on those

374
00:14:51,360 --> 00:14:53,699
so give it the name of your company give

375
00:14:53,699 --> 00:14:57,120
it the name of key organizations key

376
00:14:57,120 --> 00:14:58,680
units in your company

377
00:14:58,680 --> 00:15:01,680
sports teams other notable things about

378
00:15:01,680 --> 00:15:03,899
your area and it will generate

379
00:15:03,899 --> 00:15:06,180
permutations based on all those that you

380
00:15:06,180 --> 00:15:07,740
can feed in here

381
00:15:07,740 --> 00:15:10,680
and try those against your I guess your

382
00:15:10,680 --> 00:15:12,540
password list

383
00:15:12,540 --> 00:15:15,000
uh one other thing you can do short of a

384
00:15:15,000 --> 00:15:17,220
full password audit is you got that

385
00:15:17,220 --> 00:15:19,260
Bloodhound data earlier to to look for

386
00:15:19,260 --> 00:15:22,019
bad ad issues uh you'll also get in

387
00:15:22,019 --> 00:15:23,399
there the last time every account

388
00:15:23,399 --> 00:15:25,320
changed their password

389
00:15:25,320 --> 00:15:26,940
won't catch anything but everything it

390
00:15:26,940 --> 00:15:28,800
does catch is probably worth looking at

391
00:15:28,800 --> 00:15:30,839
uh this goes back to again things

392
00:15:30,839 --> 00:15:33,779
lingering for years or decades if

393
00:15:33,779 --> 00:15:35,160
somebody hasn't if somebody's password

394
00:15:35,160 --> 00:15:36,839
is so old it's old enough to drive

395
00:15:36,839 --> 00:15:38,940
that's a problem if it's old enough to

396
00:15:38,940 --> 00:15:41,699
drink that's really a problem

397
00:15:41,699 --> 00:15:43,800
um in the notes there's a link to a

398
00:15:43,800 --> 00:15:46,019
script we've got up in GitHub that will

399
00:15:46,019 --> 00:15:48,839
dump that password data into a nice CSV

400
00:15:48,839 --> 00:15:50,339
for you that you can take a look at and

401
00:15:50,339 --> 00:15:52,620
find the really old passwords in your

402
00:15:52,620 --> 00:15:55,040
environment

403
00:15:55,860 --> 00:15:58,019
how do you fix it uh update your

404
00:15:58,019 --> 00:15:59,820
password policy to Modern standards that

405
00:15:59,820 --> 00:16:01,860
means at least 15 characters ideally

406
00:16:01,860 --> 00:16:04,639
passphrases no periodic changes though

407
00:16:04,639 --> 00:16:07,800
current guidance says you don't

408
00:16:07,800 --> 00:16:09,420
regularly change your password because

409
00:16:09,420 --> 00:16:11,459
all that does is it makes your users

410
00:16:11,459 --> 00:16:13,680
want to come with something where they

411
00:16:13,680 --> 00:16:16,079
can keep 14 characters the same and only

412
00:16:16,079 --> 00:16:18,180
change the last one and that's all they

413
00:16:18,180 --> 00:16:19,740
really need to remember

414
00:16:19,740 --> 00:16:21,600
you only change your password if you've

415
00:16:21,600 --> 00:16:22,980
got a reason to think that it's been

416
00:16:22,980 --> 00:16:24,959
compromised if there's been a breach you

417
00:16:24,959 --> 00:16:26,519
know something else looks wrong then you

418
00:16:26,519 --> 00:16:28,380
make somebody change their password

419
00:16:28,380 --> 00:16:30,779
uh group managed service accounts for

420
00:16:30,779 --> 00:16:33,779
service account passwords uh lapse has

421
00:16:33,779 --> 00:16:35,880
been around for a while for local admin

422
00:16:35,880 --> 00:16:37,440
accounts on Windows boxes and I think

423
00:16:37,440 --> 00:16:39,360
they just made some updates this past

424
00:16:39,360 --> 00:16:43,440
week uh to make it even easier to use

425
00:16:43,440 --> 00:16:46,259
and then Azure ad password protection

426
00:16:46,259 --> 00:16:49,259
even if you're still on-prem you can get

427
00:16:49,259 --> 00:16:52,800
Azure ad password protection sync it up

428
00:16:52,800 --> 00:16:55,079
with your local ad and you can give it

429
00:16:55,079 --> 00:16:56,759
sort of like I was showing you on the

430
00:16:56,759 --> 00:16:58,620
theweekpass.com you can give it those

431
00:16:58,620 --> 00:17:00,839
lists of words and say hey block

432
00:17:00,839 --> 00:17:03,360
anything based on permutations of these

433
00:17:03,360 --> 00:17:05,640
we just don't want these passwords in

434
00:17:05,640 --> 00:17:08,299
our environment

435
00:17:10,319 --> 00:17:13,559
sensitive data in shared files our

436
00:17:13,559 --> 00:17:15,119
principal consultant refers to this part

437
00:17:15,119 --> 00:17:17,160
of our job as either file or network

438
00:17:17,160 --> 00:17:18,839
archeology

439
00:17:18,839 --> 00:17:21,839
we get into the network we start looking

440
00:17:21,839 --> 00:17:25,619
for open shares and we just start seeing

441
00:17:25,619 --> 00:17:27,140
what we've got

442
00:17:27,140 --> 00:17:31,880
web.config files Powershell Scripts

443
00:17:31,880 --> 00:17:36,419
AWS config files with uh with keys in

444
00:17:36,419 --> 00:17:39,419
them you know files for cloud

445
00:17:39,419 --> 00:17:40,919
infrastructure that you're testing out

446
00:17:40,919 --> 00:17:42,360
locally and then pushing out to the

447
00:17:42,360 --> 00:17:44,520
cloud or develop or on a developer

448
00:17:44,520 --> 00:17:47,220
laptop

449
00:17:47,220 --> 00:17:49,559
um virtual hard drive images and the

450
00:17:49,559 --> 00:17:52,500
ever popular passwords.txt passwords.doc

451
00:17:52,500 --> 00:17:55,440
passwords.xls

452
00:17:55,440 --> 00:17:57,720
um you know those are often a great way

453
00:17:57,720 --> 00:18:00,000
for us to get privilege escalation and

454
00:18:00,000 --> 00:18:02,160
lateral movement in an environment

455
00:18:02,160 --> 00:18:04,140
but sometimes we don't even need those

456
00:18:04,140 --> 00:18:05,580
to get what we're looking for I have

457
00:18:05,580 --> 00:18:07,260
found you know organizations Disaster

458
00:18:07,260 --> 00:18:10,380
Recovery plans I have found sensitive HR

459
00:18:10,380 --> 00:18:12,799
and legal docs sitting on open shares

460
00:18:12,799 --> 00:18:15,600
it's great when legal has like their

461
00:18:15,600 --> 00:18:17,580
entire file share just sitting open so

462
00:18:17,580 --> 00:18:19,260
that anybody in the in the company can

463
00:18:19,260 --> 00:18:20,940
get at it

464
00:18:20,940 --> 00:18:22,260
um especially when they've got like

465
00:18:22,260 --> 00:18:24,059
settlement docs and and contract

466
00:18:24,059 --> 00:18:25,860
negotiation stuff in there

467
00:18:25,860 --> 00:18:28,880
uh plenty of customer and employee pii

468
00:18:28,880 --> 00:18:31,140
database backups

469
00:18:31,140 --> 00:18:33,720
another good one is uh scans from

470
00:18:33,720 --> 00:18:35,880
virtual fax machines and from printers

471
00:18:35,880 --> 00:18:38,340
that are just you know it scans to disk

472
00:18:38,340 --> 00:18:40,380
somewhere it sends somebody a copy but

473
00:18:40,380 --> 00:18:43,799
it never deletes the the copy it made

474
00:18:43,799 --> 00:18:45,290
um I love finding those

475
00:18:45,290 --> 00:18:46,980
[Music]

476
00:18:46,980 --> 00:18:49,860
how do I find them I like to use smbmap

477
00:18:49,860 --> 00:18:52,200
uh I think this one's nice because it

478
00:18:52,200 --> 00:18:53,580
doesn't just say hey there's this open

479
00:18:53,580 --> 00:18:55,380
share out there I can also tell it to

480
00:18:55,380 --> 00:18:57,120
enumerate all the directories and files

481
00:18:57,120 --> 00:18:58,740
in there and so then I can go through

482
00:18:58,740 --> 00:19:01,140
and you know dump that and then say okay

483
00:19:01,140 --> 00:19:03,059
find all the things with password in the

484
00:19:03,059 --> 00:19:05,640
title but this particular one there's

485
00:19:05,640 --> 00:19:07,799
lots of tools that can do this

486
00:19:07,799 --> 00:19:09,960
um in addition to SMB Map There's crack

487
00:19:09,960 --> 00:19:12,860
map the exec there's EDD

488
00:19:12,860 --> 00:19:15,960
sharp View and Power view have modules

489
00:19:15,960 --> 00:19:18,120
that'll do this or or we'll let you

490
00:19:18,120 --> 00:19:20,760
search for specific terms in file names

491
00:19:20,760 --> 00:19:22,559
on on open shares

492
00:19:22,559 --> 00:19:24,480
there's lots of ways to do this and

493
00:19:24,480 --> 00:19:27,780
again you get a low privileged user

494
00:19:27,780 --> 00:19:30,059
you run one of these tools you take a

495
00:19:30,059 --> 00:19:32,400
look at the output and then you start

496
00:19:32,400 --> 00:19:35,539
going and locking things down

497
00:19:35,820 --> 00:19:38,820
uh other fixes for this educate your

498
00:19:38,820 --> 00:19:42,620
staff on secure data storage practices

499
00:19:42,620 --> 00:19:45,240
educate your developers in an admins on

500
00:19:45,240 --> 00:19:47,160
how to securely handle credentials in

501
00:19:47,160 --> 00:19:49,140
scripts and source code I know that I

502
00:19:49,140 --> 00:19:51,059
think cat over there hit on this in her

503
00:19:51,059 --> 00:19:54,480
talk an hour or so ago uh yeah I love

504
00:19:54,480 --> 00:19:56,280
finding config files I love finding

505
00:19:56,280 --> 00:19:58,559
Powershell Scripts

506
00:19:58,559 --> 00:20:00,240
um but sometimes you'll also get things

507
00:20:00,240 --> 00:20:02,160
like you know somebody will store a

508
00:20:02,160 --> 00:20:05,220
Powershell secure string in the same

509
00:20:05,220 --> 00:20:07,799
folder as the key necessary to decrypt

510
00:20:07,799 --> 00:20:08,820
it

511
00:20:08,820 --> 00:20:10,080
so

512
00:20:10,080 --> 00:20:11,160
um

513
00:20:11,160 --> 00:20:13,020
at a sort of a lower level don't let

514
00:20:13,020 --> 00:20:15,600
users share things off their local hard

515
00:20:15,600 --> 00:20:16,980
drives

516
00:20:16,980 --> 00:20:18,240
um they really just shouldn't be doing

517
00:20:18,240 --> 00:20:19,559
that don't be sharing things off your

518
00:20:19,559 --> 00:20:23,178
work workstation or your laptop

519
00:20:24,480 --> 00:20:26,160
um and then you know like I said audit

520
00:20:26,160 --> 00:20:27,600
your shares to make sure your users can

521
00:20:27,600 --> 00:20:29,400
only access things that they actually

522
00:20:29,400 --> 00:20:31,860
need to for their work for business

523
00:20:31,860 --> 00:20:34,459
purposes

524
00:20:34,740 --> 00:20:36,780
uh this one's a little more esoteric

525
00:20:36,780 --> 00:20:39,960
users joining computers to The Domain uh

526
00:20:39,960 --> 00:20:43,919
MSDS machine account quota that is the

527
00:20:43,919 --> 00:20:46,919
value in active directory that says how

528
00:20:46,919 --> 00:20:49,919
many computers that random domain user

529
00:20:49,919 --> 00:20:52,380
is allowed to join to the network with

530
00:20:52,380 --> 00:20:54,419
no admin privileges it's just something

531
00:20:54,419 --> 00:20:57,059
you're allowed to do by default this is

532
00:20:57,059 --> 00:20:58,679
10.

533
00:20:58,679 --> 00:21:01,500
the problem with this Beyond just

534
00:21:01,500 --> 00:21:03,960
cluttering up your inventory is that

535
00:21:03,960 --> 00:21:06,840
computers joined in this manner get put

536
00:21:06,840 --> 00:21:09,360
in the they don't get put into an OU

537
00:21:09,360 --> 00:21:11,580
like workstations or laptops or

538
00:21:11,580 --> 00:21:13,260
something they just get dumped in the

539
00:21:13,260 --> 00:21:15,480
computers folder

540
00:21:15,480 --> 00:21:17,940
gpos are not typically applied to the

541
00:21:17,940 --> 00:21:19,799
computers folder so anything that gets

542
00:21:19,799 --> 00:21:21,960
added to the computers folder is now

543
00:21:21,960 --> 00:21:23,580
domain joined

544
00:21:23,580 --> 00:21:24,900
but does not have any of the

545
00:21:24,900 --> 00:21:26,280
restrictions that would normally be

546
00:21:26,280 --> 00:21:30,419
applied to it by GPO applied so this

547
00:21:30,419 --> 00:21:32,039
means that I as an attacker if I can

548
00:21:32,039 --> 00:21:34,260
actually join a real computer to the

549
00:21:34,260 --> 00:21:35,640
network I get all the advantages of

550
00:21:35,640 --> 00:21:38,159
domain membership and none of the

551
00:21:38,159 --> 00:21:39,659
penalties

552
00:21:39,659 --> 00:21:42,299
if I can't actually join an actual

553
00:21:42,299 --> 00:21:44,280
computer all I can do is create a

554
00:21:44,280 --> 00:21:45,900
computer object

555
00:21:45,900 --> 00:21:47,820
what I can still do is I can still

556
00:21:47,820 --> 00:21:49,440
leverage that to do something like

557
00:21:49,440 --> 00:21:51,600
resource-based constrained delegation or

558
00:21:51,600 --> 00:21:53,720
resource-based unconstrained delegation

559
00:21:53,720 --> 00:21:56,460
and take advantage of that for privilege

560
00:21:56,460 --> 00:21:58,380
escalation it's a stepping stone to

561
00:21:58,380 --> 00:21:59,580
something else

562
00:21:59,580 --> 00:22:03,179
but it's useful when I can do it

563
00:22:03,179 --> 00:22:03,840
um

564
00:22:03,840 --> 00:22:05,340
it's really easy to find this if you've

565
00:22:05,340 --> 00:22:09,000
got something like ad Explorer I've also

566
00:22:09,000 --> 00:22:10,640
got a sharp view

567
00:22:10,640 --> 00:22:13,140
command in the notes if you pull down

568
00:22:13,140 --> 00:22:16,140
the slides from the network

569
00:22:16,140 --> 00:22:18,059
um but just you literally you search for

570
00:22:18,059 --> 00:22:21,120
MSDS machine account quota and the value

571
00:22:21,120 --> 00:22:22,679
pops right up there and that is that is

572
00:22:22,679 --> 00:22:25,080
the default you know that it all domains

573
00:22:25,080 --> 00:22:28,039
have unless you have changed it

574
00:22:28,039 --> 00:22:30,299
this one's really easy to fix you set

575
00:22:30,299 --> 00:22:33,419
that value to zero and it's done

576
00:22:33,419 --> 00:22:35,520
um I don't know that I've found a

577
00:22:35,520 --> 00:22:37,860
network yet where this was necessary I

578
00:22:37,860 --> 00:22:39,360
mean obviously check with your admins

579
00:22:39,360 --> 00:22:41,880
you know do some testing but this this

580
00:22:41,880 --> 00:22:45,140
should be a real easy one to fix

581
00:22:46,799 --> 00:22:48,900
part two speed bumps roadblocks and

582
00:22:48,900 --> 00:22:50,760
rough terrain

583
00:22:50,760 --> 00:22:53,520
um these are the ones that you know

584
00:22:53,520 --> 00:22:54,900
there's not a vulnerability this is just

585
00:22:54,900 --> 00:22:56,280
this is hardening your network against

586
00:22:56,280 --> 00:22:57,659
me

587
00:22:57,659 --> 00:23:00,000
I will say these are not cure-alls these

588
00:23:00,000 --> 00:23:02,580
are not panaceas these are obstacles not

589
00:23:02,580 --> 00:23:05,700
force fields given time and effort an

590
00:23:05,700 --> 00:23:07,080
attacker can still find a way around

591
00:23:07,080 --> 00:23:09,120
them and you do need to make sure you do

592
00:23:09,120 --> 00:23:10,740
them properly

593
00:23:10,740 --> 00:23:13,740
these are harder to do than addressing

594
00:23:13,740 --> 00:23:15,179
the things that I just pointed out a

595
00:23:15,179 --> 00:23:17,460
minute ago because again a lot of these

596
00:23:17,460 --> 00:23:19,919
are sort of architectural

597
00:23:19,919 --> 00:23:21,480
they will they will require you to

598
00:23:21,480 --> 00:23:23,340
change the way your network works the

599
00:23:23,340 --> 00:23:24,780
way things talk to each other the way

600
00:23:24,780 --> 00:23:27,419
you manage things as a result I'm not

601
00:23:27,419 --> 00:23:28,919
generally going to be making specific

602
00:23:28,919 --> 00:23:31,200
recommendations on tools with a couple

603
00:23:31,200 --> 00:23:34,080
of exceptions and how you go about doing

604
00:23:34,080 --> 00:23:36,360
this is going to vary from organization

605
00:23:36,360 --> 00:23:39,260
to organization

606
00:23:39,419 --> 00:23:41,039
all right so the first one is

607
00:23:41,039 --> 00:23:43,380
application allow listing

608
00:23:43,380 --> 00:23:45,419
um basically

609
00:23:45,419 --> 00:23:47,520
profile your machines

610
00:23:47,520 --> 00:23:49,320
figure out what users are actually

611
00:23:49,320 --> 00:23:51,480
running or should be running

612
00:23:51,480 --> 00:23:54,080
and don't let them run anything else

613
00:23:54,080 --> 00:23:56,460
Microsoft gives you two tools for doing

614
00:23:56,460 --> 00:23:58,080
this there is Windows Defender

615
00:23:58,080 --> 00:24:01,320
application control wdac and app Locker

616
00:24:01,320 --> 00:24:03,840
app Locker is the older tool Microsoft

617
00:24:03,840 --> 00:24:06,299
has stopped making updates to it and is

618
00:24:06,299 --> 00:24:09,020
really pushing everyone towards wdac

619
00:24:09,020 --> 00:24:12,360
either one will work but obviously you

620
00:24:12,360 --> 00:24:13,559
know I'd go with wdeck because it's

621
00:24:13,559 --> 00:24:16,140
going to be supported going forward

622
00:24:16,140 --> 00:24:17,100
um

623
00:24:17,100 --> 00:24:19,080
we've got here is an example of me

624
00:24:19,080 --> 00:24:21,419
trying to use cscript which is a

625
00:24:21,419 --> 00:24:23,100
built-in Microsoft tool

626
00:24:23,100 --> 00:24:25,380
to run a payload in a uh in a Visual

627
00:24:25,380 --> 00:24:29,280
Basic file and you know cscript.exe

628
00:24:29,280 --> 00:24:30,960
failed to run this program is blocked by

629
00:24:30,960 --> 00:24:33,000
group policy

630
00:24:33,000 --> 00:24:35,039
um I ran into this a few months ago and

631
00:24:35,039 --> 00:24:36,840
some of my co-workers have run into it

632
00:24:36,840 --> 00:24:39,179
too and it made it so hard to just get

633
00:24:39,179 --> 00:24:41,820
that initial foothold on a client

634
00:24:41,820 --> 00:24:43,260
machine and we eventually had to ask

635
00:24:43,260 --> 00:24:45,299
them to turn it off

636
00:24:45,299 --> 00:24:48,900
um because between EDR they had they had

637
00:24:48,900 --> 00:24:52,140
a good EDR config but EDR plus this

638
00:24:52,140 --> 00:24:54,960
we just didn't have many options if any

639
00:24:54,960 --> 00:24:56,820
for running a payload we beat our head

640
00:24:56,820 --> 00:24:58,320
against it for quite a while before we

641
00:24:58,320 --> 00:25:00,179
we asked them to dial it back so we

642
00:25:00,179 --> 00:25:02,400
could do the rest of the test

643
00:25:02,400 --> 00:25:04,260
um and the nice thing about this is this

644
00:25:04,260 --> 00:25:06,179
can even block Microsoft signed binaries

645
00:25:06,179 --> 00:25:08,280
that we will use to bypass some EDR

646
00:25:08,280 --> 00:25:09,419
things

647
00:25:09,419 --> 00:25:10,380
um

648
00:25:10,380 --> 00:25:13,500
so things like cscript w script install

649
00:25:13,500 --> 00:25:14,720
util

650
00:25:14,720 --> 00:25:17,700
Ms build you can you can cut all those

651
00:25:17,700 --> 00:25:20,000
off

652
00:25:20,700 --> 00:25:23,940
administrator account separation

653
00:25:23,940 --> 00:25:27,360
um I both love and hate this graph

654
00:25:27,360 --> 00:25:29,279
um I love it because you know the

655
00:25:29,279 --> 00:25:31,620
client's doing something right I hate it

656
00:25:31,620 --> 00:25:32,940
because it's going to make things suck

657
00:25:32,940 --> 00:25:34,500
for me

658
00:25:34,500 --> 00:25:37,320
um you've got your workstation admins in

659
00:25:37,320 --> 00:25:39,000
a separate group from your server admins

660
00:25:39,000 --> 00:25:40,500
in a separate group from your domain

661
00:25:40,500 --> 00:25:41,820
admins

662
00:25:41,820 --> 00:25:44,340
and with the exception of that one it

663
00:25:44,340 --> 00:25:46,200
consultant hanging out over there on the

664
00:25:46,200 --> 00:25:49,320
far left you don't have any basic domain

665
00:25:49,320 --> 00:25:53,220
user accounts in any of those groups

666
00:25:53,220 --> 00:25:54,360
um

667
00:25:54,360 --> 00:25:57,740
this just does a great job of containing

668
00:25:57,740 --> 00:26:00,779
any particular credential compromise

669
00:26:00,779 --> 00:26:03,480
even if I get one of those workstation

670
00:26:03,480 --> 00:26:06,120
admins that doesn't get me onto a server

671
00:26:06,120 --> 00:26:08,460
or onto a domain controller even even

672
00:26:08,460 --> 00:26:10,140
the server admin doesn't get me a domain

673
00:26:10,140 --> 00:26:13,740
controller it's just adding steps for

674
00:26:13,740 --> 00:26:16,860
what I have to do to try and get to the

675
00:26:16,860 --> 00:26:19,679
DC or you know anything else even if I'm

676
00:26:19,679 --> 00:26:21,059
just trying to stay at the server level

677
00:26:21,059 --> 00:26:22,679
that's still an additional hop that I'm

678
00:26:22,679 --> 00:26:24,179
going to have to make an additional

679
00:26:24,179 --> 00:26:25,740
place I'm going to have to find a

680
00:26:25,740 --> 00:26:27,779
credential to compromise

681
00:26:27,779 --> 00:26:31,460
nothing's going to get me everything

682
00:26:32,220 --> 00:26:36,120
that said can't get there from here

683
00:26:36,120 --> 00:26:37,080
um

684
00:26:37,080 --> 00:26:39,240
yeah just figure out what are your

685
00:26:39,240 --> 00:26:40,260
networks should be able to talk to

686
00:26:40,260 --> 00:26:41,640
anything else

687
00:26:41,640 --> 00:26:45,299
um why is your OT accessible from a

688
00:26:45,299 --> 00:26:48,419
regular user workstation if you've got

689
00:26:48,419 --> 00:26:50,400
OT in your environment

690
00:26:50,400 --> 00:26:51,480
um

691
00:26:51,480 --> 00:26:53,880
you know why are why are your regular

692
00:26:53,880 --> 00:26:55,919
users able to access you know

693
00:26:55,919 --> 00:26:58,500
development servers you know what why is

694
00:26:58,500 --> 00:26:59,700
why don't you have it set up so that

695
00:26:59,700 --> 00:27:01,679
only developers can get to those servers

696
00:27:01,679 --> 00:27:04,500
over there that are probably loaded down

697
00:27:04,500 --> 00:27:07,020
with misconfigurations probably have

698
00:27:07,020 --> 00:27:08,820
credentials sitting on them and I can

699
00:27:08,820 --> 00:27:11,520
totally pivot out to those prevask and

700
00:27:11,520 --> 00:27:12,960
then pivot back into the regular network

701
00:27:12,960 --> 00:27:15,299
if I can get to them don't let me get to

702
00:27:15,299 --> 00:27:16,980
them

703
00:27:16,980 --> 00:27:19,200
um this is probably the hardest one to

704
00:27:19,200 --> 00:27:20,640
implement again because this is a major

705
00:27:20,640 --> 00:27:22,919
architectural issue you really got to do

706
00:27:22,919 --> 00:27:24,659
some traffic analysis to figure out

707
00:27:24,659 --> 00:27:27,299
what's talking to what

708
00:27:27,299 --> 00:27:28,860
um but it really pays off when you can

709
00:27:28,860 --> 00:27:31,039
do it

710
00:27:32,220 --> 00:27:33,960
uh this one's a little easier to

711
00:27:33,960 --> 00:27:36,960
restrict SMB this goes back to the the

712
00:27:36,960 --> 00:27:38,700
open file shares

713
00:27:38,700 --> 00:27:40,320
don't let your workstations talk to each

714
00:27:40,320 --> 00:27:43,380
other they probably don't need to this

715
00:27:43,380 --> 00:27:45,600
will also again stop people from sharing

716
00:27:45,600 --> 00:27:48,720
stuff off of their workstations which is

717
00:27:48,720 --> 00:27:51,539
almost always a bad idea you can just do

718
00:27:51,539 --> 00:27:53,520
this with the built-in host based

719
00:27:53,520 --> 00:27:57,059
firewall that comes on every Windows box

720
00:27:57,059 --> 00:27:58,020
um

721
00:27:58,020 --> 00:28:01,140
you know this one's pretty easy

722
00:28:01,140 --> 00:28:03,179
um and I've again I've yet to see a

723
00:28:03,179 --> 00:28:04,559
network where this was really you know

724
00:28:04,559 --> 00:28:05,760
letting

725
00:28:05,760 --> 00:28:08,460
hope workstations user workstations talk

726
00:28:08,460 --> 00:28:09,960
to each other

727
00:28:09,960 --> 00:28:14,179
so rarely is it actually necessary

728
00:28:15,559 --> 00:28:19,020
so you did a password audit you know

729
00:28:19,020 --> 00:28:20,460
you've gotten rid all your your weak

730
00:28:20,460 --> 00:28:22,679
passwords the next step after that is

731
00:28:22,679 --> 00:28:24,240
privileged password management get your

732
00:28:24,240 --> 00:28:28,260
get yourself a a password vault ideally

733
00:28:28,260 --> 00:28:29,640
set it up so that things have to be

734
00:28:29,640 --> 00:28:31,380
checked out and then after they get

735
00:28:31,380 --> 00:28:33,600
checked back in they get rotated

736
00:28:33,600 --> 00:28:35,640
even if somebody copies down a password

737
00:28:35,640 --> 00:28:37,380
and sticks it in a text file on their

738
00:28:37,380 --> 00:28:40,500
desktop by the time I find it it's

739
00:28:40,500 --> 00:28:42,000
already invalid it's not going to get me

740
00:28:42,000 --> 00:28:43,679
anything

741
00:28:43,679 --> 00:28:44,580
um

742
00:28:44,580 --> 00:28:47,279
this is a great one when you can do it

743
00:28:47,279 --> 00:28:49,260
although you have to make sure then you

744
00:28:49,260 --> 00:28:50,880
protect the password Vault I've not

745
00:28:50,880 --> 00:28:52,440
personally tested but I have seen

746
00:28:52,440 --> 00:28:53,880
environments where they didn't protect

747
00:28:53,880 --> 00:28:55,620
the password Vault somebody got control

748
00:28:55,620 --> 00:28:59,820
of it and it was game over at that point

749
00:28:59,820 --> 00:29:03,960
um but this one this was a good one

750
00:29:03,960 --> 00:29:05,220
um I said at the beginning this was 10

751
00:29:05,220 --> 00:29:06,960
ways to frustrate attackers I lied a

752
00:29:06,960 --> 00:29:09,299
little bit there is a bonus bonus 11th

753
00:29:09,299 --> 00:29:11,460
uh Canary tokens

754
00:29:11,460 --> 00:29:13,620
these are just fun

755
00:29:13,620 --> 00:29:14,460
um

756
00:29:14,460 --> 00:29:17,640
and they're so easy to do uh this can be

757
00:29:17,640 --> 00:29:20,700
as simple as adding a account to your

758
00:29:20,700 --> 00:29:22,860
active directory you know make it look

759
00:29:22,860 --> 00:29:24,419
like a regular user account give it a

760
00:29:24,419 --> 00:29:26,039
ridiculously long password that will

761
00:29:26,039 --> 00:29:28,020
never get cracked and then don't tell

762
00:29:28,020 --> 00:29:29,399
anybody about it

763
00:29:29,399 --> 00:29:31,020
and as soon as someone comes in and

764
00:29:31,020 --> 00:29:32,880
starts password spraying as soon as you

765
00:29:32,880 --> 00:29:34,500
see a login attempt against that account

766
00:29:34,500 --> 00:29:37,020
you know something's wrong

767
00:29:37,020 --> 00:29:39,720
um put you know if you you know you're

768
00:29:39,720 --> 00:29:40,980
going to have file shares you're going

769
00:29:40,980 --> 00:29:42,740
to need them stick a file name

770
00:29:42,740 --> 00:29:45,779
passwords.txt in you know some six

771
00:29:45,779 --> 00:29:48,000
folder deep directory

772
00:29:48,000 --> 00:29:51,059
and just leave it there and have

773
00:29:51,059 --> 00:29:52,500
auditing set on it so that if anything

774
00:29:52,500 --> 00:29:54,960
actually opens that it fires off an

775
00:29:54,960 --> 00:29:56,580
alert

776
00:29:56,580 --> 00:29:57,720
um

777
00:29:57,720 --> 00:30:00,000
you know the and the great thing about

778
00:30:00,000 --> 00:30:02,880
these is as an attacker

779
00:30:02,880 --> 00:30:04,799
there's literally nothing I can do about

780
00:30:04,799 --> 00:30:07,140
this all this does is slow me down

781
00:30:07,140 --> 00:30:08,220
because I have to second guess

782
00:30:08,220 --> 00:30:10,440
everything I'm doing because I'm not

783
00:30:10,440 --> 00:30:12,120
going to know that that account that

784
00:30:12,120 --> 00:30:14,179
that Canary account even exists until

785
00:30:14,179 --> 00:30:16,380
I've you know done something that's

786
00:30:16,380 --> 00:30:18,059
touched it and set off an alert I'm not

787
00:30:18,059 --> 00:30:19,679
going to know or I'm going to have to

788
00:30:19,679 --> 00:30:21,960
think very carefully about whether that

789
00:30:21,960 --> 00:30:25,700
passwords.txt file or you know company

790
00:30:25,700 --> 00:30:31,679
salaries.xlsx file is you know wow it

791
00:30:31,679 --> 00:30:34,020
couldn't be that easy that's that's too

792
00:30:34,020 --> 00:30:36,240
good to be true isn't it but

793
00:30:36,240 --> 00:30:38,840
I have to look

794
00:30:38,840 --> 00:30:42,240
and now I'm screwed

795
00:30:42,240 --> 00:30:44,279
um and the like I said these are really

796
00:30:44,279 --> 00:30:46,380
easy to implement

797
00:30:46,380 --> 00:30:47,399
um

798
00:30:47,399 --> 00:30:49,020
so

799
00:30:49,020 --> 00:30:50,460
all right

800
00:30:50,460 --> 00:30:53,580
and that is it

801
00:30:53,580 --> 00:30:57,199
um does anyone have any questions

802
00:31:01,260 --> 00:31:03,179
uh yes

803
00:31:03,179 --> 00:31:04,500
was

804
00:31:04,500 --> 00:31:09,140
yeah let me jump to the beginning we

805
00:31:09,659 --> 00:31:14,340
oink red siege.com frustrate

806
00:31:14,340 --> 00:31:15,539
um the slides are already up there I've

807
00:31:15,539 --> 00:31:18,059
already checked for them I've got a

808
00:31:18,059 --> 00:31:20,720
question back there

809
00:31:24,779 --> 00:31:28,380
sorry I can't quite hear you

810
00:31:28,380 --> 00:31:30,480
uh sorta they're related you know it's

811
00:31:30,480 --> 00:31:32,820
something out there that is you know

812
00:31:32,820 --> 00:31:34,799
attractive that an attacker is going to

813
00:31:34,799 --> 00:31:36,299
intentionally or unintentionally go

814
00:31:36,299 --> 00:31:39,600
after that you know it's only there to

815
00:31:39,600 --> 00:31:41,880
provide an opportunity for for Defenders

816
00:31:41,880 --> 00:31:43,200
to detect them

817
00:31:43,200 --> 00:31:47,159
so yeah they're related Concepts

818
00:31:47,159 --> 00:31:50,059
other questions

819
00:31:50,700 --> 00:31:53,840
right here in front

820
00:31:58,260 --> 00:32:01,080
not necessarily not necessarily I mean

821
00:32:01,080 --> 00:32:04,500
don't get me wrong uh MFA is awesome

822
00:32:04,500 --> 00:32:08,240
um but it's it's more a matter of

823
00:32:08,240 --> 00:32:11,100
frequent password rotations you know

824
00:32:11,100 --> 00:32:13,980
encourage people to pick bad passwords

825
00:32:13,980 --> 00:32:15,480
yeah

826
00:32:15,480 --> 00:32:17,760
um so at the very least you know

827
00:32:17,760 --> 00:32:20,940
once a year if you really have to but

828
00:32:20,940 --> 00:32:23,700
you know figure out what makes sense for

829
00:32:23,700 --> 00:32:25,500
your environment don't just blindly say

830
00:32:25,500 --> 00:32:28,080
90 days or 180 days or something really

831
00:32:28,080 --> 00:32:29,700
put some thought into it and pick a

832
00:32:29,700 --> 00:32:32,539
policy that makes sense

833
00:32:39,179 --> 00:32:41,960
fine

834
00:32:56,340 --> 00:32:59,299
so

835
00:32:59,640 --> 00:33:01,140
yeah if your secret stuff out there

836
00:33:01,140 --> 00:33:02,520
because it's what I it's what I use all

837
00:33:02,520 --> 00:33:04,620
the time I guess so when you say you've

838
00:33:04,620 --> 00:33:07,279
signature that

839
00:33:07,860 --> 00:33:09,480
okay

840
00:33:09,480 --> 00:33:11,220
um it's going to depend on on what it is

841
00:33:11,220 --> 00:33:13,440
you're alerting on so when I'm running

842
00:33:13,440 --> 00:33:15,419
secret stump I'm very often I'm not

843
00:33:15,419 --> 00:33:17,760
actually running it inside the client

844
00:33:17,760 --> 00:33:20,399
domain I'll usually be running it on you

845
00:33:20,399 --> 00:33:22,320
know my Linux workstation that I and I'm

846
00:33:22,320 --> 00:33:24,480
proxying the traffic through so if

847
00:33:24,480 --> 00:33:27,059
you're detecting secret stump itself

848
00:33:27,059 --> 00:33:28,620
that's not going to be an issue if

849
00:33:28,620 --> 00:33:30,600
there's something about the way Secrets

850
00:33:30,600 --> 00:33:33,120
dump is talking to the DC

851
00:33:33,120 --> 00:33:35,279
yeah I'd have to look into that I don't

852
00:33:35,279 --> 00:33:36,539
have a good answer for that off the top

853
00:33:36,539 --> 00:33:38,960
of my head

854
00:33:42,860 --> 00:33:45,840
not not off the top of my head we we do

855
00:33:45,840 --> 00:33:49,200
have a repository repository of tips and

856
00:33:49,200 --> 00:33:51,240
tricks uh back at the office that we can

857
00:33:51,240 --> 00:33:52,559
look through and obviously I can talk to

858
00:33:52,559 --> 00:33:54,419
the rest of my co-workers and and other

859
00:33:54,419 --> 00:33:57,120
places uh but I'll be perfectly honest I

860
00:33:57,120 --> 00:33:59,000
did not sleep well last night so

861
00:33:59,000 --> 00:34:00,840
recalling things off the top of my

862
00:34:00,840 --> 00:34:04,039
head's a little tough at the moment

863
00:34:04,440 --> 00:34:06,659
yeah oh absolutely hit me up and I can

864
00:34:06,659 --> 00:34:09,440
try and get you an answer

865
00:34:32,790 --> 00:34:36,159
[Laughter]

866
00:34:47,639 --> 00:34:49,820
foreign

867
00:34:52,460 --> 00:34:56,720
Confluence I haven't really

868
00:34:57,240 --> 00:34:59,280
Confluence I've encountered before I

869
00:34:59,280 --> 00:35:01,140
haven't had the opportunity to do like

870
00:35:01,140 --> 00:35:02,880
try and build anything for the API and

871
00:35:02,880 --> 00:35:04,880
whatnot I need to I need to set up a lab

872
00:35:04,880 --> 00:35:07,740
and see if I can you know get a test

873
00:35:07,740 --> 00:35:10,819
instance going for that

874
00:35:15,000 --> 00:35:17,880
um nothing specific Shares are good

875
00:35:17,880 --> 00:35:18,839
because there's sort of the lowest

876
00:35:18,839 --> 00:35:20,099
common denominator you're going to find

877
00:35:20,099 --> 00:35:21,420
them everywhere

878
00:35:21,420 --> 00:35:24,240
so no there's there's plenty of other

879
00:35:24,240 --> 00:35:26,220
you know things out there to look at

880
00:35:26,220 --> 00:35:29,598
they're just a little more specific

881
00:35:32,700 --> 00:35:35,339
anyone else

882
00:35:35,339 --> 00:35:38,240
yes sir

883
00:35:57,780 --> 00:36:02,160
I have not found mistakes recently

884
00:36:02,160 --> 00:36:04,440
um and and I have and I I have not been

885
00:36:04,440 --> 00:36:06,540
in an environment that has been as

886
00:36:06,540 --> 00:36:08,400
jacked up as the one I described that

887
00:36:08,400 --> 00:36:10,619
was one where I saw

888
00:36:10,619 --> 00:36:12,660
I was there while somebody else was I

889
00:36:12,660 --> 00:36:13,619
was there for something else while

890
00:36:13,619 --> 00:36:15,420
someone else was doing a pen test and I

891
00:36:15,420 --> 00:36:17,160
saw all the alerts coming into their

892
00:36:17,160 --> 00:36:18,660
sock and I saw them rolling their eyes

893
00:36:18,660 --> 00:36:20,220
like he doesn't get it he's already

894
00:36:20,220 --> 00:36:24,618
owned everything why doesn't he stop

895
00:36:25,859 --> 00:36:29,040
um but I I personally have not been in

896
00:36:29,040 --> 00:36:31,560
an environment where they left the keys

897
00:36:31,560 --> 00:36:32,820
to the password Vault hanging out

898
00:36:32,820 --> 00:36:34,200
somewhere

899
00:36:34,200 --> 00:36:35,880
so but it's just it is something to be

900
00:36:35,880 --> 00:36:38,300
aware of

901
00:36:39,200 --> 00:36:42,859
yes in the back

902
00:37:01,280 --> 00:37:06,920
that's a very wide open question I mean

903
00:37:07,079 --> 00:37:08,700
I mean the question is protecting

904
00:37:08,700 --> 00:37:12,960
yourself from what precisely hmm

905
00:37:12,960 --> 00:37:16,020
sorry Ackles or hackers

906
00:37:16,020 --> 00:37:17,520
okay

907
00:37:17,520 --> 00:37:20,400
um I mean Discord itself is not

908
00:37:20,400 --> 00:37:23,579
particularly you know more or less

909
00:37:23,579 --> 00:37:25,320
dangerous than a lot of other places

910
00:37:25,320 --> 00:37:27,720
online I I guess

911
00:37:27,720 --> 00:37:29,940
it would

912
00:37:29,940 --> 00:37:32,760
I mean people can share stuff to their

913
00:37:32,760 --> 00:37:34,740
um you know people can share stuff to a

914
00:37:34,740 --> 00:37:36,839
lot of places that's you know you may

915
00:37:36,839 --> 00:37:38,220
want to look at like some sort of DLP

916
00:37:38,220 --> 00:37:40,980
solution for that but I don't have any

917
00:37:40,980 --> 00:37:42,839
specific recommendations for you know

918
00:37:42,839 --> 00:37:46,160
dealing with Discord securely

919
00:37:49,980 --> 00:37:53,160
sorry one more time

920
00:37:53,160 --> 00:37:55,500
uh primarily Linux and burns I mean a

921
00:37:55,500 --> 00:37:57,540
lot of these things are going to apply

922
00:37:57,540 --> 00:37:59,460
um you know you can use host based

923
00:37:59,460 --> 00:38:00,960
firewalls on Linux you'll just be using

924
00:38:00,960 --> 00:38:03,420
iptables or ufw

925
00:38:03,420 --> 00:38:04,380
um

926
00:38:04,380 --> 00:38:05,640
you know you're still going to want to

927
00:38:05,640 --> 00:38:07,440
lock down any shares whether that's SMB

928
00:38:07,440 --> 00:38:09,420
or NFS

929
00:38:09,420 --> 00:38:11,880
um you know password management you're

930
00:38:11,880 --> 00:38:12,960
probably not going to be dumping into

931
00:38:12,960 --> 00:38:14,700
ds.dit

932
00:38:14,700 --> 00:38:18,240
um in that case but you know you can if

933
00:38:18,240 --> 00:38:19,140
you want to take a look at your

934
00:38:19,140 --> 00:38:20,760
centrally managed password file or

935
00:38:20,760 --> 00:38:22,440
however you're managing passwords that

936
00:38:22,440 --> 00:38:23,760
way

937
00:38:23,760 --> 00:38:24,780
um

938
00:38:24,780 --> 00:38:27,119
but you concept the these can these

939
00:38:27,119 --> 00:38:29,520
Concepts can be adapted to a Linux

940
00:38:29,520 --> 00:38:31,940
environment

941
00:38:34,619 --> 00:38:37,220
yes

942
00:38:43,800 --> 00:38:44,820
um

943
00:38:44,820 --> 00:38:47,220
let's see I mean

944
00:38:47,220 --> 00:38:50,640
practice uh ctfs are good

945
00:38:50,640 --> 00:38:51,480
um

946
00:38:51,480 --> 00:38:54,540
but also don't necessarily look at going

947
00:38:54,540 --> 00:38:57,780
directly into security uh start you know

948
00:38:57,780 --> 00:39:00,060
if you start as assistant admin

949
00:39:00,060 --> 00:39:03,599
because basically in a lot of ways you

950
00:39:03,599 --> 00:39:05,040
know pen testers are just malicious

951
00:39:05,040 --> 00:39:08,160
sysadmins or sis admins who are you know

952
00:39:08,160 --> 00:39:10,260
they know what the easy and quick way is

953
00:39:10,260 --> 00:39:11,640
to get something done that's probably

954
00:39:11,640 --> 00:39:13,500
going to break something else but you

955
00:39:13,500 --> 00:39:15,839
know we want to get out by five

956
00:39:15,839 --> 00:39:17,339
so

957
00:39:17,339 --> 00:39:19,560
um no get get familiar with the systems

958
00:39:19,560 --> 00:39:21,780
it's it's the whole you know don't break

959
00:39:21,780 --> 00:39:23,760
the rules until you know the rules learn

960
00:39:23,760 --> 00:39:26,160
how the systems work and that will also

961
00:39:26,160 --> 00:39:27,900
teach you how to break them

962
00:39:27,900 --> 00:39:30,079
so

963
00:39:30,079 --> 00:39:32,880
all right

964
00:39:32,880 --> 00:39:35,720
anyone else

965
00:39:36,540 --> 00:39:39,380
yes yes

966
00:39:43,500 --> 00:39:46,380
yep that's another that's another one

967
00:39:46,380 --> 00:39:47,460
um

968
00:39:47,460 --> 00:39:50,339
Yeah so basically uh for for ECS one in

969
00:39:50,339 --> 00:39:51,900
specific in particular turn off the

970
00:39:51,900 --> 00:39:53,579
ability to specify a subject alternate

971
00:39:53,579 --> 00:39:54,599
name

972
00:39:54,599 --> 00:39:56,099
um that that will block that particular

973
00:39:56,099 --> 00:39:59,000
attack yeah

974
00:40:03,000 --> 00:40:06,540
all right seeing no other hands uh if

975
00:40:06,540 --> 00:40:08,400
anyone wants uh stickers or anything

976
00:40:08,400 --> 00:40:09,780
like that I've got plenty of stickers

977
00:40:09,780 --> 00:40:12,180
come see me after the talk and I'd like

978
00:40:12,180 --> 00:40:13,740
to thank you all for being here I'd like

979
00:40:13,740 --> 00:40:15,599
to thank B-side charms for letting me

980
00:40:15,599 --> 00:40:16,560
speak

981
00:40:16,560 --> 00:40:19,170
y'all enjoy the rest of your day weekend

982
00:40:19,170 --> 00:40:20,730
[Music]

983
00:40:20,730 --> 00:40:24,650
[Applause]

