1
00:00:00,120 --> 00:00:03,120
foreign

2
00:00:06,020 --> 00:00:21,539
[Music]

3
00:00:21,539 --> 00:00:24,000
hello everyone hello besides charm thank

4
00:00:24,000 --> 00:00:25,500
you for coming out

5
00:00:25,500 --> 00:00:28,800
to our talk active directory in the

6
00:00:28,800 --> 00:00:34,260
domain name system I am Jake and I'm Jim

7
00:00:34,260 --> 00:00:37,399
we are calling this

8
00:00:37,739 --> 00:00:40,090
the wrong direction cool

9
00:00:40,090 --> 00:00:43,440
[Laughter]

10
00:00:43,440 --> 00:00:46,559
a match made in heaven but anybody

11
00:00:46,559 --> 00:00:48,000
that's worked in active directory knows

12
00:00:48,000 --> 00:00:50,820
that's not quite true

13
00:00:50,820 --> 00:00:53,039
imagine made in Hell a little too spicy

14
00:00:53,039 --> 00:00:54,960
Jake

15
00:00:54,960 --> 00:00:56,879
a match made in heck

16
00:00:56,879 --> 00:00:58,440
very appropriate for our Midwestern

17
00:00:58,440 --> 00:01:00,120
sensibilities I'm from Ohio he's from

18
00:01:00,120 --> 00:01:02,460
Minnesota so yeah we're not allowed to

19
00:01:02,460 --> 00:01:04,760
swear

20
00:01:04,860 --> 00:01:06,840
so who are we

21
00:01:06,840 --> 00:01:10,020
well I'm Jim Sakura I'm a long time I.T

22
00:01:10,020 --> 00:01:13,740
generalist uh I'm on the uh a security

23
00:01:13,740 --> 00:01:16,020
consultant on identity security I've

24
00:01:16,020 --> 00:01:19,080
joined Trimark about a year ago and I'm

25
00:01:19,080 --> 00:01:21,060
not famous on Twitter but that's where

26
00:01:21,060 --> 00:01:22,500
you're probably more likely to find me

27
00:01:22,500 --> 00:01:25,439
if you want to chat afterwards

28
00:01:25,439 --> 00:01:29,520
and my name is Jake Jake Hildreth uh I'm

29
00:01:29,520 --> 00:01:31,799
also a long time I.T generalist uh

30
00:01:31,799 --> 00:01:33,420
started programming in basic on the

31
00:01:33,420 --> 00:01:36,350
Commodore 64. so yes I'm old

32
00:01:36,350 --> 00:01:39,360
[Laughter]

33
00:01:39,360 --> 00:01:43,619
uh currently run our uh active directory

34
00:01:43,619 --> 00:01:46,040
security assessment team at Trimark

35
00:01:46,040 --> 00:01:48,540
also I've been told that I'm supposed to

36
00:01:48,540 --> 00:01:50,460
say that I am the co-host of the twitch

37
00:01:50,460 --> 00:01:54,420
uh happy hour from Trimark

38
00:01:54,420 --> 00:01:56,530
co-host did I say co-host

39
00:01:56,530 --> 00:01:58,020
[Laughter]

40
00:01:58,020 --> 00:02:02,100
uh maintainer of the locksmith uh adcs

41
00:02:02,100 --> 00:02:04,619
remediation tool that was presented here

42
00:02:04,619 --> 00:02:07,380
last year for the first time

43
00:02:07,380 --> 00:02:10,560
uh and then I'm on Mastodon so come find

44
00:02:10,560 --> 00:02:14,340
me there for uh posting

45
00:02:14,340 --> 00:02:15,900
so what are we going to talk about today

46
00:02:15,900 --> 00:02:17,700
we're going to talk about Addie and

47
00:02:17,700 --> 00:02:19,200
Dennis

48
00:02:19,200 --> 00:02:20,580
so

49
00:02:20,580 --> 00:02:23,340
who is Addie wait we skipped ahead too

50
00:02:23,340 --> 00:02:26,400
far didn't we okay all right all right

51
00:02:26,400 --> 00:02:28,680
all right uh addy is who what we call

52
00:02:28,680 --> 00:02:30,239
Active Directory

53
00:02:30,239 --> 00:02:31,560
um we don't actually use that name it's

54
00:02:31,560 --> 00:02:34,319
just cute uh active directory is the

55
00:02:34,319 --> 00:02:37,080
directory service that underlies 95 of

56
00:02:37,080 --> 00:02:39,060
corporate networks out there uh it

57
00:02:39,060 --> 00:02:42,840
combines Kerberos with an ldap database

58
00:02:42,840 --> 00:02:44,760
and provide some other services like

59
00:02:44,760 --> 00:02:47,280
Federation and the previously mentioned

60
00:02:47,280 --> 00:02:49,319
adcs active directory certificate

61
00:02:49,319 --> 00:02:52,019
services that anybody that's running an

62
00:02:52,019 --> 00:02:53,519
active directory environment out there I

63
00:02:53,519 --> 00:02:56,640
bet you're vulnerable to just saying

64
00:02:56,640 --> 00:02:59,280
uh Dennis

65
00:02:59,280 --> 00:03:01,379
is the domain name system

66
00:03:01,379 --> 00:03:04,440
uh Dennis was born in the early 80s

67
00:03:04,440 --> 00:03:07,379
Dennis helps you translate uh human

68
00:03:07,379 --> 00:03:10,200
understandable names into computer

69
00:03:10,200 --> 00:03:13,080
understandable IP addresses

70
00:03:13,080 --> 00:03:15,260
uh it's essential to the modern internet

71
00:03:15,260 --> 00:03:18,540
and uh you've found that out if you've

72
00:03:18,540 --> 00:03:20,280
ever worked in operations because it's

73
00:03:20,280 --> 00:03:23,480
always DNS

74
00:03:23,879 --> 00:03:27,000
so for a little uh quick history on how

75
00:03:27,000 --> 00:03:29,340
this marriage happened

76
00:03:29,340 --> 00:03:29,940
um

77
00:03:29,940 --> 00:03:32,519
before active directory was released in

78
00:03:32,519 --> 00:03:34,260
in the olden days

79
00:03:34,260 --> 00:03:37,440
we had NT directory Services uh to do

80
00:03:37,440 --> 00:03:38,940
name resolution at that time you're

81
00:03:38,940 --> 00:03:41,640
using net bios you're using llmnr you're

82
00:03:41,640 --> 00:03:45,480
using wins these terrible protocols with

83
00:03:45,480 --> 00:03:47,480
no security built into them

84
00:03:47,480 --> 00:03:50,400
and that's really even if that directory

85
00:03:50,400 --> 00:03:52,819
service was using TCP

86
00:03:52,819 --> 00:03:54,959
a lot of networks back then are using

87
00:03:54,959 --> 00:03:58,260
ipx SPX anybody use that familiar no

88
00:03:58,260 --> 00:04:00,659
okay good oh we got one all right good

89
00:04:00,659 --> 00:04:02,220
deal

90
00:04:02,220 --> 00:04:05,159
uh but then in early 2000 active

91
00:04:05,159 --> 00:04:06,780
directory was released

92
00:04:06,780 --> 00:04:09,360
it as mentioned uh directory services

93
00:04:09,360 --> 00:04:11,340
including DNS

94
00:04:11,340 --> 00:04:14,159
and they've been pretty interlinked ever

95
00:04:14,159 --> 00:04:17,940
since I mean active directory uses DNS

96
00:04:17,940 --> 00:04:20,519
to identify so many things and you know

97
00:04:20,519 --> 00:04:23,340
DNS stores all of its information in

98
00:04:23,340 --> 00:04:25,560
active directory so they're pretty

99
00:04:25,560 --> 00:04:27,660
codependent at this point

100
00:04:27,660 --> 00:04:29,699
um if you compromise A.D you're going to

101
00:04:29,699 --> 00:04:31,440
compromise the DNS if you compromise the

102
00:04:31,440 --> 00:04:34,560
DNS you could probably compromise A.D so

103
00:04:34,560 --> 00:04:39,600
for a little more detail on where uh

104
00:04:39,600 --> 00:04:42,960
this is an out of date uh

105
00:04:42,960 --> 00:04:44,580
we're we're missing a bunch of slides

106
00:04:44,580 --> 00:04:47,280
all right that's okay for more detail I

107
00:04:47,280 --> 00:04:48,540
can talk about it anyway

108
00:04:48,540 --> 00:04:51,600
um so all of the you know historically

109
00:04:51,600 --> 00:04:54,240
DNS zones and records were stored in a

110
00:04:54,240 --> 00:04:56,100
Zone file with a startup Authority and

111
00:04:56,100 --> 00:04:57,720
all the records after that whether

112
00:04:57,720 --> 00:05:00,419
that's bind or whatever and after direct

113
00:05:00,419 --> 00:05:02,280
reintegrated DNS can do that as well

114
00:05:02,280 --> 00:05:04,620
with local files but

115
00:05:04,620 --> 00:05:06,960
um you know doing Zone transfers and all

116
00:05:06,960 --> 00:05:09,660
that stuff kind of sucks but you know

117
00:05:09,660 --> 00:05:12,500
active directory introduced multi

118
00:05:12,500 --> 00:05:15,000
multimodal replication or multi-master

119
00:05:15,000 --> 00:05:18,660
replication and allows that

120
00:05:18,660 --> 00:05:21,300
to work with DNS as well through the

121
00:05:21,300 --> 00:05:23,120
integrated DNS zones

122
00:05:23,120 --> 00:05:26,220
that lets all of the DNS zones replicate

123
00:05:26,220 --> 00:05:28,919
across your domain forests whatever and

124
00:05:28,919 --> 00:05:31,020
all of the records that are in them and

125
00:05:31,020 --> 00:05:34,139
gives you a lot simpler

126
00:05:34,139 --> 00:05:36,660
if not uh

127
00:05:36,660 --> 00:05:38,340
just a completely different way of

128
00:05:38,340 --> 00:05:40,500
handling all that replication of those

129
00:05:40,500 --> 00:05:42,440
DNS nodes across here

130
00:05:42,440 --> 00:05:45,000
all across your network the other part

131
00:05:45,000 --> 00:05:46,979
of that is that all the records for

132
00:05:46,979 --> 00:05:49,440
active directory integrated DNS zones

133
00:05:49,440 --> 00:05:53,460
are stored in what's called DNS nodes so

134
00:05:53,460 --> 00:05:55,800
they're stored in active directory and

135
00:05:55,800 --> 00:05:59,100
every DNS node is a record or has

136
00:05:59,100 --> 00:06:03,180
multiple records associated with it

137
00:06:03,180 --> 00:06:05,100
so just imagine the screenshots that

138
00:06:05,100 --> 00:06:06,300
would have been in the slide if we would

139
00:06:06,300 --> 00:06:10,500
have put put that there yep

140
00:06:11,639 --> 00:06:14,460
so I'm going to start out oh there's

141
00:06:14,460 --> 00:06:15,660
there's another slide that's missing

142
00:06:15,660 --> 00:06:17,940
that's interesting um so this is what

143
00:06:17,940 --> 00:06:20,160
happens when you edit slides 15 minutes

144
00:06:20,160 --> 00:06:22,259
before your presentation just in case

145
00:06:22,259 --> 00:06:25,020
you're wondering anyway

146
00:06:25,020 --> 00:06:28,979
um so you know obviously we've chosen a

147
00:06:28,979 --> 00:06:30,780
marriage theme for our presentation

148
00:06:30,780 --> 00:06:32,460
which is really weird because we're

149
00:06:32,460 --> 00:06:34,860
weird but um

150
00:06:34,860 --> 00:06:36,360
the reason that we did that is because

151
00:06:36,360 --> 00:06:38,819
we kind of got on this on this idea of

152
00:06:38,819 --> 00:06:41,759
uh the traditional wedding blessing of

153
00:06:41,759 --> 00:06:43,800
of Something Old Something New Something

154
00:06:43,800 --> 00:06:46,440
Borrowed and something blue so we're

155
00:06:46,440 --> 00:06:48,180
going to go through active directory

156
00:06:48,180 --> 00:06:50,880
integrated DNS in that theme and I'm

157
00:06:50,880 --> 00:06:53,580
going to start out with some uh some

158
00:06:53,580 --> 00:06:57,740
old things including previous research

159
00:06:58,500 --> 00:07:02,639
so going back to how DNS records and

160
00:07:02,639 --> 00:07:04,259
zones are stored in active directory

161
00:07:04,259 --> 00:07:06,720
which I just briefed on

162
00:07:06,720 --> 00:07:08,580
um they're all they're all active

163
00:07:08,580 --> 00:07:10,460
directory objects

164
00:07:10,460 --> 00:07:14,539
and you know there's been ways to

165
00:07:14,539 --> 00:07:17,460
manipulate DNS records inside of

166
00:07:17,460 --> 00:07:21,240
networks and for attackers to do uh

167
00:07:21,240 --> 00:07:23,520
manipulation of name resolution through

168
00:07:23,520 --> 00:07:25,199
things like poisoning for a long time

169
00:07:25,199 --> 00:07:28,919
Jake mentioned some things like llmnar

170
00:07:28,919 --> 00:07:31,440
or netbios name Services

171
00:07:31,440 --> 00:07:33,479
um responder came out in 2012 anybody

172
00:07:33,479 --> 00:07:37,020
familiar with responder yeah so

173
00:07:37,020 --> 00:07:38,460
um and there's probably people were

174
00:07:38,460 --> 00:07:39,900
doing DNS poisoning maybe before

175
00:07:39,900 --> 00:07:41,520
responder but like

176
00:07:41,520 --> 00:07:44,940
that's when it really hit the market

177
00:07:44,940 --> 00:07:45,960
um

178
00:07:45,960 --> 00:07:48,660
responder really only works within your

179
00:07:48,660 --> 00:07:49,860
local

180
00:07:49,860 --> 00:07:51,060
um

181
00:07:51,060 --> 00:07:53,160
your local network

182
00:07:53,160 --> 00:07:54,060
um

183
00:07:54,060 --> 00:07:55,860
and I forgot some words right there but

184
00:07:55,860 --> 00:07:57,000
that's cool

185
00:07:57,000 --> 00:07:59,780
um but the thing of it is is that DNS

186
00:07:59,780 --> 00:08:02,099
records when it comes to name resolution

187
00:08:02,099 --> 00:08:04,319
from a Windows client

188
00:08:04,319 --> 00:08:07,020
um you have host file DNS records and

189
00:08:07,020 --> 00:08:09,720
then below that in the pecking order all

190
00:08:09,720 --> 00:08:11,400
of your multi

191
00:08:11,400 --> 00:08:12,720
um

192
00:08:12,720 --> 00:08:15,300
uh resolution uh where they're where

193
00:08:15,300 --> 00:08:18,180
they're doing broadcast resolution so a

194
00:08:18,180 --> 00:08:19,800
while ago a person named Kevin Robertson

195
00:08:19,800 --> 00:08:21,360
did a bunch of research into active

196
00:08:21,360 --> 00:08:24,599
directory DNS and started off with

197
00:08:24,599 --> 00:08:28,259
abusing Dynamic DNS updates Dynamic DNS

198
00:08:28,259 --> 00:08:31,319
updates are what let your computers

199
00:08:31,319 --> 00:08:34,740
Windows computers other computers create

200
00:08:34,740 --> 00:08:36,719
a DNS record in active directory

201
00:08:36,719 --> 00:08:38,640
integrated DNS and then update their own

202
00:08:38,640 --> 00:08:40,919
record as they change IP addresses that

203
00:08:40,919 --> 00:08:43,200
change functions so Kevin was able to

204
00:08:43,200 --> 00:08:45,600
abuse Dynamic DNS records and he could

205
00:08:45,600 --> 00:08:47,940
create DNS records with that but he

206
00:08:47,940 --> 00:08:50,459
couldn't create a wild card record now a

207
00:08:50,459 --> 00:08:53,279
wild card record in DNS will let you do

208
00:08:53,279 --> 00:08:57,360
much the same thing that responder does

209
00:08:57,360 --> 00:09:00,360
um by advertising anytime somebody makes

210
00:09:00,360 --> 00:09:02,459
a a name query for something that

211
00:09:02,459 --> 00:09:05,339
doesn't exist responder will say that's

212
00:09:05,339 --> 00:09:07,740
me that's me send your authentication to

213
00:09:07,740 --> 00:09:10,260
me well a wild crowd record will do that

214
00:09:10,260 --> 00:09:13,260
same thing in a little bit a different

215
00:09:13,260 --> 00:09:15,600
way in a higher priority and across any

216
00:09:15,600 --> 00:09:18,540
broadcast domain so

217
00:09:18,540 --> 00:09:20,519
you know he could he couldn't create

218
00:09:20,519 --> 00:09:22,860
Wild Card records with it but he did a

219
00:09:22,860 --> 00:09:24,839
little bit more research and you know

220
00:09:24,839 --> 00:09:27,240
active directory integrated as DNS is

221
00:09:27,240 --> 00:09:29,760
just active directory objects and you

222
00:09:29,760 --> 00:09:32,040
can create manipulate and read active

223
00:09:32,040 --> 00:09:34,920
directory objects with ldap because ldap

224
00:09:34,920 --> 00:09:37,320
is a fundamental part of actroductory so

225
00:09:37,320 --> 00:09:39,420
Kevin found that a little bit of reverse

226
00:09:39,420 --> 00:09:41,339
engineering you could create DNS nodes

227
00:09:41,339 --> 00:09:44,700
for any object that didn't already exist

228
00:09:44,700 --> 00:09:48,420
including Wild Card records with ldap

229
00:09:48,420 --> 00:09:49,920
um and Kevin created a tool called

230
00:09:49,920 --> 00:09:52,860
powermad which uses ldap and still the

231
00:09:52,860 --> 00:09:55,620
the Dynamic DNS updates to manipulate

232
00:09:55,620 --> 00:09:57,959
and abuse DNS records and also

233
00:09:57,959 --> 00:10:01,980
manipulate and abuse computer objects

234
00:10:01,980 --> 00:10:02,880
um

235
00:10:02,880 --> 00:10:04,620
I wasn't really quite done with that one

236
00:10:04,620 --> 00:10:06,240
yet but that's cool

237
00:10:06,240 --> 00:10:08,040
um so DNS poisoning can do a lot of

238
00:10:08,040 --> 00:10:09,899
weird things can redirect traffic to an

239
00:10:09,899 --> 00:10:13,680
attacker machine just like responder DNS

240
00:10:13,680 --> 00:10:15,899
poisoning can create single name UNC

241
00:10:15,899 --> 00:10:18,420
pass which is interesting in a Windows

242
00:10:18,420 --> 00:10:21,899
Network because a single name UNC path

243
00:10:21,899 --> 00:10:23,700
will end up being in your internet Zone

244
00:10:23,700 --> 00:10:27,000
which for a computer running web client

245
00:10:27,000 --> 00:10:29,459
is going to have some different controls

246
00:10:29,459 --> 00:10:34,320
around it than a both a full uh fully

247
00:10:34,320 --> 00:10:35,700
qualified DNS record right Much More

248
00:10:35,700 --> 00:10:37,860
Much More trusted in the network yep so

249
00:10:37,860 --> 00:10:40,500
all this works because Addie and Dennis

250
00:10:40,500 --> 00:10:42,300
are joined at the hip but most

251
00:10:42,300 --> 00:10:44,820
importantly it works because by default

252
00:10:44,820 --> 00:10:47,040
any authenticated user in active

253
00:10:47,040 --> 00:10:50,519
directory can create those DNS roads

254
00:10:50,519 --> 00:10:51,720
um

255
00:10:51,720 --> 00:10:53,399
and we're missing a screenshot there

256
00:10:53,399 --> 00:10:54,600
that's awesome

257
00:10:54,600 --> 00:10:55,980
um I don't know what happens when you

258
00:10:55,980 --> 00:10:57,720
when you do last minute slide updates

259
00:10:57,720 --> 00:10:58,680
but

260
00:10:58,680 --> 00:11:01,680
we do know now um so

261
00:11:01,680 --> 00:11:04,079
imagine that there was a screenshot of

262
00:11:04,079 --> 00:11:05,720
uh from

263
00:11:05,720 --> 00:11:09,480
ldp.exe of uh a DNS Zone showing that

264
00:11:09,480 --> 00:11:11,459
authenticated records or authenticated

265
00:11:11,459 --> 00:11:13,920
users can create any child node

266
00:11:13,920 --> 00:11:14,700
um

267
00:11:14,700 --> 00:11:16,140
so

268
00:11:16,140 --> 00:11:17,820
it's all prior knowledge that any

269
00:11:17,820 --> 00:11:19,680
authenticated user can create any DNS

270
00:11:19,680 --> 00:11:21,180
node that doesn't already exist they

271
00:11:21,180 --> 00:11:23,700
can't just edit any of them uh with some

272
00:11:23,700 --> 00:11:25,260
exceptions but while digging into the

273
00:11:25,260 --> 00:11:27,779
actual directory schema and some of the

274
00:11:27,779 --> 00:11:29,220
the protocol specs we noticed that

275
00:11:29,220 --> 00:11:30,899
authenticated users can create some

276
00:11:30,899 --> 00:11:33,540
other things in DNS in active directory

277
00:11:33,540 --> 00:11:36,000
that were introduced with server 2016

278
00:11:36,000 --> 00:11:38,700
and they're not really Farley you

279
00:11:38,700 --> 00:11:41,100
broadly used or really well all that

280
00:11:41,100 --> 00:11:43,079
well known from what I've seen but

281
00:11:43,079 --> 00:11:45,300
there's a thing called DNS zone scope

282
00:11:45,300 --> 00:11:47,700
containers and Zone Scopes that you can

283
00:11:47,700 --> 00:11:49,560
create underneath a Zone

284
00:11:49,560 --> 00:11:52,860
for the purposes of using DNS policies

285
00:11:52,860 --> 00:11:55,740
to create split brain DNS scenarios and

286
00:11:55,740 --> 00:11:58,500
control other types of policies so what

287
00:11:58,500 --> 00:12:01,079
I found is that any authenticated user

288
00:12:01,079 --> 00:12:03,480
could create a zone scope container

289
00:12:03,480 --> 00:12:05,339
under which any authenticated user could

290
00:12:05,339 --> 00:12:07,200
create a zone scope under which on if

291
00:12:07,200 --> 00:12:09,839
any any authenticated user can create a

292
00:12:09,839 --> 00:12:12,720
zone or a DNS node and this is on any

293
00:12:12,720 --> 00:12:14,700
DNS server active directory integrated

294
00:12:14,700 --> 00:12:18,360
that's server 2016 or newer so we took a

295
00:12:18,360 --> 00:12:22,200
a power bad function and modified it and

296
00:12:22,200 --> 00:12:25,260
created a new ad

297
00:12:25,260 --> 00:12:29,760
integrated gns zone scope command and on

298
00:12:29,760 --> 00:12:33,420
the next slide we got a before up here

299
00:12:33,420 --> 00:12:36,060
so on the on the left hand side you'll

300
00:12:36,060 --> 00:12:39,360
see what DNS managers show us about a

301
00:12:39,360 --> 00:12:40,500
test

302
00:12:40,500 --> 00:12:43,260
um DNS Zone and then you'll see the same

303
00:12:43,260 --> 00:12:46,019
thing in adsi edit

304
00:12:46,019 --> 00:12:49,200
after running new adns zone scope you'll

305
00:12:49,200 --> 00:12:52,740
see that the DNS manager looks exactly

306
00:12:52,740 --> 00:12:56,160
the same but now in adsi edit we have

307
00:12:56,160 --> 00:12:58,740
the Zone the zone scope container and a

308
00:12:58,740 --> 00:13:01,760
malicious zone scope

309
00:13:02,639 --> 00:13:04,079
so

310
00:13:04,079 --> 00:13:05,820
unfortunately that appeared to be a

311
00:13:05,820 --> 00:13:06,899
little bit of a dead end for what

312
00:13:06,899 --> 00:13:09,240
authenticated users could do with that

313
00:13:09,240 --> 00:13:11,880
um the DNS Zone Scopes were as I said

314
00:13:11,880 --> 00:13:14,579
created to work in conjunction with the

315
00:13:14,579 --> 00:13:18,480
DNS policies from uh from server 2016

316
00:13:18,480 --> 00:13:20,100
and newer

317
00:13:20,100 --> 00:13:21,420
um and those

318
00:13:21,420 --> 00:13:23,399
DNS policies are stored on each

319
00:13:23,399 --> 00:13:25,800
individual DNS server whereas that's

320
00:13:25,800 --> 00:13:28,139
replicated depending on the scope of the

321
00:13:28,139 --> 00:13:30,600
Zone the policies themselves are not

322
00:13:30,600 --> 00:13:33,300
replicated they are per DNS server and

323
00:13:33,300 --> 00:13:35,519
in this case the DNS servers are domain

324
00:13:35,519 --> 00:13:37,800
controllers so they're stored in the

325
00:13:37,800 --> 00:13:39,060
registry

326
00:13:39,060 --> 00:13:40,380
um in a place where really only

327
00:13:40,380 --> 00:13:42,660
administrators in the domain have access

328
00:13:42,660 --> 00:13:44,639
to them

329
00:13:44,639 --> 00:13:46,139
um but there's there's some things maybe

330
00:13:46,139 --> 00:13:47,459
we could do with a little bit later on

331
00:13:47,459 --> 00:13:49,760
and some environmental specific things

332
00:13:49,760 --> 00:13:52,500
that might allow an attacker that's low

333
00:13:52,500 --> 00:13:54,300
privilege to create them

334
00:13:54,300 --> 00:13:56,420
let's go

335
00:13:56,420 --> 00:13:59,820
so next thing I want to skip on to is

336
00:13:59,820 --> 00:14:02,160
some other prior research from jerkian

337
00:14:02,160 --> 00:14:05,279
malema and Elijah Samir a Brown dacal

338
00:14:05,279 --> 00:14:08,639
abuse and tying into Kerberos so some of

339
00:14:08,639 --> 00:14:10,740
the research from these two shows

340
00:14:10,740 --> 00:14:13,500
possibilities for relaying

341
00:14:13,500 --> 00:14:15,839
um Kerberos unconstrained delegation and

342
00:14:15,839 --> 00:14:18,480
also abusing resource-based constrained

343
00:14:18,480 --> 00:14:19,620
delegation

344
00:14:19,620 --> 00:14:22,320
uh in active directory so this ties back

345
00:14:22,320 --> 00:14:23,760
to some of the research that Kevin did

346
00:14:23,760 --> 00:14:26,100
in active directory with DNS and the

347
00:14:26,100 --> 00:14:28,380
powerbadtool and some tricky dackle

348
00:14:28,380 --> 00:14:29,940
issues that exist on a lot of computer

349
00:14:29,940 --> 00:14:31,740
objects by default

350
00:14:31,740 --> 00:14:33,839
especially the additional DNS hostname

351
00:14:33,839 --> 00:14:35,880
and allowed to act on behalf of other

352
00:14:35,880 --> 00:14:37,920
identity which is the resource-based

353
00:14:37,920 --> 00:14:39,860
constrained delegation

354
00:14:39,860 --> 00:14:43,440
mechanism for allowing access and spns

355
00:14:43,440 --> 00:14:44,579
as well

356
00:14:44,579 --> 00:14:47,040
So This research shows ways that active

357
00:14:47,040 --> 00:14:48,720
directory integrated DNS and Kerberos

358
00:14:48,720 --> 00:14:51,000
interact and can be abused

359
00:14:51,000 --> 00:14:53,760
so when combined with vulnerable tackles

360
00:14:53,760 --> 00:14:56,339
so adacle is a discretionary Access

361
00:14:56,339 --> 00:14:58,740
Control list so that's the permissions

362
00:14:58,740 --> 00:15:01,380
on an object the whole picture of the

363
00:15:01,380 --> 00:15:02,760
permissions

364
00:15:02,760 --> 00:15:04,740
on a DNS object stored in actor

365
00:15:04,740 --> 00:15:06,180
directory this can open up some attack

366
00:15:06,180 --> 00:15:07,800
avenues that many Defenders aren't

367
00:15:07,800 --> 00:15:09,660
really even thinking about yet and I

368
00:15:09,660 --> 00:15:10,800
hadn't been thinking about them before

369
00:15:10,800 --> 00:15:12,260
starting the stock

370
00:15:12,260 --> 00:15:14,459
different types of DNS zones have

371
00:15:14,459 --> 00:15:17,639
different types of dackles and different

372
00:15:17,639 --> 00:15:19,500
DNS nodes get different permissions

373
00:15:19,500 --> 00:15:22,920
depending on where how and who creates

374
00:15:22,920 --> 00:15:26,519
them if a DNS node which is a record is

375
00:15:26,519 --> 00:15:27,959
created at a certain way any

376
00:15:27,959 --> 00:15:29,940
authenticated user can change it because

377
00:15:29,940 --> 00:15:31,199
they'll have generic right on that

378
00:15:31,199 --> 00:15:33,060
record for for example and we're going

379
00:15:33,060 --> 00:15:35,100
to have some resource slides and Links

380
00:15:35,100 --> 00:15:36,540
at the very end

381
00:15:36,540 --> 00:15:37,380
um

382
00:15:37,380 --> 00:15:39,899
of all this stuff so

383
00:15:39,899 --> 00:15:41,579
assuming those didn't get deleted as

384
00:15:41,579 --> 00:15:42,600
well

385
00:15:42,600 --> 00:15:45,180
um so there's basically four ways to

386
00:15:45,180 --> 00:15:48,300
store a DNS Zone there can be a forest

387
00:15:48,300 --> 00:15:50,639
domain Legacy and files we're going to

388
00:15:50,639 --> 00:15:53,100
skip the files that's the old way with

389
00:15:53,100 --> 00:15:54,600
Zone files um it doesn't really

390
00:15:54,600 --> 00:15:56,639
integrate with ad

391
00:15:56,639 --> 00:15:59,760
um but the screenshot on the left shows

392
00:15:59,760 --> 00:16:01,199
a forest Zone

393
00:16:01,199 --> 00:16:04,079
and it shows what it looks like in adsi

394
00:16:04,079 --> 00:16:07,680
edit so it's in its own partition

395
00:16:07,680 --> 00:16:10,500
um in its own container and on the right

396
00:16:10,500 --> 00:16:12,980
hand side we've got the dackle of that

397
00:16:12,980 --> 00:16:15,740
Forest DNS zone

398
00:16:15,740 --> 00:16:19,199
so Forest DNS zones are stored in that

399
00:16:19,199 --> 00:16:21,120
particular Forest DNS zones partition

400
00:16:21,120 --> 00:16:22,980
and they're replicated to every domain

401
00:16:22,980 --> 00:16:24,720
controller in the actor directory forest

402
00:16:24,720 --> 00:16:27,300
in an active directory the forest is the

403
00:16:27,300 --> 00:16:29,100
security boundary

404
00:16:29,100 --> 00:16:31,079
um they have the strictest tackle out of

405
00:16:31,079 --> 00:16:35,100
any of the the DNS zones and they don't

406
00:16:35,100 --> 00:16:37,940
even allow like a DNS admin any access

407
00:16:37,940 --> 00:16:40,380
special access to it

408
00:16:40,380 --> 00:16:42,899
um the most common uh Forest replicated

409
00:16:42,899 --> 00:16:45,180
zone is going to be the msdcs subdomain

410
00:16:45,180 --> 00:16:47,820
uh which was introduced in Server 2003

411
00:16:47,820 --> 00:16:50,519
it's always going to be a forest DNS

412
00:16:50,519 --> 00:16:52,740
Zone by default even if you have a

413
00:16:52,740 --> 00:16:55,440
single domain Forest

414
00:16:55,440 --> 00:16:58,680
um in modern AED this Zone replicates to

415
00:16:58,680 --> 00:17:02,339
everything in the forest and that is how

416
00:17:02,339 --> 00:17:04,799
clients and domain controllers locate

417
00:17:04,799 --> 00:17:07,319
other domain controllers ldap endpoints

418
00:17:07,319 --> 00:17:09,959
Kerberos kdcs

419
00:17:09,959 --> 00:17:13,619
Etc so and and yes even in my my lab the

420
00:17:13,619 --> 00:17:16,339
DNS is broken

421
00:17:17,400 --> 00:17:19,199
uh demanding Essence are probably going

422
00:17:19,199 --> 00:17:20,880
to be the most common type of active

423
00:17:20,880 --> 00:17:22,859
directory integrated DNS Zone they're

424
00:17:22,859 --> 00:17:24,179
also stored in their own separate

425
00:17:24,179 --> 00:17:26,640
partition which is the domain DNS zones

426
00:17:26,640 --> 00:17:29,820
and they replicate with all DCS in the

427
00:17:29,820 --> 00:17:32,580
domain not the forest the dackle is

428
00:17:32,580 --> 00:17:34,620
still pretty strict but we'll see over

429
00:17:34,620 --> 00:17:35,820
on the right hand side that domain

430
00:17:35,820 --> 00:17:37,740
admins gets full control whereas they

431
00:17:37,740 --> 00:17:41,280
didn't on the the forest and DS DNS

432
00:17:41,280 --> 00:17:43,980
admins gets a special dacalon here which

433
00:17:43,980 --> 00:17:46,919
is almost full control but not quite

434
00:17:46,919 --> 00:17:48,500
next slide

435
00:17:48,500 --> 00:17:50,400
and then

436
00:17:50,400 --> 00:17:52,500
the last thing here which is really

437
00:17:52,500 --> 00:17:55,200
probably pretty hard to see from here is

438
00:17:55,200 --> 00:17:58,440
the main legis the main DNS head object

439
00:17:58,440 --> 00:18:00,120
for all of after directory integrated

440
00:18:00,120 --> 00:18:03,600
DNS is stored under the main

441
00:18:03,600 --> 00:18:06,299
uh forests

442
00:18:06,299 --> 00:18:07,679
uh

443
00:18:07,679 --> 00:18:09,419
standard naming convention under system

444
00:18:09,419 --> 00:18:12,419
and then Microsoft DNS and like that

445
00:18:12,419 --> 00:18:15,120
Microsoft DNS in the system is what I

446
00:18:15,120 --> 00:18:16,740
call like the DNS head object because

447
00:18:16,740 --> 00:18:19,679
that controls all of the active

448
00:18:19,679 --> 00:18:21,360
directory integrated DNS hosts and the

449
00:18:21,360 --> 00:18:23,520
permissions that they have it inherits

450
00:18:23,520 --> 00:18:26,580
its permissions from domain root and

451
00:18:26,580 --> 00:18:28,860
permissions that damn domain rud are

452
00:18:28,860 --> 00:18:30,980
sometimes pretty atrocious

453
00:18:30,980 --> 00:18:35,039
and then also you'll see under here that

454
00:18:35,039 --> 00:18:38,520
Legacy zones are stored in this head

455
00:18:38,520 --> 00:18:41,520
unit and the root DNS servers are stored

456
00:18:41,520 --> 00:18:44,820
in that same container also can inherit

457
00:18:44,820 --> 00:18:48,379
their permissions from domain root

458
00:18:50,720 --> 00:18:53,460
and here

459
00:18:53,460 --> 00:18:55,320
just kind of showing The Inheritance and

460
00:18:55,320 --> 00:18:57,059
how that skips down

461
00:18:57,059 --> 00:18:59,700
um and looking at what it looks like in

462
00:18:59,700 --> 00:19:03,660
DNS manager

463
00:19:05,580 --> 00:19:08,580
next from the uh something old is uh

464
00:19:08,580 --> 00:19:10,799
abusing DNS admins

465
00:19:10,799 --> 00:19:13,919
um back in 2017 Shea bear came out with

466
00:19:13,919 --> 00:19:18,000
released some research on uh a

467
00:19:18,000 --> 00:19:20,820
dll's uh loading issue

468
00:19:20,820 --> 00:19:24,780
um so you could use DNS command to uh

469
00:19:24,780 --> 00:19:27,840
replace dlls on a DNS server again that

470
00:19:27,840 --> 00:19:29,400
DNS server is probably a domain

471
00:19:29,400 --> 00:19:30,380
controller

472
00:19:30,380 --> 00:19:33,419
so this was released in 2017 and

473
00:19:33,419 --> 00:19:36,980
Microsoft patched it with cve 2021

474
00:19:36,980 --> 00:19:40,740
40469 so this was publicly known and

475
00:19:40,740 --> 00:19:44,400
available in the wild to exploit DNS

476
00:19:44,400 --> 00:19:46,080
servers and domain controllers to go

477
00:19:46,080 --> 00:19:48,480
from a DNS admin to

478
00:19:48,480 --> 00:19:51,179
full system or full domain compromise

479
00:19:51,179 --> 00:19:55,860
from May 2017 through November 2021

480
00:19:55,860 --> 00:19:58,919
it's been patched now so any uh you know

481
00:19:58,919 --> 00:20:00,720
current OS is going to have this patched

482
00:20:00,720 --> 00:20:03,480
but DNS admins is still a lot more

483
00:20:03,480 --> 00:20:05,940
powerful than a lot of people expect and

484
00:20:05,940 --> 00:20:10,160
it's not protected by admin SD holder

485
00:20:10,799 --> 00:20:14,580
so on the left we see what DNS admins

486
00:20:14,580 --> 00:20:16,320
group looks like it has explicit access

487
00:20:16,320 --> 00:20:19,440
controls entries account operators has

488
00:20:19,440 --> 00:20:21,539
full control over it inheritance from

489
00:20:21,539 --> 00:20:23,400
the domain root

490
00:20:23,400 --> 00:20:28,080
um and again a lot of places have very

491
00:20:28,080 --> 00:20:30,059
poor permissions models on their domain

492
00:20:30,059 --> 00:20:31,620
root unfortunately

493
00:20:31,620 --> 00:20:33,960
on the right is what admin SD holder

494
00:20:33,960 --> 00:20:36,780
looks like by default in this lab and

495
00:20:36,780 --> 00:20:38,400
this is a dackle that would get stamped

496
00:20:38,400 --> 00:20:40,980
on any protected object in ad like a

497
00:20:40,980 --> 00:20:42,900
member of domain admins or something

498
00:20:42,900 --> 00:20:45,299
like that it's a more strict dackle

499
00:20:45,299 --> 00:20:47,940
inheritance is disabled so it's not

500
00:20:47,940 --> 00:20:49,860
getting any permissions from the root

501
00:20:49,860 --> 00:20:52,500
whereas on the left hand side DNS admins

502
00:20:52,500 --> 00:20:54,240
it is so this means that there's a lot

503
00:20:54,240 --> 00:20:56,880
of paths from a standard user in a lot

504
00:20:56,880 --> 00:20:58,440
of environments that I've seen from or

505
00:20:58,440 --> 00:21:00,240
from a standard user or a low privilege

506
00:21:00,240 --> 00:21:03,299
like help desk user to DNS admins

507
00:21:03,299 --> 00:21:04,980
whether that's at the Domain through

508
00:21:04,980 --> 00:21:07,080
account operators or just weird

509
00:21:07,080 --> 00:21:11,059
permissions on the user containers

510
00:21:13,140 --> 00:21:15,059
yeah and uh

511
00:21:15,059 --> 00:21:17,640
DNS admins also has an explicit access

512
00:21:17,640 --> 00:21:19,980
access control on the that DNS head

513
00:21:19,980 --> 00:21:23,340
object and for domain DNS zones and

514
00:21:23,340 --> 00:21:25,200
Legacy DNS zones they don't have full

515
00:21:25,200 --> 00:21:26,700
control but they do have modify

516
00:21:26,700 --> 00:21:28,740
permissions and modify owner as we can

517
00:21:28,740 --> 00:21:32,280
see up here uh a DNS admin could Grant

518
00:21:32,280 --> 00:21:34,260
permissions to any arbitrary service

519
00:21:34,260 --> 00:21:36,780
security principle and cause that to

520
00:21:36,780 --> 00:21:39,240
inherit down to the Legacy zones or root

521
00:21:39,240 --> 00:21:42,840
hints and also if you are or can become

522
00:21:42,840 --> 00:21:44,400
the owner of an object in active

523
00:21:44,400 --> 00:21:46,740
directory this by default is even more

524
00:21:46,740 --> 00:21:48,200
powerful than having full control

525
00:21:48,200 --> 00:21:51,539
generic all and if you watch the Primark

526
00:21:51,539 --> 00:21:54,360
content Hub in the next couple weeks

527
00:21:54,360 --> 00:21:57,559
we'll have more on that

528
00:21:58,280 --> 00:22:00,840
and then Now for Something Completely

529
00:22:00,840 --> 00:22:02,520
Different I'll be talking about

530
00:22:02,520 --> 00:22:03,900
something newer things that have

531
00:22:03,900 --> 00:22:06,000
happened upon while exploring ADI DNS

532
00:22:06,000 --> 00:22:08,039
and I'm sorry I'm not used to talking

533
00:22:08,039 --> 00:22:10,380
into a mic so I'm I'm messing that up a

534
00:22:10,380 --> 00:22:11,700
little bit but we'll we'll keep working

535
00:22:11,700 --> 00:22:12,960
on it

536
00:22:12,960 --> 00:22:15,020
um

537
00:22:15,120 --> 00:22:17,580
Defenders sometimes utilize things

538
00:22:17,580 --> 00:22:19,620
called DNS sinkholes to prevent access

539
00:22:19,620 --> 00:22:22,020
to malicious or unwanted domains but

540
00:22:22,020 --> 00:22:23,820
what if an attacker could sinkhole

541
00:22:23,820 --> 00:22:25,820
traffic that might get them caught

542
00:22:25,820 --> 00:22:27,900
something that we came up with called

543
00:22:27,900 --> 00:22:31,679
evil sinkhole there will not be a domain

544
00:22:31,679 --> 00:22:33,780
name bot for this I don't know about

545
00:22:33,780 --> 00:22:36,900
that I might buy evilsakehold.com today

546
00:22:36,900 --> 00:22:39,659
yes so

547
00:22:39,659 --> 00:22:40,500
yeah

548
00:22:40,500 --> 00:22:43,679
uh DNS admins can uh

549
00:22:43,679 --> 00:22:46,400
slide please

550
00:22:47,159 --> 00:22:50,100
so DNS admins can create new DNS domain

551
00:22:50,100 --> 00:22:52,440
DNS zones and Legacy zones and local

552
00:22:52,440 --> 00:22:54,179
zones

553
00:22:54,179 --> 00:22:56,460
um DNS zones for an external domain

554
00:22:56,460 --> 00:22:57,780
that's

555
00:22:57,780 --> 00:23:01,200
in the internal DNS

556
00:23:01,200 --> 00:23:02,640
um

557
00:23:02,640 --> 00:23:05,460
Zone will mirror the concept of split

558
00:23:05,460 --> 00:23:09,840
brain DNS and split brain DNS allows the

559
00:23:09,840 --> 00:23:13,380
internal DNS server to look up external

560
00:23:13,380 --> 00:23:15,179
queries and provide an answer for that

561
00:23:15,179 --> 00:23:17,460
without recursing to an external DNS

562
00:23:17,460 --> 00:23:20,220
server so this local DNS server things

563
00:23:20,220 --> 00:23:22,260
is authoritative and it won't recurse so

564
00:23:22,260 --> 00:23:25,200
it's gonna it's gonna return the IP

565
00:23:25,200 --> 00:23:28,980
address that the DNS admin created which

566
00:23:28,980 --> 00:23:30,980
is

567
00:23:30,980 --> 00:23:34,860
192.168.1.1 instead of whatever the

568
00:23:34,860 --> 00:23:37,919
actual real external IP address for

569
00:23:37,919 --> 00:23:39,200
application

570
00:23:39,200 --> 00:23:42,179
insights.cloudsim.com would be

571
00:23:42,179 --> 00:23:44,400
and you'll notice that you know Dennis

572
00:23:44,400 --> 00:23:46,559
admin which is a DNS admin of course

573
00:23:46,559 --> 00:23:49,919
because why not keep up the bit is is

574
00:23:49,919 --> 00:23:51,780
the owner on the object and has full

575
00:23:51,780 --> 00:23:53,400
control over the object

576
00:23:53,400 --> 00:23:57,240
so DNS admins can also create

577
00:23:57,240 --> 00:23:59,940
conditional forwarders these are also

578
00:23:59,940 --> 00:24:02,580
replicated throughout the domain and

579
00:24:02,580 --> 00:24:04,440
conditional forwards give you a little

580
00:24:04,440 --> 00:24:06,500
bit more control over what's going on

581
00:24:06,500 --> 00:24:09,059
but it'll forward any query for that

582
00:24:09,059 --> 00:24:12,419
entire DNS namespace to uh explicitly

583
00:24:12,419 --> 00:24:15,360
Define DNS servers for lookup and those

584
00:24:15,360 --> 00:24:17,400
explicitly Define DNS servers could be

585
00:24:17,400 --> 00:24:19,440
an attacker control DNS server an

586
00:24:19,440 --> 00:24:22,340
attacker control DNS box

587
00:24:22,340 --> 00:24:25,679
or just nothing because if it if the

588
00:24:25,679 --> 00:24:29,760
query doesn't forward it just times out

589
00:24:29,760 --> 00:24:32,159
and that's what we see

590
00:24:32,159 --> 00:24:33,360
that's what would have been on that

591
00:24:33,360 --> 00:24:34,200
slide

592
00:24:34,200 --> 00:24:36,240
um so what what could you use evil

593
00:24:36,240 --> 00:24:38,340
sinkholes for well you know you could

594
00:24:38,340 --> 00:24:40,440
you could

595
00:24:40,440 --> 00:24:42,539
I've seen some edrs that you could

596
00:24:42,539 --> 00:24:45,120
actually blind with DNS thankfully most

597
00:24:45,120 --> 00:24:47,280
of them have figured this out and uh

598
00:24:47,280 --> 00:24:50,340
understand that hey it's always DNS and

599
00:24:50,340 --> 00:24:53,700
put some some Fail-Safe IPS in there but

600
00:24:53,700 --> 00:24:55,080
you can kind of mess with the Telemetry

601
00:24:55,080 --> 00:24:58,380
of some edrs you can mess with Sims

602
00:24:58,380 --> 00:25:00,539
whether they're hosted internally or in

603
00:25:00,539 --> 00:25:02,159
the cloud

604
00:25:02,159 --> 00:25:04,500
um you can Update hosts for in mess with

605
00:25:04,500 --> 00:25:07,140
like patching and AV signatures AV

606
00:25:07,140 --> 00:25:08,940
uploads

607
00:25:08,940 --> 00:25:12,059
um redirect traffic to trusted sites or

608
00:25:12,059 --> 00:25:15,419
Internet zones but it's really loud it's

609
00:25:15,419 --> 00:25:17,580
you can see in the GUI

610
00:25:17,580 --> 00:25:19,500
um it applies to everything in that

611
00:25:19,500 --> 00:25:23,580
entire name space uh so I'm just

612
00:25:23,580 --> 00:25:25,140
wondering if there was a quieter way and

613
00:25:25,140 --> 00:25:27,900
I looked at some of the stuff in server

614
00:25:27,900 --> 00:25:30,779
2016 which was those DNS policies that

615
00:25:30,779 --> 00:25:32,460
got introduced

616
00:25:32,460 --> 00:25:33,659
they're a little bit more interesting

617
00:25:33,659 --> 00:25:35,159
because they don't show up in the GUI

618
00:25:35,159 --> 00:25:37,080
the primary interface is through

619
00:25:37,080 --> 00:25:38,700
Powershell

620
00:25:38,700 --> 00:25:39,380
um

621
00:25:39,380 --> 00:25:42,059
the fun thing about this is it's really

622
00:25:42,059 --> 00:25:44,340
a post compromise scenario because these

623
00:25:44,340 --> 00:25:48,419
DNS policies can only be created uh by

624
00:25:48,419 --> 00:25:51,299
an administrator on each individual DNS

625
00:25:51,299 --> 00:25:53,460
server that's because the DNS policies

626
00:25:53,460 --> 00:25:55,500
are stored in the registry on the DNS

627
00:25:55,500 --> 00:25:58,260
server AKA domain controller they're

628
00:25:58,260 --> 00:26:00,059
stored in hkey local machine software

629
00:26:00,059 --> 00:26:02,700
Microsoft Windows blah blah and only

630
00:26:02,700 --> 00:26:05,820
administrators and system trusted

631
00:26:05,820 --> 00:26:08,100
installer have access to that registry

632
00:26:08,100 --> 00:26:10,620
Key by default

633
00:26:10,620 --> 00:26:11,820
um an attacker with administrative

634
00:26:11,820 --> 00:26:14,820
rights AKA post compromise could perform

635
00:26:14,820 --> 00:26:17,400
some really targeted DNS manipulation to

636
00:26:17,400 --> 00:26:19,260
block or redirect traffic and you could

637
00:26:19,260 --> 00:26:21,900
do that in concert with those domains

638
00:26:21,900 --> 00:26:24,720
those uh DNS zone scope containers and

639
00:26:24,720 --> 00:26:27,120
dns's own Scopes because the query

640
00:26:27,120 --> 00:26:30,600
policies in here allow you to Define

641
00:26:30,600 --> 00:26:32,820
subnets that you want to manipulate the

642
00:26:32,820 --> 00:26:35,340
queries to come from so you could create

643
00:26:35,340 --> 00:26:37,440
that subnet down to a slash 32 and just

644
00:26:37,440 --> 00:26:40,919
use one host that you want to mess with

645
00:26:40,919 --> 00:26:43,620
the traffic on and lets you either

646
00:26:43,620 --> 00:26:47,640
filter queries out or replace those

647
00:26:47,640 --> 00:26:49,260
queries with the things that you put in

648
00:26:49,260 --> 00:26:51,659
the zone scope

649
00:26:51,659 --> 00:26:54,000
um so you know if an attacker could get

650
00:26:54,000 --> 00:26:55,740
you know system or trusted installer on

651
00:26:55,740 --> 00:26:57,539
the DNS server they can manipulate that

652
00:26:57,539 --> 00:27:00,299
that DNS record also but it's a domain

653
00:27:00,299 --> 00:27:02,580
controller so again post compromise

654
00:27:02,580 --> 00:27:04,980
but if the 80 environment is poorly

655
00:27:04,980 --> 00:27:06,600
configured enough

656
00:27:06,600 --> 00:27:08,820
um which which we see all the time which

657
00:27:08,820 --> 00:27:10,200
we see all the time

658
00:27:10,200 --> 00:27:13,020
um there's sometimes overly permissive

659
00:27:13,020 --> 00:27:15,659
tackles out the domain root or like

660
00:27:15,659 --> 00:27:18,539
weird permission issues on Group Policy

661
00:27:18,539 --> 00:27:20,039
objects that are applied to the domain

662
00:27:20,039 --> 00:27:22,940
root or to The Domain controllers OU

663
00:27:22,940 --> 00:27:25,260
that might allow somebody to execute

664
00:27:25,260 --> 00:27:27,900
code on the DC as system or make

665
00:27:27,900 --> 00:27:30,480
registry modifications that would allow

666
00:27:30,480 --> 00:27:32,940
you to manually create these same DNS

667
00:27:32,940 --> 00:27:35,640
policies across all domain controllers

668
00:27:35,640 --> 00:27:38,900
but again that would be post compromise

669
00:27:38,900 --> 00:27:41,460
just remember these DNS policies in

670
00:27:41,460 --> 00:27:43,260
server 2016 plus are not just for

671
00:27:43,260 --> 00:27:45,480
malicious traffic this is really the

672
00:27:45,480 --> 00:27:48,000
Microsoft recommended way now to

673
00:27:48,000 --> 00:27:51,120
implement Sprint split brain DNS if you

674
00:27:51,120 --> 00:27:53,279
actually need to do that it's also great

675
00:27:53,279 --> 00:27:54,900
for filtering out malicious queries

676
00:27:54,900 --> 00:27:57,360
malicious sites and if you don't have

677
00:27:57,360 --> 00:27:58,919
like a forwarder or something to do that

678
00:27:58,919 --> 00:28:01,220
for you

679
00:28:02,720 --> 00:28:06,260
and this is uh what we originally called

680
00:28:06,260 --> 00:28:10,200
Jim's big new hair beading idea dangling

681
00:28:10,200 --> 00:28:12,720
spns so I want to I want to ask you uh

682
00:28:12,720 --> 00:28:14,460
how many of you ever have configured an

683
00:28:14,460 --> 00:28:17,880
SPN on an object in active directory

684
00:28:17,880 --> 00:28:19,980
raise your hands if you

685
00:28:19,980 --> 00:28:23,220
've got two two how many of how many of

686
00:28:23,220 --> 00:28:25,620
you have deleted an SPN off of an object

687
00:28:25,620 --> 00:28:28,620
in active directory

688
00:28:28,620 --> 00:28:30,840
okay good good

689
00:28:30,840 --> 00:28:32,640
all right cleaning up somebody else's

690
00:28:32,640 --> 00:28:34,919
mess that's great

691
00:28:34,919 --> 00:28:36,779
um so it's more of a thought experiment

692
00:28:36,779 --> 00:28:39,000
or a theory than a working concept for

693
00:28:39,000 --> 00:28:39,960
now

694
00:28:39,960 --> 00:28:42,360
um but you know and while I think I know

695
00:28:42,360 --> 00:28:45,179
Kerberos every day I'm reminded by

696
00:28:45,179 --> 00:28:47,460
Kerberos how much I don't know

697
00:28:47,460 --> 00:28:49,200
um so

698
00:28:49,200 --> 00:28:51,419
where after directory integrated DNS

699
00:28:51,419 --> 00:28:53,700
relies on active directory to function

700
00:28:53,700 --> 00:28:56,159
many parts of active directory rely on

701
00:28:56,159 --> 00:28:58,820
DNS to function that includes Kerberos

702
00:28:58,820 --> 00:29:01,440
more specifically Kerberos relies on

703
00:29:01,440 --> 00:29:03,179
user principal names service principle

704
00:29:03,179 --> 00:29:06,179
names and especially that host part of

705
00:29:06,179 --> 00:29:10,080
the SPN all rely on DNS so there's a

706
00:29:10,080 --> 00:29:11,580
couple of blog posts out there that

707
00:29:11,580 --> 00:29:13,320
inspired this idea

708
00:29:13,320 --> 00:29:14,580
um there's one from Charlie Clark

709
00:29:14,580 --> 00:29:16,919
another one from dirkian uh Kevin

710
00:29:16,919 --> 00:29:20,899
Robertson and then also alad Shamir

711
00:29:21,720 --> 00:29:24,539
which isn't there now cool all right so

712
00:29:24,539 --> 00:29:27,480
those those um

713
00:29:27,480 --> 00:29:30,919
those blog posts cover some ways of

714
00:29:30,919 --> 00:29:34,080
manipulating an existing computer object

715
00:29:34,080 --> 00:29:36,899
to add an SPN to it then create a

716
00:29:36,899 --> 00:29:39,659
hostname and a DNS record for it to

717
00:29:39,659 --> 00:29:42,779
manipulate it for relaying Kerberos on

718
00:29:42,779 --> 00:29:45,179
constrained delegation or manipulating

719
00:29:45,179 --> 00:29:47,520
it to get resource-based constrained

720
00:29:47,520 --> 00:29:50,039
delegation to work but

721
00:29:50,039 --> 00:29:51,779
I've noticed a lot of times looking at

722
00:29:51,779 --> 00:29:53,220
active directory environments especially

723
00:29:53,220 --> 00:29:56,159
in really large organizations that spns

724
00:29:56,159 --> 00:29:58,440
get created and added to service

725
00:29:58,440 --> 00:30:01,020
accounts but they rarely get taken away

726
00:30:01,020 --> 00:30:03,919
nobody wants to break anything

727
00:30:03,919 --> 00:30:09,179
so if there's an SPN out there that

728
00:30:09,179 --> 00:30:11,760
points to a host that no longer exists

729
00:30:11,760 --> 00:30:15,179
can we take that SPN and that hostname

730
00:30:15,179 --> 00:30:19,020
and manipulate DNS to redirect that

731
00:30:19,020 --> 00:30:22,799
Kerberos traffic and get it to go to an

732
00:30:22,799 --> 00:30:24,960
attacker control machine or to a higher

733
00:30:24,960 --> 00:30:26,460
value Target and that would depend on

734
00:30:26,460 --> 00:30:28,820
whether it's unconstrained delegation or

735
00:30:28,820 --> 00:30:32,178
constrained delegation

736
00:30:33,260 --> 00:30:35,940
and now that I've kind of went through

737
00:30:35,940 --> 00:30:37,320
something old and something new to

738
00:30:37,320 --> 00:30:39,480
celebrate Addie and Dennis's 23rd

739
00:30:39,480 --> 00:30:41,520
anniversary celebration uh you might be

740
00:30:41,520 --> 00:30:44,279
thinking about or wondering like maybe I

741
00:30:44,279 --> 00:30:45,779
should just ditch after directory

742
00:30:45,779 --> 00:30:47,720
integrated DNS or maybe you already did

743
00:30:47,720 --> 00:30:50,700
uh Outsource all your DNS functions to a

744
00:30:50,700 --> 00:30:54,059
third party like bind or uh maybe some

745
00:30:54,059 --> 00:30:56,700
hosted uh DNS solution there's a there's

746
00:30:56,700 --> 00:30:58,799
a bunch of now Cloud DDI Solutions out

747
00:30:58,799 --> 00:31:01,020
there uh I just want you to think about

748
00:31:01,020 --> 00:31:02,640
as critical as

749
00:31:02,640 --> 00:31:05,240
actor directory is to DNS

750
00:31:05,240 --> 00:31:07,980
DNS is critical to active directory in

751
00:31:07,980 --> 00:31:09,779
that control plane for active directory

752
00:31:09,779 --> 00:31:15,059
and if you Outsource that DNS to that

753
00:31:15,059 --> 00:31:18,120
that provides all your records for tier

754
00:31:18,120 --> 00:31:20,760
zero DCS for Kerberos for ldap and

755
00:31:20,760 --> 00:31:22,440
everything to a third party you're

756
00:31:22,440 --> 00:31:23,820
giving a part of your control over

757
00:31:23,820 --> 00:31:25,740
active directory to that third party or

758
00:31:25,740 --> 00:31:27,179
maybe even

759
00:31:27,179 --> 00:31:29,000
um your network Engineers

760
00:31:29,000 --> 00:31:31,799
so instead of thinking about that let's

761
00:31:31,799 --> 00:31:33,720
let's have Jake tell us about Something

762
00:31:33,720 --> 00:31:35,159
Borrowed

763
00:31:35,159 --> 00:31:36,539
yeah so we're calling this something

764
00:31:36,539 --> 00:31:39,480
borrowed because all of these already

765
00:31:39,480 --> 00:31:41,880
exist there's I mean this is not new

766
00:31:41,880 --> 00:31:45,440
knowledge by any means so

767
00:31:45,440 --> 00:31:48,299
ways to defend your DNS environment

768
00:31:48,299 --> 00:31:50,940
number one not really DNS related sorry

769
00:31:50,940 --> 00:31:52,620
but it still needs to be included

770
00:31:52,620 --> 00:31:56,580
disable llmnr disable nbns and maybe

771
00:31:56,580 --> 00:31:58,740
disable multicast DNS

772
00:31:58,740 --> 00:32:00,360
the first two are not required in a

773
00:32:00,360 --> 00:32:02,520
modern Network haven't been for a while

774
00:32:02,520 --> 00:32:05,399
get rid of them the third one might be

775
00:32:05,399 --> 00:32:08,159
but you probably can get rid of it too

776
00:32:08,159 --> 00:32:11,220
uh next up here we've got a wild card

777
00:32:11,220 --> 00:32:14,820
record as Jim mentioned power mad will

778
00:32:14,820 --> 00:32:17,159
create can create a wild card record if

779
00:32:17,159 --> 00:32:19,919
it does not exist however

780
00:32:19,919 --> 00:32:22,200
it can't create a wild card record if it

781
00:32:22,200 --> 00:32:25,020
does exist so be proactive get out there

782
00:32:25,020 --> 00:32:27,840
create your wild card record uh it's a

783
00:32:27,840 --> 00:32:29,460
little touchy on exactly what you need

784
00:32:29,460 --> 00:32:33,299
to do if you are in a single domain oh I

785
00:32:33,299 --> 00:32:34,740
need to read my notes here if you're on

786
00:32:34,740 --> 00:32:38,220
a single single domain Forest uh

787
00:32:38,220 --> 00:32:40,320
you should create a wild card record

788
00:32:40,320 --> 00:32:43,140
that is an a record

789
00:32:43,140 --> 00:32:45,720
um if you are in a forest with multiple

790
00:32:45,720 --> 00:32:47,880
domains in a DNS suffix search order

791
00:32:47,880 --> 00:32:50,700
with DNS suffix search order setup you

792
00:32:50,700 --> 00:32:52,380
need to create that as a text record or

793
00:32:52,380 --> 00:32:54,020
else uh

794
00:32:54,020 --> 00:32:56,700
non-fully qualified domain name queries

795
00:32:56,700 --> 00:32:58,380
are not going to work

796
00:32:58,380 --> 00:33:00,419
that being said just use fully qualified

797
00:33:00,419 --> 00:33:02,820
domain names anyway

798
00:33:02,820 --> 00:33:05,460
uh and then we also have uh the wpad

799
00:33:05,460 --> 00:33:08,460
record as we talked about uh earlier we

800
00:33:08,460 --> 00:33:09,899
mentioned it we didn't really talk about

801
00:33:09,899 --> 00:33:12,899
it uh it's the web proxy Auto Discovery

802
00:33:12,899 --> 00:33:15,419
record uh this kind of tells your

803
00:33:15,419 --> 00:33:17,940
clients where there's a proxy in your

804
00:33:17,940 --> 00:33:19,019
network

805
00:33:19,019 --> 00:33:21,120
you might need it you might not in your

806
00:33:21,120 --> 00:33:23,100
environment if you do

807
00:33:23,100 --> 00:33:24,419
you know make sure it's set to the

808
00:33:24,419 --> 00:33:27,179
correct address if you don't

809
00:33:27,179 --> 00:33:30,899
create a txt record any any request for

810
00:33:30,899 --> 00:33:34,500
that wpad record are just going to fail

811
00:33:34,500 --> 00:33:36,120
um

812
00:33:36,120 --> 00:33:39,720
empty out your DNS admins

813
00:33:39,720 --> 00:33:42,600
we've shown I think we've shown how easy

814
00:33:42,600 --> 00:33:46,799
DNS admins can be to attack and

815
00:33:46,799 --> 00:33:50,760
the XS writes that DNS admins tends to

816
00:33:50,760 --> 00:33:53,460
carry in most environments

817
00:33:53,460 --> 00:33:54,600
um

818
00:33:54,600 --> 00:33:56,580
yeah just keep it empty let your 80

819
00:33:56,580 --> 00:33:59,220
admins do do their thing

820
00:33:59,220 --> 00:34:02,460
uh second to last here eliminate Legacy

821
00:34:02,460 --> 00:34:04,500
zones a legacy Zone when you're creating

822
00:34:04,500 --> 00:34:06,779
a DNS Zone and it's got that option that

823
00:34:06,779 --> 00:34:10,379
says you know Windows 2000 compatible

824
00:34:10,379 --> 00:34:12,359
don't choose that one get rid of those

825
00:34:12,359 --> 00:34:14,699
Windows 2000 has been end of life for

826
00:34:14,699 --> 00:34:16,739
over a decade please

827
00:34:16,739 --> 00:34:19,699
clean up your

828
00:34:20,280 --> 00:34:23,760
uh and then the last one is uh just

829
00:34:23,760 --> 00:34:25,619
taking a look at your uh Global query

830
00:34:25,619 --> 00:34:28,440
block list this is a list that lives on

831
00:34:28,440 --> 00:34:31,679
each DNS server that says these are host

832
00:34:31,679 --> 00:34:34,020
names that I am not going to resolve

833
00:34:34,020 --> 00:34:36,599
um they're by default the wpad record

834
00:34:36,599 --> 00:34:40,080
and isotap are included there were well

835
00:34:40,080 --> 00:34:41,820
known attacks for a while on those there

836
00:34:41,820 --> 00:34:43,800
are ways to bypass the global query list

837
00:34:43,800 --> 00:34:46,020
but just make sure

838
00:34:46,020 --> 00:34:50,599
those two at a minimum are included

839
00:34:51,260 --> 00:34:53,879
and then it's time to dig into

840
00:34:53,879 --> 00:34:56,460
everybody's favorite thing auditing

841
00:34:56,460 --> 00:34:58,080
uh

842
00:34:58,080 --> 00:35:00,000
number one here is not exactly auditing

843
00:35:00,000 --> 00:35:03,440
it's actually a configuration but

844
00:35:03,660 --> 00:35:06,839
DNS as it exists currently allows you to

845
00:35:06,839 --> 00:35:10,859
set up a service account to do Dynamic

846
00:35:10,859 --> 00:35:11,880
updates

847
00:35:11,880 --> 00:35:14,099
on DNS nodes so what this is instead of

848
00:35:14,099 --> 00:35:16,320
Jim's computer saying I want to create a

849
00:35:16,320 --> 00:35:18,839
DNS node called gym and now Jim's

850
00:35:18,839 --> 00:35:22,740
computer owns that gym record now

851
00:35:22,740 --> 00:35:26,400
Jim says I need a DNS node called gym

852
00:35:26,400 --> 00:35:28,680
the service account creates that record

853
00:35:28,680 --> 00:35:30,780
has ownership has full control over that

854
00:35:30,780 --> 00:35:34,920
record uh what this gives you then is

855
00:35:34,920 --> 00:35:37,320
you are able to lock down those zones

856
00:35:37,320 --> 00:35:39,119
quite a bit tighter and remove

857
00:35:39,119 --> 00:35:40,920
authenticated users from having the

858
00:35:40,920 --> 00:35:43,859
rights to create dnso nodes that makes

859
00:35:43,859 --> 00:35:45,480
that second point there auditing your

860
00:35:45,480 --> 00:35:47,760
DNS tackles a lot easier as as Jim

861
00:35:47,760 --> 00:35:49,320
showed

862
00:35:49,320 --> 00:35:51,540
there's a lot of interconnected stuff

863
00:35:51,540 --> 00:35:54,900
when you get in into DNS

864
00:35:54,900 --> 00:35:56,820
if you can minimize the amount of

865
00:35:56,820 --> 00:35:59,099
possibilities of what will work your

866
00:35:59,099 --> 00:36:00,839
auditing becomes a lot easier

867
00:36:00,839 --> 00:36:04,320
uh third there audit DNS zones

868
00:36:04,320 --> 00:36:06,300
these are available in your DNS console

869
00:36:06,300 --> 00:36:07,920
you should be able to look through them

870
00:36:07,920 --> 00:36:11,820
and say hey uh maybe hacker.io shouldn't

871
00:36:11,820 --> 00:36:14,220
be a zone that we have

872
00:36:14,220 --> 00:36:16,980
maybe maybe it is for you I don't know

873
00:36:16,980 --> 00:36:19,560
uh same thing with zonescopes do they

874
00:36:19,560 --> 00:36:21,540
make sense in your environment

875
00:36:21,540 --> 00:36:24,000
same thing with policies do they make

876
00:36:24,000 --> 00:36:25,859
sense in your environment now

877
00:36:25,859 --> 00:36:27,540
I mentioned

878
00:36:27,540 --> 00:36:29,280
that you know DNS zones you can see

879
00:36:29,280 --> 00:36:31,079
those in the DNS console

880
00:36:31,079 --> 00:36:33,420
Zone Scopes you cannot see in the DNS

881
00:36:33,420 --> 00:36:35,640
console you're gonna have to take a look

882
00:36:35,640 --> 00:36:37,320
using Powershell

883
00:36:37,320 --> 00:36:41,579
or adsi edit or ipam to see these Zone

884
00:36:41,579 --> 00:36:44,760
Scopes so be aware of that

885
00:36:44,760 --> 00:36:47,460
and then the policies

886
00:36:47,460 --> 00:36:50,099
because those are stored on each

887
00:36:50,099 --> 00:36:52,980
um DNS slash DC server

888
00:36:52,980 --> 00:36:54,720
those need to be queried individually

889
00:36:54,720 --> 00:36:56,040
they you know they're stored in the

890
00:36:56,040 --> 00:36:57,660
registry

891
00:36:57,660 --> 00:36:59,820
that makes it difficult so use

892
00:36:59,820 --> 00:37:02,339
Powershell

893
00:37:02,339 --> 00:37:05,099
um to look at those and then for

894
00:37:05,099 --> 00:37:08,099
dangling spns

895
00:37:08,099 --> 00:37:10,020
if you hate yourself you could probably

896
00:37:10,020 --> 00:37:12,060
find these all in active directory users

897
00:37:12,060 --> 00:37:15,599
and computers or adsi edit but I don't

898
00:37:15,599 --> 00:37:17,760
wish digging into every single object in

899
00:37:17,760 --> 00:37:19,619
your environment through the GUI on

900
00:37:19,619 --> 00:37:20,820
anyone

901
00:37:20,820 --> 00:37:22,099
even Jim

902
00:37:22,099 --> 00:37:24,180
so instead

903
00:37:24,180 --> 00:37:26,520
Powershell use that uh you know

904
00:37:26,520 --> 00:37:28,740
enumerate those

905
00:37:28,740 --> 00:37:31,079
and and find out those hosts that no

906
00:37:31,079 --> 00:37:32,460
longer exist

907
00:37:32,460 --> 00:37:34,380
so

908
00:37:34,380 --> 00:37:36,359
it's all well and good sounds like a lot

909
00:37:36,359 --> 00:37:39,119
of stuff but we got something blue for

910
00:37:39,119 --> 00:37:41,300
you

911
00:37:42,000 --> 00:37:44,640
it is the blue tuxedo

912
00:37:44,640 --> 00:37:48,720
so Jim often wore blue Tuxedo in uh High

913
00:37:48,720 --> 00:37:51,300
School back in high school we were

914
00:37:51,300 --> 00:37:52,619
really looking for a picture of him and

915
00:37:52,619 --> 00:37:54,540
his blue tuxedo back in the day

916
00:37:54,540 --> 00:37:55,920
uh

917
00:37:55,920 --> 00:37:58,800
blue tuxedo uh will be released later

918
00:37:58,800 --> 00:38:00,060
this year

919
00:38:00,060 --> 00:38:00,960
um

920
00:38:00,960 --> 00:38:02,640
hopefully at Wild West hackenfest in

921
00:38:02,640 --> 00:38:04,680
their Tool Shed because that perfect

922
00:38:04,680 --> 00:38:07,560
place to to uh release tools but we're

923
00:38:07,560 --> 00:38:08,460
going to go through we're going to

924
00:38:08,460 --> 00:38:10,320
search for those dangling spns that we

925
00:38:10,320 --> 00:38:12,060
talked about so again that's an SPN

926
00:38:12,060 --> 00:38:14,400
where the host name host portion no

927
00:38:14,400 --> 00:38:16,020
longer exists

928
00:38:16,020 --> 00:38:18,240
which even if you can abuse those with

929
00:38:18,240 --> 00:38:20,640
DNS you should still clean that up yeah

930
00:38:20,640 --> 00:38:23,760
that's right again clean your up

931
00:38:23,760 --> 00:38:24,540
um

932
00:38:24,540 --> 00:38:27,180
I'm gonna check DNS admins membership so

933
00:38:27,180 --> 00:38:28,920
again we're going to try and get that as

934
00:38:28,920 --> 00:38:31,140
close to zero as possible

935
00:38:31,140 --> 00:38:33,119
if it can't be gotten to zero for

936
00:38:33,119 --> 00:38:35,040
whatever reason we're gonna check and

937
00:38:35,040 --> 00:38:38,099
make sure that at least those users are

938
00:38:38,099 --> 00:38:39,900
in other groups that are protected by

939
00:38:39,900 --> 00:38:42,359
the Admin SD holder object so that would

940
00:38:42,359 --> 00:38:44,099
you know minimize the amount of abuse

941
00:38:44,099 --> 00:38:46,200
that they could take

942
00:38:46,200 --> 00:38:47,760
then we'll scan for both the wild card

943
00:38:47,760 --> 00:38:51,420
and wpad records and then you know

944
00:38:51,420 --> 00:38:54,359
depending on exactly what's found uh

945
00:38:54,359 --> 00:38:56,220
offer some different suggestions so if

946
00:38:56,220 --> 00:38:58,740
it's a txt record in most environments

947
00:38:58,740 --> 00:39:00,000
for both of those it's going to be good

948
00:39:00,000 --> 00:39:01,020
to go

949
00:39:01,020 --> 00:39:03,300
a record

950
00:39:03,300 --> 00:39:05,220
a little a little suspicious depending

951
00:39:05,220 --> 00:39:07,320
on again your exact environment

952
00:39:07,320 --> 00:39:09,660
if you find an NS record set up for wild

953
00:39:09,660 --> 00:39:10,800
card

954
00:39:10,800 --> 00:39:13,920
uh straight to jail like it is it is

955
00:39:13,920 --> 00:39:14,880
time

956
00:39:14,880 --> 00:39:17,460
to figure figure out what's going on in

957
00:39:17,460 --> 00:39:18,599
your environment and then if you have

958
00:39:18,599 --> 00:39:21,060
none of those if you if they don't exist

959
00:39:21,060 --> 00:39:23,400
the blue tuxedo will offer to create

960
00:39:23,400 --> 00:39:25,560
them for you so

961
00:39:25,560 --> 00:39:27,780
you know again proactively taking care

962
00:39:27,780 --> 00:39:30,359
of your environment uh we'll dig into

963
00:39:30,359 --> 00:39:33,359
the global uh Global query block list

964
00:39:33,359 --> 00:39:35,700
make sure that those two settings uh

965
00:39:35,700 --> 00:39:38,579
wpad and isotap are both exist or they

966
00:39:38,579 --> 00:39:40,380
both exist and then list the other ones

967
00:39:40,380 --> 00:39:41,520
too because

968
00:39:41,520 --> 00:39:44,220
as we talked about uh earlier today

969
00:39:44,220 --> 00:39:47,099
while editing these slides poorly

970
00:39:47,099 --> 00:39:48,119
um

971
00:39:48,119 --> 00:39:51,300
we've realized that DNS admins may be

972
00:39:51,300 --> 00:39:52,760
able to create a different sinkhole

973
00:39:52,760 --> 00:39:56,339
using the global query block list so DNS

974
00:39:56,339 --> 00:39:57,720
admins can

975
00:39:57,720 --> 00:40:00,839
enable disable and modify the the global

976
00:40:00,839 --> 00:40:04,079
query block list so and that's a per DNS

977
00:40:04,079 --> 00:40:07,160
server setting it is not synced

978
00:40:07,160 --> 00:40:09,119
directory correct

979
00:40:09,119 --> 00:40:10,680
uh and then we will check to make sure

980
00:40:10,680 --> 00:40:12,480
that you've got a DHCP Dynamic update

981
00:40:12,480 --> 00:40:14,220
service account set if that doesn't

982
00:40:14,220 --> 00:40:15,300
exist

983
00:40:15,300 --> 00:40:17,040
we'll let you know if it does exist

984
00:40:17,040 --> 00:40:18,839
we'll let you know if the password is

985
00:40:18,839 --> 00:40:20,700
old because uh in the environments that

986
00:40:20,700 --> 00:40:23,540
we assess

987
00:40:23,780 --> 00:40:26,520
90 of the service accounts never have

988
00:40:26,520 --> 00:40:28,380
password changes or you know they're

989
00:40:28,380 --> 00:40:30,660
over three years old and yeah just

990
00:40:30,660 --> 00:40:32,040
terrible

991
00:40:32,040 --> 00:40:34,920
uh the thing related to that the the

992
00:40:34,920 --> 00:40:37,079
dackles we are going to look and make

993
00:40:37,079 --> 00:40:39,599
sure that the decals on your various DNS

994
00:40:39,599 --> 00:40:42,480
items make sense authenticated users

995
00:40:42,480 --> 00:40:44,160
should not have you know right

996
00:40:44,160 --> 00:40:46,920
permissions to your DNS head object for

997
00:40:46,920 --> 00:40:49,260
example additionally we've

998
00:40:49,260 --> 00:40:51,780
we're still working this out but it

999
00:40:51,780 --> 00:40:53,099
seems like some of these DNS attack

1000
00:40:53,099 --> 00:40:55,260
tools like power mad

1001
00:40:55,260 --> 00:40:57,359
kind of have a signature to when they

1002
00:40:57,359 --> 00:40:59,940
when they modify dackles so take a look

1003
00:40:59,940 --> 00:41:02,160
at that if we see that we can indicate

1004
00:41:02,160 --> 00:41:04,320
hey this looks this looks like power mad

1005
00:41:04,320 --> 00:41:05,820
created this

1006
00:41:05,820 --> 00:41:08,700
uh and then one thing that we meant or

1007
00:41:08,700 --> 00:41:10,200
had on the slide didn't really mention

1008
00:41:10,200 --> 00:41:12,780
was Tombstone DNS records when a DNS

1009
00:41:12,780 --> 00:41:14,820
record becomes Tombstone it becomes

1010
00:41:14,820 --> 00:41:17,280
worldwideable

1011
00:41:17,280 --> 00:41:18,960
also bad

1012
00:41:18,960 --> 00:41:21,000
uh conditional forwarder auditing we're

1013
00:41:21,000 --> 00:41:22,680
going to list those for you make sure

1014
00:41:22,680 --> 00:41:24,060
that the conditional forwarders make

1015
00:41:24,060 --> 00:41:26,339
sense in your environment yet again

1016
00:41:26,339 --> 00:41:28,920
uh you know is google.com going to a

1017
00:41:28,920 --> 00:41:31,800
Russian IP uh

1018
00:41:31,800 --> 00:41:33,660
you might want to delete that one I

1019
00:41:33,660 --> 00:41:35,700
don't know maybe

1020
00:41:35,700 --> 00:41:39,060
um auditing same thing do you know what

1021
00:41:39,060 --> 00:41:39,900
they are

1022
00:41:39,900 --> 00:41:42,000
if you don't you probably don't need to

1023
00:41:42,000 --> 00:41:44,280
have these set up in your environment

1024
00:41:44,280 --> 00:41:45,900
and then two things that we did not

1025
00:41:45,900 --> 00:41:48,900
touch on at all in this this talk but

1026
00:41:48,900 --> 00:41:51,480
are important are your forwarders

1027
00:41:51,480 --> 00:41:55,500
uh you when you deploy DNS server out of

1028
00:41:55,500 --> 00:41:58,880
the box no forwarders are are configured

1029
00:41:58,880 --> 00:42:01,320
and instead all of your queries are

1030
00:42:01,320 --> 00:42:03,900
going to the DNS root servers

1031
00:42:03,900 --> 00:42:06,359
it's slow it's inefficient it's possibly

1032
00:42:06,359 --> 00:42:08,820
insecure and it's an iterative process I

1033
00:42:08,820 --> 00:42:10,500
mean it starts at the DNS root and then

1034
00:42:10,500 --> 00:42:12,900
Works its way down whereas uh normal

1035
00:42:12,900 --> 00:42:15,900
forwarding process is recursive it works

1036
00:42:15,900 --> 00:42:17,400
its way up

1037
00:42:17,400 --> 00:42:19,020
Etc did you have something you wanted to

1038
00:42:19,020 --> 00:42:20,280
say there Jim oh I was just going to

1039
00:42:20,280 --> 00:42:22,560
mention and remind everybody that the

1040
00:42:22,560 --> 00:42:25,859
the DNS root hints object exists in a

1041
00:42:25,859 --> 00:42:30,000
pretty uh insecure area where uh all the

1042
00:42:30,000 --> 00:42:31,560
permissions are inherited down from the

1043
00:42:31,560 --> 00:42:34,020
domain rut right

1044
00:42:34,020 --> 00:42:35,520
and then the last thing on the list here

1045
00:42:35,520 --> 00:42:38,640
is um kind of the the part security part

1046
00:42:38,640 --> 00:42:39,839
hygiene

1047
00:42:39,839 --> 00:42:40,980
um

1048
00:42:40,980 --> 00:42:43,260
when your DNS servers are making

1049
00:42:43,260 --> 00:42:45,119
requests out to forwarders they

1050
00:42:45,119 --> 00:42:46,920
randomize their Source ports

1051
00:42:46,920 --> 00:42:49,800
by default it's 2500 ports that's good

1052
00:42:49,800 --> 00:42:52,200
you can go up to a maximum of 10 000.

1053
00:42:52,200 --> 00:42:54,000
we're just going to tell you to do that

1054
00:42:54,000 --> 00:42:57,119
and uh you know we have not seen any uh

1055
00:42:57,119 --> 00:42:59,520
impact on performance so

1056
00:42:59,520 --> 00:43:01,560
why not do the maximum

1057
00:43:01,560 --> 00:43:03,660
so hopefully

1058
00:43:03,660 --> 00:43:06,240
with you know a blue Tuxedo in any

1059
00:43:06,240 --> 00:43:08,640
wedding is going to make sure

1060
00:43:08,640 --> 00:43:10,680
that that wedding lives happily ever

1061
00:43:10,680 --> 00:43:12,119
after

1062
00:43:12,119 --> 00:43:14,220
so

1063
00:43:14,220 --> 00:43:17,819
thank you all for coming out like

1064
00:43:17,819 --> 00:43:19,920
you didn't have to come out we love that

1065
00:43:19,920 --> 00:43:20,940
you're here

1066
00:43:20,940 --> 00:43:23,099
I want to thank Kevin Robertson and Shea

1067
00:43:23,099 --> 00:43:25,800
bear Charlie Clark dirkian malema elad

1068
00:43:25,800 --> 00:43:28,079
Shamir B-side charm for having us try

1069
00:43:28,079 --> 00:43:30,599
Mark for paying for us to be here Jim

1070
00:43:30,599 --> 00:43:33,270
for his first presentation

1071
00:43:33,270 --> 00:43:35,819
[Applause]

1072
00:43:35,819 --> 00:43:37,110
thanks thanks Jake

1073
00:43:37,110 --> 00:43:40,020
[Applause]

1074
00:43:40,020 --> 00:43:41,880
so if you have any questions I saw that

1075
00:43:41,880 --> 00:43:43,380
we've got like less than five minutes

1076
00:43:43,380 --> 00:43:44,460
left

1077
00:43:44,460 --> 00:43:47,280
um we can we can do some questions

1078
00:43:47,280 --> 00:43:50,540
anybody yeah what you got

1079
00:43:55,859 --> 00:43:58,520
oh boy

1080
00:43:59,819 --> 00:44:02,280
we were mostly looking at active

1081
00:44:02,280 --> 00:44:04,260
directory integrated DNS not Azure

1082
00:44:04,260 --> 00:44:06,180
active directory integrated DNS for this

1083
00:44:06,180 --> 00:44:07,460
specific talk

1084
00:44:07,460 --> 00:44:09,780
but it's a whole another ball game yeah

1085
00:44:09,780 --> 00:44:11,460
there's there's there's a lot of stuff

1086
00:44:11,460 --> 00:44:13,380
there too and and I haven't even dug

1087
00:44:13,380 --> 00:44:15,119
into it yeah we have not even touched

1088
00:44:15,119 --> 00:44:17,420
that yet

1089
00:44:23,460 --> 00:44:26,579
oh from that aspect absolutely

1090
00:44:26,579 --> 00:44:29,460
um we see a lot of stuff from you know

1091
00:44:29,460 --> 00:44:31,920
yeah so we know we look at Azure ad we

1092
00:44:31,920 --> 00:44:34,680
haven't looked at Azure DNS

1093
00:44:34,680 --> 00:44:37,020
um be very clear about that thanks Danny

1094
00:44:37,020 --> 00:44:39,240
um so yeah see a lot of stuff with

1095
00:44:39,240 --> 00:44:41,460
active directory on-prem and Azure ad

1096
00:44:41,460 --> 00:44:45,180
where people are like uh syncing

1097
00:44:45,180 --> 00:44:47,880
privileged roles from on-prem ad up into

1098
00:44:47,880 --> 00:44:50,520
Azure ID and and having those as be like

1099
00:44:50,520 --> 00:44:51,780
Global administrators and stuff like

1100
00:44:51,780 --> 00:44:53,940
that so that opens up opportunities

1101
00:44:53,940 --> 00:44:55,200
where somebody can get control of

1102
00:44:55,200 --> 00:44:57,480
on-prem AD they can most likely

1103
00:44:57,480 --> 00:44:59,220
compromise your your Azure active

1104
00:44:59,220 --> 00:45:00,720
directory tenant as well yeah there's

1105
00:45:00,720 --> 00:45:03,060
there's a lot of attack pass with that

1106
00:45:03,060 --> 00:45:06,000
um and I think Christina just yeah

1107
00:45:06,000 --> 00:45:08,339
Christina on some of the low hanging

1108
00:45:08,339 --> 00:45:10,380
fruit for that Christina morillo will be

1109
00:45:10,380 --> 00:45:12,060
releasing is it later this week Danny

1110
00:45:12,060 --> 00:45:15,780
yeah later this week uh

1111
00:45:15,780 --> 00:45:16,980
what's that

1112
00:45:16,980 --> 00:45:19,140
next weekend

1113
00:45:19,140 --> 00:45:22,140
uh hub.tryymarksecurity.com man have

1114
00:45:22,140 --> 00:45:23,819
another marketing guy in your front

1115
00:45:23,819 --> 00:45:27,980
front row that's terrible

1116
00:45:28,260 --> 00:45:30,300
so I guess uh

1117
00:45:30,300 --> 00:45:33,359
do we have um we have the reference

1118
00:45:33,359 --> 00:45:34,740
slides at the end of this assuming that

1119
00:45:34,740 --> 00:45:36,660
we didn't delete all those but I just

1120
00:45:36,660 --> 00:45:39,839
wanted to there's my God I promise you

1121
00:45:39,839 --> 00:45:42,180
there exists we'll fix that and we'll

1122
00:45:42,180 --> 00:45:43,619
put some slides that actually have all

1123
00:45:43,619 --> 00:45:45,599
the stuff we were talking about uh on

1124
00:45:45,599 --> 00:45:47,040
the internet later but I just want to

1125
00:45:47,040 --> 00:45:48,780
remind everybody you know that that

1126
00:45:48,780 --> 00:45:51,660
there's one thing uh that's really true

1127
00:45:51,660 --> 00:45:53,579
in active directory

1128
00:45:53,579 --> 00:45:55,200
um I just want to say you know I'm Jim

1129
00:45:55,200 --> 00:45:58,440
this is Jake but it's not DNS there's no

1130
00:45:58,440 --> 00:46:02,160
way it's DNS it was DNS

1131
00:46:02,160 --> 00:46:04,819
thank you

1132
00:46:06,000 --> 00:46:08,119
thank you

