1
00:00:24,560 --> 00:00:28,080
hello everyone i am jake hildreth i am

2
00:00:28,080 --> 00:00:29,840
here to talk to you about active

3
00:00:29,840 --> 00:00:32,479
directory certificate services and why

4
00:00:32,479 --> 00:00:34,960
it is probably vulnerable in your

5
00:00:34,960 --> 00:00:36,559
network

6
00:00:36,559 --> 00:00:40,000
uh i am

7
00:00:41,840 --> 00:00:43,760
i am a recovering systemism

8
00:00:43,760 --> 00:00:46,000
administrator what does that mean uh two

9
00:00:46,000 --> 00:00:47,120
months after i started working for

10
00:00:47,120 --> 00:00:49,440
trimark i thought to myself maybe i

11
00:00:49,440 --> 00:00:51,120
should stand up an exchange server at my

12
00:00:51,120 --> 00:00:54,160
house so that's the kind of guy i am

13
00:00:54,160 --> 00:00:56,840
been in the business for about 20 years

14
00:00:56,840 --> 00:01:00,719
i i started out tier one support

15
00:01:00,719 --> 00:01:03,280
uh for a cable modem provider so

16
00:01:03,280 --> 00:01:05,840
this is a windows me area

17
00:01:05,840 --> 00:01:08,880
or era so if you need to do an ipconfig

18
00:01:08,880 --> 00:01:13,200
refresh and ipconfig renew i'm your dude

19
00:01:13,200 --> 00:01:16,240
um then i moved on to a security focused

20
00:01:16,240 --> 00:01:17,600
consultancy

21
00:01:17,600 --> 00:01:21,040
um but back in 2003 2004 that meant like

22
00:01:21,040 --> 00:01:22,560
do you have a firewall do you have

23
00:01:22,560 --> 00:01:25,439
antivirus you're probably good

24
00:01:25,439 --> 00:01:26,560
um

25
00:01:26,560 --> 00:01:29,360
and then since then i've moved on to i

26
00:01:29,360 --> 00:01:31,439
moved on to being a

27
00:01:31,439 --> 00:01:33,600
network administrator

28
00:01:33,600 --> 00:01:36,320
for a small municipality

29
00:01:36,320 --> 00:01:38,240
and that meant i was responsible for

30
00:01:38,240 --> 00:01:40,799
anything with a wire a chip

31
00:01:40,799 --> 00:01:43,040
a screen

32
00:01:43,040 --> 00:01:45,600
gobbledy gobbledygook on that screen i

33
00:01:45,600 --> 00:01:47,200
had to know it and that is really where

34
00:01:47,200 --> 00:01:48,479
i cut my teeth

35
00:01:48,479 --> 00:01:51,520
in active directory

36
00:01:51,759 --> 00:01:55,360
when i joined on no one was really

37
00:01:55,360 --> 00:01:58,560
administering the active directory and

38
00:01:58,560 --> 00:02:02,000
i then kind of took it upon myself to

39
00:02:02,000 --> 00:02:03,600
figure it out

40
00:02:03,600 --> 00:02:06,479
about a year ago then i

41
00:02:06,479 --> 00:02:09,598
saw a tweet from one sean metcalf

42
00:02:09,598 --> 00:02:11,440
about you know if you're in ops and you

43
00:02:11,440 --> 00:02:14,400
want to move into security get at me

44
00:02:14,400 --> 00:02:15,520
and i did

45
00:02:15,520 --> 00:02:17,680
and a couple months later i was hired by

46
00:02:17,680 --> 00:02:19,599
trimark so now

47
00:02:19,599 --> 00:02:21,840
i am an active directory security

48
00:02:21,840 --> 00:02:23,520
subject matter

49
00:02:23,520 --> 00:02:24,879
expert

50
00:02:24,879 --> 00:02:29,360
and i do perform 80 assessments on

51
00:02:29,360 --> 00:02:31,360
all sizes of companies the smallest one

52
00:02:31,360 --> 00:02:33,440
i've personally done

53
00:02:33,440 --> 00:02:35,599
it's been about a thousand users

54
00:02:35,599 --> 00:02:37,599
largest one i've done is currently a

55
00:02:37,599 --> 00:02:39,599
hundred thousand users so

56
00:02:39,599 --> 00:02:42,160
um seen a lot

57
00:02:42,160 --> 00:02:43,760
and

58
00:02:43,760 --> 00:02:44,560
yeah

59
00:02:44,560 --> 00:02:46,480
most importantly though

60
00:02:46,480 --> 00:02:49,280
i am a husband and a father and that's

61
00:02:49,280 --> 00:02:51,280
pretty much what really defines me as a

62
00:02:51,280 --> 00:02:53,599
person

63
00:02:54,080 --> 00:02:57,040
so what are we going to talk about today

64
00:02:57,040 --> 00:02:59,280
first off we're going to do a very high

65
00:02:59,280 --> 00:03:00,560
level

66
00:03:00,560 --> 00:03:02,720
overview of pki i mean

67
00:03:02,720 --> 00:03:04,959
super high level because we don't have a

68
00:03:04,959 --> 00:03:07,040
week to talk about it and

69
00:03:07,040 --> 00:03:08,319
no one

70
00:03:08,319 --> 00:03:10,400
i i don't know that anyone that really

71
00:03:10,400 --> 00:03:12,239
cares that much about it

72
00:03:12,239 --> 00:03:14,159
but then we're going to delve into what

73
00:03:14,159 --> 00:03:15,280
makes

74
00:03:15,280 --> 00:03:17,440
microsoft's implementation of

75
00:03:17,440 --> 00:03:19,360
public key infrastructure also known as

76
00:03:19,360 --> 00:03:21,920
active directory certificate services

77
00:03:21,920 --> 00:03:23,920
what makes that

78
00:03:23,920 --> 00:03:27,200
special we'll just say

79
00:03:27,360 --> 00:03:29,440
then we're going to delve into three of

80
00:03:29,440 --> 00:03:30,720
the

81
00:03:30,720 --> 00:03:32,480
most common misconfigurations that i've

82
00:03:32,480 --> 00:03:35,200
seen um we started assessing

83
00:03:35,200 --> 00:03:36,480
adcs

84
00:03:36,480 --> 00:03:39,360
about six months ago in that time i've

85
00:03:39,360 --> 00:03:41,360
seen ten ten different environments

86
00:03:41,360 --> 00:03:42,799
approximately

87
00:03:42,799 --> 00:03:44,720
um

88
00:03:44,720 --> 00:03:47,360
and yeah see what i've what we've come

89
00:03:47,360 --> 00:03:48,239
across

90
00:03:48,239 --> 00:03:50,480
and then three of the most dangerous

91
00:03:50,480 --> 00:03:52,720
misconfigurations that i've also

92
00:03:52,720 --> 00:03:55,200
encountered

93
00:03:55,519 --> 00:03:57,439
and then we are going to talk about

94
00:03:57,439 --> 00:03:59,680
exactly how to

95
00:03:59,680 --> 00:04:01,760
remediate those issues bring them into

96
00:04:01,760 --> 00:04:03,439
compliance so you don't need to worry

97
00:04:03,439 --> 00:04:07,280
anymore about your adcs

98
00:04:07,680 --> 00:04:09,920
then we'll just review it all

99
00:04:09,920 --> 00:04:10,959
and

100
00:04:10,959 --> 00:04:14,640
i'll be announcing a tool at that point

101
00:04:14,640 --> 00:04:16,399
uh and before we go any further i just

102
00:04:16,399 --> 00:04:17,839
want to talk about

103
00:04:17,839 --> 00:04:21,040
uh prior research that's been performed

104
00:04:21,040 --> 00:04:22,079
last year

105
00:04:22,079 --> 00:04:24,960
the spectre ops guys will and lee

106
00:04:24,960 --> 00:04:26,479
did

107
00:04:26,479 --> 00:04:28,960
basically released a i think it's 140

108
00:04:28,960 --> 00:04:30,479
page document

109
00:04:30,479 --> 00:04:32,240
talking about

110
00:04:32,240 --> 00:04:35,360
adcs all the holes involved

111
00:04:35,360 --> 00:04:36,240
um

112
00:04:36,240 --> 00:04:38,000
and a little bit on how to prevent or

113
00:04:38,000 --> 00:04:39,680
defend against things but really not so

114
00:04:39,680 --> 00:04:41,520
much so that's kind of what our focus is

115
00:04:41,520 --> 00:04:44,639
going to be here today is going to be on

116
00:04:44,639 --> 00:04:46,240
how can you fix

117
00:04:46,240 --> 00:04:47,360
the holes

118
00:04:47,360 --> 00:04:49,520
quickly and easily that

119
00:04:49,520 --> 00:04:53,199
exists in your adcs environment

120
00:04:53,199 --> 00:04:54,560
we will primarily be talking about

121
00:04:54,560 --> 00:04:56,400
domain escalation

122
00:04:56,400 --> 00:04:57,360
but

123
00:04:57,360 --> 00:04:58,720
we will also touch a little bit on

124
00:04:58,720 --> 00:05:01,360
persistence

125
00:05:05,120 --> 00:05:08,320
so what is a pki

126
00:05:08,320 --> 00:05:09,680
uh

127
00:05:09,680 --> 00:05:12,000
it's generally used to confirm the

128
00:05:12,000 --> 00:05:14,160
authenticity identity of

129
00:05:14,160 --> 00:05:16,560
the entity that you are speaking to

130
00:05:16,560 --> 00:05:17,680
um

131
00:05:17,680 --> 00:05:20,080
contrary to popular belief

132
00:05:20,080 --> 00:05:22,800
it's not required for encryption though

133
00:05:22,800 --> 00:05:25,199
it can be used as part of an encryption

134
00:05:25,199 --> 00:05:26,720
process

135
00:05:26,720 --> 00:05:30,320
the way that i like to explain this is

136
00:05:30,320 --> 00:05:32,400
when you visit a website with an expired

137
00:05:32,400 --> 00:05:33,759
certificate

138
00:05:33,759 --> 00:05:34,880
and they say do you trust the

139
00:05:34,880 --> 00:05:36,639
certificate

140
00:05:36,639 --> 00:05:38,880
yes i do your connection is still

141
00:05:38,880 --> 00:05:40,880
encrypted

142
00:05:40,880 --> 00:05:42,400
but you don't really know who you're

143
00:05:42,400 --> 00:05:44,160
talking about on talking to on the other

144
00:05:44,160 --> 00:05:47,039
side so

145
00:05:48,320 --> 00:05:50,960
a pki generally involves a mix of

146
00:05:50,960 --> 00:05:53,840
hardware software policies procedures

147
00:05:53,840 --> 00:05:55,520
templates which we'll touch on a little

148
00:05:55,520 --> 00:05:56,960
bit later

149
00:05:56,960 --> 00:06:00,960
and each of those has its own sets of

150
00:06:00,960 --> 00:06:03,280
configuration issues

151
00:06:03,280 --> 00:06:06,560
that interact in really weird ways

152
00:06:06,560 --> 00:06:07,600
sometimes

153
00:06:07,600 --> 00:06:09,759
just like anything in security

154
00:06:09,759 --> 00:06:11,680
it's the interactions really that uh

155
00:06:11,680 --> 00:06:14,800
that cause the issues here

156
00:06:14,880 --> 00:06:16,160
and uh

157
00:06:16,160 --> 00:06:19,600
a bare minimum pki is going to require

158
00:06:19,600 --> 00:06:20,960
only three things

159
00:06:20,960 --> 00:06:22,479
a certificate authority that's trusted

160
00:06:22,479 --> 00:06:24,240
by everybody

161
00:06:24,240 --> 00:06:25,199
and then

162
00:06:25,199 --> 00:06:26,639
two parties that want to talk to each

163
00:06:26,639 --> 00:06:30,639
other but do not trust each other

164
00:06:30,639 --> 00:06:32,880
so

165
00:06:33,280 --> 00:06:36,400
this is this is what it looks like here

166
00:06:36,400 --> 00:06:38,960
benny wants to talk to melon

167
00:06:38,960 --> 00:06:42,000
melon wants to talk to benny

168
00:06:42,000 --> 00:06:44,639
mellon asked benny who are you and benny

169
00:06:44,639 --> 00:06:45,680
says

170
00:06:45,680 --> 00:06:47,600
i'm benny here's my certificate that

171
00:06:47,600 --> 00:06:49,680
proves who i am it's signed by the ca

172
00:06:49,680 --> 00:06:51,039
that you trust

173
00:06:51,039 --> 00:06:54,080
and melon says okay i can trust you

174
00:06:54,080 --> 00:06:55,120
but

175
00:06:55,120 --> 00:06:56,560
who are benny and melon because don't we

176
00:06:56,560 --> 00:06:58,240
normally talk about alice and bob in

177
00:06:58,240 --> 00:07:00,479
these

178
00:07:01,199 --> 00:07:03,280
this is benny

179
00:07:03,280 --> 00:07:04,720
he is

180
00:07:04,720 --> 00:07:06,720
if i had to describe a cat as a red team

181
00:07:06,720 --> 00:07:09,440
cat this is the red team cat i mean

182
00:07:09,440 --> 00:07:10,720
this dude is always getting into places

183
00:07:10,720 --> 00:07:12,160
he's not supposed to be

184
00:07:12,160 --> 00:07:16,639
testing my authority etc etc

185
00:07:16,639 --> 00:07:19,039
this is melon and melon is

186
00:07:19,039 --> 00:07:20,479
um

187
00:07:20,479 --> 00:07:24,080
he's a user we'll just say that

188
00:07:25,599 --> 00:07:30,000
so what makes adcs so unique

189
00:07:30,000 --> 00:07:30,960
free

190
00:07:30,960 --> 00:07:33,759
super easy to set up i mean next next

191
00:07:33,759 --> 00:07:36,080
next next finish we're secure we're

192
00:07:36,080 --> 00:07:38,000
moving on we never need to do anything

193
00:07:38,000 --> 00:07:40,240
why are we even here jake what's going

194
00:07:40,240 --> 00:07:42,240
on

195
00:07:42,240 --> 00:07:45,120
well

196
00:07:45,120 --> 00:07:47,759
there is no security guidance during the

197
00:07:47,759 --> 00:07:50,160
deployment of adcs they don't explain

198
00:07:50,160 --> 00:07:52,800
what you're doing at all

199
00:07:52,800 --> 00:07:55,199
and uh once you actually get it deployed

200
00:07:55,199 --> 00:07:56,879
it's not really any better

201
00:07:56,879 --> 00:07:59,039
there's the user interface is pretty

202
00:07:59,039 --> 00:08:00,720
terrible

203
00:08:00,720 --> 00:08:02,800
a lot of the configuration options are

204
00:08:02,800 --> 00:08:04,720
hidden

205
00:08:04,720 --> 00:08:06,880
and you know not shown in the ui

206
00:08:06,880 --> 00:08:08,479
[Music]

207
00:08:08,479 --> 00:08:11,759
if you make changes that are

208
00:08:11,759 --> 00:08:14,319
insecure

209
00:08:14,400 --> 00:08:15,919
you may

210
00:08:15,919 --> 00:08:18,000
you may see a warning about it you may

211
00:08:18,000 --> 00:08:19,280
not

212
00:08:19,280 --> 00:08:20,479
um

213
00:08:20,479 --> 00:08:22,720
and most importantly microsoft provides

214
00:08:22,720 --> 00:08:24,800
you like a bunch of templates and those

215
00:08:24,800 --> 00:08:26,479
are secure by default like

216
00:08:26,479 --> 00:08:28,400
if you use the template as designed

217
00:08:28,400 --> 00:08:30,240
especially if you upgrade the uh

218
00:08:30,240 --> 00:08:32,399
compatibility levels to like the latest

219
00:08:32,399 --> 00:08:34,880
possible they're secure i'm i'm happy

220
00:08:34,880 --> 00:08:36,080
with them

221
00:08:36,080 --> 00:08:38,240
but you can make an insecure

222
00:08:38,240 --> 00:08:40,880
modification with no real

223
00:08:40,880 --> 00:08:43,679
no real effort

224
00:08:43,839 --> 00:08:46,000
so speaking of what is a template a

225
00:08:46,000 --> 00:08:47,440
template is just like a group of

226
00:08:47,440 --> 00:08:50,000
configurations that defines like who can

227
00:08:50,000 --> 00:08:51,360
assign

228
00:08:51,360 --> 00:08:52,720
uh who can

229
00:08:52,720 --> 00:08:54,800
request a certificate

230
00:08:54,800 --> 00:08:56,080
who can

231
00:08:56,080 --> 00:08:57,519
who needs to approve that certificate

232
00:08:57,519 --> 00:09:00,080
what the certificate can be used for so

233
00:09:00,080 --> 00:09:01,680
those are used to

234
00:09:01,680 --> 00:09:04,160
make your administration of certificate

235
00:09:04,160 --> 00:09:07,199
services much more

236
00:09:07,279 --> 00:09:09,680
efficient and repeatable

237
00:09:09,680 --> 00:09:11,839
the things we like to see

238
00:09:11,839 --> 00:09:15,040
um unfortunately

239
00:09:15,040 --> 00:09:17,839
adcs says it right in the name relies on

240
00:09:17,839 --> 00:09:20,480
active directory and we all know that uh

241
00:09:20,480 --> 00:09:21,839
active

242
00:09:21,839 --> 00:09:24,959
pretty easy to scare right right

243
00:09:24,959 --> 00:09:27,440
um and no one ever

244
00:09:27,440 --> 00:09:29,360
misconfigures it or maliciously modifies

245
00:09:29,360 --> 00:09:32,320
it nope never

246
00:09:32,320 --> 00:09:33,680
and

247
00:09:33,680 --> 00:09:36,720
all of the configuration for adcs lives

248
00:09:36,720 --> 00:09:39,200
in ad

249
00:09:40,000 --> 00:09:41,839
yeah

250
00:09:41,839 --> 00:09:43,760
most importantly though

251
00:09:43,760 --> 00:09:45,920
certificates

252
00:09:45,920 --> 00:09:49,600
are not revoked when a user

253
00:09:49,600 --> 00:09:51,200
when their account is

254
00:09:51,200 --> 00:09:53,440
is when their password is changed

255
00:09:53,440 --> 00:09:56,080
you go in a user is compromised you

256
00:09:56,080 --> 00:09:57,920
change their password

257
00:09:57,920 --> 00:10:00,320
you think everything's happy

258
00:10:00,320 --> 00:10:01,760
if an attacker still has their

259
00:10:01,760 --> 00:10:02,880
certificate

260
00:10:02,880 --> 00:10:05,440
for that that user that was compromised

261
00:10:05,440 --> 00:10:08,160
they can continue to log in as that user

262
00:10:08,160 --> 00:10:11,760
until that certificate expires

263
00:10:12,720 --> 00:10:14,320
worst

264
00:10:14,320 --> 00:10:15,920
it's everywhere

265
00:10:15,920 --> 00:10:17,120
i mean

266
00:10:17,120 --> 00:10:19,279
every environment that i have assessed

267
00:10:19,279 --> 00:10:22,079
since working with trimark has had some

268
00:10:22,079 --> 00:10:24,959
bit of adcs that lives in their

269
00:10:24,959 --> 00:10:27,359
environment

270
00:10:28,000 --> 00:10:30,399
and that's you know just a

271
00:10:30,399 --> 00:10:32,800
side effect of being free and easy to

272
00:10:32,800 --> 00:10:36,880
set up so i totally understand why but

273
00:10:36,880 --> 00:10:38,240
uh this is

274
00:10:38,240 --> 00:10:40,560
kind of what you expect

275
00:10:40,560 --> 00:10:42,000
this graphic explains what you're trying

276
00:10:42,000 --> 00:10:42,640
to

277
00:10:42,640 --> 00:10:46,399
what you would expect to see from adcs

278
00:10:46,399 --> 00:10:48,640
a completely separate

279
00:10:48,640 --> 00:10:50,880
uh environment you know certificate

280
00:10:50,880 --> 00:10:52,480
services live one place

281
00:10:52,480 --> 00:10:55,839
active directory lives another

282
00:10:56,320 --> 00:10:59,680
but in reality it looks much more

283
00:10:59,680 --> 00:11:02,160
like this

284
00:11:02,240 --> 00:11:05,519
and that's really the problem here

285
00:11:05,519 --> 00:11:07,680
once you are

286
00:11:07,680 --> 00:11:10,160
able to use a certificate to get into an

287
00:11:10,160 --> 00:11:12,640
active directory environment

288
00:11:12,640 --> 00:11:14,880
you then have earned the rights of that

289
00:11:14,880 --> 00:11:16,000
user

290
00:11:16,000 --> 00:11:18,320
and can continue to

291
00:11:18,320 --> 00:11:19,519
uh

292
00:11:19,519 --> 00:11:20,880
you know

293
00:11:20,880 --> 00:11:22,880
you've got a foothold you can do your

294
00:11:22,880 --> 00:11:24,640
your lateral movement if possible you

295
00:11:24,640 --> 00:11:28,640
could do your escalations where possible

296
00:11:28,640 --> 00:11:30,640
um for example let's go back to benny

297
00:11:30,640 --> 00:11:31,760
and melon here

298
00:11:31,760 --> 00:11:34,480
um melon or sorry benny compromises

299
00:11:34,480 --> 00:11:36,160
melon's account

300
00:11:36,160 --> 00:11:38,800
um by fishing or it's probably tuna

301
00:11:38,800 --> 00:11:40,240
fishing actually

302
00:11:40,240 --> 00:11:45,120
and uh then steals that password

303
00:11:45,120 --> 00:11:47,680
mellon's isd it staff recognizes that

304
00:11:47,680 --> 00:11:48,880
the

305
00:11:48,880 --> 00:11:50,399
that the account has been compromised

306
00:11:50,399 --> 00:11:52,880
and resets the password

307
00:11:52,880 --> 00:11:56,320
like i said benny can continue to log in

308
00:11:56,320 --> 00:11:57,680
as melon

309
00:11:57,680 --> 00:12:00,720
until that certificate expires

310
00:12:00,720 --> 00:12:02,720
this is particularly bad

311
00:12:02,720 --> 00:12:05,040
when

312
00:12:05,440 --> 00:12:08,240
the user that gets compromised

313
00:12:08,240 --> 00:12:10,240
with something like a former domain

314
00:12:10,240 --> 00:12:12,320
administrator or a former

315
00:12:12,320 --> 00:12:15,600
uh pki administrator

316
00:12:15,600 --> 00:12:17,920
and i'll dig into that a little bit uh

317
00:12:17,920 --> 00:12:20,959
in one of my most common configurations

318
00:12:20,959 --> 00:12:22,079
so

319
00:12:22,079 --> 00:12:24,800
just before we move on though pki is

320
00:12:24,800 --> 00:12:28,880
hard to secure 80i ad is hard just hard

321
00:12:28,880 --> 00:12:30,880
and then combining them

322
00:12:30,880 --> 00:12:33,120
it's just

323
00:12:33,120 --> 00:12:34,720
we're still discovering new ways to

324
00:12:34,720 --> 00:12:36,480
attack this

325
00:12:36,480 --> 00:12:39,480
so

326
00:12:39,519 --> 00:12:41,360
let's dig into the most common things

327
00:12:41,360 --> 00:12:42,480
that i've seen

328
00:12:42,480 --> 00:12:45,040
in the wild

329
00:12:45,519 --> 00:12:46,639
number one

330
00:12:46,639 --> 00:12:49,279
insufficient auditing

331
00:12:49,279 --> 00:12:51,040
i don't know

332
00:12:51,040 --> 00:12:54,000
why microsoft chooses this

333
00:12:54,000 --> 00:12:57,279
but adcs auditing is not enabled by

334
00:12:57,279 --> 00:12:59,760
default

335
00:12:59,760 --> 00:13:01,920
i

336
00:13:02,160 --> 00:13:03,760
so many different packages they do this

337
00:13:03,760 --> 00:13:06,959
with and i just don't understand it

338
00:13:06,959 --> 00:13:08,959
um

339
00:13:08,959 --> 00:13:10,240
and

340
00:13:10,240 --> 00:13:11,839
if you have multiple cas in your

341
00:13:11,839 --> 00:13:14,399
environment this setting must be enabled

342
00:13:14,399 --> 00:13:17,120
individually on each ca

343
00:13:17,120 --> 00:13:18,240
so

344
00:13:18,240 --> 00:13:20,959
what that means in reality is you've got

345
00:13:20,959 --> 00:13:23,600
seven cas and six of them have

346
00:13:23,600 --> 00:13:26,079
auditing enabled that seventh one is the

347
00:13:26,079 --> 00:13:28,000
one that attackers are going to hit

348
00:13:28,000 --> 00:13:29,760
and they will be able to see that quite

349
00:13:29,760 --> 00:13:31,839
easily that auditing is not available

350
00:13:31,839 --> 00:13:34,480
but thankfully we can easily enable it

351
00:13:34,480 --> 00:13:35,680
via

352
00:13:35,680 --> 00:13:37,200
command line

353
00:13:37,200 --> 00:13:38,480
and

354
00:13:38,480 --> 00:13:40,959
script it

355
00:13:42,000 --> 00:13:43,839
another unfortunate thing is depending

356
00:13:43,839 --> 00:13:45,839
on your usage of adcs in your

357
00:13:45,839 --> 00:13:47,600
environment

358
00:13:47,600 --> 00:13:50,160
uh it can be really noisy i mean

359
00:13:50,160 --> 00:13:51,600
there are tons and tons and tons of

360
00:13:51,600 --> 00:13:55,040
events created and

361
00:13:55,199 --> 00:13:57,040
if you're only using it to say like

362
00:13:57,040 --> 00:13:59,199
authenticate your das or something

363
00:13:59,199 --> 00:14:00,560
no big deal

364
00:14:00,560 --> 00:14:02,959
but if you're creating machine accounts

365
00:14:02,959 --> 00:14:06,000
and or machine temp uh certificates and

366
00:14:06,000 --> 00:14:09,040
user certificates and vpn certificates

367
00:14:09,040 --> 00:14:10,880
and

368
00:14:10,880 --> 00:14:13,440
you're gonna have a tough time so

369
00:14:13,440 --> 00:14:16,560
uh do not dig into in this talk about

370
00:14:16,560 --> 00:14:17,760
event ids that you're going to want to

371
00:14:17,760 --> 00:14:18,880
track but

372
00:14:18,880 --> 00:14:21,839
we've got we've got a few

373
00:14:21,839 --> 00:14:22,800
um

374
00:14:22,800 --> 00:14:24,720
that being said like i said i i've not

375
00:14:24,720 --> 00:14:26,959
seen this configured in any environment

376
00:14:26,959 --> 00:14:28,079
at all

377
00:14:28,079 --> 00:14:29,600
so if it's not configured in your

378
00:14:29,600 --> 00:14:31,839
environment please do not be ashamed no

379
00:14:31,839 --> 00:14:34,240
judgment

380
00:14:34,720 --> 00:14:37,440
luckily it's pretty easy to uh

381
00:14:37,440 --> 00:14:39,120
re-enable it

382
00:14:39,120 --> 00:14:40,880
uh you can just go into

383
00:14:40,880 --> 00:14:42,000
the

384
00:14:42,000 --> 00:14:44,240
the certificate sort certification

385
00:14:44,240 --> 00:14:45,600
services

386
00:14:45,600 --> 00:14:49,279
uh mmc and enable

387
00:14:49,279 --> 00:14:51,040
uh auditing

388
00:14:51,040 --> 00:14:52,320
unfortunately there's there's a little

389
00:14:52,320 --> 00:14:54,240
more to it but

390
00:14:54,240 --> 00:14:56,560
uh oh yeah speaking of scripted version

391
00:14:56,560 --> 00:14:58,720
this is the scripted version super easy

392
00:14:58,720 --> 00:15:01,120
you just gotta enable the auditing

393
00:15:01,120 --> 00:15:04,720
restart the services no big deal

394
00:15:04,720 --> 00:15:07,279
but then you also need to

395
00:15:07,279 --> 00:15:09,440
enable certification services in group

396
00:15:09,440 --> 00:15:12,480
policy this is one of the

397
00:15:12,480 --> 00:15:14,399
sub policies or

398
00:15:14,399 --> 00:15:16,560
more specific policies

399
00:15:16,560 --> 00:15:20,160
uh also called advanced auditing

400
00:15:20,160 --> 00:15:24,079
that were released in server 2008

401
00:15:24,079 --> 00:15:27,040
um

402
00:15:27,040 --> 00:15:29,120
this should be applied

403
00:15:29,120 --> 00:15:30,560
i'd probably say

404
00:15:30,560 --> 00:15:33,360
put a gpo for this at your domain route

405
00:15:33,360 --> 00:15:37,120
um or at the ou that hand or holds all

406
00:15:37,120 --> 00:15:40,880
of your your certificate authority posts

407
00:15:40,880 --> 00:15:43,680
and last but not least

408
00:15:43,680 --> 00:15:46,959
you need to enforce advanced auditing so

409
00:15:46,959 --> 00:15:50,079
in my my role as a as an ad security

410
00:15:50,079 --> 00:15:52,000
assessor

411
00:15:52,000 --> 00:15:53,440
i've seen

412
00:15:53,440 --> 00:15:55,360
multiple

413
00:15:55,360 --> 00:15:57,680
organizations that

414
00:15:57,680 --> 00:15:59,360
set up all their advanced auditing

415
00:15:59,360 --> 00:16:02,800
properly and then do not enforce the

416
00:16:02,800 --> 00:16:04,560
advanced auditing

417
00:16:04,560 --> 00:16:06,079
if you do not enforce the advanced

418
00:16:06,079 --> 00:16:07,759
auditing

419
00:16:07,759 --> 00:16:10,320
those advanced auditing settings do not

420
00:16:10,320 --> 00:16:11,839
apply so

421
00:16:11,839 --> 00:16:13,040
um

422
00:16:13,040 --> 00:16:14,320
if you're doing your advanced auditing

423
00:16:14,320 --> 00:16:17,440
properly this step is not necessarily

424
00:16:17,440 --> 00:16:20,320
necessary but if you are doing it uh or

425
00:16:20,320 --> 00:16:23,839
not go ahead and get this going

426
00:16:26,000 --> 00:16:29,120
number two single tier architecture

427
00:16:29,120 --> 00:16:31,040
what does that mean

428
00:16:31,040 --> 00:16:33,199
so

429
00:16:33,759 --> 00:16:36,079
in a public key infrastructure you can

430
00:16:36,079 --> 00:16:37,839
have

431
00:16:37,839 --> 00:16:40,800
a root ca that is the

432
00:16:40,800 --> 00:16:42,720
you know root of all of your trusts in

433
00:16:42,720 --> 00:16:45,519
your entire environment

434
00:16:45,519 --> 00:16:46,720
and

435
00:16:46,720 --> 00:16:50,880
in a default configuration

436
00:16:50,880 --> 00:16:52,240
that's all you have you've got your one

437
00:16:52,240 --> 00:16:54,639
root ca it assigns some certificates to

438
00:16:54,639 --> 00:16:55,920
all your various entities in your

439
00:16:55,920 --> 00:16:57,199
network

440
00:16:57,199 --> 00:16:59,599
and

441
00:17:00,480 --> 00:17:04,319
that's it um

442
00:17:04,319 --> 00:17:05,599
unfortunately

443
00:17:05,599 --> 00:17:08,079
this is not secure this should not be

444
00:17:08,079 --> 00:17:10,079
used for production

445
00:17:10,079 --> 00:17:10,880
buy

446
00:17:10,880 --> 00:17:12,720
microsoft's guidance

447
00:17:12,720 --> 00:17:14,559
but they don't mention that when you're

448
00:17:14,559 --> 00:17:18,000
doing your next next nxt finish at all

449
00:17:18,000 --> 00:17:19,439
you have to dig into separate

450
00:17:19,439 --> 00:17:20,880
documentation in order to figure out

451
00:17:20,880 --> 00:17:23,919
that this is not production

452
00:17:25,839 --> 00:17:28,160
and there is no

453
00:17:28,160 --> 00:17:30,720
implication again when you step through

454
00:17:30,720 --> 00:17:33,280
your next next finish uh installation

455
00:17:33,280 --> 00:17:35,120
there is no implication of what you are

456
00:17:35,120 --> 00:17:37,760
actually doing

457
00:17:37,760 --> 00:17:39,600
thankfully the only places that i've

458
00:17:39,600 --> 00:17:40,799
found this have been smaller

459
00:17:40,799 --> 00:17:42,559
environments that do not have a

460
00:17:42,559 --> 00:17:44,960
dedicated security staff i think once

461
00:17:44,960 --> 00:17:46,320
you bring in that first security guy

462
00:17:46,320 --> 00:17:48,000
they say

463
00:17:48,000 --> 00:17:51,600
nah we're doing two tiers minimum

464
00:17:51,600 --> 00:17:53,520
this is what it looks like

465
00:17:53,520 --> 00:17:55,120
i mean you've got your your one

466
00:17:55,120 --> 00:17:57,520
certificate authority it's handing out

467
00:17:57,520 --> 00:18:01,080
your your certificates

468
00:18:01,280 --> 00:18:03,120
but

469
00:18:03,120 --> 00:18:04,720
if

470
00:18:04,720 --> 00:18:09,120
when your ca host is compromised

471
00:18:09,440 --> 00:18:11,200
you're going to have to go around and

472
00:18:11,200 --> 00:18:13,120
touch every single

473
00:18:13,120 --> 00:18:14,480
uh

474
00:18:14,480 --> 00:18:17,039
every single device that has

475
00:18:17,039 --> 00:18:19,760
that ca as a trusted route for your

476
00:18:19,760 --> 00:18:21,440
environment

477
00:18:21,440 --> 00:18:23,679
and unless you have like

478
00:18:23,679 --> 00:18:26,080
three machines in your network

479
00:18:26,080 --> 00:18:29,840
that's going to be a pain so

480
00:18:30,000 --> 00:18:31,120
yeah

481
00:18:31,120 --> 00:18:34,559
let's remediate that

482
00:18:34,720 --> 00:18:37,840
let's actually take a step back first

483
00:18:37,840 --> 00:18:41,120
do you really need ad integrated pki

484
00:18:41,120 --> 00:18:44,240
are you using it in that fashion

485
00:18:44,240 --> 00:18:45,440
um

486
00:18:45,440 --> 00:18:48,240
the few single tiers that i saw

487
00:18:48,240 --> 00:18:50,960
have an adcs environment stood up but

488
00:18:50,960 --> 00:18:52,000
they

489
00:18:52,000 --> 00:18:53,440
they weren't using it it was just

490
00:18:53,440 --> 00:18:55,440
sitting there

491
00:18:55,440 --> 00:18:58,400
just with gaping holes in it so

492
00:18:58,400 --> 00:19:02,640
really consider that if you do decide

493
00:19:02,799 --> 00:19:05,280
at least build a two-tier

494
00:19:05,280 --> 00:19:06,320
pki

495
00:19:06,320 --> 00:19:08,000
we've got a root ca

496
00:19:08,000 --> 00:19:09,200
we've got

497
00:19:09,200 --> 00:19:10,960
one or multiple

498
00:19:10,960 --> 00:19:13,039
cas that actually issue

499
00:19:13,039 --> 00:19:15,039
certificates

500
00:19:15,039 --> 00:19:15,919
um

501
00:19:15,919 --> 00:19:18,720
two tiers probably fine for most people

502
00:19:18,720 --> 00:19:19,919
but

503
00:19:19,919 --> 00:19:21,840
if you've got a especially a highly

504
00:19:21,840 --> 00:19:24,080
distributed environment it's kind of

505
00:19:24,080 --> 00:19:25,679
difficult to

506
00:19:25,679 --> 00:19:27,679
do it with just two tiers so three tiers

507
00:19:27,679 --> 00:19:31,039
might be might make more sense

508
00:19:31,039 --> 00:19:32,799
that root ca

509
00:19:32,799 --> 00:19:35,120
should be completely disconnected from

510
00:19:35,120 --> 00:19:37,520
ad which means it is built in standalone

511
00:19:37,520 --> 00:19:39,039
mode

512
00:19:39,039 --> 00:19:41,840
uh yeah not domain joined does not

513
00:19:41,840 --> 00:19:43,760
communicate with ad

514
00:19:43,760 --> 00:19:44,720
lives

515
00:19:44,720 --> 00:19:46,400
offline generally doesn't even have a

516
00:19:46,400 --> 00:19:47,440
network

517
00:19:47,440 --> 00:19:48,400
card

518
00:19:48,400 --> 00:19:51,039
installed etc

519
00:19:51,039 --> 00:19:52,400
uh the only time that you would bring

520
00:19:52,400 --> 00:19:54,960
that online is to

521
00:19:54,960 --> 00:19:56,240
create new

522
00:19:56,240 --> 00:19:59,200
intermediate cas or to

523
00:19:59,200 --> 00:20:02,480
update the revocation list

524
00:20:02,480 --> 00:20:05,280
that the root ca is

525
00:20:05,280 --> 00:20:06,400
publishing

526
00:20:06,400 --> 00:20:09,120
and then of course updating the o the os

527
00:20:09,120 --> 00:20:11,120
occasionally but you can do that on a

528
00:20:11,120 --> 00:20:13,600
much slow since it's offline and powered

529
00:20:13,600 --> 00:20:16,240
down you could do that at a much slower

530
00:20:16,240 --> 00:20:18,559
pace than normal

531
00:20:18,559 --> 00:20:19,600
and

532
00:20:19,600 --> 00:20:21,039
when possible

533
00:20:21,039 --> 00:20:26,159
please use a hsm or a tpm or vta tpm to

534
00:20:26,159 --> 00:20:28,720
protect those keys that makes them much

535
00:20:28,720 --> 00:20:31,200
more difficult to grab

536
00:20:31,200 --> 00:20:32,880
and then your subordinate ca is the ones

537
00:20:32,880 --> 00:20:34,880
that actually issue certificates to your

538
00:20:34,880 --> 00:20:36,559
users and your computers those will be

539
00:20:36,559 --> 00:20:38,159
in enterprise mode those will be active

540
00:20:38,159 --> 00:20:40,480
directory integrated

541
00:20:40,480 --> 00:20:41,360
um

542
00:20:41,360 --> 00:20:44,559
to go ahead and build a two-tier ca i do

543
00:20:44,559 --> 00:20:48,080
i've done this i followed peat nets uh

544
00:20:48,080 --> 00:20:50,720
guidance and

545
00:20:50,720 --> 00:20:53,039
start to finish it's great um i might

546
00:20:53,039 --> 00:20:54,799
make some configuration changes now to

547
00:20:54,799 --> 00:20:57,200
it but uh you know for playing with for

548
00:20:57,200 --> 00:21:00,080
starting your first two-tier pki it's

549
00:21:00,080 --> 00:21:02,320
perfect

550
00:21:02,320 --> 00:21:04,240
and just so we can see what this looks

551
00:21:04,240 --> 00:21:05,520
like

552
00:21:05,520 --> 00:21:07,200
we've got uh

553
00:21:07,200 --> 00:21:08,880
our root

554
00:21:08,880 --> 00:21:11,360
rca and our other ca

555
00:21:11,360 --> 00:21:12,240
now

556
00:21:12,240 --> 00:21:14,320
that first ca gets popped it is

557
00:21:14,320 --> 00:21:16,720
compromised

558
00:21:16,720 --> 00:21:18,720
instead of having to go through and

559
00:21:18,720 --> 00:21:21,039
touch all of your computers

560
00:21:21,039 --> 00:21:24,640
you can bring the root ca online

561
00:21:24,640 --> 00:21:25,760
and

562
00:21:25,760 --> 00:21:27,039
revoke

563
00:21:27,039 --> 00:21:28,559
the

564
00:21:28,559 --> 00:21:31,440
certificate that is assigned to

565
00:21:31,440 --> 00:21:33,520
the compromise ca

566
00:21:33,520 --> 00:21:35,679
the other ca will pick up

567
00:21:35,679 --> 00:21:38,559
to do some work uh on on behalf of the

568
00:21:38,559 --> 00:21:40,320
compromise one and you don't have to go

569
00:21:40,320 --> 00:21:43,039
around to every single computer and and

570
00:21:43,039 --> 00:21:45,360
touch them all

571
00:21:45,360 --> 00:21:47,520
and i'm lazy so

572
00:21:47,520 --> 00:21:50,559
that sounds better to me

573
00:21:52,080 --> 00:21:53,360
now we're going to get into things that

574
00:21:53,360 --> 00:21:56,639
are a little more

575
00:21:57,360 --> 00:22:01,440
active directory centric i would say

576
00:22:01,440 --> 00:22:03,679
and

577
00:22:03,679 --> 00:22:06,799
this this uh non-standard ownership is

578
00:22:06,799 --> 00:22:09,280
fairly common uh i would when i say

579
00:22:09,280 --> 00:22:11,120
fairly common i mean it's i've seen it

580
00:22:11,120 --> 00:22:15,039
in every environment that we've tested

581
00:22:15,280 --> 00:22:19,520
when an 80 object is created the owner

582
00:22:19,520 --> 00:22:22,080
sorry the creator becomes the owner

583
00:22:22,080 --> 00:22:24,080
and that's important because an owner of

584
00:22:24,080 --> 00:22:26,720
an 80 object can set

585
00:22:26,720 --> 00:22:28,799
any permissions on that object

586
00:22:28,799 --> 00:22:30,720
that

587
00:22:30,720 --> 00:22:32,080
that they want

588
00:22:32,080 --> 00:22:34,159
regardless of how the access control

589
00:22:34,159 --> 00:22:36,799
list is set

590
00:22:37,039 --> 00:22:39,120
so

591
00:22:39,120 --> 00:22:41,840
that means even if they say you know

592
00:22:41,840 --> 00:22:43,520
authenticated users

593
00:22:43,520 --> 00:22:46,400
deny re deny write whatever

594
00:22:46,400 --> 00:22:49,360
but if i own that that object own that

595
00:22:49,360 --> 00:22:51,760
template i can modify it exactly to how

596
00:22:51,760 --> 00:22:53,440
i want it to be

597
00:22:53,440 --> 00:22:56,880
so again when i get i get compromised

598
00:22:56,880 --> 00:22:59,039
guess what

599
00:22:59,039 --> 00:23:00,159
you can

600
00:23:00,159 --> 00:23:02,159
go and find all of my my templates that

601
00:23:02,159 --> 00:23:04,240
i created and

602
00:23:04,240 --> 00:23:07,760
modify them to your specifications

603
00:23:07,760 --> 00:23:09,280
up to and including

604
00:23:09,280 --> 00:23:12,080
allowing yourself to

605
00:23:12,080 --> 00:23:14,320
request a certificate on behalf of your

606
00:23:14,320 --> 00:23:17,919
domain admin or your domain controller

607
00:23:17,919 --> 00:23:20,559
the few places that i have seen this

608
00:23:20,559 --> 00:23:23,720
have been

609
00:23:24,000 --> 00:23:26,320
probably mid-size organizations

610
00:23:26,320 --> 00:23:28,639
that

611
00:23:28,799 --> 00:23:30,480
you know have implemented account

612
00:23:30,480 --> 00:23:31,919
tiering

613
00:23:31,919 --> 00:23:34,320
and

614
00:23:34,640 --> 00:23:37,520
never went back to clean up

615
00:23:37,520 --> 00:23:38,960
all of the objects that were created

616
00:23:38,960 --> 00:23:40,400
before their account tiering went into

617
00:23:40,400 --> 00:23:41,840
place

618
00:23:41,840 --> 00:23:43,200
for example

619
00:23:43,200 --> 00:23:46,480
in my lab you know jhildreth1234

620
00:23:46,480 --> 00:23:48,960
was formerly a domain administrator

621
00:23:48,960 --> 00:23:51,200
creates some templates

622
00:23:51,200 --> 00:23:52,640
gets them pushed out

623
00:23:52,640 --> 00:23:54,080
and then

624
00:23:54,080 --> 00:23:56,960
a few years later you know

625
00:23:56,960 --> 00:23:59,200
jake hildreth admin is created

626
00:23:59,200 --> 00:24:00,039
and

627
00:24:00,039 --> 00:24:02,480
jhildreth1234 still

628
00:24:02,480 --> 00:24:04,320
maintains control of this particular

629
00:24:04,320 --> 00:24:06,000
object so

630
00:24:06,000 --> 00:24:07,919
um

631
00:24:07,919 --> 00:24:09,760
jhildreth1234

632
00:24:09,760 --> 00:24:11,679
clicks on a phishing email about mario

633
00:24:11,679 --> 00:24:13,919
kart being released

634
00:24:13,919 --> 00:24:16,640
and uh yeah

635
00:24:16,640 --> 00:24:20,480
now now the attacker owns

636
00:24:20,720 --> 00:24:21,760
that

637
00:24:21,760 --> 00:24:24,240
specific object

638
00:24:24,240 --> 00:24:28,000
so pretty easy to fix fortunately um

639
00:24:28,000 --> 00:24:29,760
we just need to reset

640
00:24:29,760 --> 00:24:33,360
your ownership to known safe owners and

641
00:24:33,360 --> 00:24:35,520
and

642
00:24:35,760 --> 00:24:38,960
donate domain admins enterprise admins

643
00:24:38,960 --> 00:24:41,600
the domain administrators group

644
00:24:41,600 --> 00:24:43,200
if you've created some

645
00:24:43,200 --> 00:24:45,600
specific pki admin groups for your

646
00:24:45,600 --> 00:24:47,600
environment those are all perfect

647
00:24:47,600 --> 00:24:50,159
perfect owners

648
00:24:50,159 --> 00:24:53,520
what we prefer is definitely

649
00:24:53,520 --> 00:24:55,919
enterprise admins and that is mainly

650
00:24:55,919 --> 00:24:58,320
because enterprise admins

651
00:24:58,320 --> 00:25:00,000
should be kept empty unless you're

652
00:25:00,000 --> 00:25:01,919
actually using it so

653
00:25:01,919 --> 00:25:04,480
um y'all are keeping your enterprise

654
00:25:04,480 --> 00:25:07,600
admins empty correct

655
00:25:08,159 --> 00:25:11,600
i do not believe you

656
00:25:12,240 --> 00:25:15,919
so luckily again pretty easy to find

657
00:25:15,919 --> 00:25:16,799
we

658
00:25:16,799 --> 00:25:20,400
look through and find uh we we define

659
00:25:20,400 --> 00:25:22,480
what we want as our safe owners and you

660
00:25:22,480 --> 00:25:24,960
can modify this to yourself oh

661
00:25:24,960 --> 00:25:26,880
i i am including all of these snippets

662
00:25:26,880 --> 00:25:28,480
on my github which i will link to again

663
00:25:28,480 --> 00:25:30,559
later um

664
00:25:30,559 --> 00:25:32,799
i'll probably get this posted on the

665
00:25:32,799 --> 00:25:35,039
trimark hub

666
00:25:35,039 --> 00:25:38,640
got the approval from the boss suite

667
00:25:39,840 --> 00:25:41,360
yeah where you could go and grab all of

668
00:25:41,360 --> 00:25:43,760
these snippets to find and remediate

669
00:25:43,760 --> 00:25:45,039
your own

670
00:25:45,039 --> 00:25:46,400
environment

671
00:25:46,400 --> 00:25:47,760
so yeah we just look through we define

672
00:25:47,760 --> 00:25:50,080
who the your safe owners are and find

673
00:25:50,080 --> 00:25:52,480
all the objects in the public key

674
00:25:52,480 --> 00:25:53,520
services

675
00:25:53,520 --> 00:25:55,440
container that

676
00:25:55,440 --> 00:25:58,240
do not match that

677
00:25:58,240 --> 00:25:59,520
in my lab

678
00:25:59,520 --> 00:26:01,440
i had six

679
00:26:01,440 --> 00:26:03,039
if i have a small number like six i'm

680
00:26:03,039 --> 00:26:04,159
probably just going to go through and

681
00:26:04,159 --> 00:26:06,640
remediate those by hand

682
00:26:06,640 --> 00:26:08,799
that shouldn't take too long but

683
00:26:08,799 --> 00:26:10,799
if you're you're over that that's

684
00:26:10,799 --> 00:26:13,360
probably my limit

685
00:26:13,360 --> 00:26:15,440
got some code here to go through and

686
00:26:15,440 --> 00:26:16,799
reset

687
00:26:16,799 --> 00:26:18,400
your

688
00:26:18,400 --> 00:26:19,919
all the the

689
00:26:19,919 --> 00:26:22,240
ones with bad owners reset all of those

690
00:26:22,240 --> 00:26:25,760
to domain admins

691
00:26:25,760 --> 00:26:27,600
pretty simple

692
00:26:27,600 --> 00:26:29,559
so so that wraps up the common

693
00:26:29,559 --> 00:26:31,120
misconfigurations

694
00:26:31,120 --> 00:26:34,320
in just a review that's no auditing

695
00:26:34,320 --> 00:26:36,799
a single tier configuration

696
00:26:36,799 --> 00:26:38,559
and non-standard ownership of those

697
00:26:38,559 --> 00:26:40,240
objects

698
00:26:40,240 --> 00:26:42,000
um

699
00:26:42,000 --> 00:26:44,640
now we get to move into the fun stuff

700
00:26:44,640 --> 00:26:46,320
and by fun stuff i mean things that will

701
00:26:46,320 --> 00:26:47,760
take like

702
00:26:47,760 --> 00:26:51,039
two steps at worst one step

703
00:26:51,039 --> 00:26:54,960
to compromise your your domain

704
00:26:55,919 --> 00:26:58,159
first one kind of related to the last

705
00:26:58,159 --> 00:27:01,200
one overly permissive acls

706
00:27:01,200 --> 00:27:04,559
uh the problem with this one is that

707
00:27:04,559 --> 00:27:06,159
or why i deem it more dangerous is

708
00:27:06,159 --> 00:27:08,400
because

709
00:27:08,400 --> 00:27:09,679
typically

710
00:27:09,679 --> 00:27:12,159
instead of it being a single user

711
00:27:12,159 --> 00:27:13,760
that is assigned

712
00:27:13,760 --> 00:27:16,559
uh these

713
00:27:16,640 --> 00:27:18,159
dangerous acls

714
00:27:18,159 --> 00:27:19,039
they

715
00:27:19,039 --> 00:27:21,440
it's it's more assigned to groups which

716
00:27:21,440 --> 00:27:23,760
then obviously opens up the attack

717
00:27:23,760 --> 00:27:26,158
service

718
00:27:27,200 --> 00:27:30,080
low privileged users should have no

719
00:27:30,080 --> 00:27:31,919
right access on anything

720
00:27:31,919 --> 00:27:33,039
in

721
00:27:33,039 --> 00:27:36,240
the public key services container

722
00:27:36,240 --> 00:27:38,640
and really

723
00:27:38,640 --> 00:27:40,240
the everyone group shouldn't be able to

724
00:27:40,240 --> 00:27:42,720
do anything in that container

725
00:27:42,720 --> 00:27:44,399
and we'll go ahead and say you know

726
00:27:44,399 --> 00:27:49,120
anonymous and yes too because yeah

727
00:27:49,120 --> 00:27:50,159
um

728
00:27:50,159 --> 00:27:52,559
the few times that i have found this

729
00:27:52,559 --> 00:27:54,240
it is related to a template that was

730
00:27:54,240 --> 00:27:56,320
created for testing and just never got

731
00:27:56,320 --> 00:27:58,080
cleaned up later uh you know it's got

732
00:27:58,080 --> 00:28:01,200
the name of uh copy to web server test

733
00:28:01,200 --> 00:28:02,720
or

734
00:28:02,720 --> 00:28:05,840
user authentication dev or whatever

735
00:28:05,840 --> 00:28:08,399
something like that so obviously not in

736
00:28:08,399 --> 00:28:09,440
use

737
00:28:09,440 --> 00:28:12,640
probably can just delete that one

738
00:28:12,640 --> 00:28:13,919
but

739
00:28:13,919 --> 00:28:16,240
oh so this is what it looks like i mean

740
00:28:16,240 --> 00:28:18,480
fairly simple here

741
00:28:18,480 --> 00:28:20,799
um

742
00:28:21,440 --> 00:28:22,799
i'm going to give you an example of how

743
00:28:22,799 --> 00:28:24,960
this would be attacked

744
00:28:24,960 --> 00:28:27,440
first off

745
00:28:28,840 --> 00:28:31,120
user attacks

746
00:28:31,120 --> 00:28:33,840
compromises the admins and admins daily

747
00:28:33,840 --> 00:28:35,520
driver account

748
00:28:35,520 --> 00:28:38,080
and then they go ahead and enumerate

749
00:28:38,080 --> 00:28:40,159
that container that i showed you the pks

750
00:28:40,159 --> 00:28:41,840
container

751
00:28:41,840 --> 00:28:43,840
and they find

752
00:28:43,840 --> 00:28:46,559
a template created years ago

753
00:28:46,559 --> 00:28:48,720
that

754
00:28:50,159 --> 00:28:52,559
that basically the template says if i

755
00:28:52,559 --> 00:28:54,399
request a certificate using this

756
00:28:54,399 --> 00:28:55,760
template

757
00:28:55,760 --> 00:28:58,640
i get it back in my name

758
00:28:58,640 --> 00:29:01,200
but because your attacker

759
00:29:01,200 --> 00:29:03,520
has right access to that template

760
00:29:03,520 --> 00:29:05,120
they can go ahead and modify that and

761
00:29:05,120 --> 00:29:06,880
say

762
00:29:06,880 --> 00:29:08,559
i want to request a template or a

763
00:29:08,559 --> 00:29:12,880
certificate in the name of someone else

764
00:29:12,880 --> 00:29:14,320
so i'm going to go ahead and request it

765
00:29:14,320 --> 00:29:16,080
as a domain admin

766
00:29:16,080 --> 00:29:18,000
and like we discussed earlier once

767
00:29:18,000 --> 00:29:20,799
you've got that domain admin cert

768
00:29:20,799 --> 00:29:24,080
you've got domain admin until

769
00:29:24,080 --> 00:29:27,840
the certificate expires

770
00:29:29,679 --> 00:29:33,360
thankfully again pretty easy to find

771
00:29:33,360 --> 00:29:35,039
we go through we define who the safe

772
00:29:35,039 --> 00:29:37,440
users of these templates are

773
00:29:37,440 --> 00:29:39,039
we

774
00:29:39,039 --> 00:29:41,039
uh define what some dangerous rights are

775
00:29:41,039 --> 00:29:42,000
that

776
00:29:42,000 --> 00:29:44,240
non-safe users unsafe users yeah that's

777
00:29:44,240 --> 00:29:45,440
the word i want

778
00:29:45,440 --> 00:29:48,480
unsafe users should uh not have and then

779
00:29:48,480 --> 00:29:50,080
we just kind of work through the entire

780
00:29:50,080 --> 00:29:52,399
container and find all the templates

781
00:29:52,399 --> 00:29:56,479
that match that configuration

782
00:29:58,080 --> 00:29:59,279
in my lab

783
00:29:59,279 --> 00:30:02,159
i only had a couple

784
00:30:02,159 --> 00:30:03,279
unfortunately the code that i've given

785
00:30:03,279 --> 00:30:04,559
you

786
00:30:04,559 --> 00:30:06,159
as written

787
00:30:06,159 --> 00:30:08,159
will spit out things like your ca should

788
00:30:08,159 --> 00:30:10,399
not or you know that your ca has rights

789
00:30:10,399 --> 00:30:12,240
over templates your ca should have

790
00:30:12,240 --> 00:30:13,840
rights so you're going to want to go

791
00:30:13,840 --> 00:30:16,320
through this and just kind of manually

792
00:30:16,320 --> 00:30:18,320
uh clean up whatever is found in that

793
00:30:18,320 --> 00:30:19,919
that code

794
00:30:19,919 --> 00:30:21,600
and what that basically does is just

795
00:30:21,600 --> 00:30:25,200
takes and unchecks that right uh option

796
00:30:25,200 --> 00:30:26,159
for

797
00:30:26,159 --> 00:30:29,440
uh the unsafe users

798
00:30:30,720 --> 00:30:32,960
now we get into the really fun stuff and

799
00:30:32,960 --> 00:30:34,880
by really fun i mean one step this is

800
00:30:34,880 --> 00:30:36,799
this is one step step

801
00:30:36,799 --> 00:30:38,399
um

802
00:30:38,399 --> 00:30:39,840
like we discussed earlier templates

803
00:30:39,840 --> 00:30:41,919
contain basically a set of

804
00:30:41,919 --> 00:30:43,520
configurations

805
00:30:43,520 --> 00:30:45,840
that define

806
00:30:45,840 --> 00:30:47,360
you know who can who can request a

807
00:30:47,360 --> 00:30:49,360
ticket or sorry who can request a

808
00:30:49,360 --> 00:30:50,960
certificate

809
00:30:50,960 --> 00:30:53,520
what it can be used for

810
00:30:53,520 --> 00:30:56,240
who the certificate is for

811
00:30:56,240 --> 00:30:57,600
and

812
00:30:57,600 --> 00:31:00,240
is approval required for

813
00:31:00,240 --> 00:31:05,000
the certificate to actually be created

814
00:31:05,360 --> 00:31:07,679
those last two are important

815
00:31:07,679 --> 00:31:10,320
because

816
00:31:12,159 --> 00:31:14,799
in many many instances

817
00:31:14,799 --> 00:31:16,880
these certificates are created where a

818
00:31:16,880 --> 00:31:19,440
user just a standard user can request a

819
00:31:19,440 --> 00:31:20,720
certificate

820
00:31:20,720 --> 00:31:22,720
on behalf of any other entity in the

821
00:31:22,720 --> 00:31:24,080
environment

822
00:31:24,080 --> 00:31:26,240
without any approval

823
00:31:26,240 --> 00:31:28,960
up to and including domain admin and

824
00:31:28,960 --> 00:31:32,159
domain controller

825
00:31:32,159 --> 00:31:33,840
and i have found this

826
00:31:33,840 --> 00:31:36,000
exact specification

827
00:31:36,000 --> 00:31:38,240
in eight of the ten environments that i

828
00:31:38,240 --> 00:31:40,720
have that i've assessed

829
00:31:40,720 --> 00:31:41,840
so

830
00:31:41,840 --> 00:31:44,559
it's out there and yeah it's just low

831
00:31:44,559 --> 00:31:47,760
hanging your fruit at this point

832
00:31:47,760 --> 00:31:49,039
this is what it would look like if you

833
00:31:49,039 --> 00:31:50,799
were to actually dig into how the

834
00:31:50,799 --> 00:31:53,840
template is configured

835
00:31:54,000 --> 00:31:56,159
domain users can enroll

836
00:31:56,159 --> 00:31:58,399
the the template is used for client

837
00:31:58,399 --> 00:32:01,279
authentication

838
00:32:01,279 --> 00:32:02,000
the

839
00:32:02,000 --> 00:32:02,799
uh

840
00:32:02,799 --> 00:32:05,519
the requester can supply in the request

841
00:32:05,519 --> 00:32:08,640
an alternative name for the certificate

842
00:32:08,640 --> 00:32:09,840
and

843
00:32:09,840 --> 00:32:11,279
no one is

844
00:32:11,279 --> 00:32:13,120
required to approve that that

845
00:32:13,120 --> 00:32:16,080
certificate is good

846
00:32:17,120 --> 00:32:20,559
earlier i was talking about bad

847
00:32:20,559 --> 00:32:22,720
bad user interface and bad guidance from

848
00:32:22,720 --> 00:32:25,919
from microsoft and this is one of them

849
00:32:25,919 --> 00:32:28,159
the more frustrating warnings if you set

850
00:32:28,159 --> 00:32:29,919
these four configurations this is the

851
00:32:29,919 --> 00:32:32,159
warning you're gonna get

852
00:32:32,159 --> 00:32:34,240
read that last sentence combining these

853
00:32:34,240 --> 00:32:36,880
certificate options may create a cert

854
00:32:36,880 --> 00:32:40,559
security risk and is not recommended

855
00:32:40,559 --> 00:32:42,080
i don't know if they could soften that

856
00:32:42,080 --> 00:32:43,519
anymore

857
00:32:43,519 --> 00:32:44,640
i mean

858
00:32:44,640 --> 00:32:47,279
this is a security risk and should not

859
00:32:47,279 --> 00:32:49,919
be completed is what i would rewrite

860
00:32:49,919 --> 00:32:52,240
that is

861
00:32:52,399 --> 00:32:53,279
uh

862
00:32:53,279 --> 00:32:55,279
so how is this attacked

863
00:32:55,279 --> 00:32:58,640
it's pretty similar to the last one here

864
00:32:58,640 --> 00:33:01,519
user gets phished

865
00:33:01,760 --> 00:33:05,519
attacker scans the pks container

866
00:33:05,519 --> 00:33:07,039
spectreops actually released a tool

867
00:33:07,039 --> 00:33:09,200
shortly after their talk last year

868
00:33:09,200 --> 00:33:10,559
called certify

869
00:33:10,559 --> 00:33:14,639
that we'll do all this automated for you

870
00:33:16,480 --> 00:33:17,919
there are a lot of

871
00:33:17,919 --> 00:33:20,960
built-in utilities ds query and then you

872
00:33:20,960 --> 00:33:21,840
know

873
00:33:21,840 --> 00:33:24,399
get 80 object etc that

874
00:33:24,399 --> 00:33:26,480
you can use without having to download

875
00:33:26,480 --> 00:33:29,919
and compile certify on on the box

876
00:33:29,919 --> 00:33:32,080
but it will scan through and find all of

877
00:33:32,080 --> 00:33:34,000
the vulnerable

878
00:33:34,000 --> 00:33:35,039
templates

879
00:33:35,039 --> 00:33:37,360
for you

880
00:33:37,360 --> 00:33:39,679
so once they find one that's vulnerable

881
00:33:39,679 --> 00:33:42,080
like this

882
00:33:42,399 --> 00:33:44,959
what do you do

883
00:33:45,440 --> 00:33:47,679
request d.a of course

884
00:33:47,679 --> 00:33:51,360
and if this one sounds familiar to y'all

885
00:33:51,360 --> 00:33:56,960
uh mandiant actually posted on thursday

886
00:33:56,960 --> 00:33:59,760
but our good buddies apt29 putting this

887
00:33:59,760 --> 00:34:02,159
one into uh into use

888
00:34:02,159 --> 00:34:04,320
so

889
00:34:04,880 --> 00:34:05,679
yeah

890
00:34:05,679 --> 00:34:07,120
it's it's a

891
00:34:07,120 --> 00:34:10,000
it's for real now

892
00:34:10,320 --> 00:34:12,639
thankfully it's really easy to find

893
00:34:12,639 --> 00:34:14,800
a little complex to fix depending on

894
00:34:14,800 --> 00:34:17,359
your specific situation but still really

895
00:34:17,359 --> 00:34:19,520
easy to find

896
00:34:19,520 --> 00:34:21,760
what we're doing here we're just saying

897
00:34:21,760 --> 00:34:23,199
you know i'm looking for certificates

898
00:34:23,199 --> 00:34:25,440
that require that are used for client

899
00:34:25,440 --> 00:34:26,960
authentication

900
00:34:26,960 --> 00:34:28,639
and

901
00:34:28,639 --> 00:34:30,239
that

902
00:34:30,239 --> 00:34:31,040
can

903
00:34:31,040 --> 00:34:33,599
set a alternative name

904
00:34:33,599 --> 00:34:36,079
and that do not request or that do not

905
00:34:36,079 --> 00:34:39,520
require approval

906
00:34:40,159 --> 00:34:41,839
again in my lab three

907
00:34:41,839 --> 00:34:44,480
no big deal go through and

908
00:34:44,480 --> 00:34:46,719
modify them as needed

909
00:34:46,719 --> 00:34:48,639
the options that i like

910
00:34:48,639 --> 00:34:49,679
to do

911
00:34:49,679 --> 00:34:52,320
for meeting remediating this

912
00:34:52,320 --> 00:34:53,520
number one

913
00:34:53,520 --> 00:34:55,679
you could just go ahead and remove

914
00:34:55,679 --> 00:34:58,480
the ability for the enrollee to request

915
00:34:58,480 --> 00:35:02,560
a different name on their certificate

916
00:35:02,560 --> 00:35:05,280
unfortunately there are some valid uh

917
00:35:05,280 --> 00:35:08,320
use cases where

918
00:35:09,440 --> 00:35:11,599
you know one entity will need to request

919
00:35:11,599 --> 00:35:13,920
on the behalf of another entity

920
00:35:13,920 --> 00:35:16,640
so what i prefer to do instead

921
00:35:16,640 --> 00:35:19,119
oh yeah this is what it does it changes

922
00:35:19,119 --> 00:35:22,240
uh changes supply and request to

923
00:35:22,240 --> 00:35:23,760
build from active directory information

924
00:35:23,760 --> 00:35:25,040
so that way

925
00:35:25,040 --> 00:35:26,400
you cannot

926
00:35:26,400 --> 00:35:30,520
request an additional name

927
00:35:32,000 --> 00:35:33,599
so

928
00:35:33,599 --> 00:35:35,040
the one that i

929
00:35:35,040 --> 00:35:36,079
prefer

930
00:35:36,079 --> 00:35:38,400
for remediation would be requiring

931
00:35:38,400 --> 00:35:41,119
manager approval

932
00:35:41,119 --> 00:35:43,440
what this does is

933
00:35:43,440 --> 00:35:46,160
a user can an entity can request a

934
00:35:46,160 --> 00:35:50,000
certificate on behalf of someone else

935
00:35:50,079 --> 00:35:52,560
but when they do

936
00:35:52,560 --> 00:35:54,800
someone will need to actually go into

937
00:35:54,800 --> 00:35:57,040
the certification services

938
00:35:57,040 --> 00:35:58,800
mmc and actually say

939
00:35:58,800 --> 00:36:00,640
yes i approve the certificate to be

940
00:36:00,640 --> 00:36:02,400
created

941
00:36:02,400 --> 00:36:04,960
and uh yeah it's a you know just a nice

942
00:36:04,960 --> 00:36:07,599
little stopgap to prevent anything from

943
00:36:07,599 --> 00:36:09,280
being

944
00:36:09,280 --> 00:36:11,920
uh you know privilege escalated without

945
00:36:11,920 --> 00:36:14,480
any knowledge

946
00:36:14,480 --> 00:36:16,480
all that does

947
00:36:16,480 --> 00:36:18,160
checks the box that says ca certificate

948
00:36:18,160 --> 00:36:20,320
manager approval

949
00:36:20,320 --> 00:36:21,680
there are some other ways that you can

950
00:36:21,680 --> 00:36:23,359
resolve these the number of authorized

951
00:36:23,359 --> 00:36:25,599
signatures we can do

952
00:36:25,599 --> 00:36:27,680
changing who can enroll in in the

953
00:36:27,680 --> 00:36:29,680
certificate to make it

954
00:36:29,680 --> 00:36:33,200
you know a tighter group etc

955
00:36:33,200 --> 00:36:34,560
but

956
00:36:34,560 --> 00:36:37,280
these ones these two solutions are

957
00:36:37,280 --> 00:36:40,640
are pretty good

958
00:36:40,640 --> 00:36:41,839
so

959
00:36:41,839 --> 00:36:44,640
now we move on to the last

960
00:36:44,640 --> 00:36:47,440
misconfiguration

961
00:36:47,440 --> 00:36:50,320
so imagine we took

962
00:36:50,320 --> 00:36:53,440
misconfiguration number two

963
00:36:53,440 --> 00:36:54,640
and just assigned it to all the

964
00:36:54,640 --> 00:36:57,040
templates just said all the templates

965
00:36:57,040 --> 00:36:59,040
you can assign your own name it's fine

966
00:36:59,040 --> 00:37:01,359
well let me introduce you to

967
00:37:01,359 --> 00:37:03,119
the edit f

968
00:37:03,119 --> 00:37:06,640
attribute subject alt name to flag

969
00:37:06,640 --> 00:37:08,800
this one basically regardless of how the

970
00:37:08,800 --> 00:37:11,280
template is configured

971
00:37:11,280 --> 00:37:14,000
you are able to assign

972
00:37:14,000 --> 00:37:15,680
an alternative name

973
00:37:15,680 --> 00:37:17,599
to the template

974
00:37:17,599 --> 00:37:19,839
um

975
00:37:20,079 --> 00:37:22,800
manager approval will still take place

976
00:37:22,800 --> 00:37:24,400
so if you've got manager approval on

977
00:37:24,400 --> 00:37:26,480
your certificates cool

978
00:37:26,480 --> 00:37:29,200
unfortunately manager approval really

979
00:37:29,200 --> 00:37:31,440
impacts a lot of workflows and things

980
00:37:31,440 --> 00:37:33,520
like computer certificates and user

981
00:37:33,520 --> 00:37:35,280
certificates that are used for

982
00:37:35,280 --> 00:37:38,079
day-to-day use

983
00:37:41,040 --> 00:37:43,359
so yeah like i said previous issue much

984
00:37:43,359 --> 00:37:45,680
worse

985
00:37:47,680 --> 00:37:49,839
and much like the auditing it's

986
00:37:49,839 --> 00:37:52,720
configured on every single ca separately

987
00:37:52,720 --> 00:37:55,839
so again you've got seven cas

988
00:37:55,839 --> 00:37:58,240
six of them are configured properly that

989
00:37:58,240 --> 00:38:00,480
seventh one is not

990
00:38:00,480 --> 00:38:04,079
a quick scan through the network

991
00:38:04,079 --> 00:38:06,079
can find which ones are not configured

992
00:38:06,079 --> 00:38:07,599
properly

993
00:38:07,599 --> 00:38:08,640
and

994
00:38:08,640 --> 00:38:10,400
all of an attacker's work can be

995
00:38:10,400 --> 00:38:13,200
targeted at that misconfigured ca

996
00:38:13,200 --> 00:38:16,240
and you would never know

997
00:38:17,040 --> 00:38:18,960
thankfully this is this is pretty rare

998
00:38:18,960 --> 00:38:20,720
i've seen it in

999
00:38:20,720 --> 00:38:22,960
two environments

1000
00:38:22,960 --> 00:38:26,880
and the two that i saw it in were both

1001
00:38:26,880 --> 00:38:28,320
environments where they were in the

1002
00:38:28,320 --> 00:38:31,200
middle of moving from one pki to another

1003
00:38:31,200 --> 00:38:32,560
pki

1004
00:38:32,560 --> 00:38:36,640
so thankfully not a huge deal um in both

1005
00:38:36,640 --> 00:38:38,800
cases the solution was

1006
00:38:38,800 --> 00:38:40,480
okay we're just going to

1007
00:38:40,480 --> 00:38:42,320
speed up our our decommissioning of

1008
00:38:42,320 --> 00:38:45,119
these old old cas

1009
00:38:45,119 --> 00:38:47,680
um

1010
00:38:47,680 --> 00:38:50,079
this is what it looks like

1011
00:38:50,079 --> 00:38:54,400
it's a mess i i can't read that still so

1012
00:38:54,400 --> 00:38:56,640
um

1013
00:38:57,200 --> 00:38:59,680
how would you attack this yeah much like

1014
00:38:59,680 --> 00:39:02,160
the the rest

1015
00:39:02,160 --> 00:39:04,320
fish the user

1016
00:39:04,320 --> 00:39:06,160
if we just eliminate this part we'd

1017
00:39:06,160 --> 00:39:08,800
probably be good but

1018
00:39:08,800 --> 00:39:10,079
um

1019
00:39:10,079 --> 00:39:12,079
and then there's no real scanning

1020
00:39:12,079 --> 00:39:14,960
required by the use by the attacker it's

1021
00:39:14,960 --> 00:39:16,160
just

1022
00:39:16,160 --> 00:39:17,760
request a certificate with an

1023
00:39:17,760 --> 00:39:19,839
alternative name

1024
00:39:19,839 --> 00:39:21,839
get yourself da

1025
00:39:21,839 --> 00:39:24,560
simple as that

1026
00:39:25,040 --> 00:39:27,680
unfortunately

1027
00:39:27,680 --> 00:39:29,839
it's

1028
00:39:31,040 --> 00:39:32,000
there are

1029
00:39:32,000 --> 00:39:33,119
certain

1030
00:39:33,119 --> 00:39:34,880
environments and software

1031
00:39:34,880 --> 00:39:36,960
packages that require this to be set

1032
00:39:36,960 --> 00:39:39,280
they're very rare anymore

1033
00:39:39,280 --> 00:39:40,560
uh

1034
00:39:40,560 --> 00:39:43,280
but if you have this specific flag set

1035
00:39:43,280 --> 00:39:45,200
on all of your cas

1036
00:39:45,200 --> 00:39:47,599
disabling it it's probably going to

1037
00:39:47,599 --> 00:39:49,599
break stuff

1038
00:39:49,599 --> 00:39:53,920
so by all means you know test

1039
00:39:54,320 --> 00:39:56,480
if it's only set on a subset so you've

1040
00:39:56,480 --> 00:39:58,720
got your six that have it

1041
00:39:58,720 --> 00:40:00,560
properly set and then you know your

1042
00:40:00,560 --> 00:40:02,800
seventh has the flag set

1043
00:40:02,800 --> 00:40:04,880
you're probably going to be fine

1044
00:40:04,880 --> 00:40:06,720
to just

1045
00:40:06,720 --> 00:40:09,359
disable that flag and move on

1046
00:40:09,359 --> 00:40:11,440
but

1047
00:40:11,440 --> 00:40:13,680
again test

1048
00:40:13,680 --> 00:40:15,680
can't say that enough i i

1049
00:40:15,680 --> 00:40:17,839
you know you may have some some weird

1050
00:40:17,839 --> 00:40:19,760
configuration that i am not aware of and

1051
00:40:19,760 --> 00:40:22,400
that's totally

1052
00:40:22,839 --> 00:40:26,560
fine super easy to find this if it's set

1053
00:40:26,560 --> 00:40:28,079
uh

1054
00:40:28,079 --> 00:40:30,160
run cert util which is kind of the you

1055
00:40:30,160 --> 00:40:32,960
know swiss army knife of of old school

1056
00:40:32,960 --> 00:40:34,000
certificate

1057
00:40:34,000 --> 00:40:35,440
administration

1058
00:40:35,440 --> 00:40:36,880
if you run the specific command it'll

1059
00:40:36,880 --> 00:40:38,560
tell you exactly all the flags that are

1060
00:40:38,560 --> 00:40:41,040
set and with a description

1061
00:40:41,040 --> 00:40:42,400
unfortunately it doesn't really explain

1062
00:40:42,400 --> 00:40:44,079
a lot of what the

1063
00:40:44,079 --> 00:40:45,839
what those flags do

1064
00:40:45,839 --> 00:40:49,119
but if you see this specific flag

1065
00:40:49,119 --> 00:40:50,319
be

1066
00:40:50,319 --> 00:40:52,880
be vigilant and uh go ahead and move on

1067
00:40:52,880 --> 00:40:54,079
to

1068
00:40:54,079 --> 00:40:56,800
unsetting it

1069
00:40:56,960 --> 00:40:58,720
so

1070
00:40:58,720 --> 00:41:01,520
just need to unset that flag again uh

1071
00:41:01,520 --> 00:41:03,520
because this is just a simple command

1072
00:41:03,520 --> 00:41:04,839
simple single

1073
00:41:04,839 --> 00:41:07,520
command super easy to script

1074
00:41:07,520 --> 00:41:09,839
just need to find all your cas and unset

1075
00:41:09,839 --> 00:41:10,880
the flag

1076
00:41:10,880 --> 00:41:13,760
not a huge deal

1077
00:41:13,760 --> 00:41:14,880
so

1078
00:41:14,880 --> 00:41:17,520
that is pretty much it so

1079
00:41:17,520 --> 00:41:19,359
we're gonna we're gonna do a little wrap

1080
00:41:19,359 --> 00:41:21,839
up here

1081
00:41:23,760 --> 00:41:26,160
active directory certificate services is

1082
00:41:26,160 --> 00:41:28,400
incredibly easy to set up and

1083
00:41:28,400 --> 00:41:30,800
i'm not gonna lie it's very useful i

1084
00:41:30,800 --> 00:41:32,160
mean you know

1085
00:41:32,160 --> 00:41:34,720
if you need to do uh vpn authentication

1086
00:41:34,720 --> 00:41:36,960
or or machine authentication or smart

1087
00:41:36,960 --> 00:41:38,000
cards and

1088
00:41:38,000 --> 00:41:39,200
there's just a lot of things that it can

1089
00:41:39,200 --> 00:41:41,359
be used for

1090
00:41:41,359 --> 00:41:43,598
but

1091
00:41:43,920 --> 00:41:47,760
it is so easy to screw up right now

1092
00:41:47,760 --> 00:41:50,400
and i don't

1093
00:41:50,400 --> 00:41:52,400
with microsoft letting active directory

1094
00:41:52,400 --> 00:41:54,240
kind of die on the vine

1095
00:41:54,240 --> 00:41:57,040
i don't foresee any changes in

1096
00:41:57,040 --> 00:41:58,480
user interface

1097
00:41:58,480 --> 00:42:02,560
uh to help i don't foresee any

1098
00:42:02,560 --> 00:42:05,359
any changes in

1099
00:42:05,359 --> 00:42:07,040
you know making it harder to screw up

1100
00:42:07,040 --> 00:42:09,760
your own configurations

1101
00:42:09,760 --> 00:42:11,520
so instead let's just focus on

1102
00:42:11,520 --> 00:42:14,000
remediating things

1103
00:42:14,000 --> 00:42:15,680
like i said earlier

1104
00:42:15,680 --> 00:42:18,079
do you really need certificate services

1105
00:42:18,079 --> 00:42:20,160
in are you only using one or two

1106
00:42:20,160 --> 00:42:22,400
certificates in your entire environment

1107
00:42:22,400 --> 00:42:23,760
if so

1108
00:42:23,760 --> 00:42:26,640
outsource those you know plenty of

1109
00:42:26,640 --> 00:42:28,960
plenty of third-party pkis that you can

1110
00:42:28,960 --> 00:42:30,960
you can implement that will serve that

1111
00:42:30,960 --> 00:42:32,480
purpose for you

1112
00:42:32,480 --> 00:42:35,440
but if you're going to

1113
00:42:35,440 --> 00:42:39,680
move to a two or three tier pki

1114
00:42:39,920 --> 00:42:41,839
if you already have

1115
00:42:41,839 --> 00:42:43,760
adcs you're using it you know that you

1116
00:42:43,760 --> 00:42:45,920
need it etc

1117
00:42:45,920 --> 00:42:48,160
get your auditing enabled immediately

1118
00:42:48,160 --> 00:42:50,000
um

1119
00:42:50,000 --> 00:42:51,200
you know

1120
00:42:51,200 --> 00:42:54,400
less than probably five minutes per

1121
00:42:54,400 --> 00:42:55,680
ca to

1122
00:42:55,680 --> 00:42:58,000
to track down

1123
00:42:58,000 --> 00:42:59,520
and fix

1124
00:42:59,520 --> 00:43:00,880
um and then we're going to go ahead and

1125
00:43:00,880 --> 00:43:02,560
move on to those two that i mentioned at

1126
00:43:02,560 --> 00:43:05,119
the end those those most dangerous ones

1127
00:43:05,119 --> 00:43:07,520
should be pretty easy to fix once you do

1128
00:43:07,520 --> 00:43:08,640
that

1129
00:43:08,640 --> 00:43:10,640
you're going to be a hell of a lot

1130
00:43:10,640 --> 00:43:13,200
better off than you were

1131
00:43:13,200 --> 00:43:15,839
uh you know prior

1132
00:43:15,839 --> 00:43:17,760
and then we're going to go ahead and fix

1133
00:43:17,760 --> 00:43:19,839
up your access controls and your

1134
00:43:19,839 --> 00:43:21,119
ownership

1135
00:43:21,119 --> 00:43:22,960
once that's done

1136
00:43:22,960 --> 00:43:24,960
you're probably

1137
00:43:24,960 --> 00:43:27,839
probably good i say probably because who

1138
00:43:27,839 --> 00:43:30,078
knows

1139
00:43:30,400 --> 00:43:33,280
and this is one uh most importantly you

1140
00:43:33,280 --> 00:43:37,680
need to protect your ca hosts

1141
00:43:37,920 --> 00:43:40,880
every environment that i've seen the

1142
00:43:40,880 --> 00:43:44,560
ca hosts are just living in some generic

1143
00:43:44,560 --> 00:43:46,240
servers oh you

1144
00:43:46,240 --> 00:43:47,920
and don't really

1145
00:43:47,920 --> 00:43:49,440
you know they've got some people that

1146
00:43:49,440 --> 00:43:50,880
have permissions over them that

1147
00:43:50,880 --> 00:43:52,400
shouldn't and

1148
00:43:52,400 --> 00:43:53,760
that sort of thing

1149
00:43:53,760 --> 00:43:55,760
these are these are just as powerful as

1150
00:43:55,760 --> 00:43:57,280
your domain controllers

1151
00:43:57,280 --> 00:43:59,760
protect them like such you know

1152
00:43:59,760 --> 00:44:02,560
limit the logons to just domain admins

1153
00:44:02,560 --> 00:44:04,560
or your pki admins

1154
00:44:04,560 --> 00:44:06,079
uh

1155
00:44:06,079 --> 00:44:08,400
move it into a top level lu which limits

1156
00:44:08,400 --> 00:44:10,079
the amount of inheritance issues that

1157
00:44:10,079 --> 00:44:12,000
you may run across

1158
00:44:12,000 --> 00:44:14,160
um

1159
00:44:14,160 --> 00:44:16,560
make sure that the gpos that you assign

1160
00:44:16,560 --> 00:44:18,480
to that specific ou

1161
00:44:18,480 --> 00:44:21,200
are completely separate from your domain

1162
00:44:21,200 --> 00:44:23,599
controllers are completely separate from

1163
00:44:23,599 --> 00:44:24,880
your

1164
00:44:24,880 --> 00:44:28,480
uh domain root you know just

1165
00:44:29,680 --> 00:44:32,000
ca specific we'll say that

1166
00:44:32,000 --> 00:44:35,040
and treat your pki admins like tier zero

1167
00:44:35,040 --> 00:44:37,440
as well i would go uh far enough to say

1168
00:44:37,440 --> 00:44:38,480
that

1169
00:44:38,480 --> 00:44:41,359
your pki admins should be a completely

1170
00:44:41,359 --> 00:44:44,000
separate set of users

1171
00:44:44,000 --> 00:44:44,800
um

1172
00:44:44,800 --> 00:44:46,160
just like you've got your tiering for

1173
00:44:46,160 --> 00:44:48,000
your domain admins and your from regular

1174
00:44:48,000 --> 00:44:50,400
users you should have pki admins

1175
00:44:50,400 --> 00:44:52,240
separate from domain admin separate from

1176
00:44:52,240 --> 00:44:55,599
from regular user accounts so

1177
00:44:55,599 --> 00:44:57,839
i know it seems like a lot of work

1178
00:44:57,839 --> 00:44:59,920
to kind of bring

1179
00:44:59,920 --> 00:45:01,440
everything

1180
00:45:01,440 --> 00:45:03,280
correct and

1181
00:45:03,280 --> 00:45:04,720
i yeah

1182
00:45:04,720 --> 00:45:05,760
i i

1183
00:45:05,760 --> 00:45:08,960
often have this feeling

1184
00:45:09,520 --> 00:45:10,960
thankfully

1185
00:45:10,960 --> 00:45:13,040
already working on putting a tool

1186
00:45:13,040 --> 00:45:18,040
together called locksmith that will

1187
00:45:18,079 --> 00:45:20,560
through your environment

1188
00:45:20,560 --> 00:45:23,440
find these well-known misconfigurations

1189
00:45:23,440 --> 00:45:25,200
and then either provide you a report

1190
00:45:25,200 --> 00:45:28,960
where you can remediate them on your own

1191
00:45:29,440 --> 00:45:34,400
uh or provide you the code so you can

1192
00:45:34,400 --> 00:45:35,599
you know

1193
00:45:35,599 --> 00:45:39,440
fix it specifically for your environment

1194
00:45:39,520 --> 00:45:41,520
or

1195
00:45:41,520 --> 00:45:44,640
just fix it just easy button boom

1196
00:45:44,640 --> 00:45:47,839
we'll do that

1197
00:45:47,920 --> 00:45:50,240
and if you would like to help out

1198
00:45:50,240 --> 00:45:53,920
with coding locksmith uh by all means go

1199
00:45:53,920 --> 00:45:56,400
visit my github

1200
00:45:56,400 --> 00:45:57,920
the code snippets that we that i showed

1201
00:45:57,920 --> 00:46:01,280
you will all be available there so you

1202
00:46:01,280 --> 00:46:03,680
can start uh you know

1203
00:46:03,680 --> 00:46:06,079
start auditing your own environment

1204
00:46:06,079 --> 00:46:08,400
um and then locksmith currently has a

1205
00:46:08,400 --> 00:46:09,520
readme

1206
00:46:09,520 --> 00:46:11,760
markdown file uh so you know got a

1207
00:46:11,760 --> 00:46:14,960
little work to go on there

1208
00:46:14,960 --> 00:46:18,480
and then feel free to email me i

1209
00:46:18,480 --> 00:46:20,720
love to talk ad security

1210
00:46:20,720 --> 00:46:22,480
and

1211
00:46:22,480 --> 00:46:24,000
love to assess your id if you really

1212
00:46:24,000 --> 00:46:26,000
want me to

1213
00:46:26,000 --> 00:46:27,760
and then probably the best way to get

1214
00:46:27,760 --> 00:46:29,760
hold of me honestly is twitter so there

1215
00:46:29,760 --> 00:46:31,920
i am dot dot horse

1216
00:46:31,920 --> 00:46:34,720
and uh yeah it's very weird but

1217
00:46:34,720 --> 00:46:36,960
a little bit of infosec fun

1218
00:46:36,960 --> 00:46:38,640
and i'd love to connect with you on

1219
00:46:38,640 --> 00:46:41,839
linkedin as well but probably won't get

1220
00:46:41,839 --> 00:46:44,560
to a free few days

1221
00:46:44,560 --> 00:46:45,839
and

1222
00:46:45,839 --> 00:46:48,160
last of all i just want to say thanks to

1223
00:46:48,160 --> 00:46:50,000
will schrader and lee christensen and

1224
00:46:50,000 --> 00:46:53,119
and the rest of the the pki wizards that

1225
00:46:53,119 --> 00:46:54,400
have

1226
00:46:54,400 --> 00:46:56,079
provided the shoulders for me to stand

1227
00:46:56,079 --> 00:46:57,119
on

1228
00:46:57,119 --> 00:46:58,880
i wouldn't know any of this stuff

1229
00:46:58,880 --> 00:47:00,000
without them

1230
00:47:00,000 --> 00:47:01,200
um

1231
00:47:01,200 --> 00:47:03,760
another thanks to sean metcalf and

1232
00:47:03,760 --> 00:47:05,760
brandon colley who reviewed all of my

1233
00:47:05,760 --> 00:47:07,920
slides and made sure that my

1234
00:47:07,920 --> 00:47:10,640
presentation flowed correctly

1235
00:47:10,640 --> 00:47:13,359
and rest of the trimark team

1236
00:47:13,359 --> 00:47:15,450
we got tyler and daryl over there

1237
00:47:15,450 --> 00:47:16,720
[Laughter]

1238
00:47:16,720 --> 00:47:19,119
and actually everybody in trimark is

1239
00:47:19,119 --> 00:47:22,079
super supportive and everybody helped me

1240
00:47:22,079 --> 00:47:23,920
out with my dress rehearsal and then of

1241
00:47:23,920 --> 00:47:27,119
course my wife for listening to me and

1242
00:47:27,119 --> 00:47:28,720
my daughter because she actually helped

1243
00:47:28,720 --> 00:47:32,000
me come up with that um

1244
00:47:32,000 --> 00:47:34,240
the explanation with bella or melon and

1245
00:47:34,240 --> 00:47:38,400
benny so yeah many thanks to her

1246
00:47:38,400 --> 00:47:40,880
and you know resources for if you want

1247
00:47:40,880 --> 00:47:42,880
to dig in a little deeper i highly

1248
00:47:42,880 --> 00:47:45,599
recommend reading certified pre-owned it

1249
00:47:45,599 --> 00:47:50,319
is it is dense but it will

1250
00:47:50,319 --> 00:47:52,640
change your certificate services world i

1251
00:47:52,640 --> 00:47:54,960
don't know

1252
00:47:55,119 --> 00:47:57,440
that's all we got

1253
00:47:57,440 --> 00:47:59,600
any questions

1254
00:47:59,600 --> 00:48:05,699
[Applause]

1255
00:48:06,100 --> 00:48:09,250
[Music]

1256
00:48:18,160 --> 00:48:19,440
say that again i didn't hear the

1257
00:48:19,440 --> 00:48:22,000
beginning of it

1258
00:48:26,800 --> 00:48:29,800
okay

1259
00:48:34,000 --> 00:48:35,680
i haven't dug into that at all i must

1260
00:48:35,680 --> 00:48:37,919
admit

1261
00:48:38,240 --> 00:48:40,799
anybody else

1262
00:48:42,319 --> 00:48:43,280
no

1263
00:48:43,280 --> 00:48:45,359
okay

1264
00:48:45,359 --> 00:48:47,420
i'm out

1265
00:48:47,420 --> 00:48:54,160
[Applause]

1266
00:48:54,160 --> 00:48:56,240
you

