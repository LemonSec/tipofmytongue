1
00:00:05,759 --> 00:00:08,320
hello everyone thank you for joining us

2
00:00:08,320 --> 00:00:11,440
at b-sides tampa 2022

3
00:00:11,440 --> 00:00:13,519
i am excited to introduce our next

4
00:00:13,519 --> 00:00:15,920
speaker christopher peacock he will be

5
00:00:15,920 --> 00:00:18,400
giving a presentation on the process of

6
00:00:18,400 --> 00:00:20,800
detection engineering here's just a few

7
00:00:20,800 --> 00:00:22,800
of his many experiences

8
00:00:22,800 --> 00:00:25,680
cyber threat intelligence analyst cyber

9
00:00:25,680 --> 00:00:29,279
threat hunter tier three sock analyst

10
00:00:29,279 --> 00:00:31,199
incident responser

11
00:00:31,199 --> 00:00:32,880
he also has experience in multiple

12
00:00:32,880 --> 00:00:36,320
industries and energy finance health

13
00:00:36,320 --> 00:00:38,800
corp healthcare technology and defense

14
00:00:38,800 --> 00:00:43,480
please welcome christopher peacock

15
00:00:44,960 --> 00:00:46,719
thank you for that introduction really

16
00:00:46,719 --> 00:00:49,520
appreciate it thank y'all for being here

17
00:00:49,520 --> 00:00:51,520
let's see if we got slides up okay there

18
00:00:51,520 --> 00:00:52,879
we go thank you all again for getting

19
00:00:52,879 --> 00:00:54,480
that set up

20
00:00:54,480 --> 00:00:56,800
really doing a great job today guys um

21
00:00:56,800 --> 00:00:58,719
so the process of detection engineering

22
00:00:58,719 --> 00:01:01,440
first off who am i i'm christopher

23
00:01:01,440 --> 00:01:05,280
peacock i started my journey at alpha 2

24
00:01:05,280 --> 00:01:06,560
where i did

25
00:01:06,560 --> 00:01:09,600
help desk network administration system

26
00:01:09,600 --> 00:01:12,080
administration that whole jazz i worked

27
00:01:12,080 --> 00:01:14,080
up i went to general dynamics where i

28
00:01:14,080 --> 00:01:16,400
started working um

29
00:01:16,400 --> 00:01:19,360
as a sock analyst and conducting purple

30
00:01:19,360 --> 00:01:20,720
team back in that time you know

31
00:01:20,720 --> 00:01:22,640
powershell was just coming out as

32
00:01:22,640 --> 00:01:24,320
something that was like really

33
00:01:24,320 --> 00:01:27,439
used by pin testers and also adversaries

34
00:01:27,439 --> 00:01:29,280
but we didn't really have edr's yet so

35
00:01:29,280 --> 00:01:31,040
it was how to you know go out and enable

36
00:01:31,040 --> 00:01:33,280
the powershell logging around that uh

37
00:01:33,280 --> 00:01:34,640
from there i went to raytheon where i

38
00:01:34,640 --> 00:01:36,799
did intelligence i did incident

39
00:01:36,799 --> 00:01:39,280
responder sock 3

40
00:01:39,280 --> 00:01:41,439
led the threat hunt team which is now

41
00:01:41,439 --> 00:01:43,520
more kind of what has become detection

42
00:01:43,520 --> 00:01:46,159
engineering right we've the threat hunts

43
00:01:46,159 --> 00:01:47,520
at the end of the day you end up with a

44
00:01:47,520 --> 00:01:49,680
query that you can actually deploy as an

45
00:01:49,680 --> 00:01:51,520
alert so it's kind of like an automated

46
00:01:51,520 --> 00:01:53,040
threat hunting or detection engineering

47
00:01:53,040 --> 00:01:54,799
however you want to label it multiple

48
00:01:54,799 --> 00:01:57,200
ways to call it but that's what it is

49
00:01:57,200 --> 00:01:59,119
and then now i'm at scythe where i do

50
00:01:59,119 --> 00:02:00,880
adversary emulation and detection

51
00:02:00,880 --> 00:02:02,799
engineering so that's actually going out

52
00:02:02,799 --> 00:02:04,479
finding what bad guys are doing

53
00:02:04,479 --> 00:02:06,079
extracting

54
00:02:06,079 --> 00:02:08,160
those procedures you know we're getting

55
00:02:08,160 --> 00:02:10,239
down to procedure level in the ttp

56
00:02:10,239 --> 00:02:12,959
phrase uh and then we work on doing

57
00:02:12,959 --> 00:02:15,120
detection engineering so we map those to

58
00:02:15,120 --> 00:02:16,400
sigma so that you can deploy them

59
00:02:16,400 --> 00:02:18,879
wherever you need to or we create sigma

60
00:02:18,879 --> 00:02:21,120
rules and contribute that uh to the

61
00:02:21,120 --> 00:02:23,200
community

62
00:02:23,200 --> 00:02:23,920
so

63
00:02:23,920 --> 00:02:26,080
one of the goals of this is to find

64
00:02:26,080 --> 00:02:28,640
suspicious activity and one of the areas

65
00:02:28,640 --> 00:02:30,800
that we like to focus on is post

66
00:02:30,800 --> 00:02:33,120
delivery you know reconnaissance that's

67
00:02:33,120 --> 00:02:34,879
where someone's scanning

68
00:02:34,879 --> 00:02:36,560
things like that you're not going to get

69
00:02:36,560 --> 00:02:38,640
really good return on investment there

70
00:02:38,640 --> 00:02:40,879
delivery and exploitation we're really

71
00:02:40,879 --> 00:02:43,200
uh relying on our vendors you know we're

72
00:02:43,200 --> 00:02:45,760
relying on our firewall our waff

73
00:02:45,760 --> 00:02:47,920
relying on

74
00:02:47,920 --> 00:02:50,000
the email gateway things like that and

75
00:02:50,000 --> 00:02:51,760
then once we get to installation and

76
00:02:51,760 --> 00:02:53,599
command and control actions on

77
00:02:53,599 --> 00:02:55,120
objectives that's where we want to catch

78
00:02:55,120 --> 00:02:57,840
them before impact you know ransomware

79
00:02:57,840 --> 00:02:59,599
isn't click and spread everywhere that

80
00:02:59,599 --> 00:03:01,680
was one of cry that happened once

81
00:03:01,680 --> 00:03:03,280
but most of the time they're actually

82
00:03:03,280 --> 00:03:04,879
going through a whole

83
00:03:04,879 --> 00:03:06,720
chain attack chain in the environment

84
00:03:06,720 --> 00:03:07,920
and you can actually catch them pretty

85
00:03:07,920 --> 00:03:09,840
early before they get to impact so

86
00:03:09,840 --> 00:03:11,360
that's what we're about we're about

87
00:03:11,360 --> 00:03:13,280
catching those adversaries early before

88
00:03:13,280 --> 00:03:14,959
impact

89
00:03:14,959 --> 00:03:18,159
what are the strategic drivers of this

90
00:03:18,159 --> 00:03:20,319
so when we look across the strategic

91
00:03:20,319 --> 00:03:22,959
drivers of this we have two of the

92
00:03:22,959 --> 00:03:24,400
foundation

93
00:03:24,400 --> 00:03:25,280
uh

94
00:03:25,280 --> 00:03:27,440
which makes the base here so we have the

95
00:03:27,440 --> 00:03:30,959
operational uh capability or capacity

96
00:03:30,959 --> 00:03:33,120
and that's you know how the analyst can

97
00:03:33,120 --> 00:03:34,879
work with the data and then we have the

98
00:03:34,879 --> 00:03:36,879
data collection so those two things are

99
00:03:36,879 --> 00:03:38,159
the foundation

100
00:03:38,159 --> 00:03:40,480
but then when we add threat

101
00:03:40,480 --> 00:03:42,799
understanding to it that's what involves

102
00:03:42,799 --> 00:03:45,440
us into being a threat informed threat

103
00:03:45,440 --> 00:03:48,560
hunter or detection engineer

104
00:03:48,560 --> 00:03:49,840
so with data collection we need to

105
00:03:49,840 --> 00:03:52,319
understand what data are we collecting

106
00:03:52,319 --> 00:03:54,000
and then from there we can you know

107
00:03:54,000 --> 00:03:55,920
figure out where we can do analysis on

108
00:03:55,920 --> 00:03:57,920
if we don't connect or if we don't

109
00:03:57,920 --> 00:03:59,840
collect name pipe then we're not going

110
00:03:59,840 --> 00:04:01,920
to be able to do detections around that

111
00:04:01,920 --> 00:04:03,680
we have to understand our gaps and what

112
00:04:03,680 --> 00:04:05,680
we're collecting

113
00:04:05,680 --> 00:04:07,680
and then finally where is it collected

114
00:04:07,680 --> 00:04:10,959
oftentimes with an edr you have the data

115
00:04:10,959 --> 00:04:12,720
in the edr and it might only send alerts

116
00:04:12,720 --> 00:04:14,640
to the sim and the sims when they get in

117
00:04:14,640 --> 00:04:16,478
alerts so you can't do your detection

118
00:04:16,478 --> 00:04:17,839
engineering in the sim you have to go to

119
00:04:17,839 --> 00:04:20,959
the edr so we have to understand that

120
00:04:20,959 --> 00:04:22,639
and then finally we need to know how we

121
00:04:22,639 --> 00:04:24,479
prioritize our data

122
00:04:24,479 --> 00:04:26,880
so one way we can prioritize our data is

123
00:04:26,880 --> 00:04:28,560
actually understanding

124
00:04:28,560 --> 00:04:30,960
what data sources are applicable to the

125
00:04:30,960 --> 00:04:33,120
most techniques and sub techniques so

126
00:04:33,120 --> 00:04:35,280
here we see command execution process

127
00:04:35,280 --> 00:04:38,240
creation file modification those are all

128
00:04:38,240 --> 00:04:39,600
very important

129
00:04:39,600 --> 00:04:43,840
data sources to cover the attack matrix

130
00:04:44,160 --> 00:04:45,680
and then the other one is the

131
00:04:45,680 --> 00:04:47,680
operational capacity and this is just

132
00:04:47,680 --> 00:04:49,280
understanding that

133
00:04:49,280 --> 00:04:50,720
we need good tools and we need good

134
00:04:50,720 --> 00:04:52,720
analysts to work together that's really

135
00:04:52,720 --> 00:04:55,600
what it's about if you have a tool or

136
00:04:55,600 --> 00:04:57,280
it's spread across multiple tools it's

137
00:04:57,280 --> 00:04:58,960
going to slow your analysts down the

138
00:04:58,960 --> 00:05:00,960
other thing to take into consideration

139
00:05:00,960 --> 00:05:02,800
is the time factor and that's the thing

140
00:05:02,800 --> 00:05:04,800
is when we have inefficient tools or it

141
00:05:04,800 --> 00:05:06,880
takes too long for us to run queries

142
00:05:06,880 --> 00:05:08,479
it's going to slow us down as detection

143
00:05:08,479 --> 00:05:11,600
engineers or threat hunters

144
00:05:11,600 --> 00:05:12,800
and then finally we have threat

145
00:05:12,800 --> 00:05:14,000
understanding

146
00:05:14,000 --> 00:05:16,000
and this is where that cti bit comes in

147
00:05:16,000 --> 00:05:18,800
of knowing what goes um what's going on

148
00:05:18,800 --> 00:05:20,800
in the threat landscape what actors are

149
00:05:20,800 --> 00:05:23,600
doing against us our org if i'm uh

150
00:05:23,600 --> 00:05:25,199
elementary school i don't really care

151
00:05:25,199 --> 00:05:26,880
what north korea is doing to south korea

152
00:05:26,880 --> 00:05:28,639
that's not my threat profile i need to

153
00:05:28,639 --> 00:05:30,320
go out and study what ransomware actors

154
00:05:30,320 --> 00:05:31,919
are doing and then we want to focus on

155
00:05:31,919 --> 00:05:33,759
the procedure we don't want to focus on

156
00:05:33,759 --> 00:05:35,840
the technique level because if someone

157
00:05:35,840 --> 00:05:38,479
tells me that they dumped lsas i don't

158
00:05:38,479 --> 00:05:40,560
know how they dumped l-sas so i can go

159
00:05:40,560 --> 00:05:42,880
out and i can grab an atomic red team

160
00:05:42,880 --> 00:05:44,560
test which is great

161
00:05:44,560 --> 00:05:46,000
but i don't know if that actually aligns

162
00:05:46,000 --> 00:05:47,600
with what my adversaries are doing at

163
00:05:47,600 --> 00:05:48,960
the time

164
00:05:48,960 --> 00:05:50,800
and then we also don't want to focus on

165
00:05:50,800 --> 00:05:53,280
iocs or threat feeds because these

166
00:05:53,280 --> 00:05:56,720
change very often

167
00:05:56,720 --> 00:05:58,240
so the process looks something like this

168
00:05:58,240 --> 00:06:00,479
where we get direction from the cti we

169
00:06:00,479 --> 00:06:02,800
know what's happening in our space we do

170
00:06:02,800 --> 00:06:04,560
our collection

171
00:06:04,560 --> 00:06:06,880
after our direction also direction

172
00:06:06,880 --> 00:06:09,840
hopefully includes some sort of purple

173
00:06:09,840 --> 00:06:12,720
team exercise uh so that you actually

174
00:06:12,720 --> 00:06:15,039
have those um that data in your

175
00:06:15,039 --> 00:06:16,800
production environment you want to see

176
00:06:16,800 --> 00:06:17,840
what it would look like in your

177
00:06:17,840 --> 00:06:20,240
environment so that you can also test do

178
00:06:20,240 --> 00:06:22,319
we have alerts around it or do we not

179
00:06:22,319 --> 00:06:23,919
and then we do our collection and then

180
00:06:23,919 --> 00:06:25,360
our processing and finally we

181
00:06:25,360 --> 00:06:27,360
disseminate it back out to sock and our

182
00:06:27,360 --> 00:06:29,520
stakeholders

183
00:06:29,520 --> 00:06:31,600
so cyber threat intelligence this is a

184
00:06:31,600 --> 00:06:33,440
big area i've heard multiple times

185
00:06:33,440 --> 00:06:35,840
people say i pipe my threat intelligence

186
00:06:35,840 --> 00:06:38,319
right into my sim i'm like really

187
00:06:38,319 --> 00:06:41,039
because threat intelligence is very hard

188
00:06:41,039 --> 00:06:44,160
um so one thing to think about is iocs

189
00:06:44,160 --> 00:06:46,080
are not threat intelligence what we're

190
00:06:46,080 --> 00:06:47,600
talking about with threat intelligence

191
00:06:47,600 --> 00:06:49,199
is actually understanding who's going to

192
00:06:49,199 --> 00:06:51,759
attack us who's in our threat landscape

193
00:06:51,759 --> 00:06:53,280
and then what those threat actors are

194
00:06:53,280 --> 00:06:56,560
doing at a procedure level okay

195
00:06:56,560 --> 00:06:58,000
and why we do this is because the

196
00:06:58,000 --> 00:07:00,080
procedures that are ran

197
00:07:00,080 --> 00:07:02,000
adversaries have habits they have

198
00:07:02,000 --> 00:07:04,960
training they have tools they also um

199
00:07:04,960 --> 00:07:06,400
have guides if you haven't seen the

200
00:07:06,400 --> 00:07:08,800
kanti playbook literally it tells them

201
00:07:08,800 --> 00:07:11,280
step by step of what to run and like

202
00:07:11,280 --> 00:07:12,800
every time there's a conte incident

203
00:07:12,800 --> 00:07:14,880
they're doing nl tests net all these

204
00:07:14,880 --> 00:07:16,160
different stuff so you can catch them

205
00:07:16,160 --> 00:07:18,319
early um but yeah you can check out the

206
00:07:18,319 --> 00:07:19,840
guide it's awesome

207
00:07:19,840 --> 00:07:21,039
just from

208
00:07:21,039 --> 00:07:21,840
an

209
00:07:21,840 --> 00:07:23,599
intel standpoint to actually see it and

210
00:07:23,599 --> 00:07:25,360
lining up with things like the d4 report

211
00:07:25,360 --> 00:07:26,560
which is a great

212
00:07:26,560 --> 00:07:30,120
resource to have

213
00:07:30,720 --> 00:07:34,720
and i think i went out of there we go

214
00:07:34,960 --> 00:07:37,440
so direction we have that cti we

215
00:07:37,440 --> 00:07:38,960
understand what our adversaries are

216
00:07:38,960 --> 00:07:40,960
doing at a procedure level and then we

217
00:07:40,960 --> 00:07:43,599
say do i have detections already because

218
00:07:43,599 --> 00:07:45,120
we need to actually emulate those

219
00:07:45,120 --> 00:07:46,800
procedures so we can see if we have

220
00:07:46,800 --> 00:07:48,319
detections or not

221
00:07:48,319 --> 00:07:50,080
and then from there

222
00:07:50,080 --> 00:07:51,680
we need to figure out

223
00:07:51,680 --> 00:07:53,759
how to catch it but first we'll go ahead

224
00:07:53,759 --> 00:07:55,599
and run it so in this example we'll go

225
00:07:55,599 --> 00:07:57,440
ahead and run the procedure and see if

226
00:07:57,440 --> 00:07:59,039
we catch it or not and that's how we get

227
00:07:59,039 --> 00:08:00,400
direction is actually running those

228
00:08:00,400 --> 00:08:02,319
procedures

229
00:08:02,319 --> 00:08:03,599
and this is what it looks like at the

230
00:08:03,599 --> 00:08:06,000
end for the direction side where we've

231
00:08:06,000 --> 00:08:07,440
put together a plan

232
00:08:07,440 --> 00:08:08,879
of what the adversary is doing at

233
00:08:08,879 --> 00:08:10,879
procedures level we've mapped it to

234
00:08:10,879 --> 00:08:13,440
alerts and then we see where we have uh

235
00:08:13,440 --> 00:08:15,840
alerting gaps as well so that we can

236
00:08:15,840 --> 00:08:19,199
work on doing engineering around those

237
00:08:19,199 --> 00:08:22,000
next we have collection

238
00:08:22,000 --> 00:08:24,800
so with collection we want to go ahead

239
00:08:24,800 --> 00:08:27,199
and start seeing what we have in our

240
00:08:27,199 --> 00:08:29,360
events we want to see what's actually in

241
00:08:29,360 --> 00:08:31,280
our data sources

242
00:08:31,280 --> 00:08:32,719
and with this

243
00:08:32,719 --> 00:08:35,360
we can go and we can leverage detect to

244
00:08:35,360 --> 00:08:37,360
actually map out our data sources to see

245
00:08:37,360 --> 00:08:39,200
where the detections might be

246
00:08:39,200 --> 00:08:40,880
and then we also want to identify and

247
00:08:40,880 --> 00:08:43,440
catalog any visibility gaps so like i

248
00:08:43,440 --> 00:08:45,279
said before lots of edr's they won't

249
00:08:45,279 --> 00:08:47,600
actually log the

250
00:08:47,600 --> 00:08:50,240
pipe names creation so you can't do

251
00:08:50,240 --> 00:08:52,320
certain detections around that

252
00:08:52,320 --> 00:08:53,440
and as we look and we start

253
00:08:53,440 --> 00:08:54,800
understanding the data we can start

254
00:08:54,800 --> 00:08:57,760
hypothesizing

255
00:08:58,399 --> 00:09:00,640
so here this is one way that we can map

256
00:09:00,640 --> 00:09:02,560
this if you're new to it

257
00:09:02,560 --> 00:09:04,240
where you go to the miter attack page

258
00:09:04,240 --> 00:09:05,920
and we see that power shell it's going

259
00:09:05,920 --> 00:09:07,839
to have they call these detections but

260
00:09:07,839 --> 00:09:09,920
it's really like log sources so we see

261
00:09:09,920 --> 00:09:11,680
that there's a source of process and we

262
00:09:11,680 --> 00:09:13,839
see that there's a component of process

263
00:09:13,839 --> 00:09:15,120
creation

264
00:09:15,120 --> 00:09:16,399
and so you can go to any of the

265
00:09:16,399 --> 00:09:17,920
technique pages once you have your

266
00:09:17,920 --> 00:09:19,680
procedure you map that procedure to the

267
00:09:19,680 --> 00:09:21,279
technique and you can figure out your

268
00:09:21,279 --> 00:09:22,959
data sources needed

269
00:09:22,959 --> 00:09:25,839
the problem is is attack ends here and

270
00:09:25,839 --> 00:09:28,160
you have to figure out what your actual

271
00:09:28,160 --> 00:09:30,959
event logs are in your environment

272
00:09:30,959 --> 00:09:32,560
and the way you do that is you leverage

273
00:09:32,560 --> 00:09:33,839
detect

274
00:09:33,839 --> 00:09:36,240
so with detect you can add your data

275
00:09:36,240 --> 00:09:38,160
sources in so here we have process

276
00:09:38,160 --> 00:09:40,480
creation and i can see my products of

277
00:09:40,480 --> 00:09:42,560
where that actually resides and then i

278
00:09:42,560 --> 00:09:46,240
can quantify my data quality in there

279
00:09:46,240 --> 00:09:48,000
and this is what it looks like you know

280
00:09:48,000 --> 00:09:51,040
cisos like love this type of overview it

281
00:09:51,040 --> 00:09:53,440
shows actually where

282
00:09:53,440 --> 00:09:56,399
we have visibility into certain data

283
00:09:56,399 --> 00:09:58,720
collections this isn't to be construed

284
00:09:58,720 --> 00:10:00,880
as actual coverage from an alerting

285
00:10:00,880 --> 00:10:03,200
standpoint or a response standpoint but

286
00:10:03,200 --> 00:10:04,560
this is actually a good way to show

287
00:10:04,560 --> 00:10:06,240
where we have detect

288
00:10:06,240 --> 00:10:09,680
not detection gaps with logging gaps

289
00:10:09,680 --> 00:10:12,160
so hypothesizing this is where we've

290
00:10:12,160 --> 00:10:15,360
started analyzing our data

291
00:10:15,360 --> 00:10:17,040
and we need to look at ways

292
00:10:17,040 --> 00:10:19,279
of doing

293
00:10:19,279 --> 00:10:22,160
the actual alert engineering

294
00:10:22,160 --> 00:10:23,120
so

295
00:10:23,120 --> 00:10:26,079
we start out we cast a wide net because

296
00:10:26,079 --> 00:10:27,519
we want to get as much malicious

297
00:10:27,519 --> 00:10:30,079
activity that we can and then we start

298
00:10:30,079 --> 00:10:32,800
tuning that out and then we narrow it

299
00:10:32,800 --> 00:10:35,360
down and we want limited false positives

300
00:10:35,360 --> 00:10:38,240
if we deploy a lot of false positives

301
00:10:38,240 --> 00:10:39,680
then we're going to be in trouble our

302
00:10:39,680 --> 00:10:40,880
sock's not going to be able to actually

303
00:10:40,880 --> 00:10:42,560
respond to that alert

304
00:10:42,560 --> 00:10:44,399
and then from there we also want to

305
00:10:44,399 --> 00:10:46,000
embrace so that we're going to have a

306
00:10:46,000 --> 00:10:47,920
few false positives because a lot of

307
00:10:47,920 --> 00:10:50,160
what we're looking at is looking at

308
00:10:50,160 --> 00:10:52,160
living off the land techniques which are

309
00:10:52,160 --> 00:10:54,800
using things built into windows

310
00:10:54,800 --> 00:10:56,880
so we want to find suspicious activity

311
00:10:56,880 --> 00:10:58,640
and it might get flagged

312
00:10:58,640 --> 00:10:59,839
by

313
00:10:59,839 --> 00:11:01,440
a system administrator or something like

314
00:11:01,440 --> 00:11:03,440
that

315
00:11:03,440 --> 00:11:05,600
so developing a hypothesis kind of looks

316
00:11:05,600 --> 00:11:08,000
like this where we actually have uh

317
00:11:08,000 --> 00:11:10,240
microsoft delivers threat actor uh

318
00:11:10,240 --> 00:11:11,440
targeting

319
00:11:11,440 --> 00:11:14,800
solarwinds with a zero-day exploit

320
00:11:14,800 --> 00:11:16,240
so with this

321
00:11:16,240 --> 00:11:18,880
we see that we have the mshta

322
00:11:18,880 --> 00:11:21,760
application making a call out

323
00:11:21,760 --> 00:11:24,000
to a public ip address so we can start

324
00:11:24,000 --> 00:11:27,120
saying if we know what mshta does in our

325
00:11:27,120 --> 00:11:29,360
environment does it normally connect

326
00:11:29,360 --> 00:11:30,880
outbound or not

327
00:11:30,880 --> 00:11:32,480
so we can start thinking about is that a

328
00:11:32,480 --> 00:11:34,560
detection opportunity

329
00:11:34,560 --> 00:11:37,040
we also see who am i execution

330
00:11:37,040 --> 00:11:37,760
so

331
00:11:37,760 --> 00:11:39,200
we can start thinking like do we need to

332
00:11:39,200 --> 00:11:41,440
catch that we also see a couple things

333
00:11:41,440 --> 00:11:44,079
that we'll go over when of how we ask

334
00:11:44,079 --> 00:11:45,839
more questions to start developing our

335
00:11:45,839 --> 00:11:49,760
hypothesis or our search query

336
00:11:49,760 --> 00:11:51,600
so one of the things we want to consider

337
00:11:51,600 --> 00:11:53,120
is when we're looking at a procedure is

338
00:11:53,120 --> 00:11:56,560
what is the procedure doing

339
00:11:56,560 --> 00:11:58,800
and how is it made or what makes it

340
00:11:58,800 --> 00:12:00,480
malicious how is it used maliciously

341
00:12:00,480 --> 00:12:01,920
what's the threat actor really doing

342
00:12:01,920 --> 00:12:03,120
here

343
00:12:03,120 --> 00:12:04,639
so what that looks like here is we see

344
00:12:04,639 --> 00:12:07,839
that command prompt is launching who am

345
00:12:07,839 --> 00:12:09,680
i

346
00:12:09,680 --> 00:12:11,360
they're enumerating what they're running

347
00:12:11,360 --> 00:12:13,519
as and then they're piping it out to a

348
00:12:13,519 --> 00:12:14,800
text file

349
00:12:14,800 --> 00:12:16,399
so now we know what the adversary is

350
00:12:16,399 --> 00:12:19,519
doing and then we can say well you know

351
00:12:19,519 --> 00:12:20,959
what do what do our system

352
00:12:20,959 --> 00:12:22,880
administrators do or what does our help

353
00:12:22,880 --> 00:12:25,279
desk do is our helped us actually pipe

354
00:12:25,279 --> 00:12:28,000
out who am i to a text file and we can

355
00:12:28,000 --> 00:12:29,120
start thinking about ways of

356
00:12:29,120 --> 00:12:32,560
hypothesizing around that

357
00:12:34,560 --> 00:12:35,920
and then the other thing is when we

358
00:12:35,920 --> 00:12:38,079
start hypothesizing we look at how often

359
00:12:38,079 --> 00:12:40,399
does this happen in normal operations

360
00:12:40,399 --> 00:12:44,079
so in my environment how often does cmd

361
00:12:44,079 --> 00:12:45,839
launch who am i

362
00:12:45,839 --> 00:12:47,760
or like we said before how often are

363
00:12:47,760 --> 00:12:49,519
they actually piping it out that

364
00:12:49,519 --> 00:12:51,519
redirector is not very common for who am

365
00:12:51,519 --> 00:12:53,839
i in most environments

366
00:12:53,839 --> 00:12:56,079
if we're at a small company you know a

367
00:12:56,079 --> 00:12:58,560
few hundred workstations no one may even

368
00:12:58,560 --> 00:13:00,560
use who am i so that's another thing to

369
00:13:00,560 --> 00:13:02,399
consider as well so these are just

370
00:13:02,399 --> 00:13:03,519
things that we're starting to try to

371
00:13:03,519 --> 00:13:06,240
baseline in our environment

372
00:13:06,240 --> 00:13:08,320
and then we look at are there parent

373
00:13:08,320 --> 00:13:10,000
processes

374
00:13:10,000 --> 00:13:12,800
so when we look at the cmd process chain

375
00:13:12,800 --> 00:13:14,880
that spawns off we can look at what

376
00:13:14,880 --> 00:13:17,120
actually started this process

377
00:13:17,120 --> 00:13:19,200
and once we understand what starts this

378
00:13:19,200 --> 00:13:21,200
process in our environment we can tune

379
00:13:21,200 --> 00:13:22,959
it out potentially

380
00:13:22,959 --> 00:13:24,880
or we can look at how often does cmd

381
00:13:24,880 --> 00:13:27,600
launch who am i you know maybe who am i

382
00:13:27,600 --> 00:13:29,360
my environment launches but it only

383
00:13:29,360 --> 00:13:31,360
launches from a

384
00:13:31,360 --> 00:13:33,040
you know a different process so i just

385
00:13:33,040 --> 00:13:35,120
tune that out and i flag on any who am i

386
00:13:35,120 --> 00:13:36,800
execution because that's one of the

387
00:13:36,800 --> 00:13:38,320
first things attackers do when they get

388
00:13:38,320 --> 00:13:40,079
on host they want to know who they're

389
00:13:40,079 --> 00:13:42,880
operating as

390
00:13:43,279 --> 00:13:44,880
and then we can also look at are there

391
00:13:44,880 --> 00:13:47,920
common child processes so what we have

392
00:13:47,920 --> 00:13:50,000
here is just a common parent-child

393
00:13:50,000 --> 00:13:52,000
relationship well not a common but a

394
00:13:52,000 --> 00:13:53,920
commonly malicious one

395
00:13:53,920 --> 00:13:56,639
uh where one word is spawning command so

396
00:13:56,639 --> 00:13:58,639
that's one that we can tune into we can

397
00:13:58,639 --> 00:14:00,959
look for you know rare processes coming

398
00:14:00,959 --> 00:14:03,120
off of one word that attackers are using

399
00:14:03,120 --> 00:14:05,680
such as command prompt or power shell or

400
00:14:05,680 --> 00:14:07,920
run dll things like this we also see

401
00:14:07,920 --> 00:14:11,040
excel spawning run dll32 so these are

402
00:14:11,040 --> 00:14:12,639
things that we can start looking to as

403
00:14:12,639 --> 00:14:14,079
we do threat hunting and detection

404
00:14:14,079 --> 00:14:16,399
engineering is what are the child

405
00:14:16,399 --> 00:14:20,000
processes that i can tune into or out of

406
00:14:20,000 --> 00:14:21,600
uh if you want to catch you know an

407
00:14:21,600 --> 00:14:24,000
apache zero day like

408
00:14:24,000 --> 00:14:25,040
probably

409
00:14:25,040 --> 00:14:28,160
nine times out of ten the apache exe

410
00:14:28,160 --> 00:14:30,079
process is going to have some sort of

411
00:14:30,079 --> 00:14:32,240
scripting interpreter off of it such as

412
00:14:32,240 --> 00:14:34,160
power shell spawning off that apache

413
00:14:34,160 --> 00:14:36,000
process because the attacker needs to

414
00:14:36,000 --> 00:14:38,800
run commands

415
00:14:39,279 --> 00:14:41,360
so the other thing we need to look at is

416
00:14:41,360 --> 00:14:43,680
command line parameters often when we're

417
00:14:43,680 --> 00:14:45,920
trying to do tuning we're looking at a

418
00:14:45,920 --> 00:14:48,079
certain process that's used across the

419
00:14:48,079 --> 00:14:50,079
network because it's living off the land

420
00:14:50,079 --> 00:14:52,399
uh binaries and scripts and if you're

421
00:14:52,399 --> 00:14:54,320
unfamiliar with that that's just common

422
00:14:54,320 --> 00:14:56,320
applications that are built in to

423
00:14:56,320 --> 00:14:59,040
windows or there are other windows

424
00:14:59,040 --> 00:15:02,399
executables that attackers can bring in

425
00:15:02,399 --> 00:15:04,000
so we need to look at what are

426
00:15:04,000 --> 00:15:05,920
suspicious command line parameters

427
00:15:05,920 --> 00:15:07,680
around those

428
00:15:07,680 --> 00:15:08,959
and then we can tune into those

429
00:15:08,959 --> 00:15:10,800
potentially like in this case

430
00:15:10,800 --> 00:15:13,360
or potentially if i'm looking at one

431
00:15:13,360 --> 00:15:15,199
setup with an application

432
00:15:15,199 --> 00:15:17,760
and one process or multiple processes

433
00:15:17,760 --> 00:15:20,320
keep having the same line

434
00:15:20,320 --> 00:15:23,279
the same command line parameter i can

435
00:15:23,279 --> 00:15:26,959
tune that out as well

436
00:15:26,959 --> 00:15:28,320
and then the other thing we want to look

437
00:15:28,320 --> 00:15:30,639
into

438
00:15:31,279 --> 00:15:32,399
is the

439
00:15:32,399 --> 00:15:33,920
users

440
00:15:33,920 --> 00:15:35,839
so a lot of times

441
00:15:35,839 --> 00:15:37,600
you know certain processes might run a

442
00:15:37,600 --> 00:15:39,920
system so if those processes are running

443
00:15:39,920 --> 00:15:41,839
as something that's not a system then

444
00:15:41,839 --> 00:15:43,199
that's interesting

445
00:15:43,199 --> 00:15:46,079
or if they're running as you know a

446
00:15:46,079 --> 00:15:48,320
typical user and they're not supposed to

447
00:15:48,320 --> 00:15:50,320
usually run as a typical user that's

448
00:15:50,320 --> 00:15:51,360
interesting

449
00:15:51,360 --> 00:15:53,839
so we can look at that the other area of

450
00:15:53,839 --> 00:15:55,040
suspicious

451
00:15:55,040 --> 00:15:57,519
users is we can say all right for who am

452
00:15:57,519 --> 00:15:59,199
i that's typical for help desk to

453
00:15:59,199 --> 00:16:00,800
execute

454
00:16:00,800 --> 00:16:03,120
but should someone in hr probably be

455
00:16:03,120 --> 00:16:05,360
executing who am i let alone should

456
00:16:05,360 --> 00:16:07,279
someone in hr probably be launching a

457
00:16:07,279 --> 00:16:08,800
command prompt that's probably a little

458
00:16:08,800 --> 00:16:10,959
suspicious because i don't know too many

459
00:16:10,959 --> 00:16:12,959
people outside of it who launch command

460
00:16:12,959 --> 00:16:15,279
prompts

461
00:16:16,160 --> 00:16:18,240
and then finally we also look at does

462
00:16:18,240 --> 00:16:20,240
the process make network connections

463
00:16:20,240 --> 00:16:22,880
this is a huge one um for almost

464
00:16:22,880 --> 00:16:25,680
anything inside to see windows

465
00:16:25,680 --> 00:16:27,600
folder path

466
00:16:27,600 --> 00:16:29,839
if it's going outbound you probably need

467
00:16:29,839 --> 00:16:31,279
to start baselining that and look for

468
00:16:31,279 --> 00:16:33,440
suspicious activity but in this example

469
00:16:33,440 --> 00:16:35,680
we see where powershell is going

470
00:16:35,680 --> 00:16:36,720
outbound

471
00:16:36,720 --> 00:16:38,560
so that's just an example where what we

472
00:16:38,560 --> 00:16:40,560
want to do is we want to baseline does

473
00:16:40,560 --> 00:16:42,000
this process

474
00:16:42,000 --> 00:16:44,959
does it call locally to localhost

475
00:16:44,959 --> 00:16:46,399
is that common

476
00:16:46,399 --> 00:16:48,000
sometimes you'll have certain processes

477
00:16:48,000 --> 00:16:49,839
where they don't call local host and you

478
00:16:49,839 --> 00:16:51,440
need to start flagging if they do call a

479
00:16:51,440 --> 00:16:52,720
local host

480
00:16:52,720 --> 00:16:55,279
or we look at private ip spaces and say

481
00:16:55,279 --> 00:16:57,360
this process only should talk to private

482
00:16:57,360 --> 00:16:59,519
ip spaces you know

483
00:16:59,519 --> 00:17:01,279
in our land but it shouldn't call

484
00:17:01,279 --> 00:17:03,279
outbound so that's another area that we

485
00:17:03,279 --> 00:17:04,959
can look at

486
00:17:04,959 --> 00:17:06,640
and then finally you know external ips

487
00:17:06,640 --> 00:17:07,919
so we need to start understanding what

488
00:17:07,919 --> 00:17:10,559
this process communicates to on a common

489
00:17:10,559 --> 00:17:13,760
basis so that we then can flag when it's

490
00:17:13,760 --> 00:17:16,400
suspicious

491
00:17:16,400 --> 00:17:18,160
and what this looks like it looks like

492
00:17:18,160 --> 00:17:21,039
when we're tuning is we cast the wide

493
00:17:21,039 --> 00:17:24,240
net first so we cast the net and we

494
00:17:24,240 --> 00:17:27,199
usually get a bunch of benign events

495
00:17:27,199 --> 00:17:29,360
and that's where we start and that's

496
00:17:29,360 --> 00:17:30,880
what casting a wide net kind of looks

497
00:17:30,880 --> 00:17:33,840
like in a visual reference

498
00:17:33,840 --> 00:17:36,559
and our goal is to get down to this

499
00:17:36,559 --> 00:17:39,520
aspect where we have a few benign events

500
00:17:39,520 --> 00:17:42,240
and we get most of the malicious events

501
00:17:42,240 --> 00:17:43,679
and the way we do this though is through

502
00:17:43,679 --> 00:17:45,679
testing and we start seeing a bunch of

503
00:17:45,679 --> 00:17:47,200
different ways that the attackers are

504
00:17:47,200 --> 00:17:50,559
using those tools um you know run dll-32

505
00:17:50,559 --> 00:17:52,240
things like this we're starting to get a

506
00:17:52,240 --> 00:17:54,400
bunch of data generated around that and

507
00:17:54,400 --> 00:17:57,120
that's why we want to do emulation uh in

508
00:17:57,120 --> 00:17:58,320
our environment in our production

509
00:17:58,320 --> 00:17:59,919
environment to actually verify our

510
00:17:59,919 --> 00:18:03,600
detections and if we need to change them

511
00:18:03,679 --> 00:18:05,840
one thing we like to talk about too is

512
00:18:05,840 --> 00:18:09,280
don't go too small or too precise

513
00:18:09,280 --> 00:18:11,600
if you go too precise

514
00:18:11,600 --> 00:18:13,200
then you end up with something like this

515
00:18:13,200 --> 00:18:14,720
where you're actually missing a lot of

516
00:18:14,720 --> 00:18:16,720
the malicious events

517
00:18:16,720 --> 00:18:19,039
and if you do this it's just it's not

518
00:18:19,039 --> 00:18:21,120
good because you're missing the bulk of

519
00:18:21,120 --> 00:18:22,320
the events that the rule could be

520
00:18:22,320 --> 00:18:24,720
covering and what this does is it either

521
00:18:24,720 --> 00:18:26,799
allows you to miss alerts that you

522
00:18:26,799 --> 00:18:29,360
should have had or it means that you're

523
00:18:29,360 --> 00:18:30,880
gonna have to create a bunch of

524
00:18:30,880 --> 00:18:32,880
different layered alerts and then you

525
00:18:32,880 --> 00:18:34,880
just have a lot of alerts and that slows

526
00:18:34,880 --> 00:18:37,679
down the systems

527
00:18:38,480 --> 00:18:40,400
one thing we also want to mention

528
00:18:40,400 --> 00:18:44,000
is that uh with the

529
00:18:44,000 --> 00:18:45,600
the nature of finding suspicious

530
00:18:45,600 --> 00:18:48,080
activity sometimes when you actually go

531
00:18:48,080 --> 00:18:49,120
out there and you look at it in your

532
00:18:49,120 --> 00:18:50,720
environment you might think yeah i'm

533
00:18:50,720 --> 00:18:52,720
gonna catch this one guy and then you

534
00:18:52,720 --> 00:18:54,799
realize that you have a bunch of benign

535
00:18:54,799 --> 00:18:56,640
events that come along with it so i just

536
00:18:56,640 --> 00:18:59,440
want to say not every procedure that a

537
00:18:59,440 --> 00:19:02,400
adversary uses is going to be a good

538
00:19:02,400 --> 00:19:04,240
detection opportunity

539
00:19:04,240 --> 00:19:06,400
sometimes you just don't have a good

540
00:19:06,400 --> 00:19:08,240
detection opportunity and you have to

541
00:19:08,240 --> 00:19:10,480
accept that but at the end of the day we

542
00:19:10,480 --> 00:19:12,480
wanted enough lasers in our vault

543
00:19:12,480 --> 00:19:14,000
scanning everywhere so that when you

544
00:19:14,000 --> 00:19:15,840
know a hacker comes in they trip one of

545
00:19:15,840 --> 00:19:18,480
those lasers

546
00:19:20,240 --> 00:19:24,240
so a quick example of this is the uh

547
00:19:24,240 --> 00:19:25,919
tuning of wmak

548
00:19:25,919 --> 00:19:28,080
so in our environment we went out and we

549
00:19:28,080 --> 00:19:30,559
looked for wmak it's a common uh living

550
00:19:30,559 --> 00:19:33,360
off the land binary and script

551
00:19:33,360 --> 00:19:35,760
built into windows and what we have here

552
00:19:35,760 --> 00:19:38,240
is we look for the parent processes that

553
00:19:38,240 --> 00:19:39,679
were spawning it

554
00:19:39,679 --> 00:19:42,240
and as you see we have an amazon agent

555
00:19:42,240 --> 00:19:44,880
that's uh spawning it a bunch but then i

556
00:19:44,880 --> 00:19:47,039
have my scythe emulation

557
00:19:47,039 --> 00:19:48,960
campaigns and a powershell that came off

558
00:19:48,960 --> 00:19:51,280
of one of them those were also spawning

559
00:19:51,280 --> 00:19:53,600
it so this is a quick win in an

560
00:19:53,600 --> 00:19:55,039
environment where i can just go out i

561
00:19:55,039 --> 00:19:56,960
can look for wmic

562
00:19:56,960 --> 00:19:58,559
should it be spawn in my environment

563
00:19:58,559 --> 00:20:00,720
okay it's spawned by this we tuned that

564
00:20:00,720 --> 00:20:02,080
out and now we're already finding

565
00:20:02,080 --> 00:20:03,760
suspicious activity

566
00:20:03,760 --> 00:20:07,840
so that's a perfect example right there

567
00:20:08,240 --> 00:20:11,120
and then we get to dissemination as well

568
00:20:11,120 --> 00:20:13,039
and with dissemination

569
00:20:13,039 --> 00:20:16,400
we're delivering to the stakeholders

570
00:20:16,400 --> 00:20:19,120
and this could be delivering to sock

571
00:20:19,120 --> 00:20:21,039
obviously in the form of an alert if we

572
00:20:21,039 --> 00:20:23,360
did good threat hunting we have a tuned

573
00:20:23,360 --> 00:20:24,640
alert at the end of it that we can

574
00:20:24,640 --> 00:20:26,559
deliver to sock and now we can go threat

575
00:20:26,559 --> 00:20:27,840
hunt on something else instead of having

576
00:20:27,840 --> 00:20:29,760
to threat hunt on the same thing

577
00:20:29,760 --> 00:20:32,480
you know month after month

578
00:20:32,480 --> 00:20:33,919
and then one of the other things we want

579
00:20:33,919 --> 00:20:36,159
to do is maybe we give it to management

580
00:20:36,159 --> 00:20:37,760
and one of the things we give to

581
00:20:37,760 --> 00:20:40,080
management is you know we can take our

582
00:20:40,080 --> 00:20:41,679
developed alerts we can map them to

583
00:20:41,679 --> 00:20:43,280
mitre and we can throw it up on a graph

584
00:20:43,280 --> 00:20:44,880
for them so that's one thing to think

585
00:20:44,880 --> 00:20:46,960
about as well and we can also give it to

586
00:20:46,960 --> 00:20:49,360
the cti team then we can also document

587
00:20:49,360 --> 00:20:51,360
log sources so we know what tools are

588
00:20:51,360 --> 00:20:53,919
giving us the most value

589
00:20:53,919 --> 00:20:57,440
and then finally this is always a circle

590
00:20:57,440 --> 00:21:00,400
that's ever continuing because uh you

591
00:21:00,400 --> 00:21:01,919
know adversaries are always updating

592
00:21:01,919 --> 00:21:04,559
their procedures and then also if you

593
00:21:04,559 --> 00:21:06,320
have a red team you can tell the red

594
00:21:06,320 --> 00:21:08,960
team that hey we have this this rule now

595
00:21:08,960 --> 00:21:11,039
or we put a block in place or whatever

596
00:21:11,039 --> 00:21:12,000
it is

597
00:21:12,000 --> 00:21:14,000
and we want to know hey red team

598
00:21:14,000 --> 00:21:16,080
what would you do to bypass this or how

599
00:21:16,080 --> 00:21:18,480
would an adversary potentially get

600
00:21:18,480 --> 00:21:20,480
around this so it wouldn't flag in our

601
00:21:20,480 --> 00:21:21,600
environment

602
00:21:21,600 --> 00:21:23,200
and then the red team can say well you

603
00:21:23,200 --> 00:21:25,120
know instead of running who am i we'll

604
00:21:25,120 --> 00:21:27,440
we'll just enumerate this uh environment

605
00:21:27,440 --> 00:21:29,520
variable instead and then you have to go

606
00:21:29,520 --> 00:21:31,840
and you have to do detection on that so

607
00:21:31,840 --> 00:21:34,159
that's what it looks like

608
00:21:34,159 --> 00:21:36,559
from the dissemination standpoint

609
00:21:36,559 --> 00:21:38,799
and with the red team kind of if you

610
00:21:38,799 --> 00:21:40,880
have that implementing it back so that

611
00:21:40,880 --> 00:21:42,559
you're constantly doing that cat and

612
00:21:42,559 --> 00:21:44,080
mouse game and hardening your

613
00:21:44,080 --> 00:21:47,280
environment with detections

614
00:21:47,520 --> 00:21:49,840
and then we also have the

615
00:21:49,840 --> 00:21:52,559
dissemination structure by palantir they

616
00:21:52,559 --> 00:21:55,600
have the ads framework it's a great

617
00:21:55,600 --> 00:21:57,440
in-depth framework

618
00:21:57,440 --> 00:21:58,640
but

619
00:21:58,640 --> 00:22:00,880
being palantir they are a defense

620
00:22:00,880 --> 00:22:02,880
contractor and they have lots of

621
00:22:02,880 --> 00:22:05,760
resources and they have a huge team

622
00:22:05,760 --> 00:22:07,919
so i want to say that you don't have to

623
00:22:07,919 --> 00:22:09,840
go out and do this to the t some people

624
00:22:09,840 --> 00:22:12,080
they're like oh i need to do the full

625
00:22:12,080 --> 00:22:14,080
framework and i'm here to tell you you

626
00:22:14,080 --> 00:22:16,320
don't need to do the full framework but

627
00:22:16,320 --> 00:22:18,480
do what works for your environment i

628
00:22:18,480 --> 00:22:20,640
recommend going and checking it out

629
00:22:20,640 --> 00:22:22,559
take what you need what fits into your

630
00:22:22,559 --> 00:22:24,080
environment

631
00:22:24,080 --> 00:22:26,720
and then from there you can actually

632
00:22:26,720 --> 00:22:29,919
implement what you need to implement

633
00:22:29,919 --> 00:22:32,159
so let me bounce back because i've

634
00:22:32,159 --> 00:22:34,960
actually skipped a few slides i did this

635
00:22:34,960 --> 00:22:37,679
in google docs and then exported and i

636
00:22:37,679 --> 00:22:38,840
think when

637
00:22:38,840 --> 00:22:41,600
my uh

638
00:22:41,600 --> 00:22:44,240
ah so it's just blank

639
00:22:44,240 --> 00:22:45,360
all right well then i'll just talk

640
00:22:45,360 --> 00:22:47,200
manually to it

641
00:22:47,200 --> 00:22:50,960
so for those of you unaware by the way

642
00:22:50,960 --> 00:22:54,400
of the david bianco's pyramid of pain

643
00:22:54,400 --> 00:22:55,600
um

644
00:22:55,600 --> 00:22:57,919
dave bianco came out this was after

645
00:22:57,919 --> 00:23:01,039
manning an apt-1 report the apt-1 report

646
00:23:01,039 --> 00:23:03,679
really changed the industry it was the

647
00:23:03,679 --> 00:23:06,080
first time that we said hey

648
00:23:06,080 --> 00:23:08,559
it's not just malware

649
00:23:08,559 --> 00:23:10,400
it's not just malware's bad cleanup

650
00:23:10,400 --> 00:23:11,600
malware

651
00:23:11,600 --> 00:23:13,280
we went out and we actually saw that

652
00:23:13,280 --> 00:23:15,360
there's adversaries behind here there's

653
00:23:15,360 --> 00:23:18,240
actually procedures that they do

654
00:23:18,240 --> 00:23:20,320
so what david bianco said is

655
00:23:20,320 --> 00:23:22,640
hey the ip address they can change that

656
00:23:22,640 --> 00:23:24,320
really quickly i don't know if any of

657
00:23:24,320 --> 00:23:27,200
y'all were in the talk earlier uh

658
00:23:27,200 --> 00:23:29,360
john though is talking about how you can

659
00:23:29,360 --> 00:23:31,919
just script out infrastructure as code

660
00:23:31,919 --> 00:23:34,880
so adversaries can literally spin up and

661
00:23:34,880 --> 00:23:36,799
and then move ips

662
00:23:36,799 --> 00:23:39,200
constantly and then every time they do a

663
00:23:39,200 --> 00:23:40,480
new payload

664
00:23:40,480 --> 00:23:43,279
then it can be a new hash

665
00:23:43,279 --> 00:23:44,960
so when we're trying to look at these

666
00:23:44,960 --> 00:23:47,039
ioc feeds

667
00:23:47,039 --> 00:23:48,559
what we're looking at

668
00:23:48,559 --> 00:23:51,200
is just old uh

669
00:23:51,200 --> 00:23:54,640
artifacts left behind by an actor so

670
00:23:54,640 --> 00:23:59,039
ioc's uh you know those hashes and stuff

671
00:23:59,039 --> 00:24:01,279
those are good checks to make sure that

672
00:24:01,279 --> 00:24:02,720
none of that stuff was in our

673
00:24:02,720 --> 00:24:06,080
environment as far as cross-referencing

674
00:24:06,080 --> 00:24:08,000
but what we really need to get to is as

675
00:24:08,000 --> 00:24:09,840
you move up david bianco's pyramid of

676
00:24:09,840 --> 00:24:12,720
pain he gets to tools and tools are good

677
00:24:12,720 --> 00:24:13,919
because we want to catch something like

678
00:24:13,919 --> 00:24:16,000
mimi cats right because it's used

679
00:24:16,000 --> 00:24:18,080
everywhere and people change the hash

680
00:24:18,080 --> 00:24:19,679
though on it constantly so if you're

681
00:24:19,679 --> 00:24:20,960
trying to catch the hash you're not

682
00:24:20,960 --> 00:24:22,640
doing a great job but you need to be

683
00:24:22,640 --> 00:24:24,960
able to catch mimikat the tool uh or

684
00:24:24,960 --> 00:24:26,799
maybe kittens or memory dogs or whatever

685
00:24:26,799 --> 00:24:28,559
they name it that's where we get to

686
00:24:28,559 --> 00:24:30,000
tools and we need to catch that and then

687
00:24:30,000 --> 00:24:32,000
finally when we move to the top at the

688
00:24:32,000 --> 00:24:34,400
time i believe this was like 2013

689
00:24:34,400 --> 00:24:38,240
he had the ttps at the top

690
00:24:38,240 --> 00:24:40,559
and with cyber threat intelligence with

691
00:24:40,559 --> 00:24:42,480
the ttps

692
00:24:42,480 --> 00:24:44,000
everyone's kind of lumping that together

693
00:24:44,000 --> 00:24:46,720
to say that the adversary did this ttp

694
00:24:46,720 --> 00:24:48,720
in this ttp

695
00:24:48,720 --> 00:24:50,880
so when we see it though when we look at

696
00:24:50,880 --> 00:24:52,799
the actual technique it might be

697
00:24:52,799 --> 00:24:55,120
credential access

698
00:24:55,120 --> 00:24:57,679
so if i communicate to y'all as a group

699
00:24:57,679 --> 00:24:58,880
and i say hey

700
00:24:58,880 --> 00:25:02,240
uh purple unicorn yesterday did

701
00:25:02,240 --> 00:25:04,080
credential access

702
00:25:04,080 --> 00:25:06,000
how are you gonna go out and make sure

703
00:25:06,000 --> 00:25:07,679
that you're secure from

704
00:25:07,679 --> 00:25:10,240
that fuzz or from that purple unicorn

705
00:25:10,240 --> 00:25:12,799
dump you know with credential access you

706
00:25:12,799 --> 00:25:14,880
don't know how to test that so then we

707
00:25:14,880 --> 00:25:17,120
also had the technique level

708
00:25:17,120 --> 00:25:20,480
where we say okay purple unicorn dumped

709
00:25:20,480 --> 00:25:22,159
lsas that's how they got credential

710
00:25:22,159 --> 00:25:23,760
access

711
00:25:23,760 --> 00:25:25,600
but we still don't know how they

712
00:25:25,600 --> 00:25:26,799
actually

713
00:25:26,799 --> 00:25:28,960
dumped lsas so this is like where i say

714
00:25:28,960 --> 00:25:30,720
if you're familiar with

715
00:25:30,720 --> 00:25:33,520
the um shit's creek uh

716
00:25:33,520 --> 00:25:35,520
like i've seen where they're going how

717
00:25:35,520 --> 00:25:37,440
do i fold the cheese

718
00:25:37,440 --> 00:25:40,320
it's how do i fold the cheese because at

719
00:25:40,320 --> 00:25:41,520
the end of the day if you told me that

720
00:25:41,520 --> 00:25:43,760
they dumped else as

721
00:25:43,760 --> 00:25:45,039
i don't know how they did they use

722
00:25:45,039 --> 00:25:47,360
mimikats did they use proc dump did they

723
00:25:47,360 --> 00:25:49,120
do it any of the other 20 ways did they

724
00:25:49,120 --> 00:25:51,919
come up with a new and novel way of

725
00:25:51,919 --> 00:25:54,320
dumping lsas i need to know so that i

726
00:25:54,320 --> 00:25:56,000
can actually replicate that in my

727
00:25:56,000 --> 00:25:57,679
environment

728
00:25:57,679 --> 00:25:59,440
so the other thing that we need to know

729
00:25:59,440 --> 00:26:01,600
is so after david bianco published this

730
00:26:01,600 --> 00:26:04,480
after apt-1 report it wasn't until like

731
00:26:04,480 --> 00:26:06,880
three or four years later that attack

732
00:26:06,880 --> 00:26:09,039
came out and everyone's trying to map

733
00:26:09,039 --> 00:26:11,279
stuff to attack now

734
00:26:11,279 --> 00:26:14,320
and with that what we have to do

735
00:26:14,320 --> 00:26:16,080
is we have to understand what attack was

736
00:26:16,080 --> 00:26:18,960
meant for it was meant to communicate it

737
00:26:18,960 --> 00:26:21,039
was meant so that i could go out and i

738
00:26:21,039 --> 00:26:23,520
could i could do a report and tell you

739
00:26:23,520 --> 00:26:25,760
what happened in my environment without

740
00:26:25,760 --> 00:26:28,480
handing over every single command line

741
00:26:28,480 --> 00:26:31,039
procedure that the adversary did so

742
00:26:31,039 --> 00:26:33,520
attack was meant to take that tag that

743
00:26:33,520 --> 00:26:34,880
and then communicate it out to the

744
00:26:34,880 --> 00:26:36,960
masses that's what attack was meant for

745
00:26:36,960 --> 00:26:38,240
but now you know it's kind of like the

746
00:26:38,240 --> 00:26:40,400
frank's red hot sauce everyone's putting

747
00:26:40,400 --> 00:26:42,799
an attack on everything which i you know

748
00:26:42,799 --> 00:26:44,400
i love the attack team they're great but

749
00:26:44,400 --> 00:26:46,240
sometimes some things attack works for

750
00:26:46,240 --> 00:26:48,159
some things it doesn't so what we're

751
00:26:48,159 --> 00:26:50,159
really trying to do and what i'm trying

752
00:26:50,159 --> 00:26:51,440
to say is

753
00:26:51,440 --> 00:26:53,120
you need to get down to that procedure

754
00:26:53,120 --> 00:26:55,919
level of what the adversary is doing

755
00:26:55,919 --> 00:26:57,679
if you're not doing that you're not

756
00:26:57,679 --> 00:27:00,480
having threat and form detections

757
00:27:00,480 --> 00:27:03,919
so we need to go out if you are getting

758
00:27:03,919 --> 00:27:05,360
you can have this from multiple sources

759
00:27:05,360 --> 00:27:07,679
too if you're ransomware the d4 report

760
00:27:07,679 --> 00:27:10,080
does a great job on opportunity uh

761
00:27:10,080 --> 00:27:12,559
adversaries you know they take malware

762
00:27:12,559 --> 00:27:14,240
they detonate it they look at what

763
00:27:14,240 --> 00:27:15,840
they're doing in their environment at

764
00:27:15,840 --> 00:27:18,559
the procedure level they tell you every

765
00:27:18,559 --> 00:27:20,640
single procedure so then you can run

766
00:27:20,640 --> 00:27:22,399
that in your environment and then you

767
00:27:22,399 --> 00:27:24,480
can do your detection engineering on it

768
00:27:24,480 --> 00:27:26,399
and that's really what the whole process

769
00:27:26,399 --> 00:27:28,880
comes down to is starting out figuring

770
00:27:28,880 --> 00:27:30,960
what the adversary is doing because they

771
00:27:30,960 --> 00:27:32,880
have those habits i don't know if i've

772
00:27:32,880 --> 00:27:34,480
actually said um yet because i'm trying

773
00:27:34,480 --> 00:27:36,799
not to but i have a habit of saying i'm

774
00:27:36,799 --> 00:27:38,960
on stage so if you were to do something

775
00:27:38,960 --> 00:27:41,039
you're like out of all the speakers here

776
00:27:41,039 --> 00:27:42,480
that one's probably chris cause they

777
00:27:42,480 --> 00:27:44,320
said um 20 times

778
00:27:44,320 --> 00:27:46,480
but i have habits everyone has habits

779
00:27:46,480 --> 00:27:49,600
you know or they have training as well

780
00:27:49,600 --> 00:27:52,640
if you are going to a nation state uh to

781
00:27:52,640 --> 00:27:53,919
do hacking guess what you're going to

782
00:27:53,919 --> 00:27:55,200
get training

783
00:27:55,200 --> 00:27:57,279
and i'm going to tell you they don't

784
00:27:57,279 --> 00:27:59,679
change training that often because they

785
00:27:59,679 --> 00:28:01,919
have to be able to push people through

786
00:28:01,919 --> 00:28:03,760
so the training is going to be similar

787
00:28:03,760 --> 00:28:05,840
you know a lot of three-letter agencies

788
00:28:05,840 --> 00:28:07,600
send um

789
00:28:07,600 --> 00:28:10,720
send their students or their

790
00:28:10,720 --> 00:28:12,880
their employees through sands so a lot

791
00:28:12,880 --> 00:28:14,559
of them are getting sans training which

792
00:28:14,559 --> 00:28:16,080
is going to be the same training over

793
00:28:16,080 --> 00:28:17,760
and over again by the way shout out to

794
00:28:17,760 --> 00:28:19,679
george i'm not trying to uh badmouth

795
00:28:19,679 --> 00:28:21,520
sans he's probably on the discord saying

796
00:28:21,520 --> 00:28:22,880
something right now

797
00:28:22,880 --> 00:28:24,960
but george is my boss he's a good guy

798
00:28:24,960 --> 00:28:26,720
excellent guy and i thank him for this

799
00:28:26,720 --> 00:28:28,320
opportunity to be up here and talking to

800
00:28:28,320 --> 00:28:30,480
y'all because raytheon i don't believe

801
00:28:30,480 --> 00:28:32,000
would let me do this unless i jump

802
00:28:32,000 --> 00:28:34,080
through like four hoops and spun plates

803
00:28:34,080 --> 00:28:35,520
on my head

804
00:28:35,520 --> 00:28:38,080
so just getting down to this procedure

805
00:28:38,080 --> 00:28:40,080
level is what we're after and that's

806
00:28:40,080 --> 00:28:41,360
what's going to drive detection

807
00:28:41,360 --> 00:28:42,880
engineering

808
00:28:42,880 --> 00:28:43,840
and that's what's going to make us

809
00:28:43,840 --> 00:28:45,279
threaten formed

810
00:28:45,279 --> 00:28:48,080
so that's pretty much the whole talk uh

811
00:28:48,080 --> 00:28:50,000
and then we'll open it up to questions

812
00:28:50,000 --> 00:28:52,559
now i kind of rush through because i do

813
00:28:52,559 --> 00:28:54,000
want to make sure we have enough time

814
00:28:54,000 --> 00:28:55,600
for uh

815
00:28:55,600 --> 00:28:59,120
for questions but just to tie it off

816
00:28:59,120 --> 00:29:00,559
i do want you all to have some happy

817
00:29:00,559 --> 00:29:02,720
hunting and i hope you all actually go

818
00:29:02,720 --> 00:29:04,320
out and find good

819
00:29:04,320 --> 00:29:06,000
cyber threat intelligence understand

820
00:29:06,000 --> 00:29:08,080
that adversary what they're doing in

821
00:29:08,080 --> 00:29:09,520
your environment or what they would do

822
00:29:09,520 --> 00:29:10,840
in your environment

823
00:29:10,840 --> 00:29:13,520
potentially run that in your environment

824
00:29:13,520 --> 00:29:15,360
and then start doing detections around

825
00:29:15,360 --> 00:29:19,120
that so any questions

826
00:29:19,840 --> 00:29:22,840
yes

827
00:29:26,000 --> 00:29:28,000
risk-based alerting

828
00:29:28,000 --> 00:29:29,039
so

829
00:29:29,039 --> 00:29:30,880
it kind of just depends right

830
00:29:30,880 --> 00:29:32,320
i don't think i've ever seen like where

831
00:29:32,320 --> 00:29:35,520
like wrist space is necessarily

832
00:29:35,520 --> 00:29:36,720
like

833
00:29:36,720 --> 00:29:38,559
um

834
00:29:38,559 --> 00:29:40,960
how do i put this i've never seen it

835
00:29:40,960 --> 00:29:42,960
where like it works well right because

836
00:29:42,960 --> 00:29:44,880
so if i go out and i say all right i'm

837
00:29:44,880 --> 00:29:47,520
going to quantify this risk of this

838
00:29:47,520 --> 00:29:49,440
alert really high because it's on a

839
00:29:49,440 --> 00:29:52,080
domain controller all right

840
00:29:52,080 --> 00:29:54,240
well so if i have mimi cats on the

841
00:29:54,240 --> 00:29:56,799
domain controller i just got a high

842
00:29:56,799 --> 00:29:58,640
alert hopefully

843
00:29:58,640 --> 00:30:00,480
um because i have a high asset and i

844
00:30:00,480 --> 00:30:02,640
have a high fidelity alert probably of

845
00:30:02,640 --> 00:30:04,960
very malicious activity

846
00:30:04,960 --> 00:30:07,440
so now i have a high alert

847
00:30:07,440 --> 00:30:08,559
but

848
00:30:08,559 --> 00:30:10,480
sorry about that

849
00:30:10,480 --> 00:30:11,760
the issue is

850
00:30:11,760 --> 00:30:14,240
well what happened when the way the

851
00:30:14,240 --> 00:30:16,000
actor got in who got to the domain

852
00:30:16,000 --> 00:30:19,520
controller and put mimi cats on there

853
00:30:19,520 --> 00:30:21,520
what happened to that low level

854
00:30:21,520 --> 00:30:24,240
informational alert in hr that was

855
00:30:24,240 --> 00:30:26,080
ranked low

856
00:30:26,080 --> 00:30:26,960
so

857
00:30:26,960 --> 00:30:29,039
that's one of those things where to me

858
00:30:29,039 --> 00:30:30,799
tuning an environment and being able to

859
00:30:30,799 --> 00:30:32,159
respond to

860
00:30:32,159 --> 00:30:34,240
every alert that's the

861
00:30:34,240 --> 00:30:37,200
that's the idea um

862
00:30:37,200 --> 00:30:39,679
is it achievable in every environment

863
00:30:39,679 --> 00:30:40,720
no

864
00:30:40,720 --> 00:30:43,120
i mean some environments it's very

865
00:30:43,120 --> 00:30:46,000
difficult to do that but yeah risk based

866
00:30:46,000 --> 00:30:47,360
it's one of those things i haven't seen

867
00:30:47,360 --> 00:30:49,440
it work well yet and like i said because

868
00:30:49,440 --> 00:30:52,080
of mimikat's guitar domain controller

869
00:30:52,080 --> 00:30:53,919
and it's high alert but we missed all

870
00:30:53,919 --> 00:30:55,279
these other alerts of how they loudly

871
00:30:55,279 --> 00:30:56,799
move there the other thing that i like

872
00:30:56,799 --> 00:30:59,519
to talk about with detection engineering

873
00:30:59,519 --> 00:31:00,720
that i think that our detection

874
00:31:00,720 --> 00:31:03,440
engineers need to know about

875
00:31:03,440 --> 00:31:05,679
is being able to document what's going

876
00:31:05,679 --> 00:31:08,480
on in the alert so and what the response

877
00:31:08,480 --> 00:31:11,120
is so like if you have many cats on a

878
00:31:11,120 --> 00:31:13,600
domain controller and the sock analyst

879
00:31:13,600 --> 00:31:15,840
goes in and they say we removed mimikats

880
00:31:15,840 --> 00:31:18,399
from the domain controller

881
00:31:18,399 --> 00:31:20,720
we did an av scan and it's clean closing

882
00:31:20,720 --> 00:31:21,919
case

883
00:31:21,919 --> 00:31:23,440
well what you have to know is is that

884
00:31:23,440 --> 00:31:24,880
means that there's still an adversary

885
00:31:24,880 --> 00:31:26,880
with active c2 somewhere in there they

886
00:31:26,880 --> 00:31:29,120
actually didn't do the response well so

887
00:31:29,120 --> 00:31:30,960
when you're doing purple teaming you

888
00:31:30,960 --> 00:31:33,760
need to also audit that response

889
00:31:33,760 --> 00:31:34,799
to make sure we're getting the

890
00:31:34,799 --> 00:31:36,720
appropriate response one of the most

891
00:31:36,720 --> 00:31:39,120
common ways for threat actors right now

892
00:31:39,120 --> 00:31:41,039
to get

893
00:31:41,039 --> 00:31:42,960
command and control up and running from

894
00:31:42,960 --> 00:31:44,000
you know most of these phishing

895
00:31:44,000 --> 00:31:45,760
campaigns they're using something where

896
00:31:45,760 --> 00:31:48,240
they like inject either either the

897
00:31:48,240 --> 00:31:51,360
initial uh trojan or afterwards when

898
00:31:51,360 --> 00:31:53,440
they drop cobalt strike it'll go in to

899
00:31:53,440 --> 00:31:56,080
run dll32

900
00:31:56,080 --> 00:31:58,080
so one of the areas that we're running

901
00:31:58,080 --> 00:32:00,880
into issues is you see where an analyst

902
00:32:00,880 --> 00:32:04,799
will say run dll32 alerted

903
00:32:04,880 --> 00:32:06,880
and we have the alert and this is why

904
00:32:06,880 --> 00:32:08,159
you don't stop when you're purple

905
00:32:08,159 --> 00:32:10,080
teaming you don't stop at the alert you

906
00:32:10,080 --> 00:32:11,919
need to get to the next level and test

907
00:32:11,919 --> 00:32:13,360
the human response

908
00:32:13,360 --> 00:32:15,919
because if i put my shell and run dll-32

909
00:32:15,919 --> 00:32:18,399
and it's calling out bound that's that's

910
00:32:18,399 --> 00:32:20,159
great for me i'm hiding right there and

911
00:32:20,159 --> 00:32:21,919
then the analysts will go in and then

912
00:32:21,919 --> 00:32:24,320
they'll take the hash of the run dll32

913
00:32:24,320 --> 00:32:26,399
process and then they'll also say that

914
00:32:26,399 --> 00:32:28,559
it's microsoft signed and then they'll

915
00:32:28,559 --> 00:32:30,480
close the case saying that it's a false

916
00:32:30,480 --> 00:32:32,080
positive

917
00:32:32,080 --> 00:32:34,159
so this is one of those areas where if

918
00:32:34,159 --> 00:32:36,960
you're a red teamer you know try to help

919
00:32:36,960 --> 00:32:38,559
guide people through the whole process

920
00:32:38,559 --> 00:32:40,559
of look we need alerts we need to test

921
00:32:40,559 --> 00:32:42,559
the response to it and then where we

922
00:32:42,559 --> 00:32:44,080
don't have alerts we need to gain alerts

923
00:32:44,080 --> 00:32:45,600
and then we need to test the response to

924
00:32:45,600 --> 00:32:48,159
those we need to constantly be hardening

925
00:32:48,159 --> 00:32:50,960
and scrimmaging against ourselves

926
00:32:50,960 --> 00:32:52,720
so that when the adversary shows up

927
00:32:52,720 --> 00:32:55,279
we're ready and we're going to win

928
00:32:55,279 --> 00:32:58,240
thank you any other questions

929
00:32:58,240 --> 00:33:00,799
yeah what's up

930
00:33:04,000 --> 00:33:07,360
parent process id

931
00:33:07,919 --> 00:33:09,919
yeah so for those online the question

932
00:33:09,919 --> 00:33:12,399
was do we ever run into

933
00:33:12,399 --> 00:33:16,159
uh parent process id spoofing um

934
00:33:16,159 --> 00:33:17,679
i

935
00:33:17,679 --> 00:33:21,519
don't believe i ran into it in the wild

936
00:33:21,519 --> 00:33:24,640
but there are detections around that

937
00:33:24,640 --> 00:33:26,720
and it also it also depends like how

938
00:33:26,720 --> 00:33:28,399
it's done too but that's one of those

939
00:33:28,399 --> 00:33:30,480
things where you know you can do it it

940
00:33:30,480 --> 00:33:32,240
is a technique but that's where we want

941
00:33:32,240 --> 00:33:33,679
to go in and we want to see the actual

942
00:33:33,679 --> 00:33:35,919
process that was done replicate that

943
00:33:35,919 --> 00:33:38,159
whatever the adversary is doing what how

944
00:33:38,159 --> 00:33:39,600
they're actually doing it and test it in

945
00:33:39,600 --> 00:33:41,519
our environment and test it against our

946
00:33:41,519 --> 00:33:43,519
tools does that make sense

947
00:33:43,519 --> 00:33:45,600
so like with any technique there's so

948
00:33:45,600 --> 00:33:47,519
many different procedures so you'd have

949
00:33:47,519 --> 00:33:49,440
to look at the specific procedure and

950
00:33:49,440 --> 00:33:52,080
how it's doing but yeah uh definitely

951
00:33:52,080 --> 00:33:55,279
you should be hunting for that

952
00:33:55,279 --> 00:33:58,159
any other questions

953
00:34:02,960 --> 00:34:05,840
so for those online the question was how

954
00:34:05,840 --> 00:34:07,679
often should we be

955
00:34:07,679 --> 00:34:10,560
testing the rules or content

956
00:34:10,560 --> 00:34:13,359
now this is one of those things where

957
00:34:13,359 --> 00:34:15,918
you could have a test after every change

958
00:34:15,918 --> 00:34:17,599
management

959
00:34:17,599 --> 00:34:19,280
so if you change your rules one of the

960
00:34:19,280 --> 00:34:20,639
things that people are pushing right now

961
00:34:20,639 --> 00:34:22,320
is detection is code

962
00:34:22,320 --> 00:34:24,560
so every time you you know change your

963
00:34:24,560 --> 00:34:28,079
code then you want new detection tests

964
00:34:28,079 --> 00:34:29,760
you could do

965
00:34:29,760 --> 00:34:31,199
you know something where you're looking

966
00:34:31,199 --> 00:34:33,119
at a monthly test of what you're

967
00:34:33,119 --> 00:34:35,280
actually seeing in your environment or

968
00:34:35,280 --> 00:34:37,280
from your adversaries one of the best

969
00:34:37,280 --> 00:34:40,719
areas to get your best cti is to go out

970
00:34:40,719 --> 00:34:43,599
and look at all your uh blocked emails

971
00:34:43,599 --> 00:34:44,960
and any of your

972
00:34:44,960 --> 00:34:46,320
emails that actually got through that

973
00:34:46,320 --> 00:34:48,879
we're fishing and then studying that

974
00:34:48,879 --> 00:34:51,599
whole chain of what it looks like

975
00:34:51,599 --> 00:34:53,040
from the user click it might be you know

976
00:34:53,040 --> 00:34:55,280
an iso file that then launches like a

977
00:34:55,280 --> 00:34:57,520
dot bat file that then launches this

978
00:34:57,520 --> 00:34:59,680
doing that and instead of launching that

979
00:34:59,680 --> 00:35:02,480
actual process in your environ or that

980
00:35:02,480 --> 00:35:03,920
actual malicious activity in your

981
00:35:03,920 --> 00:35:05,040
environment

982
00:35:05,040 --> 00:35:07,200
figure out a way to emulate that in your

983
00:35:07,200 --> 00:35:08,720
environment and then see what would

984
00:35:08,720 --> 00:35:10,400
happen like okay

985
00:35:10,400 --> 00:35:13,040
we know we knew that this came in

986
00:35:13,040 --> 00:35:15,119
five users got it and we removed it from

987
00:35:15,119 --> 00:35:17,280
their inbox no one ever clicked it but

988
00:35:17,280 --> 00:35:18,960
do you know that you have if someone

989
00:35:18,960 --> 00:35:20,880
does click it and you don't get an alert

990
00:35:20,880 --> 00:35:23,119
do you have those capabilities after

991
00:35:23,119 --> 00:35:25,599
that click to start catching that chain

992
00:35:25,599 --> 00:35:28,800
so that's one area that we look

993
00:35:29,280 --> 00:35:30,720
yeah at um

994
00:35:30,720 --> 00:35:32,480
i just want to like get back to your

995
00:35:32,480 --> 00:35:34,880
smiley face diagram

996
00:35:34,880 --> 00:35:36,079
um

997
00:35:36,079 --> 00:35:39,280
so obviously um we have like really good

998
00:35:39,280 --> 00:35:43,240
rules that um

999
00:35:52,640 --> 00:35:56,160
and so what is your approach um on both

1000
00:35:56,160 --> 00:35:58,960
sides that we

1001
00:36:04,560 --> 00:36:06,320
so the question was is what do you do to

1002
00:36:06,320 --> 00:36:10,079
an alert to make it higher fidelity

1003
00:36:10,400 --> 00:36:12,560
so you have to understand two concepts

1004
00:36:12,560 --> 00:36:15,359
and one concept is if i have it nope on

1005
00:36:15,359 --> 00:36:19,040
here is recall so recall and this is

1006
00:36:19,040 --> 00:36:20,880
pivoting from what mitre has done with a

1007
00:36:20,880 --> 00:36:22,320
bunch of their reach research and they

1008
00:36:22,320 --> 00:36:24,240
look at it more from a very advanced

1009
00:36:24,240 --> 00:36:27,200
data science aspect is recall is how

1010
00:36:27,200 --> 00:36:29,680
much of the malicious activity

1011
00:36:29,680 --> 00:36:31,599
do i actually detect

1012
00:36:31,599 --> 00:36:33,599
so that's one area but with that too you

1013
00:36:33,599 --> 00:36:35,520
have to identify potential unknowns

1014
00:36:35,520 --> 00:36:37,119
right or consider potential unknowns in

1015
00:36:37,119 --> 00:36:38,320
your detection

1016
00:36:38,320 --> 00:36:40,880
and then the other area is precision

1017
00:36:40,880 --> 00:36:42,800
because we don't want benign events so

1018
00:36:42,800 --> 00:36:45,040
it's trying to balance those two out

1019
00:36:45,040 --> 00:36:46,960
that we get something like this where

1020
00:36:46,960 --> 00:36:49,920
we're going for the most recall we can

1021
00:36:49,920 --> 00:36:51,839
and then we're also trying to balance

1022
00:36:51,839 --> 00:36:54,560
out precision and not have a lot of

1023
00:36:54,560 --> 00:36:56,480
false positives

1024
00:36:56,480 --> 00:36:58,960
uh but the way to do this the best way

1025
00:36:58,960 --> 00:37:01,359
is to run a bunch of different

1026
00:37:01,359 --> 00:37:03,440
procedures for whatever you're trying to

1027
00:37:03,440 --> 00:37:05,200
detect so if you're trying to detect

1028
00:37:05,200 --> 00:37:08,079
like encoded power shell you know maybe

1029
00:37:08,079 --> 00:37:10,240
you want to do a base64 encoded

1030
00:37:10,240 --> 00:37:12,320
powershell and then maybe you're still

1031
00:37:12,320 --> 00:37:14,079
looking at powershell so you want to do

1032
00:37:14,079 --> 00:37:15,839
something like invoke obfuscation

1033
00:37:15,839 --> 00:37:17,119
powershell

1034
00:37:17,119 --> 00:37:18,160
so you want to start looking at

1035
00:37:18,160 --> 00:37:20,240
different things like that

1036
00:37:20,240 --> 00:37:21,839
to see how your detections can be

1037
00:37:21,839 --> 00:37:23,839
expanded or if you have to go into new

1038
00:37:23,839 --> 00:37:26,480
detections um but obviously and i'm

1039
00:37:26,480 --> 00:37:28,160
doing the um thing again once again

1040
00:37:28,160 --> 00:37:30,160
people have patterns this is why we go

1041
00:37:30,160 --> 00:37:31,520
out and we look at the patterns that

1042
00:37:31,520 --> 00:37:32,800
they're doing

1043
00:37:32,800 --> 00:37:35,200
yeah what's

1044
00:37:35,280 --> 00:37:36,200
a broad up

1045
00:37:36,240 --> 00:37:38,800
scope of detect protection not to miss

1046
00:37:38,800 --> 00:37:41,839
anything while managing

1047
00:37:41,839 --> 00:37:44,079
is there

1048
00:37:44,079 --> 00:37:45,760
a balance of creating a broad enough

1049
00:37:45,760 --> 00:37:48,720
scope detection not to miss anything

1050
00:37:48,720 --> 00:37:51,200
while managing alert fatigue

1051
00:37:51,200 --> 00:37:53,280
okay so the question is is about getting

1052
00:37:53,280 --> 00:37:54,000
to

1053
00:37:54,000 --> 00:37:56,480
balancing um detections so that you

1054
00:37:56,480 --> 00:37:58,480
don't get to alert fatigue

1055
00:37:58,480 --> 00:38:00,400
so yeah that's where we're here right

1056
00:38:00,400 --> 00:38:03,040
you have too many benign events

1057
00:38:03,040 --> 00:38:04,960
and the way we do that is we got to get

1058
00:38:04,960 --> 00:38:06,640
down to something like this where we're

1059
00:38:06,640 --> 00:38:09,200
not uh alert fatiguing our sock and the

1060
00:38:09,200 --> 00:38:10,960
way we do that is we go through our

1061
00:38:10,960 --> 00:38:12,480
questions we're looking at different

1062
00:38:12,480 --> 00:38:14,000
parent uh

1063
00:38:14,000 --> 00:38:16,160
parent processes or child processes that

1064
00:38:16,160 --> 00:38:20,720
we can tune out so like i said here

1065
00:38:21,359 --> 00:38:23,920
we looked at uh the parent processes so

1066
00:38:23,920 --> 00:38:25,760
we tuned these out so we didn't have

1067
00:38:25,760 --> 00:38:27,839
alert fatigue now obviously something

1068
00:38:27,839 --> 00:38:29,520
else could come along eventually

1069
00:38:29,520 --> 00:38:31,200
especially like if there's like an

1070
00:38:31,200 --> 00:38:33,040
install or something like this that

1071
00:38:33,040 --> 00:38:35,200
might trip it but you know we're not

1072
00:38:35,200 --> 00:38:36,800
going to have alert fatigue from this

1073
00:38:36,800 --> 00:38:38,480
we'll we'll catch some suspicious

1074
00:38:38,480 --> 00:38:40,640
activity but not alert fatigue so it's

1075
00:38:40,640 --> 00:38:44,000
just about doing that tuning

1076
00:38:44,000 --> 00:38:47,839
any other questions yep what's up

1077
00:38:50,480 --> 00:38:51,680
meaning that you need some way of

1078
00:38:51,680 --> 00:38:52,720
detecting

1079
00:38:52,720 --> 00:38:54,960
have you ever dealt with or and maybe

1080
00:38:54,960 --> 00:38:58,359
how's your deal

1081
00:39:09,680 --> 00:39:11,920
all right so the question was around uh

1082
00:39:11,920 --> 00:39:15,040
a lot of these detections are host based

1083
00:39:15,040 --> 00:39:15,839
so

1084
00:39:15,839 --> 00:39:17,119
one of the big things that you have to

1085
00:39:17,119 --> 00:39:18,960
understand if we go back to it real

1086
00:39:18,960 --> 00:39:20,240
quick

1087
00:39:20,240 --> 00:39:22,880
is to actually catch a fair amount of

1088
00:39:22,880 --> 00:39:26,040
the techniques

1089
00:39:30,800 --> 00:39:32,320
to actually catch a fair amount of the

1090
00:39:32,320 --> 00:39:34,160
techniques we actually do need command

1091
00:39:34,160 --> 00:39:37,920
execution and we need process creation

1092
00:39:37,920 --> 00:39:39,359
um one of the first things that

1093
00:39:39,359 --> 00:39:40,960
typically happens with modern day

1094
00:39:40,960 --> 00:39:42,400
incident responses is they come in and

1095
00:39:42,400 --> 00:39:43,680
they throw an eer on there because you

1096
00:39:43,680 --> 00:39:46,240
need those hosts or that host

1097
00:39:46,240 --> 00:39:48,000
data

1098
00:39:48,000 --> 00:39:50,560
so from there to address your question

1099
00:39:50,560 --> 00:39:51,760
is

1100
00:39:51,760 --> 00:39:53,119
if you have someone who doesn't have an

1101
00:39:53,119 --> 00:39:55,920
edr deployed yet most often they also

1102
00:39:55,920 --> 00:39:57,920
don't decrypt ssl

1103
00:39:57,920 --> 00:39:59,280
so you're also not going to be able to

1104
00:39:59,280 --> 00:40:02,079
look inside that traffic either

1105
00:40:02,079 --> 00:40:04,560
to do the network side so now you're

1106
00:40:04,560 --> 00:40:06,800
pretty much flying blind

1107
00:40:06,800 --> 00:40:08,400
so what do you do

1108
00:40:08,400 --> 00:40:11,760
well what we did one time was we had a

1109
00:40:11,760 --> 00:40:14,319
case study where we got charged with

1110
00:40:14,319 --> 00:40:16,000
improving detections without spending

1111
00:40:16,000 --> 00:40:18,160
any more money and what we did was we

1112
00:40:18,160 --> 00:40:19,920
deployed sysmon

1113
00:40:19,920 --> 00:40:21,920
so that we actually got the logging

1114
00:40:21,920 --> 00:40:23,599
capabilities that we needed and the

1115
00:40:23,599 --> 00:40:25,680
alerting capabilities and then so from

1116
00:40:25,680 --> 00:40:28,240
sysmon if you're not familiar great tool

1117
00:40:28,240 --> 00:40:31,119
and then look at olaf's modular config

1118
00:40:31,119 --> 00:40:33,119
it's a great one and then you also have

1119
00:40:33,119 --> 00:40:35,200
the common swift on security config as

1120
00:40:35,200 --> 00:40:38,200
well

1121
00:40:43,839 --> 00:40:45,280
potentially yes

1122
00:40:45,280 --> 00:40:47,359
but it is a cheaper route and then oh by

1123
00:40:47,359 --> 00:40:50,400
the way um another way of actually doing

1124
00:40:50,400 --> 00:40:52,560
a good substitute

1125
00:40:52,560 --> 00:40:55,760
florian ross company actually they

1126
00:40:55,760 --> 00:40:58,800
nextron i believe they came out with uh

1127
00:40:58,800 --> 00:41:01,040
a aura agent

1128
00:41:01,040 --> 00:41:04,800
and it's it actually runs on the host

1129
00:41:04,800 --> 00:41:07,200
the sigma rules

1130
00:41:07,200 --> 00:41:08,720
so it's actually great because you

1131
00:41:08,720 --> 00:41:09,920
actually don't have to collect all the

1132
00:41:09,920 --> 00:41:12,079
system on and then configure your sim

1133
00:41:12,079 --> 00:41:14,000
with the signal rules you can actually

1134
00:41:14,000 --> 00:41:16,400
just deploy this and then send whatever

1135
00:41:16,400 --> 00:41:19,119
alerts come back so it's actually it's a

1136
00:41:19,119 --> 00:41:21,040
very powerful tool that i think a lot of

1137
00:41:21,040 --> 00:41:22,880
people will start using as kind of a

1138
00:41:22,880 --> 00:41:25,520
makeshift edr for those type of setups

1139
00:41:25,520 --> 00:41:26,960
where it's like i need something on the

1140
00:41:26,960 --> 00:41:28,079
cheap

1141
00:41:28,079 --> 00:41:29,920
okay go deploy this and at least you're

1142
00:41:29,920 --> 00:41:31,839
gonna have those edr alerts even if you

1143
00:41:31,839 --> 00:41:34,400
don't have that edr visibility but now

1144
00:41:34,400 --> 00:41:36,480
you know which system to go get and

1145
00:41:36,480 --> 00:41:38,560
start looking into or deploy system on

1146
00:41:38,560 --> 00:41:42,240
to or whatnot great question

1147
00:41:42,240 --> 00:41:44,240
anyone else i think we got time for

1148
00:41:44,240 --> 00:41:46,800
about two more questions

1149
00:41:46,800 --> 00:41:48,960
yeah what's up how do you feel about

1150
00:41:48,960 --> 00:41:51,359
secondhand detection what i mean by that

1151
00:41:51,359 --> 00:41:54,319
think of your mcas or any other product

1152
00:41:54,319 --> 00:41:56,720
correlation kind of black box

1153
00:41:56,720 --> 00:41:57,839
how do you handle companies that are

1154
00:41:57,839 --> 00:41:59,680
like hey i want that

1155
00:41:59,680 --> 00:42:03,560
one you don't have

1156
00:42:05,359 --> 00:42:07,200
all right so the question is is when you

1157
00:42:07,200 --> 00:42:09,359
have like a company who doesn't tell you

1158
00:42:09,359 --> 00:42:11,839
why a detection fire but the customer

1159
00:42:11,839 --> 00:42:14,079
also wants that detection in a different

1160
00:42:14,079 --> 00:42:15,200
environment

1161
00:42:15,200 --> 00:42:16,400
um

1162
00:42:16,400 --> 00:42:17,920
probably talking about mania if i had to

1163
00:42:17,920 --> 00:42:20,160
guess

1164
00:42:20,480 --> 00:42:21,760
google now

1165
00:42:21,760 --> 00:42:23,920
i think it's google

1166
00:42:23,920 --> 00:42:25,520
so yeah that's going to be a tough one

1167
00:42:25,520 --> 00:42:26,319
right

1168
00:42:26,319 --> 00:42:28,560
but what you can do typically is

1169
00:42:28,560 --> 00:42:31,680
if if they wrote at least the alert well

1170
00:42:31,680 --> 00:42:33,040
enough

1171
00:42:33,040 --> 00:42:34,160
you can get an idea of what it's

1172
00:42:34,160 --> 00:42:35,839
flagging on

1173
00:42:35,839 --> 00:42:37,520
or what you can do is

1174
00:42:37,520 --> 00:42:39,680
because a lot of them now are tagging to

1175
00:42:39,680 --> 00:42:41,680
at least a technique level

1176
00:42:41,680 --> 00:42:43,760
so you can probably go

1177
00:42:43,760 --> 00:42:45,680
you know start doing some different

1178
00:42:45,680 --> 00:42:47,839
procedures maybe start with like some

1179
00:42:47,839 --> 00:42:50,480
atomic reds for that technique until

1180
00:42:50,480 --> 00:42:52,560
that alert fires again and then now you

1181
00:42:52,560 --> 00:42:54,079
know what that technique was and then

1182
00:42:54,079 --> 00:42:55,599
you can map it to something that's

1183
00:42:55,599 --> 00:42:56,800
internal

1184
00:42:56,800 --> 00:42:58,880
to you or like a sigma rule if that

1185
00:42:58,880 --> 00:43:01,280
makes sense

1186
00:43:01,280 --> 00:43:03,119
but yeah you can i mean if you if you

1187
00:43:03,119 --> 00:43:04,720
ham jam it enough you'll figure out what

1188
00:43:04,720 --> 00:43:07,359
what fires that sucker

1189
00:43:07,359 --> 00:43:09,440
all right come on we got questions one

1190
00:43:09,440 --> 00:43:12,440
more

1191
00:43:19,440 --> 00:43:21,040
all right so the question was how are we

1192
00:43:21,040 --> 00:43:23,280
updating our ttps

1193
00:43:23,280 --> 00:43:26,720
and thread actor information um

1194
00:43:26,720 --> 00:43:28,800
so this is like a tough area right

1195
00:43:28,800 --> 00:43:30,000
because

1196
00:43:30,000 --> 00:43:32,319
a lot of reports don't contain procedure

1197
00:43:32,319 --> 00:43:34,800
level intelligence

1198
00:43:34,800 --> 00:43:37,040
and so what we actually have done is we

1199
00:43:37,040 --> 00:43:39,040
went out we hired jake williams who's a

1200
00:43:39,040 --> 00:43:40,480
former uh

1201
00:43:40,480 --> 00:43:42,319
i don't know if i can i think he comes

1202
00:43:42,319 --> 00:43:43,760
out he's publicly said he worked for

1203
00:43:43,760 --> 00:43:46,400
three-letter agency um and he's a sans

1204
00:43:46,400 --> 00:43:48,880
instructor he wrote like the top sans

1205
00:43:48,880 --> 00:43:51,119
uh the hardest sans course which is like

1206
00:43:51,119 --> 00:43:53,359
advanced exploit development so we went

1207
00:43:53,359 --> 00:43:54,960
out and we hired him

1208
00:43:54,960 --> 00:43:58,480
uh if you are on twitter malwarejake

1209
00:43:58,480 --> 00:44:00,640
shout out to him he's been awesome so

1210
00:44:00,640 --> 00:44:02,319
far and i'm sure he's gonna do even more

1211
00:44:02,319 --> 00:44:04,400
amazing stuff so we're going out and

1212
00:44:04,400 --> 00:44:05,839
we're actually building out how to get

1213
00:44:05,839 --> 00:44:08,079
more procedure level

1214
00:44:08,079 --> 00:44:09,119
in-house

1215
00:44:09,119 --> 00:44:11,599
but the other area that we're looking at

1216
00:44:11,599 --> 00:44:13,920
is what you can do right now is go out

1217
00:44:13,920 --> 00:44:16,400
and read reports so in the instance that

1218
00:44:16,400 --> 00:44:19,839
i showed you where we actually had

1219
00:44:19,839 --> 00:44:21,359
the

1220
00:44:21,359 --> 00:44:24,400
microsoft report

1221
00:44:27,599 --> 00:44:29,920
so we have the microsoft report

1222
00:44:29,920 --> 00:44:32,160
and we can see right here what what

1223
00:44:32,160 --> 00:44:33,440
they're doing so it's one of those

1224
00:44:33,440 --> 00:44:34,720
things where you have to go through a

1225
00:44:34,720 --> 00:44:37,680
few reports opencti is actually pretty

1226
00:44:37,680 --> 00:44:39,200
good source where you can get through

1227
00:44:39,200 --> 00:44:40,880
multiple reports until you find

1228
00:44:40,880 --> 00:44:43,119
procedures but it's going out reading

1229
00:44:43,119 --> 00:44:45,119
the intelligence

1230
00:44:45,119 --> 00:44:46,640
that's actually produced this is one of

1231
00:44:46,640 --> 00:44:48,560
those things too most of the time what

1232
00:44:48,560 --> 00:44:51,440
we're doing uh if you're doing detection

1233
00:44:51,440 --> 00:44:53,119
engineering you should be a consummate

1234
00:44:53,119 --> 00:44:55,119
consumer of cyber threat intelligence

1235
00:44:55,119 --> 00:44:56,800
you should go out and read the intel

1236
00:44:56,800 --> 00:44:59,040
reports so if mandy is coming out with a

1237
00:44:59,040 --> 00:45:00,480
report of what a threat actor is doing

1238
00:45:00,480 --> 00:45:01,920
if microsoft's coming out with a report

1239
00:45:01,920 --> 00:45:03,280
of what a threat actor is doing you

1240
00:45:03,280 --> 00:45:05,200
should be reading it and understanding

1241
00:45:05,200 --> 00:45:07,599
what the adversary is doing and then you

1242
00:45:07,599 --> 00:45:09,680
can understand that at a procedure level

1243
00:45:09,680 --> 00:45:11,359
of what they're doing let's do that in

1244
00:45:11,359 --> 00:45:13,520
my environment can i detect it do i have

1245
00:45:13,520 --> 00:45:15,760
response around it and you know that's

1246
00:45:15,760 --> 00:45:17,599
what we're really trying to do purple

1247
00:45:17,599 --> 00:45:19,440
teaming is like the first thing where i

1248
00:45:19,440 --> 00:45:22,400
was like that makes sense to do like

1249
00:45:22,400 --> 00:45:25,599
mlai sure that stuff's coming um

1250
00:45:25,599 --> 00:45:27,920
eventually maybe but

1251
00:45:27,920 --> 00:45:30,079
you know purple team that's the most

1252
00:45:30,079 --> 00:45:31,760
it's the most actionable thing we can do

1253
00:45:31,760 --> 00:45:33,440
right now to actually harden our

1254
00:45:33,440 --> 00:45:35,839
environments and if we just did it a

1255
00:45:35,839 --> 00:45:37,760
little bit more we wouldn't be getting

1256
00:45:37,760 --> 00:45:39,760
the ransomware that's across all these

1257
00:45:39,760 --> 00:45:42,000
organizations with kanti playbook being

1258
00:45:42,000 --> 00:45:45,200
ran over and over and over again i hope

1259
00:45:45,200 --> 00:45:46,720
they talk about in the next talk but

1260
00:45:46,720 --> 00:45:48,160
literally it's the same thing in all

1261
00:45:48,160 --> 00:45:49,680
testsnet.exe

1262
00:45:49,680 --> 00:45:50,960
all these things over and over again

1263
00:45:50,960 --> 00:45:52,480
where if you actually had just a little

1264
00:45:52,480 --> 00:45:55,200
bit of knowledge of how to consume the

1265
00:45:55,200 --> 00:45:57,359
reports coming from like the d3 report

1266
00:45:57,359 --> 00:45:59,200
how to actually just go out read it

1267
00:45:59,200 --> 00:46:00,800
think about it emulate it in my

1268
00:46:00,800 --> 00:46:02,560
environment and then test my detections

1269
00:46:02,560 --> 00:46:04,800
and response against so with that i

1270
00:46:04,800 --> 00:46:06,960
believe i have to wrap up but happy

1271
00:46:06,960 --> 00:46:08,400
threat hunting happy detection

1272
00:46:08,400 --> 00:46:10,079
engineering happy purple teaming get out

1273
00:46:10,079 --> 00:46:11,359
there and kick some butt and let's get

1274
00:46:11,359 --> 00:46:13,440
these uh these adversaries off our

1275
00:46:13,440 --> 00:46:14,890
networks

1276
00:46:14,890 --> 00:46:20,549
[Applause]

1277
00:46:28,880 --> 00:46:30,880
oh by the way there are stickers on

1278
00:46:30,880 --> 00:46:33,280
either side of the uh

1279
00:46:33,280 --> 00:46:36,680
on the stage

1280
00:46:46,400 --> 00:46:49,520
i should have checked it out

