1
00:00:14,460 --> 00:00:17,400
but I will I will try not to disappoint

2
00:00:17,400 --> 00:00:20,850
that the we're gonna do the super secret

3
00:00:20,850 --> 00:00:24,540
sauce I did realize afterwards that

4
00:00:24,540 --> 00:00:29,040
Italy pick the wrong title not that this

5
00:00:29,040 --> 00:00:32,220
title is wrong but it's just the you

6
00:00:32,220 --> 00:00:34,710
know get everybody here so what we're

7
00:00:34,710 --> 00:00:36,420
going to do today should have been

8
00:00:36,420 --> 00:00:38,460
cutting your endpoints because that's

9
00:00:38,460 --> 00:00:39,600
that's what we're going to talk about

10
00:00:39,600 --> 00:00:44,329
today um so first off though I want to

11
00:00:44,329 --> 00:00:47,910
let's see if I'm getting rate problems

12
00:00:47,910 --> 00:00:55,079
here there we go so first I really want

13
00:00:55,079 --> 00:00:57,210
to put a shout out to our besides

14
00:00:57,210 --> 00:00:59,910
Augusta Conference folks you know the

15
00:00:59,910 --> 00:01:03,149
volunteers the organizers if you don't

16
00:01:03,149 --> 00:01:06,450
know how much effort goes into pulling

17
00:01:06,450 --> 00:01:08,340
one of these things together over a

18
00:01:08,340 --> 00:01:13,800
thousand people register and it's truly

19
00:01:13,800 --> 00:01:16,530
a labor of love and I go to a lot of

20
00:01:16,530 --> 00:01:18,030
conferences I do a fair amount of

21
00:01:18,030 --> 00:01:20,280
speaking cetera and truly this is one of

22
00:01:20,280 --> 00:01:21,899
my favorite conferences every year it

23
00:01:21,899 --> 00:01:28,939
just consists quality etc don't hesitate

24
00:01:29,570 --> 00:01:33,420
icers because they're not they're

25
00:01:33,420 --> 00:01:35,810
literally doing this because they look

26
00:01:35,810 --> 00:01:43,049
doing that so how many heard up there's

27
00:01:43,049 --> 00:01:48,960
dilemma pretty calm nowadays right how

28
00:01:48,960 --> 00:01:53,610
much II with the different okay we've

29
00:01:53,610 --> 00:01:56,759
got a couple three okay so the idea with

30
00:01:56,759 --> 00:01:59,850
the defenders dilemma on the surface it

31
00:01:59,850 --> 00:02:03,479
make on a sense right breeches are

32
00:02:03,479 --> 00:02:10,590
enough because I'm not throw red team

33
00:02:10,590 --> 00:02:13,110
today because one of my folks are in the

34
00:02:13,110 --> 00:02:15,480
audience and the last time I did that I

35
00:02:15,480 --> 00:02:19,230
got then beat up for a good year so so

36
00:02:19,230 --> 00:02:23,550
I'm I do probably my single biggest

37
00:02:23,550 --> 00:02:26,340
distinction in my career is that my

38
00:02:26,340 --> 00:02:28,170
career is longer than most of my

39
00:02:28,170 --> 00:02:31,410
team members lives but uh but that's

40
00:02:31,410 --> 00:02:34,140
what makes it interesting right so so

41
00:02:34,140 --> 00:02:36,180
makes sense on the surface defenders

42
00:02:36,180 --> 00:02:39,060
dilemma I'm a blue person I've got to

43
00:02:39,060 --> 00:02:39,660
defend

44
00:02:39,660 --> 00:02:44,280
I gotta always get it right it does but

45
00:02:44,280 --> 00:02:48,270
I would posit to you that we have

46
00:02:48,270 --> 00:02:53,430
allowed some vendors to take the

47
00:02:53,430 --> 00:02:57,239
narrative of a month this is our space

48
00:02:57,239 --> 00:03:01,320
as practitioners we need to make sure we

49
00:03:01,320 --> 00:03:03,060
keep them this is not a rant on vendors

50
00:03:03,060 --> 00:03:05,280
there's a lot of fantastic vendors out

51
00:03:05,280 --> 00:03:09,510
there but in there trying to distinguish

52
00:03:09,510 --> 00:03:12,540
themselves from the noise they kind of

53
00:03:12,540 --> 00:03:15,269
you know AI all the thing is some guy

54
00:03:15,269 --> 00:03:16,110
reached out on me

55
00:03:16,110 --> 00:03:19,950
Lincoln last week and he said hey we've

56
00:03:19,950 --> 00:03:22,500
got this cool AI base blah blah blah

57
00:03:22,500 --> 00:03:24,510
blah blah and you know I was trying to

58
00:03:24,510 --> 00:03:27,000
be polite no thanks you know not not

59
00:03:27,000 --> 00:03:30,150
interested and his response was well

60
00:03:30,150 --> 00:03:32,000
then how in the world are you defending

61
00:03:32,000 --> 00:03:35,250
against all of the cyber criminals using

62
00:03:35,250 --> 00:03:40,410
AI based attacks that's not actually a

63
00:03:40,410 --> 00:03:44,880
thing so we're good we're good

64
00:03:44,880 --> 00:03:48,209
but we need to be my point here is we

65
00:03:48,209 --> 00:03:50,970
really need to be conscious of terms

66
00:03:50,970 --> 00:03:56,130
like breaches because let's look at an

67
00:03:56,130 --> 00:04:01,950
attack type cycle hey so this called you

68
00:04:01,950 --> 00:04:04,079
know choose your miter attack framework

69
00:04:04,079 --> 00:04:06,930
whichever it is but there's a sequence

70
00:04:06,930 --> 00:04:11,100
of things that has to occur in order for

71
00:04:11,100 --> 00:04:15,360
the bad guys to hurt us okay and whether

72
00:04:15,360 --> 00:04:17,488
you use this model or another really

73
00:04:17,488 --> 00:04:21,029
isn't in critical except that when key

74
00:04:21,029 --> 00:04:25,110
things happen right so first off there's

75
00:04:25,110 --> 00:04:26,850
a foothold right it's it's Monday

76
00:04:26,850 --> 00:04:29,039
morning blood level in my caffeine

77
00:04:29,039 --> 00:04:31,800
system is a little too high and I get

78
00:04:31,800 --> 00:04:34,950
the fish and I click on it right and now

79
00:04:34,950 --> 00:04:37,260
I've remote access trojan running in my

80
00:04:37,260 --> 00:04:41,070
life I would suggest we don't have a

81
00:04:41,070 --> 00:04:42,050
breach

82
00:04:42,050 --> 00:04:45,330
we like to call that in my shop a

83
00:04:45,330 --> 00:04:48,180
prevention failure because we paid for a

84
00:04:48,180 --> 00:04:51,090
whole bunch of this technology that the

85
00:04:51,090 --> 00:04:53,040
vendors all said was going to stop all

86
00:04:53,040 --> 00:04:55,440
of from happening we all know they don't

87
00:04:55,440 --> 00:04:57,720
love it they do a good job of reducing a

88
00:04:57,720 --> 00:05:01,310
ton of it but some gets through right I

89
00:05:01,310 --> 00:05:05,280
would suggest that the the foothold

90
00:05:05,280 --> 00:05:07,980
right that initial axis because it's

91
00:05:07,980 --> 00:05:10,320
it's not good don't get me wrong I'm not

92
00:05:10,320 --> 00:05:13,140
saying that we should be cool about the

93
00:05:13,140 --> 00:05:15,750
prevention failure but we think about

94
00:05:15,750 --> 00:05:19,410
that rat that rat is just a tool being

95
00:05:19,410 --> 00:05:23,330
used by an adversary who has a goal I

96
00:05:23,330 --> 00:05:28,620
would suggest the breach occurs when

97
00:05:28,620 --> 00:05:31,740
they complete their goal right so the

98
00:05:31,740 --> 00:05:35,760
breach doesn't happen and maybe they

99
00:05:35,760 --> 00:05:37,320
want to encrypt my hard drive so they

100
00:05:37,320 --> 00:05:39,390
get a ransom maybe they want to steal

101
00:05:39,390 --> 00:05:41,930
credit cards intellectual whatever their

102
00:05:41,930 --> 00:05:46,290
objective is I would suggest that we

103
00:05:46,290 --> 00:05:48,960
need to be thinking about because if we

104
00:05:48,960 --> 00:05:51,360
do it in this then what that leaves us

105
00:05:51,360 --> 00:05:55,470
is this really interesting speed window

106
00:05:55,470 --> 00:05:58,410
where we as blue team members have an

107
00:05:58,410 --> 00:06:03,180
opportunity to prevent a breach prevent

108
00:06:03,180 --> 00:06:06,390
prevention failures but we can I would

109
00:06:06,390 --> 00:06:11,880
suggest prevent oh then if you taking

110
00:06:11,880 --> 00:06:15,660
the next level I want to give a spout up

111
00:06:15,660 --> 00:06:17,820
to Matt Swan he was the person I

112
00:06:17,820 --> 00:06:26,630
publicly heard use ears can be doing

113
00:06:26,630 --> 00:06:31,919
using are against the bad guys instead

114
00:06:31,919 --> 00:06:35,700
of just rules as I walked showing the

115
00:06:35,700 --> 00:06:39,600
stuff today I'm intentionally just using

116
00:06:39,600 --> 00:06:42,510
scripts because if you're a large

117
00:06:42,510 --> 00:06:44,660
enterprise maybe you've got SCCM

118
00:06:44,660 --> 00:06:46,919
painting a thing like that

119
00:06:46,919 --> 00:06:48,750
you can do the stuff up in dedupe lot

120
00:06:48,750 --> 00:06:52,590
easier but what I love about some of the

121
00:06:52,590 --> 00:06:54,090
techniques were going to discuss this

122
00:06:54,090 --> 00:06:55,050
afternoon

123
00:06:55,050 --> 00:06:57,810
even if you're a small shop you can

124
00:06:57,810 --> 00:07:00,389
leverage these techniques they cost

125
00:07:00,389 --> 00:07:02,210
nothing but a little blood

126
00:07:02,210 --> 00:07:07,860
okay and and the goal here is to build a

127
00:07:07,860 --> 00:07:10,949
detection grid call it a minefield

128
00:07:10,949 --> 00:07:13,530
detection minefield that is so

129
00:07:13,530 --> 00:07:17,449
comprehensive in our organization that

130
00:07:17,449 --> 00:07:21,590
occurs don't know how to navigate it

131
00:07:21,590 --> 00:07:25,139
bumping into one of our detection points

132
00:07:25,139 --> 00:07:29,690
and and this is why this is because I

133
00:07:29,690 --> 00:07:34,199
the defender you know to bump into one

134
00:07:34,199 --> 00:07:36,750
of them and now our mission is off right

135
00:07:36,750 --> 00:07:39,090
I got no there in the matter no they're

136
00:07:39,090 --> 00:07:44,250
here can't go get rid of them but if we

137
00:07:44,250 --> 00:07:51,539
up my for speed and hey so a lot about

138
00:07:51,539 --> 00:07:56,099
okay how do we detect all the thing I'm

139
00:07:56,099 --> 00:08:01,469
a long long proponent of honeypot and

140
00:08:01,469 --> 00:08:03,569
what we're gonna do is use a variation

141
00:08:03,569 --> 00:08:06,719
of that specifically I'm hoping to show

142
00:08:06,719 --> 00:08:09,900
you today is a technique where you can

143
00:08:09,900 --> 00:08:12,840
take your environment right so this is

144
00:08:12,840 --> 00:08:15,539
endpoints some it's maybe servers

145
00:08:15,539 --> 00:08:19,440
laptops doesn't matter and how do we

146
00:08:19,440 --> 00:08:23,039
turn this into that landmine

147
00:08:23,039 --> 00:08:27,479
so the attacker doesn't have a way to

148
00:08:27,479 --> 00:08:30,029
weave without bumping into one of our

149
00:08:30,029 --> 00:08:33,479
detection triggers so that we can know

150
00:08:33,479 --> 00:08:35,789
they're in the environment and go get

151
00:08:35,789 --> 00:08:37,860
rid of them before they complete their

152
00:08:37,860 --> 00:08:43,190
objective and we breach making so are

153
00:08:43,190 --> 00:08:45,839
everybody's asleep after lunch it's all

154
00:08:45,839 --> 00:08:48,540
good so how do we go about doing that

155
00:08:48,540 --> 00:08:52,730
well I I'm a big fan mattress

156
00:08:52,730 --> 00:08:57,260
choose choose two method they're just a

157
00:08:57,260 --> 00:09:01,890
lot of folks do we write more we focus

158
00:09:01,890 --> 00:09:06,510
on how to sure and and if you heard Dave

159
00:09:06,510 --> 00:09:08,810
Kennedy's talk this morning this will

160
00:09:08,810 --> 00:09:13,040
be especially relevant Dave was because

161
00:09:13,040 --> 00:09:17,330
he and I didn't chat about that but here

162
00:09:17,330 --> 00:09:20,870
today is basically focusing on behavior

163
00:09:20,870 --> 00:09:26,260
based detection not maids detection

164
00:09:26,260 --> 00:09:30,170
comments from this morning integer based

165
00:09:30,170 --> 00:09:36,140
detection very eye brittle as the term I

166
00:09:36,140 --> 00:09:39,320
would use it's really protecting what

167
00:09:39,320 --> 00:09:42,920
it's about a little bit of change lost

168
00:09:42,920 --> 00:09:47,570
everything right so so in particular we

169
00:09:47,570 --> 00:09:50,810
know that the attackers are going to

170
00:09:50,810 --> 00:09:53,660
delay privileges no unless their only

171
00:09:53,660 --> 00:09:57,050
thing they want to is encrypt that that

172
00:09:57,050 --> 00:09:59,870
they're on they're going to get some

173
00:09:59,870 --> 00:10:02,870
sort credits to fret by a lateral

174
00:10:02,870 --> 00:10:07,670
movement oh you know yeah that work

175
00:10:07,670 --> 00:10:09,710
they've got to have some way of

176
00:10:09,710 --> 00:10:11,870
communicating in the systems with an

177
00:10:11,870 --> 00:10:14,810
environment it's very very few attacks

178
00:10:14,810 --> 00:10:16,750
where they don't need some sort of

179
00:10:16,750 --> 00:10:19,670
admittance right so that they can access

180
00:10:19,670 --> 00:10:23,960
all the things so let's focus on that

181
00:10:23,960 --> 00:10:28,339
need okay and if I've been to the the

182
00:10:28,339 --> 00:10:30,980
attack framework in particular here's a

183
00:10:30,980 --> 00:10:34,970
snippet on the mitre attack frame it is

184
00:10:34,970 --> 00:10:39,470
a common goal of the effort is in their

185
00:10:39,470 --> 00:10:43,220
attack and that's the pain credentials

186
00:10:43,220 --> 00:10:46,970
right they get them from look ashes all

187
00:10:46,970 --> 00:10:49,490
sorts of places right and again this is

188
00:10:49,490 --> 00:10:52,700
just a snippet hopefully your attack

189
00:10:52,700 --> 00:10:55,970
framework now go out to that URL and

190
00:10:55,970 --> 00:10:58,550
read up on it a lot a lot of good work

191
00:10:58,550 --> 00:11:03,170
do out there alright so we nip bad guys

192
00:11:03,170 --> 00:11:06,980
want this stuff so how do we give it to

193
00:11:06,980 --> 00:11:11,029
them well what I propose is that you

194
00:11:11,029 --> 00:11:17,860
consider using those as lures if

195
00:11:23,239 --> 00:11:34,949
with the way that looks at the depot is

196
00:11:34,949 --> 00:11:37,919
stumble into one of these and we're off

197
00:11:37,919 --> 00:11:41,309
to the races right so how do we then go

198
00:11:41,309 --> 00:11:44,159
about weaponizing all right I'm actually

199
00:11:44,159 --> 00:11:47,899
gonna stop

200
00:12:01,279 --> 00:12:08,209
might get the simple but the the ones

201
00:12:08,209 --> 00:12:16,850
that are gonna hurt us as we build them

202
00:12:16,850 --> 00:12:19,639
and I then we'll circle back on that

203
00:12:19,639 --> 00:12:25,129
then the second step its eight names oh

204
00:12:25,129 --> 00:12:28,779
I'm gonna walk through all of this and

205
00:12:29,139 --> 00:12:32,329
but we're gonna create a bunch and you

206
00:12:32,329 --> 00:12:34,399
probably want to think like you leave

207
00:12:34,399 --> 00:12:37,249
small shop probably think about the

208
00:12:37,249 --> 00:12:42,470
Bulls of these okay again we talk the

209
00:12:42,470 --> 00:12:45,199
maximum realness talk about the caveats

210
00:12:45,199 --> 00:12:49,930
there that that I've run into is we're

211
00:12:50,589 --> 00:12:54,819
again locally on our end points which

212
00:12:54,819 --> 00:12:59,420
counts ashed locally okay

213
00:12:59,420 --> 00:13:04,879
there's winter to be looking at we're

214
00:13:04,879 --> 00:13:09,309
gonna go through step here we also add

215
00:13:09,309 --> 00:13:12,850
some local cash credentials to strength

216
00:13:12,850 --> 00:13:16,850
I'll talk about why in just a minute and

217
00:13:16,850 --> 00:13:21,610
I want you change the allure a account

218
00:13:21,610 --> 00:13:28,790
on I've searched is we can this ideally

219
00:13:28,790 --> 00:13:31,730
I'd prefer to disable the account the

220
00:13:31,730 --> 00:13:37,899
problem you stop alerting

221
00:13:42,050 --> 00:13:44,700
so if you err accounts unless those

222
00:13:44,700 --> 00:13:48,450
accounts are Li live so what what I'll

223
00:13:48,450 --> 00:13:50,850
do here is a sample I'm just generating

224
00:13:50,850 --> 00:13:52,920
a random character password and change

225
00:13:52,920 --> 00:13:54,930
the password to that right make it

226
00:13:54,930 --> 00:13:56,810
essentially impossible to login

227
00:13:56,810 --> 00:13:58,019
absolutely

228
00:13:58,019 --> 00:14:00,570
and then last but not least of course

229
00:14:00,570 --> 00:14:03,959
some alerting so you know that my

230
00:14:03,959 --> 00:14:06,540
earlier scenario where my my blood

231
00:14:06,540 --> 00:14:08,490
levels too high in the caffeine system

232
00:14:08,490 --> 00:14:10,890
I've now got that at running on my

233
00:14:10,890 --> 00:14:14,370
laptop the adversary dumps out runs me

234
00:14:14,370 --> 00:14:17,430
me cats or whatever you know use your

235
00:14:17,430 --> 00:14:23,550
credential dump er of choice and the

236
00:14:23,550 --> 00:14:26,310
beauty of this is that individual if

237
00:14:26,310 --> 00:14:27,720
we've created these accounts properly

238
00:14:27,720 --> 00:14:31,110
has no way to know which are real and

239
00:14:31,110 --> 00:14:34,640
which aren't right until they try them

240
00:14:34,640 --> 00:14:39,329
which is entirely the point right so the

241
00:14:39,329 --> 00:14:43,730
alert and and then it's bad guy fall for

242
00:14:43,730 --> 00:14:48,180
bully and a bada-bing out of boom

243
00:14:48,180 --> 00:14:51,540
so so do you have some background on how

244
00:14:51,540 --> 00:14:55,649
when medication works ok um particularly

245
00:14:55,649 --> 00:14:57,930
relevant a lot of people aren't aware

246
00:14:57,930 --> 00:15:00,209
Microsoft made some very significant

247
00:15:00,209 --> 00:15:05,450
changes actually with Windows Vista

248
00:15:05,450 --> 00:15:08,520
we beat poor Microsoft up a bunch of

249
00:15:08,520 --> 00:15:12,600
years for serious beat us up for a bunch

250
00:15:12,600 --> 00:15:15,839
of years because originally prior to

251
00:15:15,839 --> 00:15:18,180
Windows Vista the locally cached

252
00:15:18,180 --> 00:15:21,149
credentials so we capped credentials or

253
00:15:21,149 --> 00:15:23,820
so I login to my laptop at work I've got

254
00:15:23,820 --> 00:15:25,380
access you know that my computer has

255
00:15:25,380 --> 00:15:27,000
access to the main controller I can

256
00:15:27,000 --> 00:15:29,490
authenticate great I take my laptop home

257
00:15:29,490 --> 00:15:31,620
I can't connect to my domain controller

258
00:15:31,620 --> 00:15:34,589
or more correctly my computer pick

259
00:15:34,589 --> 00:15:37,790
domain controller

260
00:15:45,359 --> 00:15:51,549
regionally prior to this option so

261
00:15:51,549 --> 00:15:53,290
essentially when your windows was

262
00:15:53,290 --> 00:15:57,489
installed a unique key was generated for

263
00:15:57,489 --> 00:16:00,249
your during your computer only nor

264
00:16:00,249 --> 00:16:03,939
Kerala in the registry that key was used

265
00:16:03,939 --> 00:16:07,449
to decrypt the contents of the cache of

266
00:16:07,449 --> 00:16:10,269
course the the you know the algorithm

267
00:16:10,269 --> 00:16:12,399
got out so bad guys could decrypt them

268
00:16:12,399 --> 00:16:17,249
our days with algorithm as MSD CCB to

269
00:16:17,249 --> 00:16:20,979
your credentials are hashed and then

270
00:16:20,979 --> 00:16:23,499
encrypted with that it is a super strong

271
00:16:23,499 --> 00:16:27,399
it's not beyond crackable but unless you

272
00:16:27,399 --> 00:16:29,699
happen to be working for a nation-state

273
00:16:29,699 --> 00:16:34,720
probably not crackable is crackable but

274
00:16:34,720 --> 00:16:37,569
we'll talk about ways to deal with that

275
00:16:37,569 --> 00:16:40,509
in just a minute so that's why the

276
00:16:40,509 --> 00:16:42,249
credential process works that way and

277
00:16:42,249 --> 00:16:45,819
how that goes and in particular there's

278
00:16:45,819 --> 00:16:48,819
a couple tip it's on Apollo that are

279
00:16:48,819 --> 00:16:51,759
really useful for us so what this so

280
00:16:51,759 --> 00:16:54,910
this is just for the human at that URL

281
00:16:54,910 --> 00:16:57,089
right there okay

282
00:16:57,089 --> 00:16:59,499
and all these slides are by the way up

283
00:16:59,499 --> 00:17:01,720
on my dick github I'll have a link to it

284
00:17:01,720 --> 00:17:05,519
at the end of the deck so these are the

285
00:17:05,519 --> 00:17:10,119
five things that cause credentials to be

286
00:17:10,119 --> 00:17:14,138
cached locally on your Windows box so

287
00:17:14,138 --> 00:17:19,750
you RDP ask so forth well so from our

288
00:17:19,750 --> 00:17:22,809
perspective probably the best ways for

289
00:17:22,809 --> 00:17:25,510
us to so we could RTP but I don't know

290
00:17:25,510 --> 00:17:27,519
about your environment I I have a couple

291
00:17:27,519 --> 00:17:30,159
hundred thousand endpoints Rd peeing to

292
00:17:30,159 --> 00:17:34,200
them seems like problem if I want to

293
00:17:34,200 --> 00:17:38,019
write there mechanisms running a

294
00:17:38,019 --> 00:17:40,889
scheduled task is attack this works

295
00:17:40,889 --> 00:17:44,860
right so you can piece a back to

296
00:17:44,860 --> 00:17:46,720
schedule a task on the Rope remote

297
00:17:46,720 --> 00:17:48,820
computer or you can use path scheduler

298
00:17:48,820 --> 00:17:51,850
to leave with some scripting as soon as

299
00:17:51,850 --> 00:17:54,909
that cat that tasks ones under the the

300
00:17:54,909 --> 00:17:57,180
fake credit

301
00:17:57,180 --> 00:17:59,480
that you've created then it will cash

302
00:17:59,480 --> 00:18:02,790
ugly today however we're going to use

303
00:18:02,790 --> 00:18:06,330
the run ass which I found is cut this

304
00:18:06,330 --> 00:18:09,750
list up these techniques in order to

305
00:18:09,750 --> 00:18:12,360
what we want the other thing I want to

306
00:18:12,360 --> 00:18:16,350
call out which is relevant or but useful

307
00:18:16,350 --> 00:18:25,350
data is this piece of credentials hashed

308
00:18:25,350 --> 00:18:29,790
and stored on your computer again a lot

309
00:18:29,790 --> 00:18:31,920
of folks aren't you know haven't done

310
00:18:31,920 --> 00:18:34,950
the homework to realize there's a ton of

311
00:18:34,950 --> 00:18:38,870
things that windows potentially stores

312
00:18:38,870 --> 00:18:42,680
and by the way these techniques work on

313
00:18:42,680 --> 00:18:44,790
specifics are just slightly different

314
00:18:44,790 --> 00:18:47,330
right but the same principles apply

315
00:18:47,330 --> 00:18:51,570
those are useful as you'll see as we get

316
00:18:51,570 --> 00:18:55,490
just a little bit so enough of me blah

317
00:18:55,490 --> 00:19:02,990
that's good so what

318
00:19:08,250 --> 00:19:14,080
Rumpel life a lot of inner be able to

319
00:19:14,080 --> 00:19:16,240
eat the leeks so I'm running a witness

320
00:19:16,240 --> 00:19:20,880
2006 server and a Windows 10 server VM

321
00:19:20,880 --> 00:19:26,080
Windows 10 workstation VM sorry Wow

322
00:19:26,080 --> 00:19:30,940
brain brain blank there now so for full

323
00:19:30,940 --> 00:19:32,620
disclosure I have fully turned off

324
00:19:32,620 --> 00:19:34,299
Windows Defender and stuff because I'm

325
00:19:34,299 --> 00:19:35,679
going to use me me cats and some tools

326
00:19:35,679 --> 00:19:43,000
like that if you can go to know that the

327
00:19:43,000 --> 00:19:46,450
tools and being them past the the

328
00:19:46,450 --> 00:19:50,530
protections just a foregone conclusion

329
00:19:50,530 --> 00:19:54,940
unfortunately it's further tempting the

330
00:19:54,940 --> 00:19:58,630
demo just I turned it off but I I want

331
00:19:58,630 --> 00:20:01,150
you to know that I kind of cheating a

332
00:20:01,150 --> 00:20:03,190
little bit so let's start with our

333
00:20:03,190 --> 00:20:06,940
Windows 10 computer as you can see I've

334
00:20:06,940 --> 00:20:10,480
logged in here let's add another user to

335
00:20:10,480 --> 00:20:11,110
the cache

336
00:20:11,110 --> 00:20:14,890
so Doug works works with me I'm gonna

337
00:20:14,890 --> 00:20:18,480
pretend and so will sign mr. Burke in

338
00:20:18,480 --> 00:20:27,010
and he has secured 2018 alright we've

339
00:20:27,010 --> 00:20:28,929
signed Doug in now I did that because

340
00:20:28,929 --> 00:20:31,720
what you're seeing is because I've done

341
00:20:31,720 --> 00:20:36,130
a local law Windows ascetic but and in

342
00:20:36,130 --> 00:20:38,380
my research I did a lot of approaches

343
00:20:38,380 --> 00:20:41,440
where one of the things i did was i went

344
00:20:41,440 --> 00:20:44,530
in and i just added directly to the

345
00:20:44,530 --> 00:20:47,710
registry the the cache credentials and

346
00:20:47,710 --> 00:20:51,730
that works the problem is I realized as

347
00:20:51,730 --> 00:20:53,740
I was working through this is that

348
00:20:53,740 --> 00:20:57,070
doesn't create all of the windows

349
00:20:57,070 --> 00:21:01,299
artifacts created when you log in

350
00:21:01,299 --> 00:21:04,480
locally to a host and so we could do

351
00:21:04,480 --> 00:21:06,309
that the artifacts are fairly

352
00:21:06,309 --> 00:21:08,740
straightforward but there's north of a

353
00:21:08,740 --> 00:21:09,700
hundred of them

354
00:21:09,700 --> 00:21:13,059
okay and I I don't know about you but

355
00:21:13,059 --> 00:21:15,130
I'm a fan of taking the simplest

356
00:21:15,130 --> 00:21:19,330
expedient route so ergo this is why I'm

357
00:21:19,330 --> 00:21:19,900
logging

358
00:21:19,900 --> 00:21:22,660
in locally or in this case using a

359
00:21:22,660 --> 00:21:25,540
script technique to log in locally and

360
00:21:25,540 --> 00:21:28,750
that way we let Windows create all of

361
00:21:28,750 --> 00:21:31,420
those facts because again remember we're

362
00:21:31,420 --> 00:21:34,360
going for maximum realism I don't want

363
00:21:34,360 --> 00:21:38,080
to tip off the adversary that my lure

364
00:21:38,080 --> 00:21:39,880
accounts that I'm going to add into this

365
00:21:39,880 --> 00:21:43,240
system are not actually me so so I

366
00:21:43,240 --> 00:21:46,840
signed in as Doug just to show you that

367
00:21:46,840 --> 00:21:49,540
you know that's what you this is the

368
00:21:49,540 --> 00:21:52,590
effect we're trying to achieve as is

369
00:21:52,590 --> 00:21:55,660
what I am not very well trying to say

370
00:21:55,660 --> 00:21:57,520
all right so let me sign back out it's

371
00:21:57,520 --> 00:22:03,840
Doug sign back in as myself Tim see and

372
00:22:03,840 --> 00:22:09,400
as you can see I have an equal to keep

373
00:22:09,400 --> 00:22:14,320
password this mr. Burke's because he's a

374
00:22:14,320 --> 00:22:14,920
good guy

375
00:22:14,920 --> 00:22:18,220
all right so sign into Windows 10 so

376
00:22:18,220 --> 00:22:20,020
let's look around a little bit so that

377
00:22:20,020 --> 00:22:22,660
we can understand what some of this

378
00:22:22,660 --> 00:22:23,350
stuff

379
00:22:23,350 --> 00:22:25,650
looks like that we've got to deal with

380
00:22:25,650 --> 00:22:26,920
all right

381
00:22:26,920 --> 00:22:31,060
so yep I'm gonna fire up a admin console

382
00:22:31,060 --> 00:22:35,290
here I'm gonna switch over to my

383
00:22:35,290 --> 00:22:39,550
conveniently installed Mimi Katz and run

384
00:22:39,550 --> 00:22:47,550
that of course we've got to turn on our

385
00:22:47,550 --> 00:22:53,310
debug mode oh there I go sorry lost

386
00:22:53,310 --> 00:22:56,830
sight there all right so we've got debug

387
00:22:56,830 --> 00:22:59,440
mode turned on so let's look at a few of

388
00:22:59,440 --> 00:23:02,560
these credentials right so first of all

389
00:23:02,560 --> 00:23:09,070
let's validate Who I am

390
00:23:09,070 --> 00:23:15,130
so you can see I've got Tim see right Oh

391
00:23:15,130 --> 00:23:17,680
so I'm gonna need a little higher

392
00:23:17,680 --> 00:23:22,120
privileges here oops

393
00:23:22,120 --> 00:23:28,360
let's try token : elevate there we go

394
00:23:28,360 --> 00:23:32,760
all right now I've got a system token

395
00:23:32,760 --> 00:23:34,830
so this in turn of course gives me the

396
00:23:34,830 --> 00:23:40,250
ability to do things like an LSA Dom

397
00:23:40,250 --> 00:23:45,510
Ellis a so LSA pump of LSA is just my

398
00:23:45,510 --> 00:23:48,450
local accounts so these are not the

399
00:23:48,450 --> 00:23:51,990
domain accounts that this machine is

400
00:23:51,990 --> 00:23:54,750
joined to just the local accounts in the

401
00:23:54,750 --> 00:24:00,530
system what often our adversaries are

402
00:24:00,530 --> 00:24:03,270
interested in is our cashed accounts

403
00:24:03,270 --> 00:24:05,970
notice I've got two locally cached

404
00:24:05,970 --> 00:24:08,340
accounts at this point so I've got Doug

405
00:24:08,340 --> 00:24:10,260
account because I just signed in with

406
00:24:10,260 --> 00:24:13,680
that and of course my C account that I'm

407
00:24:13,680 --> 00:24:16,380
currently logged in with also of

408
00:24:16,380 --> 00:24:20,100
interest based upon the attack list and

409
00:24:20,100 --> 00:24:22,230
a bunch of time working with the

410
00:24:22,230 --> 00:24:24,390
adversary we've got a whole bunch of

411
00:24:24,390 --> 00:24:29,220
secrets installed in here okay one thing

412
00:24:29,220 --> 00:24:31,140
that's probably worth pointing out

413
00:24:31,140 --> 00:24:34,470
actually lest I forget I mentioned the

414
00:24:34,470 --> 00:24:39,120
MSD CC b2 algorithm I showed the

415
00:24:39,120 --> 00:24:42,150
passwords not to actually intend to poke

416
00:24:42,150 --> 00:24:45,300
fun at Doug but because I wanted to show

417
00:24:45,300 --> 00:24:46,830
that those passwords are the same

418
00:24:46,830 --> 00:24:51,320
password notice that the MS cash v2

419
00:24:51,320 --> 00:24:53,910
stored credentials are completely

420
00:24:53,910 --> 00:24:55,290
different and that's because of the

421
00:24:55,290 --> 00:24:57,480
hashing that's taking place even though

422
00:24:57,480 --> 00:25:00,560
is encrypted with the same local system

423
00:25:00,560 --> 00:25:05,460
okay and hence right they're more

424
00:25:05,460 --> 00:25:11,690
difficult to - at this point so then

425
00:25:11,870 --> 00:25:17,400
let's say dump on us from yep we're

426
00:25:17,400 --> 00:25:21,090
joined to the poem Corp domain because

427
00:25:21,090 --> 00:25:24,110
of course why wouldn't you name your

428
00:25:24,110 --> 00:25:28,020
company poem Corp especially if you're

429
00:25:28,020 --> 00:25:30,810
going to do demos all right so now now I

430
00:25:30,810 --> 00:25:32,610
switch to the to the Active Directory

431
00:25:32,610 --> 00:25:35,490
server so so step one as well plan out

432
00:25:35,490 --> 00:25:39,360
our so this is where we won't think what

433
00:25:39,360 --> 00:25:42,240
are the domain accounts that are

434
00:25:42,240 --> 00:25:45,210
typically leveraged by adversaries a lot

435
00:25:45,210 --> 00:25:46,570
of times things

436
00:25:46,570 --> 00:25:49,320
like your desktop administrator group

437
00:25:49,320 --> 00:25:52,120
right so I'm a user

438
00:25:52,120 --> 00:25:55,149
I call it my printers not working I need

439
00:25:55,149 --> 00:26:00,549
some help the desktop support folks who

440
00:26:00,549 --> 00:26:04,929
have a domain account RDP to my my

441
00:26:04,929 --> 00:26:06,759
machine so they can fix my printer

442
00:26:06,759 --> 00:26:08,769
problem because they've already peed it

443
00:26:08,769 --> 00:26:12,159
got cached locally often that is the

444
00:26:12,159 --> 00:26:15,190
type of accounts that are used by the

445
00:26:15,190 --> 00:26:18,730
ever so what we're gonna want to do is

446
00:26:18,730 --> 00:26:26,139
use things that you're on an Active

447
00:26:26,139 --> 00:26:29,409
Directory and there we go my click is

448
00:26:29,409 --> 00:26:33,779
not Active Directory users and groups

449
00:26:33,779 --> 00:26:36,789
you can see in in running through

450
00:26:36,789 --> 00:26:41,250
Samantha's set up early a desktop admin

451
00:26:41,250 --> 00:26:46,269
so let's you so simple here we're going

452
00:26:46,269 --> 00:26:54,580
to create a new user new user will call

453
00:26:54,580 --> 00:27:03,070
him Bob no let's call him Phil we all

454
00:27:03,070 --> 00:27:05,259
know how good Phil is supporting people

455
00:27:05,259 --> 00:27:10,470
and his desktop user ID we're gonna call

456
00:27:10,470 --> 00:27:18,370
desktop admin Oh - ok so we're just like

457
00:27:18,370 --> 00:27:21,490
we'd create any other account I'm gonna

458
00:27:21,490 --> 00:27:24,940
uncheck the youth and then give it a

459
00:27:24,940 --> 00:27:36,159
password so I'm gonna go past 20 18 you

460
00:27:36,159 --> 00:27:38,350
we want to think about using something

461
00:27:38,350 --> 00:27:42,009
even realistic for this only because if

462
00:27:42,009 --> 00:27:44,559
you've got an adversary who is capable

463
00:27:44,559 --> 00:27:50,139
of cracking some of these hashes just

464
00:27:50,139 --> 00:27:53,860
want to be safe right relatively I'm

465
00:27:53,860 --> 00:27:58,809
sure your company's your your bad

466
00:27:58,809 --> 00:28:00,490
passwords like pet

467
00:28:00,490 --> 00:28:03,250
a team bang bang you know they would

468
00:28:03,250 --> 00:28:03,940
never do that

469
00:28:03,940 --> 00:28:08,980
um oh I've already got a feeling I don't

470
00:28:08,980 --> 00:28:11,620
think so will we will this is Phil's

471
00:28:11,620 --> 00:28:16,090
brother Bob there we go

472
00:28:16,090 --> 00:28:19,750
and of course uh we've now created count

473
00:28:19,750 --> 00:28:22,990
right so our Bob plan Tamara we want to

474
00:28:22,990 --> 00:28:25,179
go out now in properties because of

475
00:28:25,179 --> 00:28:28,980
course what we want to do is add

476
00:28:28,980 --> 00:28:32,410
privileges oh that's because I had

477
00:28:32,410 --> 00:28:34,179
clicked to click done wonderful I'm

478
00:28:34,179 --> 00:28:38,800
getting that limited so we want him to

479
00:28:38,800 --> 00:28:46,900
be a member of our domain admins this

480
00:28:46,900 --> 00:28:49,090
doesn't necessarily mean be your domain

481
00:28:49,090 --> 00:28:51,940
admin again pick something appropriate

482
00:28:51,940 --> 00:28:55,320
if you've got support folks in your

483
00:28:55,320 --> 00:28:57,520
organization you might want to do

484
00:28:57,520 --> 00:28:59,590
something like that maybe you've got

485
00:28:59,590 --> 00:29:01,540
some mid-level it's a good idea to you

486
00:29:01,540 --> 00:29:03,370
know again go out look at your your

487
00:29:03,370 --> 00:29:06,010
actual population pool pick something

488
00:29:06,010 --> 00:29:09,490
appropriate so now we've got a bob plan

489
00:29:09,490 --> 00:29:14,830
Tamira user in our system right and his

490
00:29:14,830 --> 00:29:19,740
account name is desktop admin Oh - okay

491
00:29:19,740 --> 00:29:29,429
so then three all the systems and I

492
00:29:29,429 --> 00:29:33,220
think I'm running as admin but just to

493
00:29:33,220 --> 00:29:34,530
be safe

494
00:29:34,530 --> 00:29:39,070
greater command prompt so now I'm on the

495
00:29:39,070 --> 00:29:42,309
system and just so I don't you don't

496
00:29:42,309 --> 00:29:53,429
have to see me painfully type lost yay

497
00:29:53,429 --> 00:30:00,490
luckily I have backup all right so what

498
00:30:00,490 --> 00:30:04,270
I'm gonna do paste this here and make

499
00:30:04,270 --> 00:30:06,640
this a little bigger so you guys can see

500
00:30:06,640 --> 00:30:08,850
it

501
00:30:13,770 --> 00:30:17,550
so what am I gonna do here I'm going to

502
00:30:17,550 --> 00:30:23,200
run a PS exact against my workstation so

503
00:30:23,200 --> 00:30:26,940
again this is in control right

504
00:30:26,940 --> 00:30:30,820
authenticating as this new account that

505
00:30:30,820 --> 00:30:33,820
I created right so let's make sure we

506
00:30:33,820 --> 00:30:40,210
get our name correct properties so this

507
00:30:40,210 --> 00:30:44,950
one I call desktop admin Oh - and of

508
00:30:44,950 --> 00:30:47,080
course what we're gonna do want to do is

509
00:30:47,080 --> 00:30:51,160
plan this all out appropriately okay and

510
00:30:51,160 --> 00:30:55,030
then I'm going to do a run ass and just

511
00:30:55,030 --> 00:30:57,370
because Windows has gotten pretty

512
00:30:57,370 --> 00:31:00,910
finicky in Windows 10 and some of the

513
00:31:00,910 --> 00:31:03,220
later controls about tightening up

514
00:31:03,220 --> 00:31:06,010
around I'm going to do a run ass but I'm

515
00:31:06,010 --> 00:31:07,750
just going to copy the run is over

516
00:31:07,750 --> 00:31:11,470
and again authenticate remember on my

517
00:31:11,470 --> 00:31:13,960
earlier list run as is one of the ways

518
00:31:13,960 --> 00:31:17,490
to cache a local user the PS exact

519
00:31:17,490 --> 00:31:20,260
authentication to the workstation won't

520
00:31:20,260 --> 00:31:23,500
cause that user ID and password to be

521
00:31:23,500 --> 00:31:26,680
cached locally the run ass however will

522
00:31:26,680 --> 00:31:29,770
so we use the PS exact to do this and of

523
00:31:29,770 --> 00:31:32,020
course the beauty of this is we can do

524
00:31:32,020 --> 00:31:36,670
this across a bunch of systems and you

525
00:31:36,670 --> 00:31:39,100
know do it effectively there are other

526
00:31:39,100 --> 00:31:43,320
links if you vendors out there that are

527
00:31:43,320 --> 00:31:48,520
starting to offer solutions or doing

528
00:31:48,520 --> 00:31:50,880
some of these techniques or products

529
00:31:50,880 --> 00:31:53,890
what we'll find is a lot of them are

530
00:31:53,890 --> 00:31:57,640
doing using an agent on the system and

531
00:31:57,640 --> 00:32:01,450
doing an inject into else ass so the

532
00:32:01,450 --> 00:32:04,480
when I log in on when using another

533
00:32:04,480 --> 00:32:07,510
place it gets cached is in the lol saps

534
00:32:07,510 --> 00:32:10,990
memory space okay and so a lot of the

535
00:32:10,990 --> 00:32:14,500
the vendors are injecting it into that

536
00:32:14,500 --> 00:32:16,240
the problem with that from my

537
00:32:16,240 --> 00:32:19,030
perspective is twofold one it doesn't

538
00:32:19,030 --> 00:32:20,740
survive a reboot which is why they're

539
00:32:20,740 --> 00:32:22,780
doing it with a local agent and I don't

540
00:32:22,780 --> 00:32:23,950
know about you but

541
00:32:23,950 --> 00:32:26,590
my systems folks are really tired of new

542
00:32:26,590 --> 00:32:29,680
additional agents on my end points so so

543
00:32:29,680 --> 00:32:32,890
better to not have to do that and

544
00:32:32,890 --> 00:32:34,930
secondly it doesn't create all the

545
00:32:34,930 --> 00:32:39,040
artifacts either so if I'm a relatively

546
00:32:39,040 --> 00:32:42,760
smart adversary that I'm going to not

547
00:32:42,760 --> 00:32:44,890
just pull those credentials out of the

548
00:32:44,890 --> 00:32:48,220
else asked cash I'm also going to go hey

549
00:32:48,220 --> 00:32:52,000
are these credentials locally cached and

550
00:32:52,000 --> 00:32:55,260
if not then we might have a problem

551
00:32:55,260 --> 00:32:59,980
so I'm Pierce exacting run ass on that

552
00:32:59,980 --> 00:33:03,790
local system using this new account that

553
00:33:03,790 --> 00:33:08,170
we created okay and if we pop over to

554
00:33:08,170 --> 00:33:11,200
this system let's just dump out of me me

555
00:33:11,200 --> 00:33:14,590
cats and look in our users directory we

556
00:33:14,590 --> 00:33:19,630
should see oh wallah a admin Oh to pop

557
00:33:19,630 --> 00:33:24,880
up what we've done is be a script or

558
00:33:24,880 --> 00:33:27,070
just a single command in this case but

559
00:33:27,070 --> 00:33:30,310
easily scriptable is created that look

560
00:33:30,310 --> 00:33:34,170
little in user in a very realistic way

561
00:33:34,170 --> 00:33:37,990
that's now going to show up in all of

562
00:33:37,990 --> 00:33:40,060
the traces so if I go back to my Mimi

563
00:33:40,060 --> 00:33:45,480
Katz and again run that

564
00:34:03,170 --> 00:34:08,030
dump my cache notes of a desktop admin

565
00:34:08,030 --> 00:34:11,418
Oh - and in case you're wondering what

566
00:34:11,418 --> 00:34:14,540
this NL dollar sign want an ounce dollar

567
00:34:14,540 --> 00:34:17,030
sign who is well that's actually a

568
00:34:17,030 --> 00:34:22,010
reference to the local ash so let me

569
00:34:22,010 --> 00:34:24,109
open up another command prompt here a

570
00:34:24,109 --> 00:34:26,810
second this time I'm going to do a PS

571
00:34:26,810 --> 00:34:38,869
exact s I D - D am I supposed to be

572
00:34:38,869 --> 00:34:41,239
giving giveaways away all right

573
00:34:41,239 --> 00:34:47,030
so Oh perfect so as giveaway number one

574
00:34:47,030 --> 00:34:51,800
who can tell me why I just did a PS

575
00:34:51,800 --> 00:34:55,668
exact to my - run command dot exe on my

576
00:34:55,668 --> 00:35:01,820
local host nope

577
00:35:01,820 --> 00:35:04,820
good thought good thought it does but it

578
00:35:04,820 --> 00:35:14,030
closes right back out it does but it

579
00:35:14,030 --> 00:35:15,650
deletes it as soon as it's done running

580
00:35:15,650 --> 00:35:24,430
great thought yeah no great thoughts

581
00:35:24,430 --> 00:35:26,810
little trick some of the attackers use

582
00:35:26,810 --> 00:35:35,780
yeah no I elevated myself exactly what

583
00:35:35,780 --> 00:35:39,140
this did was this new command prompt is

584
00:35:39,140 --> 00:35:44,330
out running as system not as my admin

585
00:35:44,330 --> 00:35:47,330
account so this is just a little trick

586
00:35:47,330 --> 00:35:53,420
to run as system I need that because the

587
00:35:53,420 --> 00:35:55,280
portions of the registry that I want to

588
00:35:55,280 --> 00:35:58,850
look at can't be seen and eyesight's not

589
00:35:58,850 --> 00:36:01,390
really good

590
00:36:06,940 --> 00:36:10,310
yes so and there's other ways to feed

591
00:36:10,310 --> 00:36:13,400
this just too but the reason why I

592
00:36:13,400 --> 00:36:16,130
wanted to do this is because part of

593
00:36:16,130 --> 00:36:18,620
this journey because my goal here is not

594
00:36:18,620 --> 00:36:21,290
to give you a comprehensive way

595
00:36:21,290 --> 00:36:23,780
accomplishing this what I'm trying to do

596
00:36:23,780 --> 00:36:28,130
is kind of bring you up to speed on some

597
00:36:28,130 --> 00:36:30,560
of the possibilities right because this

598
00:36:30,560 --> 00:36:32,330
is something you really want to

599
00:36:32,330 --> 00:36:34,730
customize for your environment so this

600
00:36:34,730 --> 00:36:36,680
is the cache it's stored under H key

601
00:36:36,680 --> 00:36:39,200
local machine security cache by default

602
00:36:39,200 --> 00:36:42,620
Windows caches 10 entries and it's just

603
00:36:42,620 --> 00:36:44,270
a first-in first-out buffer

604
00:36:44,270 --> 00:36:48,320
so if I have 11th person login whoever

605
00:36:48,320 --> 00:36:50,660
is the oldest last logged in just gets

606
00:36:50,660 --> 00:36:52,760
dumped out and it gets replaced so that

607
00:36:52,760 --> 00:36:56,560
NL dollar sign 1 through 3 you can see

608
00:36:56,560 --> 00:37:00,440
early the cache of those and notice all

609
00:37:00,440 --> 00:37:03,800
of the other entries of the 10 are empty

610
00:37:03,800 --> 00:37:07,310
it's pretty common to reduce the number

611
00:37:07,310 --> 00:37:10,090
of cache entries in your environment

612
00:37:10,090 --> 00:37:12,680
typically however can't turn this

613
00:37:12,680 --> 00:37:14,510
completely off because if you turn it

614
00:37:14,510 --> 00:37:17,330
off the problem you've got is your goes

615
00:37:17,330 --> 00:37:19,850
home and can't login to their machine

616
00:37:19,850 --> 00:37:23,390
and we want people to work at night too

617
00:37:23,390 --> 00:37:25,480
not just during the day

618
00:37:25,480 --> 00:37:30,590
right so I with me so far still so what

619
00:37:30,590 --> 00:37:33,800
we've done we didn't a user in the

620
00:37:33,800 --> 00:37:37,400
domain we used the PS exact with a run

621
00:37:37,400 --> 00:37:39,740
ass so that caused it to be cached

622
00:37:39,740 --> 00:37:42,350
locally on my Windows machine now what

623
00:37:42,350 --> 00:37:45,110
we want to do is make sure that the

624
00:37:45,110 --> 00:37:48,350
adversaries can't use it so you know

625
00:37:48,350 --> 00:37:50,630
I've just got a little simple password

626
00:37:50,630 --> 00:37:54,320
tool so I randomly generated a 50

627
00:37:54,320 --> 00:37:57,470
character password and of course want to

628
00:37:57,470 --> 00:38:00,460
toggle back to my domain controller and

629
00:38:00,460 --> 00:38:06,380
change password now so that password is

630
00:38:06,380 --> 00:38:08,510
no longer valid right

631
00:38:08,510 --> 00:38:11,720
so I reset password and I can paste in

632
00:38:11,720 --> 00:38:13,970
that 50 character password that frankly

633
00:38:13,970 --> 00:38:16,700
I'm going to keep track of and now it's

634
00:38:16,700 --> 00:38:18,110
been changed

635
00:38:18,110 --> 00:38:22,970
so just to be safe ink actually gets the

636
00:38:22,970 --> 00:38:26,720
we want to make sure that can i that's a

637
00:38:26,720 --> 00:38:29,810
big is a little bit of residual danger

638
00:38:29,810 --> 00:38:37,420
here but once we do music sir not touch

639
00:38:37,420 --> 00:38:41,450
wood it's got a huge password throw it

640
00:38:41,450 --> 00:38:45,380
away hey you know make sure you're 80

641
00:38:45,380 --> 00:38:47,210
okay sure and obviously they could

642
00:38:47,210 --> 00:38:50,470
change it but your baby folks

643
00:38:50,470 --> 00:38:55,360
exit so that not a risk that perspective

644
00:38:55,360 --> 00:38:58,430
in my opinion this pretty effectively

645
00:38:58,430 --> 00:39:03,260
communicates but again IRB we're so what

646
00:39:03,260 --> 00:39:08,650
have we done here you've the password

647
00:39:22,079 --> 00:39:28,609
uh finding it because what happens is if

648
00:39:28,609 --> 00:39:36,720
I'm gonna get a against alien ID feature

649
00:39:36,720 --> 00:39:39,230
off top

650
00:39:45,500 --> 00:39:51,170
the the account again only if it's

651
00:39:51,170 --> 00:40:04,970
accepted does it record e in the begins

652
00:40:04,970 --> 00:40:15,589
III that B that works extremely well so

653
00:40:15,589 --> 00:40:28,540
what we're gonna so if I pop a bit you

654
00:40:29,290 --> 00:40:33,050
actually see a bunch of the for an ID

655
00:40:33,050 --> 00:40:35,930
eight overtime trying to figure out for

656
00:40:35,930 --> 00:40:38,720
so 46:24 is the event I was trying to

657
00:40:38,720 --> 00:40:48,099
think of her you what I found these

658
00:40:48,099 --> 00:40:55,310
seventy 147th on event ID triggers when

659
00:40:55,310 --> 00:41:00,560
there's a Kerberos failed pre off okay

660
00:41:00,560 --> 00:41:03,980
so under the hood right active directory

661
00:41:03,980 --> 00:41:07,720
is using modified version Microsoft and

662
00:41:07,720 --> 00:41:14,599
Virgin of Kerberos right for

663
00:41:14,599 --> 00:41:16,280
compatibility reasons a bunch of other

664
00:41:16,280 --> 00:41:20,690
stuff let me refresh ok so we've now

665
00:41:20,690 --> 00:41:27,680
changed that password so bad guys oh and

666
00:41:27,680 --> 00:41:29,510
I skipped a step I'll come back to it

667
00:41:29,510 --> 00:41:30,700
though

668
00:41:30,700 --> 00:41:35,329
so right now don't Prudential eight so

669
00:41:35,329 --> 00:41:38,530
they want to try that

670
00:41:40,760 --> 00:41:43,820
I have it in one of my command windows

671
00:41:43,820 --> 00:41:44,600
here somewhere

672
00:41:44,600 --> 00:41:47,540
okay so there's my PS exact and I'm

673
00:41:47,540 --> 00:41:49,340
gonna take off the run app so I'm just

674
00:41:49,340 --> 00:41:52,090
you're gonna try and authenticate and

675
00:41:52,090 --> 00:42:00,440
attempt it execute a CMD cedar okay so

676
00:42:00,440 --> 00:42:05,510
I'm just gonna execute the PS exact but

677
00:42:05,510 --> 00:42:08,540
of course I'm using and notice I got an

678
00:42:08,540 --> 00:42:09,700
access denied

679
00:42:09,700 --> 00:42:12,170
that's what we're trying to do right the

680
00:42:12,170 --> 00:42:14,690
in this scenario I'm the adversary I've

681
00:42:14,690 --> 00:42:18,740
scraped those credentials I'm now to

682
00:42:18,740 --> 00:42:21,140
authenticate using because that oh it's

683
00:42:21,140 --> 00:42:24,380
a domain account this is fantastic I'm

684
00:42:24,380 --> 00:42:26,360
going to be able to use this to move

685
00:42:26,360 --> 00:42:29,030
around in the environment if we trigger

686
00:42:29,030 --> 00:42:47,750
over here today notice oh desktop bad

687
00:42:47,750 --> 00:42:54,670
manoa to said hey that's clear on an a

688
00:42:54,670 --> 00:43:00,650
pre off Kerberos login event so this

689
00:43:00,650 --> 00:43:04,550
allows us if we set up alert for a

690
00:43:04,550 --> 00:43:10,610
seventh one on starter IDs we have eken

691
00:43:10,610 --> 00:43:16,970
ism that will alert with a fidelity date

692
00:43:16,970 --> 00:43:22,700
rice varieties we could have 50 could

693
00:43:22,700 --> 00:43:24,970
have a hundred lure ID whatever it is

694
00:43:24,970 --> 00:43:27,590
this through the environment we've a

695
00:43:27,590 --> 00:43:33,080
mechanism or looking behavior of someone

696
00:43:33,080 --> 00:43:37,870
trying to use our creds against us make

697
00:43:37,870 --> 00:43:40,310
now there's one thing I inadvertently

698
00:43:40,310 --> 00:43:46,070
skip and actually I'll turn this does

699
00:43:46,070 --> 00:43:53,290
anybody know command-line way add

700
00:43:53,910 --> 00:43:58,470
grits to the local window secret key

701
00:43:58,470 --> 00:44:03,030
there's the command-line tool anybody

702
00:44:03,030 --> 00:44:06,599
know what that is I'm asking some

703
00:44:06,599 --> 00:44:09,539
carefully your questions so we'll ask

704
00:44:09,539 --> 00:44:14,780
something else and he guesses good try

705
00:44:14,780 --> 00:44:16,490
not sir

706
00:44:16,490 --> 00:44:24,000
good thought though close ad is is a

707
00:44:24,000 --> 00:44:27,650
command line parameter for it

708
00:44:28,130 --> 00:44:31,170
no not read Jack again another really

709
00:44:31,170 --> 00:44:33,599
good thought so there's this cool

710
00:44:33,599 --> 00:44:37,799
command called Kaimuki CMD key ships

711
00:44:37,799 --> 00:44:40,020
with every version of Windows right and

712
00:44:40,020 --> 00:44:43,849
so what I can do is in this time I'm

713
00:44:43,849 --> 00:44:48,809
just gonna add a pop account right so

714
00:44:48,809 --> 00:44:50,970
again this case ours is called desktop

715
00:44:50,970 --> 00:44:56,579
admin Oh - I I just picked male for this

716
00:44:56,579 --> 00:44:58,950
case right we could do it with anything

717
00:44:58,950 --> 00:45:02,220
right but the key here is when i run

718
00:45:02,220 --> 00:45:08,640
this manned on a system what it did was

719
00:45:08,640 --> 00:45:11,220
it stored that credential that username

720
00:45:11,220 --> 00:45:15,029
and password in our local secrets so if

721
00:45:15,029 --> 00:45:18,720
i go over again to me me cats nope I'm

722
00:45:18,720 --> 00:45:24,230
doing this because of the difficulty in

723
00:45:24,230 --> 00:45:29,880
cracking what I'm doing is giving them

724
00:45:29,880 --> 00:45:34,200
another option - you know we we want to

725
00:45:34,200 --> 00:45:37,980
make the lure account Dave so we don't

726
00:45:37,980 --> 00:45:41,420
want to make it so difficult for them to

727
00:45:41,420 --> 00:45:45,450
crack that that they don't end up using

728
00:45:45,450 --> 00:45:50,190
it and so again I'm gonna move quickly

729
00:45:50,190 --> 00:45:52,400
here

730
00:45:54,670 --> 00:45:58,539
so I want to get back to the other part

731
00:45:58,539 --> 00:46:02,569
token elevate frame length there and so

732
00:46:02,569 --> 00:46:07,509
this time I'm gonna run sec URL s a

733
00:46:07,509 --> 00:46:12,549
which is to dump the local secrets logon

734
00:46:12,549 --> 00:46:20,500
underscore oh no underscore and then s

735
00:46:20,500 --> 00:46:28,069
come on arrow key there we go alright so

736
00:46:28,069 --> 00:46:35,240
me I'll let scroll way down oh there it

737
00:46:35,240 --> 00:46:36,140
is right in front of me

738
00:46:36,140 --> 00:46:39,440
notice that is stored in a reversible

739
00:46:39,440 --> 00:46:42,230
format so Femi cats can extract it

740
00:46:42,230 --> 00:46:44,660
problem and a whole bunch of it's not

741
00:46:44,660 --> 00:46:48,559
just me me cats okay what what have we

742
00:46:48,559 --> 00:46:51,369
done here all right let's let's go back

743
00:46:51,369 --> 00:46:54,079
to the regularly scheduled programming

744
00:46:54,079 --> 00:47:00,259
here so again it's to weaponize the the

745
00:47:00,259 --> 00:47:03,289
points mentioned earlier I've come back

746
00:47:03,289 --> 00:47:05,000
a little more detail on the plant out

747
00:47:05,000 --> 00:47:08,180
lures see why some of these suggestions

748
00:47:08,180 --> 00:47:10,460
are so important right we really want to

749
00:47:10,460 --> 00:47:13,009
make this realistic the better you are

750
00:47:13,009 --> 00:47:16,400
at making this look like your real IDs

751
00:47:16,400 --> 00:47:20,269
the more likely you are to lure them

752
00:47:20,269 --> 00:47:23,839
into traffic right we also don't want to

753
00:47:23,839 --> 00:47:25,880
put this on all of our endpoints unless

754
00:47:25,880 --> 00:47:28,730
you're a really big organization think

755
00:47:28,730 --> 00:47:31,599
about having a handful of those maybe

756
00:47:31,599 --> 00:47:34,910
maybe you do it a bunch of different

757
00:47:34,910 --> 00:47:39,890
ways organization really works because

758
00:47:39,890 --> 00:47:45,109
the this approach it's something that

759
00:47:45,109 --> 00:47:47,869
even you're really really skilled folks

760
00:47:47,869 --> 00:47:51,099
you know hypothetically Dave's crew

761
00:47:51,099 --> 00:47:55,430
might apt to trip over does that make

762
00:47:55,430 --> 00:47:57,890
sense because remember they don't have a

763
00:47:57,890 --> 00:48:00,559
way of knowing whether this idea is real

764
00:48:00,559 --> 00:48:04,549
unless you make it too obvious all they

765
00:48:04,549 --> 00:48:05,480
can do is try it

766
00:48:05,480 --> 00:48:07,490
they just know it's a locally

767
00:48:07,490 --> 00:48:10,070
- tidy until they attempt to leverage

768
00:48:10,070 --> 00:48:13,119
the ID they have no way of determining

769
00:48:13,119 --> 00:48:18,110
whether it's any good or not right point

770
00:48:18,110 --> 00:48:20,119
three of course is the local secrets

771
00:48:20,119 --> 00:48:22,400
again just to make the bar slightly

772
00:48:22,400 --> 00:48:25,190
lower and then of course what the other

773
00:48:25,190 --> 00:48:27,200
steps we did is we created the domain

774
00:48:27,200 --> 00:48:30,980
pic account we logged in locally using

775
00:48:30,980 --> 00:48:34,520
the PS exactly the run as again lots of

776
00:48:34,520 --> 00:48:36,350
ways of doing this especially the furia

777
00:48:36,350 --> 00:48:38,450
large organization I would highly

778
00:48:38,450 --> 00:48:42,970
suggest something like an SCC I'm ja or

779
00:48:42,970 --> 00:48:48,230
shot do that we and added some local

780
00:48:48,230 --> 00:48:50,660
although I did it out of order and of

781
00:48:50,660 --> 00:48:54,440
course we went for alerting so there's a

782
00:48:54,440 --> 00:48:58,790
few things that we want to keep in mind

783
00:48:58,790 --> 00:49:01,820
though in terms of challenges I

784
00:49:01,820 --> 00:49:04,310
mentioned this in passing earlier if you

785
00:49:04,310 --> 00:49:07,030
disable the account you disabled the

786
00:49:07,030 --> 00:49:09,890
ability or at least to what I found if

787
00:49:09,890 --> 00:49:12,140
you find a way to be able to disable and

788
00:49:12,140 --> 00:49:15,440
still alert on that individual ID please

789
00:49:15,440 --> 00:49:18,290
tweet me or email me or something

790
00:49:18,290 --> 00:49:19,820
because I'd love to know it because I

791
00:49:19,820 --> 00:49:22,940
have not yet found it okay that's a

792
00:49:22,940 --> 00:49:26,750
problem because the failure occurs so

793
00:49:26,750 --> 00:49:30,290
the Kerberos off event is only on your

794
00:49:30,290 --> 00:49:33,200
domain controllers so you won't it's

795
00:49:33,200 --> 00:49:35,359
important to understand you won't your

796
00:49:35,359 --> 00:49:38,119
detection won't fire until they attempt

797
00:49:38,119 --> 00:49:41,660
to use it does that make sense so you

798
00:49:41,660 --> 00:49:44,450
aren't right in there but you got to be

799
00:49:44,450 --> 00:49:47,410
ready to run quick when that happens and

800
00:49:47,410 --> 00:49:49,760
dependent your environment making it

801
00:49:49,760 --> 00:49:52,040
realistic could be problematic right

802
00:49:52,040 --> 00:49:54,640
think about the the pattern luckily most

803
00:49:54,640 --> 00:49:56,810
organizations have you know pretty

804
00:49:56,810 --> 00:49:58,700
typical naming conventions and things

805
00:49:58,700 --> 00:50:01,940
like that varieties which help with all

806
00:50:01,940 --> 00:50:04,970
of this for us right all right so those

807
00:50:04,970 --> 00:50:07,930
are the challenges terms of next steps

808
00:50:07,930 --> 00:50:12,890
this is matching the surface right again

809
00:50:12,890 --> 00:50:16,580
if you look at the attack well and the

810
00:50:16,580 --> 00:50:18,670
things the adversaries are tending to do

811
00:50:18,670 --> 00:50:21,349
go on and looking at our github

812
00:50:21,349 --> 00:50:24,079
to see if we've got hard-coded passwords

813
00:50:24,079 --> 00:50:35,779
there looking on our wiki they standing

814
00:50:35,779 --> 00:50:39,410
where our users dentist don't they're

815
00:50:39,410 --> 00:50:43,309
set in a way that is accessible right

816
00:50:43,309 --> 00:50:49,369
and so again use that right we can

817
00:50:49,369 --> 00:50:52,670
create things in those only in our

818
00:50:52,670 --> 00:50:56,479
detection grid right and of course Jen

819
00:50:56,479 --> 00:50:59,809
there's lots of other things you know I

820
00:50:59,809 --> 00:51:01,489
would even suggest thinking about

821
00:51:01,489 --> 00:51:03,609
partnering with your build team and

822
00:51:03,609 --> 00:51:06,109
making it part of building the system's

823
00:51:06,109 --> 00:51:09,019
right as part of it they often have to

824
00:51:09,019 --> 00:51:12,109
build all of this out anyway why not

825
00:51:12,109 --> 00:51:15,799
bake some of this stuff in there okay

826
00:51:15,799 --> 00:51:19,839
so we'll move to questions contact infos

827
00:51:19,839 --> 00:51:24,190
if anybody wants to come please

828
00:51:24,190 --> 00:51:29,839
hopefully feel free and and really what

829
00:51:29,839 --> 00:51:33,890
I'm hope I'm not trying to suggest that

830
00:51:33,890 --> 00:51:35,599
this is the end I'm trying to suggest

831
00:51:35,599 --> 00:51:42,499
the bikini I believe as defenders to

832
00:51:42,499 --> 00:51:45,920
leverage our systems against the

833
00:51:45,920 --> 00:51:48,799
adversaries in many many ways

834
00:51:48,799 --> 00:51:51,710
that like in this case cost us nothing

835
00:51:51,710 --> 00:51:54,319
right we're leveraging infrastructure we

836
00:51:54,319 --> 00:51:57,950
already own and it paid for and doing it

837
00:51:57,950 --> 00:52:00,920
in a way that makes it really difficult

838
00:52:00,920 --> 00:52:03,829
for the adversaries to know and if they

839
00:52:03,829 --> 00:52:06,289
bump into one of those again we're off

840
00:52:06,289 --> 00:52:08,390
to the races we potentially prevent

841
00:52:08,390 --> 00:52:12,969
breaches so questions

842
00:52:16,210 --> 00:52:29,809
yeah yeah yeah that's so anything shove

843
00:52:29,809 --> 00:52:33,739
a rebuild or users for this particular

844
00:52:33,739 --> 00:52:35,779
mechanism anything short of a complete

845
00:52:35,779 --> 00:52:38,180
system rebuild the cached credentials

846
00:52:38,180 --> 00:52:39,140
stay local

847
00:52:39,140 --> 00:52:42,170
so updates and all of that don't affect

848
00:52:42,170 --> 00:52:45,200
any of this which is oh did I

849
00:52:45,200 --> 00:52:56,259
misunderstand your question yeah oh sure

850
00:52:56,259 --> 00:52:59,440
yeah yeah

851
00:53:06,930 --> 00:53:12,010
so - so that's so a question was given

852
00:53:12,010 --> 00:53:14,380
new capabilities right well well Dave's

853
00:53:14,380 --> 00:53:15,880
talk this morning right in his keynote

854
00:53:15,880 --> 00:53:18,099
he was talking about some of the new

855
00:53:18,099 --> 00:53:20,079
approaches for for getting into our

856
00:53:20,079 --> 00:53:24,490
system I would ask that if an attacker

857
00:53:24,490 --> 00:53:29,079
can leverage it then we as defenders can

858
00:53:29,079 --> 00:53:32,619
think of ways to use it against them

859
00:53:32,619 --> 00:53:38,339
right the beauty of this knee of the

860
00:53:38,339 --> 00:53:43,560
attackers it's dependent pop of the

861
00:53:43,560 --> 00:53:45,810
literally what Dave was talking about

862
00:53:45,810 --> 00:53:51,270
right is a lot of our genus right the

863
00:53:51,270 --> 00:53:53,349
obfuscated a little bit and our

864
00:53:53,349 --> 00:53:58,030
detection doesn't work in we're doing is

865
00:53:58,030 --> 00:54:00,210
worth

866
00:54:05,710 --> 00:54:08,260
yeah

867
00:54:08,260 --> 00:54:14,980
yeah yep absolutely

868
00:54:14,980 --> 00:54:21,400
I did quite the work every difficult the

869
00:54:21,400 --> 00:54:23,670
cat

870
00:54:28,900 --> 00:54:31,779
at something that can change its action

871
00:54:31,779 --> 00:54:40,719
bunch over these logs are nomadic shall

872
00:54:40,719 --> 00:54:45,119
we say I use the past word trop as

873
00:54:45,119 --> 00:54:47,349
potentially an indicator they're coming

874
00:54:47,349 --> 00:54:50,170
from I absolutely think that's the kick

875
00:54:50,170 --> 00:54:53,049
just is you know keep track of your

876
00:54:53,049 --> 00:54:55,719
lures so in that case maybe deploy

877
00:54:55,719 --> 00:54:57,869
different lures to different locations

878
00:54:57,869 --> 00:55:01,960
right you can correlate the events with

879
00:55:01,960 --> 00:55:04,059
the failed login to get the hostname

880
00:55:04,059 --> 00:55:06,519
it's just not in the forty seven seventy

881
00:55:06,519 --> 00:55:18,430
one yeah you could yeah so that was

882
00:55:18,430 --> 00:55:20,259
could we keep someone yeah absolutely

883
00:55:20,259 --> 00:55:22,719
that feels a little more dangerous for

884
00:55:22,719 --> 00:55:26,950
me if my op really quick at that I can

885
00:55:26,950 --> 00:55:29,200
be on them really quick then what you're

886
00:55:29,200 --> 00:55:31,059
doing is you're turning your systems oh

887
00:55:31,059 --> 00:55:33,880
honey in my case I'm not really I'm

888
00:55:33,880 --> 00:55:35,319
using some of the techniques of

889
00:55:35,319 --> 00:55:37,989
deception but for just an alert

890
00:55:37,989 --> 00:55:40,719
mechanism a detection mechanism I was

891
00:55:40,719 --> 00:55:42,999
going that way I probably personally

892
00:55:42,999 --> 00:55:44,619
would would leverage some sort of

893
00:55:44,619 --> 00:55:47,410
honeypot environment so that they're

894
00:55:47,410 --> 00:55:49,660
contained within that rather than opera

895
00:55:49,660 --> 00:55:52,239
my own systems but if you're really

896
00:55:52,239 --> 00:55:55,259
confident in your team sure go for it

897
00:55:55,259 --> 00:55:59,579
that's a question over here yes

898
00:56:11,830 --> 00:56:13,860
ah

899
00:56:14,750 --> 00:56:24,710
right yeah soup soup I think that

900
00:56:24,710 --> 00:56:26,930
becomes secondary in this case right

901
00:56:26,930 --> 00:56:29,720
again what I'm really trying to suggest

902
00:56:29,720 --> 00:56:32,450
here is that we attack the behaviors so

903
00:56:32,450 --> 00:56:34,580
even if it Russia right in those

904
00:56:34,580 --> 00:56:35,390
scenarios

905
00:56:35,390 --> 00:56:38,810
Russia has specific playbooks they still

906
00:56:38,810 --> 00:56:40,970
need to obtain credentials they can't

907
00:56:40,970 --> 00:56:44,240
magically just the system now certainly

908
00:56:44,240 --> 00:56:46,330
they can use exploits as part of that

909
00:56:46,330 --> 00:56:49,940
this is by no means am I suggesting you

910
00:56:49,940 --> 00:56:52,369
should run this oh look I'm speaking

911
00:56:52,369 --> 00:56:55,910
this is an idea and an approach for

912
00:56:55,910 --> 00:57:00,710
leverage in it the adversary it's that

913
00:57:00,710 --> 00:57:05,359
most of us happen that make sense it's

914
00:57:05,359 --> 00:57:06,950
certainly not going to solve that

915
00:57:06,950 --> 00:57:11,410
problem but I would suggest it's just

916
00:57:13,210 --> 00:57:17,330
think we are complete time and I forgot

917
00:57:17,330 --> 00:57:18,970
to ask the last two questions

918
00:57:18,970 --> 00:57:23,750
so can we ask on the next person ask a

919
00:57:23,750 --> 00:57:28,580
question all right ask question what was

920
00:57:28,580 --> 00:57:32,270
Doug Burke's password when I signed it I

921
00:57:32,270 --> 00:57:34,910
saw that hand first you and a purple

922
00:57:34,910 --> 00:57:40,970
shirt correct password 2018 because

923
00:57:40,970 --> 00:57:43,130
because Doug picks really good swears

924
00:57:43,130 --> 00:57:53,599
like all right one more and I need a

925
00:57:53,599 --> 00:57:57,320
question my mom I already asked the

926
00:57:57,320 --> 00:58:03,410
command key oh so we used run as what's

927
00:58:03,410 --> 00:58:07,810
one of the other techniques for causing

928
00:58:07,810 --> 00:58:10,220
credentials to be cached locally on a

929
00:58:10,220 --> 00:58:14,750
host I saw that first scheduled tasks

930
00:58:14,750 --> 00:58:16,670
that's right excellent well thanks

931
00:58:16,670 --> 00:58:19,839
everybody for coming

932
00:58:19,849 --> 00:58:23,520
and have a great rest of the day

933
00:58:23,520 --> 00:58:26,659
[Applause]

