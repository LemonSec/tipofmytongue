1
00:00:00,000 --> 00:00:14,309
our next speaker talking about out using
powershell anywhere or something they

2
00:00:14,309 --> 00:00:24,359
are here today and here

3
00:00:24,930 --> 00:00:40,920
yeah 3 ounces and sausage you to this
event and we are half esta and also have

4
00:00:40,920 --> 00:00:52,860
mr. Cole my SAT and waited years for my
loss some dessert

5
00:00:53,520 --> 00:01:05,190
and please join me in welcoming yeah
mark so nice

6
00:01:06,300 --> 00:01:13,649
hi this is owning microsoft outlook with
Windows PowerShell I a quick obligatory

7
00:01:13,650 --> 00:01:20,220
get host so my name is andrew cole
everybody just calls me Cole always have

8
00:01:20,220 --> 00:01:23,310
papers trolling me already

9
00:01:23,310 --> 00:01:28,680
ok if you want to find me on twitter if
you have any questions afterward you can

10
00:01:28,680 --> 00:01:34,259
hit me up a culmination so little bit
about me and what I do I'm currently a

11
00:01:34,259 --> 00:01:40,500
Content developer and instructor for
chirens information operations team we

12
00:01:40,500 --> 00:01:45,450
teach I teach a number of classes on
computer network exploitation using

13
00:01:45,450 --> 00:01:51,479
conventional tools and powershell as
well as some MPs and defense classes in

14
00:01:51,479 --> 00:01:56,580
my spare time I do a little dabbling in
security research and I mostly just love

15
00:01:56,580 --> 00:02:02,009
playing around with powershell it's fun
and exciting on in a prior life I was a

16
00:02:02,009 --> 00:02:06,750
tournament interactive operator for the
US Army out for me I did that for about

17
00:02:06,750 --> 00:02:13,050
four years or so and spoken it a couple
of cons here no lacan so on and so forth

18
00:02:13,050 --> 00:02:20,280
that's about all that's interesting
about me my first my obligatory thanks i

19
00:02:20,280 --> 00:02:23,940
would like to thank the sides for giving
me this awesome place to talk at this is

20
00:02:23,940 --> 00:02:28,470
one of the best venues to do a talk at
just perfect layout and of course my

21
00:02:28,470 --> 00:02:32,370
employer for paying me to write this i
also need to give some credit to some

22
00:02:32,370 --> 00:02:37,680
people whose work sort of inspired me to
make this talk so I said Wilson that's a

23
00:02:37,680 --> 00:02:42,060
Microsoft scripting guy he had does a
lot of stuff and sometimes he says

24
00:02:42,060 --> 00:02:46,349
things that I'm like wow I wonder if
Microsoft knows that he's publishing

25
00:02:46,349 --> 00:02:50,040
that information on their website
because some of its really really

26
00:02:50,040 --> 00:02:56,489
interesting things and matt nelson is a
really smart guy he wrote an interesting

27
00:02:56,489 --> 00:03:00,870
piece of code that will have a link to
an e end of this talk that sort of led

28
00:03:00,870 --> 00:03:04,020
me down this a general road for some of
the things that we're going to be going

29
00:03:04,020 --> 00:03:05,060
over

30
00:03:05,060 --> 00:03:08,180
and last of all all the awesome people
on the powerful community that have

31
00:03:08,180 --> 00:03:11,180
answered my random questions when i hit
them up

32
00:03:12,530 --> 00:03:16,010
ok so why would you want to do this why
do you want to own power shell or why do

33
00:03:16,010 --> 00:03:20,179
you want to own outlook and why do you
want to use PowerShell I a big thing is

34
00:03:20,180 --> 00:03:21,920
why wouldn't you want to

35
00:03:21,920 --> 00:03:25,429
no matter what sort of network you're
doing some red team or penetration

36
00:03:25,430 --> 00:03:30,950
testing in odds are good for their ah my
messing up your video by walking back

37
00:03:30,950 --> 00:03:31,458
and forth

38
00:03:31,459 --> 00:03:36,200
ok odds are good they use outlook for
their email you know every government

39
00:03:36,200 --> 00:03:40,579
every government agency uses it most
civilian sectors use it it just

40
00:03:40,580 --> 00:03:44,209
integrates so well with Microsoft's
other stuff that pretty much everyone

41
00:03:44,209 --> 00:03:49,459
uses it for email power show as long as
that host is windows 7 or newer it's

42
00:03:49,459 --> 00:03:52,370
going to have powershell version 2 on it
which is going to give you an incredible

43
00:03:52,370 --> 00:03:56,150
amount of functionality if all these
things are already there in the

44
00:03:56,150 --> 00:03:57,260
environment

45
00:03:57,260 --> 00:04:01,548
why would you want to jeopardize your
custom tool set if you're doing red

46
00:04:01,549 --> 00:04:06,140
teaming and you've managed to develop a
custom set its only a good custom set

47
00:04:06,140 --> 00:04:11,450
until it really gets caught and then
it's not very useful to you anymore so

48
00:04:11,450 --> 00:04:14,238
if you have something that's already
there on the operating system that you

49
00:04:14,239 --> 00:04:18,500
don't have to upload any external
binaries for use that first then use

50
00:04:18,500 --> 00:04:21,858
your one-off toolset when you don't have
any other options

51
00:04:21,858 --> 00:04:29,090
okay so everything that I'm going to be
doing here is based off the the same

52
00:04:29,090 --> 00:04:32,900
general concept we're going to be
creating a custom common object using

53
00:04:32,900 --> 00:04:38,780
powershell for the first script i'm
going to be just adding the microsoft

54
00:04:38,780 --> 00:04:44,030
interop assembly that's basically going
to serve as a nutshell it serves as a

55
00:04:44,030 --> 00:04:48,710
bridge between . netcom for everything
else we're just going to be creating

56
00:04:48,710 --> 00:04:52,849
that new custom object for the
outlook.application one of the cool

57
00:04:52,850 --> 00:04:56,660
things about powershell is because it is
object-oriented whenever grab something

58
00:04:56,660 --> 00:05:00,740
it doesn't if we create this variable
here we're not grabbing like a pointer

59
00:05:00,740 --> 00:05:05,389
to the object we're grabbing the actual
object itself so we have pretty much

60
00:05:05,389 --> 00:05:09,650
full hold and control of outlook and if
you think about the things that outlook

61
00:05:09,650 --> 00:05:12,859
does in a network just in its native
behavior

62
00:05:12,860 --> 00:05:17,630
ah you know it receives messages from
outside the network and it's capable of

63
00:05:17,630 --> 00:05:18,960
relay message

64
00:05:18,960 --> 00:05:24,630
is back out to that external network so
you've got a great sort of command and

65
00:05:24,630 --> 00:05:30,990
control system set up there by default
right so the first thing we're going to

66
00:05:30,990 --> 00:05:37,199
look at is going to be a little bit of
collection we can collect pretty much

67
00:05:37,199 --> 00:05:44,190
anything that outlook houses so its
outlook views everything that it has as

68
00:05:44,190 --> 00:05:46,469
a folder so it's not just the inbox

69
00:05:46,470 --> 00:05:51,479
it's not just the junk folder there's
also the calendar the contacts the tasks

70
00:05:51,479 --> 00:05:56,340
i know any environment that I've ever
been in for the most part if you go to

71
00:05:56,340 --> 00:06:01,859
the commander or CEOs desktop like
everything's there but if you want to

72
00:06:01,860 --> 00:06:07,320
know what he's doing everything is in
his tasks folder right so in outlook

73
00:06:07,320 --> 00:06:10,080
he's got a whole calendar set there with
everything he's doing for the next six

74
00:06:10,080 --> 00:06:13,440
months and he's got all these projects
and what percentage he's through them

75
00:06:13,440 --> 00:06:21,120
all and his task folder so it's useful
stuff to collect all right i should be

76
00:06:21,120 --> 00:06:24,120
able to do this

77
00:06:24,900 --> 00:06:28,919
can everyone read that or do i need to
make it bigger oh wow it's really big up

78
00:06:28,919 --> 00:06:35,370
there we're going to say it's good right

79
00:06:35,370 --> 00:06:39,090
so what I what that's the wrong one

80
00:06:39,090 --> 00:06:43,590
there we go

81
00:06:43,590 --> 00:06:48,840
alright so we're going to start with
this collection script I wrote it with

82
00:06:48,840 --> 00:06:52,859
help menus and everything so hopefully
if joonbi sees this she's proud of me

83
00:06:52,860 --> 00:07:00,659
and down here so it's a fairly simple
script it's just called get outlook it

84
00:07:00,659 --> 00:07:04,110
has a couple of parameters set up all
the parameters are basically just

85
00:07:04,110 --> 00:07:08,400
switches because it's going to pull in
the same manner regardless of what

86
00:07:08,400 --> 00:07:11,940
folder you're going to this is just to
designate what folder you're actually

87
00:07:11,940 --> 00:07:16,080
going to pull the information from by
default if you don't tell it to do

88
00:07:16,080 --> 00:07:19,620
anything it goes straight to the inbox
if you want to pull from a different

89
00:07:19,620 --> 00:07:23,130
folder you just need to put the
appropriate switch on there to say which

90
00:07:23,130 --> 00:07:29,550
folder you want to harvest information
from so this little section . it's hard

91
00:07:29,550 --> 00:07:33,150
to see this section right here is what
was on one of the earlier slides were

92
00:07:33,150 --> 00:07:38,489
just grabbing that object that is
outlook i should note that you want to

93
00:07:38,490 --> 00:07:43,260
make sure outlook is running on the host
before you do this because if it looks

94
00:07:43,260 --> 00:07:46,740
not already running when you create that
common object for outlook guess what

95
00:07:46,740 --> 00:07:51,000
it's going to do it's going to start
outlook guess where it's going to start

96
00:07:51,000 --> 00:07:51,539
it

97
00:07:51,539 --> 00:07:55,830
users desktop so it's going to make the
big old pop up this is hey here's

98
00:07:55,830 --> 00:08:01,260
outlook so you want to be wary of where
you pop it up make sure they already

99
00:08:01,260 --> 00:08:02,190
have it open

100
00:08:02,190 --> 00:08:06,719
fortunately when most people show up to
work what's the first thing you do you

101
00:08:06,719 --> 00:08:10,110
login you open outlook you check your
email and then you minimize it and go on

102
00:08:10,110 --> 00:08:10,800
with your day

103
00:08:10,800 --> 00:08:14,339
nobody ever closes outlook and then
reopen it later to see if they're gotten

104
00:08:14,339 --> 00:08:19,710
a new email after that we just have a
series of switches specifying you know

105
00:08:19,710 --> 00:08:23,549
if you want to get the calendar just go
to the calendar and all the different

106
00:08:23,550 --> 00:08:30,240
switches do is specify what folder to go
to so if you pick the calendar switch

107
00:08:30,240 --> 00:08:37,440
the folder equals the namespace default
folder for calendar if you choose tasks

108
00:08:37,440 --> 00:08:40,890
it switches it to tasks and if its
contacts that makes it contacts

109
00:08:40,890 --> 00:08:48,240
that's all it needs to know what folder
to pull from ah it is then

110
00:08:48,240 --> 00:08:54,510
so right here it has if it is the sent
folder the target folders then outlook

111
00:08:54,510 --> 00:08:57,900
folder sent mail otherwise default to
outlook folder inbox

112
00:08:58,620 --> 00:09:04,140
there's also a full switch so what you
actually see an outlook for an email is

113
00:09:04,140 --> 00:09:07,529
a very small amount of the information
that actually gets transmitted by

114
00:09:07,529 --> 00:09:10,470
whenever opened up and look at all the
metadata that goes along with an email

115
00:09:10,470 --> 00:09:16,290
like there's a lot of stuff in there so
if you do put the full switch it's going

116
00:09:16,290 --> 00:09:21,120
to grab the full content of every email
so I have a little safety catch in there

117
00:09:21,120 --> 00:09:25,380
that you know says hey this might be
really really large are you sure this is

118
00:09:25,380 --> 00:09:31,079
what you want to do and if you say yes
then it goes on and runs through and if

119
00:09:31,079 --> 00:09:35,219
not then it aborts and falls back if you
don't specify the full switch it just

120
00:09:35,220 --> 00:09:41,069
goes for a default view that shows a
table that has the subject line center

121
00:09:41,610 --> 00:09:48,269
who goes to the daytime and i believe
the body but the body won't contain the

122
00:09:48,269 --> 00:09:51,269
whole body unless you expand the
property to see it

123
00:09:51,959 --> 00:09:59,849
alright so I always prayed the demo gods
before i do a demo even if its

124
00:09:59,850 --> 00:10:04,470
pre-recorded I was having a slight
problem running these demos live on my

125
00:10:04,470 --> 00:10:08,550
laptop because once you give for gigs
around your exchange server a couple

126
00:10:08,550 --> 00:10:13,140
gigs your DC and a couple to a few
workstations there wasn't too much left

127
00:10:13,140 --> 00:10:18,750
for my host laptop so it wasn't
functioning well so we just played it

128
00:10:18,750 --> 00:10:23,399
safe and went with that pre-recorded
videos

129
00:10:25,680 --> 00:10:33,209
come on over there we go so i'm doing
here is first i'm importing the module

130
00:10:33,209 --> 00:10:36,630
anytime you have a script in powershell
you have to import the module and loaded

131
00:10:36,630 --> 00:10:40,589
up before you can execute it once the
modules loaded up i'm just going to type

132
00:10:40,589 --> 00:10:45,660
get outlook by default it again pulls
the inbox and puts it in a little table

133
00:10:45,660 --> 00:10:49,050
format so you can see if there's
anything in there that is of interest if

134
00:10:49,050 --> 00:10:57,719
there's not you could move on and at
this point I'm doing a full here so to

135
00:10:57,720 --> 00:10:59,550
give you an idea how much stuff is in
full

136
00:10:59,550 --> 00:11:05,010
that's the same for email set to full
output so it's a very large amount of

137
00:11:05,010 --> 00:11:11,040
information it's all the metadata
associated with the email itself the

138
00:11:11,040 --> 00:11:15,630
rest of them pretty much go along in the
same manner so if you specify sent polls

139
00:11:15,630 --> 00:11:21,209
from $FULLPHONENUM sent the contacts i
have it pull all the fields by default

140
00:11:21,209 --> 00:11:27,268
if they're not populated it will just
leave them blank but they all pull again

141
00:11:27,269 --> 00:11:31,709
in the same manner because outlook views
each of them as a folder not as separate

142
00:11:31,709 --> 00:11:34,709
entities

143
00:11:35,620 --> 00:11:45,040
alright so moving on from there looking
at client side there's a number of

144
00:11:45,040 --> 00:11:49,329
things that you can do with outlook for
client-side because when the number-one

145
00:11:49,330 --> 00:11:53,860
ways you blindside people is you send
them spear phishing emails and you get

146
00:11:53,860 --> 00:11:57,640
them to click on the email from the
problems you have is sending them an

147
00:11:57,640 --> 00:12:02,350
email and not having exchanged your
outlook sort of snatch it up in

148
00:12:02,350 --> 00:12:08,500
quarantine it so how does the email
system how does exchange decide what

149
00:12:08,500 --> 00:12:13,960
emails are junk and which are just
absolute outright malware there's

150
00:12:13,960 --> 00:12:17,529
something called your spam confidence
level so your spam conference that will

151
00:12:17,529 --> 00:12:23,770
or scl has a rating scale of 0 to 9 plus
negative 1 negative 1 is assigned to any

152
00:12:23,770 --> 00:12:27,370
email that comes from the trusted
internal network so if you have two

153
00:12:27,370 --> 00:12:30,640
people that are both logged in the same
domain sending an email between each

154
00:12:30,640 --> 00:12:34,000
other it's a negative 1 it automatically
goes back and forth

155
00:12:34,000 --> 00:12:39,070
no matter what it's considered safe and
trusted unless there are custom outlook

156
00:12:39,070 --> 00:12:41,890
rules or custom exchange rules that say
otherwise

157
00:12:41,890 --> 00:12:47,709
other than that it will be assigned a
score of 0 to 90 is extremely trusted it

158
00:12:47,709 --> 00:12:51,520
just says okay there's no way this is
malware it's just a line of text and it

159
00:12:51,520 --> 00:12:53,140
will let it go through

160
00:12:53,140 --> 00:12:58,330
depending on what other attributes email
has so if you add an attachment that has

161
00:12:58,330 --> 00:13:02,620
any executable functionality that's
going to make the SEL jump if you add

162
00:13:02,620 --> 00:13:07,690
any links to external sites that makes
the scl jump so depending on how many

163
00:13:07,690 --> 00:13:11,560
points each one or allocated based on
what's on the email it'll raise that

164
00:13:11,560 --> 00:13:15,760
spam confidence level as it gets higher
and higher it will trip to first the

165
00:13:15,760 --> 00:13:19,750
junk setting where it just goes straight
to the junk folder not that bad

166
00:13:19,750 --> 00:13:24,430
I if it goes to quarantine quarantines
an optional one it's not there by

167
00:13:24,430 --> 00:13:27,609
default and exchange but if the person
does add it

168
00:13:27,610 --> 00:13:32,260
that's the worst one for us because it
gets sent to the quarantine folder on

169
00:13:32,260 --> 00:13:36,819
the exchange server and only an exchange
admin has access to that folder to clean

170
00:13:36,820 --> 00:13:41,529
it up so you'll have a little issue
there if it gets really bad or go to

171
00:13:41,529 --> 00:13:45,160
reject in which case it won't send the
email and it sends a notice to the

172
00:13:45,160 --> 00:13:48,850
center or if it's you know coming

173
00:13:48,850 --> 00:13:52,750
from a Nigerian prince who wants to
transfer you money while selling viagra

174
00:13:52,750 --> 00:13:57,069
on the side it might go ahead and bump
all the way to delete and just get wiped

175
00:13:57,069 --> 00:14:02,349
out with no notification to anybody so
what does this have to do with outlook

176
00:14:02,350 --> 00:14:06,639
technically nothing but this has to do
with exchange so i'm going to count the

177
00:14:06,639 --> 00:14:07,959
to work hand-in-hand

178
00:14:07,959 --> 00:14:13,300
so there's a command lit that's built
into powershell but only for powershell

179
00:14:13,300 --> 00:14:16,719
for exchange so you will have to
actually get access to the exchange

180
00:14:16,720 --> 00:14:22,569
server or if you have the if you get
administrator creds you can powershell

181
00:14:22,569 --> 00:14:26,050
remote into the exchange server and
you'll have access to this commandment

182
00:14:26,050 --> 00:14:31,269
what new transport rule does is it lets
you make a new transport rule to

183
00:14:31,269 --> 00:14:37,480
designate how mail is handled where it
goes to whatever you want and this can

184
00:14:37,480 --> 00:14:43,149
be based on where it comes from the
center it's going to arm from I like

185
00:14:43,149 --> 00:14:48,850
from address contains words and subject
or body contains words so remember those

186
00:14:48,850 --> 00:14:52,300
two later on when we start talking about
some of the other things were going to

187
00:14:52,300 --> 00:14:55,959
do later but one of the easiest things
to do is once you're already in the

188
00:14:55,959 --> 00:14:59,229
network you get access to the exchange
server you want to make sure your later

189
00:14:59,230 --> 00:15:03,189
client-side to work set up sort of a
redundancy system we can use this first

190
00:15:03,189 --> 00:15:06,370
command so we're going to set a new
transport rule

191
00:15:06,370 --> 00:15:09,399
we're just going to name it set SEL you
can name it whatever you want his name

192
00:15:09,399 --> 00:15:10,000
it

193
00:15:10,000 --> 00:15:15,040
so we're gonna say anything coming from
our attack or email address going to our

194
00:15:15,040 --> 00:15:17,860
default target

195
00:15:17,860 --> 00:15:22,269
we're just going to set the scl 2-1 so
anything that we sent no matter what it

196
00:15:22,269 --> 00:15:26,290
is i can attach an executable to this
file and send it to him and it's going

197
00:15:26,290 --> 00:15:31,149
to go directly to his inbox even though
i'm coming from malicious dotnet or

198
00:15:31,149 --> 00:15:33,730
wherever it's going to send it right it

199
00:15:33,730 --> 00:15:38,139
the other thing you can do that's fun
and exciting is this bottom example so

200
00:15:38,139 --> 00:15:39,699
we're gonna set a new transport rule

201
00:15:39,699 --> 00:15:44,170
we're going to call it bc we're going to
say anything that is sent to our target

202
00:15:44,170 --> 00:15:49,089
person we're just going to automatically
blind carbon copy it to ourselves so now

203
00:15:49,089 --> 00:15:53,199
every email that person gets is going to
get exfilled in the background out to

204
00:15:53,199 --> 00:15:56,229
our email address and we don't even have
to do anything else

205
00:15:56,230 --> 00:15:59,110
we just left these rules in place

206
00:15:59,110 --> 00:16:08,350
right so now let's talk about the fun
stuff

207
00:16:08,350 --> 00:16:14,800
let's talk about back doors every
backdoor has one of two traits right

208
00:16:14,800 --> 00:16:19,510
it's either based on having a bind shell
or a reverse shell so they both have

209
00:16:19,510 --> 00:16:22,750
some flaws are things that can make them
rather detectable you've got a

210
00:16:22,750 --> 00:16:25,209
permanently bound socket that's horrible

211
00:16:25,209 --> 00:16:28,750
no one should do that anymore hopefully
no penetration testers are still at that

212
00:16:28,750 --> 00:16:32,920
level that they're leaving a socket
bound on the host it's too easy to find

213
00:16:32,920 --> 00:16:38,260
detect and stop beacons harder to find
that's definitely the preferred method

214
00:16:38,260 --> 00:16:42,579
the issue that you might have there is
even if you add some variance in your

215
00:16:42,579 --> 00:16:47,019
callbacks eventually there's a good
chance someone will have a fine-tuned

216
00:16:47,019 --> 00:16:50,680
IDs it's going to catch the traffic
going on a wire so best of both worlds

217
00:16:50,680 --> 00:16:55,120
gives you a host that has triggered will
access you have something that's not

218
00:16:55,120 --> 00:16:58,930
necessarily holding a socket opener
listening but is waiting for some form

219
00:16:58,930 --> 00:17:02,800
of a trigger a prime example this is
like a port not back door

220
00:17:02,800 --> 00:17:07,540
you know it's waiting for packets to hit
a particular packets to hit 445 followed

221
00:17:07,540 --> 00:17:13,030
by 135 followed by 139 and if it gets
them it will then have the payload call

222
00:17:13,030 --> 00:17:21,129
out that's a a trigger backdoor the
benefit of sugar black back doors again

223
00:17:21,130 --> 00:17:23,380
you have no sockets bound whatsoever

224
00:17:23,380 --> 00:17:28,780
there's no unnecessary network traffic
and you have twenty-four seven access

225
00:17:28,780 --> 00:17:34,840
outlook is an ideal triggering mechanism
if you think about it what to do it sits

226
00:17:34,840 --> 00:17:38,678
there at all time and waits for traffic
to come from wherever and auto forwards

227
00:17:38,679 --> 00:17:42,730
it to the host so if you have something
an Outlook that's listening for your

228
00:17:42,730 --> 00:17:51,700
trigger as soon as the trigger hits it
can have your payload call out so this

229
00:17:51,700 --> 00:17:57,100
portion i got inspired from matt nelson
so this is a he wrote a nice little

230
00:17:57,100 --> 00:18:00,760
proof-of-concept code that did this
again the link to its going to be at the

231
00:18:00,760 --> 00:18:06,340
end of the presentation this is only a
triggering mechanism you still have to

232
00:18:06,340 --> 00:18:10,059
have a persistence method like anything
else it is a powershell script it has to

233
00:18:10,059 --> 00:18:11,570
be started by something

234
00:18:11,570 --> 00:18:15,080
so you'll need some persistence method
that's going to start it up and you'll

235
00:18:15,080 --> 00:18:19,280
need to have some sort of payload that
it triggers for this simple proof of

236
00:18:19,280 --> 00:18:24,620
concept code i just had it trigger a
calculator because that seems to be the

237
00:18:24,620 --> 00:18:30,649
proof-of-concept go to you can pop a
calculator you can pop a shell so what

238
00:18:30,650 --> 00:18:35,390
the process is here it's gonna monitor
the inbox for the trigger email when the

239
00:18:35,390 --> 00:18:39,050
triggers detected its gonna start the
payload and have something called back

240
00:18:39,050 --> 00:18:45,409
out Matt Nelson's did this the only
things i did really that I tweaked on it

241
00:18:45,410 --> 00:18:52,280
a little bit is his deleted the email i
wanted to mark it as unread first and

242
00:18:52,280 --> 00:18:56,540
then after i delete it i also wanted to
remove it from the deleted items folder

243
00:18:56,540 --> 00:19:01,820
so it's not still just sitting there
after that it goes and sleeps 4

244
00:19:01,820 --> 00:19:15,649
designate interval and waits for another
trigger packet everything is easy to see

245
00:19:15,650 --> 00:19:19,730
except for the cursor there

246
00:19:22,400 --> 00:19:28,160
maybe there we go

247
00:19:28,160 --> 00:19:38,510
alright alright so for this trigger to
work we have to have a certain set of

248
00:19:38,510 --> 00:19:44,300
parameters that are defined obviously
you have to have the delay for how long

249
00:19:44,300 --> 00:19:45,470
you want to sleep

250
00:19:45,470 --> 00:19:49,430
the payload for what you wanted to
actually trigger again in this case i'm

251
00:19:49,430 --> 00:19:53,720
going to set it to a calculator and then
for this basic one it's just looking for

252
00:19:53,720 --> 00:19:59,090
the sender's email address and then the
subject line so if it receives an email

253
00:19:59,090 --> 00:20:04,879
from the designated sending address and
has the designated subject line it's

254
00:20:04,880 --> 00:20:08,990
going to go into its other instructions
and execute the payload and then it will

255
00:20:08,990 --> 00:20:12,350
sleep for delay it gets any email that
doesn't meet both those criteria

256
00:20:13,070 --> 00:20:16,159
it's going to just go about its business
go through asleep and then come back to

257
00:20:16,160 --> 00:20:18,770
another cycle

258
00:20:18,770 --> 00:20:24,080
ah there is also a switch if you want to
monitor the junk folder instead of

259
00:20:24,080 --> 00:20:29,240
monitoring the inbox that's fine and
dandy to on people don't tend to pay as

260
00:20:29,240 --> 00:20:33,260
much attention to things that go to the
junk folder so maybe you wanted to put a

261
00:20:33,260 --> 00:20:38,510
transport rule in that set the SEL 22 so
that your email automatically went to

262
00:20:38,510 --> 00:20:42,410
junk in which case you would set your
folder you're monitoring the junk so in

263
00:20:42,410 --> 00:20:44,960
the beginning section here we're just
defining which folder we're going to

264
00:20:44,960 --> 00:20:51,110
look at the junk folder is folder number
23 the outlook folder for the inbox is

265
00:20:51,110 --> 00:20:52,550
older number six

266
00:20:52,550 --> 00:20:56,210
I don't know what all the other folder
numbers are because they have a lot more

267
00:20:56,210 --> 00:20:59,810
folder numbers then they have actual
folders i guess they left some blank

268
00:20:59,810 --> 00:21:02,389
space in there in case they needed for
some future use

269
00:21:02,390 --> 00:21:07,550
so then we've got this process that
starts and it's going to start the

270
00:21:07,550 --> 00:21:11,840
outlook again and get that common object
and then we're defining the folder to be

271
00:21:11,840 --> 00:21:16,610
whichever folder was specified in the
earlier section after that it's going to

272
00:21:16,610 --> 00:21:20,600
define a variable called emails that is
everything that's in that folder and

273
00:21:20,600 --> 00:21:26,810
then for those emails you can see that
for those emails there's this little if

274
00:21:26,810 --> 00:21:30,620
statement that says if the sender
address matches sent mail and if the

275
00:21:30,620 --> 00:21:35,840
subject matches the trigger subject then
it will go into this behavior so

276
00:21:35,840 --> 00:21:39,470
first thing it does is marks the unread
to false so that's going to make it not

277
00:21:39,470 --> 00:21:44,330
show up as a new email gonna make it
sort of go away i will not go away but

278
00:21:44,330 --> 00:21:45,980
it's gonna mark it as read

279
00:21:45,980 --> 00:21:50,900
after that it's going to delete the
email so it gets moved to the lead items

280
00:21:50,900 --> 00:21:55,039
folder and isn't sitting in the inbox
anymore and it's been going to set this

281
00:21:55,039 --> 00:21:59,330
variable of cleaned to false so i used
to have it just run through and

282
00:21:59,330 --> 00:22:02,779
automatically clean up after it ran
through the trigger but then i'm

283
00:22:02,779 --> 00:22:06,380
scanning to it two different folders and
it was doubling the resources necessary

284
00:22:06,380 --> 00:22:10,190
for the script so now i just set a
variable once it finds the trigger email

285
00:22:10,190 --> 00:22:14,510
and deletes it sets the variable to
false so that excuse me

286
00:22:15,409 --> 00:22:20,750
so that it knows it has to clean up so
then if cleaned is equal false it will

287
00:22:20,750 --> 00:22:24,020
go through these clean up steps so the
first thing it does is it grabs the

288
00:22:24,020 --> 00:22:28,760
deleted items folder and then it defines
the emails is everything that's in the

289
00:22:28,760 --> 00:22:32,600
deleted items folder and then it looks
for that same email and when it finds it

290
00:22:32,600 --> 00:22:36,289
will delete it from the deleted items
and then set the clean variable to true

291
00:22:36,289 --> 00:22:39,440
so in the next cycle through it won't
attempt to clean up unless it receives

292
00:22:39,440 --> 00:22:47,059
another trigger after that it will start
the sleep cycle and i miss the part

293
00:22:47,059 --> 00:22:59,090
where it's calling the payload yep
that's right here okay i know i skipped

294
00:22:59,090 --> 00:23:02,689
it so yeah in the middle of that right
before deleted the email was start

295
00:23:02,690 --> 00:23:06,620
process payload so whatever you had set
as your process now wouldn't have to be

296
00:23:06,620 --> 00:23:10,399
an executable file instead of using
start process here you could use invoke

297
00:23:10,399 --> 00:23:16,399
expression and have it run a blob of the
script instead you could do whatever you

298
00:23:16,399 --> 00:23:21,469
really wanted it to be whatever you want
to set your payload to so after it goes

299
00:23:21,470 --> 00:23:25,250
through that and after cleans up but
then just sleeps with delay and after

300
00:23:25,250 --> 00:23:28,250
finishes it sleep it goes back to
monitoring the inbox again

301
00:23:38,450 --> 00:23:43,190
ok so again it's going to import the
module so it will load up i already have

302
00:23:43,190 --> 00:23:47,299
the email prepped but i have it sitting
in the junk folder so i also have

303
00:23:47,299 --> 00:23:51,918
anyones not familiar with powershell all
those lines say right verbose that are

304
00:23:51,919 --> 00:23:52,970
in the script

305
00:23:52,970 --> 00:23:56,750
those aren't going to do anything unless
the script has started with the attack

306
00:23:56,750 --> 00:24:00,919
for both switch in which case it will
give you extra information so once i

307
00:24:00,919 --> 00:24:07,250
start the trigger mechanism is going
you're going to see it right the repose

308
00:24:07,250 --> 00:24:12,919
most line saying it's checking the inbox
email not found and then sleeping and

309
00:24:12,919 --> 00:24:17,090
going to the cycle and then as soon as i
move the junk email folder from the junk

310
00:24:17,090 --> 00:24:21,860
folder to the inbox you'll see it then
trigger on the email and run through the

311
00:24:21,860 --> 00:24:28,189
rest of it steps and describe what it's
doing as it goes video is moving right

312
00:24:28,190 --> 00:24:30,950
there we go

313
00:24:30,950 --> 00:24:36,140
ok so there's the verbose lines it's
going through it sleep cycle it's not

314
00:24:36,140 --> 00:24:39,919
finding an email and it's moving on
because there's no email that matches

315
00:24:39,919 --> 00:24:45,770
the trigger in the inbox so now i'm
going to go to the junk email there is

316
00:24:45,770 --> 00:24:50,240
the email that matches the center and
the subject line so it's in the folder

317
00:24:50,240 --> 00:24:54,559
and you can see it just call it
triggered and started a calculator for

318
00:24:54,559 --> 00:24:57,559
us

319
00:24:58,450 --> 00:25:09,970
alright that's a fun happy active crowd

320
00:25:12,010 --> 00:25:15,370
alright so what's the one big problem
with using email as a triggering

321
00:25:15,370 --> 00:25:22,899
mechanism what happens when you get an
email you open it how do you know that

322
00:25:22,900 --> 00:25:25,120
you have one

323
00:25:25,120 --> 00:25:28,270
yeah it makes a pop-up right you get
this little thing that looks a lot like

324
00:25:28,270 --> 00:25:29,680
that shows up

325
00:25:29,680 --> 00:25:34,960
so what happens if you periodically get
a pop-up and then you go to the folder

326
00:25:34,960 --> 00:25:38,020
and the emails gone

327
00:25:38,020 --> 00:25:40,810
you might just scratch your head think
it's a glitch the first time but about

328
00:25:40,810 --> 00:25:44,169
the third or fourth time you have this
magical email that keeps popping up from

329
00:25:44,170 --> 00:25:48,820
the same center and then magically
disappearing you might start to call

330
00:25:48,820 --> 00:25:54,760
your IT guy and be like I think I'm
owned or you're just not very Cybersmart

331
00:25:54,760 --> 00:25:58,330
you might just roll with it for the rest
your life I don't know but we're going

332
00:25:58,330 --> 00:26:00,879
to give people the benefit of the doubt
and assume at some point they would make

333
00:26:00,880 --> 00:26:02,890
a jump

334
00:26:02,890 --> 00:26:08,890
so the issue that you have there is well
you still have to send the email for the

335
00:26:08,890 --> 00:26:14,410
trigger to work but that deleting the
email afterwards is going to sort of get

336
00:26:14,410 --> 00:26:18,550
you caught eventually so I had a
co-worker who said could you make that

337
00:26:18,550 --> 00:26:27,100
dynamic and I thought huh yeah i bet you
could thank you flip and so I wrote a

338
00:26:27,100 --> 00:26:32,530
script to run more dynamically so it
doesn't have to come from a specific IP

339
00:26:32,530 --> 00:26:34,570
address or email address

340
00:26:34,570 --> 00:26:40,179
it doesn't have to have a set trigger
line it can be any email that matches

341
00:26:40,180 --> 00:26:45,040
certain trigger criteria so who here has
a linkedin account

342
00:26:45,580 --> 00:26:50,770
alright so then having that LinkedIn
account who at least once every two

343
00:26:50,770 --> 00:26:54,100
weeks get some spam email for some
recruiter that scrape to off of your

344
00:26:54,100 --> 00:26:55,179
LinkedIn account

345
00:26:55,180 --> 00:26:59,050
yeah it's annoying as hell do you even
pay attention to them or do you just

346
00:26:59,050 --> 00:27:01,600
leave them there and move into your junk
folder delete them

347
00:27:01,600 --> 00:27:06,760
yeah I don't even read my most of time
anymore I just delete them and move on

348
00:27:07,450 --> 00:27:09,159
that's the premise we're going to work
with

349
00:27:09,159 --> 00:27:16,570
we're going to filter on the body of the
email instead of the sender address or

350
00:27:16,570 --> 00:27:21,820
the subject line what we're going to do
is we're going to have it look for a

351
00:27:21,820 --> 00:27:27,340
series of trigger words somewhere in the
body of the email so these would have to

352
00:27:27,340 --> 00:27:32,439
be three words that are common enough
that it wouldn't seem really strange you

353
00:27:32,440 --> 00:27:37,119
know you can't have superfluous and
supercalifragilisticexpialidocious and

354
00:27:37,119 --> 00:27:40,119
crap like that altogether because people
are going to notice those words

355
00:27:40,119 --> 00:27:45,820
recurring over and over again but on the
other hand it has to be specific enough

356
00:27:45,820 --> 00:27:49,869
that it's unlikely that a false trigger
will get sent

357
00:27:49,869 --> 00:27:53,168
we don't want an actual email from a
real person to trigger our payload

358
00:27:53,169 --> 00:27:56,979
either so we need to find the three
trigger words an email

359
00:27:56,979 --> 00:28:00,639
additionally we have to find a single
number the email can't have more than

360
00:28:00,639 --> 00:28:04,059
one number it has to have a single
number that falls within the port range

361
00:28:04,059 --> 00:28:13,509
so it has to be between 1 and 65535 it
also has to have a URL that URL will be

362
00:28:13,509 --> 00:28:16,720
resolved to an IP address that will then
be used for the callback

363
00:28:17,349 --> 00:28:21,309
so this way you can send your email from
any email address you want with any

364
00:28:21,309 --> 00:28:27,789
subject line in the body it just has to
contain three words a URL that can

365
00:28:27,789 --> 00:28:31,599
translate to the IP you want to call
back to and a single number that is the

366
00:28:31,599 --> 00:28:35,439
port you want to call back to this way
when you put your payload on target

367
00:28:35,440 --> 00:28:38,300
you can do a number of things you can
make a

368
00:28:38,300 --> 00:28:42,169
you're a big medicine boyfriend and
there's no antivirus on the network you

369
00:28:42,170 --> 00:28:45,290
can make a default interpreter payload
that just doesn't have a statically

370
00:28:45,290 --> 00:28:49,550
assigned callback that has a dynamic one
so you can provide parameters and have

371
00:28:49,550 --> 00:28:54,350
that call back or you can just have a
little blob of PowerShell that opens up

372
00:28:54,350 --> 00:29:02,209
a socket and calls back whatever suits
your fancy that was supposed to having

373
00:29:02,210 --> 00:29:07,640
it no mind to the turtle he's not really
they're all right

374
00:29:09,890 --> 00:29:16,460
ok so the parameters that you would have
to specify here and I put a little bit

375
00:29:16,460 --> 00:29:19,910
of parameter control on here to make
sure you get valid ones so the first one

376
00:29:19,910 --> 00:29:22,850
is you need your trigger words and i'm
using validate count there to make sure

377
00:29:22,850 --> 00:29:26,510
you gave exactly three trigger words if
you get less than that the script will

378
00:29:26,510 --> 00:29:32,090
probably freak out not be happy we have
a delay of course this is still

379
00:29:32,090 --> 00:29:35,419
monitoring and inbox so you have to set
a delay when you're setting the delay

380
00:29:35,420 --> 00:29:40,880
you need to find a balance if you set it
to two short it's going to start really

381
00:29:40,880 --> 00:29:44,630
burning ram because it's just constantly
scanning the inbox over and over again

382
00:29:44,630 --> 00:29:48,530
you set it to a long delay you're going
to be waiting a while for it to scan

383
00:29:48,530 --> 00:29:51,740
find your email and trigger your
callback so if your email gets deleted

384
00:29:51,740 --> 00:29:56,990
before it finds it you won't get your
call back so you need to find a middle

385
00:29:56,990 --> 00:30:01,070
ground there then you have to specify a
payload so what you want it to actually

386
00:30:01,070 --> 00:30:05,629
trigger and again it will scan the inbox
by default or if you tell it to move to

387
00:30:05,630 --> 00:30:10,010
the junk folder it will go to the junk
folder instead the rest of this should

388
00:30:10,010 --> 00:30:11,330
look very familiar

389
00:30:11,330 --> 00:30:16,280
so selecting the junk folder of the
inbox or hooking outlook the same way we

390
00:30:16,280 --> 00:30:21,410
did every time and then for each email
if the body matches the trigger word 0

391
00:30:21,410 --> 00:30:25,850
trigger words one and trigger words too
because our trigger words are just saved

392
00:30:25,850 --> 00:30:32,689
as a string array so as long as it finds
all three of them it will then grab the

393
00:30:32,690 --> 00:30:37,370
body of the email and it's going to load
it up in a variable and then we have two

394
00:30:37,370 --> 00:30:42,919
other variables i have defined here one
is the regex for URL and another is the

395
00:30:42,920 --> 00:30:45,740
regex for every possible port range

396
00:30:45,740 --> 00:30:50,120
I really suck at regex so i need to
thank my co-workers again for reading my

397
00:30:50,120 --> 00:30:51,830
reg ex for me it's not my fault

398
00:30:51,830 --> 00:31:00,559
rotate at all that was Jared after that
for each section in the so the format is

399
00:31:00,559 --> 00:31:05,330
just the body of the email split on
every space so it's grabbing each word

400
00:31:05,330 --> 00:31:09,980
or each section between spaces and
calling it a section and it's been

401
00:31:09,980 --> 00:31:17,570
checking each one of those and if it
matches the URL regex it's going to grab

402
00:31:17,570 --> 00:31:20,418
it and acknowledge that that is what
it's going to have to use this callback

403
00:31:20,419 --> 00:31:29,600
address if it matches the port regex
it's going to set that as the port so

404
00:31:29,600 --> 00:31:36,139
down here we're going to set look up to
use the dotnet accelerator system.net

405
00:31:36,139 --> 00:31:42,649
dns to get the hosts entry for that URL
and we've just gotta catch statement

406
00:31:42,649 --> 00:31:49,459
therefore if it goes fubar on us and
then we're doing the net IP address for

407
00:31:49,460 --> 00:31:55,070
the IP equals look up for that address
and then set the address to a string so

408
00:31:55,070 --> 00:31:59,389
I don't have an actual payload for the
demo here instead I'm having it resolve

409
00:31:59,389 --> 00:32:05,299
our our corporate email for the IP
address and then it's just going to pop

410
00:32:05,299 --> 00:32:10,940
a text document that says the IP address
i would call back to is this IP the port

411
00:32:10,940 --> 00:32:19,429
i would call back to is export back
alright

412
00:32:22,570 --> 00:32:28,450
yeah

413
00:32:30,380 --> 00:32:36,680
alright so again we're going to import
the module first we're setting it to go

414
00:32:36,680 --> 00:32:42,560
in the trigger words I think what I
picked were linkedin independent and

415
00:32:42,560 --> 00:32:47,149
cyberattacks security figured those are
all words that won't pop is like nasty

416
00:32:47,150 --> 00:32:51,950
buzz words but they're also things that
are unlikely to show up in an email by

417
00:32:51,950 --> 00:32:57,680
themselves because too hyper haha
hyphenate cybersecurity or even uses the

418
00:32:57,680 --> 00:33:03,110
term as much anymore so this is my email
I saw your profile on linkedin i'm an

419
00:33:03,110 --> 00:33:05,449
independent contractor yada yada

420
00:33:05,450 --> 00:33:13,610
I do a cybersecurity you can reach me at
chyron techcom and then I found a street

421
00:33:13,610 --> 00:33:17,540
address is a great place to squeeze in a
port number because street addresses do

422
00:33:17,540 --> 00:33:22,190
not generally have more than five digits
to him and ports also do not have more

423
00:33:22,190 --> 00:33:26,240
than five digits to them so it's a great
place to put your port number so it's

424
00:33:26,240 --> 00:33:29,510
again it's looking for the email it's
running it's not finding any because

425
00:33:29,510 --> 00:33:34,490
again it's in the junk email folder
right now and not in the folder that its

426
00:33:34,490 --> 00:33:38,900
monitoring so it's just going to go
through and sleep and try to find things

427
00:33:38,900 --> 00:33:47,690
because nothing in the inbox matches so
we're going to take our junk email and

428
00:33:47,690 --> 00:33:53,930
we are going to move it to our inbox and
it should find it in just a second

429
00:33:54,470 --> 00:33:58,580
so it said hey I found chyron tech and
it popped open a notepad so it will call

430
00:33:58,580 --> 00:34:04,790
back to that IP address on for 2700 and
i think i have an nslookup for our

431
00:34:04,790 --> 00:34:09,649
corporate IP address going that will
show that the port or rather the IP

432
00:34:09,649 --> 00:34:14,750
address is the same so that way it can
call back to whatever you want you don't

433
00:34:14,750 --> 00:34:17,030
have to use the same call back

434
00:34:17,030 --> 00:34:20,360
I peas or emails each time you set
things up

435
00:34:22,010 --> 00:34:25,010
let me minimize that too

436
00:34:26,270 --> 00:34:31,668
so that's awesome triggering backdoors
is great and then tell me what is better

437
00:34:31,668 --> 00:34:38,060
than triggering a backdoor what if you
don't even have to get on the box to

438
00:34:38,060 --> 00:34:42,290
begin with I mean at the end of the day
automation makes your life so much

439
00:34:42,290 --> 00:34:43,070
easier

440
00:34:43,070 --> 00:34:47,120
so what if you could have something that
monitors outlook and instead of having a

441
00:34:47,120 --> 00:34:47,899
call back

442
00:34:47,899 --> 00:34:51,500
that's going to trigger a payload and
call you back what if it's a what if the

443
00:34:51,500 --> 00:34:58,730
task you need to do is a smaller easier
one say it is that CEO and you know

444
00:34:58,730 --> 00:35:02,870
everything of value is on his desktop so
maybe you just want to get the contents

445
00:35:02,870 --> 00:35:05,870
of that desktop and pull it back on a
recurring basis

446
00:35:06,380 --> 00:35:13,520
well we can use outlook to get our
information for us and be our command

447
00:35:13,520 --> 00:35:17,300
control mechanism for our automation
script without having to get a shell on

448
00:35:17,300 --> 00:35:21,020
the target if you think about it it's
designed to receive emails

449
00:35:21,020 --> 00:35:25,220
it will then take the instructions we
give us to our collection attach it to

450
00:35:25,220 --> 00:35:28,970
another email and exhale the information
right back out to us using the same

451
00:35:28,970 --> 00:35:31,970
email system

452
00:35:34,070 --> 00:35:41,660
ok the problem with this is is you can't
just send a ps1 script to outlook it is

453
00:35:41,660 --> 00:35:42,500
not going to work

454
00:35:42,500 --> 00:35:46,910
anything with the ps1 extension is
instantly recognized as executable code

455
00:35:46,910 --> 00:35:50,450
and add a minimum it's going to go to
the junk folder and have the code

456
00:35:50,450 --> 00:35:51,350
disabled

457
00:35:51,350 --> 00:35:56,029
ah depending on how the exchange rules
are set up it can quarantine or reject

458
00:35:56,030 --> 00:36:00,440
your email so that leaves us two
possible options we can either put our

459
00:36:00,440 --> 00:36:06,170
script literally in the body of the
email or we can just attach it as a dot

460
00:36:06,170 --> 00:36:11,600
txt file outlook exchange consider text
files to be completely harmless and

461
00:36:11,600 --> 00:36:17,330
benign they don't even monitor for them
they just let them right through so you

462
00:36:17,330 --> 00:36:21,860
could have done either method i opted to
just go for the attachment so I'm just

463
00:36:21,860 --> 00:36:25,010
going to put the commands i want into a
text file and attach them to the email

464
00:36:27,950 --> 00:36:33,710
ok so it's a fairly fairly simple
process this could be streamlined and i

465
00:36:33,710 --> 00:36:38,300
plan to streamline a little more not a
later evolution of this but I just

466
00:36:38,300 --> 00:36:39,420
haven't gotten to it yet

467
00:36:39,420 --> 00:36:42,750
so it's going to monitor the inbox or
junk folder whatever you tell it once it

468
00:36:42,750 --> 00:36:46,890
detects the email it's going to and
again this is dynamic so it's looking

469
00:36:46,890 --> 00:36:50,160
for three trigger words in the email
body and then once it finds it it's

470
00:36:50,160 --> 00:36:54,180
going to take the attachment and it's
going to save the attachment to disk on

471
00:36:54,180 --> 00:37:00,390
the temp folder once it saves it it's
going to grab its contents saving as a

472
00:37:00,390 --> 00:37:04,558
variable and then delete that temporary
file its going to take that variable

473
00:37:04,559 --> 00:37:08,010
which contains your script it's going to
execute whatever instructions were

474
00:37:08,010 --> 00:37:12,089
inside of it and after it executes its
going to write the results out to

475
00:37:12,089 --> 00:37:16,799
another temporary file on the disk which
it will then attach as an attachment to

476
00:37:16,799 --> 00:37:21,420
an email that will go back to whatever
email address sent the script in the

477
00:37:21,420 --> 00:37:25,049
first place afterwards it will go
through the the standard cleanup

478
00:37:25,049 --> 00:37:28,950
procedures that will blow away that
second temp file it will delete both the

479
00:37:28,950 --> 00:37:34,049
trigger an exfil emails from the inbox
and the sent items folder and then it

480
00:37:34,049 --> 00:37:41,130
will clean up the deleted items folder
am i doing on time I need to go a little

481
00:37:41,130 --> 00:37:43,109
faster

482
00:37:43,109 --> 00:37:52,170
ok so it functions in a similar manner
to the others so I'm just going to all

483
00:37:52,170 --> 00:37:56,099
it needs four parameters is the delay in
the trigger words that setting the

484
00:37:56,099 --> 00:38:01,109
folder again i'm going to skip down to
the part that is new so for a place to

485
00:38:01,109 --> 00:38:05,339
save the disk i just went ahead and
saved a temp folder and for the names

486
00:38:05,339 --> 00:38:09,839
for the temporary files i went with
tilde DF some numbers because that's

487
00:38:09,839 --> 00:38:14,190
always there anyways it's how Windows
saves temp files there to begin with so

488
00:38:14,190 --> 00:38:16,589
we'll just throw a couple extras in
there they're not gonna be there long

489
00:38:16,589 --> 00:38:22,380
enough for anyone to notice and no AV is
going to be looking for malicious txt

490
00:38:22,380 --> 00:38:28,410
files because they're not executable so
it's going to save it to disk afterwards

491
00:38:28,410 --> 00:38:33,960
it's going to create a new outlook item
we're just setting a subject the body

492
00:38:33,960 --> 00:38:38,250
redefining the to address as the
attacker email from the trigger email

493
00:38:38,250 --> 00:38:43,559
and attaching the text file and then
sending it afterwards it goes through

494
00:38:43,559 --> 00:38:50,520
clean up which basically matches all the
others are on this last video you're

495
00:38:50,520 --> 00:38:53,009
going to notice things are a little bit
different

496
00:38:53,010 --> 00:38:57,840
there's going to be some pop-ups and i
will explain with the pop-ups are

497
00:38:57,840 --> 00:39:00,840
afterwards

498
00:39:02,880 --> 00:39:07,590
alright so there there are going to be
two pop-ups one is going to be when we

499
00:39:07,590 --> 00:39:11,190
start trying to grab emails from the
inbox you're going to see a pop-up from

500
00:39:11,190 --> 00:39:14,460
outlook saying hey somebody's doing
something bad you want to let him do

501
00:39:14,460 --> 00:39:15,210
this

502
00:39:15,210 --> 00:39:18,660
also when we try to send an email it's
going to make another pop-up that says

503
00:39:18,660 --> 00:39:21,029
hey somebody's doing something bad

504
00:39:21,030 --> 00:39:25,140
are you sure you want to let them do
this so I'll get into how we get around

505
00:39:25,140 --> 00:39:30,089
those later while momentarily because
i'm running out of time

506
00:39:30,780 --> 00:39:36,240
ok so this one has i made a much simpler
email but it's got the three trigger

507
00:39:36,240 --> 00:39:40,620
words and it has a text document it and
the text document has one command which

508
00:39:40,620 --> 00:39:44,520
is just get process so all its gonna do
is grab a process list and send the

509
00:39:44,520 --> 00:39:48,450
email back out in the script i commented
out the part where it cleans up the

510
00:39:48,450 --> 00:39:52,020
emails because i need to have to send
email there to show that it actually

511
00:39:52,020 --> 00:39:53,880
worked and it deleted it

512
00:39:53,880 --> 00:39:56,880
I just be like it did it I promise

513
00:39:57,690 --> 00:40:03,570
so it's going to run through i have it
loaded up with three trigger words kitty

514
00:40:03,570 --> 00:40:14,850
dog in cheeky ah it's searching and when
I moved the email to the inbox it should

515
00:40:14,850 --> 00:40:16,200
now momentarily

516
00:40:16,200 --> 00:40:19,830
there's the pop-up it says hey somebody
just tried to grab this email and do

517
00:40:19,830 --> 00:40:21,900
something are you sure you want to allow
this

518
00:40:21,900 --> 00:40:27,480
so I said yes allow it it's then going
to run the command and it's there's

519
00:40:27,480 --> 00:40:30,750
another one that says hey programs
trying to send an email in your name

520
00:40:30,750 --> 00:40:37,260
are you sure you want to allow this I
went ahead and said yes so it sent so it

521
00:40:37,260 --> 00:40:40,500
sent the item the verbose says that it
was cleaning up but it didn't actually

522
00:40:40,500 --> 00:40:44,310
clean up and if we look at the center
items folder there will be an email on

523
00:40:44,310 --> 00:40:48,840
there to our attacker with a attachment
that should have the process list

524
00:40:51,850 --> 00:41:00,759
haha alright so i think it's kinda Shh
minimize I think it's kind of shady to

525
00:41:00,760 --> 00:41:04,600
give a talk talking about nasty stuff
you can do without giving a quick

526
00:41:04,600 --> 00:41:09,940
preview of how you can actually do some
defense to this so how can you stop

527
00:41:09,940 --> 00:41:10,930
these things from happening

528
00:41:10,930 --> 00:41:18,790
how can you protect yourself uh-oh i
skipped a slide this is just what I'd

529
00:41:18,790 --> 00:41:19,720
like to do in the future

530
00:41:19,720 --> 00:41:24,730
obviously I want to add encryption but
i'm i'm smart enough about encryption to

531
00:41:24,730 --> 00:41:28,060
know that I'm not smart enough to roll
my own so I would have someone else

532
00:41:28,060 --> 00:41:32,200
wrote my crypto for me and it would like
to merge it all into one tools so you

533
00:41:32,200 --> 00:41:36,460
can sort it do it is an all-in-one and
not have four separate scripts so how do

534
00:41:36,460 --> 00:41:40,930
you protect yourself for starters you
can go ahead and get rid of your AV

535
00:41:40,930 --> 00:41:46,089
product this is a horrible idea to do in
general but the reason we didn't get

536
00:41:46,090 --> 00:41:53,500
pop-ups in the first three videos and we
did in the fourth the fourth one

537
00:41:53,500 --> 00:41:56,500
ah did not have an antivirus product

538
00:41:56,500 --> 00:42:00,460
yeah did not have an antivirus product
on it so once an antivirus product

539
00:42:00,460 --> 00:42:06,430
registers outlook says oh there's a navy
I don't have to protect myself anymore

540
00:42:06,430 --> 00:42:10,089
the AV product is going to do it for me
so those pop-ups you saw on the fourth

541
00:42:10,090 --> 00:42:14,050
video was outlook defending itself but
if you have a navy product

542
00:42:14,050 --> 00:42:19,420
thank you have asked you did a great job
outlook assumes that everything's fine

543
00:42:19,420 --> 00:42:24,340
and that the AV product will take care
of it so it didn't so I guess you just

544
00:42:24,340 --> 00:42:30,970
need to have a better any virus product
then that's free version maybe of a

545
00:42:30,970 --> 00:42:36,549
spade version will check email and
monitor but it does make outlook disable

546
00:42:36,550 --> 00:42:42,640
its own defenses other things you can do
I mean stopping it from happening is

547
00:42:42,640 --> 00:42:46,270
difficult unless you know you're
monitoring your exchange server but I

548
00:42:46,270 --> 00:42:51,970
mean event logs assume breach and just
monitor your event logs are starting

549
00:42:51,970 --> 00:42:57,939
with a colonel 61 so windows if you have
that particular hotfix attached in

550
00:42:57,940 --> 00:43:00,010
addition to auditing process creation

551
00:43:00,010 --> 00:43:04,780
you can also include the command line in
the event log so if

552
00:43:04,780 --> 00:43:08,770
have the command line it's going to have
when the powershell process starts going

553
00:43:08,770 --> 00:43:12,790
to have that it's starting a script and
where it's loading that script from look

554
00:43:12,790 --> 00:43:13,690
at that

555
00:43:13,690 --> 00:43:18,940
powershell logging if you're on a system
that has powershell you have a

556
00:43:18,940 --> 00:43:24,400
powershell log turn it on and set the
settings if you have powershell version

557
00:43:24,400 --> 00:43:28,960
for newer there's a feature called
powershell transcription so you can just

558
00:43:28,960 --> 00:43:32,740
type start transcript and it will record
every command and everything that those

559
00:43:32,740 --> 00:43:36,580
commands return that happens in a
powershell session there's also a

560
00:43:36,580 --> 00:43:40,630
setting you can turn on that has
mandatory powershell can script that

561
00:43:40,630 --> 00:43:47,080
transcription so anytime that powershell
pops on the host it's going to run and

562
00:43:47,080 --> 00:43:50,380
everything that got typed and written
it's written a disk but it doesn't alert

563
00:43:50,380 --> 00:43:58,780
the user that it's doing it the user in
this case being the attacker these are

564
00:43:58,780 --> 00:44:05,080
my shoutouts so for the scraping outlook
i got the idea from a at Wilson's thing

565
00:44:05,080 --> 00:44:11,950
on exporting your outlook calendar and
for the triggers I got the initial idea

566
00:44:11,950 --> 00:44:17,200
from again Matt Nelson's blog it is very
good i would recommend you read it if

567
00:44:17,200 --> 00:44:23,169
you have copious spare time if you want
any of these code samples they are all

568
00:44:23,170 --> 00:44:27,430
up on github feel free to grab them
modify them do it suits your fancy just

569
00:44:27,430 --> 00:44:33,580
please if you use them responsibly
didn't get them for me and that's all I

570
00:44:33,580 --> 00:44:35,410
have same we have any questions

571
00:44:35,410 --> 00:44:44,470
yes your energy you visible after
outlook on you create a popular to make

572
00:44:44,470 --> 00:44:47,660
it disappear so the user had actually

573
00:44:47,660 --> 00:44:54,950
located already loaded and this year or
not be visible for half a second so do

574
00:44:54,950 --> 00:44:56,290
everything

575
00:44:56,290 --> 00:45:03,759
so good job before our sure after are
drawn now I did not actually know that I

576
00:45:03,760 --> 00:45:07,210
learned something today there's a really
good talk i learned something

577
00:45:07,210 --> 00:45:13,720
thank you i'll have to talk to you
afterwards I any other questions

578
00:45:15,790 --> 00:45:27,670
bueller yes i'm not very hard to say our
time

579
00:45:34,360 --> 00:45:41,500
so you want to for which aspects you
want to store the scripts that I had

580
00:45:41,500 --> 00:45:45,730
that are running or the one for the
command-and-control that it runs in your

581
00:45:45,730 --> 00:46:00,850
family your ok you have interpreted your
heart attack back without cycle where

582
00:46:00,850 --> 00:46:09,009
you could hide it in an image i do not
have a strong background in stego

583
00:46:09,010 --> 00:46:14,740
theoretically yeah you probably just
made your script a lot longer but I

584
00:46:14,740 --> 00:46:20,770
don't see a reason why you wouldn't be
able to anybody else

585
00:46:21,850 --> 00:46:39,250
yes yes so the execution policy it's a
it's a good thing

586
00:46:39,250 --> 00:46:46,090
microsoft is very careful to call that a
safety feature not a security feature so

587
00:46:46,090 --> 00:46:50,560
the difference would be your seatbelt is
a safety feature it will not stop you

588
00:46:50,560 --> 00:46:55,390
from running your car into a tree
execution policy is a good catch but

589
00:46:55,390 --> 00:47:00,609
there's so many ways to bypass that that
I mean it'sit's really go surf web page

590
00:47:00,610 --> 00:47:04,780
is called 15 ways to bypass the script
execution policy in powershell it's

591
00:47:04,780 --> 00:47:07,780
pretty much child's play to step around

592
00:47:14,260 --> 00:47:20,530
but if i was going to deploy whatever
actually started up the script I would

593
00:47:20,530 --> 00:47:23,950
run that with a bypass to get past the
execution policy

594
00:47:24,580 --> 00:47:28,569
yep right i am just about out of time

