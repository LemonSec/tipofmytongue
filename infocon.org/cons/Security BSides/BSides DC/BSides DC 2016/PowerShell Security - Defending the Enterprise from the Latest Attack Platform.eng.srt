1
00:00:00,030 --> 00:00:06,660
the<font color="#E5E5E5"> b-sides DC 2016 videos are brought</font>

2
00:00:03,240 --> 00:00:09,389
to you by<font color="#E5E5E5"> clear jobs net and cybersex</font>

3
00:00:06,660 --> 00:00:12,900
<font color="#E5E5E5">jobs.com tools for your next career move</font>

4
00:00:09,389 --> 00:00:15,329
<font color="#CCCCCC">and Antietam</font><font color="#E5E5E5"> technologies focusing on</font>

5
00:00:12,900 --> 00:00:18,660
advanced cyber detection analysis and

6
00:00:15,330 --> 00:00:21,390
mitigation<font color="#CCCCCC"> okay so before we</font><font color="#E5E5E5"> get started</font>

7
00:00:18,660 --> 00:00:22,800
<font color="#CCCCCC">I'm Sean Metcalfe I've started a new</font>

8
00:00:21,390 --> 00:00:25,019
<font color="#CCCCCC">tradition at Derby con we're actually</font>

9
00:00:22,800 --> 00:00:26,070
<font color="#CCCCCC">giveaway puppies before my talk so I</font>

10
00:00:25,019 --> 00:00:28,948
have some puppies<font color="#E5E5E5"> here I'm gonna ask</font>

11
00:00:26,070 --> 00:00:32,340
<font color="#CCCCCC">some PowerShell questions who created</font>

12
00:00:28,949 --> 00:00:34,440
<font color="#E5E5E5">PowerShell</font><font color="#CCCCCC"> raise</font><font color="#E5E5E5"> your hand if you have</font>

13
00:00:32,340 --> 00:00:40,320
an answer no one<font color="#E5E5E5"> knows who created power</font>

14
00:00:34,440 --> 00:00:41,339
<font color="#E5E5E5">cell gets over there oh it's so close</font>

15
00:00:40,320 --> 00:00:43,200
<font color="#CCCCCC">okay</font>

16
00:00:41,340 --> 00:00:45,780
what was the<font color="#CCCCCC"> original code name for</font>

17
00:00:43,200 --> 00:00:52,230
PowerShell<font color="#CCCCCC"> I raise your hand I don't</font>

18
00:00:45,780 --> 00:00:55,410
<font color="#CCCCCC">know where she mo okay hey puppies okay</font>

19
00:00:52,230 --> 00:00:58,949
um what<font color="#E5E5E5"> is the default file extension</font>

20
00:00:55,410 --> 00:01:03,409
for<font color="#CCCCCC"> a</font><font color="#E5E5E5"> PowerShell script hands sorry it's</font>

21
00:00:58,949 --> 00:01:06,330
already at first<font color="#E5E5E5"> what is the what is</font>

22
00:01:03,409 --> 00:01:08,939
<font color="#CCCCCC">what is my favorite PowerShell post</font>

23
00:01:06,330 --> 00:01:11,750
exploitation<font color="#E5E5E5"> tools written by</font><font color="#CCCCCC"> Vera's</font>

24
00:01:08,939 --> 00:01:11,750
raise your hand

25
00:01:12,840 --> 00:01:23,539
<font color="#E5E5E5">yeah what is the new hotness from</font><font color="#CCCCCC"> varus</font>

26
00:01:19,439 --> 00:01:23,538
that does recon in Active Directory the

27
00:01:24,619 --> 00:01:28,220
<font color="#CCCCCC">poopies thank you</font>

28
00:01:29,390 --> 00:01:36,869
Wow even even<font color="#E5E5E5"> with video problems</font><font color="#CCCCCC"> it's</font>

29
00:01:32,520 --> 00:01:38,699
still worked out pretty good<font color="#CCCCCC"> so uh are</font>

30
00:01:36,869 --> 00:01:46,950
we<font color="#E5E5E5"> good on video</font><font color="#CCCCCC"> I'm gonna be over here</font>

31
00:01:38,700 --> 00:01:48,569
is<font color="#E5E5E5"> that fine okay so this is</font><font color="#CCCCCC"> PowerShell</font>

32
00:01:46,950 --> 00:01:50,549
security defending the enterprise<font color="#E5E5E5"> from</font>

33
00:01:48,569 --> 00:01:52,350
the<font color="#E5E5E5"> latest attack platform</font><font color="#CCCCCC"> and I am Sean</font>

34
00:01:50,549 --> 00:01:55,229
<font color="#CCCCCC">Metcalfe and</font><font color="#E5E5E5"> since it's 1:30 we're gonna</font>

35
00:01:52,350 --> 00:01:57,298
<font color="#E5E5E5">get started so I'm the founder of</font>

36
00:01:55,229 --> 00:01:59,310
<font color="#E5E5E5">Trimark a security company Microsoft</font>

37
00:01:57,299 --> 00:02:00,869
<font color="#E5E5E5">Certified Master</font><font color="#CCCCCC"> in Active Directory one</font>

38
00:01:59,310 --> 00:02:03,110
of<font color="#CCCCCC"> about a hundred</font><font color="#E5E5E5"> in the world and a</font>

39
00:02:00,869 --> 00:02:04,619
Microsoft MVP as of earlier this year<font color="#CCCCCC"> I</font>

40
00:02:03,110 --> 00:02:06,420
spoken at a number<font color="#E5E5E5"> of</font><font color="#CCCCCC"> different</font>

41
00:02:04,619 --> 00:02:08,519
<font color="#CCCCCC">conferences it's</font><font color="#E5E5E5"> my first time speaking</font>

42
00:02:06,420 --> 00:02:11,310
at besides DC I'm very excited to<font color="#E5E5E5"> be</font>

43
00:02:08,519 --> 00:02:13,709
here I'm a<font color="#E5E5E5"> security consultant and a</font>

44
00:02:11,310 --> 00:02:15,599
researcher and I own and operate<font color="#E5E5E5"> 80</font>

45
00:02:13,709 --> 00:02:17,630
security<font color="#CCCCCC"> Touareg which hopefully many</font><font color="#E5E5E5"> of</font>

46
00:02:15,599 --> 00:02:20,369
you have been to and have checked out

47
00:02:17,630 --> 00:02:25,230
<font color="#CCCCCC">also at one point in time I raced</font>

48
00:02:20,370 --> 00:02:26,790
armadillos long story so PowerShell<font color="#CCCCCC"> what</font>

49
00:02:25,230 --> 00:02:29,399
are we talking about<font color="#E5E5E5"> with this what is</font>

50
00:02:26,790 --> 00:02:32,790
PowerShell I think most<font color="#E5E5E5"> people here</font><font color="#CCCCCC"> know</font>

51
00:02:29,400 --> 00:02:34,799
what PowerShell is but we're gonna<font color="#E5E5E5"> cover</font>

52
00:02:32,790 --> 00:02:37,650
very<font color="#CCCCCC"> briefly some cool things about</font>

53
00:02:34,799 --> 00:02:39,150
PowerShell what its capability is I'm

54
00:02:37,650 --> 00:02:41,010
<font color="#E5E5E5">gonna talk about how it's used as an</font>

55
00:02:39,150 --> 00:02:43,130
attack platform<font color="#CCCCCC"> look at some real-world</font>

56
00:02:41,010 --> 00:02:45,000
<font color="#E5E5E5">attack code that I found on the</font><font color="#CCCCCC"> internet</font>

57
00:02:43,130 --> 00:02:47,250
<font color="#CCCCCC">because everything</font><font color="#E5E5E5"> on the</font><font color="#CCCCCC"> internet is</font>

58
00:02:45,000 --> 00:02:49,680
<font color="#E5E5E5">cool and awesome and we're gonna talk</font>

59
00:02:47,250 --> 00:02:51,630
<font color="#CCCCCC">about how all of</font><font color="#E5E5E5"> these new PowerShell</font>

60
00:02:49,680 --> 00:02:55,769
security features are<font color="#CCCCCC"> often bypassed</font><font color="#E5E5E5"> by</font>

61
00:02:51,630 --> 00:02:59,370
<font color="#E5E5E5">attackers so isn't PowerShell just C</font>

62
00:02:55,769 --> 00:03:02,370
<font color="#E5E5E5">sharp with training wheels Wow</font>

63
00:02:59,370 --> 00:03:04,170
kind of yes<font color="#CCCCCC"> it absolutely is I posed</font>

64
00:03:02,370 --> 00:03:05,190
this question to<font color="#CCCCCC"> Matt graver and he kind</font>

65
00:03:04,170 --> 00:03:07,798
of just<font color="#CCCCCC"> turned around and walked away</font>

66
00:03:05,190 --> 00:03:09,180
<font color="#E5E5E5">from me which makes sense because</font>

67
00:03:07,799 --> 00:03:11,480
apparently the squirrel doesn't<font color="#E5E5E5"> know how</font>

68
00:03:09,180 --> 00:03:14,489
to<font color="#E5E5E5"> ride a tricycle so that's how it goes</font>

69
00:03:11,480 --> 00:03:16,170
but PowerShell is an object<font color="#CCCCCC"> based</font>

70
00:03:14,489 --> 00:03:19,139
scripting language which leveraged

71
00:03:16,170 --> 00:03:22,859
leverages net originally written and

72
00:03:19,139 --> 00:03:26,400
<font color="#E5E5E5">design and c-sharp it has tremendous</font>

73
00:03:22,860 --> 00:03:29,430
capability it has basic<font color="#E5E5E5"> connectivity</font>

74
00:03:26,400 --> 00:03:31,890
and ability to pull data from<font color="#E5E5E5"> disparate</font>

75
00:03:29,430 --> 00:03:37,560
data<font color="#CCCCCC"> sources like</font><font color="#E5E5E5"> the registry the event</font>

76
00:03:31,890 --> 00:03:38,879
log<font color="#E5E5E5"> WMI</font><font color="#CCCCCC"> XML</font><font color="#E5E5E5"> and so the power of it is</font>

77
00:03:37,560 --> 00:03:40,620
<font color="#E5E5E5">the fact</font><font color="#CCCCCC"> that you don't</font><font color="#E5E5E5"> have</font><font color="#CCCCCC"> to write</font>

78
00:03:38,879 --> 00:03:42,599
<font color="#CCCCCC">your</font><font color="#E5E5E5"> own parsers</font><font color="#CCCCCC"> for a lot</font><font color="#E5E5E5"> of this you</font>

79
00:03:40,620 --> 00:03:46,110
can just natively pull in data<font color="#E5E5E5"> from XML</font>

80
00:03:42,599 --> 00:03:47,700
<font color="#E5E5E5">and work with it</font><font color="#CCCCCC"> you can extend the</font>

81
00:03:46,110 --> 00:03:49,530
<font color="#CCCCCC">PowerShell capability the commandments</font>

82
00:03:47,700 --> 00:03:52,109
<font color="#CCCCCC">that are available</font><font color="#E5E5E5"> on the box by</font>

83
00:03:49,530 --> 00:03:53,579
importing command modules<font color="#E5E5E5"> which then</font>

84
00:03:52,110 --> 00:03:55,230
provide a whole lot<font color="#E5E5E5"> of additional</font>

85
00:03:53,579 --> 00:03:58,650
commandlets which are<font color="#E5E5E5"> purpose-built and</font>

86
00:03:55,230 --> 00:04:01,349
specific to a<font color="#CCCCCC"> specific purpose or area</font>

87
00:03:58,650 --> 00:04:03,750
<font color="#E5E5E5">or command or data gathering session</font>

88
00:04:01,349 --> 00:04:05,700
that you need or<font color="#CCCCCC"> you want and it's</font>

89
00:04:03,750 --> 00:04:07,200
almost<font color="#CCCCCC"> ten years</font><font color="#E5E5E5"> old now</font><font color="#CCCCCC"> in fact next</font>

90
00:04:05,700 --> 00:04:09,238
month<font color="#CCCCCC"> PowerShell will be 10 years</font><font color="#E5E5E5"> old</font>

91
00:04:07,200 --> 00:04:10,909
<font color="#E5E5E5">and Here I am</font><font color="#CCCCCC"> talking about it in DC</font>

92
00:04:09,239 --> 00:04:13,409
<font color="#E5E5E5">it's pretty exciting</font>

93
00:04:10,909 --> 00:04:14,819
so with PowerShell<font color="#E5E5E5"> version 5 we get a</font>

94
00:04:13,409 --> 00:04:16,320
lot<font color="#E5E5E5"> of nice security enhancements</font>

95
00:04:14,819 --> 00:04:18,539
PowerShell version<font color="#CCCCCC"> 5 of course came out</font>

96
00:04:16,320 --> 00:04:19,769
early this year<font color="#E5E5E5"> technically it came out</font>

97
00:04:18,539 --> 00:04:21,449
in December of<font color="#CCCCCC"> last year but we're not</font>

98
00:04:19,769 --> 00:04:23,490
<font color="#E5E5E5">talking about that it came out</font><font color="#CCCCCC"> this year</font>

99
00:04:21,449 --> 00:04:25,320
and<font color="#CCCCCC"> we get some</font><font color="#E5E5E5"> really great features</font>

100
00:04:23,490 --> 00:04:27,660
<font color="#E5E5E5">script lock logging system-wide</font>

101
00:04:25,320 --> 00:04:30,090
transcripts constrained PowerShell that

102
00:04:27,660 --> 00:04:31,020
that locks in locks down PowerShell when

103
00:04:30,090 --> 00:04:34,138
you have application whitelisting

104
00:04:31,020 --> 00:04:36,419
enabled<font color="#E5E5E5"> like app Locker or device guard</font>

105
00:04:34,139 --> 00:04:39,630
and anti-malware integration with

106
00:04:36,419 --> 00:04:41,460
Windows<font color="#E5E5E5"> 10 we can configure these</font>

107
00:04:39,630 --> 00:04:43,650
settings<font color="#E5E5E5"> we</font><font color="#CCCCCC"> can configure these security</font>

108
00:04:41,460 --> 00:04:44,940
through group policy<font color="#CCCCCC"> and there's a</font>

109
00:04:43,650 --> 00:04:47,190
<font color="#CCCCCC">number of</font><font color="#E5E5E5"> different settings and options</font>

110
00:04:44,940 --> 00:04:49,139
<font color="#CCCCCC">that</font><font color="#E5E5E5"> we have here all this group</font><font color="#CCCCCC"> policy</font>

111
00:04:47,190 --> 00:04:50,639
is doing is setting<font color="#E5E5E5"> items in the</font>

112
00:04:49,139 --> 00:04:52,440
registry and<font color="#E5E5E5"> I'm sorry it's very</font>

113
00:04:50,639 --> 00:04:54,030
difficult to see but<font color="#CCCCCC"> that's the registry</font>

114
00:04:52,440 --> 00:04:58,080
those are the<font color="#E5E5E5"> settings we just nod and</font>

115
00:04:54,030 --> 00:04:59,760
<font color="#E5E5E5">smile we move on script lock logging we</font>

116
00:04:58,080 --> 00:05:02,990
can enable<font color="#E5E5E5"> through the group</font><font color="#CCCCCC"> policy</font><font color="#E5E5E5"> and</font>

117
00:04:59,760 --> 00:05:05,340
<font color="#E5E5E5">basically script lock logging takes that</font>

118
00:05:02,990 --> 00:05:07,560
PowerShell code that's delivered to<font color="#E5E5E5"> the</font>

119
00:05:05,340 --> 00:05:11,039
PowerShell engine and effectively just

120
00:05:07,560 --> 00:05:13,530
before<font color="#E5E5E5"> it's executed it's logged so with</font>

121
00:05:11,039 --> 00:05:15,449
module<font color="#CCCCCC"> Augen the type of</font><font color="#E5E5E5"> logging we have</font>

122
00:05:13,530 --> 00:05:18,539
<font color="#E5E5E5">in power show on version 3</font><font color="#CCCCCC"> in version 4</font>

123
00:05:15,449 --> 00:05:20,820
and also<font color="#E5E5E5"> in</font><font color="#CCCCCC"> 5 what that gives us is</font>

124
00:05:18,539 --> 00:05:23,340
whatever code is delivered<font color="#CCCCCC"> to the engine</font>

125
00:05:20,820 --> 00:05:24,930
<font color="#E5E5E5">is what gets logged well there's a</font>

126
00:05:23,340 --> 00:05:28,198
problem<font color="#E5E5E5"> with that</font><font color="#CCCCCC"> because if that code</font>

127
00:05:24,930 --> 00:05:29,610
<font color="#E5E5E5">is</font><font color="#CCCCCC"> obfuscated if it's</font><font color="#E5E5E5"> bunged around in</font>

128
00:05:28,199 --> 00:05:32,880
such a way that<font color="#E5E5E5"> it doesn't look</font><font color="#CCCCCC"> like</font>

129
00:05:29,610 --> 00:05:34,020
language it doesn't<font color="#E5E5E5"> look clear to us it</font>

130
00:05:32,880 --> 00:05:36,419
makes<font color="#E5E5E5"> it very</font><font color="#CCCCCC"> difficult</font><font color="#E5E5E5"> to identify</font>

131
00:05:34,020 --> 00:05:38,520
<font color="#E5E5E5">what's</font><font color="#CCCCCC"> going on with script block</font><font color="#E5E5E5"> log</font>

132
00:05:36,419 --> 00:05:39,900
and we can actually get what<font color="#E5E5E5"> PowerShell</font>

133
00:05:38,520 --> 00:05:41,698
interprets<font color="#E5E5E5"> and what it's a</font>

134
00:05:39,900 --> 00:05:44,340
to run in order<font color="#CCCCCC"> to look at</font><font color="#E5E5E5"> that and</font>

135
00:05:41,699 --> 00:05:48,090
create indicators<font color="#E5E5E5"> so we want to turn</font>

136
00:05:44,340 --> 00:05:49,258
<font color="#E5E5E5">that</font><font color="#CCCCCC"> on</font><font color="#E5E5E5"> because if someone is running an</font>

137
00:05:48,090 --> 00:05:51,150
encoded command<font color="#CCCCCC"> or doing some</font>

138
00:05:49,259 --> 00:05:53,039
obfuscation<font color="#CCCCCC"> in this event we're actually</font>

139
00:05:51,150 --> 00:05:56,039
going to<font color="#E5E5E5"> see that someone's running</font>

140
00:05:53,039 --> 00:05:58,860
invoke mimikatz<font color="#E5E5E5"> another nice feature</font>

141
00:05:56,039 --> 00:06:00,090
<font color="#CCCCCC">system-wide transcript so in PowerShell</font>

142
00:05:58,860 --> 00:06:03,120
we've had the ability<font color="#CCCCCC"> to have a</font>

143
00:06:00,090 --> 00:06:05,429
transcript which is a file that<font color="#CCCCCC"> gets</font>

144
00:06:03,120 --> 00:06:06,930
written<font color="#E5E5E5"> when you tell</font><font color="#CCCCCC"> it to Pat tell</font>

145
00:06:05,430 --> 00:06:08,520
PowerShell go ahead and write a file for

146
00:06:06,930 --> 00:06:10,500
<font color="#E5E5E5">me and say show everything that's shows</font>

147
00:06:08,520 --> 00:06:11,940
up in the console the system-wide

148
00:06:10,500 --> 00:06:14,070
transcript is something that once

149
00:06:11,940 --> 00:06:16,289
enabled you<font color="#CCCCCC"> can point it to a share on</font>

150
00:06:14,070 --> 00:06:17,909
<font color="#E5E5E5">the network make it a right</font><font color="#CCCCCC"> one</font><font color="#E5E5E5"> share so</font>

151
00:06:16,289 --> 00:06:20,639
that<font color="#CCCCCC"> way</font><font color="#E5E5E5"> that file is written there and</font>

152
00:06:17,910 --> 00:06:23,610
cannot be<font color="#E5E5E5"> modified and it's written</font>

153
00:06:20,639 --> 00:06:25,169
<font color="#E5E5E5">anytime any user on that system opens up</font>

154
00:06:23,610 --> 00:06:27,300
the PowerShell console or does<font color="#E5E5E5"> something</font>

155
00:06:25,169 --> 00:06:29,010
in<font color="#CCCCCC"> PowerShell</font><font color="#E5E5E5"> and</font><font color="#CCCCCC"> it's effectively an</font>

156
00:06:27,300 --> 00:06:31,169
over-the-shoulder transcript of what

157
00:06:29,010 --> 00:06:33,270
they're<font color="#E5E5E5"> doing so you can go back</font><font color="#CCCCCC"> to that</font>

158
00:06:31,169 --> 00:06:35,099
look<font color="#E5E5E5"> at that later and go oh that looks</font>

159
00:06:33,270 --> 00:06:37,560
like partial Empire that looks

160
00:06:35,099 --> 00:06:39,300
interesting<font color="#CCCCCC"> and this is what it looks</font>

161
00:06:37,560 --> 00:06:41,490
<font color="#CCCCCC">like so</font><font color="#E5E5E5"> we've got a lot of really good</font>

162
00:06:39,300 --> 00:06:43,710
information<font color="#E5E5E5"> at the top start time</font><font color="#CCCCCC"> the</font>

163
00:06:41,490 --> 00:06:45,870
user name who's run as machine it's on

164
00:06:43,710 --> 00:06:47,510
the host<font color="#CCCCCC"> application if it's PowerShell</font>

165
00:06:45,870 --> 00:06:50,160
dideoxy or maybe it's<font color="#CCCCCC"> something</font><font color="#E5E5E5"> else</font>

166
00:06:47,510 --> 00:06:51,599
the version of PowerShell etc and we can

167
00:06:50,160 --> 00:06:55,310
see that<font color="#E5E5E5"> maybe</font><font color="#CCCCCC"> Katz is running on this</font>

168
00:06:51,599 --> 00:06:57,870
which<font color="#CCCCCC"> looks a</font><font color="#E5E5E5"> little</font><font color="#CCCCCC"> suspicious</font>

169
00:06:55,310 --> 00:07:00,780
the enforced PowerShell<font color="#CCCCCC"> constrained</font>

170
00:06:57,870 --> 00:07:03,630
language mode locks down PowerShell to

171
00:07:00,780 --> 00:07:05,489
<font color="#CCCCCC">its core components so we</font><font color="#E5E5E5"> can't run</font>

172
00:07:03,630 --> 00:07:08,070
those advanced<font color="#E5E5E5"> features</font><font color="#CCCCCC"> that invoke</font>

173
00:07:05,490 --> 00:07:12,720
mimikatz loves using<font color="#E5E5E5"> like calling</font>

174
00:07:08,070 --> 00:07:15,360
<font color="#CCCCCC">windows</font><font color="#E5E5E5"> api's calling net etc and this</font>

175
00:07:12,720 --> 00:07:18,150
locks down<font color="#E5E5E5"> with</font><font color="#CCCCCC"> AppLocker device guard</font>

176
00:07:15,360 --> 00:07:19,830
once you have that<font color="#CCCCCC"> enforce mode so this</font>

177
00:07:18,150 --> 00:07:21,960
means<font color="#E5E5E5"> that these more advanced scripts</font>

178
00:07:19,830 --> 00:07:23,789
such<font color="#E5E5E5"> as</font><font color="#CCCCCC"> those that are</font><font color="#E5E5E5"> in power sploit</font>

179
00:07:21,960 --> 00:07:27,359
like<font color="#CCCCCC"> invoke invoke mimikatz</font>

180
00:07:23,789 --> 00:07:29,960
or<font color="#CCCCCC"> D gets</font><font color="#E5E5E5"> keystrokes which is a</font>

181
00:07:27,360 --> 00:07:32,460
keystroke<font color="#E5E5E5"> logger within PowerShell or</font>

182
00:07:29,960 --> 00:07:34,138
even<font color="#E5E5E5"> just dumping a process from</font>

183
00:07:32,460 --> 00:07:35,430
<font color="#CCCCCC">powersploit</font><font color="#E5E5E5"> all those get blocked</font>

184
00:07:34,139 --> 00:07:39,570
<font color="#E5E5E5">because</font><font color="#CCCCCC"> as advanced</font><font color="#E5E5E5"> functions</font>

185
00:07:35,430 --> 00:07:42,030
functionality get blocked<font color="#E5E5E5"> and if we run</font>

186
00:07:39,570 --> 00:07:44,219
<font color="#E5E5E5">maybe</font><font color="#CCCCCC"> Katz</font><font color="#E5E5E5"> even if we're downloading it</font>

187
00:07:42,030 --> 00:07:46,380
<font color="#E5E5E5">that's</font><font color="#CCCCCC"> cue to get</font><font color="#E5E5E5"> in memory it still</font>

188
00:07:44,220 --> 00:07:47,729
<font color="#E5E5E5">gets blocked because</font><font color="#CCCCCC"> constrained</font>

189
00:07:46,380 --> 00:07:49,289
language mode says I<font color="#CCCCCC"> don't know what</font>

190
00:07:47,729 --> 00:07:53,190
you're trying<font color="#CCCCCC"> to do only</font><font color="#E5E5E5"> core types are</font>

191
00:07:49,289 --> 00:07:55,500
available<font color="#E5E5E5"> and in Windows 10 we get</font>

192
00:07:53,190 --> 00:07:58,950
ms:i which is the anti-malware scan

193
00:07:55,500 --> 00:08:01,680
interface this<font color="#CCCCCC"> is a big step up</font><font color="#E5E5E5"> with</font>

194
00:07:58,950 --> 00:08:05,400
Windows 10<font color="#E5E5E5"> traditional antivirus can</font>

195
00:08:01,680 --> 00:08:08,460
only see and scan files<font color="#CCCCCC"> if they hit disk</font>

196
00:08:05,400 --> 00:08:10,710
<font color="#E5E5E5">they don't hit this they have no idea</font>

197
00:08:08,460 --> 00:08:13,590
what's going<font color="#E5E5E5"> on so what does this mean</font>

198
00:08:10,710 --> 00:08:15,390
if<font color="#E5E5E5"> I download and execute invoke</font>

199
00:08:13,590 --> 00:08:17,070
mimikatz<font color="#CCCCCC"> in memory without</font><font color="#E5E5E5"> it ever</font>

200
00:08:15,390 --> 00:08:19,710
touching disk<font color="#E5E5E5"> antivirus can't do</font>

201
00:08:17,070 --> 00:08:21,420
<font color="#E5E5E5">anything about it but with Windows 10</font>

202
00:08:19,710 --> 00:08:24,030
<font color="#CCCCCC">and</font><font color="#E5E5E5"> the MSI assuming that I have</font><font color="#CCCCCC"> a</font>

203
00:08:21,420 --> 00:08:27,330
registered anti-malware solution with

204
00:08:24,030 --> 00:08:29,070
MSI<font color="#E5E5E5"> like Windows Defender PowerShell</font>

205
00:08:27,330 --> 00:08:30,539
once it gets that code is going<font color="#E5E5E5"> to kick</font>

206
00:08:29,070 --> 00:08:32,280
it through<font color="#E5E5E5"> the EMS ID or whatever</font><font color="#CCCCCC"> that</font>

207
00:08:30,540 --> 00:08:34,830
registered anti-malware is and it's

208
00:08:32,280 --> 00:08:37,199
checking<font color="#E5E5E5"> and send</font><font color="#CCCCCC"> back a status ok</font>

209
00:08:34,830 --> 00:08:39,840
<font color="#E5E5E5">PowerShell will run it the same thing</font>

210
00:08:37,200 --> 00:08:41,550
happens for vbscript<font color="#CCCCCC"> and other windows</font>

211
00:08:39,840 --> 00:08:43,650
scripting hosts and engines on that

212
00:08:41,549 --> 00:08:45,810
system<font color="#CCCCCC"> so now we can get</font><font color="#E5E5E5"> more insight</font>

213
00:08:43,650 --> 00:08:48,090
<font color="#CCCCCC">into what's going on from a scripting</font>

214
00:08:45,810 --> 00:08:50,130
perspective on our<font color="#CCCCCC"> windows boxes and</font>

215
00:08:48,090 --> 00:08:52,410
this<font color="#E5E5E5"> is what it looks like so if</font><font color="#CCCCCC"> I</font>

216
00:08:50,130 --> 00:08:54,210
<font color="#CCCCCC">download next cute that code</font><font color="#E5E5E5"> memory it's</font>

217
00:08:52,410 --> 00:08:57,350
<font color="#E5E5E5">gonna get stopped assuming that it's</font>

218
00:08:54,210 --> 00:08:57,350
flagged as<font color="#E5E5E5"> malicious</font>

219
00:08:58,130 --> 00:09:01,639
and what's interesting<font color="#E5E5E5"> about this if you</font>

220
00:09:00,079 --> 00:09:04,430
look at the file path<font color="#E5E5E5"> it's actually</font>

221
00:09:01,639 --> 00:09:05,899
<font color="#E5E5E5">triggering on PowerShell</font><font color="#CCCCCC"> DHC does anyone</font>

222
00:09:04,430 --> 00:09:09,170
think<font color="#CCCCCC"> that PowerShell you see is really</font>

223
00:09:05,899 --> 00:09:12,800
malicious<font color="#E5E5E5"> no it's not what happens is</font>

224
00:09:09,170 --> 00:09:14,979
when<font color="#E5E5E5"> you download that code and jam it</font>

225
00:09:12,800 --> 00:09:17,479
<font color="#E5E5E5">into memory and execute it from memory</font>

226
00:09:14,980 --> 00:09:18,800
<font color="#E5E5E5">it's not a file right it doesn't</font><font color="#CCCCCC"> have a</font>

227
00:09:17,480 --> 00:09:20,720
place on<font color="#E5E5E5"> the hard drive</font><font color="#CCCCCC"> that it can</font>

228
00:09:18,800 --> 00:09:22,370
reference so there's effectively<font color="#E5E5E5"> a</font>

229
00:09:20,720 --> 00:09:23,839
virtual<font color="#E5E5E5"> address that gets added or</font>

230
00:09:22,370 --> 00:09:26,180
virtual file<font color="#E5E5E5"> that</font><font color="#CCCCCC"> gets</font><font color="#E5E5E5"> added to</font>

231
00:09:23,839 --> 00:09:29,300
<font color="#CCCCCC">PowerShell dot exe here and that's what</font>

232
00:09:26,180 --> 00:09:30,829
it's that's how it tracks<font color="#E5E5E5"> it and we can</font>

233
00:09:29,300 --> 00:09:32,839
see that<font color="#E5E5E5"> here when we're</font><font color="#CCCCCC"> looking at a</font>

234
00:09:30,829 --> 00:09:34,310
couple<font color="#CCCCCC"> of the powershell commandlets</font>

235
00:09:32,839 --> 00:09:36,050
that will give<font color="#CCCCCC"> us</font><font color="#E5E5E5"> more information about</font>

236
00:09:34,310 --> 00:09:38,268
<font color="#CCCCCC">threats that</font><font color="#E5E5E5"> are detected by defender</font>

237
00:09:36,050 --> 00:09:40,550
<font color="#E5E5E5">and in the top you can</font><font color="#CCCCCC"> see</font><font color="#E5E5E5"> that I was</font>

238
00:09:38,269 --> 00:09:43,610
trying<font color="#CCCCCC"> to copy a Reno</font><font color="#E5E5E5"> renamed invoke</font>

239
00:09:40,550 --> 00:09:45,740
mimikatz file to another<font color="#E5E5E5"> named invoke</font>

240
00:09:43,610 --> 00:09:47,600
mimikatz file and it flagged it as<font color="#E5E5E5"> a</font>

241
00:09:45,740 --> 00:09:49,160
threat it said that looks bad I'm not

242
00:09:47,600 --> 00:09:52,880
<font color="#CCCCCC">gonna let that happen and it stopped the</font>

243
00:09:49,160 --> 00:09:54,680
copy the second one was actually pulling

244
00:09:52,880 --> 00:09:56,899
<font color="#E5E5E5">that code from the internet injecting it</font>

245
00:09:54,680 --> 00:09:58,670
in memory<font color="#E5E5E5"> and then executing it and you</font>

246
00:09:56,899 --> 00:10:01,130
can see that it says<font color="#E5E5E5"> PowerShell that Exe</font>

247
00:09:58,670 --> 00:10:01,790
underscore 10.0 and then dot zero zero

248
00:10:01,130 --> 00:10:06,040
zero

249
00:10:01,790 --> 00:10:09,529
that's the virtual file that it<font color="#CCCCCC"> flags</font>

250
00:10:06,040 --> 00:10:11,209
<font color="#E5E5E5">but it's not a hundred</font><font color="#CCCCCC"> percent so with</font>

251
00:10:09,529 --> 00:10:13,790
as with<font color="#E5E5E5"> all new technology there's some</font>

252
00:10:11,209 --> 00:10:16,849
issues sometimes PowerShell code does

253
00:10:13,790 --> 00:10:19,610
get through<font color="#E5E5E5"> DLL hijacking so the guy who</font>

254
00:10:16,850 --> 00:10:21,560
wrote pony show which is a<font color="#E5E5E5"> PowerShell</font>

255
00:10:19,610 --> 00:10:23,630
<font color="#E5E5E5">offensive toolkit and a single</font>

256
00:10:21,560 --> 00:10:25,459
<font color="#E5E5E5">executable</font><font color="#CCCCCC"> he realized that if you</font><font color="#E5E5E5"> drop</font>

257
00:10:23,630 --> 00:10:28,670
<font color="#CCCCCC">that</font><font color="#E5E5E5"> executable on the Box</font><font color="#CCCCCC"> pone shell on</font>

258
00:10:25,459 --> 00:10:31,430
a box<font color="#E5E5E5"> into a location</font><font color="#CCCCCC"> and then added his</font>

259
00:10:28,670 --> 00:10:35,209
<font color="#CCCCCC">own version</font><font color="#E5E5E5"> of a MSI DLL effectively</font>

260
00:10:31,430 --> 00:10:38,209
hijacking<font color="#CCCCCC"> that DLL then it would go when</font>

261
00:10:35,209 --> 00:10:39,739
a<font color="#CCCCCC"> MSI would would get called it would go</font>

262
00:10:38,209 --> 00:10:42,290
<font color="#E5E5E5">to that version</font><font color="#CCCCCC"> and his version</font><font color="#E5E5E5"> would</font>

263
00:10:39,740 --> 00:10:44,660
say everything's good<font color="#E5E5E5"> so it wouldn't</font>

264
00:10:42,290 --> 00:10:47,509
<font color="#E5E5E5">cause any problems but</font><font color="#CCCCCC"> Mac</font><font color="#E5E5E5"> grader</font><font color="#CCCCCC"> Raber</font>

265
00:10:44,660 --> 00:10:49,370
actually figured<font color="#E5E5E5"> out that he could tell</font>

266
00:10:47,509 --> 00:10:51,139
a<font color="#E5E5E5"> Masai from within PowerShell that</font>

267
00:10:49,370 --> 00:10:53,779
everything's<font color="#E5E5E5"> fine using reflection and</font>

268
00:10:51,139 --> 00:10:56,509
it would<font color="#CCCCCC"> just work with everything</font><font color="#E5E5E5"> and</font>

269
00:10:53,779 --> 00:10:58,430
<font color="#E5E5E5">so this fits in a tweet which just</font>

270
00:10:56,509 --> 00:11:01,490
amazes me because<font color="#CCCCCC"> he</font><font color="#E5E5E5"> was able</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> get</font>

271
00:10:58,430 --> 00:11:04,579
this code that<font color="#CCCCCC"> bypasses</font><font color="#E5E5E5"> a</font><font color="#CCCCCC"> msi into 140</font>

272
00:11:01,490 --> 00:11:07,100
<font color="#E5E5E5">characters so I mentioned</font><font color="#CCCCCC"> that</font><font color="#E5E5E5"> sometimes</font>

273
00:11:04,579 --> 00:11:09,529
PowerShell code just works and gets

274
00:11:07,100 --> 00:11:11,000
through<font color="#CCCCCC"> this is me testing invoke</font>

275
00:11:09,529 --> 00:11:11,420
mimikatz<font color="#CCCCCC"> downloading it from</font><font color="#E5E5E5"> the</font>

276
00:11:11,000 --> 00:11:13,640
internet

277
00:11:11,420 --> 00:11:15,260
executing it<font color="#E5E5E5"> and you see Windows</font>

278
00:11:13,640 --> 00:11:17,900
<font color="#E5E5E5">Defender actually popped up and flagged</font>

279
00:11:15,260 --> 00:11:20,630
on it but it still ran because<font color="#E5E5E5"> I still</font>

280
00:11:17,900 --> 00:11:23,300
got<font color="#E5E5E5"> credentials from that system so it's</font>

281
00:11:20,630 --> 00:11:24,500
still<font color="#E5E5E5"> being worked on and the other</font>

282
00:11:23,300 --> 00:11:26,449
problem is that<font color="#E5E5E5"> there's only three</font>

283
00:11:24,500 --> 00:11:29,060
vendors<font color="#E5E5E5"> today that support it which is</font>

284
00:11:26,450 --> 00:11:32,720
kind of a mega fail<font color="#E5E5E5"> because Windows 10</font>

285
00:11:29,060 --> 00:11:36,319
<font color="#E5E5E5">has</font><font color="#CCCCCC"> been out for a year so we're looking</font>

286
00:11:32,720 --> 00:11:38,390
at<font color="#CCCCCC"> Defender AVG and an ESET vert beta</font>

287
00:11:36,320 --> 00:11:40,940
version<font color="#E5E5E5"> and then all the others they</font>

288
00:11:38,390 --> 00:11:43,010
have<font color="#CCCCCC"> no statement on</font><font color="#E5E5E5"> a MSI</font><font color="#CCCCCC"> so please</font><font color="#E5E5E5"> ask</font>

289
00:11:40,940 --> 00:11:48,050
<font color="#E5E5E5">your vendor</font><font color="#CCCCCC"> to support a</font><font color="#E5E5E5"> MSI in Windows</font>

290
00:11:43,010 --> 00:11:49,670
10 so it's story<font color="#CCCCCC"> time</font><font color="#E5E5E5"> with</font><font color="#CCCCCC"> Sean there's</font>

291
00:11:48,050 --> 00:11:52,490
<font color="#E5E5E5">a kids story called a fish out of water</font>

292
00:11:49,670 --> 00:11:53,959
<font color="#CCCCCC">I remember this when I was a kid I</font><font color="#E5E5E5"> loved</font>

293
00:11:52,490 --> 00:11:56,180
this story<font color="#CCCCCC"> and basically</font><font color="#E5E5E5"> it's about a</font>

294
00:11:53,960 --> 00:11:58,730
little kid that<font color="#E5E5E5"> gets a goldfish and he</font>

295
00:11:56,180 --> 00:12:01,099
takes<font color="#E5E5E5"> it home and he didn't listen to</font>

296
00:11:58,730 --> 00:12:03,530
mr.<font color="#E5E5E5"> Karp who said you know</font><font color="#CCCCCC"> what</font><font color="#E5E5E5"> give the</font>

297
00:12:01,100 --> 00:12:07,190
fish this much and no more<font color="#E5E5E5"> or something</font>

298
00:12:03,530 --> 00:12:08,390
<font color="#E5E5E5">may happen</font><font color="#CCCCCC"> you never</font><font color="#E5E5E5"> know what okay Sean</font>

299
00:12:07,190 --> 00:12:12,530
what does this<font color="#E5E5E5"> have to do with</font><font color="#CCCCCC"> power</font>

300
00:12:08,390 --> 00:12:14,420
<font color="#CCCCCC">shop</font><font color="#E5E5E5"> so Microsoft with PowerShell</font>

301
00:12:12,530 --> 00:12:16,339
version<font color="#E5E5E5"> 5 has a new feature component</font>

302
00:12:14,420 --> 00:12:20,000
<font color="#CCCCCC">security enhancement called just enough</font>

303
00:12:16,340 --> 00:12:23,930
administration so the principle of least

304
00:12:20,000 --> 00:12:26,540
privilege says just as much of<font color="#CCCCCC"> Rights</font><font color="#E5E5E5"> of</font>

305
00:12:23,930 --> 00:12:28,939
permissions of access and nothing more

306
00:12:26,540 --> 00:12:31,430
or something<font color="#CCCCCC"> may happen</font><font color="#E5E5E5"> you never know</font>

307
00:12:28,940 --> 00:12:32,690
what I think we know what happens when

308
00:12:31,430 --> 00:12:34,579
<font color="#CCCCCC">someone has more</font><font color="#E5E5E5"> access and</font><font color="#CCCCCC"> they're</font>

309
00:12:32,690 --> 00:12:36,320
<font color="#E5E5E5">supposed to but she is</font><font color="#CCCCCC"> available with</font>

310
00:12:34,580 --> 00:12:41,420
<font color="#E5E5E5">PowerShell</font><font color="#CCCCCC"> version 5</font><font color="#E5E5E5"> Windows 10 Windows</font>

311
00:12:36,320 --> 00:12:43,480
2016 and effectively<font color="#E5E5E5"> with</font><font color="#CCCCCC"> jiya we get a</font>

312
00:12:41,420 --> 00:12:46,550
constrained<font color="#CCCCCC"> PowerShell remoting session</font>

313
00:12:43,480 --> 00:12:47,690
with<font color="#E5E5E5"> whitelisted commandlets so we</font>

314
00:12:46,550 --> 00:12:49,000
specifically say these are the

315
00:12:47,690 --> 00:12:51,170
<font color="#E5E5E5">commandments that</font><font color="#CCCCCC"> are allowed and</font>

316
00:12:49,000 --> 00:12:54,340
specific parameters that are allowed

317
00:12:51,170 --> 00:12:56,530
with names of those parameters<font color="#CCCCCC"> and</font>

318
00:12:54,340 --> 00:13:00,140
actual parameter values that are allowed

319
00:12:56,530 --> 00:13:02,270
<font color="#E5E5E5">and this is baked</font><font color="#CCCCCC"> into Windows 10 in</font>

320
00:13:00,140 --> 00:13:04,580
2016<font color="#E5E5E5"> otherwise you can install</font>

321
00:13:02,270 --> 00:13:06,110
<font color="#E5E5E5">PowerShell version 5 and configure</font><font color="#CCCCCC"> gyah</font>

322
00:13:04,580 --> 00:13:10,160
on other<font color="#E5E5E5"> system supported systems like</font>

323
00:13:06,110 --> 00:13:11,480
<font color="#CCCCCC">Windows 7</font><font color="#E5E5E5"> 20 2008 r2 but what's really</font>

324
00:13:10,160 --> 00:13:13,850
interesting<font color="#CCCCCC"> is you can</font><font color="#E5E5E5"> Det when you</font>

325
00:13:11,480 --> 00:13:15,740
delegate server<font color="#E5E5E5"> rights it can leverage a</font>

326
00:13:13,850 --> 00:13:18,080
virtual account on that<font color="#E5E5E5"> system assuming</font>

327
00:13:15,740 --> 00:13:19,640
<font color="#E5E5E5">that you're using</font><font color="#CCCCCC"> gyah on a supported</font>

328
00:13:18,080 --> 00:13:21,110
platform for<font color="#E5E5E5"> that which actually</font>

329
00:13:19,640 --> 00:13:23,300
<font color="#E5E5E5">abstract</font><font color="#CCCCCC"> Sacre den</font><font color="#E5E5E5"> shalls' that are</font>

330
00:13:21,110 --> 00:13:25,160
being<font color="#E5E5E5"> used</font><font color="#CCCCCC"> for it even more and we can</font>

331
00:13:23,300 --> 00:13:26,479
<font color="#E5E5E5">gain insight</font><font color="#CCCCCC"> into what</font><font color="#E5E5E5"> those activity</font>

332
00:13:25,160 --> 00:13:28,699
<font color="#E5E5E5">are through</font><font color="#CCCCCC"> PowerShell logging and</font>

333
00:13:26,480 --> 00:13:30,920
transcription which we<font color="#E5E5E5"> don't really get</font>

334
00:13:28,699 --> 00:13:33,439
when<font color="#E5E5E5"> someone's using</font><font color="#CCCCCC"> RDP or using the</font>

335
00:13:30,920 --> 00:13:35,750
NFC<font color="#CCCCCC"> or using another</font><font color="#E5E5E5"> tool but we can get</font>

336
00:13:33,440 --> 00:13:38,029
that<font color="#E5E5E5"> if we can identify what those tasks</font>

337
00:13:35,750 --> 00:13:40,459
<font color="#CCCCCC">are and</font><font color="#E5E5E5"> actually PowerShell those tasks</font>

338
00:13:38,029 --> 00:13:43,160
<font color="#E5E5E5">which is ideal for server admin</font>

339
00:13:40,459 --> 00:13:45,050
delegation<font color="#E5E5E5"> if your server admins really</font>

340
00:13:43,160 --> 00:13:47,420
just need to<font color="#E5E5E5"> connect into</font><font color="#CCCCCC"> a box and</font>

341
00:13:45,050 --> 00:13:49,099
restart a service or maybe clear the

342
00:13:47,420 --> 00:13:50,899
event<font color="#E5E5E5"> log or save the event</font><font color="#CCCCCC"> log or do a</font>

343
00:13:49,100 --> 00:13:54,350
few<font color="#E5E5E5"> other things</font><font color="#CCCCCC"> why do they need</font><font color="#E5E5E5"> to be</font>

344
00:13:50,899 --> 00:13:56,839
able to RDP in as an admin so

345
00:13:54,350 --> 00:13:59,149
configuring<font color="#CCCCCC"> G is something that sounds</font>

346
00:13:56,839 --> 00:14:00,560
<font color="#CCCCCC">like it</font><font color="#E5E5E5"> could work right but there's a</font>

347
00:13:59,149 --> 00:14:01,670
number<font color="#CCCCCC"> of things</font><font color="#E5E5E5"> that we have to do and</font>

348
00:14:00,560 --> 00:14:03,349
we<font color="#E5E5E5"> need to make</font><font color="#CCCCCC"> sure we have</font>

349
00:14:01,670 --> 00:14:05,300
prerequisites<font color="#E5E5E5"> which domain join</font>

350
00:14:03,350 --> 00:14:07,850
<font color="#E5E5E5">PowerShell remoting is enabled G is</font>

351
00:14:05,300 --> 00:14:11,149
supported etc but<font color="#E5E5E5"> the second one is</font>

352
00:14:07,850 --> 00:14:13,879
really<font color="#E5E5E5"> the most important how many</font>

353
00:14:11,149 --> 00:14:16,670
people actually know<font color="#E5E5E5"> what the admins are</font>

354
00:14:13,879 --> 00:14:18,470
doing what their rights are what their

355
00:14:16,670 --> 00:14:22,519
rights<font color="#E5E5E5"> that they actually are required</font>

356
00:14:18,470 --> 00:14:25,639
to do so if I'm an admin<font color="#E5E5E5"> I might get the</font>

357
00:14:22,519 --> 00:14:26,449
main admin<font color="#E5E5E5"> why it's easier I say I need</font>

358
00:14:25,639 --> 00:14:28,250
<font color="#CCCCCC">to do these things</font>

359
00:14:26,449 --> 00:14:30,740
<font color="#CCCCCC">ok domain admin go ahead and do that I</font>

360
00:14:28,250 --> 00:14:32,300
don't need<font color="#CCCCCC"> to main admin I could just do</font>

361
00:14:30,740 --> 00:14:34,579
<font color="#E5E5E5">this no no that's fine just just use</font>

362
00:14:32,300 --> 00:14:36,319
that<font color="#E5E5E5"> that's easier we need to start</font>

363
00:14:34,579 --> 00:14:37,790
<font color="#CCCCCC">identifying what admins really need to</font>

364
00:14:36,319 --> 00:14:40,130
do<font color="#CCCCCC"> because then we can start</font><font color="#E5E5E5"> leveraging</font>

365
00:14:37,790 --> 00:14:43,399
technology like this<font color="#E5E5E5"> and make</font><font color="#CCCCCC"> sure that</font>

366
00:14:40,130 --> 00:14:45,139
admins have this much and no<font color="#CCCCCC"> more so we</font>

367
00:14:43,399 --> 00:14:46,819
identify the tasks we restrict as

368
00:14:45,139 --> 00:14:48,019
appropriate<font color="#E5E5E5"> we confirm they work with</font>

369
00:14:46,819 --> 00:14:49,729
you because<font color="#CCCCCC"> they have to be powershell</font>

370
00:14:48,019 --> 00:14:52,310
commandlets and it actually<font color="#E5E5E5"> needs a</font>

371
00:14:49,730 --> 00:14:54,410
<font color="#CCCCCC">plugin correctly</font><font color="#E5E5E5"> we can configure these</font>

372
00:14:52,310 --> 00:14:56,899
<font color="#CCCCCC">identified tasks and a</font><font color="#E5E5E5"> role capability</font>

373
00:14:54,410 --> 00:14:58,550
file<font color="#CCCCCC"> P SRC and then we're going to</font>

374
00:14:56,899 --> 00:15:01,310
register<font color="#CCCCCC"> a session configuration which</font>

375
00:14:58,550 --> 00:15:03,529
<font color="#E5E5E5">exposes those role that role capability</font>

376
00:15:01,310 --> 00:15:05,750
and we need to make<font color="#CCCCCC"> sure</font><font color="#E5E5E5"> that we follow</font>

377
00:15:03,529 --> 00:15:06,920
a principle lease privilege<font color="#E5E5E5"> but of</font>

378
00:15:05,750 --> 00:15:08,720
course the important thing<font color="#CCCCCC"> here is that</font>

379
00:15:06,920 --> 00:15:10,459
we test that<font color="#CCCCCC"> so if we just</font><font color="#E5E5E5"> go ahead</font><font color="#CCCCCC"> and</font>

380
00:15:08,720 --> 00:15:11,959
configure<font color="#CCCCCC"> gyah for a bunch of admins and</font>

381
00:15:10,459 --> 00:15:14,508
<font color="#E5E5E5">we say go ahead</font><font color="#CCCCCC"> and do this PowerShell</font>

382
00:15:11,959 --> 00:15:16,609
remote in we actually<font color="#CCCCCC"> may be opening up</font>

383
00:15:14,509 --> 00:15:18,230
<font color="#CCCCCC">another Avenue</font><font color="#E5E5E5"> of attack for something</font>

384
00:15:16,610 --> 00:15:20,029
else<font color="#E5E5E5"> so we definitely need</font><font color="#CCCCCC"> to look at</font>

385
00:15:18,230 --> 00:15:21,410
this but this is a great capability<font color="#CCCCCC"> and</font>

386
00:15:20,029 --> 00:15:23,300
it's great feature and it's<font color="#E5E5E5"> something we</font>

387
00:15:21,410 --> 00:15:24,949
<font color="#CCCCCC">need to</font><font color="#E5E5E5"> look at and start getting away</font>

388
00:15:23,300 --> 00:15:26,930
<font color="#CCCCCC">from having admins already</font><font color="#E5E5E5"> pee</font><font color="#CCCCCC"> in his</font>

389
00:15:24,949 --> 00:15:28,699
systems all the<font color="#E5E5E5"> time when maybe we can</font>

390
00:15:26,930 --> 00:15:31,008
give them a<font color="#E5E5E5"> customized</font><font color="#CCCCCC"> PowerShell script</font>

391
00:15:28,699 --> 00:15:33,170
that they can run and more<font color="#E5E5E5"> easily manage</font>

392
00:15:31,009 --> 00:15:37,069
all<font color="#CCCCCC"> of the systems they have</font><font color="#E5E5E5"> to giving</font>

393
00:15:33,170 --> 00:15:38,319
them back more time so PowerShell

394
00:15:37,069 --> 00:15:47,559
obviously is<font color="#CCCCCC"> very</font>

395
00:15:38,319 --> 00:15:49,449
<font color="#E5E5E5">helpful as an attack platform meant for</font>

396
00:15:47,559 --> 00:15:51,279
administrators<font color="#CCCCCC"> but</font><font color="#E5E5E5"> like all good admin</font>

397
00:15:49,449 --> 00:15:54,819
tools can be<font color="#E5E5E5"> used</font><font color="#CCCCCC"> for</font><font color="#E5E5E5"> more nefarious</font>

398
00:15:51,279 --> 00:15:57,309
purposes<font color="#E5E5E5"> but attackers have options so</font>

399
00:15:54,819 --> 00:15:59,259
it's not<font color="#CCCCCC"> just about PowerShell attackers</font>

400
00:15:57,309 --> 00:16:01,629
have always had options<font color="#E5E5E5"> custom</font>

401
00:15:59,259 --> 00:16:04,449
executables Windows command tools<font color="#CCCCCC"> RDP</font>

402
00:16:01,629 --> 00:16:10,179
<font color="#E5E5E5">window scripting this is just another</font>

403
00:16:04,449 --> 00:16:12,039
tool<font color="#CCCCCC"> in their</font><font color="#E5E5E5"> toolkit Python even well</font>

404
00:16:10,179 --> 00:16:14,108
how did<font color="#E5E5E5"> we get to the point where we are</font>

405
00:16:12,039 --> 00:16:16,299
<font color="#E5E5E5">now</font><font color="#CCCCCC"> in the summer</font><font color="#E5E5E5"> of 2010 about</font><font color="#CCCCCC"> six</font>

406
00:16:14,109 --> 00:16:20,199
years ago<font color="#CCCCCC"> Dave Kennedy</font><font color="#E5E5E5"> and Josh Kelly</font>

407
00:16:16,299 --> 00:16:22,569
presented at<font color="#E5E5E5"> DEFCON oMFG PowerShell</font><font color="#CCCCCC"> like</font>

408
00:16:20,199 --> 00:16:24,849
what this is crazy<font color="#E5E5E5"> all this stuff I can</font>

409
00:16:22,569 --> 00:16:27,339
do and they described in that talk which

410
00:16:24,850 --> 00:16:28,720
I highly<font color="#CCCCCC"> recommend you check</font><font color="#E5E5E5"> out most if</font>

411
00:16:27,339 --> 00:16:31,269
not all<font color="#E5E5E5"> of the PowerShell attack</font>

412
00:16:28,720 --> 00:16:33,579
techniques we see today<font color="#E5E5E5"> bypass execution</font>

413
00:16:31,269 --> 00:16:36,339
policy<font color="#CCCCCC"> encoded</font><font color="#E5E5E5"> commands invoke</font>

414
00:16:33,579 --> 00:16:38,589
expression and they released a tool that

415
00:16:36,339 --> 00:16:41,350
<font color="#E5E5E5">dumped the Sam database on the windows</font>

416
00:16:38,589 --> 00:16:43,779
box with a PowerShell based tool

417
00:16:41,350 --> 00:16:46,119
entirely built<font color="#E5E5E5"> in PowerShell by the way</font>

418
00:16:43,779 --> 00:16:49,589
all these slides will be available now

419
00:16:46,119 --> 00:16:52,179
on on<font color="#CCCCCC"> 80 security so just so you know</font>

420
00:16:49,589 --> 00:16:55,419
<font color="#E5E5E5">and in 2012 just a</font><font color="#CCCCCC"> couple years later</font>

421
00:16:52,179 --> 00:16:58,238
<font color="#E5E5E5">Mac</font><font color="#CCCCCC"> raver released power sploit</font><font color="#E5E5E5"> a github</font>

422
00:16:55,419 --> 00:16:59,649
repo<font color="#E5E5E5"> with a number of PowerShell attack</font>

423
00:16:58,239 --> 00:17:01,689
tools which started with invoke<font color="#E5E5E5"> shell</font>

424
00:16:59,649 --> 00:17:04,449
<font color="#E5E5E5">code he realized that you could take</font>

425
00:17:01,689 --> 00:17:07,750
<font color="#E5E5E5">PowerShell code and inject them into the</font>

426
00:17:04,449 --> 00:17:09,669
process<font color="#CCCCCC"> of your choosing and originally</font>

427
00:17:07,750 --> 00:17:12,638
this<font color="#CCCCCC"> was from retur but it could be used</font>

428
00:17:09,669 --> 00:17:14,649
<font color="#E5E5E5">for</font><font color="#CCCCCC"> just</font><font color="#E5E5E5"> about any shell code and then a</font>

429
00:17:12,638 --> 00:17:16,240
year<font color="#E5E5E5"> later</font><font color="#CCCCCC"> the shot</font><font color="#E5E5E5"> heard around the</font>

430
00:17:14,648 --> 00:17:18,309
<font color="#E5E5E5">world was when invoke mimikatz was</font>

431
00:17:16,240 --> 00:17:20,138
released by<font color="#CCCCCC"> Joe Balak and now</font><font color="#E5E5E5"> Minnie</font>

432
00:17:18,309 --> 00:17:21,939
<font color="#E5E5E5">Katz was no longer just</font><font color="#CCCCCC"> an executable</font>

433
00:17:20,138 --> 00:17:23,500
you<font color="#CCCCCC"> have to control</font><font color="#E5E5E5"> now it's a</font>

434
00:17:21,939 --> 00:17:24,909
<font color="#E5E5E5">PowerShell script you need to stop from</font>

435
00:17:23,500 --> 00:17:26,859
<font color="#E5E5E5">downloading from the internet from</font>

436
00:17:24,909 --> 00:17:30,519
people carrying around<font color="#E5E5E5"> from Casey Smith</font>

437
00:17:26,859 --> 00:17:32,649
putting into<font color="#E5E5E5"> a an image file and this</font>

438
00:17:30,519 --> 00:17:34,510
leverages invoke reflection PE injection

439
00:17:32,649 --> 00:17:37,959
which just blows<font color="#E5E5E5"> my mind</font><font color="#CCCCCC"> you can take a</font>

440
00:17:34,510 --> 00:17:40,720
dll file encode it<font color="#E5E5E5"> into a PowerShell</font>

441
00:17:37,960 --> 00:17:43,539
script which<font color="#CCCCCC"> is a text</font><font color="#E5E5E5"> file and run that</font>

442
00:17:40,720 --> 00:17:46,000
and push that into memory<font color="#E5E5E5"> push that code</font>

443
00:17:43,539 --> 00:17:47,740
into<font color="#E5E5E5"> memory that DLL and then call it in</font>

444
00:17:46,000 --> 00:17:51,950
memory<font color="#CCCCCC"> without anything ever touching</font>

445
00:17:47,740 --> 00:17:53,750
disk so<font color="#CCCCCC"> PowerShell there</font>

446
00:17:51,950 --> 00:17:55,790
<font color="#E5E5E5">beneficial for the admin lots of</font>

447
00:17:53,750 --> 00:17:58,090
capability can run lots<font color="#E5E5E5"> of different</font>

448
00:17:55,790 --> 00:17:59,960
types<font color="#E5E5E5"> of things can call</font><font color="#CCCCCC"> windows api's</font>

449
00:17:58,090 --> 00:18:01,520
but there's a lot<font color="#E5E5E5"> of things that</font>

450
00:17:59,960 --> 00:18:03,410
attackers love about it the things that

451
00:18:01,520 --> 00:18:05,030
admins love about it attackers love<font color="#CCCCCC"> also</font>

452
00:18:03,410 --> 00:18:07,730
<font color="#E5E5E5">and the interesting</font><font color="#CCCCCC"> thing</font><font color="#E5E5E5"> is that</font>

453
00:18:05,030 --> 00:18:09,590
historically<font color="#E5E5E5"> most organizations haven't</font>

454
00:18:07,730 --> 00:18:12,860
had good visibility in<font color="#E5E5E5"> a</font><font color="#CCCCCC"> powershell it's</font>

455
00:18:09,590 --> 00:18:17,480
gotten much<font color="#E5E5E5"> better but this</font><font color="#CCCCCC"> is</font><font color="#E5E5E5"> another</font>

456
00:18:12,860 --> 00:18:18,919
reason why attackers like<font color="#E5E5E5"> to use it so</font>

457
00:18:17,480 --> 00:18:28,430
let's<font color="#E5E5E5"> talk about</font><font color="#CCCCCC"> real-world PowerShell</font>

458
00:18:18,920 --> 00:18:29,510
attacks yeah that'd be<font color="#E5E5E5"> great so like I</font>

459
00:18:28,430 --> 00:18:30,860
said<font color="#CCCCCC"> I</font><font color="#E5E5E5"> found a lot</font><font color="#CCCCCC"> of things off the</font>

460
00:18:29,510 --> 00:18:32,210
<font color="#E5E5E5">internet I also reached out to some</font>

461
00:18:30,860 --> 00:18:33,889
<font color="#CCCCCC">people in the industry</font><font color="#E5E5E5"> and said hey send</font>

462
00:18:32,210 --> 00:18:35,000
me<font color="#E5E5E5"> your PowerShell attack code I'll use</font>

463
00:18:33,890 --> 00:18:37,280
it<font color="#E5E5E5"> for good I promise</font>

464
00:18:35,000 --> 00:18:39,850
<font color="#CCCCCC">so I'm putting it up here</font><font color="#E5E5E5"> we're using</font><font color="#CCCCCC"> it</font>

465
00:18:37,280 --> 00:18:42,889
for<font color="#CCCCCC"> good as education</font><font color="#E5E5E5"> so as we know</font>

466
00:18:39,850 --> 00:18:45,919
macros are code that run<font color="#CCCCCC"> in documents</font>

467
00:18:42,890 --> 00:18:47,900
VBA<font color="#E5E5E5"> Visual Basic for applications when</font>

468
00:18:45,920 --> 00:18:50,540
you click on enable macro<font color="#E5E5E5"> we know that's</font>

469
00:18:47,900 --> 00:18:52,430
running code unfortunately it's called

470
00:18:50,540 --> 00:18:53,870
enable macros and<font color="#E5E5E5"> people see that as I</font>

471
00:18:52,430 --> 00:18:55,610
need<font color="#E5E5E5"> to see the stuff that's in this</font>

472
00:18:53,870 --> 00:18:57,620
file<font color="#E5E5E5"> right but this is</font><font color="#CCCCCC"> what actually</font>

473
00:18:55,610 --> 00:18:59,290
runs behind the scenes<font color="#E5E5E5"> and this is</font>

474
00:18:57,620 --> 00:19:03,199
interesting<font color="#E5E5E5"> because this word macro</font>

475
00:18:59,290 --> 00:19:06,230
calls<font color="#CCCCCC"> PowerShell it has</font><font color="#E5E5E5"> a FG process</font>

476
00:19:03,200 --> 00:19:09,170
create power in quotes<font color="#E5E5E5"> and shell</font><font color="#CCCCCC"> in</font>

477
00:19:06,230 --> 00:19:11,420
quotes<font color="#E5E5E5"> and dot exe in quotes execution</font>

478
00:19:09,170 --> 00:19:12,650
policy bypass etc and then it's

479
00:19:11,420 --> 00:19:15,560
downloading some stuff from<font color="#E5E5E5"> the</font><font color="#CCCCCC"> internet</font>

480
00:19:12,650 --> 00:19:17,150
<font color="#CCCCCC">and then executing it pretty standard</font>

481
00:19:15,560 --> 00:19:20,210
but interesting way to<font color="#E5E5E5"> do it from a word</font>

482
00:19:17,150 --> 00:19:22,280
macro<font color="#E5E5E5"> and then we also see that another</font>

483
00:19:20,210 --> 00:19:24,350
one can download code and upload recon

484
00:19:22,280 --> 00:19:27,230
data so there's a<font color="#E5E5E5"> number of different</font>

485
00:19:24,350 --> 00:19:29,209
variables<font color="#E5E5E5"> here that are key</font><font color="#CCCCCC"> to what that</font>

486
00:19:27,230 --> 00:19:31,370
system<font color="#E5E5E5"> is and</font><font color="#CCCCCC"> how its configured</font><font color="#E5E5E5"> which</font>

487
00:19:29,210 --> 00:19:33,710
then get<font color="#CCCCCC"> uploaded right back</font><font color="#E5E5E5"> again so</font>

488
00:19:31,370 --> 00:19:35,659
pull the<font color="#E5E5E5"> code down execute it pull some</font>

489
00:19:33,710 --> 00:19:37,310
recon off the system<font color="#E5E5E5"> and then upload it</font>

490
00:19:35,660 --> 00:19:40,280
<font color="#E5E5E5">up upload</font><font color="#CCCCCC"> it</font><font color="#E5E5E5"> to the</font><font color="#CCCCCC"> system of</font><font color="#E5E5E5"> their</font>

491
00:19:37,310 --> 00:19:41,720
choice<font color="#E5E5E5"> download code execute so the</font>

492
00:19:40,280 --> 00:19:42,530
first one here<font color="#E5E5E5"> and I'm sorry the people</font>

493
00:19:41,720 --> 00:19:43,130
on the back is a<font color="#CCCCCC"> little more</font><font color="#E5E5E5"> difficult</font>

494
00:19:42,530 --> 00:19:46,220
<font color="#CCCCCC">to see</font>

495
00:19:43,130 --> 00:19:49,850
we haven't expanded<font color="#E5E5E5"> here invoke shell</font>

496
00:19:46,220 --> 00:19:51,800
code is being executed<font color="#CCCCCC"> on this</font><font color="#E5E5E5"> system</font><font color="#CCCCCC"> to</font>

497
00:19:49,850 --> 00:19:53,300
<font color="#E5E5E5">obviously inject some shell code and</font>

498
00:19:51,800 --> 00:19:55,820
then some additional<font color="#E5E5E5"> things are done</font>

499
00:19:53,300 --> 00:19:59,510
<font color="#CCCCCC">here to get some additional Paik</font>

500
00:19:55,820 --> 00:20:01,129
payloads<font color="#CCCCCC"> so a lot</font><font color="#E5E5E5"> of times malware</font>

501
00:19:59,510 --> 00:20:02,900
authors use stagers right<font color="#E5E5E5"> you use one</font>

502
00:20:01,130 --> 00:20:04,220
part to use then<font color="#CCCCCC"> but go to another part</font>

503
00:20:02,900 --> 00:20:05,529
<font color="#CCCCCC">to do another part</font><font color="#E5E5E5"> makes it a little</font>

504
00:20:04,220 --> 00:20:07,970
<font color="#E5E5E5">more</font><font color="#CCCCCC"> difficult to track</font>

505
00:20:05,529 --> 00:20:10,610
this one I really<font color="#E5E5E5"> love so the first one</font>

506
00:20:07,970 --> 00:20:12,529
pulls an executable off of a<font color="#CCCCCC"> website</font><font color="#E5E5E5"> and</font>

507
00:20:10,610 --> 00:20:16,399
then drops it locally and executes<font color="#E5E5E5"> sit</font>

508
00:20:12,529 --> 00:20:18,259
<font color="#E5E5E5">in</font><font color="#CCCCCC"> C</font><font color="#E5E5E5"> users app data roaming which is why</font>

509
00:20:16,399 --> 00:20:19,668
it's a good<font color="#CCCCCC"> idea</font><font color="#E5E5E5"> to actually block users</font>

510
00:20:18,259 --> 00:20:22,519
from running executable content from

511
00:20:19,669 --> 00:20:24,259
<font color="#E5E5E5">these locations but the second one is</font>

512
00:20:22,519 --> 00:20:27,289
<font color="#CCCCCC">really interesting because it's pulling</font>

513
00:20:24,259 --> 00:20:29,929
<font color="#CCCCCC">down a JPEG and then renaming it as an</font>

514
00:20:27,289 --> 00:20:34,759
executable<font color="#E5E5E5"> so on the internet</font><font color="#CCCCCC"> it's jpg</font>

515
00:20:29,929 --> 00:20:36,559
but locally it's not<font color="#CCCCCC"> exe this one I</font><font color="#E5E5E5"> love</font>

516
00:20:34,759 --> 00:20:38,389
<font color="#CCCCCC">so what we're</font><font color="#E5E5E5"> going to do is we're going</font>

517
00:20:36,559 --> 00:20:40,309
<font color="#CCCCCC">to create a new task on</font><font color="#E5E5E5"> this system</font>

518
00:20:38,389 --> 00:20:41,928
we're gonna<font color="#E5E5E5"> call it update</font><font color="#CCCCCC"> Google but</font>

519
00:20:40,309 --> 00:20:44,840
really it's gonna just run some

520
00:20:41,929 --> 00:20:46,970
<font color="#CCCCCC">PowerShell and so it's running invoke</font>

521
00:20:44,840 --> 00:20:49,189
<font color="#CCCCCC">shellcode and that means that we're</font>

522
00:20:46,970 --> 00:20:51,049
<font color="#E5E5E5">going to get some stuff that the system</font>

523
00:20:49,190 --> 00:20:54,980
administrator is not expecting to be<font color="#CCCCCC"> on</font>

524
00:20:51,049 --> 00:20:57,940
that system<font color="#E5E5E5"> and then as we</font><font color="#CCCCCC"> look and dig</font>

525
00:20:54,980 --> 00:21:00,230
into it we<font color="#CCCCCC"> see DLL import kernel32.dll</font>

526
00:20:57,940 --> 00:21:01,309
<font color="#CCCCCC">which is something attackers love using</font>

527
00:21:00,230 --> 00:21:02,960
<font color="#E5E5E5">because it gives a lot</font><font color="#CCCCCC"> more</font>

528
00:21:01,309 --> 00:21:04,850
functionality<font color="#CCCCCC"> to their powershell script</font>

529
00:21:02,960 --> 00:21:07,970
<font color="#E5E5E5">and then they can do additional things</font>

530
00:21:04,850 --> 00:21:11,480
<font color="#CCCCCC">like jam in more shell code or do pretty</font>

531
00:21:07,970 --> 00:21:13,129
much whatever<font color="#E5E5E5"> they can want this is</font>

532
00:21:11,480 --> 00:21:15,200
<font color="#CCCCCC">fascinating because this</font><font color="#E5E5E5"> powershell</font>

533
00:21:13,129 --> 00:21:17,748
script<font color="#E5E5E5"> actually monitors what windows</font>

534
00:21:15,200 --> 00:21:19,759
are open and then looks for<font color="#E5E5E5"> specific</font>

535
00:21:17,749 --> 00:21:22,009
financial<font color="#E5E5E5"> and sensitive information in</font>

536
00:21:19,759 --> 00:21:26,989
those in these<font color="#E5E5E5"> windows like LastPass</font>

537
00:21:22,009 --> 00:21:28,789
<font color="#E5E5E5">PayPal Discover Expedia interesting</font>

538
00:21:26,989 --> 00:21:30,379
things<font color="#CCCCCC"> and when it sees it</font><font color="#E5E5E5"> then it</font>

539
00:21:28,789 --> 00:21:32,210
starts extracting information from<font color="#E5E5E5"> those</font>

540
00:21:30,379 --> 00:21:35,238
sites<font color="#CCCCCC"> and has a key logger component</font>

541
00:21:32,210 --> 00:21:36,859
that's logging what<font color="#E5E5E5"> this typed in we can</font>

542
00:21:35,239 --> 00:21:39,109
also take screenshots with PowerShell on

543
00:21:36,859 --> 00:21:40,519
a regular basis to screenshot<font color="#E5E5E5"> what's</font>

544
00:21:39,109 --> 00:21:42,350
going on and<font color="#E5E5E5"> get more information about</font>

545
00:21:40,519 --> 00:21:46,309
<font color="#E5E5E5">what the users are doing or the admin is</font>

546
00:21:42,350 --> 00:21:48,649
doing and last year at blackhat Mac

547
00:21:46,309 --> 00:21:50,899
<font color="#E5E5E5">Raber talked about</font><font color="#CCCCCC"> WMI as a backdoor</font>

548
00:21:48,649 --> 00:21:53,600
<font color="#E5E5E5">that's a great persistence method and</font>

549
00:21:50,899 --> 00:21:56,418
mechanism<font color="#E5E5E5"> well we have Windows scheduled</font>

550
00:21:53,600 --> 00:21:58,248
tasks but there's also this<font color="#E5E5E5"> management</font>

551
00:21:56,419 --> 00:22:00,769
interface<font color="#E5E5E5"> buried into Windows called</font>

552
00:21:58,249 --> 00:22:03,799
<font color="#CCCCCC">double yemaja that's been around for 20</font>

553
00:22:00,769 --> 00:22:07,429
years<font color="#E5E5E5"> and what is</font><font color="#CCCCCC"> that it</font><font color="#E5E5E5"> basically</font>

554
00:22:03,799 --> 00:22:09,559
provides for valid<font color="#CCCCCC"> reasons but also for</font>

555
00:22:07,429 --> 00:22:11,330
attackers<font color="#CCCCCC"> a way to set up a</font><font color="#E5E5E5"> scheduled</font>

556
00:22:09,559 --> 00:22:13,519
<font color="#E5E5E5">task that you really can't</font><font color="#CCCCCC"> find unless</font>

557
00:22:11,330 --> 00:22:15,109
you write<font color="#E5E5E5"> some PowerShell code it's very</font>

558
00:22:13,519 --> 00:22:17,359
<font color="#CCCCCC">difficult to get this because what's</font>

559
00:22:15,109 --> 00:22:18,980
what<font color="#E5E5E5"> you do is you</font><font color="#CCCCCC"> actually configure</font>

560
00:22:17,359 --> 00:22:20,539
this<font color="#CCCCCC"> w my</font><font color="#E5E5E5"> tab</font>

561
00:22:18,980 --> 00:22:22,070
in several<font color="#CCCCCC"> different parts</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> first</font>

562
00:22:20,539 --> 00:22:25,129
part<font color="#E5E5E5"> is to say when this situation</font>

563
00:22:22,070 --> 00:22:27,080
<font color="#CCCCCC">occurs</font><font color="#E5E5E5"> and then the other part is I want</font>

564
00:22:25,130 --> 00:22:29,360
<font color="#E5E5E5">you to do this</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> then the third part</font>

565
00:22:27,080 --> 00:22:32,049
is say when you see this then do this

566
00:22:29,360 --> 00:22:34,039
and here it's<font color="#E5E5E5"> going</font><font color="#CCCCCC"> to run evil dot exe</font>

567
00:22:32,049 --> 00:22:37,460
<font color="#E5E5E5">which I don't</font><font color="#CCCCCC"> know about you but that</font>

568
00:22:34,039 --> 00:22:40,100
<font color="#CCCCCC">sounds pretty suspicious</font><font color="#E5E5E5"> so what does</font>

569
00:22:37,460 --> 00:22:41,480
<font color="#E5E5E5">Microsoft think about all this and</font><font color="#CCCCCC"> I can</font>

570
00:22:40,100 --> 00:22:43,370
apologize<font color="#E5E5E5"> for the screen</font>

571
00:22:41,480 --> 00:22:44,690
what does Microsoft think about all this

572
00:22:43,370 --> 00:22:48,529
at<font color="#E5E5E5"> derbycon</font>

573
00:22:44,690 --> 00:22:50,179
last month<font color="#E5E5E5"> Jeff's recent over created</font>

574
00:22:48,529 --> 00:22:52,250
PowerShell<font color="#CCCCCC"> Lea Holmes who actually wrote</font>

575
00:22:50,179 --> 00:22:55,370
all of<font color="#CCCCCC"> these</font><font color="#E5E5E5"> PowerShell version 5</font>

576
00:22:52,250 --> 00:22:58,220
<font color="#E5E5E5">security features</font><font color="#CCCCCC"> had keynoted at Derby</font>

577
00:22:55,370 --> 00:23:00,469
<font color="#E5E5E5">Khan and they said well we know that</font>

578
00:22:58,220 --> 00:23:02,899
attackers<font color="#E5E5E5"> using</font><font color="#CCCCCC"> powershell</font><font color="#E5E5E5"> fir for</font>

579
00:23:00,470 --> 00:23:04,399
attacks but<font color="#E5E5E5"> they're also using RTP</font>

580
00:23:02,899 --> 00:23:05,779
they're also using MMC they're also

581
00:23:04,399 --> 00:23:08,120
using all these other tools that<font color="#E5E5E5"> are</font>

582
00:23:05,779 --> 00:23:10,520
<font color="#E5E5E5">there</font><font color="#CCCCCC"> for admins so they put up here and</font>

583
00:23:08,120 --> 00:23:13,070
said<font color="#E5E5E5"> we know</font><font color="#CCCCCC"> you have your</font><font color="#E5E5E5"> choice</font><font color="#CCCCCC"> of</font>

584
00:23:10,520 --> 00:23:16,779
post exploitation languages so<font color="#CCCCCC"> we thank</font>

585
00:23:13,070 --> 00:23:16,779
you for hacking with<font color="#E5E5E5"> PowerShell</font>

586
00:23:20,080 --> 00:23:26,060
but we don't<font color="#E5E5E5"> just need</font><font color="#CCCCCC"> powershell data</font>

587
00:23:23,330 --> 00:23:28,580
<font color="#CCCCCC">yuxi we can execute power shell</font><font color="#E5E5E5"> from</font>

588
00:23:26,060 --> 00:23:29,990
<font color="#E5E5E5">other places and why is that we can</font>

589
00:23:28,580 --> 00:23:32,449
execute and run PowerShell

590
00:23:29,990 --> 00:23:34,730
from net because PowerShell is system

591
00:23:32,450 --> 00:23:37,490
management<font color="#E5E5E5"> automation dot dl l it is a</font>

592
00:23:34,730 --> 00:23:39,320
<font color="#E5E5E5">dll it is not powershell data you see</font>

593
00:23:37,490 --> 00:23:41,510
it's not<font color="#CCCCCC"> powershell underscore is c dot</font>

594
00:23:39,320 --> 00:23:43,520
exe<font color="#E5E5E5"> those are just consoles</font><font color="#CCCCCC"> that call</font>

595
00:23:41,510 --> 00:23:45,770
that<font color="#CCCCCC"> dll</font><font color="#E5E5E5"> in the right side you can't</font>

596
00:23:43,520 --> 00:23:47,600
really see<font color="#CCCCCC"> it but this is code from</font><font color="#E5E5E5"> MSD</font>

597
00:23:45,770 --> 00:23:49,670
and that says how<font color="#CCCCCC"> to actually create</font><font color="#E5E5E5"> a</font>

598
00:23:47,600 --> 00:23:53,090
an<font color="#E5E5E5"> application that calls PowerShell</font>

599
00:23:49,670 --> 00:23:55,160
code and it's simple<font color="#E5E5E5"> as going powershell</font>

600
00:23:53,090 --> 00:23:57,740
PS equals powershell<font color="#CCCCCC"> Dockery</font><font color="#E5E5E5"> and then</font>

601
00:23:55,160 --> 00:24:00,050
prints and<font color="#CCCCCC"> benton who spoke at Derby</font><font color="#E5E5E5"> Con</font>

602
00:23:57,740 --> 00:24:03,620
this year<font color="#E5E5E5"> and also last year talked</font>

603
00:24:00,050 --> 00:24:05,419
<font color="#E5E5E5">about his not PowerShell which is an</font>

604
00:24:03,620 --> 00:24:06,860
executable that's totally not PowerShell

605
00:24:05,420 --> 00:24:10,730
but you can actually<font color="#E5E5E5"> run PowerShell code</font>

606
00:24:06,860 --> 00:24:14,929
from it so we can create a c-sharp

607
00:24:10,730 --> 00:24:16,580
application that references this<font color="#CCCCCC"> dll we</font>

608
00:24:14,930 --> 00:24:18,650
can leverage that<font color="#E5E5E5"> automation assemblies</font>

609
00:24:16,580 --> 00:24:21,080
functions to execute the PowerShell code

610
00:24:18,650 --> 00:24:26,270
<font color="#E5E5E5">and this</font><font color="#CCCCCC"> is pretty much</font><font color="#E5E5E5"> how</font><font color="#CCCCCC"> powershell</font>

611
00:24:21,080 --> 00:24:28,250
dot exe works solely<font color="#CCCCCC"> Christensen someone</font>

612
00:24:26,270 --> 00:24:30,560
said hey this<font color="#CCCCCC"> is how this works</font><font color="#E5E5E5"> when we</font>

613
00:24:28,250 --> 00:24:31,910
<font color="#E5E5E5">do it this</font><font color="#CCCCCC"> way and</font><font color="#E5E5E5"> he goes what about</font>

614
00:24:30,560 --> 00:24:33,260
<font color="#E5E5E5">over here</font><font color="#CCCCCC"> and they said no</font><font color="#E5E5E5"> no that</font>

615
00:24:31,910 --> 00:24:34,940
<font color="#CCCCCC">doesn't really work that</font><font color="#E5E5E5"> way</font><font color="#CCCCCC"> he's like</font>

616
00:24:33,260 --> 00:24:37,129
<font color="#CCCCCC">ok</font><font color="#E5E5E5"> and he went off</font><font color="#CCCCCC"> for like a month</font><font color="#E5E5E5"> and</font>

617
00:24:34,940 --> 00:24:38,660
figured out<font color="#CCCCCC"> I'd do it so he wrote</font>

618
00:24:37,130 --> 00:24:40,430
unmanaged power show<font color="#E5E5E5"> which is the</font>

619
00:24:38,660 --> 00:24:42,680
<font color="#CCCCCC">foundation for</font><font color="#E5E5E5"> just about every attack</font>

620
00:24:40,430 --> 00:24:44,180
tool that's out there<font color="#E5E5E5"> that runs</font>

621
00:24:42,680 --> 00:24:46,970
PowerShell code on a system<font color="#CCCCCC"> without</font>

622
00:24:44,180 --> 00:24:48,980
actually calling PowerShell dot exe<font color="#CCCCCC"> how</font>

623
00:24:46,970 --> 00:24:50,870
does it do<font color="#E5E5E5"> this</font><font color="#CCCCCC"> but starts up net and</font>

624
00:24:48,980 --> 00:24:52,880
performs<font color="#CCCCCC"> in</font><font color="#E5E5E5"> memory loading of a custom</font>

625
00:24:50,870 --> 00:24:54,739
c-sharp assembly<font color="#E5E5E5"> that executes</font><font color="#CCCCCC"> that</font>

626
00:24:52,880 --> 00:24:58,670
PowerShell<font color="#E5E5E5"> and it runs it from an</font>

627
00:24:54,740 --> 00:25:01,280
unmanaged process<font color="#CCCCCC"> Metasploit uses it as</font>

628
00:24:58,670 --> 00:25:03,440
of March of<font color="#CCCCCC"> this year</font><font color="#E5E5E5"> unmanaged</font>

629
00:25:01,280 --> 00:25:05,240
<font color="#E5E5E5">PowerShell tremendously enhance the</font>

630
00:25:03,440 --> 00:25:06,470
capability of<font color="#CCCCCC"> Metasploit because that</font>

631
00:25:05,240 --> 00:25:08,180
means<font color="#E5E5E5"> that</font><font color="#CCCCCC"> it can do a</font><font color="#E5E5E5"> lot</font><font color="#CCCCCC"> of things</font>

632
00:25:06,470 --> 00:25:12,350
that they<font color="#E5E5E5"> couldn't otherwise do unless</font>

633
00:25:08,180 --> 00:25:14,540
they were calling<font color="#E5E5E5"> PowerShell dideoxy so</font>

634
00:25:12,350 --> 00:25:16,699
how do we sidestep<font color="#CCCCCC"> PowerShell security</font>

635
00:25:14,540 --> 00:25:18,889
<font color="#CCCCCC">man that's too bad so this is a graphic</font>

636
00:25:16,700 --> 00:25:21,620
of a road in<font color="#CCCCCC"> the middle with a gate</font>

637
00:25:18,890 --> 00:25:23,000
there and you can see in the snow<font color="#E5E5E5"> that</font>

638
00:25:21,620 --> 00:25:24,709
all<font color="#E5E5E5"> these other cars have just gone</font>

639
00:25:23,000 --> 00:25:26,210
right<font color="#E5E5E5"> around that road because</font><font color="#CCCCCC"> they can</font>

640
00:25:24,710 --> 00:25:28,550
<font color="#CCCCCC">just drive in the grass and there's a</font>

641
00:25:26,210 --> 00:25:29,810
gate in the<font color="#CCCCCC"> middle so it's not so</font>

642
00:25:28,550 --> 00:25:31,918
effective when<font color="#E5E5E5"> you have</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> explain your</font>

643
00:25:29,810 --> 00:25:34,389
graphics

644
00:25:31,919 --> 00:25:37,240
so let's talk about<font color="#CCCCCC"> power show without</font>

645
00:25:34,389 --> 00:25:39,008
<font color="#E5E5E5">power shell</font><font color="#CCCCCC"> one of my favorite actually</font>

646
00:25:37,240 --> 00:25:40,509
<font color="#E5E5E5">I can't say</font><font color="#CCCCCC"> favor</font><font color="#E5E5E5"> because jared has</font>

647
00:25:39,009 --> 00:25:42,940
<font color="#E5E5E5">quoted me on that this</font><font color="#CCCCCC"> is</font><font color="#E5E5E5"> not my</font>

648
00:25:40,509 --> 00:25:44,529
<font color="#CCCCCC">favorite power shell attack</font><font color="#E5E5E5"> tool that is</font>

649
00:25:42,940 --> 00:25:48,549
a power is an executable that's not

650
00:25:44,529 --> 00:25:50,440
power<font color="#E5E5E5"> shell</font><font color="#CCCCCC"> I like to explain it because</font>

651
00:25:48,549 --> 00:25:51,340
it's one<font color="#E5E5E5"> of the easier ways to</font><font color="#CCCCCC"> explain</font>

652
00:25:50,440 --> 00:25:54,249
how<font color="#E5E5E5"> this works</font>

653
00:25:51,340 --> 00:25:57,249
it is a<font color="#E5E5E5"> self-contained custom executable</font>

654
00:25:54,249 --> 00:26:00,100
<font color="#CCCCCC">that has power shell offensive attack</font>

655
00:25:57,249 --> 00:26:02,740
code<font color="#E5E5E5"> inside</font><font color="#CCCCCC"> of it</font><font color="#E5E5E5"> that</font><font color="#CCCCCC"> can be leveraged</font>

656
00:26:00,100 --> 00:26:04,570
just by running<font color="#E5E5E5"> that executable and it</font>

657
00:26:02,740 --> 00:26:06,309
calls this power shell components

658
00:26:04,570 --> 00:26:08,559
through net but what's pretty<font color="#CCCCCC"> cool about</font>

659
00:26:06,309 --> 00:26:10,990
<font color="#E5E5E5">it is all these power shell modules</font>

660
00:26:08,559 --> 00:26:13,299
<font color="#E5E5E5">inside of</font><font color="#CCCCCC"> this executable</font><font color="#E5E5E5"> are encrypted</font>

661
00:26:10,990 --> 00:26:14,799
and when you run<font color="#E5E5E5"> the executable these</font>

662
00:26:13,299 --> 00:26:16,720
are decrypted<font color="#E5E5E5"> and then place it in a</font>

663
00:26:14,799 --> 00:26:18,460
<font color="#E5E5E5">memory so this means that antivirus</font>

664
00:26:16,720 --> 00:26:20,230
really never gets a<font color="#E5E5E5"> chance</font><font color="#CCCCCC"> to see what</font>

665
00:26:18,460 --> 00:26:22,210
<font color="#E5E5E5">the code really is because they're</font>

666
00:26:20,230 --> 00:26:24,249
encrypted in the<font color="#E5E5E5"> executable in that file</font>

667
00:26:22,210 --> 00:26:27,730
<font color="#E5E5E5">and then when it's executed</font><font color="#CCCCCC"> they're</font>

668
00:26:24,249 --> 00:26:29,259
shoved up into memory so<font color="#CCCCCC"> this is</font><font color="#E5E5E5"> pretty</font>

669
00:26:27,730 --> 00:26:31,799
interesting<font color="#CCCCCC"> you</font><font color="#E5E5E5"> run PS attack it</font>

670
00:26:29,259 --> 00:26:35,049
decrypts these modules in a memory<font color="#E5E5E5"> and</font>

671
00:26:31,799 --> 00:26:36,700
we can run a command lit within PS

672
00:26:35,049 --> 00:26:39,009
attack called get attack we want to do

673
00:26:36,700 --> 00:26:41,139
recon we say get attack recon<font color="#E5E5E5"> or get</font>

674
00:26:39,009 --> 00:26:44,830
<font color="#E5E5E5">attack netcat get attack passwords to</font>

675
00:26:41,139 --> 00:26:47,439
see what's<font color="#CCCCCC"> available to us</font><font color="#E5E5E5"> so here's the</font>

676
00:26:44,830 --> 00:26:49,119
interesting<font color="#E5E5E5"> thing</font><font color="#CCCCCC"> about PS attack when I</font>

677
00:26:47,440 --> 00:26:51,340
run PS attack and run invoke mimikatz

678
00:26:49,119 --> 00:26:54,789
there is no<font color="#CCCCCC"> powershell dot exe that's</font>

679
00:26:51,340 --> 00:26:55,840
executing<font color="#CCCCCC"> its PS attack</font><font color="#E5E5E5"> if</font><font color="#CCCCCC"> i rename it</font>

680
00:26:54,789 --> 00:26:58,840
<font color="#E5E5E5">or call it something else and that would</font>

681
00:26:55,840 --> 00:27:00,309
show up<font color="#E5E5E5"> that's what would show up what</font>

682
00:26:58,840 --> 00:27:02,080
about<font color="#E5E5E5"> constraint language mode</font><font color="#CCCCCC"> Sean you</font>

683
00:27:00,309 --> 00:27:04,509
<font color="#E5E5E5">said how great that</font><font color="#CCCCCC"> is how we can stop</font>

684
00:27:02,080 --> 00:27:05,980
invoke mimikatz<font color="#CCCCCC"> but I see invoke</font>

685
00:27:04,509 --> 00:27:09,309
mimikatz is running on the bottom<font color="#CCCCCC"> when</font>

686
00:27:05,980 --> 00:27:11,619
<font color="#CCCCCC">you run PS attack</font><font color="#E5E5E5"> yes that is true</font>

687
00:27:09,309 --> 00:27:15,129
so constrain language mode only

688
00:27:11,619 --> 00:27:18,100
constrains<font color="#CCCCCC"> PowerShell exe the PowerShell</font>

689
00:27:15,129 --> 00:27:20,639
console components does not constrain

690
00:27:18,100 --> 00:27:24,369
when you have an<font color="#CCCCCC"> application</font><font color="#E5E5E5"> a dotnet</font>

691
00:27:20,639 --> 00:27:26,039
<font color="#CCCCCC">exe</font><font color="#E5E5E5"> calling PowerShell code you can</font>

692
00:27:24,369 --> 00:27:29,168
bypass<font color="#E5E5E5"> that constraint language mode</font>

693
00:27:26,039 --> 00:27:31,149
Sean why did Microsoft do this I asked

694
00:27:29,169 --> 00:27:33,429
that very question<font color="#CCCCCC"> and the answer I got</font>

695
00:27:31,149 --> 00:27:35,320
was because of compatibility<font color="#E5E5E5"> with other</font>

696
00:27:33,429 --> 00:27:36,669
applications<font color="#CCCCCC"> you might have constraint</font>

697
00:27:35,320 --> 00:27:38,559
language mode and<font color="#E5E5E5"> that</font><font color="#CCCCCC"> application would</font>

698
00:27:36,669 --> 00:27:42,220
stop<font color="#E5E5E5"> working at which point they would</font>

699
00:27:38,559 --> 00:27:43,120
blame Microsoft<font color="#CCCCCC"> Q support hassles</font><font color="#E5E5E5"> small</font>

700
00:27:42,220 --> 00:27:46,540
violin<font color="#CCCCCC"> etcetera</font>

701
00:27:43,120 --> 00:27:48,189
so invoke mimikatz works in<font color="#CCCCCC"> constrain</font>

702
00:27:46,540 --> 00:27:50,560
language mode when it's called from this

703
00:27:48,190 --> 00:27:53,290
executable<font color="#E5E5E5"> and it doesn't show</font><font color="#CCCCCC"> up in</font><font color="#E5E5E5"> the</font>

704
00:27:50,560 --> 00:27:54,879
task manager<font color="#CCCCCC"> okay that's interesting it</font>

705
00:27:53,290 --> 00:27:55,420
<font color="#CCCCCC">bypassed Rayyan language mode how does</font>

706
00:27:54,880 --> 00:27:58,600
it do that

707
00:27:55,420 --> 00:27:59,830
<font color="#E5E5E5">well I mentioned how it does</font><font color="#CCCCCC"> that but is</font>

708
00:27:58,600 --> 00:28:02,199
<font color="#E5E5E5">there anything else that it's doing</font>

709
00:27:59,830 --> 00:28:04,270
that's unusual what<font color="#CCCCCC"> about all those</font>

710
00:28:02,200 --> 00:28:06,460
great<font color="#CCCCCC"> PowerShell version</font><font color="#E5E5E5"> 5 security logs</font>

711
00:28:04,270 --> 00:28:10,000
that<font color="#E5E5E5"> I was talking</font><font color="#CCCCCC"> about they're not</font>

712
00:28:06,460 --> 00:28:12,700
<font color="#CCCCCC">there so I run invoke mimikatz from</font>

713
00:28:10,000 --> 00:28:14,110
within<font color="#CCCCCC"> powershell PS attack and there</font>

714
00:28:12,700 --> 00:28:17,650
are no logs that show up in<font color="#E5E5E5"> the</font>

715
00:28:14,110 --> 00:28:21,580
<font color="#E5E5E5">powershell operational log why is this</font>

716
00:28:17,650 --> 00:28:24,640
it seems really weird<font color="#CCCCCC"> but</font><font color="#E5E5E5"> there are the</font>

717
00:28:21,580 --> 00:28:26,439
original<font color="#E5E5E5"> PowerShell logs so event ID 400</font>

718
00:28:24,640 --> 00:28:28,210
of<font color="#E5E5E5"> NIT 800 the ones you got with</font>

719
00:28:26,440 --> 00:28:33,490
PowerShell<font color="#E5E5E5"> like in the version</font><font color="#CCCCCC"> 2 days</font>

720
00:28:28,210 --> 00:28:34,060
<font color="#E5E5E5">your default Windows 7 ones how does</font>

721
00:28:33,490 --> 00:28:35,860
this work

722
00:28:34,060 --> 00:28:37,990
it works because PS attack is actually

723
00:28:35,860 --> 00:28:40,510
<font color="#E5E5E5">using PowerShell version 2 on that</font>

724
00:28:37,990 --> 00:28:42,130
<font color="#E5E5E5">system and these</font><font color="#CCCCCC"> capabilities are not</font>

725
00:28:40,510 --> 00:28:43,780
<font color="#E5E5E5">available in PowerShell 2 there is no</font>

726
00:28:42,130 --> 00:28:47,920
script block logging there's no module

727
00:28:43,780 --> 00:28:49,810
logging so at the top<font color="#E5E5E5"> here</font><font color="#CCCCCC"> I run from a</font>

728
00:28:47,920 --> 00:28:52,450
command prompt<font color="#E5E5E5"> PowerShell - version</font>

729
00:28:49,810 --> 00:28:54,460
space<font color="#E5E5E5"> - so I'm basically invoking</font>

730
00:28:52,450 --> 00:28:55,930
<font color="#E5E5E5">calling PowerShell but I only want to</font>

731
00:28:54,460 --> 00:28:58,210
<font color="#CCCCCC">use</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> version 2</font><font color="#E5E5E5"> libraries the only</font>

732
00:28:55,930 --> 00:29:00,370
only want to use version<font color="#E5E5E5"> 2 associated</font>

733
00:28:58,210 --> 00:29:02,080
PowerShell and I run a<font color="#E5E5E5"> command called</font>

734
00:29:00,370 --> 00:29:03,580
<font color="#E5E5E5">get process you can't see it on the</font>

735
00:29:02,080 --> 00:29:07,149
<font color="#E5E5E5">right side I apologize but the slides</font>

736
00:29:03,580 --> 00:29:09,280
are online<font color="#E5E5E5"> and we cannot see that event</font>

737
00:29:07,150 --> 00:29:10,930
but<font color="#E5E5E5"> the one below it where I just</font><font color="#CCCCCC"> call</font>

738
00:29:09,280 --> 00:29:12,520
PowerShell<font color="#CCCCCC"> where it's running</font><font color="#E5E5E5"> PowerShell</font>

739
00:29:10,930 --> 00:29:15,250
version 5 on<font color="#CCCCCC"> this system that happens to</font>

740
00:29:12,520 --> 00:29:16,750
<font color="#E5E5E5">be a Windows 10 system we can see</font><font color="#CCCCCC"> it run</font>

741
00:29:15,250 --> 00:29:18,820
here and then if you could actually see

742
00:29:16,750 --> 00:29:20,890
<font color="#CCCCCC">the event there you would see that it</font>

743
00:29:18,820 --> 00:29:21,850
saw that<font color="#E5E5E5"> they can't see the top</font><font color="#CCCCCC"> one</font>

744
00:29:20,890 --> 00:29:26,890
<font color="#E5E5E5">because it's running PowerShell version</font>

745
00:29:21,850 --> 00:29:29,860
<font color="#E5E5E5">2 so how do we detect this and this is</font>

746
00:29:26,890 --> 00:29:33,580
an<font color="#CCCCCC"> awesome graphic</font><font color="#E5E5E5"> with like RGB colors</font>

747
00:29:29,860 --> 00:29:36,280
<font color="#E5E5E5">it actually had like 16 K colors this is</font>

748
00:29:33,580 --> 00:29:38,080
<font color="#CCCCCC">a Where's Waldo</font><font color="#E5E5E5"> picture again explaining</font>

749
00:29:36,280 --> 00:29:39,879
<font color="#E5E5E5">your memes is not so interesting or</font>

750
00:29:38,080 --> 00:29:41,379
exciting<font color="#E5E5E5"> but we have to figure</font><font color="#CCCCCC"> out where</font>

751
00:29:39,880 --> 00:29:42,940
Waldo<font color="#E5E5E5"> is and it's very difficult to</font>

752
00:29:41,380 --> 00:29:44,230
<font color="#CCCCCC">figure</font><font color="#E5E5E5"> out where Waldo is because we</font>

753
00:29:42,940 --> 00:29:46,390
have an executable that's calling

754
00:29:44,230 --> 00:29:48,940
<font color="#E5E5E5">PowerShell that</font><font color="#CCCCCC"> bypasses our standard</font>

755
00:29:46,390 --> 00:29:49,510
traditional<font color="#CCCCCC"> security visibility through</font>

756
00:29:48,940 --> 00:29:53,260
our logs

757
00:29:49,510 --> 00:29:55,420
so I ran<font color="#E5E5E5"> proc</font><font color="#CCCCCC"> Mon by sysinternals to</font>

758
00:29:53,260 --> 00:29:56,770
look at what PS attack was doing well

759
00:29:55,420 --> 00:30:00,520
there's a lot of dot in that call

760
00:29:56,770 --> 00:30:03,300
<font color="#CCCCCC">to PowerShell one and as I dug into it</font>

761
00:30:00,520 --> 00:30:05,440
and also some<font color="#E5E5E5"> help from Carlos Perez</font>

762
00:30:03,300 --> 00:30:07,690
<font color="#E5E5E5">realize that we could look for</font>

763
00:30:05,440 --> 00:30:10,270
PowerShell on<font color="#E5E5E5"> non-standard processes so</font>

764
00:30:07,690 --> 00:30:11,470
<font color="#CCCCCC">we can do get process</font><font color="#E5E5E5"> and pipe it and</font>

765
00:30:10,270 --> 00:30:14,080
look for the system management

766
00:30:11,470 --> 00:30:16,300
<font color="#E5E5E5">automation because that is the</font><font color="#CCCCCC"> dll</font>

767
00:30:14,080 --> 00:30:18,070
that's called by those executables<font color="#E5E5E5"> to</font>

768
00:30:16,300 --> 00:30:20,649
run PowerShell outside of PowerShell<font color="#CCCCCC"> not</font>

769
00:30:18,070 --> 00:30:22,030
<font color="#CCCCCC">exe if we dig in a little</font><font color="#E5E5E5"> bit more we</font>

770
00:30:20,650 --> 00:30:25,270
<font color="#CCCCCC">can see all of the modules that</font><font color="#E5E5E5"> it's</font>

771
00:30:22,030 --> 00:30:26,830
calling so kernel32 again pretty pretty

772
00:30:25,270 --> 00:30:33,580
interesting<font color="#CCCCCC"> but system management</font>

773
00:30:26,830 --> 00:30:36,669
<font color="#E5E5E5">automation</font><font color="#CCCCCC"> ni dll so we can run Windows</font>

774
00:30:33,580 --> 00:30:39,309
<font color="#CCCCCC">10 with an AMS I</font><font color="#E5E5E5"> wear a V like defender</font>

775
00:30:36,670 --> 00:30:41,590
<font color="#CCCCCC">and when we do</font><font color="#E5E5E5"> that</font>

776
00:30:39,309 --> 00:30:43,570
what do<font color="#E5E5E5"> we get it doesn't work when it's</font>

777
00:30:41,590 --> 00:30:45,669
trying<font color="#CCCCCC"> to load those modules</font><font color="#E5E5E5"> and decrypt</font>

778
00:30:43,570 --> 00:30:47,710
them<font color="#E5E5E5"> and put them in a memory MSI kicks</font>

779
00:30:45,670 --> 00:30:49,720
it over<font color="#E5E5E5"> to defender and defender goes no</font>

780
00:30:47,710 --> 00:30:53,140
that is<font color="#E5E5E5"> not good code we're not going to</font>

781
00:30:49,720 --> 00:30:55,270
<font color="#E5E5E5">run that except remember I said Mac</font>

782
00:30:53,140 --> 00:30:57,160
<font color="#E5E5E5">Raber tweeted out</font><font color="#CCCCCC"> how bypass and then</font>

783
00:30:55,270 --> 00:30:59,740
Jared went ahead and integrated into PS

784
00:30:57,160 --> 00:31:01,210
<font color="#CCCCCC">attacks and now it works</font><font color="#E5E5E5"> again so it's</font>

785
00:30:59,740 --> 00:31:02,620
always this<font color="#CCCCCC"> cat-and-mouse game</font><font color="#E5E5E5"> try to</font>

786
00:31:01,210 --> 00:31:03,910
figure<font color="#E5E5E5"> out how to defend against</font>

787
00:31:02,620 --> 00:31:06,280
something<font color="#E5E5E5"> and then someone comes out</font>

788
00:31:03,910 --> 00:31:09,340
with a better<font color="#CCCCCC"> Mouse or a better</font>

789
00:31:06,280 --> 00:31:10,960
<font color="#CCCCCC">mousetrap or you get a cat and then you</font>

790
00:31:09,340 --> 00:31:12,580
have a cat running<font color="#CCCCCC"> around and then the</font>

791
00:31:10,960 --> 00:31:14,140
<font color="#CCCCCC">cat's not good enough because there's a</font>

792
00:31:12,580 --> 00:31:15,309
rat<font color="#E5E5E5"> and then you need to get a snake and</font>

793
00:31:14,140 --> 00:31:16,750
<font color="#E5E5E5">then a snakes not good</font><font color="#CCCCCC"> enough you get a</font>

794
00:31:15,309 --> 00:31:18,010
mongoose<font color="#E5E5E5"> then you have a mongoose</font>

795
00:31:16,750 --> 00:31:19,360
running around<font color="#CCCCCC"> the house which is</font><font color="#E5E5E5"> not so</font>

796
00:31:18,010 --> 00:31:21,460
<font color="#CCCCCC">great with</font><font color="#E5E5E5"> kids no matter what you heard</font>

797
00:31:19,360 --> 00:31:23,439
about<font color="#CCCCCC"> rikki-tikki-tavi and then you</font><font color="#E5E5E5"> get</font>

798
00:31:21,460 --> 00:31:24,910
<font color="#CCCCCC">like an eagle and trust me you cannot</font>

799
00:31:23,440 --> 00:31:26,590
have<font color="#E5E5E5"> them in the house at any point in</font>

800
00:31:24,910 --> 00:31:28,120
time<font color="#E5E5E5"> and then just goes</font><font color="#CCCCCC"> onto</font><font color="#E5E5E5"> this thing</font>

801
00:31:26,590 --> 00:31:31,720
<font color="#CCCCCC">where you just keep escalating and</font><font color="#E5E5E5"> it</font>

802
00:31:28,120 --> 00:31:35,350
goes crazy<font color="#E5E5E5"> and I'm off topic so how do</font>

803
00:31:31,720 --> 00:31:38,050
<font color="#E5E5E5">we detect PS attack</font><font color="#CCCCCC"> so I looked into</font>

804
00:31:35,350 --> 00:31:39,490
this and I saw that event 400 is one of

805
00:31:38,050 --> 00:31:41,830
<font color="#E5E5E5">those events</font><font color="#CCCCCC"> that starts with the</font>

806
00:31:39,490 --> 00:31:44,050
original<font color="#E5E5E5"> earlier version</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> PowerShell</font>

807
00:31:41,830 --> 00:31:45,520
<font color="#CCCCCC">PowerShell version</font><font color="#E5E5E5"> 2 and what we can</font>

808
00:31:44,050 --> 00:31:48,428
look<font color="#CCCCCC"> here is that the host name the host</font>

809
00:31:45,520 --> 00:31:52,030
engine but we can look at the engine

810
00:31:48,429 --> 00:31:53,950
version and it says 2.0 which means this

811
00:31:52,030 --> 00:31:57,010
<font color="#E5E5E5">executable is calling PowerShell version</font>

812
00:31:53,950 --> 00:32:00,670
2<font color="#E5E5E5"> which is really weird because I have</font>

813
00:31:57,010 --> 00:32:02,470
PowerShell<font color="#CCCCCC"> 5 on there so in Windows 10</font>

814
00:32:00,670 --> 00:32:04,330
we can<font color="#E5E5E5"> actually uncheck Sabbagh uncheck</font>

815
00:32:02,470 --> 00:32:05,170
a box and say I don't<font color="#E5E5E5"> want PowerShell 2</font>

816
00:32:04,330 --> 00:32:06,850
on my

817
00:32:05,170 --> 00:32:09,010
ten box and it will remove it we can do

818
00:32:06,850 --> 00:32:11,199
the<font color="#E5E5E5"> same thing with 8.1</font><font color="#CCCCCC"> and so when I</font>

819
00:32:09,010 --> 00:32:14,370
try to run PowerShell<font color="#CCCCCC"> version 2</font><font color="#E5E5E5"> it goes</font>

820
00:32:11,200 --> 00:32:14,370
I<font color="#E5E5E5"> don't know what you're talking about</font>

821
00:32:16,140 --> 00:32:22,030
and<font color="#E5E5E5"> so once we</font><font color="#CCCCCC"> uncheck that box here</font><font color="#E5E5E5"> and</font>

822
00:32:19,660 --> 00:32:25,810
say there's<font color="#E5E5E5"> no more PowerShell version</font><font color="#CCCCCC"> 2</font>

823
00:32:22,030 --> 00:32:27,910
<font color="#E5E5E5">and then we run PS attack and have to do</font>

824
00:32:25,810 --> 00:32:29,649
all of<font color="#E5E5E5"> this interesting activity</font><font color="#CCCCCC"> guess</font>

825
00:32:27,910 --> 00:32:32,440
what all the script block logging starts

826
00:32:29,650 --> 00:32:36,610
showing up again<font color="#E5E5E5"> so 4104 shows us what</font>

827
00:32:32,440 --> 00:32:38,770
it's trying<font color="#E5E5E5"> to do</font><font color="#CCCCCC"> 40 140</font><font color="#E5E5E5"> 103 we get the</font>

828
00:32:36,610 --> 00:32:40,449
logs that<font color="#E5E5E5"> we would</font><font color="#CCCCCC"> normally be we would</font>

829
00:32:38,770 --> 00:32:43,810
normally<font color="#CCCCCC"> get from this type of activity</font>

830
00:32:40,450 --> 00:32:45,340
<font color="#CCCCCC">and that we're accustomed to</font><font color="#E5E5E5"> so how do</font>

831
00:32:43,810 --> 00:32:46,780
we detect<font color="#E5E5E5"> it well we can look at event</font>

832
00:32:45,340 --> 00:32:49,060
ID 800 which means that if you're not

833
00:32:46,780 --> 00:32:50,350
<font color="#E5E5E5">pulling the original</font><font color="#CCCCCC"> PowerShell logs you</font>

834
00:32:49,060 --> 00:32:52,419
<font color="#E5E5E5">probably need</font><font color="#CCCCCC"> to pull</font><font color="#E5E5E5"> those in addition</font>

835
00:32:50,350 --> 00:32:54,370
to your<font color="#E5E5E5"> operational logs we can</font><font color="#CCCCCC"> look for</font>

836
00:32:52,420 --> 00:32:56,050
those<font color="#E5E5E5"> host applications</font><font color="#CCCCCC"> not a standard</font>

837
00:32:54,370 --> 00:32:57,159
Microsoft tool<font color="#E5E5E5"> it's not gonna be a</font>

838
00:32:56,050 --> 00:32:58,659
hundred<font color="#E5E5E5"> percent</font><font color="#CCCCCC"> but it's something</font><font color="#E5E5E5"> to</font>

839
00:32:57,160 --> 00:33:01,410
<font color="#CCCCCC">look at</font><font color="#E5E5E5"> because if it says PS attack</font>

840
00:32:58,660 --> 00:33:04,240
<font color="#E5E5E5">it's probably not PowerShell dot exe</font><font color="#CCCCCC"> a</font>

841
00:33:01,410 --> 00:33:05,560
version<font color="#E5E5E5"> mismatch system management</font>

842
00:33:04,240 --> 00:33:07,240
<font color="#CCCCCC">automation being hosted in</font><font color="#E5E5E5"> a</font>

843
00:33:05,560 --> 00:33:08,950
<font color="#E5E5E5">non-standard process if you're using a</font>

844
00:33:07,240 --> 00:33:10,720
tool<font color="#E5E5E5"> that's able</font><font color="#CCCCCC"> to look at processes</font>

845
00:33:08,950 --> 00:33:13,780
and what they're loading this is a good

846
00:33:10,720 --> 00:33:15,810
way to<font color="#E5E5E5"> identify that</font><font color="#CCCCCC"> and then the other</font>

847
00:33:13,780 --> 00:33:18,700
thing<font color="#CCCCCC"> is custom executables are</font>

848
00:33:15,810 --> 00:33:21,280
executables they can call<font color="#CCCCCC"> Windows api's</font>

849
00:33:18,700 --> 00:33:23,140
directly they can call<font color="#E5E5E5"> net directly they</font>

850
00:33:21,280 --> 00:33:24,879
don't need<font color="#E5E5E5"> to run PowerShell code so the</font>

851
00:33:23,140 --> 00:33:27,340
problem here isn't<font color="#E5E5E5"> PowerShell it's the</font>

852
00:33:24,880 --> 00:33:29,710
fact that untrusted code is running<font color="#CCCCCC"> on</font>

853
00:33:27,340 --> 00:33:33,399
the<font color="#CCCCCC"> system that belongs</font><font color="#E5E5E5"> to someone who</font>

854
00:33:29,710 --> 00:33:35,170
<font color="#CCCCCC">doesn't</font><font color="#E5E5E5"> work for your organization so</font>

855
00:33:33,400 --> 00:33:36,790
how do we<font color="#E5E5E5"> detect this how do we how do</font>

856
00:33:35,170 --> 00:33:39,960
we improve<font color="#E5E5E5"> our logging how do we find</font>

857
00:33:36,790 --> 00:33:39,960
the<font color="#CCCCCC"> bag that's out there</font>

858
00:33:42,870 --> 00:33:47,529
well we use PowerShell<font color="#CCCCCC"> module long and</font>

859
00:33:45,760 --> 00:33:50,440
we enable<font color="#E5E5E5"> that if</font><font color="#CCCCCC"> you PowerShell version</font>

860
00:33:47,529 --> 00:33:51,220
3 or 4 or 5<font color="#CCCCCC"> you can enable it through</font>

861
00:33:50,440 --> 00:33:52,840
group<font color="#CCCCCC"> policy</font>

862
00:33:51,220 --> 00:33:55,179
there's enhanced logging in version 5

863
00:33:52,840 --> 00:33:57,279
<font color="#E5E5E5">and of course version sorry you enhanced</font>

864
00:33:55,179 --> 00:34:00,370
logging in version 4 version 5 has some

865
00:33:57,279 --> 00:34:03,039
more compelling features<font color="#E5E5E5"> and we can go</font>

866
00:34:00,370 --> 00:34:05,439
in and set this and<font color="#E5E5E5"> basically say we</font>

867
00:34:03,039 --> 00:34:07,870
want<font color="#E5E5E5"> to enable PowerShell module logging</font>

868
00:34:05,440 --> 00:34:09,418
and we want all modules so<font color="#CCCCCC"> star log all</font>

869
00:34:07,870 --> 00:34:11,949
<font color="#CCCCCC">of them for us please</font>

870
00:34:09,418 --> 00:34:13,719
so we log all our attack to all our

871
00:34:11,949 --> 00:34:15,158
<font color="#E5E5E5">PowerShell activity and then we look for</font>

872
00:34:13,719 --> 00:34:16,989
interesting<font color="#CCCCCC"> things like dotnet web</font>

873
00:34:15,159 --> 00:34:20,710
client download invoke expression and

874
00:34:16,989 --> 00:34:22,509
coda command bits activity etc<font color="#E5E5E5"> that's a</font>

875
00:34:20,710 --> 00:34:23,800
good start<font color="#CCCCCC"> but</font><font color="#E5E5E5"> I'm going to show you why</font>

876
00:34:22,510 --> 00:34:27,879
if this is how you're<font color="#CCCCCC"> looking for</font>

877
00:34:23,800 --> 00:34:29,950
PowerShell bad<font color="#E5E5E5"> we're missing a lot so</font>

878
00:34:27,879 --> 00:34:31,629
invoke expression is pretty much it's

879
00:34:29,949 --> 00:34:33,549
been referred<font color="#CCCCCC"> to as</font><font color="#E5E5E5"> the hackers</font>

880
00:34:31,629 --> 00:34:36,310
<font color="#CCCCCC">powershell command line with good reason</font>

881
00:34:33,550 --> 00:34:39,550
invoke expression is a way to take any

882
00:34:36,310 --> 00:34:42,668
text anywhere<font color="#E5E5E5"> pull it in a PowerShell</font>

883
00:34:39,550 --> 00:34:44,409
<font color="#CCCCCC">and say this is code execute it</font><font color="#E5E5E5"> which</font>

884
00:34:42,668 --> 00:34:46,569
means<font color="#E5E5E5"> that we can just pipe code into it</font>

885
00:34:44,409 --> 00:34:48,760
and invoke it and PowerShell goes<font color="#CCCCCC"> okay</font>

886
00:34:46,570 --> 00:34:50,770
it's a script<font color="#CCCCCC"> I'll run it so if you</font><font color="#E5E5E5"> have</font>

887
00:34:48,760 --> 00:34:52,659
execution<font color="#E5E5E5"> policy set up to block scripts</font>

888
00:34:50,770 --> 00:34:55,119
from running all I have to do is pipe

889
00:34:52,659 --> 00:34:59,080
text<font color="#E5E5E5"> from anywhere and say invoke</font>

890
00:34:55,119 --> 00:35:01,540
expression that<font color="#E5E5E5"> and it'll run net-net</font>

891
00:34:59,080 --> 00:35:03,130
web client download very popular we've

892
00:35:01,540 --> 00:35:05,050
seen it<font color="#E5E5E5"> in the real world attack tools</font>

893
00:35:03,130 --> 00:35:07,210
<font color="#E5E5E5">there's also a way</font><font color="#CCCCCC"> to use the</font><font color="#E5E5E5"> IE comm</font>

894
00:35:05,050 --> 00:35:09,160
object<font color="#E5E5E5"> there's a number</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> different net</font>

895
00:35:07,210 --> 00:35:10,869
methods to do<font color="#CCCCCC"> this as well and there's</font>

896
00:35:09,160 --> 00:35:12,520
actually powershell commandlets that

897
00:35:10,869 --> 00:35:14,140
allow you<font color="#E5E5E5"> to pull code down from the</font>

898
00:35:12,520 --> 00:35:15,759
<font color="#E5E5E5">internet</font><font color="#CCCCCC"> so there's a lot</font><font color="#E5E5E5"> of different</font>

899
00:35:14,140 --> 00:35:18,700
<font color="#E5E5E5">ways this can be done not just dotnet</font>

900
00:35:15,760 --> 00:35:20,410
web client download so how do we<font color="#E5E5E5"> detect</font>

901
00:35:18,700 --> 00:35:22,779
invoke mimikatz as<font color="#E5E5E5"> we</font><font color="#CCCCCC"> care about right</font>

902
00:35:20,410 --> 00:35:25,330
<font color="#E5E5E5">we want to find the bad stuff that</font><font color="#CCCCCC"> we</font>

903
00:35:22,780 --> 00:35:27,520
know is out there<font color="#E5E5E5"> we look for we can do</font>

904
00:35:25,330 --> 00:35:30,790
it the the<font color="#E5E5E5"> antivirus way look for many</font>

905
00:35:27,520 --> 00:35:32,680
cats general key we invoke<font color="#CCCCCC"> many cats but</font>

906
00:35:30,790 --> 00:35:34,570
<font color="#E5E5E5">unfortunately someone told the bad guys</font>

907
00:35:32,680 --> 00:35:36,580
there's this tool<font color="#CCCCCC"> called search replace</font>

908
00:35:34,570 --> 00:35:38,200
and we can just take mini cats<font color="#E5E5E5"> and</font>

909
00:35:36,580 --> 00:35:40,900
replace it with kitty cats<font color="#E5E5E5"> and then we</font>

910
00:35:38,200 --> 00:35:42,098
can't find<font color="#E5E5E5"> these things anymore the end</font>

911
00:35:40,900 --> 00:35:43,570
<font color="#E5E5E5">of our offenders haven't really figured</font>

912
00:35:42,099 --> 00:35:45,730
this<font color="#E5E5E5"> part</font><font color="#CCCCCC"> out yet</font><font color="#E5E5E5"> but they're</font><font color="#CCCCCC"> working</font><font color="#E5E5E5"> on</font>

913
00:35:43,570 --> 00:35:49,510
<font color="#CCCCCC">it they've got</font><font color="#E5E5E5"> teams of people</font><font color="#CCCCCC"> working</font>

914
00:35:45,730 --> 00:35:51,880
<font color="#E5E5E5">on</font><font color="#CCCCCC"> it so i went through</font><font color="#E5E5E5"> and looked at</font>

915
00:35:49,510 --> 00:35:53,260
the<font color="#E5E5E5"> most</font><font color="#CCCCCC"> popular</font><font color="#E5E5E5"> powershell attack tools</font>

916
00:35:51,880 --> 00:35:55,570
<font color="#E5E5E5">and i know they're the most</font><font color="#CCCCCC"> popular</font>

917
00:35:53,260 --> 00:35:57,700
because<font color="#E5E5E5"> i just</font><font color="#CCCCCC"> went</font><font color="#E5E5E5"> to the</font><font color="#CCCCCC"> empire</font>

918
00:35:55,570 --> 00:35:58,960
<font color="#CCCCCC">power Empire github repository</font><font color="#E5E5E5"> and</font>

919
00:35:57,700 --> 00:36:01,060
looked at all that<font color="#E5E5E5"> power</font><font color="#CCCCCC"> salt act tools</font>

920
00:35:58,960 --> 00:36:02,080
that were there<font color="#E5E5E5"> open them all up</font><font color="#CCCCCC"> went</font>

921
00:36:01,060 --> 00:36:04,150
<font color="#E5E5E5">through and</font><font color="#CCCCCC"> looked at all of</font><font color="#E5E5E5"> them and</font>

922
00:36:02,080 --> 00:36:06,130
<font color="#E5E5E5">start pulling out function calls and</font>

923
00:36:04,150 --> 00:36:07,360
figured out what all<font color="#E5E5E5"> those were and then</font>

924
00:36:06,130 --> 00:36:08,590
just part of<font color="#E5E5E5"> putting them together and</font>

925
00:36:07,360 --> 00:36:10,720
parsing them<font color="#E5E5E5"> out and these are</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> ones</font>

926
00:36:08,590 --> 00:36:13,780
I came up with<font color="#E5E5E5"> so token privileges</font>

927
00:36:10,720 --> 00:36:15,549
system reflection system runtime token

928
00:36:13,780 --> 00:36:17,440
impersonate token duplicate token

929
00:36:15,550 --> 00:36:19,090
privileges system reflection<font color="#E5E5E5"> these are</font>

930
00:36:17,440 --> 00:36:21,010
the core<font color="#CCCCCC"> components of these attack</font>

931
00:36:19,090 --> 00:36:24,280
tools<font color="#E5E5E5"> this</font><font color="#CCCCCC"> is how they work</font><font color="#E5E5E5"> they can't</font>

932
00:36:21,010 --> 00:36:26,410
really<font color="#E5E5E5"> obfuscate those asterisks because</font>

933
00:36:24,280 --> 00:36:29,410
if they do then they won't work<font color="#E5E5E5"> when</font>

934
00:36:26,410 --> 00:36:32,230
they get called again<font color="#CCCCCC"> there's an Asterix</font>

935
00:36:29,410 --> 00:36:36,129
on that<font color="#E5E5E5"> and I'll get</font><font color="#CCCCCC"> back to</font><font color="#E5E5E5"> that which</font>

936
00:36:32,230 --> 00:36:37,930
<font color="#E5E5E5">is now power</font><font color="#CCCCCC"> saw obfuscation</font><font color="#E5E5E5"> so</font>

937
00:36:36,130 --> 00:36:40,030
<font color="#CCCCCC">powershell obfuscation up until recently</font>

938
00:36:37,930 --> 00:36:41,290
meant that we did some stuff we<font color="#E5E5E5"> changed</font>

939
00:36:40,030 --> 00:36:43,360
some things<font color="#CCCCCC"> around but</font><font color="#E5E5E5"> it wasn't that</font>

940
00:36:41,290 --> 00:36:45,640
difficult to see what it was until

941
00:36:43,360 --> 00:36:47,680
invoke obfuscation was released by<font color="#CCCCCC"> noted</font>

942
00:36:45,640 --> 00:36:51,640
red teamer<font color="#CCCCCC"> Daniel Bohannon</font><font color="#E5E5E5"> at Derby con</font>

943
00:36:47,680 --> 00:36:55,750
and it's kind of changed the<font color="#CCCCCC"> world</font><font color="#E5E5E5"> of</font>

944
00:36:51,640 --> 00:36:57,670
detecting bad<font color="#E5E5E5"> PowerShell it highlights</font>

945
00:36:55,750 --> 00:37:00,160
the gaps in finding these offensive

946
00:36:57,670 --> 00:37:04,210
<font color="#E5E5E5">PowerShell code how because basically it</font>

947
00:37:00,160 --> 00:37:06,850
is a full tool<font color="#CCCCCC"> daniel spent hundreds</font><font color="#E5E5E5"> of</font>

948
00:37:04,210 --> 00:37:09,670
<font color="#CCCCCC">hours on his research and on</font><font color="#E5E5E5"> this tool</font>

949
00:37:06,850 --> 00:37:11,890
<font color="#E5E5E5">and basically invoke obfuscation to take</font>

950
00:37:09,670 --> 00:37:14,410
a script<font color="#CCCCCC"> lock code</font><font color="#E5E5E5"> or an actual script</font>

951
00:37:11,890 --> 00:37:15,730
<font color="#E5E5E5">and obfuscate</font><font color="#CCCCCC"> it to the</font><font color="#E5E5E5"> level where my</font>

952
00:37:14,410 --> 00:37:18,730
indicators don't work anymore

953
00:37:15,730 --> 00:37:21,270
most indicators don't work anymore<font color="#E5E5E5"> so</font>

954
00:37:18,730 --> 00:37:21,270
what does this<font color="#E5E5E5"> look like</font>

955
00:37:23,680 --> 00:37:31,629
that's a shame so what yeah probably

956
00:37:28,690 --> 00:37:33,580
<font color="#E5E5E5">okay so we'll look at this uh-huh invoke</font>

957
00:37:31,630 --> 00:37:35,980
expression new object net web client

958
00:37:33,580 --> 00:37:37,509
download string a bitly link<font color="#CCCCCC"> right</font><font color="#E5E5E5"> no we</font>

959
00:37:35,980 --> 00:37:39,640
look for this we know what this<font color="#E5E5E5"> is we</font>

960
00:37:37,510 --> 00:37:41,200
look<font color="#E5E5E5"> for a net web client we look for</font>

961
00:37:39,640 --> 00:37:43,720
<font color="#CCCCCC">invoke expression</font><font color="#E5E5E5"> we know this we got it</font>

962
00:37:41,200 --> 00:37:44,649
right except this is what it looks<font color="#E5E5E5"> like</font>

963
00:37:43,720 --> 00:37:48,730
when you run it through info

964
00:37:44,650 --> 00:37:50,080
confiscation my indicators don't work on

965
00:37:48,730 --> 00:37:51,490
that<font color="#E5E5E5"> okay but we have script lock</font>

966
00:37:50,080 --> 00:37:52,810
logging<font color="#E5E5E5"> so we're okay well we'll just</font>

967
00:37:51,490 --> 00:37:54,850
<font color="#E5E5E5">pull it out</font><font color="#CCCCCC"> of script block logging</font>

968
00:37:52,810 --> 00:37:57,330
<font color="#E5E5E5">right it's a ampersand on the beginning</font>

969
00:37:54,850 --> 00:38:00,069
and<font color="#E5E5E5"> some quotes and some other stuff</font><font color="#CCCCCC"> um</font>

970
00:37:57,330 --> 00:38:02,380
it<font color="#E5E5E5"> looks exactly the same</font><font color="#CCCCCC"> in script</font>

971
00:38:00,070 --> 00:38:03,850
<font color="#CCCCCC">block logging</font><font color="#E5E5E5"> this means that our tools</font>

972
00:38:02,380 --> 00:38:06,100
need to evolve<font color="#E5E5E5"> we need to</font><font color="#CCCCCC"> figure out a</font>

973
00:38:03,850 --> 00:38:08,020
better<font color="#CCCCCC"> way to find</font><font color="#E5E5E5"> these things because</font>

974
00:38:06,100 --> 00:38:10,029
<font color="#E5E5E5">it also looks like this if you run it</font>

975
00:38:08,020 --> 00:38:15,790
through<font color="#CCCCCC"> again now it's got brackets with</font>

976
00:38:10,030 --> 00:38:18,700
numbers in it<font color="#CCCCCC"> I can't even</font><font color="#E5E5E5"> like what is</font>

977
00:38:15,790 --> 00:38:20,460
that<font color="#E5E5E5"> and it looks</font><font color="#CCCCCC"> like that</font><font color="#E5E5E5"> in the</font>

978
00:38:18,700 --> 00:38:22,779
script<font color="#CCCCCC"> block logging</font><font color="#E5E5E5"> that's the event</font>

979
00:38:20,460 --> 00:38:27,040
<font color="#E5E5E5">how am I supposed to find that as a blue</font>

980
00:38:22,780 --> 00:38:29,020
<font color="#E5E5E5">team err so invocation I highly</font>

981
00:38:27,040 --> 00:38:30,970
recommend<font color="#CCCCCC"> everyone here check it</font><font color="#E5E5E5"> out</font>

982
00:38:29,020 --> 00:38:32,740
<font color="#CCCCCC">Daniel's talk at Derby Khan was</font>

983
00:38:30,970 --> 00:38:36,040
fantastic the slides are online the

984
00:38:32,740 --> 00:38:38,290
videos online<font color="#E5E5E5"> but download the tool take</font>

985
00:38:36,040 --> 00:38:40,509
some scripts obfuscate them run them in

986
00:38:38,290 --> 00:38:42,340
your<font color="#E5E5E5"> sim see what you get out of it</font><font color="#CCCCCC"> run</font>

987
00:38:40,510 --> 00:38:45,850
it and then send<font color="#E5E5E5"> it to spawn pull that</font>

988
00:38:42,340 --> 00:38:47,530
data back because this<font color="#E5E5E5"> is what invoke</font>

989
00:38:45,850 --> 00:38:49,569
mimikatz looks like this is a function

990
00:38:47,530 --> 00:38:54,130
and<font color="#E5E5E5"> invoke mimikatz</font><font color="#CCCCCC"> right</font><font color="#E5E5E5"> one of my</font>

991
00:38:49,570 --> 00:38:57,250
indicators is image<font color="#E5E5E5"> NT optional</font><font color="#CCCCCC"> hd60 for</font>

992
00:38:54,130 --> 00:38:59,350
magic right<font color="#E5E5E5"> okay that's a that we kind</font>

993
00:38:57,250 --> 00:39:01,120
of<font color="#E5E5E5"> need for that to work this is what it</font>

994
00:38:59,350 --> 00:39:02,799
looks like<font color="#CCCCCC"> for invoke obfuscation for</font>

995
00:39:01,120 --> 00:39:04,720
those in the back<font color="#CCCCCC"> or in the front they</font>

996
00:39:02,800 --> 00:39:07,260
can't see it<font color="#E5E5E5"> it's brackets with numbers</font>

997
00:39:04,720 --> 00:39:12,430
in it<font color="#CCCCCC"> its quotes</font><font color="#E5E5E5"> it's single quotes</font>

998
00:39:07,260 --> 00:39:16,210
double<font color="#E5E5E5"> quotes commas ampersands</font><font color="#CCCCCC"> and it</font>

999
00:39:12,430 --> 00:39:18,549
actually<font color="#E5E5E5"> gets worse because this</font>

1000
00:39:16,210 --> 00:39:19,840
obfuscation bypasses<font color="#E5E5E5"> antivirus because</font>

1001
00:39:18,550 --> 00:39:21,490
the antivirus doesn't even know what<font color="#E5E5E5"> it</font>

1002
00:39:19,840 --> 00:39:23,110
<font color="#CCCCCC">is it's looking for those strings</font><font color="#E5E5E5"> that</font>

1003
00:39:21,490 --> 00:39:24,700
it can't find<font color="#E5E5E5"> anymore</font><font color="#CCCCCC"> so the top one</font><font color="#E5E5E5"> is</font>

1004
00:39:23,110 --> 00:39:27,850
<font color="#CCCCCC">your standard invoke mimikatz</font>

1005
00:39:24,700 --> 00:39:29,259
the bottom one is an obfuscated version

1006
00:39:27,850 --> 00:39:31,390
of<font color="#CCCCCC"> mini cats that i just ran through</font>

1007
00:39:29,260 --> 00:39:35,490
invoke obfuscation<font color="#E5E5E5"> select the defaults</font>

1008
00:39:31,390 --> 00:39:35,490
<font color="#E5E5E5">and ran it once and it ran</font>

1009
00:39:36,390 --> 00:39:41,440
so then I decided<font color="#CCCCCC"> to get</font><font color="#E5E5E5"> creative</font><font color="#CCCCCC"> and</font>

1010
00:39:38,920 --> 00:39:43,330
I'm like what<font color="#CCCCCC"> about Power View</font><font color="#E5E5E5"> so I took</font>

1011
00:39:41,440 --> 00:39:45,310
<font color="#E5E5E5">Power View and ran it through invoke</font>

1012
00:39:43,330 --> 00:39:47,259
obfuscation<font color="#E5E5E5"> and I got this which</font><font color="#CCCCCC"> looks</font>

1013
00:39:45,310 --> 00:39:49,660
nothing like the<font color="#CCCCCC"> PowerShell code that</font>

1014
00:39:47,260 --> 00:39:52,090
will harm Joey<font color="#E5E5E5"> and then I ran it</font><font color="#CCCCCC"> through</font>

1015
00:39:49,660 --> 00:39:55,750
again<font color="#CCCCCC"> and it</font><font color="#E5E5E5"> looks</font><font color="#CCCCCC"> like</font><font color="#E5E5E5"> this and I I</font>

1016
00:39:52,090 --> 00:39:58,690
just<font color="#E5E5E5"> I'm not even sure what to do with</font>

1017
00:39:55,750 --> 00:40:00,730
<font color="#CCCCCC">this there's how many</font><font color="#E5E5E5"> lines of code</font><font color="#CCCCCC"> I</font>

1018
00:39:58,690 --> 00:40:01,570
mean will as<font color="#E5E5E5"> your coding</font><font color="#CCCCCC"> skills gotten</font>

1019
00:40:00,730 --> 00:40:04,360
<font color="#CCCCCC">that bad where you're just putting</font>

1020
00:40:01,570 --> 00:40:06,880
random<font color="#E5E5E5"> numbers and</font><font color="#CCCCCC"> brackets now I</font><font color="#E5E5E5"> don't</font>

1021
00:40:04,360 --> 00:40:10,180
<font color="#E5E5E5">even know like this is what happens when</font>

1022
00:40:06,880 --> 00:40:12,010
you have obfuscation<font color="#E5E5E5"> at a very high</font>

1023
00:40:10,180 --> 00:40:14,440
<font color="#E5E5E5">level against code that you normally</font>

1024
00:40:12,010 --> 00:40:17,110
<font color="#CCCCCC">would be able to</font><font color="#E5E5E5"> detect and find info</font>

1025
00:40:14,440 --> 00:40:19,510
confiscation removes comments it removes

1026
00:40:17,110 --> 00:40:21,280
white spaces<font color="#CCCCCC"> it removes</font><font color="#E5E5E5"> typical things</font>

1027
00:40:19,510 --> 00:40:23,950
that antivirus vendors are looking for

1028
00:40:21,280 --> 00:40:26,230
if you're<font color="#CCCCCC"> looking for</font><font color="#E5E5E5"> power sploit by</font>

1029
00:40:23,950 --> 00:40:29,980
looking<font color="#E5E5E5"> for at manifestation or at</font>

1030
00:40:26,230 --> 00:40:31,750
obscure<font color="#E5E5E5"> sec</font><font color="#CCCCCC"> it doesn't work</font><font color="#E5E5E5"> anymore so</font>

1031
00:40:29,980 --> 00:40:34,030
what can we<font color="#E5E5E5"> do is defenses how do we get</font>

1032
00:40:31,750 --> 00:40:36,310
our gang of velociraptors<font color="#E5E5E5"> lined up so we</font>

1033
00:40:34,030 --> 00:40:38,040
can<font color="#CCCCCC"> actually stop this</font><font color="#E5E5E5"> and and and</font><font color="#CCCCCC"> get</font>

1034
00:40:36,310 --> 00:40:40,540
ourselves in a good<font color="#E5E5E5"> place</font>

1035
00:40:38,040 --> 00:40:42,970
well<font color="#CCCCCC"> constrained PowerShell it's not a</font>

1036
00:40:40,540 --> 00:40:44,980
<font color="#E5E5E5">panacea we can deploy this just by</font>

1037
00:40:42,970 --> 00:40:48,009
<font color="#E5E5E5">setting a environmental variable and</font>

1038
00:40:44,980 --> 00:40:49,600
those initial<font color="#CCCCCC"> attack codes like</font><font color="#E5E5E5"> invoke</font>

1039
00:40:48,010 --> 00:40:51,610
anemic<font color="#CCCCCC"> ATS won't work we can use group</font>

1040
00:40:49,600 --> 00:40:52,870
policy<font color="#CCCCCC"> to</font><font color="#E5E5E5"> deploy this but it's not a</font>

1041
00:40:51,610 --> 00:40:54,280
panacea<font color="#E5E5E5"> it's not going to stop</font>

1042
00:40:52,870 --> 00:40:56,470
<font color="#E5E5E5">everything there's a way to get</font><font color="#CCCCCC"> around</font>

1043
00:40:54,280 --> 00:40:58,210
it<font color="#E5E5E5"> but in order for</font><font color="#CCCCCC"> someone to</font><font color="#E5E5E5"> get</font>

1044
00:40:56,470 --> 00:41:00,310
around<font color="#CCCCCC"> it they have</font><font color="#E5E5E5"> to actually remove</font>

1045
00:40:58,210 --> 00:41:01,600
the<font color="#CCCCCC"> constrained language mode and if</font>

1046
00:41:00,310 --> 00:41:03,549
we're deploying this<font color="#E5E5E5"> via group policy</font>

1047
00:41:01,600 --> 00:41:06,190
it's going to reapply<font color="#E5E5E5"> after</font><font color="#CCCCCC"> a</font><font color="#E5E5E5"> certain</font>

1048
00:41:03,550 --> 00:41:08,110
<font color="#E5E5E5">amount of time and</font><font color="#CCCCCC"> we know that this</font>

1049
00:41:06,190 --> 00:41:10,420
will stop a lot<font color="#CCCCCC"> of these more advanced</font>

1050
00:41:08,110 --> 00:41:13,630
attack tools not everything but quite a

1051
00:41:10,420 --> 00:41:15,460
<font color="#E5E5E5">bit so how do we find obfuscated evil</font>

1052
00:41:13,630 --> 00:41:17,590
and this<font color="#E5E5E5"> was like one</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> my big slides</font>

1053
00:41:15,460 --> 00:41:19,330
and it's tough<font color="#E5E5E5"> to see so I'm sorry about</font>

1054
00:41:17,590 --> 00:41:21,040
<font color="#E5E5E5">that</font><font color="#CCCCCC"> I was chatting</font><font color="#E5E5E5"> with</font><font color="#CCCCCC"> Lee Holmes</font>

1055
00:41:19,330 --> 00:41:24,670
earlier this week of the senior dev on

1056
00:41:21,040 --> 00:41:26,440
the PowerShell team and he said he's

1057
00:41:24,670 --> 00:41:27,670
been<font color="#CCCCCC"> looking at obfuscated PowerShell</font>

1058
00:41:26,440 --> 00:41:29,560
code for a while and<font color="#E5E5E5"> he has a script</font>

1059
00:41:27,670 --> 00:41:31,240
<font color="#CCCCCC">that looks at this the deviation</font>

1060
00:41:29,560 --> 00:41:34,060
standard<font color="#E5E5E5"> deviation to</font><font color="#CCCCCC"> distribution of</font>

1061
00:41:31,240 --> 00:41:35,950
characters and PowerShell code<font color="#E5E5E5"> so he</font>

1062
00:41:34,060 --> 00:41:38,230
pulled from Posche code about<font color="#E5E5E5"> 3,500</font>

1063
00:41:35,950 --> 00:41:41,020
<font color="#CCCCCC">PowerShell scripts ran this on them and</font>

1064
00:41:38,230 --> 00:41:43,510
looked for things that were unusual<font color="#CCCCCC"> so</font>

1065
00:41:41,020 --> 00:41:45,900
typically if everyone in here writes a

1066
00:41:43,510 --> 00:41:48,520
<font color="#CCCCCC">PowerShell script</font><font color="#E5E5E5"> you're gonna have</font>

1067
00:41:45,900 --> 00:41:49,180
<font color="#E5E5E5">different types of stuff that</font><font color="#CCCCCC"> people</font><font color="#E5E5E5"> are</font>

1068
00:41:48,520 --> 00:41:50,770
going<font color="#CCCCCC"> to do</font><font color="#E5E5E5"> different</font>

1069
00:41:49,180 --> 00:41:52,450
techniques but it's not<font color="#E5E5E5"> going to look</font>

1070
00:41:50,770 --> 00:41:54,670
like<font color="#CCCCCC"> a bunch</font><font color="#E5E5E5"> of characters like on the</font>

1071
00:41:52,450 --> 00:41:56,740
right side<font color="#E5E5E5"> which is highly obfuscated</font>

1072
00:41:54,670 --> 00:41:59,559
versus<font color="#E5E5E5"> letters on there on the left side</font>

1073
00:41:56,740 --> 00:42:01,299
and he also identified that<font color="#CCCCCC"> if you look</font>

1074
00:41:59,559 --> 00:42:03,520
at the entropy<font color="#E5E5E5"> of these characters in</font>

1075
00:42:01,300 --> 00:42:05,349
<font color="#E5E5E5">the distribution</font><font color="#CCCCCC"> the ones that are much</font>

1076
00:42:03,520 --> 00:42:07,630
more similar<font color="#E5E5E5"> are the ones that</font><font color="#CCCCCC"> are</font>

1077
00:42:05,349 --> 00:42:09,700
obfuscated so we have some<font color="#E5E5E5"> information</font>

1078
00:42:07,630 --> 00:42:12,250
<font color="#CCCCCC">to work off of</font><font color="#E5E5E5"> and so I put this</font>

1079
00:42:09,700 --> 00:42:15,640
together<font color="#E5E5E5"> deploy</font><font color="#CCCCCC"> powershell version 5 so</font>

1080
00:42:12,250 --> 00:42:18,760
we get script lock logging and look for

1081
00:42:15,640 --> 00:42:21,220
lots of<font color="#CCCCCC"> rackets figure</font><font color="#E5E5E5"> out work with</font>

1082
00:42:18,760 --> 00:42:22,869
your sim vendor work with<font color="#CCCCCC"> Splunk figure</font>

1083
00:42:21,220 --> 00:42:24,939
out how we can get that<font color="#CCCCCC"> so when our</font>

1084
00:42:22,869 --> 00:42:28,000
script lock log<font color="#E5E5E5"> gives us something crazy</font>

1085
00:42:24,940 --> 00:42:29,559
like<font color="#CCCCCC"> that it gets</font><font color="#E5E5E5"> flagged</font><font color="#CCCCCC"> I don't know</font>

1086
00:42:28,000 --> 00:42:32,619
about you but<font color="#CCCCCC"> I don't code like this</font>

1087
00:42:29,559 --> 00:42:35,589
I'm not data look for lots of<font color="#E5E5E5"> quotes</font>

1088
00:42:32,619 --> 00:42:36,940
single and double quotes<font color="#E5E5E5"> and ampersands</font>

1089
00:42:35,589 --> 00:42:38,440
and<font color="#E5E5E5"> other things that are unusual random</font>

1090
00:42:36,940 --> 00:42:40,540
function names are many<font color="#CCCCCC"> unusual</font>

1091
00:42:38,440 --> 00:42:42,760
characters<font color="#E5E5E5"> or just special characters</font>

1092
00:42:40,540 --> 00:42:45,190
<font color="#E5E5E5">because in this one where we're</font><font color="#CCCCCC"> looking</font>

1093
00:42:42,760 --> 00:42:48,190
here<font color="#E5E5E5"> the top one is is actually</font><font color="#CCCCCC"> a dollar</font>

1094
00:42:45,190 --> 00:42:51,069
sign the next<font color="#E5E5E5"> one is open curly brackets</font>

1095
00:42:48,190 --> 00:42:54,520
<font color="#E5E5E5">closed curly brackets</font><font color="#CCCCCC"> and pluses and</font>

1096
00:42:51,069 --> 00:42:55,900
equals<font color="#E5E5E5"> I don't code that way I'm not</font>

1097
00:42:54,520 --> 00:42:58,540
<font color="#CCCCCC">that great of a coder</font><font color="#E5E5E5"> but</font><font color="#CCCCCC"> I don't code</font>

1098
00:42:55,900 --> 00:43:00,549
that way<font color="#E5E5E5"> so this is my detection cheat</font>

1099
00:42:58,540 --> 00:43:02,140
sheet that<font color="#CCCCCC"> I put out before</font><font color="#E5E5E5"> and I've</font>

1100
00:43:00,549 --> 00:43:03,579
updated<font color="#E5E5E5"> with create delegate and hamster</font>

1101
00:43:02,140 --> 00:43:06,339
utils to detect some of<font color="#CCCCCC"> the things that</font>

1102
00:43:03,579 --> 00:43:08,200
Mac ravers been doing recently<font color="#E5E5E5"> this is a</font>

1103
00:43:06,339 --> 00:43:09,910
good foundation<font color="#E5E5E5"> this will detect the</font>

1104
00:43:08,200 --> 00:43:11,259
things that<font color="#CCCCCC"> people</font><font color="#E5E5E5"> are not highly</font>

1105
00:43:09,910 --> 00:43:12,759
obfuscating where they're<font color="#E5E5E5"> not just</font>

1106
00:43:11,260 --> 00:43:15,790
<font color="#E5E5E5">throwing things against it to see what</font>

1107
00:43:12,760 --> 00:43:17,619
they get so it's a good start<font color="#CCCCCC"> and we</font>

1108
00:43:15,790 --> 00:43:21,808
need to start we can't just throw up our

1109
00:43:17,619 --> 00:43:24,549
hands ago<font color="#E5E5E5"> I give up because that right</font>

1110
00:43:21,809 --> 00:43:27,280
we want to set up our layers of

1111
00:43:24,549 --> 00:43:30,220
<font color="#E5E5E5">Defense's we want to make sure</font><font color="#CCCCCC"> that what</font>

1112
00:43:27,280 --> 00:43:31,960
we're<font color="#CCCCCC"> doing has impact</font><font color="#E5E5E5"> any of</font><font color="#CCCCCC"> the</font><font color="#E5E5E5"> things</font>

1113
00:43:30,220 --> 00:43:34,359
<font color="#E5E5E5">that we're doing</font><font color="#CCCCCC"> to defend our</font>

1114
00:43:31,960 --> 00:43:36,819
environment to defend our network should

1115
00:43:34,359 --> 00:43:40,808
align to one of three<font color="#E5E5E5"> buckets detect</font>

1116
00:43:36,819 --> 00:43:43,299
<font color="#E5E5E5">what's going on mitigate it or block</font><font color="#CCCCCC"> it</font>

1117
00:43:40,809 --> 00:43:46,390
prevent it<font color="#E5E5E5"> so we should hit one</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> those</font>

1118
00:43:43,299 --> 00:43:48,280
three and I'm actually<font color="#E5E5E5"> an advocate for</font>

1119
00:43:46,390 --> 00:43:50,200
going for detect as much as<font color="#CCCCCC"> possible if</font>

1120
00:43:48,280 --> 00:43:52,270
we can detect there's obfuscated code

1121
00:43:50,200 --> 00:43:54,279
out<font color="#CCCCCC"> there</font><font color="#E5E5E5"> where it's being run what</font>

1122
00:43:52,270 --> 00:43:57,009
system it's being run<font color="#E5E5E5"> to me that's a</font>

1123
00:43:54,280 --> 00:43:58,630
much<font color="#CCCCCC"> more value than a lot of times</font>

1124
00:43:57,010 --> 00:43:59,940
blocking<font color="#E5E5E5"> that initial attack because</font>

1125
00:43:58,630 --> 00:44:01,710
then we get more information<font color="#E5E5E5"> about</font>

1126
00:43:59,940 --> 00:44:03,510
it's being done instead<font color="#E5E5E5"> of having a</font>

1127
00:44:01,710 --> 00:44:04,770
block never know<font color="#CCCCCC"> about</font><font color="#E5E5E5"> it and then they</font>

1128
00:44:03,510 --> 00:44:05,450
do<font color="#E5E5E5"> something else which we never</font><font color="#CCCCCC"> ever</font>

1129
00:44:04,770 --> 00:44:08,040
see

1130
00:44:05,450 --> 00:44:10,140
so get<font color="#E5E5E5"> PowerShell</font><font color="#CCCCCC"> to a new</font><font color="#E5E5E5"> modern</font>

1131
00:44:08,040 --> 00:44:11,850
version like PowerShell<font color="#E5E5E5"> 5 there are some</font>

1132
00:44:10,140 --> 00:44:13,339
caveats with it there's some application

1133
00:44:11,850 --> 00:44:15,960
and compatibility<font color="#E5E5E5"> so be aware of that</font>

1134
00:44:13,340 --> 00:44:17,940
get those<font color="#E5E5E5"> logs is your central logging</font>

1135
00:44:15,960 --> 00:44:19,980
system pull them<font color="#E5E5E5"> from your workstations</font>

1136
00:44:17,940 --> 00:44:22,020
your servers<font color="#E5E5E5"> your domain</font><font color="#CCCCCC"> controllers</font>

1137
00:44:19,980 --> 00:44:24,870
know what and how PowerShell is being

1138
00:44:22,020 --> 00:44:27,140
used<font color="#E5E5E5"> use</font><font color="#CCCCCC"> Windows</font><font color="#E5E5E5"> event forwarding</font><font color="#CCCCCC"> it</font>

1139
00:44:24,870 --> 00:44:30,000
works very well in<font color="#E5E5E5"> large organizations</font>

1140
00:44:27,140 --> 00:44:32,009
identify<font color="#CCCCCC"> your PowerShell usage you can</font>

1141
00:44:30,000 --> 00:44:33,900
<font color="#E5E5E5">use SCCM software metering or something</font>

1142
00:44:32,010 --> 00:44:35,640
like that<font color="#E5E5E5"> see who's spawning PowerShell</font>

1143
00:44:33,900 --> 00:44:37,800
<font color="#CCCCCC">dot exe is still very</font><font color="#E5E5E5"> much being used</font>

1144
00:44:35,640 --> 00:44:40,379
today<font color="#E5E5E5"> and you can leverage constrain</font>

1145
00:44:37,800 --> 00:44:41,730
language mode where possible<font color="#CCCCCC"> great place</font>

1146
00:44:40,380 --> 00:44:43,110
<font color="#CCCCCC">for this</font><font color="#E5E5E5"> is on shared servers like</font>

1147
00:44:41,730 --> 00:44:45,690
terminal servers there's no reason for

1148
00:44:43,110 --> 00:44:47,790
<font color="#E5E5E5">users to be running PowerShell doing</font>

1149
00:44:45,690 --> 00:44:50,610
special advanced functions like calling

1150
00:44:47,790 --> 00:44:52,529
the<font color="#CCCCCC"> Windows API</font><font color="#E5E5E5"> so this one's a little</font>

1151
00:44:50,610 --> 00:44:54,350
tricky code sign your<font color="#E5E5E5"> PowerShell scripts</font>

1152
00:44:52,530 --> 00:44:56,700
that<font color="#E5E5E5"> you're using</font><font color="#CCCCCC"> for administration if</font>

1153
00:44:54,350 --> 00:44:58,350
you're using PowerShell scripts for<font color="#E5E5E5"> a</font>

1154
00:44:56,700 --> 00:45:00,540
scheduled<font color="#CCCCCC"> task and you're not code</font>

1155
00:44:58,350 --> 00:45:03,270
<font color="#E5E5E5">signing it how do you know it hasn't</font>

1156
00:45:00,540 --> 00:45:04,860
been<font color="#E5E5E5"> modified how do you know that</font>

1157
00:45:03,270 --> 00:45:06,930
<font color="#E5E5E5">someone hasn't snuck something else in</font>

1158
00:45:04,860 --> 00:45:08,490
there how how often<font color="#CCCCCC"> do you check</font><font color="#E5E5E5"> these</font>

1159
00:45:06,930 --> 00:45:10,049
scripts<font color="#E5E5E5"> how often do you validate them</font>

1160
00:45:08,490 --> 00:45:12,060
you have them all over<font color="#CCCCCC"> the place right</font>

1161
00:45:10,050 --> 00:45:14,990
<font color="#E5E5E5">we all do we write a script</font><font color="#CCCCCC"> that works</font>

1162
00:45:12,060 --> 00:45:17,610
<font color="#E5E5E5">great scheduled tasks it runs over here</font>

1163
00:45:14,990 --> 00:45:20,910
but that's<font color="#E5E5E5"> a</font><font color="#CCCCCC"> perfect persistence method</font>

1164
00:45:17,610 --> 00:45:22,380
for an attacker<font color="#E5E5E5"> and</font><font color="#CCCCCC"> of course we need to</font>

1165
00:45:20,910 --> 00:45:24,870
limit<font color="#E5E5E5"> our admin rights we want to make</font>

1166
00:45:22,380 --> 00:45:28,530
sure<font color="#CCCCCC"> that we're boiling it down to just</font>

1167
00:45:24,870 --> 00:45:29,970
<font color="#E5E5E5">this much and no more</font><font color="#CCCCCC"> and please reach</font>

1168
00:45:28,530 --> 00:45:33,150
<font color="#E5E5E5">out to your antivirus</font><font color="#CCCCCC"> or anti-malware</font>

1169
00:45:29,970 --> 00:45:34,770
your anti bad code<font color="#E5E5E5"> vendor and ask them</font>

1170
00:45:33,150 --> 00:45:36,870
when they're going<font color="#CCCCCC"> to</font><font color="#E5E5E5"> support a</font><font color="#CCCCCC"> msi on</font>

1171
00:45:34,770 --> 00:45:39,720
Windows 10<font color="#E5E5E5"> because you want that</font><font color="#CCCCCC"> I think</font>

1172
00:45:36,870 --> 00:45:44,460
we all<font color="#E5E5E5"> want that block</font><font color="#CCCCCC"> Microsoft Office</font>

1173
00:45:39,720 --> 00:45:47,910
macros in 2016 there's an option in the

1174
00:45:44,460 --> 00:45:49,560
GPO to block<font color="#E5E5E5"> all macros in files that</font>

1175
00:45:47,910 --> 00:45:52,440
<font color="#CCCCCC">originate from the</font><font color="#E5E5E5"> internet that'll</font>

1176
00:45:49,560 --> 00:45:54,420
solve<font color="#E5E5E5"> 99% plus of your problems and you</font>

1177
00:45:52,440 --> 00:45:57,180
shouldn't have<font color="#E5E5E5"> too much user outrage</font>

1178
00:45:54,420 --> 00:45:58,950
<font color="#E5E5E5">about that if at all possible digitally</font>

1179
00:45:57,180 --> 00:46:00,359
signed any<font color="#E5E5E5"> macros I don't get into</font>

1180
00:45:58,950 --> 00:46:02,009
macros here<font color="#E5E5E5"> there's an appendix to the</font>

1181
00:46:00,360 --> 00:46:03,510
end of the the slide deck because I

1182
00:46:02,010 --> 00:46:05,850
<font color="#E5E5E5">couldn't get to</font><font color="#CCCCCC"> it</font>

1183
00:46:03,510 --> 00:46:09,180
the other thing is<font color="#CCCCCC"> oh le packager</font><font color="#E5E5E5"> is</font>

1184
00:46:05,850 --> 00:46:12,150
used by attackers<font color="#E5E5E5"> to embed code to</font><font color="#CCCCCC"> embed</font>

1185
00:46:09,180 --> 00:46:13,618
<font color="#E5E5E5">an attachment into an email so that when</font>

1186
00:46:12,150 --> 00:46:15,960
the<font color="#E5E5E5"> user runs it runs code</font>

1187
00:46:13,619 --> 00:46:17,490
even if macros are blocked<font color="#CCCCCC"> will and I</font>

1188
00:46:15,960 --> 00:46:19,920
spoke<font color="#CCCCCC"> about</font><font color="#E5E5E5"> this</font><font color="#CCCCCC"> in</font><font color="#E5E5E5"> showed a demo at</font>

1189
00:46:17,490 --> 00:46:22,109
Derby con<font color="#E5E5E5"> and actually did a post on</font><font color="#CCCCCC"> ad</font>

1190
00:46:19,920 --> 00:46:24,630
security yesterday about<font color="#E5E5E5"> how to lock all</font>

1191
00:46:22,109 --> 00:46:26,308
this down<font color="#CCCCCC"> on</font><font color="#E5E5E5"> Windows workstations and</font>

1192
00:46:24,630 --> 00:46:28,200
<font color="#CCCCCC">certainly look at application</font>

1193
00:46:26,309 --> 00:46:30,450
whitelisting<font color="#CCCCCC"> figure</font><font color="#E5E5E5"> out how to control</font>

1194
00:46:28,200 --> 00:46:32,939
<font color="#E5E5E5">your executables your</font><font color="#CCCCCC"> DLLs</font><font color="#E5E5E5"> what's being</font>

1195
00:46:30,450 --> 00:46:36,029
run<font color="#CCCCCC"> in your systems because yeah it's</font>

1196
00:46:32,940 --> 00:46:38,009
great to control<font color="#CCCCCC"> PowerShell but not if</font>

1197
00:46:36,029 --> 00:46:41,039
anyone can download any<font color="#E5E5E5"> executable and</font>

1198
00:46:38,009 --> 00:46:43,109
run it<font color="#E5E5E5"> on any system they want and at</font>

1199
00:46:41,039 --> 00:46:45,079
least what we can do is deploy AppLocker

1200
00:46:43,109 --> 00:46:48,180
most organizations pretty much own it

1201
00:46:45,079 --> 00:46:50,549
deploy AppLocker and blacklist<font color="#CCCCCC"> those</font>

1202
00:46:48,180 --> 00:46:52,859
home directory profile pass<font color="#CCCCCC"> see user</font>

1203
00:46:50,549 --> 00:46:54,450
<font color="#CCCCCC">locations so the users can't run</font><font color="#E5E5E5"> execute</font>

1204
00:46:52,859 --> 00:46:55,819
<font color="#CCCCCC">or content</font><font color="#E5E5E5"> that they just download that</font>

1205
00:46:54,450 --> 00:46:59,460
<font color="#CCCCCC">are there</font>

1206
00:46:55,819 --> 00:47:00,690
so in summary what's good<font color="#E5E5E5"> for the admin</font>

1207
00:46:59,460 --> 00:47:03,240
<font color="#E5E5E5">is great for the attacker</font>

1208
00:47:00,690 --> 00:47:04,920
we know that PowerShell can be leveraged

1209
00:47:03,240 --> 00:47:07,499
from outside<font color="#CCCCCC"> of the standard powershell</font>

1210
00:47:04,920 --> 00:47:08,759
executables<font color="#CCCCCC"> and securing that isn't</font>

1211
00:47:07,499 --> 00:47:12,660
<font color="#CCCCCC">straightforward I mean that's a lot of</font>

1212
00:47:08,759 --> 00:47:14,059
<font color="#E5E5E5">stuff right invoke obfuscation</font><font color="#CCCCCC"> I mean I</font>

1213
00:47:12,660 --> 00:47:16,499
don't have<font color="#E5E5E5"> a good answer</font><font color="#CCCCCC"> for today but</font>

1214
00:47:14,059 --> 00:47:18,390
<font color="#E5E5E5">that's how this</font><font color="#CCCCCC"> industry works</font><font color="#E5E5E5"> that was</font>

1215
00:47:16,499 --> 00:47:19,980
released last<font color="#E5E5E5"> month</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> Daniel said that</font>

1216
00:47:18,390 --> 00:47:23,308
there's attackers using some of<font color="#E5E5E5"> those</font>

1217
00:47:19,980 --> 00:47:24,599
techniques<font color="#E5E5E5"> already so we need logging we</font>

1218
00:47:23,309 --> 00:47:25,769
need<font color="#E5E5E5"> visibility we need to better</font>

1219
00:47:24,599 --> 00:47:28,039
understand what's going<font color="#E5E5E5"> on in</font>

1220
00:47:25,769 --> 00:47:30,749
organizations how tools are being<font color="#E5E5E5"> used</font>

1221
00:47:28,039 --> 00:47:34,650
<font color="#E5E5E5">and we should look at version 5 to be</font>

1222
00:47:30,749 --> 00:47:36,808
that new baseline because<font color="#CCCCCC"> attackers</font>

1223
00:47:34,650 --> 00:47:38,249
<font color="#E5E5E5">using more than</font><font color="#CCCCCC"> PowerShell so look at</font>

1224
00:47:36,809 --> 00:47:40,170
PowerShell but make<font color="#CCCCCC"> sure your visibility</font>

1225
00:47:38,249 --> 00:47:41,038
covers the whole gamut<font color="#CCCCCC"> if you have Mac's</font>

1226
00:47:40,170 --> 00:47:42,900
in your environment

1227
00:47:41,039 --> 00:47:45,059
guess what<font color="#CCCCCC"> Python has no logging</font>

1228
00:47:42,900 --> 00:47:48,210
whatsoever<font color="#E5E5E5"> there is</font><font color="#CCCCCC"> no constraint</font><font color="#E5E5E5"> log</font>

1229
00:47:45,059 --> 00:47:54,119
logging<font color="#CCCCCC"> mode for Python is Python</font>

1230
00:47:48,210 --> 00:47:55,799
installed on every<font color="#E5E5E5"> Mac yes so you need</font>

1231
00:47:54,119 --> 00:47:58,079
to layer<font color="#E5E5E5"> your defenses know what's going</font>

1232
00:47:55,799 --> 00:48:00,089
on understand what's out there<font color="#E5E5E5"> and</font><font color="#CCCCCC"> the</font>

1233
00:47:58,079 --> 00:48:02,069
slides like I said will<font color="#CCCCCC"> be or actually</font>

1234
00:48:00,089 --> 00:48:05,308
there right now on presentations<font color="#CCCCCC"> at 80</font>

1235
00:48:02,069 --> 00:48:07,140
<font color="#CCCCCC">Security org and thank you very</font><font color="#E5E5E5"> much</font>

1236
00:48:05,309 --> 00:48:10,739
<font color="#CCCCCC">thank</font><font color="#E5E5E5"> you Ben Thank You Carlos Thank You</font>

1237
00:48:07,140 --> 00:48:15,060
Daniel Jared<font color="#CCCCCC"> Jeffery</font><font color="#E5E5E5"> Justin</font><font color="#CCCCCC"> Lili Matt</font>

1238
00:48:10,739 --> 00:48:17,010
Matt Matthew<font color="#CCCCCC"> we'll thank you very much</font>

1239
00:48:15,060 --> 00:48:19,370
that's been my time thank you<font color="#CCCCCC"> so much</font>

1240
00:48:17,010 --> 00:48:19,370
for yours

