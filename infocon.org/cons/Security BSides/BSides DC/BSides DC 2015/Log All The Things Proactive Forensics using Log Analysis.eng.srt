1
00:00:03,200 --> 00:00:06,160
hey good afternoon everyone

2
00:00:06,160 --> 00:00:08,080
everyone hear me okay

3
00:00:08,080 --> 00:00:10,480
cool uh thanks for coming to our talk uh

4
00:00:10,480 --> 00:00:13,040
my name is kyle salaz

5
00:00:13,040 --> 00:00:15,440
and i'm aaron buring and i just have to

6
00:00:15,440 --> 00:00:17,520
say if i seem a little bit nervous today

7
00:00:17,520 --> 00:00:19,119
it's because this is the first time i've

8
00:00:19,119 --> 00:00:20,400
ever presented in front of my

9
00:00:20,400 --> 00:00:22,640
seven-year-old daughter so she has

10
00:00:22,640 --> 00:00:24,080
promised me that she would make at least

11
00:00:24,080 --> 00:00:25,519
two funny faces at me though so that

12
00:00:25,519 --> 00:00:27,359
should break the ice so it'll be all

13
00:00:27,359 --> 00:00:29,279
right

14
00:00:29,279 --> 00:00:31,760
all right uh so real quick we're going

15
00:00:31,760 --> 00:00:33,040
to talk about a lot of stuff pertaining

16
00:00:33,040 --> 00:00:34,559
to collecting logs from endpoints in the

17
00:00:34,559 --> 00:00:36,800
network and if you hear uh some things

18
00:00:36,800 --> 00:00:37,920
that you don't recognize or you don't

19
00:00:37,920 --> 00:00:39,280
understand why we did some certain

20
00:00:39,280 --> 00:00:40,960
things or turned on some certain things

21
00:00:40,960 --> 00:00:42,800
we've done a couple of talks for uh

22
00:00:42,800 --> 00:00:45,040
shmukon and then in mir khan which is i

23
00:00:45,040 --> 00:00:47,440
think firecon or something this year

24
00:00:47,440 --> 00:00:48,879
and then we've uh we've gotten an

25
00:00:48,879 --> 00:00:51,120
article in ieee so take a look at those

26
00:00:51,120 --> 00:00:52,320
and i'll give you some background into

27
00:00:52,320 --> 00:00:54,000
why we did some things with immediate

28
00:00:54,000 --> 00:00:56,719
app locker and host-based firewalls

29
00:00:56,719 --> 00:00:58,879
so the point of of our talk today is to

30
00:00:58,879 --> 00:01:01,120
kind of go over the our our last two

31
00:01:01,120 --> 00:01:02,079
years with

32
00:01:02,079 --> 00:01:04,159
deploying sims or simin in our

33
00:01:04,159 --> 00:01:05,360
environment and how we went about

34
00:01:05,360 --> 00:01:07,119
collecting logs uh

35
00:01:07,119 --> 00:01:09,119
some very obvious goals here implement a

36
00:01:09,119 --> 00:01:11,360
sim uh collect logs from what matters

37
00:01:11,360 --> 00:01:13,439
not from everything and do it within

38
00:01:13,439 --> 00:01:15,520
budget anyone here that's ever tried to

39
00:01:15,520 --> 00:01:17,439
spec out a sim uh they're really really

40
00:01:17,439 --> 00:01:18,960
expensive

41
00:01:18,960 --> 00:01:20,640
and actually make use of it we don't

42
00:01:20,640 --> 00:01:22,479
want to treat this like an ips sensor

43
00:01:22,479 --> 00:01:24,240
where you just buy it and then

44
00:01:24,240 --> 00:01:27,040
no one knows what to do with that

45
00:01:27,040 --> 00:01:29,600
so if you do cyber security operations

46
00:01:29,600 --> 00:01:31,520
uh you will likely have to deal with

47
00:01:31,520 --> 00:01:33,360
phishing emails it's still the most

48
00:01:33,360 --> 00:01:35,280
prominent attack vector

49
00:01:35,280 --> 00:01:37,759
uh for compromising end hosts this is

50
00:01:37,759 --> 00:01:39,759
one that came across our networks i'd

51
00:01:39,759 --> 00:01:42,000
say in september and it's a you know

52
00:01:42,000 --> 00:01:44,000
it's a receipt for some payment that the

53
00:01:44,000 --> 00:01:46,640
user supposedly uh you know some

54
00:01:46,640 --> 00:01:48,560
transaction that the user had done in

55
00:01:48,560 --> 00:01:51,119
the past and it's a it's a word document

56
00:01:51,119 --> 00:01:52,720
uh but the user doesn't know that the

57
00:01:52,720 --> 00:01:55,360
word document has

58
00:01:55,360 --> 00:01:57,040
embedded macros it calls on a script

59
00:01:57,040 --> 00:01:58,399
that drops a

60
00:01:58,399 --> 00:02:00,399
an exe that then makes a connection out

61
00:02:00,399 --> 00:02:01,759
and starts encrypting their entire

62
00:02:01,759 --> 00:02:03,600
profile so this is pretty standard stuff

63
00:02:03,600 --> 00:02:05,920
our goal eventually after doing the

64
00:02:05,920 --> 00:02:07,759
basics was to figure out how we can log

65
00:02:07,759 --> 00:02:08,878
this stuff

66
00:02:08,878 --> 00:02:10,560
and then proactively alert on it and

67
00:02:10,560 --> 00:02:12,160
then search the entire enterprise for

68
00:02:12,160 --> 00:02:13,760
artifacts from something like this

69
00:02:13,760 --> 00:02:15,200
because this is the most common attack

70
00:02:15,200 --> 00:02:16,319
vector

71
00:02:16,319 --> 00:02:18,800
or at least the scariest in terms of

72
00:02:18,800 --> 00:02:21,200
how apt starts

73
00:02:21,200 --> 00:02:23,200
so the the point of this talk is if you

74
00:02:23,200 --> 00:02:25,440
listen to your logs uh they'll have some

75
00:02:25,440 --> 00:02:28,080
great things to tell you

76
00:02:28,080 --> 00:02:30,160
uh i'm gonna go through some basics if

77
00:02:30,160 --> 00:02:31,840
it bores you uh bear with me we'll get

78
00:02:31,840 --> 00:02:33,040
to some of the more interesting stuff

79
00:02:33,040 --> 00:02:35,680
that we did so we had a demo period we

80
00:02:35,680 --> 00:02:37,519
evaluated a couple of sims i know it's

81
00:02:37,519 --> 00:02:40,160
hard to do a demo sometimes you just

82
00:02:40,160 --> 00:02:41,599
want to pick something look at the magic

83
00:02:41,599 --> 00:02:42,800
quad and be like all right we're going

84
00:02:42,800 --> 00:02:44,640
with vendor a because they're all the

85
00:02:44,640 --> 00:02:45,680
way up here

86
00:02:45,680 --> 00:02:46,720
uh

87
00:02:46,720 --> 00:02:48,239
obviously you want to create your own

88
00:02:48,239 --> 00:02:49,920
requirements and then make sure that you

89
00:02:49,920 --> 00:02:51,680
don't exceed your budget

90
00:02:51,680 --> 00:02:53,280
and then you want to document everything

91
00:02:53,280 --> 00:02:54,720
uh and then you want to send a

92
00:02:54,720 --> 00:02:55,920
requirements document out to some

93
00:02:55,920 --> 00:02:57,840
vendors the usu the reason i say this is

94
00:02:57,840 --> 00:02:59,440
because some vendors will if you send

95
00:02:59,440 --> 00:03:00,959
them a requirements document they'll

96
00:03:00,959 --> 00:03:02,959
usually the marketing guys will

97
00:03:02,959 --> 00:03:04,319
answer everything like yeah we do

98
00:03:04,319 --> 00:03:06,319
everything uh guess what when you buy it

99
00:03:06,319 --> 00:03:07,599
and you have that document with their

100
00:03:07,599 --> 00:03:09,519
responses you can come back and say you

101
00:03:09,519 --> 00:03:11,519
don't do this or you don't do this well

102
00:03:11,519 --> 00:03:13,120
but you said you did so you could you

103
00:03:13,120 --> 00:03:14,319
have some leverage with the product

104
00:03:14,319 --> 00:03:16,480
development team come back and have them

105
00:03:16,480 --> 00:03:18,720
uh build some more uh

106
00:03:18,720 --> 00:03:20,000
some more features that you actually

107
00:03:20,000 --> 00:03:22,239
want uh that stuff is really expensive

108
00:03:22,239 --> 00:03:23,599
if you want to hire consultants to do

109
00:03:23,599 --> 00:03:25,519
that especially for the more higher end

110
00:03:25,519 --> 00:03:27,280
uh sims

111
00:03:27,280 --> 00:03:29,120
so let's go through the steps uh step

112
00:03:29,120 --> 00:03:31,040
one you want to configure logging

113
00:03:31,040 --> 00:03:33,280
obviously figure out what log sources

114
00:03:33,280 --> 00:03:35,120
you want to log from and only pick the

115
00:03:35,120 --> 00:03:37,200
events that you want to parse out don't

116
00:03:37,200 --> 00:03:39,040
just send everything

117
00:03:39,040 --> 00:03:40,239
we're going to go through the order of

118
00:03:40,239 --> 00:03:41,920
what we did in terms of what we picked

119
00:03:41,920 --> 00:03:43,120
out first and

120
00:03:43,120 --> 00:03:45,040
and it was more of a methodical approach

121
00:03:45,040 --> 00:03:46,480
i know it's kind of counterintuitive to

122
00:03:46,480 --> 00:03:47,920
say i'm just going to send my firewall

123
00:03:47,920 --> 00:03:49,840
logs to this you know half a million

124
00:03:49,840 --> 00:03:51,680
dollar product that i just bought but

125
00:03:51,680 --> 00:03:53,760
actually try to do that and then figure

126
00:03:53,760 --> 00:03:54,959
out how that

127
00:03:54,959 --> 00:03:56,720
how that works with with the sim

128
00:03:56,720 --> 00:03:57,840
sometimes

129
00:03:57,840 --> 00:03:59,599
you run into parsing issues run into

130
00:03:59,599 --> 00:04:00,879
timing issues and we'll get through some

131
00:04:00,879 --> 00:04:03,120
of those uh the other important thing

132
00:04:03,120 --> 00:04:04,560
that we ran into this is that you will

133
00:04:04,560 --> 00:04:06,959
have performance issues with some of the

134
00:04:06,959 --> 00:04:08,640
some of the log sources the devices that

135
00:04:08,640 --> 00:04:10,480
you turn logging on

136
00:04:10,480 --> 00:04:11,920
for instance

137
00:04:11,920 --> 00:04:14,799
switch acls if you ever turn those on

138
00:04:14,799 --> 00:04:16,959
because you have all these acls that you

139
00:04:16,959 --> 00:04:18,478
want a lot you want to see what what

140
00:04:18,478 --> 00:04:19,680
kind of traffic's reversing your network

141
00:04:19,680 --> 00:04:21,199
that'll if the switch is a little bit

142
00:04:21,199 --> 00:04:22,880
smaller it'll bring down your switch so

143
00:04:22,880 --> 00:04:24,880
that's some of the the things we kind of

144
00:04:24,880 --> 00:04:26,800
ran into

145
00:04:26,800 --> 00:04:28,639
the second step is actually figuring out

146
00:04:28,639 --> 00:04:30,560
what you're going to send to your sim

147
00:04:30,560 --> 00:04:33,360
uh we this is in the list of what we did

148
00:04:33,360 --> 00:04:35,199
we started with perimeter firewalls ips

149
00:04:35,199 --> 00:04:37,040
sensors that's an obvious one sim

150
00:04:37,040 --> 00:04:38,960
vendors really do a good job picking up

151
00:04:38,960 --> 00:04:41,120
on the common events that those those

152
00:04:41,120 --> 00:04:43,440
lock sources generate domain controllers

153
00:04:43,440 --> 00:04:45,600
for obvious reasons you want failed

154
00:04:45,600 --> 00:04:47,600
logins you want domain admin logins you

155
00:04:47,600 --> 00:04:48,400
want

156
00:04:48,400 --> 00:04:50,240
any really any login and there are a lot

157
00:04:50,240 --> 00:04:52,320
of rules built in for that

158
00:04:52,320 --> 00:04:54,800
uh web and database servers we haven't

159
00:04:54,800 --> 00:04:56,720
done much with database servers there's

160
00:04:56,720 --> 00:04:59,840
it's kind of a tricky uh it's a tricky

161
00:04:59,840 --> 00:05:02,960
device to log or or entity to log but we

162
00:05:02,960 --> 00:05:04,400
we have done a lot with web servers and

163
00:05:04,400 --> 00:05:05,680
there's a lot of good logging there that

164
00:05:05,680 --> 00:05:07,039
we'll get into

165
00:05:07,039 --> 00:05:10,000
uh load balancers and proxy devices uh

166
00:05:10,000 --> 00:05:11,919
proxy devices are

167
00:05:11,919 --> 00:05:14,080
are amazing if you have an inline proxy

168
00:05:14,080 --> 00:05:16,560
and if you're doing ssl decryption there

169
00:05:16,560 --> 00:05:18,160
are a lot of great logs that you can get

170
00:05:18,160 --> 00:05:19,280
out of that and then all the

171
00:05:19,280 --> 00:05:21,840
infrastructure stuff rsa servers vpn

172
00:05:21,840 --> 00:05:22,960
devices

173
00:05:22,960 --> 00:05:24,720
uh the one the bullet point before the

174
00:05:24,720 --> 00:05:27,360
last talks about netflows jflows partial

175
00:05:27,360 --> 00:05:29,199
packet captures full packet captures if

176
00:05:29,199 --> 00:05:31,440
you have a gazillion dollars uh you can

177
00:05:31,440 --> 00:05:33,039
feed a lot of that stuff into your sim

178
00:05:33,039 --> 00:05:34,960
and it it kind of augments your log

179
00:05:34,960 --> 00:05:37,680
sources so it acts as like a like a

180
00:05:37,680 --> 00:05:40,960
crude dlp or even an ids really

181
00:05:40,960 --> 00:05:42,800
and then the last bullet is client logs

182
00:05:42,800 --> 00:05:44,160
and and that's what aaron's going to

183
00:05:44,160 --> 00:05:46,400
cover in the second half of this talk

184
00:05:46,400 --> 00:05:47,919
and that's kind of where we did a lot of

185
00:05:47,919 --> 00:05:49,600
the custom stuff and and that's where we

186
00:05:49,600 --> 00:05:51,600
want to lean in on the vendors

187
00:05:51,600 --> 00:05:53,280
the sim vendors and the product vendors

188
00:05:53,280 --> 00:05:54,720
to kind of do better there because it's

189
00:05:54,720 --> 00:05:57,360
severely lacking in that area

190
00:05:57,360 --> 00:05:58,960
the final step is

191
00:05:58,960 --> 00:06:01,039
actually looking at the payload as it

192
00:06:01,039 --> 00:06:02,880
gets parsed out in your sim

193
00:06:02,880 --> 00:06:03,759
so

194
00:06:03,759 --> 00:06:05,199
there are multiple

195
00:06:05,199 --> 00:06:07,600
event timestamps that could be labeled

196
00:06:07,600 --> 00:06:10,560
or thrown at a payload and uh half the

197
00:06:10,560 --> 00:06:12,400
time those things aren't uh get

198
00:06:12,400 --> 00:06:14,160
co-mangled like the event time versus

199
00:06:14,160 --> 00:06:16,080
the storage time versus the start time

200
00:06:16,080 --> 00:06:19,120
uh most most host-based firewall logs

201
00:06:19,120 --> 00:06:20,960
don't sim vendors don't do a good job

202
00:06:20,960 --> 00:06:23,680
parsing out those logs

203
00:06:23,680 --> 00:06:26,400
also look at if the entire payload is

204
00:06:26,400 --> 00:06:28,160
arriving so

205
00:06:28,160 --> 00:06:29,680
we've had this with our proxy locks

206
00:06:29,680 --> 00:06:31,360
where the law the payload is literally

207
00:06:31,360 --> 00:06:33,840
too big and it just gets truncated so if

208
00:06:33,840 --> 00:06:36,319
you have like a url at the top that's

209
00:06:36,319 --> 00:06:38,639
really long urls can get really long and

210
00:06:38,639 --> 00:06:40,880
then the source ip and the username or

211
00:06:40,880 --> 00:06:42,400
beyond that then you don't get to see

212
00:06:42,400 --> 00:06:44,160
that so that's just something to pay

213
00:06:44,160 --> 00:06:46,639
attention to and then figure out if

214
00:06:46,639 --> 00:06:47,919
things are actually getting mapped to

215
00:06:47,919 --> 00:06:50,400
global categories uh

216
00:06:50,400 --> 00:06:52,400
you know they're they're native uh

217
00:06:52,400 --> 00:06:54,720
mappings in every product and and those

218
00:06:54,720 --> 00:06:56,479
things don't always translate well so

219
00:06:56,479 --> 00:06:58,240
depending on what you're sending there

220
00:06:58,240 --> 00:06:59,520
you want to make sure that like a

221
00:06:59,520 --> 00:07:00,880
username is getting mapped to the global

222
00:07:00,880 --> 00:07:03,599
username that makes a difference because

223
00:07:03,599 --> 00:07:05,199
if it's not then if you have a domain

224
00:07:05,199 --> 00:07:06,720
controller and a firewall they both have

225
00:07:06,720 --> 00:07:09,120
a username field and that category isn't

226
00:07:09,120 --> 00:07:10,479
happening then the rules won't work

227
00:07:10,479 --> 00:07:12,319
because the username doesn't translate

228
00:07:12,319 --> 00:07:14,639
for the firewall logs

229
00:07:14,639 --> 00:07:16,880
quick note on ntp uh just point

230
00:07:16,880 --> 00:07:19,120
everything to one log source if you can

231
00:07:19,120 --> 00:07:21,039
uh it's for obvious reasons you don't

232
00:07:21,039 --> 00:07:22,240
want to have

233
00:07:22,240 --> 00:07:24,319
uh an issue where you have

234
00:07:24,319 --> 00:07:26,639
dhcp logs and let's say firewall logs

235
00:07:26,639 --> 00:07:28,639
that are two minutes ahead somehow your

236
00:07:28,639 --> 00:07:30,479
client made http connections before you

237
00:07:30,479 --> 00:07:32,319
got a dhcp lease that is going to mess

238
00:07:32,319 --> 00:07:33,520
with your um

239
00:07:33,520 --> 00:07:35,199
your correlation engine

240
00:07:35,199 --> 00:07:37,520
so and you're not able to actually do

241
00:07:37,520 --> 00:07:39,280
anything forensically

242
00:07:39,280 --> 00:07:41,599
if you if you have uh log sources that

243
00:07:41,599 --> 00:07:43,039
are desperate in time so that's just

244
00:07:43,039 --> 00:07:45,360
something to pay attention to

245
00:07:45,360 --> 00:07:47,039
and then if you have chatty applications

246
00:07:47,039 --> 00:07:49,199
that you know send a million packets of

247
00:07:49,199 --> 00:07:51,360
requests within a second it gets really

248
00:07:51,360 --> 00:07:55,639
hard if if the timing's off

249
00:08:00,879 --> 00:08:02,160
absolutely yeah

250
00:08:02,160 --> 00:08:03,440
and that completely depends on the

251
00:08:03,440 --> 00:08:05,919
application

252
00:08:06,000 --> 00:08:08,319
oh he said the depth of the time whether

253
00:08:08,319 --> 00:08:10,639
it's milliseconds or actual seconds that

254
00:08:10,639 --> 00:08:12,879
makes a difference uh how how granular

255
00:08:12,879 --> 00:08:15,199
your your your setting your ntp settings

256
00:08:15,199 --> 00:08:15,919
but

257
00:08:15,919 --> 00:08:17,599
we'll get a little bit more into timing

258
00:08:17,599 --> 00:08:19,759
when it comes to some of the other logs

259
00:08:19,759 --> 00:08:21,759
uh if you do all this you and your logs

260
00:08:21,759 --> 00:08:22,879
will start painting a really pretty

261
00:08:22,879 --> 00:08:24,840
picture

262
00:08:24,840 --> 00:08:27,039
hopefully so let's get into some of the

263
00:08:27,039 --> 00:08:28,800
network logs that we've done uh proxy

264
00:08:28,800 --> 00:08:30,879
logs we mentioned this is a huge

265
00:08:30,879 --> 00:08:32,719
uh advantage if you can get this parsed

266
00:08:32,719 --> 00:08:34,240
out so i wouldn't worry about system

267
00:08:34,240 --> 00:08:36,159
logs initially unless you're

268
00:08:36,159 --> 00:08:37,599
unless you're using your sim for both

269
00:08:37,599 --> 00:08:39,120
operations and security so that's kind

270
00:08:39,120 --> 00:08:40,559
of one of your requirements or your

271
00:08:40,559 --> 00:08:41,839
operations guys going to be using your

272
00:08:41,839 --> 00:08:43,839
sim or just your security guys

273
00:08:43,839 --> 00:08:46,720
access logs are really where you want to

274
00:08:46,720 --> 00:08:48,720
spend your time here we talked about

275
00:08:48,720 --> 00:08:51,279
your url length being an issue most

276
00:08:51,279 --> 00:08:52,800
vendors will fail here so that's

277
00:08:52,800 --> 00:08:54,560
something you might have to take up with

278
00:08:54,560 --> 00:08:56,800
them or increase the the payload side on

279
00:08:56,800 --> 00:08:59,040
the on the proxy itself you could you

280
00:08:59,040 --> 00:09:02,160
could switch uh syslog from udp to tcp

281
00:09:02,160 --> 00:09:03,360
if you wanted and increase the packet

282
00:09:03,360 --> 00:09:06,880
size so it doesn't have to go over udp

283
00:09:06,880 --> 00:09:08,399
a cool thing that we discovered is you

284
00:09:08,399 --> 00:09:10,800
can get every list of every file that

285
00:09:10,800 --> 00:09:13,440
was downloaded or uploaded so your your

286
00:09:13,440 --> 00:09:15,040
proxy sits in line

287
00:09:15,040 --> 00:09:17,440
uh that's not going to be parsed out i

288
00:09:17,440 --> 00:09:19,120
doubt it we haven't seen a sim that

289
00:09:19,120 --> 00:09:20,800
parses out file uploads because it's in

290
00:09:20,800 --> 00:09:22,880
the payload you can reject that stuff

291
00:09:22,880 --> 00:09:23,600
out

292
00:09:23,600 --> 00:09:26,240
uh i don't know if you have use for that

293
00:09:26,240 --> 00:09:27,600
on a day-to-day basis but it would be

294
00:09:27,600 --> 00:09:28,959
really cool to say

295
00:09:28,959 --> 00:09:30,880
that file was downloaded two months ago

296
00:09:30,880 --> 00:09:32,080
on this machine

297
00:09:32,080 --> 00:09:33,920
and it'll you know if you're keeping

298
00:09:33,920 --> 00:09:36,480
your logs long enough you have that data

299
00:09:36,480 --> 00:09:38,720
user asian strings will infer

300
00:09:38,720 --> 00:09:41,040
application execution so

301
00:09:41,040 --> 00:09:43,920
you know if i use netcat or if i use ie

302
00:09:43,920 --> 00:09:45,519
there's going to be some sort of user

303
00:09:45,519 --> 00:09:46,640
agent string

304
00:09:46,640 --> 00:09:48,080
associated there

305
00:09:48,080 --> 00:09:50,959
and then domains obviously ip address

306
00:09:50,959 --> 00:09:52,560
and the destination domains being logged

307
00:09:52,560 --> 00:09:54,320
by your proxy because it is proxying

308
00:09:54,320 --> 00:09:55,839
that entire connection

309
00:09:55,839 --> 00:09:57,839
uh and then i think most proxies

310
00:09:57,839 --> 00:09:59,519
nowadays allow you to integrate with

311
00:09:59,519 --> 00:10:01,839
ldap or active directory so the username

312
00:10:01,839 --> 00:10:03,120
for every outbound connection that's

313
00:10:03,120 --> 00:10:06,320
going to be included in your log

314
00:10:06,640 --> 00:10:09,279
flows and partial packet captures

315
00:10:09,279 --> 00:10:10,880
there's really one

316
00:10:10,880 --> 00:10:13,120
one sim vendor in town that does partial

317
00:10:13,120 --> 00:10:15,839
peak pcaps so traditionally you do

318
00:10:15,839 --> 00:10:18,240
netflows which is port and source and

319
00:10:18,240 --> 00:10:20,160
destination ip and then the packet size

320
00:10:20,160 --> 00:10:22,640
or you do full packet captures which is

321
00:10:22,640 --> 00:10:24,720
very expensive you need storage

322
00:10:24,720 --> 00:10:27,839
uh processing all that stuff so

323
00:10:27,839 --> 00:10:30,320
this ones inventor can combine

324
00:10:30,320 --> 00:10:32,320
flows with packet captures and then

325
00:10:32,320 --> 00:10:34,399
that'll give you some interesting data

326
00:10:34,399 --> 00:10:35,680
on your network because you get to span

327
00:10:35,680 --> 00:10:38,160
ports in really strategic locations and

328
00:10:38,160 --> 00:10:40,959
then you have kind of like a crude dlp

329
00:10:40,959 --> 00:10:42,560
sensor where you can start detecting

330
00:10:42,560 --> 00:10:44,000
like someone bringing up a new dns

331
00:10:44,000 --> 00:10:46,800
server or new sql database or a new vlan

332
00:10:46,800 --> 00:10:48,240
or something

333
00:10:48,240 --> 00:10:50,240
and then it helps you identify

334
00:10:50,240 --> 00:10:52,079
patterns of usage

335
00:10:52,079 --> 00:10:53,839
baselines don't have to be complicated

336
00:10:53,839 --> 00:10:55,600
initially i mean i've attended a lot of

337
00:10:55,600 --> 00:10:57,680
talks that talk about how you baseline

338
00:10:57,680 --> 00:10:59,040
something and then how you build these

339
00:10:59,040 --> 00:11:01,839
really cool uh graphs and how you detect

340
00:11:01,839 --> 00:11:04,480
anomalous behavior this is a

341
00:11:04,480 --> 00:11:06,320
graph from our network for three days of

342
00:11:06,320 --> 00:11:08,959
just network traffic as you can see from

343
00:11:08,959 --> 00:11:10,079
around i don't know if you can see the

344
00:11:10,079 --> 00:11:11,839
time but from around 11

345
00:11:11,839 --> 00:11:14,880
p.m till 5am not much is going on it's

346
00:11:14,880 --> 00:11:17,040
an easy rule if you see a spike in that

347
00:11:17,040 --> 00:11:19,600
time frame you know throw an alert

348
00:11:19,600 --> 00:11:22,399
similarly uh during the peak times it's

349
00:11:22,399 --> 00:11:23,440
pretty

350
00:11:23,440 --> 00:11:25,200
it's pretty obvious that if someone you

351
00:11:25,200 --> 00:11:26,640
know tries to do something at the peak

352
00:11:26,640 --> 00:11:29,120
of time you could say 20 over that

353
00:11:29,120 --> 00:11:30,880
that peak let me know if that if that

354
00:11:30,880 --> 00:11:33,040
triggers uh that's just that's some of

355
00:11:33,040 --> 00:11:34,880
the things we've done uh from like a

356
00:11:34,880 --> 00:11:36,720
very basic standpoint

357
00:11:36,720 --> 00:11:39,040
uh the last bullet talks about strategic

358
00:11:39,040 --> 00:11:40,399
choke points

359
00:11:40,399 --> 00:11:42,720
so if you spam a port in front of your

360
00:11:42,720 --> 00:11:44,640
proxy every connection going to the

361
00:11:44,640 --> 00:11:46,399
internet will be the source ip will be

362
00:11:46,399 --> 00:11:47,519
the proxy

363
00:11:47,519 --> 00:11:49,519
same thing with dns if you spam a port

364
00:11:49,519 --> 00:11:51,360
in front of your dns servers then all

365
00:11:51,360 --> 00:11:53,200
the recursive queries go in your dns

366
00:11:53,200 --> 00:11:54,720
folder are going to be sourced by the

367
00:11:54,720 --> 00:11:57,279
dns server if you span a port behind

368
00:11:57,279 --> 00:11:59,600
your dns servers or behind your proxy

369
00:11:59,600 --> 00:12:01,120
then you're getting the client ip that's

370
00:12:01,120 --> 00:12:02,800
making that connection so that's just

371
00:12:02,800 --> 00:12:04,880
something we learned that pay attention

372
00:12:04,880 --> 00:12:05,920
where your spanning ports if you're

373
00:12:05,920 --> 00:12:08,240
doing flows or partial

374
00:12:08,240 --> 00:12:10,399
packet captures

375
00:12:10,399 --> 00:12:11,839
uh we talked a little bit about the

376
00:12:11,839 --> 00:12:14,959
behavioral rules uh this is more of

377
00:12:14,959 --> 00:12:16,639
we use this for insider threat kind of

378
00:12:16,639 --> 00:12:18,560
things or rogue admins you know if

379
00:12:18,560 --> 00:12:21,360
someone brings a new dns server

380
00:12:21,360 --> 00:12:23,279
you should have a process for

381
00:12:23,279 --> 00:12:24,959
you know change control if something

382
00:12:24,959 --> 00:12:27,040
comes up you're aware of it

383
00:12:27,040 --> 00:12:28,720
most sims allow you to build a network

384
00:12:28,720 --> 00:12:30,079
topology

385
00:12:30,079 --> 00:12:32,240
you basically feed it all the vlans tell

386
00:12:32,240 --> 00:12:33,760
it what your dns servers your sql

387
00:12:33,760 --> 00:12:35,600
servers are your web servers and then if

388
00:12:35,600 --> 00:12:37,200
it sees anything outside of that it says

389
00:12:37,200 --> 00:12:38,560
hey there's a new dns server on the

390
00:12:38,560 --> 00:12:40,320
network there's a new web server

391
00:12:40,320 --> 00:12:42,079
obviously that takes time to tune early

392
00:12:42,079 --> 00:12:43,839
on but once you do that it's really not

393
00:12:43,839 --> 00:12:45,360
a lot of tuning to do

394
00:12:45,360 --> 00:12:47,440
depends on how big your network is

395
00:12:47,440 --> 00:12:49,360
new network being created similarly how

396
00:12:49,360 --> 00:12:51,839
many times you're creating new vlans

397
00:12:51,839 --> 00:12:53,839
we've had admins try to create new vlans

398
00:12:53,839 --> 00:12:55,279
to circumvent

399
00:12:55,279 --> 00:12:57,360
a lot of our interesting protections

400
00:12:57,360 --> 00:12:58,720
that we have so

401
00:12:58,720 --> 00:13:00,000
that does happen

402
00:13:00,000 --> 00:13:01,680
we talked about traffic patterns during

403
00:13:01,680 --> 00:13:04,320
off hours those are easy rules and then

404
00:13:04,320 --> 00:13:06,639
once you have a large data set you can

405
00:13:06,639 --> 00:13:10,000
start creating more complex rules

406
00:13:10,000 --> 00:13:12,320
web servers uh

407
00:13:12,320 --> 00:13:14,240
again back to user agent strings if you

408
00:13:14,240 --> 00:13:16,320
have multiple user agent strings being

409
00:13:16,320 --> 00:13:18,160
sourced from the same ip address that's

410
00:13:18,160 --> 00:13:19,360
unusual

411
00:13:19,360 --> 00:13:21,120
you should probably write a rule alert

412
00:13:21,120 --> 00:13:22,639
on that it's usually an indication of

413
00:13:22,639 --> 00:13:25,120
someone's just trying different tools

414
00:13:25,120 --> 00:13:27,040
files that should never be accessed

415
00:13:27,040 --> 00:13:29,279
honey pots you could put a like a dummy

416
00:13:29,279 --> 00:13:31,040
file and if someone downloads it we do

417
00:13:31,040 --> 00:13:34,000
that then you alert on it it has no need

418
00:13:34,000 --> 00:13:35,360
to be on that server but we put it up

419
00:13:35,360 --> 00:13:36,959
there to see if someone tries to

420
00:13:36,959 --> 00:13:38,160
download it

421
00:13:38,160 --> 00:13:39,040
um

422
00:13:39,040 --> 00:13:40,639
create alerts for access to protected

423
00:13:40,639 --> 00:13:42,720
directories uh same thing if they don't

424
00:13:42,720 --> 00:13:45,839
if they shouldn't be accessed

425
00:13:45,839 --> 00:13:47,600
you should alert on that

426
00:13:47,600 --> 00:13:50,639
uh load balancers again we have large

427
00:13:50,639 --> 00:13:52,480
web environments that are in the dims

428
00:13:52,480 --> 00:13:55,200
either usually fronted by load balancers

429
00:13:55,200 --> 00:13:57,519
make sure that the load balancer is uh

430
00:13:57,519 --> 00:13:59,120
capturing the source id of the client

431
00:13:59,120 --> 00:14:00,800
that's making the request otherwise

432
00:14:00,800 --> 00:14:02,399
you're seeing the source ip as the load

433
00:14:02,399 --> 00:14:03,600
balancer making the connection to your

434
00:14:03,600 --> 00:14:06,720
web server just just a common theme

435
00:14:06,720 --> 00:14:07,920
how you've seen

436
00:14:07,920 --> 00:14:10,320
dns logging has actually been really uh

437
00:14:10,320 --> 00:14:12,959
hard for us to do because

438
00:14:12,959 --> 00:14:16,079
before server 2012 r2 you really had no

439
00:14:16,079 --> 00:14:18,079
good way to extract dns logs if you're

440
00:14:18,079 --> 00:14:19,040
running

441
00:14:19,040 --> 00:14:21,440
uh windows dns uh you have to turn on

442
00:14:21,440 --> 00:14:23,839
debugging and then that dumps it to a

443
00:14:23,839 --> 00:14:25,279
flat file and then you have to parse

444
00:14:25,279 --> 00:14:26,800
that flat file somehow get it to your

445
00:14:26,800 --> 00:14:28,800
sim debugging on a domain controller is

446
00:14:28,800 --> 00:14:30,399
a bad idea even microsoft will tell you

447
00:14:30,399 --> 00:14:31,360
that

448
00:14:31,360 --> 00:14:33,120
so what we ended up doing is using the

449
00:14:33,120 --> 00:14:36,160
proxy logs and aaron will talk about how

450
00:14:36,160 --> 00:14:38,399
we've enabled the client firewall that's

451
00:14:38,399 --> 00:14:39,920
logging all of the domains that you're

452
00:14:39,920 --> 00:14:42,160
visiting as a client so we've used that

453
00:14:42,160 --> 00:14:45,680
kind of to search any dns or you know to

454
00:14:45,680 --> 00:14:47,199
augment the fact that we can't really do

455
00:14:47,199 --> 00:14:50,079
dns at this time

456
00:14:50,880 --> 00:14:53,040
what was that

457
00:14:53,040 --> 00:14:57,000
yeah we could always do that

458
00:15:03,760 --> 00:15:05,279
we tried to do that we tried to do some

459
00:15:05,279 --> 00:15:08,079
things with flows but uh the the parsers

460
00:15:08,079 --> 00:15:10,160
didn't play very well i mean it

461
00:15:10,160 --> 00:15:12,639
we have some ideas bro is one of them

462
00:15:12,639 --> 00:15:15,760
uh we do have 2012 right now so we're

463
00:15:15,760 --> 00:15:17,360
probably not going to go the complicated

464
00:15:17,360 --> 00:15:18,959
route and just get dns logs off of the

465
00:15:18,959 --> 00:15:20,320
domain controllers

466
00:15:20,320 --> 00:15:21,360
uh

467
00:15:21,360 --> 00:15:22,880
there are some more interesting rules

468
00:15:22,880 --> 00:15:24,480
that we could we want to write like the

469
00:15:24,480 --> 00:15:26,800
the length of the domain and uh

470
00:15:26,800 --> 00:15:28,560
some some other some other things that

471
00:15:28,560 --> 00:15:30,079
you want to do but so far we really

472
00:15:30,079 --> 00:15:31,600
haven't gotten a chance to do that but

473
00:15:31,600 --> 00:15:34,000
those are some good ideas

474
00:15:34,000 --> 00:15:36,880
uh finally some basic custom rules i'm

475
00:15:36,880 --> 00:15:39,279
sure you've seen some of these

476
00:15:39,279 --> 00:15:40,800
alert for an ip address that connects to

477
00:15:40,800 --> 00:15:43,040
multiple hosts in your dmz across your

478
00:15:43,040 --> 00:15:44,800
entire enterprise sure you have

479
00:15:44,800 --> 00:15:46,160
legitimate vendors that might do that

480
00:15:46,160 --> 00:15:48,399
but why would one ip connect to three

481
00:15:48,399 --> 00:15:49,680
different web servers that have three

482
00:15:49,680 --> 00:15:51,839
different functions so that that's

483
00:15:51,839 --> 00:15:53,920
that's something you can alert on there

484
00:15:53,920 --> 00:15:56,079
any critical ips signature

485
00:15:56,079 --> 00:15:58,160
if those aren't tuned yet i think you

486
00:15:58,160 --> 00:15:59,440
have bigger problems but you shouldn't

487
00:15:59,440 --> 00:16:00,639
have critical

488
00:16:00,639 --> 00:16:02,880
ips firing all the time that's just an

489
00:16:02,880 --> 00:16:05,199
easy rule to set there

490
00:16:05,199 --> 00:16:06,880
suspicious countries connecting to your

491
00:16:06,880 --> 00:16:08,480
network i don't know if you do business

492
00:16:08,480 --> 00:16:10,079
with all 200 plus countries you might

493
00:16:10,079 --> 00:16:11,360
have friendly countries you might have

494
00:16:11,360 --> 00:16:13,759
not so friendly countries most sims have

495
00:16:13,759 --> 00:16:15,040
geo

496
00:16:15,040 --> 00:16:16,720
identifying abilities so if you see an

497
00:16:16,720 --> 00:16:18,079
ip address they automatically say this

498
00:16:18,079 --> 00:16:19,440
is coming from china

499
00:16:19,440 --> 00:16:20,639
you can create a rule this is every time

500
00:16:20,639 --> 00:16:22,160
you see china or russia connect to my

501
00:16:22,160 --> 00:16:23,600
dmz

502
00:16:23,600 --> 00:16:26,160
create a rule or alert for that

503
00:16:26,160 --> 00:16:27,920
multiple failed vpn logins obviously

504
00:16:27,920 --> 00:16:29,759
that's to detect some sort of brute

505
00:16:29,759 --> 00:16:31,839
force on your vpn servers

506
00:16:31,839 --> 00:16:35,040
simultaneous logins from the same user

507
00:16:35,040 --> 00:16:37,279
that's rare alerts from demand from the

508
00:16:37,279 --> 00:16:39,759
domain admins group uh you shouldn't be

509
00:16:39,759 --> 00:16:41,279
using domain admin across your network

510
00:16:41,279 --> 00:16:43,519
if you are uh don't

511
00:16:43,519 --> 00:16:46,000
uh alerts on new user agent strings this

512
00:16:46,000 --> 00:16:48,800
is also from the proxy so if you have

513
00:16:48,800 --> 00:16:50,959
the data set for every single user agent

514
00:16:50,959 --> 00:16:51,839
string

515
00:16:51,839 --> 00:16:53,920
that's been launched on your network and

516
00:16:53,920 --> 00:16:55,199
you regex that out and say all right

517
00:16:55,199 --> 00:16:56,720
here's my baseline for user agent

518
00:16:56,720 --> 00:16:59,199
strings anything outside of this throw

519
00:16:59,199 --> 00:17:00,399
an alert

520
00:17:00,399 --> 00:17:02,480
that's just uh that's an easy regex to

521
00:17:02,480 --> 00:17:03,600
write and then

522
00:17:03,600 --> 00:17:04,559
all of a sudden when you have a new

523
00:17:04,559 --> 00:17:06,400
security someone tries to run some new

524
00:17:06,400 --> 00:17:08,000
tool that you don't have in that data

525
00:17:08,000 --> 00:17:10,480
set uh you've got you've got some some

526
00:17:10,480 --> 00:17:12,319
interesting forensics there so this is

527
00:17:12,319 --> 00:17:13,679
the network side aaron's going to go

528
00:17:13,679 --> 00:17:15,119
into the client side and some of the

529
00:17:15,119 --> 00:17:17,439
things we did there

530
00:17:17,439 --> 00:17:19,839
thanks

531
00:17:20,240 --> 00:17:22,160
so on the client side this is where we

532
00:17:22,160 --> 00:17:23,439
really like to call this more of a

533
00:17:23,439 --> 00:17:25,760
proactive forensics approach our goal is

534
00:17:25,760 --> 00:17:28,480
to try and collect logs that normally to

535
00:17:28,480 --> 00:17:30,080
to get that sort of information you'd

536
00:17:30,080 --> 00:17:31,440
have to do some sort of a dead disk

537
00:17:31,440 --> 00:17:33,600
analysis you take an image fire up the

538
00:17:33,600 --> 00:17:35,840
forensics tools dig in try to figure out

539
00:17:35,840 --> 00:17:38,160
what ran when what network connections

540
00:17:38,160 --> 00:17:40,320
it made all that sort of thing our goal

541
00:17:40,320 --> 00:17:42,000
was rather to

542
00:17:42,000 --> 00:17:44,000
get this logged as it's happening real

543
00:17:44,000 --> 00:17:46,240
time pull those into the sim and be able

544
00:17:46,240 --> 00:17:48,080
to alert on them and or if we need to go

545
00:17:48,080 --> 00:17:49,840
back and investigate them be able to

546
00:17:49,840 --> 00:17:52,799
just make it as simple as a sim query so

547
00:17:52,799 --> 00:17:54,559
some of the types of logs that we wanted

548
00:17:54,559 --> 00:17:57,039
to pull are client firewall logs if you

549
00:17:57,039 --> 00:17:58,640
haven't turned on the client firewall on

550
00:17:58,640 --> 00:18:00,559
all of your endpoints you're missing out

551
00:18:00,559 --> 00:18:03,440
on a very valuable source of data turn

552
00:18:03,440 --> 00:18:05,440
those on feed them into the sim and

553
00:18:05,440 --> 00:18:07,760
start searching into them additionally

554
00:18:07,760 --> 00:18:08,799
getting some

555
00:18:08,799 --> 00:18:10,559
information about what applications are

556
00:18:10,559 --> 00:18:12,320
actually running on your network this

557
00:18:12,320 --> 00:18:13,679
can either come from application

558
00:18:13,679 --> 00:18:15,840
whitelisting um

559
00:18:15,840 --> 00:18:16,960
you know if you've got windows 7

560
00:18:16,960 --> 00:18:18,960
enterprise or above you have access to

561
00:18:18,960 --> 00:18:20,799
app locker you don't even have to turn

562
00:18:20,799 --> 00:18:23,039
it on in enforced mode just log pull

563
00:18:23,039 --> 00:18:25,280
those application execution logs in and

564
00:18:25,280 --> 00:18:26,880
now you can see what's being executed

565
00:18:26,880 --> 00:18:30,559
and when sysmon is a fantastic utility

566
00:18:30,559 --> 00:18:31,760
and if you haven't kicked the tires on

567
00:18:31,760 --> 00:18:32,880
that

568
00:18:32,880 --> 00:18:34,480
you're really really missing out and

569
00:18:34,480 --> 00:18:35,840
i'll show you some examples of how that

570
00:18:35,840 --> 00:18:37,840
can be used in a moment other types of

571
00:18:37,840 --> 00:18:39,520
event logs that might be interesting are

572
00:18:39,520 --> 00:18:41,280
when is a new service installed on your

573
00:18:41,280 --> 00:18:43,200
endpoints you know if you can alert on

574
00:18:43,200 --> 00:18:44,640
that and you know that it's not

575
00:18:44,640 --> 00:18:47,039
associated with a big push that's coming

576
00:18:47,039 --> 00:18:49,039
from your applications team who's

577
00:18:49,039 --> 00:18:50,960
installing some new software that's

578
00:18:50,960 --> 00:18:52,080
definitely something that you want to

579
00:18:52,080 --> 00:18:55,120
dig in on and look at

580
00:18:55,120 --> 00:18:56,559
as long as you're kind of being prudent

581
00:18:56,559 --> 00:18:57,760
about the types of logs that you're

582
00:18:57,760 --> 00:18:59,120
bringing in you can really get some

583
00:18:59,120 --> 00:19:00,960
interesting stuff out of this

584
00:19:00,960 --> 00:19:02,640
and by bringing it into the sim we may

585
00:19:02,640 --> 00:19:04,320
not even need to take that step of going

586
00:19:04,320 --> 00:19:07,520
to a forensic investigation

587
00:19:07,520 --> 00:19:09,840
now the problem though is typically sims

588
00:19:09,840 --> 00:19:12,000
have been focused at let's pull in from

589
00:19:12,000 --> 00:19:14,000
the servers and you probably have less

590
00:19:14,000 --> 00:19:16,320
servers than endpoints now if you just

591
00:19:16,320 --> 00:19:18,240
flip on logging on all of your endpoints

592
00:19:18,240 --> 00:19:20,559
haphazardly and feed it into your sim

593
00:19:20,559 --> 00:19:22,559
the system is going to go down

594
00:19:22,559 --> 00:19:24,320
so we need to be a little more judicious

595
00:19:24,320 --> 00:19:25,600
about what we bring in so i'm going to

596
00:19:25,600 --> 00:19:27,280
talk about some examples of how we can

597
00:19:27,280 --> 00:19:29,520
kind of source filter that down to to

598
00:19:29,520 --> 00:19:32,240
get what really matters

599
00:19:32,240 --> 00:19:34,160
for endpoint firewall logging if you

600
00:19:34,160 --> 00:19:36,320
have one of the standard endpoint

601
00:19:36,320 --> 00:19:37,760
security suites

602
00:19:37,760 --> 00:19:39,520
chances are it has a firewall component

603
00:19:39,520 --> 00:19:40,960
that can be enabled and what it's going

604
00:19:40,960 --> 00:19:42,799
to end up doing is logging back at that

605
00:19:42,799 --> 00:19:44,640
management console that management

606
00:19:44,640 --> 00:19:46,480
console can then be configured to syslog

607
00:19:46,480 --> 00:19:48,000
over to your sim and so that's the most

608
00:19:48,000 --> 00:19:50,400
normal way to get those events in what's

609
00:19:50,400 --> 00:19:52,000
awesome about these logs is it will tell

610
00:19:52,000 --> 00:19:53,840
you the exact application that was

611
00:19:53,840 --> 00:19:55,679
running that's something that even the

612
00:19:55,679 --> 00:19:58,320
best next gen layer 7 inspecting

613
00:19:58,320 --> 00:20:00,559
firewall is taking a guess at but they

614
00:20:00,559 --> 00:20:02,160
can't give you the exact application

615
00:20:02,160 --> 00:20:04,000
like this can from there you can create

616
00:20:04,000 --> 00:20:06,320
some very simple rules i mean would a

617
00:20:06,320 --> 00:20:09,039
user ever actually run ftp.exe from a

618
00:20:09,039 --> 00:20:12,480
command line probably not now admins yes

619
00:20:12,480 --> 00:20:14,400
admins yes and you can separate out

620
00:20:14,400 --> 00:20:15,840
those out and have different rules to

621
00:20:15,840 --> 00:20:18,160
trigger on your admin accounts um you

622
00:20:18,160 --> 00:20:18,840
know

623
00:20:18,840 --> 00:20:21,679
powershell you know if there if it's a a

624
00:20:21,679 --> 00:20:23,760
bad red teamer who's still migrating

625
00:20:23,760 --> 00:20:25,840
into notepad with metasploit there's an

626
00:20:25,840 --> 00:20:27,919
easy detection that sort of thing so you

627
00:20:27,919 --> 00:20:30,640
can get pretty pretty interesting stuff

628
00:20:30,640 --> 00:20:31,919
um

629
00:20:31,919 --> 00:20:33,919
some of the gotchas though

630
00:20:33,919 --> 00:20:35,600
normalizing time that comes from your

631
00:20:35,600 --> 00:20:37,200
clients can be difficult if you have a

632
00:20:37,200 --> 00:20:39,039
laptop that's left your environment and

633
00:20:39,039 --> 00:20:40,480
it's been out for a week or so when it

634
00:20:40,480 --> 00:20:42,880
comes back and uploads those logs this

635
00:20:42,880 --> 00:20:44,720
is something that the sims don't handle

636
00:20:44,720 --> 00:20:46,559
very well those logs are going to come

637
00:20:46,559 --> 00:20:48,960
from your your management appliance and

638
00:20:48,960 --> 00:20:50,320
the sim is going to take those events

639
00:20:50,320 --> 00:20:52,720
and say these just happened despite the

640
00:20:52,720 --> 00:20:54,559
fact that they happened four days five

641
00:20:54,559 --> 00:20:56,799
days maybe a week ago uh and they'll

642
00:20:56,799 --> 00:20:58,320
trigger on a fence and say it happened

643
00:20:58,320 --> 00:20:59,760
at this time and if you go circling at

644
00:20:59,760 --> 00:21:02,080
that exact time you're gonna be like uh

645
00:21:02,080 --> 00:21:03,520
no it didn't

646
00:21:03,520 --> 00:21:05,679
um another consideration is when these

647
00:21:05,679 --> 00:21:07,120
these clients come back you may get an

648
00:21:07,120 --> 00:21:09,360
eps burst when they dump all these logs

649
00:21:09,360 --> 00:21:11,200
that they've been offline for a while so

650
00:21:11,200 --> 00:21:12,400
it's one of those questions you want to

651
00:21:12,400 --> 00:21:14,240
ask your sim vendors is how do they deal

652
00:21:14,240 --> 00:21:16,240
with kind of spikes in your events per

653
00:21:16,240 --> 00:21:17,440
second

654
00:21:17,440 --> 00:21:20,000
but really the best way to to manage

655
00:21:20,000 --> 00:21:22,400
this is like i said source filter look

656
00:21:22,400 --> 00:21:23,679
at what some of the more chatty

657
00:21:23,679 --> 00:21:25,679
protocols are decide whether you

658
00:21:25,679 --> 00:21:27,200
actually need them on your network i

659
00:21:27,200 --> 00:21:27,919
mean

660
00:21:27,919 --> 00:21:29,039
some of the ones that do a lot of

661
00:21:29,039 --> 00:21:31,600
broadcasts ssdp net bios that sort of

662
00:21:31,600 --> 00:21:33,520
thing do they really have a need to be

663
00:21:33,520 --> 00:21:35,760
in your enterprise if not

664
00:21:35,760 --> 00:21:37,360
block it at the source

665
00:21:37,360 --> 00:21:39,039
it's better to disable it but also go

666
00:21:39,039 --> 00:21:40,400
ahead and create a firewall rule that

667
00:21:40,400 --> 00:21:41,679
blocks it if it's going to try and go

668
00:21:41,679 --> 00:21:43,360
outbound

669
00:21:43,360 --> 00:21:45,039
there are broadcast applications that

670
00:21:45,039 --> 00:21:46,880
you're going to have to allow though

671
00:21:46,880 --> 00:21:49,120
take for example dhcp if you can't get

672
00:21:49,120 --> 00:21:51,600
onto the network it's not very useful so

673
00:21:51,600 --> 00:21:53,760
but when dhcp comes online your clients

674
00:21:53,760 --> 00:21:55,919
going to make a broadcast out to port 67

675
00:21:55,919 --> 00:21:58,880
and say give me an ip address well every

676
00:21:58,880 --> 00:22:00,799
other client on that same vlan is going

677
00:22:00,799 --> 00:22:02,559
to drop that packet and say this is not

678
00:22:02,559 --> 00:22:04,640
legitimate traffic and when all that

679
00:22:04,640 --> 00:22:06,480
comes to your sim it's going to be a

680
00:22:06,480 --> 00:22:07,919
couple hundred logs and your sims gonna

681
00:22:07,919 --> 00:22:09,760
say someone's port scanning this vlan

682
00:22:09,760 --> 00:22:11,919
that's not what's happening so you need

683
00:22:11,919 --> 00:22:13,600
to make some decisions about what you

684
00:22:13,600 --> 00:22:14,960
actually want to log and when you're

685
00:22:14,960 --> 00:22:16,880
creating your firewall logs it might be

686
00:22:16,880 --> 00:22:18,720
fine to create one that just says drop

687
00:22:18,720 --> 00:22:21,840
inbound port 67 and don't log it's

688
00:22:21,840 --> 00:22:23,919
probably not going to be you know it you

689
00:22:23,919 --> 00:22:25,280
are kind of curtailing some of your

690
00:22:25,280 --> 00:22:27,600
information but on the long term it's

691
00:22:27,600 --> 00:22:28,960
really going to going to pay off and

692
00:22:28,960 --> 00:22:32,720
having cleaner logs coming into your sim

693
00:22:32,799 --> 00:22:35,280
and you know just a side note whatever

694
00:22:35,280 --> 00:22:36,880
endpoint firewall you're using make sure

695
00:22:36,880 --> 00:22:37,840
it's not something that can be

696
00:22:37,840 --> 00:22:39,679
manipulated by your end users it should

697
00:22:39,679 --> 00:22:42,400
be securely managed upstream

698
00:22:42,400 --> 00:22:44,240
so here's just sort of an example of a

699
00:22:44,240 --> 00:22:46,000
sample firewall and the colors aren't

700
00:22:46,000 --> 00:22:47,440
coming out too well but what i really

701
00:22:47,440 --> 00:22:49,679
wanted to show out here is you know the

702
00:22:49,679 --> 00:22:50,720
log

703
00:22:50,720 --> 00:22:52,799
as it's being sent to the sim is showing

704
00:22:52,799 --> 00:22:55,039
up as though it was september 18th at 10

705
00:22:55,039 --> 00:22:58,000
55 however further down in the the

706
00:22:58,000 --> 00:22:59,760
payload we see that the start time was

707
00:22:59,760 --> 00:23:02,320
actually on september 16th and so that's

708
00:23:02,320 --> 00:23:04,320
exactly the issue that the the sims

709
00:23:04,320 --> 00:23:05,600
going to have a problem with so when you

710
00:23:05,600 --> 00:23:07,520
go back to investigate these things it's

711
00:23:07,520 --> 00:23:09,200
very important that you take in into

712
00:23:09,200 --> 00:23:10,799
consideration not just the time that the

713
00:23:10,799 --> 00:23:12,640
event was triggered on the sim but the

714
00:23:12,640 --> 00:23:14,480
actual log source time as you're going

715
00:23:14,480 --> 00:23:15,679
through it

716
00:23:15,679 --> 00:23:17,520
um but as i alluded to i mean there's

717
00:23:17,520 --> 00:23:19,679
just gold in these in these logs you've

718
00:23:19,679 --> 00:23:22,080
got the domain that it went to the exact

719
00:23:22,080 --> 00:23:24,080
application that was run the rule name

720
00:23:24,080 --> 00:23:26,240
that you had created in your firewall so

721
00:23:26,240 --> 00:23:27,840
all these things are that are things

722
00:23:27,840 --> 00:23:30,480
that you can key in on and and try to to

723
00:23:30,480 --> 00:23:33,440
alert on within your sim

724
00:23:33,440 --> 00:23:35,760
now windows client event logs

725
00:23:35,760 --> 00:23:38,640
this is always a difficult issue with

726
00:23:38,640 --> 00:23:40,559
the sim windows of course doesn't

727
00:23:40,559 --> 00:23:41,600
support

728
00:23:41,600 --> 00:23:43,360
syslog natively we've got to find some

729
00:23:43,360 --> 00:23:46,000
other way to get those logs in there

730
00:23:46,000 --> 00:23:47,919
one way that you can do this is

731
00:23:47,919 --> 00:23:50,640
by using native windows functionality

732
00:23:50,640 --> 00:23:52,320
use event log forwarding to bring it

733
00:23:52,320 --> 00:23:54,320
into a central place and from there fire

734
00:23:54,320 --> 00:23:56,559
those over at syslog otherwise check

735
00:23:56,559 --> 00:23:58,000
with your sim vendor they probably have

736
00:23:58,000 --> 00:23:59,360
some sort of an agent that will sit

737
00:23:59,360 --> 00:24:01,120
local on your host that's going to cache

738
00:24:01,120 --> 00:24:03,039
those logs and then upload them securely

739
00:24:03,039 --> 00:24:06,799
securely to the system um but again this

740
00:24:06,799 --> 00:24:08,480
is something that can easily overwhelm

741
00:24:08,480 --> 00:24:10,480
your your sim if you're sending every

742
00:24:10,480 --> 00:24:12,480
single event log from your clients your

743
00:24:12,480 --> 00:24:14,080
sims just going to crash now your sim

744
00:24:14,080 --> 00:24:15,679
vendor will be happy to sell you more

745
00:24:15,679 --> 00:24:17,600
eps and to sell you bigger boxes and

746
00:24:17,600 --> 00:24:19,840
that sort of thing but uh like we said

747
00:24:19,840 --> 00:24:21,760
we wanted to do this on a budget so

748
00:24:21,760 --> 00:24:23,279
check with your some vendors check your

749
00:24:23,279 --> 00:24:25,919
your client see what you can work out

750
00:24:25,919 --> 00:24:28,000
xpath queries if they support it are an

751
00:24:28,000 --> 00:24:29,919
excellent way to minimize what's coming

752
00:24:29,919 --> 00:24:31,840
into your sim so this is a way of

753
00:24:31,840 --> 00:24:33,200
searching through your windows event

754
00:24:33,200 --> 00:24:34,880
logs and picking out only those

755
00:24:34,880 --> 00:24:36,799
individual events that you actually care

756
00:24:36,799 --> 00:24:39,120
about

757
00:24:40,480 --> 00:24:42,080
if you want some good examples of the

758
00:24:42,080 --> 00:24:43,840
types of logs that you should be looking

759
00:24:43,840 --> 00:24:46,000
at there's a fantastic paper that was

760
00:24:46,000 --> 00:24:48,240
published by the nsa called spotting the

761
00:24:48,240 --> 00:24:49,840
adversary with windows event log

762
00:24:49,840 --> 00:24:51,120
monitoring

763
00:24:51,120 --> 00:24:53,200
if you go through that and i still

764
00:24:53,200 --> 00:24:54,640
wouldn't recommend that you pick out

765
00:24:54,640 --> 00:24:56,240
every single one of those events and try

766
00:24:56,240 --> 00:24:58,159
to bring it in for your organization

767
00:24:58,159 --> 00:24:59,520
that's probably still going to be too

768
00:24:59,520 --> 00:25:02,000
much do some xpath queries against your

769
00:25:02,000 --> 00:25:03,919
own box see what's normal what makes

770
00:25:03,919 --> 00:25:06,000
sense then pick out only those ones that

771
00:25:06,000 --> 00:25:08,559
do do make sense to bring into the sim

772
00:25:08,559 --> 00:25:09,919
but you know some obvious ones that

773
00:25:09,919 --> 00:25:11,440
you're always going to want to see event

774
00:25:11,440 --> 00:25:13,840
logs are being cleared key in on that

775
00:25:13,840 --> 00:25:15,520
users are being added to a privileged

776
00:25:15,520 --> 00:25:18,080
group key in on that and then app locker

777
00:25:18,080 --> 00:25:19,679
or emmett logs i mean if you've deployed

778
00:25:19,679 --> 00:25:21,279
emmett and you're seeing something

779
00:25:21,279 --> 00:25:24,480
triggering on a dep or aslr violation

780
00:25:24,480 --> 00:25:25,919
that's something you're going to want to

781
00:25:25,919 --> 00:25:29,360
kind of want to investigate further

782
00:25:29,360 --> 00:25:30,159
and

783
00:25:30,159 --> 00:25:32,400
leveraging application execution logs is

784
00:25:32,400 --> 00:25:33,600
something that i think is very

785
00:25:33,600 --> 00:25:35,760
interesting that the sim vendors haven't

786
00:25:35,760 --> 00:25:37,039
really gotten their arms around they're

787
00:25:37,039 --> 00:25:38,480
starting to recognize that they need to

788
00:25:38,480 --> 00:25:40,720
do this but there isn't doesn't seem to

789
00:25:40,720 --> 00:25:42,320
be some sort of a common framework to

790
00:25:42,320 --> 00:25:43,520
say

791
00:25:43,520 --> 00:25:45,840
application execution happened at just

792
00:25:45,840 --> 00:25:47,440
the same way that there is to say

793
00:25:47,440 --> 00:25:49,360
network flow happened or network traffic

794
00:25:49,360 --> 00:25:50,559
happened

795
00:25:50,559 --> 00:25:51,840
so this is something that we really had

796
00:25:51,840 --> 00:25:53,360
to spend a lot of time customizing

797
00:25:53,360 --> 00:25:55,840
around parsing out what is application

798
00:25:55,840 --> 00:25:57,679
execution and recognizing it as some

799
00:25:57,679 --> 00:25:59,039
sort of an event

800
00:25:59,039 --> 00:26:00,559
now you can monitor for your white

801
00:26:00,559 --> 00:26:02,320
listing system to say these things got

802
00:26:02,320 --> 00:26:04,080
blocked that can give you some

803
00:26:04,080 --> 00:26:05,600
information about you know something

804
00:26:05,600 --> 00:26:07,440
that shouldn't have happened but what's

805
00:26:07,440 --> 00:26:08,960
going to be more interesting in the long

806
00:26:08,960 --> 00:26:11,360
term is what actually got allowed to run

807
00:26:11,360 --> 00:26:12,880
because that's what got by and that's

808
00:26:12,880 --> 00:26:14,159
that's where you're getting actually

809
00:26:14,159 --> 00:26:15,279
owned

810
00:26:15,279 --> 00:26:17,200
advanced attackers aren't going to drop

811
00:26:17,200 --> 00:26:18,880
new payloads they're going to use native

812
00:26:18,880 --> 00:26:20,960
functionality against you and abuse it

813
00:26:20,960 --> 00:26:22,799
against you so you need to baseline and

814
00:26:22,799 --> 00:26:25,679
know what is normal execution and then

815
00:26:25,679 --> 00:26:28,159
you can start looking for those abnormal

816
00:26:28,159 --> 00:26:30,960
executions like really long encoded

817
00:26:30,960 --> 00:26:33,120
strings associated with powershell

818
00:26:33,120 --> 00:26:34,400
definitely something that you want to

819
00:26:34,400 --> 00:26:36,960
key in on

820
00:26:37,120 --> 00:26:38,640
applocker i've mentioned a couple of

821
00:26:38,640 --> 00:26:40,480
times that's kind of uh

822
00:26:40,480 --> 00:26:42,159
one of our old go-to's but it just

823
00:26:42,159 --> 00:26:43,679
doesn't give you the same robust

824
00:26:43,679 --> 00:26:46,000
information that sysmon does with sysmon

825
00:26:46,000 --> 00:26:47,679
you're getting the full what was

826
00:26:47,679 --> 00:26:49,520
launched what it

827
00:26:49,520 --> 00:26:52,080
what its parent process was the hashes

828
00:26:52,080 --> 00:26:54,960
of it and the user that did it so

829
00:26:54,960 --> 00:26:56,720
going back to that first slide that kyle

830
00:26:56,720 --> 00:26:59,200
brought up of that phishing email i mean

831
00:26:59,200 --> 00:27:00,799
anyone see anything that that looks a

832
00:27:00,799 --> 00:27:02,480
little odd here i know it's a little bit

833
00:27:02,480 --> 00:27:04,320
hard to read but it's saying the parent

834
00:27:04,320 --> 00:27:06,480
image is windword and the command line

835
00:27:06,480 --> 00:27:08,640
that windward ran

836
00:27:08,640 --> 00:27:10,320
was it launched

837
00:27:10,320 --> 00:27:12,880
a batch file out of the temp directory

838
00:27:12,880 --> 00:27:15,120
if word is ever running a batch file out

839
00:27:15,120 --> 00:27:17,120
of attempt directory you've got issues

840
00:27:17,120 --> 00:27:19,600
guaranteed now if you are application

841
00:27:19,600 --> 00:27:21,279
whitelisting

842
00:27:21,279 --> 00:27:23,120
good stuff you won't even see this log

843
00:27:23,120 --> 00:27:24,559
you'll just see the blocked execution

844
00:27:24,559 --> 00:27:26,400
which is great but if you're not this is

845
00:27:26,400 --> 00:27:28,159
the sort of log that you can collect and

846
00:27:28,159 --> 00:27:29,840
take to manage in management and say

847
00:27:29,840 --> 00:27:31,360
this is how we got owned and this is why

848
00:27:31,360 --> 00:27:33,279
we should be whitelisting so it's still

849
00:27:33,279 --> 00:27:36,080
good information to bring in

850
00:27:36,080 --> 00:27:37,679
types of tools that you you want to look

851
00:27:37,679 --> 00:27:39,120
at and this actually references some

852
00:27:39,120 --> 00:27:40,559
things that we've brought up in

853
00:27:40,559 --> 00:27:43,919
presentations in the past these are uh

854
00:27:43,919 --> 00:27:45,679
tools that would be normal for an admin

855
00:27:45,679 --> 00:27:47,919
to run but if you see your average end

856
00:27:47,919 --> 00:27:50,080
user running these from the command line

857
00:27:50,080 --> 00:27:52,880
you probably have issues

858
00:27:52,880 --> 00:27:55,120
wmic definitely never going to see an

859
00:27:55,120 --> 00:27:56,880
end user do it half of your admins

860
00:27:56,880 --> 00:27:58,480
probably struggle with using those tools

861
00:27:58,480 --> 00:27:59,360
as well

862
00:27:59,360 --> 00:28:01,440
powershell you might if it's integrated

863
00:28:01,440 --> 00:28:03,279
into some of your normal scripts and so

864
00:28:03,279 --> 00:28:05,360
again you need to have that full

865
00:28:05,360 --> 00:28:06,799
command line and that's where you can do

866
00:28:06,799 --> 00:28:08,960
some great searching against that these

867
00:28:08,960 --> 00:28:10,720
other ones typically you're never going

868
00:28:10,720 --> 00:28:12,559
to see an end user run them

869
00:28:12,559 --> 00:28:14,399
so you definitely want to monitor for

870
00:28:14,399 --> 00:28:16,000
that sort of thing and these are the

871
00:28:16,000 --> 00:28:17,600
ones that are very unusual i mean

872
00:28:17,600 --> 00:28:19,039
typically even your admins aren't going

873
00:28:19,039 --> 00:28:22,000
to run these i.e exec you know that gets

874
00:28:22,000 --> 00:28:23,360
called from powershell a lot if you've

875
00:28:23,360 --> 00:28:25,039
been watching any of the the red team

876
00:28:25,039 --> 00:28:27,120
talks lately they they love these tools

877
00:28:27,120 --> 00:28:29,520
so we need to start looking for them and

878
00:28:29,520 --> 00:28:31,039
seeing when they're being used against

879
00:28:31,039 --> 00:28:33,200
us

880
00:28:33,760 --> 00:28:35,440
so here's sort of you know going back to

881
00:28:35,440 --> 00:28:36,720
the whole picture of what we talked

882
00:28:36,720 --> 00:28:38,480
about from pulling things from the

883
00:28:38,480 --> 00:28:40,240
perimeter all the way down to the

884
00:28:40,240 --> 00:28:41,520
endpoint what does it look like when

885
00:28:41,520 --> 00:28:44,640
we're actually doing an investigation so

886
00:28:44,640 --> 00:28:46,640
we have an alert that would be triggered

887
00:28:46,640 --> 00:28:48,080
in our network if there's a large

888
00:28:48,080 --> 00:28:50,640
outbound flow of data to an ip address

889
00:28:50,640 --> 00:28:52,559
that we have not previously whitelisted

890
00:28:52,559 --> 00:28:54,880
meaning it's one of our trusted partners

891
00:28:54,880 --> 00:28:56,720
it's going to trigger an offense when it

892
00:28:56,720 --> 00:28:58,640
comes time to investigate that

893
00:28:58,640 --> 00:28:59,840
you know if we looked at just the

894
00:28:59,840 --> 00:29:02,159
perimeter firewall for that outbound ip

895
00:29:02,159 --> 00:29:03,600
address the source ip is going to show

896
00:29:03,600 --> 00:29:05,279
up as our proxy typically and that's not

897
00:29:05,279 --> 00:29:07,279
going to give us much information since

898
00:29:07,279 --> 00:29:09,760
we've sampled our flows from the user

899
00:29:09,760 --> 00:29:12,000
side of the proxy we can actually figure

900
00:29:12,000 --> 00:29:14,159
out okay what is the actual source ip

901
00:29:14,159 --> 00:29:16,799
address that's great information

902
00:29:16,799 --> 00:29:18,799
digging into the actual proxy and client

903
00:29:18,799 --> 00:29:20,159
firewall logs

904
00:29:20,159 --> 00:29:22,000
if we just search on that destination ip

905
00:29:22,000 --> 00:29:23,200
we're going to be able to extract what

906
00:29:23,200 --> 00:29:25,120
was the user agent and does that match

907
00:29:25,120 --> 00:29:27,440
up with the application that was said to

908
00:29:27,440 --> 00:29:30,000
be running from the firewall rules if

909
00:29:30,000 --> 00:29:32,320
it's saying that it's user agent ie

910
00:29:32,320 --> 00:29:34,960
but it's a randomly generated string of

911
00:29:34,960 --> 00:29:36,880
letters for the executable you've got

912
00:29:36,880 --> 00:29:38,080
issues

913
00:29:38,080 --> 00:29:39,600
so that allows us to validate that it

914
00:29:39,600 --> 00:29:42,240
was actually a legitimate program

915
00:29:42,240 --> 00:29:44,240
if we have the full url which you would

916
00:29:44,240 --> 00:29:46,080
get if you're doing full ssl decryption

917
00:29:46,080 --> 00:29:48,000
you may be able to actually pick out

918
00:29:48,000 --> 00:29:49,279
what was the file that was being

919
00:29:49,279 --> 00:29:51,440
uploaded at that point in time and then

920
00:29:51,440 --> 00:29:52,960
you pick up the phone and call the user

921
00:29:52,960 --> 00:29:55,760
and say hey what was going on um you

922
00:29:55,760 --> 00:29:58,240
know for us luckily fortunately

923
00:29:58,240 --> 00:30:00,640
to date we've only had those calls where

924
00:30:00,640 --> 00:30:01,760
they're like yeah i was uploading a

925
00:30:01,760 --> 00:30:04,080
bunch of photos to gmail and we're like

926
00:30:04,080 --> 00:30:05,919
well don't do that on our network so

927
00:30:05,919 --> 00:30:07,600
that we don't have these triggers and

928
00:30:07,600 --> 00:30:09,520
that sort of also gets the word out that

929
00:30:09,520 --> 00:30:11,520
says yeah big brother is definitely

930
00:30:11,520 --> 00:30:13,760
watching so

931
00:30:13,760 --> 00:30:15,360
it's a good way to go into it but you

932
00:30:15,360 --> 00:30:17,120
know this whole process since we've got

933
00:30:17,120 --> 00:30:18,559
all this stuff into our sim and

934
00:30:18,559 --> 00:30:20,720
centrally managed and cleaned up this

935
00:30:20,720 --> 00:30:22,799
can be done in a matter of minutes

936
00:30:22,799 --> 00:30:24,880
rather than having to go out to the end

937
00:30:24,880 --> 00:30:26,720
point dig around and try and figure out

938
00:30:26,720 --> 00:30:28,799
what happened

939
00:30:28,799 --> 00:30:30,640
so what do we see as sort of the

940
00:30:30,640 --> 00:30:33,120
failures of sim vendors at this point

941
00:30:33,120 --> 00:30:34,399
at this point

942
00:30:34,399 --> 00:30:35,840
there's just a lot of payloads that

943
00:30:35,840 --> 00:30:37,840
aren't processed to their fullest extent

944
00:30:37,840 --> 00:30:39,279
especially when you look at the newer

945
00:30:39,279 --> 00:30:41,039
generations of stuff the next gen

946
00:30:41,039 --> 00:30:42,880
whatever that's doing that application

947
00:30:42,880 --> 00:30:44,960
identification they aren't picking that

948
00:30:44,960 --> 00:30:46,720
out and correlating that back very

949
00:30:46,720 --> 00:30:47,760
neatly

950
00:30:47,760 --> 00:30:48,720
um

951
00:30:48,720 --> 00:30:50,880
we sometimes in our experience i've seen

952
00:30:50,880 --> 00:30:52,799
poor communication between the vendors

953
00:30:52,799 --> 00:30:54,240
that are making the products and the sim

954
00:30:54,240 --> 00:30:56,720
vendors themselves so those log parsers

955
00:30:56,720 --> 00:30:59,440
are getting broken on a regular basis so

956
00:30:59,440 --> 00:31:00,960
you know another thing that you need to

957
00:31:00,960 --> 00:31:02,640
do if you're managing a sim is from time

958
00:31:02,640 --> 00:31:04,799
to time do a search just for unknown

959
00:31:04,799 --> 00:31:07,520
events or uncategorized events

960
00:31:07,520 --> 00:31:08,960
you're going to see a lot of things in

961
00:31:08,960 --> 00:31:10,880
there that you may have thought were

962
00:31:10,880 --> 00:31:12,720
being properly processed by the sim but

963
00:31:12,720 --> 00:31:13,919
weren't that's when you need to start

964
00:31:13,919 --> 00:31:15,760
opening tickets

965
00:31:15,760 --> 00:31:17,360
if you haven't opened a ticket with your

966
00:31:17,360 --> 00:31:18,480
sim vendor

967
00:31:18,480 --> 00:31:20,480
at least once or twice a month you're

968
00:31:20,480 --> 00:31:22,080
probably not paying attention to it

969
00:31:22,080 --> 00:31:23,840
enough to be be honest

970
00:31:23,840 --> 00:31:24,640
um

971
00:31:24,640 --> 00:31:26,880
a lot of the vendors will have their own

972
00:31:26,880 --> 00:31:29,120
you know ip reputation list and things

973
00:31:29,120 --> 00:31:31,360
like that that stuff in our experience

974
00:31:31,360 --> 00:31:32,720
is really becoming less and less

975
00:31:32,720 --> 00:31:33,840
valuable

976
00:31:33,840 --> 00:31:35,360
as everything's starting to be moved

977
00:31:35,360 --> 00:31:37,360
behind cdns or even the bad guys are

978
00:31:37,360 --> 00:31:39,279
putting everything behind cloudflare

979
00:31:39,279 --> 00:31:40,960
that's not going to be very useful at

980
00:31:40,960 --> 00:31:42,480
all it's just noise that you probably

981
00:31:42,480 --> 00:31:45,120
don't need so you know don't tell your

982
00:31:45,120 --> 00:31:46,559
sim salesman i said this when he's

983
00:31:46,559 --> 00:31:47,760
taking you out to lunch but you probably

984
00:31:47,760 --> 00:31:49,440
don't need to subscribe to those if as

985
00:31:49,440 --> 00:31:50,880
long as you have some clean traffic you

986
00:31:50,880 --> 00:31:52,480
can find a better signal in your your

987
00:31:52,480 --> 00:31:53,679
own stuff

988
00:31:53,679 --> 00:31:56,080
timing is still a major issue the idea

989
00:31:56,080 --> 00:31:57,840
that an endpoint might not be sending

990
00:31:57,840 --> 00:31:59,519
logs in real time is that something that

991
00:31:59,519 --> 00:32:00,880
they grasp with

992
00:32:00,880 --> 00:32:02,640
and there also still just seems to be a

993
00:32:02,640 --> 00:32:04,320
lot of lack of support for the

994
00:32:04,320 --> 00:32:07,120
non-standard windows log types

995
00:32:07,120 --> 00:32:09,039
if you say i want to pull things out of

996
00:32:09,039 --> 00:32:11,200
the sysmon logs which isn't sitting in

997
00:32:11,200 --> 00:32:12,960
security or applications or something

998
00:32:12,960 --> 00:32:14,559
like that they're going to look at you

999
00:32:14,559 --> 00:32:16,159
and say why and you have to kind of

1000
00:32:16,159 --> 00:32:17,760
explain this is what i want to do and

1001
00:32:17,760 --> 00:32:19,519
it's really cool

1002
00:32:19,519 --> 00:32:20,640
and then you have to jump through the

1003
00:32:20,640 --> 00:32:22,080
hoops of trying to get it properly

1004
00:32:22,080 --> 00:32:24,159
qualified so that they it's categorized

1005
00:32:24,159 --> 00:32:26,240
properly within the sim and there just

1006
00:32:26,240 --> 00:32:28,159
doesn't really seem to be any

1007
00:32:28,159 --> 00:32:30,399
correlation around application execution

1008
00:32:30,399 --> 00:32:31,840
at all

1009
00:32:31,840 --> 00:32:33,440
and that's where everyone in this room

1010
00:32:33,440 --> 00:32:35,279
comes in really i mean we're the

1011
00:32:35,279 --> 00:32:37,200
customers of these systems in many cases

1012
00:32:37,200 --> 00:32:38,720
and if we don't start calling our sem

1013
00:32:38,720 --> 00:32:40,799
vendors and saying this is what i want

1014
00:32:40,799 --> 00:32:42,000
they're not going to implement these

1015
00:32:42,000 --> 00:32:44,159
things i mean we we actually

1016
00:32:44,159 --> 00:32:45,440
unfortunately have a very good

1017
00:32:45,440 --> 00:32:46,880
relationship with our sim vendor to the

1018
00:32:46,880 --> 00:32:48,399
point where we have a quarterly call

1019
00:32:48,399 --> 00:32:50,240
with their developers where we're saying

1020
00:32:50,240 --> 00:32:51,600
this is what we're trying to do these

1021
00:32:51,600 --> 00:32:53,200
are the things that aren't working can

1022
00:32:53,200 --> 00:32:55,519
you please make this happen and what we

1023
00:32:55,519 --> 00:32:57,760
always hear as a response is well we

1024
00:32:57,760 --> 00:33:00,240
would love to but what we need to do is

1025
00:33:00,240 --> 00:33:01,840
have this come forward from multiple

1026
00:33:01,840 --> 00:33:03,760
customers so i'm begging you guys as

1027
00:33:03,760 --> 00:33:05,840
customers of your sim vendors call them

1028
00:33:05,840 --> 00:33:08,080
up say this is what i want to do let's

1029
00:33:08,080 --> 00:33:10,080
start getting this there

1030
00:33:10,080 --> 00:33:11,360
if you aren't spending the time to

1031
00:33:11,360 --> 00:33:12,960
configure the basics and cleaning up the

1032
00:33:12,960 --> 00:33:14,720
rogue services and whatnot you're really

1033
00:33:14,720 --> 00:33:15,840
wasting

1034
00:33:15,840 --> 00:33:17,919
time with your sim and money

1035
00:33:17,919 --> 00:33:19,679
your sim is only as good as the signal

1036
00:33:19,679 --> 00:33:21,919
it gets so this is why we advocate

1037
00:33:21,919 --> 00:33:24,159
taking the methodical approach add one

1038
00:33:24,159 --> 00:33:26,000
source at a time make sure it's looking

1039
00:33:26,000 --> 00:33:28,240
good and clean tweak it if need be don't

1040
00:33:28,240 --> 00:33:29,760
do anything more until you've got that

1041
00:33:29,760 --> 00:33:32,080
source in and it is painstaking and it

1042
00:33:32,080 --> 00:33:34,480
does take time and that's why two years

1043
00:33:34,480 --> 00:33:36,000
later we're just now giving this talk

1044
00:33:36,000 --> 00:33:38,159
saying we are feeling pretty good about

1045
00:33:38,159 --> 00:33:40,000
our sim but we still feel like we got a

1046
00:33:40,000 --> 00:33:42,480
whole lot of work to go so

1047
00:33:42,480 --> 00:33:44,240
your end goal just needs to be a low

1048
00:33:44,240 --> 00:33:46,000
noise environment that enables you to

1049
00:33:46,000 --> 00:33:47,760
actually detect when the anomalous

1050
00:33:47,760 --> 00:33:50,640
behavior happens

1051
00:33:50,640 --> 00:33:52,480
so if you have any questions i would be

1052
00:33:52,480 --> 00:33:54,000
happy to answer some of them now or if

1053
00:33:54,000 --> 00:33:55,679
you want to hit us up on twitter twitter

1054
00:33:55,679 --> 00:33:58,399
later we're we're glad to do that yes so

1055
00:33:58,399 --> 00:34:00,399
after you've applied the filters do you

1056
00:34:00,399 --> 00:34:02,399
find useful for all those client event

1057
00:34:02,399 --> 00:34:04,799
logs sysmon app locker

1058
00:34:04,799 --> 00:34:06,880
that and things like that

1059
00:34:06,880 --> 00:34:08,000
um

1060
00:34:08,000 --> 00:34:10,239
about how much data are you typically

1061
00:34:10,239 --> 00:34:11,679
seeing from the average workstation in

1062
00:34:11,679 --> 00:34:13,839
terms of the number of events as well as

1063
00:34:13,839 --> 00:34:15,679
like megabytes grenade okay so the

1064
00:34:15,679 --> 00:34:16,800
question is after we've done our

1065
00:34:16,800 --> 00:34:20,000
filtering down how much our eps per from

1066
00:34:20,000 --> 00:34:22,239
each individual source of the end points

1067
00:34:22,239 --> 00:34:24,000
are we seeing or how much per day are we

1068
00:34:24,000 --> 00:34:26,159
seeing um

1069
00:34:26,159 --> 00:34:27,918
honestly when we

1070
00:34:27,918 --> 00:34:29,199
we first started doing this our

1071
00:34:29,199 --> 00:34:30,399
chattiest log that we were trying to

1072
00:34:30,399 --> 00:34:32,560
bring in was app locker and in a single

1073
00:34:32,560 --> 00:34:34,879
day you could get 30 megabytes of data

1074
00:34:34,879 --> 00:34:36,639
if you pulled everything in so the first

1075
00:34:36,639 --> 00:34:38,239
thing we said was that's not going to

1076
00:34:38,239 --> 00:34:39,520
work if we're pulling that from all our

1077
00:34:39,520 --> 00:34:41,679
endpoints do we really need dll

1078
00:34:41,679 --> 00:34:43,760
application executions compared to just

1079
00:34:43,760 --> 00:34:46,399
exe executions that's a simple i know

1080
00:34:46,399 --> 00:34:47,679
you would want it but when you think

1081
00:34:47,679 --> 00:34:49,440
about you know thousands of endpoints

1082
00:34:49,440 --> 00:34:51,199
feeding it that's the type of decision

1083
00:34:51,199 --> 00:34:53,119
that you have to make and realize that

1084
00:34:53,119 --> 00:34:55,280
just getting the executable happening

1085
00:34:55,280 --> 00:34:57,760
that's far better than nothing so that

1086
00:34:57,760 --> 00:34:59,520
trimmed that down significantly i would

1087
00:34:59,520 --> 00:35:02,079
say on a daily basis just the endpoint

1088
00:35:02,079 --> 00:35:03,760
logs that we're pulling in from from an

1089
00:35:03,760 --> 00:35:05,440
endpoint is probably on the order of a

1090
00:35:05,440 --> 00:35:07,119
couple of hundred logs

1091
00:35:07,119 --> 00:35:09,119
and it sounds minimal but in our

1092
00:35:09,119 --> 00:35:11,119
experience we really

1093
00:35:11,119 --> 00:35:13,520
i mean for for event logs yes but for

1094
00:35:13,520 --> 00:35:15,839
your client firewall that is the top log

1095
00:35:15,839 --> 00:35:17,839
source that's the top talker yeah

1096
00:35:17,839 --> 00:35:19,359
because you have rules enabled for every

1097
00:35:19,359 --> 00:35:21,280
single client times

1098
00:35:21,280 --> 00:35:22,800
the number of clients you have so that

1099
00:35:22,800 --> 00:35:24,640
is the largest log source consump

1100
00:35:24,640 --> 00:35:26,400
consumer but for event windows event

1101
00:35:26,400 --> 00:35:28,720
logs yeah not that much windows event

1102
00:35:28,720 --> 00:35:30,960
logs is a couple hundred a day so i can

1103
00:35:30,960 --> 00:35:34,480
expand dramatically on that so um

1104
00:35:34,480 --> 00:35:36,480
the windows firewall logs generate two

1105
00:35:36,480 --> 00:35:40,320
messages 5156 5158 you do not need 5158

1106
00:35:40,320 --> 00:35:41,920
for any usefulness

1107
00:35:41,920 --> 00:35:44,000
process command process execution and

1108
00:35:44,000 --> 00:35:47,599
process terminations 468 4689 those top

1109
00:35:47,599 --> 00:35:49,040
four right there you do not need

1110
00:35:49,040 --> 00:35:50,160
termination because you just want to

1111
00:35:50,160 --> 00:35:52,079
know when something executes those top

1112
00:35:52,079 --> 00:35:54,560
four right there will equal more than

1113
00:35:54,560 --> 00:35:56,720
all the other logs combined

1114
00:35:56,720 --> 00:35:58,880
i can get my lovely license for my

1115
00:35:58,880 --> 00:36:00,720
personal lab stuff and all my research

1116
00:36:00,720 --> 00:36:02,320
is a one gig per day

1117
00:36:02,320 --> 00:36:04,000
um if i turn on all the stuff that's in

1118
00:36:04,000 --> 00:36:05,920
my windows logging sheet very similar to

1119
00:36:05,920 --> 00:36:07,200
what they're talking about which is

1120
00:36:07,200 --> 00:36:08,800
everything windows firewall process

1121
00:36:08,800 --> 00:36:11,839
execution sysmon fully fully loaded with

1122
00:36:11,839 --> 00:36:15,040
uh module executions and all that stuff

1123
00:36:15,040 --> 00:36:17,200
um i can easily fill in a day one

1124
00:36:17,200 --> 00:36:19,839
workstation one gig but if i filter and

1125
00:36:19,839 --> 00:36:21,280
you can actually get that off my website

1126
00:36:21,280 --> 00:36:22,880
i have an nx lav com file to give you an

1127
00:36:22,880 --> 00:36:25,119
idea how to filter stuff i can easily

1128
00:36:25,119 --> 00:36:27,520
get 10 clients 10 times the amount of

1129
00:36:27,520 --> 00:36:29,200
clients into that one gig per day

1130
00:36:29,200 --> 00:36:31,520
license and logly for example

1131
00:36:31,520 --> 00:36:33,040
it is very noisy but you can also then

1132
00:36:33,040 --> 00:36:34,800
taper it off over time saying well keep

1133
00:36:34,800 --> 00:36:37,200
it's 30 days and then i'll age it out

1134
00:36:37,200 --> 00:36:39,680
um but yeah it's it's huge but the value

1135
00:36:39,680 --> 00:36:41,760
is ginormous

1136
00:36:41,760 --> 00:36:43,119
and i would say you know something you

1137
00:36:43,119 --> 00:36:45,200
can do is again and we've said this in

1138
00:36:45,200 --> 00:36:46,880
other presentations don't let perfect be

1139
00:36:46,880 --> 00:36:48,640
the enemy of good start small if you

1140
00:36:48,640 --> 00:36:50,960
need to if you do nothing more than just

1141
00:36:50,960 --> 00:36:51,760
have

1142
00:36:51,760 --> 00:36:53,760
your agent that's able to collect logs

1143
00:36:53,760 --> 00:36:55,040
and able to be

1144
00:36:55,040 --> 00:36:57,520
tweaked when you need to to increase

1145
00:36:57,520 --> 00:36:59,280
what logs it's bringing in so if there

1146
00:36:59,280 --> 00:37:00,800
is some sort of an incident you can go

1147
00:37:00,800 --> 00:37:03,200
back and turn and ramp that up

1148
00:37:03,200 --> 00:37:04,400
but you know start with just what you

1149
00:37:04,400 --> 00:37:06,400
need i mean if you looked at the nsa

1150
00:37:06,400 --> 00:37:08,000
guide and all you did was enable

1151
00:37:08,000 --> 00:37:09,760
collection of one event type

1152
00:37:09,760 --> 00:37:12,560
ntlm lateral movement with a non-domain

1153
00:37:12,560 --> 00:37:15,119
account to show passing the hashtag as

1154
00:37:15,119 --> 00:37:17,040
things start there

1155
00:37:17,040 --> 00:37:18,640
it's better than nothing

1156
00:37:18,640 --> 00:37:20,000
and then from there you can just start

1157
00:37:20,000 --> 00:37:21,440
ramping it up and see where you get

1158
00:37:21,440 --> 00:37:23,520
comfortable on it at that point so

1159
00:37:23,520 --> 00:37:25,200
another great trick is creator know you

1160
00:37:25,200 --> 00:37:26,960
that has all this turned on

1161
00:37:26,960 --> 00:37:27,839
okay

1162
00:37:27,839 --> 00:37:29,280
and then you can drag your workstations

1163
00:37:29,280 --> 00:37:31,119
you want to investigate into that who

1164
00:37:31,119 --> 00:37:33,040
use added so that your your log will

1165
00:37:33,040 --> 00:37:34,720
spike up so i do this for a lot for

1166
00:37:34,720 --> 00:37:36,400
windows firewall because it's so noisy

1167
00:37:36,400 --> 00:37:37,760
that if i'm investigating somebody i

1168
00:37:37,760 --> 00:37:39,520
need these 12 clients added to this ou

1169
00:37:39,520 --> 00:37:41,280
and now that's automatically turned on

1170
00:37:41,280 --> 00:37:43,040
and then i can turn it off if i'm not

1171
00:37:43,040 --> 00:37:44,320
doing anything there's no other

1172
00:37:44,320 --> 00:37:45,599
indicator that i'm getting from the

1173
00:37:45,599 --> 00:37:46,720
lower level

1174
00:37:46,720 --> 00:37:48,880
loud logs you can totally control that

1175
00:37:48,880 --> 00:37:51,119
from gpo to apply stuff on and take

1176
00:37:51,119 --> 00:37:53,119
something

1177
00:37:53,119 --> 00:37:55,440
um that was but anyway the extent was uh

1178
00:37:55,440 --> 00:37:57,119
create a special lu that turns all this

1179
00:37:57,119 --> 00:38:00,000
stuff on drag systems into it

1180
00:38:00,000 --> 00:38:01,440
as you're investigating so you can bring

1181
00:38:01,440 --> 00:38:02,720
the logs up and then when you're done

1182
00:38:02,720 --> 00:38:04,400
investigating bring it back down and

1183
00:38:04,400 --> 00:38:06,240
then log for the short course stuff like

1184
00:38:06,240 --> 00:38:08,160
a new service you see five systems with

1185
00:38:08,160 --> 00:38:09,839
a new service for example okay i'm gonna

1186
00:38:09,839 --> 00:38:11,599
drag those five into the bucket that

1187
00:38:11,599 --> 00:38:13,760
turns all this stuff on collect it short

1188
00:38:13,760 --> 00:38:15,839
period to do your investigation then

1189
00:38:15,839 --> 00:38:17,359
pull them back out and you can get all

1190
00:38:17,359 --> 00:38:18,480
the nice data

1191
00:38:18,480 --> 00:38:19,839
come to a conclusion and then pull them

1192
00:38:19,839 --> 00:38:21,920
back out so ou's with just the

1193
00:38:21,920 --> 00:38:24,480
workstations you need are awesome any

1194
00:38:24,480 --> 00:38:26,320
other questions

1195
00:38:26,320 --> 00:38:27,920
yes sir

1196
00:38:27,920 --> 00:38:31,640
do you have any problems

1197
00:38:32,000 --> 00:38:34,560
so your dns example of getting rid of

1198
00:38:34,560 --> 00:38:36,800
specific ports i feel like my security

1199
00:38:36,800 --> 00:38:38,400
team would have the field they would be

1200
00:38:38,400 --> 00:38:41,040
disabling valid traffic versus if i have

1201
00:38:41,040 --> 00:38:42,880
a limitation in my license to just

1202
00:38:42,880 --> 00:38:44,800
collect that on a syslog server and just

1203
00:38:44,800 --> 00:38:47,040
knock

1204
00:38:54,320 --> 00:38:55,839
so the question is basically do we ever

1205
00:38:55,839 --> 00:38:57,680
have issues with our security team being

1206
00:38:57,680 --> 00:39:00,240
angry of us turning off certain logs in

1207
00:39:00,240 --> 00:39:02,079
order to try and filter up at the source

1208
00:39:02,079 --> 00:39:04,320
rather than trying to collect them all

1209
00:39:04,320 --> 00:39:06,800
and then process them um so you know one

1210
00:39:06,800 --> 00:39:08,960
of the fortunate things that we have is

1211
00:39:08,960 --> 00:39:10,240
you're actually looking at the entire

1212
00:39:10,240 --> 00:39:12,160
security team for our organization right

1213
00:39:12,160 --> 00:39:12,839
now

1214
00:39:12,839 --> 00:39:14,400
so

1215
00:39:14,400 --> 00:39:16,400
we arm wrestle sometimes if we need to

1216
00:39:16,400 --> 00:39:17,760
but we don't have too much internal

1217
00:39:17,760 --> 00:39:19,839
conflict or strife on that

1218
00:39:19,839 --> 00:39:20,640
but

1219
00:39:20,640 --> 00:39:22,079
you know in organizations where there's

1220
00:39:22,079 --> 00:39:23,040
that you know one thing that you might

1221
00:39:23,040 --> 00:39:26,079
consider is uh and something that even

1222
00:39:26,079 --> 00:39:28,400
our se from our sim vendor recommended

1223
00:39:28,400 --> 00:39:30,320
was you can always have a separate log

1224
00:39:30,320 --> 00:39:32,640
collector that does the filtering that

1225
00:39:32,640 --> 00:39:34,400
is capturing everything that isn't the

1226
00:39:34,400 --> 00:39:36,079
sim and you know it's just being a

1227
00:39:36,079 --> 00:39:37,599
syslog destination where you're keeping

1228
00:39:37,599 --> 00:39:38,800
it all but you're then doing that

1229
00:39:38,800 --> 00:39:40,800
filtering there and push that into the

1230
00:39:40,800 --> 00:39:42,240
sim where the ones that you care about

1231
00:39:42,240 --> 00:39:43,440
are going to be correlated and dealt

1232
00:39:43,440 --> 00:39:45,680
with that's one way to approach it

1233
00:39:45,680 --> 00:39:46,960
it's really one of those things where if

1234
00:39:46,960 --> 00:39:48,560
you've got a tricky organization you've

1235
00:39:48,560 --> 00:39:50,240
just got to you know

1236
00:39:50,240 --> 00:39:51,839
tell them well if you want to have all

1237
00:39:51,839 --> 00:39:53,680
these logs give us some of your budget

1238
00:39:53,680 --> 00:39:56,160
and we'd be happy to fill it in this is

1239
00:39:56,160 --> 00:39:59,200
cheap right so yeah

1240
00:39:59,359 --> 00:40:01,280
that's great

1241
00:40:01,280 --> 00:40:03,520
oh yeah we actually got another chip

1242
00:40:03,520 --> 00:40:05,119
we got one other question i would say

1243
00:40:05,119 --> 00:40:07,920
that uh if the item

1244
00:40:07,920 --> 00:40:09,920
on the security team usually i'm the one

1245
00:40:09,920 --> 00:40:12,240
pushing for more lobby and the ops team

1246
00:40:12,240 --> 00:40:14,079
is pushing back because they're looking

1247
00:40:14,079 --> 00:40:15,440
at um

1248
00:40:15,440 --> 00:40:17,839
uptime and response time of what they're

1249
00:40:17,839 --> 00:40:20,800
mastering their monitors so that becomes

1250
00:40:20,800 --> 00:40:23,599
the uh trade off in the

1251
00:40:23,599 --> 00:40:26,000
negotiation point between security and

1252
00:40:26,000 --> 00:40:29,119
ops not necessarily between security um

1253
00:40:29,119 --> 00:40:30,640
and so we end up having to figure out

1254
00:40:30,640 --> 00:40:32,720
what's the best bang for the buck and

1255
00:40:32,720 --> 00:40:35,760
how to alternatively collect the data we

1256
00:40:35,760 --> 00:40:39,400
need if

1257
00:40:48,880 --> 00:40:50,400
yeah i mean all of these i mean all of

1258
00:40:50,400 --> 00:40:52,000
this what it really comes down to is the

1259
00:40:52,000 --> 00:40:53,760
very one of the very first things that

1260
00:40:53,760 --> 00:40:55,599
we started saying is think about it as

1261
00:40:55,599 --> 00:40:57,920
an overall design architecture from the

1262
00:40:57,920 --> 00:41:00,000
get-go and you know one of those things

1263
00:41:00,000 --> 00:41:01,920
where they they talk about an ounce of

1264
00:41:01,920 --> 00:41:03,599
prevention is worth a pound of cure i

1265
00:41:03,599 --> 00:41:05,760
mean if you're thinking of it up front

1266
00:41:05,760 --> 00:41:07,599
of and having these discussions with

1267
00:41:07,599 --> 00:41:09,119
everyone as you're getting to roll this

1268
00:41:09,119 --> 00:41:11,119
out that can save you a lot of pain and

1269
00:41:11,119 --> 00:41:13,119
a lot of the these heartaches and

1270
00:41:13,119 --> 00:41:15,760
arguments internal strife after the fact

1271
00:41:15,760 --> 00:41:21,000
so other other questions or over here

1272
00:41:30,480 --> 00:41:32,839
i can say no i don't

1273
00:41:32,839 --> 00:41:35,280
so sorry

1274
00:41:35,280 --> 00:41:37,520
sir

1275
00:41:44,319 --> 00:41:45,680
the question is any experience with

1276
00:41:45,680 --> 00:41:47,839
deploying windows powershell logging you

1277
00:41:47,839 --> 00:41:49,359
said

1278
00:41:49,359 --> 00:41:50,720
from the endpoints and i think that's

1279
00:41:50,720 --> 00:41:52,400
one of the the newer features that are

1280
00:41:52,400 --> 00:41:53,359
you talking about the new features that

1281
00:41:53,359 --> 00:41:54,880
are coming out with the actual

1282
00:41:54,880 --> 00:41:56,800
powershell logging we actually haven't

1283
00:41:56,800 --> 00:41:58,480
gone that direction yet it's something

1284
00:41:58,480 --> 00:42:00,240
that we're interested in the future but

1285
00:42:00,240 --> 00:42:01,760
for now we're really just digging into

1286
00:42:01,760 --> 00:42:03,599
sysmond for that because sysmon is going

1287
00:42:03,599 --> 00:42:05,760
to give us the full powershell as it got

1288
00:42:05,760 --> 00:42:07,599
executed uh while we wouldn't

1289
00:42:07,599 --> 00:42:09,359
necessarily get get the logging if it's

1290
00:42:09,359 --> 00:42:11,599
inside of a script uh we get at least

1291
00:42:11,599 --> 00:42:13,839
the notification that the script went if

1292
00:42:13,839 --> 00:42:16,560
you if you took carlos perez's class he

1293
00:42:16,560 --> 00:42:18,720
talks about the logging specifically but

1294
00:42:18,720 --> 00:42:20,079
it's either

1295
00:42:20,079 --> 00:42:22,160
i think he compares sysmon logging with

1296
00:42:22,160 --> 00:42:24,319
powershelf initially until you start

1297
00:42:24,319 --> 00:42:26,960
talking about capturing uh transcripts

1298
00:42:26,960 --> 00:42:28,480
so if you want that level you definitely

1299
00:42:28,480 --> 00:42:30,640
want to turn it on but power cismod will

1300
00:42:30,640 --> 00:42:32,240
give you enough

1301
00:42:32,240 --> 00:42:34,400
unless you have a lot of storage again

1302
00:42:34,400 --> 00:42:36,640
i mean one of the things that um it's no

1303
00:42:36,640 --> 00:42:38,480
secret we love white listing and so we

1304
00:42:38,480 --> 00:42:40,960
are doing that and so for us it's not as

1305
00:42:40,960 --> 00:42:42,800
much of a concern that we wouldn't get

1306
00:42:42,800 --> 00:42:44,960
the full script uh as it was being

1307
00:42:44,960 --> 00:42:46,960
transpired or whatever because

1308
00:42:46,960 --> 00:42:48,319
that script's not going to execute and

1309
00:42:48,319 --> 00:42:49,599
it's going to be blocked

1310
00:42:49,599 --> 00:42:51,839
by the white listing level so it's more

1311
00:42:51,839 --> 00:42:54,000
that we have to worry about if they did

1312
00:42:54,000 --> 00:42:56,839
if they were as an admin running a power

1313
00:42:56,839 --> 00:43:00,560
shell um i do have extreme experience

1314
00:43:00,560 --> 00:43:02,000
i'm releasing a windows powershell

1315
00:43:02,000 --> 00:43:04,480
logging gg for this your main focus is

1316
00:43:04,480 --> 00:43:05,599
going to be there's two logs there's a

1317
00:43:05,599 --> 00:43:07,680
windows powershell log under the

1318
00:43:07,680 --> 00:43:10,240
security log area basic logs and then

1319
00:43:10,240 --> 00:43:12,400
under microsoft windows

1320
00:43:12,400 --> 00:43:14,240
there it i have a pretty loud voice but

1321
00:43:14,240 --> 00:43:16,480
i bet they're recording it sorry um and

1322
00:43:16,480 --> 00:43:18,079
then under the microsoft windows there's

1323
00:43:18,079 --> 00:43:20,480
another powershell log so if you want to

1324
00:43:20,480 --> 00:43:22,160
know about the subject a research what

1325
00:43:22,160 --> 00:43:25,200
ben 10 is doing uh ben 10 actually b be

1326
00:43:25,200 --> 00:43:26,400
in to ian

1327
00:43:26,400 --> 00:43:28,000
he's a powershell guru and he actually

1328
00:43:28,000 --> 00:43:29,040
slowed down

1329
00:43:29,040 --> 00:43:31,599
my release of the powershell logging so

1330
00:43:31,599 --> 00:43:34,640
a you're looking for event ids 501 to

1331
00:43:34,640 --> 00:43:36,800
execute you cannot get that unless you

1332
00:43:36,800 --> 00:43:38,720
create a default profile in that

1333
00:43:38,720 --> 00:43:40,880
enabling the two variables you need so

1334
00:43:40,880 --> 00:43:43,280
every session and powershell triggers

1335
00:43:43,280 --> 00:43:44,400
and then you'll get the command line

1336
00:43:44,400 --> 00:43:45,280
logging

1337
00:43:45,280 --> 00:43:47,520
most a matter of fact the

1338
00:43:47,520 --> 00:43:49,200
the laughing thing is you know that

1339
00:43:49,200 --> 00:43:50,720
example they gave you the menu with 10.

1340
00:43:50,720 --> 00:43:52,400
exe that that

1341
00:43:52,400 --> 00:43:55,760
malware in my workshop it was 9.exe so

1342
00:43:55,760 --> 00:43:58,000
they had the next version in their prezo

1343
00:43:58,000 --> 00:44:00,800
that launched a powershell backdoor to

1344
00:44:00,800 --> 00:44:02,720
ukraine in the case of my particular

1345
00:44:02,720 --> 00:44:05,200
sample that i was evaluating lab

1346
00:44:05,200 --> 00:44:06,720
in order to capture that you must have a

1347
00:44:06,720 --> 00:44:08,319
default profile but this particular

1348
00:44:08,319 --> 00:44:10,720
malware actually executed the execution

1349
00:44:10,720 --> 00:44:13,520
policy bypass no profile so no logging

1350
00:44:13,520 --> 00:44:15,280
occurred but the fact that i got that as

1351
00:44:15,280 --> 00:44:16,319
an alert

1352
00:44:16,319 --> 00:44:17,839
is going to tell me i won't get

1353
00:44:17,839 --> 00:44:19,119
powershell logging so i have to use

1354
00:44:19,119 --> 00:44:21,359
something else or just re-image the box

1355
00:44:21,359 --> 00:44:22,960
but you're looking at having to do those

1356
00:44:22,960 --> 00:44:24,880
two variables you're having a look in

1357
00:44:24,880 --> 00:44:27,680
the the windows powershell for a 500 or

1358
00:44:27,680 --> 00:44:29,440
501 you won't see those unless you do

1359
00:44:29,440 --> 00:44:30,960
those variables and then the windows

1360
00:44:30,960 --> 00:44:33,040
powershell log has some vents in the

1361
00:44:33,040 --> 00:44:35,040
4000 series but they're more like a

1362
00:44:35,040 --> 00:44:36,960
transcript dump so you'll have to parse

1363
00:44:36,960 --> 00:44:37,599
those out they're going to be

1364
00:44:37,599 --> 00:44:39,040
excessively long and cut off in some of

1365
00:44:39,040 --> 00:44:40,960
the sim solutions and that you can

1366
00:44:40,960 --> 00:44:43,599
detect the powershell executions that

1367
00:44:43,599 --> 00:44:45,920
were not executed with powershell.exe

1368
00:44:45,920 --> 00:44:47,200
and yes thank you microsoft there's a

1369
00:44:47,200 --> 00:44:48,480
way to launch powershell without using

1370
00:44:48,480 --> 00:44:51,040
powershell x exe um so watch out for

1371
00:44:51,040 --> 00:44:52,960
that if you want but yes there is

1372
00:44:52,960 --> 00:44:55,200
there's some info coming

1373
00:44:55,200 --> 00:44:56,480
and you know just some one thing i would

1374
00:44:56,480 --> 00:44:58,319
add just you hear powershell powershell

1375
00:44:58,319 --> 00:45:00,560
powershell powershell if you aren't up

1376
00:45:00,560 --> 00:45:02,400
on powershell start reading up on it but

1377
00:45:02,400 --> 00:45:04,319
also something else that i think is very

1378
00:45:04,319 --> 00:45:05,520
important

1379
00:45:05,520 --> 00:45:07,119
powershell should not be talking to the

1380
00:45:07,119 --> 00:45:09,599
internet for most of your endpoints ever

1381
00:45:09,599 --> 00:45:11,440
ever ever

1382
00:45:11,440 --> 00:45:13,200
if you go back to our schmukon

1383
00:45:13,200 --> 00:45:15,440
presentation we put up a slide there we

1384
00:45:15,440 --> 00:45:17,680
showed an example stack two firewall

1385
00:45:17,680 --> 00:45:18,960
rules if you need powershell to have

1386
00:45:18,960 --> 00:45:21,359
network access internally one that says

1387
00:45:21,359 --> 00:45:23,359
allow powershell internally one that

1388
00:45:23,359 --> 00:45:25,440
says block powershell all

1389
00:45:25,440 --> 00:45:29,680
and that cuts it off right there so

1390
00:45:30,839 --> 00:45:33,119
yeah it was fun with our last pen test

1391
00:45:33,119 --> 00:45:35,200
they were complaining about how uh

1392
00:45:35,200 --> 00:45:37,040
they couldn't do something and and he

1393
00:45:37,040 --> 00:45:37,920
was talking about it it's gonna be

1394
00:45:37,920 --> 00:45:39,119
difficult for me to come back and do

1395
00:45:39,119 --> 00:45:40,640
something like i'll do it i can actually

1396
00:45:40,640 --> 00:45:42,720
run powershell so

1397
00:45:42,720 --> 00:45:43,920
fun when you restrict it just to

1398
00:45:43,920 --> 00:45:46,079
yourselves so a lot of these ideas are

1399
00:45:46,079 --> 00:45:48,480
from pen testers so pinterest come in

1400
00:45:48,480 --> 00:45:49,839
they come in and they

1401
00:45:49,839 --> 00:45:51,119
they beat us up for a little bit and

1402
00:45:51,119 --> 00:45:52,319
we're like all right we're going to

1403
00:45:52,319 --> 00:45:53,680
build these rules and then they come

1404
00:45:53,680 --> 00:45:55,119
back again next year like oh you're

1405
00:45:55,119 --> 00:45:56,800
stopping this stuff

1406
00:45:56,800 --> 00:45:58,079
it's like yeah you have to take it a

1407
00:45:58,079 --> 00:45:59,359
step up and they do and then we're like

1408
00:45:59,359 --> 00:46:01,119
alright build rules for that so most of

1409
00:46:01,119 --> 00:46:02,960
this stuff comes from

1410
00:46:02,960 --> 00:46:05,040
pen testers kind of coming in and doing

1411
00:46:05,040 --> 00:46:08,160
their red teaming in our environment

1412
00:46:08,160 --> 00:46:10,160
any other questions

1413
00:46:10,160 --> 00:46:11,760
well thank you everyone for attending

1414
00:46:11,760 --> 00:46:13,760
hope you enjoyed the talk and feel free

1415
00:46:13,760 --> 00:46:18,040
to reach us out to us in the future

