1
00:00:00,000 --> 00:00:02,009
so anyway thanks for coming to the talk

2
00:00:02,009 --> 00:00:04,230
I hoped you one of the comments had

3
00:00:04,230 --> 00:00:05,400
gotten yesterday from my training was

4
00:00:05,400 --> 00:00:06,930
that was really good actionable

5
00:00:06,930 --> 00:00:09,719
information so I'm a big advocate for

6
00:00:09,719 --> 00:00:11,130
talks that have actionable information

7
00:00:11,130 --> 00:00:14,040
meaning whatever we teach whatever I

8
00:00:14,040 --> 00:00:17,010
teach at least we should definitely make

9
00:00:17,010 --> 00:00:21,150
it a focus and a objective so that you

10
00:00:21,150 --> 00:00:23,519
can leave here going I can actually go

11
00:00:23,519 --> 00:00:25,710
back to work and do that and that's

12
00:00:25,710 --> 00:00:28,310
really my goal so with this talk

13
00:00:28,310 --> 00:00:30,390
unfortunately in the course of my last

14
00:00:30,390 --> 00:00:33,180
employer I had already accepted an offer

15
00:00:33,180 --> 00:00:36,840
before this occurred last Thanksgiving

16
00:00:36,840 --> 00:00:39,629
and so I did stay with them all through

17
00:00:39,629 --> 00:00:41,550
the point of getting this contained and

18
00:00:41,550 --> 00:00:43,829
beginning the cleanup or at least we had

19
00:00:43,829 --> 00:00:45,450
it completely isolated so we could start

20
00:00:45,450 --> 00:00:46,860
to clean up and then it became my

21
00:00:46,860 --> 00:00:49,559
buddies problem but I was there long

22
00:00:49,559 --> 00:00:50,969
enough to document everything that

23
00:00:50,969 --> 00:00:52,860
occurred and so I'm going to share that

24
00:00:52,860 --> 00:00:56,160
with you in regards to how a tell you

25
00:00:56,160 --> 00:00:57,960
little bit about the Chinese apt that

26
00:00:57,960 --> 00:01:00,660
we're talking about but also how we went

27
00:01:00,660 --> 00:01:04,170
about finding it now for those who don't

28
00:01:04,170 --> 00:01:07,500
know I do the logging training and yes I

29
00:01:07,500 --> 00:01:10,500
am a blue team defender ninja and I'm

30
00:01:10,500 --> 00:01:13,590
our archaeologist I really had to talk

31
00:01:13,590 --> 00:01:15,390
to me about that later and yes my name

32
00:01:15,390 --> 00:01:19,860
is Michael I'm a log aholic you're

33
00:01:19,860 --> 00:01:22,710
better than my training class was so you

34
00:01:22,710 --> 00:01:24,600
know I love properly configured logs I

35
00:01:24,600 --> 00:01:27,360
teach a lot of people about logs in and

36
00:01:27,360 --> 00:01:29,490
tell us who they tell us what they tell

37
00:01:29,490 --> 00:01:31,170
us where when and hopefully how

38
00:01:31,170 --> 00:01:33,329
obviously the why we can you know

39
00:01:33,329 --> 00:01:37,950
discuss that debate that all day long we

40
00:01:37,950 --> 00:01:40,799
got an interruption to feed okay there

41
00:01:40,799 --> 00:01:43,020
you go and i think i'm the creator the

42
00:01:43,020 --> 00:01:44,820
windows logging cheat sheet that's a

43
00:01:44,820 --> 00:01:46,979
real important component to this talk so

44
00:01:46,979 --> 00:01:50,100
it's a resource for you to take away you

45
00:01:50,100 --> 00:01:51,810
can google it and or just go to Mauer

46
00:01:51,810 --> 00:01:53,850
archaeology come and get it I am coming

47
00:01:53,850 --> 00:01:55,439
out with a Windows PowerShell logging

48
00:01:55,439 --> 00:01:57,450
cheat sheet thanks to ben 10 though that

49
00:01:57,450 --> 00:01:59,540
some of his little hackery of launching

50
00:01:59,540 --> 00:02:02,130
powershell without using powershell THC

51
00:02:02,130 --> 00:02:05,520
I gotta go update it so thank you ben 10

52
00:02:05,520 --> 00:02:09,869
my my internet internet con son and then

53
00:02:09,869 --> 00:02:12,540
i also recently it's lung comp it's a

54
00:02:12,540 --> 00:02:13,360
long story

55
00:02:13,360 --> 00:02:16,570
dallas dfw i also just released its

56
00:02:16,570 --> 00:02:18,310
blunt conf the windows splunk logging

57
00:02:18,310 --> 00:02:19,960
cheat sheet I got a lot of requests

58
00:02:19,960 --> 00:02:21,640
because I talked about using splunk in

59
00:02:21,640 --> 00:02:23,170
the course of many and people I've

60
00:02:23,170 --> 00:02:25,420
worked with and they say well you've got

61
00:02:25,420 --> 00:02:27,400
some short list of things that start me

62
00:02:27,400 --> 00:02:28,270
off so I can kind of get an

63
00:02:28,270 --> 00:02:30,100
understanding that's what this is for

64
00:02:30,100 --> 00:02:32,770
this is about six pages I think about

65
00:02:32,770 --> 00:02:35,560
five pages and then a huge component of

66
00:02:35,560 --> 00:02:37,960
this talk in regards to understanding

67
00:02:37,960 --> 00:02:39,850
how to start looking for advanced

68
00:02:39,850 --> 00:02:41,440
attacks is what I call them our

69
00:02:41,440 --> 00:02:43,480
management framework the idea here is

70
00:02:43,480 --> 00:02:44,620
everybody knows that vulnerability

71
00:02:44,620 --> 00:02:46,660
management is we get alerts and notices

72
00:02:46,660 --> 00:02:48,220
and vendors we read some of the vendor

73
00:02:48,220 --> 00:02:50,440
reports we possibly take action and

74
00:02:50,440 --> 00:02:52,630
eventually patch the system so it's

75
00:02:52,630 --> 00:02:54,400
something that generated from a vendor

76
00:02:54,400 --> 00:02:56,650
the information in it causes us to take

77
00:02:56,650 --> 00:02:58,720
an action Mauer management's the same

78
00:02:58,720 --> 00:03:01,300
thing I read the apt reports from

79
00:03:01,300 --> 00:03:04,450
eyesight partners that brought up wrote

80
00:03:04,450 --> 00:03:08,020
up targets breach in January I then make

81
00:03:08,020 --> 00:03:10,000
a lot of fun of home depot who got

82
00:03:10,000 --> 00:03:11,739
breached in July later that year because

83
00:03:11,739 --> 00:03:12,940
everything they needed to know was in

84
00:03:12,940 --> 00:03:15,100
that January report and I read those

85
00:03:15,100 --> 00:03:16,840
reports and I pull the artifacts out

86
00:03:16,840 --> 00:03:19,360
thus now our archaeology we collect

87
00:03:19,360 --> 00:03:22,000
artifacts of ancient mankind malware's

88
00:03:22,000 --> 00:03:25,019
written by man now artifacts right and

89
00:03:25,019 --> 00:03:27,280
basically you take this information and

90
00:03:27,280 --> 00:03:28,690
you can pilot you start improving your

91
00:03:28,690 --> 00:03:30,640
active defense am I looking for this

92
00:03:30,640 --> 00:03:33,459
thing in this place that this apt did am

93
00:03:33,459 --> 00:03:35,709
I looking for this artifact right some

94
00:03:35,709 --> 00:03:37,299
people call them ioc's a lot of people

95
00:03:37,299 --> 00:03:39,190
think I o Caesar md5 so I don't use

96
00:03:39,190 --> 00:03:42,130
ioc's for that reason but now or

97
00:03:42,130 --> 00:03:44,080
management framework is when I want to

98
00:03:44,080 --> 00:03:46,900
tweak tools I read these reports I see

99
00:03:46,900 --> 00:03:48,580
that they're starting let's say use the

100
00:03:48,580 --> 00:03:50,500
windows font directory and so I'm going

101
00:03:50,500 --> 00:03:52,060
to make sure I monitor the windows font

102
00:03:52,060 --> 00:03:53,739
directory for creation of new or drops

103
00:03:53,739 --> 00:03:55,299
of new files doesn't matter what type

104
00:03:55,299 --> 00:03:57,430
for example and this is really

105
00:03:57,430 --> 00:03:59,680
beneficial on the website Maori ecology

106
00:03:59,680 --> 00:04:01,390
calm there is a link of resources where

107
00:04:01,390 --> 00:04:02,530
does a whole lot of these I've collected

108
00:04:02,530 --> 00:04:04,750
and so if you want to start that concept

109
00:04:04,750 --> 00:04:06,400
of reading those and get to understand

110
00:04:06,400 --> 00:04:09,160
stuff highly recommend it i'm also the

111
00:04:09,160 --> 00:04:11,170
co-creator of log emd it was a tool we

112
00:04:11,170 --> 00:04:13,150
discussed yesterday in training i'm

113
00:04:13,150 --> 00:04:14,049
actually going to show you a little bit

114
00:04:14,049 --> 00:04:15,250
about that the end just couple

115
00:04:15,250 --> 00:04:17,769
screenshots the idea was i infect

116
00:04:17,769 --> 00:04:19,478
malware in a lab or i have to rebuild

117
00:04:19,478 --> 00:04:22,360
them our like from this attack into a

118
00:04:22,360 --> 00:04:24,490
lab make sure i know everything is doing

119
00:04:24,490 --> 00:04:25,510
so when it comes

120
00:04:25,510 --> 00:04:27,070
time to pull the switch and get rid of

121
00:04:27,070 --> 00:04:28,930
the malware and bandra mediate the

122
00:04:28,930 --> 00:04:30,910
problem I know everything I know and

123
00:04:30,910 --> 00:04:33,190
that gives us high confidence level I

124
00:04:33,190 --> 00:04:34,660
needed a faster way to gather some of

125
00:04:34,660 --> 00:04:36,580
that data and so Brian Boettcher of

126
00:04:36,580 --> 00:04:38,710
breaking down security and I basically

127
00:04:38,710 --> 00:04:41,080
wrote this tool dumps out a spreadsheet

128
00:04:41,080 --> 00:04:43,300
of all the data within the logs it's

129
00:04:43,300 --> 00:04:45,130
going to do some more and it won't run

130
00:04:45,130 --> 00:04:46,960
until you actually configure the logs

131
00:04:46,960 --> 00:04:48,970
based on the windows logging cheat sheet

132
00:04:48,970 --> 00:04:50,500
so there's a tie-in between the tool and

133
00:04:50,500 --> 00:04:53,620
cheat sheet and it will drop you out a

134
00:04:53,620 --> 00:04:56,080
nice audit report that lets you see what

135
00:04:56,080 --> 00:04:57,430
you need to set you would actually go

136
00:04:57,430 --> 00:04:58,750
through and set all these things when

137
00:04:58,750 --> 00:05:01,620
you finally do the tool run so with that

138
00:05:01,620 --> 00:05:05,500
what is the goal interaction there are

139
00:05:05,500 --> 00:05:07,480
some things in here you probably want to

140
00:05:07,480 --> 00:05:09,430
ask a question on so if it's a short

141
00:05:09,430 --> 00:05:12,280
something I can shortly respond to don't

142
00:05:12,280 --> 00:05:14,590
be a ding dong and not ask questions the

143
00:05:14,590 --> 00:05:16,120
only stupid questions are unasked ones

144
00:05:16,120 --> 00:05:18,700
if you ask a good question and it really

145
00:05:18,700 --> 00:05:20,350
quite appropriate to enhancing the

146
00:05:20,350 --> 00:05:24,160
content I will Sam well because now I

147
00:05:24,160 --> 00:05:28,450
lost a hand send you out a ding dong to

148
00:05:28,450 --> 00:05:30,730
encourage you to ask questions so don't

149
00:05:30,730 --> 00:05:34,690
be a ding dong and again learn how it's

150
00:05:34,690 --> 00:05:36,910
ninjas do it so you can do it too and

151
00:05:36,910 --> 00:05:38,080
I'm going to expose you to new tool

152
00:05:38,080 --> 00:05:40,480
which really came out of the fact of I

153
00:05:40,480 --> 00:05:43,750
need to catch more of this stuff so it's

154
00:05:43,750 --> 00:05:46,510
that so with that why listen to me well

155
00:05:46,510 --> 00:05:48,130
how many people here are familiar with

156
00:05:48,130 --> 00:05:50,890
the gaming environment MMOs likely

157
00:05:50,890 --> 00:05:53,710
legend stuff like that that industry has

158
00:05:53,710 --> 00:05:55,240
been attacked by a group called winnt I

159
00:05:55,240 --> 00:05:56,950
for probably about five years that's

160
00:05:56,950 --> 00:05:58,540
what they label them kaspersky label

161
00:05:58,540 --> 00:06:00,150
these guys that's where that comes from

162
00:06:00,150 --> 00:06:02,740
and this report came out april 2013

163
00:06:02,740 --> 00:06:05,530
right there but we found this malware in

164
00:06:05,530 --> 00:06:08,170
2012 and met with the feds share them

165
00:06:08,170 --> 00:06:09,910
that information so you get declassified

166
00:06:09,910 --> 00:06:12,070
and shared with other people a good

167
00:06:12,070 --> 00:06:13,660
chance like especially got a lot of the

168
00:06:13,660 --> 00:06:15,040
information that they needed for the

169
00:06:15,040 --> 00:06:17,230
support from us but they didn't contact

170
00:06:17,230 --> 00:06:19,450
us I kind of ripped Eugene about that

171
00:06:19,450 --> 00:06:21,160
one because they missed some things they

172
00:06:21,160 --> 00:06:23,470
really need to be in that report and the

173
00:06:23,470 --> 00:06:25,060
other thing is the talk I'm about to

174
00:06:25,060 --> 00:06:27,550
tell you about we gave an infected vm to

175
00:06:27,550 --> 00:06:29,560
one of the big I our firms and no I'm

176
00:06:29,560 --> 00:06:30,490
not gonna tell you who because it

177
00:06:30,490 --> 00:06:31,750
doesn't matter everybody has a bad day

178
00:06:31,750 --> 00:06:34,030
or three or week or however long it took

179
00:06:34,030 --> 00:06:36,640
them to fail in this one but because I

180
00:06:36,640 --> 00:06:38,140
do respect the firm you a lot of good

181
00:06:38,140 --> 00:06:38,710
work

182
00:06:38,710 --> 00:06:41,440
but the point here is you must validate

183
00:06:41,440 --> 00:06:43,360
or at least have some understanding of

184
00:06:43,360 --> 00:06:45,310
what you're giving these I are firms if

185
00:06:45,310 --> 00:06:47,290
you're doing what we did give them an

186
00:06:47,290 --> 00:06:48,990
image and say hey what do you know

187
00:06:48,990 --> 00:06:50,740
figure out what you know about it first

188
00:06:50,740 --> 00:06:53,050
so when they come back with a report it

189
00:06:53,050 --> 00:06:55,090
aligns with what you think and hopefully

190
00:06:55,090 --> 00:06:57,700
expands on what you know so that's just

191
00:06:57,700 --> 00:06:59,710
the point there so yeah we find it

192
00:06:59,710 --> 00:07:01,930
before they report do the reports and we

193
00:07:01,930 --> 00:07:03,250
deal with a lot of our firms and the

194
00:07:03,250 --> 00:07:04,960
bureau to share and declassify

195
00:07:04,960 --> 00:07:08,530
information so when NTI 2014 it was a

196
00:07:08,530 --> 00:07:10,840
much more sophisticated version of this

197
00:07:10,840 --> 00:07:14,080
particular kaspersky attacked a guy they

198
00:07:14,080 --> 00:07:16,750
updated their approach quite a bit for

199
00:07:16,750 --> 00:07:19,750
example 2012 used new services much like

200
00:07:19,750 --> 00:07:21,430
the black POS did at Target and all the

201
00:07:21,430 --> 00:07:23,580
other retailers installed two services

202
00:07:23,580 --> 00:07:26,140
the win NT I guys installed lots of

203
00:07:26,140 --> 00:07:27,760
services that are different across a lot

204
00:07:27,760 --> 00:07:29,380
of systems they didn't do that this time

205
00:07:29,380 --> 00:07:31,750
so suddenly they now know we know to

206
00:07:31,750 --> 00:07:33,250
find new services so they had to change

207
00:07:33,250 --> 00:07:36,160
their mo as we have all they evolved and

208
00:07:36,160 --> 00:07:37,720
so are we really have to up our game and

209
00:07:37,720 --> 00:07:40,570
suck a lot less but boy did we catch

210
00:07:40,570 --> 00:07:42,730
them in the act this is definitely not

211
00:07:42,730 --> 00:07:44,710
your typical pwnage I hope to really get

212
00:07:44,710 --> 00:07:46,540
you guys to your eyes open with this

213
00:07:46,540 --> 00:07:50,470
information but bullying the whole 210

214
00:07:50,470 --> 00:07:52,900
days mean time to detection it's more

215
00:07:52,900 --> 00:07:55,540
like 200 10 minutes for where we're at I

216
00:07:55,540 --> 00:07:57,400
can pretty much get something going

217
00:07:57,400 --> 00:07:59,170
within that first hour if those systems

218
00:07:59,170 --> 00:08:01,090
are monitored and it's a gaming

219
00:08:01,090 --> 00:08:03,100
environment every system was monitored

220
00:08:03,100 --> 00:08:04,210
so we caught them right when they

221
00:08:04,210 --> 00:08:06,610
started again they can infect an entire

222
00:08:06,610 --> 00:08:09,310
environment within an hour to wear as it

223
00:08:09,310 --> 00:08:11,230
takes us an hour to just to evaluate one

224
00:08:11,230 --> 00:08:13,090
system right so their way faster than we

225
00:08:13,090 --> 00:08:15,400
are and the goal here is I want to share

226
00:08:15,400 --> 00:08:18,010
this so you can learn okay clearly we

227
00:08:18,010 --> 00:08:19,600
have people in DC that are very

228
00:08:19,600 --> 00:08:21,280
interested in this kind of detection I'm

229
00:08:21,280 --> 00:08:23,980
hoping or maybe avoidance of this kind

230
00:08:23,980 --> 00:08:25,720
of detection it all depends on your

231
00:08:25,720 --> 00:08:29,260
perspective so the history again I

232
00:08:29,260 --> 00:08:30,130
mentioned it's been around for about

233
00:08:30,130 --> 00:08:32,140
five years it's known that their Chinese

234
00:08:32,140 --> 00:08:34,030
hackers both kaspersky obviously

235
00:08:34,030 --> 00:08:35,590
mentions this in the report so let's

236
00:08:35,590 --> 00:08:37,390
believe them but also the feds told us

237
00:08:37,390 --> 00:08:38,559
that they're a known group that's being

238
00:08:38,559 --> 00:08:41,200
tracked but again they're in China they

239
00:08:41,200 --> 00:08:42,700
attack the gaming industry and

240
00:08:42,700 --> 00:08:44,010
everybody's like why would you do that

241
00:08:44,010 --> 00:08:46,660
it's considered a billion-dollar black

242
00:08:46,660 --> 00:08:49,480
market industry meaning when you farm

243
00:08:49,480 --> 00:08:51,670
for things and collect things and they

244
00:08:51,670 --> 00:08:52,720
steal your things

245
00:08:52,720 --> 00:08:54,850
log in your accounts or create new

246
00:08:54,850 --> 00:08:57,370
accounts and script collecting of stuff

247
00:08:57,370 --> 00:09:00,069
and they drop that off and sell it on on

248
00:09:00,069 --> 00:09:02,860
ebay for example I think before I left

249
00:09:02,860 --> 00:09:04,930
our gold was going for 100 gold was

250
00:09:04,930 --> 00:09:07,269
going for like nine dollars and so

251
00:09:07,269 --> 00:09:09,339
there's real money behind fake gold and

252
00:09:09,339 --> 00:09:12,730
fake things surprisingly and and so

253
00:09:12,730 --> 00:09:14,769
they're very much incentivized to rip

254
00:09:14,769 --> 00:09:17,139
you off and always the sunday so this is

255
00:09:17,139 --> 00:09:18,660
a very organized group matter of fact

256
00:09:18,660 --> 00:09:21,009
it's known that they have a building and

257
00:09:21,009 --> 00:09:22,180
different floors do different things

258
00:09:22,180 --> 00:09:24,160
many of the gaming people have gone over

259
00:09:24,160 --> 00:09:26,259
there have been told by the authorities

260
00:09:26,259 --> 00:09:27,639
you know there it is you know that floor

261
00:09:27,639 --> 00:09:29,649
probably logs in or creates accounts and

262
00:09:29,649 --> 00:09:31,389
scripts gaming these guys break into

263
00:09:31,389 --> 00:09:33,790
accounts these guys write code highly

264
00:09:33,790 --> 00:09:37,029
organized so and again it's not quite

265
00:09:37,029 --> 00:09:39,069
state-sponsored for sure there's some

266
00:09:39,069 --> 00:09:41,500
good stuff in here but it's pretty darn

267
00:09:41,500 --> 00:09:43,269
good I have to say this the best stuff

268
00:09:43,269 --> 00:09:44,800
I've ever had to deal with and i work

269
00:09:44,800 --> 00:09:47,050
for HP for eight years and got to expose

270
00:09:47,050 --> 00:09:49,420
us some interesting stuff and i would

271
00:09:49,420 --> 00:09:51,310
definitely consider this your typical

272
00:09:51,310 --> 00:09:53,439
advanced persistent threat now advanced

273
00:09:53,439 --> 00:09:56,199
i hear a lot of terms with malware where

274
00:09:56,199 --> 00:09:57,910
this is sophisticated malware like I

275
00:09:57,910 --> 00:09:59,379
heard that with all the black POS stuff

276
00:09:59,379 --> 00:10:00,939
I'm sorry that was one of the easiest

277
00:10:00,939 --> 00:10:02,949
mauers ever to detect so it is not

278
00:10:02,949 --> 00:10:05,230
sophisticated sophisticated to me is

279
00:10:05,230 --> 00:10:07,449
when something new occurs that you

280
00:10:07,449 --> 00:10:09,459
weren't looking for thinking about and

281
00:10:09,459 --> 00:10:11,290
this stuff had it in there I'm going to

282
00:10:11,290 --> 00:10:13,720
walk you through it and again we saw

283
00:10:13,720 --> 00:10:15,370
each new things each time the attack

284
00:10:15,370 --> 00:10:16,449
could obviously keep learning keep

285
00:10:16,449 --> 00:10:19,059
earning disease these persistent malware

286
00:10:19,059 --> 00:10:21,220
ians or bad actors or whatever you want

287
00:10:21,220 --> 00:10:23,259
to call them keep coming at us it was

288
00:10:23,259 --> 00:10:25,779
almost like a monthly game with us you

289
00:10:25,779 --> 00:10:27,879
know they specifically target HR with

290
00:10:27,879 --> 00:10:29,860
really well-crafted resumes that were

291
00:10:29,860 --> 00:10:31,899
infected because a gaming company just

292
00:10:31,899 --> 00:10:34,089
laid off 5,000 people and they know at

293
00:10:34,089 --> 00:10:35,529
that point it's time to release a resume

294
00:10:35,529 --> 00:10:36,790
and be amongst all the other resumes

295
00:10:36,790 --> 00:10:40,089
that the HR person just got my colleague

296
00:10:40,089 --> 00:10:42,189
had an interesting thought maybe this is

297
00:10:42,189 --> 00:10:43,660
state-sponsored stuff getting a test

298
00:10:43,660 --> 00:10:45,009
drive and the stuff that doesn't get

299
00:10:45,009 --> 00:10:47,170
detected maybe then gets elevated up I'm

300
00:10:47,170 --> 00:10:49,389
interesting theory but I got no backing

301
00:10:49,389 --> 00:10:51,069
for that but that was an interesting

302
00:10:51,069 --> 00:10:53,889
thought that maybe that is kind of maybe

303
00:10:53,889 --> 00:10:55,600
the Chinese or even the Russians would

304
00:10:55,600 --> 00:10:57,639
buy this good technology that took three

305
00:10:57,639 --> 00:11:00,670
years of detect yes right kind of this

306
00:11:00,670 --> 00:11:03,069
athlete so here's the summary of it

307
00:11:03,069 --> 00:11:06,550
pretty typical from 2012 DLL injection

308
00:11:06,550 --> 00:11:08,470
they dropped a dll in wbm that looks

309
00:11:08,470 --> 00:11:10,450
just like named exactly like one in

310
00:11:10,450 --> 00:11:12,910
system32 they dropped down a windows so

311
00:11:12,910 --> 00:11:15,250
the idea here is in wbm when W Mike

312
00:11:15,250 --> 00:11:17,440
starts up in stocks and million times a

313
00:11:17,440 --> 00:11:19,149
Sunday on a server and in many

314
00:11:19,149 --> 00:11:20,950
workstations the box got infected but

315
00:11:20,950 --> 00:11:22,600
nothing more than adding a dll to the

316
00:11:22,600 --> 00:11:25,899
box they dropped a dll into the windows

317
00:11:25,899 --> 00:11:28,329
directory solely so when someone logged

318
00:11:28,329 --> 00:11:30,190
in and infected as well alright pretty

319
00:11:30,190 --> 00:11:32,709
typical they dropped files in system32

320
00:11:32,709 --> 00:11:34,420
because they could obviously if they're

321
00:11:34,420 --> 00:11:35,350
dropping files in the other two

322
00:11:35,350 --> 00:11:37,959
directories their admins they also use

323
00:11:37,959 --> 00:11:39,339
the program data directory where they

324
00:11:39,339 --> 00:11:41,410
stored files why because it's the all

325
00:11:41,410 --> 00:11:43,390
users directory right everybody who logs

326
00:11:43,390 --> 00:11:46,180
in the box has access to that area a

327
00:11:46,180 --> 00:11:49,149
well-known exploit sysprep calling base

328
00:11:49,149 --> 00:11:51,519
dll was executed and used quite often so

329
00:11:51,519 --> 00:11:53,440
if you write a bad trip based dll and

330
00:11:53,440 --> 00:11:55,209
you just tell sysprep loaded guess what

331
00:11:55,209 --> 00:11:57,700
it loads it this is known I've actually

332
00:11:57,700 --> 00:12:00,220
seen the expanding of this with

333
00:12:00,220 --> 00:12:02,140
executables and some commodity malware I

334
00:12:02,140 --> 00:12:03,670
had matter of fact one of the talks

335
00:12:03,670 --> 00:12:06,160
yesterday with a 10 dot exe my talk I

336
00:12:06,160 --> 00:12:08,860
the nine dot exe actually utilized the

337
00:12:08,860 --> 00:12:10,899
sysprep piping it a bunch of executable

338
00:12:10,899 --> 00:12:12,100
so I have to write that up and so into

339
00:12:12,100 --> 00:12:13,450
Microsoft because I think there's

340
00:12:13,450 --> 00:12:15,310
something now and exploit kits that's

341
00:12:15,310 --> 00:12:17,500
really expanding on that so watch for

342
00:12:17,500 --> 00:12:19,120
the execution of sips prep is probably

343
00:12:19,120 --> 00:12:21,880
the best thing to tell you there I did a

344
00:12:21,880 --> 00:12:23,529
boot up back door that was really cool

345
00:12:23,529 --> 00:12:26,020
they put it on our exchange servers it

346
00:12:26,020 --> 00:12:27,910
actually wrote to disk on shut down

347
00:12:27,910 --> 00:12:31,420
after tripwire stopped and boot it up

348
00:12:31,420 --> 00:12:34,029
and loaded before tripwire stop started

349
00:12:34,029 --> 00:12:36,579
so trip are never saw this file on the

350
00:12:36,579 --> 00:12:38,050
only way we found it is you know when

351
00:12:38,050 --> 00:12:39,279
you're in this kind of attack scenario

352
00:12:39,279 --> 00:12:40,570
eventually get around to doing memory

353
00:12:40,570 --> 00:12:42,399
dumps and there where it was we had

354
00:12:42,399 --> 00:12:44,140
black hold all the ip's involved to a

355
00:12:44,140 --> 00:12:46,360
rackspace server running netcat just to

356
00:12:46,360 --> 00:12:47,800
be able to keep the communication going

357
00:12:47,800 --> 00:12:50,230
and about every 30 something days this

358
00:12:50,230 --> 00:12:52,240
thing would open up in phone home or try

359
00:12:52,240 --> 00:12:53,470
to phone home to get a connection back

360
00:12:53,470 --> 00:12:55,420
it was their super-secret back door but

361
00:12:55,420 --> 00:12:57,160
it was pretty easy to find pointed to a

362
00:12:57,160 --> 00:12:59,649
file on the system 32 just wasn't there

363
00:12:59,649 --> 00:13:02,140
pretty easy but we couldn't figure out

364
00:13:02,140 --> 00:13:03,910
how to get it off disk it was real pain

365
00:13:03,910 --> 00:13:05,800
yes they datacenters in taiwan and

366
00:13:05,800 --> 00:13:07,630
amsterdam dallas and it's really hard to

367
00:13:07,630 --> 00:13:09,220
take full images and copy one with the

368
00:13:09,220 --> 00:13:11,079
wire and we tried a bunch other things

369
00:13:11,079 --> 00:13:12,279
you know quick we're trying to figure

370
00:13:12,279 --> 00:13:14,050
out a quicker way to do this memory dump

371
00:13:14,050 --> 00:13:16,209
by process was the fastest way and

372
00:13:16,209 --> 00:13:18,870
turned out one of our offices lost power

373
00:13:18,870 --> 00:13:20,070
I mean the batteries died and everything

374
00:13:20,070 --> 00:13:21,810
brought everything back up and I'm

375
00:13:21,810 --> 00:13:23,550
watching these servers really carefully

376
00:13:23,550 --> 00:13:25,529
trying to figure out in the course like

377
00:13:25,529 --> 00:13:27,270
couple months after this attack you know

378
00:13:27,270 --> 00:13:28,650
what is it that this thing's how can we

379
00:13:28,650 --> 00:13:29,700
find this thing some of the way the

380
00:13:29,700 --> 00:13:31,860
memory dumps and the servers no longer

381
00:13:31,860 --> 00:13:33,570
talking the remnants are all gone the

382
00:13:33,570 --> 00:13:35,310
memory dumps nothing I'm like what

383
00:13:35,310 --> 00:13:36,839
happened sometimes a server so I start

384
00:13:36,839 --> 00:13:38,550
Splunk in it and I find the server died

385
00:13:38,550 --> 00:13:41,100
rebooted and it went down it was down

386
00:13:41,100 --> 00:13:42,630
for a long time and I'm like what the

387
00:13:42,630 --> 00:13:43,980
hell oh we had a power outage it like

388
00:13:43,980 --> 00:13:45,930
lost everything UPS's were overloaded

389
00:13:45,930 --> 00:13:48,510
and they killed I'm like oh yeah I

390
00:13:48,510 --> 00:13:50,400
memory only stuffed full of power so

391
00:13:50,400 --> 00:13:51,630
guess what I did walked in the server

392
00:13:51,630 --> 00:13:53,250
room fold these exchange server power

393
00:13:53,250 --> 00:13:55,410
and boof that was going to it was our

394
00:13:55,410 --> 00:13:57,360
backup it was the one we had retired and

395
00:13:57,360 --> 00:13:59,430
boom it was gone I'm like awesome guess

396
00:13:59,430 --> 00:14:00,839
what we have is a new process every time

397
00:14:00,839 --> 00:14:02,430
we find when these infections power down

398
00:14:02,430 --> 00:14:04,860
the paps in the databases pull the power

399
00:14:04,860 --> 00:14:07,110
and boom so it's become part of my

400
00:14:07,110 --> 00:14:08,970
incident response to do that FY you

401
00:14:08,970 --> 00:14:11,490
really should too yeah I just do it

402
00:14:11,490 --> 00:14:12,839
before you shut you shut the database

403
00:14:12,839 --> 00:14:14,040
down first that would really really bad

404
00:14:14,040 --> 00:14:18,510
idea and also they install a lot of new

405
00:14:18,510 --> 00:14:20,550
services a multiple of different names

406
00:14:20,550 --> 00:14:23,430
Splunk drv sis all right so splunk dear

407
00:14:23,430 --> 00:14:25,170
views of service and we also right above

408
00:14:25,170 --> 00:14:27,500
it head splunk that's like wait a minute

409
00:14:27,500 --> 00:14:30,330
and also multiple infections per machine

410
00:14:30,330 --> 00:14:32,190
so they didn't affect a box the same way

411
00:14:32,190 --> 00:14:34,620
once they would in fact let's say in

412
00:14:34,620 --> 00:14:36,029
this particular case are probably 200

413
00:14:36,029 --> 00:14:38,310
systems they would infect 200 systems

414
00:14:38,310 --> 00:14:39,810
probably eight or nine different ways

415
00:14:39,810 --> 00:14:42,150
one box would have three another box

416
00:14:42,150 --> 00:14:43,589
would had to another box would have

417
00:14:43,589 --> 00:14:45,360
something totally different and they

418
00:14:45,360 --> 00:14:46,800
kind of littered things around hoping if

419
00:14:46,800 --> 00:14:48,029
you found these sort of things you'd

420
00:14:48,029 --> 00:14:50,580
miss these others but they were all

421
00:14:50,580 --> 00:14:52,020
having the same logic so pretty easy to

422
00:14:52,020 --> 00:14:56,520
find really so 2014 new stuff dude we

423
00:14:56,520 --> 00:14:58,560
were is like dude you know I'm an hour

424
00:14:58,560 --> 00:15:00,270
guy i'm an active fender so when i say

425
00:15:00,270 --> 00:15:02,339
really cool foo i'm just like dude this

426
00:15:02,339 --> 00:15:04,230
is awesome it's bad but it's really

427
00:15:04,230 --> 00:15:06,600
awesome because hey I don't have a talk

428
00:15:06,600 --> 00:15:09,420
yet it has some more done but again what

429
00:15:09,420 --> 00:15:11,279
triggered it what changed you know it

430
00:15:11,279 --> 00:15:12,839
avoided the message method used before

431
00:15:12,839 --> 00:15:15,360
not a new service and fortunately we're

432
00:15:15,360 --> 00:15:17,880
doing really good logging I I would have

433
00:15:17,880 --> 00:15:19,770
to say if you higher rate all the

434
00:15:19,770 --> 00:15:21,029
security solutions member is work for HP

435
00:15:21,029 --> 00:15:23,040
I have seen and played with a lot of

436
00:15:23,040 --> 00:15:24,810
security solutions my number one

437
00:15:24,810 --> 00:15:26,190
solution is some sort of good logging

438
00:15:26,190 --> 00:15:30,150
proper logging number two is my case not

439
00:15:30,150 --> 00:15:31,580
because I like IBM I

440
00:15:31,580 --> 00:15:33,920
don't work for a vendor is big fix I've

441
00:15:33,920 --> 00:15:35,480
used it multiple organizations and that

442
00:15:35,480 --> 00:15:37,490
is absolutely the baddest-ass tool the

443
00:15:37,490 --> 00:15:39,380
best description of how i use it is like

444
00:15:39,380 --> 00:15:41,450
mozilla investigator or google adwords

445
00:15:41,450 --> 00:15:44,030
fonts i ask a question and all the

446
00:15:44,030 --> 00:15:45,320
systems have to reply back with an

447
00:15:45,320 --> 00:15:47,210
answer do you have this file in this

448
00:15:47,210 --> 00:15:49,790
location with this hash rollin and I can

449
00:15:49,790 --> 00:15:51,140
do an analysis in big fix that gives it

450
00:15:51,140 --> 00:15:53,600
to me much like Meg would do or girl

451
00:15:53,600 --> 00:15:56,690
would do and again we we are ninjas

452
00:15:56,690 --> 00:15:58,090
after all at least we think you very and

453
00:15:58,090 --> 00:16:00,680
so here's the summary of improvements

454
00:16:00,680 --> 00:16:02,540
let's walk through these plug X was

455
00:16:02,540 --> 00:16:04,580
heavily used initial infection plug X as

456
00:16:04,580 --> 00:16:07,640
an exploit kit it's very modular and so

457
00:16:07,640 --> 00:16:09,050
they can start off with that and then

458
00:16:09,050 --> 00:16:11,240
write their own modules with more

459
00:16:11,240 --> 00:16:13,610
stealthiness does a lot of automatic

460
00:16:13,610 --> 00:16:15,920
bypass a baby and various other tools as

461
00:16:15,920 --> 00:16:18,020
part of the exploit kit so we saw that

462
00:16:18,020 --> 00:16:20,060
initially used for the initial

463
00:16:20,060 --> 00:16:22,010
infections as well as some of the litter

464
00:16:22,010 --> 00:16:24,370
different pieces across the environment

465
00:16:24,370 --> 00:16:26,990
this was new they actually did a DLL

466
00:16:26,990 --> 00:16:29,060
injection on sequel server on single

467
00:16:29,060 --> 00:16:30,550
servers like you know program files

468
00:16:30,550 --> 00:16:33,830
microsoft single server ms underscore

469
00:16:33,830 --> 00:16:36,830
sequel 10 nada slash bin and in there

470
00:16:36,830 --> 00:16:38,990
was this robe dll and we're like what

471
00:16:38,990 --> 00:16:41,510
the hell is this thing doing here and so

472
00:16:41,510 --> 00:16:42,920
that was one of the last pieces we kind

473
00:16:42,920 --> 00:16:44,930
of we kind of went after but it ended up

474
00:16:44,930 --> 00:16:46,430
injecting to the point where they could

475
00:16:46,430 --> 00:16:48,500
create they could get in and compromise

476
00:16:48,500 --> 00:16:50,810
the sequel server to enable XV command

477
00:16:50,810 --> 00:16:52,670
show which allowed them to do the dotnet

478
00:16:52,670 --> 00:16:54,980
commands within the sequel server which

479
00:16:54,980 --> 00:16:56,570
was totally hidden because they know

480
00:16:56,570 --> 00:16:58,970
most of us don't log sequel server to

481
00:16:58,970 --> 00:17:01,640
our security logs so in that aspect they

482
00:17:01,640 --> 00:17:04,190
could go unnoticed in this Avenue there

483
00:17:04,190 --> 00:17:05,569
is a way to do that so I highly

484
00:17:05,569 --> 00:17:08,060
recommend you get your your security

485
00:17:08,060 --> 00:17:10,280
sequel stuff into the base windows

486
00:17:10,280 --> 00:17:11,480
security logs because I don't have to

487
00:17:11,480 --> 00:17:12,680
change splunk it we just automatic

488
00:17:12,680 --> 00:17:14,480
collected there are articles about how

489
00:17:14,480 --> 00:17:16,640
to do that so that was the takeaway from

490
00:17:16,640 --> 00:17:18,890
from that particular item they had a

491
00:17:18,890 --> 00:17:22,520
binary infector this was the dude so so

492
00:17:22,520 --> 00:17:26,720
we ran McAfee for example AV we had

493
00:17:26,720 --> 00:17:28,730
backup software and imaging software

494
00:17:28,730 --> 00:17:31,790
from altiris bigfix obviously several

495
00:17:31,790 --> 00:17:34,640
other components long etc they actually

496
00:17:34,640 --> 00:17:36,920
had an infected infected our management

497
00:17:36,920 --> 00:17:38,210
software and the management software

498
00:17:38,210 --> 00:17:40,940
still worked and we'll get to why and

499
00:17:40,940 --> 00:17:42,980
how that worked in a minute they had a

500
00:17:42,980 --> 00:17:44,419
driver infector

501
00:17:44,419 --> 00:17:46,580
again that the way I catch these things

502
00:17:46,580 --> 00:17:48,850
with this really cool high-tech script

503
00:17:48,850 --> 00:17:51,440
robocopy everything in this directory to

504
00:17:51,440 --> 00:17:54,799
captured only try once and skip these

505
00:17:54,799 --> 00:17:56,179
other directories so I don't get these

506
00:17:56,179 --> 00:17:58,999
funny symlink loops and it just goes

507
00:17:58,999 --> 00:18:00,649
next it goes back the top and just does

508
00:18:00,649 --> 00:18:01,999
this over and over and over again so we

509
00:18:01,999 --> 00:18:03,169
started launching that across their

510
00:18:03,169 --> 00:18:04,970
environment and so as the boxes got

511
00:18:04,970 --> 00:18:06,799
popped and these things run you don't

512
00:18:06,799 --> 00:18:08,749
know how malware works they drop a file

513
00:18:08,749 --> 00:18:10,940
they execute a file delete a file with

514
00:18:10,940 --> 00:18:13,190
tripwire you have about strip bar does

515
00:18:13,190 --> 00:18:15,080
kind of like a 10 second sampling so if

516
00:18:15,080 --> 00:18:16,340
you can execute something within 7

517
00:18:16,340 --> 00:18:18,379
seconds and delete it trip I will never

518
00:18:18,379 --> 00:18:22,100
see it okay FYI so they know that and so

519
00:18:22,100 --> 00:18:24,169
Mauer generally does is very quickly the

520
00:18:24,169 --> 00:18:25,609
only way to capture it is to try to get

521
00:18:25,609 --> 00:18:27,739
it while it's doing its thing so I have

522
00:18:27,739 --> 00:18:28,940
this high-tech method robocopy

523
00:18:28,940 --> 00:18:31,340
everything to captured and I run this on

524
00:18:31,340 --> 00:18:33,320
my lab boxes and I will deploy this as a

525
00:18:33,320 --> 00:18:34,999
part of IR if I think they're actively

526
00:18:34,999 --> 00:18:36,739
unboxed or will clean a box so they come

527
00:18:36,739 --> 00:18:38,119
back and nail that box because we know

528
00:18:38,119 --> 00:18:39,409
they like domain controllers and

529
00:18:39,409 --> 00:18:41,359
exchange servers and we caught these

530
00:18:41,359 --> 00:18:42,950
infector 'he's what's really cool

531
00:18:42,950 --> 00:18:43,879
because they need to figure out what

532
00:18:43,879 --> 00:18:45,590
they did and how they did it because

533
00:18:45,590 --> 00:18:46,999
right now we know is we have infected

534
00:18:46,999 --> 00:18:49,879
exe and infect our sister you see they

535
00:18:49,879 --> 00:18:51,830
hid stuff in the registry they hid their

536
00:18:51,830 --> 00:18:53,299
scripts that they executed in the

537
00:18:53,299 --> 00:18:56,119
registry and they also hit hit their

538
00:18:56,119 --> 00:18:58,369
payload the registry and folks the

539
00:18:58,369 --> 00:19:00,919
registry is seeking I do good Donald

540
00:19:00,919 --> 00:19:04,850
Trump the registry is huge and it's a

541
00:19:04,850 --> 00:19:06,980
big database so hiding stuff it can go

542
00:19:06,980 --> 00:19:08,679
totally unnoticed and surprisingly

543
00:19:08,679 --> 00:19:10,549
there's a lot of stuff that can be

544
00:19:10,549 --> 00:19:13,489
hidden in the registry so initially they

545
00:19:13,489 --> 00:19:15,769
popped a user it was not an admin so a

546
00:19:15,769 --> 00:19:17,899
they're good we're pretty sure or at

547
00:19:17,899 --> 00:19:20,119
least I'm pretty sure patient zero was

548
00:19:20,119 --> 00:19:22,279
an office oday exploit that had not been

549
00:19:22,279 --> 00:19:25,100
patched yet because afterwards and we

550
00:19:25,100 --> 00:19:26,809
got some patching going the next patch

551
00:19:26,809 --> 00:19:28,970
cycle some of the stuff we tried didn't

552
00:19:28,970 --> 00:19:30,710
work so we're pretty sure that word doc

553
00:19:30,710 --> 00:19:33,320
or thing that that user got sent he was

554
00:19:33,320 --> 00:19:34,460
immediately imaged and we don't

555
00:19:34,460 --> 00:19:36,590
generally do that but all the people got

556
00:19:36,590 --> 00:19:38,869
infected because it was a fast rapid

557
00:19:38,869 --> 00:19:40,850
roll he was on vacation his went ahead

558
00:19:40,850 --> 00:19:42,379
and did a bunch of systems I don't

559
00:19:42,379 --> 00:19:43,399
really care at that point I have a

560
00:19:43,399 --> 00:19:44,950
couple systems and I have all the data

561
00:19:44,950 --> 00:19:46,909
but generally you try to keep that

562
00:19:46,909 --> 00:19:48,230
patient zero because normally in these

563
00:19:48,230 --> 00:19:50,179
attacks patient zero looks nothing like

564
00:19:50,179 --> 00:19:52,580
patient one or patient to a patient

565
00:19:52,580 --> 00:19:53,869
three through whatever generally looked

566
00:19:53,869 --> 00:19:54,870
the same

567
00:19:54,870 --> 00:19:57,809
in some aspects they drop their initial

568
00:19:57,809 --> 00:19:59,670
malware they use the backup software

569
00:19:59,670 --> 00:20:01,320
they harvest at the backup software

570
00:20:01,320 --> 00:20:03,150
creds and hopped on a domain controller

571
00:20:03,150 --> 00:20:05,460
and from there blew across the

572
00:20:05,460 --> 00:20:07,950
environment and they spread all over say

573
00:20:07,950 --> 00:20:10,530
memos 2012 they always went after the

574
00:20:10,530 --> 00:20:12,030
stupid domain controllers obviously

575
00:20:12,030 --> 00:20:14,430
that's where all the creds are Mimi cats

576
00:20:14,430 --> 00:20:15,809
or whatever their equivalent is they run

577
00:20:15,809 --> 00:20:17,850
and easily pull creds off now in this

578
00:20:17,850 --> 00:20:20,520
case a 20 2014 I'm pretty convinced up

579
00:20:20,520 --> 00:20:21,720
whatever they're installing on these

580
00:20:21,720 --> 00:20:23,880
boxes actually needs an admin to log in

581
00:20:23,880 --> 00:20:25,559
before they can steal the crits because

582
00:20:25,559 --> 00:20:27,720
that was a pretty much almost a you know

583
00:20:27,720 --> 00:20:30,030
hey Bob just logged in the thing I guess

584
00:20:30,030 --> 00:20:32,130
what Bob at 10 15 20 minutes or an hour

585
00:20:32,130 --> 00:20:34,770
later just popped through my boxes so I

586
00:20:34,770 --> 00:20:35,790
don't think they were harvesting right

587
00:20:35,790 --> 00:20:37,020
out of the domain controller I think as

588
00:20:37,020 --> 00:20:38,660
people logged in they grab their creds

589
00:20:38,660 --> 00:20:41,550
so same MO that aspect the same behavior

590
00:20:41,550 --> 00:20:44,190
in highly crawled and so files dropped

591
00:20:44,190 --> 00:20:46,140
and gone right they used publicly

592
00:20:46,140 --> 00:20:47,880
accessible directories to drop this

593
00:20:47,880 --> 00:20:49,530
stuff why because they didn't worry

594
00:20:49,530 --> 00:20:51,150
about user they were they would just

595
00:20:51,150 --> 00:20:53,520
drop it we're all users had rights so if

596
00:20:53,520 --> 00:20:54,809
you're not monitoring see users public

597
00:20:54,809 --> 00:20:57,120
or see windows web or c / flogs you

598
00:20:57,120 --> 00:20:58,559
better start doing it not to mention the

599
00:20:58,559 --> 00:21:00,720
whole users app data local app data

600
00:21:00,720 --> 00:21:02,370
local oh updated roaming directories and

601
00:21:02,370 --> 00:21:05,010
then they deleted the files fast i mean

602
00:21:05,010 --> 00:21:06,240
we're talking less than a second we

603
00:21:06,240 --> 00:21:08,910
could watch them booked on but they did

604
00:21:08,910 --> 00:21:10,170
leave someone disk obviously the

605
00:21:10,170 --> 00:21:11,700
persistence must remain in some way for

606
00:21:11,700 --> 00:21:14,190
manner and so they were gone definitely

607
00:21:14,190 --> 00:21:17,400
in 60 seconds the sequel server being

608
00:21:17,400 --> 00:21:20,130
five deep they dropped a dll called

609
00:21:20,130 --> 00:21:22,350
cease capping it is a dll that's

610
00:21:22,350 --> 00:21:24,150
required by sequel server so if i put

611
00:21:24,150 --> 00:21:25,679
the bad one right next to the executable

612
00:21:25,679 --> 00:21:27,780
the a windows you will load the bad one

613
00:21:27,780 --> 00:21:29,550
first before you go to system 32 or

614
00:21:29,550 --> 00:21:32,820
wherever and load the kid one yay they

615
00:21:32,820 --> 00:21:36,750
drop files in 65 64 qaf dll is normal on

616
00:21:36,750 --> 00:21:38,910
workstations for sound stuff it is not

617
00:21:38,910 --> 00:21:41,429
on servers so they pop they use this

618
00:21:41,429 --> 00:21:43,650
thing across the servers as one of their

619
00:21:43,650 --> 00:21:45,540
mechanisms thinking that a QA is normal

620
00:21:45,540 --> 00:21:49,320
not on servers is not socially VMS they

621
00:21:49,320 --> 00:21:50,790
went after the splunk and out terrorists

622
00:21:50,790 --> 00:21:52,260
directory where they dropped a driver

623
00:21:52,260 --> 00:21:55,650
why a dot sis or a driver windows

624
00:21:55,650 --> 00:21:57,059
doesn't log this stuff very well if you

625
00:21:57,059 --> 00:21:58,590
want to log driver load you're going to

626
00:21:58,590 --> 00:21:59,910
need you something like sis mon or the

627
00:21:59,910 --> 00:22:01,950
windows logging service and so they

628
00:22:01,950 --> 00:22:03,960
named it to look just like there is no

629
00:22:03,960 --> 00:22:05,940
spunk sis in the splunk directory by the

630
00:22:05,940 --> 00:22:08,580
way spunky ll yes punks this no

631
00:22:08,580 --> 00:22:10,320
same with Altera's so these are the same

632
00:22:10,320 --> 00:22:12,390
payloads and so they litter these things

633
00:22:12,390 --> 00:22:13,950
across the environment looking like our

634
00:22:13,950 --> 00:22:15,299
management software that was a big thing

635
00:22:15,299 --> 00:22:18,179
they did this time the initial infect

636
00:22:18,179 --> 00:22:20,159
our again dropping to see users public

637
00:22:20,159 --> 00:22:21,929
because again that's everybody when they

638
00:22:21,929 --> 00:22:23,789
log in they can pull this they had an

639
00:22:23,789 --> 00:22:27,210
item called CXC infected exe infects sis

640
00:22:27,210 --> 00:22:28,590
so this is a thing that infected the

641
00:22:28,590 --> 00:22:30,090
binaries this is the thing that did the

642
00:22:30,090 --> 00:22:32,940
drivers and then 64-bit obviously the

643
00:22:32,940 --> 00:22:34,380
dll for that wasn't really sure what

644
00:22:34,380 --> 00:22:37,200
exactly this one did and then one was

645
00:22:37,200 --> 00:22:40,559
specifically named after our company so

646
00:22:40,559 --> 00:22:41,880
that means there's probably a blizzard

647
00:22:41,880 --> 00:22:45,149
exe and a you know whatever riyad exe is

648
00:22:45,149 --> 00:22:52,139
well probably out there how many people

649
00:22:52,139 --> 00:22:53,970
here do logging good enough that you

650
00:22:53,970 --> 00:22:55,940
would see this execute on your systems

651
00:22:55,940 --> 00:23:01,200
okay I see one two three hands they

652
00:23:01,200 --> 00:23:02,970
don't have to the bottom line they don't

653
00:23:02,970 --> 00:23:04,440
have to they do in our environment but

654
00:23:04,440 --> 00:23:06,120
their writings for the entire gaming

655
00:23:06,120 --> 00:23:11,309
industry probably owe their d leave

656
00:23:11,309 --> 00:23:13,169
within one second we wrote an executable

657
00:23:13,169 --> 00:23:15,299
that wrote filed 0 seconds delete 10

658
00:23:15,299 --> 00:23:17,220
times wrote one second delete 10 times

659
00:23:17,220 --> 00:23:18,299
in order to figure out where the

660
00:23:18,299 --> 00:23:21,090
threshold was and yeah we watched him we

661
00:23:21,090 --> 00:23:22,260
actually recreated this in the lab and

662
00:23:22,260 --> 00:23:24,059
it actually was able to record how fast

663
00:23:24,059 --> 00:23:30,600
it was yeah won't be there long / flogs

664
00:23:30,600 --> 00:23:33,809
had the command binary stored there and

665
00:23:33,809 --> 00:23:35,130
then windows web had a bunch of any

666
00:23:35,130 --> 00:23:37,470
files for permission changes the temp

667
00:23:37,470 --> 00:23:39,149
directory and windows had the vb scripts

668
00:23:39,149 --> 00:23:42,450
and the ax script and since well 64 had

669
00:23:42,450 --> 00:23:45,149
the files dropped this is the dll that

670
00:23:45,149 --> 00:23:46,260
was obviously a show she with that

671
00:23:46,260 --> 00:23:49,309
particular infector this guy here and

672
00:23:49,309 --> 00:23:51,210
that guy is a different piece of malware

673
00:23:51,210 --> 00:23:52,980
this guy here is the same as the Alturas

674
00:23:52,980 --> 00:23:55,019
and the splunk sis same same thing all

675
00:23:55,019 --> 00:23:57,090
the sis files were the same payload just

676
00:23:57,090 --> 00:23:58,889
littered along the disk in different

677
00:23:58,889 --> 00:24:00,929
ways and infecting different ways so

678
00:24:00,929 --> 00:24:03,299
they made it they made a they pointed an

679
00:24:03,299 --> 00:24:04,590
actual new service in this particular

680
00:24:04,590 --> 00:24:06,630
case when they use this one it was a new

681
00:24:06,630 --> 00:24:09,149
service on a couple boxes thinking oh we

682
00:24:09,149 --> 00:24:10,710
caught this and they wouldn't see the

683
00:24:10,710 --> 00:24:11,750
other one that I'm about to talk about

684
00:24:11,750 --> 00:24:16,799
so perf log co XE yay for once we got

685
00:24:16,799 --> 00:24:18,690
there creds so if you look at this

686
00:24:18,690 --> 00:24:21,149
whoops you look at this slide here /

687
00:24:21,149 --> 00:24:22,640
flogged see exceeds being

688
00:24:22,640 --> 00:24:24,950
executing and here's the command line

689
00:24:24,950 --> 00:24:27,230
obviously port 445 and we caught their

690
00:24:27,230 --> 00:24:29,300
password so now we had the ability to

691
00:24:29,300 --> 00:24:30,380
actually go to their command and control

692
00:24:30,380 --> 00:24:31,790
server within our environment and see

693
00:24:31,790 --> 00:24:36,230
what it did so hey winning thanks for

694
00:24:36,230 --> 00:24:37,490
the port and password for once we

695
00:24:37,490 --> 00:24:39,320
compromised them so now who

696
00:24:39,320 --> 00:24:43,100
sophisticated persistence was really

697
00:24:43,100 --> 00:24:46,760
cool in this case they created a driver

698
00:24:46,760 --> 00:24:48,740
in this case this driver again same

699
00:24:48,740 --> 00:24:50,570
payload of spunk sis and I'll terrorist

700
00:24:50,570 --> 00:24:52,970
sis it but in a different location but

701
00:24:52,970 --> 00:24:54,680
they put it they pointed it at program

702
00:24:54,680 --> 00:24:57,710
files common files you know with W x64

703
00:24:57,710 --> 00:24:59,390
sis but it wasn't our disk anywhere

704
00:24:59,390 --> 00:25:00,800
couldn't find it it's like why would

705
00:25:00,800 --> 00:25:03,770
they modify the service dll in this

706
00:25:03,770 --> 00:25:05,030
particular by the way it was the worst

707
00:25:05,030 --> 00:25:07,010
CPL support so who needs windows error

708
00:25:07,010 --> 00:25:08,090
reporting when they're infecting your

709
00:25:08,090 --> 00:25:09,890
box so I didn't want to use it they

710
00:25:09,890 --> 00:25:11,030
didn't want us to see it not that

711
00:25:11,030 --> 00:25:13,040
anybody monitors anyway so he pointed

712
00:25:13,040 --> 00:25:14,630
this thing here and we're like wow why

713
00:25:14,630 --> 00:25:17,810
what goods that do there's no file and

714
00:25:17,810 --> 00:25:19,580
we're like okay we know what's going on

715
00:25:19,580 --> 00:25:22,280
here something we're missing and so this

716
00:25:22,280 --> 00:25:23,360
is what it normally looks like right

717
00:25:23,360 --> 00:25:26,360
here so they modify that injury and it

718
00:25:26,360 --> 00:25:27,830
turns out that this is what the entry

719
00:25:27,830 --> 00:25:29,390
looks like when after they messed with

720
00:25:29,390 --> 00:25:30,980
it so it actually isn't that it's

721
00:25:30,980 --> 00:25:33,020
pointing to some oxy ated code right in

722
00:25:33,020 --> 00:25:35,450
some cases mistakes they left it as an

723
00:25:35,450 --> 00:25:37,550
MZ in some cases it was put it in hex as

724
00:25:37,550 --> 00:25:39,740
a 45 a but in all the successful

725
00:25:39,740 --> 00:25:41,300
infections that had been encrypted in

726
00:25:41,300 --> 00:25:43,250
some way and so all we knew was it was a

727
00:25:43,250 --> 00:25:45,680
big payload so I did it load if it was

728
00:25:45,680 --> 00:25:50,450
not on disk well yay windows support Cpl

729
00:25:50,450 --> 00:25:52,940
failed to start yes thank you microsoft

730
00:25:52,940 --> 00:25:56,600
flaw number 5 million 425 when a service

731
00:25:56,600 --> 00:25:58,190
fails to start because of a missing

732
00:25:58,190 --> 00:26:00,290
binary or whatever they point to it

733
00:26:00,290 --> 00:26:02,780
loops it doesn't try once twice three

734
00:26:02,780 --> 00:26:05,060
times a lady it just keeps looping and

735
00:26:05,060 --> 00:26:07,160
looping and looping which means you got

736
00:26:07,160 --> 00:26:08,570
lots of time to get that file there

737
00:26:08,570 --> 00:26:10,910
right that's that's the key there and

738
00:26:10,910 --> 00:26:13,610
yay no thank you there but once the file

739
00:26:13,610 --> 00:26:16,070
existed where CPL support started and

740
00:26:16,070 --> 00:26:18,260
the system was now infected and then the

741
00:26:18,260 --> 00:26:20,060
file immediately disappeared like what

742
00:26:20,060 --> 00:26:22,760
the frank we still hadn't found the file

743
00:26:22,760 --> 00:26:24,860
and we know because it was a cyst file

744
00:26:24,860 --> 00:26:26,750
we were pretty confident was probably

745
00:26:26,750 --> 00:26:28,640
the same binary that was our assumption

746
00:26:28,640 --> 00:26:30,110
but don't ever make assumptions other

747
00:26:30,110 --> 00:26:31,400
than help you go a direction when you

748
00:26:31,400 --> 00:26:32,990
get stuck i'll let the data do the

749
00:26:32,990 --> 00:26:34,520
speaking so when we actually hash the

750
00:26:34,520 --> 00:26:34,960
file they

751
00:26:34,960 --> 00:26:37,330
were at the end of the same file all the

752
00:26:37,330 --> 00:26:41,950
drivers seem to be the same so again

753
00:26:41,950 --> 00:26:43,960
persistence after leaving the key falls

754
00:26:43,960 --> 00:26:46,149
behind I'd like to do before well at

755
00:26:46,149 --> 00:26:50,370
least one anyway she uses public 64 SS

756
00:26:50,370 --> 00:26:52,480
started telling us some information I'll

757
00:26:52,480 --> 00:26:53,620
tell you how I caught this here in a

758
00:26:53,620 --> 00:26:57,010
second and then of course a reference in

759
00:26:57,010 --> 00:26:58,720
the windows so you asked how I caught

760
00:26:58,720 --> 00:27:00,700
some of the stuff this is how I did now

761
00:27:00,700 --> 00:27:01,710
if you haven't figured it out by now

762
00:27:01,710 --> 00:27:04,600
this is command line logging that now is

763
00:27:04,600 --> 00:27:06,880
built into windows 8 dot one and twenty

764
00:27:06,880 --> 00:27:10,690
twelve server r2 if you tweak a key it

765
00:27:10,690 --> 00:27:13,330
is not on windows 7 and 2008 server at

766
00:27:13,330 --> 00:27:17,140
this time last year in February 2015 of

767
00:27:17,140 --> 00:27:19,720
this year Microsoft added a patch it's

768
00:27:19,720 --> 00:27:23,110
kb 343 75 if you do not have that patch

769
00:27:23,110 --> 00:27:24,700
i highly recommend you go put that patch

770
00:27:24,700 --> 00:27:26,470
on there you tweak the registry key and

771
00:27:26,470 --> 00:27:28,600
you start collecting this with a process

772
00:27:28,600 --> 00:27:31,419
create 4688 event so those servers that

773
00:27:31,419 --> 00:27:33,370
i had been playing with this up to this

774
00:27:33,370 --> 00:27:34,840
point one of my summer projects was to

775
00:27:34,840 --> 00:27:36,700
get this command line long and going so

776
00:27:36,700 --> 00:27:40,330
a couple win 81 boxes we had and a few

777
00:27:40,330 --> 00:27:41,890
new all the new servers for a new game

778
00:27:41,890 --> 00:27:43,659
we were doing we're all 2012 servers i

779
00:27:43,659 --> 00:27:45,039
started turning this on to see what we

780
00:27:45,039 --> 00:27:46,990
do and i started building spunk stuff i

781
00:27:46,990 --> 00:27:49,059
hadn't quite refined it yet but the cool

782
00:27:49,059 --> 00:27:51,760
thing was anytime command line was

783
00:27:51,760 --> 00:27:53,470
executed if i went net use whack whack

784
00:27:53,470 --> 00:27:55,570
some server wax some user whack /

785
00:27:55,570 --> 00:27:58,390
password whack it's in the logs I don't

786
00:27:58,390 --> 00:27:59,830
worry about having passwords in logs so

787
00:27:59,830 --> 00:28:01,240
I tell the developer hey take the

788
00:28:01,240 --> 00:28:02,770
password out and do it through a file or

789
00:28:02,770 --> 00:28:04,659
something so we don't see this or I can

790
00:28:04,659 --> 00:28:06,340
tell splunk not to even collect this

791
00:28:06,340 --> 00:28:07,990
particular string which is even better

792
00:28:07,990 --> 00:28:09,610
way to do it so I don't consider it a

793
00:28:09,610 --> 00:28:11,620
problem collecting command-line logs I

794
00:28:11,620 --> 00:28:14,020
can remediate that problem and so I

795
00:28:14,020 --> 00:28:15,760
started collecting this information as

796
00:28:15,760 --> 00:28:17,890
we start looking the boxes that were

797
00:28:17,890 --> 00:28:19,510
infected and it's pointing me to

798
00:28:19,510 --> 00:28:21,850
locations that I now have to monitor or

799
00:28:21,850 --> 00:28:23,409
look for across the board using a big

800
00:28:23,409 --> 00:28:25,840
fix analysis hey do any use servers or

801
00:28:25,840 --> 00:28:28,000
any boxes have 64 tied yellow in this

802
00:28:28,000 --> 00:28:29,649
location and boom I get its response

803
00:28:29,649 --> 00:28:31,659
banging about 15 minutes do any of you

804
00:28:31,659 --> 00:28:33,580
have this file here the script in the

805
00:28:33,580 --> 00:28:37,299
temp directory etc etc but the other

806
00:28:37,299 --> 00:28:39,730
thing it did is point us to software

807
00:28:39,730 --> 00:28:42,659
clients like good man that's a reg key

808
00:28:42,659 --> 00:28:46,500
what the hell and so we went looking and

809
00:28:46,500 --> 00:28:48,429
basically we started seeing some

810
00:28:48,429 --> 00:28:48,940
interesting

811
00:28:48,940 --> 00:28:52,540
in the registry in this case the command

812
00:28:52,540 --> 00:28:54,130
line logging was the key and I just told

813
00:28:54,130 --> 00:28:57,340
you about this and we have a big fixed

814
00:28:57,340 --> 00:29:00,220
thing that looks for several a whole

815
00:29:00,220 --> 00:29:02,290
list of Edmond utilities if if you want

816
00:29:02,290 --> 00:29:03,880
to look in the windows splunk logging

817
00:29:03,880 --> 00:29:05,320
cheat sheet you'll get a short list of a

818
00:29:05,320 --> 00:29:07,030
lot of them there's several more I have

819
00:29:07,030 --> 00:29:07,960
it was just I was trying to make it

820
00:29:07,960 --> 00:29:10,000
short enough and basically when that

821
00:29:10,000 --> 00:29:12,550
thing gets triggers we get an alert

822
00:29:12,550 --> 00:29:14,500
because of the multiple executions of

823
00:29:14,500 --> 00:29:19,390
that yes oh you haven't problem sorry

824
00:29:19,390 --> 00:29:22,090
but then if I'm doing that just somebody

825
00:29:22,090 --> 00:29:25,180
do this wait your hand and go I'm sorry

826
00:29:25,180 --> 00:29:26,440
I'm trying to hold it against my body so

827
00:29:26,440 --> 00:29:28,690
I keep that going and so what we found

828
00:29:28,690 --> 00:29:31,030
is and this is where hackers don't look

829
00:29:31,030 --> 00:29:35,290
anything like Edmonds is an admin will

830
00:29:35,290 --> 00:29:37,420
go to box type net use maybe run see

831
00:29:37,420 --> 00:29:39,190
script on an exchange box to clean

832
00:29:39,190 --> 00:29:41,200
something up a it's always an exchange

833
00:29:41,200 --> 00:29:43,540
script be it's always this script or

834
00:29:43,540 --> 00:29:45,910
powershell script and see he's only

835
00:29:45,910 --> 00:29:48,340
doing it a couple commands but in the

836
00:29:48,340 --> 00:29:50,620
hackers case they executed see script

837
00:29:50,620 --> 00:29:53,230
they executed stuff about the registry

838
00:29:53,230 --> 00:29:56,170
the executed net stops they executed

839
00:29:56,170 --> 00:29:58,870
command XE with C script they executed a

840
00:29:58,870 --> 00:30:01,090
push d which is a drooping changes a

841
00:30:01,090 --> 00:30:03,460
directory not a heavily used command in

842
00:30:03,460 --> 00:30:06,340
Windows but it's there they also did

843
00:30:06,340 --> 00:30:07,870
take own because now they're trying to

844
00:30:07,870 --> 00:30:10,600
take ownership and hide the dll for from

845
00:30:10,600 --> 00:30:12,340
us they hit them at rip them and all

846
00:30:12,340 --> 00:30:15,220
that and so right there the quantity

847
00:30:15,220 --> 00:30:16,930
I've got just from this one infection

848
00:30:16,930 --> 00:30:19,960
allows me to set up a logic of if all

849
00:30:19,960 --> 00:30:22,410
the if all these executables in my list

850
00:30:22,410 --> 00:30:25,180
execute and are greater than quantity

851
00:30:25,180 --> 00:30:27,370
say to that means on the third one of

852
00:30:27,370 --> 00:30:29,290
these my slump would alert me to

853
00:30:29,290 --> 00:30:31,000
multiple commands being executed in a

854
00:30:31,000 --> 00:30:33,550
box I rarely caught admins doing this

855
00:30:33,550 --> 00:30:34,930
unless they were installing a new system

856
00:30:34,930 --> 00:30:36,070
and I can just reach out and say Hayes

857
00:30:36,070 --> 00:30:38,350
issue and so when they started doing

858
00:30:38,350 --> 00:30:39,730
this in a box as we had command line

859
00:30:39,730 --> 00:30:41,500
logging it lit up like a Christmas tree

860
00:30:41,500 --> 00:30:45,540
it was like win win win win win yes

861
00:30:47,260 --> 00:30:50,690
hey Tori they're moving forward it's

862
00:30:50,690 --> 00:30:53,330
already there yeah I and on all the

863
00:30:53,330 --> 00:30:54,740
windows stuff now has this option you

864
00:30:54,740 --> 00:30:59,120
just have to tweak a reg key and so it's

865
00:30:59,120 --> 00:31:00,559
in the windows logging cheat sheet the

866
00:31:00,559 --> 00:31:04,580
reg key at the end we get a didn't have

867
00:31:04,580 --> 00:31:12,350
anything go and incoming so hidden the

868
00:31:12,350 --> 00:31:14,240
registry a via the command line pointed

869
00:31:14,240 --> 00:31:16,159
us Hey look here software clients there

870
00:31:16,159 --> 00:31:17,690
was also a software classes key they

871
00:31:17,690 --> 00:31:21,140
used and the classes asterisk even

872
00:31:21,140 --> 00:31:22,789
better yet really trying to hide it not

873
00:31:22,789 --> 00:31:24,950
making it a name and inside this was a

874
00:31:24,950 --> 00:31:27,799
bunch of info one of which was in this

875
00:31:27,799 --> 00:31:30,260
funny scenario of this big blob we're

876
00:31:30,260 --> 00:31:32,929
like hmm what's up with that right now I

877
00:31:32,929 --> 00:31:34,610
still have no answers they pointed me

878
00:31:34,610 --> 00:31:36,470
where look but I can't read anything so

879
00:31:36,470 --> 00:31:38,480
you know we kept poking around kept

880
00:31:38,480 --> 00:31:40,940
poking around kept poking around in some

881
00:31:40,940 --> 00:31:42,620
cases especially when we started

882
00:31:42,620 --> 00:31:44,809
recreating this in the lab because at

883
00:31:44,809 --> 00:31:47,059
different stages they literally copied

884
00:31:47,059 --> 00:31:50,030
the driver out of the file system and

885
00:31:50,030 --> 00:31:51,620
dropped it into the registry so it was

886
00:31:51,620 --> 00:31:53,630
MZ and all the normal code you normally

887
00:31:53,630 --> 00:31:55,580
see and in the course of their infection

888
00:31:55,580 --> 00:31:58,520
they would convert it to hex as part of

889
00:31:58,520 --> 00:32:00,260
their office keishon and then from there

890
00:32:00,260 --> 00:32:03,049
they encrypted it so when we did see

891
00:32:03,049 --> 00:32:05,179
these in MZ we are harvest them when we

892
00:32:05,179 --> 00:32:07,100
saw him is 45 days we could harvest them

893
00:32:07,100 --> 00:32:08,510
and turn them into MZ's we could hash

894
00:32:08,510 --> 00:32:10,610
them and now we knew what was hiding in

895
00:32:10,610 --> 00:32:12,320
the registry and we didn't care about

896
00:32:12,320 --> 00:32:13,820
the encrypted pelo at this point we knew

897
00:32:13,820 --> 00:32:16,580
it was that driver and so that led us to

898
00:32:16,580 --> 00:32:19,789
the fact that in this case here's the

899
00:32:19,789 --> 00:32:21,169
here's the big long script that sort of

900
00:32:21,169 --> 00:32:22,370
looks like when you're looking at it I

901
00:32:22,370 --> 00:32:24,049
don't know what that means and so you

902
00:32:24,049 --> 00:32:25,610
have to start trying to get clever and

903
00:32:25,610 --> 00:32:29,299
figure out how to harvest it now this

904
00:32:29,299 --> 00:32:30,950
was new they've never seen this before

905
00:32:30,950 --> 00:32:33,320
and it led us to actually changing some

906
00:32:33,320 --> 00:32:36,110
of our behavior and doing I are they

907
00:32:36,110 --> 00:32:38,090
added three new keys to the registry

908
00:32:38,090 --> 00:32:39,710
they put him in the software clients or

909
00:32:39,710 --> 00:32:42,140
classes key again trying to hide in

910
00:32:42,140 --> 00:32:44,900
multiple ways and they also on the HR

911
00:32:44,900 --> 00:32:48,919
system created a what looked like a w

912
00:32:48,919 --> 00:32:51,409
acrobat file it was the same driver we

913
00:32:51,409 --> 00:32:53,090
don't believe this instance actually

914
00:32:53,090 --> 00:32:55,640
successfully installed it failed it's a

915
00:32:55,640 --> 00:32:56,960
good thing because this person was

916
00:32:56,960 --> 00:32:58,070
infected months early

917
00:32:58,070 --> 00:33:00,180
but it definitely hung it was up

918
00:33:00,180 --> 00:33:01,290
something it did not work in their

919
00:33:01,290 --> 00:33:03,180
environment they created three keys in

920
00:33:03,180 --> 00:33:06,000
English put file file and read and

921
00:33:06,000 --> 00:33:12,390
here's what was in them no DXE that's

922
00:33:12,390 --> 00:33:13,830
not a typo that's what they named the

923
00:33:13,830 --> 00:33:17,400
key who knows yeah but in there was the

924
00:33:17,400 --> 00:33:19,500
driver and for sure it was an MZ as a PE

925
00:33:19,500 --> 00:33:24,960
windows fifo what's that yeah I love

926
00:33:24,960 --> 00:33:27,270
Adobe apparently but yeah that's the

927
00:33:27,270 --> 00:33:29,160
name of it that's you can't go off a

928
00:33:29,160 --> 00:33:32,970
name yeah true so in the foot file

929
00:33:32,970 --> 00:33:35,820
directory they had this big blob again

930
00:33:35,820 --> 00:33:37,110
you know there's not much there but

931
00:33:37,110 --> 00:33:39,570
that's you know actually the the stuff

932
00:33:39,570 --> 00:33:41,370
they were doing and then in here you can

933
00:33:41,370 --> 00:33:42,990
actually see one of the ones that were

934
00:33:42,990 --> 00:33:44,550
it was done in hex so this is the one I

935
00:33:44,550 --> 00:33:46,080
harvested to figure out what it did

936
00:33:46,080 --> 00:33:47,640
because if it's in hex I know I can make

937
00:33:47,640 --> 00:33:49,800
it actually into a PE and I was able to

938
00:33:49,800 --> 00:33:51,570
hash it and see that it was indeed the

939
00:33:51,570 --> 00:33:53,580
same drivers everything else so I now

940
00:33:53,580 --> 00:33:55,290
knew what the thing was that was

941
00:33:55,290 --> 00:33:56,610
impacting the box the same as all the

942
00:33:56,610 --> 00:33:59,730
others and then and again if you don't

943
00:33:59,730 --> 00:34:03,180
know 45 a means m ZX whoops and then

944
00:34:03,180 --> 00:34:04,920
they had this read key so in essence

945
00:34:04,920 --> 00:34:07,170
what they did is they had the infect or

946
00:34:07,170 --> 00:34:08,969
reach out into the registry after it was

947
00:34:08,969 --> 00:34:11,310
populated grab this registry crees

948
00:34:11,310 --> 00:34:13,199
string which was the actual script

949
00:34:13,199 --> 00:34:15,989
information to infect another box then

950
00:34:15,989 --> 00:34:18,659
in order to do the D infection or they

951
00:34:18,659 --> 00:34:20,010
or they pull out of the registry and

952
00:34:20,010 --> 00:34:22,770
write to the disk they read are they did

953
00:34:22,770 --> 00:34:24,690
the foot file where it actually told

954
00:34:24,690 --> 00:34:26,100
them how to pull it out of the registry

955
00:34:26,100 --> 00:34:27,780
was all the sea script and whatnot that

956
00:34:27,780 --> 00:34:30,120
then wrote it to disk and so their

957
00:34:30,120 --> 00:34:32,190
scripts are in here again obfuscated it

958
00:34:32,190 --> 00:34:34,889
but in some cases not and then the big

959
00:34:34,889 --> 00:34:39,330
ass file payload was a 296 Meg file

960
00:34:39,330 --> 00:34:41,760
payload of a driver and I'll talk about

961
00:34:41,760 --> 00:34:44,429
that in a second so the infect her again

962
00:34:44,429 --> 00:34:47,340
was for the DLLs to infect mcafee

963
00:34:47,340 --> 00:34:49,409
framework frame mcafee framework service

964
00:34:49,409 --> 00:34:51,480
and make me framework helper sorry let's

965
00:34:51,480 --> 00:34:53,370
make sure I get the right one and the

966
00:34:53,370 --> 00:34:55,168
infect sis was a thing that did the

967
00:34:55,168 --> 00:34:56,969
driver infection so we actually use

968
00:34:56,969 --> 00:34:58,500
these tools in the lab and said yep

969
00:34:58,500 --> 00:35:01,110
that's what it does and it infected the

970
00:35:01,110 --> 00:35:02,670
mcafee framework service the best client

971
00:35:02,670 --> 00:35:04,830
helper and several others and some they

972
00:35:04,830 --> 00:35:07,440
failed I think by accident or maybe this

973
00:35:07,440 --> 00:35:09,000
tool doesn't work on everything but we

974
00:35:09,000 --> 00:35:10,530
tried it with a lot of others and we

975
00:35:10,530 --> 00:35:11,340
were able to infect

976
00:35:11,340 --> 00:35:14,960
and run no pad for example it was

977
00:35:14,960 --> 00:35:17,340
surprising this vector works really

978
00:35:17,340 --> 00:35:20,850
really well and yep yeah it worked and

979
00:35:20,850 --> 00:35:23,130
so now we could recreate the payload in

980
00:35:23,130 --> 00:35:24,750
the lab which means we knew everything

981
00:35:24,750 --> 00:35:27,900
we needed to move forward but one thing

982
00:35:27,900 --> 00:35:30,900
how did it get from the registry to the

983
00:35:30,900 --> 00:35:33,390
dropped file location and well here it

984
00:35:33,390 --> 00:35:35,970
is there's the location again once we

985
00:35:35,970 --> 00:35:38,880
executed the bower and saw that mcafee

986
00:35:38,880 --> 00:35:41,070
framework service was doing it and check

987
00:35:41,070 --> 00:35:42,600
the hashes against all the others we

988
00:35:42,600 --> 00:35:44,010
found the systems that we had the

989
00:35:44,010 --> 00:35:46,170
initial artifacts on they all had these

990
00:35:46,170 --> 00:35:47,840
different hashes for these different

991
00:35:47,840 --> 00:35:50,250
management utilities and we're like aha

992
00:35:50,250 --> 00:35:51,900
they popped them but they still worked

993
00:35:51,900 --> 00:35:54,180
AV still work big fix still work alterra

994
00:35:54,180 --> 00:35:55,800
stuff works Blanc still work and like

995
00:35:55,800 --> 00:35:57,750
what the hell this is this is really

996
00:35:57,750 --> 00:36:01,140
cool and so that came up with a dude so

997
00:36:01,140 --> 00:36:03,150
as soon as it loaded it deleted so now

998
00:36:03,150 --> 00:36:05,250
the now that the comp recover mines

999
00:36:05,250 --> 00:36:08,130
binary loaded read the key decrypted it

1000
00:36:08,130 --> 00:36:09,930
dropped it to disk now this looping

1001
00:36:09,930 --> 00:36:11,850
service could read that file load it

1002
00:36:11,850 --> 00:36:13,290
then the things that okay you're done

1003
00:36:13,290 --> 00:36:15,270
delete it so that's the way they tried

1004
00:36:15,270 --> 00:36:16,620
to keep the persistence where we

1005
00:36:16,620 --> 00:36:19,140
couldn't find the file and of course we

1006
00:36:19,140 --> 00:36:22,230
were better than they were so yay they

1007
00:36:22,230 --> 00:36:24,230
worked really well so what led us there

1008
00:36:24,230 --> 00:36:26,790
Mallard discovery I talked about the

1009
00:36:26,790 --> 00:36:29,160
concept of baselining in order to figure

1010
00:36:29,160 --> 00:36:31,620
out where these binaries were I said

1011
00:36:31,620 --> 00:36:33,570
something on the disk is different so we

1012
00:36:33,570 --> 00:36:35,220
immediately initiated we I have this big

1013
00:36:35,220 --> 00:36:37,440
master hash at windows 7 windows 8 I had

1014
00:36:37,440 --> 00:36:39,450
to add to it and windows 2012 already

1015
00:36:39,450 --> 00:36:40,590
had from all the other servers were

1016
00:36:40,590 --> 00:36:42,450
built and windows 2000 e I had run a

1017
00:36:42,450 --> 00:36:44,340
baseline hash on our new builds so I had

1018
00:36:44,340 --> 00:36:46,770
his big ass file and I threw that in

1019
00:36:46,770 --> 00:36:48,690
comparison with sha-1 deep with a minus

1020
00:36:48,690 --> 00:36:51,540
x2 one of these infected systems I just

1021
00:36:51,540 --> 00:36:52,710
made a script of big fix and push down

1022
00:36:52,710 --> 00:36:54,270
and said run this drop the files that i

1023
00:36:54,270 --> 00:36:56,250
went and harvested them and what I found

1024
00:36:56,250 --> 00:36:58,080
was in the bigfix directory in the mag

1025
00:36:58,080 --> 00:36:59,220
raphy director emailed terrorists

1026
00:36:59,220 --> 00:37:01,800
directory is one binary had a different

1027
00:37:01,800 --> 00:37:03,660
hash than all the others and that point

1028
00:37:03,660 --> 00:37:04,920
island I'm going to go look across the

1029
00:37:04,920 --> 00:37:07,230
environment and hash maxi framework

1030
00:37:07,230 --> 00:37:08,520
service for everything and then I must

1031
00:37:08,520 --> 00:37:10,890
sort it and I see hey all these have a

1032
00:37:10,890 --> 00:37:12,210
different binary and all that spigot

1033
00:37:12,210 --> 00:37:13,590
there's a stud bits there's those

1034
00:37:13,590 --> 00:37:15,000
tidbits and that's how I went across the

1035
00:37:15,000 --> 00:37:17,130
environment and found them and so now I

1036
00:37:17,130 --> 00:37:19,290
knew exactly which machines are infected

1037
00:37:19,290 --> 00:37:21,360
with that particular mechanism that was

1038
00:37:21,360 --> 00:37:24,339
good and you do to compare like

1039
00:37:24,339 --> 00:37:26,410
plus a master file or paws am fr and so

1040
00:37:26,410 --> 00:37:27,670
I did it compare and it showed us

1041
00:37:27,670 --> 00:37:29,049
listing of hashes and that's how that's

1042
00:37:29,049 --> 00:37:31,029
how we basically do it if you're an IR

1043
00:37:31,029 --> 00:37:33,489
guy and you've ever done this Sean D but

1044
00:37:33,489 --> 00:37:34,869
this recursive hash stuff works pretty

1045
00:37:34,869 --> 00:37:37,479
well we looked about them and again oh

1046
00:37:37,479 --> 00:37:39,099
now we're winning for sure because now

1047
00:37:39,099 --> 00:37:41,079
we know exactly the missing piece of

1048
00:37:41,079 --> 00:37:43,599
what to do to clean it up alright but I

1049
00:37:43,599 --> 00:37:45,519
want to see it do it so everybody's

1050
00:37:45,519 --> 00:37:47,440
really proc mountains internals tool for

1051
00:37:47,440 --> 00:37:49,779
windows well there it is actually doing

1052
00:37:49,779 --> 00:37:51,369
it so it's the best client help are

1053
00:37:51,369 --> 00:37:53,469
doing a create file c program files

1054
00:37:53,469 --> 00:37:57,460
common files system wls 64 cysts and

1055
00:37:57,460 --> 00:37:59,229
there it is actually writing the file

1056
00:37:59,229 --> 00:38:01,210
disk that was the final absolute we're

1057
00:38:01,210 --> 00:38:03,519
certain that's what it's doing so pretty

1058
00:38:03,519 --> 00:38:04,660
cool and then further down you can

1059
00:38:04,660 --> 00:38:08,019
actually see where it deletes it BAM got

1060
00:38:08,019 --> 00:38:09,549
them man we now know what we need to

1061
00:38:09,549 --> 00:38:12,009
know so finally we had all the pieces

1062
00:38:12,009 --> 00:38:15,579
recreated in the lab high confidence for

1063
00:38:15,579 --> 00:38:17,380
remediation now able and this is about

1064
00:38:17,380 --> 00:38:18,789
mid December and started just before

1065
00:38:18,789 --> 00:38:21,309
Thanksgiving and it did not take 210

1066
00:38:21,309 --> 00:38:23,380
days meantime to detection this was

1067
00:38:23,380 --> 00:38:24,900
literally within first couple hours

1068
00:38:24,900 --> 00:38:26,799
contained within the first couple days

1069
00:38:26,799 --> 00:38:29,229
and and basically at that point

1070
00:38:29,229 --> 00:38:31,599
remediating you can't just turn off game

1071
00:38:31,599 --> 00:38:32,710
blades in the middle you have to do

1072
00:38:32,710 --> 00:38:33,789
maintenance windows and all that crap

1073
00:38:33,789 --> 00:38:35,829
there's nothing of value that they can

1074
00:38:35,829 --> 00:38:37,660
take on those so didn't really bothers

1075
00:38:37,660 --> 00:38:38,799
too much they were contained they

1076
00:38:38,799 --> 00:38:40,599
couldn't phone home but once we have

1077
00:38:40,599 --> 00:38:41,769
everything we turned off all the

1078
00:38:41,769 --> 00:38:43,809
communication there were certain we had

1079
00:38:43,809 --> 00:38:46,029
everything we needed except for the fact

1080
00:38:46,029 --> 00:38:47,769
that one of the blades unfortunately had

1081
00:38:47,769 --> 00:38:50,499
crashed before the cleanup and so when

1082
00:38:50,499 --> 00:38:51,969
the guy found it crashed and brought it

1083
00:38:51,969 --> 00:38:55,170
back up reinfection

1084
00:38:55,170 --> 00:38:58,170
so warning be sure to work with your

1085
00:38:58,170 --> 00:39:00,390
guys make sure all the drivers of all

1086
00:39:00,390 --> 00:39:02,309
the management apps are running before

1087
00:39:02,309 --> 00:39:04,290
you start your clean up an account for

1088
00:39:04,290 --> 00:39:06,839
every damn system because you skip one

1089
00:39:06,839 --> 00:39:08,940
yeah yo start all over fortunately the

1090
00:39:08,940 --> 00:39:11,099
same stuff so we able to immediately cut

1091
00:39:11,099 --> 00:39:12,540
off communication again and start over

1092
00:39:12,540 --> 00:39:14,700
and this time we went through a lot of

1093
00:39:14,700 --> 00:39:16,470
validation and make sure everything was

1094
00:39:16,470 --> 00:39:19,200
running before we cut everything off so

1095
00:39:19,200 --> 00:39:26,790
yeah it worked pretty well so how long

1096
00:39:26,790 --> 00:39:28,200
was it from the first got into a clean

1097
00:39:28,200 --> 00:39:34,920
up to begin a remediation so we detected

1098
00:39:34,920 --> 00:39:36,150
it within the first couple hours we

1099
00:39:36,150 --> 00:39:37,980
remediated yeah good good question we

1100
00:39:37,980 --> 00:39:41,099
remediated we contained it in the first

1101
00:39:41,099 --> 00:39:43,380
few days we cleaned up Enterprise

1102
00:39:43,380 --> 00:39:45,569
probably in a few days later and until

1103
00:39:45,569 --> 00:39:47,849
them course that box yeah that box came

1104
00:39:47,849 --> 00:39:49,619
up but we had a lot of other components

1105
00:39:49,619 --> 00:39:50,970
we could not clean we're talking

1106
00:39:50,970 --> 00:39:52,770
hundreds of frigging game servers and

1107
00:39:52,770 --> 00:39:54,210
all the components all the others help

1108
00:39:54,210 --> 00:39:56,670
rebel servers and and because they're

1109
00:39:56,670 --> 00:39:58,140
internet-facing there's no firewall

1110
00:39:58,140 --> 00:39:59,460
controls like you would think in normal

1111
00:39:59,460 --> 00:40:00,359
environments because of the throughput

1112
00:40:00,359 --> 00:40:02,819
we didn't have the same ability so when

1113
00:40:02,819 --> 00:40:04,859
we cut stuff off we had to do it you

1114
00:40:04,859 --> 00:40:06,869
know all edits one at once because of

1115
00:40:06,869 --> 00:40:07,920
all digital data centers across the

1116
00:40:07,920 --> 00:40:10,349
world so that was scheduled they weren't

1117
00:40:10,349 --> 00:40:11,790
able to talk to any database servers so

1118
00:40:11,790 --> 00:40:13,319
we don't worry about risk of that stuff

1119
00:40:13,319 --> 00:40:15,180
it's more of them just trying to hide

1120
00:40:15,180 --> 00:40:16,410
all the persistence and being able to

1121
00:40:16,410 --> 00:40:17,819
hop around and go looking and getting

1122
00:40:17,819 --> 00:40:19,799
all the stuff they actually want gaming

1123
00:40:19,799 --> 00:40:21,750
has a pretty well design infrastructure

1124
00:40:21,750 --> 00:40:23,430
and so there's nothing of value here let

1125
00:40:23,430 --> 00:40:25,319
them have it it's not crashing the game

1126
00:40:25,319 --> 00:40:26,609
don't worry about it if it crashes the

1127
00:40:26,609 --> 00:40:28,410
game rebuild a server push it to another

1128
00:40:28,410 --> 00:40:30,180
one it's a good question it probably

1129
00:40:30,180 --> 00:40:32,430
took about two tries of two weeks to get

1130
00:40:32,430 --> 00:40:34,559
all the things cleaned up the rest of

1131
00:40:34,559 --> 00:40:35,640
the stuff that was contained in the

1132
00:40:35,640 --> 00:40:38,940
bubble so now our management allowed us

1133
00:40:38,940 --> 00:40:39,990
to set up the alerts because I'm

1134
00:40:39,990 --> 00:40:41,819
constantly read these reports I

1135
00:40:41,819 --> 00:40:44,040
recommend you do too I take the tidbits

1136
00:40:44,040 --> 00:40:45,660
him looking at the fonts directory I

1137
00:40:45,660 --> 00:40:47,309
pick on that one because these guys use

1138
00:40:47,309 --> 00:40:48,630
the fonts directory to store their log

1139
00:40:48,630 --> 00:40:51,960
files their debug log files I this ran

1140
00:40:51,960 --> 00:40:54,270
yep successful yep successful and it was

1141
00:40:54,270 --> 00:40:56,369
a very detailed it was awesome so they

1142
00:40:56,369 --> 00:40:58,020
forgot to delete them but I wouldn't

1143
00:40:58,020 --> 00:40:59,160
found that if i wasn't monitoring the

1144
00:40:59,160 --> 00:41:00,510
fonts directory which i actually got

1145
00:41:00,510 --> 00:41:03,510
from another apt that's how ma'am our

1146
00:41:03,510 --> 00:41:05,490
management works now our discovery

1147
00:41:05,490 --> 00:41:06,990
because I'm hash into boxes saying

1148
00:41:06,990 --> 00:41:07,589
there's

1149
00:41:07,589 --> 00:41:09,059
something on here i'm not seeing or i'm

1150
00:41:09,059 --> 00:41:11,279
not looking for in a directory they're

1151
00:41:11,279 --> 00:41:12,599
using that we're not managing or

1152
00:41:12,599 --> 00:41:14,249
monitoring for so i'll get a hash the

1153
00:41:14,249 --> 00:41:15,779
whole box that's what my our discovery

1154
00:41:15,779 --> 00:41:17,430
is involved and then malware analysis

1155
00:41:17,430 --> 00:41:19,499
and doing it recreating in the lab gave

1156
00:41:19,499 --> 00:41:21,029
us all the sure ensuite knew we could

1157
00:41:21,029 --> 00:41:24,779
remediate very fast so how you can

1158
00:41:24,779 --> 00:41:28,229
detect this ninja tips this is how we

1159
00:41:28,229 --> 00:41:30,809
harvested the malware so some infections

1160
00:41:30,809 --> 00:41:32,789
hung so recommendation number one is

1161
00:41:32,789 --> 00:41:35,519
look for parent list executables so for

1162
00:41:35,519 --> 00:41:38,460
parentless processes for example in the

1163
00:41:38,460 --> 00:41:40,799
talk yesterday and also my training we

1164
00:41:40,799 --> 00:41:43,829
reference on my slides a malicious word

1165
00:41:43,829 --> 00:41:45,599
document in that word document when you

1166
00:41:45,599 --> 00:41:47,369
launch it there's embedded macros in

1167
00:41:47,369 --> 00:41:49,319
vbscript so you have a tree in the

1168
00:41:49,319 --> 00:41:50,789
process tree looking like this it's

1169
00:41:50,789 --> 00:41:53,519
windward its command exe its see script

1170
00:41:53,519 --> 00:41:55,680
it's powershell it then calls another

1171
00:41:55,680 --> 00:41:58,710
command a txt and some other executables

1172
00:41:58,710 --> 00:42:00,420
and so you get this tree structure you

1173
00:42:00,420 --> 00:42:03,450
close word command exe is still there

1174
00:42:03,450 --> 00:42:06,210
but now its parents gone so I can crawl

1175
00:42:06,210 --> 00:42:07,619
through systems or the simple scripts

1176
00:42:07,619 --> 00:42:08,969
and sis internal tools will do this for

1177
00:42:08,969 --> 00:42:10,680
you and basically final the pigs running

1178
00:42:10,680 --> 00:42:12,509
and then say who's your parent because

1179
00:42:12,509 --> 00:42:14,069
there is a process structure within the

1180
00:42:14,069 --> 00:42:16,019
windows and you can identify that and

1181
00:42:16,019 --> 00:42:18,630
show me all the parent lyst identifiers

1182
00:42:18,630 --> 00:42:20,880
so when the stuff hung in the box yeah

1183
00:42:20,880 --> 00:42:22,170
the parent was gone because the effector

1184
00:42:22,170 --> 00:42:24,089
launched assuming it would complete and

1185
00:42:24,089 --> 00:42:26,160
delete it when they hung I was able to

1186
00:42:26,160 --> 00:42:27,869
go harvest I knew those servers had

1187
00:42:27,869 --> 00:42:29,069
something on the box and I went

1188
00:42:29,069 --> 00:42:31,200
harvested it so that's a big tip that

1189
00:42:31,200 --> 00:42:33,029
this was really valuable for us look for

1190
00:42:33,029 --> 00:42:35,640
parentless processes there's not a lot

1191
00:42:35,640 --> 00:42:37,289
of them normally some stuff like Java

1192
00:42:37,289 --> 00:42:38,789
will do it but there's not a lot

1193
00:42:38,789 --> 00:42:42,660
normally the other thing is the command

1194
00:42:42,660 --> 00:42:44,249
line logging obviously pointed us where

1195
00:42:44,249 --> 00:42:45,809
to look so we created these really cool

1196
00:42:45,809 --> 00:42:48,210
high-tech scripts with the robocopy here

1197
00:42:48,210 --> 00:42:51,660
it is nothing more than woohoo I changed

1198
00:42:51,660 --> 00:42:53,039
it just a better for prezzo but was

1199
00:42:53,039 --> 00:42:54,749
captured I used the word captured but I

1200
00:42:54,749 --> 00:42:56,369
slewed the directory capture I want to

1201
00:42:56,369 --> 00:42:57,869
capture my captured stuff over and over

1202
00:42:57,869 --> 00:42:59,579
and literally just copies everything

1203
00:42:59,579 --> 00:43:02,009
loops loops loops we turn this on on all

1204
00:43:02,009 --> 00:43:03,390
those directories I talked about earlier

1205
00:43:03,390 --> 00:43:05,579
and the cool thing was as those things

1206
00:43:05,579 --> 00:43:07,469
ran and when that second infection

1207
00:43:07,469 --> 00:43:09,359
happened after we were doing cleanup so

1208
00:43:09,359 --> 00:43:10,710
as we did clean up one of our steps was

1209
00:43:10,710 --> 00:43:12,569
to launch these scripts and just let

1210
00:43:12,569 --> 00:43:14,160
them loop and raise directors are pretty

1211
00:43:14,160 --> 00:43:15,509
much empty there's not very much stuff

1212
00:43:15,509 --> 00:43:17,849
in where they put this stuff and so that

1213
00:43:17,849 --> 00:43:19,140
these things are I'm really fast nobody

1214
00:43:19,140 --> 00:43:20,729
even notice they were running and so

1215
00:43:20,729 --> 00:43:21,450
when we got reading

1216
00:43:21,450 --> 00:43:23,700
that we got so many binaries out of this

1217
00:43:23,700 --> 00:43:26,700
was great yeah simple high tech right

1218
00:43:26,700 --> 00:43:29,250
but it worked awesome if you're in a lab

1219
00:43:29,250 --> 00:43:30,720
environment where you're taking payloads

1220
00:43:30,720 --> 00:43:32,040
and you're infecting them highly

1221
00:43:32,040 --> 00:43:33,390
recommend you do this where you think

1222
00:43:33,390 --> 00:43:35,369
the mayor will drop obviously it won't

1223
00:43:35,369 --> 00:43:37,200
catch don't do entire C Drive that won't

1224
00:43:37,200 --> 00:43:38,880
work but directories they don't have a

1225
00:43:38,880 --> 00:43:41,579
lot of stuff this works really well and

1226
00:43:41,579 --> 00:43:43,140
anything in the app data space for all

1227
00:43:43,140 --> 00:43:45,180
that commodity user base drop malware is

1228
00:43:45,180 --> 00:43:49,109
awesome so top priorities here's the kb

1229
00:43:49,109 --> 00:43:51,810
guys everybody needs his patch read this

1230
00:43:51,810 --> 00:43:53,280
it also tells you about the registry key

1231
00:43:53,280 --> 00:43:56,400
to tweak I you know I call this some

1232
00:43:56,400 --> 00:43:58,470
people mentioned I see my sexy six talk

1233
00:43:58,470 --> 00:44:00,060
this is kind of an elaboration on that

1234
00:44:00,060 --> 00:44:02,520
especially because of my sexy six and

1235
00:44:02,520 --> 00:44:04,619
that was built to pick on home depot and

1236
00:44:04,619 --> 00:44:08,130
target target obviously got popped we

1237
00:44:08,130 --> 00:44:10,230
know that the isight partners report

1238
00:44:10,230 --> 00:44:13,020
showed in much detail that here's what

1239
00:44:13,020 --> 00:44:14,820
it did one of the things that did was

1240
00:44:14,820 --> 00:44:17,670
dropped two services black POS d XE and

1241
00:44:17,670 --> 00:44:21,210
POS WDS if all these retailers home

1242
00:44:21,210 --> 00:44:23,820
depot especially had monitored for

1243
00:44:23,820 --> 00:44:25,710
nothing more than in this is XP these

1244
00:44:25,710 --> 00:44:28,079
are win7 and on vista I'd beat IDs but

1245
00:44:28,079 --> 00:44:29,790
there's an equivalent if they had

1246
00:44:29,790 --> 00:44:31,020
monitored nothing more than a new

1247
00:44:31,020 --> 00:44:34,020
service install on a POS they would have

1248
00:44:34,020 --> 00:44:35,490
caught this thing immediately if that's

1249
00:44:35,490 --> 00:44:37,650
all they looked for that's a that's a

1250
00:44:37,650 --> 00:44:39,240
huge payoff here folks if you're not

1251
00:44:39,240 --> 00:44:41,190
looking for these two items right here

1252
00:44:41,190 --> 00:44:43,440
this is your short list of stuff process

1253
00:44:43,440 --> 00:44:45,300
create get stress on it's noisy they'll

1254
00:44:45,300 --> 00:44:47,280
get me wrong read the windows login

1255
00:44:47,280 --> 00:44:48,930
cheat sheet to get some guidance but if

1256
00:44:48,930 --> 00:44:50,160
you turn this on now everything that

1257
00:44:50,160 --> 00:44:51,630
executes sin the system ever recorded in

1258
00:44:51,630 --> 00:44:54,480
their logs and the windows logs 4624

1259
00:44:54,480 --> 00:44:56,910
successful logins of course 51 40s this

1260
00:44:56,910 --> 00:44:58,410
is where I'm capturing them net using

1261
00:44:58,410 --> 00:44:59,910
two boxes and pushing their payload

1262
00:44:59,910 --> 00:45:01,650
which they then executed remotely with

1263
00:45:01,650 --> 00:45:06,119
wmi 4663 s I have auditing on and file

1264
00:45:06,119 --> 00:45:08,400
locations like app data local see

1265
00:45:08,400 --> 00:45:11,040
windows web see users public and see /

1266
00:45:11,040 --> 00:45:12,660
flogs because nothing ever happens there

1267
00:45:12,660 --> 00:45:14,369
it's not noisy doesn't tilt the logs so

1268
00:45:14,369 --> 00:45:16,710
that got turned on and because now our

1269
00:45:16,710 --> 00:45:18,270
management tells me these locations are

1270
00:45:18,270 --> 00:45:20,160
often used I do some testing how much is

1271
00:45:20,160 --> 00:45:21,540
this really putting in my log normally

1272
00:45:21,540 --> 00:45:23,040
that's a good alert and I'll leave it

1273
00:45:23,040 --> 00:45:24,630
there and now I can catch file drops

1274
00:45:24,630 --> 00:45:28,470
just from logging 5156 if you don't use

1275
00:45:28,470 --> 00:45:29,819
the Windows Firewall another talk

1276
00:45:29,819 --> 00:45:31,109
yesterday talked about this was huge

1277
00:45:31,109 --> 00:45:33,970
value for them sis mom will also do that

1278
00:45:33,970 --> 00:45:35,260
you want to use a system on service we

1279
00:45:35,260 --> 00:45:38,440
did use that as part of the IR here put

1280
00:45:38,440 --> 00:45:40,150
it across a lot of servers the windows 7

1281
00:45:40,150 --> 00:45:42,430
2008 servers it stopped a lot of times

1282
00:45:42,430 --> 00:45:44,369
so it wasn't as consistent as I'd like

1283
00:45:44,369 --> 00:45:46,869
apparently Carlos Perez is talked to

1284
00:45:46,869 --> 00:45:48,700
mark as well we're both noticing some of

1285
00:45:48,700 --> 00:45:50,290
these these bugs so they've got to work

1286
00:45:50,290 --> 00:45:52,750
on version 3 but if you're not doing it

1287
00:45:52,750 --> 00:45:54,430
if you have for example the Windows

1288
00:45:54,430 --> 00:45:57,040
Firewall disabled in the root oh you get

1289
00:45:57,040 --> 00:45:58,900
rid of that get you guys to move it to a

1290
00:45:58,900 --> 00:46:01,119
sub 0 you so that way if you need to

1291
00:46:01,119 --> 00:46:03,010
turn the windows firewall on you can

1292
00:46:03,010 --> 00:46:04,660
drag the system out of that oh you drop

1293
00:46:04,660 --> 00:46:05,920
them into a no use it's got all this

1294
00:46:05,920 --> 00:46:07,840
stuff turned on and now the sudden

1295
00:46:07,840 --> 00:46:09,130
you're logging to get really enhanced

1296
00:46:09,130 --> 00:46:10,390
and it's nothing more than moving the

1297
00:46:10,390 --> 00:46:12,460
machine to a different group and put it

1298
00:46:12,460 --> 00:46:14,349
in any you won't block anything the user

1299
00:46:14,349 --> 00:46:16,090
will never know and now you can start

1300
00:46:16,090 --> 00:46:17,950
collecting all this information a highly

1301
00:46:17,950 --> 00:46:19,630
valuable new service in the case of

1302
00:46:19,630 --> 00:46:22,420
winnt I 2012 the change service we were

1303
00:46:22,420 --> 00:46:25,000
CPL support what's a change so it's a 70

1304
00:46:25,000 --> 00:46:26,830
40 and if you're doing PowerShell

1305
00:46:26,830 --> 00:46:28,150
logging you do need to have a default

1306
00:46:28,150 --> 00:46:30,430
profile yes there's a bypass for that I

1307
00:46:30,430 --> 00:46:32,020
understand that you just execution

1308
00:46:32,020 --> 00:46:35,200
policy bypass and no profile you won't

1309
00:46:35,200 --> 00:46:37,599
get this to work but if as your people

1310
00:46:37,599 --> 00:46:39,940
use PowerShell normally and you set the

1311
00:46:39,940 --> 00:46:42,580
remote signed execution policy when

1312
00:46:42,580 --> 00:46:44,560
scripts are executed you will catch what

1313
00:46:44,560 --> 00:46:46,420
the command lines are if you turn if you

1314
00:46:46,420 --> 00:46:47,800
enable this there's a couple variables

1315
00:46:47,800 --> 00:46:49,900
you have to put in so these are top

1316
00:46:49,900 --> 00:46:53,580
priority the things to start with yes

1317
00:46:56,220 --> 00:46:59,170
there is layers don't do me a lot of

1318
00:46:59,170 --> 00:47:01,480
good they're very noisy and these bed

1319
00:47:01,480 --> 00:47:05,170
these apts rarely so he 4625 is the

1320
00:47:05,170 --> 00:47:06,640
login failure says wouldn't that work

1321
00:47:06,640 --> 00:47:09,060
it's very little value to me honestly

1322
00:47:09,060 --> 00:47:11,290
surprising internet-facing yeah higher

1323
00:47:11,290 --> 00:47:12,790
value but you're going to fill up a lot

1324
00:47:12,790 --> 00:47:14,770
of failures I'm more interested in that

1325
00:47:14,770 --> 00:47:17,380
Sam connected to his machine his machine

1326
00:47:17,380 --> 00:47:18,780
his machine has a machine his machine

1327
00:47:18,780 --> 00:47:21,339
because we know just when their behavior

1328
00:47:21,339 --> 00:47:22,750
they popped the creds they know the

1329
00:47:22,750 --> 00:47:24,820
creds failure is not an option for them

1330
00:47:24,820 --> 00:47:27,820
it turns out and so just very little now

1331
00:47:27,820 --> 00:47:29,230
there was some times where commodity

1332
00:47:29,230 --> 00:47:30,970
Mauer will try to brute force matter of

1333
00:47:30,970 --> 00:47:32,470
fact some of the malware reports one of

1334
00:47:32,470 --> 00:47:34,089
them has a whole big list of the top you

1335
00:47:34,089 --> 00:47:35,890
know thousand bad passwords that had

1336
00:47:35,890 --> 00:47:38,980
brooded so yes but be prepared to have a

1337
00:47:38,980 --> 00:47:40,060
lot of noise that people are actually

1338
00:47:40,060 --> 00:47:42,640
doing this with failed login so that's a

1339
00:47:42,640 --> 00:47:44,650
good question it is no windows login

1340
00:47:44,650 --> 00:47:46,930
cheat sheet but just be aware it's not

1341
00:47:46,930 --> 00:47:47,710
my high prior

1342
00:47:47,710 --> 00:47:49,540
highest priority here's an example that

1343
00:47:49,540 --> 00:47:52,960
big list of commands ie exact should be

1344
00:47:52,960 --> 00:47:54,430
in here as well it's not on my sample I

1345
00:47:54,430 --> 00:47:56,080
took a couple out just shrink it to make

1346
00:47:56,080 --> 00:47:57,990
it readable but here's kind of what my

1347
00:47:57,990 --> 00:48:00,580
splunk or any log management it's event

1348
00:48:00,580 --> 00:48:03,550
code 4688 look for all these and then

1349
00:48:03,550 --> 00:48:05,170
think about it from the perspective of

1350
00:48:05,170 --> 00:48:06,700
well I execute these some of these all

1351
00:48:06,700 --> 00:48:08,500
the time you won't do it in the quantity

1352
00:48:08,500 --> 00:48:12,030
you see in the tax no way you just one

1353
00:48:12,030 --> 00:48:16,089
size matters so this was a big one the

1354
00:48:16,089 --> 00:48:17,650
fact that this payload got dropped in

1355
00:48:17,650 --> 00:48:19,420
the registry turns out if you scan the

1356
00:48:19,420 --> 00:48:21,910
registry for fur keys bigger than 20k

1357
00:48:21,910 --> 00:48:25,060
there are only about 20 of them so if

1358
00:48:25,060 --> 00:48:26,530
you filter those out in a whitelist in

1359
00:48:26,530 --> 00:48:29,800
some way and you look for large keys the

1360
00:48:29,800 --> 00:48:33,790
win NT I was 296 k and so my buddy had

1361
00:48:33,790 --> 00:48:35,200
written a little script and we ran it on

1362
00:48:35,200 --> 00:48:37,210
all the boxes and now we found every box

1363
00:48:37,210 --> 00:48:39,160
that had large keys and then we filtered

1364
00:48:39,160 --> 00:48:40,839
those out as the ones as normal like

1365
00:48:40,839 --> 00:48:42,310
your icons are all that stuff stored

1366
00:48:42,310 --> 00:48:44,440
that's a big key for example Microsoft

1367
00:48:44,440 --> 00:48:47,410
stores all kinds of status in there yeah

1368
00:48:47,410 --> 00:48:48,640
you can find this up pretty well there

1369
00:48:48,640 --> 00:48:50,800
is a GUI version reg scanner from near

1370
00:48:50,800 --> 00:48:53,260
soft and then David longenecker in

1371
00:48:53,260 --> 00:48:54,730
Austin went Austin peeps through some

1372
00:48:54,730 --> 00:48:56,950
conversation of Twitter went out wrote a

1373
00:48:56,950 --> 00:48:59,050
python script to actually do this I

1374
00:48:59,050 --> 00:49:01,330
think the defaults 20k to look for large

1375
00:49:01,330 --> 00:49:03,490
rich keys we are also incorporating this

1376
00:49:03,490 --> 00:49:05,830
functionality into log md this is a big

1377
00:49:05,830 --> 00:49:07,420
one where I want to replace using a GUI

1378
00:49:07,420 --> 00:49:10,060
so log in D will actually do and provide

1379
00:49:10,060 --> 00:49:11,650
you a whitelist for large reg keys as

1380
00:49:11,650 --> 00:49:14,890
you use moving forward enhance logging

1381
00:49:14,890 --> 00:49:17,020
system on if you haven't played with it

1382
00:49:17,020 --> 00:49:19,210
please do turn it all on but warning

1383
00:49:19,210 --> 00:49:20,680
somebody noticed this yesterday was

1384
00:49:20,680 --> 00:49:23,050
using it you must exclude sis mom from

1385
00:49:23,050 --> 00:49:25,089
your AV or will kill your box because

1386
00:49:25,089 --> 00:49:26,710
now is it's registering all these dll's

1387
00:49:26,710 --> 00:49:27,790
and drivers being loaded which is

1388
00:49:27,790 --> 00:49:30,400
boatloads AV can keep up and your system

1389
00:49:30,400 --> 00:49:31,990
will just come to a screeching halt so

1390
00:49:31,990 --> 00:49:33,460
there's my warning to using system on

1391
00:49:33,460 --> 00:49:35,770
with the monitor logging with the

1392
00:49:35,770 --> 00:49:38,950
network logging and again the windows

1393
00:49:38,950 --> 00:49:41,349
logging service is system on on steroids

1394
00:49:41,349 --> 00:49:43,570
yeah his thumbs up over here I can't

1395
00:49:43,570 --> 00:49:45,000
speak enough but I've had input to this

1396
00:49:45,000 --> 00:49:47,440
Jason McCord is added PowerShell command

1397
00:49:47,440 --> 00:49:49,030
line logging he does it at the trace

1398
00:49:49,030 --> 00:49:51,040
level not the logs it's actually a

1399
00:49:51,040 --> 00:49:53,230
replacement to your logging agent and

1400
00:49:53,230 --> 00:49:55,720
he's doing a trace level not reading the

1401
00:49:55,720 --> 00:49:57,430
windows logs so you want to do both

1402
00:49:57,430 --> 00:49:58,890
great and it sends it to it

1403
00:49:58,890 --> 00:50:01,559
Eric's syslog server he's also with the

1404
00:50:01,559 --> 00:50:03,059
next version I proud to announce that

1405
00:50:03,059 --> 00:50:05,910
he's doing wmic commands so if the bad

1406
00:50:05,910 --> 00:50:07,529
guys are launching wmic you're gonna be

1407
00:50:07,529 --> 00:50:08,640
able to see the calls that they're

1408
00:50:08,640 --> 00:50:11,010
making so at least maybe now I can see

1409
00:50:11,010 --> 00:50:13,019
if they're using that functionality I'll

1410
00:50:13,019 --> 00:50:14,760
see that but a lot of the hackers have

1411
00:50:14,760 --> 00:50:17,789
moved to the PowerShell execution of wmi

1412
00:50:17,789 --> 00:50:20,069
and that's a different problem that we

1413
00:50:20,069 --> 00:50:21,720
have a solve with with the future

1414
00:50:21,720 --> 00:50:24,269
project and working on but yes enhance

1415
00:50:24,269 --> 00:50:26,760
logging please take a look at these now

1416
00:50:26,760 --> 00:50:28,529
we're discovery I can't speak enough

1417
00:50:28,529 --> 00:50:30,480
about how well it worked again simple

1418
00:50:30,480 --> 00:50:32,789
you have a suspect system so go get a

1419
00:50:32,789 --> 00:50:35,039
good system hash the hell out of it and

1420
00:50:35,039 --> 00:50:37,410
run shaw one deep login d will also have

1421
00:50:37,410 --> 00:50:39,329
this functionality to replace Sean D and

1422
00:50:39,329 --> 00:50:41,279
I basically allow you to compare a

1423
00:50:41,279 --> 00:50:43,140
suspect box to a good box get a short

1424
00:50:43,140 --> 00:50:45,480
list of hashes to look for and help you

1425
00:50:45,480 --> 00:50:48,569
find the bed the bad stuff before before

1426
00:50:48,569 --> 00:50:51,150
they get too far then how many people

1427
00:50:51,150 --> 00:50:54,210
here have a log management solution yeah

1428
00:50:54,210 --> 00:50:55,710
so well you don't have a log management

1429
00:50:55,710 --> 00:50:58,769
solution so real quick that innovation

1430
00:50:58,769 --> 00:51:01,680
was to co my my colleague up introducing

1431
00:51:01,680 --> 00:51:03,839
new omd this is a tool that we wrote as

1432
00:51:03,839 --> 00:51:05,549
an outcome of dealing with this kind of

1433
00:51:05,549 --> 00:51:07,190
crap i needed a command-line utility

1434
00:51:07,190 --> 00:51:09,359
because there were cases where I don't

1435
00:51:09,359 --> 00:51:12,269
have log management I do some dir on the

1436
00:51:12,269 --> 00:51:14,759
side and I wanted to speed up my lab

1437
00:51:14,759 --> 00:51:18,000
analysis so with this we wrote a tool

1438
00:51:18,000 --> 00:51:21,210
and it's called log md it's at log md

1439
00:51:21,210 --> 00:51:22,559
com there's also a link to my website

1440
00:51:22,559 --> 00:51:24,990
now archaeology calm it's free please

1441
00:51:24,990 --> 00:51:28,079
download dumps a report to yeah we

1442
00:51:28,079 --> 00:51:29,880
believe in and the community needs some

1443
00:51:29,880 --> 00:51:31,799
of this basic health we're Richard

1444
00:51:31,799 --> 00:51:33,240
developing up with some other stuff that

1445
00:51:33,240 --> 00:51:34,650
may be a small cost of the item because

1446
00:51:34,650 --> 00:51:36,809
of a development required but it is

1447
00:51:36,809 --> 00:51:39,269
based on enforcing you to run and use

1448
00:51:39,269 --> 00:51:40,980
the windows login cheat sheet when you

1449
00:51:40,980 --> 00:51:42,210
run this the first time in a box that's

1450
00:51:42,210 --> 00:51:43,829
not properly configured what I say is

1451
00:51:43,829 --> 00:51:45,630
properly configured for that or the

1452
00:51:45,630 --> 00:51:47,490
windows login cheat sheet it will fail

1453
00:51:47,490 --> 00:51:49,950
and it will not run until you properly

1454
00:51:49,950 --> 00:51:51,450
configure the box I'm not going to

1455
00:51:51,450 --> 00:51:52,559
collect something that's going to be

1456
00:51:52,559 --> 00:51:54,089
garbage and windows by default clicks

1457
00:51:54,089 --> 00:51:57,359
nothing that's of any value so once it's

1458
00:51:57,359 --> 00:51:58,680
probably configured boom you get a

1459
00:51:58,680 --> 00:52:00,450
spreadsheet when it does fail you get a

1460
00:52:00,450 --> 00:52:02,279
nice audit report of all the settings

1461
00:52:02,279 --> 00:52:03,779
with their currently set to against your

1462
00:52:03,779 --> 00:52:05,309
machine comparing to the windows login

1463
00:52:05,309 --> 00:52:06,720
cheat sheet and also comparing to the

1464
00:52:06,720 --> 00:52:08,339
Center for Internet Security and tells

1465
00:52:08,339 --> 00:52:10,049
you all the reg keys to tweak and the

1466
00:52:10,049 --> 00:52:12,450
profile for a powershell and the very

1467
00:52:12,450 --> 00:52:15,300
you have to set the idea here is someone

1468
00:52:15,300 --> 00:52:17,310
says I have an ironing I our report

1469
00:52:17,310 --> 00:52:18,630
going on right now can you help us out

1470
00:52:18,630 --> 00:52:20,700
well you have logging you have this you

1471
00:52:20,700 --> 00:52:22,859
have this I don't know no I can send you

1472
00:52:22,859 --> 00:52:24,750
this executable get your guys to get it

1473
00:52:24,750 --> 00:52:26,490
running send me the results back and

1474
00:52:26,490 --> 00:52:28,410
then I can bid on you and depending on

1475
00:52:28,410 --> 00:52:29,910
one you take will depend on how much I

1476
00:52:29,910 --> 00:52:31,710
charge you if you should be able to do

1477
00:52:31,710 --> 00:52:33,420
this in an hour if you take two or three

1478
00:52:33,420 --> 00:52:35,040
days just to get these settings turned

1479
00:52:35,040 --> 00:52:36,750
on yeah my price for you just went up

1480
00:52:36,750 --> 00:52:37,800
which means it can be really hard to

1481
00:52:37,800 --> 00:52:40,290
work with your people so it's really

1482
00:52:40,290 --> 00:52:41,430
good for that kind of thing that's how I

1483
00:52:41,430 --> 00:52:47,369
use it it's a great customer cloth it

1484
00:52:47,369 --> 00:52:48,990
will help you assist in tweaking file

1485
00:52:48,990 --> 00:52:51,210
and registry auditing as well so as you

1486
00:52:51,210 --> 00:52:52,470
turn this on one of the things we

1487
00:52:52,470 --> 00:52:54,420
collect is what you're capturing in the

1488
00:52:54,420 --> 00:52:56,250
logs for file audit registering so

1489
00:52:56,250 --> 00:52:59,339
example I go and turn on auditing in the

1490
00:52:59,339 --> 00:53:01,920
services key and I let it do all subkeys

1491
00:53:01,920 --> 00:53:04,890
the tcp/ip key is very noisy a couple

1492
00:53:04,890 --> 00:53:06,750
others are also noisy that's too much

1493
00:53:06,750 --> 00:53:08,550
data it's not ever going to help me so

1494
00:53:08,550 --> 00:53:09,960
I'll go turn off auditing in that

1495
00:53:09,960 --> 00:53:11,849
location so now the amount of data and

1496
00:53:11,849 --> 00:53:13,800
putting into my logs just shrink and the

1497
00:53:13,800 --> 00:53:15,000
stuff that's in there is more actionable

1498
00:53:15,000 --> 00:53:16,980
for me and it will help you do that too

1499
00:53:16,980 --> 00:53:18,750
also with file auditing oh I turn this

1500
00:53:18,750 --> 00:53:21,300
directory on way too much data I'm going

1501
00:53:21,300 --> 00:53:22,380
to go turn it off here here and here

1502
00:53:22,380 --> 00:53:25,230
that looks good because you can't audit

1503
00:53:25,230 --> 00:53:27,000
everywhere file and registry just can't

1504
00:53:27,000 --> 00:53:28,560
you have to be selective how selective

1505
00:53:28,560 --> 00:53:36,869
using our management to guide you you

1506
00:53:36,869 --> 00:53:38,849
look at a different way for that one but

1507
00:53:38,849 --> 00:53:41,750
maybe no you really couldn't but yeah

1508
00:53:41,750 --> 00:53:44,849
again large ridge key that I do

1509
00:53:44,849 --> 00:53:47,310
everywhere so yeah we have multiple ways

1510
00:53:47,310 --> 00:53:50,010
of looking at this problem and then once

1511
00:53:50,010 --> 00:53:51,839
the system is configured you clear the

1512
00:53:51,839 --> 00:53:53,579
logs you infect the system you run login

1513
00:53:53,579 --> 00:53:55,410
D and then you view the report so expel

1514
00:53:55,410 --> 00:53:57,660
Excel spreadsheet yes I'd understand use

1515
00:53:57,660 --> 00:53:59,670
the filtering it's awesome but again we

1516
00:53:59,670 --> 00:54:01,770
just started this project in May and it

1517
00:54:01,770 --> 00:54:03,630
is free and release now that's pretty

1518
00:54:03,630 --> 00:54:05,040
fast and it works pretty well as I

1519
00:54:05,040 --> 00:54:06,750
showed some people yesterday anybody in

1520
00:54:06,750 --> 00:54:09,540
here play with it yesterday would you at

1521
00:54:09,540 --> 00:54:10,920
least look at it and saw what I did with

1522
00:54:10,920 --> 00:54:14,609
it shout out what you thought and then

1523
00:54:14,609 --> 00:54:16,920
again the audit report for you auditors

1524
00:54:16,920 --> 00:54:18,359
or somebody says well I don't know what

1525
00:54:18,359 --> 00:54:20,310
I'm set to but I just want to see run it

1526
00:54:20,310 --> 00:54:21,690
get the report out of it add it to your

1527
00:54:21,690 --> 00:54:24,150
assessment report or if you're a

1528
00:54:24,150 --> 00:54:25,859
consultant use it to say hey I want you

1529
00:54:25,859 --> 00:54:26,170
to

1530
00:54:26,170 --> 00:54:27,790
of your logging and here's how I did

1531
00:54:27,790 --> 00:54:28,810
contribute the Center for Internet

1532
00:54:28,810 --> 00:54:30,580
Security benchmarks years ago I was H at

1533
00:54:30,580 --> 00:54:32,260
HP so that's why I know some of the

1534
00:54:32,260 --> 00:54:36,430
shortcomings of that 33 whitelist so I

1535
00:54:36,430 --> 00:54:38,170
run this thing I got all this broadcast

1536
00:54:38,170 --> 00:54:39,970
traffic I got all this normal printer

1537
00:54:39,970 --> 00:54:42,400
traffic for example great we give you a

1538
00:54:42,400 --> 00:54:44,620
whitelist to get rid of the IPS that you

1539
00:54:44,620 --> 00:54:46,060
don't want source destination

1540
00:54:46,060 --> 00:54:48,130
destination port so you put that in

1541
00:54:48,130 --> 00:54:49,450
there in any combination and it will

1542
00:54:49,450 --> 00:54:51,640
filter the results it does not just drop

1543
00:54:51,640 --> 00:54:53,200
them it puts them in a white listed

1544
00:54:53,200 --> 00:54:54,760
report so you're not losing any data

1545
00:54:54,760 --> 00:54:55,930
you're just moving it out of the main

1546
00:54:55,930 --> 00:54:57,940
report into a secondary report we also

1547
00:54:57,940 --> 00:54:59,980
do it by process command line this

1548
00:54:59,980 --> 00:55:01,750
command line convos blah blah blah I

1549
00:55:01,750 --> 00:55:02,890
never want to see that it's never a

1550
00:55:02,890 --> 00:55:05,230
value whitelisted this particular cam

1551
00:55:05,230 --> 00:55:06,760
man running the search indexer never

1552
00:55:06,760 --> 00:55:08,500
want to see it white listed so you start

1553
00:55:08,500 --> 00:55:09,880
chopping away at traffic by using the

1554
00:55:09,880 --> 00:55:12,940
whitelist in a lab my run of log md in

1555
00:55:12,940 --> 00:55:15,880
my my lab box is almost blank because I

1556
00:55:15,880 --> 00:55:17,260
white listed all the normal stuff that

1557
00:55:17,260 --> 00:55:19,000
happens in my lab so when I affect the

1558
00:55:19,000 --> 00:55:20,380
box i'm pretty much seeing all the

1559
00:55:20,380 --> 00:55:21,880
interactions the box is doing within

1560
00:55:21,880 --> 00:55:25,270
that malware and then again process name

1561
00:55:25,270 --> 00:55:30,190
don't do that overly random make sure

1562
00:55:30,190 --> 00:55:31,600
that if you're executing if you're

1563
00:55:31,600 --> 00:55:33,970
excluding my process name make sure

1564
00:55:33,970 --> 00:55:35,590
you'll never see anything in the command

1565
00:55:35,590 --> 00:55:38,080
line that's a value to you because if

1566
00:55:38,080 --> 00:55:39,490
there is at some point in the future

1567
00:55:39,490 --> 00:55:40,720
like you would want to get rid of

1568
00:55:40,720 --> 00:55:42,340
sysprep because all those disparate

1569
00:55:42,340 --> 00:55:44,290
command lines would be of high value so

1570
00:55:44,290 --> 00:55:45,790
be careful when you do it by that do it

1571
00:55:45,790 --> 00:55:48,100
by command line first only if processed

1572
00:55:48,100 --> 00:55:51,310
name by like I exclude process name log

1573
00:55:51,310 --> 00:55:53,830
md only do it when you know there's

1574
00:55:53,830 --> 00:55:56,100
never going to be value file auditing

1575
00:55:56,100 --> 00:55:58,600
whitelisting as well so that way as I'm

1576
00:55:58,600 --> 00:55:59,770
looking for those reg keys and I'm

1577
00:55:59,770 --> 00:56:01,000
trying to get rid of some of that noise

1578
00:56:01,000 --> 00:56:02,500
i'm turning on auditing and kind of

1579
00:56:02,500 --> 00:56:04,540
doing it quickly in an ir scenario i can

1580
00:56:04,540 --> 00:56:05,920
white let's those out of my results and

1581
00:56:05,920 --> 00:56:07,450
then it that that white list becomes

1582
00:56:07,450 --> 00:56:10,120
what I use to refine splunk and

1583
00:56:10,120 --> 00:56:11,860
blacklist the stuff I don't want to go

1584
00:56:11,860 --> 00:56:13,360
to splunk that's noisy but i do want to

1585
00:56:13,360 --> 00:56:15,700
collect stuff like that and then the

1586
00:56:15,700 --> 00:56:18,640
report itself so here's a typical crypto

1587
00:56:18,640 --> 00:56:20,020
event someone brought a laptop in and

1588
00:56:20,020 --> 00:56:21,790
said hey I'm cryptid so here it is in

1589
00:56:21,790 --> 00:56:24,790
yellow not something I Iran it's a box

1590
00:56:24,790 --> 00:56:26,500
that was given to me there's the

1591
00:56:26,500 --> 00:56:28,570
execution of the cryptolocker stuff it

1592
00:56:28,570 --> 00:56:30,700
immediately copied to a different file

1593
00:56:30,700 --> 00:56:32,890
name it went through the deletions spit

1594
00:56:32,890 --> 00:56:34,480
that data out to null same file name

1595
00:56:34,480 --> 00:56:36,490
here same folly same here so it's saying

1596
00:56:36,490 --> 00:56:37,840
delete me but don't tell anything about

1597
00:56:37,840 --> 00:56:39,550
it and then of course

1598
00:56:39,550 --> 00:56:41,410
after the cryptolocker it executes savvy

1599
00:56:41,410 --> 00:56:43,810
SS admin delete all volume shadow copies

1600
00:56:43,810 --> 00:56:45,850
so you now you now know restore is the

1601
00:56:45,850 --> 00:56:47,980
rebuild is the only option here there is

1602
00:56:47,980 --> 00:56:50,260
no volume shadow copy option to restore

1603
00:56:50,260 --> 00:56:52,300
from and so that fast I know what to do

1604
00:56:52,300 --> 00:56:54,850
the box boom done and that's pretty much

1605
00:56:54,850 --> 00:56:57,040
you can see that the lines 40 through 72

1606
00:56:57,040 --> 00:56:58,860
there's not a whole lot of data in this

1607
00:56:58,860 --> 00:57:00,790
so it works pretty well for that kind of

1608
00:57:00,790 --> 00:57:02,770
thing to investigate so here's a word

1609
00:57:02,770 --> 00:57:06,010
doc I exploded into lab there's the word

1610
00:57:06,010 --> 00:57:08,170
doc being executed here's the batch file

1611
00:57:08,170 --> 00:57:09,910
that dropped out of the word doc this is

1612
00:57:09,910 --> 00:57:11,830
the thing that the guy had yesterday his

1613
00:57:11,830 --> 00:57:13,930
was 10 dot exe and this one's 9 eggsy

1614
00:57:13,930 --> 00:57:16,060
it's pinging china because it wants to

1615
00:57:16,060 --> 00:57:18,160
make sure it can communicate or it will

1616
00:57:18,160 --> 00:57:20,260
kill so i've tested that and it kills if

1617
00:57:20,260 --> 00:57:22,180
it does not complete this and then

1618
00:57:22,180 --> 00:57:24,010
there's the nine dot exe executing all

1619
00:57:24,010 --> 00:57:25,720
over the place there's the ping once

1620
00:57:25,720 --> 00:57:28,570
it's a done only once to see the episode

1621
00:57:28,570 --> 00:57:30,280
still communicate still can't

1622
00:57:30,280 --> 00:57:33,490
communicate and then BOOM I move over in

1623
00:57:33,490 --> 00:57:35,530
the spreadsheet and I now can associate

1624
00:57:35,530 --> 00:57:37,870
through the windows firewall login 5156

1625
00:57:37,870 --> 00:57:39,760
I can see the cool thing about windows

1626
00:57:39,760 --> 00:57:41,260
firewall logs it tells you the process

1627
00:57:41,260 --> 00:57:44,740
and the IP port and protocol it uses so

1628
00:57:44,740 --> 00:57:46,690
here's windward talking to an IP this

1629
00:57:46,690 --> 00:57:49,360
particular IP is a dream host server I'm

1630
00:57:49,360 --> 00:57:51,460
sorry but word much like PowerShell

1631
00:57:51,460 --> 00:57:53,470
should never talk to any IP ever

1632
00:57:53,470 --> 00:57:56,080
externally windward should never talk to

1633
00:57:56,080 --> 00:57:58,300
anything but Microsoft so immediately

1634
00:57:58,300 --> 00:58:00,460
that got added to our iPad IP list and

1635
00:58:00,460 --> 00:58:02,800
then see script Ram we have some more

1636
00:58:02,800 --> 00:58:04,720
IPS and then there's the ping running

1637
00:58:04,720 --> 00:58:06,910
and then there's the nine and sysprep

1638
00:58:06,910 --> 00:58:09,010
running and so I'm harvesting these IPS

1639
00:58:09,010 --> 00:58:10,630
checking in with who is so that I can

1640
00:58:10,630 --> 00:58:12,310
see what company and network they belong

1641
00:58:12,310 --> 00:58:14,560
to I add them to my black litter into my

1642
00:58:14,560 --> 00:58:17,020
bad IP list and splunk I run it anybody

1643
00:58:17,020 --> 00:58:19,150
who visited those IPS is now infected I

1644
00:58:19,150 --> 00:58:20,770
can immediately remediation that

1645
00:58:20,770 --> 00:58:23,820
information and this took me 15 minutes

1646
00:58:23,820 --> 00:58:26,620
 I did that whole whopping 15

1647
00:58:26,620 --> 00:58:29,680
minutes so it's it speeds up that kind

1648
00:58:29,680 --> 00:58:31,570
of process for me again it would take a

1649
00:58:31,570 --> 00:58:32,680
little longer for the advanced stuff

1650
00:58:32,680 --> 00:58:33,760
because i have to pick it up from here

1651
00:58:33,760 --> 00:58:34,840
and collect it from there and put it

1652
00:58:34,840 --> 00:58:37,030
here reassemble reboot and all that but

1653
00:58:37,030 --> 00:58:38,560
this helps a lot this is really shocking

1654
00:58:38,560 --> 00:58:40,630
how well this worked for me so that's

1655
00:58:40,630 --> 00:58:41,980
why we're sharing it it's kind of one of

1656
00:58:41,980 --> 00:58:44,230
those hey this thing actually works but

1657
00:58:44,230 --> 00:58:46,420
yeah really really well so in summary

1658
00:58:46,420 --> 00:58:50,080
Mauer is noisy we can detect it logs

1659
00:58:50,080 --> 00:58:51,790
hold all kinds of information if you

1660
00:58:51,790 --> 00:58:53,019
just go out and enable

1661
00:58:53,019 --> 00:58:54,699
and configure them and the windows

1662
00:58:54,699 --> 00:58:56,649
logging cheat sheet there it is what it

1663
00:58:56,649 --> 00:58:58,899
looks like six pages of gold talks about

1664
00:58:58,899 --> 00:59:00,339
how to enable configure gather and

1665
00:59:00,339 --> 00:59:01,869
harvest and able and configure

1666
00:59:01,869 --> 00:59:03,789
self-explanatory gathering is what you

1667
00:59:03,789 --> 00:59:04,929
can do it like command line with

1668
00:59:04,929 --> 00:59:06,939
powershell or w event util command line

1669
00:59:06,939 --> 00:59:09,069
utility and harvesting is talking about

1670
00:59:09,069 --> 00:59:10,779
how to put it in a log management and

1671
00:59:10,779 --> 00:59:12,999
regardless sections and so please go do

1672
00:59:12,999 --> 00:59:15,399
that as well as get the windows lung

1673
00:59:15,399 --> 00:59:16,509
clogging cheat sheet to help you out

1674
00:59:16,509 --> 00:59:18,729
your smudge get you started if you're

1675
00:59:18,729 --> 00:59:20,259
not doing those kind of security alerts

1676
00:59:20,259 --> 00:59:22,799
and with that here's some resources

1677
00:59:22,799 --> 00:59:25,419
Maori archaeology calm also has a tab to

1678
00:59:25,419 --> 00:59:28,029
log in d log dash md calm will be a new

1679
00:59:28,029 --> 00:59:29,589
website next year since this thing works

1680
00:59:29,589 --> 00:59:30,909
well we're actually going to split it

1681
00:59:30,909 --> 00:59:33,369
off and here's we get the stuff pretty

1682
00:59:33,369 --> 00:59:35,169
simple you google this pretty much

1683
00:59:35,169 --> 00:59:36,219
Google will help you autofill

1684
00:59:36,219 --> 00:59:37,539
archaeology because you can't spell it

1685
00:59:37,539 --> 00:59:39,759
and you'll be able to find me real easy

1686
00:59:39,759 --> 00:59:42,069
actually also on SlideShare you can find

1687
00:59:42,069 --> 00:59:43,689
me through that as well with malware

1688
00:59:43,689 --> 00:59:46,269
archaeology calm and let that I'll take

1689
00:59:46,269 --> 00:59:48,159
any questions and Sam will throw Ding

1690
00:59:48,159 --> 00:59:56,380
Dongs questions got one right here we

1691
00:59:56,380 --> 00:59:59,079
did within our environment yeah we could

1692
00:59:59,079 --> 01:00:01,269
they set up a box and it was talking to

1693
01:00:01,269 --> 01:00:03,130
that box it was how they communicated

1694
01:00:03,130 --> 01:00:05,229
with it and so we used a minute yeah we

1695
01:00:05,229 --> 01:00:07,329
were able to get in saying haha boom we

1696
01:00:07,329 --> 01:00:16,479
focused on that box ding dong yes so

1697
01:00:16,479 --> 01:00:18,039
before log md how was I pulling this

1698
01:00:18,039 --> 01:00:20,049
host large in the environment in gaming

1699
01:00:20,049 --> 01:00:22,269
I had splunk unfortunately sometimes we

1700
01:00:22,269 --> 01:00:24,159
had to go to the box remote or I would

1701
01:00:24,159 --> 01:00:26,139
execute bigfix scripts just basically

1702
01:00:26,139 --> 01:00:27,779
scripts that would collect information

1703
01:00:27,779 --> 01:00:30,459
specifically I was looking for with some

1704
01:00:30,459 --> 01:00:31,659
of the tools that I have they talked

1705
01:00:31,659 --> 01:00:33,909
about my malware discovery class before

1706
01:00:33,909 --> 01:00:35,679
that very manual so I've got like a

1707
01:00:35,679 --> 01:00:38,169
script that I run around reg scanner and

1708
01:00:38,169 --> 01:00:40,029
a GUI pops up those look for big key so

1709
01:00:40,029 --> 01:00:41,549
we ran that across the environment

1710
01:00:41,549 --> 01:00:44,019
redshaw to capture the shot and try to

1711
01:00:44,019 --> 01:00:46,329
compare that to others a very manual

1712
01:00:46,329 --> 01:00:48,099
process of just executing a lot of sis

1713
01:00:48,099 --> 01:00:50,739
internal tools so log in DS I'm trying

1714
01:00:50,739 --> 01:00:51,789
to write that to replace some of these

1715
01:00:51,789 --> 01:00:54,009
more clunky mechanisms so in theory you

1716
01:00:54,009 --> 01:00:56,439
could use s sem or or whatever agent or

1717
01:00:56,439 --> 01:00:58,779
a net used PS exec or however you want

1718
01:00:58,779 --> 01:01:00,429
to execute this executable throw it on a

1719
01:01:00,429 --> 01:01:02,259
bunch of boxes are suspect run it take

1720
01:01:02,259 --> 01:01:04,010
the output collect it and then

1721
01:01:04,010 --> 01:01:05,840
you get rid of a lot of steps that we're

1722
01:01:05,840 --> 01:01:07,520
doing very manually this is kind of a

1723
01:01:07,520 --> 01:01:10,010
manual ARR people do it Mannion people

1724
01:01:10,010 --> 01:01:11,270
would use mirror and a lot of these

1725
01:01:11,270 --> 01:01:13,520
tools that I'm using but a lot of our

1726
01:01:13,520 --> 01:01:15,130
guys kind of do it this way is very

1727
01:01:15,130 --> 01:01:18,110
unfortunately manual unless you have

1728
01:01:18,110 --> 01:01:20,960
something you know big and fancy yes any

1729
01:01:20,960 --> 01:01:26,740
other questions and then going

1730
01:01:31,210 --> 01:01:33,530
do I run into Mauer to try to disable

1731
01:01:33,530 --> 01:01:36,200
logging good question surprisingly the

1732
01:01:36,200 --> 01:01:38,240
only dumb things the Chinese did in 2012

1733
01:01:38,240 --> 01:01:40,250
was somewhat clear the logs it's clear

1734
01:01:40,250 --> 01:01:41,780
they had a noob running along with a

1735
01:01:41,780 --> 01:01:43,760
expert a lot of mistakes on these

1736
01:01:43,760 --> 01:01:46,340
systems no mistakes on these systems if

1737
01:01:46,340 --> 01:01:47,840
you're using log management the stuff

1738
01:01:47,840 --> 01:01:49,609
gets sent to a log server they can they

1739
01:01:49,609 --> 01:01:50,960
can muck up the local logs all you want

1740
01:01:50,960 --> 01:01:53,420
if they turn something off we get alerts

1741
01:01:53,420 --> 01:01:55,100
for that so if you start messing with

1742
01:01:55,100 --> 01:01:57,500
turning things off we get alerts so that

1743
01:01:57,500 --> 01:01:58,760
we have to look at the condition being

1744
01:01:58,760 --> 01:02:01,340
normal have they are do they are have

1745
01:02:01,340 --> 01:02:03,980
some things hung or whether it was them

1746
01:02:03,980 --> 01:02:06,320
or not happen normally absolutely and

1747
01:02:06,320 --> 01:02:08,150
but we have a Splunk running correctly

1748
01:02:08,150 --> 01:02:10,640
is big fix running we use each product

1749
01:02:10,640 --> 01:02:12,320
to look at each other product and so we

1750
01:02:12,320 --> 01:02:14,119
have this cross thing saying if splunk

1751
01:02:14,119 --> 01:02:15,740
running in big fix is big fix running

1752
01:02:15,740 --> 01:02:17,270
and splunk and we kind of keep that

1753
01:02:17,270 --> 01:02:20,210
stuff up and up to date so yes I really

1754
01:02:20,210 --> 01:02:21,650
not because I don't think they want to

1755
01:02:21,650 --> 01:02:23,270
trigger the there Carlos always says I

1756
01:02:23,270 --> 01:02:25,250
got you to click on the email and now I

1757
01:02:25,250 --> 01:02:26,630
got to gather as much information as I

1758
01:02:26,630 --> 01:02:28,520
can figure out how you're doing it and

1759
01:02:28,520 --> 01:02:30,109
by the way his recommendation in his

1760
01:02:30,109 --> 01:02:31,910
present during Khan was referencing the

1761
01:02:31,910 --> 01:02:33,320
windows logging cheat sheet he said if

1762
01:02:33,320 --> 01:02:34,700
you want to catch me you need to do

1763
01:02:34,700 --> 01:02:37,820
stuff like this if they go after that if

1764
01:02:37,820 --> 01:02:39,740
Carlos let's say in a pen test starts

1765
01:02:39,740 --> 01:02:41,450
going after that yeah you got to look

1766
01:02:41,450 --> 01:02:43,220
for the conditions of clearing logs of

1767
01:02:43,220 --> 01:02:44,540
stopping a services and I do

1768
01:02:44,540 --> 01:02:46,100
automatically monitor that you saw the

1769
01:02:46,100 --> 01:02:48,920
70 45 and 70 40 in there of new and

1770
01:02:48,920 --> 01:02:51,700
stuff so good question

1771
01:02:52,530 --> 01:02:57,300
I wish it was that easy they don't seem

1772
01:02:57,300 --> 01:02:59,430
to do that and normally when you see the

1773
01:02:59,430 --> 01:03:01,440
behavior of them getting to that box so

1774
01:03:01,440 --> 01:03:03,210
if you can't you just rootkit the box

1775
01:03:03,210 --> 01:03:05,010
sure you can but how do I get to the box

1776
01:03:05,010 --> 01:03:06,780
without making any noise in any way

1777
01:03:06,780 --> 01:03:08,790
putting something on the bars getting it

1778
01:03:08,790 --> 01:03:10,320
executed without doing any of this stuff

1779
01:03:10,320 --> 01:03:11,700
that you saw me collecting in the logs

1780
01:03:11,700 --> 01:03:17,550
it's it's really difficult you windows

1781
01:03:17,550 --> 01:03:18,450
does a pretty good job of collecting

1782
01:03:18,450 --> 01:03:20,310
stuff I mean really there weren't any

1783
01:03:20,310 --> 01:03:22,680
gapping holes and all that apt we saw

1784
01:03:22,680 --> 01:03:24,450
I've just never run into it where Wow

1785
01:03:24,450 --> 01:03:26,100
we're missing a lot of data tripwire

1786
01:03:26,100 --> 01:03:28,920
missing tons of data but logging built

1787
01:03:28,920 --> 01:03:32,970
in logging not so much i love tripwire

1788
01:03:32,970 --> 01:03:34,170
by the way it's just you have to

1789
01:03:34,170 --> 01:03:36,210
understand its use really like any

1790
01:03:36,210 --> 01:03:39,050
security tool yes

1791
01:03:48,670 --> 01:03:51,730
ah so after they infect the box it phone

1792
01:03:51,730 --> 01:03:53,710
homes it turns out these guys these

1793
01:03:53,710 --> 01:03:54,940
actors that's really good question I

1794
01:03:54,940 --> 01:03:57,069
didn't mention that in the talk when

1795
01:03:57,069 --> 01:03:58,450
they infect a box it doesn't necessarily

1796
01:03:58,450 --> 01:04:01,089
phone home they are heavy users of timer

1797
01:04:01,089 --> 01:04:03,849
the timer API to where they will infect

1798
01:04:03,849 --> 01:04:06,339
an environment and wait until we're gone

1799
01:04:06,339 --> 01:04:07,599
in the day and sometimes these things

1800
01:04:07,599 --> 01:04:09,940
wake up at seven o'clock at night so

1801
01:04:09,940 --> 01:04:11,770
once we understand the IPS we can watch

1802
01:04:11,770 --> 01:04:13,119
their behavior and they're very much

1803
01:04:13,119 --> 01:04:15,010
opposite us either you know the Russians

1804
01:04:15,010 --> 01:04:17,049
or the Ukrainians or the Chinese over

1805
01:04:17,049 --> 01:04:18,609
the pawns either direction they're

1806
01:04:18,609 --> 01:04:20,200
opposite us and they really do most

1807
01:04:20,200 --> 01:04:21,760
their work at night because they know

1808
01:04:21,760 --> 01:04:23,319
we're offline and so it's a better

1809
01:04:23,319 --> 01:04:24,609
chance of them getting further and

1810
01:04:24,609 --> 01:04:26,619
embedding themselves faster without us

1811
01:04:26,619 --> 01:04:28,450
watching them i would say eighty percent

1812
01:04:28,450 --> 01:04:31,210
of the work happened off hours and did

1813
01:04:31,210 --> 01:04:34,359
not phone home for at least hours days

1814
01:04:34,359 --> 01:04:37,089
or in some case 13 days they were really

1815
01:04:37,089 --> 01:04:38,349
good at just not making a lot of network

1816
01:04:38,349 --> 01:04:40,119
noise for that reason of us looking at

1817
01:04:40,119 --> 01:04:42,569
network traffic

1818
01:04:48,770 --> 01:04:51,350
yeah the the the logging that goes on in

1819
01:04:51,350 --> 01:04:53,360
the whole gaming platform environments

1820
01:04:53,360 --> 01:04:55,130
are very detailed they collect and

1821
01:04:55,130 --> 01:04:57,260
kajillion pieces of information they can

1822
01:04:57,260 --> 01:04:59,600
tell exactly when one who wear all that

1823
01:04:59,600 --> 01:05:01,340
stuff and they will restore accounts

1824
01:05:01,340 --> 01:05:10,820
very common yeah it's probably because

1825
01:05:10,820 --> 01:05:14,180
it came from his IP probably they know

1826
01:05:14,180 --> 01:05:15,830
that and if your IP is compromised it

1827
01:05:15,830 --> 01:05:17,300
has to come from another IP from another

1828
01:05:17,300 --> 01:05:19,130
country for them the gaming is really

1829
01:05:19,130 --> 01:05:25,340
good at that yeah yep any other

1830
01:05:25,340 --> 01:05:29,000
questions I'll be around talk to me and

1831
01:05:29,000 --> 01:05:31,630
got the big picture

