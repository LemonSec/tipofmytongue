1
00:00:00,559 --> 00:00:05,540
Oh welcome everybody today we're going

2
00:00:05,540 --> 00:00:06,410
to talk about you heard in the keynote

3
00:00:06,410 --> 00:00:08,780
he talked about lack of monitoring well

4
00:00:08,780 --> 00:00:10,219
we're gonna talk about an area that

5
00:00:10,219 --> 00:00:13,519
involves everybody cuz face it you can't

6
00:00:13,519 --> 00:00:16,039
surf the web if you don't do DNS I mean

7
00:00:16,039 --> 00:00:18,230
most people don't remember IP addresses

8
00:00:18,230 --> 00:00:21,230
specially with ipv6 now so we're gonna

9
00:00:21,230 --> 00:00:22,670
talk about how the tax have been

10
00:00:22,670 --> 00:00:24,050
evolving and becoming much more

11
00:00:24,050 --> 00:00:26,690
sophisticated if you will specifically

12
00:00:26,690 --> 00:00:29,150
targeting ways to use that vector of

13
00:00:29,150 --> 00:00:33,320
using DNS to get into your network so

14
00:00:33,320 --> 00:00:34,600
give you a little background on myself

15
00:00:34,600 --> 00:00:37,129
like Brian I've been doing this forever

16
00:00:37,129 --> 00:00:40,309
I've been in security since security

17
00:00:40,309 --> 00:00:41,870
wasn't the thing with the internet you

18
00:00:41,870 --> 00:00:44,179
know the internet wasn't there when I

19
00:00:44,179 --> 00:00:46,969
started been doing lots of things I've

20
00:00:46,969 --> 00:00:49,100
got patents on security I've got written

21
00:00:49,100 --> 00:00:51,260
cyber security books pretty much

22
00:00:51,260 --> 00:00:53,149
everything you can think of evolved from

23
00:00:53,149 --> 00:00:55,069
pen testing and now I'm actually doing

24
00:00:55,069 --> 00:00:56,629
malware research there's lots of

25
00:00:56,629 --> 00:00:58,879
different things but as I said the

26
00:00:58,879 --> 00:01:00,440
problem just keeps evolving keeps

27
00:01:00,440 --> 00:01:02,899
changing it's not going to go anyway any

28
00:01:02,899 --> 00:01:05,420
time soon keeps us all employed but I

29
00:01:05,420 --> 00:01:07,490
wish it would get a little bit better so

30
00:01:07,490 --> 00:01:09,320
we're gonna start a tag team our

31
00:01:09,320 --> 00:01:11,180
presentation today we're gonna cover the

32
00:01:11,180 --> 00:01:12,950
evolution of it somewhat Passover Evan

33
00:01:12,950 --> 00:01:14,270
LED and talked about what you know where

34
00:01:14,270 --> 00:01:16,039
he started what he does and then we'll

35
00:01:16,039 --> 00:01:19,430
get into some of the cool stuff yeah

36
00:01:19,430 --> 00:01:21,409
thank you besides both us so my name is

37
00:01:21,409 --> 00:01:22,189
Edmund brummagem

38
00:01:22,189 --> 00:01:23,899
I'm also a security researcher with

39
00:01:23,899 --> 00:01:26,030
Cisco talos so just a little bit about

40
00:01:26,030 --> 00:01:27,950
me I love malware that's that's what I

41
00:01:27,950 --> 00:01:30,409
do day in day out neck deep in malware

42
00:01:30,409 --> 00:01:32,119
figuring out how it works and how to

43
00:01:32,119 --> 00:01:34,119
make sure our customers are protected so

44
00:01:34,119 --> 00:01:36,680
I've been with Telus for about three and

45
00:01:36,680 --> 00:01:39,259
a half years prior to joining Telus I

46
00:01:39,259 --> 00:01:40,820
spent the prior decade doing digital

47
00:01:40,820 --> 00:01:43,189
forensics Incident Response I've held

48
00:01:43,189 --> 00:01:44,750
pretty much every role you can hold an

49
00:01:44,750 --> 00:01:46,700
is security operations team protecting

50
00:01:46,700 --> 00:01:48,320
critical infrastructure so nuclear

51
00:01:48,320 --> 00:01:50,119
energy power generation financial

52
00:01:50,119 --> 00:01:52,039
services high-tech for coming over to

53
00:01:52,039 --> 00:01:54,469
the research side also is a hobby I'm

54
00:01:54,469 --> 00:01:56,420
super into music that's that's kind of

55
00:01:56,420 --> 00:01:59,020
the thing that I like besides security

56
00:01:59,020 --> 00:02:01,310
so what are we gonna cover today so

57
00:02:01,310 --> 00:02:02,810
we're gonna start out with a kind of a

58
00:02:02,810 --> 00:02:05,479
crash course on the on the DNS protocol

59
00:02:05,479 --> 00:02:07,399
and and how the specification works

60
00:02:07,399 --> 00:02:08,720
we're not going to dissect like the RFC

61
00:02:08,720 --> 00:02:10,459
or anything super boring like that but

62
00:02:10,459 --> 00:02:11,260
we're

63
00:02:11,260 --> 00:02:12,580
we're gonna cover some topics that are

64
00:02:12,580 --> 00:02:14,319
relevant to how attackers are abusing

65
00:02:14,319 --> 00:02:16,480
this specific protocol to compromised

66
00:02:16,480 --> 00:02:19,000
organizations we're also going to talk a

67
00:02:19,000 --> 00:02:20,920
little bit about how you can detect this

68
00:02:20,920 --> 00:02:22,780
sort of malicious activity how you might

69
00:02:22,780 --> 00:02:24,040
be able to put security controls in

70
00:02:24,040 --> 00:02:25,629
place to help make sure that you know

71
00:02:25,629 --> 00:02:27,790
you're not compromised and if you are

72
00:02:27,790 --> 00:02:29,769
you're able to at least detect it just

73
00:02:29,769 --> 00:02:31,060
to show of hands how many people are

74
00:02:31,060 --> 00:02:33,760
actively monitoring the content of DNS

75
00:02:33,760 --> 00:02:35,739
queries and the Associated responses I

76
00:02:35,739 --> 00:02:37,660
mean now they're networked so it so a

77
00:02:37,660 --> 00:02:40,030
few yeah I talk to a lot of

78
00:02:40,030 --> 00:02:41,290
organizations I talk to a lot of

79
00:02:41,290 --> 00:02:42,489
security professionals and that that's

80
00:02:42,489 --> 00:02:44,019
kind of a weak spot right now everyone's

81
00:02:44,019 --> 00:02:46,480
good at you know monitoring HTTP HTTPS

82
00:02:46,480 --> 00:02:48,129
you know some of the more conventional

83
00:02:48,129 --> 00:02:51,250
protocols FTP SMTP but not a lot of

84
00:02:51,250 --> 00:02:53,140
people actually you are monitoring the

85
00:02:53,140 --> 00:02:55,620
content of the DNS traffic that's

86
00:02:55,620 --> 00:02:57,519
ingressing and egressing their network

87
00:02:57,519 --> 00:02:58,870
and then we're going to talk about ways

88
00:02:58,870 --> 00:03:00,160
that you can defend against this sort of

89
00:03:00,160 --> 00:03:03,280
abuse so let's start out with that crash

90
00:03:03,280 --> 00:03:05,680
course so DNS right I'm going to date

91
00:03:05,680 --> 00:03:07,239
myself a little bit I still remember

92
00:03:07,239 --> 00:03:08,560
landlines and when you didn't

93
00:03:08,560 --> 00:03:10,239
necessarily remember everyone's phone

94
00:03:10,239 --> 00:03:12,190
number you had to go into a big yellow

95
00:03:12,190 --> 00:03:13,750
book and like you remember their name

96
00:03:13,750 --> 00:03:15,609
and you have to go see what number you

97
00:03:15,609 --> 00:03:17,049
had to dial on the phone to like

98
00:03:17,049 --> 00:03:19,030
actually reach them so DNS is very

99
00:03:19,030 --> 00:03:21,940
similar right you enter a rememberable

100
00:03:21,940 --> 00:03:24,880
address into the the address bar in your

101
00:03:24,880 --> 00:03:27,280
browser and DNS is responsible for

102
00:03:27,280 --> 00:03:29,500
taking that and converting that into an

103
00:03:29,500 --> 00:03:31,299
IP address that you can then route to to

104
00:03:31,299 --> 00:03:33,010
access whatever content is hosted there

105
00:03:33,010 --> 00:03:34,989
so that's that's kind of how that works

106
00:03:34,989 --> 00:03:37,120
at a high level but when you really

107
00:03:37,120 --> 00:03:38,709
think about it there's a lot of moving

108
00:03:38,709 --> 00:03:40,569
parts in DNS that makes that name

109
00:03:40,569 --> 00:03:43,329
resolution possible so with a lot of the

110
00:03:43,329 --> 00:03:44,739
the attacks that that we're gonna cover

111
00:03:44,739 --> 00:03:46,959
today you know I talk to people and one

112
00:03:46,959 --> 00:03:48,130
of the things that I hear a lot is well

113
00:03:48,130 --> 00:03:50,079
we don't allow our endpoints inside of

114
00:03:50,079 --> 00:03:52,480
our network to communicate to DNS

115
00:03:52,480 --> 00:03:54,280
servers directly well that that's not

116
00:03:54,280 --> 00:03:55,750
necessarily a protection against a lot

117
00:03:55,750 --> 00:03:56,980
of the attacks that are making use of

118
00:03:56,980 --> 00:03:58,629
the DNS protocol because when you think

119
00:03:58,629 --> 00:04:00,220
about it if you've got an endpoint in

120
00:04:00,220 --> 00:04:02,049
your environment that is trying to reach

121
00:04:02,049 --> 00:04:04,720
you know server X Y Z domain X Y Z

122
00:04:04,720 --> 00:04:06,609
hostname X Y Z they're not reaching

123
00:04:06,609 --> 00:04:09,370
directly out to that name server they're

124
00:04:09,370 --> 00:04:11,919
typically going to request resolution

125
00:04:11,919 --> 00:04:13,780
from a server inside your network right

126
00:04:13,780 --> 00:04:15,819
your DNS servers and those DNS servers

127
00:04:15,819 --> 00:04:18,070
are going to go upstream to your ISPs

128
00:04:18,070 --> 00:04:20,019
DNS servers which are they gonna go

129
00:04:20,019 --> 00:04:22,270
upstream even more and they'll

130
00:04:22,270 --> 00:04:24,010
eventually reach the name server this

131
00:04:24,010 --> 00:04:24,440
respond

132
00:04:24,440 --> 00:04:25,880
for the namespace of the domain that

133
00:04:25,880 --> 00:04:27,800
you're trying to resolve so attackers

134
00:04:27,800 --> 00:04:29,570
are leveraging this because it doesn't

135
00:04:29,570 --> 00:04:31,610
require any sort of direct command and

136
00:04:31,610 --> 00:04:33,020
control or any sort of direct

137
00:04:33,020 --> 00:04:34,640
communications from the endpoint to the

138
00:04:34,640 --> 00:04:35,810
attacker control server

139
00:04:35,810 --> 00:04:37,640
they're basically hopping through

140
00:04:37,640 --> 00:04:39,650
legitimate infrastructure so if you're

141
00:04:39,650 --> 00:04:41,720
if you're relying on a firewall blocking

142
00:04:41,720 --> 00:04:44,960
you know UDP or TCP 53 not necessarily

143
00:04:44,960 --> 00:04:46,280
gonna help you in this case because

144
00:04:46,280 --> 00:04:47,450
they're just gonna leverage your

145
00:04:47,450 --> 00:04:49,370
legitimate internal DNS servers to

146
00:04:49,370 --> 00:04:53,390
facilitate that connectivity so we're

147
00:04:53,390 --> 00:04:54,260
gonna talk about a few ways that

148
00:04:54,260 --> 00:04:57,010
attackers are actively leveraging DNS to

149
00:04:57,010 --> 00:04:59,720
successfully compromise organizations a

150
00:04:59,720 --> 00:05:01,280
lot of organizations have gotten much

151
00:05:01,280 --> 00:05:03,200
more mature in recent years as far as

152
00:05:03,200 --> 00:05:07,520
detecting abuse of FTP HTTP SMTP but

153
00:05:07,520 --> 00:05:08,930
they're not necessarily looking at DNS

154
00:05:08,930 --> 00:05:10,940
in the right way so what we're seeing is

155
00:05:10,940 --> 00:05:12,380
adversaries are starting to tunnel

156
00:05:12,380 --> 00:05:15,490
malicious code through DNS txt records

157
00:05:15,490 --> 00:05:18,350
basically leverage dns for a command and

158
00:05:18,350 --> 00:05:21,080
control protocol to facilitate the

159
00:05:21,080 --> 00:05:22,700
execution of arbitrary commands on

160
00:05:22,700 --> 00:05:24,980
systems interact with shells things like

161
00:05:24,980 --> 00:05:27,170
that we're seeing that through TFC

162
00:05:27,170 --> 00:05:28,910
records a records we're actually seeing

163
00:05:28,910 --> 00:05:31,820
attackers start to abuse the inherent

164
00:05:31,820 --> 00:05:34,160
trust relationship within DNS itself in

165
00:05:34,160 --> 00:05:38,120
targeting the core and Internet protist

166
00:05:38,120 --> 00:05:39,110
ruk sure that's responsible for

167
00:05:39,110 --> 00:05:41,419
facilitating dns for the internet to

168
00:05:41,419 --> 00:05:45,020
continue to work so let's talk a little

169
00:05:45,020 --> 00:05:48,530
bit about DNS tunneling so most people

170
00:05:48,530 --> 00:05:49,760
are pretty familiar with protocol

171
00:05:49,760 --> 00:05:51,320
tunneling right if you use a VPN to

172
00:05:51,320 --> 00:05:53,390
connect to your organization's network

173
00:05:53,390 --> 00:05:55,400
you're using protocol tunneling all

174
00:05:55,400 --> 00:05:56,900
right you got a VPN tunnel and you're

175
00:05:56,900 --> 00:06:00,320
tunneling traffic HTTP HTTPS other

176
00:06:00,320 --> 00:06:02,450
traffic through that VPN tunnel so

177
00:06:02,450 --> 00:06:04,520
protocol tunneling is pretty common and

178
00:06:04,520 --> 00:06:08,030
it's possible using the DNS protocol as

179
00:06:08,030 --> 00:06:10,010
well you can tunnel other protocols

180
00:06:10,010 --> 00:06:11,870
typically custom design protocols

181
00:06:11,870 --> 00:06:15,830
leveraging DNS communications so a

182
00:06:15,830 --> 00:06:18,680
practical example of this is a DNS

183
00:06:18,680 --> 00:06:20,300
tunneling to bypass captive portals

184
00:06:20,300 --> 00:06:21,890
right so when you think about you know

185
00:06:21,890 --> 00:06:24,260
Wi-Fi free Wi-Fi in a coffee shop around

186
00:06:24,260 --> 00:06:27,350
an airplane or in other scenarios a lot

187
00:06:27,350 --> 00:06:28,700
of times when you connect to the

188
00:06:28,700 --> 00:06:30,350
wireless network and you're doing your

189
00:06:30,350 --> 00:06:32,120
thing you can actually load the website

190
00:06:32,120 --> 00:06:34,100
that allows you to put your PII in and

191
00:06:34,100 --> 00:06:35,450
you're in your your credit-card

192
00:06:35,450 --> 00:06:36,889
information to get

193
00:06:36,889 --> 00:06:40,400
free wife or to get Wi-Fi and if you try

194
00:06:40,400 --> 00:06:42,259
to browse to other websites typically

195
00:06:42,259 --> 00:06:43,370
they're not gonna work right it's gonna

196
00:06:43,370 --> 00:06:44,990
tell you know you don't have

197
00:06:44,990 --> 00:06:46,879
connectivity to the Internet but one of

198
00:06:46,879 --> 00:06:48,169
the things you'll notice that is that in

199
00:06:48,169 --> 00:06:49,999
a lot of configurations even in those

200
00:06:49,999 --> 00:06:53,330
scenarios DNS works just fine so there

201
00:06:53,330 --> 00:06:54,979
are applications like a couple of the

202
00:06:54,979 --> 00:06:56,479
examples on the screen where you can

203
00:06:56,479 --> 00:06:59,689
leverage DNS tunneling to facilitate

204
00:06:59,689 --> 00:07:00,949
connectivity to the internet without

205
00:07:00,949 --> 00:07:03,349
having to actually pay for it or enter

206
00:07:03,349 --> 00:07:04,340
your credentials or enter your

207
00:07:04,340 --> 00:07:06,289
information into the the captive portal

208
00:07:06,289 --> 00:07:08,150
because they're filtering HTTP they're

209
00:07:08,150 --> 00:07:10,009
filtering HTTP and filtering all these

210
00:07:10,009 --> 00:07:12,409
other protocols but DNS is not filtered

211
00:07:12,409 --> 00:07:14,090
and that's one of the one of the

212
00:07:14,090 --> 00:07:15,259
weaknesses and a lot of organizations

213
00:07:15,259 --> 00:07:17,270
security postures that attackers are

214
00:07:17,270 --> 00:07:20,870
actively leveraging so I want to talk a

215
00:07:20,870 --> 00:07:23,330
little bit about txt records so txt

216
00:07:23,330 --> 00:07:24,830
records are an interesting element

217
00:07:24,830 --> 00:07:26,779
within DNS right everyone's used to like

218
00:07:26,779 --> 00:07:28,819
a records cname records things like that

219
00:07:28,819 --> 00:07:31,039
deity HT records are pretty interesting

220
00:07:31,039 --> 00:07:33,139
because they're used really commonly

221
00:07:33,139 --> 00:07:36,050
nowadays when DNS first came about and

222
00:07:36,050 --> 00:07:38,089
when txt records were first a thing they

223
00:07:38,089 --> 00:07:39,349
were typically used to append

224
00:07:39,349 --> 00:07:42,259
information about different assets that

225
00:07:42,259 --> 00:07:43,610
an organization might be interested in

226
00:07:43,610 --> 00:07:45,650
so you'd have a DNS record and you put a

227
00:07:45,650 --> 00:07:47,479
txt record that says this is Jim server

228
00:07:47,479 --> 00:07:50,000
or this server is located in Dana's data

229
00:07:50,000 --> 00:07:53,240
center XYZ so it's effectively a record

230
00:07:53,240 --> 00:07:55,669
that contains text content that gives

231
00:07:55,669 --> 00:07:57,710
you information about an asset so

232
00:07:57,710 --> 00:07:59,659
nowadays they're used for a lot more

233
00:07:59,659 --> 00:08:01,250
than than just that sort of thing

234
00:08:01,250 --> 00:08:02,389
they're used for a lot of security

235
00:08:02,389 --> 00:08:04,399
relevant functions so when you think

236
00:08:04,399 --> 00:08:07,009
about a SPF a sender policy framework or

237
00:08:07,009 --> 00:08:07,729
DKIM

238
00:08:07,729 --> 00:08:09,740
or D mark these are all technologies

239
00:08:09,740 --> 00:08:12,229
designed to secure mail flow so you

240
00:08:12,229 --> 00:08:14,360
protect from phishing that may be

241
00:08:14,360 --> 00:08:15,860
targeting your brand things like that

242
00:08:15,860 --> 00:08:18,830
and so they're really regularly used

243
00:08:18,830 --> 00:08:20,210
they're very very common in a lot of

244
00:08:20,210 --> 00:08:22,250
organizations nowadays but they're also

245
00:08:22,250 --> 00:08:24,770
able to be used to facilitate the

246
00:08:24,770 --> 00:08:26,960
transfer of information from an external

247
00:08:26,960 --> 00:08:29,539
server to an internal asset all

248
00:08:29,539 --> 00:08:33,649
leveraging DNS so I want to talk about a

249
00:08:33,649 --> 00:08:35,539
DNS tunneling kind of case study and

250
00:08:35,539 --> 00:08:39,948
this came about back in I think 2017 and

251
00:08:39,948 --> 00:08:41,990
this was a malware family that we

252
00:08:41,990 --> 00:08:44,240
discovered that we refer to as DNS

253
00:08:44,240 --> 00:08:45,910
messenger it's pretty interesting

254
00:08:45,910 --> 00:08:48,769
example of how this sort of txt record

255
00:08:48,769 --> 00:08:49,820
is being leveraged to

256
00:08:49,820 --> 00:08:52,550
facilitate command and control so in

257
00:08:52,550 --> 00:08:54,380
this particular case it started with a

258
00:08:54,380 --> 00:08:56,720
tweet right so we had somebody tagged us

259
00:08:56,720 --> 00:08:58,100
on Twitter and they were likes well

260
00:08:58,100 --> 00:08:59,480
somebody doesn't really like Sourcefire

261
00:08:59,480 --> 00:09:01,550
much and they they pasted a snippet of

262
00:09:01,550 --> 00:09:04,040
PowerShell and inside the powershell was

263
00:09:04,040 --> 00:09:06,140
a base64 encoded blob you can see on the

264
00:09:06,140 --> 00:09:08,120
screen and when you decode that it's a

265
00:09:08,120 --> 00:09:10,070
source fire sucks well we kind of took

266
00:09:10,070 --> 00:09:11,570
note of that because if you're familiar

267
00:09:11,570 --> 00:09:13,580
with Cisco right a cisco acquired source

268
00:09:13,580 --> 00:09:16,370
fire so you know we saw that and we were

269
00:09:16,370 --> 00:09:17,420
kind of interested to see where exactly

270
00:09:17,420 --> 00:09:20,570
that was what was that relevant to so we

271
00:09:20,570 --> 00:09:21,560
started trying to figure out exactly

272
00:09:21,560 --> 00:09:23,900
what we could to figure out where in an

273
00:09:23,900 --> 00:09:25,850
infection chain this was all we had was

274
00:09:25,850 --> 00:09:27,800
the base64 encoded blob and the snippet

275
00:09:27,800 --> 00:09:29,060
of PowerShell we didn't have any other

276
00:09:29,060 --> 00:09:31,730
IO C's so a researcher and myself we

277
00:09:31,730 --> 00:09:33,380
basically started looking to see if we

278
00:09:33,380 --> 00:09:35,060
could reconstruct the the attack that

279
00:09:35,060 --> 00:09:37,850
was associated with this string and we

280
00:09:37,850 --> 00:09:39,860
were actually able to reconstruct this

281
00:09:39,860 --> 00:09:41,770
using a lot of open source intelligence

282
00:09:41,770 --> 00:09:45,080
and we were able to basically tie this

283
00:09:45,080 --> 00:09:47,120
back to the initial infection vector

284
00:09:47,120 --> 00:09:49,910
associated with DNS messenger and DNS

285
00:09:49,910 --> 00:09:51,860
messenger was actually being transmitted

286
00:09:51,860 --> 00:09:54,140
and distributed via email spam campaigns

287
00:09:54,140 --> 00:09:56,900
so they were sending targeted phishing

288
00:09:56,900 --> 00:09:58,700
emails that contain malicious office

289
00:09:58,700 --> 00:10:00,710
documents and an example of one is on

290
00:10:00,710 --> 00:10:02,150
the screen there you can see it's a

291
00:10:02,150 --> 00:10:03,770
malicious Word document one of the

292
00:10:03,770 --> 00:10:04,910
interesting things they did was they

293
00:10:04,910 --> 00:10:07,130
used McAfee branding inside of the the

294
00:10:07,130 --> 00:10:09,170
mal doc it's pretty similar to what you

295
00:10:09,170 --> 00:10:10,970
see a lot with with mal spam campaigns

296
00:10:10,970 --> 00:10:13,430
right they they put a decoy image in and

297
00:10:13,430 --> 00:10:14,930
they say hey enable macros enable

298
00:10:14,930 --> 00:10:16,520
content so that the attackers code can

299
00:10:16,520 --> 00:10:18,530
start to execute that can facilitate the

300
00:10:18,530 --> 00:10:20,720
the infection process for a lot of

301
00:10:20,720 --> 00:10:22,520
organizations McAfee bait may be really

302
00:10:22,520 --> 00:10:23,990
common right what if you use McAfee on

303
00:10:23,990 --> 00:10:25,760
your endpoints most of your users are

304
00:10:25,760 --> 00:10:27,260
going to be super comfortable seeing a

305
00:10:27,260 --> 00:10:30,800
McAfee logo and entrusting it so this

306
00:10:30,800 --> 00:10:32,480
was actually the the first stage of

307
00:10:32,480 --> 00:10:34,460
about a four stage infection process

308
00:10:34,460 --> 00:10:36,020
that was really interesting because it

309
00:10:36,020 --> 00:10:38,450
leveraged a lot of techniques that are

310
00:10:38,450 --> 00:10:39,920
commonly associated with fireless

311
00:10:39,920 --> 00:10:42,710
malware so the only way that this

312
00:10:42,710 --> 00:10:44,390
particular malware family would actually

313
00:10:44,390 --> 00:10:47,120
leave artifacts on a system was if they

314
00:10:47,120 --> 00:10:50,090
chose to achieve persistence during

315
00:10:50,090 --> 00:10:52,190
stage two so when you open the word

316
00:10:52,190 --> 00:10:54,410
document and you enable macros basically

317
00:10:54,410 --> 00:10:57,890
VBA macros kick off that extract in

318
00:10:57,890 --> 00:11:00,050
start to execute a stage 1 PowerShell

319
00:11:00,050 --> 00:11:01,710
routine that in

320
00:11:01,710 --> 00:11:03,870
that PowerShell routine contains stage 2

321
00:11:03,870 --> 00:11:06,000
that's encoded they decode that and then

322
00:11:06,000 --> 00:11:07,050
they do a check to see if they should

323
00:11:07,050 --> 00:11:08,790
enable persistence so should they

324
00:11:08,790 --> 00:11:10,470
persist across reboot so every time you

325
00:11:10,470 --> 00:11:12,360
reboot a system malware kicks back off

326
00:11:12,360 --> 00:11:14,760
and so if they chose to do that they

327
00:11:14,760 --> 00:11:17,940
would either write the contents of stage

328
00:11:17,940 --> 00:11:20,340
3 of this malware into the registry or

329
00:11:20,340 --> 00:11:22,140
they would write it to an alternate data

330
00:11:22,140 --> 00:11:24,150
stream so not your conventional file

331
00:11:24,150 --> 00:11:26,940
storage of malware payload they were

332
00:11:26,940 --> 00:11:29,220
using non-traditional ways to facilitate

333
00:11:29,220 --> 00:11:33,450
that persistence so persistence as I

334
00:11:33,450 --> 00:11:34,980
mentioned was acquired during stage 2

335
00:11:34,980 --> 00:11:36,660
and it was responsible for going out

336
00:11:36,660 --> 00:11:39,510
retrieving stage 3 and then if necessary

337
00:11:39,510 --> 00:11:42,000
if configured properly by the attacker

338
00:11:42,000 --> 00:11:44,910
would basically store stage 3 in a

339
00:11:44,910 --> 00:11:46,410
non-traditional way so that each time

340
00:11:46,410 --> 00:11:48,440
the system was rebooted the stage 3

341
00:11:48,440 --> 00:11:51,540
power shell itself would be extracted

342
00:11:51,540 --> 00:11:52,830
from the registry kicked off and then

343
00:11:52,830 --> 00:11:55,290
executed on the system so stage 3 was

344
00:11:55,290 --> 00:11:57,090
responsible for retrieving stage 4 and

345
00:11:57,090 --> 00:11:59,130
that's where DNS really came in so the

346
00:11:59,130 --> 00:12:01,020
equation here because stage 4 was

347
00:12:01,020 --> 00:12:03,930
delivered using the contents of DNS txt

348
00:12:03,930 --> 00:12:06,780
record responses so the let's look at

349
00:12:06,780 --> 00:12:09,720
how that works so effectively the way

350
00:12:09,720 --> 00:12:11,370
that this works is inside of that stage

351
00:12:11,370 --> 00:12:14,040
3 PowerShell they would basically look

352
00:12:14,040 --> 00:12:16,500
at an array list of domains that the

353
00:12:16,500 --> 00:12:18,150
attacker controlled the nameservers for

354
00:12:18,150 --> 00:12:19,650
and so they would pick one of these

355
00:12:19,650 --> 00:12:21,180
domains and they would go out and they

356
00:12:21,180 --> 00:12:23,430
would retrieve that would make a DNS txt

357
00:12:23,430 --> 00:12:25,320
record request and the response of that

358
00:12:25,320 --> 00:12:27,570
that record request as you can see in

359
00:12:27,570 --> 00:12:29,460
the bottom of the slide there I'm

360
00:12:29,460 --> 00:12:31,920
actually contained encoded PowerShell

361
00:12:31,920 --> 00:12:33,960
command so it was basically PowerShell

362
00:12:33,960 --> 00:12:36,240
that was encoded using base64 so the

363
00:12:36,240 --> 00:12:37,950
malware would kick off it would go out

364
00:12:37,950 --> 00:12:40,350
to an attacker control name server using

365
00:12:40,350 --> 00:12:41,970
that normal DNS hierarchy it would

366
00:12:41,970 --> 00:12:43,800
basically just say hey I want a txt

367
00:12:43,800 --> 00:12:45,390
record associated with you know

368
00:12:45,390 --> 00:12:47,250
subdomain XYZ of one of these domains

369
00:12:47,250 --> 00:12:49,440
and then the response from the attackers

370
00:12:49,440 --> 00:12:51,300
server would just be transmitted through

371
00:12:51,300 --> 00:12:53,760
that hierarchy back into the internal

372
00:12:53,760 --> 00:12:55,320
DNS servers and then forwarded over to

373
00:12:55,320 --> 00:12:57,150
the endpoint and what it would do is it

374
00:12:57,150 --> 00:12:59,070
would basically take that base64 encoded

375
00:12:59,070 --> 00:13:01,080
blob that it received inside of the DNS

376
00:13:01,080 --> 00:13:03,690
txt record response decode it and then

377
00:13:03,690 --> 00:13:05,310
execute it within the confines of the

378
00:13:05,310 --> 00:13:06,810
existing PowerShell process that was

379
00:13:06,810 --> 00:13:10,830
running so what this stage 4 would do is

380
00:13:10,830 --> 00:13:12,420
it would actually execute the Windows

381
00:13:12,420 --> 00:13:14,800
command processors so cmd.exe

382
00:13:14,800 --> 00:13:16,450
would redirect standard in standard out

383
00:13:16,450 --> 00:13:18,640
in standard air into the powershell

384
00:13:18,640 --> 00:13:21,190
process itself it would select a second

385
00:13:21,190 --> 00:13:22,450
domain from a list

386
00:13:22,450 --> 00:13:24,339
another ArrayList and then they would

387
00:13:24,339 --> 00:13:26,800
basically leverage a custom command and

388
00:13:26,800 --> 00:13:28,330
control protocol that all made use of

389
00:13:28,330 --> 00:13:30,790
DNS txt records they would send a syn

390
00:13:30,790 --> 00:13:32,890
message a way to response and then they

391
00:13:32,890 --> 00:13:35,740
would send the output of that to send

392
00:13:35,740 --> 00:13:37,209
the output of the command line processor

393
00:13:37,209 --> 00:13:39,490
over standard out in standard air using

394
00:13:39,490 --> 00:13:42,820
DNS record record requests so just to

395
00:13:42,820 --> 00:13:44,079
kind of illustrate that so when I say

396
00:13:44,079 --> 00:13:46,120
syn I don't mean like TCP syn packets

397
00:13:46,120 --> 00:13:47,649
this is actually what they called that

398
00:13:47,649 --> 00:13:49,329
stage of the command control protocol so

399
00:13:49,329 --> 00:13:52,060
syn would be used to basically stand up

400
00:13:52,060 --> 00:13:53,589
the command control protocol and then

401
00:13:53,589 --> 00:13:54,940
message queries would be used to

402
00:13:54,940 --> 00:13:56,260
facilitate the transfer of information

403
00:13:56,260 --> 00:13:58,540
from an infected endpoint to an attacker

404
00:13:58,540 --> 00:14:00,850
controlled DNS server all over that DNS

405
00:14:00,850 --> 00:14:03,430
txt request and then associated response

406
00:14:03,430 --> 00:14:05,320
so you can see the the message query

407
00:14:05,320 --> 00:14:07,329
itself the query is from the end point

408
00:14:07,329 --> 00:14:08,740
so the end point saying hey please

409
00:14:08,740 --> 00:14:10,690
resolve the txt record associated with

410
00:14:10,690 --> 00:14:14,440
this really long string of alphanumeric

411
00:14:14,440 --> 00:14:17,079
characters but when you actually decode

412
00:14:17,079 --> 00:14:19,390
that using you know the the encoding

413
00:14:19,390 --> 00:14:20,649
mechanism that they were using what they

414
00:14:20,649 --> 00:14:21,700
were basically doing is they were

415
00:14:21,700 --> 00:14:24,790
sending requests for DNS txt records but

416
00:14:24,790 --> 00:14:26,170
when you decoded the contents on the

417
00:14:26,170 --> 00:14:27,370
attacker controlled server

418
00:14:27,370 --> 00:14:28,779
it was the output of the Windows command

419
00:14:28,779 --> 00:14:31,420
line processor so the responses from the

420
00:14:31,420 --> 00:14:32,890
server could be used to say hey go

421
00:14:32,890 --> 00:14:34,450
execute this command on a Windows in

422
00:14:34,450 --> 00:14:36,430
point and then the output would be sent

423
00:14:36,430 --> 00:14:39,160
back over that DNS stream and this kind

424
00:14:39,160 --> 00:14:40,720
of just shows the command control

425
00:14:40,720 --> 00:14:42,250
protocol that was being leveraged by the

426
00:14:42,250 --> 00:14:44,350
adversary so syn would stand up the the

427
00:14:44,350 --> 00:14:46,060
C 2 protocol they would just do that

428
00:14:46,060 --> 00:14:48,670
message query in response as long as the

429
00:14:48,670 --> 00:14:50,230
attacker wanted shell access to the

430
00:14:50,230 --> 00:14:52,480
system and then when the attacker was

431
00:14:52,480 --> 00:14:53,829
done controlling the endpoint they would

432
00:14:53,829 --> 00:14:55,720
send us in a fin query and a fin

433
00:14:55,720 --> 00:14:58,720
response and they actually created a

434
00:14:58,720 --> 00:15:00,610
full custom command and control protocol

435
00:15:00,610 --> 00:15:01,779
for this and you can see kind of the

436
00:15:01,779 --> 00:15:04,149
packet structure that they created for

437
00:15:04,149 --> 00:15:06,010
this particular command control protocol

438
00:15:06,010 --> 00:15:07,839
so that was the initial campaign

439
00:15:07,839 --> 00:15:09,699
associated with DNS messenger a few

440
00:15:09,699 --> 00:15:12,029
months later we actually detected some

441
00:15:12,029 --> 00:15:13,870
additional campaigns and they were

442
00:15:13,870 --> 00:15:16,209
actually leveraging an updated version

443
00:15:16,209 --> 00:15:18,820
of DNS messenger so once again Mouse

444
00:15:18,820 --> 00:15:20,290
spam campaigns in this case they were

445
00:15:20,290 --> 00:15:21,519
making them appear as if they were from

446
00:15:21,519 --> 00:15:22,570
the Securities and Exchange Commission

447
00:15:22,570 --> 00:15:24,579
the Edgar system if you're not familiar

448
00:15:24,579 --> 00:15:27,010
with it in the US on the sec

449
00:15:27,010 --> 00:15:28,270
has the editor system that allows

450
00:15:28,270 --> 00:15:30,910
companies to make filings and put in the

451
00:15:30,910 --> 00:15:32,560
documentation they need to so they

452
00:15:32,560 --> 00:15:35,200
basically spoofed SEC sent emails in

453
00:15:35,200 --> 00:15:37,330
that said hey you know there's important

454
00:15:37,330 --> 00:15:38,890
information from the SEC open this

455
00:15:38,890 --> 00:15:40,800
attach document to find out what it is

456
00:15:40,800 --> 00:15:42,790
so when you open the document they

457
00:15:42,790 --> 00:15:44,140
actually branded it to make it appear as

458
00:15:44,140 --> 00:15:45,940
if it was you know associated with the

459
00:15:45,940 --> 00:15:48,700
SEC they put the appropriate branding in

460
00:15:48,700 --> 00:15:50,260
and whatnot in there in this case they

461
00:15:50,260 --> 00:15:51,790
weren't using macros though they were

462
00:15:51,790 --> 00:15:54,130
using a dynamic data exchange dd which

463
00:15:54,130 --> 00:15:56,170
is a feature set that was present in

464
00:15:56,170 --> 00:15:57,820
word that attackers were abusing pretty

465
00:15:57,820 --> 00:16:00,190
heavily so when you open the document it

466
00:16:00,190 --> 00:16:02,020
pops up it says hey this this document

467
00:16:02,020 --> 00:16:03,760
links to other your files do you want to

468
00:16:03,760 --> 00:16:05,410
update the document and if you say yes

469
00:16:05,410 --> 00:16:07,480
that causes of Microsoft Word to go out

470
00:16:07,480 --> 00:16:09,430
to the predefined resource on the

471
00:16:09,430 --> 00:16:11,410
internet pull down contents and then

472
00:16:11,410 --> 00:16:14,470
start to execute it so in this case if

473
00:16:14,470 --> 00:16:16,480
you clicked yes what it would do is it

474
00:16:16,480 --> 00:16:17,740
would call the Windows command line

475
00:16:17,740 --> 00:16:19,000
processor which would then call

476
00:16:19,000 --> 00:16:22,420
PowerShell which would echo SCC gov in a

477
00:16:22,420 --> 00:16:23,800
little window on the screen to make it

478
00:16:23,800 --> 00:16:26,020
look legit right and then it would

479
00:16:26,020 --> 00:16:28,390
basically go out to a compromised

480
00:16:28,390 --> 00:16:31,030
Louisiana government website where they

481
00:16:31,030 --> 00:16:32,800
had been hosted the the next stage of

482
00:16:32,800 --> 00:16:34,450
the infection process it would pull down

483
00:16:34,450 --> 00:16:37,230
the contents from that URL that TRT do-e

484
00:16:37,230 --> 00:16:40,900
Louisiana gov /font txt and then it

485
00:16:40,900 --> 00:16:44,500
would execute it on the system so when

486
00:16:44,500 --> 00:16:46,780
you actually go out to that and pull

487
00:16:46,780 --> 00:16:48,400
down that the contents associated with

488
00:16:48,400 --> 00:16:50,710
that external resource I truncated it

489
00:16:50,710 --> 00:16:53,680
for for slide sake but what you would

490
00:16:53,680 --> 00:16:54,910
get is PowerShell and inside that

491
00:16:54,910 --> 00:16:59,260
PowerShell was a base64 encoded blob so

492
00:16:59,260 --> 00:17:01,300
that basic ste 4 encoded blob would then

493
00:17:01,300 --> 00:17:03,190
be decoded and then executed within the

494
00:17:03,190 --> 00:17:04,660
confines of the existing powershell

495
00:17:04,660 --> 00:17:06,430
process on the system and it was

496
00:17:06,430 --> 00:17:08,980
responsible for storing stage 2 in in

497
00:17:08,980 --> 00:17:10,420
the Windows registry similar to what we

498
00:17:10,420 --> 00:17:11,980
saw with the previous versions of DNS

499
00:17:11,980 --> 00:17:13,839
messenger it would also check to see if

500
00:17:13,839 --> 00:17:15,550
it was already running so it would check

501
00:17:15,550 --> 00:17:17,410
to see if a specific mutex was present

502
00:17:17,410 --> 00:17:18,310
on the system if you're not familiar

503
00:17:18,310 --> 00:17:20,859
with mutexes they're pretty common ways

504
00:17:20,859 --> 00:17:24,339
for programs to avoid executing multiple

505
00:17:24,339 --> 00:17:26,560
times on a system so they would check to

506
00:17:26,560 --> 00:17:28,480
see if this this mutex was present if it

507
00:17:28,480 --> 00:17:30,160
was that meant that DNS messenger was

508
00:17:30,160 --> 00:17:31,270
already running on the system and they

509
00:17:31,270 --> 00:17:32,590
would just terminate execution if it

510
00:17:32,590 --> 00:17:34,960
wasn't it would continue to kick off and

511
00:17:34,960 --> 00:17:36,640
go into later stages of the infection

512
00:17:36,640 --> 00:17:40,640
process so stage 2 persistence was cray

513
00:17:40,640 --> 00:17:42,050
so they had a bunch of different ways

514
00:17:42,050 --> 00:17:43,490
that they could achieve persistence on

515
00:17:43,490 --> 00:17:45,410
an end point so this is just a

516
00:17:45,410 --> 00:17:47,060
screenshot of some of the the ways that

517
00:17:47,060 --> 00:17:48,380
they could attempt to do this within the

518
00:17:48,380 --> 00:17:49,940
Windows registry so there were a lot of

519
00:17:49,940 --> 00:17:52,070
if-then statements present and based on

520
00:17:52,070 --> 00:17:54,200
the the results of those operations that

521
00:17:54,200 --> 00:17:55,880
would make a decision on how to persist

522
00:17:55,880 --> 00:17:57,410
on the system so they could write to a

523
00:17:57,410 --> 00:17:59,510
bunch of different locations within the

524
00:17:59,510 --> 00:18:01,490
registry to store that that powershell

525
00:18:01,490 --> 00:18:02,810
blot that would be kicked off every time

526
00:18:02,810 --> 00:18:05,090
the system was rebooted so in addition

527
00:18:05,090 --> 00:18:08,360
to the registry they also had the

528
00:18:08,360 --> 00:18:10,030
capability of creating a scheduled task

529
00:18:10,030 --> 00:18:12,170
one of the interesting things about the

530
00:18:12,170 --> 00:18:13,280
scheduled tasks this is pretty common

531
00:18:13,280 --> 00:18:15,050
with malware write schedule task points

532
00:18:15,050 --> 00:18:16,550
to an hour code every time the system

533
00:18:16,550 --> 00:18:18,680
reboots malware code kicks off and the

534
00:18:18,680 --> 00:18:20,750
infection continues but in this case

535
00:18:20,750 --> 00:18:23,210
they actually set a random delay so they

536
00:18:23,210 --> 00:18:24,710
had a random delay set up so that each

537
00:18:24,710 --> 00:18:26,270
time the system rebooted a different

538
00:18:26,270 --> 00:18:27,980
amount of time would pass before the the

539
00:18:27,980 --> 00:18:29,990
malware would kick itself back off which

540
00:18:29,990 --> 00:18:31,400
is you know kind of interesting if

541
00:18:31,400 --> 00:18:32,930
you're running this in a sandbox

542
00:18:32,930 --> 00:18:34,400
environment or if you're you know just

543
00:18:34,400 --> 00:18:35,930
trying to analyze it you might look at

544
00:18:35,930 --> 00:18:37,010
it after a reboot and said well

545
00:18:37,010 --> 00:18:38,900
nothing's happening but reality is there

546
00:18:38,900 --> 00:18:41,990
there was a wait timer set in addition

547
00:18:41,990 --> 00:18:43,820
to the registry in addition to the

548
00:18:43,820 --> 00:18:45,350
scheduled tasks they also had the

549
00:18:45,350 --> 00:18:46,940
capability of using alternate data

550
00:18:46,940 --> 00:18:49,340
streams or WMI subscriptions in the

551
00:18:49,340 --> 00:18:50,830
windows management instrumentation

552
00:18:50,830 --> 00:18:53,240
database on a Windows endpoint so these

553
00:18:53,240 --> 00:18:56,300
are a couple of non-traditional ways to

554
00:18:56,300 --> 00:18:57,770
persist on a Windows in point they could

555
00:18:57,770 --> 00:18:59,330
create a subscription in the WMI

556
00:18:59,330 --> 00:19:00,890
database and then leverage that for

557
00:19:00,890 --> 00:19:04,700
persistence as well so stage 3 was was

558
00:19:04,700 --> 00:19:06,860
pretty interesting so this is where the

559
00:19:06,860 --> 00:19:08,030
command and control protocol would

560
00:19:08,030 --> 00:19:09,170
really kick off and they would start to

561
00:19:09,170 --> 00:19:10,490
reach out to an attacker controlled

562
00:19:10,490 --> 00:19:12,020
server in the way that they would

563
00:19:12,020 --> 00:19:13,730
determine you know how to operate is

564
00:19:13,730 --> 00:19:15,140
they would obtain the system serial

565
00:19:15,140 --> 00:19:16,400
number and then they would generate an

566
00:19:16,400 --> 00:19:18,200
md5 hash of the serial number that would

567
00:19:18,200 --> 00:19:20,420
take the first 10 bytes and use that to

568
00:19:20,420 --> 00:19:22,100
generate a DNS hostname that they would

569
00:19:22,100 --> 00:19:24,260
use to communicate out to an attacker

570
00:19:24,260 --> 00:19:27,830
controlled name server so what they

571
00:19:27,830 --> 00:19:28,760
would do is they would take that host

572
00:19:28,760 --> 00:19:31,190
name they would basically append a

573
00:19:31,190 --> 00:19:32,660
hard-coded string in this case it was

574
00:19:32,660 --> 00:19:34,760
stage then they had a counter setup that

575
00:19:34,760 --> 00:19:37,100
would iterate each time a DNS request

576
00:19:37,100 --> 00:19:39,530
was made it started with 0 1 2 3 4 etc

577
00:19:39,530 --> 00:19:42,230
and then they would randomly select a

578
00:19:42,230 --> 00:19:45,530
root domain from an array list similar

579
00:19:45,530 --> 00:19:46,820
to what I talked about in the last

580
00:19:46,820 --> 00:19:48,500
version of DNS and that's the host name

581
00:19:48,500 --> 00:19:50,690
that they would use to create DNS

582
00:19:50,690 --> 00:19:51,920
requests for two

583
00:19:51,920 --> 00:19:55,310
Qwest that name resolution so just as an

584
00:19:55,310 --> 00:19:57,440
example let's that's an example of one

585
00:19:57,440 --> 00:19:59,320
of the the host names that they would

586
00:19:59,320 --> 00:20:02,000
attempt to request name resolution for

587
00:20:02,000 --> 00:20:04,010
so they would first request an a record

588
00:20:04,010 --> 00:20:06,140
and then they would take the the the IP

589
00:20:06,140 --> 00:20:08,360
address that was returned from the name

590
00:20:08,360 --> 00:20:10,400
server associated with that a record and

591
00:20:10,400 --> 00:20:12,170
then they would request the txt record

592
00:20:12,170 --> 00:20:13,520
and they would take the first part of

593
00:20:13,520 --> 00:20:15,350
that txt record and it would perform a

594
00:20:15,350 --> 00:20:17,330
cryptographic operation on it they would

595
00:20:17,330 --> 00:20:19,160
perform the same cryptographic operation

596
00:20:19,160 --> 00:20:20,570
on the a record and they would compare

597
00:20:20,570 --> 00:20:22,370
the values how kind of is a data

598
00:20:22,370 --> 00:20:25,640
integrity checksum if you will so you

599
00:20:25,640 --> 00:20:27,140
can kind of see here so you've got an a

600
00:20:27,140 --> 00:20:28,850
record that returns an IP address they

601
00:20:28,850 --> 00:20:31,640
perform that cryptographic operation on

602
00:20:31,640 --> 00:20:33,740
it and an integer value is returned and

603
00:20:33,740 --> 00:20:35,570
then they do the same thing with the txt

604
00:20:35,570 --> 00:20:37,700
record and they compared the two integer

605
00:20:37,700 --> 00:20:38,210
values

606
00:20:38,210 --> 00:20:40,910
that's that data verification so in this

607
00:20:40,910 --> 00:20:42,410
particular command control protocol if

608
00:20:42,410 --> 00:20:44,000
the integer value matches that means

609
00:20:44,000 --> 00:20:45,440
that you know command and control is

610
00:20:45,440 --> 00:20:47,030
good to go and they would take the rest

611
00:20:47,030 --> 00:20:49,460
of the txt record contents and they

612
00:20:49,460 --> 00:20:51,650
would store it in a variable and then

613
00:20:51,650 --> 00:20:53,600
they would iterate the counter and they

614
00:20:53,600 --> 00:20:55,550
would make another DNS request it would

615
00:20:55,550 --> 00:20:58,250
return base 64 they would perform that

616
00:20:58,250 --> 00:21:00,260
data verification and if it matched they

617
00:21:00,260 --> 00:21:01,580
would take the rest of the txt and they

618
00:21:01,580 --> 00:21:02,840
would append it to the end and they

619
00:21:02,840 --> 00:21:04,100
would just keep building this blob

620
00:21:04,100 --> 00:21:07,520
base64 encoded information on they would

621
00:21:07,520 --> 00:21:09,560
then basically wait for the process to

622
00:21:09,560 --> 00:21:12,110
either fail that data integrity check or

623
00:21:12,110 --> 00:21:14,930
if 0.0.0.0 was returned from the

624
00:21:14,930 --> 00:21:16,520
attacker controlled server that meant

625
00:21:16,520 --> 00:21:18,050
that the transmission of information was

626
00:21:18,050 --> 00:21:21,110
complete in the resulting base64 encoded

627
00:21:21,110 --> 00:21:22,550
blob is stage-four they would decode

628
00:21:22,550 --> 00:21:24,890
that pass it to powershell and execute

629
00:21:24,890 --> 00:21:30,140
it to initiate stage 4 so stage 4 it was

630
00:21:30,140 --> 00:21:31,880
a rat basically it functioned as a

631
00:21:31,880 --> 00:21:33,890
remote access Trojan you could execute

632
00:21:33,890 --> 00:21:36,680
arbitrary commands it would use DNS to

633
00:21:36,680 --> 00:21:38,150
retrieve what commands to run on the

634
00:21:38,150 --> 00:21:40,280
system based on the contents of those

635
00:21:40,280 --> 00:21:42,980
DNS query responses it would execute

636
00:21:42,980 --> 00:21:44,330
those commands and then it would post

637
00:21:44,330 --> 00:21:45,500
information this time they actually

638
00:21:45,500 --> 00:21:47,630
leveraged HTTP for the the data

639
00:21:47,630 --> 00:21:50,600
exfiltration and it functioned pretty

640
00:21:50,600 --> 00:21:51,770
similar to what you would expect from

641
00:21:51,770 --> 00:21:52,900
rats

642
00:21:52,900 --> 00:21:56,810
it's all what's up over here so you see

643
00:21:56,810 --> 00:21:59,030
they started taking advantage of DNS and

644
00:21:59,030 --> 00:22:00,260
anybody who's been in this business

645
00:22:00,260 --> 00:22:02,840
knows these guys love to see what their

646
00:22:02,840 --> 00:22:04,669
peers doing so they keep adding

647
00:22:04,669 --> 00:22:06,379
to it they keep changing we saw Dennis

648
00:22:06,379 --> 00:22:08,239
messenger evolved from one that was easy

649
00:22:08,239 --> 00:22:09,710
to see on the names to one that was a

650
00:22:09,710 --> 00:22:11,570
little harder to look at when I were

651
00:22:11,570 --> 00:22:13,549
going to look at Dean espionage Warren

652
00:22:13,549 --> 00:22:15,259
and Paul did a great job finding these

653
00:22:15,259 --> 00:22:17,029
attacks so when they first came out and

654
00:22:17,029 --> 00:22:19,059
this was probably about a few months

655
00:22:19,059 --> 00:22:22,879
later than he was basically like near

656
00:22:22,879 --> 00:22:26,029
November October of 2018 they came

657
00:22:26,029 --> 00:22:29,029
across the Espionage and this one this

658
00:22:29,029 --> 00:22:30,919
first attack actually had two different

659
00:22:30,919 --> 00:22:32,600
components the first part we're gonna

660
00:22:32,600 --> 00:22:35,299
look at was a rat similar to what DNS

661
00:22:35,299 --> 00:22:36,739
messenger was where they were trying to

662
00:22:36,739 --> 00:22:39,289
get remote access to a box and what was

663
00:22:39,289 --> 00:22:41,269
really interesting is that you know they

664
00:22:41,269 --> 00:22:42,710
started like everything else you know

665
00:22:42,710 --> 00:22:44,869
they could do spearfishing but they also

666
00:22:44,869 --> 00:22:46,549
had some other interesting techniques

667
00:22:46,549 --> 00:22:49,159
they were going for tricking users you

668
00:22:49,159 --> 00:22:50,570
know users are that one of those weak

669
00:22:50,570 --> 00:22:53,179
links in our networks so instead of just

670
00:22:53,179 --> 00:22:55,070
doing phishing emails they would also go

671
00:22:55,070 --> 00:22:57,049
to different social media sites like

672
00:22:57,049 --> 00:22:59,570
LinkedIn places that people may be

673
00:22:59,570 --> 00:23:01,759
looking for a job and they would

674
00:23:01,759 --> 00:23:03,889
actually put interesting links up there

675
00:23:03,889 --> 00:23:07,369
that sort of confused a regular user

676
00:23:07,369 --> 00:23:09,649
most people don't understand how DNS

677
00:23:09,649 --> 00:23:13,249
works so we're procom Suncor comm those

678
00:23:13,249 --> 00:23:15,950
are valid companies that actually hire

679
00:23:15,950 --> 00:23:17,330
people well

680
00:23:17,330 --> 00:23:20,929
HR - Suncor comm it's not really related

681
00:23:20,929 --> 00:23:22,999
to sun core but it looks that way for a

682
00:23:22,999 --> 00:23:25,059
regular user so if I put that up there

683
00:23:25,059 --> 00:23:28,009
you're likely to download the file well

684
00:23:28,009 --> 00:23:29,989
when you download it it looks like a

685
00:23:29,989 --> 00:23:31,609
regular document you know it has

686
00:23:31,609 --> 00:23:33,499
information to fill out like I'm getting

687
00:23:33,499 --> 00:23:35,840
a job but as usual since it's an

688
00:23:35,840 --> 00:23:37,669
attacker one they put some macros in

689
00:23:37,669 --> 00:23:39,739
this document so in this case they

690
00:23:39,739 --> 00:23:41,659
actually put two different macros one

691
00:23:41,659 --> 00:23:43,789
macro would execute when it first opened

692
00:23:43,789 --> 00:23:46,789
up and all I would do is copy a copy of

693
00:23:46,789 --> 00:23:49,059
the document down to the system name doc

694
00:23:49,059 --> 00:23:52,279
then look really suspicious but then

695
00:23:52,279 --> 00:23:54,049
when you close the document another

696
00:23:54,049 --> 00:23:55,639
macro would execute and actually do some

697
00:23:55,639 --> 00:23:58,909
other things on the system might wonder

698
00:23:58,909 --> 00:24:02,019
why'd they put two macros on this system

699
00:24:02,019 --> 00:24:04,070
what they're doing is they started

700
00:24:04,070 --> 00:24:06,320
realizing that the defenders know aren't

701
00:24:06,320 --> 00:24:06,710
they

702
00:24:06,710 --> 00:24:08,119
we're trying to always defend against

703
00:24:08,119 --> 00:24:09,710
these attackers out there but the

704
00:24:09,710 --> 00:24:11,869
attackers know that we're putting

705
00:24:11,869 --> 00:24:13,999
roadblocks in their way and one of the

706
00:24:13,999 --> 00:24:15,559
things they know is that most people now

707
00:24:15,559 --> 00:24:17,299
have incorporated some type of

708
00:24:17,299 --> 00:24:18,670
sandboxing

709
00:24:18,670 --> 00:24:20,470
some way to check to see if a foul is

710
00:24:20,470 --> 00:24:22,840
malicious or not well they also know a

711
00:24:22,840 --> 00:24:25,330
lot of sand boxes aren't the same well

712
00:24:25,330 --> 00:24:27,490
if I have a very simple sand box it's

713
00:24:27,490 --> 00:24:30,310
gonna open up this document and see if

714
00:24:30,310 --> 00:24:32,650
it does anything well in this case if

715
00:24:32,650 --> 00:24:34,630
all you did was open it and you don't

716
00:24:34,630 --> 00:24:37,060
actually close it in your sandbox you

717
00:24:37,060 --> 00:24:39,700
never did the malicious part so it looks

718
00:24:39,700 --> 00:24:42,010
pretty benign and you go okay it's fine

719
00:24:42,010 --> 00:24:44,080
let it through so they're trying to do

720
00:24:44,080 --> 00:24:46,180
some avoidance of those sand boxes that

721
00:24:46,180 --> 00:24:47,710
they know in place on all of our

722
00:24:47,710 --> 00:24:51,040
networks but if you didn't if you did

723
00:24:51,040 --> 00:24:52,900
actually close it then would actually

724
00:24:52,900 --> 00:24:55,090
kick off the actual malicious stage of

725
00:24:55,090 --> 00:24:57,670
this payload and in this case as I

726
00:24:57,670 --> 00:24:58,930
mentioned it was trying to get a remote

727
00:24:58,930 --> 00:25:01,770
access trojan on your box well those

728
00:25:01,770 --> 00:25:03,880
Trojans need to communicate with the

729
00:25:03,880 --> 00:25:06,250
command and control well we see it could

730
00:25:06,250 --> 00:25:08,770
do HTTP we've seen that over the years

731
00:25:08,770 --> 00:25:11,860
nothing really unusual nothing new but

732
00:25:11,860 --> 00:25:14,410
these attackers also had the capability

733
00:25:14,410 --> 00:25:16,930
to take advantage of DNS so if they were

734
00:25:16,930 --> 00:25:19,330
going for say a higher value target

735
00:25:19,330 --> 00:25:20,800
maybe one that they knew is really

736
00:25:20,800 --> 00:25:23,740
monitoring HTTP really well they could

737
00:25:23,740 --> 00:25:25,630
actually use DNS before their entire

738
00:25:25,630 --> 00:25:29,050
command and control and in this case

739
00:25:29,050 --> 00:25:30,610
they actually went a little bit more

740
00:25:30,610 --> 00:25:32,140
doing a little different than DNS

741
00:25:32,140 --> 00:25:34,120
messenger remember DNS mission was using

742
00:25:34,120 --> 00:25:36,340
those text records which they're

743
00:25:36,340 --> 00:25:38,110
becoming more common but you could still

744
00:25:38,110 --> 00:25:40,570
look at the text records well in this

745
00:25:40,570 --> 00:25:43,330
case these guys went straight for

746
00:25:43,330 --> 00:25:46,360
regular DNS a records so what they would

747
00:25:46,360 --> 00:25:48,040
do is they would create a domain again

748
00:25:48,040 --> 00:25:49,570
you have to develop some type of a

749
00:25:49,570 --> 00:25:52,210
domain well they created one that looked

750
00:25:52,210 --> 00:25:55,530
like office 360

751
00:25:56,440 --> 00:26:00,130
you know the zero with a little Oh quick

752
00:26:00,130 --> 00:26:01,480
look at it most people are going to

753
00:26:01,480 --> 00:26:04,300
think it's office 360 and then they need

754
00:26:04,300 --> 00:26:05,920
to create a sub domain that went with

755
00:26:05,920 --> 00:26:08,440
that domain well in this case they

756
00:26:08,440 --> 00:26:10,330
didn't want to repeat their domains over

757
00:26:10,330 --> 00:26:13,150
and over again so the blue part that you

758
00:26:13,150 --> 00:26:14,890
can see they just randomly generated

759
00:26:14,890 --> 00:26:17,740
some information so that each time they

760
00:26:17,740 --> 00:26:19,690
would get a different sub domain and

761
00:26:19,690 --> 00:26:22,030
then the gray part they were actually

762
00:26:22,030 --> 00:26:25,360
encoding essentially the ID of the

763
00:26:25,360 --> 00:26:27,580
system so for this malware each

764
00:26:27,580 --> 00:26:29,680
individual system was given a two

765
00:26:29,680 --> 00:26:32,290
character identification value like

766
00:26:32,290 --> 00:26:35,200
case it was GT so they basically based

767
00:26:35,200 --> 00:26:37,800
32 encoded that into the gray part

768
00:26:37,800 --> 00:26:40,540
created that domain shipped it off

769
00:26:40,540 --> 00:26:43,090
through DNS went all the way to the

770
00:26:43,090 --> 00:26:45,520
attackers name server and they got a

771
00:26:45,520 --> 00:26:49,930
reply back of 0.1 0.3 not really a valid

772
00:26:49,930 --> 00:26:52,270
IP address DNS doesn't care as long as

773
00:26:52,270 --> 00:26:54,700
it's four octet some numbers but in this

774
00:26:54,700 --> 00:26:56,980
case it's actually telling the malware

775
00:26:56,980 --> 00:26:59,440
on the system that I'm sending you one

776
00:26:59,440 --> 00:27:01,240
command and it's gonna be three

777
00:27:01,240 --> 00:27:02,440
characters long

778
00:27:02,440 --> 00:27:05,680
so the malware goes okay I'll reissue my

779
00:27:05,680 --> 00:27:08,140
DNS command and again the gray part

780
00:27:08,140 --> 00:27:10,600
stays the same the blue part which is

781
00:27:10,600 --> 00:27:12,970
random get something different but if

782
00:27:12,970 --> 00:27:14,260
you'll notice we have a different IP

783
00:27:14,260 --> 00:27:18,160
address this time we have 100 105 114

784
00:27:18,160 --> 00:27:20,560
well you've looked at the ASCII chart

785
00:27:20,560 --> 00:27:23,140
they basically encode the results of

786
00:27:23,140 --> 00:27:25,450
what they're trying to do the 100 is

787
00:27:25,450 --> 00:27:29,140
addi the 105 is na and I are so it's

788
00:27:29,140 --> 00:27:31,420
telling through DNS the malware that I

789
00:27:31,420 --> 00:27:34,030
want to run a directory on the system so

790
00:27:34,030 --> 00:27:35,410
they could send whatever command they

791
00:27:35,410 --> 00:27:38,860
want it and then they would execute a

792
00:27:38,860 --> 00:27:40,900
bunch of DNS requests going back again

793
00:27:40,900 --> 00:27:44,410
given the results this time that gray

794
00:27:44,410 --> 00:27:47,560
portion was going to hold pieces of the

795
00:27:47,560 --> 00:27:50,890
result they again kept it small because

796
00:27:50,890 --> 00:27:52,420
they know if they get too large just

797
00:27:52,420 --> 00:27:54,280
like the original DNS messenger it's

798
00:27:54,280 --> 00:27:56,620
real easy to spot programmatically but

799
00:27:56,620 --> 00:27:58,240
here as long as I keep it fairly small

800
00:27:58,240 --> 00:28:00,580
it's much harder to detect they're

801
00:28:00,580 --> 00:28:02,920
staying in the noise and now they're

802
00:28:02,920 --> 00:28:05,350
transmitting all their information over

803
00:28:05,350 --> 00:28:06,760
a protocol in many cases that aren't

804
00:28:06,760 --> 00:28:08,740
even monitored and that's one of the

805
00:28:08,740 --> 00:28:09,790
advantage they were looking at they were

806
00:28:09,790 --> 00:28:12,300
really trying to stay under the radar

807
00:28:12,300 --> 00:28:15,310
and when we saw him do this you know we

808
00:28:15,310 --> 00:28:17,140
could look in umbrella and investigate

809
00:28:17,140 --> 00:28:19,030
tool and see when they were using this

810
00:28:19,030 --> 00:28:20,950
but in reality they didn't use it in

811
00:28:20,950 --> 00:28:23,200
that many cases they really used it for

812
00:28:23,200 --> 00:28:25,120
more of the high-value targets it wasn't

813
00:28:25,120 --> 00:28:26,320
something they went to on a regular

814
00:28:26,320 --> 00:28:29,110
basis because they knew again the more

815
00:28:29,110 --> 00:28:30,700
they used it the more it was likely to

816
00:28:30,700 --> 00:28:32,950
get detected and then people put more

817
00:28:32,950 --> 00:28:34,540
roadblocks in place to stop it from

818
00:28:34,540 --> 00:28:38,170
working in the future then that was the

819
00:28:38,170 --> 00:28:40,090
first half of it but these same threat

820
00:28:40,090 --> 00:28:42,160
actors also had another component that

821
00:28:42,160 --> 00:28:44,530
they were using to try and get into the

822
00:28:44,530 --> 00:28:46,410
network's so instead of

823
00:28:46,410 --> 00:28:49,620
you know tunnel stuff through DNS what

824
00:28:49,620 --> 00:28:51,450
they also realized was that when you do

825
00:28:51,450 --> 00:28:53,640
a DNS request you see the like blue

826
00:28:53,640 --> 00:28:55,800
system here we know we got to get that

827
00:28:55,800 --> 00:28:57,150
IP address so that we can actually

828
00:28:57,150 --> 00:28:59,370
communicate with the real server but

829
00:28:59,370 --> 00:29:01,440
they also knew there's this entire DNS

830
00:29:01,440 --> 00:29:05,340
hierarchy that facilitates giving me

831
00:29:05,340 --> 00:29:07,470
that IP address so like but what if I go

832
00:29:07,470 --> 00:29:11,070
and target that infrastructure first so

833
00:29:11,070 --> 00:29:13,650
what if we switch it around so that if i

834
00:29:13,650 --> 00:29:16,620
hack the DNS infrastructure so that when

835
00:29:16,620 --> 00:29:19,620
the IP address comes back it's not the

836
00:29:19,620 --> 00:29:22,080
company's website it's my attacker

837
00:29:22,080 --> 00:29:25,230
controlled website I can now become a

838
00:29:25,230 --> 00:29:26,940
man in the middle for the actual traffic

839
00:29:26,940 --> 00:29:30,000
and if I do that well enough I can still

840
00:29:30,000 --> 00:29:31,650
credentials for the users for that

841
00:29:31,650 --> 00:29:33,720
company and then go directly to the

842
00:29:33,720 --> 00:29:36,780
company with valid creds so a way that

843
00:29:36,780 --> 00:29:38,580
really target a company in a much more

844
00:29:38,580 --> 00:29:42,240
stealthy mode you know when you look at

845
00:29:42,240 --> 00:29:44,070
the hierarchy there's lots of different

846
00:29:44,070 --> 00:29:46,320
tiers to this and that's one of the

847
00:29:46,320 --> 00:29:48,420
things in this case these guys were

848
00:29:48,420 --> 00:29:49,710
literally going just for the regiment

849
00:29:49,710 --> 00:29:51,510
registering accounts because what they

850
00:29:51,510 --> 00:29:54,180
realize is that a lot of people have set

851
00:29:54,180 --> 00:29:56,340
up these domain accounts they may have

852
00:29:56,340 --> 00:29:58,080
said a long time ago they have a really

853
00:29:58,080 --> 00:29:59,700
weak password on their register an

854
00:29:59,700 --> 00:30:02,340
account if I go in and hack that account

855
00:30:02,340 --> 00:30:05,040
I can easily change words pointing to

856
00:30:05,040 --> 00:30:06,600
and now I've become a man-in-the-middle

857
00:30:06,600 --> 00:30:08,760
I can actually steal credentials get

858
00:30:08,760 --> 00:30:10,980
right onto the networks it made a pretty

859
00:30:10,980 --> 00:30:13,530
interesting attack so that's what we're

860
00:30:13,530 --> 00:30:15,060
going to talk about for the second stage

861
00:30:15,060 --> 00:30:17,010
of DN espionage that's what these guys

862
00:30:17,010 --> 00:30:19,920
actually did they went out they set up

863
00:30:19,920 --> 00:30:21,960
their own servers you know they picked

864
00:30:21,960 --> 00:30:24,420
their own IP addresses they had and then

865
00:30:24,420 --> 00:30:26,850
they were actually putting self-signed

866
00:30:26,850 --> 00:30:28,320
search and a lot of these so they could

867
00:30:28,320 --> 00:30:31,620
make it look like legitimate hosts so if

868
00:30:31,620 --> 00:30:32,820
you went there it actually had a

869
00:30:32,820 --> 00:30:35,130
certificate a lot of users don't know

870
00:30:35,130 --> 00:30:36,630
the difference between self sign and

871
00:30:36,630 --> 00:30:40,650
regular sign but then they would create

872
00:30:40,650 --> 00:30:43,020
the domains and then basically redirect

873
00:30:43,020 --> 00:30:46,920
the a records and again couldn't put the

874
00:30:46,920 --> 00:30:48,600
domains when we first did this because

875
00:30:48,600 --> 00:30:50,340
they were actually validly still

876
00:30:50,340 --> 00:30:52,320
targeting these companies they were like

877
00:30:52,320 --> 00:30:54,990
you know military government sites oil

878
00:30:54,990 --> 00:30:58,320
and gas certain middle-eastern countries

879
00:30:58,320 --> 00:30:59,639
we could actually track this through

880
00:30:59,639 --> 00:31:02,669
passive DNS to see that they were

881
00:31:02,669 --> 00:31:05,970
redirecting valid requests for that site

882
00:31:05,970 --> 00:31:08,309
to the attacker controlled server and

883
00:31:08,309 --> 00:31:10,230
then what was really interesting is they

884
00:31:10,230 --> 00:31:11,730
would let you put in your credentials

885
00:31:11,730 --> 00:31:13,590
and they would happily redirect you to

886
00:31:13,590 --> 00:31:15,240
the real site so that you would actually

887
00:31:15,240 --> 00:31:18,179
be logged in to the real company after

888
00:31:18,179 --> 00:31:19,470
you gave them the information that they

889
00:31:19,470 --> 00:31:21,539
were looking for because it was their

890
00:31:21,539 --> 00:31:24,059
site first so that was what we first

891
00:31:24,059 --> 00:31:27,179
noticed then actually stepping back we

892
00:31:27,179 --> 00:31:29,789
saw that this wasn't just happening near

893
00:31:29,789 --> 00:31:32,159
the end of 2018 it had been going on for

894
00:31:32,159 --> 00:31:34,350
a couple of years so these guys were

895
00:31:34,350 --> 00:31:36,960
taking advantage of a situation where

896
00:31:36,960 --> 00:31:39,990
people don't really look to see that the

897
00:31:39,990 --> 00:31:42,149
IP address from my a record is actually

898
00:31:42,149 --> 00:31:44,220
getting changed they're not monitoring

899
00:31:44,220 --> 00:31:45,809
that just like we don't monitor DNS on

900
00:31:45,809 --> 00:31:47,759
our network we don't always monitor

901
00:31:47,759 --> 00:31:49,559
what's happening on those named

902
00:31:49,559 --> 00:31:51,570
registries either and they took

903
00:31:51,570 --> 00:31:52,980
advantage of that fact so they were

904
00:31:52,980 --> 00:31:55,610
actually doing that to target networks

905
00:31:55,610 --> 00:31:59,269
so again as I talk they keep evolving

906
00:31:59,269 --> 00:32:02,759
you know in this case it was it was

907
00:32:02,759 --> 00:32:05,519
significant enough at the time that in

908
00:32:05,519 --> 00:32:08,039
u.s. homeland security actually sent out

909
00:32:08,039 --> 00:32:09,840
and noticed to all of the government

910
00:32:09,840 --> 00:32:12,899
agencies and said hey we want you to go

911
00:32:12,899 --> 00:32:14,519
and check your register accounts make

912
00:32:14,519 --> 00:32:16,230
sure you have a very strong password if

913
00:32:16,230 --> 00:32:18,059
you can do two-factor authentication on

914
00:32:18,059 --> 00:32:20,909
it set it up whatever you can do but we

915
00:32:20,909 --> 00:32:21,870
feel that they're going to start

916
00:32:21,870 --> 00:32:24,720
targeting those registrant accounts for

917
00:32:24,720 --> 00:32:26,279
all the government organizations so they

918
00:32:26,279 --> 00:32:28,049
really pushed it in the u.s. to try and

919
00:32:28,049 --> 00:32:29,580
get people to make sure that they knew

920
00:32:29,580 --> 00:32:32,039
that they had strong accounts that

921
00:32:32,039 --> 00:32:34,350
weren't going to be hacked I don't know

922
00:32:34,350 --> 00:32:35,879
if they're really successful but we'll

923
00:32:35,879 --> 00:32:38,909
see as time goes on but now we move even

924
00:32:38,909 --> 00:32:41,730
further to I think this is like

925
00:32:41,730 --> 00:32:45,419
beginning of 2019 we started seeing

926
00:32:45,419 --> 00:32:47,250
attackers that were taking it actually

927
00:32:47,250 --> 00:32:50,059
to the next level up these guys went

928
00:32:50,059 --> 00:32:52,620
solely for targeting that DNS

929
00:32:52,620 --> 00:32:56,789
infrastructure and doing it with more of

930
00:32:56,789 --> 00:32:58,950
a clear motive of espionage I mean they

931
00:32:58,950 --> 00:33:00,960
were targeting really high value targets

932
00:33:00,960 --> 00:33:02,549
think of governments and telogen

933
00:33:02,549 --> 00:33:06,870
organizations you know military but one

934
00:33:06,870 --> 00:33:08,429
of the interesting parts is they really

935
00:33:08,429 --> 00:33:10,679
went up higher in the food chain so they

936
00:33:10,679 --> 00:33:12,160
were taking over like name

937
00:33:12,160 --> 00:33:14,110
servers in some cases they were actually

938
00:33:14,110 --> 00:33:16,540
taking over like top-level country

939
00:33:16,540 --> 00:33:19,900
domains so hey why go for the low guys

940
00:33:19,900 --> 00:33:22,390
when I can control all the DNS for an

941
00:33:22,390 --> 00:33:25,630
entire country which makes it really

942
00:33:25,630 --> 00:33:27,790
scary because you think about it on

943
00:33:27,790 --> 00:33:30,160
these situations here these guys were

944
00:33:30,160 --> 00:33:33,190
pretty skilled at what they did but DNS

945
00:33:33,190 --> 00:33:36,670
holds the Internet together if somebody

946
00:33:36,670 --> 00:33:38,650
goes and tries to repeat this and makes

947
00:33:38,650 --> 00:33:41,380
a mistake they could like wreak havoc

948
00:33:41,380 --> 00:33:43,420
and destroy the operation of lots of

949
00:33:43,420 --> 00:33:45,040
activity on the internet when nothing

950
00:33:45,040 --> 00:33:47,200
would work you know and that's one of

951
00:33:47,200 --> 00:33:49,510
the scary parts is that these attacks

952
00:33:49,510 --> 00:33:50,920
are getting involved as people start

953
00:33:50,920 --> 00:33:52,840
repeating that they may or may not have

954
00:33:52,840 --> 00:33:54,850
the skills but they can get in and then

955
00:33:54,850 --> 00:33:56,290
wreak havoc that they wouldn't think

956
00:33:56,290 --> 00:33:59,830
about and in this case you know there

957
00:33:59,830 --> 00:34:01,660
was intrude on ously the primary targets

958
00:34:01,660 --> 00:34:03,280
these military sites these government

959
00:34:03,280 --> 00:34:05,890
organizations but it also involves

960
00:34:05,890 --> 00:34:07,330
secondary targets because if you think

961
00:34:07,330 --> 00:34:09,570
about it a lot of these registrar's were

962
00:34:09,570 --> 00:34:13,030
even in different countries so to get to

963
00:34:13,030 --> 00:34:15,250
my final target I had to compromise that

964
00:34:15,250 --> 00:34:16,870
part of that infrastructure that DNS

965
00:34:16,870 --> 00:34:19,150
setup and those registrar's may be in

966
00:34:19,150 --> 00:34:20,620
totally different countries but that's

967
00:34:20,620 --> 00:34:22,239
what they were targeting because they

968
00:34:22,239 --> 00:34:24,520
realized that maybe this government

969
00:34:24,520 --> 00:34:26,530
entity has very strong security they

970
00:34:26,530 --> 00:34:29,889
really take security seriously but what

971
00:34:29,889 --> 00:34:31,330
about the Registrar that provided him

972
00:34:31,330 --> 00:34:33,250
that account maybe they have some

973
00:34:33,250 --> 00:34:34,360
weaknesses they haven't patched

974
00:34:34,360 --> 00:34:36,370
something they may have ways I can get

975
00:34:36,370 --> 00:34:37,989
in and that's what it's already taking

976
00:34:37,989 --> 00:34:39,969
advantage of the fact that there's lots

977
00:34:39,969 --> 00:34:41,949
of areas almost like a supply chain if

978
00:34:41,949 --> 00:34:44,230
you would that I can take advantage of

979
00:34:44,230 --> 00:34:47,020
not going directly to that company as

980
00:34:47,020 --> 00:34:49,480
you can see here primary targets there

981
00:34:49,480 --> 00:34:51,730
in orange but the secondary ones were

982
00:34:51,730 --> 00:34:53,860
those registrar accounts are registered

983
00:34:53,860 --> 00:34:56,409
entities registries that were in

984
00:34:56,409 --> 00:34:57,940
different countries that they also took

985
00:34:57,940 --> 00:34:59,800
advantage of because that's what was

986
00:34:59,800 --> 00:35:02,560
supplying the name servers that these

987
00:35:02,560 --> 00:35:04,540
guys actually took control of and in

988
00:35:04,540 --> 00:35:06,040
many cases actually stood up their own

989
00:35:06,040 --> 00:35:07,330
name servers so instead of just

990
00:35:07,330 --> 00:35:10,600
redirecting in single entry they were

991
00:35:10,600 --> 00:35:12,430
actually redirecting an entire name

992
00:35:12,430 --> 00:35:15,190
server and other spaces so that they

993
00:35:15,190 --> 00:35:16,570
could pretty print ready to put whatever

994
00:35:16,570 --> 00:35:18,340
they wanted and they would do it short

995
00:35:18,340 --> 00:35:19,960
long term at depending on how long they

996
00:35:19,960 --> 00:35:22,780
wanted to do the change so give you an

997
00:35:22,780 --> 00:35:25,120
idea how this work these guys would go

998
00:35:25,120 --> 00:35:26,050
and target

999
00:35:26,050 --> 00:35:27,610
one of these registrar's one of these

1000
00:35:27,610 --> 00:35:30,160
registries find a way to get in some

1001
00:35:30,160 --> 00:35:31,570
initial access they may be even

1002
00:35:31,570 --> 00:35:33,460
Spearfish somebody that works for a

1003
00:35:33,460 --> 00:35:36,700
registrar they would get in start moving

1004
00:35:36,700 --> 00:35:38,950
around get more access they would get

1005
00:35:38,950 --> 00:35:40,210
you know data back to their

1006
00:35:40,210 --> 00:35:42,490
command-and-control pretty much once

1007
00:35:42,490 --> 00:35:44,200
they would get in far enough they would

1008
00:35:44,200 --> 00:35:46,120
actually control some part of this DNS

1009
00:35:46,120 --> 00:35:48,280
registry so that they could actually

1010
00:35:48,280 --> 00:35:50,380
then do that changing changing the name

1011
00:35:50,380 --> 00:35:53,200
register your name server IP address do

1012
00:35:53,200 --> 00:35:54,370
whatever they need it to because they

1013
00:35:54,370 --> 00:35:55,930
were actually on the systems that could

1014
00:35:55,930 --> 00:35:58,450
control it now so now they would do it

1015
00:35:58,450 --> 00:36:00,790
update whatever entry they wanted maybe

1016
00:36:00,790 --> 00:36:02,920
it's for your company site and now

1017
00:36:02,920 --> 00:36:04,840
whenever someone goes to that valid

1018
00:36:04,840 --> 00:36:06,520
company site they're getting redirected

1019
00:36:06,520 --> 00:36:09,340
to the attackers controlled name server

1020
00:36:09,340 --> 00:36:11,710
attackers are called DNS server however

1021
00:36:11,710 --> 00:36:14,760
you want to put it and then obviously

1022
00:36:14,760 --> 00:36:16,780
depending on how sophisticated they were

1023
00:36:16,780 --> 00:36:18,430
when you connect it sometimes they have

1024
00:36:18,430 --> 00:36:20,590
self-signed search other instances here

1025
00:36:20,590 --> 00:36:22,030
one of the interesting thing that they

1026
00:36:22,030 --> 00:36:25,570
would also do is that all the people

1027
00:36:25,570 --> 00:36:28,240
that generate certificates these

1028
00:36:28,240 --> 00:36:30,880
companies are not all created equal some

1029
00:36:30,880 --> 00:36:32,320
of them do less authentication than

1030
00:36:32,320 --> 00:36:34,120
others and in this case a lot of times

1031
00:36:34,120 --> 00:36:36,730
they would see who you had your

1032
00:36:36,730 --> 00:36:39,040
certificate with and then they would go

1033
00:36:39,040 --> 00:36:41,800
to a competing certificate registrar a

1034
00:36:41,800 --> 00:36:42,910
few of the ones who issue the

1035
00:36:42,910 --> 00:36:45,220
certificates and actually request a

1036
00:36:45,220 --> 00:36:48,190
certificate for this company site and in

1037
00:36:48,190 --> 00:36:50,320
many instances there wasn't enough

1038
00:36:50,320 --> 00:36:51,730
checking done that they actually had a

1039
00:36:51,730 --> 00:36:54,880
valid cert for your domain so when they

1040
00:36:54,880 --> 00:36:57,070
stood up their fake server it looked

1041
00:36:57,070 --> 00:36:59,440
totally legit so obviously they would

1042
00:36:59,440 --> 00:37:02,830
let people come in it looked pretty you

1043
00:37:02,830 --> 00:37:04,480
know legitimate people would log in give

1044
00:37:04,480 --> 00:37:05,290
their credentials

1045
00:37:05,290 --> 00:37:07,300
they'd pass you on to legitimate site

1046
00:37:07,300 --> 00:37:09,880
but now they actually have actual

1047
00:37:09,880 --> 00:37:12,370
credentials for the targeted network so

1048
00:37:12,370 --> 00:37:13,720
they could come in really under the

1049
00:37:13,720 --> 00:37:15,310
radar because they're not even trying to

1050
00:37:15,310 --> 00:37:16,540
break in because they have valid

1051
00:37:16,540 --> 00:37:21,070
credentials to start with one of the

1052
00:37:21,070 --> 00:37:23,320
things that was really I wanna say

1053
00:37:23,320 --> 00:37:25,480
interesting and sort of scary at the

1054
00:37:25,480 --> 00:37:27,610
same time when this one happened most of

1055
00:37:27,610 --> 00:37:28,840
the time you know whenever we find these

1056
00:37:28,840 --> 00:37:30,340
into attacks we'll publish about it on

1057
00:37:30,340 --> 00:37:31,750
our blog we'll let everybody in the

1058
00:37:31,750 --> 00:37:33,910
world know about it and most of the time

1059
00:37:33,910 --> 00:37:36,930
the attacker is when they see that

1060
00:37:36,930 --> 00:37:39,089
we'll sort of back off they'll take a

1061
00:37:39,089 --> 00:37:41,040
pause and go people are watching this

1062
00:37:41,040 --> 00:37:45,180
I'm when I like scurry into the dark I

1063
00:37:45,180 --> 00:37:48,000
don't want to be seen when we published

1064
00:37:48,000 --> 00:37:50,790
on this one these guys didn't cool off

1065
00:37:50,790 --> 00:37:52,349
at all they sort of increase what they

1066
00:37:52,349 --> 00:37:53,700
were doing they could care less they

1067
00:37:53,700 --> 00:37:56,130
were just like we don't care we're gonna

1068
00:37:56,130 --> 00:37:58,170
keep doing what we're doing so they were

1069
00:37:58,170 --> 00:37:59,970
really scary it was one of those that

1070
00:37:59,970 --> 00:38:02,099
they were aggressively going after their

1071
00:38:02,099 --> 00:38:03,690
targets and they could care less whether

1072
00:38:03,690 --> 00:38:06,059
people talked about it or publicized it

1073
00:38:06,059 --> 00:38:07,440
at all they were still going to keep

1074
00:38:07,440 --> 00:38:09,869
doing their targeting which was really a

1075
00:38:09,869 --> 00:38:11,339
scary thing because we hadn't seen that

1076
00:38:11,339 --> 00:38:13,500
in the past most of the time they'd

1077
00:38:13,500 --> 00:38:16,440
always at least cool off for a while but

1078
00:38:16,440 --> 00:38:18,180
this time they didn't pause at all they

1079
00:38:18,180 --> 00:38:20,309
just kept moving forward with detects

1080
00:38:20,309 --> 00:38:23,700
that they were doing and you know I

1081
00:38:23,700 --> 00:38:25,140
mentioned they did different search and

1082
00:38:25,140 --> 00:38:26,579
things but one of the really you know

1083
00:38:26,579 --> 00:38:28,559
things that they really came across here

1084
00:38:28,559 --> 00:38:31,440
was you know that was the other side of

1085
00:38:31,440 --> 00:38:33,450
it being able to make it look legitimate

1086
00:38:33,450 --> 00:38:36,059
they didn't just pause that redirecting

1087
00:38:36,059 --> 00:38:37,920
you with a man-in-the-middle attack they

1088
00:38:37,920 --> 00:38:40,200
wanted to make it look as legitimate as

1089
00:38:40,200 --> 00:38:41,940
possible because that was their key is

1090
00:38:41,940 --> 00:38:43,079
they were trying to steal it without

1091
00:38:43,079 --> 00:38:46,140
anybody even being the wiser and in many

1092
00:38:46,140 --> 00:38:48,000
cases they were very successful at doing

1093
00:38:48,000 --> 00:38:51,900
that and sometimes they basically went

1094
00:38:51,900 --> 00:38:55,230
through so good at it that they were

1095
00:38:55,230 --> 00:38:57,119
actually targeting a lot of the VPN

1096
00:38:57,119 --> 00:38:59,430
endpoints that people set up to VPN into

1097
00:38:59,430 --> 00:39:01,670
their network so they would actually

1098
00:39:01,670 --> 00:39:04,650
either set up that initial fake one get

1099
00:39:04,650 --> 00:39:06,299
on the network and still legitimate

1100
00:39:06,299 --> 00:39:07,680
certs but they would actually set up

1101
00:39:07,680 --> 00:39:09,630
endpoints that look just like their

1102
00:39:09,630 --> 00:39:11,970
legitimate VPN endpoint so you would

1103
00:39:11,970 --> 00:39:15,630
actually be peeing in into the attackers

1104
00:39:15,630 --> 00:39:17,790
controlled network to get into your own

1105
00:39:17,790 --> 00:39:20,040
network which meant they were actually

1106
00:39:20,040 --> 00:39:21,660
getting those valid certain you know

1107
00:39:21,660 --> 00:39:23,790
valent credentials to get onto the

1108
00:39:23,790 --> 00:39:26,010
network but people were felt safe I mean

1109
00:39:26,010 --> 00:39:28,589
when people get into their VPN hey I'm

1110
00:39:28,589 --> 00:39:30,720
happy now that's my safe spot they

1111
00:39:30,720 --> 00:39:32,700
weren't thinking that it was a fake VPN

1112
00:39:32,700 --> 00:39:34,230
endpoint because these guys had him

1113
00:39:34,230 --> 00:39:36,480
personally did so well and that's the

1114
00:39:36,480 --> 00:39:38,250
scary part is they sort of raised the

1115
00:39:38,250 --> 00:39:40,799
game and really did a much more

1116
00:39:40,799 --> 00:39:42,809
interesting attack to you know trick

1117
00:39:42,809 --> 00:39:44,760
people into giving away their data their

1118
00:39:44,760 --> 00:39:48,950
valuable credentials so I mean you know

1119
00:39:48,950 --> 00:39:50,790
I'd like to say there was

1120
00:39:50,790 --> 00:39:52,950
easy solution to this you know I don't

1121
00:39:52,950 --> 00:39:54,090
think it's going to go away tomorrow

1122
00:39:54,090 --> 00:39:56,340
because as I said as people see this the

1123
00:39:56,340 --> 00:39:57,960
Pyrrhus keep up in their game they keep

1124
00:39:57,960 --> 00:40:00,060
one to do things that other people have

1125
00:40:00,060 --> 00:40:02,430
already done one of the basics is

1126
00:40:02,430 --> 00:40:04,590
obviously if you have a register account

1127
00:40:04,590 --> 00:40:07,470
you know make sure you have strong

1128
00:40:07,470 --> 00:40:09,420
credentials on it have to factor if you

1129
00:40:09,420 --> 00:40:11,340
can that sort of depends on who your

1130
00:40:11,340 --> 00:40:13,560
registrar is some people offer it some

1131
00:40:13,560 --> 00:40:15,840
people don't but the more you can secure

1132
00:40:15,840 --> 00:40:17,910
that account the better you are the more

1133
00:40:17,910 --> 00:40:20,250
you can monitor that you know if you get

1134
00:40:20,250 --> 00:40:22,170
a multi-factor that's great just

1135
00:40:22,170 --> 00:40:24,300
monitoring it to see if it's changing is

1136
00:40:24,300 --> 00:40:26,340
my IP address being redirected to a new

1137
00:40:26,340 --> 00:40:28,590
IP address I mean because it's not an

1138
00:40:28,590 --> 00:40:31,080
easy task to do because some of these

1139
00:40:31,080 --> 00:40:32,940
attacks we've seen especially with sea

1140
00:40:32,940 --> 00:40:35,760
turtle they would redirect it in a very

1141
00:40:35,760 --> 00:40:37,530
small window I mean they may have

1142
00:40:37,530 --> 00:40:39,480
redirected for five or ten minutes and

1143
00:40:39,480 --> 00:40:41,070
then they switched it back to the

1144
00:40:41,070 --> 00:40:43,410
legitimate name server so they were

1145
00:40:43,410 --> 00:40:45,930
really doing some very targeted short

1146
00:40:45,930 --> 00:40:48,630
term attacks to gain what they were

1147
00:40:48,630 --> 00:40:50,910
trying to gain but the biggest thing is

1148
00:40:50,910 --> 00:40:53,100
you know keeping the system's patched

1149
00:40:53,100 --> 00:40:54,870
you know age-old thing we talked about

1150
00:40:54,870 --> 00:40:56,910
patching all the time but the main thing

1151
00:40:56,910 --> 00:40:59,940
is don't take dns for granted we have to

1152
00:40:59,940 --> 00:41:02,460
have it to run our networks but you need

1153
00:41:02,460 --> 00:41:04,920
to start looking at DNS monitor the

1154
00:41:04,920 --> 00:41:06,510
activity see what's happening just

1155
00:41:06,510 --> 00:41:08,700
because that's none of those key data

1156
00:41:08,700 --> 00:41:10,140
points just like the logs on your

1157
00:41:10,140 --> 00:41:12,840
network DNS has becoming that vital log

1158
00:41:12,840 --> 00:41:14,880
that you can't forget you've got to look

1159
00:41:14,880 --> 00:41:16,800
at it to see what's happening because

1160
00:41:16,800 --> 00:41:17,850
it's always going to give you an

1161
00:41:17,850 --> 00:41:19,110
indication that maybe it's another

1162
00:41:19,110 --> 00:41:20,910
vector that the attackers are using to

1163
00:41:20,910 --> 00:41:24,060
try and get into your network so with

1164
00:41:24,060 --> 00:41:26,690
that I think we're pretty much done

1165
00:41:26,690 --> 00:41:29,370
hopefully it was useful enjoyable we'll

1166
00:41:29,370 --> 00:41:31,020
be around you can ask us any questions

1167
00:41:31,020 --> 00:41:32,760
you have any time just hit us up with

1168
00:41:32,760 --> 00:41:34,520
the booth whatever see us walking around

1169
00:41:34,520 --> 00:41:37,320
happy to talk about this I'll go ping

1170
00:41:37,320 --> 00:41:38,790
Warren make him answer all the questions

1171
00:41:38,790 --> 00:41:43,680
but that I'll let him switch this on

1172
00:41:43,680 --> 00:41:45,150
because I think we're going to the next

1173
00:41:45,150 --> 00:41:46,410
time

1174
00:41:46,410 --> 00:41:48,160
[Applause]

1175
00:41:48,160 --> 00:41:50,220
you

