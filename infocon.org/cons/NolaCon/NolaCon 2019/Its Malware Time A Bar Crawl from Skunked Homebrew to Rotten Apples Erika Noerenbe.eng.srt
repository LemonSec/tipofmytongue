1
00:00:01,820 --> 00:00:09,510
test yeah good all right I'm going to go

2
00:00:06,150 --> 00:00:11,940
ahead and get started so my name is

3
00:00:09,510 --> 00:00:15,059
Erica nürnberg and I'm gonna be talking

4
00:00:11,940 --> 00:00:16,198
about some malware the researched

5
00:00:15,059 --> 00:00:21,240
recently over the last few months

6
00:00:16,199 --> 00:00:25,949
college flare now it's not working

7
00:00:21,240 --> 00:00:37,860
that's fantastic of course you test it

8
00:00:25,949 --> 00:00:40,410
and then it stops gonna be manual all

9
00:00:37,860 --> 00:00:42,030
right so I'm gonna be talking about the

10
00:00:40,410 --> 00:00:44,099
smell where I wanted to talk about how

11
00:00:42,030 --> 00:00:47,430
it started before digging into the

12
00:00:44,100 --> 00:00:48,450
details about it and then we'll just

13
00:00:47,430 --> 00:00:49,920
talk about some detection prevention

14
00:00:48,450 --> 00:00:52,110
stuff and we'll have some time for

15
00:00:49,920 --> 00:00:55,199
questions there we go now it started

16
00:00:52,110 --> 00:00:57,059
working so Who am I like I said Eric

17
00:00:55,199 --> 00:01:00,239
nürnberg I've been in the security

18
00:00:57,059 --> 00:01:01,980
industry for a while now started out

19
00:01:00,239 --> 00:01:03,709
mostly like digital forensics and

20
00:01:01,980 --> 00:01:07,920
reverse engineering also did some

21
00:01:03,710 --> 00:01:12,180
firmware analysis and iOS program in

22
00:01:07,920 --> 00:01:13,650
fact a long time ago iOS 5 that's been a

23
00:01:12,180 --> 00:01:16,439
while I've been at carbon block for

24
00:01:13,650 --> 00:01:19,890
about a year before that I was at a

25
00:01:16,439 --> 00:01:22,559
company called logarithm and but spent a

26
00:01:19,890 --> 00:01:24,600
few years before that at the at DC 3

27
00:01:22,560 --> 00:01:27,030
which is the defense cybercrime Center

28
00:01:24,600 --> 00:01:29,119
in there intrusions Department which we

29
00:01:27,030 --> 00:01:33,930
basically investigated defense network

30
00:01:29,119 --> 00:01:36,479
intrusions so any sort of baby either

31
00:01:33,930 --> 00:01:38,790
federal entity or some of the did

32
00:01:36,479 --> 00:01:40,590
partners at defense industrial base your

33
00:01:38,790 --> 00:01:43,110
Lockheed your Boeing you know those

34
00:01:40,590 --> 00:01:45,479
types of people if they had some sort of

35
00:01:43,110 --> 00:01:48,329
intrusion they would send us the malware

36
00:01:45,479 --> 00:01:50,100
or the systems to investigate do you do

37
00:01:48,329 --> 00:01:54,360
forensics and malware analysis on them

38
00:01:50,100 --> 00:01:56,250
and my twitter handle is guttural but if

39
00:01:54,360 --> 00:01:59,310
you can find by name somewhere or

40
00:01:56,250 --> 00:02:01,200
remember how to spell it possibly if you

41
00:01:59,310 --> 00:02:05,700
google me I'm literally the only Erica

42
00:02:01,200 --> 00:02:08,319
nürnberg so it's kind of hard to hide

43
00:02:05,700 --> 00:02:08,800
so back in November this is how this all

44
00:02:08,318 --> 00:02:10,568
started

45
00:02:08,800 --> 00:02:12,489
I'm sitting on my couch my husband and

46
00:02:10,568 --> 00:02:14,619
I've got a Manhattan we're watching a

47
00:02:12,489 --> 00:02:16,510
movie or something and my phone lights

48
00:02:14,620 --> 00:02:18,670
up with a slack notification from my

49
00:02:16,510 --> 00:02:20,260
coworker and so Jimmy sends me this

50
00:02:18,670 --> 00:02:22,000
message he's like he's an avid home

51
00:02:20,260 --> 00:02:24,849
brewer and say son Dean I was looking

52
00:02:22,000 --> 00:02:26,470
for this beer recipe the stout recipe

53
00:02:24,849 --> 00:02:28,268
and I stumbled on this thing that's

54
00:02:26,470 --> 00:02:32,830
serving out these fake what looked like

55
00:02:28,269 --> 00:02:34,690
fake flash download downloads and so

56
00:02:32,830 --> 00:02:37,090
it's you know asking him to install a

57
00:02:34,690 --> 00:02:38,799
flash update it's like yeah this is

58
00:02:37,090 --> 00:02:40,599
probably not where thanks for turning me

59
00:02:38,799 --> 00:02:41,739
on to it so I kind of pulled the few

60
00:02:40,599 --> 00:02:43,540
down looked at us like yeah this is

61
00:02:41,739 --> 00:02:46,540
definitely malware what are we gonna do

62
00:02:43,540 --> 00:02:48,940
with this and say sent me the site again

63
00:02:46,540 --> 00:02:51,069
he said look at this whole site this

64
00:02:48,940 --> 00:02:53,109
whole web site is owned so I started

65
00:02:51,069 --> 00:02:55,298
looking into it and I'm like this domain

66
00:02:53,110 --> 00:02:58,120
isn't even registered like it's expired

67
00:02:55,299 --> 00:03:04,030
yours expired so what's going on with

68
00:02:58,120 --> 00:03:07,810
all of this so over the months so that

69
00:03:04,030 --> 00:03:09,220
was back in November right didn't really

70
00:03:07,810 --> 00:03:12,160
have a lot of time or resources to

71
00:03:09,220 --> 00:03:14,139
develop you know to devote to this so

72
00:03:12,160 --> 00:03:15,459
kind of poked around it a few samples

73
00:03:14,139 --> 00:03:17,109
tried to see if there were some other

74
00:03:15,459 --> 00:03:18,549
sites or if I could find some stuff on

75
00:03:17,109 --> 00:03:20,349
virustotal but it didn't really have a

76
00:03:18,549 --> 00:03:22,750
whole lot of time we had a lot of stuff

77
00:03:20,349 --> 00:03:24,429
going on so I'd kind of come back around

78
00:03:22,750 --> 00:03:28,169
to it every few weeks just kind of check

79
00:03:24,430 --> 00:03:32,169
it out it was still serving stuff out

80
00:03:28,169 --> 00:03:35,829
December so January comes around and I'm

81
00:03:32,169 --> 00:03:38,560
I'm doing a blog post on wind tail which

82
00:03:35,829 --> 00:03:41,620
is another OSX malware and I stumble on

83
00:03:38,560 --> 00:03:44,290
this article from central one researcher

84
00:03:41,620 --> 00:03:46,120
Phillip Stokes that was about how wind

85
00:03:44,290 --> 00:03:48,910
tail and other malware will bypass

86
00:03:46,120 --> 00:03:51,519
gatekeeper in Mac OS so this is really

87
00:03:48,910 --> 00:03:54,010
interesting and then I noticed there was

88
00:03:51,519 --> 00:03:56,410
a little snippet of a script that was in

89
00:03:54,010 --> 00:03:59,828
his blog post and it wasn't really made

90
00:03:56,410 --> 00:04:01,120
much mention of in detail but he was in

91
00:03:59,829 --> 00:04:03,280
this wind tail article and I was like

92
00:04:01,120 --> 00:04:04,480
holy crap is this wind tail is this

93
00:04:03,280 --> 00:04:06,459
related to wind tail because that would

94
00:04:04,480 --> 00:04:07,840
be pretty big it's kind of like a you

95
00:04:06,459 --> 00:04:10,750
know I don't like the word nation-state

96
00:04:07,840 --> 00:04:12,940
uh you know an advanced actor targeted

97
00:04:10,750 --> 00:04:15,459
attack it's like wow we just happened to

98
00:04:12,940 --> 00:04:19,060
stumble on this is pretty big so this is

99
00:04:15,459 --> 00:04:21,800
the actual script that I had

100
00:04:19,060 --> 00:04:23,630
this is a blown up here so this is the

101
00:04:21,800 --> 00:04:25,870
one that from one of the samples that

102
00:04:23,630 --> 00:04:28,219
I'd pulled down from this homeroom site

103
00:04:25,870 --> 00:04:31,690
and it basically it's just a very simple

104
00:04:28,220 --> 00:04:36,740
bash script that will pull down this

105
00:04:31,690 --> 00:04:40,270
marsupials zip this particular domain

106
00:04:36,740 --> 00:04:42,830
was also serving out kittens zip and

107
00:04:40,270 --> 00:04:45,680
porcupines zip and you know any number

108
00:04:42,830 --> 00:04:47,840
of these things that contained Slayers I

109
00:04:45,680 --> 00:04:50,360
found out later but basically it does a

110
00:04:47,840 --> 00:04:52,130
curl just a simple curl command which if

111
00:04:50,360 --> 00:04:53,990
you're not familiar with it is just a

112
00:04:52,130 --> 00:04:55,460
command-line utility for downloading

113
00:04:53,990 --> 00:04:59,440
kind of like double you get if you're

114
00:04:55,460 --> 00:05:02,750
familiar with that as well for Mac and

115
00:04:59,440 --> 00:05:06,440
UNIX systems so very simple

116
00:05:02,750 --> 00:05:10,010
pulls down this zip file unzips it it's

117
00:05:06,440 --> 00:05:14,510
a dot app you know when uh sorry Mac OS

118
00:05:10,010 --> 00:05:16,310
app unzips it with a password removes

119
00:05:14,510 --> 00:05:18,830
the temporary stuff and then just open

120
00:05:16,310 --> 00:05:22,460
stab so that the user doesn't have to

121
00:05:18,830 --> 00:05:26,599
actually interact with it so here's the

122
00:05:22,460 --> 00:05:29,180
the clip from Philips article this is

123
00:05:26,600 --> 00:05:32,300
the the clip that he actually had put

124
00:05:29,180 --> 00:05:34,130
into his blog post and I mean it was

125
00:05:32,300 --> 00:05:35,780
almost verbatim the same thing kittens

126
00:05:34,130 --> 00:05:38,630
zip which I had actually this is a

127
00:05:35,780 --> 00:05:41,479
different I don't know what that IP

128
00:05:38,630 --> 00:05:43,520
address and resolved to at the time but

129
00:05:41,480 --> 00:05:50,660
I was able to pull down the same file

130
00:05:43,520 --> 00:05:52,190
from the aaww 799 domain as well so this

131
00:05:50,660 --> 00:05:54,110
gets me going I'm like this is really

132
00:05:52,190 --> 00:05:55,700
exciting right if we found something

133
00:05:54,110 --> 00:05:57,410
just stumbled on this thing that's like

134
00:05:55,700 --> 00:05:58,690
an advanced threat that'd be really

135
00:05:57,410 --> 00:06:02,000
awesome

136
00:05:58,690 --> 00:06:02,930
so like yes maybe this isn't just adware

137
00:06:02,000 --> 00:06:04,190
maybe it's actually something

138
00:06:02,930 --> 00:06:07,220
interesting because if you've ever done

139
00:06:04,190 --> 00:06:12,230
any malware analysis for Mac's almost

140
00:06:07,220 --> 00:06:14,330
all that is is actually a guerre so I

141
00:06:12,230 --> 00:06:17,090
went down the rabbit hole so that was on

142
00:06:14,330 --> 00:06:18,890
a Friday and I spent the rest of the

143
00:06:17,090 --> 00:06:20,239
evening basically pulling apart some of

144
00:06:18,890 --> 00:06:21,530
the samples that I'd found pulling down

145
00:06:20,240 --> 00:06:23,090
everything I could you know looking at

146
00:06:21,530 --> 00:06:26,119
virustotal just kind of trying to get an

147
00:06:23,090 --> 00:06:28,369
idea of this but I was talking to my

148
00:06:26,120 --> 00:06:30,200
coworker Greg and he's like why don't we

149
00:06:28,370 --> 00:06:31,300
try to script this to try to pull down

150
00:06:30,200 --> 00:06:33,159
as many samples

151
00:06:31,300 --> 00:06:37,330
so he threw together a Python script

152
00:06:33,160 --> 00:06:41,020
that basically uses selenium to automate

153
00:06:37,330 --> 00:06:45,070
loading the loading this one site and

154
00:06:41,020 --> 00:06:47,650
the site used a system of redirects and

155
00:06:45,070 --> 00:06:50,860
so we had to follow the redirects until

156
00:06:47,650 --> 00:06:53,679
we could detect that a flash update was

157
00:06:50,860 --> 00:06:55,750
being served out and then automatically

158
00:06:53,680 --> 00:06:57,070
pull down that payload and so this

159
00:06:55,750 --> 00:06:59,230
worked for a while

160
00:06:57,070 --> 00:07:01,750
basically what he would do once he

161
00:06:59,230 --> 00:07:04,450
decided that or once he determined that

162
00:07:01,750 --> 00:07:06,280
malicious site was found he had pulled

163
00:07:04,450 --> 00:07:08,920
down the URL pulled down the source code

164
00:07:06,280 --> 00:07:11,130
for the page take a screenshot of it and

165
00:07:08,920 --> 00:07:17,500
then try to download the payload as well

166
00:07:11,130 --> 00:07:20,080
so this was all automated so right

167
00:07:17,500 --> 00:07:25,240
around February that was a that was

168
00:07:20,080 --> 00:07:27,099
January again you know the the script

169
00:07:25,240 --> 00:07:29,470
kind of went cold because the actors you

170
00:07:27,100 --> 00:07:32,500
know from the time we first saw it in

171
00:07:29,470 --> 00:07:34,720
November they kept putting in more

172
00:07:32,500 --> 00:07:36,730
mitigations to try to keep people from

173
00:07:34,720 --> 00:07:39,280
pulling these things down automatically

174
00:07:36,730 --> 00:07:41,500
so at first they were detecting IP

175
00:07:39,280 --> 00:07:44,409
addresses so if the same IP address hit

176
00:07:41,500 --> 00:07:45,730
the site more than once and you know ten

177
00:07:44,410 --> 00:07:48,310
minutes or something like that it would

178
00:07:45,730 --> 00:07:51,670
redirect you to something else and then

179
00:07:48,310 --> 00:07:56,920
they put in some like CAPTCHAs they've

180
00:07:51,670 --> 00:07:59,080
put in detection for IP ranges you know

181
00:07:56,920 --> 00:08:00,190
this was continually evolving but we

182
00:07:59,080 --> 00:08:01,750
still didn't really think it was all

183
00:08:00,190 --> 00:08:02,980
that interesting because when I went

184
00:08:01,750 --> 00:08:05,230
down the rabbit hole wind tail I

185
00:08:02,980 --> 00:08:06,790
realized it's like okay no this is this

186
00:08:05,230 --> 00:08:10,060
actually isn't related I just misread

187
00:08:06,790 --> 00:08:13,360
the article this is something completely

188
00:08:10,060 --> 00:08:15,280
different but then in February we were

189
00:08:13,360 --> 00:08:17,740
like you know we've been looking at this

190
00:08:15,280 --> 00:08:19,450
thing for four months now and we haven't

191
00:08:17,740 --> 00:08:22,120
seen any sort of research about this

192
00:08:19,450 --> 00:08:23,590
anywhere else so we're gonna have to

193
00:08:22,120 --> 00:08:25,030
name this thing if we're gonna you know

194
00:08:23,590 --> 00:08:27,039
write a blog post about it if we're

195
00:08:25,030 --> 00:08:28,270
gonna do any sort of research we need to

196
00:08:27,040 --> 00:08:30,880
if we to be talking about this thing we

197
00:08:28,270 --> 00:08:32,650
need to name it so the original

198
00:08:30,880 --> 00:08:34,659
homebrewing set that we found it on was

199
00:08:32,650 --> 00:08:35,020
called double Doc's double as in the

200
00:08:34,659 --> 00:08:38,110
beer

201
00:08:35,020 --> 00:08:40,360
BBB e-l and at the time I was talking to

202
00:08:38,110 --> 00:08:43,240
we're having a heated debate about IPAs

203
00:08:40,360 --> 00:08:44,600
because a lot of people hate IPAs have

204
00:08:43,240 --> 00:08:46,580
very strong feelings about the

205
00:08:44,600 --> 00:08:50,030
and one of them used to be my coworker

206
00:08:46,580 --> 00:08:51,260
Brian Baskin who spoke earlier and so I

207
00:08:50,030 --> 00:08:53,000
just wanted to mess with him and I was

208
00:08:51,260 --> 00:08:54,350
like how about double IPA then I know

209
00:08:53,000 --> 00:08:57,560
doubles don't have anything to do with

210
00:08:54,350 --> 00:08:59,540
IPAs but I just wanted mess with him so

211
00:08:57,560 --> 00:09:06,619
we decided to call it double life here

212
00:08:59,540 --> 00:09:08,270
and so then it's like okay there's

213
00:09:06,620 --> 00:09:11,780
actually been this you know evolution

214
00:09:08,270 --> 00:09:14,060
going on and in February I was like oh I

215
00:09:11,780 --> 00:09:16,699
found this this article from a year ago

216
00:09:14,060 --> 00:09:18,410
from February 2018 where they had

217
00:09:16,700 --> 00:09:20,390
actually in Diego researchers had

218
00:09:18,410 --> 00:09:22,670
actually found this before and so they

219
00:09:20,390 --> 00:09:25,130
were calling it Schleyer I was like I

220
00:09:22,670 --> 00:09:28,189
think this is all the same thing I think

221
00:09:25,130 --> 00:09:31,490
we've probably got Slayer here this is

222
00:09:28,190 --> 00:09:35,270
not new unfortunately and here's the the

223
00:09:31,490 --> 00:09:36,890
article from in tego I was like maybe

224
00:09:35,270 --> 00:09:40,210
they're not just actually sophisticated

225
00:09:36,890 --> 00:09:45,430
it's just another version of this Slayer

226
00:09:40,210 --> 00:09:47,630
crap like so exciting and total bummer

227
00:09:45,430 --> 00:09:51,199
totally bummed we don't get to use the

228
00:09:47,630 --> 00:09:54,200
name double IPA and so our boss said you

229
00:09:51,200 --> 00:09:56,090
know maybe we can just say it's a

230
00:09:54,200 --> 00:09:59,930
different campaign you know it's the

231
00:09:56,090 --> 00:10:01,190
double IPA campaign from Slayer but when

232
00:09:59,930 --> 00:10:02,540
we started looking at the distribution

233
00:10:01,190 --> 00:10:03,560
methods and all these things it's like

234
00:10:02,540 --> 00:10:05,630
this has been an ongoing campaign

235
00:10:03,560 --> 00:10:06,709
clearly for the last year and they've

236
00:10:05,630 --> 00:10:08,030
just been spreading it out over

237
00:10:06,710 --> 00:10:10,640
different ad sites and things like that

238
00:10:08,030 --> 00:10:12,770
this was like we can't we can't use this

239
00:10:10,640 --> 00:10:15,949
name I mean we had the slack channel set

240
00:10:12,770 --> 00:10:20,390
up you know dedicated everything very

241
00:10:15,950 --> 00:10:22,340
exciting ya know so so it was a total

242
00:10:20,390 --> 00:10:24,350
bummer but you know it was still pretty

243
00:10:22,340 --> 00:10:27,980
cool because you know nobody had really

244
00:10:24,350 --> 00:10:29,480
talked about it for the past year aside

245
00:10:27,980 --> 00:10:31,880
from that one mention from Philip Stokes

246
00:10:29,480 --> 00:10:33,290
in his wind tail article which was from

247
00:10:31,880 --> 00:10:36,070
like I think November or something

248
00:10:33,290 --> 00:10:38,990
watched her so um

249
00:10:36,070 --> 00:10:40,940
despite the fact that this wasn't

250
00:10:38,990 --> 00:10:42,200
anything new we started looking as like

251
00:10:40,940 --> 00:10:44,000
well we thought this was some kind of

252
00:10:42,200 --> 00:10:46,760
this one-off thing but then it's like

253
00:10:44,000 --> 00:10:49,400
okay this is a large ad network that's

254
00:10:46,760 --> 00:10:51,230
serving out all these things this is is

255
00:10:49,400 --> 00:10:54,350
going a lot deeper than we thought at

256
00:10:51,230 --> 00:10:56,810
first so you know maybe we should take a

257
00:10:54,350 --> 00:10:57,950
look in our customers environment and as

258
00:10:56,810 --> 00:11:00,670
we did that it was like

259
00:10:57,950 --> 00:11:03,680
wow this thing is pervasive and

260
00:11:00,670 --> 00:11:05,750
especially for the fact that it actually

261
00:11:03,680 --> 00:11:08,030
requires user intervention we were very

262
00:11:05,750 --> 00:11:10,730
surprised to find how many infections

263
00:11:08,030 --> 00:11:14,150
that were actually were across the the

264
00:11:10,730 --> 00:11:15,530
base that we looked up so they said you

265
00:11:14,150 --> 00:11:18,110
know we really need to do something

266
00:11:15,530 --> 00:11:20,510
about this and get the word out and tell

267
00:11:18,110 --> 00:11:23,120
people how to get rid of it I put some

268
00:11:20,510 --> 00:11:24,080
detection in place so I'm going to talk

269
00:11:23,120 --> 00:11:26,870
a little bit about the technical

270
00:11:24,080 --> 00:11:28,970
analysis because you'll see why what

271
00:11:26,870 --> 00:11:32,000
makes this a little bit more difficult

272
00:11:28,970 --> 00:11:34,070
in terms of detection and remediation on

273
00:11:32,000 --> 00:11:36,020
the one hand it's very easy but on the

274
00:11:34,070 --> 00:11:38,120
other hand they've put protections into

275
00:11:36,020 --> 00:11:39,590
place that that make it a little bit

276
00:11:38,120 --> 00:11:45,260
more difficult for the analyst or for

277
00:11:39,590 --> 00:11:46,070
the you know the sock analyst so anyway

278
00:11:45,260 --> 00:11:48,260
what is it

279
00:11:46,070 --> 00:11:51,230
like I said it was initially discovered

280
00:11:48,260 --> 00:11:54,050
by researchers from NatGeo back in

281
00:11:51,230 --> 00:11:57,170
January of 2018 and then we saw it in

282
00:11:54,050 --> 00:11:58,310
November and started looking at it at

283
00:11:57,170 --> 00:12:00,800
that time we didn't know what the family

284
00:11:58,310 --> 00:12:03,560
was but then in February we saw this

285
00:12:00,800 --> 00:12:04,849
like crazy amount of infections and said

286
00:12:03,560 --> 00:12:06,530
you know we've got to do something about

287
00:12:04,850 --> 00:12:09,560
this and when I was looking into the

288
00:12:06,530 --> 00:12:10,939
malware further we found out my coworker

289
00:12:09,560 --> 00:12:14,719
Jimmy was doing a lot of work with mitre

290
00:12:10,940 --> 00:12:17,060
attack and the framework he does more

291
00:12:14,720 --> 00:12:18,320
like Applied Research stuff and I was

292
00:12:17,060 --> 00:12:20,750
telling him about this privilege

293
00:12:18,320 --> 00:12:22,430
escalation technique that it uses he's

294
00:12:20,750 --> 00:12:25,640
like you know we don't man we've been

295
00:12:22,430 --> 00:12:27,410
trying to put you know mitre attack IDs

296
00:12:25,640 --> 00:12:28,550
and things like that into our posts for

297
00:12:27,410 --> 00:12:30,910
customers because a lot of people are

298
00:12:28,550 --> 00:12:33,229
pulling those in and using them like

299
00:12:30,910 --> 00:12:35,750
well you know this doesn't really fit

300
00:12:33,230 --> 00:12:39,080
under any of the current attack IDs that

301
00:12:35,750 --> 00:12:42,020
are existing right now so we ended up

302
00:12:39,080 --> 00:12:45,440
actually applying to mitre writing it up

303
00:12:42,020 --> 00:12:47,660
for them and there's not an idea signed

304
00:12:45,440 --> 00:12:48,980
just yet but they have accepted it into

305
00:12:47,660 --> 00:12:54,560
the framework so there will be a

306
00:12:48,980 --> 00:12:58,100
privilege escalation attack ID coming I

307
00:12:54,560 --> 00:13:00,680
think in the next one probably maybe but

308
00:12:58,100 --> 00:13:02,600
it's basically based on an API called

309
00:13:00,680 --> 00:13:06,500
authorization execute with privileges

310
00:13:02,600 --> 00:13:09,380
which is a deprecated API in Mac OS but

311
00:13:06,500 --> 00:13:10,310
because it can be abused this way to

312
00:13:09,380 --> 00:13:12,680
gain

313
00:13:10,310 --> 00:13:16,790
to get root privileges basically on the

314
00:13:12,680 --> 00:13:19,930
system but nobody the so Apple

315
00:13:16,790 --> 00:13:22,819
deprecated this API and put a safer

316
00:13:19,930 --> 00:13:25,520
replacement in but nobody really wants

317
00:13:22,820 --> 00:13:27,589
to employ the safer one because it's

318
00:13:25,520 --> 00:13:29,660
apparently very hard to instrument and

319
00:13:27,589 --> 00:13:31,279
so they have to rewrite and refactor a

320
00:13:29,660 --> 00:13:33,439
lot of code in order to implement the

321
00:13:31,279 --> 00:13:35,270
safe version so a lot of people still

322
00:13:33,440 --> 00:13:37,580
use this and so they can't just

323
00:13:35,270 --> 00:13:39,430
completely cut this off this API because

324
00:13:37,580 --> 00:13:41,180
it would break practically all the

325
00:13:39,430 --> 00:13:46,969
programs that are out there right now

326
00:13:41,180 --> 00:13:49,339
okay so like I said before Gregg wrote

327
00:13:46,970 --> 00:13:51,080
this script to scrape the shite the

328
00:13:49,339 --> 00:13:53,270
sites that we knew that were serving out

329
00:13:51,080 --> 00:13:55,190
Slayer and then the selenium script

330
00:13:53,270 --> 00:13:58,430
would pull down the the samples pull

331
00:13:55,190 --> 00:14:00,050
down the code here's just his his script

332
00:13:58,430 --> 00:14:02,209
saying liya the pop-up is detected

333
00:14:00,050 --> 00:14:05,839
here's the URL we're gonna write all

334
00:14:02,210 --> 00:14:07,970
this stuff out to a file but like I said

335
00:14:05,839 --> 00:14:10,400
they were getting smarter and so by

336
00:14:07,970 --> 00:14:12,350
February they were actually hosting all

337
00:14:10,400 --> 00:14:18,170
of these payloads the final stage

338
00:14:12,350 --> 00:14:20,270
payloads on s3 on Amazon AWS so you know

339
00:14:18,170 --> 00:14:22,490
you're not gonna block Amazon in your

340
00:14:20,270 --> 00:14:26,630
environment right I mean most def shops

341
00:14:22,490 --> 00:14:27,980
are using not legitimately so they start

342
00:14:26,630 --> 00:14:29,660
doing this it's they start making it

343
00:14:27,980 --> 00:14:31,400
harder to determine these payloads and

344
00:14:29,660 --> 00:14:32,870
they moved things around on the screen

345
00:14:31,400 --> 00:14:33,400
so the selenium is not really working

346
00:14:32,870 --> 00:14:36,140
anymore

347
00:14:33,400 --> 00:14:40,069
and they started redirecting to this w

348
00:14:36,140 --> 00:14:41,210
w9 w ox comm which if you've ever seen

349
00:14:40,070 --> 00:14:43,190
one of the things if you've typed in

350
00:14:41,210 --> 00:14:45,050
something like a typed of your own in

351
00:14:43,190 --> 00:14:47,120
wrong and somebody's squatting on a

352
00:14:45,050 --> 00:14:50,270
mistyped domain you get this kind of

353
00:14:47,120 --> 00:14:52,910
like fake search page kind of thing so

354
00:14:50,270 --> 00:14:55,360
that's what they would redirect you if

355
00:14:52,910 --> 00:14:58,250
they thought that you were trying to

356
00:14:55,360 --> 00:15:00,800
work with system basically so we had set

357
00:14:58,250 --> 00:15:04,130
up a whole thing of rotating proxies to

358
00:15:00,800 --> 00:15:06,109
try to get around the IP range detection

359
00:15:04,130 --> 00:15:08,990
so we'd hop you know to different

360
00:15:06,110 --> 00:15:11,240
countries sleep for five minutes go to a

361
00:15:08,990 --> 00:15:14,120
new country tried it again but

362
00:15:11,240 --> 00:15:15,500
eventually this stopped working however

363
00:15:14,120 --> 00:15:17,150
like in the very beginning it actually

364
00:15:15,500 --> 00:15:18,500
was very successful so that first day

365
00:15:17,150 --> 00:15:20,810
that I ran the script that Greg and I

366
00:15:18,500 --> 00:15:23,980
were running it we're actually able to

367
00:15:20,810 --> 00:15:26,800
pull down I think about like 28 or 30

368
00:15:23,980 --> 00:15:29,320
samples just in a few hours from this

369
00:15:26,800 --> 00:15:32,829
site before they started putting the

370
00:15:29,320 --> 00:15:37,000
mitigations in place and out of that we

371
00:15:32,830 --> 00:15:40,360
had about 15 unique samples and it's a

372
00:15:37,000 --> 00:15:43,210
little hard to see here but basically we

373
00:15:40,360 --> 00:15:45,810
had separate they're identical hashes

374
00:15:43,210 --> 00:15:48,610
that were being served out on different

375
00:15:45,810 --> 00:15:50,380
different views like different sites so

376
00:15:48,610 --> 00:15:51,040
they would be they would change up how

377
00:15:50,380 --> 00:15:56,680
it looked

378
00:15:51,040 --> 00:15:58,180
which I'll show you in a little bit so

379
00:15:56,680 --> 00:15:59,829
here's an example this is one of those

380
00:15:58,180 --> 00:16:02,260
like fake search sites that you kind of

381
00:15:59,830 --> 00:16:04,990
see this is what you get redirected to

382
00:16:02,260 --> 00:16:17,800
if it thinks that you're trying to mess

383
00:16:04,990 --> 00:16:19,630
with it let's see I'm gonna know it's

384
00:16:17,800 --> 00:16:23,170
not gonna let me do that thought maybe

385
00:16:19,630 --> 00:16:26,650
we could see what happens but basically

386
00:16:23,170 --> 00:16:28,979
if you if you go to this site it'll

387
00:16:26,650 --> 00:16:31,720
either redirect you through a system of

388
00:16:28,980 --> 00:16:38,260
different ad network proxies or you'll

389
00:16:31,720 --> 00:16:39,850
get this this is dummy page here so the

390
00:16:38,260 --> 00:16:42,480
distribution as I said we first

391
00:16:39,850 --> 00:16:45,940
discovered it on this home brew site and

392
00:16:42,480 --> 00:16:49,750
we found that it was utilizing a whole

393
00:16:45,940 --> 00:16:53,560
network of expired domains to squat on

394
00:16:49,750 --> 00:16:55,660
and serve out these ads so it would take

395
00:16:53,560 --> 00:16:57,189
a legitimate domain that had legitimate

396
00:16:55,660 --> 00:17:00,040
content at one point the domain it

397
00:16:57,190 --> 00:17:03,280
expired and when you go to it again now

398
00:17:00,040 --> 00:17:06,250
it's it's got this add chain that will

399
00:17:03,280 --> 00:17:07,839
eventually take you to usually most of

400
00:17:06,250 --> 00:17:10,390
them were fake

401
00:17:07,839 --> 00:17:11,679
fake flash update installers so you

402
00:17:10,390 --> 00:17:13,240
would go to the site that you thought

403
00:17:11,680 --> 00:17:15,520
you know maybe you'd been to it six

404
00:17:13,240 --> 00:17:17,410
months ago maybe had it bookmarked from

405
00:17:15,520 --> 00:17:19,150
a long time ago you go to it again and

406
00:17:17,410 --> 00:17:21,730
it says oh hey you need to update your

407
00:17:19,150 --> 00:17:23,860
Flash to see this page again and so

408
00:17:21,730 --> 00:17:27,490
unfortunately a lot of people fall into

409
00:17:23,859 --> 00:17:30,370
this trap and so they install it so most

410
00:17:27,490 --> 00:17:32,890
of these some of them were some of them

411
00:17:30,370 --> 00:17:36,629
were also browser extensions so it would

412
00:17:32,890 --> 00:17:38,320
actually look like the Chrome browser

413
00:17:36,630 --> 00:17:41,590
extension store

414
00:17:38,320 --> 00:17:45,129
but in actuality there was there was

415
00:17:41,590 --> 00:17:46,990
another thing going on in underneath the

416
00:17:45,130 --> 00:17:49,720
other common distribution method for

417
00:17:46,990 --> 00:17:52,840
this was in cracked software so if you

418
00:17:49,720 --> 00:17:56,890
look at torrance for let's say somebody

419
00:17:52,840 --> 00:17:59,379
wants Photoshop they go to download a

420
00:17:56,890 --> 00:18:00,670
crack version of Photoshop because they

421
00:17:59,380 --> 00:18:04,210
don't want to pay for the license and

422
00:18:00,670 --> 00:18:05,950
they get surf with Claire instead some

423
00:18:04,210 --> 00:18:08,380
of these things especially the flash

424
00:18:05,950 --> 00:18:09,670
updates some of them will actually after

425
00:18:08,380 --> 00:18:11,710
installing the malware they will

426
00:18:09,670 --> 00:18:14,140
actually go through the additional

427
00:18:11,710 --> 00:18:16,600
installation of flash which is pretty

428
00:18:14,140 --> 00:18:19,570
funny because when you're going through

429
00:18:16,600 --> 00:18:22,270
the malware installation it'll actually

430
00:18:19,570 --> 00:18:24,580
say install complete and then you click

431
00:18:22,270 --> 00:18:29,530
again and it starts installing again to

432
00:18:24,580 --> 00:18:30,970
install the real flash like that people

433
00:18:29,530 --> 00:18:32,800
still fall for this so what I was

434
00:18:30,970 --> 00:18:33,970
looking into this domain thing we

435
00:18:32,800 --> 00:18:37,800
couldn't figure out you know there's no

436
00:18:33,970 --> 00:18:40,420
way to report abuse when there's no

437
00:18:37,800 --> 00:18:41,730
person running the website so like how

438
00:18:40,420 --> 00:18:45,850
do we tell these people that these

439
00:18:41,730 --> 00:18:47,710
websites are hijacked and you know it I

440
00:18:45,850 --> 00:18:52,060
was talking to somebody from Verisign

441
00:18:47,710 --> 00:18:53,080
and she said that companies like hosting

442
00:18:52,060 --> 00:18:56,200
companies like GoDaddy

443
00:18:53,080 --> 00:18:59,139
they get a list a huge list of all of

444
00:18:56,200 --> 00:19:00,430
these parked domains where they've there

445
00:18:59,140 --> 00:19:03,310
are people parking on these expired

446
00:19:00,430 --> 00:19:04,990
domains on a weekly or monthly basis I

447
00:19:03,310 --> 00:19:05,770
forget and it's up to them to do

448
00:19:04,990 --> 00:19:08,260
something about it

449
00:19:05,770 --> 00:19:09,760
so as you can imagine they don't really

450
00:19:08,260 --> 00:19:10,150
have a lot of incentive to do anything

451
00:19:09,760 --> 00:19:13,030
about it

452
00:19:10,150 --> 00:19:14,920
because you know it's just a domain

453
00:19:13,030 --> 00:19:16,690
sitting out there and in the ether they

454
00:19:14,920 --> 00:19:18,610
don't really have any incentive to shut

455
00:19:16,690 --> 00:19:21,490
these down so they pretty much just keep

456
00:19:18,610 --> 00:19:23,290
going and when I was researching this

457
00:19:21,490 --> 00:19:25,450
just about a month ago kind of preparing

458
00:19:23,290 --> 00:19:27,460
these slides I decided to get back to

459
00:19:25,450 --> 00:19:29,380
double docks again to this original site

460
00:19:27,460 --> 00:19:31,870
that we saw and I was looking at the

461
00:19:29,380 --> 00:19:34,030
page source and I noticed this that

462
00:19:31,870 --> 00:19:37,659
there was a bunch of CSS code for this

463
00:19:34,030 --> 00:19:40,120
parking parking crew net I was like what

464
00:19:37,660 --> 00:19:41,650
is this well it's apparently a there's

465
00:19:40,120 --> 00:19:44,560
something called domain errs this is

466
00:19:41,650 --> 00:19:45,810
completely outside of my expertise but

467
00:19:44,560 --> 00:19:48,159
there are these domain errs that

468
00:19:45,810 --> 00:19:50,620
specialize they will actually you'd

469
00:19:48,160 --> 00:19:51,370
actually pay them to park domains for

470
00:19:50,620 --> 00:19:54,370
you

471
00:19:51,370 --> 00:19:55,989
and so they will just give you a set of

472
00:19:54,370 --> 00:19:58,290
domains that you can put your ads or

473
00:19:55,990 --> 00:20:02,050
your you know whatever you want to on it

474
00:19:58,290 --> 00:20:05,649
so it's a huge industry apparently

475
00:20:02,050 --> 00:20:07,330
because they make money off of it so but

476
00:20:05,650 --> 00:20:13,030
there's really not at this point there's

477
00:20:07,330 --> 00:20:15,490
not really any good way to stop it so

478
00:20:13,030 --> 00:20:18,970
here's one sample site this is one of

479
00:20:15,490 --> 00:20:21,610
the things when you go to one of these

480
00:20:18,970 --> 00:20:24,460
ad sites this is a sample page that you

481
00:20:21,610 --> 00:20:28,120
would get redirected to so as you'll see

482
00:20:24,460 --> 00:20:30,550
it they actually utilize they take some

483
00:20:28,120 --> 00:20:33,760
user agent information from the system

484
00:20:30,550 --> 00:20:35,649
so that they can cater this to the

485
00:20:33,760 --> 00:20:38,590
particular person that's looking at the

486
00:20:35,650 --> 00:20:42,760
website so this knew that my system is

487
00:20:38,590 --> 00:20:44,699
10.14 it's mojave they tell me I'm

488
00:20:42,760 --> 00:20:47,500
infected and do you want to start a scan

489
00:20:44,700 --> 00:20:50,140
the interesting thing about this is that

490
00:20:47,500 --> 00:20:53,050
this entire page is actually completely

491
00:20:50,140 --> 00:20:54,700
valid all of these links are exactly

492
00:20:53,050 --> 00:20:56,590
what you would think they were go down

493
00:20:54,700 --> 00:20:58,179
here you can buy Apple care that'll

494
00:20:56,590 --> 00:21:00,159
actually take you to apples Apple care

495
00:20:58,179 --> 00:21:02,320
site where you can buy Apple care all of

496
00:21:00,160 --> 00:21:04,570
these links up here exactly as Apple

497
00:21:02,320 --> 00:21:06,100
site would be the only custom content is

498
00:21:04,570 --> 00:21:08,320
this right here so this is a good

499
00:21:06,100 --> 00:21:11,110
example of social engineering they're

500
00:21:08,320 --> 00:21:13,540
trying to make the page look as valid

501
00:21:11,110 --> 00:21:16,178
and believable to the user as possible

502
00:21:13,540 --> 00:21:17,350
you know not an uncommon thing but I

503
00:21:16,179 --> 00:21:18,670
thought this one was interesting because

504
00:21:17,350 --> 00:21:20,678
a lot of times they don't go to this

505
00:21:18,670 --> 00:21:24,580
much effort of actually mapping the

506
00:21:20,679 --> 00:21:25,870
entire page but you know it's it works

507
00:21:24,580 --> 00:21:28,120
people fall for it

508
00:21:25,870 --> 00:21:30,699
and so that's why the you you continue

509
00:21:28,120 --> 00:21:32,709
to see these things because the more

510
00:21:30,700 --> 00:21:34,090
believable it is you know the more

511
00:21:32,710 --> 00:21:37,510
likely that your user is going to click

512
00:21:34,090 --> 00:21:41,220
on it and Trust the content so here's

513
00:21:37,510 --> 00:21:43,960
just a few these are all the different

514
00:21:41,220 --> 00:21:45,520
examples of different pages that are

515
00:21:43,960 --> 00:21:47,710
serving out this malware this is all the

516
00:21:45,520 --> 00:21:49,660
same malware sometimes the same hashes

517
00:21:47,710 --> 00:21:51,429
sometimes different hashes but the same

518
00:21:49,660 --> 00:21:53,920
thing but they just make the pages look

519
00:21:51,429 --> 00:21:56,140
different so it's not you're not seeing

520
00:21:53,920 --> 00:21:58,059
the same thing over and over again and

521
00:21:56,140 --> 00:22:00,340
this here is one of the examples of the

522
00:21:58,059 --> 00:22:02,950
extensions that I was talking about so

523
00:22:00,340 --> 00:22:05,510
as you can see up here they can't see it

524
00:22:02,950 --> 00:22:11,850
but this is actually going to the Chrome

525
00:22:05,510 --> 00:22:15,660
Extension store Chrome Web Store so if

526
00:22:11,850 --> 00:22:18,418
you look at it at face value it says

527
00:22:15,660 --> 00:22:21,630
okay you know you need to add this to

528
00:22:18,419 --> 00:22:23,760
Chrome it's this legitimate extension

529
00:22:21,630 --> 00:22:25,320
and I didn't really think too much of it

530
00:22:23,760 --> 00:22:27,660
because I was focusing on the malware on

531
00:22:25,320 --> 00:22:29,879
the actual the dot apps and the flash

532
00:22:27,660 --> 00:22:32,700
updates and stuff but one time I was

533
00:22:29,880 --> 00:22:34,890
going back to my BMI and analysis VM and

534
00:22:32,700 --> 00:22:36,720
I was I just happened to move I was

535
00:22:34,890 --> 00:22:40,200
going to try to move this screen out of

536
00:22:36,720 --> 00:22:44,190
the way and I noticed that uh it's

537
00:22:40,200 --> 00:22:47,760
actually just a another window that's

538
00:22:44,190 --> 00:22:49,590
placed on top so so this is the actual

539
00:22:47,760 --> 00:22:51,929
Chrome Web Store but if you click down

540
00:22:49,590 --> 00:22:53,909
here on the the security check and

541
00:22:51,929 --> 00:22:55,860
you're you know try this again try my

542
00:22:53,910 --> 00:22:57,299
download again this is a completely

543
00:22:55,860 --> 00:22:58,678
separate page and this is actually the

544
00:22:57,299 --> 00:23:02,010
malware page back here this is double

545
00:22:58,679 --> 00:23:03,690
docks com I actually happened on this

546
00:23:02,010 --> 00:23:05,730
completely by accident because I wasn't

547
00:23:03,690 --> 00:23:08,160
even caring about the browser extensions

548
00:23:05,730 --> 00:23:11,390
at that point I was like oh alright

549
00:23:08,160 --> 00:23:14,669
so yeah social engineering at its best

550
00:23:11,390 --> 00:23:16,559
some of these samples also were actually

551
00:23:14,669 --> 00:23:19,380
had JavaScript than were bundled with

552
00:23:16,559 --> 00:23:21,360
crypto mining component this is just an

553
00:23:19,380 --> 00:23:22,679
illustration of one of the systems

554
00:23:21,360 --> 00:23:25,740
running this you can see this is kind of

555
00:23:22,679 --> 00:23:27,450
usual normal behavior and once the

556
00:23:25,740 --> 00:23:32,720
Krypton mining component gets installed

557
00:23:27,450 --> 00:23:34,500
the CPU usage spikes the crypto mining

558
00:23:32,720 --> 00:23:39,120
components are a little bit harder to

559
00:23:34,500 --> 00:23:40,590
find but that's generally the first

560
00:23:39,120 --> 00:23:42,989
thing that that's kind of an indication

561
00:23:40,590 --> 00:23:45,360
that something's something's going wrong

562
00:23:42,990 --> 00:23:48,990
because your your usage goes way up

563
00:23:45,360 --> 00:23:51,049
I mean chrome is enough of a hog so you

564
00:23:48,990 --> 00:23:57,120
know you'd imagine it doesn't always

565
00:23:51,049 --> 00:24:00,809
flag for people but so the other

566
00:23:57,120 --> 00:24:02,399
interesting thing and I got in trouble

567
00:24:00,809 --> 00:24:05,040
for this the last time I talked about

568
00:24:02,400 --> 00:24:07,440
this but this is my coworker former

569
00:24:05,040 --> 00:24:09,780
coworker Adam and he hit me up

570
00:24:07,440 --> 00:24:11,970
a month or two ago he's like hey check

571
00:24:09,780 --> 00:24:13,889
this out I was just googling my name and

572
00:24:11,970 --> 00:24:17,549
look at this link down here at the

573
00:24:13,890 --> 00:24:18,390
bottom it's like oh yeah I went to it

574
00:24:17,549 --> 00:24:20,940
and I was like oh

575
00:24:18,390 --> 00:24:24,000
enough that's serving up Schleyer and my

576
00:24:20,940 --> 00:24:26,880
other co-worker Casey had said hey you

577
00:24:24,000 --> 00:24:28,440
know I was searching for Python 7-zip

578
00:24:26,880 --> 00:24:31,830
extract or something you know looking

579
00:24:28,440 --> 00:24:34,110
for some some code documentation and you

580
00:24:31,830 --> 00:24:37,110
know down halfway down the page of

581
00:24:34,110 --> 00:24:39,540
search results were was a random link

582
00:24:37,110 --> 00:24:42,120
that it'll actually show you it looks

583
00:24:39,540 --> 00:24:43,830
like you know something from Stack

584
00:24:42,120 --> 00:24:46,560
Overflow or something the description

585
00:24:43,830 --> 00:24:48,449
this one is is pretty fake looking but

586
00:24:46,560 --> 00:24:50,790
some of the ones that I found which

587
00:24:48,450 --> 00:24:53,100
unfortunately didn't screenshot it looks

588
00:24:50,790 --> 00:24:54,899
like a valid result that you would have

589
00:24:53,100 --> 00:24:56,459
you know maybe some code snippets are

590
00:24:54,900 --> 00:24:58,320
like a forum link or something like that

591
00:24:56,460 --> 00:25:03,690
but when you actually go to it it takes

592
00:24:58,320 --> 00:25:06,210
you one of these flash updates so they

593
00:25:03,690 --> 00:25:08,900
must it seems like they're paying for

594
00:25:06,210 --> 00:25:11,250
Adwords somehow working into it because

595
00:25:08,900 --> 00:25:14,160
as we've been watching out over the last

596
00:25:11,250 --> 00:25:16,050
month or so month or two you it'll be in

597
00:25:14,160 --> 00:25:19,110
completely random searches you know some

598
00:25:16,050 --> 00:25:21,510
things will show up and some things you

599
00:25:19,110 --> 00:25:23,219
know it's not it's all the links are

600
00:25:21,510 --> 00:25:25,080
valid but you never know so I don't

601
00:25:23,220 --> 00:25:27,360
really know how they're working that but

602
00:25:25,080 --> 00:25:31,730
it is pretty interesting that you'll

603
00:25:27,360 --> 00:25:33,959
just see these in random Google searches

604
00:25:31,730 --> 00:25:37,890
so I want to go through one of the

605
00:25:33,960 --> 00:25:39,630
samples and just briefly walk through

606
00:25:37,890 --> 00:25:40,890
the execution in this hour just so that

607
00:25:39,630 --> 00:25:43,980
you kind of have an understanding of

608
00:25:40,890 --> 00:25:45,600
what it's doing and how it works

609
00:25:43,980 --> 00:25:47,640
this one variant like I said there were

610
00:25:45,600 --> 00:25:50,879
several different types some of them

611
00:25:47,640 --> 00:25:53,760
were basically just bash scripts some of

612
00:25:50,880 --> 00:25:55,620
them were apps some of them or ISOs I'm

613
00:25:53,760 --> 00:25:57,180
going to take one that was we're gonna

614
00:25:55,620 --> 00:25:59,429
walk through one that was actually a dmg

615
00:25:57,180 --> 00:26:03,480
so if you're not real familiar with Mac

616
00:25:59,430 --> 00:26:05,340
disk dmg files are like a disk image

617
00:26:03,480 --> 00:26:07,590
that gets mounted and that usually has

618
00:26:05,340 --> 00:26:10,169
your installer in it to install an

619
00:26:07,590 --> 00:26:12,480
application so in this particular case

620
00:26:10,170 --> 00:26:15,240
this one had a dmg that once he mounted

621
00:26:12,480 --> 00:26:16,950
it and executed it there was a hidden

622
00:26:15,240 --> 00:26:18,750
directory that got created that

623
00:26:16,950 --> 00:26:22,500
contained a dot command file which is

624
00:26:18,750 --> 00:26:25,290
basically a script and there's multi

625
00:26:22,500 --> 00:26:27,180
layers of decoding an execution that

626
00:26:25,290 --> 00:26:29,340
occur before the final payload actually

627
00:26:27,180 --> 00:26:31,620
gets installed so the very first script

628
00:26:29,340 --> 00:26:32,280
actually decodes and decrypts another

629
00:26:31,620 --> 00:26:34,620
encoded

630
00:26:32,280 --> 00:26:38,040
tripped which decodes another embedded

631
00:26:34,620 --> 00:26:42,000
script which then also tries to download

632
00:26:38,040 --> 00:26:45,170
the final payload and execute it once

633
00:26:42,000 --> 00:26:48,390
that's actually executed it attempts to

634
00:26:45,170 --> 00:26:51,570
escalate privileges and get root on the

635
00:26:48,390 --> 00:26:54,540
system the most interesting thing to me

636
00:26:51,570 --> 00:26:56,460
about this were that all of the payloads

637
00:26:54,540 --> 00:26:58,830
the final payloads and the initial

638
00:26:56,460 --> 00:27:01,680
payloads all signed with valid developer

639
00:26:58,830 --> 00:27:04,770
IDs valid Apple Developer IDs valid

640
00:27:01,680 --> 00:27:06,450
certificates so you know gate keeper and

641
00:27:04,770 --> 00:27:08,879
your normal protections are kind of out

642
00:27:06,450 --> 00:27:10,770
if the user is going to authenticate

643
00:27:08,880 --> 00:27:12,210
against this nothing on the system is

644
00:27:10,770 --> 00:27:13,889
going to prevent it because it says

645
00:27:12,210 --> 00:27:15,330
you've got a valid certificate it's a

646
00:27:13,890 --> 00:27:17,340
valid developer you're not gonna get

647
00:27:15,330 --> 00:27:19,620
that pop-up if you use a Mac you know

648
00:27:17,340 --> 00:27:21,449
this was this application was not food

649
00:27:19,620 --> 00:27:23,070
you downloaded it from the internet it's

650
00:27:21,450 --> 00:27:24,780
not a valid developer ball-ball you're

651
00:27:23,070 --> 00:27:26,580
not gonna get that warning at all so

652
00:27:24,780 --> 00:27:30,210
people that's just one more step of

653
00:27:26,580 --> 00:27:35,820
saying trying to make it's not question

654
00:27:30,210 --> 00:27:37,530
time joke no they're actually

655
00:27:35,820 --> 00:27:39,629
registering them so I'll actually talk

656
00:27:37,530 --> 00:27:41,790
about that a little bit later but I did

657
00:27:39,630 --> 00:27:44,220
have a big discussion with Apple who was

658
00:27:41,790 --> 00:27:45,870
actually very helpful and I studied it I

659
00:27:44,220 --> 00:27:48,150
started trying to hunt down all these

660
00:27:45,870 --> 00:27:49,500
IDs because I was like okay well why

661
00:27:48,150 --> 00:27:52,020
don't I just go to virustotal

662
00:27:49,500 --> 00:27:54,210
and see if I can pull down some of these

663
00:27:52,020 --> 00:27:56,129
samples and it was very easy it's very

664
00:27:54,210 --> 00:27:57,420
easy to identify the samples but you

665
00:27:56,130 --> 00:27:59,250
start looking at I'm like I'm just gonna

666
00:27:57,420 --> 00:28:01,590
try to start harvesting these developer

667
00:27:59,250 --> 00:28:02,730
IDs and you start looking at it and it's

668
00:28:01,590 --> 00:28:04,320
almost like if you're familiar if

669
00:28:02,730 --> 00:28:05,970
anybody's familiar with malware in

670
00:28:04,320 --> 00:28:08,429
general you've heard of domain

671
00:28:05,970 --> 00:28:10,200
generation algorithms so basically it's

672
00:28:08,430 --> 00:28:13,260
a way of generating kind of a random

673
00:28:10,200 --> 00:28:15,510
domain for you so they can just kind of

674
00:28:13,260 --> 00:28:17,700
automatically generate these things the

675
00:28:15,510 --> 00:28:20,790
developer ID names were generated like

676
00:28:17,700 --> 00:28:22,260
that yes so they're very random sounding

677
00:28:20,790 --> 00:28:25,649
sometimes it'll be like a last name

678
00:28:22,260 --> 00:28:29,010
sounding for the first name there was

679
00:28:25,650 --> 00:28:32,280
like a Maxwell Brooklyn and you know did

680
00:28:29,010 --> 00:28:34,710
but I'll get a little bit more to that

681
00:28:32,280 --> 00:28:38,070
in a bit but that was one of the

682
00:28:34,710 --> 00:28:40,350
interesting things I thought so

683
00:28:38,070 --> 00:28:41,399
Apple had actually been revoking certs

684
00:28:40,350 --> 00:28:43,439
and they're they've been pretty good

685
00:28:41,400 --> 00:28:46,050
about revoking certs so they don't stay

686
00:28:43,440 --> 00:28:47,220
alive for very long but the

687
00:28:46,050 --> 00:28:50,010
the actual malware developers are

688
00:28:47,220 --> 00:28:52,620
churning them out so fast that you know

689
00:28:50,010 --> 00:28:53,370
they just recycle just make any certain

690
00:28:52,620 --> 00:28:54,840
make me sir

691
00:28:53,370 --> 00:28:57,120
so Apple haven't been revoking the

692
00:28:54,840 --> 00:28:58,649
developer IDs at the time but now

693
00:28:57,120 --> 00:29:00,510
they've actually started revoking the

694
00:28:58,650 --> 00:29:03,600
IDs as well because that one that I was

695
00:29:00,510 --> 00:29:05,850
talking about Maxwell Brooklyn I told

696
00:29:03,600 --> 00:29:08,669
them I was like you know this this ID

697
00:29:05,850 --> 00:29:11,280
has been signing this malware for close

698
00:29:08,670 --> 00:29:13,380
to a year now without being revoked yeah

699
00:29:11,280 --> 00:29:16,800
you're revoking the certs but the idea

700
00:29:13,380 --> 00:29:18,960
is still valid so I I'm hoping that some

701
00:29:16,800 --> 00:29:20,610
of this is going to be mitigated when

702
00:29:18,960 --> 00:29:25,740
they start they've actually just

703
00:29:20,610 --> 00:29:29,189
officially rolled out notarization so

704
00:29:25,740 --> 00:29:30,930
Apple now if you're a new developer you

705
00:29:29,190 --> 00:29:33,030
have to go through an additional step to

706
00:29:30,930 --> 00:29:35,550
notarize and get your application

707
00:29:33,030 --> 00:29:38,490
approved so hopefully that'll you know

708
00:29:35,550 --> 00:29:42,030
mitigate some of them go back to the

709
00:29:38,490 --> 00:29:44,040
malware so this is the an example of the

710
00:29:42,030 --> 00:29:45,680
first encoded script it's a little hard

711
00:29:44,040 --> 00:29:48,870
to see but basically you've got a giant

712
00:29:45,680 --> 00:29:52,080
chunk of this base64 encoded looking

713
00:29:48,870 --> 00:29:55,189
stuff and it's a very simple script that

714
00:29:52,080 --> 00:30:00,480
will base disk base64 decode and then

715
00:29:55,190 --> 00:30:02,280
decrypt this code for the that's will

716
00:30:00,480 --> 00:30:04,130
turn out to be the the second script and

717
00:30:02,280 --> 00:30:06,690
interesting thing is this password

718
00:30:04,130 --> 00:30:08,970
there's a password that's used with the

719
00:30:06,690 --> 00:30:11,310
decryption and it's actually hard-coded

720
00:30:08,970 --> 00:30:12,570
into all of these samples and when I was

721
00:30:11,310 --> 00:30:14,580
talking to a former colleague about it

722
00:30:12,570 --> 00:30:16,500
who's also been tracking this he said

723
00:30:14,580 --> 00:30:20,340
that it seems to be kind of like a

724
00:30:16,500 --> 00:30:22,770
timestamp decided type of related thing

725
00:30:20,340 --> 00:30:25,560
and if you track them when I looked back

726
00:30:22,770 --> 00:30:28,110
at the samples from over the months you

727
00:30:25,560 --> 00:30:29,790
can see that the number increases so I

728
00:30:28,110 --> 00:30:31,590
think that it's based on some sort of

729
00:30:29,790 --> 00:30:36,710
timestamp or something basically this is

730
00:30:31,590 --> 00:30:39,720
this is hard-coded per sample baby and

731
00:30:36,710 --> 00:30:40,980
so once you when you run this I'm going

732
00:30:39,720 --> 00:30:43,770
to be talking about behavior a little

733
00:30:40,980 --> 00:30:47,370
bit later so this happens to be just a

734
00:30:43,770 --> 00:30:49,530
clip from our product response just to

735
00:30:47,370 --> 00:30:52,919
show you the child processes but you'll

736
00:30:49,530 --> 00:30:55,620
see this base64 and open SSL it as an

737
00:30:52,920 --> 00:30:58,500
artifact of this execution for the first

738
00:30:55,620 --> 00:30:59,570
stage of encryption so this our decrypt

739
00:30:58,500 --> 00:31:03,300
oh sorry

740
00:30:59,570 --> 00:31:05,429
the first script so again so that that

741
00:31:03,300 --> 00:31:07,980
this second script is what's decoded by

742
00:31:05,430 --> 00:31:11,100
the first one again a big chunk of

743
00:31:07,980 --> 00:31:13,350
base64 that gets base64 decoded and then

744
00:31:11,100 --> 00:31:15,570
they actually use X X D which if you're

745
00:31:13,350 --> 00:31:20,219
not familiar is a command-line hex

746
00:31:15,570 --> 00:31:23,070
editor tool that's on UNIX and FreeBSD

747
00:31:20,220 --> 00:31:26,070
systems and so they use this basically

748
00:31:23,070 --> 00:31:28,110
to format and write out the third and

749
00:31:26,070 --> 00:31:30,629
final script before pulling down the

750
00:31:28,110 --> 00:31:32,610
final payload and so again you know that

751
00:31:30,630 --> 00:31:33,960
same screenshot you'll see the art of

752
00:31:32,610 --> 00:31:36,870
the process artifacts from this

753
00:31:33,960 --> 00:31:39,750
execution of the base64 the OpenSSL and

754
00:31:36,870 --> 00:31:43,530
the xxt which take when taken together

755
00:31:39,750 --> 00:31:50,400
is not a very common combination of

756
00:31:43,530 --> 00:31:51,750
things to run in a normal environment so

757
00:31:50,400 --> 00:31:54,150
this third script is actually just a

758
00:31:51,750 --> 00:31:55,770
pretty simple bash script more akin to

759
00:31:54,150 --> 00:31:57,810
that one that I showed at the very

760
00:31:55,770 --> 00:31:59,990
beginning they do a little bit more

761
00:31:57,810 --> 00:32:02,010
complicated stuff with checks and

762
00:31:59,990 --> 00:32:03,840
checking the volumes that are mounted

763
00:32:02,010 --> 00:32:06,710
and some different things like that but

764
00:32:03,840 --> 00:32:08,939
all in all it's doing the same thing is

765
00:32:06,710 --> 00:32:09,840
I'm gonna try to download the final

766
00:32:08,940 --> 00:32:11,850
payload which is is it

767
00:32:09,840 --> 00:32:13,889
password-protected zip again this

768
00:32:11,850 --> 00:32:16,679
password is the same password that was

769
00:32:13,890 --> 00:32:17,880
used in the first step the decryption or

770
00:32:16,680 --> 00:32:20,600
no I'm sorry that's a different password

771
00:32:17,880 --> 00:32:23,490
get back to the password thing later but

772
00:32:20,600 --> 00:32:27,600
basically it uses curl again to download

773
00:32:23,490 --> 00:32:32,700
a zip file it's gonna unzip this and

774
00:32:27,600 --> 00:32:36,120
that's an actual Mac App dot app it's

775
00:32:32,700 --> 00:32:37,770
going to open that and try to install

776
00:32:36,120 --> 00:32:40,469
them our and then it deletes everything

777
00:32:37,770 --> 00:32:45,150
that all the temporary files from before

778
00:32:40,470 --> 00:32:46,800
the zip and everything else so let's

779
00:32:45,150 --> 00:32:49,170
take a look at these URL components so

780
00:32:46,800 --> 00:32:53,490
this is actually what's passed in to

781
00:32:49,170 --> 00:32:57,510
curl you've got the the URL but then

782
00:32:53,490 --> 00:32:59,970
there's these components in the URL that

783
00:32:57,510 --> 00:33:02,490
are consistent across all these the

784
00:32:59,970 --> 00:33:05,010
samples of this malware so the first one

785
00:33:02,490 --> 00:33:07,470
we were calling a campaign ID this is

786
00:33:05,010 --> 00:33:09,230
not unique we tried for a while we

787
00:33:07,470 --> 00:33:11,970
thought well maybe there's some sort of

788
00:33:09,230 --> 00:33:13,020
these are based on target or some sort

789
00:33:11,970 --> 00:33:14,100
of campaign

790
00:33:13,020 --> 00:33:16,710
targeting certain people or certain

791
00:33:14,100 --> 00:33:19,740
industries or you know and so we started

792
00:33:16,710 --> 00:33:20,730
grouping all of these that we saw but we

793
00:33:19,740 --> 00:33:23,130
couldn't really find any sort of

794
00:33:20,730 --> 00:33:28,140
patterns I think it's just probably just

795
00:33:23,130 --> 00:33:32,250
a set campaign Aidid for a certain set

796
00:33:28,140 --> 00:33:35,730
of of hashes that are generated you the

797
00:33:32,250 --> 00:33:38,490
you equals is a unique ID for that

798
00:33:35,730 --> 00:33:40,410
system and it's based on IO platform

799
00:33:38,490 --> 00:33:42,960
unique ID so it's a basically something

800
00:33:40,410 --> 00:33:44,760
you can run from the that you can pull

801
00:33:42,960 --> 00:33:48,240
from the system information for a given

802
00:33:44,760 --> 00:33:50,220
host s similarly is another unique ID

803
00:33:48,240 --> 00:33:53,940
it's just we're calling a session ID

804
00:33:50,220 --> 00:33:56,160
that's just a straight results from

805
00:33:53,940 --> 00:33:58,860
running the command UUID gen from the

806
00:33:56,160 --> 00:34:01,440
command line and then you've got Oh

807
00:33:58,860 --> 00:34:03,870
which is the OS version and patch levels

808
00:34:01,440 --> 00:34:06,120
so this in this case it was ten dot 12.5

809
00:34:03,870 --> 00:34:06,719
and then that encryption key which is

810
00:34:06,120 --> 00:34:08,040
hard-coded

811
00:34:06,720 --> 00:34:09,659
so that's that password that I was

812
00:34:08,040 --> 00:34:11,040
talking about before so that actually

813
00:34:09,659 --> 00:34:13,440
gets passed into the URL as well

814
00:34:11,040 --> 00:34:17,219
something that the attackers can

815
00:34:13,440 --> 00:34:20,130
actually track this stuff so here's

816
00:34:17,219 --> 00:34:21,540
another look at the net connection again

817
00:34:20,130 --> 00:34:23,460
you'll see the actual call this is

818
00:34:21,540 --> 00:34:26,610
actually from a system that was infected

819
00:34:23,460 --> 00:34:29,310
and the actual call to curl and the

820
00:34:26,610 --> 00:34:32,669
execution of the malware itself but up

821
00:34:29,310 --> 00:34:35,549
here you can't read it here in this

822
00:34:32,668 --> 00:34:39,060
slide but you'll see in this is a

823
00:34:35,550 --> 00:34:43,169
screenshot from our our product it tells

824
00:34:39,060 --> 00:34:46,020
you this file is signed by domingus

825
00:34:43,168 --> 00:34:48,750
wha-wha so that's another developer

826
00:34:46,020 --> 00:34:53,070
ready yeah domingus wawa I don't think

827
00:34:48,750 --> 00:34:55,918
I've ever met a domingus but this

828
00:34:53,070 --> 00:34:57,990
actually comes through you can see the

829
00:34:55,918 --> 00:35:00,480
the check and the malware actually will

830
00:34:57,990 --> 00:35:03,689
before doing the final execution

831
00:35:00,480 --> 00:35:06,330
it will run SP CTL which is a command

832
00:35:03,690 --> 00:35:09,720
line program that will let you check the

833
00:35:06,330 --> 00:35:11,549
certificate status for given binary and

834
00:35:09,720 --> 00:35:13,560
so it'll actually run that itself and

835
00:35:11,550 --> 00:35:16,110
certificates been revoked it'll kill

836
00:35:13,560 --> 00:35:18,770
itself so it will not run if that

837
00:35:16,110 --> 00:35:21,540
particular sample has been revoked

838
00:35:18,770 --> 00:35:23,070
maybe so the interesting thing about

839
00:35:21,540 --> 00:35:25,710
that is when I started looking on

840
00:35:23,070 --> 00:35:26,460
virustotal you can find hundreds and

841
00:35:25,710 --> 00:35:31,470
hundreds of samples

842
00:35:26,460 --> 00:35:35,550
this daily daily different hashes every

843
00:35:31,470 --> 00:35:39,899
single sample uploaded exactly once so

844
00:35:35,550 --> 00:35:42,330
it seems as though the malware authors

845
00:35:39,900 --> 00:35:44,250
are actually just hitting virustotal

846
00:35:42,330 --> 00:35:46,500
to say okay am i getting detected is my

847
00:35:44,250 --> 00:35:48,570
stroked you know what's the status here

848
00:35:46,500 --> 00:35:50,640
and once they get you know a certain

849
00:35:48,570 --> 00:35:53,130
number sections then they can flip it

850
00:35:50,640 --> 00:35:55,140
use another developer ID generate new

851
00:35:53,130 --> 00:35:57,750
certificates generate new hashes and

852
00:35:55,140 --> 00:36:00,150
continue so they're continually hitting

853
00:35:57,750 --> 00:36:01,619
virustotal with these things and if you

854
00:36:00,150 --> 00:36:02,970
pull them down from virustotal

855
00:36:01,619 --> 00:36:06,450
a lot of times the certs have already

856
00:36:02,970 --> 00:36:08,660
been revoked even you know day later but

857
00:36:06,450 --> 00:36:12,419
apples been working really hard at

858
00:36:08,660 --> 00:36:16,170
getting control of that stuff so kudos

859
00:36:12,420 --> 00:36:19,619
to them now i wanted to talk a little

860
00:36:16,170 --> 00:36:23,359
bit about this privilege escalation so

861
00:36:19,619 --> 00:36:27,570
once that actual second stage is

862
00:36:23,359 --> 00:36:31,290
executed it tries to escalate privileges

863
00:36:27,570 --> 00:36:34,800
with sudo and invoking this tool called

864
00:36:31,290 --> 00:36:37,650
security off trampoline which as a

865
00:36:34,800 --> 00:36:39,900
result of running security off

866
00:36:37,650 --> 00:36:42,720
trampoline one side effect of that is

867
00:36:39,900 --> 00:36:45,270
that it invokes a program called UID

868
00:36:42,720 --> 00:36:49,109
which is a system utility but it's not

869
00:36:45,270 --> 00:36:51,150
something that's run on it on it's not

870
00:36:49,109 --> 00:36:52,859
something that you run from a command

871
00:36:51,150 --> 00:36:55,609
line it's more of something a utility

872
00:36:52,859 --> 00:36:58,319
that the system would use and so because

873
00:36:55,609 --> 00:36:59,970
security off trampoline is set UID root

874
00:36:58,320 --> 00:37:03,920
if you're familiar with like Linux or

875
00:36:59,970 --> 00:37:06,240
Mac this program is set UID root so one

876
00:37:03,920 --> 00:37:09,270
consequence of running security off

877
00:37:06,240 --> 00:37:11,640
trampoline is that this UID gets invoked

878
00:37:09,270 --> 00:37:14,430
as well and so if you see you know UID

879
00:37:11,640 --> 00:37:16,290
being run in your environment a lot of

880
00:37:14,430 --> 00:37:19,759
times it's it's going to be something to

881
00:37:16,290 --> 00:37:22,560
look into because we haven't found any

882
00:37:19,760 --> 00:37:25,130
sort of it's not a common thing that you

883
00:37:22,560 --> 00:37:28,049
would that would be associated with

884
00:37:25,130 --> 00:37:32,040
legitimate activity so that's kind of

885
00:37:28,050 --> 00:37:33,390
another behavioral indicator so I

886
00:37:32,040 --> 00:37:35,849
mentioned this briefly before the

887
00:37:33,390 --> 00:37:38,910
security are sorry authorization execute

888
00:37:35,849 --> 00:37:40,600
privileges API I'm not going to go into

889
00:37:38,910 --> 00:37:43,750
detail about this because it

890
00:37:40,600 --> 00:37:45,100
gets down into the weeds a lot and if

891
00:37:43,750 --> 00:37:49,240
you're familiar with Patrick Wartell

892
00:37:45,100 --> 00:37:52,630
he's a Mac security researcher and he

893
00:37:49,240 --> 00:37:55,450
did a very very good talk a couple years

894
00:37:52,630 --> 00:37:57,850
ago DEFCON 25 called death by a thousand

895
00:37:55,450 --> 00:37:59,439
installers highly recommended if you're

896
00:37:57,850 --> 00:38:03,190
interested in this kind of thing he goes

897
00:37:59,440 --> 00:38:05,080
goes into it in depth basically how the

898
00:38:03,190 --> 00:38:07,570
what happens behind the scenes when this

899
00:38:05,080 --> 00:38:09,100
API call gets called this is that

900
00:38:07,570 --> 00:38:13,540
deprecated API that I was talking about

901
00:38:09,100 --> 00:38:15,750
at the beginning maybe so as a result of

902
00:38:13,540 --> 00:38:18,880
this API that security australian gets

903
00:38:15,750 --> 00:38:21,220
triggered and set UID and that whole

904
00:38:18,880 --> 00:38:22,630
process I highly recommend that talk if

905
00:38:21,220 --> 00:38:27,580
if you're interested in that kind of

906
00:38:22,630 --> 00:38:30,880
thing so I just wanted to quickly to end

907
00:38:27,580 --> 00:38:33,759
up talk about how do we detect and

908
00:38:30,880 --> 00:38:36,550
prevent this because the the whole

909
00:38:33,760 --> 00:38:37,630
problem of the valid developer IDs it's

910
00:38:36,550 --> 00:38:39,820
going to get around your basic

911
00:38:37,630 --> 00:38:41,080
protections and if you're looking in

912
00:38:39,820 --> 00:38:43,870
your security products like when we

913
00:38:41,080 --> 00:38:45,840
first looked it was like well this isn't

914
00:38:43,870 --> 00:38:47,770
necessarily flagging it's not really

915
00:38:45,840 --> 00:38:49,240
standing out as something that's

916
00:38:47,770 --> 00:38:51,910
malicious behavior because you've got

917
00:38:49,240 --> 00:38:53,560
curl you've got xxd you've got all these

918
00:38:51,910 --> 00:38:55,600
you know wall bones the living off the

919
00:38:53,560 --> 00:38:57,940
land binaries they're all legitimate

920
00:38:55,600 --> 00:39:00,279
system applications just being used in a

921
00:38:57,940 --> 00:39:01,500
bad way so how do you actually detect

922
00:39:00,280 --> 00:39:05,470
this when you've got a valid certificate

923
00:39:01,500 --> 00:39:09,550
valid dev ID and you're using valid

924
00:39:05,470 --> 00:39:13,600
binaries so I've to go to the attack

925
00:39:09,550 --> 00:39:15,460
with look at re attack page but for the

926
00:39:13,600 --> 00:39:17,529
people that that we have a lot of

927
00:39:15,460 --> 00:39:19,410
customers that are relying on or using

928
00:39:17,530 --> 00:39:22,000
attack to kind of try to classify things

929
00:39:19,410 --> 00:39:24,759
these are some of the attack IDs that

930
00:39:22,000 --> 00:39:26,140
are involved the privilege escalation

931
00:39:24,760 --> 00:39:28,750
was the interesting one and like I said

932
00:39:26,140 --> 00:39:30,670
they have accepted it it'll probably be

933
00:39:28,750 --> 00:39:32,800
in the next release there's not an

934
00:39:30,670 --> 00:39:35,560
attack ID associated with it now but

935
00:39:32,800 --> 00:39:39,670
there should be probably in the next

936
00:39:35,560 --> 00:39:41,440
month but we've got execution defensive

937
00:39:39,670 --> 00:39:43,420
asian with the hidden bash scripts and

938
00:39:41,440 --> 00:39:46,090
things like that and then you know

939
00:39:43,420 --> 00:39:49,290
discovery with system data you know kind

940
00:39:46,090 --> 00:39:49,290
of system information gathering

941
00:39:49,650 --> 00:39:54,690
but the

942
00:39:51,990 --> 00:39:56,609
death by $1,000 was the talk that I was

943
00:39:54,690 --> 00:39:59,310
telling you about about with sorry by

944
00:39:56,610 --> 00:40:01,800
Patrick Wardle but basically when you

945
00:39:59,310 --> 00:40:03,779
when the second-stage payload the final

946
00:40:01,800 --> 00:40:07,020
stage of payload is executed the user

947
00:40:03,780 --> 00:40:09,210
has to authenticate so this isn't even

948
00:40:07,020 --> 00:40:11,009
though it's using this this API you

949
00:40:09,210 --> 00:40:12,360
don't get around the authentication it

950
00:40:11,010 --> 00:40:14,550
still does have to be authenticated and

951
00:40:12,360 --> 00:40:17,180
you do have to have an admin user so you

952
00:40:14,550 --> 00:40:19,710
can't actually mitigate this with

953
00:40:17,180 --> 00:40:22,290
restricting privileges on your systems

954
00:40:19,710 --> 00:40:25,770
but at least in my experience a lot of

955
00:40:22,290 --> 00:40:27,119
shops that are running Mac's give admin

956
00:40:25,770 --> 00:40:30,930
privileges to their users and they're

957
00:40:27,119 --> 00:40:33,720
not restricting it so if the user is

958
00:40:30,930 --> 00:40:35,069
going to install it then you know you're

959
00:40:33,720 --> 00:40:38,759
going to get this privilege escalation

960
00:40:35,070 --> 00:40:40,760
and sudden way now they've got work so

961
00:40:38,760 --> 00:40:43,500
even though this is actually ad where

962
00:40:40,760 --> 00:40:45,210
people say oh well it's just adware I

963
00:40:43,500 --> 00:40:47,040
don't really care it's not like it's

964
00:40:45,210 --> 00:40:50,970
malware it's not exfiltrating data off

965
00:40:47,040 --> 00:40:52,619
my system why do I care well you have to

966
00:40:50,970 --> 00:40:55,140
remember that this thing has root access

967
00:40:52,619 --> 00:40:57,210
and it can literally download so once

968
00:40:55,140 --> 00:41:00,990
the second the final stage is installed

969
00:40:57,210 --> 00:41:03,090
it will download additional adware and

970
00:41:00,990 --> 00:41:04,439
install it on the system so at any point

971
00:41:03,090 --> 00:41:06,510
in time it's got access it's got a

972
00:41:04,440 --> 00:41:09,530
backdoor to install whatever it wants to

973
00:41:06,510 --> 00:41:12,270
so in the hands of the right adversary

974
00:41:09,530 --> 00:41:14,070
you know if they've got all your system

975
00:41:12,270 --> 00:41:17,400
information they know you know anything

976
00:41:14,070 --> 00:41:20,070
about your system who's using it if

977
00:41:17,400 --> 00:41:22,140
there's a CEO because we know that a lot

978
00:41:20,070 --> 00:41:24,780
of a lot of the higher level people are

979
00:41:22,140 --> 00:41:25,680
the ones that are running backs if

980
00:41:24,780 --> 00:41:27,510
there's so many that they wanted

981
00:41:25,680 --> 00:41:28,649
targeted they've got all that system

982
00:41:27,510 --> 00:41:30,990
information they can say yeah that's

983
00:41:28,650 --> 00:41:33,180
that guy let's download something else

984
00:41:30,990 --> 00:41:35,040
onto his system you know personally I

985
00:41:33,180 --> 00:41:36,540
haven't seen it but it is something that

986
00:41:35,040 --> 00:41:39,869
could happen because they've got full

987
00:41:36,540 --> 00:41:41,400
system access so you know it's not

988
00:41:39,869 --> 00:41:43,680
something to be dismissed anything

989
00:41:41,400 --> 00:41:46,380
that's got root on the system should be

990
00:41:43,680 --> 00:41:48,810
a concern obviously but as far as

991
00:41:46,380 --> 00:41:50,609
behavioral indicators I talked a little

992
00:41:48,810 --> 00:41:56,250
bit about the xxd the openness I see

993
00:41:50,609 --> 00:42:00,029
open SSL and curl those by themselves

994
00:41:56,250 --> 00:42:01,940
you know xxd open SSL xxd probably used

995
00:42:00,030 --> 00:42:05,130
by a lot of your you know maybe devs

996
00:42:01,940 --> 00:42:05,670
people like that doing lower level stuff

997
00:42:05,130 --> 00:42:08,490
here

998
00:42:05,670 --> 00:42:10,349
environment not too uncommon OpenSSL

999
00:42:08,490 --> 00:42:11,549
also probably used by some of your

1000
00:42:10,349 --> 00:42:13,589
admins your sysadmin

1001
00:42:11,549 --> 00:42:16,920
to automate scrips automate things with

1002
00:42:13,589 --> 00:42:21,390
certs not uncommon curl also devs and

1003
00:42:16,920 --> 00:42:22,890
sysadmin you know used in automation but

1004
00:42:21,390 --> 00:42:25,710
the combination of the three of them

1005
00:42:22,890 --> 00:42:27,390
with base64 you have to start looking at

1006
00:42:25,710 --> 00:42:29,190
okay it's not this individual tool

1007
00:42:27,390 --> 00:42:30,750
itself but when I put these things

1008
00:42:29,190 --> 00:42:32,839
together that starts to paint a picture

1009
00:42:30,750 --> 00:42:36,140
of something bigger that's going on and

1010
00:42:32,839 --> 00:42:39,450
these don't necessarily make sense in

1011
00:42:36,140 --> 00:42:41,700
let's say you know somebody from the

1012
00:42:39,450 --> 00:42:44,549
sales department you know is probably

1013
00:42:41,700 --> 00:42:51,259
not running xxd and it's certainly not

1014
00:42:44,549 --> 00:42:51,259
XD base64 kernel and all of these things

1015
00:42:51,630 --> 00:42:56,490
UID again with in conjunction with

1016
00:42:54,240 --> 00:43:00,689
security off trampoline security off

1017
00:42:56,490 --> 00:43:03,720
happily and in this case is is a module

1018
00:43:00,690 --> 00:43:06,119
that's loaded by via Apple script and

1019
00:43:03,720 --> 00:43:08,790
it's from in this case I use a writable

1020
00:43:06,119 --> 00:43:10,140
location also not something that's going

1021
00:43:08,790 --> 00:43:11,579
to be common yes security I'll

1022
00:43:10,140 --> 00:43:13,290
trampoline by itself

1023
00:43:11,579 --> 00:43:16,400
yeah it's used you know it's it's

1024
00:43:13,290 --> 00:43:18,750
invoked by some applications when

1025
00:43:16,400 --> 00:43:24,960
isolating privileges but it's not not a

1026
00:43:18,750 --> 00:43:26,220
common thing in these in this context so

1027
00:43:24,960 --> 00:43:30,660
we said why don't we take one of these

1028
00:43:26,220 --> 00:43:31,770
things and can we figure out what the we

1029
00:43:30,660 --> 00:43:35,069
need to figure out some way to narrow

1030
00:43:31,770 --> 00:43:36,869
this down and identify where this this

1031
00:43:35,069 --> 00:43:38,700
malware is actually installed well we

1032
00:43:36,869 --> 00:43:40,829
can't look at any of these when we look

1033
00:43:38,700 --> 00:43:43,680
at any of these tools by themselves so

1034
00:43:40,829 --> 00:43:45,869
this in this case literally just saying

1035
00:43:43,680 --> 00:43:48,660
process name is curl like where is curl

1036
00:43:45,869 --> 00:43:50,250
running in my environment and if you

1037
00:43:48,660 --> 00:43:52,890
think of each one of these squares as a

1038
00:43:50,250 --> 00:43:55,319
cluster of machines so say that's you

1039
00:43:52,890 --> 00:43:59,040
know ten thousand machines each one of

1040
00:43:55,319 --> 00:44:02,220
these squares the darker the square the

1041
00:43:59,040 --> 00:44:04,710
more the higher percentage of those

1042
00:44:02,220 --> 00:44:06,899
machines are running this utility at

1043
00:44:04,710 --> 00:44:09,780
some point in the given time so I think

1044
00:44:06,900 --> 00:44:11,400
this was actually over a month so you

1045
00:44:09,780 --> 00:44:13,470
can see that there's quite heavy usage

1046
00:44:11,400 --> 00:44:18,540
across all these clusters of machines

1047
00:44:13,470 --> 00:44:21,629
for curl just in general they said well

1048
00:44:18,540 --> 00:44:25,920
this malware uses kind of interesting

1049
00:44:21,630 --> 00:44:28,230
and unusual command-line arguments to

1050
00:44:25,920 --> 00:44:30,300
curl so why don't we 0 and on that and

1051
00:44:28,230 --> 00:44:32,820
see how that changes like maybe we can

1052
00:44:30,300 --> 00:44:36,030
narrow it down at least and this turned

1053
00:44:32,820 --> 00:44:38,490
out to be a very very good high fidelity

1054
00:44:36,030 --> 00:44:41,160
indicator for this malware and continues

1055
00:44:38,490 --> 00:44:43,169
to be so basically we've still got the

1056
00:44:41,160 --> 00:44:46,200
process name of curl but we added the

1057
00:44:43,170 --> 00:44:48,200
command-line arguments of - s0l which is

1058
00:44:46,200 --> 00:44:51,569
what they run and you can see I mean

1059
00:44:48,200 --> 00:44:55,529
there's barely any and I can tell you

1060
00:44:51,570 --> 00:44:58,560
that these results 99% Schleyer there

1061
00:44:55,530 --> 00:45:01,020
were two - results that were not that

1062
00:44:58,560 --> 00:45:04,590
were false positives and it was download

1063
00:45:01,020 --> 00:45:06,120
if like a software a anti-virus update

1064
00:45:04,590 --> 00:45:08,760
for like a vast or something like that

1065
00:45:06,120 --> 00:45:11,460
but in every other case it was it was

1066
00:45:08,760 --> 00:45:13,970
the malware that was running so these

1067
00:45:11,460 --> 00:45:17,100
command-line options f fail silently

1068
00:45:13,970 --> 00:45:20,299
okay not so uncommon you know people

1069
00:45:17,100 --> 00:45:24,900
probably use that - zero though using

1070
00:45:20,300 --> 00:45:27,240
HTTP 1.0 so who's gonna restrict like

1071
00:45:24,900 --> 00:45:30,510
specifically restrict their curl

1072
00:45:27,240 --> 00:45:32,939
downloads to one HTTP one not very

1073
00:45:30,510 --> 00:45:35,190
common and then - l is to follow the

1074
00:45:32,940 --> 00:45:39,960
redirects because like I said you know

1075
00:45:35,190 --> 00:45:44,100
it was it was hopping so the combination

1076
00:45:39,960 --> 00:45:47,550
of the curl and these specific arguments

1077
00:45:44,100 --> 00:45:48,750
are very very high fidelity indicator so

1078
00:45:47,550 --> 00:45:52,470
this was just one of the ones that we

1079
00:45:48,750 --> 00:45:56,940
found this I just thought was hilarious

1080
00:45:52,470 --> 00:45:59,640
I saw this the other day so this is I

1081
00:45:56,940 --> 00:46:02,550
think this is actually regarding Adobe

1082
00:45:59,640 --> 00:46:04,830
sorry Acrobat but you can see all of

1083
00:46:02,550 --> 00:46:08,700
these see V's this is a list of how many

1084
00:46:04,830 --> 00:46:14,150
Seavey's so if you're not familiar of CB

1085
00:46:08,700 --> 00:46:17,069
it's a common vulnerability exploits

1086
00:46:14,150 --> 00:46:19,980
exploitable yeah basically it's all the

1087
00:46:17,070 --> 00:46:22,530
exploits there catalogs of exploits that

1088
00:46:19,980 --> 00:46:25,010
are available for a product so this is a

1089
00:46:22,530 --> 00:46:27,930
list in one Adobe update of how many

1090
00:46:25,010 --> 00:46:32,049
CBE's that are actually patched in one

1091
00:46:27,930 --> 00:46:34,509
update again this is Adobe Reader but or

1092
00:46:32,049 --> 00:46:37,679
bat but it applies to flash as well

1093
00:46:34,509 --> 00:46:39,729
flashes notorious for vulnerabilities

1094
00:46:37,679 --> 00:46:44,559
yeah they're all gone

1095
00:46:39,729 --> 00:46:45,759
yep so in this thread later a lot of you

1096
00:46:44,559 --> 00:46:47,410
if you follow Twitter you're probably

1097
00:46:45,759 --> 00:46:50,949
familiar with malware tech he was a guy

1098
00:46:47,410 --> 00:46:56,348
that discovered the kill switch for

1099
00:46:50,949 --> 00:46:59,049
wanna cry and is now facing prison but

1100
00:46:56,349 --> 00:47:00,699
he was said waiting for Patch Tuesday

1101
00:46:59,049 --> 00:47:02,170
and hoping that there will be something

1102
00:47:00,699 --> 00:47:03,069
other than what's up because if you've

1103
00:47:02,170 --> 00:47:05,410
been following the news

1104
00:47:03,069 --> 00:47:09,489
whatsapp had this big thing about you

1105
00:47:05,410 --> 00:47:11,558
know whatever and he said I'm not

1106
00:47:09,489 --> 00:47:12,309
talking I'm talking about Microsoft not

1107
00:47:11,559 --> 00:47:14,650
a duty

1108
00:47:12,309 --> 00:47:16,059
nobody cares about Adobe Acrobat is a

1109
00:47:14,650 --> 00:47:23,439
collection of vulnerabilities that

1110
00:47:16,059 --> 00:47:25,420
somehow also renders PDFs so true so

1111
00:47:23,439 --> 00:47:27,910
although this is talking about Acrobat

1112
00:47:25,420 --> 00:47:30,400
the same thing goes for flash you know

1113
00:47:27,910 --> 00:47:32,769
these days you know it's really not

1114
00:47:30,400 --> 00:47:34,509
needed when 99% the time you really

1115
00:47:32,769 --> 00:47:36,879
don't need flash and you shouldn't

1116
00:47:34,509 --> 00:47:38,769
install it so what's the takeaway well

1117
00:47:36,880 --> 00:47:41,229
number one don't install flash just

1118
00:47:38,769 --> 00:47:43,538
don't and if you have to install flash

1119
00:47:41,229 --> 00:47:45,968
get it from Adobe and make sure that

1120
00:47:43,539 --> 00:47:48,309
it's actually signed by Adobe right and

1121
00:47:45,969 --> 00:47:50,939
that's not still not failsafe but it's

1122
00:47:48,309 --> 00:47:54,339
gonna get a lot you know it's a lot

1123
00:47:50,939 --> 00:47:56,109
better than you know just downloading

1124
00:47:54,339 --> 00:47:57,640
from one of these things also you know

1125
00:47:56,109 --> 00:47:59,319
gatekeeper and ex protect are not going

1126
00:47:57,640 --> 00:48:01,348
to help you these are the gatekeeper

1127
00:47:59,319 --> 00:48:05,619
next protector the the Mac security

1128
00:48:01,349 --> 00:48:06,880
built-in system mitigations they're not

1129
00:48:05,619 --> 00:48:10,089
going to help you when something is

1130
00:48:06,880 --> 00:48:13,299
signed the certs are valid and the user

1131
00:48:10,089 --> 00:48:14,229
executes sit and authenticate sit you

1132
00:48:13,299 --> 00:48:16,689
can't get around that there's no

1133
00:48:14,229 --> 00:48:18,428
security control for that there's a huge

1134
00:48:16,689 --> 00:48:20,109
network of hydrogen hijack domains

1135
00:48:18,429 --> 00:48:21,759
websites and like I said there's

1136
00:48:20,109 --> 00:48:24,279
hundreds of these hashes being generated

1137
00:48:21,759 --> 00:48:27,249
daily so you can't chase these IO sees

1138
00:48:24,279 --> 00:48:29,019
you can't block like I said the nowadays

1139
00:48:27,249 --> 00:48:31,299
that one site they're serving it through

1140
00:48:29,019 --> 00:48:34,269
AWS you're not going to block Amazon you

1141
00:48:31,299 --> 00:48:36,279
to be us in your environment you can't

1142
00:48:34,269 --> 00:48:37,718
chase these domains and and try to

1143
00:48:36,279 --> 00:48:38,949
blacklist all this it's not going to

1144
00:48:37,719 --> 00:48:40,359
work so you have to rely on these

1145
00:48:38,949 --> 00:48:43,900
behavioral indicators like I talked

1146
00:48:40,359 --> 00:48:45,038
about so here's some links and I'm

1147
00:48:43,900 --> 00:48:45,890
actually going to be putting out a blog

1148
00:48:45,039 --> 00:48:48,800
post probably

1149
00:48:45,890 --> 00:48:51,500
next week we have a short one out there

1150
00:48:48,800 --> 00:48:53,540
for anybody that's actually carbon about

1151
00:48:51,500 --> 00:48:56,660
customers we have like carbon block

1152
00:48:53,540 --> 00:49:00,080
product specific mitigation stuff that's

1153
00:48:56,660 --> 00:49:02,569
that's in the user exchange and some

1154
00:49:00,080 --> 00:49:07,400
scripts and things but this is just all

1155
00:49:02,570 --> 00:49:09,290
the links again my handle Twitter is

1156
00:49:07,400 --> 00:49:11,810
gunner troll feel free to hit me up if

1157
00:49:09,290 --> 00:49:14,690
questions but I'd like to open it up if

1158
00:49:11,810 --> 00:49:31,480
anybody has questions in general we got

1159
00:49:14,690 --> 00:49:34,520
like a couple minutes yes yeah exactly

1160
00:49:31,480 --> 00:49:37,250
yes a he asked he said you know and this

1161
00:49:34,520 --> 00:49:38,990
is this was my thought initially an

1162
00:49:37,250 --> 00:49:41,750
apple developer idea is 100 dollars a

1163
00:49:38,990 --> 00:49:43,520
pop and all of these domains you know

1164
00:49:41,750 --> 00:49:45,740
you have to pay for all these things so

1165
00:49:43,520 --> 00:49:48,080
you can imagine how profitable this

1166
00:49:45,740 --> 00:49:51,259
thing must be in order for them to be

1167
00:49:48,080 --> 00:49:54,520
cycling through developer IDs domains

1168
00:49:51,260 --> 00:49:56,900
you know serving out all of these things

1169
00:49:54,520 --> 00:49:59,030
yeah and I don't know the answer the

1170
00:49:56,900 --> 00:50:01,940
thing is that like I said before before

1171
00:49:59,030 --> 00:50:05,390
Apple was basically just banning hashes

1172
00:50:01,940 --> 00:50:07,460
so the same developer ID was working for

1173
00:50:05,390 --> 00:50:09,560
a while and they would just generate new

1174
00:50:07,460 --> 00:50:11,540
certs but now they've actually started

1175
00:50:09,560 --> 00:50:13,340
revoking IDs as well and hopefully like

1176
00:50:11,540 --> 00:50:23,810
I said the notational take care of some

1177
00:50:13,340 --> 00:50:25,610
that as well yeah yeah so he said asked

1178
00:50:23,810 --> 00:50:30,770
if the ad we're actually requires root

1179
00:50:25,610 --> 00:50:32,860
access it does for the stage after the

1180
00:50:30,770 --> 00:50:35,360
final stage I guess basically it

1181
00:50:32,860 --> 00:50:38,540
downloads additional packages and so

1182
00:50:35,360 --> 00:50:41,150
enable for it to be able to download and

1183
00:50:38,540 --> 00:50:44,270
install additional adware packages

1184
00:50:41,150 --> 00:50:46,430
without user interaction it needs to

1185
00:50:44,270 --> 00:50:49,360
have that system level access and so

1186
00:50:46,430 --> 00:50:51,740
once they get past that initial

1187
00:50:49,360 --> 00:50:53,690
gatekeeping and only use that word it's

1188
00:50:51,740 --> 00:50:57,580
not gatekeeper but once they get past

1189
00:50:53,690 --> 00:50:59,400
that there's initial system max system

1190
00:50:57,580 --> 00:51:02,869
mitigation

1191
00:50:59,400 --> 00:51:22,410
techniques it can do what it wants to so

1192
00:51:02,869 --> 00:51:25,260
yoga right yes and he was making the

1193
00:51:22,410 --> 00:51:27,109
point that um developer IDs in general

1194
00:51:25,260 --> 00:51:30,000
Apple developer ideas are kind of

1195
00:51:27,109 --> 00:51:32,819
notorious now for being revoked because

1196
00:51:30,000 --> 00:51:34,680
people use stupid passwords and they get

1197
00:51:32,819 --> 00:51:36,660
compromised and somebody starts using

1198
00:51:34,680 --> 00:51:45,000
them for malware things like that so

1199
00:51:36,660 --> 00:51:47,339
yeah that's a good question you know I

1200
00:51:45,000 --> 00:51:49,039
think that it I'm just guessing but I'm

1201
00:51:47,339 --> 00:51:51,240
I'm assuming that it was probably

1202
00:51:49,039 --> 00:51:53,599
because if you look at the ad sites like

1203
00:51:51,240 --> 00:52:00,990
the one that we initially found it's a

1204
00:51:53,599 --> 00:52:02,910
non secure server and there's you know I

1205
00:52:00,990 --> 00:52:04,979
don't know if that's the way that

1206
00:52:02,910 --> 00:52:06,839
they're getting around for the park

1207
00:52:04,980 --> 00:52:10,160
demeans like how they're taking

1208
00:52:06,839 --> 00:52:14,299
advantage of the demands that are

1209
00:52:10,160 --> 00:52:17,339
expired yeah it's not it's not my ID

1210
00:52:14,299 --> 00:52:18,599
exactly and that's why as an indicator

1211
00:52:17,339 --> 00:52:22,160
I'm like I don't know why they're using

1212
00:52:18,599 --> 00:52:24,869
it but nobody else uses it legitimately

1213
00:52:22,160 --> 00:52:29,910
right yeah and so I haven't tested that

1214
00:52:24,869 --> 00:52:38,910
I'm not sure so yeah any other questions

1215
00:52:29,910 --> 00:52:43,770
yeah I think because of if you've got

1216
00:52:38,910 --> 00:52:45,690
network traffic monitoring or like if

1217
00:52:43,770 --> 00:52:46,799
you have some sort of like IDs system or

1218
00:52:45,690 --> 00:52:48,990
things like that that does packet

1219
00:52:46,799 --> 00:52:51,270
inspection it's just like if you're

1220
00:52:48,990 --> 00:52:53,879
trying to send well one thing I've done

1221
00:52:51,270 --> 00:52:55,619
sending malware to your friend right if

1222
00:52:53,880 --> 00:52:56,880
you should if you just try to send it

1223
00:52:55,619 --> 00:52:59,700
through your email it's probably going

1224
00:52:56,880 --> 00:53:02,279
to get clipped but if you send it if you

1225
00:52:59,700 --> 00:53:06,470
password protect it and encrypt it then

1226
00:53:02,279 --> 00:53:06,470
it's more likely to get past filters so

1227
00:53:06,890 --> 00:53:12,319
right and so anytime that the password

1228
00:53:10,650 --> 00:53:14,550
has changed it's going to change the

1229
00:53:12,320 --> 00:53:17,480
signature of the payload so if you're

1230
00:53:14,550 --> 00:53:21,990
relying on antivirus or things like that

1231
00:53:17,480 --> 00:53:23,310
yeah right and so that since it seems

1232
00:53:21,990 --> 00:53:24,689
like it's kind of a timestamp based

1233
00:53:23,310 --> 00:53:30,680
thing it's probably just an automated

1234
00:53:24,690 --> 00:53:38,940
generation of these payloads that yeah

1235
00:53:30,680 --> 00:53:40,790
questions all right well thank you very

1236
00:53:38,940 --> 00:53:43,840
much

1237
00:53:40,790 --> 00:53:43,840
[Applause]

