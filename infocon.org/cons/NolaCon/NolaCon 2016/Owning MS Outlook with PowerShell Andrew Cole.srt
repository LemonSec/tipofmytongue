1
00:00:00,000 --> 00:00:43,300
maybe everybody welcome to the only
Microsoft Outlook with PowerShell talk

2
00:00:43,300 --> 00:00:45,050
last talk of the day

3
00:00:45,050 --> 00:00:48,050
presenting this is one of our
instructors for Tyrone

4
00:00:48,590 --> 00:00:54,760
Andrew Cole and I will turn it over to
him you know you're really really

5
00:00:54,760 --> 00:01:01,579
special when you get to have an intro it
was the cockles of my heart so everyone

6
00:01:01,579 --> 00:01:07,530
enjoying all the concepts are having a
happy little time as you mentioned this

7
00:01:07,530 --> 00:01:11,570
is only Microsoft Outlook with
PowerShell it is the last talking today

8
00:01:11,570 --> 00:01:15,990
that's part of being the last time the
day is no one really cares if you end a

9
00:01:15,990 --> 00:01:19,759
little bit earlier running a bit long
but good cause I time this out three

10
00:01:19,759 --> 00:01:23,509
different times and each time I ended up
with a completely different time so it's

11
00:01:23,509 --> 00:01:31,790
going to be what it's gonna be alright
so who am I my name is Andrew Cole you

12
00:01:31,790 --> 00:01:35,950
want to reach me I pretty much exists on
social media solely on Twitter other

13
00:01:35,950 --> 00:01:41,930
than that I'm not a big social media ban
but I am had culmination I currently do

14
00:01:41,930 --> 00:01:47,170
work on technology services on their
information operations team I do

15
00:01:47,170 --> 00:01:51,920
development content and teach a bunch of
classes and in my spare time I do some

16
00:01:51,920 --> 00:01:56,360
security research so anybody here he
says they're scary researcher news that

17
00:01:56,360 --> 00:02:00,990
basically means you spend a lot of time
on Google and try to break crap that's

18
00:02:00,990 --> 00:02:03,990
it there's no qualifications for the job

19
00:02:05,520 --> 00:02:10,269
so prior to my time at chyron I was a
journeyman interactive on operator for

20
00:02:10,269 --> 00:02:17,360
the USR me for many years giving a talk
and be denied the gust said this is only

21
00:02:17,360 --> 00:02:28,010
my second talk so the love of god please
be gentle with me gusta so first I want

22
00:02:28,010 --> 00:02:31,548
to thank my employer for basically
giving me a paid vacation from my wife

23
00:02:31,549 --> 00:02:37,440
and I in New Orleans that was awesome in
a second off I want to thank the know

24
00:02:37,440 --> 00:02:41,060
what kind crew for providing the vessel
that allowed me to get my employer to

25
00:02:41,060 --> 00:02:46,709
get paid vacation for my wife and I and
New Orleans so win win a couple of the

26
00:02:46,709 --> 00:02:50,750
people I want to throw a shout out to
their work is sort of what I helped to

27
00:02:50,750 --> 00:02:57,140
build this work off of it will seem so
the Microsoft scripting guy PowerShell

28
00:02:57,140 --> 00:03:00,518
his blog he puts things up there that
it's like he doesn't know that he works

29
00:03:00,519 --> 00:03:04,390
for Microsoft is like here's how you
change time stamps on files on the

30
00:03:04,390 --> 00:03:08,059
Microsoft operating system like okay
that's good

31
00:03:08,640 --> 00:03:14,208
also Matt Nelson really smart young guy
works for the various group and so I

32
00:03:14,209 --> 00:03:17,910
took inspiration from some other code
for what we're gonna go over today

33
00:03:18,959 --> 00:03:25,370
ok so why did I pick outlook and
PowerShell to hear uses Outlook at work

34
00:03:25,370 --> 00:03:32,709
at our shallower Wow shame on you there
should be more and PowerShell is awesome

35
00:03:32,709 --> 00:03:37,709
you can do anything with it so the big
reason I like using PowerShell for

36
00:03:37,709 --> 00:03:41,889
exploitation a couple reasons one its
gonna be present in every environment

37
00:03:41,889 --> 00:03:46,069
God willing anyplace that your pen
testing is not going to have anything

38
00:03:46,069 --> 00:03:51,268
other than Windows 7 and Windows seven
you got PowerShell version 2 by default

39
00:03:51,269 --> 00:03:56,480
straight out of the box so that's a nice
little added bonus the other wonderful

40
00:03:56,480 --> 00:04:03,828
thing is one a lot admins aren't using
powershell or if they are using

41
00:04:03,829 --> 00:04:08,599
powershell they're not properly auditing
it for monitoring it so you can get away

42
00:04:08,599 --> 00:04:10,790
with a lot of different things

43
00:04:10,790 --> 00:04:14,450
lastly read timbers apprentices to
Avenue

44
00:04:14,450 --> 00:04:20,488
couple so everyone has their own custom
tools and great thing about your custom

45
00:04:20,488 --> 00:04:24,580
tools is that they there's no signatures
porn so it's awesome but that only

46
00:04:24,580 --> 00:04:28,750
happens until someone signature toll
than their signatures for your kind of

47
00:04:28,750 --> 00:04:33,340
hose so why would you use your custom
tools that unless you absolutely have to

48
00:04:33,340 --> 00:04:37,659
if there something already on the box
that there by default

49
00:04:37,660 --> 00:04:42,410
why don't we just use that instead so
you can use a lot of the things that

50
00:04:42,410 --> 00:04:47,229
you're probably currently using a custom
tool set for those same actions just

51
00:04:47,229 --> 00:04:51,669
using powershell and things that are
already on the box so we're going to

52
00:04:51,669 --> 00:04:57,870
look at how you can use Outlook
basically to work hand-in-hand with

53
00:04:57,870 --> 00:05:02,010
PowerShell and where they were exporting
outlook we're using it as a helper or a

54
00:05:02,010 --> 00:05:09,150
butt so a lot of what we're doing here
is we're going to be basically taking

55
00:05:09,150 --> 00:05:14,400
advantage of the outlook interop
assembly so interop assembly is

56
00:05:14,400 --> 00:05:16,750
basically

57
00:05:16,750 --> 00:05:25,889
interop assembly provided by Microsoft
that sort of makes a bridge to the

58
00:05:25,889 --> 00:05:31,600
applications and calm so it's a big
beneficial there let you go between dot

59
00:05:31,600 --> 00:05:37,260
net and com and if we use this technique
for the bulk of what we're gonna do here

60
00:05:37,260 --> 00:05:42,820
so the first thing we're doing is adding
a new type assembly for Microsoft Office

61
00:05:42,820 --> 00:05:48,030
Outlook so again it's already pre-k and
it's all in the box we're then going to

62
00:05:48,030 --> 00:05:52,638
define a variable as Outlook folders
which just points to the deep all

63
00:05:52,639 --> 00:05:57,470
holders that are already there for
Outlook where they going to do outlook

64
00:05:57,470 --> 00:06:02,900
new object to find the common object is
Outlook application and then namespace

65
00:06:02,900 --> 00:06:09,820
to be that new objects namespace MAPI so
once we done that we basically have full

66
00:06:09,820 --> 00:06:17,610
unfettered access to anything that is in
that users outlook so calendars Inbox

67
00:06:17,610 --> 00:06:22,050
Sent folder contacts anything they have
an outlook

68
00:06:22,050 --> 00:06:27,909
we have full access to it now the first
thing we're going to do is we're gonna

69
00:06:27,909 --> 00:06:32,180
look at using this person data mining so
at the end of the day a lot of the time

70
00:06:32,180 --> 00:06:37,120
with the customer needs is that so what
why you should care so yes you have a

71
00:06:37,120 --> 00:06:41,819
boner ability that's not a big deal more
than when you show them like their

72
00:06:41,819 --> 00:06:45,009
personal calendar it's like well here's
where you are

73
00:06:45,009 --> 00:06:51,020
during these hours and here's the email
from your wife then this or to go oh wow

74
00:06:51,020 --> 00:06:56,318
ability to pass my system I need to get
this out so we're going to use this to

75
00:06:56,319 --> 00:07:02,419
sort of just harvest whatever we want to
be the Inbox Sent Items calendar what

76
00:07:02,419 --> 00:07:44,948
have you been up and down the code
section I wonder if there is I can't see

77
00:07:44,949 --> 00:07:47,949
that modern very well at all

78
00:07:56,110 --> 00:08:02,410
I'm skipping the parameters and such
because those are less important so that

79
00:08:02,410 --> 00:08:06,040
first part of top is just the interop
assembly that we're loading up in the

80
00:08:06,040 --> 00:08:09,390
last slide and after that we're just
saying what we wanted to do with the

81
00:08:09,390 --> 00:08:13,990
particular data so do we want to grab
the Inbox

82
00:08:13,990 --> 00:08:17,700
do you want to grab the Sent Items
contacts what had you they're all just

83
00:08:17,700 --> 00:08:23,000
boulders their defined by folder numbers
and just by changing the polder number

84
00:08:23,000 --> 00:08:27,490
that we're feeding to it we can tell it
what to grabbing pole and I promise all

85
00:08:27,490 --> 00:08:30,370
the code is up on github and I'll give
you the link to that if you want to grab

86
00:08:30,370 --> 00:08:51,600
the code samples later to dig through
let me my original plan was to have a

87
00:08:51,600 --> 00:08:58,630
great live demos but it turns out to use
Outlook in exchange for various items

88
00:08:59,430 --> 00:09:02,770
well for starters I had to run a Dec

89
00:09:02,770 --> 00:09:08,350
and Exchange server to work stations and
once I had all that rain absorb it sort

90
00:09:08,350 --> 00:09:14,250
of slowed my demos down the crap so we
went ahead and went to just videos I

91
00:09:14,250 --> 00:09:19,570
ended up recording on my hardware at
work where I had more RAM to work which

92
00:09:19,570 --> 00:09:22,440
because otherwise my poor little boxes
started crying

93
00:09:22,440 --> 00:09:26,620
nonetheless it's a good idea to pray to
the demigods to give you a good display

94
00:09:26,620 --> 00:09:30,790
so I have a glorious video clip here

95
00:09:41,769 --> 00:09:58,730
so what it's doing in a nutshell is
we're just gonna look into each of the

96
00:09:58,730 --> 00:10:03,049
folders and it's a harsher script it's
designed to harvest the contents of it

97
00:10:03,049 --> 00:10:07,019
to grab either in this case it's
grabbing it looks like the Inbox there

98
00:10:07,019 --> 00:10:14,819
we can later pointed to the Sent Items
folder we can point to their contact

99
00:10:14,819 --> 00:10:15,920
information

100
00:10:15,920 --> 00:10:20,128
anything that stored in Outlook by
default I only have it set to grab items

101
00:10:20,129 --> 00:10:25,069
that ship with outlook on its own so
that's going to be Inbox Sent calendar

102
00:10:25,069 --> 00:10:29,589
contacts and tax what all those items
can be harvested if they start making

103
00:10:29,589 --> 00:10:33,230
their own custom folders where they're
storing things you're gonna have to pull

104
00:10:33,230 --> 00:10:37,689
what that Outlook folder number is and
then pointed to that taxes that

105
00:10:37,689 --> 00:10:42,879
particular folder not gonna know what
those are by default but it does grab

106
00:10:42,879 --> 00:10:46,999
the whole information now for the
harvesting script for grabbing emails he

107
00:10:46,999 --> 00:10:51,619
can either grab just a summary listing
what is in the email so who it's from

108
00:10:51,619 --> 00:10:58,230
obviously came to you that date it was
thanks and the subject line it can also

109
00:10:58,230 --> 00:11:02,600
pull the full contents when polls the
full contents know that it's going to be

110
00:11:02,600 --> 00:11:07,579
harvesting all the medidata is well so
you're going to get the network

111
00:11:07,579 --> 00:11:11,989
interface adapter that actually received
the packet from wherever it's going to

112
00:11:11,990 --> 00:11:16,559
get full HTML code this set up email
itself so there's going to be a very

113
00:11:16,559 --> 00:11:23,309
large amount of information there so if
you do pull it on a live active system

114
00:11:23,309 --> 00:11:26,429
you want to be careful and make sure
you're not grabbing an inbox that has

115
00:11:26,429 --> 00:11:33,350
5,000 items in it but as 5,000 items one
you're gonna spike the processor and RAM

116
00:11:33,350 --> 00:11:37,989
modem box and to its gonna take it
somewhere in the ballpark of hours to

117
00:11:37,989 --> 00:11:40,989
finish up

118
00:11:41,840 --> 00:11:45,690
so that's just the basics

119
00:11:45,690 --> 00:11:53,050
obviously we probably want to do a
little more than just grab information

120
00:11:53,050 --> 00:11:56,469
that's not a huge deal we want to know
how we can leverage this for some of our

121
00:11:56,470 --> 00:12:02,320
other possible actions so I assume
people here do client-side exploitation

122
00:12:02,320 --> 00:12:07,850
sometimes your initial access into
networks you have to get someone to

123
00:12:07,850 --> 00:12:13,460
click on something and email is an easy
way to do it than 14 million with SCLC

124
00:12:13,460 --> 00:12:19,260
and confidence level so when you have an
Exchange server and I realized this

125
00:12:19,260 --> 00:12:22,420
doesn't actually touch outlook but
accounts for exchange so i'm i'm calling

126
00:12:22,420 --> 00:12:27,699
it still on the road when you send an
email it's the sign of value by exchange

127
00:12:27,700 --> 00:12:32,680
called the spam competence level numbers
range anywhere from zero to nine or it

128
00:12:32,680 --> 00:12:35,650
is from a trusted email address

129
00:12:35,650 --> 00:12:40,560
inside the network it gets a value minus
one now based on the number that it's

130
00:12:40,560 --> 00:12:44,750
given so 10 is something that it's
almost a hundred percent positive as not

131
00:12:44,750 --> 00:12:51,070
spam if it gets a nine basically it's an
email from a Nigerian prince who wants

132
00:12:51,070 --> 00:12:56,600
to sell you viagra on the side he just
needed bank account information based on

133
00:12:56,600 --> 00:13:00,380
which value it's given its gonna clip a
threshold and when it quits that

134
00:13:00,380 --> 00:13:03,030
threshold itself exchange what to do
with it

135
00:13:03,030 --> 00:13:09,910
typically like 032 it'll just deliver
the email if you get a three-year of

136
00:13:09,910 --> 00:13:12,040
poor little trip

137
00:13:12,040 --> 00:13:15,459
threshold which case it gets put in the
junk folder

138
00:13:16,170 --> 00:13:20,510
quarantine is not normally there it has
to be turned on its not a deep ball

139
00:13:20,510 --> 00:13:23,890
action but if you turn it on

140
00:13:23,890 --> 00:13:27,210
quarantine that on the Exchange server
in a special folder that only exchange

141
00:13:27,210 --> 00:13:32,380
admin get into so basically you're
caught but again that's not on by

142
00:13:32,380 --> 00:13:36,870
default the other actions are to reject
or delete which the only difference is

143
00:13:36,870 --> 00:13:43,780
basically whether or not it notifies the
sender that the email was dropped so why

144
00:13:43,780 --> 00:13:50,120
do we care about this there's a built-in
command leading PowerShell it's only on

145
00:13:50,120 --> 00:13:53,490
PowerShell per Exchange servers so
you're not going to be able to run this

146
00:13:53,490 --> 00:13:54,710
from a regular box

147
00:13:54,710 --> 00:13:59,690
however you do get creds you can remote
into the Exchange server or you can

148
00:13:59,690 --> 00:14:04,640
exploit under the Exchange server you
can put rules down in place that make

149
00:14:04,640 --> 00:14:11,210
things easier for you the next time you
up the client-side somebody so the the

150
00:14:11,210 --> 00:14:15,200
number of parameters that are available
for this command force new transport

151
00:14:15,200 --> 00:14:19,130
role are ridiculous some of the things
you're just like why would they even

152
00:14:19,130 --> 00:14:27,050
make that but you can have it set the
specified SEL based on certain criteria

153
00:14:27,050 --> 00:14:34,180
like if it is safe from this particular
address given in STL minus 10 now every

154
00:14:34,180 --> 00:14:38,719
single email that we send from our
attacking address is going to get sent a

155
00:14:38,720 --> 00:14:41,130
trusted email to the Inbox

156
00:14:41,130 --> 00:14:45,250
nothing will ever go to junk it'll never
get quarantine it will never get to

157
00:14:45,250 --> 00:14:50,160
leader rejected other things you can do
maybe you just want to track a specific

158
00:14:50,160 --> 00:14:56,420
users email there's this great option
this autumn rule so that the top example

159
00:14:56,420 --> 00:15:01,339
there the new Transport Rule named said
US yell from this attacker sent to this

160
00:15:01,340 --> 00:15:06,130
target set the SL 2-1 we probably won't
have both those fields in there because

161
00:15:06,130 --> 00:15:11,380
if you just say anything going to this
targets at the SEL 2-1 well now the

162
00:15:11,380 --> 00:15:15,439
actual Nigerian Prince emails are going
directly to their in-box and not chunks

163
00:15:15,440 --> 00:15:21,320
that might set up a red flag we can see
if it comes from us a lot that comes

164
00:15:21,320 --> 00:15:27,390
from us and goes to this person said it
2-1 gonna be automatically trusted that

165
00:15:27,390 --> 00:15:31,500
second example their new Transport Rule
named doesn't matter whatever you want

166
00:15:31,500 --> 00:15:38,710
to call it if it sent to this target
line copy too so anyone take a stab in

167
00:15:38,710 --> 00:15:42,870
the dark with that's going to do so we
just had this to our target and every

168
00:15:42,870 --> 00:15:48,510
single email to get sent to them ever
Exchange servers gonna add a BCC line to

169
00:15:48,510 --> 00:15:53,040
send a copy to us so now we
automatically collect all the email

170
00:15:53,040 --> 00:16:00,410
without even having to be on the box so
its beauty beautiful part of our shelter

171
00:16:00,410 --> 00:16:03,410
exchange

172
00:16:05,320 --> 00:16:08,550
to get past client side the next thing
we want to look at is obviously

173
00:16:08,550 --> 00:16:14,709
persistence thank god how persistent a
way to get onto a box exploitations kind

174
00:16:14,710 --> 00:16:19,440
of a bit of work cleaning up after it
even more work and sometimes exploits

175
00:16:19,440 --> 00:16:26,150
have less than ideal side effects like
crushing a service or possibly screening

176
00:16:26,150 --> 00:16:31,390
a box so back to our friends generally
know your back doors fall into one of

177
00:16:31,390 --> 00:16:32,340
two categories

178
00:16:32,340 --> 00:16:35,410
it's either going to be a glistening
back door which is going to bind socket

179
00:16:35,410 --> 00:16:39,770
on the host its gonna be a big inning
back door that's gonna call back to us

180
00:16:39,770 --> 00:16:45,640
at us that interval they both have
issues so you're listening back to where

181
00:16:45,640 --> 00:16:50,069
is your most basic back door but it's so
easy to catch with his face detection

182
00:16:50,070 --> 00:16:55,180
you've got a socket setting open that's
never good it's very obvious that

183
00:16:55,180 --> 00:17:00,500
something is doing something shady there
you're beginning back door really hard

184
00:17:00,500 --> 00:17:04,589
to find on the host if you have a good
persistence method but that heartbeat

185
00:17:04,589 --> 00:17:11,770
popping out on the wire network IDs can
catch that pretty easily so the ideal

186
00:17:11,770 --> 00:17:16,139
way to do it who here has a tool that
they used for trigger able access to get

187
00:17:16,140 --> 00:17:21,329
onto a target so there's no beacon
there's no listening port you just send

188
00:17:21,329 --> 00:17:25,240
a specialized triggered in the box when
it sees the trigger it either calls out

189
00:17:25,240 --> 00:17:31,430
to you or it opens up a listening nobody
terrible access is the way to go

190
00:17:32,140 --> 00:17:36,370
so we're going to show how we can create
trigger herbal access great part about

191
00:17:36,370 --> 00:17:40,889
credible access to snowbound port
sitting there for anyone to find there's

192
00:17:40,890 --> 00:17:47,770
no socket are no socket there's no
unnecessary traffic flying across the

193
00:17:47,770 --> 00:17:52,980
network when we don't wanna connection
and we've got 24 7 access to the box

194
00:17:52,980 --> 00:17:59,470
outlook is a natural trigger I think
about what it's designed to do it's

195
00:17:59,470 --> 00:18:05,770
designed to take traffic from anywhere
on the internet and redirect it directly

196
00:18:05,770 --> 00:18:10,850
to your user that's sort of what r
trigger pack and he's so why can't we

197
00:18:10,850 --> 00:18:14,759
just use Outlook as are triggering
mechanism

198
00:18:14,759 --> 00:18:23,789
ok this is only a triggering mechanism
is not a true persistence you're gonna

199
00:18:23,789 --> 00:18:27,789
have to use some other persistence
method to start this script out but once

200
00:18:27,789 --> 00:18:33,059
the script does start up it's going to
be your purse your trigger able access

201
00:18:33,059 --> 00:18:37,719
so it's gonna have you not have that
network traffic report bounds do so in a

202
00:18:37,719 --> 00:18:43,059
person's method and you're gonna have to
have your payload of course this general

203
00:18:43,059 --> 00:18:50,690
idea was written by Matt Nelson you did
a really good article I liked his it was

204
00:18:50,690 --> 00:19:02,100
a little bit of a resource hog and my
big issue though it didn't

205
00:19:02,100 --> 00:19:06,250
clean up with I guess would be the
easiest way to say it so it would get

206
00:19:06,250 --> 00:19:09,140
the trigger email it would then delete
the email or some other things that

207
00:19:09,140 --> 00:19:15,150
didn't do like it didn't delete the
email from the Deleted Items folder so

208
00:19:15,150 --> 00:19:19,320
your trigger email was still on that
deleted items for forever it also didn't

209
00:19:19,320 --> 00:19:23,080
mark the emails read so it would go to
deleted items in there be a little one

210
00:19:23,080 --> 00:19:28,240
in Outlook said hey you have an unread
email and your deleted items folder so

211
00:19:28,240 --> 00:19:32,240
we streamline it a little bit so with
the script gonna do in a nutshell it's

212
00:19:32,240 --> 00:19:38,559
going to monitor the Inbox looking for a
particular trigger scripts a trigger

213
00:19:38,559 --> 00:19:44,250
email it's gonna look for a particular
user name and subject line so whoever

214
00:19:44,250 --> 00:19:48,840
comes from and the subject line if they
match but we have set in the script it

215
00:19:48,840 --> 00:19:55,209
will then start whatever payload we tell
the script 2.2 it will then after it

216
00:19:55,210 --> 00:19:59,320
protects the email it'll start that
payload the payload call you out after

217
00:19:59,320 --> 00:20:04,500
which its going to delete the email you
can remove it from the Deleted Items

218
00:20:04,500 --> 00:20:09,159
folder and then it's going to go into a
sleep cycle and then start listening

219
00:20:09,159 --> 00:20:24,659
again over and over again in my during
that inbox yes in fact if you run the

220
00:20:24,659 --> 00:20:28,110
scripts when you create that common
objects guess what it does about looks

221
00:20:28,110 --> 00:20:34,500
not running start Outlook so yeah that's
that's a little side part so it has to

222
00:20:34,500 --> 00:20:38,809
be an environment where somebody's gonna
have Outlook running all the time I know

223
00:20:38,809 --> 00:20:42,980
at least in most of the work environment
so I worked in most people that look set

224
00:20:42,980 --> 00:20:49,309
to start on startup that's why would you
not outlook running you don't do email

225
00:20:49,309 --> 00:20:55,940
then obviously you're doing stopping not
actually working anyways so it's it's

226
00:20:55,940 --> 00:20:59,039
not without its little hiccups when you
start the script it's gonna start

227
00:20:59,039 --> 00:21:03,600
Outlook but it's gonna start outlook for
that user so they'll be like that's

228
00:21:03,600 --> 00:21:08,010
gonna bring in somebody must have bad
news for me that's wonderful

229
00:21:08,010 --> 00:21:18,440
ok so the largest issue with it is that
it actually here let me just go to the

230
00:21:18,440 --> 00:21:21,610
code real quick will pop a little bit of
code up there and have a great little

231
00:21:21,610 --> 00:21:36,580
demo video I'm going through time are
doing okay right so I also have this set

232
00:21:36,580 --> 00:21:42,639
so in the script you can tell it in your
parameters whether you want it to stay

233
00:21:42,640 --> 00:21:47,000
in the in box where the junk folder so
if you know your emails are popping on

234
00:21:47,000 --> 00:21:52,770
that SEL and things that can pop on an
SLR things like an attachment to it as

235
00:21:52,770 --> 00:21:58,490
an attachment that has any execution
whatsoever it tends to bump up the SEL

236
00:21:58,490 --> 00:22:04,270
buy alesse 28 has a active link in it
that usually bumps here SEL up by one or

237
00:22:04,270 --> 00:22:07,410
two as well so if you have either one of
those is a good chance you're gonna get

238
00:22:07,410 --> 00:22:11,470
rerouted to junk so if you know your
emails going there anyways why not just

239
00:22:11,470 --> 00:22:21,870
have him on your shoulder for you so
what we've got going over here again

240
00:22:21,870 --> 00:22:24,939
basically it's just going to define the
Inbox

241
00:22:24,940 --> 00:22:29,500
as your target environment it's gonna
say for each email in its gonna find

242
00:22:29,500 --> 00:22:32,450
emails as objects that are in that Inbox

243
00:22:32,450 --> 00:22:35,420
and then for each one it's just going to
scroll through the mall one at a time

244
00:22:35,420 --> 00:22:39,900
and check to see the center and the
subject line at the center in the

245
00:22:39,900 --> 00:22:46,180
subject line match what's in the trigger
to what we told you to do not go to the

246
00:22:46,180 --> 00:22:50,810
next email after it runs through all of
them if it doesn't see the trigger email

247
00:22:50,810 --> 00:22:54,629
at all anywhere it's going to just go
into a sleep cycle the delay is fully

248
00:22:54,630 --> 00:22:57,950
customizable when you start the script
you can tell the delay of however long

249
00:22:57,950 --> 00:22:58,130
you

250
00:22:58,130 --> 00:23:04,060
want to go forward that's how long it'll
sleep at all then sleeps go back to the

251
00:23:04,060 --> 00:23:08,610
first email in the box and run through
them all again it does use a little bit

252
00:23:08,610 --> 00:23:13,629
of resources on the box so I found on
average on a typical PC Bill you're

253
00:23:13,630 --> 00:23:18,810
gonna do not touch CPU usage at all but
that continuous monitoring if you have

254
00:23:18,810 --> 00:23:24,370
that delay set really short at like two
or three seconds it's gonna increase the

255
00:23:24,370 --> 00:23:30,060
RAM usage by about 8% if you cut that
time now to more like 30 seconds it's

256
00:23:30,060 --> 00:23:34,840
only gonna see probably about a four
percent bump in rain usage which no

257
00:23:34,840 --> 00:23:41,770
users to notice right so I have another
glorious little video here that is going

258
00:23:41,770 --> 00:23:45,650
to run through and get that minimize

259
00:23:56,350 --> 00:24:07,350
so for the sake of the video I literally
I chose the simplest easiest payload I

260
00:24:07,350 --> 00:24:15,399
could which is like all exploit sample
code calculator so it's gonna look for a

261
00:24:15,400 --> 00:24:20,910
trigger email when it finds the trigger
even now it's going to start a payload

262
00:24:20,910 --> 00:24:36,549
which is in this case a calculator is
running like it was just so I believe

263
00:24:36,549 --> 00:24:42,129
the email that it's looking to trigger
on is from like a bad user @ aol.com and

264
00:24:42,130 --> 00:24:46,270
trigger word I believe I said his
trigger but again it's just going to

265
00:24:46,270 --> 00:24:52,639
that running just sitting there writing
so it's just going to monitor that inbox

266
00:24:52,640 --> 00:24:57,090
I put the email and junk folder so that
it will just keep running and scanning

267
00:24:57,090 --> 00:25:00,570
the inbox and nothing will happen and
then when I move that email from the

268
00:25:00,570 --> 00:25:02,100
junk folder to the Inbox

269
00:25:02,100 --> 00:25:05,178
its gonna set up the trigger and
theoretically we're gonna get a

270
00:25:05,179 --> 00:25:08,400
calculator see anything can go wrong

271
00:25:08,400 --> 00:25:18,049
into the recording but yes I have been
proposed that there so it's just

272
00:25:18,049 --> 00:25:22,100
scanning through and I just have some
great for both lines in there whenever

273
00:25:22,100 --> 00:25:24,770
you're writing editing and PowerShell
right proposed the most awesome thing

274
00:25:24,770 --> 00:25:28,190
ever let you put in things to let you
know what point in the script you're

275
00:25:28,190 --> 00:25:31,640
actually at so it's just going through
saying hey i'm looking I haven't found

276
00:25:31,640 --> 00:25:34,909
anything I believe I said that the
latest something like one or two second

277
00:25:34,909 --> 00:25:40,190
so it's going really fast but now as
soon as we move the email and there it

278
00:25:40,190 --> 00:25:43,559
triggered and it kicked off her
calculator you probably wouldn't want to

279
00:25:43,559 --> 00:25:46,700
use a calculator in the real world you
probably won't have that be you know

280
00:25:46,700 --> 00:25:52,409
every verse payload its gonna call back
to your attack platform and then it

281
00:25:52,409 --> 00:25:57,450
deleted the folder and the first thing
it does is it marks it as read and

282
00:25:57,450 --> 00:26:02,030
deletes it so that way it's visible to
use her for the smallest amount of time

283
00:26:02,030 --> 00:26:02,870
possible

284
00:26:02,870 --> 00:26:12,379
but it is still gonna be visible to the
user for a short period of time there's

285
00:26:12,380 --> 00:26:17,890
not much we can really do about that so
the largest issue with that method was

286
00:26:17,890 --> 00:26:21,870
again the emails going to be sitting
there we're not gonna start i'm too late

287
00:26:21,870 --> 00:26:26,840
to one second because then it would be
just like in the crap outta resources

288
00:26:26,840 --> 00:26:30,879
and people notice when something like
word takes 40 minutes to type out a word

289
00:26:30,880 --> 00:26:34,170
so we have to set that time interval to
be a long ripping so we're not

290
00:26:34,170 --> 00:26:39,610
overloading the memory of the box when
we do that obviously it's gonna sit

291
00:26:39,610 --> 00:26:44,240
there for a little while also whenever
our email comes in what happens in

292
00:26:44,240 --> 00:26:48,420
Outlook when you get an email you about
looking at a modest you get that little

293
00:26:48,420 --> 00:26:51,940
thing in the lower right hand corner so
the user is going to notice that they're

294
00:26:51,940 --> 00:26:58,540
getting emails eventually they're gonna
wonder why they keep getting this email

295
00:26:58,540 --> 00:27:03,670
from nowhere that keeps deleting itself
and then disappearing off the box that's

296
00:27:03,670 --> 00:27:09,010
not normal behavior and overly paranoid
user or even a stain one would probably

297
00:27:09,010 --> 00:27:13,470
start to notice that for a while so what
if we had an email that was completely

298
00:27:13,470 --> 00:27:19,110
done nine and didn't look to have any
threat or risk to it whatsoever

299
00:27:19,110 --> 00:27:24,959
would be really careful user sees that I
would do here gets an email from here as

300
00:27:24,960 --> 00:27:29,540
a LinkedIn account ok so how many job
offers you get a month from linköping

301
00:27:29,540 --> 00:27:34,990
your LinkedIn profile and we have a job
it's just right for you and then you

302
00:27:34,990 --> 00:27:39,429
look at the job operating doesn't match
your skills so you know you can spans

303
00:27:39,429 --> 00:27:46,540
but a usable think twice if we get like
a LinkedIn job offer he now so we're

304
00:27:46,540 --> 00:27:51,450
gonna do is working to make the filter
dynamic so rather than having it come

305
00:27:51,450 --> 00:27:58,080
from a set IP address or with assets
subject line would have we made it so it

306
00:27:58,080 --> 00:28:00,840
could be any sender

307
00:28:00,840 --> 00:28:06,800
any subject line are payload could even
call back to different IP addresses in

308
00:28:06,800 --> 00:28:12,790
different ports that'd be pretty awesome
right I call this a dynamic outlook

309
00:28:12,790 --> 00:28:15,789
trigger so what it's going to do is
instead of searching

310
00:28:15,789 --> 00:28:19,440
its gonna load up the emails in the same
manner but instead of searching the mall

311
00:28:19,440 --> 00:28:24,570
for the sender address or the subject
line it's going to scan the body of the

312
00:28:24,570 --> 00:28:29,299
email looking for a series of trigger
words so I haven't defined three words

313
00:28:29,299 --> 00:28:33,129
because you don't want false positives
kicking off your payload all the time so

314
00:28:33,129 --> 00:28:37,449
it's gonna look for three words you want
to make them common words that will show

315
00:28:37,450 --> 00:28:42,499
up in a normal email and we'll look
weird you know fiber hood you should not

316
00:28:42,499 --> 00:28:44,999
be one of your trigger words you want to
be something that would be hard to

317
00:28:44,999 --> 00:28:49,419
notice but you also need it to be three
words that are unlikely to be in an

318
00:28:49,419 --> 00:28:55,950
email from a regular user so since
they're usually computer emails from

319
00:28:55,950 --> 00:29:00,979
LinkedIn I pick white cyber battlefield
or something buzz birdie like that you

320
00:29:00,979 --> 00:29:05,960
know cyber warfare Cyber Security and
then things like the word LinkedIn

321
00:29:05,960 --> 00:29:12,359
LinkedIn profile and then something like
interested or independent recruiter or

322
00:29:12,359 --> 00:29:16,570
what have you see picture 3 trigger
words when it finds that trigger trigger

323
00:29:16,570 --> 00:29:20,649
words then gonna do its gonna look
through the email and it's gonna find a

324
00:29:20,649 --> 00:29:26,349
URL if there's a URL in the email it
will take that URL it'll do an nslookup

325
00:29:26,349 --> 00:29:31,809
on in the background so that it pulls an
IP address from that URL so that way if

326
00:29:31,809 --> 00:29:36,220
you just modify your name record 2.2 a
different IP address

327
00:29:36,220 --> 00:29:41,649
call up to a different IP also we need
support not just night P so what does it

328
00:29:41,649 --> 00:29:46,349
scans through the entire email and it
finds any number that is in the accepted

329
00:29:46,349 --> 00:29:53,349
port range so it's between the number
one and 65535 its gonna say okay thats

330
00:29:53,349 --> 00:29:58,299
my port so couple things you need to
consider one in your check your email

331
00:29:58,799 --> 00:30:02,139
do not put to you or else it will
confuse the crap out of it

332
00:30:02,849 --> 00:30:07,979
do not put two numbers that following
that port range that will also use the

333
00:30:07,979 --> 00:30:13,629
crap out of it other than that there's
not really any rules so three trigger

334
00:30:13,629 --> 00:30:21,309
words words up making whatever you want
and you can as long as every trigger

335
00:30:21,309 --> 00:30:26,649
email you sent has those three trigger
words a URL and a number and

336
00:30:26,650 --> 00:30:31,880
every email pretty much has a URL
signature block or sometimes even in the

337
00:30:31,880 --> 00:30:36,210
middle attack somebody always mentions
their email address or something along

338
00:30:36,210 --> 00:30:42,100
those lines and a number range that's
the way I've been most commonly using it

339
00:30:42,100 --> 00:30:46,219
is not unusual to have your street
address your business and your signature

340
00:30:46,220 --> 00:30:53,380
block right so the street address can be
he number of the port you want to call

341
00:30:53,380 --> 00:31:15,230
back forty five digit number so this is
our dynamic outlook trigger that I am

342
00:31:15,230 --> 00:31:28,480
going to in this case I just use the ISE
to load my script because it made life a

343
00:31:28,480 --> 00:31:34,110
little bit easier so we loaded up the
scripts are trigger words are right

344
00:31:34,110 --> 00:31:40,399
there so any email that contains those
three words it's going to kick off our

345
00:31:40,400 --> 00:31:46,320
action now in this case for this demo i
calculator wouldn't release suffice

346
00:31:46,830 --> 00:31:51,659
so when it detects the words I'm having
it right to a Word notepad document to

347
00:31:51,660 --> 00:31:56,190
text document what the IP address and
the port it's going to call back to and

348
00:31:56,190 --> 00:32:03,030
then the payload is no pad open that
document so it's going to execute down

349
00:32:03,030 --> 00:32:09,490
here I used chyron tech my company
website at the URL you can see that it's

350
00:32:09,490 --> 00:32:14,690
best to call back to 218 something
that's what the nslookup for our

351
00:32:14,690 --> 00:32:20,020
particular IP address is going to be so
the script just watching and waiting

352
00:32:20,020 --> 00:32:24,960
it's going through its verbose didn't
find the email started over to find the

353
00:32:24,960 --> 00:32:35,750
email started over so once I do move the
email from the junk folder to be in box

354
00:32:35,750 --> 00:32:37,620
it will trigger

355
00:32:37,620 --> 00:32:41,110
long it actually stands emails were
really fast

356
00:32:41,110 --> 00:32:44,939
each emails gonna take it like a
fraction of a second so you can stand

357
00:32:44,940 --> 00:32:52,440
the whole inbox pretty quickly so it
pops up and said its gonna call back to

358
00:32:52,440 --> 00:32:59,070
this IP address and the sport it's as
simple as that I like things being

359
00:32:59,070 --> 00:33:03,050
dynamic I like the fact that I don't
have a signature double trigger I mean

360
00:33:03,050 --> 00:33:06,440
who's gonna write a signature that looks
for three words in the body of an email

361
00:33:06,440 --> 00:33:19,360
I wouldn't it be a huge pain so what
would be the only thing that is better

362
00:33:19,360 --> 00:33:24,889
than having trigger Apple access what if
you didn't have to get on the box and

363
00:33:24,890 --> 00:33:31,720
all right that would be incredibly
awesome so getting shell is awesome but

364
00:33:31,720 --> 00:33:35,550
what if you don't need one but if i dont
have to get on that box at all there's

365
00:33:35,550 --> 00:33:39,450
some actions you have to get the shell
on the box to do if you don't know what

366
00:33:39,450 --> 00:33:42,450
you're doing on the target or where
things are going to be located

367
00:33:43,100 --> 00:33:48,870
yeah you need an interactive shell but
what if I have sustained collection I

368
00:33:48,870 --> 00:33:53,840
want to get off the target so I know
what directory to file sorry I just want

369
00:33:53,840 --> 00:33:58,149
to copy those files and see what's in or
maybe I just want to pull this to the

370
00:33:58,150 --> 00:34:02,640
user's what have you some static
information about the box or a static

371
00:34:02,640 --> 00:34:08,280
location I can use Outlook to automate
that process so I don't even have to

372
00:34:08,280 --> 00:34:13,310
bother getting on the box so you can do
is I'm gonna come up with the commands

373
00:34:13,310 --> 00:34:16,529
that I want they're going to have to be
in a single line separated by semicolons

374
00:34:16,530 --> 00:34:20,470
so it has to be PowerShell commands and
they have to be on a single line

375
00:34:20,469 --> 00:34:25,678
separated by semicolons so you can take
like 35 million scripts and load them

376
00:34:25,679 --> 00:34:28,490
all up in there and send them it's not
going to work that way

377
00:34:28,489 --> 00:34:36,770
probably get it to work that way but
it's gonna take a hot new coating so if

378
00:34:36,770 --> 00:34:41,710
you have simple commands though you can
use this method what we're gonna do is

379
00:34:41,710 --> 00:34:46,679
we're going to take our command in a
document we're going to attach that

380
00:34:46,679 --> 00:34:49,820
document to an email that we are sending
to the target

381
00:34:49,820 --> 00:34:56,030
when it hits the target it's going to
pack its gonna be a trigger is going to

382
00:34:56,030 --> 00:35:00,320
recognize their trigger gonna take our
script commands it's going to run them

383
00:35:00,320 --> 00:35:05,810
and then it's going to email the results
back to us so that we don't have to

384
00:35:05,810 --> 00:35:12,080
actually get on the box so a couple
little things you need to consider here

385
00:35:12,080 --> 00:35:18,140
for starters don't try to just put a ps1
script and send it turns out that

386
00:35:18,140 --> 00:35:24,129
Outlook using powershell script the same
way it use an executable if you send a

387
00:35:24,130 --> 00:35:27,700
email the someone with a next day as an
attachment I promise you they will never

388
00:35:27,700 --> 00:35:31,500
get it it will at a minimum go to the
junk folder most likely it'll get

389
00:35:31,500 --> 00:35:36,060
quarantine or deleted so don't send a
ps1 script either it will definitely

390
00:35:36,060 --> 00:35:43,460
send it to at least the job holder so
there's two ways to get around that one

391
00:35:43,460 --> 00:35:49,930
we could just put our script in the body
of the email and you could just grab

392
00:35:49,930 --> 00:35:55,049
that bodies save it as a variable and
run it ok but now you have a really

393
00:35:55,050 --> 00:36:00,130
suspicious-looking just went to the
right you've got an email but just like

394
00:36:00,130 --> 00:36:04,950
you know get process get user and that's
not normally now so I think the better

395
00:36:04,950 --> 00:36:08,680
option is to throw in the attachment
obviously your attachment is going to be

396
00:36:08,680 --> 00:36:12,680
a series of commands so you're not going
to want to leave this there for a long

397
00:36:12,680 --> 00:36:15,990
time you'll probably want to delete this
once they don't get the list of commands

398
00:36:15,990 --> 00:36:22,620
also when we send a response back it's
going to generate any emails were going

399
00:36:22,620 --> 00:36:26,339
to delete that out of the Sent Items
think it looks fishy here than a weird

400
00:36:26,340 --> 00:36:31,490
email that came in is if you replied to
it and you don't remember sending the

401
00:36:31,490 --> 00:36:32,450
reply

402
00:36:32,450 --> 00:36:39,589
kind of a little red flag so we're gonna
attach a text file to the document once

403
00:36:39,590 --> 00:36:43,310
it comes in and it recognizes that our
email matches the trigger I used to

404
00:36:43,310 --> 00:36:46,470
dynamic trigger for this but you could
use the static one save it comes from

405
00:36:46,470 --> 00:36:48,899
the side this anger with this subject

406
00:36:48,900 --> 00:36:53,350
whatever you want once it recognizes
that it did trigger email it's gonna

407
00:36:53,350 --> 00:36:56,350
take

408
00:36:58,460 --> 00:37:04,670
of the attachment savings a variable it
then going to feed them to PowerShell to

409
00:37:04,670 --> 00:37:11,700
execute the output of the commands are
going to be written temporarily to a dot

410
00:37:11,700 --> 00:37:17,200
team people in the user's temp directory
which will then be added as an

411
00:37:17,200 --> 00:37:20,730
attachment to the outgoing email that's
gonna send back to us and it's been

412
00:37:20,730 --> 00:37:24,670
going to delete all the files that it
created going to delete the emails it

413
00:37:24,670 --> 00:37:31,880
created it's going to clear them out of
the Deleted Items folder as well so yeah

414
00:37:31,880 --> 00:37:35,790
steps I have the stats so just like the
other ones if you want to monitor the

415
00:37:35,790 --> 00:37:38,369
junk folder or the Inbox

416
00:37:38,369 --> 00:37:41,280
it work for either one is just a
difference which the EP the script to

417
00:37:41,280 --> 00:37:47,220
tell it where to look it does have to
see the attachment to disk for a hot

418
00:37:47,220 --> 00:37:51,359
minute I couldn't get it to read the
content stored them in memory is a

419
00:37:51,359 --> 00:37:56,259
variable and then passed the variable to
PowerShell the habit execute I don't

420
00:37:56,260 --> 00:38:01,980
know why it should be pretty simple to
do but it failed every time that I tried

421
00:38:01,980 --> 00:38:05,410
and I finally got frustrated and said
screw it outright something to the temp

422
00:38:05,410 --> 00:38:11,060
directory it's only there for a second
and as long as it's not an executable

423
00:38:11,060 --> 00:38:19,109
file the AV products students in it so
once it writes it to disk its then going

424
00:38:19,109 --> 00:38:23,529
to run the script save the output to
another temp file and then send the

425
00:38:23,530 --> 00:38:27,940
results to these centres address so
whatever email it came from is the one

426
00:38:27,940 --> 00:38:31,450
that's going to send the email back to
its then going to delete everything

427
00:38:31,450 --> 00:38:37,279
clean up and life is good so I'm gonna
go ahead and play the video for this you

428
00:38:37,280 --> 00:38:47,040
will notice there are some pop up video
and we will go over like this pop up so

429
00:38:47,040 --> 00:38:57,480
there ya so the popups you'll notice
they're very obvious pop-ups so the

430
00:38:57,480 --> 00:39:02,560
first one is going to be outlook saying
someone's trying to access outlook do

431
00:39:02,560 --> 00:39:06,250
you want to allow them to do this and
this crippled just pause until the user

432
00:39:06,250 --> 00:39:10,420
click Yes allow it for X amount of time
the second one is going to be

433
00:39:11,520 --> 00:39:14,770
outside application is trying to send an
email on your behalf do you want to

434
00:39:14,770 --> 00:39:25,250
allow this to happen so bad pop ups but
it's waiting the it's a really simple

435
00:39:25,250 --> 00:39:29,330
one i believe i have it running late get
process so it's just running a simple

436
00:39:29,330 --> 00:39:35,310
one-line command executed and then we're
going to look in the Sent Items an

437
00:39:35,310 --> 00:39:39,730
attachment and they sent email back out
to see what it returned which will

438
00:39:39,730 --> 00:39:51,360
actually be the process list on this box
so we start the script momentarily video

439
00:39:51,360 --> 00:39:58,110
I thought it was ok so the scripts
running you can see it it's sitting

440
00:39:58,110 --> 00:40:03,650
there it's looking at its thinking it's
obviously not finding the email because

441
00:40:03,650 --> 00:40:06,240
it's not there it's in the junk folder

442
00:40:06,240 --> 00:40:10,180
there's the first pop-up ashey
somebody's trying to access outlook do

443
00:40:10,180 --> 00:40:13,480
you want to allow this organization
allow it for a minute

444
00:40:13,480 --> 00:40:16,830
script executes now it's like hey
someone sending an email on your behalf

445
00:40:16,830 --> 00:40:24,009
do you want to allow this we are going
to say yes and it will send the email

446
00:40:24,010 --> 00:40:31,510
response and life will be good look at
the San Items folder you can see that

447
00:40:31,510 --> 00:40:35,590
there is a text document attached to it
I just had it fired back with the

448
00:40:35,590 --> 00:40:40,350
generic email response to something like
here is the email you the information

449
00:40:40,350 --> 00:40:44,610
you requested and then it has to text
while the script would normally clean

450
00:40:44,610 --> 00:40:48,120
this up and clean all the evidence up
but then I wouldn't have had proved it

451
00:40:48,120 --> 00:40:53,170
worked so I commented out those sections
of the code to begin with so it ran our

452
00:40:53,170 --> 00:40:56,010
process list you can see it doesn't
match the process list of what is

453
00:40:56,010 --> 00:41:00,210
actually on the box so it did what it
was supposed to do with getting

454
00:41:00,210 --> 00:41:11,620
wonderful i love it when a plan comes
together alright so

455
00:41:11,620 --> 00:41:15,859
these are just rough tools obviously
they could use some finesse and polish

456
00:41:15,860 --> 00:41:20,560
basically made them as proof of concept
thing is that I would tweet about them

457
00:41:20,560 --> 00:41:27,460
for starters he would add encryption
customers don't usually like it when you

458
00:41:27,460 --> 00:41:28,600
take your information

459
00:41:28,600 --> 00:41:32,940
their information do not encrypted and
then sent it out to some random email

460
00:41:32,940 --> 00:41:39,860
address again a little angry and you're
not invited their network again I didn't

461
00:41:39,860 --> 00:41:43,740
put the encryption and yet because i
dont wanna try pulling my own encryption

462
00:41:43,740 --> 00:41:47,319
historically that does not go well and I
wanted to make sure that the scripps

463
00:41:47,320 --> 00:41:53,950
would work in function on older versions
of our show and nowadays you can just

464
00:41:53,950 --> 00:41:57,750
tell it to our children 5 you can tell
it to encrypt the contents for you

465
00:41:57,750 --> 00:42:01,240
command get bought it but the older
PowerShell version doesn't support them

466
00:42:01,240 --> 00:42:04,770
you have to go through a long series of
steps encrypted data so I wouldn't do

467
00:42:04,770 --> 00:42:07,800
that also I would like to eventually
take all the pieces merge them together

468
00:42:07,800 --> 00:42:13,290
into one script one ring to rule them
all and have one thing that does

469
00:42:13,290 --> 00:42:19,190
everything for you so it could set up
your persistence a lot of these could be

470
00:42:19,190 --> 00:42:22,820
done for the same thing right you could
have the automation set up and if you

471
00:42:22,820 --> 00:42:27,470
need it she'll just leave your payload
on the box as well and text file that

472
00:42:27,470 --> 00:42:32,640
you attach just start process whatever
your payload it so the automation could

473
00:42:32,640 --> 00:42:36,200
just start your payload and then return
an e-mail to The Hague

474
00:42:36,200 --> 00:42:40,330
just called you back so you can merge
them in that sense and used one for

475
00:42:40,330 --> 00:42:48,580
multiple functions I would like to get
them all together so it's kinda shady to

476
00:42:48,580 --> 00:42:51,960
tell people how to do all things and
then tell them how to protect their

477
00:42:51,960 --> 00:42:55,270
networks from these awesome things so
how do you protect yourself

478
00:42:56,170 --> 00:43:04,390
step one is kill your baby I know that
doesn't seem like a good thing I could

479
00:43:04,390 --> 00:43:08,540
go on for hours and hours about the
shortcomings of antivirus products

480
00:43:08,540 --> 00:43:13,130
personally my baby product is its
internals I don't even run one of my

481
00:43:13,130 --> 00:43:17,930
boxes there all total crap I can do more
with this internal is defined in my box

482
00:43:17,930 --> 00:43:21,230
than any AV product I now

483
00:43:21,230 --> 00:43:25,060
so this wonderful pop ups in the fourth
video if you notice the first three

484
00:43:25,060 --> 00:43:28,060
videos there's a little thing in the top
corner that said komodo you are

485
00:43:28,060 --> 00:43:29,910
protected

486
00:43:29,910 --> 00:43:35,790
Navy product Courtney got these pop-ups
because there's no easy product outlook

487
00:43:35,790 --> 00:43:38,940
has built-in security features to
protect you

488
00:43:38,940 --> 00:43:42,619
they are things like if someone tries
access outlook it makes a popup that

489
00:43:42,619 --> 00:43:46,530
says do you want to allow this and for
how long it took to try to send an email

490
00:43:46,530 --> 00:43:50,140
from an outside application it makes a
popup that says hey someone is doing

491
00:43:50,140 --> 00:43:56,509
this it's shady to install a security
product and it registers and is fully

492
00:43:56,510 --> 00:44:01,210
updated outlook assumes that the eighty
product is going to do the protection

493
00:44:01,210 --> 00:44:06,090
for them and that they don't actually do
anything so it disables all the built-in

494
00:44:06,090 --> 00:44:13,730
protections for Outlook so that would be
being number one is a product that

495
00:44:13,730 --> 00:44:15,510
doesn't stop probably pay for it

496
00:44:15,510 --> 00:44:21,680
yeah there is no good creative people
ask me all the time

497
00:44:21,680 --> 00:44:25,910
great baby product I was like how much
you looking to spend like nothing like

498
00:44:25,910 --> 00:44:31,089
there isn't one sorry no one gives away
amazing things for free so short of that

499
00:44:31,090 --> 00:44:36,080
your only real option is to catch these
things when they happen and catch them

500
00:44:36,080 --> 00:44:39,310
quickly at the end of the day there's
almost nothing you can do in a windows

501
00:44:39,310 --> 00:44:43,890
box that there's not a way to capture it
in the event logs and yes an attacker

502
00:44:43,890 --> 00:44:49,430
can just blow away the entire event log
but who really knows that then you know

503
00:44:49,430 --> 00:44:52,640
the exact date and time that something
bad happened in the box it'll be the

504
00:44:52,640 --> 00:44:57,420
time when there's an injury that says
the ball was cleared so there's a number

505
00:44:57,420 --> 00:45:00,810
of things you can do in the event logs
that will catch these things for

506
00:45:00,810 --> 00:45:06,140
starters audit process creation when you
audit process creation if you're on

507
00:45:06,140 --> 00:45:10,920
Windows 7 or nowhere and you have that
hatch install there's an option that

508
00:45:10,920 --> 00:45:16,460
says include command line so when this
execute every process that starts up it

509
00:45:16,460 --> 00:45:22,030
also puts the exact command line that
started that process so yeah you had

510
00:45:22,030 --> 00:45:25,609
power choking off well what started
PowerShell and it will have the trigger

511
00:45:25,609 --> 00:45:29,850
line your persistence point started
pretty easy to catch things then

512
00:45:29,850 --> 00:45:32,839
assuming that someone actually looks at
the event log

513
00:45:32,839 --> 00:45:38,130
box other things turn on PowerShell
logging so it's there for a reason

514
00:45:38,670 --> 00:45:44,119
on kernel six and newer or at least 61
in newer there is a special event log

515
00:45:44,119 --> 00:45:50,979
just for PowerShell it should be used if
you have PowerShell for you were there

516
00:45:50,979 --> 00:45:55,538
is even a great thing called mandatory
transcription so what this is going to

517
00:45:55,539 --> 00:46:01,140
do is everytime PowerShell starts it's
gonna create a transcript so this time

518
00:46:01,140 --> 00:46:05,828
that PowerShell started the time that it
stopped and in between those every

519
00:46:05,829 --> 00:46:10,180
command was executed in the output from
those commands and it writes all this

520
00:46:10,180 --> 00:46:14,430
off to a text document you can turn it
on to make it mandatory so every

521
00:46:14,430 --> 00:46:18,489
powershell script that runs on the box
its carefully catalogued and saved in a

522
00:46:18,489 --> 00:46:23,180
series of text files that you can then
read and see you it's a great teacher

523
00:46:23,180 --> 00:46:35,160
that Colonel Sanders don't use but they
really should show some quick little

524
00:46:35,160 --> 00:46:41,598
credits you have said Wilson Microsoft
scripting again he's the one he had

525
00:46:41,599 --> 00:46:45,420
exporting your Outlook calendar that's
the article the game the inspiration to

526
00:46:45,420 --> 00:46:50,690
data mining crap out of Outlook and all
the other triggered things the game

527
00:46:50,690 --> 00:46:55,109
originally from Matt Nelson's trigger
script that is on his own web page it's

528
00:46:55,109 --> 00:46:58,279
a good little trigger script again he
did it is very rough proof of concept

529
00:46:58,279 --> 00:47:03,410
code no intention of actually using it
so I just took his ideas and expound on

530
00:47:03,410 --> 00:47:11,379
them and made slightly more advanced
concepts that is my get home link where

531
00:47:11,380 --> 00:47:15,089
all the scripts from today's talks are
up there are more than welcome to take

532
00:47:15,089 --> 00:47:17,109
them play with them do what you would
like

533
00:47:17,109 --> 00:47:25,960
again I would probably take them a bit
before using environment that anybody

534
00:47:25,960 --> 00:47:28,960
have any questions yes

535
00:47:41,019 --> 00:48:13,828
to get the transport ideally you're
gonna have to be from something internal

536
00:48:13,829 --> 00:48:15,130
to begin with

537
00:48:15,130 --> 00:48:22,279
exactly but it's not be able to install
the scripts on the boxy one already

538
00:48:22,279 --> 00:48:30,099
anyways the big thing yet to get past
the SEL and then you really you have to

539
00:48:30,099 --> 00:48:36,619
set a rule and modify it and it's really
hard to do that you were really bad he

540
00:48:36,619 --> 00:48:41,319
likes to you know remote into is
Exchange server from home and it seems

541
00:48:41,319 --> 00:48:44,890
describes are safe if you've managed to
get the admin creds there's no reason

542
00:48:44,890 --> 00:48:49,739
you can't PowerShell remote into that
exchange box from anywhere and then once

543
00:48:49,739 --> 00:48:52,559
you do that you can modify everything to
your heart's content

544
00:48:52,559 --> 00:49:00,189
you can set specific SEL so that your
particular emails just don't get sup yes

545
00:49:42,000 --> 00:49:52,250
yeah you can even have funders a
sendmail message command and PowerShell

546
00:49:52,250 --> 00:49:56,680
did it doesn't work very well for
external emails but once you get on a

547
00:49:56,680 --> 00:50:01,350
semi truck tool box it's a lot of fun
you can just you can specify any from

548
00:50:01,350 --> 00:50:04,810
address you want it doesn't care it
doesn't check and adjust populates the

549
00:50:04,810 --> 00:50:11,250
field so I set one of my coworkers a
email saying oh I really love your work

550
00:50:11,250 --> 00:50:13,890
can you send us your resume can we get
together I think I have a good

551
00:50:13,890 --> 00:50:20,150
opportunity for you and I sent it from
and soccer Birgit facebook.com and it it

552
00:50:20,150 --> 00:50:25,910
seems that justice that makes me a
little pop up its not gonna get you past

553
00:50:25,910 --> 00:50:31,180
your essay else but you can just being
else it's built in the PowerShell the

554
00:50:31,180 --> 00:50:34,430
emails yes

555
00:50:43,020 --> 00:50:48,470
reading what's on the client whatever
that outlook has access to so if they

556
00:50:48,470 --> 00:50:52,230
opened up their outlook and look in the
folder anything they can see the scripts

557
00:50:52,230 --> 00:50:55,230
as well

558
00:51:13,770 --> 00:51:18,070
but I found I tried it on a couple
different outlook worsens I believe it

559
00:51:18,070 --> 00:51:19,430
works on everything

560
00:51:19,430 --> 00:51:25,720
2007 and newer I didn't try anything
other than that but regardless of the

561
00:51:25,720 --> 00:51:31,060
API used they all still use the same set
com objects and the same dotnet

562
00:51:31,060 --> 00:51:36,380
assemblies so that's what we're actually
grabbing and leveraging so by doing that

563
00:51:36,380 --> 00:51:41,250
it doesn't matter what edi using the
side we're using basically the blood and

564
00:51:41,250 --> 00:51:44,640
guts the system itself

565
00:51:44,640 --> 00:51:49,560
else know when that case I believe it's
just about beer 30

