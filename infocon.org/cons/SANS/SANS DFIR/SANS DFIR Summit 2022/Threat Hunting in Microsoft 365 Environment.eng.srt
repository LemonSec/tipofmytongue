1
00:00:00,659 --> 00:00:02,960
foreign

2
00:00:05,660 --> 00:00:07,740
thanks a lot for joining this session

3
00:00:07,740 --> 00:00:09,660
threat hunting in Microsoft 365

4
00:00:09,660 --> 00:00:12,420
environment I'm chiru I'm a city manager

5
00:00:12,420 --> 00:00:14,340
in mandian Consulting

6
00:00:14,340 --> 00:00:16,500
predominantly supporting customers to

7
00:00:16,500 --> 00:00:18,180
respond and remediate to major security

8
00:00:18,180 --> 00:00:19,380
breaches

9
00:00:19,380 --> 00:00:21,240
and to proactively assess the security

10
00:00:21,240 --> 00:00:22,920
portion of their cloud and identity

11
00:00:22,920 --> 00:00:24,060
environment

12
00:00:24,060 --> 00:00:25,920
in today's session we'll be talking

13
00:00:25,920 --> 00:00:27,720
about some of the adversarial techniques

14
00:00:27,720 --> 00:00:29,820
observed in Microsoft 365 environment

15
00:00:29,820 --> 00:00:32,640
and how to hunt these techniques

16
00:00:32,640 --> 00:00:34,559
I'm going to take a pass for a while I'm

17
00:00:34,559 --> 00:00:36,600
going to let my co-speaker anurag to

18
00:00:36,600 --> 00:00:40,700
introduce himself and continue the talk

19
00:00:40,800 --> 00:00:44,219
thank you hey everyone my name is anurag

20
00:00:44,219 --> 00:00:46,140
I'm a manager with crowdstrike instant

21
00:00:46,140 --> 00:00:48,719
Response Team here in Asia Pacific I

22
00:00:48,719 --> 00:00:50,340
work with a lot of organizations when

23
00:00:50,340 --> 00:00:52,320
they are battling threat actors when

24
00:00:52,320 --> 00:00:54,780
they are responding to breaches I'm also

25
00:00:54,780 --> 00:00:56,640
a instructor with the Science Institute

26
00:00:56,640 --> 00:00:59,100
and I've spoken at several conferences

27
00:00:59,100 --> 00:01:01,860
before and as thiru said we're going to

28
00:01:01,860 --> 00:01:03,739
today talk about

29
00:01:03,739 --> 00:01:07,439
M365 or Microsoft 365 services

30
00:01:07,439 --> 00:01:10,140
now we're going to look at how thread

31
00:01:10,140 --> 00:01:13,320
actors Target Microsoft 365 we'll talk

32
00:01:13,320 --> 00:01:15,780
through how Defenders can hunt for these

33
00:01:15,780 --> 00:01:17,220
attackers techniques which we're going

34
00:01:17,220 --> 00:01:19,260
to talk about uh we'll look we're going

35
00:01:19,260 --> 00:01:21,000
to look at multiple ways of doing this

36
00:01:21,000 --> 00:01:24,360
threat hunting we will look at how

37
00:01:24,360 --> 00:01:27,240
Defenders can look at configuration as

38
00:01:27,240 --> 00:01:29,700
well as how Defenders can look at logs

39
00:01:29,700 --> 00:01:31,500
to identify if these activities are

40
00:01:31,500 --> 00:01:33,200
happening in the environment

41
00:01:33,200 --> 00:01:36,060
the question that comes up is why talk

42
00:01:36,060 --> 00:01:37,860
about a software as a service platform

43
00:01:37,860 --> 00:01:40,020
and then talk about threat hunting and

44
00:01:40,020 --> 00:01:41,640
software as a service platform now

45
00:01:41,640 --> 00:01:44,460
Microsoft 365 is not any common SAS

46
00:01:44,460 --> 00:01:47,400
platform it is a productivity platform

47
00:01:47,400 --> 00:01:50,159
which is widely used probably the most

48
00:01:50,159 --> 00:01:52,259
common software as a service solution

49
00:01:52,259 --> 00:01:55,439
across the globe a lot of organizations

50
00:01:55,439 --> 00:01:57,240
use it they use it for very critical

51
00:01:57,240 --> 00:01:59,520
purposes they use it to communicate they

52
00:01:59,520 --> 00:02:02,700
use it to store files to share files so

53
00:02:02,700 --> 00:02:04,860
there are a lot of these Services which

54
00:02:04,860 --> 00:02:07,799
M365 comes with now we are talking about

55
00:02:07,799 --> 00:02:10,258
exchange online teams power automate

56
00:02:10,258 --> 00:02:13,379
also known as flows OneDrive SharePoint

57
00:02:13,379 --> 00:02:16,459
online and several of these that makes

58
00:02:16,459 --> 00:02:20,760
M365 a very lucrative Target for threat

59
00:02:20,760 --> 00:02:21,900
actors

60
00:02:21,900 --> 00:02:24,180
which obviously makes it very important

61
00:02:24,180 --> 00:02:26,640
for us Defenders to be able to

62
00:02:26,640 --> 00:02:29,400
understand this understand how M365

63
00:02:29,400 --> 00:02:31,739
Works understand how threat actors

64
00:02:31,739 --> 00:02:35,400
Target M365 and then to be able to hunt

65
00:02:35,400 --> 00:02:37,500
for techniques of threat actors across

66
00:02:37,500 --> 00:02:39,239
the environment and that's what we're

67
00:02:39,239 --> 00:02:41,459
going to talk about today

68
00:02:41,459 --> 00:02:44,580
which ttps are we going to talk about as

69
00:02:44,580 --> 00:02:48,620
I talked about M365 is huge it's complex

70
00:02:48,620 --> 00:02:51,720
it's used in a lot of different ways so

71
00:02:51,720 --> 00:02:53,519
there are multiple ways how threat

72
00:02:53,519 --> 00:02:55,860
actors Target this platform we have

73
00:02:55,860 --> 00:02:57,540
picked up certain techniques which we

74
00:02:57,540 --> 00:03:00,239
have seen protectors use in the wild and

75
00:03:00,239 --> 00:03:02,400
put those together for sharing it with

76
00:03:02,400 --> 00:03:04,860
community and see how these techniques

77
00:03:04,860 --> 00:03:07,080
work and then we'll talk about how

78
00:03:07,080 --> 00:03:09,420
hunting can be done looking for these

79
00:03:09,420 --> 00:03:12,900
techniques in M365 tenant

80
00:03:12,900 --> 00:03:15,840
the way we have structured this talk is

81
00:03:15,840 --> 00:03:17,099
we're going to pick up one technique

82
00:03:17,099 --> 00:03:19,260
we'll talk how this technique works and

83
00:03:19,260 --> 00:03:20,700
what is the purpose of this technique

84
00:03:20,700 --> 00:03:23,700
how what are the protector ways of

85
00:03:23,700 --> 00:03:25,200
implementing this so can they use

86
00:03:25,200 --> 00:03:27,060
Powershell they can use graphical user

87
00:03:27,060 --> 00:03:29,400
interface and then we look at how

88
00:03:29,400 --> 00:03:30,659
Defenders can hunt it through

89
00:03:30,659 --> 00:03:32,459
configuration

90
00:03:32,459 --> 00:03:34,680
as well as logging so Carlos pointed out

91
00:03:34,680 --> 00:03:36,480
to ual log we'll talk about that we'll

92
00:03:36,480 --> 00:03:40,319
talk about AAL log it is important for

93
00:03:40,319 --> 00:03:42,360
Defenders to understand both ways of

94
00:03:42,360 --> 00:03:44,459
doing threat hunting so not only get

95
00:03:44,459 --> 00:03:46,920
stuck with configuration based threat

96
00:03:46,920 --> 00:03:48,360
hunting but also be able to do log base

97
00:03:48,360 --> 00:03:50,099
threat hunting they are kind of

98
00:03:50,099 --> 00:03:52,440
complementary to each other you cannot

99
00:03:52,440 --> 00:03:54,200
do log base threat hunting

100
00:03:54,200 --> 00:03:56,819
unless you have turned them on which a

101
00:03:56,819 --> 00:03:58,319
lot of organizations don't do that so

102
00:03:58,319 --> 00:03:59,940
it's important and critical to

103
00:03:59,940 --> 00:04:02,519
understand both ways of doing hunting I

104
00:04:02,519 --> 00:04:04,379
will start talking about exchange online

105
00:04:04,379 --> 00:04:06,959
service exchange is one of the most

106
00:04:06,959 --> 00:04:10,680
commonly used service from M365 platform

107
00:04:10,680 --> 00:04:13,319
we'll look at that then we look at

108
00:04:13,319 --> 00:04:15,120
Microsoft flows also known as power

109
00:04:15,120 --> 00:04:17,579
automate that is the automation platform

110
00:04:17,579 --> 00:04:21,000
in M365 the automation application

111
00:04:21,000 --> 00:04:23,340
we'll see how attackers can use that and

112
00:04:23,340 --> 00:04:26,220
misuse those then Theory will talk about

113
00:04:26,220 --> 00:04:28,979
persistent privileged role illicit oauth

114
00:04:28,979 --> 00:04:30,300
grants another very big problem with

115
00:04:30,300 --> 00:04:33,660
M365 applications uh we'll touch upon

116
00:04:33,660 --> 00:04:36,060
SharePoint online how detectors can

117
00:04:36,060 --> 00:04:38,520
Target that and we look at some ways of

118
00:04:38,520 --> 00:04:40,979
how threat actors can have persistent

119
00:04:40,979 --> 00:04:43,259
access to M365 applications and then

120
00:04:43,259 --> 00:04:45,060
we're going to wrap this up we have a

121
00:04:45,060 --> 00:04:46,440
summary slide in the end which everyone

122
00:04:46,440 --> 00:04:48,120
can take away with them

123
00:04:48,120 --> 00:04:51,300
so that's what we're going to do do one

124
00:04:51,300 --> 00:04:54,840
thing here is uh we we are in a lot of

125
00:04:54,840 --> 00:04:56,639
these tactics and techniques which we're

126
00:04:56,639 --> 00:04:59,100
going to talk about assuming that the

127
00:04:59,100 --> 00:05:00,960
threat actor has already gained access

128
00:05:00,960 --> 00:05:03,600
to the environment that access could

129
00:05:03,600 --> 00:05:05,340
have been gained by sometimes just

130
00:05:05,340 --> 00:05:07,680
guessing passwords sometimes doing

131
00:05:07,680 --> 00:05:10,080
credential stuffing finding ways of

132
00:05:10,080 --> 00:05:12,120
bypassing MFA which we're going to touch

133
00:05:12,120 --> 00:05:13,979
upon in one in some of the techniques

134
00:05:13,979 --> 00:05:15,660
which we're going to talk about but

135
00:05:15,660 --> 00:05:18,000
often it is not that difficult for a

136
00:05:18,000 --> 00:05:20,400
thread actor to get the first level of

137
00:05:20,400 --> 00:05:22,320
access in the environment often even

138
00:05:22,320 --> 00:05:24,600
Global admin access which we have seen

139
00:05:24,600 --> 00:05:26,940
in a lot of cases which we have seen in

140
00:05:26,940 --> 00:05:29,039
a lot of public documentation that has

141
00:05:29,039 --> 00:05:30,240
come out

142
00:05:30,240 --> 00:05:32,160
so let's get started and start talk

143
00:05:32,160 --> 00:05:34,380
start talking about exchange online

144
00:05:34,380 --> 00:05:37,800
service that's the outlook.com this is

145
00:05:37,800 --> 00:05:39,419
the email service which a lot of people

146
00:05:39,419 --> 00:05:43,320
use the the Workhorse of a lot of

147
00:05:43,320 --> 00:05:45,840
organizations and we're going to talk

148
00:05:45,840 --> 00:05:47,639
about a few things here we'll talk about

149
00:05:47,639 --> 00:05:49,500
how email forwarding is a very big

150
00:05:49,500 --> 00:05:52,380
problem which threatenators abuse so

151
00:05:52,380 --> 00:05:54,240
that they can continuously have access

152
00:05:54,240 --> 00:05:56,340
to an environment they can perform

153
00:05:56,340 --> 00:05:58,860
exfiltration continuously so we'll talk

154
00:05:58,860 --> 00:06:01,680
a number of ways of how email forwarding

155
00:06:01,680 --> 00:06:03,840
can be set up then we look at two

156
00:06:03,840 --> 00:06:05,580
another two other ways of how

157
00:06:05,580 --> 00:06:08,360
permissions can be granted to inbox

158
00:06:08,360 --> 00:06:11,699
specific folders and how that probably

159
00:06:11,699 --> 00:06:13,979
can be misused by a lot of thread actors

160
00:06:13,979 --> 00:06:16,919
so let's start talking through

161
00:06:16,919 --> 00:06:19,320
the first part which is automated email

162
00:06:19,320 --> 00:06:22,020
forwarding which is probably the biggest

163
00:06:22,020 --> 00:06:24,780
problem in M365 which a lot of

164
00:06:24,780 --> 00:06:26,759
organizations are dealing with

165
00:06:26,759 --> 00:06:29,580
now be it your nation state protectors

166
00:06:29,580 --> 00:06:32,520
the the apex predator orbit your

167
00:06:32,520 --> 00:06:34,440
business email compromise and e-crying

168
00:06:34,440 --> 00:06:36,240
protectors both of these different

169
00:06:36,240 --> 00:06:38,580
protectors they often use email

170
00:06:38,580 --> 00:06:41,340
forwarding sometimes to continuously

171
00:06:41,340 --> 00:06:43,259
gain access as I said and do

172
00:06:43,259 --> 00:06:45,539
exfiltration and sometimes just to focus

173
00:06:45,539 --> 00:06:47,639
on those accounting related emails that

174
00:06:47,639 --> 00:06:49,560
come in so that they can use that

175
00:06:49,560 --> 00:06:52,319
information and can commit a email fraud

176
00:06:52,319 --> 00:06:55,080
so this is a big problem with a lot of

177
00:06:55,080 --> 00:06:57,419
organizations are facing the challenge

178
00:06:57,419 --> 00:07:00,300
here being that it's not only one way

179
00:07:00,300 --> 00:07:02,520
how this can be configured so there are

180
00:07:02,520 --> 00:07:04,740
multiple ways how automated email

181
00:07:04,740 --> 00:07:07,139
forwarding can be configured in an M365

182
00:07:07,139 --> 00:07:09,180
environment we're going to talk about

183
00:07:09,180 --> 00:07:11,039
some of those ways so we'll talk about

184
00:07:11,039 --> 00:07:13,560
mailbox email forwarding then we'll talk

185
00:07:13,560 --> 00:07:15,479
about inbox rules we'll talk about

186
00:07:15,479 --> 00:07:17,699
transport rules and later in our

187
00:07:17,699 --> 00:07:19,800
discussion we'll also look at how

188
00:07:19,800 --> 00:07:22,319
Microsoft flows also known as power

189
00:07:22,319 --> 00:07:25,620
automate can be used to set up these

190
00:07:25,620 --> 00:07:27,479
email forwarding so it's a very novel

191
00:07:27,479 --> 00:07:29,759
way of doing that probably more

192
00:07:29,759 --> 00:07:31,620
difficult to detect because a lot of

193
00:07:31,620 --> 00:07:33,720
people are not looking at that so let's

194
00:07:33,720 --> 00:07:37,139
start first talking about

195
00:07:37,139 --> 00:07:39,900
uh mailbox email forwarding so in

196
00:07:39,900 --> 00:07:42,660
mailbox email forwarding uh email

197
00:07:42,660 --> 00:07:44,880
forwarding can be configured as part of

198
00:07:44,880 --> 00:07:46,919
the user mailbox setting so on the right

199
00:07:46,919 --> 00:07:49,680
hand side here you see how this can be

200
00:07:49,680 --> 00:07:51,919
configured in a graphical user interface

201
00:07:51,919 --> 00:07:55,919
where an attribute called forward SMTP

202
00:07:55,919 --> 00:07:57,780
address is being configured so there are

203
00:07:57,780 --> 00:07:59,699
two ways how mailbox email forwarding

204
00:07:59,699 --> 00:08:01,259
can be configured

205
00:08:01,259 --> 00:08:03,180
using an attribute called forwarding

206
00:08:03,180 --> 00:08:05,699
SMTP address and the other one using

207
00:08:05,699 --> 00:08:07,860
forwarding address now in case of

208
00:08:07,860 --> 00:08:10,680
forwarding SMTP address it is important

209
00:08:10,680 --> 00:08:11,900
that

210
00:08:11,900 --> 00:08:15,720
the object to which the forwarding is

211
00:08:15,720 --> 00:08:17,520
being configured

212
00:08:17,520 --> 00:08:21,800
the object has a male enabled object is

213
00:08:21,800 --> 00:08:25,080
uh it can be an external object so it

214
00:08:25,080 --> 00:08:26,400
doesn't have to be an internal object

215
00:08:26,400 --> 00:08:29,580
whereas in case of forwarding address

216
00:08:29,580 --> 00:08:31,560
it needs to be an internal mailbox

217
00:08:31,560 --> 00:08:33,958
attribute so typically if you look at

218
00:08:33,958 --> 00:08:36,059
this forwarding address would typically

219
00:08:36,059 --> 00:08:37,860
be used for internal emails whereas for

220
00:08:37,860 --> 00:08:39,839
putting SMTP address can be used for

221
00:08:39,839 --> 00:08:43,140
external emails also depending on where

222
00:08:43,140 --> 00:08:45,720
the mail enabled object exists in your

223
00:08:45,720 --> 00:08:47,820
active directory so two different ways

224
00:08:47,820 --> 00:08:51,420
of how object attributes can be used to

225
00:08:51,420 --> 00:08:53,880
set up email forwarding the way a thread

226
00:08:53,880 --> 00:08:56,519
actor can do this using Powershell is

227
00:08:56,519 --> 00:08:59,339
use the set mailbox command Powershell

228
00:08:59,339 --> 00:09:01,320
commandlet where they can put an

229
00:09:01,320 --> 00:09:03,120
identity for which they want to forward

230
00:09:03,120 --> 00:09:06,000
email like here we are showing victim as

231
00:09:06,000 --> 00:09:08,640
the victim identity and then they can

232
00:09:08,640 --> 00:09:11,040
set up forwarding SMTP address to a

233
00:09:11,040 --> 00:09:14,279
email address which they controlled once

234
00:09:14,279 --> 00:09:16,620
this has been set up the emails would

235
00:09:16,620 --> 00:09:18,720
then be forwarded to the threat actor

236
00:09:18,720 --> 00:09:20,880
controlled email address which in this

237
00:09:20,880 --> 00:09:23,580
case is attacker protector.dev that's

238
00:09:23,580 --> 00:09:24,779
the structure we're going to follow so

239
00:09:24,779 --> 00:09:26,279
we will talk about

240
00:09:26,279 --> 00:09:28,860
The Protector technique first like I'm

241
00:09:28,860 --> 00:09:31,740
doing right now and then let's talk

242
00:09:31,740 --> 00:09:35,399
about how Defenders can hunt for these

243
00:09:35,399 --> 00:09:37,860
first as part of configuration as I said

244
00:09:37,860 --> 00:09:40,740
it's important for us as Defenders to

245
00:09:40,740 --> 00:09:42,899
understand how threat hunting can be

246
00:09:42,899 --> 00:09:43,920
done

247
00:09:43,920 --> 00:09:46,680
with the configuration information not

248
00:09:46,680 --> 00:09:49,860
only the logs part of it so here we are

249
00:09:49,860 --> 00:09:52,200
showing a Powershell commandlet get

250
00:09:52,200 --> 00:09:54,839
mailbox so what this does is it gets all

251
00:09:54,839 --> 00:09:57,899
the mailboxes configured in M365 and

252
00:09:57,899 --> 00:10:00,540
then it looks for objects where

253
00:10:00,540 --> 00:10:04,380
forwarding SMTP address has been set

254
00:10:04,380 --> 00:10:06,540
so it would give you a list of all the

255
00:10:06,540 --> 00:10:09,000
email boxes mailboxes we're forwarding

256
00:10:09,000 --> 00:10:11,399
SMTP address has been set you can do the

257
00:10:11,399 --> 00:10:13,140
similar thing for for wedding address

258
00:10:13,140 --> 00:10:15,899
also what we need to look at here is

259
00:10:15,899 --> 00:10:18,600
typically email addresses which are

260
00:10:18,600 --> 00:10:20,760
external email addresses which do not

261
00:10:20,760 --> 00:10:22,800
belong to the same user for which the

262
00:10:22,800 --> 00:10:25,500
mailbox is and something which may not

263
00:10:25,500 --> 00:10:27,660
be approved as part of the business so

264
00:10:27,660 --> 00:10:28,620
that's how you look at this

265
00:10:28,620 --> 00:10:31,260
configuration it does require some

266
00:10:31,260 --> 00:10:33,540
manual effort to go through this but

267
00:10:33,540 --> 00:10:36,240
that's a way of doing it based on the

268
00:10:36,240 --> 00:10:38,339
configuration that is available

269
00:10:38,339 --> 00:10:40,680
Carlos touched upon unified audit log

270
00:10:40,680 --> 00:10:44,540
ual is the Workhorse logging platform in

271
00:10:44,540 --> 00:10:47,940
m365. it includes user logs it includes

272
00:10:47,940 --> 00:10:49,620
admin logs and it includes a lot of

273
00:10:49,620 --> 00:10:52,320
different logging what you can do as

274
00:10:52,320 --> 00:10:56,760
Defender is go through these UL logs and

275
00:10:56,760 --> 00:10:59,820
look for specific set mailbox operations

276
00:10:59,820 --> 00:11:02,220
now what we showed was the protector

277
00:11:02,220 --> 00:11:04,800
using set mailbox operation and here we

278
00:11:04,800 --> 00:11:07,740
are searching through the UA log for any

279
00:11:07,740 --> 00:11:11,040
usage of set mailbox for specific start

280
00:11:11,040 --> 00:11:13,980
date and end date and if there is a

281
00:11:13,980 --> 00:11:16,160
parameter for forwarding SMTP address

282
00:11:16,160 --> 00:11:18,600
that will come up and we are searching

283
00:11:18,600 --> 00:11:20,640
for that now one thing to keep in mind

284
00:11:20,640 --> 00:11:22,860
for a lot of these techniques which we

285
00:11:22,860 --> 00:11:25,320
are talking about is to understand that

286
00:11:25,320 --> 00:11:28,079
detectors can use variations of these so

287
00:11:28,079 --> 00:11:29,700
while we are giving one example of this

288
00:11:29,700 --> 00:11:31,560
is how you can search for this but that

289
00:11:31,560 --> 00:11:33,240
doesn't mean that will work for all the

290
00:11:33,240 --> 00:11:35,640
different variations which are protector

291
00:11:35,640 --> 00:11:37,380
may use so it's always good to be

292
00:11:37,380 --> 00:11:38,880
Innovative and think about different

293
00:11:38,880 --> 00:11:41,160
ways author detectors are using the same

294
00:11:41,160 --> 00:11:42,720
commandlets or sometimes different

295
00:11:42,720 --> 00:11:45,000
commandlets also so something to keep in

296
00:11:45,000 --> 00:11:46,200
mind

297
00:11:46,200 --> 00:11:49,500
this is how the output of that Search

298
00:11:49,500 --> 00:11:51,420
Command which we showed for ual will

299
00:11:51,420 --> 00:11:54,779
look like here the important part is to

300
00:11:54,779 --> 00:11:57,660
look at the operation so that is the set

301
00:11:57,660 --> 00:12:00,540
mailbox operation and the forwarding

302
00:12:00,540 --> 00:12:03,240
SMTP address so here a forwarding SMTP

303
00:12:03,240 --> 00:12:06,120
address value has been set for attacker

304
00:12:06,120 --> 00:12:09,660
at the rate protector.diff

305
00:12:09,779 --> 00:12:11,760
one important thing to pick up here is

306
00:12:11,760 --> 00:12:14,100
this workload field here in line 8 which

307
00:12:14,100 --> 00:12:16,680
you see that workload says exchange so

308
00:12:16,680 --> 00:12:19,560
workload is the application in M365

309
00:12:19,560 --> 00:12:22,800
which is generating this ual log which

310
00:12:22,800 --> 00:12:24,860
we are looking at

311
00:12:24,860 --> 00:12:27,959
that was mailbox rules now let's look at

312
00:12:27,959 --> 00:12:30,600
inbox rules how inbox rules can be set

313
00:12:30,600 --> 00:12:34,380
up by a thread actor to perform email

314
00:12:34,380 --> 00:12:36,480
forwarding uh standard difference

315
00:12:36,480 --> 00:12:39,779
between inbox rules is that inbox rules

316
00:12:39,779 --> 00:12:42,720
trigger once an email lands in an inbox

317
00:12:42,720 --> 00:12:45,839
so it is often used by a lot of users to

318
00:12:45,839 --> 00:12:47,700
move emails around in different folders

319
00:12:47,700 --> 00:12:49,860
depending on what project that email

320
00:12:49,860 --> 00:12:52,399
belongs to or what user that email comes

321
00:12:52,399 --> 00:12:55,440
from So based on that a lot of users use

322
00:12:55,440 --> 00:12:58,200
this inbox notes what the threat what a

323
00:12:58,200 --> 00:13:00,540
thread actor can do is use the same sort

324
00:13:00,540 --> 00:13:03,480
of inbox rules but this time instead of

325
00:13:03,480 --> 00:13:05,639
moving it into a folder they can just

326
00:13:05,639 --> 00:13:07,740
start copying those emails out to a

327
00:13:07,740 --> 00:13:10,380
attacker controlled email address on the

328
00:13:10,380 --> 00:13:11,760
right side you see how this can be

329
00:13:11,760 --> 00:13:13,860
configured in a graphical user interface

330
00:13:13,860 --> 00:13:16,680
so you can add a condition

331
00:13:16,680 --> 00:13:19,019
first you provide the name here we are

332
00:13:19,019 --> 00:13:20,399
providing malicious underscore forward

333
00:13:20,399 --> 00:13:22,440
obviously that's probably not what a

334
00:13:22,440 --> 00:13:24,240
thread actor would want to use they want

335
00:13:24,240 --> 00:13:25,860
to use something which is a little more

336
00:13:25,860 --> 00:13:27,540
difficult to identify

337
00:13:27,540 --> 00:13:29,639
and then you add a condition so this is

338
00:13:29,639 --> 00:13:31,260
a trigger which will trigger that inbox

339
00:13:31,260 --> 00:13:34,019
rule uh here we are showing apply to all

340
00:13:34,019 --> 00:13:36,180
the messages that come in and once that

341
00:13:36,180 --> 00:13:38,579
message hits the inbox just forward it

342
00:13:38,579 --> 00:13:40,399
to the attacker controlled email address

343
00:13:40,399 --> 00:13:44,100
that's the step two here this is this

344
00:13:44,100 --> 00:13:45,839
can be configured in GUI it can also be

345
00:13:45,839 --> 00:13:48,060
configured using Powershell so new inbox

346
00:13:48,060 --> 00:13:49,800
rule is the commandlet that a thread

347
00:13:49,800 --> 00:13:52,620
actor can use and create a forwarding in

348
00:13:52,620 --> 00:13:54,899
a inbox rule in the environment to

349
00:13:54,899 --> 00:13:57,420
forward the emails that come to that

350
00:13:57,420 --> 00:13:58,740
inbox

351
00:13:58,740 --> 00:14:01,440
hunting this so in case of configuration

352
00:14:01,440 --> 00:14:04,500
what we suggest is you look for all the

353
00:14:04,500 --> 00:14:07,620
mailboxes and for each mailbox you look

354
00:14:07,620 --> 00:14:09,420
for in the inbox rules that have been

355
00:14:09,420 --> 00:14:10,500
configured

356
00:14:10,500 --> 00:14:13,079
now if we start doing this for all the

357
00:14:13,079 --> 00:14:14,519
inbox rules

358
00:14:14,519 --> 00:14:16,260
it's going to be painful because as I

359
00:14:16,260 --> 00:14:18,540
said a lot of users use it so it's going

360
00:14:18,540 --> 00:14:21,000
to be a big result of all the inbox

361
00:14:21,000 --> 00:14:23,459
rules in the environment what you can

362
00:14:23,459 --> 00:14:25,500
focus on is things like forward to

363
00:14:25,500 --> 00:14:28,440
redirect to and forward is attachment to

364
00:14:28,440 --> 00:14:31,079
these are the typical settings which are

365
00:14:31,079 --> 00:14:33,660
used by attackers to make sure that the

366
00:14:33,660 --> 00:14:35,700
email gets forwarded to them so this

367
00:14:35,700 --> 00:14:38,339
might help to focus on only specific

368
00:14:38,339 --> 00:14:40,440
inbox rules rather than looking looking

369
00:14:40,440 --> 00:14:42,360
at everything which might be configured

370
00:14:42,360 --> 00:14:44,880
in your environment another tip here is

371
00:14:44,880 --> 00:14:47,880
to use this include hidden flag what

372
00:14:47,880 --> 00:14:50,040
this helps is when you give this you can

373
00:14:50,040 --> 00:14:52,620
look at any hidden inbox rules that

374
00:14:52,620 --> 00:14:53,940
might have been configured in the

375
00:14:53,940 --> 00:14:56,399
environment so something to keep in mind

376
00:14:56,399 --> 00:15:00,060
when it comes to logs in the ual which

377
00:15:00,060 --> 00:15:02,100
is the unified audit log you can perform

378
00:15:02,100 --> 00:15:04,560
a search going through the unified audit

379
00:15:04,560 --> 00:15:06,720
log looking at the operations we are

380
00:15:06,720 --> 00:15:08,699
looking at new inbox rule as well as set

381
00:15:08,699 --> 00:15:11,100
inbox rule here like I said it often

382
00:15:11,100 --> 00:15:13,079
pays to be Innovative and think about

383
00:15:13,079 --> 00:15:14,880
different ways how predictors can use

384
00:15:14,880 --> 00:15:16,620
this and then we are going through the

385
00:15:16,620 --> 00:15:19,920
data looking for forward to redirect to

386
00:15:19,920 --> 00:15:22,019
and forward as attachment to so again

387
00:15:22,019 --> 00:15:25,320
how detectors set these rules up once

388
00:15:25,320 --> 00:15:26,639
you do this search and if you get a hit

389
00:15:26,639 --> 00:15:29,240
this is how a result will look like

390
00:15:29,240 --> 00:15:32,399
operation is new inbox Rule and what we

391
00:15:32,399 --> 00:15:34,500
are focusing on is that forward to field

392
00:15:34,500 --> 00:15:36,980
so forward to field here is attacker at

393
00:15:36,980 --> 00:15:39,300
protector.dev if that is not something

394
00:15:39,300 --> 00:15:41,040
which has been configured by the user

395
00:15:41,040 --> 00:15:43,620
it's not a user email it's an external

396
00:15:43,620 --> 00:15:45,540
email that's some those are some red

397
00:15:45,540 --> 00:15:48,240
flags that should light up if you see an

398
00:15:48,240 --> 00:15:50,880
output like this so that was the second

399
00:15:50,880 --> 00:15:53,459
way now there's another way so as I said

400
00:15:53,459 --> 00:15:55,079
there are multiple ways of how these can

401
00:15:55,079 --> 00:15:57,060
be configured and that's what makes it

402
00:15:57,060 --> 00:15:59,040
tricky sometimes to look for all these

403
00:15:59,040 --> 00:16:01,500
different rules that are configured here

404
00:16:01,500 --> 00:16:03,540
we are looking at transport rules also

405
00:16:03,540 --> 00:16:06,240
known as mail flow rules and as the name

406
00:16:06,240 --> 00:16:09,360
says these get triggered while a message

407
00:16:09,360 --> 00:16:12,779
is in transit so this has a richer set

408
00:16:12,779 --> 00:16:14,820
of conditions it can do a lot of more

409
00:16:14,820 --> 00:16:17,160
different stuff but it also requires an

410
00:16:17,160 --> 00:16:19,500
admin access to exchange so an exchange

411
00:16:19,500 --> 00:16:21,660
admin access is typically required a

412
00:16:21,660 --> 00:16:23,940
privileged access is required but once

413
00:16:23,940 --> 00:16:26,399
detector has that they can set up these

414
00:16:26,399 --> 00:16:28,260
malicious forwarding rules where they

415
00:16:28,260 --> 00:16:29,880
can copy their email address to

416
00:16:29,880 --> 00:16:31,680
everything or BCC their email address

417
00:16:31,680 --> 00:16:35,160
making sure that they have continuous

418
00:16:35,160 --> 00:16:37,380
access to whatever messages or emails

419
00:16:37,380 --> 00:16:39,720
are coming to an inbox so here's an

420
00:16:39,720 --> 00:16:42,660
example of Powershell command let new

421
00:16:42,660 --> 00:16:44,940
transport rule being used by a thread

422
00:16:44,940 --> 00:16:47,339
actor to set up a malicious forward mail

423
00:16:47,339 --> 00:16:50,160
with a higher priority and making it

424
00:16:50,160 --> 00:16:53,100
enabled and every email that comes to

425
00:16:53,100 --> 00:16:55,440
victim at threat hunting here would be

426
00:16:55,440 --> 00:16:58,560
blind copy 2 or bcc2 attacker at

427
00:16:58,560 --> 00:17:01,620
protector.com making the threat actor

428
00:17:01,620 --> 00:17:04,079
giving threat actor capability to look

429
00:17:04,079 --> 00:17:06,059
at all the emails that is you this user

430
00:17:06,059 --> 00:17:07,439
receives

431
00:17:07,439 --> 00:17:09,480
hunting this through configuration would

432
00:17:09,480 --> 00:17:10,799
mean you are looking at all the

433
00:17:10,799 --> 00:17:12,660
transport rules again there might be a

434
00:17:12,660 --> 00:17:14,640
lot of Transport rules but you can focus

435
00:17:14,640 --> 00:17:17,400
only on things like blind copy 2 copy

436
00:17:17,400 --> 00:17:18,959
two and other things which you can go

437
00:17:18,959 --> 00:17:21,240
through uh again you know just just

438
00:17:21,240 --> 00:17:23,160
being Innovative helps when you are

439
00:17:23,160 --> 00:17:25,020
doing hunting

440
00:17:25,020 --> 00:17:27,240
looking at logs there are two different

441
00:17:27,240 --> 00:17:29,340
logs which can be used as this is a

442
00:17:29,340 --> 00:17:31,799
admin or a privileged operation you can

443
00:17:31,799 --> 00:17:34,620
look at admin audit logs or AEL logs

444
00:17:34,620 --> 00:17:36,480
where you are looking for new transport

445
00:17:36,480 --> 00:17:38,880
Rule and set transport rule usage as

446
00:17:38,880 --> 00:17:40,799
well as you can go through the ual or

447
00:17:40,799 --> 00:17:43,260
unified audit log looking for new

448
00:17:43,260 --> 00:17:45,059
transport Rule and set transport rule

449
00:17:45,059 --> 00:17:47,340
operations we have put a lot of code and

450
00:17:47,340 --> 00:17:48,840
a lot of stuff in the slides because we

451
00:17:48,840 --> 00:17:50,160
would like this to be used as a

452
00:17:50,160 --> 00:17:52,260
reference if need be so you can just

453
00:17:52,260 --> 00:17:54,539
take this away look at this code and use

454
00:17:54,539 --> 00:17:56,760
that instead of me going through each of

455
00:17:56,760 --> 00:17:58,140
the commander so that's the reason we

456
00:17:58,140 --> 00:17:59,880
have tried to put a lot of code and you

457
00:17:59,880 --> 00:18:01,200
know some of these slides really really

458
00:18:01,200 --> 00:18:03,600
look busy

459
00:18:03,600 --> 00:18:05,820
let's look at the output so if you have

460
00:18:05,820 --> 00:18:07,980
a hit this is how a hit will look like

461
00:18:07,980 --> 00:18:10,500
so operation is new transport rule

462
00:18:10,500 --> 00:18:13,320
and the name blind copy 2 has been set

463
00:18:13,320 --> 00:18:15,960
to attacker at protector.com so any

464
00:18:15,960 --> 00:18:17,700
email that is coming through is being

465
00:18:17,700 --> 00:18:20,760
blind copied to to attacker at

466
00:18:20,760 --> 00:18:22,740
protector.com here

467
00:18:22,740 --> 00:18:25,140
so that was all our different kind of

468
00:18:25,140 --> 00:18:27,480
inbox rules transport rules and mailbox

469
00:18:27,480 --> 00:18:29,520
rules which could be configured

470
00:18:29,520 --> 00:18:31,860
we're going to talk about the flow

471
00:18:31,860 --> 00:18:35,400
or Microsoft power automate but I'm

472
00:18:35,400 --> 00:18:36,780
going to do that a little later let's

473
00:18:36,780 --> 00:18:40,380
talk about two different ways of how a

474
00:18:40,380 --> 00:18:42,480
threat actor who has hacks had access in

475
00:18:42,480 --> 00:18:45,000
your environment can just set themselves

476
00:18:45,000 --> 00:18:47,940
up to be able to access an inbox

477
00:18:47,940 --> 00:18:50,640
again these are things which are

478
00:18:50,640 --> 00:18:52,980
typically used by the users by System

479
00:18:52,980 --> 00:18:55,559
administrators but they can be abused by

480
00:18:55,559 --> 00:18:57,120
threat actors like a lot of different

481
00:18:57,120 --> 00:18:58,620
things which we see when we perform

482
00:18:58,620 --> 00:18:59,880
threat hunting

483
00:18:59,880 --> 00:19:02,580
the first one is delegation settings now

484
00:19:02,580 --> 00:19:04,620
delegation settings are a very commonly

485
00:19:04,620 --> 00:19:07,020
used things in an Enterprise environment

486
00:19:07,020 --> 00:19:09,000
often you will see executive assistance

487
00:19:09,000 --> 00:19:11,400
they require access to an executive's

488
00:19:11,400 --> 00:19:13,799
mailbox that's where that mailbox

489
00:19:13,799 --> 00:19:15,440
delegation settings come into picture

490
00:19:15,440 --> 00:19:17,820
there are two specific delegation

491
00:19:17,820 --> 00:19:20,100
settings which we are interested in here

492
00:19:20,100 --> 00:19:22,200
one is called full access and the other

493
00:19:22,200 --> 00:19:24,200
one is called send as

494
00:19:24,200 --> 00:19:25,919
Y2

495
00:19:25,919 --> 00:19:28,320
I'll come to that in a second when you

496
00:19:28,320 --> 00:19:31,080
think about full access it appears you

497
00:19:31,080 --> 00:19:33,780
get all the excess right but but what

498
00:19:33,780 --> 00:19:36,179
happens here is when full excess is

499
00:19:36,179 --> 00:19:39,539
provided it just allows the delegate to

500
00:19:39,539 --> 00:19:41,880
open the mailbox and View and delete

501
00:19:41,880 --> 00:19:43,919
email so you are able to manage the

502
00:19:43,919 --> 00:19:44,940
mailbox

503
00:19:44,940 --> 00:19:47,340
and read the emails

504
00:19:47,340 --> 00:19:49,260
you see something missing there you

505
00:19:49,260 --> 00:19:51,179
cannot send the emails that's where send

506
00:19:51,179 --> 00:19:53,700
as delegation setting comes into picture

507
00:19:53,700 --> 00:19:57,179
so between full s full access and send

508
00:19:57,179 --> 00:19:59,820
as you get full access to the Inbox and

509
00:19:59,820 --> 00:20:01,860
you can read emails view emails delete

510
00:20:01,860 --> 00:20:03,960
emails and send emails and pretend to be

511
00:20:03,960 --> 00:20:07,140
that owner of that inbox these are

512
00:20:07,140 --> 00:20:08,880
Powershell Snippets of how these can be

513
00:20:08,880 --> 00:20:11,640
configured by a protector so just adding

514
00:20:11,640 --> 00:20:13,860
mailbox permission here and giving

515
00:20:13,860 --> 00:20:15,900
access rights at full access and adding

516
00:20:15,900 --> 00:20:17,240
recipient permission here and giving

517
00:20:17,240 --> 00:20:21,780
excess rights at send as this would only

518
00:20:21,780 --> 00:20:23,700
work out for a threat actor if threat

519
00:20:23,700 --> 00:20:25,260
actor has somehow gained access to the

520
00:20:25,260 --> 00:20:27,000
environment and has access to another

521
00:20:27,000 --> 00:20:30,059
inbox or if it's a malicious Insider so

522
00:20:30,059 --> 00:20:31,980
once they have that they can provide

523
00:20:31,980 --> 00:20:33,780
themselves these settings and then keep

524
00:20:33,780 --> 00:20:37,760
access to over these uh mailboxes

525
00:20:37,760 --> 00:20:41,039
this is how we can as Defenders look for

526
00:20:41,039 --> 00:20:44,520
these misconfigurations or attacker ttps

527
00:20:44,520 --> 00:20:47,760
here we are reviewing all the mailboxes

528
00:20:47,760 --> 00:20:49,500
which have full access permission

529
00:20:49,500 --> 00:20:52,620
configured in exchange online settings

530
00:20:52,620 --> 00:20:55,380
here we are looking at logs we you can

531
00:20:55,380 --> 00:20:57,120
look for search we can search through

532
00:20:57,120 --> 00:20:59,700
admin audit logs looking for add mailbox

533
00:20:59,700 --> 00:21:01,260
permission that's what we were using

534
00:21:01,260 --> 00:21:04,140
earlier and we can also look through the

535
00:21:04,140 --> 00:21:07,140
ual log looking for any usage of this

536
00:21:07,140 --> 00:21:11,100
specific commandlets and the values of

537
00:21:11,100 --> 00:21:13,919
pool access as the audit data parameters

538
00:21:13,919 --> 00:21:15,780
that have been configured

539
00:21:15,780 --> 00:21:18,419
this is how a hit will look like what we

540
00:21:18,419 --> 00:21:20,160
are looking for is access right as full

541
00:21:20,160 --> 00:21:22,140
access and the operation is ADD mailbox

542
00:21:22,140 --> 00:21:24,539
permission do remember when you run some

543
00:21:24,539 --> 00:21:26,280
of these you will see a lot of different

544
00:21:26,280 --> 00:21:29,600
logs so it might need some effort to

545
00:21:29,600 --> 00:21:32,340
narrow down on what is of Interest or

546
00:21:32,340 --> 00:21:34,020
sometimes you would need to export these

547
00:21:34,020 --> 00:21:36,360
into a analytics platform where you can

548
00:21:36,360 --> 00:21:37,919
then run their searches

549
00:21:37,919 --> 00:21:41,039
so that was for full access similar

550
00:21:41,039 --> 00:21:43,380
things can be done for send as as I said

551
00:21:43,380 --> 00:21:45,240
you need full access as well as send as

552
00:21:45,240 --> 00:21:47,700
senders provides an attacker capability

553
00:21:47,700 --> 00:21:52,140
to send email as a victim

554
00:21:52,140 --> 00:21:54,120
so that's what we are doing here we are

555
00:21:54,120 --> 00:21:56,220
reviewing all the mailboxes and looking

556
00:21:56,220 --> 00:21:59,340
for Access rights and we are also

557
00:21:59,340 --> 00:22:02,220
looking for admin audit logs

558
00:22:02,220 --> 00:22:05,220
ual in the ual you can run the same

559
00:22:05,220 --> 00:22:07,380
power Powershell commandlets looking for

560
00:22:07,380 --> 00:22:09,900
send as the rights that have been

561
00:22:09,900 --> 00:22:12,059
assigned so that's another way of doing

562
00:22:12,059 --> 00:22:14,460
uh hunting for this and this is how a

563
00:22:14,460 --> 00:22:16,740
hit will look like if you see access

564
00:22:16,740 --> 00:22:19,919
rights as send as

565
00:22:19,919 --> 00:22:22,620
this takes me to mailbox folder

566
00:22:22,620 --> 00:22:25,080
permissions so I'll talk through this

567
00:22:25,080 --> 00:22:28,260
and then I'll hand it over to thiru

568
00:22:28,260 --> 00:22:31,020
here instead of providing full access to

569
00:22:31,020 --> 00:22:33,720
the entire mailbox you can provide

570
00:22:33,720 --> 00:22:35,460
access to specific folders now this is

571
00:22:35,460 --> 00:22:37,980
often used where people provide access

572
00:22:37,980 --> 00:22:39,780
to their calendars to everyone across

573
00:22:39,780 --> 00:22:42,720
organization you can do that for inboxes

574
00:22:42,720 --> 00:22:44,159
you can do that for specific folders

575
00:22:44,159 --> 00:22:46,980
that's what a protector can do there are

576
00:22:46,980 --> 00:22:49,080
two special user types here Anonymous

577
00:22:49,080 --> 00:22:51,179
and default that's what are typically

578
00:22:51,179 --> 00:22:54,840
misused Anonymous means anyone

579
00:22:54,840 --> 00:22:57,600
unauthenticated users anyone external

580
00:22:57,600 --> 00:23:00,780
whereas default means anyone internal so

581
00:23:00,780 --> 00:23:02,520
here what you see on the right side is

582
00:23:02,520 --> 00:23:04,919
for inbox the permission of the inbox

583
00:23:04,919 --> 00:23:07,140
for the default user has been set up as

584
00:23:07,140 --> 00:23:09,720
owner which means anyone internal can

585
00:23:09,720 --> 00:23:11,460
access this

586
00:23:11,460 --> 00:23:14,039
this can be done using a Powershell

587
00:23:14,039 --> 00:23:16,559
commandlet also where the threat actor

588
00:23:16,559 --> 00:23:19,260
is now changing what kind of permission

589
00:23:19,260 --> 00:23:22,500
Anonymous or default has on a specific

590
00:23:22,500 --> 00:23:24,659
folder depending on what kind of access

591
00:23:24,659 --> 00:23:26,400
they have so if they make it Anonymous

592
00:23:26,400 --> 00:23:29,220
has full access then even outside of an

593
00:23:29,220 --> 00:23:30,720
organization they would be able to

594
00:23:30,720 --> 00:23:33,000
access the folder they have provided

595
00:23:33,000 --> 00:23:34,559
permission to

596
00:23:34,559 --> 00:23:37,080
this is how we can hunt for this so here

597
00:23:37,080 --> 00:23:39,120
we are running get mailbox looking at

598
00:23:39,120 --> 00:23:41,640
all the mailbox folder permission and

599
00:23:41,640 --> 00:23:43,880
looking for anonymous as well as default

600
00:23:43,880 --> 00:23:46,980
wherever excess rights have been set

601
00:23:46,980 --> 00:23:50,100
we can review the default user as well

602
00:23:50,100 --> 00:23:52,440
as Anonymous user also here that's what

603
00:23:52,440 --> 00:23:54,419
we are doing uh looking through the

604
00:23:54,419 --> 00:23:56,700
configuration again

605
00:23:56,700 --> 00:23:58,860
and this is the ual hunt which we can do

606
00:23:58,860 --> 00:24:01,740
looking look for mailbox folder

607
00:24:01,740 --> 00:24:04,200
permission command let you search again

608
00:24:04,200 --> 00:24:06,360
looking for anonymous as well as default

609
00:24:06,360 --> 00:24:08,880
having some sort of permission on a

610
00:24:08,880 --> 00:24:11,240
folder

611
00:24:11,580 --> 00:24:13,559
this is how a successful hunt will look

612
00:24:13,559 --> 00:24:15,600
like so what we are looking for is user

613
00:24:15,600 --> 00:24:17,820
as default and access rights as

614
00:24:17,820 --> 00:24:20,120
something other than

615
00:24:20,120 --> 00:24:22,740
nothing so you know here it is owner

616
00:24:22,740 --> 00:24:25,620
this is suspicious so that means uh

617
00:24:25,620 --> 00:24:28,260
excess rights have been changed for the

618
00:24:28,260 --> 00:24:32,039
user default as the owner here

619
00:24:32,039 --> 00:24:34,620
let's talk about Microsoft flows uh

620
00:24:34,620 --> 00:24:36,360
Microsoft flows is a very very

621
00:24:36,360 --> 00:24:40,080
interesting application in M365 it's

622
00:24:40,080 --> 00:24:41,940
also known as power automate it's used

623
00:24:41,940 --> 00:24:43,740
to perform automation so you can do

624
00:24:43,740 --> 00:24:46,200
several different things you can set up

625
00:24:46,200 --> 00:24:48,179
rules where you get a email which has a

626
00:24:48,179 --> 00:24:49,559
file and that file is automatically

627
00:24:49,559 --> 00:24:52,679
copied in the OneDrive you can power

628
00:24:52,679 --> 00:24:54,539
automate or you can automate stuff by

629
00:24:54,539 --> 00:24:56,400
writing all these different rules or of

630
00:24:56,400 --> 00:24:58,740
what needs to be done the way these

631
00:24:58,740 --> 00:25:00,840
rules are written is there is a trigger

632
00:25:00,840 --> 00:25:03,240
so here you see a trigger on the right

633
00:25:03,240 --> 00:25:05,820
side the trigger we have set here is

634
00:25:05,820 --> 00:25:08,159
when a new email arrives so every time a

635
00:25:08,159 --> 00:25:10,020
new email comes in this rule will be

636
00:25:10,020 --> 00:25:12,539
triggered and what will this rule do it

637
00:25:12,539 --> 00:25:14,039
will forward the email to the threat

638
00:25:14,039 --> 00:25:16,740
actor so here I'm using Microsoft flow

639
00:25:16,740 --> 00:25:18,419
or the third actor can use a Microsoft

640
00:25:18,419 --> 00:25:21,600
flow as a user so they just need user

641
00:25:21,600 --> 00:25:22,980
permission and they can set up the

642
00:25:22,980 --> 00:25:24,419
school and every time an email comes in

643
00:25:24,419 --> 00:25:27,919
that email will be forwarded out

644
00:25:28,980 --> 00:25:30,960
this is how you can hunt for this across

645
00:25:30,960 --> 00:25:33,600
ual so what you can do is search Unified

646
00:25:33,600 --> 00:25:35,760
audit log looking for a flow creation

647
00:25:35,760 --> 00:25:39,360
Now again this is a lot of results which

648
00:25:39,360 --> 00:25:41,039
you will get you may have to

649
00:25:41,039 --> 00:25:43,740
specifically focus on certain new flows

650
00:25:43,740 --> 00:25:46,080
that have been created based on time or

651
00:25:46,080 --> 00:25:48,240
continuously look for it the other

652
00:25:48,240 --> 00:25:50,760
challenge here is you see this URL that

653
00:25:50,760 --> 00:25:54,659
is mentioned here even if someone when

654
00:25:54,659 --> 00:25:56,400
they click on this they may not get full

655
00:25:56,400 --> 00:25:58,020
access to the flow so they may have to

656
00:25:58,020 --> 00:25:59,760
own the flow or add themselves to the

657
00:25:59,760 --> 00:26:01,200
permission so it's not that

658
00:26:01,200 --> 00:26:03,059
straightforward to look at what a flow

659
00:26:03,059 --> 00:26:05,580
is doing that's something to keep in

660
00:26:05,580 --> 00:26:08,220
mind but when these emails get Auto

661
00:26:08,220 --> 00:26:10,200
forwarded there are certain things which

662
00:26:10,200 --> 00:26:12,360
you can pick up in those emails to see

663
00:26:12,360 --> 00:26:14,220
this doesn't look right

664
00:26:14,220 --> 00:26:17,340
this looks suspicious like the client IP

665
00:26:17,340 --> 00:26:19,740
address field so here this is an email

666
00:26:19,740 --> 00:26:22,679
going out but the client IP address here

667
00:26:22,679 --> 00:26:25,500
is set up as Microsoft's IP address and

668
00:26:25,500 --> 00:26:27,419
similarly on the email messages that are

669
00:26:27,419 --> 00:26:29,820
being forward the XMS mail operation

670
00:26:29,820 --> 00:26:31,320
type is forward where the mail

671
00:26:31,320 --> 00:26:34,140
application is power automate which is

672
00:26:34,140 --> 00:26:37,140
Microsoft flow so some tidbits here and

673
00:26:37,140 --> 00:26:38,520
there you can pick up that this email

674
00:26:38,520 --> 00:26:40,740
was probably forwarded so if you have

675
00:26:40,740 --> 00:26:43,559
someone watching this they can alert on

676
00:26:43,559 --> 00:26:44,760
this

677
00:26:44,760 --> 00:26:47,279
another example of flows being used for

678
00:26:47,279 --> 00:26:50,220
data extraction so not only sending

679
00:26:50,220 --> 00:26:53,700
emails it's a it's a blank canvas for a

680
00:26:53,700 --> 00:26:55,260
threat actor on what they would like to

681
00:26:55,260 --> 00:26:58,140
do using flows there is a lot of

682
00:26:58,140 --> 00:27:00,539
capabilities that are built into flow so

683
00:27:00,539 --> 00:27:03,000
here in this case whenever a file is

684
00:27:03,000 --> 00:27:04,980
created that's the trigger

685
00:27:04,980 --> 00:27:07,620
another file is getting created in a

686
00:27:07,620 --> 00:27:09,600
storage account with tradector controls

687
00:27:09,600 --> 00:27:11,100
so when I see a file is getting created

688
00:27:11,100 --> 00:27:14,460
in OneDrive I can create the same file

689
00:27:14,460 --> 00:27:16,919
in Dropbox which I as a attacker control

690
00:27:16,919 --> 00:27:19,620
so this is data extraction keeping an

691
00:27:19,620 --> 00:27:21,240
eye on whatever files are getting

692
00:27:21,240 --> 00:27:23,340
created or a user is creating those

693
00:27:23,340 --> 00:27:24,720
files so this is another very

694
00:27:24,720 --> 00:27:28,559
interesting way of how thread actor can

695
00:27:28,559 --> 00:27:31,080
perform data exfiltration this is how we

696
00:27:31,080 --> 00:27:34,080
can perform a hunt for this here we are

697
00:27:34,080 --> 00:27:36,360
going through the ual looking for data

698
00:27:36,360 --> 00:27:37,740
extraction so what we are looking for is

699
00:27:37,740 --> 00:27:40,080
this file download operation because

700
00:27:40,080 --> 00:27:42,000
another cloud storage is downloading is

701
00:27:42,000 --> 00:27:45,000
for downloading this file from M365 so

702
00:27:45,000 --> 00:27:46,500
that's how you can look for this again

703
00:27:46,500 --> 00:27:49,200
these IP addresses depend on what

704
00:27:49,200 --> 00:27:53,179
service you are using as a predictor

705
00:27:54,299 --> 00:27:56,580
this looks like a lot of code so I'm not

706
00:27:56,580 --> 00:27:58,320
going to go through this entire code but

707
00:27:58,320 --> 00:28:00,240
what this Powershell snippet does is it

708
00:28:00,240 --> 00:28:02,039
goes through all the different flows

709
00:28:02,039 --> 00:28:04,320
that have been configured and gives you

710
00:28:04,320 --> 00:28:06,779
details of those flows so something to

711
00:28:06,779 --> 00:28:08,880
see if something to use if you want to

712
00:28:08,880 --> 00:28:10,559
list all the different flows that have

713
00:28:10,559 --> 00:28:12,779
been configured and then you can hunt

714
00:28:12,779 --> 00:28:14,580
through those and see which ones are

715
00:28:14,580 --> 00:28:19,380
those not for it not valid this is again

716
00:28:19,380 --> 00:28:21,620
performing hunting through configuration

717
00:28:21,620 --> 00:28:24,179
what we are looking at is output of an

718
00:28:24,179 --> 00:28:25,980
auto forwarded email and output of a

719
00:28:25,980 --> 00:28:28,260
data extraction flow so in this flow you

720
00:28:28,260 --> 00:28:30,539
are looking at actions as forwarding

721
00:28:30,539 --> 00:28:32,460
email and delete email so email is being

722
00:28:32,460 --> 00:28:35,400
forwarded it is being deleted and

723
00:28:35,400 --> 00:28:37,020
display name is something which the

724
00:28:37,020 --> 00:28:39,179
attacker can configure so victim is

725
00:28:39,179 --> 00:28:40,559
created by is another thing which you

726
00:28:40,559 --> 00:28:43,080
can look at but that's kind of what it

727
00:28:43,080 --> 00:28:44,520
tells you it tells you the trigger it

728
00:28:44,520 --> 00:28:46,980
tells you the action not a lot again

729
00:28:46,980 --> 00:28:49,080
here this is the data extraction flow so

730
00:28:49,080 --> 00:28:52,080
if you have a successful threaten this

731
00:28:52,080 --> 00:28:53,880
is how the output will look like which

732
00:28:53,880 --> 00:28:57,240
is I'm creating a file on new file that

733
00:28:57,240 --> 00:29:00,240
is getting created so that's how you can

734
00:29:00,240 --> 00:29:03,120
do hunting looking for uh different

735
00:29:03,120 --> 00:29:05,340
flows what I'm going to do here is now

736
00:29:05,340 --> 00:29:07,559
hand it over to thiru and thiru is going

737
00:29:07,559 --> 00:29:09,179
to talk through some of those other

738
00:29:09,179 --> 00:29:11,340
techniques uh over to you through if you

739
00:29:11,340 --> 00:29:12,900
can change the slides

740
00:29:12,900 --> 00:29:14,760
uh Sandstorm can you pass on the control

741
00:29:14,760 --> 00:29:17,240
to me

742
00:29:20,580 --> 00:29:22,919
yeah thank you

743
00:29:22,919 --> 00:29:24,600
let's move on to the next technique

744
00:29:24,600 --> 00:29:27,600
called persistent privileged role I'm

745
00:29:27,600 --> 00:29:29,039
going to talk about an interesting role

746
00:29:29,039 --> 00:29:31,559
called application impersonation role

747
00:29:31,559 --> 00:29:33,539
so this is a built-in management role in

748
00:29:33,539 --> 00:29:35,820
exchange online services any identities

749
00:29:35,820 --> 00:29:38,460
with application impersonation role can

750
00:29:38,460 --> 00:29:40,919
access the content of any user's mailbox

751
00:29:40,919 --> 00:29:44,460
so typically this role is assigned to

752
00:29:44,460 --> 00:29:46,200
third-party email Security Solutions are

753
00:29:46,200 --> 00:29:48,179
backup products

754
00:29:48,179 --> 00:29:50,220
threat actors can abuse this role in

755
00:29:50,220 --> 00:29:52,080
order to perform bulk email extraction

756
00:29:52,080 --> 00:29:54,299
activities either they can Target any of

757
00:29:54,299 --> 00:29:55,679
the user account that has application

758
00:29:55,679 --> 00:29:59,520
impersonation role or they can assign

759
00:29:59,520 --> 00:30:01,679
this roll tone of the compromised user

760
00:30:01,679 --> 00:30:03,000
account after gaining The Exchange admin

761
00:30:03,000 --> 00:30:04,740
privileges not to perform stealthy

762
00:30:04,740 --> 00:30:05,820
operations

763
00:30:05,820 --> 00:30:08,240
so this role can be assigned through

764
00:30:08,240 --> 00:30:10,980
admin portal or this can be assigned

765
00:30:10,980 --> 00:30:14,340
through Powershell commandlets

766
00:30:14,340 --> 00:30:16,260
for hunting perspective you can list out

767
00:30:16,260 --> 00:30:18,360
the identities with application

768
00:30:18,360 --> 00:30:20,279
impersonation role by querying exchange

769
00:30:20,279 --> 00:30:22,260
online configurations we are displaying

770
00:30:22,260 --> 00:30:25,140
two sets of queries the first query you

771
00:30:25,140 --> 00:30:28,559
can you can use in order to list out all

772
00:30:28,559 --> 00:30:29,760
the role groups assigned with

773
00:30:29,760 --> 00:30:31,740
application impersonation role and then

774
00:30:31,740 --> 00:30:33,840
list out all the identities part of the

775
00:30:33,840 --> 00:30:35,820
role group and the second query will

776
00:30:35,820 --> 00:30:37,860
list out the identities that has direct

777
00:30:37,860 --> 00:30:39,779
role assignment

778
00:30:39,779 --> 00:30:43,620
to the role application impersonation

779
00:30:43,620 --> 00:30:45,419
for hunting you can query unified audit

780
00:30:45,419 --> 00:30:47,100
blocks in order to list out application

781
00:30:47,100 --> 00:30:49,620
impersonation role assignment activity

782
00:30:49,620 --> 00:30:52,020
well through the mention time date range

783
00:30:52,020 --> 00:30:54,179
search Unified audit log for the

784
00:30:54,179 --> 00:30:56,580
operations new role Group New Management

785
00:30:56,580 --> 00:30:58,140
role assignment set management role

786
00:30:58,140 --> 00:30:59,580
assignment and then you can filter out

787
00:30:59,580 --> 00:31:01,740
for Value application impersonation

788
00:31:01,740 --> 00:31:03,659
so through this way you can narrow down

789
00:31:03,659 --> 00:31:05,820
your hunt

790
00:31:05,820 --> 00:31:08,159
so this is a sample log output

791
00:31:08,159 --> 00:31:09,539
where you can see an application

792
00:31:09,539 --> 00:31:11,700
impersonation role is assigned to a user

793
00:31:11,700 --> 00:31:14,820
called attacker so through this way you

794
00:31:14,820 --> 00:31:16,860
can hunt this technique

795
00:31:16,860 --> 00:31:18,600
let's move to the next technique illicit

796
00:31:18,600 --> 00:31:19,980
constant grants

797
00:31:19,980 --> 00:31:22,980
consent is a process where a user or

798
00:31:22,980 --> 00:31:25,200
Anonymous data can grant authorization

799
00:31:25,200 --> 00:31:27,179
to a third-party application or an

800
00:31:27,179 --> 00:31:29,279
application hosted in the tenant in

801
00:31:29,279 --> 00:31:31,260
order to access Microsoft 365 resources

802
00:31:31,260 --> 00:31:33,299
such as SharePoint online or exchange

803
00:31:33,299 --> 00:31:35,399
online or onedrives

804
00:31:35,399 --> 00:31:37,260
once an authorization is granted to an

805
00:31:37,260 --> 00:31:38,760
application a service principle will be

806
00:31:38,760 --> 00:31:39,899
registered

807
00:31:39,899 --> 00:31:42,720
through which an empress can be accessed

808
00:31:42,720 --> 00:31:44,460
so there are various permissions

809
00:31:44,460 --> 00:31:46,200
application permissions so these

810
00:31:46,200 --> 00:31:48,240
permissions are used by applications

811
00:31:48,240 --> 00:31:50,700
without a need for a user to sign into

812
00:31:50,700 --> 00:31:52,740
the application so typically this

813
00:31:52,740 --> 00:31:54,419
permission is used when an application

814
00:31:54,419 --> 00:31:56,640
need to run in a background or as a

815
00:31:56,640 --> 00:31:59,340
demon and application permissions can be

816
00:31:59,340 --> 00:32:01,919
granted only by administrators delegated

817
00:32:01,919 --> 00:32:04,140
permissions so these permissions can be

818
00:32:04,140 --> 00:32:06,659
used by application when a user need to

819
00:32:06,659 --> 00:32:08,640
sign into the application right so that

820
00:32:08,640 --> 00:32:10,799
the service principle can impersonate

821
00:32:10,799 --> 00:32:14,039
the signed in useless privilege threat

822
00:32:14,039 --> 00:32:15,720
actors can abuse this content Grant

823
00:32:15,720 --> 00:32:16,799
process

824
00:32:16,799 --> 00:32:19,140
by social engineering a user or a set of

825
00:32:19,140 --> 00:32:21,720
users then luring them to Grand content

826
00:32:21,720 --> 00:32:23,760
to threat actors malicious application

827
00:32:23,760 --> 00:32:28,080
to access the Microsoft 365 data

828
00:32:28,080 --> 00:32:30,299
so these are some of the risks which we

829
00:32:30,299 --> 00:32:33,299
felt has high permissions and if at all

830
00:32:33,299 --> 00:32:35,640
you see any of these Scopes are granted

831
00:32:35,640 --> 00:32:37,200
to a third party application service

832
00:32:37,200 --> 00:32:39,659
principle we strongly recommend you to

833
00:32:39,659 --> 00:32:41,159
work with your internal team to

834
00:32:41,159 --> 00:32:42,480
understand the necessity of these

835
00:32:42,480 --> 00:32:44,640
requirements

836
00:32:44,640 --> 00:32:46,740
for a hunting perspective you can list

837
00:32:46,740 --> 00:32:48,419
out all the service principles and their

838
00:32:48,419 --> 00:32:50,279
oath promotion grants by querying as

839
00:32:50,279 --> 00:32:52,080
ready tenant configuration

840
00:32:52,080 --> 00:32:53,760
so this script will list out all the

841
00:32:53,760 --> 00:32:55,320
oauth permission Grant and the output

842
00:32:55,320 --> 00:32:57,600
includes the scope information and then

843
00:32:57,600 --> 00:32:58,919
you can narrow down your hand to focus

844
00:32:58,919 --> 00:33:02,299
on some of the risky scopes

845
00:33:02,580 --> 00:33:04,500
so these are the sequence of events that

846
00:33:04,500 --> 00:33:06,059
are recorded whenever a constant is

847
00:33:06,059 --> 00:33:08,880
granted to an application right so we

848
00:33:08,880 --> 00:33:10,860
have given you our two snapshots where

849
00:33:10,860 --> 00:33:12,539
the first snapshot shows few events when

850
00:33:12,539 --> 00:33:14,159
a delegated permissions are granted one

851
00:33:14,159 --> 00:33:16,080
application the second snapshot shows

852
00:33:16,080 --> 00:33:17,940
series of events when an application or

853
00:33:17,940 --> 00:33:20,220
delegated permissions are granted to an

854
00:33:20,220 --> 00:33:21,919
application

855
00:33:21,919 --> 00:33:24,240
for hunting perspective again you can

856
00:33:24,240 --> 00:33:25,980
query unified audit log for operations

857
00:33:25,980 --> 00:33:28,019
constant application so this will list

858
00:33:28,019 --> 00:33:29,700
out logs whenever a constant is

859
00:33:29,700 --> 00:33:31,740
guaranted to an application the log

860
00:33:31,740 --> 00:33:34,500
output will include scope information

861
00:33:34,500 --> 00:33:36,000
and similarly you can also query for

862
00:33:36,000 --> 00:33:37,620
operations add delegated permission

863
00:33:37,620 --> 00:33:40,140
Grant so this will list out all the

864
00:33:40,140 --> 00:33:42,000
delegated permissions granted to an

865
00:33:42,000 --> 00:33:43,080
application

866
00:33:43,080 --> 00:33:44,399
and this will also include scope

867
00:33:44,399 --> 00:33:46,699
information

868
00:33:47,299 --> 00:33:49,980
operations are service principle so this

869
00:33:49,980 --> 00:33:51,299
will list out whenever a new service

870
00:33:51,299 --> 00:33:53,399
principles are registered

871
00:33:53,399 --> 00:33:56,700
so when a new third-party application

872
00:33:56,700 --> 00:33:59,340
Grant are getting a content from a user

873
00:33:59,340 --> 00:34:00,539
then there will be a new service

874
00:34:00,539 --> 00:34:01,980
principle registered on the Azure ID

875
00:34:01,980 --> 00:34:03,720
tenant

876
00:34:03,720 --> 00:34:06,000
operations app role assignment to

877
00:34:06,000 --> 00:34:08,219
service principles so this will list out

878
00:34:08,219 --> 00:34:11,219
logs whenever an application permissions

879
00:34:11,219 --> 00:34:13,859
are granted to Applications so this will

880
00:34:13,859 --> 00:34:15,359
also include scope information

881
00:34:15,359 --> 00:34:17,520
so these are the series of event that

882
00:34:17,520 --> 00:34:20,099
you need to query in order to hunt this

883
00:34:20,099 --> 00:34:22,139
technique from a defense perspective you

884
00:34:22,139 --> 00:34:23,879
can Harden the user settings by

885
00:34:23,879 --> 00:34:26,040
restricting users granting consents to

886
00:34:26,040 --> 00:34:28,020
third-party applications

887
00:34:28,020 --> 00:34:30,060
let's move to the next technique abusing

888
00:34:30,060 --> 00:34:31,679
SharePoint online

889
00:34:31,679 --> 00:34:33,899
so SharePoint online is a web-based

890
00:34:33,899 --> 00:34:35,040
application

891
00:34:35,040 --> 00:34:36,480
predominantly used by various

892
00:34:36,480 --> 00:34:37,739
organizations not to promote

893
00:34:37,739 --> 00:34:39,599
collaborations and to exchange

894
00:34:39,599 --> 00:34:42,300
information with external uses as well

895
00:34:42,300 --> 00:34:44,219
as throughout the organization

896
00:34:44,219 --> 00:34:46,859
that's a specific external sharing

897
00:34:46,859 --> 00:34:48,599
setting in SharePoint admin portal that

898
00:34:48,599 --> 00:34:50,940
will dictate whether the users can share

899
00:34:50,940 --> 00:34:53,760
content to external users or not the

900
00:34:53,760 --> 00:34:55,800
most permissive settings in SharePoint

901
00:34:55,800 --> 00:34:58,200
admin portal will allow any external

902
00:34:58,200 --> 00:35:00,119
uses to access the shared content

903
00:35:00,119 --> 00:35:02,099
without a requirement of signing into

904
00:35:02,099 --> 00:35:04,440
the tenant

905
00:35:04,440 --> 00:35:06,780
so from Attack perspective uh threat

906
00:35:06,780 --> 00:35:07,859
actors after gaining the SharePoint

907
00:35:07,859 --> 00:35:10,560
admin privileges they can tweak the

908
00:35:10,560 --> 00:35:13,680
external sharing settings and then they

909
00:35:13,680 --> 00:35:16,800
can choose some of the targeted file or

910
00:35:16,800 --> 00:35:18,000
the folder and then they can create an

911
00:35:18,000 --> 00:35:19,740
anonymous Link in order to maintain a

912
00:35:19,740 --> 00:35:21,960
persistent access to the file and folder

913
00:35:21,960 --> 00:35:24,960
so later it will let Actis can use

914
00:35:24,960 --> 00:35:27,359
anonymous Link in order to access a file

915
00:35:27,359 --> 00:35:29,339
or the file stored in the folders

916
00:35:29,339 --> 00:35:31,680
without a requirement of signing into

917
00:35:31,680 --> 00:35:34,380
the tenant so this is a stealthy attack

918
00:35:34,380 --> 00:35:37,140
and from a hunting perspective you can

919
00:35:37,140 --> 00:35:39,119
start with querying the SharePoint

920
00:35:39,119 --> 00:35:41,040
online configurations you can list out

921
00:35:41,040 --> 00:35:43,200
what is the the permission settings that

922
00:35:43,200 --> 00:35:45,839
you have have configured and the output

923
00:35:45,839 --> 00:35:48,000
external user and guest sharing will

924
00:35:48,000 --> 00:35:51,680
refer to the most permissive setting

925
00:35:51,680 --> 00:35:55,020
and from a hunting perspective you can

926
00:35:55,020 --> 00:35:58,200
query unified audit logs where a

927
00:35:58,200 --> 00:36:00,000
specific operation called sharing policy

928
00:36:00,000 --> 00:36:02,579
change this will list out all the logs

929
00:36:02,579 --> 00:36:05,160
whenever a specific permission settings

930
00:36:05,160 --> 00:36:07,859
are changed in SharePoint

931
00:36:07,859 --> 00:36:10,920
the uh the sharing policy changed so

932
00:36:10,920 --> 00:36:13,260
this will list out a specific values and

933
00:36:13,260 --> 00:36:14,820
when you're seeing extra net with share

934
00:36:14,820 --> 00:36:16,980
by link so this will refer to the most

935
00:36:16,980 --> 00:36:19,940
permissive setting

936
00:36:20,160 --> 00:36:22,320
an anonymous link created Anonymous link

937
00:36:22,320 --> 00:36:24,839
updated so this will list out whenever a

938
00:36:24,839 --> 00:36:27,060
new Anonymous links are created or

939
00:36:27,060 --> 00:36:29,420
updated

940
00:36:31,140 --> 00:36:33,540
Anonymous link usage so this specific

941
00:36:33,540 --> 00:36:35,700
operation lock will list out locks

942
00:36:35,700 --> 00:36:37,560
whenever an anonymous links are accessed

943
00:36:37,560 --> 00:36:40,140
by external or internal users

944
00:36:40,140 --> 00:36:42,180
so these are the series of events that

945
00:36:42,180 --> 00:36:43,859
you need to query through unified audit

946
00:36:43,859 --> 00:36:45,900
logs in order to hunt this technique

947
00:36:45,900 --> 00:36:47,579
let's move to the last technique the

948
00:36:47,579 --> 00:36:48,780
interest of time let me move a little

949
00:36:48,780 --> 00:36:51,359
bit faster uh maintain persistent access

950
00:36:51,359 --> 00:36:53,760
to n365 application

951
00:36:53,760 --> 00:36:55,740
so Azure application is a software that

952
00:36:55,740 --> 00:36:57,839
provides functionality to users

953
00:36:57,839 --> 00:36:59,520
and this will be in a form of an

954
00:36:59,520 --> 00:37:01,800
application object in Azure ID and

955
00:37:01,800 --> 00:37:03,480
whenever a new Azure application is

956
00:37:03,480 --> 00:37:04,560
created there will be a service

957
00:37:04,560 --> 00:37:07,380
principle created and registered in the

958
00:37:07,380 --> 00:37:08,460
tenant

959
00:37:08,460 --> 00:37:11,160
we can assign API permissions to the

960
00:37:11,160 --> 00:37:12,420
application object through which the

961
00:37:12,420 --> 00:37:14,579
empty Square resource can be accessed as

962
00:37:14,579 --> 00:37:16,380
well as we can also assign secret to

963
00:37:16,380 --> 00:37:19,380
application object or service principles

964
00:37:19,380 --> 00:37:21,119
typically we can enforce multi-factor

965
00:37:21,119 --> 00:37:22,440
authentication to traditional user

966
00:37:22,440 --> 00:37:25,079
accounts whereas for the workload

967
00:37:25,079 --> 00:37:26,700
identities such as service principles

968
00:37:26,700 --> 00:37:29,339
that cannot perform multi-factor

969
00:37:29,339 --> 00:37:30,900
authentication and threat actors can

970
00:37:30,900 --> 00:37:34,440
abuse this method in order to set a

971
00:37:34,440 --> 00:37:36,599
secret or a password to a specific

972
00:37:36,599 --> 00:37:38,040
application object which has high

973
00:37:38,040 --> 00:37:40,619
permissions over emphasized by resources

974
00:37:40,619 --> 00:37:42,420
so we have given a detailed right up

975
00:37:42,420 --> 00:37:44,040
late last year and the the white paper

976
00:37:44,040 --> 00:37:46,440
was published virus bulletin and we

977
00:37:46,440 --> 00:37:47,880
humbly request you to refer the white

978
00:37:47,880 --> 00:37:50,040
paper

979
00:37:50,040 --> 00:37:51,599
so from an attack perspective the

980
00:37:51,599 --> 00:37:53,400
attackers can add secrets to application

981
00:37:53,400 --> 00:37:55,320
objects they can add uh secrets to

982
00:37:55,320 --> 00:37:56,640
service principles this can be achieved

983
00:37:56,640 --> 00:37:59,339
through Powershell commandlets and once

984
00:37:59,339 --> 00:38:00,900
after they set a secret they can log

985
00:38:00,900 --> 00:38:02,099
into the tenant and access the

986
00:38:02,099 --> 00:38:05,060
empressify resources

987
00:38:05,160 --> 00:38:06,960
for a hunting you can query as you ready

988
00:38:06,960 --> 00:38:08,400
current configuration you can list out

989
00:38:08,400 --> 00:38:09,780
all the service principles configured

990
00:38:09,780 --> 00:38:11,760
with Secrets then you can use the same

991
00:38:11,760 --> 00:38:13,440
query in order to list out all the

992
00:38:13,440 --> 00:38:15,599
applications uh configure with secrets

993
00:38:15,599 --> 00:38:17,400
and then you can review the output and

994
00:38:17,400 --> 00:38:18,900
you can work with your internal team to

995
00:38:18,900 --> 00:38:19,980
understand the necessity of the

996
00:38:19,980 --> 00:38:21,660
requirement

997
00:38:21,660 --> 00:38:23,160
and again for hunting you can query

998
00:38:23,160 --> 00:38:24,599
unified audio clocks you can look for

999
00:38:24,599 --> 00:38:25,800
operations update application

1000
00:38:25,800 --> 00:38:27,720
certificate and secret management so

1001
00:38:27,720 --> 00:38:29,280
this will list out logs whenever a

1002
00:38:29,280 --> 00:38:31,380
secret or certificate are assigned to

1003
00:38:31,380 --> 00:38:33,300
applications and then you can add on

1004
00:38:33,300 --> 00:38:35,040
your hunt to focus on the key type

1005
00:38:35,040 --> 00:38:37,520
password

1006
00:38:37,680 --> 00:38:41,460
let's move to the last section takeaways

1007
00:38:41,460 --> 00:38:43,680
so we talked about a lot of adversal

1008
00:38:43,680 --> 00:38:46,740
techniques uh in M365 environment so

1009
00:38:46,740 --> 00:38:48,960
this is a mind map that we have created

1010
00:38:48,960 --> 00:38:51,240
that we have listing all the attributes

1011
00:38:51,240 --> 00:38:52,619
that you can query through unified audit

1012
00:38:52,619 --> 00:38:55,200
logs in order to hunt this technique

1013
00:38:55,200 --> 00:38:57,599
as well as we have also created a mind

1014
00:38:57,599 --> 00:38:59,339
map where we have listed out some of the

1015
00:38:59,339 --> 00:39:00,660
parameters that you can query through

1016
00:39:00,660 --> 00:39:02,339
configuration settings in order to

1017
00:39:02,339 --> 00:39:05,040
identify the misconfigurations as well

1018
00:39:05,040 --> 00:39:06,660
as to hunt all these adversarial

1019
00:39:06,660 --> 00:39:08,820
techniques

1020
00:39:08,820 --> 00:39:10,619
thanks a lot for listening to our talk

1021
00:39:10,619 --> 00:39:14,000
we really appreciate your time

