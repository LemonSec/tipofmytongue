1
00:00:00,734 --> 00:00:03,069
(crescendoing music)

2
00:00:05,939 --> 00:00:08,742
(loud boom)

3
00:00:08,742 --> 00:00:10,043
(loud zoom)

4
00:00:10,043 --> 00:00:12,312
(applause)

5
00:00:14,481 --> 00:00:17,717
- Without further ado,
Office 365 Forensics,

6
00:00:18,818 --> 00:00:22,355
the forensically sound approach.

7
00:00:22,355 --> 00:00:25,091
and at the end of the day,
you know, the transition

8
00:00:25,091 --> 00:00:30,096
from on-prem exchange
servers to doing forensics,

9
00:00:31,431 --> 00:00:33,133
in Microsoft's playground
on their servers,

10
00:00:33,133 --> 00:00:35,635
and then in their back-end
data infrastructures

11
00:00:35,635 --> 00:00:38,038
has presented interesting
forensic challenges.

12
00:00:38,038 --> 00:00:41,007
There's no longer am I able
to put hands on the original,

13
00:00:41,007 --> 00:00:42,809
you know, the old
traditional IS logs.

14
00:00:42,809 --> 00:00:47,080
Now we're kind of working off
of logs filtered by Microsoft

15
00:00:47,080 --> 00:00:51,016
and put into certain
areas of Office 365.

16
00:00:51,017 --> 00:00:52,285
We now have to interpret

17
00:00:52,285 --> 00:00:55,087
and figure out what
is the causality,

18
00:00:55,088 --> 00:00:59,459
with what creates these entries,
and what can I then learn

19
00:00:59,459 --> 00:01:02,228
from these logs to
figure out an actor

20
00:01:02,228 --> 00:01:03,696
that has gained
unauthorized access,

21
00:01:03,696 --> 00:01:05,832
usually through business
email compromise,

22
00:01:05,832 --> 00:01:08,701
or through password spray
attacks, to get into an account

23
00:01:08,701 --> 00:01:11,237
and now what data is it
risk of being accessed

24
00:01:11,237 --> 00:01:12,672
by an authorized third party.

25
00:01:14,474 --> 00:01:16,276
So where do we go first?

26
00:01:16,276 --> 00:01:20,213
For those of you that have
done forensics in Office 365

27
00:01:21,381 --> 00:01:22,949
the most important
place you want to go

28
00:01:22,949 --> 00:01:25,051
is under security
and compliance,

29
00:01:25,051 --> 00:01:27,153
and there is something
called the unified audit log.

30
00:01:27,153 --> 00:01:30,690
And the unified audit
log is Microsoft's dump

31
00:01:30,690 --> 00:01:34,727
of several data sources
into one location.

32
00:01:34,727 --> 00:01:36,796
And what you have
produced from that

33
00:01:36,796 --> 00:01:38,465
is this unified audit
log that allows you

34
00:01:38,465 --> 00:01:41,468
to pull auditable events,
that Microsoft has kind

35
00:01:41,468 --> 00:01:44,037
of again hand chosen for
us, to dump into one log

36
00:01:44,037 --> 00:01:45,805
that you can break
down by users.

37
00:01:46,906 --> 00:01:48,975
So you'd go to
search investigation,

38
00:01:48,975 --> 00:01:51,176
you'll go to audit log search,

39
00:01:51,177 --> 00:01:54,981
and then you'd be greeted
with an interesting window,

40
00:01:54,981 --> 00:01:57,817
which we'll get to in a minute,
to actually search through.

41
00:01:57,817 --> 00:01:59,085
There's some caveats.

42
00:01:59,085 --> 00:02:00,553
Some very important
friends of caveats

43
00:02:00,553 --> 00:02:02,122
to the unified audit log that

44
00:02:02,122 --> 00:02:03,957
if you're not aware
of you should be.

45
00:02:05,058 --> 00:02:07,494
Logouts are not captured.

46
00:02:07,494 --> 00:02:10,497
So if I'm a bad guy and I've
logged into an email account,

47
00:02:10,497 --> 00:02:13,399
one of the questions I
often get asked by law firms

48
00:02:13,399 --> 00:02:16,169
or clients, "How
long was the bad guy

49
00:02:16,169 --> 00:02:18,438
in our system/email account?"

50
00:02:20,140 --> 00:02:21,573
Logouts aren't
captured and there's,

51
00:02:21,574 --> 00:02:23,176
of course, a bunch of
technical reasons for that.

52
00:02:23,176 --> 00:02:25,278
One of which is, you know,
if I close the web browser

53
00:02:25,278 --> 00:02:26,546
by not clicking
the logout button,

54
00:02:26,546 --> 00:02:28,715
I just clicked the
"X", close my session,

55
00:02:28,715 --> 00:02:31,618
Microsoft probably
could log the latency

56
00:02:31,618 --> 00:02:33,418
or could probably log that
my sessions terminated.

57
00:02:33,419 --> 00:02:35,121
At the end of the
day, they just don't.

58
00:02:35,121 --> 00:02:36,623
So I have a login event.

59
00:02:36,623 --> 00:02:37,756
I have no logout event.

60
00:02:37,757 --> 00:02:38,825
Was he in there for hours?

61
00:02:38,825 --> 00:02:40,093
Was he in there for days?

62
00:02:41,728 --> 00:02:42,996
Messages.

63
00:02:42,996 --> 00:02:44,797
Specific viewed messages
within an email account

64
00:02:44,797 --> 00:02:47,333
are not logged in the
unified audit log.

65
00:02:47,333 --> 00:02:49,669
So if I'm a bad guy and
I'm in an email account,

66
00:02:49,669 --> 00:02:51,971
and I've logged in with
username and password,

67
00:02:51,971 --> 00:02:54,107
and I'm viewing emails
in your email account,

68
00:02:54,107 --> 00:02:55,375
the viewed message themselves

69
00:02:55,375 --> 00:02:57,410
are not captured in
the unified audit log.

70
00:02:58,778 --> 00:03:00,412
Search terms being run.

71
00:03:00,413 --> 00:03:03,016
Again, not actually
captured there.

72
00:03:04,684 --> 00:03:05,952
Was an attachment viewed?

73
00:03:07,253 --> 00:03:08,821
For a lot of the investigations

74
00:03:08,821 --> 00:03:13,493
that my team does
we're often asked,

75
00:03:13,493 --> 00:03:15,595
you know, the body of the
emails, not the important part.

76
00:03:15,595 --> 00:03:18,598
It doesn't have the PII or
the PHI, the HIPAA data.

77
00:03:18,598 --> 00:03:20,133
It's the attachment.

78
00:03:20,133 --> 00:03:23,303
It's Excel spreadsheet that
contains 10,000 user records

79
00:03:23,303 --> 00:03:25,204
with social security
number, date of birth, etc.

80
00:03:25,205 --> 00:03:26,573
Was that attachment viewed?

81
00:03:27,740 --> 00:03:29,475
Unified audit log
doesn't tell me.

82
00:03:29,475 --> 00:03:32,478
So usually I take the
position that if I know that,

83
00:03:32,478 --> 00:03:36,115
that guy was in the account
based on the unified audit log,

84
00:03:36,115 --> 00:03:39,352
likely the contents of that
account are at least at risk.

85
00:03:39,352 --> 00:03:40,853
Those are the limitations
that Microsoft

86
00:03:40,853 --> 00:03:43,790
has kind of strapped us with
from this one data source.

87
00:03:44,991 --> 00:03:46,726
Like the session, I
already spoke about.

88
00:03:48,494 --> 00:03:49,662
This is the one thing.

89
00:03:49,662 --> 00:03:50,930
This is the nightmare
that you never,

90
00:03:50,930 --> 00:03:52,865
ever want to see an
instant responder.

91
00:03:52,865 --> 00:03:56,202
If you've logged into a
client's Office 365 tenant

92
00:03:56,202 --> 00:03:58,738
and that is that the
audit log is not turned on

93
00:03:58,738 --> 00:04:00,373
because now you have
a significant issue.

94
00:04:00,373 --> 00:04:04,143
I have now lost one of my
primary forensic data sets

95
00:04:04,143 --> 00:04:07,113
to help tell you, the
client, what the actor did

96
00:04:07,113 --> 00:04:08,748
when he was in
your email account.

97
00:04:08,748 --> 00:04:10,416
By default, this is not on.

98
00:04:11,284 --> 00:04:13,052
So any time that we get engaged

99
00:04:13,052 --> 00:04:15,888
one of the first things we
usually do is ask the client,

100
00:04:15,888 --> 00:04:18,591
"Do you know if you have unified
audit logging turned on?"

101
00:04:18,591 --> 00:04:20,026
And for about a
quarter of our clients

102
00:04:20,026 --> 00:04:21,527
they have no idea what
we're talking about.

103
00:04:21,527 --> 00:04:23,229
For about another percentage
of our clients, they're like,

104
00:04:23,229 --> 00:04:25,365
"Yes and we just turned it
on when we found out about

105
00:04:25,365 --> 00:04:27,600
this event so it's
now capturing data."

106
00:04:27,600 --> 00:04:30,403
Great, that doesn't help
me for the last 30 days.

107
00:04:30,403 --> 00:04:33,506
Or, you know, you have
a proactive IT group

108
00:04:33,506 --> 00:04:34,407
and they're like, "Yes.

109
00:04:34,407 --> 00:04:35,207
That was turned on.

110
00:04:35,208 --> 00:04:36,542
We have logged data."

111
00:04:36,542 --> 00:04:37,777
Excellent.

112
00:04:37,777 --> 00:04:39,378
If not though, you're
greeted with this screen

113
00:04:39,379 --> 00:04:41,247
where you then
have to turn it on.

114
00:04:41,247 --> 00:04:44,350
Takes about 24 or so hours.

115
00:04:44,350 --> 00:04:46,486
A little hard to see on
the screen. I apologize.

116
00:04:46,486 --> 00:04:47,654
Bottom left there
though is says,

117
00:04:47,654 --> 00:04:49,088
"Because you started
recording user

118
00:04:49,088 --> 00:04:52,225
and admin activities
within the past 24 hours

119
00:04:52,225 --> 00:04:54,093
some activities
may not show up."

120
00:04:54,093 --> 00:04:57,397
And depending on the
size of the tenant

121
00:04:57,397 --> 00:04:59,232
and depending, what
I mean by that is,

122
00:04:59,232 --> 00:05:00,967
depending on the amount of users

123
00:05:00,967 --> 00:05:03,135
in the tenant based
on the licensing,

124
00:05:03,136 --> 00:05:04,871
sometimes it will take 24 hours

125
00:05:04,871 --> 00:05:06,472
before logged data
starts getting streamed

126
00:05:06,472 --> 00:05:07,674
and pulled into that.

127
00:05:07,674 --> 00:05:09,142
If it's a smaller
tenant and it's on one

128
00:05:09,142 --> 00:05:10,777
of Microsoft's newer servers,

129
00:05:10,777 --> 00:05:14,280
or it's been a more
recently subscribed tenant,

130
00:05:14,280 --> 00:05:16,816
usually it's within hours
we can start seeing data.

131
00:05:16,816 --> 00:05:18,284
May not be complete

132
00:05:18,284 --> 00:05:20,620
but you'll start actually
seeing data populate in there.

133
00:05:25,091 --> 00:05:26,626
So what's one of the
first things you need

134
00:05:26,626 --> 00:05:27,859
to do as an instant responder?

135
00:05:27,860 --> 00:05:29,829
And it's establish a
global admin account.

136
00:05:29,829 --> 00:05:32,398
Now Microsoft's got
an interesting tier

137
00:05:32,398 --> 00:05:34,534
to the user accounts and
you can be a global admin,

138
00:05:34,534 --> 00:05:38,236
you can be normal user,
or you can be a member

139
00:05:38,237 --> 00:05:40,873
of one of many user,
kind of levels.

140
00:05:40,873 --> 00:05:43,676
If you have a global admin
think of it as domain admin.

141
00:05:43,676 --> 00:05:47,046
It is your power user
within the tenant

142
00:05:47,046 --> 00:05:48,815
but even as a
global admin I still

143
00:05:48,815 --> 00:05:51,851
do not have 100% capabilities
across the tenant.

144
00:05:51,851 --> 00:05:53,786
I still need to
be assigned roles

145
00:05:53,786 --> 00:05:55,154
and we'll talk about
that in a couple minutes.

146
00:05:55,154 --> 00:05:56,889
There's a roll
particularly you need

147
00:05:56,889 --> 00:05:59,025
if you want actually
download PSTs

148
00:05:59,025 --> 00:06:02,128
or search the results
of a content search.

149
00:06:05,531 --> 00:06:07,200
Know your environment.

150
00:06:07,200 --> 00:06:10,002
This is probably one of
the more important slides.

151
00:06:10,002 --> 00:06:13,973
If have not done Office 365
Forensics these are the areas,

152
00:06:13,973 --> 00:06:16,209
the first three are
the areas within O365

153
00:06:16,209 --> 00:06:17,944
where you will be
focused the most on.

154
00:06:17,944 --> 00:06:20,213
http://protection.office.com
gets you

155
00:06:20,213 --> 00:06:22,215
to the security
compliance portal.

156
00:06:22,215 --> 00:06:24,751
Which allows you to
access unified audit log

157
00:06:24,751 --> 00:06:27,286
and it allows you to
access the content search.

158
00:06:27,286 --> 00:06:29,589
Which allows you to do
searches within user accounts

159
00:06:29,589 --> 00:06:32,692
for particular messages
and generate PSTs

160
00:06:32,692 --> 00:06:35,194
that you can download and
do offline forensics on.

161
00:06:36,596 --> 00:06:40,099
The O365 admin center is
where you can look up users

162
00:06:40,099 --> 00:06:44,670
and I've been engaged on
intrusion investigations

163
00:06:44,670 --> 00:06:46,572
where we've been
told by the client,

164
00:06:46,572 --> 00:06:48,741
we know there was phising
emails being sent out

165
00:06:48,741 --> 00:06:50,342
from this one particular user,

166
00:06:50,343 --> 00:06:52,578
or there was something fishy
going on with this account

167
00:06:52,578 --> 00:06:55,046
and emails were being
deleted or marked as read,

168
00:06:55,047 --> 00:06:58,451
and I go in here and the
client had deleted the account

169
00:06:58,451 --> 00:06:59,986
and created the user
another account.

170
00:06:59,986 --> 00:07:03,389
Well as soon as they did
that they break the linkage

171
00:07:03,389 --> 00:07:07,059
within Office 365 to the
unified audit log for that user.

172
00:07:07,059 --> 00:07:08,127
You could try
searching for that user

173
00:07:08,127 --> 00:07:10,029
you will not find any logs.

174
00:07:10,029 --> 00:07:13,566
You've about a 30-day window
to restore that account.

175
00:07:13,566 --> 00:07:17,236
The restoration will
relink the logs for you

176
00:07:17,236 --> 00:07:19,372
and you'll be able to
rerun a search query

177
00:07:19,372 --> 00:07:21,340
within the unified audit log.

178
00:07:21,340 --> 00:07:23,241
To the admin center is
where you will spend

179
00:07:23,242 --> 00:07:25,378
a lot of your time if you're
looking up particular users.

180
00:07:25,378 --> 00:07:27,447
If you wanna see what
their titles are,

181
00:07:27,447 --> 00:07:30,049
you wanna see how they're
configured within the tenant,

182
00:07:30,049 --> 00:07:33,719
what licensing is assigned to
them, it gives you, I kind of,

183
00:07:33,719 --> 00:07:36,022
I kind of equate it to
metadata about the user

184
00:07:36,022 --> 00:07:38,724
and it may help you
with your investigation.

185
00:07:38,724 --> 00:07:40,193
Windows Azure.

186
00:07:40,193 --> 00:07:42,161
So for those of you that know
Azure and the environment,

187
00:07:42,161 --> 00:07:44,897
it's kind of, I would kind
of equate it to Amazon AWS,

188
00:07:44,897 --> 00:07:47,332
you know, at the end of the
day you can spin up servers

189
00:07:47,333 --> 00:07:51,137
but it also by default,
depending on the licensing level

190
00:07:51,137 --> 00:07:55,608
of your tenant, has active
directory resources in it

191
00:07:55,608 --> 00:07:57,743
and we're gonna talk about
some of the forensic artifacts

192
00:07:57,743 --> 00:08:00,413
that are relevant
there to Office 365

193
00:08:00,413 --> 00:08:01,981
and email accounts specifically.

194
00:08:03,149 --> 00:08:05,351
And then the last one,
Windows Powershell.

195
00:08:05,351 --> 00:08:06,886
I don't know Nathan personally.

196
00:08:06,886 --> 00:08:08,287
I've gotten to talk to him
over email a couple times.

197
00:08:08,287 --> 00:08:09,455
Really good guy.

198
00:08:09,455 --> 00:08:11,591
He wrote a tool
called Pshell for 0365

199
00:08:11,591 --> 00:08:13,426
and you can Google
it and find it off a,

200
00:08:13,426 --> 00:08:14,560
there's a third-party website

201
00:08:14,560 --> 00:08:16,395
that posts his
article and the tool.

202
00:08:16,395 --> 00:08:20,099
What's great about the
tool is that it has bundled

203
00:08:20,099 --> 00:08:21,601
with it all the dependencies

204
00:08:21,601 --> 00:08:25,137
in the Powershell command
list for all of Office 365.

205
00:08:25,137 --> 00:08:29,208
Azure, OneDrive, SharePoint,

206
00:08:31,811 --> 00:08:34,579
all of those are pre bundles
when you run his installer.

207
00:08:34,580 --> 00:08:37,583
You have all of the commandlets
loaded on your local system

208
00:08:37,582 --> 00:08:39,251
so that you can actually
enter, if you need to,

209
00:08:39,251 --> 00:08:40,453
into Powershell and I have some

210
00:08:40,453 --> 00:08:42,121
Powershell queries
I'll show you in a bit

211
00:08:42,121 --> 00:08:44,624
where by default loggin' in

212
00:08:44,624 --> 00:08:46,125
from a normal
Windows stock machine

213
00:08:46,125 --> 00:08:48,761
you're not able to run those
commandlets without this.

214
00:08:51,531 --> 00:08:53,199
I'm not gonna to spend
too much time on this.

215
00:08:53,199 --> 00:08:55,767
As most of us is seasoned
investigators we understand

216
00:08:55,768 --> 00:08:57,770
if there's something wrong
within an account we need

217
00:08:57,770 --> 00:08:59,338
to identify which
accounts at risk

218
00:08:59,338 --> 00:09:02,808
and usually with a typical
business email compromised life

219
00:09:02,808 --> 00:09:05,144
cycle usually someone
is found out about it

220
00:09:05,144 --> 00:09:07,313
because of either A,
you know, admitted,

221
00:09:07,313 --> 00:09:09,181
"Hey I found a, I
had a weird link

222
00:09:09,181 --> 00:09:11,284
and it was for a document,
or it was for an invoice,

223
00:09:11,284 --> 00:09:13,753
and I had to go, and it asked
me to log in my credentials."

224
00:09:13,753 --> 00:09:14,787
And of course, you're going

225
00:09:14,787 --> 00:09:16,022
(face palm)

226
00:09:16,022 --> 00:09:17,990
and they've kind
of self-admitted.

227
00:09:17,990 --> 00:09:20,693
Or all the sudden
you have a report

228
00:09:20,693 --> 00:09:21,928
that a user's email account

229
00:09:21,928 --> 00:09:23,963
was sending out messages
asking for something.

230
00:09:23,963 --> 00:09:25,964
And it's like hundreds
of messages going out.

231
00:09:25,965 --> 00:09:26,966
That's a clue.

232
00:09:28,401 --> 00:09:31,304
So you usually know it,
those of us that do this,

233
00:09:31,304 --> 00:09:33,973
which email account needs
to actually be investigated

234
00:09:33,973 --> 00:09:35,675
and now we have our accounts

235
00:09:35,675 --> 00:09:37,877
we're gonna pivot off
of for the evidence.

236
00:09:40,012 --> 00:09:40,979
So we're exploring the log.

237
00:09:40,980 --> 00:09:42,715
The unified audit log.

238
00:09:42,715 --> 00:09:44,183
This is the screen
I was mentioning.

239
00:09:44,183 --> 00:09:46,819
So when you go to
search and compliance,

240
00:09:46,819 --> 00:09:50,222
and you go specifically to
that, it loads this screen,

241
00:09:50,222 --> 00:09:54,026
allows you to run a search
of a particular user,

242
00:09:54,026 --> 00:09:58,798
or users you can do multiple,
at the end of the day it's,

243
00:09:58,798 --> 00:10:00,499
you know, depending
what tool you're using,

244
00:10:00,499 --> 00:10:02,268
Splunk, or Excel, or, you know,

245
00:10:02,268 --> 00:10:04,236
whatever tool you might prefer.

246
00:10:04,236 --> 00:10:06,939
It may be helpful to
download one log per user

247
00:10:06,939 --> 00:10:08,708
and try to separate
those events.

248
00:10:08,708 --> 00:10:11,944
I've seen users and instant
responders that will try

249
00:10:11,944 --> 00:10:15,982
to load up, you know, 15
email addresses into this box

250
00:10:15,982 --> 00:10:17,216
and you get a really large file

251
00:10:17,216 --> 00:10:19,051
and they're all meshed together.

252
00:10:19,051 --> 00:10:21,621
Again, you know, it depends on,

253
00:10:21,621 --> 00:10:23,055
I guess, your
preference for analysis.

254
00:10:23,055 --> 00:10:25,458
I like running it and getting
the individual log file

255
00:10:25,458 --> 00:10:26,891
so I can kind of
see what happened

256
00:10:26,892 --> 00:10:29,629
and then I'll merge em together
based on what's relevant.

257
00:10:29,629 --> 00:10:31,697
Cuz again, if you're doing

258
00:10:31,697 --> 00:10:33,833
an instant response
investigation

259
00:10:33,833 --> 00:10:37,969
for actor activity most
likely you're also going

260
00:10:37,970 --> 00:10:40,506
to see legitimate
account activity.

261
00:10:40,506 --> 00:10:42,475
So now you have to try
to correlate yourself

262
00:10:42,475 --> 00:10:45,911
as the instant responder,
what's bad, what's good?

263
00:10:45,911 --> 00:10:48,079
You know, the good guy in
his account using Outlook.

264
00:10:48,080 --> 00:10:49,982
Bad guy in the account
using a web browser.

265
00:10:49,982 --> 00:10:51,584
And then I need to
separate that out.

266
00:10:51,584 --> 00:10:53,919
And it becomes a little more
convoluted if you're running,

267
00:10:53,919 --> 00:10:56,889
you know, 15 something users
all through this search screen.

268
00:10:58,324 --> 00:11:00,892
By default, once loggings,
of course, turned on,

269
00:11:00,893 --> 00:11:05,498
I have seen logs available
for 30 days, up to 90 days,

270
00:11:05,498 --> 00:11:07,433
and I've seen some
larger tenants available

271
00:11:07,433 --> 00:11:09,168
for about 6 months
worth of data.

272
00:11:10,302 --> 00:11:12,104
There is a Powershell query.

273
00:11:12,104 --> 00:11:13,739
You can change the
default setting up to

274
00:11:13,739 --> 00:11:16,208
I believe the 180-day mark.

275
00:11:16,208 --> 00:11:17,443
I do not believe
you can exceed that.

276
00:11:17,443 --> 00:11:19,211
Like, so I've never
seen any documentation

277
00:11:19,211 --> 00:11:21,547
and when I've tried via
Powershell to exceed

278
00:11:21,547 --> 00:11:23,883
that I usually get
an error message.

279
00:11:23,883 --> 00:11:26,952
I do know that Microsoft
can exceed that number.

280
00:11:26,952 --> 00:11:28,587
I was dealing with
one client who

281
00:11:28,587 --> 00:11:31,090
had two years of
unified audit log data.

282
00:11:31,090 --> 00:11:32,625
Which blew my mind.

283
00:11:32,625 --> 00:11:35,728
It was an immense amount of
data and we were just amazed

284
00:11:35,728 --> 00:11:37,963
because when you
bring up the calendar,

285
00:11:37,963 --> 00:11:39,432
I don't think I have a slide,

286
00:11:40,900 --> 00:11:42,268
when you bring up the calendar

287
00:11:42,268 --> 00:11:45,304
it actually shows you
a color-coded dates

288
00:11:45,304 --> 00:11:48,107
for what days have
logs available and I
just kept going back

289
00:11:48,107 --> 00:11:49,341
and back and I'm like surely
there's something wrong

290
00:11:49,341 --> 00:11:51,177
and I pulled a log
from like 2 years prior

291
00:11:51,177 --> 00:11:52,778
that actually had data in it.

292
00:11:52,778 --> 00:11:55,047
Found out they had,
had a prior issue.

293
00:11:55,047 --> 00:11:56,315
They had reached
out to Microsoft

294
00:11:56,315 --> 00:11:57,550
and Microsoft kind of
flipped the magic switch

295
00:11:57,550 --> 00:12:00,585
and gave them longer
retention data.

296
00:12:00,586 --> 00:12:01,654
So Microsoft humor.

297
00:12:02,755 --> 00:12:05,458
I have found significant
issues with trying

298
00:12:05,458 --> 00:12:09,694
to run this search
engine, if you will

299
00:12:09,695 --> 00:12:13,833
and typing in users if you
are using Chrome or Firefox.

300
00:12:13,833 --> 00:12:15,735
In fact, when I have
tried with those browsers,

301
00:12:15,735 --> 00:12:18,003
even with the newer versions,
you start typing in there,

302
00:12:18,003 --> 00:12:21,474
the cursor actually disappears
and keeps you from typing.

303
00:12:21,474 --> 00:12:23,008
It's a really weird bug.

304
00:12:23,008 --> 00:12:25,377
But of course, Microsoft's
browsers work just perfectly.

305
00:12:25,377 --> 00:12:27,412
So again, I'm not sure if
that's just something odd

306
00:12:27,413 --> 00:12:29,949
with my testing or if
that's a Microsoft joke

307
00:12:29,949 --> 00:12:32,852
to try to prevent or force
people to use their browsers.

308
00:12:32,852 --> 00:12:36,822
One requirement, I mentioned
the content search,

309
00:12:36,822 --> 00:12:38,290
and I think I mentioned
it twice so far.

310
00:12:38,290 --> 00:12:40,892
The content search allows you
to download PSTs for users

311
00:12:40,893 --> 00:12:42,928
so that you can do
offline forensics.

312
00:12:44,296 --> 00:12:47,166
That export tool that Microsoft

313
00:12:47,166 --> 00:12:51,137
has created requires a
Microsoft based browser.

314
00:12:51,137 --> 00:12:53,973
The little plug-in that loads,
I've not had any success

315
00:12:53,973 --> 00:12:57,175
with it loading in a
non-Microsoft browser.

316
00:12:57,176 --> 00:12:59,011
And as your AD, which
we'll talk about

317
00:12:59,011 --> 00:13:00,846
in a bit, same functionality,

318
00:13:00,846 --> 00:13:02,748
some of the search fields
and the search boxes,

319
00:13:02,748 --> 00:13:04,083
some of the sliders,

320
00:13:04,083 --> 00:13:06,584
it just it will
not render as well

321
00:13:06,585 --> 00:13:08,687
unless you're using
Edge or IE 11.

322
00:13:13,526 --> 00:13:16,395
Under the search window

323
00:13:16,395 --> 00:13:18,831
that we were talkin' about
a couple screens ago,

324
00:13:18,831 --> 00:13:20,533
in the top right-hand corner

325
00:13:20,533 --> 00:13:23,102
is where you download the
results of your search.

326
00:13:23,102 --> 00:13:25,237
I'm gonna go back for
just a quick minute here.

327
00:13:29,108 --> 00:13:30,342
This may be easier
said than done

328
00:13:30,342 --> 00:13:32,211
cuz I forgot how many
slides it was back.

329
00:13:35,080 --> 00:13:36,949
This might have been a bad
idea. Sorry about that.

330
00:13:36,949 --> 00:13:38,516
I thought I had a
screen a couple back

331
00:13:38,517 --> 00:13:41,187
that actually showed the
results a little but better.

332
00:13:42,054 --> 00:13:43,355
Bear with me as I get back.

333
00:13:44,857 --> 00:13:46,358
Okay.

334
00:13:46,358 --> 00:13:48,493
In the top right-hand corner
though is where you'll export.

335
00:13:48,494 --> 00:13:50,629
Now, interesting nuance here,

336
00:13:50,629 --> 00:13:52,865
save loaded results versus
download all results.

337
00:13:52,865 --> 00:13:55,534
Kind of self-explanatory, but
for those of you that may not

338
00:13:55,534 --> 00:13:57,803
have done this before,
save loaded results

339
00:13:57,803 --> 00:14:02,508
will only download a JSON
dump of what's loaded

340
00:14:02,508 --> 00:14:03,976
on the screen and by default,

341
00:14:03,976 --> 00:14:06,312
it's loading about one
screen worth of data.

342
00:14:06,312 --> 00:14:08,781
As you scroll down
it keeps loading more

343
00:14:08,781 --> 00:14:10,415
and more data into the browser.

344
00:14:10,416 --> 00:14:14,386
If you only do save loaded
it will only save out

345
00:14:14,386 --> 00:14:17,089
what is loaded on the screen
versus download all results

346
00:14:17,089 --> 00:14:18,791
which will dump
everything responsive

347
00:14:18,791 --> 00:14:20,259
to the query you've executed.

348
00:14:21,861 --> 00:14:23,194
I have a little
bit of a joke there

349
00:14:23,195 --> 00:14:25,865
that with the Microsoft Excel.

350
00:14:25,865 --> 00:14:30,870
This data if JSON and it does
not render super well in Excel

351
00:14:32,037 --> 00:14:33,272
but I'll talk about
that in a minute.

352
00:14:33,272 --> 00:14:37,376
So I made a chart for
all of the operators

353
00:14:37,376 --> 00:14:40,613
or the auditable events
that are captured

354
00:14:40,613 --> 00:14:42,615
as well as their default status

355
00:14:42,615 --> 00:14:45,317
by Microsoft, the
unified audit log.

356
00:14:45,317 --> 00:14:48,587
It's a couple
interesting ones here.

357
00:14:48,587 --> 00:14:51,423
A message being copied
to another folder.

358
00:14:51,423 --> 00:14:55,828
That action is an audible event
but it is not on by default

359
00:14:55,828 --> 00:14:59,430
if you are a delegate or if
you are the account owner.

360
00:14:59,431 --> 00:15:02,167
So if I have an email
account in Office 365

361
00:15:02,167 --> 00:15:05,137
and I copy a message that
is not an auditable event.

362
00:15:05,137 --> 00:15:08,273
If I'm an admin
level user it is.

363
00:15:10,309 --> 00:15:11,977
Folder bind and message bind.

364
00:15:11,977 --> 00:15:13,646
Now, these are two are
very interesting ones.

365
00:15:13,646 --> 00:15:14,579
So folder bind.

366
00:15:14,580 --> 00:15:16,649
A mailbox folder being accessed.

367
00:15:16,649 --> 00:15:18,384
Well, that can be
extremely useful

368
00:15:18,384 --> 00:15:19,885
to an instant responder, right?

369
00:15:19,885 --> 00:15:22,121
If a bad guys been in one
of my users' email accounts

370
00:15:22,121 --> 00:15:24,924
be extremely useful
to know if a bad guy

371
00:15:24,924 --> 00:15:26,592
was traversing down
through folder structures.

372
00:15:26,592 --> 00:15:30,329
Did he stay in my inbox or did
he go to my doctor's folder

373
00:15:30,329 --> 00:15:32,131
with his rounding
list where he's

374
00:15:32,131 --> 00:15:33,699
been keeping my pick up patient

375
00:15:33,699 --> 00:15:36,035
PII and PHI for
going back for years?

376
00:15:36,035 --> 00:15:37,468
Did he ever access that folder

377
00:15:37,469 --> 00:15:41,907
cuz that changes a forensic
finding of years worth

378
00:15:41,907 --> 00:15:43,709
of notifications
now for the client?

379
00:15:43,709 --> 00:15:47,813
Or bad guy was only looking
for invoice data in the inbox.

380
00:15:49,315 --> 00:15:52,618
Not auditable for
typical owner accounts.

381
00:15:52,618 --> 00:15:53,752
It cannot be configured.

382
00:15:53,752 --> 00:15:55,721
It cannot be turned on.

383
00:15:55,721 --> 00:15:58,657
When you try it in Powershell
to force that operator

384
00:15:58,657 --> 00:16:01,894
to be logged you'll get
an error response back.

385
00:16:01,894 --> 00:16:03,796
So message find being
even more important.

386
00:16:03,796 --> 00:16:05,965
Message being viewed in
the preview pane or opened.

387
00:16:05,965 --> 00:16:08,567
Now this is speaking
to if I log in

388
00:16:08,567 --> 00:16:10,269
whether as a legit
user or a bad guy

389
00:16:10,269 --> 00:16:13,839
into http://office365.com
and I'm looking

390
00:16:13,839 --> 00:16:16,275
at an email account
via the web browser

391
00:16:16,275 --> 00:16:17,876
and I'm clicking down
through messages,

392
00:16:17,876 --> 00:16:20,212
or objects is how
Microsoft refers

393
00:16:20,212 --> 00:16:22,146
to it in their nomenclature, all

394
00:16:22,147 --> 00:16:23,983
of the objects that
are being viewed.

395
00:16:26,085 --> 00:16:29,955
If you are normal owner
or a delegate the clicking

396
00:16:29,955 --> 00:16:33,125
of those messages is
not captured in the
unified audit log.

397
00:16:33,125 --> 00:16:36,395
If you're an admin,
interestingly enough,

398
00:16:36,395 --> 00:16:39,531
I have seen where it sometimes
is and sometimes is not.

399
00:16:39,531 --> 00:16:41,467
Regardless of it
being on or off.

400
00:16:41,467 --> 00:16:42,800
No explanation for that.

401
00:16:46,038 --> 00:16:50,009
So the Powershell query to
force on certain operators

402
00:16:50,009 --> 00:16:52,044
that are not on by
default is here.

403
00:16:52,044 --> 00:16:54,880
And, of course, then you can
comma separate the values

404
00:16:54,880 --> 00:16:56,415
or the operators that
you want to turn.

405
00:16:56,415 --> 00:17:00,019
By default, Microsoft does not
have all of the operators on.

406
00:17:00,019 --> 00:17:01,453
Well, as we already discussed,

407
00:17:01,453 --> 00:17:03,555
by default the
loggings not even on

408
00:17:03,555 --> 00:17:05,691
and then once you've turned
it on only a certain amount

409
00:17:05,691 --> 00:17:08,494
of operators are
logged by default.

410
00:17:08,493 --> 00:17:11,195
So now you actually
can go in yourself

411
00:17:11,195 --> 00:17:14,032
and turn on additional
ones if they're supported.

412
00:17:17,502 --> 00:17:20,739
So now we're into the analysis
of the unified audit log.

413
00:17:20,739 --> 00:17:22,775
Again it's JSON data.

414
00:17:22,775 --> 00:17:26,045
It's a little ugly
to look at in Excel

415
00:17:26,045 --> 00:17:27,479
but just for ease I
brought it up here

416
00:17:27,479 --> 00:17:28,981
and it's this kind
of a sanitized one

417
00:17:28,981 --> 00:17:30,516
so apologies for
the big black boxes

418
00:17:30,516 --> 00:17:32,985
but at the end of the day
you have four main columns

419
00:17:32,985 --> 00:17:34,919
that you'll see in Excel
when you open this up.

420
00:17:34,920 --> 00:17:37,956
Creation date and
time, the user IDs

421
00:17:37,956 --> 00:17:39,291
of the user accounts
you've export,

422
00:17:39,291 --> 00:17:41,894
and then the operations
or the operators.

423
00:17:41,894 --> 00:17:44,963
These are the auditable
events recorded down

424
00:17:44,963 --> 00:17:46,231
to the unified audit log.

425
00:17:47,066 --> 00:17:48,167
User logged in.

426
00:17:48,167 --> 00:17:50,202
Files being accessed.

427
00:17:50,202 --> 00:17:53,372
The files being accessed
and files being viewed

428
00:17:53,372 --> 00:17:56,241
is actually very interesting
cuz that speaks specifically

429
00:17:56,241 --> 00:17:58,944
to OneDrive and
SharePoint activity.

430
00:17:58,944 --> 00:18:01,080
Now a lot of the business email
compromise cases I've worked

431
00:18:01,080 --> 00:18:02,714
over the years
typically the actors

432
00:18:02,714 --> 00:18:04,716
are getting in, they're
looking at messages.

433
00:18:04,716 --> 00:18:07,052
We have seen a percentage
of our cases though

434
00:18:07,052 --> 00:18:10,222
where the actors will
actually host the file

435
00:18:10,222 --> 00:18:11,657
they're gonna use for phising

436
00:18:11,657 --> 00:18:14,293
on the compromised
accounts OneDrive

437
00:18:14,293 --> 00:18:16,360
or in their SharePoint
and you can actually see

438
00:18:16,361 --> 00:18:19,932
that activity and it
timelines out very well

439
00:18:19,932 --> 00:18:21,400
out of the unified audit log.

440
00:18:23,235 --> 00:18:24,803
So again that's just
kind of the highlight

441
00:18:24,803 --> 00:18:27,473
of the actual operators
and how they correlate

442
00:18:27,473 --> 00:18:29,508
and then the data
that's in that JSON blob

443
00:18:29,508 --> 00:18:31,677
to the to the right
on that last screen

444
00:18:31,677 --> 00:18:33,978
those are kind of the
more granular effects

445
00:18:33,979 --> 00:18:35,481
I have another
screenshot of that

446
00:18:35,481 --> 00:18:36,982
but the mailbox login is
one of the most important

447
00:18:36,982 --> 00:18:39,818
if you're trying to pivot
around actor timelines

448
00:18:39,818 --> 00:18:41,687
and their activity
within an account.

449
00:18:43,388 --> 00:18:44,822
It's not as simple
though as just looking

450
00:18:44,823 --> 00:18:47,893
for just one operator to
identify when a user logged in.

451
00:18:47,893 --> 00:18:50,762
Microsoft has several.

452
00:18:50,762 --> 00:18:52,231
In fact, this isn't
even a complete list.

453
00:18:52,231 --> 00:18:53,465
I think there's eight.

454
00:18:53,465 --> 00:18:56,001
But these are the six
that I see the most

455
00:18:56,001 --> 00:18:57,569
in the investigations
that I've done.

456
00:18:57,569 --> 00:18:59,404
User logged in is
the most basic.

457
00:18:59,404 --> 00:19:02,307
That is the easiest one
to search for or grep for.

458
00:19:02,307 --> 00:19:04,076
But the other ones
that are here depending

459
00:19:04,076 --> 00:19:08,080
on the client's
mail environment,

460
00:19:08,080 --> 00:19:09,715
the way they've got it set up,

461
00:19:09,715 --> 00:19:11,984
you may see all of
these other types

462
00:19:11,984 --> 00:19:15,387
of logins to capture a
username and password

463
00:19:15,387 --> 00:19:19,625
and an authentication event
into the Office 365 account.

464
00:19:19,625 --> 00:19:22,361
Now for the most part user
logged in is the default.

465
00:19:22,361 --> 00:19:25,330
If a bad guys logged in
via http://office365.com

466
00:19:25,330 --> 00:19:28,567
via web browser this is the
one you'll see the most common

467
00:19:28,567 --> 00:19:31,537
but depending on if the clients
using some type of an ADFS

468
00:19:31,537 --> 00:19:33,038
or a hybrid environment
where they still

469
00:19:33,038 --> 00:19:35,541
have exchange on-prem
maybe they haven't migrated

470
00:19:35,541 --> 00:19:39,444
all their users into Office
365 or they're hosting locally

471
00:19:39,444 --> 00:19:41,480
but they're using a
licensing in Office 365.

472
00:19:41,480 --> 00:19:44,049
A lot of those factors
can affect the way

473
00:19:44,049 --> 00:19:48,453
Microsoft sees the
authentication into
their infrastructure.

474
00:19:48,453 --> 00:19:49,955
Hence the different operators

475
00:19:49,955 --> 00:19:52,291
that make capture a login event.

476
00:19:52,291 --> 00:19:54,126
So you'd be remiss
if when you load

477
00:19:54,126 --> 00:19:56,562
that data you're only
looking for user logged in.

478
00:19:56,562 --> 00:19:59,665
You may miss other
types of login events.

479
00:20:02,868 --> 00:20:05,236
So here's that JSON
blob I was talking about

480
00:20:06,805 --> 00:20:09,908
and these are kind of the most
important aspects of that.

481
00:20:09,908 --> 00:20:11,342
The creation time.

482
00:20:12,778 --> 00:20:15,280
What is the actual operator
that you're caring about?

483
00:20:15,280 --> 00:20:16,615
The user logged in for this,

484
00:20:16,615 --> 00:20:19,885
for the purposes of this
example, the IP address.

485
00:20:19,885 --> 00:20:23,322
Where is that person logging
in from as far as an IP?

486
00:20:24,156 --> 00:20:25,224
The extended properties.

487
00:20:25,224 --> 00:20:26,124
The user agent.

488
00:20:27,559 --> 00:20:30,095
This is fantastic for base
lining a user's account.

489
00:20:30,095 --> 00:20:32,164
You know, most the times
when my team is brought in

490
00:20:32,164 --> 00:20:34,533
we don't know the
user's environment,

491
00:20:34,533 --> 00:20:37,168
the clients' environment, as
well as the client's IT team

492
00:20:37,169 --> 00:20:38,770
so I don't know
what a normal user

493
00:20:38,770 --> 00:20:40,305
may be using at their system.

494
00:20:40,305 --> 00:20:41,773
Are they using the most
recent version of Outlook?

495
00:20:41,773 --> 00:20:43,074
Are they a remote user?

496
00:20:43,075 --> 00:20:44,643
Are they using a browser
when they're traveling?

497
00:20:44,643 --> 00:20:47,012
So I can go in here we
can pull this data out

498
00:20:47,012 --> 00:20:49,481
and I can baseline
an accounts activity.

499
00:20:49,481 --> 00:20:51,483
Now, what are my outliers?

500
00:20:51,483 --> 00:20:53,418
IP addresses are
always geo-locating

501
00:20:53,418 --> 00:20:55,152
to this one part of
the United States.

502
00:20:55,153 --> 00:20:57,189
That's right where the
headquarters is for this client.

503
00:20:57,189 --> 00:20:59,992
I'll listen, I've got a login
that's a significant outlier

504
00:20:59,992 --> 00:21:01,693
and it's coming from a
different part of the world.

505
00:21:01,693 --> 00:21:03,629
Now I have something to
pivot off of. Very quickly.

506
00:21:03,629 --> 00:21:04,862
Very easily.

507
00:21:04,863 --> 00:21:06,698
Same thing for the user
agent string though.

508
00:21:06,698 --> 00:21:09,201
Am I only ever seeing Outlook

509
00:21:09,201 --> 00:21:11,169
as the normal baseline
activity for this client?

510
00:21:11,169 --> 00:21:12,804
And all of the sudden
I see a web browser

511
00:21:12,804 --> 00:21:15,240
and it's some odd
version of Opera.

512
00:21:15,240 --> 00:21:18,310
That's an outlier and now
I can pivot off of that.

513
00:21:18,310 --> 00:21:20,279
And of course the
result status detail.

514
00:21:20,279 --> 00:21:21,780
Value success.

515
00:21:21,780 --> 00:21:23,315
I don't care about value fails

516
00:21:23,315 --> 00:21:25,384
and you'll see a lot of failures

517
00:21:25,384 --> 00:21:26,852
when you're doing
these types of logs.

518
00:21:26,852 --> 00:21:28,553
Filter em all out. I mean
at the end of the day

519
00:21:28,553 --> 00:21:30,389
it may help give you
some information,

520
00:21:30,389 --> 00:21:32,123
then you know, is someone
beating on the door,

521
00:21:32,124 --> 00:21:33,592
someone trying passwords,

522
00:21:33,592 --> 00:21:34,860
but at the end of the
day, I care about success

523
00:21:34,860 --> 00:21:36,828
and if there was an
unauthorized access

524
00:21:36,828 --> 00:21:38,030
I don't normally care.

525
00:21:38,030 --> 00:21:39,798
I care about the
success and this is

526
00:21:39,798 --> 00:21:42,000
where you would be able
to go and pull that.

527
00:21:44,836 --> 00:21:47,539
Three more operators that
are significantly important,

528
00:21:47,539 --> 00:21:48,940
add mailbox permission,

529
00:21:48,940 --> 00:21:50,976
add recipient permission,
and set mailbox.

530
00:21:50,976 --> 00:21:53,278
Set mailbox is the
forensic artifact

531
00:21:53,278 --> 00:21:55,580
that is laid down in
the log when a change

532
00:21:55,580 --> 00:21:57,316
to the account has occurred.

533
00:21:57,316 --> 00:22:01,019
So the point in time via
Powershell, via the interface.

534
00:22:01,019 --> 00:22:03,622
If I have changed a setting

535
00:22:03,622 --> 00:22:05,757
within the users
Office 365 account

536
00:22:05,757 --> 00:22:07,959
there will be a set
mailbox operator

537
00:22:07,959 --> 00:22:11,063
that records the moment
in time that the changes

538
00:22:11,063 --> 00:22:13,231
have now taken effect
on the account.

539
00:22:13,231 --> 00:22:15,100
This is a great one
to pivot off of.

540
00:22:15,100 --> 00:22:18,704
Now I can just sort by set
mailbox cuz typically most users

541
00:22:18,704 --> 00:22:21,340
aren't changing core
settings in their account.

542
00:22:21,340 --> 00:22:23,007
If I'm looking in
accounts I'm looking

543
00:22:23,008 --> 00:22:25,544
for settings like
an auto-forwarding
rule being created.

544
00:22:25,544 --> 00:22:27,446
I can very quickly
filter by this

545
00:22:27,446 --> 00:22:29,715
and now I start to
see the outliers.

546
00:22:29,715 --> 00:22:32,851
But the add mailbox permission
and recipient permission

547
00:22:32,851 --> 00:22:35,320
is significant
because if you have

548
00:22:35,320 --> 00:22:37,422
had a global admin
account popped

549
00:22:38,590 --> 00:22:41,760
and that bad guy has
been able to leverage

550
00:22:41,760 --> 00:22:45,230
that account to log in,
so just say Devon Ackerman

551
00:22:45,230 --> 00:22:47,299
is the global admin,
his account gets popped,

552
00:22:47,299 --> 00:22:49,634
and now he's that
account is logging in

553
00:22:49,634 --> 00:22:52,871
and being set as a delegate
on other email accounts,

554
00:22:52,871 --> 00:22:55,440
the add mailbox permission
recipient permission

555
00:22:55,440 --> 00:23:00,278
will be recorded in the
log for every account

556
00:23:00,278 --> 00:23:03,181
that my primary global admin
is being used to log into.

557
00:23:04,383 --> 00:23:06,985
Those artifacts may
not be on those users

558
00:23:06,985 --> 00:23:09,286
in their individual
unified audit log

559
00:23:09,287 --> 00:23:11,456
but I'll see it on
the global admins UAL.

560
00:23:16,795 --> 00:23:18,730
So again, this is
not rocket science.

561
00:23:18,730 --> 00:23:20,699
Do this on a regular basis.

562
00:23:20,699 --> 00:23:25,070
I want to know if I've
had an authorized access

563
00:23:25,070 --> 00:23:27,706
when did it happen and what else

564
00:23:27,706 --> 00:23:29,307
did the actor do in the account?

565
00:23:33,011 --> 00:23:34,613
So we're gonna baseline
that user activity.

566
00:23:34,613 --> 00:23:37,649
We're gonna identify what is
normal, what is legitimate,

567
00:23:37,649 --> 00:23:39,283
and now what is my
outlier activity?

568
00:23:39,284 --> 00:23:42,387
And the outlier activity is
what I'm gonna care about.

569
00:23:42,387 --> 00:23:44,822
You're gonna use user agent
strings that we talked about.

570
00:23:44,823 --> 00:23:46,358
Mail rule creation.

571
00:23:46,358 --> 00:23:51,062
Typically I find that a lot of
the actors from Europe, from,

572
00:23:55,167 --> 00:23:56,735
I don't know, I'm tryin' not
to name a specific countries

573
00:23:56,735 --> 00:23:59,870
but from the African region
that are usually interested

574
00:23:59,871 --> 00:24:02,507
in monetary gain
through wire transfer

575
00:24:02,507 --> 00:24:04,910
they will create mail rules
and they will create mail rules

576
00:24:04,910 --> 00:24:08,313
to either cover their tracks
from the kind of the spam

577
00:24:08,313 --> 00:24:10,549
that they stay flood out or

578
00:24:10,549 --> 00:24:13,318
they will create a mail rule
to auto-delete responses.

579
00:24:13,318 --> 00:24:14,586
And they wanna try to hide

580
00:24:14,586 --> 00:24:15,921
their activity as
long as possible.

581
00:24:15,921 --> 00:24:19,558
So typically mail
users are not creating

582
00:24:19,558 --> 00:24:21,460
a lot of mail rules
in their accounts.

583
00:24:22,828 --> 00:24:24,796
If mail rules have been
created within a certain time,

584
00:24:24,796 --> 00:24:27,466
something to help rise
to the top If I'm looking

585
00:24:27,466 --> 00:24:30,034
at hundreds of accounts,
to look for those outliers.

586
00:24:30,035 --> 00:24:32,137
In fact is a good
example we're working

587
00:24:32,137 --> 00:24:37,142
a 191 account breach right now

588
00:24:38,510 --> 00:24:40,378
and one of the things
we've done with this volume

589
00:24:40,378 --> 00:24:43,348
of accounts is A, is
the 191 the total?

590
00:24:43,348 --> 00:24:44,683
I mean that's a lot of accounts

591
00:24:44,683 --> 00:24:46,051
that have had
unauthorized access out

592
00:24:46,051 --> 00:24:49,521
of a 10-12000 account tenant.

593
00:24:49,521 --> 00:24:50,822
One of things we've
been looking for

594
00:24:50,822 --> 00:24:52,122
is during the time we know

595
00:24:52,123 --> 00:24:54,025
of unauthorized access,
who had mail rules?

596
00:24:54,025 --> 00:24:56,461
And we've found
another 49 accounts

597
00:24:56,461 --> 00:24:58,330
and the mail rules
were all malicious.

598
00:24:58,330 --> 00:25:01,166
It was a very quick
way for us to pivot on

599
00:25:01,166 --> 00:25:02,667
that data and look for things.

600
00:25:04,402 --> 00:25:05,837
And the geolocation
of the IP address

601
00:25:05,837 --> 00:25:08,507
is the end of the day whatever
your preferred tool is.

602
00:25:08,507 --> 00:25:11,343
Splunk or another tool where
you're doing geo IP lookups.

603
00:25:12,777 --> 00:25:16,481
Something that helps you on
a map identify what is normal

604
00:25:16,481 --> 00:25:18,650
for this client or for
these user accounts

605
00:25:18,650 --> 00:25:20,252
and what is an outlier.

606
00:25:20,252 --> 00:25:21,786
Especially because most actors

607
00:25:21,786 --> 00:25:24,456
in my experience are
not very original.

608
00:25:24,456 --> 00:25:26,091
They will usually come
from the same area

609
00:25:26,091 --> 00:25:28,592
or the same data centers
or the same VPN client

610
00:25:28,593 --> 00:25:31,863
and you can very quickly start
kind of seeing that on a map.

611
00:25:31,863 --> 00:25:34,566
One thing to look
for in my experience

612
00:25:34,566 --> 00:25:36,868
is the IP addresses you
may see from a bad guy

613
00:25:36,868 --> 00:25:39,838
on one account they may
especially they're using like

614
00:25:39,838 --> 00:25:42,541
an IPVanish or they're using
some type of VPN client

615
00:25:42,541 --> 00:25:46,043
or an anonymizer service they
may get different IPs assigned

616
00:25:46,044 --> 00:25:48,346
to them over a period of time

617
00:25:48,346 --> 00:25:50,949
but typically there from
that same IP netblock.

618
00:25:50,949 --> 00:25:53,451
And I've gotta Powershell
query I'll show you.

619
00:25:53,451 --> 00:25:58,256
You can use to search
an entire netblock

620
00:25:58,256 --> 00:26:01,192
and make sure you're not
missing particular other IPs

621
00:26:01,192 --> 00:26:03,461
that you may not have seen
specifically in a log.

622
00:26:03,461 --> 00:26:06,264
This allows you to have a lot
more about broader scapple

623
00:26:06,264 --> 00:26:10,135
to see if there's other IPs
from that same actor or group.

624
00:26:13,071 --> 00:26:15,139
Couple examples of
clients you may see

625
00:26:15,140 --> 00:26:17,509
in the unified audit
log and it Microsoft's

626
00:26:17,509 --> 00:26:19,177
very proud of their
products, right?

627
00:26:19,177 --> 00:26:22,246
So they're going to give you
a very detailed information

628
00:26:22,247 --> 00:26:24,449
about Outlook if it's
their product their client

629
00:26:24,449 --> 00:26:26,885
and then in my experience
and lookin' these logs

630
00:26:26,885 --> 00:26:28,219
if it's not an Outlook
client they're like,

631
00:26:28,219 --> 00:26:29,821
"Eh, it's a IMAP".

632
00:26:29,821 --> 00:26:30,822
(laughs)

633
00:26:30,822 --> 00:26:32,756
Well, thanks Microsoft.

634
00:26:32,757 --> 00:26:35,393
You will notice they
do not identify other

635
00:26:35,393 --> 00:26:37,662
non-Microsoft
Outlook mail clients

636
00:26:37,662 --> 00:26:40,098
and they literally let you
know there's a protocol

637
00:26:40,098 --> 00:26:41,566
which is indicative of an

638
00:26:41,566 --> 00:26:45,337
non-Microsoft Outlook mail
client accessing the account.

639
00:26:45,337 --> 00:26:46,905
Which of course, you know,
at the end of the day

640
00:26:46,905 --> 00:26:49,341
I'll let you be the
forensic verifiers on that

641
00:26:49,341 --> 00:26:53,144
but in my opinion and through
testing normally means

642
00:26:53,144 --> 00:26:57,048
the possibility is there that
at least certain emails would

643
00:26:57,048 --> 00:26:58,450
have been allowed
to be downloaded

644
00:26:58,450 --> 00:27:01,419
if not a complete ActiveSync
of an email account.

645
00:27:04,756 --> 00:27:06,191
Going back to the
rules we've touched on

646
00:27:06,191 --> 00:27:07,325
briefly a minute ago.

647
00:27:07,325 --> 00:27:08,860
So these are the
operators you would see

648
00:27:08,860 --> 00:27:12,363
inside a unified audit log if
a bad guy creates a mail rule

649
00:27:12,364 --> 00:27:14,633
to do whatever it is whether
it's auto-forwarding,

650
00:27:14,633 --> 00:27:17,235
deleting messages based
on certain keywords.

651
00:27:17,235 --> 00:27:19,870
These are the operators
you would see written down

652
00:27:19,871 --> 00:27:23,208
to the log and again that's
a change to the account

653
00:27:23,208 --> 00:27:25,677
so forensically you
would see set mailbox as

654
00:27:25,677 --> 00:27:30,615
that last operator
being recorded after
the actor has gone

655
00:27:30,615 --> 00:27:34,853
and created the mail
rule, updated the
content or the rules,

656
00:27:36,021 --> 00:27:39,324
the arguments for the rule,

657
00:27:39,324 --> 00:27:41,426
and you can actually
see almost the seconds

658
00:27:41,426 --> 00:27:44,529
between the actor clicking
the different options

659
00:27:44,529 --> 00:27:47,365
with the mail role things
and then when he hits save

660
00:27:47,365 --> 00:27:49,868
that's when the set mailbox
is written to the log.

661
00:27:51,736 --> 00:27:55,106
There is something extremely
unique to Office 365

662
00:27:55,106 --> 00:27:58,343
that is not reflected
in the Microsoft client,

663
00:27:58,343 --> 00:27:59,878
Outlook mail client, and that

664
00:27:59,878 --> 00:28:01,279
is another
auto-forwarding feature.

665
00:28:01,279 --> 00:28:03,882
So you can auto-forward
messages as a bad guy.

666
00:28:03,882 --> 00:28:06,818
Out of a victim's
account using mail rule.

667
00:28:06,818 --> 00:28:11,823
You can also in Office 365
go to options, mail accounts,

668
00:28:13,491 --> 00:28:17,362
forwarding, and I can type
in an email address here

669
00:28:17,362 --> 00:28:19,130
and say keep a copy
of forwarded messages,

670
00:28:19,130 --> 00:28:21,666
so they still get
delivered to the inbox,

671
00:28:21,666 --> 00:28:23,368
and now I have a second
place I have to look

672
00:28:23,368 --> 00:28:24,601
as an instant responder to see

673
00:28:24,602 --> 00:28:26,137
if a bad guy has put
an email address.

674
00:28:26,137 --> 00:28:29,441
And this, more times than
not, is completely missed

675
00:28:29,441 --> 00:28:31,009
by infosec teams
internal company.

676
00:28:31,009 --> 00:28:33,411
They know to go to
look for mail rules.

677
00:28:33,411 --> 00:28:35,747
Mail rules have been around
since as long, you know,

678
00:28:35,747 --> 00:28:38,216
Microsoft has had all
earlier versions of Outlook.

679
00:28:38,216 --> 00:28:41,119
This is specific to Office 365

680
00:28:41,119 --> 00:28:42,352
and the only way you'd be able

681
00:28:42,353 --> 00:28:44,022
to go in and find
that is to actually

682
00:28:44,022 --> 00:28:46,491
you can do via Powershell or
go into the user's account

683
00:28:46,491 --> 00:28:47,992
and manually go look for this.

684
00:28:51,463 --> 00:28:53,598
Here's the IP address example
that I was telling you about.

685
00:28:53,598 --> 00:28:56,033
So if you want to search unified
audit log from Powershell,

686
00:28:56,034 --> 00:28:58,403
you're a command line
guru, you wanna dive in,

687
00:28:58,403 --> 00:29:00,739
this would be the command
that you would issue

688
00:29:00,739 --> 00:29:05,744
from Powershell to actually
search the unified audit log,

689
00:29:07,112 --> 00:29:08,646
and this is actually searched
all unified audit logs,

690
00:29:08,646 --> 00:29:10,115
so all the audit logs for all
of your users in your tenant,

691
00:29:10,115 --> 00:29:12,350
this is a quick way quick
way, quick down and dirty way,

692
00:29:12,350 --> 00:29:15,919
if you have some indicators
of compromise, type em in,

693
00:29:15,920 --> 00:29:17,188
you give the dates, the start,

694
00:29:17,188 --> 00:29:19,858
and the end, export
to a CSV, and boom.

695
00:29:19,858 --> 00:29:22,260
Usually within seconds
this query can run

696
00:29:22,260 --> 00:29:24,262
and it immediately
can give you IPs

697
00:29:24,262 --> 00:29:26,898
helping you identify
other accounts

698
00:29:26,898 --> 00:29:28,632
that you may not know about.

699
00:29:28,633 --> 00:29:30,535
And this second example
there is what I'd recommend

700
00:29:30,535 --> 00:29:32,003
if you're tryin' to do netblock.

701
00:29:32,003 --> 00:29:33,804
So if you know I have a bad IP

702
00:29:33,805 --> 00:29:36,775
it goes back to a hosting
center no legitimate activity

703
00:29:37,942 --> 00:29:41,045
do a Whois, do a DNS
lookup, figure out

704
00:29:41,045 --> 00:29:43,515
what is the netblock owned
by that organization.

705
00:29:43,515 --> 00:29:45,250
I'd recommend you
search the whole thing.

706
00:29:45,250 --> 00:29:47,519
You may find that
actors using other boxes

707
00:29:47,519 --> 00:29:51,089
from that hosting provider or
other IP's within that range.

708
00:29:53,525 --> 00:29:55,527
So beyond the unified audit log.

709
00:29:55,527 --> 00:29:59,764
In Azure, depending on the
licensing of the tenant,

710
00:29:59,764 --> 00:30:02,867
usually it requires an
E1 or an E3 licensing,

711
00:30:02,867 --> 00:30:04,903
there are a couple additional
things that Microsoft

712
00:30:04,903 --> 00:30:07,839
has done to try to
help instant responders

713
00:30:07,839 --> 00:30:10,308
pull out suspicious activity.

714
00:30:11,609 --> 00:30:13,711
And you would see
users flagged for risk

715
00:30:13,711 --> 00:30:15,613
and risky sign-ins and those

716
00:30:15,613 --> 00:30:17,415
would be two very
quick logs you'd go to.

717
00:30:17,415 --> 00:30:20,418
Usually is logs
7 days or 30 days

718
00:30:20,418 --> 00:30:22,085
is the max they're available.

719
00:30:22,086 --> 00:30:23,588
So they're extremely volatile.

720
00:30:25,723 --> 00:30:26,925
So wrapping up real quick.

721
00:30:26,925 --> 00:30:28,459
So I think I'm pushing my time.

722
00:30:29,727 --> 00:30:31,663
If you wanna jump to
Powershell you can additionally

723
00:30:31,663 --> 00:30:34,933
do some interesting queries
to pull out a massive amount

724
00:30:34,933 --> 00:30:36,467
of data about a
particular user account.

725
00:30:36,467 --> 00:30:38,937
Not necessarily of a
lot of forensic interest

726
00:30:38,937 --> 00:30:41,238
but it is some very
interesting details about

727
00:30:41,239 --> 00:30:44,809
what auditable events are
turned on for an account

728
00:30:44,809 --> 00:30:47,245
when the last password
reset was for the account,

729
00:30:47,245 --> 00:30:48,513
and some very
interesting activity

730
00:30:48,513 --> 00:30:50,782
that may tell you just
general information

731
00:30:50,782 --> 00:30:52,550
about the user
you're investigating.

732
00:30:56,020 --> 00:30:58,256
I talked briefly
that a global admin

733
00:30:58,256 --> 00:31:01,626
does not have 100%
rights within a tenant.

734
00:31:01,626 --> 00:31:04,729
You would need to, if you
want to do PST forensics

735
00:31:04,729 --> 00:31:07,198
and look for other
artifacts within that PST,

736
00:31:07,198 --> 00:31:09,000
you would need to
assign the global admin

737
00:31:09,000 --> 00:31:11,336
an eDiscovery admin role

738
00:31:11,336 --> 00:31:14,505
so that he can download
the actual PST contents.

739
00:31:17,408 --> 00:31:19,444
So this was very briefly

740
00:31:19,444 --> 00:31:21,678
had an instant response
scenario we were doing.

741
00:31:21,679 --> 00:31:25,483
Had a couple emails that
I pulled out of a PST and,

742
00:31:25,483 --> 00:31:27,385
"Hello Frank, per our
prior conversation,

743
00:31:27,385 --> 00:31:28,720
please let me know what
you think about it."

744
00:31:28,720 --> 00:31:30,121
I'm thinking this
looks a little odd.

745
00:31:30,121 --> 00:31:32,991
It was right during the
unauthorized access.

746
00:31:32,991 --> 00:31:34,993
I thought this was the actor.

747
00:31:34,993 --> 00:31:35,960
It was.

748
00:31:38,029 --> 00:31:40,064
So Julie responds, excuse
me, Frank responds,

749
00:31:40,064 --> 00:31:41,633
"Julie is this legitimate?"

750
00:31:41,633 --> 00:31:44,235
Of course, now Julie is the
account that has been popped

751
00:31:44,235 --> 00:31:46,704
and the actor is the one
sending the messages out.

752
00:31:47,605 --> 00:31:50,541
"Frank, yes it is, I sent it."

753
00:31:51,743 --> 00:31:52,877
Thank you Mr. Actor.

754
00:31:52,877 --> 00:31:53,878
I appreciate that.

755
00:31:55,380 --> 00:31:58,182
So, not gonna spend too much
long on the email analysis.

756
00:31:58,182 --> 00:31:59,984
You guys know what you're
doing with that, right?

757
00:31:59,984 --> 00:32:01,519
At the end of the day,
you're lookin' at the emails

758
00:32:01,519 --> 00:32:03,488
that may be of interest
and may still be left over

759
00:32:03,488 --> 00:32:05,523
in the PST and
those of course help

760
00:32:05,523 --> 00:32:07,524
from a timeline
analysis standpoint.

761
00:32:07,525 --> 00:32:08,927
If we know the actor
was in the account

762
00:32:08,927 --> 00:32:10,194
or we're looking
for particularly

763
00:32:10,194 --> 00:32:11,361
what they did you may find

764
00:32:11,362 --> 00:32:13,164
some very interesting
emails actually

765
00:32:13,164 --> 00:32:14,399
still left in the account.

766
00:32:14,399 --> 00:32:16,700
RSS subscriptions is
a very popular folder

767
00:32:16,701 --> 00:32:17,936
I recommend you go look at.

768
00:32:17,936 --> 00:32:19,971
Actors love hiding
messages there.

769
00:32:19,971 --> 00:32:22,674
It's a default folder
Microsoft has in Outlook.

770
00:32:22,674 --> 00:32:25,176
Almost no one ever uses
it and it's a great spot

771
00:32:25,176 --> 00:32:27,078
where actors rules
will usually mark

772
00:32:27,078 --> 00:32:29,080
as read and move
messages to there.

773
00:32:31,616 --> 00:32:32,917
Second really funny scenario.

774
00:32:32,917 --> 00:32:35,786
Phishing email with an
attachment received.

775
00:32:35,787 --> 00:32:38,289
We've identified through the
PST forensics the message

776
00:32:38,289 --> 00:32:41,526
had been marked as read
so we knew the user,

777
00:32:41,526 --> 00:32:42,894
the legitimate user,
had clicked the link

778
00:32:42,894 --> 00:32:44,429
in the phishing email.

779
00:32:44,429 --> 00:32:46,497
He'd gone to the website,
submitted his credentials,

780
00:32:46,497 --> 00:32:48,933
he was arguing he
had not done this

781
00:32:48,933 --> 00:32:51,569
but I found an email that
said and him responding

782
00:32:51,569 --> 00:32:53,771
to the actor, "Send me
something I can open

783
00:32:53,771 --> 00:32:56,341
and not something that makes
me feel uncomfortable."

784
00:32:59,844 --> 00:33:02,380
I usually get asked,
"What can my client"

785
00:33:02,380 --> 00:33:03,948
so I usually get asked,
"What can we do to make sure

786
00:33:03,948 --> 00:33:05,683
that we protect and
harden ourself".

787
00:33:05,683 --> 00:33:07,819
You know, multi-factor
authentication usually

788
00:33:07,819 --> 00:33:11,254
will nullify probably 99% of
these types of attacks, right?

789
00:33:11,255 --> 00:33:12,690
You're using single factor,

790
00:33:12,690 --> 00:33:14,792
and a phishing page captures
username and password,

791
00:33:14,792 --> 00:33:16,593
you're gonna have a little
bit of an issue there.

792
00:33:16,594 --> 00:33:19,263
If you turn multi-factor on
of course you're going to

793
00:33:19,263 --> 00:33:21,198
have that second
level of factor.

794
00:33:21,199 --> 00:33:22,433
You're gonna have the token.

795
00:33:22,433 --> 00:33:24,769
It's much harder for a
bad guy to capture that.

796
00:33:24,769 --> 00:33:28,339
I have seen a trend
where actors are starting

797
00:33:28,339 --> 00:33:33,344
to also put a token field
on these phish kit pages

798
00:33:34,779 --> 00:33:36,047
so it asks for username,
password, and your token.

799
00:33:36,047 --> 00:33:38,149
And I have had some instances

800
00:33:38,149 --> 00:33:40,685
where users have
given up their token.

801
00:33:40,685 --> 00:33:42,486
Tokens usually good
for 10-15 minutes,

802
00:33:42,487 --> 00:33:43,721
depending how it's configured,

803
00:33:43,721 --> 00:33:45,256
and the bad guy still gets in.

804
00:33:45,256 --> 00:33:46,357
So be aware of that.

805
00:33:47,825 --> 00:33:49,360
But domain
auto-forwarding blocks.

806
00:33:49,360 --> 00:33:51,161
At the end of the day
auto-forwarding messages out

807
00:33:51,162 --> 00:33:54,165
of your tenant because a bad
actors create a mail rule

808
00:33:54,165 --> 00:33:56,067
is a significant issue.

809
00:33:56,067 --> 00:33:57,769
These would be ways
where you can stop that.

810
00:33:57,769 --> 00:34:02,006
I've in most clients I speak
with and do consulting work

811
00:34:02,006 --> 00:34:04,042
for they're like, "We don't
have a legitimate reason

812
00:34:04,042 --> 00:34:05,309
to be sending messages outside

813
00:34:05,309 --> 00:34:07,912
of our tenant to an
external third-party."

814
00:34:07,912 --> 00:34:10,014
Microsoft gives you a
Powershell way to actually block

815
00:34:10,014 --> 00:34:12,784
that tenant wide and those
messages are attempted

816
00:34:12,784 --> 00:34:14,485
to be auto-forwarded
they will get dropped

817
00:34:14,485 --> 00:34:16,687
and they will not be
delivered successfully.

818
00:34:19,023 --> 00:34:19,857
And that's it.

819
00:34:21,092 --> 00:34:22,126
What questions?

820
00:34:22,126 --> 00:34:24,328
(audience applause)

821
00:34:24,328 --> 00:34:27,065
(thumping music)

