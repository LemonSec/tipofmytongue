1
00:00:04,799 --> 00:00:08,639
let's get ryan on board here ryan is a

2
00:00:07,120 --> 00:00:11,440
fellow instructor

3
00:00:08,639 --> 00:00:13,360
who uh joins phil and i and in teaching

4
00:00:11,440 --> 00:00:15,800
in the defer or the digital forensic

5
00:00:13,360 --> 00:00:18,560
incident response track ryan is a

6
00:00:15,800 --> 00:00:20,320
4-6-10 instructor for anyone here that

7
00:00:18,560 --> 00:00:20,880
is our malware reverse engineering

8
00:00:20,320 --> 00:00:23,199
course

9
00:00:20,880 --> 00:00:24,799
and uh ryan has taken it upon himself to

10
00:00:23,199 --> 00:00:26,800
take quite frankly one of

11
00:00:24,800 --> 00:00:29,039
the most difficult intricate

12
00:00:26,800 --> 00:00:30,160
puzzle-laden courses and simply said yup

13
00:00:29,039 --> 00:00:31,359
i want to teach that when i'm going

14
00:00:30,160 --> 00:00:33,840
after it and um

15
00:00:31,359 --> 00:00:35,520
i actually had a chance to meet ryan in

16
00:00:33,840 --> 00:00:37,040
person for the first time before he did

17
00:00:35,520 --> 00:00:38,000
his first teach and to say he was

18
00:00:37,040 --> 00:00:40,079
excited

19
00:00:38,000 --> 00:00:41,840
would be to say that the titanic was a

20
00:00:40,079 --> 00:00:43,840
rowboat and

21
00:00:41,840 --> 00:00:45,520
that just clearly is not a good way of

22
00:00:43,840 --> 00:00:47,120
describing it he was beyond excited and

23
00:00:45,520 --> 00:00:47,680
i think all that enthusiasm shines

24
00:00:47,120 --> 00:00:50,959
through

25
00:00:47,680 --> 00:00:53,680
um little-known side factoid ryan and i

26
00:00:50,960 --> 00:00:55,039
almost worked together as well uh in a

27
00:00:53,680 --> 00:00:56,239
professional capacity i think we missed

28
00:00:55,039 --> 00:00:57,039
each other right by what maybe like a

29
00:00:56,239 --> 00:00:59,440
month or so

30
00:00:57,039 --> 00:01:01,440
a month yeah yeah there was a very very

31
00:00:59,440 --> 00:01:03,199
very short uh pass but there we go yep

32
00:01:01,440 --> 00:01:05,759
there we go he's supporting himself

33
00:01:03,199 --> 00:01:07,280
um had a very very uh near near miss

34
00:01:05,760 --> 00:01:08,479
there if you will but i'm excited to

35
00:01:07,280 --> 00:01:09,119
have him on here excited to have him

36
00:01:08,479 --> 00:01:10,880
talking to us

37
00:01:09,119 --> 00:01:14,000
ryan's talk today is going to be hunting

38
00:01:10,880 --> 00:01:16,640
human operated ransomware operators

39
00:01:14,000 --> 00:01:18,080
which uh is a good that's got to be an

40
00:01:16,640 --> 00:01:20,240
acronym here of something

41
00:01:18,080 --> 00:01:21,280
that yeah be careful with that one yeah

42
00:01:20,240 --> 00:01:23,520
yeah

43
00:01:21,280 --> 00:01:24,799
yeah i'm not going any further than that

44
00:01:23,520 --> 00:01:25,280
we'll just leave it as uh ladies and

45
00:01:24,799 --> 00:01:28,159
gentlemen

46
00:01:25,280 --> 00:01:30,720
ryan chapman all right all right thank

47
00:01:28,159 --> 00:01:33,360
you very much

48
00:01:30,720 --> 00:01:35,200
hey folks my name is ryan and i'm here

49
00:01:33,360 --> 00:01:38,000
to talk about hunting humans

50
00:01:35,200 --> 00:01:39,119
specifically humans involved with

51
00:01:38,000 --> 00:01:41,439
ransomware

52
00:01:39,119 --> 00:01:43,520
so i am an incident response analyst

53
00:01:41,439 --> 00:01:46,000
with blackberry formerly silence

54
00:01:43,520 --> 00:01:48,240
i'm a forensic 610 instructor absolutely

55
00:01:46,000 --> 00:01:50,799
love teaching those courses

56
00:01:48,240 --> 00:01:51,839
and i now am the lead organizer for

57
00:01:50,799 --> 00:01:54,159
cactus con which is

58
00:01:51,840 --> 00:01:55,520
arizona's premier security and hacker

59
00:01:54,159 --> 00:01:57,680
conference

60
00:01:55,520 --> 00:01:59,119
today did i sell you on that uh we're

61
00:01:57,680 --> 00:02:01,680
kicking off in february so

62
00:01:59,119 --> 00:02:03,200
come come check us out online all right

63
00:02:01,680 --> 00:02:05,920
let's get to it

64
00:02:03,200 --> 00:02:08,319
ransomware has evolved and the days of

65
00:02:05,920 --> 00:02:10,479
the initial stage or secondary stage

66
00:02:08,318 --> 00:02:12,079
being ransomware immediately after

67
00:02:10,479 --> 00:02:14,640
someone clicks something silly

68
00:02:12,080 --> 00:02:16,640
and gets infected and the one or maybe a

69
00:02:14,640 --> 00:02:18,720
couple machines in a given subnet

70
00:02:16,640 --> 00:02:20,079
become encrypted that is becoming more

71
00:02:18,720 --> 00:02:22,239
and more a thing of

72
00:02:20,080 --> 00:02:24,319
the past of yesteryear and now we are

73
00:02:22,239 --> 00:02:25,040
seeing these targeted attacks by these

74
00:02:24,319 --> 00:02:28,238
groups that are

75
00:02:25,040 --> 00:02:30,400
really good at what they do so if you're

76
00:02:28,239 --> 00:02:32,160
familiar with maze ryuk rival

77
00:02:30,400 --> 00:02:33,440
sam sam couple of the bigger name

78
00:02:32,160 --> 00:02:35,280
ransomware attacks

79
00:02:33,440 --> 00:02:37,599
what we're going to talk about right now

80
00:02:35,280 --> 00:02:38,000
are some hunting methods for identifying

81
00:02:37,599 --> 00:02:39,599
them

82
00:02:38,000 --> 00:02:41,120
for when they get into your environment

83
00:02:39,599 --> 00:02:43,679
because if you don't

84
00:02:41,120 --> 00:02:45,200
prevent them or identify them quickly

85
00:02:43,680 --> 00:02:46,480
you're going to realize that by the time

86
00:02:45,200 --> 00:02:48,560
you do find them

87
00:02:46,480 --> 00:02:50,319
it's already too late prevention and

88
00:02:48,560 --> 00:02:52,720
detection are key

89
00:02:50,319 --> 00:02:54,399
and the reason for that is they carry

90
00:02:52,720 --> 00:02:56,480
out these attacks very similar

91
00:02:54,400 --> 00:02:58,640
to like an advanced threat group whether

92
00:02:56,480 --> 00:02:59,518
it's nation state sponsored or not

93
00:02:58,640 --> 00:03:01,119
they're going to get into your

94
00:02:59,519 --> 00:03:02,319
environment they're going to move around

95
00:03:01,120 --> 00:03:04,560
laterally

96
00:03:02,319 --> 00:03:05,920
privilege escalation here and there grab

97
00:03:04,560 --> 00:03:07,599
all kinds of stuff they want

98
00:03:05,920 --> 00:03:09,920
they're going to stage a bunch of your

99
00:03:07,599 --> 00:03:10,959
information after doing internal recon

100
00:03:09,920 --> 00:03:12,879
and they're going to steal it they're

101
00:03:10,959 --> 00:03:13,840
going to exfiltrate it out so if

102
00:03:12,879 --> 00:03:16,840
anyone's familiar

103
00:03:13,840 --> 00:03:18,080
for example with the maze shaming site

104
00:03:16,840 --> 00:03:20,640
mazenews.top be

105
00:03:18,080 --> 00:03:21,360
careful about going there by the way

106
00:03:20,640 --> 00:03:23,279
they they're

107
00:03:21,360 --> 00:03:25,519
shamelessly like hey i tell you what you

108
00:03:23,280 --> 00:03:26,319
have three to ten days to pay up or not

109
00:03:25,519 --> 00:03:27,680
only

110
00:03:26,319 --> 00:03:30,238
are you not going to be able to resume

111
00:03:27,680 --> 00:03:31,920
operations quickly not only may you not

112
00:03:30,239 --> 00:03:32,959
receive your data back if you don't have

113
00:03:31,920 --> 00:03:34,720
great backup

114
00:03:32,959 --> 00:03:36,959
infrastructure and have tested it and it

115
00:03:34,720 --> 00:03:38,799
works but we're going to expose your

116
00:03:36,959 --> 00:03:40,799
data and your clients data and your

117
00:03:38,799 --> 00:03:41,519
clients clients data everything we found

118
00:03:40,799 --> 00:03:43,120
we took it

119
00:03:41,519 --> 00:03:45,120
we're going to give it away to the world

120
00:03:43,120 --> 00:03:48,879
and so that is a huge

121
00:03:45,120 --> 00:03:51,120
problem to deal with so let's talk about

122
00:03:48,879 --> 00:03:51,920
some quick wins against this type of

123
00:03:51,120 --> 00:03:53,599
attack

124
00:03:51,920 --> 00:03:55,119
now when these folks get into your

125
00:03:53,599 --> 00:03:57,760
network i have to say

126
00:03:55,120 --> 00:03:59,439
i've dealt with many of these this year

127
00:03:57,760 --> 00:04:02,319
in addition to last year

128
00:03:59,439 --> 00:04:04,239
they are not super stealth in fact i

129
00:04:02,319 --> 00:04:05,920
don't think they really care to be i

130
00:04:04,239 --> 00:04:07,439
don't i think it's kind of by design

131
00:04:05,920 --> 00:04:08,559
that's financially motivated they're

132
00:04:07,439 --> 00:04:09,680
like you know what i'm just going to go

133
00:04:08,560 --> 00:04:12,080
boop boop boop and

134
00:04:09,680 --> 00:04:14,000
sucks for you um they can be within the

135
00:04:12,080 --> 00:04:14,480
environment their dwell time can be days

136
00:04:14,000 --> 00:04:16,959
to

137
00:04:14,480 --> 00:04:18,238
actually almost a year months but while

138
00:04:16,959 --> 00:04:20,880
they're there they're not

139
00:04:18,238 --> 00:04:23,198
very quiet and they do very similar

140
00:04:20,880 --> 00:04:25,199
things each time between these groups

141
00:04:23,199 --> 00:04:27,440
that's what we're focusing on now we're

142
00:04:25,199 --> 00:04:28,160
focusing on like the jiu jitsu black

143
00:04:27,440 --> 00:04:30,560
belt

144
00:04:28,160 --> 00:04:32,080
who has perfected the easiest moves and

145
00:04:30,560 --> 00:04:33,280
before your match they stare at you

146
00:04:32,080 --> 00:04:34,320
right in the face and they say here's

147
00:04:33,280 --> 00:04:36,320
what i'm going to do

148
00:04:34,320 --> 00:04:37,759
boom boom boom and you say uh and then

149
00:04:36,320 --> 00:04:38,800
they do it anyway because they're just

150
00:04:37,759 --> 00:04:40,479
that good

151
00:04:38,800 --> 00:04:42,320
that's what these ransomware operators

152
00:04:40,479 --> 00:04:44,800
are doing so i

153
00:04:42,320 --> 00:04:46,639
chose to focus on how to find them as

154
00:04:44,800 --> 00:04:50,479
soon as they get into the environment

155
00:04:46,639 --> 00:04:52,240
that's my primary focus for this talk

156
00:04:50,479 --> 00:04:54,159
now first up you're going to want to

157
00:04:52,240 --> 00:04:56,080
have a hunting environment that is

158
00:04:54,160 --> 00:04:57,919
augmented and that facilitates

159
00:04:56,080 --> 00:04:59,199
this type of analysis that we're going

160
00:04:57,919 --> 00:05:00,960
to be doing so

161
00:04:59,199 --> 00:05:02,800
it's very important that you understand

162
00:05:00,960 --> 00:05:04,320
what you are logging and that you

163
00:05:02,800 --> 00:05:06,320
understand what you are

164
00:05:04,320 --> 00:05:08,479
not logging because many folks don't

165
00:05:06,320 --> 00:05:11,120
realize what gaps they have so it's

166
00:05:08,479 --> 00:05:13,360
important to take note of these things

167
00:05:11,120 --> 00:05:15,440
i've provided a bunch of resources for

168
00:05:13,360 --> 00:05:17,039
you to check out after the talk

169
00:05:15,440 --> 00:05:18,880
and you're going to have the pdf posted

170
00:05:17,039 --> 00:05:20,479
so you can click on these links

171
00:05:18,880 --> 00:05:22,639
and it will describe if you need to

172
00:05:20,479 --> 00:05:24,400
identify these types of things

173
00:05:22,639 --> 00:05:26,000
look for these things but make sure

174
00:05:24,400 --> 00:05:27,919
you're logging the following

175
00:05:26,000 --> 00:05:29,600
so these cheat sheets are provided by

176
00:05:27,919 --> 00:05:32,159
michael goff hacker hurricane

177
00:05:29,600 --> 00:05:33,680
fantastic fella and i highly recommend

178
00:05:32,160 --> 00:05:35,360
that you check those out

179
00:05:33,680 --> 00:05:37,440
additionally make sure that you have

180
00:05:35,360 --> 00:05:38,080
either a very strong edr within your

181
00:05:37,440 --> 00:05:40,800
environment

182
00:05:38,080 --> 00:05:42,320
or some type of log augmentation like

183
00:05:40,800 --> 00:05:44,080
sysmon and i'm going to push

184
00:05:42,320 --> 00:05:46,000
sysmond left and right in this talk so

185
00:05:44,080 --> 00:05:49,120
just heads up if you already have it

186
00:05:46,000 --> 00:05:50,639
awesome if you don't stop it go get it

187
00:05:49,120 --> 00:05:52,560
there's also a tool called windows

188
00:05:50,639 --> 00:05:54,479
logging service which i really really

189
00:05:52,560 --> 00:05:55,919
like so you should check that out

190
00:05:54,479 --> 00:05:57,919
if you're a government contractor you

191
00:05:55,919 --> 00:05:59,359
can get a deal for windows logging

192
00:05:57,919 --> 00:06:01,840
service

193
00:05:59,360 --> 00:06:02,560
and before we get too far into string

194
00:06:01,840 --> 00:06:04,638
matching or

195
00:06:02,560 --> 00:06:06,000
pattern matching as far as this hunting

196
00:06:04,639 --> 00:06:08,960
is concerned i do want to

197
00:06:06,000 --> 00:06:09,919
say very often well actually not as

198
00:06:08,960 --> 00:06:12,318
often that's the whole point of this

199
00:06:09,919 --> 00:06:14,560
conversation but sometimes i should say

200
00:06:12,319 --> 00:06:16,080
these strings will be obfuscated so if

201
00:06:14,560 --> 00:06:19,680
you're dealing with something like

202
00:06:16,080 --> 00:06:21,520
maybe a command prompt based

203
00:06:19,680 --> 00:06:23,520
stage to malware right you're going to

204
00:06:21,520 --> 00:06:25,120
want to strip out things like

205
00:06:23,520 --> 00:06:26,639
the extraneous characters that you'll

206
00:06:25,120 --> 00:06:29,440
find in those areas

207
00:06:26,639 --> 00:06:31,280
carrot utility you know if your sim or

208
00:06:29,440 --> 00:06:32,960
log aggregator supports

209
00:06:31,280 --> 00:06:34,719
filtering those things out or doing

210
00:06:32,960 --> 00:06:35,680
character replacements make sure you

211
00:06:34,720 --> 00:06:38,240
understand

212
00:06:35,680 --> 00:06:39,840
primarily the escape characters for

213
00:06:38,240 --> 00:06:41,440
whatever you're looking at so and i give

214
00:06:39,840 --> 00:06:43,119
these as great examples just do

215
00:06:41,440 --> 00:06:44,479
replacements on this take them out so

216
00:06:43,120 --> 00:06:47,680
that your strings can match

217
00:06:44,479 --> 00:06:48,719
properly and accordingly i'd be remiss

218
00:06:47,680 --> 00:06:50,880
if i didn't mention

219
00:06:48,720 --> 00:06:52,479
sigma this is a phenomenal framework i'm

220
00:06:50,880 --> 00:06:53,280
sure many folks have already heard of

221
00:06:52,479 --> 00:06:54,880
sigma

222
00:06:53,280 --> 00:06:56,638
uh florian roth i call him the

223
00:06:54,880 --> 00:06:58,400
granddaddy of yara because he's so great

224
00:06:56,639 --> 00:06:58,800
with that but he has his hands in mini

225
00:06:58,400 --> 00:07:01,520
things

226
00:06:58,800 --> 00:07:02,080
and he's provided a unified format that

227
00:07:01,520 --> 00:07:04,318
you can

228
00:07:02,080 --> 00:07:06,159
use in fact there's a repo of rules

229
00:07:04,319 --> 00:07:08,319
right here that you can go and grab

230
00:07:06,160 --> 00:07:09,280
right now and then if you happen to have

231
00:07:08,319 --> 00:07:12,000
any of these

232
00:07:09,280 --> 00:07:12,719
sims edr's aggregators over on the right

233
00:07:12,000 --> 00:07:15,440
hand side

234
00:07:12,720 --> 00:07:16,080
you can convert the rules into your

235
00:07:15,440 --> 00:07:17,759
particular

236
00:07:16,080 --> 00:07:19,599
search format so if you don't have a

237
00:07:17,759 --> 00:07:20,880
team right now of people who are going

238
00:07:19,599 --> 00:07:21,520
to take some of the stuff i'm going to

239
00:07:20,880 --> 00:07:23,840
discuss

240
00:07:21,520 --> 00:07:25,520
and immediately you know weaponize it to

241
00:07:23,840 --> 00:07:27,280
go search for stuff

242
00:07:25,520 --> 00:07:28,560
use these as examples i think it's a

243
00:07:27,280 --> 00:07:31,599
phenomenal framework

244
00:07:28,560 --> 00:07:34,400
it facilitates hunting in a major way

245
00:07:31,599 --> 00:07:35,280
because it helps people share searches

246
00:07:34,400 --> 00:07:36,560
and queries

247
00:07:35,280 --> 00:07:38,239
and that's what i want to cover right

248
00:07:36,560 --> 00:07:39,520
now what type of searches and queries

249
00:07:38,240 --> 00:07:40,639
that you should be running you should be

250
00:07:39,520 --> 00:07:42,639
making

251
00:07:40,639 --> 00:07:44,720
for initial access for these large

252
00:07:42,639 --> 00:07:46,560
ransomware campaigns and they don't just

253
00:07:44,720 --> 00:07:49,360
hit large companies by the way

254
00:07:46,560 --> 00:07:50,800
like at all we often see the following

255
00:07:49,360 --> 00:07:53,440
for initial access

256
00:07:50,800 --> 00:07:53,919
banking trojans emitteth and trickbot

257
00:07:53,440 --> 00:07:57,599
they are

258
00:07:53,919 --> 00:07:59,680
so freaking common it's not even funny

259
00:07:57,599 --> 00:08:01,440
so when i got into my position matt

260
00:07:59,680 --> 00:08:03,280
actually had left some previous work

261
00:08:01,440 --> 00:08:04,960
behind i found your stuff buddy

262
00:08:03,280 --> 00:08:06,400
and i was looking at it and he was

263
00:08:04,960 --> 00:08:08,000
actually already searching and hunting

264
00:08:06,400 --> 00:08:10,719
this stuff from years back

265
00:08:08,000 --> 00:08:12,240
imitate and trickbot are so common and

266
00:08:10,720 --> 00:08:12,960
they are so commonly used in these

267
00:08:12,240 --> 00:08:14,800
attacks

268
00:08:12,960 --> 00:08:16,318
it's not even funny so i'm going to

269
00:08:14,800 --> 00:08:18,960
focus on finding those

270
00:08:16,319 --> 00:08:20,160
and it can really help you out and then

271
00:08:18,960 --> 00:08:21,280
also rdp

272
00:08:20,160 --> 00:08:23,280
and you might be thinking to yourself

273
00:08:21,280 --> 00:08:25,198
right now you're like nah no don't worry

274
00:08:23,280 --> 00:08:26,239
about it ryan i don't have rdp exposed

275
00:08:25,199 --> 00:08:28,400
to the internet

276
00:08:26,240 --> 00:08:29,520
are you sure are you like a hundred

277
00:08:28,400 --> 00:08:32,559
percent sure

278
00:08:29,520 --> 00:08:34,880
monitor monitor for it anyway and then

279
00:08:32,559 --> 00:08:35,598
i'm not trying to throw shade at any of

280
00:08:34,880 --> 00:08:37,360
the companies

281
00:08:35,599 --> 00:08:38,800
listed in this bullet point because i am

282
00:08:37,360 --> 00:08:40,159
in love with every single one of these

283
00:08:38,799 --> 00:08:41,679
to be honest

284
00:08:40,159 --> 00:08:43,279
they run a lot of our critical

285
00:08:41,679 --> 00:08:45,120
infrastructure but we do have to

286
00:08:43,279 --> 00:08:46,720
acknowledge that over the past year

287
00:08:45,120 --> 00:08:48,160
there have been many vulnerabilities

288
00:08:46,720 --> 00:08:50,080
that have been posted

289
00:08:48,160 --> 00:08:52,480
and many times these ransomware

290
00:08:50,080 --> 00:08:54,800
attackers are taking advantage of those

291
00:08:52,480 --> 00:08:56,480
so you can do your best darn job but if

292
00:08:54,800 --> 00:08:58,959
you happen to have a

293
00:08:56,480 --> 00:09:00,320
very commonplace expensive network of

294
00:08:58,959 --> 00:09:03,359
plants on the outside

295
00:09:00,320 --> 00:09:04,560
if it has a recent early cve or zero day

296
00:09:03,360 --> 00:09:06,480
or what have you like

297
00:09:04,560 --> 00:09:08,000
they're going to get in right let's

298
00:09:06,480 --> 00:09:10,800
focus on some of the ways that they can

299
00:09:08,000 --> 00:09:11,120
get in one of them rdp and i'm telling

300
00:09:10,800 --> 00:09:12,880
you

301
00:09:11,120 --> 00:09:14,720
i'm telling you if you're like no no no

302
00:09:12,880 --> 00:09:17,760
i have that taken care of

303
00:09:14,720 --> 00:09:21,839
just monitor it anyway okay many people

304
00:09:17,760 --> 00:09:24,160
focus on event id 4624 logon type 10

305
00:09:21,839 --> 00:09:25,120
which is rdp it's an rdp log on in

306
00:09:24,160 --> 00:09:26,959
windows

307
00:09:25,120 --> 00:09:29,040
don't forget these other event ids i

308
00:09:26,959 --> 00:09:30,079
have up here at the top especially 21

309
00:09:29,040 --> 00:09:32,399
through 25

310
00:09:30,080 --> 00:09:34,880
and 11 49 you can find some phenomenal

311
00:09:32,399 --> 00:09:35,920
rdp based information in there

312
00:09:34,880 --> 00:09:38,160
what type of things should you be

313
00:09:35,920 --> 00:09:40,079
looking for well in general if you have

314
00:09:38,160 --> 00:09:42,880
for example just in your firewalls

315
00:09:40,080 --> 00:09:43,440
you can look for and by the way i'm

316
00:09:42,880 --> 00:09:46,160
calling

317
00:09:43,440 --> 00:09:46,480
these example searches here pseudo code

318
00:09:46,160 --> 00:09:48,640
but

319
00:09:46,480 --> 00:09:50,720
if any of you are familiar with splunk

320
00:09:48,640 --> 00:09:53,680
you're like isn't that just uh spl

321
00:09:50,720 --> 00:09:54,800
well i know i just i have a heavy splunk

322
00:09:53,680 --> 00:09:56,719
background and so

323
00:09:54,800 --> 00:09:58,000
it's pseudo code right you convert it

324
00:09:56,720 --> 00:10:01,200
into whatever you need to for

325
00:09:58,000 --> 00:10:01,839
your environment looking at port 3389

326
00:10:01,200 --> 00:10:03,920
hits

327
00:10:01,839 --> 00:10:05,040
and doing a distinct count which is what

328
00:10:03,920 --> 00:10:08,079
dc is

329
00:10:05,040 --> 00:10:10,560
for destination ip and doing that by

330
00:10:08,079 --> 00:10:12,399
source ip what you're looking for is to

331
00:10:10,560 --> 00:10:13,599
set a threshold within your environment

332
00:10:12,399 --> 00:10:15,680
right you have to do it within your

333
00:10:13,600 --> 00:10:17,680
environment maybe it's five maybe

334
00:10:15,680 --> 00:10:19,599
ten maybe it's 100 whatever you have

335
00:10:17,680 --> 00:10:21,279
going on about 100.

336
00:10:19,600 --> 00:10:22,640
you're looking to see if any individual

337
00:10:21,279 --> 00:10:25,120
ip is trying to hit

338
00:10:22,640 --> 00:10:25,920
multiple of your servers on that port

339
00:10:25,120 --> 00:10:28,240
and if it is

340
00:10:25,920 --> 00:10:30,240
is that supposed to be happening is that

341
00:10:28,240 --> 00:10:31,200
it admin working from home or is that

342
00:10:30,240 --> 00:10:33,440
something silly

343
00:10:31,200 --> 00:10:34,959
have there been successes like no that's

344
00:10:33,440 --> 00:10:36,399
ignorant right like find out what's

345
00:10:34,959 --> 00:10:38,959
going on there

346
00:10:36,399 --> 00:10:39,920
looking at 4624 events you get target

347
00:10:38,959 --> 00:10:41,920
username

348
00:10:39,920 --> 00:10:44,959
if you do a distinct count of target

349
00:10:41,920 --> 00:10:47,439
usernames also by the ip address field

350
00:10:44,959 --> 00:10:49,518
within those logs it's the same concept

351
00:10:47,440 --> 00:10:52,000
you're looking for when a single ip is

352
00:10:49,519 --> 00:10:54,480
trying to authenticate to multiple users

353
00:10:52,000 --> 00:10:56,320
via rdp if especially if you have

354
00:10:54,480 --> 00:10:57,680
successes with a big list of failures

355
00:10:56,320 --> 00:11:00,640
right like whoopsie

356
00:10:57,680 --> 00:11:01,199
go find out what that is and then always

357
00:11:00,640 --> 00:11:03,519
look for

358
00:11:01,200 --> 00:11:04,880
i love geoip based queries they are like

359
00:11:03,519 --> 00:11:07,279
low hanging fruit

360
00:11:04,880 --> 00:11:09,040
really freaking easy your points of

361
00:11:07,279 --> 00:11:10,000
presence whatever countries out of which

362
00:11:09,040 --> 00:11:11,519
you operate

363
00:11:10,000 --> 00:11:14,399
you look for other countries hitting

364
00:11:11,519 --> 00:11:15,920
your stuff on port 3389 especially if

365
00:11:14,399 --> 00:11:17,200
there are successes that you wouldn't

366
00:11:15,920 --> 00:11:18,560
normally expect

367
00:11:17,200 --> 00:11:20,160
you may have to hunt down some people

368
00:11:18,560 --> 00:11:21,518
who are officially traveling and what

369
00:11:20,160 --> 00:11:22,480
have you but that can be a great

370
00:11:21,519 --> 00:11:24,320
indicator

371
00:11:22,480 --> 00:11:25,680
and then finally i've given a sigma rule

372
00:11:24,320 --> 00:11:27,360
here just because i love the sigma

373
00:11:25,680 --> 00:11:29,839
project and that's a fun rule to kind of

374
00:11:27,360 --> 00:11:29,839
kick things off

375
00:11:30,320 --> 00:11:34,480
now the banking trojans ah imitating

376
00:11:32,720 --> 00:11:36,320
trick bot you little devils

377
00:11:34,480 --> 00:11:38,000
they often come down via malicious

378
00:11:36,320 --> 00:11:39,600
documents right let's just talk

379
00:11:38,000 --> 00:11:43,040
downloader if you will

380
00:11:39,600 --> 00:11:44,079
and a lot of times we see a three digit

381
00:11:43,040 --> 00:11:45,760
file name

382
00:11:44,079 --> 00:11:46,959
for the downloader the down excuse me

383
00:11:45,760 --> 00:11:48,480
that the downloader downloads the

384
00:11:46,959 --> 00:11:48,880
malware too right into stage two if you

385
00:11:48,480 --> 00:11:50,959
want to

386
00:11:48,880 --> 00:11:52,000
call it that previously we saw two to

387
00:11:50,959 --> 00:11:53,680
three characters so

388
00:11:52,000 --> 00:11:56,000
here is a regular expression right

389
00:11:53,680 --> 00:11:58,319
matching anything up to whatever slash

390
00:11:56,000 --> 00:11:59,839
your system wants to use and then two or

391
00:11:58,320 --> 00:12:01,760
three digits.exe

392
00:11:59,839 --> 00:12:04,160
boom if you find hits to that it's a

393
00:12:01,760 --> 00:12:06,639
fairly decent fidelity query

394
00:12:04,160 --> 00:12:08,319
also looking in the windows directory

395
00:12:06,639 --> 00:12:11,040
for file names that are

396
00:12:08,320 --> 00:12:12,320
just numbers just digits especially

397
00:12:11,040 --> 00:12:14,959
eight to ten digits

398
00:12:12,320 --> 00:12:15,360
super common with emitted now keep in

399
00:12:14,959 --> 00:12:17,119
mind

400
00:12:15,360 --> 00:12:19,040
that when you're looking for this stuff

401
00:12:17,120 --> 00:12:20,959
you're looking at probably file right

402
00:12:19,040 --> 00:12:23,920
and then most likely process execution

403
00:12:20,959 --> 00:12:26,079
right sysmon has file rights it also has

404
00:12:23,920 --> 00:12:26,880
process execution which is event id

405
00:12:26,079 --> 00:12:30,160
number one

406
00:12:26,880 --> 00:12:32,240
in sysmon windows by default does not

407
00:12:30,160 --> 00:12:34,160
log process auditing so you have to

408
00:12:32,240 --> 00:12:35,360
enable that along with the command line

409
00:12:34,160 --> 00:12:38,480
to grab that

410
00:12:35,360 --> 00:12:40,320
those would be 4688 events

411
00:12:38,480 --> 00:12:42,399
refer back to the previous slide when

412
00:12:40,320 --> 00:12:44,000
you get your pdf at those logging cheat

413
00:12:42,399 --> 00:12:47,200
sheets if you're not logging this stuff

414
00:12:44,000 --> 00:12:49,360
now you want to start logging it if

415
00:12:47,200 --> 00:12:50,320
you are logging mutexes take a look for

416
00:12:49,360 --> 00:12:53,120
any that begin

417
00:12:50,320 --> 00:12:54,639
with the letters p e m and then you'll

418
00:12:53,120 --> 00:12:55,519
often see a couple of hexadecimal

419
00:12:54,639 --> 00:12:58,560
characters which

420
00:12:55,519 --> 00:13:01,600
actually translate to a process id

421
00:12:58,560 --> 00:13:03,119
but that is often used by invented so if

422
00:13:01,600 --> 00:13:06,320
you're getting mutexes you might as well

423
00:13:03,120 --> 00:13:08,079
use them to hunt

424
00:13:06,320 --> 00:13:09,920
another thing that i i just have to

425
00:13:08,079 --> 00:13:12,000
mention is and i may be butchering their

426
00:13:09,920 --> 00:13:14,079
name but the crypto lamest group

427
00:13:12,000 --> 00:13:16,639
is a group of quite honestly just

428
00:13:14,079 --> 00:13:18,000
phenomenal freaking human beings

429
00:13:16,639 --> 00:13:20,560
and i know some of these folks

430
00:13:18,000 --> 00:13:22,079
professionally uh matt is a fantastic

431
00:13:20,560 --> 00:13:23,920
dude i love this guy

432
00:13:22,079 --> 00:13:25,279
all these people put a lot of time and

433
00:13:23,920 --> 00:13:27,519
energy into

434
00:13:25,279 --> 00:13:28,880
trying to shut down trying to thwart and

435
00:13:27,519 --> 00:13:30,480
trying to expose

436
00:13:28,880 --> 00:13:32,560
imitating they're trying to do their

437
00:13:30,480 --> 00:13:35,200
best job to protect

438
00:13:32,560 --> 00:13:36,719
the rest of us basically right so check

439
00:13:35,200 --> 00:13:39,199
out their website they

440
00:13:36,720 --> 00:13:41,199
provide and produce a bunch of

441
00:13:39,199 --> 00:13:43,120
indicators including actual computed

442
00:13:41,199 --> 00:13:44,319
iocs so if you're interested in hashes

443
00:13:43,120 --> 00:13:47,440
and things of that nature

444
00:13:44,320 --> 00:13:49,680
they're very very helpful

445
00:13:47,440 --> 00:13:51,839
now we move to trickbot right for anyone

446
00:13:49,680 --> 00:13:53,760
any uh always sunny fans here's charlie

447
00:13:51,839 --> 00:13:55,680
freaking out about all the trickbot dlls

448
00:13:53,760 --> 00:13:57,279
in his environment and i stole this from

449
00:13:55,680 --> 00:14:00,560
sneakymonkey on twitter

450
00:13:57,279 --> 00:14:02,480
because it's just phenomenal trickbot is

451
00:14:00,560 --> 00:14:06,399
a modular-based framework

452
00:14:02,480 --> 00:14:09,440
and the modules often end in either 32

453
00:14:06,399 --> 00:14:12,959
or dll32 in a 32-bit environment

454
00:14:09,440 --> 00:14:15,600
or 64 or dll-64

455
00:14:12,959 --> 00:14:16,079
in a 64-bit environment and here's an

456
00:14:15,600 --> 00:14:17,600
example

457
00:14:16,079 --> 00:14:19,760
i know it's not very large on the screen

458
00:14:17,600 --> 00:14:22,160
but import dll64

459
00:14:19,760 --> 00:14:23,600
that's one example right there right so

460
00:14:22,160 --> 00:14:26,000
we have a regular expression

461
00:14:23,600 --> 00:14:27,360
to hunt for a common location for where

462
00:14:26,000 --> 00:14:30,000
these are found

463
00:14:27,360 --> 00:14:30,880
users a user directory right such as dot

464
00:14:30,000 --> 00:14:32,880
plus

465
00:14:30,880 --> 00:14:34,000
app data typically roaming but also

466
00:14:32,880 --> 00:14:35,760
local

467
00:14:34,000 --> 00:14:37,680
and then usually it's two directories

468
00:14:35,760 --> 00:14:39,600
deep is what you'll find out and those

469
00:14:37,680 --> 00:14:42,319
change based on the campaign hence the

470
00:14:39,600 --> 00:14:44,160
not a specific attributable name here

471
00:14:42,320 --> 00:14:46,880
any name for a file ending in

472
00:14:44,160 --> 00:14:48,000
either 32 or 64 and then potentially

473
00:14:46,880 --> 00:14:48,959
right the question mark there

474
00:14:48,000 --> 00:14:52,160
potentially in

475
00:14:48,959 --> 00:14:54,560
also ending in dll dot dll

476
00:14:52,160 --> 00:14:56,480
this is a very very very high fidelity

477
00:14:54,560 --> 00:14:58,000
query in fact you can take out the

478
00:14:56,480 --> 00:14:59,920
directory part completely

479
00:14:58,000 --> 00:15:01,360
and still use that to find some stuff

480
00:14:59,920 --> 00:15:03,360
there you'll find some

481
00:15:01,360 --> 00:15:05,120
false positives here and there but it's

482
00:15:03,360 --> 00:15:07,199
a great query to run

483
00:15:05,120 --> 00:15:09,360
and in that same location if you find a

484
00:15:07,199 --> 00:15:11,279
settings.ini file that is typically the

485
00:15:09,360 --> 00:15:13,839
encrypted settings file for trickbot

486
00:15:11,279 --> 00:15:13,839
itself

487
00:15:14,880 --> 00:15:18,079
these locations are used by both

488
00:15:17,360 --> 00:15:20,160
ambitete

489
00:15:18,079 --> 00:15:22,000
and trickbot and if you go to virustotal

490
00:15:20,160 --> 00:15:24,319
and you look up a sample and it says

491
00:15:22,000 --> 00:15:26,480
hey this is imitech oftentimes it's

492
00:15:24,320 --> 00:15:28,320
trickbot and vice versa they become so

493
00:15:26,480 --> 00:15:29,680
ingrained and wrapped into one another's

494
00:15:28,320 --> 00:15:32,639
little worlds

495
00:15:29,680 --> 00:15:34,479
so looking for example in app data for

496
00:15:32,639 --> 00:15:36,639
executables that are being dropped

497
00:15:34,480 --> 00:15:39,120
let alone that are being executed let

498
00:15:36,639 --> 00:15:41,600
alone that are associated with services

499
00:15:39,120 --> 00:15:42,880
and then monitoring these three folders

500
00:15:41,600 --> 00:15:45,199
here program data

501
00:15:42,880 --> 00:15:46,800
and users public just having exes

502
00:15:45,199 --> 00:15:49,040
dropped inside those

503
00:15:46,800 --> 00:15:50,319
super super common with both of these

504
00:15:49,040 --> 00:15:53,599
pieces of malware

505
00:15:50,320 --> 00:15:55,440
and monitoring of file rights to the

506
00:15:53,600 --> 00:15:57,440
syswow 64 directory

507
00:15:55,440 --> 00:15:59,040
now obviously that's where your 32-bit

508
00:15:57,440 --> 00:16:01,519
dlls dynamic

509
00:15:59,040 --> 00:16:02,160
libraries and exes in a 64-bit

510
00:16:01,519 --> 00:16:04,480
environment

511
00:16:02,160 --> 00:16:05,680
live so you can't just alert on anything

512
00:16:04,480 --> 00:16:07,600
there like duh

513
00:16:05,680 --> 00:16:09,040
but look for files being written there

514
00:16:07,600 --> 00:16:11,040
and then look to see what's writing it

515
00:16:09,040 --> 00:16:11,839
is that a microsoft update process or is

516
00:16:11,040 --> 00:16:13,839
that like you know

517
00:16:11,839 --> 00:16:15,759
chrome like like what our word or like

518
00:16:13,839 --> 00:16:18,560
what's writing that

519
00:16:15,759 --> 00:16:19,600
look for exes and users public first off

520
00:16:18,560 --> 00:16:21,680
just in general

521
00:16:19,600 --> 00:16:23,279
look in users public that's one right

522
00:16:21,680 --> 00:16:25,920
there i could put a little i just

523
00:16:23,279 --> 00:16:27,759
erase that and like look there but also

524
00:16:25,920 --> 00:16:28,399
specifically when they just have alpha

525
00:16:27,759 --> 00:16:30,160
characters

526
00:16:28,399 --> 00:16:33,040
and there are five to ten of them dot

527
00:16:30,160 --> 00:16:34,160
exe really good indicator of both these

528
00:16:33,040 --> 00:16:36,079
pieces of malware

529
00:16:34,160 --> 00:16:38,079
and then the user profile directors and

530
00:16:36,079 --> 00:16:40,638
this one i find it so weird

531
00:16:38,079 --> 00:16:42,399
videos music or pictures and then

532
00:16:40,639 --> 00:16:44,160
eventually having a dot exe in there you

533
00:16:42,399 --> 00:16:46,480
can actually do a dot star

534
00:16:44,160 --> 00:16:47,439
and then a dot exe to identify any level

535
00:16:46,480 --> 00:16:49,120
of you know

536
00:16:47,440 --> 00:16:50,959
subdirectories in there like who's

537
00:16:49,120 --> 00:16:51,920
dropping exe files in their music

538
00:16:50,959 --> 00:16:53,279
directories

539
00:16:51,920 --> 00:16:55,199
except for when you you know used to

540
00:16:53,279 --> 00:16:56,800
download or rip off music on kazaa and

541
00:16:55,199 --> 00:16:59,839
it would be like malware

542
00:16:56,800 --> 00:17:02,719
right same same concept

543
00:16:59,839 --> 00:17:03,680
not that you all did that services and

544
00:17:02,720 --> 00:17:05,919
tasks

545
00:17:03,680 --> 00:17:06,799
taken into account if you're not already

546
00:17:05,919 --> 00:17:09,039
logging

547
00:17:06,799 --> 00:17:10,160
service installations for example or

548
00:17:09,039 --> 00:17:12,160
task creations

549
00:17:10,160 --> 00:17:14,319
like go back to those pdfs check out

550
00:17:12,160 --> 00:17:17,199
those logging cheat sheets

551
00:17:14,319 --> 00:17:19,119
look for any of them that refer to any

552
00:17:17,199 --> 00:17:20,720
of the previous directories for example

553
00:17:19,119 --> 00:17:22,319
that we just talked about right in the

554
00:17:20,720 --> 00:17:24,559
past couple slides

555
00:17:22,319 --> 00:17:25,520
additionally look for any especially

556
00:17:24,559 --> 00:17:28,399
services

557
00:17:25,520 --> 00:17:29,679
whose name is just digits just multiple

558
00:17:28,400 --> 00:17:32,320
digits and that's it

559
00:17:29,679 --> 00:17:35,039
especially if they happen to be eight to

560
00:17:32,320 --> 00:17:39,120
ten digits that is a great identifier

561
00:17:35,039 --> 00:17:39,120
for imitech so check those out too

562
00:17:39,760 --> 00:17:43,600
and that takes us to the next stage of

563
00:17:41,840 --> 00:17:45,199
the attacker's toolbox this is probably

564
00:17:43,600 --> 00:17:48,639
one of my favorite parts here

565
00:17:45,200 --> 00:17:50,880
because it is ridiculous ridiculous

566
00:17:48,640 --> 00:17:52,640
how many times just the regular old

567
00:17:50,880 --> 00:17:55,919
string just the name

568
00:17:52,640 --> 00:17:58,160
mini cats returns a ton of results

569
00:17:55,919 --> 00:17:59,600
and an even like slightly moderately

570
00:17:58,160 --> 00:18:02,080
sized environment

571
00:17:59,600 --> 00:18:03,280
many times these threat actors drop the

572
00:18:02,080 --> 00:18:05,600
files on the system

573
00:18:03,280 --> 00:18:06,879
and don't rename them at all not at all

574
00:18:05,600 --> 00:18:09,760
you see metasploit

575
00:18:06,880 --> 00:18:10,160
meme cats process hacker we see them

576
00:18:09,760 --> 00:18:12,559
using

577
00:18:10,160 --> 00:18:13,600
angry ip scanner a lot maze and ryuk

578
00:18:12,559 --> 00:18:16,480
teams love

579
00:18:13,600 --> 00:18:17,918
to use that tool so just look for ipscan

580
00:18:16,480 --> 00:18:18,640
and you're like that seems too simple

581
00:18:17,919 --> 00:18:20,960
that's stupid

582
00:18:18,640 --> 00:18:22,799
i'm like i know i don't know but it

583
00:18:20,960 --> 00:18:24,320
works i'm telling you it works

584
00:18:22,799 --> 00:18:26,400
and then over on the right hand side i

585
00:18:24,320 --> 00:18:29,600
have an example that i've sanitized

586
00:18:26,400 --> 00:18:32,640
from a recent case here in c users

587
00:18:29,600 --> 00:18:33,678
i change the name to legit user but we

588
00:18:32,640 --> 00:18:36,160
see in music

589
00:18:33,679 --> 00:18:38,400
a directory called windows and then mimi

590
00:18:36,160 --> 00:18:40,000
cats underscore trunk.zip

591
00:18:38,400 --> 00:18:42,400
that tells me that sucker probably came

592
00:18:40,000 --> 00:18:45,360
right from github and we see it all

593
00:18:42,400 --> 00:18:46,559
the time so string based searches for

594
00:18:45,360 --> 00:18:49,439
these kinds of tools

595
00:18:46,559 --> 00:18:50,960
you'd be amazed at what you'll find

596
00:18:49,440 --> 00:18:53,919
additionally did you know

597
00:18:50,960 --> 00:18:54,880
that if a threat actor or you changes

598
00:18:53,919 --> 00:18:57,679
the name of an

599
00:18:54,880 --> 00:18:59,520
executable but launches it that for

600
00:18:57,679 --> 00:19:02,960
example sysmon event 1

601
00:18:59,520 --> 00:19:04,879
or even 4688 events will record what's

602
00:19:02,960 --> 00:19:06,480
known as the original file name which is

603
00:19:04,880 --> 00:19:08,480
part of the pe header we covered this

604
00:19:06,480 --> 00:19:12,400
kind of stuff in 610 right

605
00:19:08,480 --> 00:19:13,440
i renamed g flags.es exe which is used

606
00:19:12,400 --> 00:19:16,000
in some

607
00:19:13,440 --> 00:19:17,679
apt attacks for persistence and we use

608
00:19:16,000 --> 00:19:20,880
it for debugging malware

609
00:19:17,679 --> 00:19:22,480
and i named it farts.exe because i'm a

610
00:19:20,880 --> 00:19:24,880
very mature adult

611
00:19:22,480 --> 00:19:25,960
and it's a very important testing to do

612
00:19:24,880 --> 00:19:29,440
so i labeled it

613
00:19:25,960 --> 00:19:32,000
parts.exe i executed and you'll notice i

614
00:19:29,440 --> 00:19:33,440
still get the original name the original

615
00:19:32,000 --> 00:19:36,559
file name field

616
00:19:33,440 --> 00:19:38,400
you can hunt for things like ps exact or

617
00:19:36,559 --> 00:19:39,678
other ps tools or what have you within

618
00:19:38,400 --> 00:19:42,320
your environment

619
00:19:39,679 --> 00:19:43,200
not just by name of execution right the

620
00:19:42,320 --> 00:19:45,120
command line

621
00:19:43,200 --> 00:19:47,360
but looking to see when the command line

622
00:19:45,120 --> 00:19:49,120
does not match the original file name

623
00:19:47,360 --> 00:19:52,000
that indicates it has been

624
00:19:49,120 --> 00:19:54,000
renamed now in the previous slide i said

625
00:19:52,000 --> 00:19:56,320
often they don't even rename stuff

626
00:19:54,000 --> 00:19:58,160
when they do rename it oftentimes they

627
00:19:56,320 --> 00:19:58,960
literally just do a quick rename and

628
00:19:58,160 --> 00:20:00,799
then

629
00:19:58,960 --> 00:20:01,760
you know double click it via rdp or

630
00:20:00,799 --> 00:20:03,360
whatever you know however they're

631
00:20:01,760 --> 00:20:05,280
executing it in your environment

632
00:20:03,360 --> 00:20:06,639
so that's like your number one probably

633
00:20:05,280 --> 00:20:07,840
take away right there if you're logging

634
00:20:06,640 --> 00:20:11,360
process execution

635
00:20:07,840 --> 00:20:12,240
it's a great tip i love it when we do

636
00:20:11,360 --> 00:20:14,399
see renaming

637
00:20:12,240 --> 00:20:15,600
of certain tools like nemy cats we see

638
00:20:14,400 --> 00:20:17,520
certain patterns

639
00:20:15,600 --> 00:20:21,520
we often will see a single character and

640
00:20:17,520 --> 00:20:23,679
then either 32 or 64 dot exe so look for

641
00:20:21,520 --> 00:20:25,280
any file that is a single character and

642
00:20:23,679 --> 00:20:28,000
then ends in 32 or 64.

643
00:20:25,280 --> 00:20:30,000
that's an executable we also see many

644
00:20:28,000 --> 00:20:32,840
times malware dropped by these

645
00:20:30,000 --> 00:20:34,880
actors will be renamed to a single

646
00:20:32,840 --> 00:20:38,000
character.exe we also see that

647
00:20:34,880 --> 00:20:39,679
a lot just generally in actual exploits

648
00:20:38,000 --> 00:20:41,360
that involve shell code because you know

649
00:20:39,679 --> 00:20:42,720
shellcode the whole idea is to compress

650
00:20:41,360 --> 00:20:44,959
the code as much as possible

651
00:20:42,720 --> 00:20:46,880
a single character for the path to save

652
00:20:44,960 --> 00:20:49,120
it to facilitates that

653
00:20:46,880 --> 00:20:50,559
especially like tilde.exe we see that

654
00:20:49,120 --> 00:20:52,399
one a lot

655
00:20:50,559 --> 00:20:54,960
and then we have sometimes you'll see

656
00:20:52,400 --> 00:20:57,120
pipes involved sysmon captures pipes

657
00:20:54,960 --> 00:20:59,280
maybe your edr does hopefully you have

658
00:20:57,120 --> 00:21:00,479
pipes and mutexes by the way within your

659
00:20:59,280 --> 00:21:02,879
environment

660
00:21:00,480 --> 00:21:04,400
if you see comspec that is simply the

661
00:21:02,880 --> 00:21:06,400
environment variable

662
00:21:04,400 --> 00:21:08,159
for the command prompt basically when

663
00:21:06,400 --> 00:21:10,159
you see c it means command

664
00:21:08,159 --> 00:21:12,080
and then if you happen to see echo after

665
00:21:10,159 --> 00:21:14,720
that followed by for example

666
00:21:12,080 --> 00:21:16,000
hexadecimal characters redirecting to a

667
00:21:14,720 --> 00:21:18,080
named pipe

668
00:21:16,000 --> 00:21:20,000
that is often part of inter-process

669
00:21:18,080 --> 00:21:22,559
communication used by

670
00:21:20,000 --> 00:21:24,240
well for one example is cobalt strike

671
00:21:22,559 --> 00:21:24,720
but what we can do for this is just look

672
00:21:24,240 --> 00:21:27,520
for like

673
00:21:24,720 --> 00:21:28,400
comspec echo and pipe that's it just

674
00:21:27,520 --> 00:21:30,000
those three words

675
00:21:28,400 --> 00:21:32,320
you know if you have an implicit and

676
00:21:30,000 --> 00:21:34,400
it's just comp spec echo pipe

677
00:21:32,320 --> 00:21:36,320
hit enter see what you get in your logs

678
00:21:34,400 --> 00:21:38,080
you may have some fun information

679
00:21:36,320 --> 00:21:40,559
you may even find something like our

680
00:21:38,080 --> 00:21:42,639
next fella cobalt strike

681
00:21:40,559 --> 00:21:44,799
everyone here has heard of cs everyone

682
00:21:42,640 --> 00:21:46,159
knows that it's a commercial

683
00:21:44,799 --> 00:21:47,840
framework that's used often for

684
00:21:46,159 --> 00:21:50,080
penetration testing

685
00:21:47,840 --> 00:21:51,760
we see it all the time all this time in

686
00:21:50,080 --> 00:21:54,000
these ransomware attacks and we see it

687
00:21:51,760 --> 00:21:57,360
all the time in red teaming you know too

688
00:21:54,000 --> 00:21:59,120
the default name for named pipes

689
00:21:57,360 --> 00:22:00,719
in this system i pulled three of them

690
00:21:59,120 --> 00:22:04,959
directly from the documentation

691
00:22:00,720 --> 00:22:07,120
for this talk status underscore 98.65

692
00:22:04,960 --> 00:22:08,320
ms agent underscore and then four

693
00:22:07,120 --> 00:22:10,719
characters

694
00:22:08,320 --> 00:22:12,480
that derive we can derive a pattern from

695
00:22:10,720 --> 00:22:13,120
that and so here is our regular

696
00:22:12,480 --> 00:22:16,480
expression

697
00:22:13,120 --> 00:22:19,120
to look for named pipes that maybe match

698
00:22:16,480 --> 00:22:20,480
the default names for cobalt strike and

699
00:22:19,120 --> 00:22:26,080
i'm telling you right now

700
00:22:20,480 --> 00:22:29,039
many times the default name is used

701
00:22:26,080 --> 00:22:30,559
cobalt strike also uses a bunch of

702
00:22:29,039 --> 00:22:32,400
powershell as does

703
00:22:30,559 --> 00:22:33,678
all kinds of the other tools that we

704
00:22:32,400 --> 00:22:36,320
just don't have time to cover

705
00:22:33,679 --> 00:22:37,120
today in this short 20 plus minute talk

706
00:22:36,320 --> 00:22:39,678
right

707
00:22:37,120 --> 00:22:41,918
so powershell events that are decoded

708
00:22:39,679 --> 00:22:43,840
you can search through them by enabling

709
00:22:41,919 --> 00:22:45,520
powershell logging there are multiple

710
00:22:43,840 --> 00:22:48,320
event ids involved

711
00:22:45,520 --> 00:22:49,520
right now we're looking at 4104 which

712
00:22:48,320 --> 00:22:52,080
happens to be script

713
00:22:49,520 --> 00:22:53,600
block logging before i mention this you

714
00:22:52,080 --> 00:22:54,000
can take all the things we've talked

715
00:22:53,600 --> 00:22:56,799
about

716
00:22:54,000 --> 00:22:57,760
thus far and combine them with this

717
00:22:56,799 --> 00:23:00,559
mentality

718
00:22:57,760 --> 00:23:02,720
of looking for default names so let's

719
00:23:00,559 --> 00:23:04,480
say you're looking at 4103

720
00:23:02,720 --> 00:23:06,080
events which hopefully you're logging

721
00:23:04,480 --> 00:23:06,960
and again refer to the cheat sheets

722
00:23:06,080 --> 00:23:09,360
right

723
00:23:06,960 --> 00:23:11,120
and you notice that like oh this power

724
00:23:09,360 --> 00:23:13,039
split and powershell empire

725
00:23:11,120 --> 00:23:15,039
they have these modules and their names

726
00:23:13,039 --> 00:23:15,840
are you know so and so just do string

727
00:23:15,039 --> 00:23:17,679
based searches

728
00:23:15,840 --> 00:23:20,000
through your powershell logs for those

729
00:23:17,679 --> 00:23:21,679
and you'd be amazed at what you'll find

730
00:23:20,000 --> 00:23:23,200
i mean hopefully not you don't find some

731
00:23:21,679 --> 00:23:26,799
really bad stuff but

732
00:23:23,200 --> 00:23:27,520
you might powershell used in cobalt

733
00:23:26,799 --> 00:23:30,480
strike

734
00:23:27,520 --> 00:23:32,240
often uses the following strings do it

735
00:23:30,480 --> 00:23:34,240
is a super common string

736
00:23:32,240 --> 00:23:36,080
sometimes it will be obfuscated with

737
00:23:34,240 --> 00:23:38,240
certain escape characters what have you

738
00:23:36,080 --> 00:23:39,360
but not all the time so look for it look

739
00:23:38,240 --> 00:23:41,760
for do it just do it

740
00:23:39,360 --> 00:23:42,639
look for it and then we have function

741
00:23:41,760 --> 00:23:46,320
names funk

742
00:23:42,640 --> 00:23:48,000
get proc address funk get delegate type

743
00:23:46,320 --> 00:23:49,520
and this little fellow down here i put

744
00:23:48,000 --> 00:23:50,720
it in bold because it's a good one to

745
00:23:49,520 --> 00:23:52,879
look at

746
00:23:50,720 --> 00:23:55,120
var code especially when you see it as

747
00:23:52,880 --> 00:23:56,640
being instantiated as a byte array

748
00:23:55,120 --> 00:23:58,959
being casted just like this in

749
00:23:56,640 --> 00:24:02,480
powershell and especially

750
00:23:58,960 --> 00:24:03,360
if you see from base64 from basics for

751
00:24:02,480 --> 00:24:06,640
string

752
00:24:03,360 --> 00:24:07,840
within it very often it points to cobalt

753
00:24:06,640 --> 00:24:09,919
strike

754
00:24:07,840 --> 00:24:12,080
here's an example of a decoded cobalt

755
00:24:09,919 --> 00:24:14,400
strike powershell stage this is used for

756
00:24:12,080 --> 00:24:15,918
one of their beacons it's used for

757
00:24:14,400 --> 00:24:17,679
a lot of other malware now that's

758
00:24:15,919 --> 00:24:18,000
ripping off the functionality and even

759
00:24:17,679 --> 00:24:21,120
using

760
00:24:18,000 --> 00:24:21,679
some of the same names you see the

761
00:24:21,120 --> 00:24:23,918
string

762
00:24:21,679 --> 00:24:24,720
do it you see one of the function names

763
00:24:23,919 --> 00:24:26,880
right here

764
00:24:24,720 --> 00:24:27,840
you see one of the other function names

765
00:24:26,880 --> 00:24:31,039
right there

766
00:24:27,840 --> 00:24:34,639
right and

767
00:24:31,039 --> 00:24:37,520
finally we have ftp data exfiltration

768
00:24:34,640 --> 00:24:38,240
we see ftp and cloud sites being used

769
00:24:37,520 --> 00:24:40,559
the most

770
00:24:38,240 --> 00:24:42,080
for data expo it's crazy it's like what

771
00:24:40,559 --> 00:24:44,799
year is this right it's 20 20.

772
00:24:42,080 --> 00:24:45,520
they're using ftp often straight windows

773
00:24:44,799 --> 00:24:48,879
api

774
00:24:45,520 --> 00:24:49,760
what have you monitor outbound port 20

775
00:24:48,880 --> 00:24:52,080
and 21.

776
00:24:49,760 --> 00:24:53,679
if you're not designing a baseline now

777
00:24:52,080 --> 00:24:54,480
for what should be allowed out through

778
00:24:53,679 --> 00:24:56,480
ftp like

779
00:24:54,480 --> 00:24:58,159
please do that please do it as soon as

780
00:24:56,480 --> 00:24:59,840
they start stealing your data

781
00:24:58,159 --> 00:25:01,440
if they've made it to that point the

782
00:24:59,840 --> 00:25:02,879
more data they get out the door the

783
00:25:01,440 --> 00:25:04,799
worse it's going to be when you end up

784
00:25:02,880 --> 00:25:05,120
having a team like ours come in and we

785
00:25:04,799 --> 00:25:07,840
go

786
00:25:05,120 --> 00:25:09,678
oh dude that sucks like you should have

787
00:25:07,840 --> 00:25:12,720
found that

788
00:25:09,679 --> 00:25:15,200
also if you have

789
00:25:12,720 --> 00:25:17,039
ftp going to outside of your points of

790
00:25:15,200 --> 00:25:17,840
presence so again if you're operating in

791
00:25:17,039 --> 00:25:19,919
country a

792
00:25:17,840 --> 00:25:21,678
and b anything outside of that like

793
00:25:19,919 --> 00:25:23,039
what's that can you just like block that

794
00:25:21,679 --> 00:25:24,559
out right in your firewall like don't

795
00:25:23,039 --> 00:25:27,360
let it happen

796
00:25:24,559 --> 00:25:28,000
monitor for win scp and filezilla mary

797
00:25:27,360 --> 00:25:30,559
gave an awesome

798
00:25:28,000 --> 00:25:32,400
talk on when scp so if you happen to

799
00:25:30,559 --> 00:25:33,200
have a chance to take a look at her talk

800
00:25:32,400 --> 00:25:35,360
for what you could

801
00:25:33,200 --> 00:25:36,880
do if you find a tool like this and

802
00:25:35,360 --> 00:25:38,479
you'd be actually quite surprised as to

803
00:25:36,880 --> 00:25:41,600
how much data you can get

804
00:25:38,480 --> 00:25:42,799
in a mass on your right actors and then

805
00:25:41,600 --> 00:25:45,678
powershell natively

806
00:25:42,799 --> 00:25:46,480
you can look for system.net.ftp web

807
00:25:45,679 --> 00:25:48,559
request

808
00:25:46,480 --> 00:25:51,039
it's super common within these attacks

809
00:25:48,559 --> 00:25:54,000
they just you go right into powershell

810
00:25:51,039 --> 00:25:55,440
and just send your data right out and

811
00:25:54,000 --> 00:25:58,559
then finally cloud-based

812
00:25:55,440 --> 00:26:00,320
sharing sites i i failed i failed

813
00:25:58,559 --> 00:26:02,480
everyone miserably i apologize i

814
00:26:00,320 --> 00:26:04,799
should have included mega on this slide

815
00:26:02,480 --> 00:26:07,679
because it is mega mega common

816
00:26:04,799 --> 00:26:09,039
so if you don't approve using certain

817
00:26:07,679 --> 00:26:10,880
file sharing sites within

818
00:26:09,039 --> 00:26:12,799
a policy and i hope that you have a

819
00:26:10,880 --> 00:26:15,279
policy around that by the way

820
00:26:12,799 --> 00:26:16,320
then look for sites that are outside of

821
00:26:15,279 --> 00:26:18,880
your policy

822
00:26:16,320 --> 00:26:19,439
calculate bike counts out and alert or

823
00:26:18,880 --> 00:26:21,279
hunt

824
00:26:19,440 --> 00:26:22,720
when they're over a certain threshold

825
00:26:21,279 --> 00:26:24,320
right even just a couple hundred

826
00:26:22,720 --> 00:26:24,799
megabytes like what's that why is that

827
00:26:24,320 --> 00:26:27,279
leaving

828
00:26:24,799 --> 00:26:29,440
and going to the site you will get most

829
00:26:27,279 --> 00:26:31,600
likely a ton of false positives for

830
00:26:29,440 --> 00:26:32,799
this kind of stuff even mega but it's

831
00:26:31,600 --> 00:26:34,399
still really solid

832
00:26:32,799 --> 00:26:36,240
to keep your eyes on it so that you can

833
00:26:34,400 --> 00:26:38,000
make darn sure that if you have one of

834
00:26:36,240 --> 00:26:40,400
these ransomware operators in your

835
00:26:38,000 --> 00:26:41,120
environment you catch them at the very

836
00:26:40,400 --> 00:26:42,720
least

837
00:26:41,120 --> 00:26:44,639
when they're trying to take your stuff

838
00:26:42,720 --> 00:26:45,360
out and you put a stop to it because if

839
00:26:44,640 --> 00:26:48,240
you

840
00:26:45,360 --> 00:26:48,719
let them get the stuff out the door your

841
00:26:48,240 --> 00:26:52,159
day

842
00:26:48,720 --> 00:26:53,760
is gonna suck all right and that's it

843
00:26:52,159 --> 00:26:55,360
that's my presentation i know i had a

844
00:26:53,760 --> 00:26:57,679
whole bunch of information i

845
00:26:55,360 --> 00:26:59,600
compressed into that 25 minutes so

846
00:26:57,679 --> 00:27:00,480
please check out the pdf that's going to

847
00:26:59,600 --> 00:27:02,240
be available

848
00:27:00,480 --> 00:27:04,159
i will be in the chat for the next at

849
00:27:02,240 --> 00:27:05,679
least half an hour answering questions

850
00:27:04,159 --> 00:27:07,520
and thank you everyone thank you very

851
00:27:05,679 --> 00:27:15,039
very much for having me on i really

852
00:27:07,520 --> 00:27:15,039
appreciate it

