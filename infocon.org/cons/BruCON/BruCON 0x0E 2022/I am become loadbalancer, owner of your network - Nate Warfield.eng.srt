1
00:00:03,840 --> 00:00:05,220
um I'm Nate Warfield

2
00:00:05,220 --> 00:00:06,600
um thank you for having me this is

3
00:00:06,600 --> 00:00:08,039
actually my third time speaking at

4
00:00:08,039 --> 00:00:09,240
brewcon

5
00:00:09,240 --> 00:00:11,099
um Tom you guys just killed it with the

6
00:00:11,099 --> 00:00:13,019
venue I hope you eventually can figure

7
00:00:13,019 --> 00:00:14,700
out what the background on my slides is

8
00:00:14,700 --> 00:00:17,820
because I did it just for you

9
00:00:17,820 --> 00:00:18,900
so

10
00:00:18,900 --> 00:00:20,279
um quick we're gonna go through the

11
00:00:20,279 --> 00:00:22,619
agenda real quick here and I'm gonna let

12
00:00:22,619 --> 00:00:24,119
you know what I'm talking about so

13
00:00:24,119 --> 00:00:25,800
obviously I'm going to be talking about

14
00:00:25,800 --> 00:00:28,500
uh post exploitation things it's uh F5

15
00:00:28,500 --> 00:00:30,840
devices so I'm going to go a little bit

16
00:00:30,840 --> 00:00:33,120
into my background Who I Am What

17
00:00:33,120 --> 00:00:34,700
motivated me to put this talk together

18
00:00:34,700 --> 00:00:36,960
we're going to do a brief abbreviated

19
00:00:36,960 --> 00:00:38,940
history of the exploitation of F5

20
00:00:38,940 --> 00:00:42,300
devices another article we'll get into

21
00:00:42,300 --> 00:00:46,260
the who UNC 3524 is on those slides

22
00:00:46,260 --> 00:00:47,399
um then I'm going to go into some of the

23
00:00:47,399 --> 00:00:49,260
basically the the thought process and

24
00:00:49,260 --> 00:00:50,700
the way that I did this research to

25
00:00:50,700 --> 00:00:52,379
build this talk and then we're going to

26
00:00:52,379 --> 00:00:53,820
get into the fun stuff I've got three

27
00:00:53,820 --> 00:00:55,440
demo videos scattered throughout this

28
00:00:55,440 --> 00:00:57,360
talk we're going to see how I attack

29
00:00:57,360 --> 00:00:59,579
these things implant these things like I

30
00:00:59,579 --> 00:01:01,379
hope you like this I feel like you're in

31
00:01:01,379 --> 00:01:03,000
for a good time

32
00:01:03,000 --> 00:01:04,860
um and then there's an actual like very

33
00:01:04,860 --> 00:01:06,600
interesting hacking demo at the end that

34
00:01:06,600 --> 00:01:08,280
shows me doing some stuff that I'm going

35
00:01:08,280 --> 00:01:10,260
to wait until you see it

36
00:01:10,260 --> 00:01:13,080
so like I said my name is Nate

37
00:01:13,080 --> 00:01:14,520
um I'm actually one of the founders of a

38
00:01:14,520 --> 00:01:16,260
group that was called CTI League this

39
00:01:16,260 --> 00:01:18,360
was a group of infosec volunteers that

40
00:01:18,360 --> 00:01:20,520
we put together in 2020

41
00:01:20,520 --> 00:01:23,280
um essentially I we put out a call and

42
00:01:23,280 --> 00:01:26,280
myself Mark Rogers a little hard from uh

43
00:01:26,280 --> 00:01:28,320
India we basically realized that

44
00:01:28,320 --> 00:01:30,600
hospitals were getting ransomware and we

45
00:01:30,600 --> 00:01:32,040
wanted to do whatever we could to help

46
00:01:32,040 --> 00:01:35,040
so in about a month we built a 1500

47
00:01:35,040 --> 00:01:37,860
person volunteer group in slack giving

48
00:01:37,860 --> 00:01:39,720
away threat intelligence and perimeter

49
00:01:39,720 --> 00:01:41,340
assessments and anything we could to try

50
00:01:41,340 --> 00:01:42,600
to help hospitals keep from getting

51
00:01:42,600 --> 00:01:44,579
ransomware we ended up getting right

52
00:01:44,579 --> 00:01:46,380
written up and Wired Magazine for this

53
00:01:46,380 --> 00:01:47,939
we worked with pretty much every law

54
00:01:47,939 --> 00:01:50,399
enforcement agency on the planet and

55
00:01:50,399 --> 00:01:51,720
even now two years later I run into

56
00:01:51,720 --> 00:01:53,220
people that are like you guys did so

57
00:01:53,220 --> 00:01:55,500
much good obviously we never really know

58
00:01:55,500 --> 00:01:56,880
what we stopped because it's hard to

59
00:01:56,880 --> 00:01:59,040
measure things that don't happen but

60
00:01:59,040 --> 00:02:00,180
it's something we did that was really

61
00:02:00,180 --> 00:02:01,979
good for the world

62
00:02:01,979 --> 00:02:04,799
um I've been a network hacker since my

63
00:02:04,799 --> 00:02:06,659
teens it's how I got kicked out of high

64
00:02:06,659 --> 00:02:09,959
school I do security research it used to

65
00:02:09,959 --> 00:02:12,000
be in my spare time like my couple of

66
00:02:12,000 --> 00:02:13,860
rukon talks I did before was sort of

67
00:02:13,860 --> 00:02:16,200
Spare Time research now I'm a director

68
00:02:16,200 --> 00:02:17,879
of research at this firmware company

69
00:02:17,879 --> 00:02:19,560
called eclipsium so I get to do this

70
00:02:19,560 --> 00:02:22,319
like as much as I want which is amazing

71
00:02:22,319 --> 00:02:24,540
I also worked for F5 for 10 years and

72
00:02:24,540 --> 00:02:25,860
I'm pretty sure when they see this

73
00:02:25,860 --> 00:02:27,300
they're not going to be too thrilled at

74
00:02:27,300 --> 00:02:29,220
what I'm talking about

75
00:02:29,220 --> 00:02:31,440
um and I worked at Microsoft I spent

76
00:02:31,440 --> 00:02:33,120
seven years there I spent four and a

77
00:02:33,120 --> 00:02:34,560
half years shipping out Patch Tuesday

78
00:02:34,560 --> 00:02:36,180
stuff so I always like to say you're

79
00:02:36,180 --> 00:02:39,120
welcome I'm also have the dubious honor

80
00:02:39,120 --> 00:02:41,459
of shipping the ms-1710 also known as

81
00:02:41,459 --> 00:02:44,040
the wannacry patch and I want to point

82
00:02:44,040 --> 00:02:45,900
out that I am not a red teamer

83
00:02:45,900 --> 00:02:47,280
um I've mostly done defensive things

84
00:02:47,280 --> 00:02:49,200
this is me just figuring out how to do

85
00:02:49,200 --> 00:02:50,459
this on my own

86
00:02:50,459 --> 00:02:51,780
um and the point is if I can do this

87
00:02:51,780 --> 00:02:53,280
it's kind of scary what other people can

88
00:02:53,280 --> 00:02:55,680
do and my Twitter handle is on there I

89
00:02:55,680 --> 00:02:57,540
also use my full name everywhere I don't

90
00:02:57,540 --> 00:02:59,580
really try to hide so look me up follow

91
00:02:59,580 --> 00:03:02,160
me friend me on LinkedIn I'm cool

92
00:03:02,160 --> 00:03:04,080
so motivation

93
00:03:04,080 --> 00:03:06,000
um like I said I started CTI league and

94
00:03:06,000 --> 00:03:07,440
the one thing that started it was

95
00:03:07,440 --> 00:03:09,780
literally load balancer vulnerabilities

96
00:03:09,780 --> 00:03:11,340
um I was at Microsoft at the time

97
00:03:11,340 --> 00:03:13,140
playing with my super god Showdown

98
00:03:13,140 --> 00:03:14,760
license and I dumped all of these net

99
00:03:14,760 --> 00:03:17,280
scalers that were vulnerable and started

100
00:03:17,280 --> 00:03:18,659
looking for like keywords like Hospital

101
00:03:18,659 --> 00:03:20,099
health care you know in the

102
00:03:20,099 --> 00:03:22,379
organizational data and I find two

103
00:03:22,379 --> 00:03:24,360
Citrix devices that were VPN devices

104
00:03:24,360 --> 00:03:26,159
that were on the network of my hospital

105
00:03:26,159 --> 00:03:27,900
that I go to for my general practice

106
00:03:27,900 --> 00:03:29,760
doctor I've they put my shoulder

107
00:03:29,760 --> 00:03:31,200
together after a snowboarding accident

108
00:03:31,200 --> 00:03:33,480
I'm just like oh my God like these are

109
00:03:33,480 --> 00:03:35,280
VPN things attached to a hospital that

110
00:03:35,280 --> 00:03:37,800
are vulnerable to this nasty o day and I

111
00:03:37,800 --> 00:03:39,060
didn't know how to get a hold of people

112
00:03:39,060 --> 00:03:42,000
so you know that process of figuring out

113
00:03:42,000 --> 00:03:43,799
who we could talk to figuring out how to

114
00:03:43,799 --> 00:03:45,780
tell hospitals about this it turns out

115
00:03:45,780 --> 00:03:48,299
it's a lot harder to give away free to

116
00:03:48,299 --> 00:03:49,860
free threat Intel than you would think

117
00:03:49,860 --> 00:03:52,080
it was we had people that actually

118
00:03:52,080 --> 00:03:53,400
straight up thought we were trying to

119
00:03:53,400 --> 00:03:55,319
Blackmail them like people were emailing

120
00:03:55,319 --> 00:03:57,540
hospitals like hey you've got like RDP

121
00:03:57,540 --> 00:03:58,860
open to the internet or hey you've got a

122
00:03:58,860 --> 00:04:00,360
Citrix device and there's response is

123
00:04:00,360 --> 00:04:01,799
like you're blackmailing us we're going

124
00:04:01,799 --> 00:04:03,000
to get the low lawyers involved and

125
00:04:03,000 --> 00:04:05,519
we're like no we're trying to help you

126
00:04:05,519 --> 00:04:07,080
um so we ended up getting a lot of

127
00:04:07,080 --> 00:04:09,360
interesting experience working with

128
00:04:09,360 --> 00:04:11,340
government Partnerships we actually had

129
00:04:11,340 --> 00:04:13,319
somebody from the sisa or the Cyber

130
00:04:13,319 --> 00:04:15,239
something intelligence something agency

131
00:04:15,239 --> 00:04:17,820
in the United States they told us sort

132
00:04:17,820 --> 00:04:20,160
of privately until now that what we did

133
00:04:20,160 --> 00:04:21,358
in a month was something they've been

134
00:04:21,358 --> 00:04:23,220
trying and failing to do for 10 years so

135
00:04:23,220 --> 00:04:24,960
we really sort of proved conceptually

136
00:04:24,960 --> 00:04:26,460
that private and public sector could

137
00:04:26,460 --> 00:04:28,440
work together for good

138
00:04:28,440 --> 00:04:30,419
and I also in the process of this I did

139
00:04:30,419 --> 00:04:32,940
a lot of sort of defer stuff for F5s in

140
00:04:32,940 --> 00:04:35,699
2020 in the summer this nasty zero well

141
00:04:35,699 --> 00:04:37,139
not a zero day but this this really

142
00:04:37,139 --> 00:04:39,240
nasty bug came out that they fixed that

143
00:04:39,240 --> 00:04:42,300
was promptly exploited in Mass over the

144
00:04:42,300 --> 00:04:45,060
U.S 4th of July holiday so you know we

145
00:04:45,060 --> 00:04:46,500
worked the weekend trying to help the

146
00:04:46,500 --> 00:04:48,960
ctily hospital people we knew I came in

147
00:04:48,960 --> 00:04:51,360
on Monday and found out that like 140 of

148
00:04:51,360 --> 00:04:53,160
the F5s that Microsoft ran had been hit

149
00:04:53,160 --> 00:04:55,080
by it too so then Microsoft's like hey

150
00:04:55,080 --> 00:04:56,520
can you do D Fair on it because you're

151
00:04:56,520 --> 00:04:58,080
apparently the only guy that understands

152
00:04:58,080 --> 00:04:59,699
these in the company so

153
00:04:59,699 --> 00:05:02,040
done a lot of the defensive side and I

154
00:05:02,040 --> 00:05:03,479
figured now it's time to do something

155
00:05:03,479 --> 00:05:05,340
offensive and the point of this talk

156
00:05:05,340 --> 00:05:08,160
really is if you're a pen tester this is

157
00:05:08,160 --> 00:05:10,680
what you can do this is tricks to not

158
00:05:10,680 --> 00:05:12,000
get caught this is how you was talking

159
00:05:12,000 --> 00:05:13,680
to someone the other night that it was

160
00:05:13,680 --> 00:05:15,120
like Hey I go into these environments

161
00:05:15,120 --> 00:05:16,380
and I'm not allowed to touch the load

162
00:05:16,380 --> 00:05:18,180
balancers and even if I could I wouldn't

163
00:05:18,180 --> 00:05:19,380
because I don't want to take this thing

164
00:05:19,380 --> 00:05:20,940
down so this will give you some Clues on

165
00:05:20,940 --> 00:05:22,800
how to do it and yes there are some

166
00:05:22,800 --> 00:05:24,120
stuff that's defensive that'll help you

167
00:05:24,120 --> 00:05:25,500
if you're doing do you feel like this is

168
00:05:25,500 --> 00:05:28,139
what to look for so that when the apts

169
00:05:28,139 --> 00:05:30,000
eventually I can't wait for this talk to

170
00:05:30,000 --> 00:05:31,560
be used in a mandated report of like hey

171
00:05:31,560 --> 00:05:33,479
these a-holes use the information from

172
00:05:33,479 --> 00:05:35,520
this a-hole to reach this company like

173
00:05:35,520 --> 00:05:38,759
it'll be a check mark on my resume

174
00:05:38,759 --> 00:05:41,039
um yeah and I mentioned Mandy it um

175
00:05:41,039 --> 00:05:42,960
because as I was putting this together I

176
00:05:42,960 --> 00:05:44,520
was going to go to North Second Montreal

177
00:05:44,520 --> 00:05:46,740
and I was going to use the 2020 exploit

178
00:05:46,740 --> 00:05:48,300
which is kind of horrible it's bad but

179
00:05:48,300 --> 00:05:50,400
it's really ugly to work with and then

180
00:05:50,400 --> 00:05:52,979
um the gods looked down on me and uh

181
00:05:52,979 --> 00:05:54,960
like Monday of one of the weeks in May

182
00:05:54,960 --> 00:05:57,360
mandiant releases this report about this

183
00:05:57,360 --> 00:05:59,759
UNC 3524 threat actor that I'm going to

184
00:05:59,759 --> 00:06:01,320
get into and I was like wow this is cool

185
00:06:01,320 --> 00:06:02,940
my work is relevant I didn't think

186
00:06:02,940 --> 00:06:04,259
anybody was going to care about load

187
00:06:04,259 --> 00:06:06,360
balancers except me and then two days

188
00:06:06,360 --> 00:06:08,580
later another really nasty but very

189
00:06:08,580 --> 00:06:10,979
beautiful uh zero day-ish you know

190
00:06:10,979 --> 00:06:13,139
remote code execution of old erops from

191
00:06:13,139 --> 00:06:14,940
F5 and I'm just like first there's the

192
00:06:14,940 --> 00:06:16,680
report and now I have a much better POC

193
00:06:16,680 --> 00:06:19,680
to work with like yeah it's been my year

194
00:06:19,680 --> 00:06:21,060
um and the other thing too is that this

195
00:06:21,060 --> 00:06:22,259
is a space that people don't seem to

196
00:06:22,259 --> 00:06:24,120
understand very well right F5 devices

197
00:06:24,120 --> 00:06:26,460
Citrix load balancers wafts firewalls

198
00:06:26,460 --> 00:06:27,479
all these things are these like black

199
00:06:27,479 --> 00:06:29,580
boxes you stick them in your network you

200
00:06:29,580 --> 00:06:30,840
get it running and then you just pray

201
00:06:30,840 --> 00:06:32,220
that it keeps working that nobody

202
00:06:32,220 --> 00:06:34,259
touches it and you kind of assume I

203
00:06:34,259 --> 00:06:36,720
spent 150 000 on this piece of gear the

204
00:06:36,720 --> 00:06:38,280
vendor must have made this stuff cure

205
00:06:38,280 --> 00:06:40,440
which is obviously that's how it works

206
00:06:40,440 --> 00:06:41,759
right

207
00:06:41,759 --> 00:06:44,880
so a brief history of F5 exploits like I

208
00:06:44,880 --> 00:06:46,860
said I worked there for 10 years and the

209
00:06:46,860 --> 00:06:48,000
first really bad role that we had

210
00:06:48,000 --> 00:06:50,940
reported to us was a they left an SSH

211
00:06:50,940 --> 00:06:53,100
public private key pair in an ISO image

212
00:06:53,100 --> 00:06:54,840
that you could download from their FTP

213
00:06:54,840 --> 00:06:56,819
server the code that was supposed to

214
00:06:56,819 --> 00:06:58,919
roll the key when you first booted it up

215
00:06:58,919 --> 00:07:01,080
didn't work so somebody figured out if I

216
00:07:01,080 --> 00:07:02,880
download this ISO pull out the private

217
00:07:02,880 --> 00:07:04,740
key I can there the public key I can

218
00:07:04,740 --> 00:07:06,720
then SSH into any F5 in the world is

219
00:07:06,720 --> 00:07:09,419
root if they have the SSH Port open

220
00:07:09,419 --> 00:07:11,160
um sub-optimal

221
00:07:11,160 --> 00:07:15,900
uh this is the one from 2020. um this I

222
00:07:15,900 --> 00:07:18,060
have a bit of a I have a bit of a pet

223
00:07:18,060 --> 00:07:19,560
peeve about people that don't pay

224
00:07:19,560 --> 00:07:21,060
attention to research well this is yet

225
00:07:21,060 --> 00:07:23,460
another of the path traversal loans same

226
00:07:23,460 --> 00:07:24,660
exact thing that happened with the

227
00:07:24,660 --> 00:07:26,460
Citrix volume from 2019 I think

228
00:07:26,460 --> 00:07:29,039
fortigate I'm also had one

229
00:07:29,039 --> 00:07:31,860
um this this this exact POC this dot dot

230
00:07:31,860 --> 00:07:34,500
semicolon forward slash was in a talk by

231
00:07:34,500 --> 00:07:36,240
this guy orange side he spoke at black

232
00:07:36,240 --> 00:07:38,580
hat and I think it was 2018 talking

233
00:07:38,580 --> 00:07:40,620
about this problem and then nobody paid

234
00:07:40,620 --> 00:07:41,880
attention and then you know two years

235
00:07:41,880 --> 00:07:43,380
later machines are getting popped left

236
00:07:43,380 --> 00:07:45,300
and right it's like guys he told you

237
00:07:45,300 --> 00:07:46,800
right there how to look for this stuff

238
00:07:46,800 --> 00:07:48,240
so

239
00:07:48,240 --> 00:07:50,759
um and this is the one that from 2022

240
00:07:50,759 --> 00:07:52,620
and what this screenshot is is actually

241
00:07:52,620 --> 00:07:54,599
just using the POC to dump and say hey

242
00:07:54,599 --> 00:07:55,740
let me look at the platform information

243
00:07:55,740 --> 00:07:58,319
of this device like that looks exactly

244
00:07:58,319 --> 00:08:00,360
like what your it looks like on an F5

245
00:08:00,360 --> 00:08:01,860
shell like this is against a Json

246
00:08:01,860 --> 00:08:03,240
endpoint so everything comes back at

247
00:08:03,240 --> 00:08:05,400
Json and it's beautiful I actually

248
00:08:05,400 --> 00:08:07,500
contemplated writing a rapper around the

249
00:08:07,500 --> 00:08:09,240
exploit to use to basically emulate

250
00:08:09,240 --> 00:08:10,919
their entire show so that you wouldn't

251
00:08:10,919 --> 00:08:12,360
have to log in you could just use the

252
00:08:12,360 --> 00:08:14,460
exploit to run all your admin stuff

253
00:08:14,460 --> 00:08:15,660
and all of these things attack

254
00:08:15,660 --> 00:08:17,220
management interfaces like there's

255
00:08:17,220 --> 00:08:18,780
aren't vulnerabilities in so much the

256
00:08:18,780 --> 00:08:21,120
traffic playing side of the F5 but the

257
00:08:21,120 --> 00:08:22,500
problem is is that people point this

258
00:08:22,500 --> 00:08:24,419
stuff at the internet all the time

259
00:08:24,419 --> 00:08:26,819
and I like exploits that fit in tweets I

260
00:08:26,819 --> 00:08:28,199
have this thing if you could put it in a

261
00:08:28,199 --> 00:08:30,479
tweet it's amazing so both of these last

262
00:08:30,479 --> 00:08:32,399
two years of XYZ verifies both fit

263
00:08:32,399 --> 00:08:35,458
inside a tweet with room to spare

264
00:08:35,458 --> 00:08:37,020
so this is the report that got me

265
00:08:37,020 --> 00:08:39,120
interested in it right so I was sitting

266
00:08:39,120 --> 00:08:41,580
there wondering if anybody was going to

267
00:08:41,580 --> 00:08:43,140
care about a load balancing talk and

268
00:08:43,140 --> 00:08:45,060
mandian releases this report and you can

269
00:08:45,060 --> 00:08:46,500
read along these little blurbs that I

270
00:08:46,500 --> 00:08:48,480
pulled out that were interesting but the

271
00:08:48,480 --> 00:08:50,580
gist of it is is this you know alleged

272
00:08:50,580 --> 00:08:52,680
Russian cyber actor cyber Espionage

273
00:08:52,680 --> 00:08:55,320
group was hacking into networks and they

274
00:08:55,320 --> 00:08:57,360
were getting in through Santa rays and

275
00:08:57,360 --> 00:08:59,880
load balancers and while they didn't

276
00:08:59,880 --> 00:09:01,740
actually specify which load balancer as

277
00:09:01,740 --> 00:09:02,700
they mentioned in their thing they're

278
00:09:02,700 --> 00:09:04,740
like yeah these devices run Centos or

279
00:09:04,740 --> 00:09:07,200
BSD and blah blah blah and I'm like well

280
00:09:07,200 --> 00:09:08,580
the only load balancer in the world that

281
00:09:08,580 --> 00:09:10,380
uses Centos is its management interface

282
00:09:10,380 --> 00:09:13,200
is F5 so I was like okay

283
00:09:13,200 --> 00:09:14,880
um and the other stuff that I thought

284
00:09:14,880 --> 00:09:17,040
was interesting is as I'm reading this

285
00:09:17,040 --> 00:09:18,240
article right they're talking about like

286
00:09:18,240 --> 00:09:19,680
what do they use as their their back

287
00:09:19,680 --> 00:09:21,839
door well they modified the drop bear

288
00:09:21,839 --> 00:09:23,760
SSH client and they just plopped that on

289
00:09:23,760 --> 00:09:25,320
the machine and then they would ssh in

290
00:09:25,320 --> 00:09:28,080
I'm like apt really here do you like

291
00:09:28,080 --> 00:09:30,959
nothing custom nothing cool the other

292
00:09:30,959 --> 00:09:32,279
stuff that was interesting too is they

293
00:09:32,279 --> 00:09:33,720
have they even say that this had no

294
00:09:33,720 --> 00:09:35,279
method of persistence like there was you

295
00:09:35,279 --> 00:09:37,140
know they tried to modify some RC

296
00:09:37,140 --> 00:09:38,640
scripts they tried to modify some stuff

297
00:09:38,640 --> 00:09:40,740
that would let them come back in but it

298
00:09:40,740 --> 00:09:42,240
was also unreliable to the point where

299
00:09:42,240 --> 00:09:44,160
they had to drop a web shell on servers

300
00:09:44,160 --> 00:09:45,839
in the environment because they would

301
00:09:45,839 --> 00:09:47,519
use the web shell to turn their implant

302
00:09:47,519 --> 00:09:49,680
back on when it turned off so I'm just

303
00:09:49,680 --> 00:09:51,779
like man you guys really don't know what

304
00:09:51,779 --> 00:09:52,920
you're doing

305
00:09:52,920 --> 00:09:55,200
um so you know I was like very late much

306
00:09:55,200 --> 00:09:57,060
hack hold my beard I bet you I could do

307
00:09:57,060 --> 00:09:59,459
better and my point was right these guys

308
00:09:59,459 --> 00:10:01,860
don't have persistence they it's there

309
00:10:01,860 --> 00:10:03,660
but if you reboot the box it's probably

310
00:10:03,660 --> 00:10:05,700
going to go away that was even something

311
00:10:05,700 --> 00:10:07,380
we told people in defer we're like we'll

312
00:10:07,380 --> 00:10:09,720
reboot it first after you've tried to

313
00:10:09,720 --> 00:10:12,000
image it reboot it and then wipe it

314
00:10:12,000 --> 00:10:13,620
um but I'm like their malware's not

315
00:10:13,620 --> 00:10:14,640
going to survive an upgrade it's not

316
00:10:14,640 --> 00:10:16,380
going to survive patching I'll bet you I

317
00:10:16,380 --> 00:10:18,420
can do better than that I thought it was

318
00:10:18,420 --> 00:10:20,580
weird that for you know a Russian threat

319
00:10:20,580 --> 00:10:22,800
actor they're using open source software

320
00:10:22,800 --> 00:10:25,500
with like a hard-coded password that is

321
00:10:25,500 --> 00:10:27,060
easily I mean the Mandate report has

322
00:10:27,060 --> 00:10:28,380
Yara rules it's like this is how you

323
00:10:28,380 --> 00:10:29,820
find it because the password is hard

324
00:10:29,820 --> 00:10:31,740
coded into the binary I'm like that's

325
00:10:31,740 --> 00:10:35,279
not very Intel like very good opsec as I

326
00:10:35,279 --> 00:10:37,260
mentioned it was unreliable and I kind

327
00:10:37,260 --> 00:10:38,519
of thought that they were strangely

328
00:10:38,519 --> 00:10:40,980
inept for like this cyber actor now this

329
00:10:40,980 --> 00:10:43,380
isn't a slight mandian it just seemed

330
00:10:43,380 --> 00:10:44,760
very strange that you know they were

331
00:10:44,760 --> 00:10:46,079
able to stay in the environments for

332
00:10:46,079 --> 00:10:47,820
like 18 months undetected which I was

333
00:10:47,820 --> 00:10:50,220
like that's pretty impressive they're

334
00:10:50,220 --> 00:10:52,140
also on an endpoint thing that's hard to

335
00:10:52,140 --> 00:10:53,160
monitor right like I said these are

336
00:10:53,160 --> 00:10:54,779
black boxes you just kind of leave it

337
00:10:54,779 --> 00:10:58,019
alone until something goes wrong with it

338
00:10:58,019 --> 00:11:00,120
so I decided to do some reconnaissance

339
00:11:00,120 --> 00:11:02,220
and figure out knowing some of the stuff

340
00:11:02,220 --> 00:11:03,959
I already knew from working at F5 like

341
00:11:03,959 --> 00:11:05,640
what can I do like could I do better

342
00:11:05,640 --> 00:11:07,700
than an apt could I make something more

343
00:11:07,700 --> 00:11:10,200
pervasive and more sort of deeply

344
00:11:10,200 --> 00:11:13,620
implanted on one of these things so

345
00:11:13,620 --> 00:11:15,959
the quick cldr I kind of assume that

346
00:11:15,959 --> 00:11:17,160
everybody's a network engineer and

347
00:11:17,160 --> 00:11:18,480
everybody knows what a load balancer is

348
00:11:18,480 --> 00:11:20,459
but basically they're big super

349
00:11:20,459 --> 00:11:22,980
expensive pieces of networking Hardware

350
00:11:22,980 --> 00:11:25,140
um if you like think of like a catalyst

351
00:11:25,140 --> 00:11:27,360
switch I'm dating myself I think Cisco

352
00:11:27,360 --> 00:11:29,700
uses Nexus or something else now but the

353
00:11:29,700 --> 00:11:30,959
price point on these things it starts

354
00:11:30,959 --> 00:11:32,399
around ninety thousand dollars and then

355
00:11:32,399 --> 00:11:34,200
goes up to three quarters of a million

356
00:11:34,200 --> 00:11:36,300
dollars a piece and they sell them in

357
00:11:36,300 --> 00:11:37,860
pairs because if you need to do

358
00:11:37,860 --> 00:11:39,240
maintenance you fail over to the other

359
00:11:39,240 --> 00:11:40,440
one so that you're never going to have

360
00:11:40,440 --> 00:11:42,660
traffic Interruption these devices run

361
00:11:42,660 --> 00:11:45,000
and I think it's 400 of the Fortune 500

362
00:11:45,000 --> 00:11:46,740
companies like every cell phone company

363
00:11:46,740 --> 00:11:49,260
in the world uses them most banks us

364
00:11:49,260 --> 00:11:51,000
space command I don't know if you know

365
00:11:51,000 --> 00:11:53,040
who Costco is but they also use them

366
00:11:53,040 --> 00:11:55,079
Walmart uses them like they're

367
00:11:55,079 --> 00:11:56,700
everywhere and they've been around for

368
00:11:56,700 --> 00:11:59,279
20 years so they've got a huge market

369
00:11:59,279 --> 00:12:00,660
share

370
00:12:00,660 --> 00:12:01,860
um they've kind of begun the Swiss army

371
00:12:01,860 --> 00:12:04,079
knife of networking which is part of how

372
00:12:04,079 --> 00:12:05,760
they got themselves in trouble so they

373
00:12:05,760 --> 00:12:06,959
do everything from layer four to seven

374
00:12:06,959 --> 00:12:08,519
load balancing you can make it a web

375
00:12:08,519 --> 00:12:10,620
application firewall it does DNS load

376
00:12:10,620 --> 00:12:12,540
balancing a lot of people used to buy

377
00:12:12,540 --> 00:12:14,700
them for their TLS offloading back when

378
00:12:14,700 --> 00:12:17,100
you know computers and and ships were

379
00:12:17,100 --> 00:12:19,620
expensive and you only wanted to buy one

380
00:12:19,620 --> 00:12:21,420
SSL certificate and let it do all the

381
00:12:21,420 --> 00:12:23,040
SSL on the load balancer and then use

382
00:12:23,040 --> 00:12:25,680
Clear text HTTP to the back because that

383
00:12:25,680 --> 00:12:27,779
was smart to do back then but the nice

384
00:12:27,779 --> 00:12:29,279
thing is these also are deployed in

385
00:12:29,279 --> 00:12:30,720
places where they usually have fairly

386
00:12:30,720 --> 00:12:32,519
unfettered access to your network right

387
00:12:32,519 --> 00:12:34,079
it's somewhere in the core of a network

388
00:12:34,079 --> 00:12:35,339
it's somewhere where there's tons of

389
00:12:35,339 --> 00:12:36,779
valuable stuff happening and you want it

390
00:12:36,779 --> 00:12:39,240
to be able to talk to everything the

391
00:12:39,240 --> 00:12:40,440
other part of that minimum is because

392
00:12:40,440 --> 00:12:42,240
they're so big and expensive and because

393
00:12:42,240 --> 00:12:45,899
F5 is a questionable code quality the

394
00:12:45,899 --> 00:12:47,399
people leave these things outdated for a

395
00:12:47,399 --> 00:12:49,680
long time when I worked at Microsoft I

396
00:12:49,680 --> 00:12:51,779
was on the networking team and we would

397
00:12:51,779 --> 00:12:53,639
spend about a year and a half to test

398
00:12:53,639 --> 00:12:55,399
and certify a new Borough build of code

399
00:12:55,399 --> 00:12:58,980
granted we had 2300 fives that we had to

400
00:12:58,980 --> 00:13:01,260
upgrade but it took a long time for us

401
00:13:01,260 --> 00:13:02,940
to certify a code and say this is stable

402
00:13:02,940 --> 00:13:04,560
enough that we could put passport and

403
00:13:04,560 --> 00:13:06,899
Hotmail and Outlook to our office365.com

404
00:13:06,899 --> 00:13:09,480
traffic on it so and a lot of people I

405
00:13:09,480 --> 00:13:10,560
talk to that manage and they're like

406
00:13:10,560 --> 00:13:11,760
yeah dude I don't upgrade it unless I

407
00:13:11,760 --> 00:13:12,959
have to like I'm scared that it's going

408
00:13:12,959 --> 00:13:14,100
to blow up and it's going to cause an

409
00:13:14,100 --> 00:13:15,839
outage

410
00:13:15,839 --> 00:13:16,800
um and because these things are

411
00:13:16,800 --> 00:13:18,899
proprietary there is no EDR software

412
00:13:18,899 --> 00:13:21,060
that runs on it right it's Centos Linux

413
00:13:21,060 --> 00:13:22,139
the management operating system is

414
00:13:22,139 --> 00:13:25,620
Centos somebody could in theory make EDR

415
00:13:25,620 --> 00:13:27,300
software for it but unless you were to

416
00:13:27,300 --> 00:13:29,399
partner with F5 and make it an accepted

417
00:13:29,399 --> 00:13:31,860
thing when you upgrade these things they

418
00:13:31,860 --> 00:13:33,959
just wipe the you upgrade to a new boot

419
00:13:33,959 --> 00:13:35,700
location it lays down on new copy of the

420
00:13:35,700 --> 00:13:37,740
operating system whatever patch it is

421
00:13:37,740 --> 00:13:40,200
and then you roll it over so it's not as

422
00:13:40,200 --> 00:13:43,320
simple as like AV or EDR on Windows and

423
00:13:43,320 --> 00:13:45,060
as Dave just mentioned that's kind of a

424
00:13:45,060 --> 00:13:47,399
Panacea anyways

425
00:13:47,399 --> 00:13:49,860
so a little bit about how these things

426
00:13:49,860 --> 00:13:51,360
are deployed and this is where they

427
00:13:51,360 --> 00:13:54,680
started getting themselves into trouble

428
00:13:55,320 --> 00:13:57,060
all these devices of course being

429
00:13:57,060 --> 00:13:59,100
networks network devices there's a

430
00:13:59,100 --> 00:14:00,660
switch and there's always a port on the

431
00:14:00,660 --> 00:14:01,860
end that's a gigabit length that's out

432
00:14:01,860 --> 00:14:03,779
of band management with SSL and or SSH

433
00:14:03,779 --> 00:14:05,639
and TLS

434
00:14:05,639 --> 00:14:07,860
um they're deployed like I said in pairs

435
00:14:07,860 --> 00:14:10,380
and similar to hsrp there's a sort of a

436
00:14:10,380 --> 00:14:12,600
device specific IP address there's a

437
00:14:12,600 --> 00:14:14,160
what they call a floating address which

438
00:14:14,160 --> 00:14:15,720
is where your servers will point at

439
00:14:15,720 --> 00:14:18,360
their default gateway the idea is when

440
00:14:18,360 --> 00:14:20,220
it fails over not even the only thing

441
00:14:20,220 --> 00:14:21,959
that happens is the MAC address changes

442
00:14:21,959 --> 00:14:23,700
in the switch cam tables the servers

443
00:14:23,700 --> 00:14:25,440
never see anything change the switch

444
00:14:25,440 --> 00:14:26,940
table the switches just say oh this Mac

445
00:14:26,940 --> 00:14:28,380
is now over here instead of over there

446
00:14:28,380 --> 00:14:30,360
the idea is that you never interrupt

447
00:14:30,360 --> 00:14:32,519
traffic flow

448
00:14:32,519 --> 00:14:34,320
um Behind these things live big pools of

449
00:14:34,320 --> 00:14:35,760
servers this is what your resource stuff

450
00:14:35,760 --> 00:14:37,019
is this is where all your clear text

451
00:14:37,019 --> 00:14:39,899
HTTP is happening right they then you

452
00:14:39,899 --> 00:14:41,519
stick a virtual server on the front of

453
00:14:41,519 --> 00:14:43,980
it this is where you add TLS you can um

454
00:14:43,980 --> 00:14:46,740
TLS encryption

455
00:14:46,740 --> 00:14:48,779
um and all the other fun things that you

456
00:14:48,779 --> 00:14:50,760
know you can do sometimes people run

457
00:14:50,760 --> 00:14:52,260
these almost like a hub and spoke mode

458
00:14:52,260 --> 00:14:53,339
where they've got different networks

459
00:14:53,339 --> 00:14:55,079
that are coming through that are routing

460
00:14:55,079 --> 00:14:56,519
internally and they're doing internet

461
00:14:56,519 --> 00:14:57,959
traffic through it because like I said

462
00:14:57,959 --> 00:14:59,519
they're really expensive so you try not

463
00:14:59,519 --> 00:15:00,899
to buy these things it's like you try

464
00:15:00,899 --> 00:15:02,100
not to buy a bunch of them you try to

465
00:15:02,100 --> 00:15:04,199
buy one and do everything with it

466
00:15:04,199 --> 00:15:05,699
and then they've got this weird idea of

467
00:15:05,699 --> 00:15:08,399
profiles which is just like it's a Swiss

468
00:15:08,399 --> 00:15:09,899
army knife of fine tuning every little

469
00:15:09,899 --> 00:15:13,860
detail about tcpip HTTP TLs but the fun

470
00:15:13,860 --> 00:15:17,040
thing is that they also have this TCL TK

471
00:15:17,040 --> 00:15:18,839
embedded interpreter that runs inside

472
00:15:18,839 --> 00:15:21,300
their load balancing traffic plane which

473
00:15:21,300 --> 00:15:23,820
allows you to in real time look at data

474
00:15:23,820 --> 00:15:25,500
and manipulate it and you can make load

475
00:15:25,500 --> 00:15:27,360
balancing decisions you can inject data

476
00:15:27,360 --> 00:15:28,920
inside things you can reroute traffic

477
00:15:28,920 --> 00:15:31,019
and it all happens at like you know 40

478
00:15:31,019 --> 00:15:32,579
gigabit speed or whatever their back

479
00:15:32,579 --> 00:15:34,920
planes are now

480
00:15:34,920 --> 00:15:37,320
so how do you find these things right so

481
00:15:37,320 --> 00:15:39,600
the idea you're on engagement there's a

482
00:15:39,600 --> 00:15:40,740
way you can do it there's a few ways

483
00:15:40,740 --> 00:15:43,260
right you can look and Showdown

484
00:15:43,260 --> 00:15:45,540
um and Showdown actually will notic so

485
00:15:45,540 --> 00:15:47,519
much expose the devices themselves but

486
00:15:47,519 --> 00:15:49,380
you can search for This big-ip Server

487
00:15:49,380 --> 00:15:50,639
cookie

488
00:15:50,639 --> 00:15:52,260
um and it's just some sort of a weird

489
00:15:52,260 --> 00:15:54,360
it's like modded modulated something

490
00:15:54,360 --> 00:15:56,820
encrypted it's not encrypted but if you

491
00:15:56,820 --> 00:15:58,680
can find the server hash off Showdown

492
00:15:58,680 --> 00:16:00,300
you can you're basically exposing the

493
00:16:00,300 --> 00:16:02,519
back end IPS and ports that are behind

494
00:16:02,519 --> 00:16:04,440
this F5 device so you can tell okay well

495
00:16:04,440 --> 00:16:06,480
this IP address right here is something

496
00:16:06,480 --> 00:16:08,459
that there's an F5 in front of and

497
00:16:08,459 --> 00:16:09,899
there's a person that wrote a decoder

498
00:16:09,899 --> 00:16:12,300
that does this for you

499
00:16:12,300 --> 00:16:13,560
um this is why the whole thing is right

500
00:16:13,560 --> 00:16:15,779
that allows them to only speak HTTP on

501
00:16:15,779 --> 00:16:17,639
the back um if you get on one of these

502
00:16:17,639 --> 00:16:19,320
things all of the certs and keys are

503
00:16:19,320 --> 00:16:21,839
stored in clear text on the file system

504
00:16:21,839 --> 00:16:23,760
um they don't by default ship with hsms

505
00:16:23,760 --> 00:16:25,380
there is no real secure way of storing

506
00:16:25,380 --> 00:16:27,180
it like it's a text file on a hard drive

507
00:16:27,180 --> 00:16:29,279
you could just grab the entire like if

508
00:16:29,279 --> 00:16:30,480
you're on an engagement trying to show

509
00:16:30,480 --> 00:16:32,040
what you can steal just zip up the whole

510
00:16:32,040 --> 00:16:34,079
hard drive or as we'll get to use their

511
00:16:34,079 --> 00:16:37,380
embedded functionality to do it for you

512
00:16:37,380 --> 00:16:38,880
um once you get on it some of these

513
00:16:38,880 --> 00:16:40,259
commands are like I said it's red team

514
00:16:40,259 --> 00:16:41,820
Centric so this is some stuff I'm not

515
00:16:41,820 --> 00:16:43,320
going to put the whole command manual in

516
00:16:43,320 --> 00:16:44,399
there because we would be here until

517
00:16:44,399 --> 00:16:46,199
next Brew con

518
00:16:46,199 --> 00:16:47,759
um but you can basically list and see

519
00:16:47,759 --> 00:16:49,079
what kind of authentication these things

520
00:16:49,079 --> 00:16:51,360
speak every Authentication Protocol you

521
00:16:51,360 --> 00:16:53,160
know once you're on it you know I was

522
00:16:53,160 --> 00:16:54,899
trying to decrypt like the active

523
00:16:54,899 --> 00:16:56,459
directory password and figure out if I

524
00:16:56,459 --> 00:16:58,079
could do like a replay attack against an

525
00:16:58,079 --> 00:17:01,019
80 server once I'm on the F5 again not a

526
00:17:01,019 --> 00:17:02,639
red team or somebody who is you probably

527
00:17:02,639 --> 00:17:05,099
could figure this out

528
00:17:05,099 --> 00:17:06,059
um but the other thing that when we're

529
00:17:06,059 --> 00:17:07,319
going to see this in the demo is because

530
00:17:07,319 --> 00:17:09,240
they're deployed in pairs you can find

531
00:17:09,240 --> 00:17:10,559
out a lot of stuff about the entire

532
00:17:10,559 --> 00:17:12,720
environment around this device just by

533
00:17:12,720 --> 00:17:14,160
using embedded commands it'll tell you

534
00:17:14,160 --> 00:17:15,540
about its peer devices it'll tell you

535
00:17:15,540 --> 00:17:16,980
about every other F5 that it knows about

536
00:17:16,980 --> 00:17:18,839
it's kind of like Cisco to Discovery

537
00:17:18,839 --> 00:17:21,000
protocol like they sort of all you know

538
00:17:21,000 --> 00:17:22,740
they become self-aware they know where

539
00:17:22,740 --> 00:17:24,720
everybody else is and so you can start

540
00:17:24,720 --> 00:17:26,339
discovering a whole lot about internal

541
00:17:26,339 --> 00:17:28,439
addressing schemes it'll tell you you

542
00:17:28,439 --> 00:17:29,760
know here's the pure device and here's

543
00:17:29,760 --> 00:17:31,200
all of the network interfaces that it

544
00:17:31,200 --> 00:17:32,820
has and all the subnets that it's on

545
00:17:32,820 --> 00:17:34,679
right so you get all sorts of mapping

546
00:17:34,679 --> 00:17:37,320
just by looking on one of these things

547
00:17:37,320 --> 00:17:39,480
um as far as finding them on showdan um

548
00:17:39,480 --> 00:17:40,799
there's a bunch of queries that I put

549
00:17:40,799 --> 00:17:42,419
together I have a GitHub I used to keep

550
00:17:42,419 --> 00:17:43,620
it updated

551
00:17:43,620 --> 00:17:45,240
um but yeah it's it's not there's not as

552
00:17:45,240 --> 00:17:47,400
many now I think in 2020 there was like

553
00:17:47,400 --> 00:17:49,260
15 000 with their management interfaces

554
00:17:49,260 --> 00:17:50,580
on the internet

555
00:17:50,580 --> 00:17:51,720
um this year when we saw this last

556
00:17:51,720 --> 00:17:53,100
exploit come out I think it was down

557
00:17:53,100 --> 00:17:54,720
around like seven or eight

558
00:17:54,720 --> 00:17:58,140
um so it's getting better maybe

559
00:17:58,140 --> 00:18:01,020
so quickly like I said you're on one of

560
00:18:01,020 --> 00:18:03,059
these things they have a concept of a

561
00:18:03,059 --> 00:18:05,039
traffic plane and a control plane I'm

562
00:18:05,039 --> 00:18:07,320
sorry yeah control plane and management

563
00:18:07,320 --> 00:18:09,360
plane no I'll probably screw that up

564
00:18:09,360 --> 00:18:11,220
anyways traffic management one of them

565
00:18:11,220 --> 00:18:12,900
you touch one of them you know

566
00:18:12,900 --> 00:18:14,340
um the tmn side is where their

567
00:18:14,340 --> 00:18:16,380
proprietary code is it's basically it

568
00:18:16,380 --> 00:18:17,820
takes over the entire device it takes

569
00:18:17,820 --> 00:18:19,260
over all the networking interfaces and

570
00:18:19,260 --> 00:18:20,880
then it gives back a certain percentage

571
00:18:20,880 --> 00:18:23,760
of resources to the Centos side

572
00:18:23,760 --> 00:18:24,660
um

573
00:18:24,660 --> 00:18:27,900
uh the central side so you can figure

574
00:18:27,900 --> 00:18:29,520
out your platform information right some

575
00:18:29,520 --> 00:18:31,080
of these things are small the one I

576
00:18:31,080 --> 00:18:32,400
think I showed you in my example was

577
00:18:32,400 --> 00:18:34,380
just running it on a VM so it gives you

578
00:18:34,380 --> 00:18:37,679
an idea of like how big of a box am I on

579
00:18:37,679 --> 00:18:39,120
um and then this other image is kind of

580
00:18:39,120 --> 00:18:40,559
the way their architecture works right

581
00:18:40,559 --> 00:18:42,360
they've got their Hardware stuff

582
00:18:42,360 --> 00:18:44,820
um their full proxy thing down there

583
00:18:44,820 --> 00:18:47,640
like if you have somebody even even if

584
00:18:47,640 --> 00:18:48,840
these devices are doing sort of

585
00:18:48,840 --> 00:18:50,280
end-to-end encryption right say they've

586
00:18:50,280 --> 00:18:52,200
got an encryption to the internet they

587
00:18:52,200 --> 00:18:53,820
decrypt it so they can use this eye roll

588
00:18:53,820 --> 00:18:55,320
stuff to manipulate their traffic and

589
00:18:55,320 --> 00:18:56,700
they re-encrypt it to the back-end

590
00:18:56,700 --> 00:18:59,220
servers like this is what banks do

591
00:18:59,220 --> 00:19:01,080
um if you can pack it capture on the

592
00:19:01,080 --> 00:19:02,280
internal essentially the traffic

593
00:19:02,280 --> 00:19:04,260
interface you can sniff encrypted

594
00:19:04,260 --> 00:19:05,580
traffic as it's going through the device

595
00:19:05,580 --> 00:19:07,080
or unencrypted traffic as it's going

596
00:19:07,080 --> 00:19:09,240
through the device obviously don't do

597
00:19:09,240 --> 00:19:10,500
this unless you really know what you're

598
00:19:10,500 --> 00:19:12,000
doing because if you've ever been a

599
00:19:12,000 --> 00:19:13,380
network person and you've tried to like

600
00:19:13,380 --> 00:19:15,480
pack a capture a 40 gigabit interface

601
00:19:15,480 --> 00:19:17,940
you can't just do that wide open um but

602
00:19:17,940 --> 00:19:19,559
you can and it's there

603
00:19:19,559 --> 00:19:21,299
on the management side it's a fully

604
00:19:21,299 --> 00:19:22,620
functional very operating so there's a

605
00:19:22,620 --> 00:19:25,440
fully fully functional Centos install

606
00:19:25,440 --> 00:19:27,539
um downside it does it has python 2 so

607
00:19:27,539 --> 00:19:29,039
all the cool hacker toys are written in

608
00:19:29,039 --> 00:19:31,380
Python 3 and most of those won't work

609
00:19:31,380 --> 00:19:32,580
um it doesn't have hip so you can't

610
00:19:32,580 --> 00:19:34,080
install anything they took all the

611
00:19:34,080 --> 00:19:36,419
compilers out but it's red hat or it's

612
00:19:36,419 --> 00:19:38,640
Centos if you were so inclined you could

613
00:19:38,640 --> 00:19:40,500
pick you know it's not Debian which is

614
00:19:40,500 --> 00:19:41,940
easy but you could figure out all the

615
00:19:41,940 --> 00:19:43,919
RPMs you needed and then just install

616
00:19:43,919 --> 00:19:45,419
all of them and you could probably get

617
00:19:45,419 --> 00:19:47,360
like a Metasploit to run on this thing

618
00:19:47,360 --> 00:19:49,679
there's really no controls on it they

619
00:19:49,679 --> 00:19:50,580
don't tell you you can't install

620
00:19:50,580 --> 00:19:52,440
software and the hard drive is huge so

621
00:19:52,440 --> 00:19:54,179
there's no like size constraints of like

622
00:19:54,179 --> 00:19:55,440
oh you know you only have enough to hold

623
00:19:55,440 --> 00:19:57,360
the operating system

624
00:19:57,360 --> 00:19:58,980
once you get on the device everything

625
00:19:58,980 --> 00:20:00,179
you care about is in a directory called

626
00:20:00,179 --> 00:20:02,340
slash config which we're going to talk a

627
00:20:02,340 --> 00:20:04,320
lot more about here in a minute and the

628
00:20:04,320 --> 00:20:05,640
interesting thing about these though is

629
00:20:05,640 --> 00:20:07,679
they're designed with a GUI right and

630
00:20:07,679 --> 00:20:09,539
they spent way more time writing their

631
00:20:09,539 --> 00:20:11,100
GUI than they ever did writing their

632
00:20:11,100 --> 00:20:12,419
command line

633
00:20:12,419 --> 00:20:14,760
um I don't know 15 years ago when I was

634
00:20:14,760 --> 00:20:16,940
working for them working with Microsoft

635
00:20:16,940 --> 00:20:18,960
instead of working for Microsoft

636
00:20:18,960 --> 00:20:21,660
Microsoft pretty much held them like

637
00:20:21,660 --> 00:20:23,460
held them hostage until they built a

638
00:20:23,460 --> 00:20:25,559
better shell like there was no shell

639
00:20:25,559 --> 00:20:27,360
there was no like Cisco style Shell at

640
00:20:27,360 --> 00:20:28,919
the time you basically could only use

641
00:20:28,919 --> 00:20:31,020
the GUI and somebody wrote a document

642
00:20:31,020 --> 00:20:33,480
saying have you tried to change the DNS

643
00:20:33,480 --> 00:20:36,539
servers on 1500 F5s and he did the math

644
00:20:36,539 --> 00:20:37,980
he was like it takes this long to log

645
00:20:37,980 --> 00:20:39,299
into the GUI I have to do this many

646
00:20:39,299 --> 00:20:40,500
clicks to do this thing I have to do

647
00:20:40,500 --> 00:20:41,700
this click he's like and now I have to

648
00:20:41,700 --> 00:20:43,980
do this 1500 times and it was like a

649
00:20:43,980 --> 00:20:45,360
week and a half or something was the

650
00:20:45,360 --> 00:20:47,460
time it took so everything has been

651
00:20:47,460 --> 00:20:48,840
designed for GUI and everything that I'm

652
00:20:48,840 --> 00:20:50,580
attacking is inside the command line and

653
00:20:50,580 --> 00:20:53,039
all on the low level file system so if

654
00:20:53,039 --> 00:20:54,419
you don't know how to look like you're

655
00:20:54,419 --> 00:20:56,400
never gonna find this

656
00:20:56,400 --> 00:20:57,660
um the other thing if you're you're

657
00:20:57,660 --> 00:20:58,919
going to start screwing around with

658
00:20:58,919 --> 00:21:01,620
these they share their stuff like the

659
00:21:01,620 --> 00:21:03,179
load balancing configuration is shared

660
00:21:03,179 --> 00:21:04,620
and they do have this sort of stateful

661
00:21:04,620 --> 00:21:06,480
intelligence between the two so if you

662
00:21:06,480 --> 00:21:08,039
make a change to anything that's a load

663
00:21:08,039 --> 00:21:10,080
balancing configuration the devices will

664
00:21:10,080 --> 00:21:11,220
pop a little alarm and say the

665
00:21:11,220 --> 00:21:13,080
configuration's out of sync

666
00:21:13,080 --> 00:21:15,539
um so that's a be delicate if you're

667
00:21:15,539 --> 00:21:16,799
going to go you know what you'll see

668
00:21:16,799 --> 00:21:19,080
here in the demo at the end but the

669
00:21:19,080 --> 00:21:21,419
device configs themselves are completely

670
00:21:21,419 --> 00:21:23,580
transparent like nothing it never tells

671
00:21:23,580 --> 00:21:25,500
anybody that hey somebody opened up a

672
00:21:25,500 --> 00:21:27,059
new port on this device or hey somebody

673
00:21:27,059 --> 00:21:29,280
added a new route to this device like

674
00:21:29,280 --> 00:21:30,900
you can do whatever you want and as long

675
00:21:30,900 --> 00:21:32,280
as it doesn't touch the load balancing

676
00:21:32,280 --> 00:21:36,020
config they're never going to know

677
00:21:36,360 --> 00:21:38,520
there we go so now we get to the fun

678
00:21:38,520 --> 00:21:40,380
part because like I said they have been

679
00:21:40,380 --> 00:21:41,580
sort of the Swiss army knife of

680
00:21:41,580 --> 00:21:43,799
networking and F5 was happy to cram any

681
00:21:43,799 --> 00:21:45,179
features and functionality that a

682
00:21:45,179 --> 00:21:48,299
customer asked for into their device

683
00:21:48,299 --> 00:21:50,580
so one of the things that got people bit

684
00:21:50,580 --> 00:21:53,340
Microsoft included was that they mostly

685
00:21:53,340 --> 00:21:54,480
you think okay there's a management

686
00:21:54,480 --> 00:21:56,340
interface as long as I keep my

687
00:21:56,340 --> 00:21:57,539
management interface in my management

688
00:21:57,539 --> 00:22:00,900
Network I'm safe yes and no by default

689
00:22:00,900 --> 00:22:02,520
all those those three addresses that

690
00:22:02,520 --> 00:22:04,860
that you have to use Reno hsrp thing the

691
00:22:04,860 --> 00:22:06,299
management interface gets turned on on

692
00:22:06,299 --> 00:22:08,820
all of those too and they don't tell you

693
00:22:08,820 --> 00:22:10,620
this it's just by default it gets turned

694
00:22:10,620 --> 00:22:12,720
on so what we saw was people saying my

695
00:22:12,720 --> 00:22:14,039
management interface is off the internet

696
00:22:14,039 --> 00:22:16,080
and we're like well yeah but the

697
00:22:16,080 --> 00:22:17,760
interface that your virtual servers are

698
00:22:17,760 --> 00:22:19,500
on like did you just allow that subnet

699
00:22:19,500 --> 00:22:20,820
into the DMZ where they're like yeah

700
00:22:20,820 --> 00:22:23,760
well then you have self IPS the gateway

701
00:22:23,760 --> 00:22:25,559
address is if it's accessible your

702
00:22:25,559 --> 00:22:27,240
management interface is enabled on that

703
00:22:27,240 --> 00:22:28,860
thing too and the people's eyes are like

704
00:22:28,860 --> 00:22:31,158
oh

705
00:22:31,380 --> 00:22:33,120
um then they started doing things like

706
00:22:33,120 --> 00:22:35,159
sharing routing tables now they're not

707
00:22:35,159 --> 00:22:36,600
the only ones that do this

708
00:22:36,600 --> 00:22:37,919
um some other vendors do the same thing

709
00:22:37,919 --> 00:22:39,539
but every other like I looked at Citrix

710
00:22:39,539 --> 00:22:42,600
Juniper Cisco they have this ability to

711
00:22:42,600 --> 00:22:45,000
say there's the traffic plane and it has

712
00:22:45,000 --> 00:22:46,320
its own routing table and then there's

713
00:22:46,320 --> 00:22:48,000
the management plane and it has its own

714
00:22:48,000 --> 00:22:49,620
routing table and never the two shall

715
00:22:49,620 --> 00:22:52,200
speak right with an F5 your management

716
00:22:52,200 --> 00:22:54,600
interface could have no Gateway but when

717
00:22:54,600 --> 00:22:56,460
I get on it if there's a default gateway

718
00:22:56,460 --> 00:22:58,320
to send out to the internet like I can

719
00:22:58,320 --> 00:22:59,880
use my malware on the management

720
00:22:59,880 --> 00:23:01,559
operating system to use the traffic

721
00:23:01,559 --> 00:23:03,360
route to get out to the internet

722
00:23:03,360 --> 00:23:06,360
not the best thing but it's by Design

723
00:23:06,360 --> 00:23:09,000
but my favorite is there's multiple ways

724
00:23:09,000 --> 00:23:10,740
that are in the code that lets you run

725
00:23:10,740 --> 00:23:13,440
scripts whenever you want

726
00:23:13,440 --> 00:23:15,000
um it has us these are documented

727
00:23:15,000 --> 00:23:16,320
Solutions on their website where they

728
00:23:16,320 --> 00:23:17,520
say this is how you can run a script

729
00:23:17,520 --> 00:23:18,900
when it boots up

730
00:23:18,900 --> 00:23:20,280
um these are scripts that you could run

731
00:23:20,280 --> 00:23:22,200
when the devices go active or standby

732
00:23:22,200 --> 00:23:24,600
you can run scripts when a specific log

733
00:23:24,600 --> 00:23:26,580
message is entered by syslog like I've

734
00:23:26,580 --> 00:23:28,020
never seen any other piece of gear that

735
00:23:28,020 --> 00:23:30,240
lets you like run code just when any

736
00:23:30,240 --> 00:23:31,860
little event happens

737
00:23:31,860 --> 00:23:34,380
and then the configs like I said are in

738
00:23:34,380 --> 00:23:36,600
this one directory and like a Cisco

739
00:23:36,600 --> 00:23:38,280
device a juniper device most of these

740
00:23:38,280 --> 00:23:39,480
things like if you want to save the

741
00:23:39,480 --> 00:23:40,980
configuration you basically back up just

742
00:23:40,980 --> 00:23:43,320
a text file right F5 on the other hand

743
00:23:43,320 --> 00:23:45,780
takes that directory it basically makes

744
00:23:45,780 --> 00:23:47,940
a tarball of the entire thing whatever

745
00:23:47,940 --> 00:23:50,039
is in that directory it does not care if

746
00:23:50,039 --> 00:23:51,900
it's a system file or not you could have

747
00:23:51,900 --> 00:23:53,820
accidentally like been writing a letter

748
00:23:53,820 --> 00:23:55,500
in VI and left in there it doesn't care

749
00:23:55,500 --> 00:23:57,000
whatever if it's in that directory it

750
00:23:57,000 --> 00:23:59,460
gets backed up it gets put into this

751
00:23:59,460 --> 00:24:02,039
config backup which is used for a bunch

752
00:24:02,039 --> 00:24:03,720
of things that we'll talk about and it's

753
00:24:03,720 --> 00:24:05,340
also got this massively deep directory

754
00:24:05,340 --> 00:24:07,620
structure of snapshots like I had to

755
00:24:07,620 --> 00:24:08,940
take this thing apart because I looked

756
00:24:08,940 --> 00:24:10,860
at their documentation and I was like oh

757
00:24:10,860 --> 00:24:12,299
it tells you what files are backed up

758
00:24:12,299 --> 00:24:13,799
and then I realized that it wasn't

759
00:24:13,799 --> 00:24:15,539
entirely accurate and I just took an

760
00:24:15,539 --> 00:24:17,700
archive put in an attempt directory

761
00:24:17,700 --> 00:24:19,260
untargeted it started digging through it

762
00:24:19,260 --> 00:24:21,179
and I was like my God there's so much

763
00:24:21,179 --> 00:24:22,320
stuff in here there's so many

764
00:24:22,320 --> 00:24:23,580
directories they don't even tell you

765
00:24:23,580 --> 00:24:25,080
about

766
00:24:25,080 --> 00:24:26,700
so

767
00:24:26,700 --> 00:24:28,679
now I knew Kung Fu and what you're

768
00:24:28,679 --> 00:24:30,299
watching here is the first of your demo

769
00:24:30,299 --> 00:24:33,360
videos where this device is going to log

770
00:24:33,360 --> 00:24:34,919
a syslog message and then it's going to

771
00:24:34,919 --> 00:24:37,620
call out to my C2 so that little script

772
00:24:37,620 --> 00:24:39,600
up there is the script that runs a

773
00:24:39,600 --> 00:24:42,240
command this is the system log from the

774
00:24:42,240 --> 00:24:43,980
F5 and now I'm going to go stop my

775
00:24:43,980 --> 00:24:45,600
Apache web server

776
00:24:45,600 --> 00:24:48,120
and we'll get into details of why this

777
00:24:48,120 --> 00:24:50,400
is taking so long in a second

778
00:24:50,400 --> 00:24:53,240
but eventually

779
00:24:55,679 --> 00:24:58,020
there we go the session gets popped back

780
00:24:58,020 --> 00:24:59,700
right Vlog message and all of a sudden I

781
00:24:59,700 --> 00:25:02,700
have C2 back to my command server

782
00:25:02,700 --> 00:25:06,240
so hack all the things get all the money

783
00:25:06,240 --> 00:25:07,919
um let me do it on time all right so

784
00:25:07,919 --> 00:25:09,600
what I basically used to do this was I

785
00:25:09,600 --> 00:25:11,580
used the exploit from this year

786
00:25:11,580 --> 00:25:13,620
um and I use the sliver C2 framework and

787
00:25:13,620 --> 00:25:15,600
I used a script that I got from f5's

788
00:25:15,600 --> 00:25:17,280
knowledge base

789
00:25:17,280 --> 00:25:19,320
um what I did was I took this script and

790
00:25:19,320 --> 00:25:21,059
I decided I want sort of the one script

791
00:25:21,059 --> 00:25:22,799
to rule them all I want this thing to

792
00:25:22,799 --> 00:25:25,440
obviously be able to start my malware I

793
00:25:25,440 --> 00:25:27,179
wanted to also be able to check for the

794
00:25:27,179 --> 00:25:28,620
existence of the malware on the system

795
00:25:28,620 --> 00:25:30,720
if it doesn't exist I wanted to be able

796
00:25:30,720 --> 00:25:33,480
to download this malware and and if it's

797
00:25:33,480 --> 00:25:35,279
uh and I also want this thing to survive

798
00:25:35,279 --> 00:25:37,740
through an upgrade a ripe or reboot and

799
00:25:37,740 --> 00:25:40,080
you know whatever it is so what it does

800
00:25:40,080 --> 00:25:42,059
is it basically when it runs it sleeps

801
00:25:42,059 --> 00:25:43,620
that's why you saw that delay it does a

802
00:25:43,620 --> 00:25:45,059
random sleep because I don't want it to

803
00:25:45,059 --> 00:25:47,880
ever start two copies of itself I chose

804
00:25:47,880 --> 00:25:51,059
a survey or a Daemon name based on I

805
00:25:51,059 --> 00:25:52,440
looked through their run service list in

806
00:25:52,440 --> 00:25:53,820
PS and I said okay there's all these run

807
00:25:53,820 --> 00:25:55,740
service you know these different daemons

808
00:25:55,740 --> 00:25:57,299
that are running and then I found one

809
00:25:57,299 --> 00:25:59,880
called rest Java D now rest Java d The

810
00:25:59,880 --> 00:26:01,740
Run service starts JRE which is this

811
00:26:01,740 --> 00:26:03,900
whole humongous hideous string but

812
00:26:03,900 --> 00:26:05,700
there's no actual process named that and

813
00:26:05,700 --> 00:26:07,200
I didn't know you know if I use one

814
00:26:07,200 --> 00:26:08,580
that's existing and I put it in a

815
00:26:08,580 --> 00:26:09,900
different directory if somebody does a

816
00:26:09,900 --> 00:26:11,640
pit of is it going to accidentally try

817
00:26:11,640 --> 00:26:13,080
to talk to the malware instead of the

818
00:26:13,080 --> 00:26:15,120
actual process and get me caught so what

819
00:26:15,120 --> 00:26:17,520
I do is the script will it starts up it

820
00:26:17,520 --> 00:26:19,320
sleeps it checks it is anything running

821
00:26:19,320 --> 00:26:21,480
if it's not do I have the malware on my

822
00:26:21,480 --> 00:26:24,720
system if I don't let me go bypass they

823
00:26:24,720 --> 00:26:26,039
have a security thing where they mount

824
00:26:26,039 --> 00:26:27,840
the user system read only because they

825
00:26:27,840 --> 00:26:29,100
think nobody's going to be able to hack

826
00:26:29,100 --> 00:26:31,440
it so I remounted read write I download

827
00:26:31,440 --> 00:26:34,020
my malware make it executable and then I

828
00:26:34,020 --> 00:26:36,360
time stomp it by taking the time stamp

829
00:26:36,360 --> 00:26:38,580
of one of the system CTO binaries in the

830
00:26:38,580 --> 00:26:40,620
same directory stop the time thing

831
00:26:40,620 --> 00:26:42,419
mounted read only again and then start

832
00:26:42,419 --> 00:26:44,220
it the idea is if you're like what is

833
00:26:44,220 --> 00:26:45,720
you look on a box you say okay well this

834
00:26:45,720 --> 00:26:46,980
looks like a right process you look

835
00:26:46,980 --> 00:26:48,960
inside user bid everything has the same

836
00:26:48,960 --> 00:26:51,659
time stamp there's no new files in there

837
00:26:51,659 --> 00:26:56,279
um and yeah at that point I'm in so then

838
00:26:56,279 --> 00:26:58,140
I'm also writing the start I'm writing

839
00:26:58,140 --> 00:26:59,640
this round that I called a runner script

840
00:26:59,640 --> 00:27:01,020
I write this to these failover

841
00:27:01,020 --> 00:27:03,539
configuration files so that when the

842
00:27:03,539 --> 00:27:05,460
device goes back or forth it'll always

843
00:27:05,460 --> 00:27:06,840
make sure it'll always at least start

844
00:27:06,840 --> 00:27:08,460
and maybe it starts up it's like nope my

845
00:27:08,460 --> 00:27:09,659
implant's already running I'm just going

846
00:27:09,659 --> 00:27:11,700
to go back to sleep or hey it's a new

847
00:27:11,700 --> 00:27:13,080
box that they just installed I need to

848
00:27:13,080 --> 00:27:15,720
go grab my malware and put it on there

849
00:27:15,720 --> 00:27:17,640
and like I said this prevents you know

850
00:27:17,640 --> 00:27:18,960
somebody logging me like why are there

851
00:27:18,960 --> 00:27:20,760
500 of this process running like that

852
00:27:20,760 --> 00:27:23,159
seems weird that seems suspicious

853
00:27:23,159 --> 00:27:24,600
um and those persistence files gets

854
00:27:24,600 --> 00:27:26,340
backed up right and instead of me I'm

855
00:27:26,340 --> 00:27:28,500
using sliver which is cool because it's

856
00:27:28,500 --> 00:27:30,840
it runs on a pretty much every OS the

857
00:27:30,840 --> 00:27:32,400
downside is the implants are like 15

858
00:27:32,400 --> 00:27:34,620
Megs so I was initially gonna I was

859
00:27:34,620 --> 00:27:36,720
going to put all the stuff in the config

860
00:27:36,720 --> 00:27:37,860
directory but I was like man somebody

861
00:27:37,860 --> 00:27:39,539
would notice if they did a config backup

862
00:27:39,539 --> 00:27:41,460
and instead of it being like one and a

863
00:27:41,460 --> 00:27:42,900
half bags all of a sudden it's like 17

864
00:27:42,900 --> 00:27:44,460
Megs they'd be like well that's weird

865
00:27:44,460 --> 00:27:46,140
that file is huge compared to all the

866
00:27:46,140 --> 00:27:48,419
other ones on our file server so I just

867
00:27:48,419 --> 00:27:49,740
figured make a tiny little script that

868
00:27:49,740 --> 00:27:51,480
nobody's going to notice

869
00:27:51,480 --> 00:27:53,760
oh I clicked back

870
00:27:53,760 --> 00:27:56,640
so the other fun thing because of these

871
00:27:56,640 --> 00:27:58,140
devices and there's a funny story that

872
00:27:58,140 --> 00:27:59,220
I'm going to go through with you here

873
00:27:59,220 --> 00:28:01,679
these devices don't allow servers behind

874
00:28:01,679 --> 00:28:03,600
them to talk to the Internet by default

875
00:28:03,600 --> 00:28:05,340
um they can read they they restrict this

876
00:28:05,340 --> 00:28:07,740
like with the presence or the absence of

877
00:28:07,740 --> 00:28:09,539
like an outbound Nat like think your

878
00:28:09,539 --> 00:28:11,100
home cable router

879
00:28:11,100 --> 00:28:12,360
um and then you actually have to enable

880
00:28:12,360 --> 00:28:14,100
it say yes this serve this VLAN is

881
00:28:14,100 --> 00:28:15,419
allowed to talk to the internet and as

882
00:28:15,419 --> 00:28:16,980
long as there's an egress IP on that

883
00:28:16,980 --> 00:28:18,659
Network then everything's hunky-dory so

884
00:28:18,659 --> 00:28:21,240
this this F5 encased in a block of ice

885
00:28:21,240 --> 00:28:23,279
is keeping everything very cold and very

886
00:28:23,279 --> 00:28:25,140
secure right

887
00:28:25,140 --> 00:28:26,880
um the sliver allows you to do pivoting

888
00:28:26,880 --> 00:28:28,919
so for those who were like me and

889
00:28:28,919 --> 00:28:30,240
learning about this it means I can set

890
00:28:30,240 --> 00:28:31,679
up a C2 and then I can pivot other

891
00:28:31,679 --> 00:28:33,539
systems through my C2 back out to the

892
00:28:33,539 --> 00:28:34,860
internet

893
00:28:34,860 --> 00:28:37,320
now F5 lets you actually attach it so

894
00:28:37,320 --> 00:28:39,059
you'd like a listener IP to one of the

895
00:28:39,059 --> 00:28:40,440
system addresses like it doesn't care

896
00:28:40,440 --> 00:28:42,419
your root and it doesn't have any way to

897
00:28:42,419 --> 00:28:43,980
differentiate like is this something

898
00:28:43,980 --> 00:28:45,720
that I should do or did this weird

899
00:28:45,720 --> 00:28:47,460
process that actually doesn't have a

900
00:28:47,460 --> 00:28:49,860
show wants to bind to a port like YOLO

901
00:28:49,860 --> 00:28:51,480
that seems fine to me

902
00:28:51,480 --> 00:28:53,400
and you can change the apples on the

903
00:28:53,400 --> 00:28:55,440
interfaces to let your implants in

904
00:28:55,440 --> 00:28:57,120
without anybody noticing like I said

905
00:28:57,120 --> 00:28:58,679
device specific things there's no

906
00:28:58,679 --> 00:29:00,600
logging there's no alerting so you know

907
00:29:00,600 --> 00:29:01,919
you don't even have to be sneaky you

908
00:29:01,919 --> 00:29:03,960
know real sneaky right so now that I've

909
00:29:03,960 --> 00:29:05,100
done this

910
00:29:05,100 --> 00:29:07,919
I'm able to Pivot my traffic my

911
00:29:07,919 --> 00:29:09,600
delicious traffic is now pivoted out

912
00:29:09,600 --> 00:29:11,880
through my very cold firewall into my

913
00:29:11,880 --> 00:29:14,159
waiting C2 Cup and the story behind this

914
00:29:14,159 --> 00:29:16,200
is this is one of the uh these are one

915
00:29:16,200 --> 00:29:17,580
of the first of the chassis load

916
00:29:17,580 --> 00:29:19,380
balancers that F5 made they were

917
00:29:19,380 --> 00:29:21,120
deployed at Xbox Live's Network when

918
00:29:21,120 --> 00:29:23,940
Xbox Live first became online they gave

919
00:29:23,940 --> 00:29:25,919
them so much of a headache that instead

920
00:29:25,919 --> 00:29:27,419
of like refurbing them or selling them

921
00:29:27,419 --> 00:29:30,059
on eBay they took a 450 000 load

922
00:29:30,059 --> 00:29:33,120
balancer rewired all the LEDs encased it

923
00:29:33,120 --> 00:29:34,679
in a block of ice and turned it into a

924
00:29:34,679 --> 00:29:36,720
beer tap for their Christmas party like

925
00:29:36,720 --> 00:29:38,159
I know that people don't like stuff but

926
00:29:38,159 --> 00:29:40,020
that's like office space printer like

927
00:29:40,020 --> 00:29:43,200
not you have no comparison to putting

928
00:29:43,200 --> 00:29:44,580
half a million dollar piece of gear just

929
00:29:44,580 --> 00:29:47,220
soaked in ice and beer but it was a it

930
00:29:47,220 --> 00:29:49,260
was a good party

931
00:29:49,260 --> 00:29:51,840
so what are we doing outside all right

932
00:29:51,840 --> 00:29:53,340
we're doing okay so the low level

933
00:29:53,340 --> 00:29:54,600
persistence

934
00:29:54,600 --> 00:29:56,220
um

935
00:29:56,220 --> 00:29:59,279
okay there we go so this is like I said

936
00:29:59,279 --> 00:30:01,200
the backups this backup directory that

937
00:30:01,200 --> 00:30:02,520
people use

938
00:30:02,520 --> 00:30:04,500
um it's used for it has pretty much

939
00:30:04,500 --> 00:30:06,299
everything the documentation like I said

940
00:30:06,299 --> 00:30:07,620
it tries to tell you what files are

941
00:30:07,620 --> 00:30:09,600
backed up it turns out that some of the

942
00:30:09,600 --> 00:30:11,340
stuff they say isn't backed up is some

943
00:30:11,340 --> 00:30:13,200
of the stuff they say is backed up isn't

944
00:30:13,200 --> 00:30:14,520
and then there's just random places

945
00:30:14,520 --> 00:30:16,200
where they just grab an entire directory

946
00:30:16,200 --> 00:30:17,760
and I can't figure out why so there can

947
00:30:17,760 --> 00:30:19,080
I basically was like I said I had to

948
00:30:19,080 --> 00:30:20,340
unpack it and say well let me just look

949
00:30:20,340 --> 00:30:22,860
at what it does on a device

950
00:30:22,860 --> 00:30:24,659
um so anything in there there you know

951
00:30:24,659 --> 00:30:26,279
there's no signatures there's no hashing

952
00:30:26,279 --> 00:30:27,960
there's no list of trusted the list of

953
00:30:27,960 --> 00:30:30,419
trusted files doesn't actually work and

954
00:30:30,419 --> 00:30:32,580
what you're seeing here is loading a

955
00:30:32,580 --> 00:30:34,620
dirty config file on a device and I had

956
00:30:34,620 --> 00:30:35,880
to speed it up because these things are

957
00:30:35,880 --> 00:30:38,279
slow but I loaded dirty config and then

958
00:30:38,279 --> 00:30:40,140
click the implant start so this is what

959
00:30:40,140 --> 00:30:41,460
would happen if you had wiped your

960
00:30:41,460 --> 00:30:43,080
machine say okay take a config backup

961
00:30:43,080 --> 00:30:45,179
wipe the machine take a config back up

962
00:30:45,179 --> 00:30:47,580
buy a new one stick it on here we want

963
00:30:47,580 --> 00:30:49,080
to make sure the malware is gone well

964
00:30:49,080 --> 00:30:51,240
now yes this is predicated on the device

965
00:30:51,240 --> 00:30:52,620
being able to talk to the internet or

966
00:30:52,620 --> 00:30:54,720
wherever it gets its C2 but you know

967
00:30:54,720 --> 00:30:56,399
details details

968
00:30:56,399 --> 00:30:58,679
so here's the blue team stuff this is

969
00:30:58,679 --> 00:31:00,120
about the only thing and blue teamers

970
00:31:00,120 --> 00:31:02,039
are going to get on this talk these

971
00:31:02,039 --> 00:31:03,360
files are what I'm abusing there's a

972
00:31:03,360 --> 00:31:05,220
file called config startup which as you

973
00:31:05,220 --> 00:31:06,600
might imagine is what runs when you

974
00:31:06,600 --> 00:31:08,340
start up the device there's a directory

975
00:31:08,340 --> 00:31:10,080
called failover with a bunch of files

976
00:31:10,080 --> 00:31:12,179
that you can write to that run scripts

977
00:31:12,179 --> 00:31:14,399
when things change State and then the

978
00:31:14,399 --> 00:31:16,559
syslog message is in this user alert con

979
00:31:16,559 --> 00:31:19,140
so if you're ever doing a d fear

980
00:31:19,140 --> 00:31:20,580
engagement or something weird happened

981
00:31:20,580 --> 00:31:22,500
those are the files you want to check

982
00:31:22,500 --> 00:31:24,659
first right you can also check the RC

983
00:31:24,659 --> 00:31:27,419
files you can check cront Tab and the

984
00:31:27,419 --> 00:31:29,039
script cuties will probably use those I

985
00:31:29,039 --> 00:31:32,100
mean the UNC groups but they don't get

986
00:31:32,100 --> 00:31:34,260
saved so you know there's no point in

987
00:31:34,260 --> 00:31:35,520
writing to cron because they actually

988
00:31:35,520 --> 00:31:37,980
oddly enough don't backup cron in their

989
00:31:37,980 --> 00:31:39,720
config backup so if you created a bunch

990
00:31:39,720 --> 00:31:41,700
of you know archive jobs and back up

991
00:31:41,700 --> 00:31:43,799
your config jobs in cron like your Sol

992
00:31:43,799 --> 00:31:46,020
because you have to recreate those when

993
00:31:46,020 --> 00:31:47,700
you put your new device in place it's

994
00:31:47,700 --> 00:31:50,220
kind of backwards

995
00:31:50,220 --> 00:31:51,960
um but the other thing is their upgrade

996
00:31:51,960 --> 00:31:55,200
process right so instead of because it's

997
00:31:55,200 --> 00:31:57,120
not just a flat file like I think I

998
00:31:57,120 --> 00:31:59,100
mentioned when it upgrades it it's you

999
00:31:59,100 --> 00:32:00,840
basically say hang on so I want to patch

1000
00:32:00,840 --> 00:32:02,220
this machine you're obviously not going

1001
00:32:02,220 --> 00:32:04,140
to patch a running machine it takes the

1002
00:32:04,140 --> 00:32:05,940
OS it puts it into a boot location it

1003
00:32:05,940 --> 00:32:07,620
takes the you know patch it puts it in

1004
00:32:07,620 --> 00:32:09,659
the patch there over the OS and then it

1005
00:32:09,659 --> 00:32:11,460
zips up the config directory and it

1006
00:32:11,460 --> 00:32:13,080
plops it on the other side

1007
00:32:13,080 --> 00:32:15,360
now because it's basically laying down a

1008
00:32:15,360 --> 00:32:17,159
fresh copy of the operating system my

1009
00:32:17,159 --> 00:32:19,200
fancy little trick of hiding in user bin

1010
00:32:19,200 --> 00:32:21,360
well it's not going to go there but the

1011
00:32:21,360 --> 00:32:22,740
fact is you took the script that loads

1012
00:32:22,740 --> 00:32:24,299
the malware with your config backup and

1013
00:32:24,299 --> 00:32:25,799
you plopped it into your new install and

1014
00:32:25,799 --> 00:32:27,179
then you booted it up and so that

1015
00:32:27,179 --> 00:32:29,460
process that you saw or you're seeing

1016
00:32:29,460 --> 00:32:31,080
right now just happens as soon as you

1017
00:32:31,080 --> 00:32:33,000
turn it on right yeah I made this as

1018
00:32:33,000 --> 00:32:35,880
hard to get rid of as possible um

1019
00:32:35,880 --> 00:32:38,700
so now it's demo time the actual fun

1020
00:32:38,700 --> 00:32:41,460
logger format demo and we're gonna this

1021
00:32:41,460 --> 00:32:42,899
has music we're going to see if it works

1022
00:32:42,899 --> 00:32:44,220
and if it hopefully doesn't kill your

1023
00:32:44,220 --> 00:32:45,840
eardrums and I'm going to narrate this

1024
00:32:45,840 --> 00:32:48,360
because it's complex and I need you to I

1025
00:32:48,360 --> 00:32:51,380
need to explain what's going on

1026
00:32:51,380 --> 00:32:53,600
a little lower

1027
00:32:53,600 --> 00:32:55,799
all right so what I'm doing here is

1028
00:32:55,799 --> 00:32:57,360
basically just showing you I'm going to

1029
00:32:57,360 --> 00:33:00,179
turn that down just a tiny bit more

1030
00:33:00,179 --> 00:33:01,980
there we go so what I'm doing here is

1031
00:33:01,980 --> 00:33:03,659
just showing you this is my setup right

1032
00:33:03,659 --> 00:33:05,760
in the top you'll notice that these

1033
00:33:05,760 --> 00:33:08,120
things are in sync this is the logging

1034
00:33:08,120 --> 00:33:11,039
what I'm doing is basically showing that

1035
00:33:11,039 --> 00:33:13,440
I found a big IP and this is what poor

1036
00:33:13,440 --> 00:33:15,120
opsec will look like right so these are

1037
00:33:15,120 --> 00:33:17,100
the system logs okay now it sees that

1038
00:33:17,100 --> 00:33:18,240
somebody's running on command on the

1039
00:33:18,240 --> 00:33:20,820
device right that's bad fortunately this

1040
00:33:20,820 --> 00:33:23,340
exploit allows me to turn off syslog so

1041
00:33:23,340 --> 00:33:25,380
being a good hacker I turn off this log

1042
00:33:25,380 --> 00:33:27,000
it even tells me hey we're shut down

1043
00:33:27,000 --> 00:33:28,380
syslog for you which I think was

1044
00:33:28,380 --> 00:33:30,360
beautiful so now I can start discovering

1045
00:33:30,360 --> 00:33:32,100
the pure device right so I know there's

1046
00:33:32,100 --> 00:33:34,200
one where there's one there's two I can

1047
00:33:34,200 --> 00:33:35,640
see there's another box but I can't

1048
00:33:35,640 --> 00:33:38,039
really see how to get to it so I need to

1049
00:33:38,039 --> 00:33:39,840
figure out how many devices are in this

1050
00:33:39,840 --> 00:33:41,760
group so I find out okay there's two

1051
00:33:41,760 --> 00:33:44,519
obviously the other one's named big-ip2

1052
00:33:44,519 --> 00:33:46,980
so I figure out these are all commands

1053
00:33:46,980 --> 00:33:48,720
to list it and now I've got the

1054
00:33:48,720 --> 00:33:50,519
addresses of the secondary device by

1055
00:33:50,519 --> 00:33:52,679
talking to the first device so of course

1056
00:33:52,679 --> 00:33:54,120
let's shut off syslog on the other one

1057
00:33:54,120 --> 00:33:55,740
we don't want to get caught

1058
00:33:55,740 --> 00:33:57,480
and then what we're going to do is I'm

1059
00:33:57,480 --> 00:33:58,980
going to throw this very ugly command

1060
00:33:58,980 --> 00:34:01,740
which is the throw the exploit load the

1061
00:34:01,740 --> 00:34:03,539
uh load the implants

1062
00:34:03,539 --> 00:34:06,480
start the implant on one of them

1063
00:34:06,480 --> 00:34:08,159
this is an artifact of the way the

1064
00:34:08,159 --> 00:34:10,619
exploit works on the other one I'm just

1065
00:34:10,619 --> 00:34:12,540
going to basically tell it download the

1066
00:34:12,540 --> 00:34:14,099
implant and write to my persistence

1067
00:34:14,099 --> 00:34:16,020
files but I don't start it so now I can

1068
00:34:16,020 --> 00:34:17,699
see okay I've got a session on this

1069
00:34:17,699 --> 00:34:20,099
device I'm going to make it active and

1070
00:34:20,099 --> 00:34:21,359
now I'm going to set up my Pivot

1071
00:34:21,359 --> 00:34:23,399
listener on the F5 so I can hack into

1072
00:34:23,399 --> 00:34:25,739
the Windows Server later

1073
00:34:25,739 --> 00:34:27,060
um you know it binds to the port no

1074
00:34:27,060 --> 00:34:30,000
problem we add the firewall thing both

1075
00:34:30,000 --> 00:34:31,679
of them you'll notice still say in sync

1076
00:34:31,679 --> 00:34:33,000
nothing's happening system normal

1077
00:34:33,000 --> 00:34:35,520
everybody's fine here how are you

1078
00:34:35,520 --> 00:34:38,879
so this side I'm going to use Metasploit

1079
00:34:38,879 --> 00:34:40,320
um and I go in first I'm going to I'm

1080
00:34:40,320 --> 00:34:41,280
going to do the same thing I'm going to

1081
00:34:41,280 --> 00:34:43,739
hack into one of the F5s the demo gods

1082
00:34:43,739 --> 00:34:44,940
were not kind to me there but I wasn't

1083
00:34:44,940 --> 00:34:46,440
going to redo it so I hacked into the

1084
00:34:46,440 --> 00:34:48,659
other one and this time I actually got a

1085
00:34:48,659 --> 00:34:50,639
shell that was usable

1086
00:34:50,639 --> 00:34:53,159
so now I've got a shell on this F5 I can

1087
00:34:53,159 --> 00:34:54,899
go and run the Metasploit port scan

1088
00:34:54,899 --> 00:34:56,820
module to say hey is there any Windows

1089
00:34:56,820 --> 00:34:59,220
servers behind this device right but

1090
00:34:59,220 --> 00:35:00,420
pretending I don't know where I'm at

1091
00:35:00,420 --> 00:35:02,940
right okay Port Stan lo and behold

1092
00:35:02,940 --> 00:35:05,339
there's a Windows Server it doesn't have

1093
00:35:05,339 --> 00:35:06,660
access to the internet I didn't have

1094
00:35:06,660 --> 00:35:08,220
enough time to show you but trust me it

1095
00:35:08,220 --> 00:35:09,240
didn't

1096
00:35:09,240 --> 00:35:10,619
um so now I'm like well it's a Windows

1097
00:35:10,619 --> 00:35:12,240
Server I'll bet that vulnerability that

1098
00:35:12,240 --> 00:35:13,619
I shipped a patch for didn't actually

1099
00:35:13,619 --> 00:35:16,380
get installed because nobody did so we

1100
00:35:16,380 --> 00:35:18,960
used the ms-1710 exploit

1101
00:35:18,960 --> 00:35:21,119
we get a shell

1102
00:35:21,119 --> 00:35:23,160
In fairness I cheated I uploaded the

1103
00:35:23,160 --> 00:35:25,200
implant beforehand because my VM lab is

1104
00:35:25,200 --> 00:35:26,280
slow and you would have had to sit here

1105
00:35:26,280 --> 00:35:27,599
for like seven minutes watching it

1106
00:35:27,599 --> 00:35:29,880
upload but now I start it it's pivoted

1107
00:35:29,880 --> 00:35:31,680
back through my F5 so I have my F5

1108
00:35:31,680 --> 00:35:33,300
device so now I've got my Windows Server

1109
00:35:33,300 --> 00:35:36,060
that's talking through my F5 to my C2

1110
00:35:36,060 --> 00:35:39,720
so you know never one to you know to

1111
00:35:39,720 --> 00:35:42,839
stop there I drop into the shell this is

1112
00:35:42,839 --> 00:35:43,980
where I'm going to show you how the eye

1113
00:35:43,980 --> 00:35:46,920
rolls abuse can happen right so you'll

1114
00:35:46,920 --> 00:35:49,440
notice as in a second what I'm doing is

1115
00:35:49,440 --> 00:35:51,000
I'm creating the rule

1116
00:35:51,000 --> 00:35:53,099
this is a very simple rule I don't I'm

1117
00:35:53,099 --> 00:35:54,960
not a JavaScript programmer I didn't

1118
00:35:54,960 --> 00:35:57,000
want to learn so I'm just tweaking this

1119
00:35:57,000 --> 00:35:58,560
thing and as soon as I save this file

1120
00:35:58,560 --> 00:36:00,000
you'll notice that devices are going to

1121
00:36:00,000 --> 00:36:02,640
say change is pending right this is how

1122
00:36:02,640 --> 00:36:04,020
you get yourself caught right if

1123
00:36:04,020 --> 00:36:06,420
somebody if somebody was watching they

1124
00:36:06,420 --> 00:36:07,740
would notice will something just change

1125
00:36:07,740 --> 00:36:09,300
right but you can also have it set an

1126
00:36:09,300 --> 00:36:10,920
SNMP trap when this happens or better

1127
00:36:10,920 --> 00:36:12,619
yet log a message

1128
00:36:12,619 --> 00:36:15,780
so I run the config sync command and now

1129
00:36:15,780 --> 00:36:18,000
they're both back in sync so okay nobody

1130
00:36:18,000 --> 00:36:19,680
noticed that I created this Rule and I

1131
00:36:19,680 --> 00:36:21,180
bound this rule to the web server that

1132
00:36:21,180 --> 00:36:22,740
we just looked at

1133
00:36:22,740 --> 00:36:25,020
however when our poor user tries to go

1134
00:36:25,020 --> 00:36:26,760
back to goodguy.com

1135
00:36:26,760 --> 00:36:28,500
turns out they can't go to good guy.com

1136
00:36:28,500 --> 00:36:29,880
anymore right now and this could be

1137
00:36:29,880 --> 00:36:31,320
something like you could if you're smart

1138
00:36:31,320 --> 00:36:32,700
smarter than me you could put a

1139
00:36:32,700 --> 00:36:34,140
keystroke log or you could put any sort

1140
00:36:34,140 --> 00:36:36,420
of malicious stuff in someone's website

1141
00:36:36,420 --> 00:36:38,040
so you know you all of a sudden your

1142
00:36:38,040 --> 00:36:39,599
commute users complain oh my God my

1143
00:36:39,599 --> 00:36:41,220
website's gone so you know being a very

1144
00:36:41,220 --> 00:36:43,320
good sys admin you're like well shoot we

1145
00:36:43,320 --> 00:36:45,119
need to do uh we need to do do D Fair

1146
00:36:45,119 --> 00:36:46,560
let's fail over the device to the other

1147
00:36:46,560 --> 00:36:49,200
one click standby comes back up now I

1148
00:36:49,200 --> 00:36:51,240
have both right this was the idea it was

1149
00:36:51,240 --> 00:36:52,980
you can't get rid of me when I do it

1150
00:36:52,980 --> 00:36:54,240
this way

1151
00:36:54,240 --> 00:36:58,098
so yeah that's the demo

1152
00:37:00,300 --> 00:37:03,240
now

1153
00:37:03,240 --> 00:37:06,119
I'm not done not yet almost so if you

1154
00:37:06,119 --> 00:37:07,859
want to do this yourself uh it turns out

1155
00:37:07,859 --> 00:37:09,720
it's a lot easier to build an F5 hacking

1156
00:37:09,720 --> 00:37:11,460
lab than you would think

1157
00:37:11,460 --> 00:37:13,140
um you just they give away virtual

1158
00:37:13,140 --> 00:37:15,540
Edition VMS for every major hypervisor

1159
00:37:15,540 --> 00:37:18,480
out there including vulnerable versions

1160
00:37:18,480 --> 00:37:20,700
if you want to go play around with these

1161
00:37:20,700 --> 00:37:21,960
exploits that are on the internet just

1162
00:37:21,960 --> 00:37:23,339
figure out what versions are vulnerable

1163
00:37:23,339 --> 00:37:25,140
and go get the VM that's vulnerable like

1164
00:37:25,140 --> 00:37:27,119
I've never heard of a software company

1165
00:37:27,119 --> 00:37:28,859
giving well actually I correct myself

1166
00:37:28,859 --> 00:37:30,780
because I got a VM of Windows 2012

1167
00:37:30,780 --> 00:37:32,700
without the Ms 1710 patch so I guess

1168
00:37:32,700 --> 00:37:34,079
they're just aspiring to be like

1169
00:37:34,079 --> 00:37:35,720
Microsoft

1170
00:37:35,720 --> 00:37:38,220
but the best part about this is you can

1171
00:37:38,220 --> 00:37:40,260
use a I mean those devices were licensed

1172
00:37:40,260 --> 00:37:42,240
that was a fully functional pair of F5s

1173
00:37:42,240 --> 00:37:44,220
when you just download and install it

1174
00:37:44,220 --> 00:37:46,859
they won't work however use a throwaway

1175
00:37:46,859 --> 00:37:48,540
email account like one of those website

1176
00:37:48,540 --> 00:37:50,400
ones that you use for logging in for

1177
00:37:50,400 --> 00:37:52,859
like giving it to spammers use one of

1178
00:37:52,859 --> 00:37:54,660
those set up an account that's how you

1179
00:37:54,660 --> 00:37:56,280
get to their download system anyways and

1180
00:37:56,280 --> 00:37:57,660
then go and say I want some trial

1181
00:37:57,660 --> 00:37:59,579
licenses and F5 will gladly give you

1182
00:37:59,579 --> 00:38:01,800
three 30-day time limited licenses for

1183
00:38:01,800 --> 00:38:03,839
their virtual product and you can do

1184
00:38:03,839 --> 00:38:05,520
this as many times as you want I think

1185
00:38:05,520 --> 00:38:07,560
I've gone through about 30 or 40 of

1186
00:38:07,560 --> 00:38:09,720
these things in like the last six months

1187
00:38:09,720 --> 00:38:11,760
because I kept burning down my lab and

1188
00:38:11,760 --> 00:38:12,900
building it up with different versions

1189
00:38:12,900 --> 00:38:15,359
and fiddling with stuff like and you can

1190
00:38:15,359 --> 00:38:17,339
also get the iso images too so like the

1191
00:38:17,339 --> 00:38:19,320
guy that found that SSH key thing if you

1192
00:38:19,320 --> 00:38:20,700
want to go and start digging around and

1193
00:38:20,700 --> 00:38:22,440
finding out how woefully out of date

1194
00:38:22,440 --> 00:38:24,240
some of the modules and the code that

1195
00:38:24,240 --> 00:38:26,400
they have in there grab an ISO unpack it

1196
00:38:26,400 --> 00:38:28,140
dig around now they don't have a bounty

1197
00:38:28,140 --> 00:38:29,520
program so all you're really going to

1198
00:38:29,520 --> 00:38:31,200
get is street cred for your cves you're

1199
00:38:31,200 --> 00:38:32,940
not going to actually get any money for

1200
00:38:32,940 --> 00:38:35,460
it but maybe I'll talk about your

1201
00:38:35,460 --> 00:38:36,960
exploit or your vulnerability in my next

1202
00:38:36,960 --> 00:38:38,280
talk

1203
00:38:38,280 --> 00:38:40,980
and that is actually all I had if

1204
00:38:40,980 --> 00:38:43,079
there's any questions I think I've got

1205
00:38:43,079 --> 00:38:45,060
actually a little bit on time I got like

1206
00:38:45,060 --> 00:38:48,560
four minutes for questions it looks like

1207
00:38:49,740 --> 00:38:52,200
oh and by the way here's the Tom when I

1208
00:38:52,200 --> 00:38:53,400
said wait I made this for you guys

1209
00:38:53,400 --> 00:38:56,339
that's yeah so I was on the roof the

1210
00:38:56,339 --> 00:38:57,540
other night and I was like that's just a

1211
00:38:57,540 --> 00:38:59,460
gorgeous view so I had to go and

1212
00:38:59,460 --> 00:39:01,619
customize it but yeah you're the first

1213
00:39:01,619 --> 00:39:04,640
conference I've done that for

1214
00:39:05,940 --> 00:39:08,839
speechless

1215
00:39:08,880 --> 00:39:10,079
okay

1216
00:39:10,079 --> 00:39:11,520
all right well if there's no questions

1217
00:39:11,520 --> 00:39:13,079
thank you for coming to see me thank you

1218
00:39:13,079 --> 00:39:16,099
brewcon for having me

