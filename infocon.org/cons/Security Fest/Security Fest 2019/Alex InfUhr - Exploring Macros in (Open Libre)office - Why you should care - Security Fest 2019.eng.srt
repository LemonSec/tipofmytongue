1
00:00:00,030 --> 00:00:05,819
so welcome that you're actually watching

2
00:00:02,220 --> 00:00:08,189
my talk exploring macros in libreoffice

3
00:00:05,819 --> 00:00:12,240
and white could be actually interesting

4
00:00:08,189 --> 00:00:15,750
for you yes i'm stuff about me my name

5
00:00:12,240 --> 00:00:20,250
is alex i'm called in said script on

6
00:00:15,750 --> 00:00:24,420
twitter i also have a really awesome

7
00:00:20,250 --> 00:00:27,090
blog no but actually every finding i

8
00:00:24,420 --> 00:00:30,150
have and i'm allowed to publish is on my

9
00:00:27,090 --> 00:00:33,510
blog so in case anything is unclear or

10
00:00:30,150 --> 00:00:37,800
i'm talking too fast you will most

11
00:00:33,510 --> 00:00:40,079
likely find a blog post about it

12
00:00:37,800 --> 00:00:44,129
i'm working in a Paris as a penetration

13
00:00:40,079 --> 00:00:49,129
tester for cue 53 like this gentleman

14
00:00:44,129 --> 00:00:52,949
here I'm mostly a browser and web guy

15
00:00:49,129 --> 00:00:58,160
but I started six years ago

16
00:00:52,949 --> 00:01:01,829
to learn about PDF and how it works and

17
00:00:58,160 --> 00:01:05,670
yeah I've actually spent all the six

18
00:01:01,829 --> 00:01:11,640
years on PDF so yeah it's a nice read

19
00:01:05,670 --> 00:01:15,560
and so I decided last year to move on to

20
00:01:11,640 --> 00:01:16,950
another file format besides that I

21
00:01:15,560 --> 00:01:18,450
flavor

22
00:01:16,950 --> 00:01:22,950
I don't know counter-strike and I watch

23
00:01:18,450 --> 00:01:27,450
CDP shark movies this is kind of this is

24
00:01:22,950 --> 00:01:32,159
kind of important so what will be

25
00:01:27,450 --> 00:01:37,970
discussed today a really simple overview

26
00:01:32,159 --> 00:01:41,520
how I start learning a new file format I

27
00:01:37,970 --> 00:01:46,369
will talk about my latest it's kind of a

28
00:01:41,520 --> 00:01:48,780
simple finding in PDF but it showcased

29
00:01:46,369 --> 00:01:52,950
how understanding the file from what

30
00:01:48,780 --> 00:01:55,770
really helps you to find bugs when you

31
00:01:52,950 --> 00:01:59,070
need them basically then we will move on

32
00:01:55,770 --> 00:02:03,509
to Libre Office and some client-side

33
00:01:59,070 --> 00:02:07,859
attack I found and how this would work

34
00:02:03,509 --> 00:02:10,580
on the server side and we will talk

35
00:02:07,860 --> 00:02:10,580
about sharks

36
00:02:11,250 --> 00:02:18,640
so maybe you don't care about file

37
00:02:13,930 --> 00:02:22,390
formats at all yeah you're kind of right

38
00:02:18,640 --> 00:02:24,640
but also wrong nowadays more and more

39
00:02:22,390 --> 00:02:28,149
stuff gets converted on the file on the

40
00:02:24,640 --> 00:02:32,200
server side I don't know like just think

41
00:02:28,150 --> 00:02:36,100
of JPEG to PNG or I don't know sometimes

42
00:02:32,200 --> 00:02:39,130
you can upload some file document format

43
00:02:36,100 --> 00:02:43,420
which skirts convert it to PDF for a PV

44
00:02:39,130 --> 00:02:45,010
preview feature nobody really wants to

45
00:02:43,420 --> 00:02:48,250
read the whole documentation and you

46
00:02:45,010 --> 00:02:50,920
will see later why there's also image

47
00:02:48,250 --> 00:02:54,010
magic which helped me a lot to actually

48
00:02:50,920 --> 00:02:57,040
get into all this and the last part is

49
00:02:54,010 --> 00:02:59,459
it's really fun and it's always nice to

50
00:02:57,040 --> 00:03:01,798
have other people I can talk to who

51
00:02:59,459 --> 00:03:05,830
suffer the same way I do

52
00:03:01,799 --> 00:03:08,620
basically oh yeah the first awesome

53
00:03:05,830 --> 00:03:11,739
movie I have to talk about and yeah

54
00:03:08,620 --> 00:03:14,380
that's a real movie it's six at a target

55
00:03:11,739 --> 00:03:17,739
six headed shark attack there is two

56
00:03:14,380 --> 00:03:20,769
three four but not five they skipped

57
00:03:17,739 --> 00:03:23,680
that one and this one is really terrible

58
00:03:20,769 --> 00:03:32,530
for some reason he can walk on land with

59
00:03:23,680 --> 00:03:36,160
his head okay um so how I approached

60
00:03:32,530 --> 00:03:38,079
stuff with LibreOffice and it sounds

61
00:03:36,160 --> 00:03:40,150
super simple but believe me it's easy to

62
00:03:38,079 --> 00:03:44,230
make a mistake here

63
00:03:40,150 --> 00:03:46,390
you really should install the latest I

64
00:03:44,230 --> 00:03:48,730
don't know developer version Enterprise

65
00:03:46,390 --> 00:03:52,328
version professional version whatever

66
00:03:48,730 --> 00:03:55,720
the name is the reason is quite simple

67
00:03:52,329 --> 00:03:59,470
because most of the time you can use the

68
00:03:55,720 --> 00:04:02,890
application to use certain features and

69
00:03:59,470 --> 00:04:05,140
the standard fuel which everybody's

70
00:04:02,890 --> 00:04:09,790
using actually supports the feature as

71
00:04:05,140 --> 00:04:12,208
well so it really helps you to get

72
00:04:09,790 --> 00:04:14,888
proper coverage of the file format

73
00:04:12,209 --> 00:04:18,459
another important point get the

74
00:04:14,889 --> 00:04:21,310
documentation never expect that the

75
00:04:18,459 --> 00:04:23,780
documentation is awesome and explains

76
00:04:21,310 --> 00:04:25,370
everything and contains

77
00:04:23,780 --> 00:04:29,799
everything because most of the time it's

78
00:04:25,370 --> 00:04:32,389
old incomplete and really huge

79
00:04:29,800 --> 00:04:37,090
yeah and then you complain about how it

80
00:04:32,389 --> 00:04:37,090
makes no sense then you read it again

81
00:04:37,580 --> 00:04:42,919
then yeah you start to look for keywords

82
00:04:40,510 --> 00:04:44,419
the keywords can change for each

83
00:04:42,919 --> 00:04:47,120
documentation because to just name it

84
00:04:44,419 --> 00:04:49,940
differently all the time you click like

85
00:04:47,120 --> 00:04:54,169
a maniac on every available feature in

86
00:04:49,940 --> 00:04:56,719
the program for some reason it's always

87
00:04:54,169 --> 00:05:00,590
the case that we just do not work when

88
00:04:56,720 --> 00:05:03,290
you actually click on them yeah then you

89
00:05:00,590 --> 00:05:06,109
start to Google you go to google search

90
00:05:03,290 --> 00:05:09,470
for them the key word you should always

91
00:05:06,110 --> 00:05:12,830
include is not working because then you

92
00:05:09,470 --> 00:05:15,220
find forums where people complain the

93
00:05:12,830 --> 00:05:17,960
feature is not working and you can see

94
00:05:15,220 --> 00:05:21,080
some explanations how it should work and

95
00:05:17,960 --> 00:05:23,930
stuff like that yeah

96
00:05:21,080 --> 00:05:26,450
also you really have to read how the

97
00:05:23,930 --> 00:05:30,650
actual file looks like when the program

98
00:05:26,450 --> 00:05:32,780
created the file like with PDF it looks

99
00:05:30,650 --> 00:05:34,130
completely different at first what you

100
00:05:32,780 --> 00:05:38,960
expect when you read the documentation

101
00:05:34,130 --> 00:05:40,400
and it's basically always true yeah you

102
00:05:38,960 --> 00:05:42,710
have to get used to your roost

103
00:05:40,400 --> 00:05:46,460
use standard text editors or sometimes

104
00:05:42,710 --> 00:05:49,130
you read to need to read heck stuff or

105
00:05:46,460 --> 00:05:51,250
just write some scripts so you can

106
00:05:49,130 --> 00:05:54,350
actually understand what's going on and

107
00:05:51,250 --> 00:05:56,150
then you can start mapping the

108
00:05:54,350 --> 00:06:01,010
documentation and the features to the

109
00:05:56,150 --> 00:06:07,969
actual actually created files and then

110
00:06:01,010 --> 00:06:10,430
you repeat this steps for five years one

111
00:06:07,970 --> 00:06:14,810
nice thing this is especially true for

112
00:06:10,430 --> 00:06:19,039
windows check the file extensions as a

113
00:06:14,810 --> 00:06:21,890
nice and example for Kiev or when you

114
00:06:19,039 --> 00:06:24,050
install a double reader there is one

115
00:06:21,890 --> 00:06:26,659
file extension called PDF XML which

116
00:06:24,050 --> 00:06:28,729
doesn't really work anymore there's

117
00:06:26,660 --> 00:06:31,039
actually a link trigger that you don't

118
00:06:28,729 --> 00:06:34,610
have to download a module and when you

119
00:06:31,039 --> 00:06:37,068
open it it's a 404 page and

120
00:06:34,610 --> 00:06:39,740
if you want to be cool instead of using

121
00:06:37,069 --> 00:06:42,979
dot PDF you can use dot Acrobat security

122
00:06:39,740 --> 00:06:49,099
settings and it's the same identical

123
00:06:42,979 --> 00:06:52,508
stuff oh yeah this movie maybe you can

124
00:06:49,099 --> 00:06:55,729
already guess what this char can do

125
00:06:52,509 --> 00:06:59,629
instead of water he lives on the beach

126
00:06:55,729 --> 00:07:01,370
and for some reason that people decide

127
00:06:59,629 --> 00:07:05,169
hey we will still want to be on the

128
00:07:01,370 --> 00:07:05,169
beach so they have to fight him

129
00:07:10,389 --> 00:07:19,639
don't worry sharknado is not even once

130
00:07:13,219 --> 00:07:24,979
in this presentation yeah as promised

131
00:07:19,639 --> 00:07:26,330
one my last example for file format

132
00:07:24,979 --> 00:07:29,389
stuff we can do when you know the file

133
00:07:26,330 --> 00:07:33,229
format really well as PDF over the years

134
00:07:29,389 --> 00:07:35,419
I learned that PDF can send HTTP

135
00:07:33,229 --> 00:07:39,229
requests we had two different languages

136
00:07:35,419 --> 00:07:42,080
actually there is one executable just

137
00:07:39,229 --> 00:07:46,000
handling comments and there is stuff

138
00:07:42,080 --> 00:07:50,599
like XML support and the XML support is

139
00:07:46,000 --> 00:07:53,449
actually important because last year

140
00:07:50,599 --> 00:07:58,639
there was a github repo called bad PDF

141
00:07:53,449 --> 00:08:01,960
and it's when when it was opened on

142
00:07:58,639 --> 00:08:06,259
Windows with Adobe Reader it would send

143
00:08:01,960 --> 00:08:09,409
a request on an to an SMB share of an

144
00:08:06,259 --> 00:08:12,529
attacker and suddenly Adobe patched it

145
00:08:09,409 --> 00:08:14,000
and I was kind of surprised so I decided

146
00:08:12,529 --> 00:08:16,789
I can do that

147
00:08:14,000 --> 00:08:21,139
it's not difficult so I think it took me

148
00:08:16,789 --> 00:08:23,839
one day maybe maybe less and basically

149
00:08:21,139 --> 00:08:27,610
what I used is the fact that XML is

150
00:08:23,839 --> 00:08:30,650
supported so I used the XSL stylesheet

151
00:08:27,610 --> 00:08:35,390
inside the XML structure which was

152
00:08:30,650 --> 00:08:37,399
loaded from a remote SMB share and this

153
00:08:35,390 --> 00:08:40,968
allows once again to leak the anti-male

154
00:08:37,399 --> 00:08:43,610
hash and I didn't report it and it was

155
00:08:40,969 --> 00:08:45,890
fixed nevertheless so I decided to do

156
00:08:43,610 --> 00:08:49,790
another purpose because I had some time

157
00:08:45,890 --> 00:08:52,819
and the pitch was basically they only

158
00:08:49,790 --> 00:08:55,699
allow internal IPS or domains without

159
00:08:52,820 --> 00:08:59,839
the dot so they don't break stuff for

160
00:08:55,700 --> 00:09:06,589
companies I assume maybe you think about

161
00:08:59,839 --> 00:09:10,130
using I don't know like ipv6 or yeah you

162
00:09:06,589 --> 00:09:12,320
can represent IPs without a dot that's

163
00:09:10,130 --> 00:09:13,910
also possible but actually on Windows

164
00:09:12,320 --> 00:09:16,550
you don't even have to do that because

165
00:09:13,910 --> 00:09:20,660
there is an awesome blog post from James

166
00:09:16,550 --> 00:09:23,540
Porter from Google project zero where he

167
00:09:20,660 --> 00:09:27,709
explains how Windows handles a lot of

168
00:09:23,540 --> 00:09:30,410
the path stuff and he also mentions it's

169
00:09:27,709 --> 00:09:32,930
a B shares or UNC paths as they are

170
00:09:30,410 --> 00:09:35,269
called and basically in Windows what you

171
00:09:32,930 --> 00:09:37,729
can do there are two devices called

172
00:09:35,269 --> 00:09:40,220
Landman redirector and veptr free

173
00:09:37,730 --> 00:09:43,220
director and all they do is tell Windows

174
00:09:40,220 --> 00:09:47,930
if you want to use SB as the protocol or

175
00:09:43,220 --> 00:09:49,880
that daf which is basically HTTP and you

176
00:09:47,930 --> 00:09:53,209
specified as you can see it on the slide

177
00:09:49,880 --> 00:09:56,959
and this works fine on Windows and it

178
00:09:53,209 --> 00:10:00,199
contains no dot so this was another

179
00:09:56,959 --> 00:10:03,319
bypass it was actually fixed and then I

180
00:10:00,199 --> 00:10:04,880
stopped I got kind of bored but it shows

181
00:10:03,320 --> 00:10:09,640
you that Windows is kind of awesome when

182
00:10:04,880 --> 00:10:14,149
it comes to this kind of stuff oh yeah I

183
00:10:09,640 --> 00:10:19,630
could talk a lot about this one because

184
00:10:14,149 --> 00:10:24,199
Sharktopus is actually free movies yeah

185
00:10:19,630 --> 00:10:28,779
and this one he fights whale wolf which

186
00:10:24,199 --> 00:10:33,979
was created by an evil female German

187
00:10:28,779 --> 00:10:34,519
scientists for some reason but don't

188
00:10:33,980 --> 00:10:39,920
worry

189
00:10:34,519 --> 00:10:44,350
octopus wins of course yes sorry

190
00:10:39,920 --> 00:10:49,628
oh no I already told you it's a trilogy

191
00:10:44,350 --> 00:10:49,629
so let's come to the LibreOffice I

192
00:10:50,559 --> 00:10:55,579
started I think last year if I remember

193
00:10:53,540 --> 00:10:58,819
correctly and the reason was image magic

194
00:10:55,579 --> 00:11:02,449
is used a lot on the pagan to convert

195
00:10:58,819 --> 00:11:06,290
any kind of stuff I was aware of image

196
00:11:02,449 --> 00:11:09,079
tragic and Google project zero found a

197
00:11:06,290 --> 00:11:11,419
lot of stuff in a ghost script which

198
00:11:09,079 --> 00:11:13,160
allowed remote code execution and go

199
00:11:11,419 --> 00:11:19,910
script is also supported by image magic

200
00:11:13,160 --> 00:11:22,368
and I decided I tried it as well why not

201
00:11:19,910 --> 00:11:24,649
and there's a file called delegates that

202
00:11:22,369 --> 00:11:28,509
XML which contains a lot of file

203
00:11:24,649 --> 00:11:32,419
extensions supported and I decided oh

204
00:11:28,509 --> 00:11:35,589
okay it supports s Office which is

205
00:11:32,419 --> 00:11:37,819
either OpenOffice or Libre Office and

206
00:11:35,589 --> 00:11:41,679
that's basically the reason how I got

207
00:11:37,819 --> 00:11:44,389
started with this I basically used

208
00:11:41,679 --> 00:11:48,799
LibreOffice write a writer the whole

209
00:11:44,389 --> 00:11:50,689
time during this time and there are some

210
00:11:48,799 --> 00:11:52,819
differences between the different

211
00:11:50,689 --> 00:11:56,118
applications but most of the time they

212
00:11:52,819 --> 00:11:59,269
are quite similar actually what also is

213
00:11:56,119 --> 00:12:01,879
quite nice is that the ODT file format

214
00:11:59,269 --> 00:12:04,549
is sip-based file format so you can

215
00:12:01,879 --> 00:12:09,139
easily modify it and there is an even

216
00:12:04,549 --> 00:12:13,399
better file extension called F DT which

217
00:12:09,139 --> 00:12:17,089
is one huge XML file which is basically

218
00:12:13,399 --> 00:12:22,279
the same as ODT and you can easily

219
00:12:17,089 --> 00:12:25,819
modify it and just play around and then

220
00:12:22,279 --> 00:12:28,129
I grab the documentation so my Google

221
00:12:25,819 --> 00:12:31,248
documentation there's like the open

222
00:12:28,129 --> 00:12:35,509
document version 1.2 I just assumed

223
00:12:31,249 --> 00:12:42,480
that's the latest one it has free parts

224
00:12:35,509 --> 00:12:45,740
and then some additional specifications

225
00:12:42,480 --> 00:12:49,079
and yeah when you combine them it's like

226
00:12:45,740 --> 00:12:52,649
1200 pages to read I just decided I go

227
00:12:49,079 --> 00:12:55,380
with the part one makes kind of sense to

228
00:12:52,649 --> 00:12:58,500
start at the beginning

229
00:12:55,380 --> 00:13:02,699
compared PDF it's not that much I did

230
00:12:58,500 --> 00:13:06,110
wants to come the math and when you

231
00:13:02,699 --> 00:13:11,880
combine on PDF all the important

232
00:13:06,110 --> 00:13:15,360
documents you know over 4,000 pages I

233
00:13:11,880 --> 00:13:18,540
think it's I compare it to Harry Potter

234
00:13:15,360 --> 00:13:22,740
or stuff like that and it's kinda in

235
00:13:18,540 --> 00:13:24,060
this area so maybe you know know now why

236
00:13:22,740 --> 00:13:28,920
nobody wants to read the whole

237
00:13:24,060 --> 00:13:31,199
documentation yeah after that I just

238
00:13:28,920 --> 00:13:32,729
started to look for interesting keywords

239
00:13:31,199 --> 00:13:36,859
and there are were actually quite a lot

240
00:13:32,730 --> 00:13:39,540
laughs like script script sauce macro

241
00:13:36,860 --> 00:13:43,110
script eventlistener that sound or

242
00:13:39,540 --> 00:13:47,000
everything sounds like perfect but it

243
00:13:43,110 --> 00:13:52,560
didn't contain any structure examples

244
00:13:47,000 --> 00:13:55,470
which was kind of a pain and at first I

245
00:13:52,560 --> 00:13:58,079
couldn't really find where I can use

246
00:13:55,470 --> 00:13:59,579
macros I found like the settings and

247
00:13:58,079 --> 00:14:02,519
stuff like that but I wanted to create

248
00:13:59,579 --> 00:14:05,670
an example document and last year was a

249
00:14:02,519 --> 00:14:09,060
brew con and I was maybe a little bit

250
00:14:05,670 --> 00:14:11,910
tired from the day before and I didn't

251
00:14:09,060 --> 00:14:14,160
want to go to the talk so i decided i

252
00:14:11,910 --> 00:14:17,910
sit down and just google for one hour

253
00:14:14,160 --> 00:14:23,850
and i will find this and and i actually

254
00:14:17,910 --> 00:14:28,290
did I found the scripting framework your

255
00:14:23,850 --> 00:14:33,630
eyes specification and it contains not

256
00:14:28,290 --> 00:14:36,510
only how the script URI has to look it

257
00:14:33,630 --> 00:14:40,160
also specifies which languages are

258
00:14:36,510 --> 00:14:47,569
supported and it supports Python

259
00:14:40,160 --> 00:14:52,649
JavaScript bean shell - yeah and basic

260
00:14:47,569 --> 00:14:54,860
for some reason and I was wondering how

261
00:14:52,649 --> 00:14:57,620
they actually support Tizen

262
00:14:54,860 --> 00:14:59,780
and LibreOffice and OpenOffice actually

263
00:14:57,620 --> 00:15:00,530
ship their own Python interpreter when

264
00:14:59,780 --> 00:15:07,069
you install them

265
00:15:00,530 --> 00:15:09,079
it's basically bundled in there so so

266
00:15:07,070 --> 00:15:13,580
where was it actually hidden this nice

267
00:15:09,080 --> 00:15:15,890
feature there are different places but

268
00:15:13,580 --> 00:15:17,630
the first one I found is when you create

269
00:15:15,890 --> 00:15:21,650
an hyperlink there is this really small

270
00:15:17,630 --> 00:15:28,189
icon and it handles the macros for

271
00:15:21,650 --> 00:15:31,400
hyperlinks and it also shows you which

272
00:15:28,190 --> 00:15:34,370
events you can use I choose the mouse

273
00:15:31,400 --> 00:15:36,230
over what it's called mouse over object

274
00:15:34,370 --> 00:15:39,220
in this case so when the mouse is over

275
00:15:36,230 --> 00:15:41,750
the hyperlink it the macro gets executed

276
00:15:39,220 --> 00:15:45,770
and then I just used one of the

277
00:15:41,750 --> 00:15:48,260
pre-installed macros from peyten because

278
00:15:45,770 --> 00:15:54,290
I like peyten basically that was the

279
00:15:48,260 --> 00:15:57,230
sole reason and then I checked the file

280
00:15:54,290 --> 00:16:01,670
because finally I could have a look how

281
00:15:57,230 --> 00:16:04,940
its created and that's the element

282
00:16:01,670 --> 00:16:07,790
handling that and I think it's quite

283
00:16:04,940 --> 00:16:10,850
obvious when you look at it that it

284
00:16:07,790 --> 00:16:14,480
specifies a file which is on a file

285
00:16:10,850 --> 00:16:16,690
system in this case it's table sample

286
00:16:14,480 --> 00:16:20,660
type I then there is a dollar sign and

287
00:16:16,690 --> 00:16:25,250
create table so I decided okay I will

288
00:16:20,660 --> 00:16:27,350
find this file I found it and I looked

289
00:16:25,250 --> 00:16:30,980
into it and of course it has a really

290
00:16:27,350 --> 00:16:35,350
simple function called create table so

291
00:16:30,980 --> 00:16:40,690
what would you try when you see that

292
00:16:35,350 --> 00:16:44,060
maybe I can traverse anywhere so I

293
00:16:40,690 --> 00:16:48,560
decided I try traverse down to the root

294
00:16:44,060 --> 00:16:51,609
folder and just place testify and see

295
00:16:48,560 --> 00:16:54,770
and create a function called test and

296
00:16:51,610 --> 00:16:56,870
see if gets executed so I save that file

297
00:16:54,770 --> 00:16:59,480
open that in deeper office move my mouse

298
00:16:56,870 --> 00:17:02,330
over hyperlink and my script got

299
00:16:59,480 --> 00:17:05,450
executed without any dialogue or warning

300
00:17:02,330 --> 00:17:07,180
or whatsoever so this was the point

301
00:17:05,450 --> 00:17:10,000
where about where

302
00:17:07,180 --> 00:17:16,990
I was really convinced this is not

303
00:17:10,000 --> 00:17:19,540
intended but I prefer to have proof of

304
00:17:16,990 --> 00:17:24,190
concept which works without any

305
00:17:19,540 --> 00:17:26,920
requirements basically so my first idea

306
00:17:24,190 --> 00:17:31,510
was to use a different location you can

307
00:17:26,920 --> 00:17:33,970
define like location user which is on

308
00:17:31,510 --> 00:17:38,800
Windows the app data folder

309
00:17:33,970 --> 00:17:40,690
Linux it's in the user folder as a user

310
00:17:38,800 --> 00:17:45,490
home directory and I assume from Mac

311
00:17:40,690 --> 00:17:47,260
it's the same and my idea was that I

312
00:17:45,490 --> 00:17:49,920
triggered a download of my militia

313
00:17:47,260 --> 00:17:53,530
malicious Libre Office file on Windows

314
00:17:49,920 --> 00:17:57,070
specify a script inside the AppData

315
00:17:53,530 --> 00:17:59,680
folder traverse down then traverse up

316
00:17:57,070 --> 00:18:02,470
into the Downloads folder and specify

317
00:17:59,680 --> 00:18:05,740
the same office file as a Python script

318
00:18:02,470 --> 00:18:08,740
file so basically I would need to create

319
00:18:05,740 --> 00:18:13,570
an LibreOffice file which is also valid

320
00:18:08,740 --> 00:18:17,230
Python script and sadly that didn't work

321
00:18:13,570 --> 00:18:20,399
would have been cool but LibreOffice is

322
00:18:17,230 --> 00:18:24,820
actually really strict about data before

323
00:18:20,400 --> 00:18:30,010
the zip header it allows for some reason

324
00:18:24,820 --> 00:18:33,250
to merge two zip files and then it just

325
00:18:30,010 --> 00:18:37,690
reads the later one but you can't add

326
00:18:33,250 --> 00:18:40,450
anything else and so I kind of gave up

327
00:18:37,690 --> 00:18:45,970
and decided I need another solution

328
00:18:40,450 --> 00:18:49,290
so I actually read the code because it

329
00:18:45,970 --> 00:18:51,760
was also written in Python and I

330
00:18:49,290 --> 00:18:54,490
discovered that parameters are supported

331
00:18:51,760 --> 00:18:57,040
so you not only can you load any Python

332
00:18:54,490 --> 00:19:01,890
script and any Python function but you

333
00:18:57,040 --> 00:19:05,530
can also pass parameters so of course

334
00:19:01,890 --> 00:19:10,330
when you install Python there are a lot

335
00:19:05,530 --> 00:19:13,540
of Python files so I had a look into all

336
00:19:10,330 --> 00:19:17,389
the files which all Python files which

337
00:19:13,540 --> 00:19:21,609
are shipped with LibreOffice by default

338
00:19:17,389 --> 00:19:21,609
and there was one really interesting one

339
00:19:22,299 --> 00:19:28,668
it's called pied octopi and it has a

340
00:19:26,119 --> 00:19:31,428
function called temp file pager and one

341
00:19:28,669 --> 00:19:36,769
parameter is called CMD it's quite short

342
00:19:31,429 --> 00:19:39,019
and maybe you can already see what it

343
00:19:36,769 --> 00:19:41,959
does when you understand Titan so

344
00:19:39,019 --> 00:19:44,769
basically you can ignore the first line

345
00:19:41,959 --> 00:19:48,799
lines it just creates a temp file and

346
00:19:44,769 --> 00:19:51,950
then the CMD parameter gets passed to OS

347
00:19:48,799 --> 00:19:56,539
dot system which is the windows shell in

348
00:19:51,950 --> 00:19:59,149
this case and you can basically execute

349
00:19:56,539 --> 00:20:02,749
any program download I don't know

350
00:19:59,149 --> 00:20:05,168
whatever you want and the payload

351
00:20:02,749 --> 00:20:08,329
actually looked quite simple in the end

352
00:20:05,169 --> 00:20:10,879
all you need to do is Traverse three

353
00:20:08,329 --> 00:20:13,279
folders down into the Python core

354
00:20:10,879 --> 00:20:16,748
library a Python code file a folder of

355
00:20:13,279 --> 00:20:20,929
LibreOffice and execute this nice

356
00:20:16,749 --> 00:20:30,879
function and I did an awesome recording

357
00:20:20,929 --> 00:20:35,719
of that of course if it works yeah so

358
00:20:30,879 --> 00:20:41,289
it's really short so basically I created

359
00:20:35,719 --> 00:20:41,289
this malicious structure such as shown

360
00:20:45,519 --> 00:20:54,119
and yeah

361
00:20:48,230 --> 00:20:54,119
[Applause]

362
00:20:54,600 --> 00:20:59,469
of course because I've used peyten which

363
00:20:57,670 --> 00:21:01,750
is shipped by default it works on

364
00:20:59,470 --> 00:21:06,430
Windows Linux and Mac so that's quite

365
00:21:01,750 --> 00:21:08,770
nice then I started to finally report

366
00:21:06,430 --> 00:21:12,250
this issue and I made a little mistake

367
00:21:08,770 --> 00:21:15,370
and reported it to the Box allure system

368
00:21:12,250 --> 00:21:19,530
which is not intended for security bugs

369
00:21:15,370 --> 00:21:25,179
in libreoffice so it got closed and I

370
00:21:19,530 --> 00:21:27,399
responded with are you sure maybe have

371
00:21:25,180 --> 00:21:30,370
another look here is an proof of concept

372
00:21:27,400 --> 00:21:31,630
for Windows or maybe try that one and

373
00:21:30,370 --> 00:21:33,879
then they were like oh that's a security

374
00:21:31,630 --> 00:21:36,940
issue and moved it to the right location

375
00:21:33,880 --> 00:21:41,760
which is actually a specific email

376
00:21:36,940 --> 00:21:45,070
address you should write to and then

377
00:21:41,760 --> 00:21:49,450
things got moved quite fast

378
00:21:45,070 --> 00:21:52,629
Libre Office I can't remember how many

379
00:21:49,450 --> 00:21:54,040
days but if they fix it really fast but

380
00:21:52,630 --> 00:21:59,880
then they told me I have to wait because

381
00:21:54,040 --> 00:22:01,870
OpenOffice is sharing some code with

382
00:21:59,880 --> 00:22:05,200
openoffice and libreoffice are sharing

383
00:22:01,870 --> 00:22:09,370
some code and they are vulnerable to the

384
00:22:05,200 --> 00:22:13,180
traversal as well so they told me to

385
00:22:09,370 --> 00:22:15,250
wait three months they didn't fix it and

386
00:22:13,180 --> 00:22:20,770
then they decided I'm allowed to publish

387
00:22:15,250 --> 00:22:23,890
the the details in OpenOffice the issue

388
00:22:20,770 --> 00:22:26,650
is not as pay because they don't know

389
00:22:23,890 --> 00:22:31,120
but they didn't actually implement the

390
00:22:26,650 --> 00:22:33,910
parameter support but one problem is

391
00:22:31,120 --> 00:22:37,439
OpenOffice is still vulnerable it's

392
00:22:33,910 --> 00:22:40,360
still there still no patch available so

393
00:22:37,440 --> 00:22:43,540
not sure if there ever will be a patch

394
00:22:40,360 --> 00:22:49,240
for that actually but LibreOffice is

395
00:22:43,540 --> 00:22:51,909
safe I can tell you that so as I already

396
00:22:49,240 --> 00:22:56,230
mentioned there are other like macro

397
00:22:51,910 --> 00:22:58,990
languages you can use the base one which

398
00:22:56,230 --> 00:23:01,960
is we shall basic in the LibreOffice

399
00:22:58,990 --> 00:23:06,639
world as actually quite interesting

400
00:23:01,960 --> 00:23:10,279
because they ship a lot of

401
00:23:06,639 --> 00:23:13,008
pre-installed bass macros and some of

402
00:23:10,279 --> 00:23:18,379
them are really powerful so I try to

403
00:23:13,009 --> 00:23:21,019
abuse them but they do not work I don't

404
00:23:18,379 --> 00:23:25,039
know why you always get the same error

405
00:23:21,019 --> 00:23:28,999
message wrong amount of parameters or no

406
00:23:25,039 --> 00:23:33,859
parameters passed and I tried to use my

407
00:23:28,999 --> 00:23:36,769
own bass function which I managed to do

408
00:23:33,859 --> 00:23:39,408
with some googling skills and no matter

409
00:23:36,769 --> 00:23:43,279
no matter the amount of parameters I

410
00:23:39,409 --> 00:23:46,249
accept it always decided it's the wrong

411
00:23:43,279 --> 00:23:49,789
amount of parameters so maybe I get it

412
00:23:46,249 --> 00:23:53,389
working this year let's see they also

413
00:23:49,789 --> 00:23:57,229
support JavaScript which is not really

414
00:23:53,389 --> 00:24:00,488
JavaScript it's more like Java not true

415
00:23:57,229 --> 00:24:02,779
always actually exists but it's a thing

416
00:24:00,489 --> 00:24:07,969
yeah they also have support for Java

417
00:24:02,779 --> 00:24:10,940
itself and bean shell but you actually

418
00:24:07,969 --> 00:24:13,669
have to install the Java Runtime

419
00:24:10,940 --> 00:24:17,570
environment and it must be available in

420
00:24:13,669 --> 00:24:21,139
the path at least on Windows and Linux

421
00:24:17,570 --> 00:24:26,779
and one problem to actually abuse them

422
00:24:21,139 --> 00:24:28,579
is the way how they how the the path is

423
00:24:26,779 --> 00:24:30,979
created because they don't use slashes

424
00:24:28,579 --> 00:24:34,178
like for Python they just use dots and

425
00:24:30,979 --> 00:24:39,190
no matter what I tried I wasn't able to

426
00:24:34,179 --> 00:24:46,339
cause any kind of path reversals so I

427
00:24:39,190 --> 00:24:49,309
couldn't abuse them sadly so let's talk

428
00:24:46,339 --> 00:24:52,849
about the back end a little bit but

429
00:24:49,309 --> 00:24:55,158
first we need more shocks by the way I

430
00:24:52,849 --> 00:24:58,129
like this title so much much Evelyn

431
00:24:55,159 --> 00:25:05,089
sharks the snow will run red with blood

432
00:24:58,129 --> 00:25:06,829
I watched it it doesn't in case you want

433
00:25:05,089 --> 00:25:08,629
to watch this movie it's not the same

434
00:25:06,829 --> 00:25:10,779
movie as snow shark that's a different

435
00:25:08,629 --> 00:25:10,779
one

436
00:25:11,440 --> 00:25:15,860
but but but snow shock is actually

437
00:25:14,030 --> 00:25:21,559
really awesome this one is also kind of

438
00:25:15,860 --> 00:25:24,439
fun and no I don't know why it exists

439
00:25:21,559 --> 00:25:27,950
both movies they act the same wait the

440
00:25:24,440 --> 00:25:30,710
Sharks okay

441
00:25:27,950 --> 00:25:32,690
so the first problem with macros on the

442
00:25:30,710 --> 00:25:35,650
back end

443
00:25:32,690 --> 00:25:39,980
I take image magic as an example because

444
00:25:35,650 --> 00:25:45,620
at least in my opinion it's the most

445
00:25:39,980 --> 00:25:48,190
used library to convert files and it

446
00:25:45,620 --> 00:25:49,370
uses the headless mode of course of

447
00:25:48,190 --> 00:25:52,370
LibreOffice

448
00:25:49,370 --> 00:25:56,030
so all these mouse-over stuff doesn't

449
00:25:52,370 --> 00:25:59,570
work it just doesn't execute any Mac

450
00:25:56,030 --> 00:26:02,870
macros but there is thankfully more

451
00:25:59,570 --> 00:26:07,610
events available which I've found weeks

452
00:26:02,870 --> 00:26:11,449
later when you click on the right menu

453
00:26:07,610 --> 00:26:14,740
option these are all the events which

454
00:26:11,450 --> 00:26:20,299
are available for a document to react on

455
00:26:14,740 --> 00:26:21,830
and not all of them get executed in in a

456
00:26:20,299 --> 00:26:25,370
headless mode when the file could

457
00:26:21,830 --> 00:26:28,668
actually converted but as an example to

458
00:26:25,370 --> 00:26:33,199
highlight that bone called few created

459
00:26:28,669 --> 00:26:34,970
gets executed so when you when you use

460
00:26:33,200 --> 00:26:40,910
them they actually look really similar

461
00:26:34,970 --> 00:26:43,960
to my clients ient exploit so I was like

462
00:26:40,910 --> 00:26:48,200
oh yeah I can use my proof-of-concept to

463
00:26:43,960 --> 00:26:50,900
attack backends as well yes sadly it's

464
00:26:48,200 --> 00:26:54,669
not mentioned at the documentation but I

465
00:26:50,900 --> 00:26:57,470
learned that when you use any kind of

466
00:26:54,669 --> 00:27:00,650
event which is related to the whole

467
00:26:57,470 --> 00:27:03,230
document itself it just decided to add

468
00:27:00,650 --> 00:27:05,240
additional parameters sometimes it's

469
00:27:03,230 --> 00:27:08,530
born sometimes there are two additional

470
00:27:05,240 --> 00:27:13,580
parameters sometimes they're even four

471
00:27:08,530 --> 00:27:16,460
so I couldn't use my proof of concept

472
00:27:13,580 --> 00:27:18,439
because I needed to control the last

473
00:27:16,460 --> 00:27:19,980
parameter and it was not an option

474
00:27:18,440 --> 00:27:23,850
anymore

475
00:27:19,980 --> 00:27:26,670
I tried to find another nice function to

476
00:27:23,850 --> 00:27:32,178
abuse but sadly I couldn't

477
00:27:26,670 --> 00:27:35,130
maybe I wasn't looking good enough but

478
00:27:32,179 --> 00:27:39,140
what can you do

479
00:27:35,130 --> 00:27:40,620
so I decided to give polyglot files

480
00:27:39,140 --> 00:27:44,970
another go

481
00:27:40,620 --> 00:27:48,570
so to include Python script inside my

482
00:27:44,970 --> 00:27:51,690
malicious of office file on the back end

483
00:27:48,570 --> 00:27:59,360
and in this case i can assume and i'm on

484
00:27:51,690 --> 00:28:03,870
linux i tried to abuse the proc self

485
00:27:59,360 --> 00:28:07,110
file descriptor folder which basically

486
00:28:03,870 --> 00:28:12,689
contains all the open file descriptors

487
00:28:07,110 --> 00:28:16,740
of the current application so i wanted

488
00:28:12,690 --> 00:28:21,650
to see if i can specify the file

489
00:28:16,740 --> 00:28:24,540
descriptor to the office file itself to

490
00:28:21,650 --> 00:28:28,590
execute my pipe my own python script

491
00:28:24,540 --> 00:28:31,409
basically that was my idea in theory it

492
00:28:28,590 --> 00:28:35,490
actually would work because Python

493
00:28:31,410 --> 00:28:40,320
supports super compressed files in

494
00:28:35,490 --> 00:28:43,110
Python two and three actually and sadly

495
00:28:40,320 --> 00:28:45,840
it didn't work because they use the

496
00:28:43,110 --> 00:28:49,799
compile function and the compile

497
00:28:45,840 --> 00:28:52,320
function accepts either a string a byte

498
00:28:49,799 --> 00:28:56,520
string or an EPS

499
00:28:52,320 --> 00:29:00,870
abstract syntax tree and in this case

500
00:28:56,520 --> 00:29:03,780
it's always a string so we have the same

501
00:29:00,870 --> 00:29:06,059
problem on the back end as on the client

502
00:29:03,780 --> 00:29:08,600
side when I just include my Python

503
00:29:06,059 --> 00:29:11,040
script at the beginning of the

504
00:29:08,600 --> 00:29:15,178
LibreOffice file really Libre Office

505
00:29:11,040 --> 00:29:18,210
won't posit but if I include any other

506
00:29:15,179 --> 00:29:23,580
crap which Libre Office except at the

507
00:29:18,210 --> 00:29:25,890
beginning Python will fail so once again

508
00:29:23,580 --> 00:29:29,070
I was stucked and to this day I have no

509
00:29:25,890 --> 00:29:31,110
solution for that so you would require

510
00:29:29,070 --> 00:29:32,500
to have an additional file your full

511
00:29:31,110 --> 00:29:36,370
control

512
00:29:32,500 --> 00:29:41,620
on the backend and then you can actually

513
00:29:36,370 --> 00:29:43,419
exploit it but thankfully dia other

514
00:29:41,620 --> 00:29:45,820
features I discovered while playing

515
00:29:43,420 --> 00:29:49,600
around with LibreOffice you can link to

516
00:29:45,820 --> 00:29:53,260
external files you can load remote

517
00:29:49,600 --> 00:29:56,980
images there is something called special

518
00:29:53,260 --> 00:30:01,800
fields and at first I was hoping to

519
00:29:56,980 --> 00:30:04,180
abuse all the objects in LibreOffice but

520
00:30:01,800 --> 00:30:05,710
for some reason they do not work at all

521
00:30:04,180 --> 00:30:08,610
in the headless mode

522
00:30:05,710 --> 00:30:13,680
either there are like a blank object or

523
00:30:08,610 --> 00:30:16,810
some stupid standard chip back arrow

524
00:30:13,680 --> 00:30:22,510
will show up after conversion so I

525
00:30:16,810 --> 00:30:26,409
basically gave up using them but one

526
00:30:22,510 --> 00:30:30,129
feature which is kind of nice is the

527
00:30:26,410 --> 00:30:32,410
linking to external files basically all

528
00:30:30,130 --> 00:30:34,750
of the LibreOffice application allowed

529
00:30:32,410 --> 00:30:38,290
to link to external files on the file

530
00:30:34,750 --> 00:30:40,180
system and you can hard code basically

531
00:30:38,290 --> 00:30:44,470
what you want to reference of course

532
00:30:40,180 --> 00:30:47,440
most of time when you attack a back-end

533
00:30:44,470 --> 00:30:50,410
based on Linux you try to read et Cie

534
00:30:47,440 --> 00:30:55,330
passivity or stuff like that or et Cie

535
00:30:50,410 --> 00:30:58,300
hosts or this kind of standard files but

536
00:30:55,330 --> 00:31:00,189
there is a protection in place which

537
00:30:58,300 --> 00:31:05,500
requires some kind of user interaction

538
00:31:00,190 --> 00:31:07,930
to yeah I want to update the link I have

539
00:31:05,500 --> 00:31:11,170
a bypass for this feature but it's

540
00:31:07,930 --> 00:31:13,270
certainly not fixed so you have to wait

541
00:31:11,170 --> 00:31:20,160
until it's fixed and I can publish it

542
00:31:13,270 --> 00:31:22,780
how about blog post yeah external images

543
00:31:20,160 --> 00:31:25,450
they mean they're quite simple you can

544
00:31:22,780 --> 00:31:31,240
use file the file protocol you can use

545
00:31:25,450 --> 00:31:33,990
HTTP HTTP this allows to test the

546
00:31:31,240 --> 00:31:40,270
firewall of the server which is

547
00:31:33,990 --> 00:31:43,690
converting your office file most of the

548
00:31:40,270 --> 00:31:46,210
time when HTTP or HTTPS is allowed and

549
00:31:43,690 --> 00:31:50,320
basically all ports are are allowed

550
00:31:46,210 --> 00:31:52,630
that's kind of my experience so far

551
00:31:50,320 --> 00:31:57,520
it's also nice to check if you can maybe

552
00:31:52,630 --> 00:32:01,540
use DNS for some DNS channels to steal

553
00:31:57,520 --> 00:32:06,940
data and the developer version supports

554
00:32:01,540 --> 00:32:10,060
now PDF JPEG files so in case you want

555
00:32:06,940 --> 00:32:12,790
to read local PDFs of the backend and

556
00:32:10,060 --> 00:32:16,510
you know the location you can actually

557
00:32:12,790 --> 00:32:18,850
include them in your office files and

558
00:32:16,510 --> 00:32:20,890
after they are converted to I don't know

559
00:32:18,850 --> 00:32:27,280
cheaper or whatever they will contain

560
00:32:20,890 --> 00:32:29,200
the content of the PDF yeah special

561
00:32:27,280 --> 00:32:32,850
fields which I actually just called

562
00:32:29,200 --> 00:32:36,970
fields but I call them special fields

563
00:32:32,850 --> 00:32:38,709
they always get updated also even in

564
00:32:36,970 --> 00:32:42,910
headless mode so it doesn't matter in

565
00:32:38,710 --> 00:32:46,480
which context in the on the right which

566
00:32:42,910 --> 00:32:50,430
means like ODT files you can use

567
00:32:46,480 --> 00:32:53,260
features like full file path which is

568
00:32:50,430 --> 00:32:56,890
basically always the first thing I use

569
00:32:53,260 --> 00:32:59,470
because it shows you the file structure

570
00:32:56,890 --> 00:33:05,500
on the back end it shows you if your own

571
00:32:59,470 --> 00:33:09,340
file name is used so that's sometimes

572
00:33:05,500 --> 00:33:13,120
helpful not all the time sometimes you

573
00:33:09,340 --> 00:33:16,179
can use the offer to get the current

574
00:33:13,120 --> 00:33:23,530
user but only sometimes for some reason

575
00:33:16,180 --> 00:33:27,480
I try to abuse the DD II which is quite

576
00:33:23,530 --> 00:33:30,660
famous in in the Microsoft Office world

577
00:33:27,480 --> 00:33:34,660
because it was abused a lot to execute

578
00:33:30,660 --> 00:33:36,460
external programs sadly it doesn't work

579
00:33:34,660 --> 00:33:39,030
the same way in LibreOffice so they

580
00:33:36,460 --> 00:33:43,600
didn't port that feature and

581
00:33:39,030 --> 00:33:45,879
additionally they have once again the

582
00:33:43,600 --> 00:33:49,689
requirement when it's linking to an

583
00:33:45,880 --> 00:33:52,300
external program and data you have the

584
00:33:49,690 --> 00:33:57,330
kind of user interaction so it can't be

585
00:33:52,300 --> 00:33:57,330
really abused to attack the back end

586
00:33:58,200 --> 00:34:05,080
yeah the colic which is basically the

587
00:34:01,480 --> 00:34:08,620
Excel version in libreoffice has no

588
00:34:05,080 --> 00:34:14,049
special fields but it has of course

589
00:34:08,620 --> 00:34:16,899
functions like Excel has and two years

590
00:34:14,050 --> 00:34:20,710
ago I think if I recall correctly there

591
00:34:16,899 --> 00:34:25,560
was a function you could abuse called

592
00:34:20,710 --> 00:34:30,909
web service which allowed to read at a

593
00:34:25,560 --> 00:34:33,310
local files or any HTTP or HTTPS

594
00:34:30,909 --> 00:34:38,560
endpoint and the content is actually

595
00:34:33,310 --> 00:34:41,889
stored inside the document without user

596
00:34:38,560 --> 00:34:46,090
interaction actually they decided it's a

597
00:34:41,889 --> 00:34:48,158
buck and fix that sadly so maybe when

598
00:34:46,090 --> 00:34:50,740
you encounter really old LibreOffice

599
00:34:48,159 --> 00:34:53,500
version you can use that

600
00:34:50,739 --> 00:34:56,799
another cool feature I always abuse is

601
00:34:53,500 --> 00:34:59,130
the info call because it allows you to

602
00:34:56,800 --> 00:35:02,800
check if you're on the Linux or Windows

603
00:34:59,130 --> 00:35:05,020
you can check the exact version of the

604
00:35:02,800 --> 00:35:09,820
Libre Office application which is used

605
00:35:05,020 --> 00:35:15,610
and yes set is the OS version is

606
00:35:09,820 --> 00:35:17,650
hard-coded to Windows NT 5 actually

607
00:35:15,610 --> 00:35:22,740
Microsoft Office supports this called

608
00:35:17,650 --> 00:35:25,720
properly but Libre Office just used NT 5

609
00:35:22,740 --> 00:35:31,899
so yeah you can see I still have some to

610
00:35:25,720 --> 00:35:36,609
use I want to explore more about CDE in

611
00:35:31,900 --> 00:35:41,650
general actually I want you to continue

612
00:35:36,610 --> 00:35:46,180
with getting a working - injection on

613
00:35:41,650 --> 00:35:47,760
the backend and check how the base macro

614
00:35:46,180 --> 00:35:50,440
support actually works

615
00:35:47,760 --> 00:35:52,930
there must be a way to get it working I

616
00:35:50,440 --> 00:35:56,620
mean it's in there and somebody must

617
00:35:52,930 --> 00:35:58,990
have used it properly yeah all the

618
00:35:56,620 --> 00:36:02,230
objects seem interesting and just so

619
00:35:58,990 --> 00:36:04,209
many features you can use and some of

620
00:36:02,230 --> 00:36:07,510
them work done in the backend in

621
00:36:04,210 --> 00:36:08,740
combination with imagemagick so maybe

622
00:36:07,510 --> 00:36:12,250
some of you want to

623
00:36:08,740 --> 00:36:16,868
me in this awesome journey we can watch

624
00:36:12,250 --> 00:36:20,500
some be shark movies together so some

625
00:36:16,869 --> 00:36:24,369
general security considerations yeah as

626
00:36:20,500 --> 00:36:27,940
you this was this was just a short

627
00:36:24,369 --> 00:36:32,920
overview of what you can do in such

628
00:36:27,940 --> 00:36:37,119
complex file format what you have to

629
00:36:32,920 --> 00:36:39,490
consider is when you use applications

630
00:36:37,119 --> 00:36:42,910
like image magic you maybe don't even

631
00:36:39,490 --> 00:36:47,009
realize you were supporting this file

632
00:36:42,910 --> 00:36:50,080
format because when you upload like a

633
00:36:47,010 --> 00:36:56,430
ghost script file or a LibreOffice file

634
00:36:50,080 --> 00:37:01,299
with a dot jpg extensions extension or

635
00:36:56,430 --> 00:37:04,690
some configurations of image magic or

636
00:37:01,300 --> 00:37:08,680
maybe all of them I'm not sure now try

637
00:37:04,690 --> 00:37:15,070
to sniff the actual type of the

638
00:37:08,680 --> 00:37:17,859
application of the file so it it try it

639
00:37:15,070 --> 00:37:21,369
looks into the file sees it's not a JPEG

640
00:37:17,859 --> 00:37:22,990
file and then actually decides oh this

641
00:37:21,369 --> 00:37:25,780
is an office file or this is a ghost

642
00:37:22,990 --> 00:37:29,049
script file and suddenly you support the

643
00:37:25,780 --> 00:37:31,980
file types and you never wanted to so

644
00:37:29,050 --> 00:37:36,760
you have to implement some kind of logic

645
00:37:31,980 --> 00:37:38,710
on your back ends so that you verify you

646
00:37:36,760 --> 00:37:43,090
only support the file formats you want

647
00:37:38,710 --> 00:37:47,080
to check or convert and this is actually

648
00:37:43,090 --> 00:37:50,710
really important because we abuse this a

649
00:37:47,080 --> 00:37:53,020
lot in the past when you want to disable

650
00:37:50,710 --> 00:37:56,560
macro support in Libre Office good luck

651
00:37:53,020 --> 00:37:57,130
I assumed there is like in just an easy

652
00:37:56,560 --> 00:38:00,609
option

653
00:37:57,130 --> 00:38:05,980
I don't want macros I couldn't find one

654
00:38:00,609 --> 00:38:09,160
like maybe I didn't look hard enough for

655
00:38:05,980 --> 00:38:11,619
pipe you can just delete Python script

656
00:38:09,160 --> 00:38:14,710
at PI then the feature is completely

657
00:38:11,619 --> 00:38:17,470
broken when you don't have to travel

658
00:38:14,710 --> 00:38:20,170
travel runtime environment installed

659
00:38:17,470 --> 00:38:21,589
you're fine in case you have it

660
00:38:20,170 --> 00:38:25,970
installed and it

661
00:38:21,590 --> 00:38:30,770
in your path you have to disable it in

662
00:38:25,970 --> 00:38:35,959
libreoffice because it tries to actually

663
00:38:30,770 --> 00:38:37,280
find it and then use it for macros of

664
00:38:35,960 --> 00:38:39,410
course you can use containers if

665
00:38:37,280 --> 00:38:43,070
possible because then you're just really

666
00:38:39,410 --> 00:38:45,020
limiting the files and you can disable

667
00:38:43,070 --> 00:38:48,500
network connections and stuff like that

668
00:38:45,020 --> 00:38:52,759
and it's actually possible to run file a

669
00:38:48,500 --> 00:38:56,180
filesystem jail for LibreOffice and it's

670
00:38:52,760 --> 00:39:04,280
used in libreoffice online and yes

671
00:38:56,180 --> 00:39:07,069
that's the thing there you can get the

672
00:39:04,280 --> 00:39:12,310
commands and and the necessary files to

673
00:39:07,070 --> 00:39:13,490
run Libre Office in filesystem jail oh

674
00:39:12,310 --> 00:39:17,660
yeah

675
00:39:13,490 --> 00:39:22,939
ghosts Chuck this movie is so ridiculous

676
00:39:17,660 --> 00:39:26,569
so this is about a shark who died but

677
00:39:22,940 --> 00:39:29,540
for some reason he's a ghost and as you

678
00:39:26,570 --> 00:39:32,570
know ghosts can appear everywhere and

679
00:39:29,540 --> 00:39:35,900
this shark can appear everywhere whereas

680
00:39:32,570 --> 00:39:39,710
water everywhere in your bathtub in your

681
00:39:35,900 --> 00:39:48,380
pool and you can kill him because he's

682
00:39:39,710 --> 00:39:52,850
dead yeah he can he can he can eat

683
00:39:48,380 --> 00:40:01,100
everybody he can even fly up into the

684
00:39:52,850 --> 00:40:04,520
sky for some reason so this is my main

685
00:40:01,100 --> 00:40:06,890
part actually of still five minutes left

686
00:40:04,520 --> 00:40:12,790
I can show you some additional content

687
00:40:06,890 --> 00:40:12,790
in case you want no who's that No

688
00:40:13,849 --> 00:40:22,740
this is not really file format related

689
00:40:17,130 --> 00:40:25,230
but it's windows maybe if I heard about

690
00:40:22,740 --> 00:40:27,868
dot URL files on Windows

691
00:40:25,230 --> 00:40:33,240
they are super old and still work in

692
00:40:27,869 --> 00:40:37,109
Windows 10 and I found this issue

693
00:40:33,240 --> 00:40:39,598
because of an ascetic necessity we often

694
00:40:37,109 --> 00:40:43,319
had one abilities where we can execute a

695
00:40:39,599 --> 00:40:46,950
program on Windows but we weren't able

696
00:40:43,319 --> 00:40:49,950
to pass any parameters and just opening

697
00:40:46,950 --> 00:40:53,129
calculator and CMD all the time is kind

698
00:40:49,950 --> 00:40:58,618
of boring I wanted to prove that we can

699
00:40:53,130 --> 00:41:01,770
actually execute our own code so when

700
00:40:58,619 --> 00:41:04,010
you execute you can of course point to

701
00:41:01,770 --> 00:41:07,319
an SMB share or ripped-off share and

702
00:41:04,010 --> 00:41:08,819
execute an executable from there but

703
00:41:07,319 --> 00:41:11,220
then it's blocked there is like this

704
00:41:08,819 --> 00:41:14,038
nice warning box do you really want to

705
00:41:11,220 --> 00:41:16,740
execute it so I have had to find a way

706
00:41:14,039 --> 00:41:19,289
around that and there was a nice thing

707
00:41:16,740 --> 00:41:24,930
called DLL hijacking which still still

708
00:41:19,289 --> 00:41:27,480
is a thing and I decided to use the docs

709
00:41:24,930 --> 00:41:29,759
URL file format because you can execute

710
00:41:27,480 --> 00:41:32,520
it from a remote SMB share without a

711
00:41:29,760 --> 00:41:34,920
warning you can define the application

712
00:41:32,520 --> 00:41:37,980
which should get executed and you can

713
00:41:34,920 --> 00:41:39,720
define the working directory and you can

714
00:41:37,980 --> 00:41:45,260
point the working directory to your

715
00:41:39,720 --> 00:41:48,689
remote as a be sure which is awesome so

716
00:41:45,260 --> 00:41:52,369
what will happen when you execute a lot

717
00:41:48,690 --> 00:41:55,049
of executables stored in Windows and

718
00:41:52,369 --> 00:42:00,980
point the working directory to your SMB

719
00:41:55,049 --> 00:42:06,990
sure that's basically what I did and I

720
00:42:00,980 --> 00:42:10,140
found that veined of CPL at least on two

721
00:42:06,990 --> 00:42:13,618
systems and one VM it worked

722
00:42:10,140 --> 00:42:16,078
and on one VM on my cubes it doesn't

723
00:42:13,619 --> 00:42:18,480
work for some reason it still tries to

724
00:42:16,079 --> 00:42:21,690
load it the remote DLL but then

725
00:42:18,480 --> 00:42:22,349
something fails I'm not sure yeah it's

726
00:42:21,690 --> 00:42:25,510
cute

727
00:42:22,349 --> 00:42:28,090
must be cute to secure

728
00:42:25,510 --> 00:42:32,650
yeah but basically how it works you can

729
00:42:28,090 --> 00:42:37,120
execute main dot Cpl which will is the

730
00:42:32,650 --> 00:42:40,600
settings for your mouse and then it will

731
00:42:37,120 --> 00:42:44,140
try to load master DLL from the remote

732
00:42:40,600 --> 00:42:47,980
SMB share and when it's there it gets

733
00:42:44,140 --> 00:42:54,299
executed and that's basically how I did

734
00:42:47,980 --> 00:42:54,300
it and have beautiful videos somewhere

735
00:42:58,350 --> 00:43:06,220
yeah in this case I just used my local

736
00:43:02,680 --> 00:43:11,049
seed dollar share but I verified it with

737
00:43:06,220 --> 00:43:13,810
remote SMB shares it's not worried so as

738
00:43:11,050 --> 00:43:17,410
you can see there is the mouse DLL this

739
00:43:13,810 --> 00:43:19,810
is the test dot your arrow file yeah you

740
00:43:17,410 --> 00:43:21,549
don't see the extension in case you're

741
00:43:19,810 --> 00:43:26,350
wondering yes you can change the icon

742
00:43:21,550 --> 00:43:36,010
because there is parameter for icon you

743
00:43:26,350 --> 00:43:38,710
want to use less you and yet this dot

744
00:43:36,010 --> 00:43:48,450
URL file basically contains this payload

745
00:43:38,710 --> 00:43:48,450
here and now you will see what happens

746
00:43:58,280 --> 00:44:07,640
and now it's open that's basically the

747
00:44:01,850 --> 00:44:10,400
normal window in case yeah I reported

748
00:44:07,640 --> 00:44:14,839
that to Microsoft there is a registry

749
00:44:10,400 --> 00:44:17,960
key you can set which nobody does Libre

750
00:44:14,840 --> 00:44:20,440
Office actually had a bypass which

751
00:44:17,960 --> 00:44:24,740
allowed me to abuse that but somebody

752
00:44:20,440 --> 00:44:26,710
reported it before me and now they have

753
00:44:24,740 --> 00:44:29,689
a similar behavior to Microsoft Office

754
00:44:26,710 --> 00:44:33,380
and what they do they actually pass the

755
00:44:29,690 --> 00:44:37,640
dot UL file and check the executable it

756
00:44:33,380 --> 00:44:41,750
points to so when you try to use the

757
00:44:37,640 --> 00:44:45,740
remote SMB dot URL file as a link in

758
00:44:41,750 --> 00:44:47,540
Microsoft Office you will see an

759
00:44:45,740 --> 00:44:51,529
dialogue with do you really want to

760
00:44:47,540 --> 00:44:53,930
execute main dot CPL and then you have

761
00:44:51,530 --> 00:44:56,900
to click like two times yes yes so it's

762
00:44:53,930 --> 00:45:00,109
not really nice so at least Microsoft is

763
00:44:56,900 --> 00:45:06,500
aware of that so yeah that's that thank

764
00:45:00,110 --> 00:45:12,350
you thank you Alex I think we have time

765
00:45:06,500 --> 00:45:15,500
for a few questions anyone getting tired

766
00:45:12,350 --> 00:45:17,480
here we have one let's see if I can make

767
00:45:15,500 --> 00:45:21,460
this work yep I can I think it's already

768
00:45:17,480 --> 00:45:24,110
up hello interesting talk thank you I

769
00:45:21,460 --> 00:45:25,660
don't know if you already said this but

770
00:45:24,110 --> 00:45:28,250
the when imagemagick

771
00:45:25,660 --> 00:45:31,819
uses libre office for file conversion

772
00:45:28,250 --> 00:45:35,690
does it also support Microsoft Office

773
00:45:31,820 --> 00:45:37,790
document formats oh yeah it does so you

774
00:45:35,690 --> 00:45:41,480
can you can use you can use certain

775
00:45:37,790 --> 00:45:43,279
features of Microsoft Office in Libre

776
00:45:41,480 --> 00:45:47,060
Office because it's supported you can

777
00:45:43,280 --> 00:45:49,160
also use the file extensions dot like

778
00:45:47,060 --> 00:45:52,040
you can literally use a created file

779
00:45:49,160 --> 00:45:54,470
from Microsoft Office sometimes you have

780
00:45:52,040 --> 00:45:56,230
to change the file extension in case

781
00:45:54,470 --> 00:45:58,819
there are some file extensions

782
00:45:56,230 --> 00:46:01,030
restrictions but in general yeah it

783
00:45:58,820 --> 00:46:04,220
works so did you look anything into the

784
00:46:01,030 --> 00:46:08,150
conversion or import feature so yeah I

785
00:46:04,220 --> 00:46:10,399
tested some of them but so far nothing

786
00:46:08,150 --> 00:46:12,400
came up but I just just got started

787
00:46:10,400 --> 00:46:17,120
awesome thank you

788
00:46:12,400 --> 00:46:20,240
so anyone else yeah I also can talk

789
00:46:17,120 --> 00:46:24,170
about Bishop movies I've 20 more I can

790
00:46:20,240 --> 00:46:26,390
talk about hi thanks it was great awk

791
00:46:24,170 --> 00:46:29,500
have you tried so I I don't know

792
00:46:26,390 --> 00:46:33,560
Microsoft Office supports the oddity

793
00:46:29,500 --> 00:46:36,020
format and if yes can you every was dead

794
00:46:33,560 --> 00:46:41,120
in Microsoft Office yeah I tried that

795
00:46:36,020 --> 00:46:43,580
but microsoft office supports libre

796
00:46:41,120 --> 00:46:48,200
office file format because I actually

797
00:46:43,580 --> 00:46:50,900
dis lights were first created and first

798
00:46:48,200 --> 00:46:51,259
in the LibreOffice impress what it's

799
00:46:50,900 --> 00:46:53,780
called

800
00:46:51,260 --> 00:46:55,880
then in PowerPoint and then back to the

801
00:46:53,780 --> 00:46:59,900
profits so yeah you can switch between

802
00:46:55,880 --> 00:47:03,520
them but many features do not work like

803
00:46:59,900 --> 00:47:08,150
the micro support is not at all there

804
00:47:03,520 --> 00:47:11,830
sadly and yeah most stuff basically just

805
00:47:08,150 --> 00:47:16,490
gets ignored by Microsoft Office sadly

806
00:47:11,830 --> 00:47:18,740
anyone else here yes sir

807
00:47:16,490 --> 00:47:22,750
what be short movie is most be and

808
00:47:18,740 --> 00:47:26,410
therefore most awesome most awesome

809
00:47:22,750 --> 00:47:30,070
would say two-headed shark attack is

810
00:47:26,410 --> 00:47:36,230
really funny because to talk so much

811
00:47:30,070 --> 00:47:39,140
 all the time the worst one all

812
00:47:36,230 --> 00:47:42,350
the mega sharks are pretty terrible

813
00:47:39,140 --> 00:47:44,650
I think mega shark versus mechatronic

814
00:47:42,350 --> 00:47:50,930
shock

815
00:47:44,650 --> 00:47:54,730
and yeah it's a real movie by the way

816
00:47:50,930 --> 00:47:54,730
the free movies meet with Mega Shark

817
00:47:55,150 --> 00:48:07,270
thank you Alex for this amazing talk

818
00:47:59,080 --> 00:48:07,270
[Applause]

