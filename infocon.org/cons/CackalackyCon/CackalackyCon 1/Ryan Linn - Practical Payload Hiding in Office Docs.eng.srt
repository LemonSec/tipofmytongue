1
00:00:00,140 --> 00:00:04,588
thank you everybody I was told that I

2
00:00:03,120 --> 00:00:06,210
should always include an agenda slide so

3
00:00:04,589 --> 00:00:07,230
people know what they're in for and also

4
00:00:06,210 --> 00:00:12,000
whether or not they should get the hell

5
00:00:07,230 --> 00:00:15,030
out so what you guys I guess take a look

6
00:00:12,000 --> 00:00:16,560
there will be some code in this so if

7
00:00:15,030 --> 00:00:20,369
you're if you're into code this will be

8
00:00:16,560 --> 00:00:22,169
a lot of fun so for background I'm a

9
00:00:20,369 --> 00:00:25,920
security strategist for a large

10
00:00:22,170 --> 00:00:28,680
financial institution and so I enjoy

11
00:00:25,920 --> 00:00:31,320
training and teaching people stuff and

12
00:00:28,680 --> 00:00:34,680
so the research I'm gonna be presenting

13
00:00:31,320 --> 00:00:36,450
is furthering some stuff that I learned

14
00:00:34,680 --> 00:00:39,960
from one of my old co-workers a drupe on

15
00:00:36,450 --> 00:00:41,370
strim and I've taken it a couple extra

16
00:00:39,960 --> 00:00:45,780
steps and so we're gonna be talking a

17
00:00:41,370 --> 00:00:48,599
little bit about hiding malware in in

18
00:00:45,780 --> 00:00:50,610
office documents but also this will also

19
00:00:48,600 --> 00:00:54,870
apply to things like data exfiltration

20
00:00:50,610 --> 00:00:58,949
and stuff like that so the the problem

21
00:00:54,870 --> 00:01:00,809
that I wanted to solve was for fishing

22
00:00:58,949 --> 00:01:03,030
especially and obviously we we just

23
00:01:00,809 --> 00:01:05,518
learned a lot about profiling a MS or

24
00:01:03,030 --> 00:01:07,110
stuff for figuring out what people find

25
00:01:05,519 --> 00:01:11,010
interesting in order for fishing to

26
00:01:07,110 --> 00:01:13,680
happen one of the ways that is still

27
00:01:11,010 --> 00:01:15,450
really effective is Word documents the

28
00:01:13,680 --> 00:01:17,189
blue team's have started to catch on and

29
00:01:15,450 --> 00:01:19,590
there's getting better detection and

30
00:01:17,189 --> 00:01:23,220
things like fireEye Windows Defender

31
00:01:19,590 --> 00:01:25,110
it's is as far as I can tell just far

32
00:01:23,220 --> 00:01:27,390
above pretty much all the other

33
00:01:25,110 --> 00:01:30,240
antiviruses for detecting this I'm gonna

34
00:01:27,390 --> 00:01:31,530
keep making it harder and harder I our

35
00:01:30,240 --> 00:01:33,479
teams are used to looking at these

36
00:01:31,530 --> 00:01:35,850
documents and for a lot of these they

37
00:01:33,479 --> 00:01:38,100
can take a quick cursory look at the

38
00:01:35,850 --> 00:01:40,079
contents of the macro and go oh yeah

39
00:01:38,100 --> 00:01:42,899
that's another cobalt strike oh yeah

40
00:01:40,079 --> 00:01:46,070
that's another Metasploit and so it just

41
00:01:42,899 --> 00:01:48,270
makes it really easy for them and so

42
00:01:46,070 --> 00:01:49,710
what I wanted to figure out is can I

43
00:01:48,270 --> 00:01:53,310
make it more difficult for automated

44
00:01:49,710 --> 00:01:55,079
tools to look at these and the other

45
00:01:53,310 --> 00:01:58,560
thing I wanted to look at is so there

46
00:01:55,079 --> 00:01:59,850
are solutions out there to help and so I

47
00:01:58,560 --> 00:02:01,350
went through and I started looking at

48
00:01:59,850 --> 00:02:03,929
some of these and I'll have a resource

49
00:02:01,350 --> 00:02:06,119
for for some of these at the end and

50
00:02:03,930 --> 00:02:08,640
what I found is that many of them are

51
00:02:06,119 --> 00:02:11,280
detected and they're being detected

52
00:02:08,639 --> 00:02:13,170
pretty quickly so how can we improve

53
00:02:11,280 --> 00:02:13,470
these so the current things that I'm

54
00:02:13,170 --> 00:02:17,190
going

55
00:02:13,470 --> 00:02:19,830
mention cobalt strike how many people

56
00:02:17,190 --> 00:02:21,300
here have used cobalt strike okay so a

57
00:02:19,830 --> 00:02:22,950
lot more people are using cobalt strike

58
00:02:21,300 --> 00:02:24,960
it has the ability to build Word Excel

59
00:02:22,950 --> 00:02:26,670
macros and it's pretty decent

60
00:02:24,960 --> 00:02:27,840
but it doesn't really do anything to

61
00:02:26,670 --> 00:02:30,839
hide itself it's pretty much

62
00:02:27,840 --> 00:02:32,280
straightforward Metasploit does office

63
00:02:30,840 --> 00:02:35,460
macros that work for a couple of

64
00:02:32,280 --> 00:02:37,380
different types Empire I want to

65
00:02:35,460 --> 00:02:39,120
especially call Empire they don't just

66
00:02:37,380 --> 00:02:42,810
have office macros they have max support

67
00:02:39,120 --> 00:02:44,700
so if you're efficient on max you know

68
00:02:42,810 --> 00:02:48,810
and there's not a lot of other security

69
00:02:44,700 --> 00:02:50,790
things there give Empire a try and so

70
00:02:48,810 --> 00:02:53,100
one of the the ones that I came across

71
00:02:50,790 --> 00:02:55,320
that has been pretty effective in the

72
00:02:53,100 --> 00:02:57,840
past has been cactus torch and for this

73
00:02:55,320 --> 00:03:00,660
that don't know what cactus torches it's

74
00:02:57,840 --> 00:03:02,760
a way of embedding a calm object into a

75
00:03:00,660 --> 00:03:05,970
Word document and then using that calm

76
00:03:02,760 --> 00:03:10,950
object to run your code and so it's a

77
00:03:05,970 --> 00:03:13,170
little bit more I guess effective than a

78
00:03:10,950 --> 00:03:15,600
lot of the others because it's harder to

79
00:03:13,170 --> 00:03:18,480
to pick up on but since it became

80
00:03:15,600 --> 00:03:21,120
popular a lot of the antivirus vendors

81
00:03:18,480 --> 00:03:22,590
have signatures for it and so if you're

82
00:03:21,120 --> 00:03:25,350
interested in these attacks and there's

83
00:03:22,590 --> 00:03:28,650
a number of more a number of others it I

84
00:03:25,350 --> 00:03:32,280
red team there's an entire list of

85
00:03:28,650 --> 00:03:34,920
different attack vectors so what's our

86
00:03:32,280 --> 00:03:38,010
problem most of these techniques get

87
00:03:34,920 --> 00:03:40,410
caught or blocked and one of the the

88
00:03:38,010 --> 00:03:44,160
ones that was one of my favorites was

89
00:03:40,410 --> 00:03:45,630
the remote off a remote document

90
00:03:44,160 --> 00:03:47,609
templates where you could actually give

91
00:03:45,630 --> 00:03:50,160
somebody a normal word document make a

92
00:03:47,610 --> 00:03:52,410
malicious macro and then put it on a

93
00:03:50,160 --> 00:03:54,510
remote HTTP server so that got patched

94
00:03:52,410 --> 00:03:55,980
earlier this year and so Microsoft is

95
00:03:54,510 --> 00:03:58,679
now starting to aggressively go after

96
00:03:55,980 --> 00:04:00,630
these things and so that is making it a

97
00:03:58,680 --> 00:04:02,340
little bit harder defenders getting

98
00:04:00,630 --> 00:04:04,019
better at detecting me so defender now

99
00:04:02,340 --> 00:04:06,300
has some behavior analytics for things

100
00:04:04,020 --> 00:04:08,040
happening out of office documents that

101
00:04:06,300 --> 00:04:11,730
some that's able to catch some of this

102
00:04:08,040 --> 00:04:12,929
stuff Symantec and McAfee your mileage

103
00:04:11,730 --> 00:04:15,840
may vary

104
00:04:12,930 --> 00:04:17,760
so sometimes I see things getting caught

105
00:04:15,840 --> 00:04:19,410
that I'm really surprised about and

106
00:04:17,760 --> 00:04:23,039
other things that I think should be

107
00:04:19,410 --> 00:04:25,260
absolutely blatantly malicious when they

108
00:04:23,039 --> 00:04:26,070
looks at it it's like a whatever so

109
00:04:25,260 --> 00:04:29,039
prints

110
00:04:26,070 --> 00:04:31,380
so I just tried Metasploit to reveal the

111
00:04:29,040 --> 00:04:34,380
other day and it was like go for it and

112
00:04:31,380 --> 00:04:36,900
so you know this the stuff that I'm

113
00:04:34,380 --> 00:04:39,540
gonna be talking about is for when these

114
00:04:36,900 --> 00:04:40,859
these things don't work but like I said

115
00:04:39,540 --> 00:04:43,290
Irish can sort through these really

116
00:04:40,860 --> 00:04:45,780
quickly one of the ones that I look at

117
00:04:43,290 --> 00:04:48,330
when I'm looking at my payloads to see

118
00:04:45,780 --> 00:04:51,780
what is really out there is a levy ba

119
00:04:48,330 --> 00:04:55,109
and OE VBA is a Python tool that will

120
00:04:51,780 --> 00:04:56,520
dump the macro out of an office document

121
00:04:55,110 --> 00:04:58,470
and then give you some basic analysis

122
00:04:56,520 --> 00:05:00,780
it'll tell you you know how many base64

123
00:04:58,470 --> 00:05:02,430
strings that sees whether or not it sees

124
00:05:00,780 --> 00:05:04,049
any kind of interesting in codings and

125
00:05:02,430 --> 00:05:05,490
that sort of stuff one of the things

126
00:05:04,050 --> 00:05:06,780
that I've noticed when I've been looking

127
00:05:05,490 --> 00:05:08,400
at things of mine that I've gotten

128
00:05:06,780 --> 00:05:10,770
caught and things that haven't gotten

129
00:05:08,400 --> 00:05:12,599
caught is it seems to correlate with

130
00:05:10,770 --> 00:05:14,280
fireEye a little bit the number of

131
00:05:12,600 --> 00:05:16,080
things in that list versus whether or

132
00:05:14,280 --> 00:05:18,630
not it makes it through so I don't know

133
00:05:16,080 --> 00:05:20,490
if like there's anything besides

134
00:05:18,630 --> 00:05:22,950
circumstantial stuff there but it seems

135
00:05:20,490 --> 00:05:24,840
like when my list is small everything is

136
00:05:22,950 --> 00:05:29,460
happy and when it's not I'm gonna have a

137
00:05:24,840 --> 00:05:32,510
bad time so one of the the other things

138
00:05:29,460 --> 00:05:35,940
that is has a lot of potential is

139
00:05:32,510 --> 00:05:37,469
stomping so stomping this basically when

140
00:05:35,940 --> 00:05:39,300
you have a macro it's actually kept in

141
00:05:37,470 --> 00:05:43,350
two places is kept in byte code and it's

142
00:05:39,300 --> 00:05:44,880
kept in text and if you have a document

143
00:05:43,350 --> 00:05:47,160
that was built on the exact same

144
00:05:44,880 --> 00:05:49,409
platform that you are going after you

145
00:05:47,160 --> 00:05:50,970
can get rid of that text and it will

146
00:05:49,410 --> 00:05:53,700
still run in when somebody opens the

147
00:05:50,970 --> 00:05:56,750
macro it'll just be blank but unless you

148
00:05:53,700 --> 00:05:58,710
were really good at Euro ascent or

149
00:05:56,750 --> 00:06:00,390
you're cooking against a small enough

150
00:05:58,710 --> 00:06:03,630
company that they're predictable most

151
00:06:00,390 --> 00:06:05,310
big companies you know even though they

152
00:06:03,630 --> 00:06:08,010
have patching who knows what you're

153
00:06:05,310 --> 00:06:10,350
actually gonna get and so it's kind of

154
00:06:08,010 --> 00:06:11,909
tough but that works one of the tools to

155
00:06:10,350 --> 00:06:13,770
do this this pretty effective is evil

156
00:06:11,910 --> 00:06:17,400
Clippy yes I haven't checked out evil

157
00:06:13,770 --> 00:06:19,109
Clippy check that out so the other thing

158
00:06:17,400 --> 00:06:22,890
is people with even basic IDI are

159
00:06:19,110 --> 00:06:25,020
looking for a powershell and a lot of

160
00:06:22,890 --> 00:06:26,159
the time people are running these macros

161
00:06:25,020 --> 00:06:29,159
and they're just trying to show up

162
00:06:26,160 --> 00:06:32,190
PowerShell stuff and it's completely

163
00:06:29,160 --> 00:06:35,330
obvious when it happens so one of the

164
00:06:32,190 --> 00:06:37,500
things that I've been doing with this is

165
00:06:35,330 --> 00:06:39,090
going with cactus torch and the reason

166
00:06:37,500 --> 00:06:39,780
is cactus torch doesn't have to show up

167
00:06:39,090 --> 00:06:43,619
power show

168
00:06:39,780 --> 00:06:45,719
so even with obfuscation most of these

169
00:06:43,620 --> 00:06:48,120
macros it's really easy to tell what

170
00:06:45,720 --> 00:06:49,740
they are part of it is is because even

171
00:06:48,120 --> 00:06:52,050
with obfuscation it looks like just

172
00:06:49,740 --> 00:06:53,550
pages and pages of goggle goop because

173
00:06:52,050 --> 00:06:55,320
your payload has to be big enough to be

174
00:06:53,550 --> 00:06:57,480
in there and it's like why is all this

175
00:06:55,320 --> 00:07:02,130
base64 trash in the middle of this thing

176
00:06:57,480 --> 00:07:05,340
so with cactus torch like I said it

177
00:07:02,130 --> 00:07:07,800
actually uses a comma the stock macro is

178
00:07:05,340 --> 00:07:10,530
detected by some stuff but we have

179
00:07:07,800 --> 00:07:12,810
opposable digits so we got tools and so

180
00:07:10,530 --> 00:07:15,119
this was my starting point right so

181
00:07:12,810 --> 00:07:17,760
let's take a quick look at how to

182
00:07:15,120 --> 00:07:20,790
actually do this with cobalt strike and

183
00:07:17,760 --> 00:07:23,400
cactus torch to start off with so the

184
00:07:20,790 --> 00:07:25,230
first thing we do is by grabbing the

185
00:07:23,400 --> 00:07:26,760
cactus torch to get repo it's got a

186
00:07:25,230 --> 00:07:31,980
couple of things in it one is it has a

187
00:07:26,760 --> 00:07:34,409
CNA file for for cobalt strike and when

188
00:07:31,980 --> 00:07:38,870
we load this in you basically just click

189
00:07:34,410 --> 00:07:42,930
load and then you go to your file and

190
00:07:38,870 --> 00:07:45,600
you load in the CNA file when you load

191
00:07:42,930 --> 00:07:47,400
in the CNA file you'll get a new option

192
00:07:45,600 --> 00:07:50,160
under attack once you see it loaded

193
00:07:47,400 --> 00:07:52,409
there if you go up under attacks you can

194
00:07:50,160 --> 00:07:56,340
say host cactus torch payload and so

195
00:07:52,410 --> 00:07:57,840
some of the stuff here URI path doesn't

196
00:07:56,340 --> 00:08:00,599
really matter for this because we're

197
00:07:57,840 --> 00:08:02,130
going to use a stage 'less payload one

198
00:08:00,600 --> 00:08:03,870
of the differences between a stage

199
00:08:02,130 --> 00:08:05,760
payload Ernest Ageless payload the

200
00:08:03,870 --> 00:08:07,890
stages payload keeps all the stuff in

201
00:08:05,760 --> 00:08:09,750
one place we're gonna create a VBA macro

202
00:08:07,890 --> 00:08:12,599
and one of the other things you saw

203
00:08:09,750 --> 00:08:14,880
there was the run DLL 32 when this

204
00:08:12,600 --> 00:08:16,890
actually spawns it's gonna process how

205
00:08:14,880 --> 00:08:18,390
it'll run D low of 32 and shove our

206
00:08:16,890 --> 00:08:21,890
stuff into that because it's not power

207
00:08:18,390 --> 00:08:25,530
so so now we open up word and we go

208
00:08:21,890 --> 00:08:27,690
under view and go to macros and so we're

209
00:08:25,530 --> 00:08:28,950
going to just create a fake name one of

210
00:08:27,690 --> 00:08:31,320
the things we want to make sure we do is

211
00:08:28,950 --> 00:08:32,968
don't contaminate our template we're

212
00:08:31,320 --> 00:08:35,789
gonna go to the actual word document

213
00:08:32,969 --> 00:08:38,280
itself and create and then we just past

214
00:08:35,789 --> 00:08:41,010
paste this guy in so one of the things

215
00:08:38,280 --> 00:08:44,039
you'll notice is that this is a ton of

216
00:08:41,010 --> 00:08:47,160
code and that doesn't look malicious at

217
00:08:44,039 --> 00:08:48,890
all right that looks everybody's macros

218
00:08:47,160 --> 00:08:53,930
look exactly like that

219
00:08:48,890 --> 00:08:55,910
so so yeah the other thing that you'll

220
00:08:53,930 --> 00:08:59,569
notice is like things are called binary

221
00:08:55,910 --> 00:09:03,079
and code and so I mean it doesn't even

222
00:08:59,570 --> 00:09:06,430
try right so here what you can see is is

223
00:09:03,079 --> 00:09:09,800
actually allocating this as a stream

224
00:09:06,430 --> 00:09:11,839
deserializing hex code and then it's

225
00:09:09,800 --> 00:09:13,569
creating the objects creating the

226
00:09:11,839 --> 00:09:19,250
instance and then you see Oh dot flame

227
00:09:13,570 --> 00:09:22,040
which is a method in the cactus torch

228
00:09:19,250 --> 00:09:24,680
comm object and so all of those are

229
00:09:22,040 --> 00:09:25,699
really easy for any virus to pick up so

230
00:09:24,680 --> 00:09:28,010
we're going to do is we're going to take

231
00:09:25,700 --> 00:09:30,380
that and we're gonna save it so when we

232
00:09:28,010 --> 00:09:32,839
save it by default you have docx files

233
00:09:30,380 --> 00:09:34,760
docx files are really easy to look into

234
00:09:32,839 --> 00:09:36,170
because they're basically zip files so

235
00:09:34,760 --> 00:09:39,649
we're actually gonna change this to just

236
00:09:36,170 --> 00:09:42,170
a docx file and the docx file supports

237
00:09:39,649 --> 00:09:46,130
macros without having to have any kind

238
00:09:42,170 --> 00:09:47,750
of special extension and so it tends to

239
00:09:46,130 --> 00:09:50,060
make it through things like fire I a

240
00:09:47,750 --> 00:09:54,560
little bit more easily so now when we

241
00:09:50,060 --> 00:09:57,680
look at this with le VBA you can see my

242
00:09:54,560 --> 00:10:00,469
sweet typing skills we look at this with

243
00:09:57,680 --> 00:10:04,399
lav bei VBA one of the things that we're

244
00:10:00,470 --> 00:10:06,920
gonna see is that there's just tons of

245
00:10:04,399 --> 00:10:08,870
stuff tons of stuff that it finds pages

246
00:10:06,920 --> 00:10:12,890
and pages of things that look funny so

247
00:10:08,870 --> 00:10:16,930
you see here you know base64 strings hex

248
00:10:12,890 --> 00:10:19,040
data the actual like you know code

249
00:10:16,930 --> 00:10:21,859
comments all of that sort of stuff

250
00:10:19,040 --> 00:10:24,829
all of these dll's and so unless you

251
00:10:21,860 --> 00:10:27,800
have some sort of you know severely

252
00:10:24,829 --> 00:10:29,719
challenged incident responder this

253
00:10:27,800 --> 00:10:33,560
should be completely obvious what it is

254
00:10:29,720 --> 00:10:35,420
right and so if you give your instant

255
00:10:33,560 --> 00:10:36,768
responder this and they can't figure it

256
00:10:35,420 --> 00:10:38,899
out then you need a new instant

257
00:10:36,769 --> 00:10:41,750
responder so now we look at this we see

258
00:10:38,899 --> 00:10:44,690
all of these suite macros auto open auto

259
00:10:41,750 --> 00:10:46,190
open workbook open which some of those

260
00:10:44,690 --> 00:10:49,670
are forward some of those are for excel

261
00:10:46,190 --> 00:10:52,550
and so that's also a dead giveaway and

262
00:10:49,670 --> 00:10:53,750
then the one called run you know this is

263
00:10:52,550 --> 00:10:55,819
pretty special too

264
00:10:53,750 --> 00:10:58,699
so now when we run this we see we get

265
00:10:55,820 --> 00:11:02,130
our beacon back in order to run this I

266
00:10:58,699 --> 00:11:04,260
had to turn off defender hard

267
00:11:02,130 --> 00:11:07,710
otherwise defender was just it didn't

268
00:11:04,260 --> 00:11:10,319
even let me get close so you know at

269
00:11:07,710 --> 00:11:13,170
this point we have our cell and that was

270
00:11:10,320 --> 00:11:16,260
successful so that was our starting

271
00:11:13,170 --> 00:11:20,310
point but we can do better we certainly

272
00:11:16,260 --> 00:11:22,740
can't do worse so one of the things that

273
00:11:20,310 --> 00:11:24,359
I wanted to look at is where can what

274
00:11:22,740 --> 00:11:26,750
hidey-holes can we put this stuff in

275
00:11:24,360 --> 00:11:29,670
right so some of the things that came up

276
00:11:26,750 --> 00:11:31,529
metadata metadata is a nice place to

277
00:11:29,670 --> 00:11:32,939
store stuff unfortunately you can look

278
00:11:31,529 --> 00:11:34,529
at it through the GUI you can look at

279
00:11:32,940 --> 00:11:38,010
the document properties you can see all

280
00:11:34,529 --> 00:11:40,170
that so like again incident responders

281
00:11:38,010 --> 00:11:41,790
if they're you know half-decent they're

282
00:11:40,170 --> 00:11:44,339
gonna right-click and look to see what

283
00:11:41,790 --> 00:11:47,250
it's there or just dump it with a tool

284
00:11:44,339 --> 00:11:48,720
and it's gonna be obvious image alt tags

285
00:11:47,250 --> 00:11:50,550
this is one that I don't think people

286
00:11:48,720 --> 00:11:52,680
have looked at a lot and it's kind of

287
00:11:50,550 --> 00:11:54,870
neat the problem is is you have to dump

288
00:11:52,680 --> 00:11:56,910
a bunch of images in there because the

289
00:11:54,870 --> 00:12:00,150
alt tags have a maximum of 255

290
00:11:56,910 --> 00:12:02,850
characters so if you have a couple K

291
00:12:00,150 --> 00:12:06,630
payload you know that's a lot of images

292
00:12:02,850 --> 00:12:08,970
anyway so the other thing is is you can

293
00:12:06,630 --> 00:12:11,310
always hide the images too to limit

294
00:12:08,970 --> 00:12:13,440
visibility so maybe that doesn't matter

295
00:12:11,310 --> 00:12:16,619
as much but you end up with just a huge

296
00:12:13,440 --> 00:12:20,190
document file and so the other thing is

297
00:12:16,620 --> 00:12:21,630
document text and so that is okay you

298
00:12:20,190 --> 00:12:23,490
can make it really small make it white

299
00:12:21,630 --> 00:12:25,110
and maybe people won't see it but as

300
00:12:23,490 --> 00:12:26,670
soon as you actually like dump the

301
00:12:25,110 --> 00:12:30,230
document with any tools it's completely

302
00:12:26,670 --> 00:12:34,079
obvious so one of the things that I

303
00:12:30,230 --> 00:12:36,089
wanted to look at was how how do we hide

304
00:12:34,080 --> 00:12:38,640
this stuff so that it's a little bit

305
00:12:36,089 --> 00:12:40,620
easier so my favorite right now is

306
00:12:38,640 --> 00:12:42,089
document variables for people that may

307
00:12:40,620 --> 00:12:43,680
not be familiar with document variables

308
00:12:42,089 --> 00:12:45,330
document variables are different than

309
00:12:43,680 --> 00:12:48,089
metadata variables document variables

310
00:12:45,330 --> 00:12:49,589
are there for programmers who want to be

311
00:12:48,089 --> 00:12:51,690
able to store some information inside

312
00:12:49,589 --> 00:12:53,370
the document the only place that you can

313
00:12:51,690 --> 00:12:56,610
see them is through the macro interface

314
00:12:53,370 --> 00:13:00,390
or if you pull up the raw XML you can't

315
00:12:56,610 --> 00:13:02,400
see it via the GUI at all and when you

316
00:13:00,390 --> 00:13:04,620
save to non word work formats it just

317
00:13:02,400 --> 00:13:06,480
strips these out so somebody were to

318
00:13:04,620 --> 00:13:08,550
dump this with a tool convert it to a

319
00:13:06,480 --> 00:13:10,320
text file something like that it just

320
00:13:08,550 --> 00:13:13,439
disappears so nobody will be able to

321
00:13:10,320 --> 00:13:15,360
tell what's there and so like I said XML

322
00:13:13,440 --> 00:13:18,210
and macros really the only way to see it

323
00:13:15,360 --> 00:13:19,680
forward 97 there isn't a way to see it

324
00:13:18,210 --> 00:13:20,880
that I can find programmatically in

325
00:13:19,680 --> 00:13:23,099
order to actually see it you have to

326
00:13:20,880 --> 00:13:24,660
convert it to a docx file and dump it

327
00:13:23,100 --> 00:13:27,840
out if you want to actually look at the

328
00:13:24,660 --> 00:13:30,089
pieces there without using macros so

329
00:13:27,840 --> 00:13:34,830
let's take a look about what this looks

330
00:13:30,090 --> 00:13:36,480
like in COBOL strike so the the tool

331
00:13:34,830 --> 00:13:38,160
that I created for this right now is

332
00:13:36,480 --> 00:13:40,560
being called better torch I'm gonna

333
00:13:38,160 --> 00:13:44,189
release it later this weekend it still

334
00:13:40,560 --> 00:13:47,729
needs a little bit of love but basically

335
00:13:44,190 --> 00:13:49,440
in our case we're going to load the the

336
00:13:47,730 --> 00:13:51,470
better torch module and I have made some

337
00:13:49,440 --> 00:13:56,580
changes and I'll talk about those as we

338
00:13:51,470 --> 00:13:58,410
go along so here we see the host better

339
00:13:56,580 --> 00:13:59,610
torch payload one of the things you'll

340
00:13:58,410 --> 00:14:02,160
notice down at the bottom is your

341
00:13:59,610 --> 00:14:04,200
options you have Word and Excel it has a

342
00:14:02,160 --> 00:14:06,000
little fewer options upfront so you have

343
00:14:04,200 --> 00:14:07,410
the Word or Excel there you need a

344
00:14:06,000 --> 00:14:09,060
little bit different strategy for each

345
00:14:07,410 --> 00:14:11,069
room go after the excel in a minute and

346
00:14:09,060 --> 00:14:13,229
so basically you do the same thing

347
00:14:11,070 --> 00:14:15,120
you've got clipboard so now we take that

348
00:14:13,230 --> 00:14:16,680
we go back into our Word document and

349
00:14:15,120 --> 00:14:18,420
we're gonna go back into our macros and

350
00:14:16,680 --> 00:14:21,180
we're gonna create our macro again and

351
00:14:18,420 --> 00:14:24,660
so this has it situated a little bit

352
00:14:21,180 --> 00:14:27,829
differently so that we can optimize how

353
00:14:24,660 --> 00:14:31,170
small it is so we just create our

354
00:14:27,830 --> 00:14:33,750
placeholder again copy all of our stuff

355
00:14:31,170 --> 00:14:36,750
and paste it so you'll notice that there

356
00:14:33,750 --> 00:14:38,580
is still all of this there right but we

357
00:14:36,750 --> 00:14:42,240
only need it for a minute as we put the

358
00:14:38,580 --> 00:14:43,560
things in the document variables so here

359
00:14:42,240 --> 00:14:46,980
one of the things that we're gonna do is

360
00:14:43,560 --> 00:14:49,050
because I am lazy I am gonna be using

361
00:14:46,980 --> 00:14:50,670
some of the scripting Microsoft

362
00:14:49,050 --> 00:14:52,500
scripting interface so we're gonna add

363
00:14:50,670 --> 00:14:54,959
in scripting interface so that I can

364
00:14:52,500 --> 00:14:57,450
each dictionaries instead of having to

365
00:14:54,960 --> 00:14:59,460
use one of VBA's data structures because

366
00:14:57,450 --> 00:15:06,450
it turns out that that is a horrible

367
00:14:59,460 --> 00:15:08,010
language and so anyway now when we look

368
00:15:06,450 --> 00:15:10,080
at this we see three things are two

369
00:15:08,010 --> 00:15:12,960
things we see deleteme setup which will

370
00:15:10,080 --> 00:15:15,210
run and once it's run we can delete all

371
00:15:12,960 --> 00:15:18,180
of that code so now we can just go in

372
00:15:15,210 --> 00:15:20,240
and delete delete' me setup and then

373
00:15:18,180 --> 00:15:22,650
when we go in we can edit this guy and

374
00:15:20,240 --> 00:15:24,290
instead of including all three we can

375
00:15:22,650 --> 00:15:28,860
pick just the one that we want and so

376
00:15:24,290 --> 00:15:33,930
for this one we're going to delete that

377
00:15:28,860 --> 00:15:37,290
and do the auto open the workbook open

378
00:15:33,930 --> 00:15:39,630
and the other Auto opener for Excel and

379
00:15:37,290 --> 00:15:42,540
so that is the only one forward so we do

380
00:15:39,630 --> 00:15:45,480
this and so now if you look you're

381
00:15:42,540 --> 00:15:46,770
limited to a whole lot less code you can

382
00:15:45,480 --> 00:15:49,050
look over at the scroll bar on the right

383
00:15:46,770 --> 00:15:52,980
and see so now we're using these active

384
00:15:49,050 --> 00:15:55,770
document variables and all the things

385
00:15:52,980 --> 00:15:57,380
are randomized we still have some to

386
00:15:55,770 --> 00:16:01,050
create objects and that sort of stuff

387
00:15:57,380 --> 00:16:03,480
and we still have the o dot flame so if

388
00:16:01,050 --> 00:16:04,920
we were to change our comm object then

389
00:16:03,480 --> 00:16:06,090
we can change the name of that o dot

390
00:16:04,920 --> 00:16:08,189
flame and we're going to talk about that

391
00:16:06,090 --> 00:16:09,450
in a minute too to hide that but

392
00:16:08,190 --> 00:16:11,670
unfortunately unless you change to comm

393
00:16:09,450 --> 00:16:14,220
object that has to persist so now all

394
00:16:11,670 --> 00:16:16,319
that we have is Auto open so let's take

395
00:16:14,220 --> 00:16:20,550
a look at this oh it's uh let's save

396
00:16:16,320 --> 00:16:24,990
this guy out we when we run him we

397
00:16:20,550 --> 00:16:27,780
should see our connection back so yeh

398
00:16:24,990 --> 00:16:30,270
that's good and so now when we save this

399
00:16:27,780 --> 00:16:34,829
guy we'll save it as a doc file again

400
00:16:30,270 --> 00:16:42,180
instead of a docx we'll see what the OL

401
00:16:34,830 --> 00:16:46,770
EVB a shows up and so you can save this

402
00:16:42,180 --> 00:16:48,660
as a docx file but our doc M file but

403
00:16:46,770 --> 00:16:50,819
you can't save it as a docx file docx

404
00:16:48,660 --> 00:16:52,949
files won't actually run the macro so

405
00:16:50,820 --> 00:16:56,850
now when we do this we we see we're down

406
00:16:52,950 --> 00:16:59,550
to two things we see the autoexec auto

407
00:16:56,850 --> 00:17:01,140
open and suspicious create object now

408
00:16:59,550 --> 00:17:03,540
for people who may have looked at a lot

409
00:17:01,140 --> 00:17:05,700
of macros there are a lot of reasons to

410
00:17:03,540 --> 00:17:07,740
include create object a lot of things

411
00:17:05,700 --> 00:17:10,920
that for instance pull data off the web

412
00:17:07,740 --> 00:17:13,609
or do anything that requires a dotnet

413
00:17:10,920 --> 00:17:16,020
library we'll have create object and so

414
00:17:13,609 --> 00:17:18,599
fire I for instance won't fire on that

415
00:17:16,020 --> 00:17:21,030
it's not suspicious enough and Auto open

416
00:17:18,599 --> 00:17:22,889
on itself isn't suspicious enough so

417
00:17:21,030 --> 00:17:26,399
this will make it through fire I and it

418
00:17:22,890 --> 00:17:29,190
will make it through most of the anti

419
00:17:26,400 --> 00:17:33,120
viruses and most of the the ingress

420
00:17:29,190 --> 00:17:35,370
things the way that you launch the

421
00:17:33,120 --> 00:17:36,989
common object depending on the settings

422
00:17:35,370 --> 00:17:39,870
for your defender it may or may not be

423
00:17:36,990 --> 00:17:40,850
seen by default I was able to get this

424
00:17:39,870 --> 00:17:43,459
running and

425
00:17:40,850 --> 00:17:45,918
be seen so one of the things I also

426
00:17:43,460 --> 00:17:47,270
wanted to do is give people a chance for

427
00:17:45,919 --> 00:17:47,660
questions before we move on to the next

428
00:17:47,270 --> 00:17:48,950
thing

429
00:17:47,660 --> 00:17:56,630
does anybody have questions before we

430
00:17:48,950 --> 00:17:58,429
move on to the next part yep it is not

431
00:17:56,630 --> 00:18:00,620
the ATP it is standard Windows Defender

432
00:17:58,429 --> 00:18:04,820
it has enough instrumentation to be able

433
00:18:00,620 --> 00:18:08,870
to tell when so the what it saw was the

434
00:18:04,820 --> 00:18:11,210
process Halloween function of cactus

435
00:18:08,870 --> 00:18:13,729
torch if you change the method it is

436
00:18:11,210 --> 00:18:14,990
less effective so one of the things

437
00:18:13,730 --> 00:18:17,510
number hang on for the future is

438
00:18:14,990 --> 00:18:18,350
basically extending the common object to

439
00:18:17,510 --> 00:18:20,090
do some more stuff and I'll talk about

440
00:18:18,350 --> 00:18:21,500
that some more in the future but just

441
00:18:20,090 --> 00:18:28,879
standard Windows Defender will pick it

442
00:18:21,500 --> 00:18:30,380
up yep um again it depends on what

443
00:18:28,880 --> 00:18:32,270
method you use process hollowing is

444
00:18:30,380 --> 00:18:33,950
pretty obvious there are some other

445
00:18:32,270 --> 00:18:39,020
methods that don't get picked up quite

446
00:18:33,950 --> 00:18:40,549
as easily and also EDR tools tend to pay

447
00:18:39,020 --> 00:18:42,559
attention in the first couple seconds

448
00:18:40,549 --> 00:18:45,889
and look at things that are happening in

449
00:18:42,559 --> 00:18:47,120
response so talk about remind me if I

450
00:18:45,890 --> 00:18:50,539
don't talk about that in a minute

451
00:18:47,120 --> 00:18:53,449
but there's one in what comes next Auto

452
00:18:50,539 --> 00:18:55,400
Open is not the way to do this Auto open

453
00:18:53,450 --> 00:18:57,320
is more likely to get caught forcing

454
00:18:55,400 --> 00:19:00,020
user interaction is is the way around

455
00:18:57,320 --> 00:19:03,789
this any other questions before we move

456
00:19:00,020 --> 00:19:03,789
on and talk about Excel a little bit

457
00:19:04,059 --> 00:19:10,520
okay so Excel documents um

458
00:19:08,530 --> 00:19:15,168
Excel documents don't have document

459
00:19:10,520 --> 00:19:16,610
variables which made me very sad and we

460
00:19:15,169 --> 00:19:18,679
hadn't been doing a lot of fishing with

461
00:19:16,610 --> 00:19:21,139
Excel documents but when we decided we

462
00:19:18,679 --> 00:19:24,860
needed to all of the things that I tried

463
00:19:21,140 --> 00:19:26,380
went horribly so this is gonna be a

464
00:19:24,860 --> 00:19:29,120
little bit my experience with that

465
00:19:26,380 --> 00:19:31,970
metadata again can be seen through the

466
00:19:29,120 --> 00:19:33,799
GUI image alt tags there aren't a lot of

467
00:19:31,970 --> 00:19:37,240
people that us a lot of images in

468
00:19:33,799 --> 00:19:41,840
spreadsheets but you can still use that

469
00:19:37,240 --> 00:19:44,270
and sheet text so she text can be hidden

470
00:19:41,840 --> 00:19:46,580
but it's easily recovered and converted

471
00:19:44,270 --> 00:19:48,320
to text so one of the things as I

472
00:19:46,580 --> 00:19:50,149
started researching I found out that

473
00:19:48,320 --> 00:19:52,790
there's actually three different visible

474
00:19:50,150 --> 00:19:54,440
States in Excel there's a visible which

475
00:19:52,790 --> 00:19:56,420
is visible in the GUI hidden

476
00:19:54,440 --> 00:19:58,910
which is on high double in the GUI but

477
00:19:56,420 --> 00:20:01,910
then there's extremely hidden which is I

478
00:19:58,910 --> 00:20:03,860
guess the Red Bull of like hiding so

479
00:20:01,910 --> 00:20:07,970
extremely hidden you can't unhide

480
00:20:03,860 --> 00:20:10,490
anywhere except for from the macro side

481
00:20:07,970 --> 00:20:12,760
you can you can change that there but if

482
00:20:10,490 --> 00:20:15,680
you convert this document to say PDF

483
00:20:12,760 --> 00:20:17,090
extremely hidden stays hidden so if you

484
00:20:15,680 --> 00:20:20,840
convert this to anything else it's still

485
00:20:17,090 --> 00:20:25,129
hidden so since we don't have document

486
00:20:20,840 --> 00:20:27,470
variables extremely hidden was the our

487
00:20:25,130 --> 00:20:30,230
way to go with this so you can put a bit

488
00:20:27,470 --> 00:20:33,140
32k NSL so that's not horrible

489
00:20:30,230 --> 00:20:36,520
the cactus torch payload itself for the

490
00:20:33,140 --> 00:20:38,900
comm object that's easily in 32 K and

491
00:20:36,520 --> 00:20:41,060
splitting the cobalt strike payload or

492
00:20:38,900 --> 00:20:43,790
any other payload up into 32 K chunks

493
00:20:41,060 --> 00:20:46,340
isn't actually that bad the problem is

494
00:20:43,790 --> 00:20:48,170
is Excel has some quirks and if anybody

495
00:20:46,340 --> 00:20:49,909
has ever worked with Excel you know that

496
00:20:48,170 --> 00:20:52,580
putting certain special characters at

497
00:20:49,910 --> 00:20:55,070
the front of fields means certain things

498
00:20:52,580 --> 00:20:56,570
like plus sign needs add this or an

499
00:20:55,070 --> 00:21:01,040
equal sign means something very specific

500
00:20:56,570 --> 00:21:04,220
and so that is cool and all but base64

501
00:21:01,040 --> 00:21:06,230
has plus signs and equal signs so you

502
00:21:04,220 --> 00:21:08,450
have to give it a little bit of

503
00:21:06,230 --> 00:21:10,550
attention to make sure you're not doing

504
00:21:08,450 --> 00:21:12,140
something stupid along the way so let's

505
00:21:10,550 --> 00:21:15,680
take a look at how this works under

506
00:21:12,140 --> 00:21:18,890
excel it's very similar we load up our

507
00:21:15,680 --> 00:21:21,680
better torch well generate our payload

508
00:21:18,890 --> 00:21:23,240
we'll select Excel and we'll do the same

509
00:21:21,680 --> 00:21:25,010
thing one of the things I'll mention is

510
00:21:23,240 --> 00:21:27,800
one of the things that you saw in here

511
00:21:25,010 --> 00:21:29,600
was the register of 32 as the binary

512
00:21:27,800 --> 00:21:30,830
that we're injecting into a lot of

513
00:21:29,600 --> 00:21:33,770
things we're looking at that right now

514
00:21:30,830 --> 00:21:39,129
you can actually use any binary that is

515
00:21:33,770 --> 00:21:41,780
in system 32 pause this once again huh

516
00:21:39,130 --> 00:21:46,520
you can actually use any binary that's

517
00:21:41,780 --> 00:21:48,830
in system 32 and the 64 and the reason

518
00:21:46,520 --> 00:21:50,960
it does that is it will make it platform

519
00:21:48,830 --> 00:21:52,370
independent it looks to see things in

520
00:21:50,960 --> 00:21:54,650
both of those places there are a handful

521
00:21:52,370 --> 00:21:56,629
of binaries that exist in both places so

522
00:21:54,650 --> 00:21:57,590
pick one of those other binaries there's

523
00:21:56,630 --> 00:22:00,560
a number of pieces of documentation

524
00:21:57,590 --> 00:22:03,649
about how to pick ones that are good and

525
00:22:00,560 --> 00:22:08,149
less likely to be to be detected run dll

526
00:22:03,650 --> 00:22:10,340
is your worst idea basically so by two

527
00:22:08,150 --> 00:22:13,310
all you know your mileage may vary

528
00:22:10,340 --> 00:22:19,010
picking others will we'll give you some

529
00:22:13,310 --> 00:22:20,300
improvements and so yeah basically all

530
00:22:19,010 --> 00:22:23,000
that that does is the binary you're

531
00:22:20,300 --> 00:22:24,680
injecting into and so that keeps you

532
00:22:23,000 --> 00:22:27,800
from not having to switch between 32 and

533
00:22:24,680 --> 00:22:29,900
64-bit so here what we see is we have

534
00:22:27,800 --> 00:22:31,909
basically the same stuff we have the

535
00:22:29,900 --> 00:22:35,300
scripting dictionary again we're gonna

536
00:22:31,910 --> 00:22:37,250
have to add back in the the stuff the

537
00:22:35,300 --> 00:22:40,450
scripting dictionary so we go back to

538
00:22:37,250 --> 00:22:43,240
our references we add back in that and

539
00:22:40,450 --> 00:22:45,800
we're gonna basically do the same thing

540
00:22:43,240 --> 00:22:47,150
one of the things that we'll see along

541
00:22:45,800 --> 00:22:51,980
the way is we're gonna I'm gonna show

542
00:22:47,150 --> 00:22:53,870
you guys how to fix when you when you

543
00:22:51,980 --> 00:22:56,090
hit one of those equal sign errors so

544
00:22:53,870 --> 00:22:58,250
here we have our delete me setup so we

545
00:22:56,090 --> 00:23:00,340
go to that function and we run it and

546
00:22:58,250 --> 00:23:03,920
we've see this awesome out of memory

547
00:23:00,340 --> 00:23:05,990
what does that even mean out of memory

548
00:23:03,920 --> 00:23:08,000
for what so what out of memory in this

549
00:23:05,990 --> 00:23:12,350
case actually means is it just tried to

550
00:23:08,000 --> 00:23:14,150
do a computation with that and obviously

551
00:23:12,350 --> 00:23:16,550
with all of those division and plus

552
00:23:14,150 --> 00:23:18,200
signs and everything else it was just

553
00:23:16,550 --> 00:23:22,370
like you know what screw it I'm going

554
00:23:18,200 --> 00:23:24,200
home so now we have to go back to the

555
00:23:22,370 --> 00:23:27,320
top of this and we see that it starts

556
00:23:24,200 --> 00:23:29,600
with a plus sign so our lete selves we

557
00:23:27,320 --> 00:23:32,030
delete the plus sign from there and move

558
00:23:29,600 --> 00:23:35,179
it to the next line and like magic it

559
00:23:32,030 --> 00:23:38,480
works so now we do that now the problem

560
00:23:35,180 --> 00:23:41,090
is is because our sheet two cleverly

561
00:23:38,480 --> 00:23:43,070
called bo xq three already exists and

562
00:23:41,090 --> 00:23:46,459
it's very hidden in order to delete it

563
00:23:43,070 --> 00:23:48,679
we have to make it visible again and so

564
00:23:46,460 --> 00:23:50,000
once we've made it visible again after

565
00:23:48,680 --> 00:23:51,140
we stop the debugger because you also

566
00:23:50,000 --> 00:23:53,750
can't do it while the debugger is

567
00:23:51,140 --> 00:23:56,060
running so after we do that we set it

568
00:23:53,750 --> 00:23:58,160
back to visible and then we can come and

569
00:23:56,060 --> 00:24:00,530
delete it you can see kind of what this

570
00:23:58,160 --> 00:24:02,210
actually looks like if you were to

571
00:24:00,530 --> 00:24:06,399
actually see that here so now we come

572
00:24:02,210 --> 00:24:12,080
back we go back to our delete me setup

573
00:24:06,400 --> 00:24:14,960
and we can run this guy again and now we

574
00:24:12,080 --> 00:24:18,590
see our sheet three when we look at our

575
00:24:14,960 --> 00:24:21,260
sheet three it's very hidden and so now

576
00:24:18,590 --> 00:24:24,889
we can delete our delete me setup

577
00:24:21,260 --> 00:24:27,350
move on with their lives so we also need

578
00:24:24,890 --> 00:24:32,170
to do our renaming and so here we can

579
00:24:27,350 --> 00:24:34,730
choose auto open or workbook open and so

580
00:24:32,170 --> 00:24:36,800
they basically do the same thing but are

581
00:24:34,730 --> 00:24:39,460
called at different points so depending

582
00:24:36,800 --> 00:24:42,050
on how this is rendered Auto open or

583
00:24:39,460 --> 00:24:44,690
workbook open will be more effective and

584
00:24:42,050 --> 00:24:47,180
there's entire like Microsoft articles

585
00:24:44,690 --> 00:24:50,870
that are not that interesting to me on

586
00:24:47,180 --> 00:24:52,670
the difference and so I haven't like I

587
00:24:50,870 --> 00:24:55,189
didn't pay a lot of attention to just

588
00:24:52,670 --> 00:24:57,380
know that it's different and the way

589
00:24:55,190 --> 00:24:59,690
that I wanted to do it was auto open so

590
00:24:57,380 --> 00:25:03,230
now we can delete our delete me setup we

591
00:24:59,690 --> 00:25:06,800
just have our auto open and again we can

592
00:25:03,230 --> 00:25:08,990
save this as a word 97 at gross so when

593
00:25:06,800 --> 00:25:15,050
we look at our cobalt strike it's not

594
00:25:08,990 --> 00:25:19,730
there when we run it it goes yeh shells

595
00:25:15,050 --> 00:25:21,530
okay so we now have our shell back and

596
00:25:19,730 --> 00:25:25,220
so if we want to look at what this looks

597
00:25:21,530 --> 00:25:26,930
like in Olli VBA we can go back and we

598
00:25:25,220 --> 00:25:39,170
can save this again and we're gonna save

599
00:25:26,930 --> 00:25:49,370
it as the 97 format and so to do again

600
00:25:39,170 --> 00:25:50,780
you see basically the same thing this

601
00:25:49,370 --> 00:25:52,580
one has a couple of things

602
00:25:50,780 --> 00:25:55,700
it has create object and it has text

603
00:25:52,580 --> 00:25:58,790
strings so the hex encoded strings were

604
00:25:55,700 --> 00:26:00,320
detected one of the things that if you

605
00:25:58,790 --> 00:26:03,980
actually look at it it turns out to be

606
00:26:00,320 --> 00:26:07,010
nothing we can fix this by changing the

607
00:26:03,980 --> 00:26:10,190
length of some of our variable names if

608
00:26:07,010 --> 00:26:11,720
it actually hits this if you just rerun

609
00:26:10,190 --> 00:26:14,060
the module and it randomizes it again

610
00:26:11,720 --> 00:26:15,530
it'll get rid of the heck strings it

611
00:26:14,060 --> 00:26:17,000
just so happens that if you hit a

612
00:26:15,530 --> 00:26:21,080
randomized string that only has

613
00:26:17,000 --> 00:26:24,320
lowercase between like 0 to 9 and then

614
00:26:21,080 --> 00:26:27,490
you know it's like oh that's hex so just

615
00:26:24,320 --> 00:26:31,429
rerun it again and it fixes it and so

616
00:26:27,490 --> 00:26:34,340
now we have a document that we can use

617
00:26:31,430 --> 00:26:35,480
so again if you run this again that'll

618
00:26:34,340 --> 00:26:38,270
go away

619
00:26:35,480 --> 00:26:43,010
and you'll only end up with those to be

620
00:26:38,270 --> 00:26:44,420
Auto open and create object again before

621
00:26:43,010 --> 00:26:47,960
I start talking some more about

622
00:26:44,420 --> 00:26:51,640
improving evasion anybody have questions

623
00:26:47,960 --> 00:26:51,640
on the excel piece yes sir

624
00:26:59,200 --> 00:27:06,560
sure and so the thing for this is it is

625
00:27:04,070 --> 00:27:08,960
not because it was using base64 this has

626
00:27:06,560 --> 00:27:12,560
everything to do with my crappy random

627
00:27:08,960 --> 00:27:17,150
string generator not the actual content

628
00:27:12,560 --> 00:27:20,179
of the payload so we figure out how to

629
00:27:17,150 --> 00:27:22,490
put this if I cared more where I didn't

630
00:27:20,180 --> 00:27:27,260
just rerun it then I would write a

631
00:27:22,490 --> 00:27:33,950
better random string generator and but I

632
00:27:27,260 --> 00:27:38,750
didn't so I when I make this public I

633
00:27:33,950 --> 00:27:41,960
welcome all of the pull requests so yeah

634
00:27:38,750 --> 00:27:44,720
anybody's welcome to fix my janky code

635
00:27:41,960 --> 00:27:48,140
if they would like and the first thing

636
00:27:44,720 --> 00:27:49,490
is probably better randomizers right now

637
00:27:48,140 --> 00:27:51,320
it's basically just looping through all

638
00:27:49,490 --> 00:27:53,600
of the characters are valid for base64

639
00:27:51,320 --> 00:27:55,189
well all the characters that are valid

640
00:27:53,600 --> 00:27:57,919
for vba this is another interesting

641
00:27:55,190 --> 00:28:00,920
little caveat not all characters are

642
00:27:57,920 --> 00:28:02,900
valid for VBA so you can't start

643
00:28:00,920 --> 00:28:05,390
variable names with numbers I haven't

644
00:28:02,900 --> 00:28:07,270
counted for that either so if you get a

645
00:28:05,390 --> 00:28:09,380
thing that has a number up front just

646
00:28:07,270 --> 00:28:16,190
rerun it and it'll be better next time

647
00:28:09,380 --> 00:28:16,730
so maybe maybe one day any other

648
00:28:16,190 --> 00:28:34,340
questions

649
00:28:16,730 --> 00:28:41,600
yep well they they were depending on the

650
00:28:34,340 --> 00:28:45,020
tools and I will say that it the quality

651
00:28:41,600 --> 00:28:47,750
of your fish will drastically change the

652
00:28:45,020 --> 00:28:48,350
outcome of this so are ones that have

653
00:28:47,750 --> 00:28:50,990
been really

654
00:28:48,350 --> 00:28:52,399
corphish's they gave it an additional

655
00:28:50,990 --> 00:28:57,350
look the ones that were really good

656
00:28:52,400 --> 00:29:01,460
fishes people claim credit for so we've

657
00:28:57,350 --> 00:29:02,840
had things that you know didn't didn't

658
00:29:01,460 --> 00:29:07,160
get responded to because they were

659
00:29:02,840 --> 00:29:08,539
really good-looking fishes and so all

660
00:29:07,160 --> 00:29:12,080
that sort of stuff is it's kind of

661
00:29:08,539 --> 00:29:14,150
interesting and the ones that were

662
00:29:12,080 --> 00:29:16,189
really bad looking they were like this

663
00:29:14,150 --> 00:29:21,010
looks exactly like a fish even if this

664
00:29:16,190 --> 00:29:21,010
document isn't malicious just be gone

665
00:29:21,460 --> 00:29:31,909
any other questions okay so improving a

666
00:29:28,850 --> 00:29:33,530
Bayesian so some of you guys asked about

667
00:29:31,909 --> 00:29:34,640
some other things that we can can do

668
00:29:33,530 --> 00:29:38,480
here so I'm going to talk about some of

669
00:29:34,640 --> 00:29:40,340
these one is add encryption so for

670
00:29:38,480 --> 00:29:42,350
adding the encryption one of the places

671
00:29:40,340 --> 00:29:44,209
that I'm looking at doing this is

672
00:29:42,350 --> 00:29:47,000
actually in the comma Becht so we can

673
00:29:44,210 --> 00:29:49,520
use AES encryption and then base the key

674
00:29:47,000 --> 00:29:51,289
off of environmental variables most

675
00:29:49,520 --> 00:29:52,520
people that fire I deployed don't have

676
00:29:51,289 --> 00:29:55,400
their corporate image sitting inside

677
00:29:52,520 --> 00:29:56,780
fire I so if something will only run in

678
00:29:55,400 --> 00:29:58,730
the corporate image it means it can't

679
00:29:56,780 --> 00:30:01,129
ever decrypt in fire I and most people

680
00:29:58,730 --> 00:30:03,140
don't do their instant response on a

681
00:30:01,130 --> 00:30:07,340
imaged machine for their environment so

682
00:30:03,140 --> 00:30:09,159
again they will have a bad time keying

683
00:30:07,340 --> 00:30:13,730
off environment variables is another one

684
00:30:09,159 --> 00:30:16,250
and so things the like host name domain

685
00:30:13,730 --> 00:30:18,620
name the domain SIDS a really good one

686
00:30:16,250 --> 00:30:19,970
it's hard for people to figure out if

687
00:30:18,620 --> 00:30:21,500
they don't know what they're looking for

688
00:30:19,970 --> 00:30:22,460
so if you can include something

689
00:30:21,500 --> 00:30:25,520
programmatic there

690
00:30:22,460 --> 00:30:27,020
it's nice user name patterns if your

691
00:30:25,520 --> 00:30:30,620
company has a very specific user name

692
00:30:27,020 --> 00:30:32,570
pattern and that's a good one and like I

693
00:30:30,620 --> 00:30:34,280
said it's nice to fire sandboxes and a

694
00:30:32,570 --> 00:30:35,178
lot of the other sandboxes because they

695
00:30:34,280 --> 00:30:37,450
don't know anything about your

696
00:30:35,179 --> 00:30:40,150
environment and so they typically won't

697
00:30:37,450 --> 00:30:43,850
won't run when you detonate them

698
00:30:40,150 --> 00:30:45,380
customizing cactus torch is the way that

699
00:30:43,850 --> 00:30:48,408
I have been going I've been slowly

700
00:30:45,380 --> 00:30:51,530
adding to my cactus torch comm object to

701
00:30:48,409 --> 00:30:53,900
include encryption include randomizers

702
00:30:51,530 --> 00:30:55,070
things to split stuff up more easily so

703
00:30:53,900 --> 00:30:56,690
that I can do a lot of the stuff that

704
00:30:55,070 --> 00:31:00,230
I'm currently doing in COBOL strike

705
00:30:56,690 --> 00:31:01,760
inside my actual word document macro so

706
00:31:00,230 --> 00:31:03,500
that I can use payload

707
00:31:01,760 --> 00:31:05,420
anywhere I don't have to just use cobalt

708
00:31:03,500 --> 00:31:07,670
strike there's a couple other c2

709
00:31:05,420 --> 00:31:09,590
frameworks that are coming out that show

710
00:31:07,670 --> 00:31:11,690
some promise and so want to be able to

711
00:31:09,590 --> 00:31:13,669
do as much of that in the actual common

712
00:31:11,690 --> 00:31:17,000
object as I can and for anybody who

713
00:31:13,670 --> 00:31:18,140
hasn't written comics they aren't like

714
00:31:17,000 --> 00:31:20,000
normal c-sharp code

715
00:31:18,140 --> 00:31:24,110
they're like c-sharp code that hates you

716
00:31:20,000 --> 00:31:26,960
so like if you're like I would like to

717
00:31:24,110 --> 00:31:28,459
use this data structure that will be the

718
00:31:26,960 --> 00:31:34,130
data structure that comm does not

719
00:31:28,460 --> 00:31:35,420
support so I had to call in a friend to

720
00:31:34,130 --> 00:31:36,950
make some of this work because I was

721
00:31:35,420 --> 00:31:38,330
like this doesn't make any sense and

722
00:31:36,950 --> 00:31:40,070
it's like yeah calm objects don't make

723
00:31:38,330 --> 00:31:42,340
sense you just have to roll with it and

724
00:31:40,070 --> 00:31:46,639
so I felt a little bit better about that

725
00:31:42,340 --> 00:31:48,830
but yeah so let's take a look at how to

726
00:31:46,640 --> 00:31:50,690
rebuild the comm object so that you can

727
00:31:48,830 --> 00:31:52,610
do it yourself if you want to add

728
00:31:50,690 --> 00:31:54,080
anything in you have to use Visual

729
00:31:52,610 --> 00:31:56,060
Studio for this so basically you just

730
00:31:54,080 --> 00:31:58,760
load it up we're going to start off with

731
00:31:56,060 --> 00:32:00,649
done at two jscript.net to jscript is

732
00:31:58,760 --> 00:32:06,170
how the comm object-- is actually

733
00:32:00,650 --> 00:32:09,410
encoded and put into the into the the

734
00:32:06,170 --> 00:32:10,610
cactus torch file and so we're gonna

735
00:32:09,410 --> 00:32:14,270
start off by building this we'll just

736
00:32:10,610 --> 00:32:16,790
build it and then we'll copy the release

737
00:32:14,270 --> 00:32:21,740
version of.net to jscript into the

738
00:32:16,790 --> 00:32:24,020
directory that has our our comm object

739
00:32:21,740 --> 00:32:32,690
in it so we're going to copy that guy

740
00:32:24,020 --> 00:32:35,420
here and so next thing we can do is we

741
00:32:32,690 --> 00:32:38,050
can actually use CSC which is command

742
00:32:35,420 --> 00:32:41,720
line c compiler for dotnet

743
00:32:38,050 --> 00:32:45,440
that that we can use we're gonna compile

744
00:32:41,720 --> 00:32:47,510
this into a library and so in the CS

745
00:32:45,440 --> 00:32:49,760
directory there's this cleverly named

746
00:32:47,510 --> 00:32:52,550
test class thus yes that they stole and

747
00:32:49,760 --> 00:32:54,440
extended from dotnet to JavaScript or

748
00:32:52,550 --> 00:32:56,899
Adana to jscript so now we have this

749
00:32:54,440 --> 00:33:00,410
test class DLL so now we need to turn

750
00:32:56,900 --> 00:33:02,660
the test class DLL into that hex object

751
00:33:00,410 --> 00:33:06,560
so what we're gonna do is we're gonna

752
00:33:02,660 --> 00:33:10,400
take done net to jscript and we're going

753
00:33:06,560 --> 00:33:14,200
to go ahead and tell it the language

754
00:33:10,400 --> 00:33:15,470
we're going to use as VBA we're going to

755
00:33:14,200 --> 00:33:19,070
go ahead

756
00:33:15,470 --> 00:33:22,970
until what files output 2 and so cactus

757
00:33:19,070 --> 00:33:24,620
WBA and then we're going to give it the

758
00:33:22,970 --> 00:33:26,539
Tusk loss and it's gonna say that

759
00:33:24,620 --> 00:33:29,330
doesn't work because it's called cactus

760
00:33:26,539 --> 00:33:32,809
torch but it was built into Tusk lost

761
00:33:29,330 --> 00:33:34,189
dll so I renamed mine so it's not called

762
00:33:32,809 --> 00:33:38,600
cactus torch anymore

763
00:33:34,190 --> 00:33:44,470
I know it's squirtle wolf cuz shells

764
00:33:38,600 --> 00:33:47,570
anyway for any Pokemon fans anyway so

765
00:33:44,470 --> 00:33:49,130
then it poops it back out into all of

766
00:33:47,570 --> 00:33:51,110
the hex stuff and then a bunch of stuff

767
00:33:49,130 --> 00:33:53,240
we don't care about so what we would do

768
00:33:51,110 --> 00:33:56,539
from here is we would steal that hex

769
00:33:53,240 --> 00:34:02,929
code and we would copy it into our CNA

770
00:33:56,539 --> 00:34:06,230
file in order to be able to just use all

771
00:34:02,929 --> 00:34:08,599
of this and so the things that you have

772
00:34:06,230 --> 00:34:10,580
to change when you rename the class I

773
00:34:08,599 --> 00:34:12,320
strongly recommend you call the actual

774
00:34:10,580 --> 00:34:14,090
executing method something besides flame

775
00:34:12,320 --> 00:34:16,340
because that is something that's

776
00:34:14,090 --> 00:34:18,310
triggering off of signatures you can

777
00:34:16,340 --> 00:34:22,250
call it literally anything that you want

778
00:34:18,310 --> 00:34:25,609
and the only thing is is that is the one

779
00:34:22,250 --> 00:34:29,330
thing that you can't obfuscate that has

780
00:34:25,609 --> 00:34:31,790
to just be so you can create a random

781
00:34:29,330 --> 00:34:34,339
name that looks obfuscated and then it

782
00:34:31,790 --> 00:34:36,230
is what it is I recommend not run

783
00:34:34,339 --> 00:34:39,889
malware or something like that or you

784
00:34:36,230 --> 00:34:41,030
have just wasted your time or not if

785
00:34:39,889 --> 00:34:46,339
you're just having fun with your instant

786
00:34:41,030 --> 00:34:49,790
responders so but but that's really the

787
00:34:46,339 --> 00:34:52,399
the only piece there so so looking ahead

788
00:34:49,790 --> 00:34:54,500
you know one of the things that I would

789
00:34:52,399 --> 00:34:57,290
love is some collaboration on this I

790
00:34:54,500 --> 00:34:58,670
have some ideas I'm probably not going

791
00:34:57,290 --> 00:35:00,800
to make the C sharp stuff that I'm

792
00:34:58,670 --> 00:35:02,089
working on public right away because

793
00:35:00,800 --> 00:35:02,690
people are stupid and submitted to

794
00:35:02,089 --> 00:35:07,040
virustotal

795
00:35:02,690 --> 00:35:08,359
and then I'm sad and so if this is

796
00:35:07,040 --> 00:35:10,369
something where somebody would like to

797
00:35:08,359 --> 00:35:11,779
collaborate I have my contact

798
00:35:10,369 --> 00:35:13,130
information at the end and people can

799
00:35:11,780 --> 00:35:15,619
chat with me so some of the things that

800
00:35:13,130 --> 00:35:17,990
I'm adding are different methods to

801
00:35:15,619 --> 00:35:20,000
actually execute code some different

802
00:35:17,990 --> 00:35:22,129
ways to hide it some built-in things to

803
00:35:20,000 --> 00:35:23,720
pull for some of the environment

804
00:35:22,130 --> 00:35:26,150
variables and stuff like that to make it

805
00:35:23,720 --> 00:35:29,000
a little bit easier to hide it

806
00:35:26,150 --> 00:35:30,050
and so

807
00:35:29,000 --> 00:35:31,910
you know one of the other things that I

808
00:35:30,050 --> 00:35:35,180
wanted to do was some unmanaged

809
00:35:31,910 --> 00:35:37,399
PowerShell and the comm object you can

810
00:35:35,180 --> 00:35:39,529
actually load PowerShell into itself

811
00:35:37,400 --> 00:35:40,820
and then you're just loading unmanaged

812
00:35:39,530 --> 00:35:45,740
PowerShell from within the word document

813
00:35:40,820 --> 00:35:47,720
and doing that and EDRs may see you

814
00:35:45,740 --> 00:35:49,729
loading unmanaged PowerShell but there's

815
00:35:47,720 --> 00:35:52,310
actually PowerShell extensions for word

816
00:35:49,730 --> 00:35:53,840
and so they may not be paying a whole

817
00:35:52,310 --> 00:35:55,190
lot of attention to that because you can

818
00:35:53,840 --> 00:35:56,480
actually do some PowerShell and word

819
00:35:55,190 --> 00:36:00,200
anyway

820
00:35:56,480 --> 00:36:04,610
and so encryption encryption is good I

821
00:36:00,200 --> 00:36:07,609
hear so and the last one is additional

822
00:36:04,610 --> 00:36:10,220
hidey-holes um the obviously everybody

823
00:36:07,610 --> 00:36:12,110
knows about document variables now so

824
00:36:10,220 --> 00:36:14,899
looking at some additional places to

825
00:36:12,110 --> 00:36:17,510
hide it some of the things that been

826
00:36:14,900 --> 00:36:18,710
looking at is you know actually what we

827
00:36:17,510 --> 00:36:20,180
can do with the document structure

828
00:36:18,710 --> 00:36:22,100
itself so that we can pull things back

829
00:36:20,180 --> 00:36:28,149
out of the document itself that may not

830
00:36:22,100 --> 00:36:28,150
be visible and some things like that so

831
00:36:28,900 --> 00:36:33,650
last thing I wanted to show you guys

832
00:36:31,460 --> 00:36:37,370
before we do some more questions is

833
00:36:33,650 --> 00:36:40,280
forensics so if we wanted to look at

834
00:36:37,370 --> 00:36:41,600
this I said the doc file there's not a

835
00:36:40,280 --> 00:36:43,700
whole lot you can do to get it out of

836
00:36:41,600 --> 00:36:45,680
this but if you suspect that something

837
00:36:43,700 --> 00:36:48,350
is malicious you can always turn it into

838
00:36:45,680 --> 00:36:50,930
a docx file we name the docx to a zip

839
00:36:48,350 --> 00:36:55,400
extract it and the document variables

840
00:36:50,930 --> 00:36:57,049
all live in settings.xml so settings.xml

841
00:36:55,400 --> 00:36:59,720
when you look at it it's usually pretty

842
00:36:57,050 --> 00:37:02,210
small when you start putting all of this

843
00:36:59,720 --> 00:37:04,700
crap in here you start seeing all these

844
00:37:02,210 --> 00:37:06,710
doc ver fields and these doc fair name

845
00:37:04,700 --> 00:37:08,540
equals blah and there's our a base64

846
00:37:06,710 --> 00:37:11,180
code so if we wanted to do some more

847
00:37:08,540 --> 00:37:12,580
trolling obviously we can encrypt that

848
00:37:11,180 --> 00:37:14,899
and then they can't do anything with it

849
00:37:12,580 --> 00:37:15,890
but this is the way that if somebody

850
00:37:14,900 --> 00:37:18,110
wanted to put this back together

851
00:37:15,890 --> 00:37:19,670
manually or without running this through

852
00:37:18,110 --> 00:37:21,590
a debugger or something else they can

853
00:37:19,670 --> 00:37:23,930
extract all of these out of here with

854
00:37:21,590 --> 00:37:28,640
their awesome perl skills or whatever

855
00:37:23,930 --> 00:37:31,370
people use these days and and then go

856
00:37:28,640 --> 00:37:35,779
through and match it up with what's in

857
00:37:31,370 --> 00:37:38,359
the actual code other than that edie are

858
00:37:35,780 --> 00:37:40,610
and that sort of stuff is as another way

859
00:37:38,360 --> 00:37:42,210
to do it one of the ways mint and coming

860
00:37:40,610 --> 00:37:45,530
back to your EDR question one

861
00:37:42,210 --> 00:37:49,730
the things for EDR I suggest putting

862
00:37:45,530 --> 00:37:52,530
form fields in and of some some kind

863
00:37:49,730 --> 00:37:55,230
sign up for our newsletter just type in

864
00:37:52,530 --> 00:37:57,840
your email and hit hear register for a

865
00:37:55,230 --> 00:37:59,310
free puppy you know whatever if people

866
00:37:57,840 --> 00:38:04,980
are mashing buttons which is especially

867
00:37:59,310 --> 00:38:05,880
common in Excel then hit ADR is like oh

868
00:38:04,980 --> 00:38:08,550
you meant to do that

869
00:38:05,880 --> 00:38:11,310
and so it's much less likely to fire for

870
00:38:08,550 --> 00:38:13,380
those sort of things so that is is one

871
00:38:11,310 --> 00:38:14,820
of the things that I found also if it

872
00:38:13,380 --> 00:38:18,570
you have to do mouse clicks it's another

873
00:38:14,820 --> 00:38:20,130
way to avoid detection on detonation of

874
00:38:18,570 --> 00:38:22,260
malware and something like fireEye or

875
00:38:20,130 --> 00:38:24,030
sandbox that sort of stuff so I

876
00:38:22,260 --> 00:38:25,890
recommend not using auto open

877
00:38:24,030 --> 00:38:27,930
it's also another line that doesn't show

878
00:38:25,890 --> 00:38:29,580
up but instead bind a function to

879
00:38:27,930 --> 00:38:34,669
something inside the actual dock itself

880
00:38:29,580 --> 00:38:36,960
and you'll be better off so with that

881
00:38:34,670 --> 00:38:37,760
I'm gonna go ahead and throw some things

882
00:38:36,960 --> 00:38:40,020
out

883
00:38:37,760 --> 00:38:41,910
drue bonds from is who originally showed

884
00:38:40,020 --> 00:38:43,830
me the document variables and a lot of

885
00:38:41,910 --> 00:38:46,220
the stuff was based off of and smart guy

886
00:38:43,830 --> 00:38:49,770
and so I wanted to give him thanks

887
00:38:46,220 --> 00:38:51,629
Walmart labs so Walmart labs has some

888
00:38:49,770 --> 00:38:54,630
really cool stuff that they've talked

889
00:38:51,630 --> 00:38:57,210
about including one of them is called a

890
00:38:54,630 --> 00:38:59,850
Phoenix called VBA seismograph which is

891
00:38:57,210 --> 00:39:01,920
a way to tell if people are using a lot

892
00:38:59,850 --> 00:39:04,049
of the techniques from evil Clippy

893
00:39:01,920 --> 00:39:05,460
within a document so if you're an

894
00:39:04,050 --> 00:39:07,770
instant responder and you haven't looked

895
00:39:05,460 --> 00:39:10,260
at their stuff go take a look it's a

896
00:39:07,770 --> 00:39:14,550
it's some really great material to kind

897
00:39:10,260 --> 00:39:17,280
of sort through some of this also for

898
00:39:14,550 --> 00:39:20,580
evil Clippy go check out the the

899
00:39:17,280 --> 00:39:24,710
techniques there and also the Red Team

900
00:39:20,580 --> 00:39:27,029
me site which has lots of these little

901
00:39:24,710 --> 00:39:28,980
things that you can do well I said some

902
00:39:27,030 --> 00:39:31,230
of them will work some of them malt but

903
00:39:28,980 --> 00:39:34,830
knowing what your options are is always

904
00:39:31,230 --> 00:39:38,490
a good place to be so if you want to to

905
00:39:34,830 --> 00:39:41,100
work on this stuff feel free to reach

906
00:39:38,490 --> 00:39:43,319
out and contact me hopefully folks have

907
00:39:41,100 --> 00:39:48,140
some more questions so give us some info

908
00:39:43,320 --> 00:39:48,140
questions and make anything

909
00:39:48,420 --> 00:39:53,130
so moving to encryption a lot of people

910
00:39:51,210 --> 00:39:56,549
are doing that to avoid you know

911
00:39:53,130 --> 00:39:58,799
simulation but then you're subject to

912
00:39:56,549 --> 00:40:09,690
interpret calculations and people are

913
00:39:58,799 --> 00:40:12,410
treating things with iuv ability yes um

914
00:40:09,690 --> 00:40:14,789
so the question was aren't you afraid of

915
00:40:12,410 --> 00:40:16,618
being identified because of entropy when

916
00:40:14,789 --> 00:40:18,089
you're using encryption and so the big

917
00:40:16,619 --> 00:40:19,650
thing is most of the tools that are

918
00:40:18,089 --> 00:40:22,470
looking at this can't actually pull this

919
00:40:19,650 --> 00:40:24,510
data out so really it's just to mess

920
00:40:22,470 --> 00:40:29,089
with the responders and the automated

921
00:40:24,510 --> 00:40:32,760
tools will never see it anyway so I

922
00:40:29,089 --> 00:40:34,950
think that for for some things that is

923
00:40:32,760 --> 00:40:37,799
definitely a possibility but I think

924
00:40:34,950 --> 00:40:40,339
that for the specific technique I'm not

925
00:40:37,799 --> 00:40:48,569
worrying too much about it other

926
00:40:40,339 --> 00:40:49,440
questions less chance okay thank you

927
00:40:48,569 --> 00:40:50,580
guys very much for your time I really

928
00:40:49,440 --> 00:40:55,110
appreciate it

929
00:40:50,580 --> 00:40:55,110
[Applause]

