1
00:00:01,669 --> 00:00:06,660
so it turns out that you are all in for

2
00:00:06,660 --> 00:00:10,950
a great treat so I was actually having a

3
00:00:10,950 --> 00:00:12,719
conversation with Jesse a little while

4
00:00:12,719 --> 00:00:15,179
ago I'm getting ready to introduce him

5
00:00:15,179 --> 00:00:17,760
and I was amazed to learn that he is a

6
00:00:17,760 --> 00:00:21,680
former astronaut which is pretty amazing

7
00:00:21,680 --> 00:00:23,640
seven years on the International Space

8
00:00:23,640 --> 00:00:25,980
Station he actually got bored of it so

9
00:00:25,980 --> 00:00:29,279
now he leads a red team and if you

10
00:00:29,279 --> 00:00:30,900
believe all that he's got a lot to tell

11
00:00:30,900 --> 00:00:32,668
us about the spearfishing experience

12
00:00:32,668 --> 00:00:34,500
right so he's gonna tell us about the

13
00:00:34,500 --> 00:00:37,410
real-world trial and errors that he made

14
00:00:37,410 --> 00:00:40,520
building and running a red team and also

15
00:00:40,520 --> 00:00:43,260
why to do things in a very OPSEC safe

16
00:00:43,260 --> 00:00:45,030
way and how to get a foothold with

17
00:00:45,030 --> 00:00:48,780
spearfishing so and of course in the in

18
00:00:48,780 --> 00:00:51,210
the ISS tradition we're gonna start off

19
00:00:51,210 --> 00:00:54,390
with the way we did there you know to

20
00:00:54,390 --> 00:01:00,600
our comrades shot of vodka Cheers good

21
00:01:00,600 --> 00:01:05,519
luck everyone so my talk is called

22
00:01:05,519 --> 00:01:07,740
Purple Haze the spearfishing experience

23
00:01:07,740 --> 00:01:12,600
featuring me so just a little bit about

24
00:01:12,600 --> 00:01:15,119
me if you if we never met before my name

25
00:01:15,119 --> 00:01:17,220
is Jesse doubling I'm on an internal red

26
00:01:17,220 --> 00:01:19,770
team a former consultant I was

27
00:01:19,770 --> 00:01:21,720
consulting for about seven years before

28
00:01:21,720 --> 00:01:24,840
I joined this team this year it's not a

29
00:01:24,840 --> 00:01:27,180
big for consulting firm or accounting

30
00:01:27,180 --> 00:01:29,250
firm I'm not allowed to say the name

31
00:01:29,250 --> 00:01:30,869
right now but I'm based out of Seattle

32
00:01:30,869 --> 00:01:33,979
Washington I'm mostly focused on windows

33
00:01:33,979 --> 00:01:38,159
exploitation purple team advocate really

34
00:01:38,159 --> 00:01:40,560
just I'm in for the collaboration

35
00:01:40,560 --> 00:01:42,329
between red teams and blue teams because

36
00:01:42,329 --> 00:01:43,950
that's really how we all get better

37
00:01:43,950 --> 00:01:46,409
right on the side I do some music

38
00:01:46,409 --> 00:01:48,720
production electronic music play guitar

39
00:01:48,720 --> 00:01:50,880
in a punk band free parking check them

40
00:01:50,880 --> 00:01:52,890
out the cool and I'm just stoked to be

41
00:01:52,890 --> 00:01:57,240
here overall so during this I just want

42
00:01:57,240 --> 00:02:00,960
you to think and take this to heart

43
00:02:00,960 --> 00:02:03,450
during a red team operation treat the

44
00:02:03,450 --> 00:02:06,329
attackers like a real adversary I think

45
00:02:06,329 --> 00:02:07,829
that's important that's how you're going

46
00:02:07,829 --> 00:02:10,619
to learn to figure out how to detect

47
00:02:10,619 --> 00:02:12,420
certain things figure out how to respond

48
00:02:12,420 --> 00:02:13,739
to it properly

49
00:02:13,739 --> 00:02:15,330
if you if you're not doing that you're

50
00:02:15,330 --> 00:02:17,220
not going to get much value from the red

51
00:02:17,220 --> 00:02:19,049
team and then afterwards make sure you

52
00:02:19,049 --> 00:02:22,560
have collaboration so what's the point

53
00:02:22,560 --> 00:02:24,900
of my talk I'm gonna walk through some

54
00:02:24,900 --> 00:02:27,150
of the trial and error I've had as a red

55
00:02:27,150 --> 00:02:27,540
teamer

56
00:02:27,540 --> 00:02:30,659
and also what blue teams have done when

57
00:02:30,659 --> 00:02:33,510
I was consulting and now the blue team I

58
00:02:33,510 --> 00:02:36,030
work with directly pinpoints some areas

59
00:02:36,030 --> 00:02:38,069
that hopefully will help some of you

60
00:02:38,069 --> 00:02:40,769
think a little bit differently from an

61
00:02:40,769 --> 00:02:43,470
attackers mindset tightened security and

62
00:02:43,470 --> 00:02:46,560
to potentially help you foster some new

63
00:02:46,560 --> 00:02:49,349
detection controls and just give you the

64
00:02:49,349 --> 00:02:52,440
blue teamers in the room a glimpse of

65
00:02:52,440 --> 00:02:55,709
how adversaries think and how we're

66
00:02:55,709 --> 00:02:59,069
plotting against you so overall I'm just

67
00:02:59,069 --> 00:03:01,230
going to go over recon some adversarial

68
00:03:01,230 --> 00:03:03,389
OPSEC that we put in place to figure out

69
00:03:03,389 --> 00:03:06,629
if the blue team is catching on to what

70
00:03:06,629 --> 00:03:10,440
we're doing and also dive into malicious

71
00:03:10,440 --> 00:03:13,109
attachments some old stuff some new

72
00:03:13,109 --> 00:03:14,639
stuff hopefully you guys learned

73
00:03:14,639 --> 00:03:18,680
something from it so first with recon

74
00:03:18,680 --> 00:03:21,750
you know we look to see what's publicly

75
00:03:21,750 --> 00:03:23,430
out there who is sub-domain all that

76
00:03:23,430 --> 00:03:26,579
jazz everyone knows that and then we

77
00:03:26,579 --> 00:03:29,430
start trying to craft our spearfishing

78
00:03:29,430 --> 00:03:33,269
campaigns looking for things like job

79
00:03:33,269 --> 00:03:35,250
openings that have the technologies that

80
00:03:35,250 --> 00:03:37,440
your business is using looking up social

81
00:03:37,440 --> 00:03:39,989
media to see if you know your employees

82
00:03:39,989 --> 00:03:41,730
are saying what tools that you have in

83
00:03:41,730 --> 00:03:43,620
your environment anything that we can

84
00:03:43,620 --> 00:03:47,340
really pull together to understand what

85
00:03:47,340 --> 00:03:50,370
your tech stack is and also potentially

86
00:03:50,370 --> 00:03:54,620
craft a campaign to to go against you

87
00:03:54,620 --> 00:03:57,870
also we look for things like services

88
00:03:57,870 --> 00:04:01,650
that might be available though and we

89
00:04:01,650 --> 00:04:03,180
could potentially look for things that

90
00:04:03,180 --> 00:04:06,720
like maybe single off on your external

91
00:04:06,720 --> 00:04:08,250
environment so we could attack that

92
00:04:08,250 --> 00:04:09,989
later and I think the last bullet point

93
00:04:09,989 --> 00:04:11,970
is big one I'm going to show you a

94
00:04:11,970 --> 00:04:14,370
screenshot next in the next slide but

95
00:04:14,370 --> 00:04:16,289
bouncing emails off of domains you can

96
00:04:16,289 --> 00:04:17,488
pull a bunch of good information from

97
00:04:17,488 --> 00:04:20,220
that really what we're using all of this

98
00:04:20,220 --> 00:04:24,150
for the firewall rules looking for the

99
00:04:24,150 --> 00:04:25,409
things in who is in your public

100
00:04:25,409 --> 00:04:26,580
environment

101
00:04:26,580 --> 00:04:30,030
we will create firewall rules for rc2

102
00:04:30,030 --> 00:04:33,300
servers so we could potentially narrow

103
00:04:33,300 --> 00:04:35,009
the scope if you have a third party

104
00:04:35,009 --> 00:04:38,190
sandbox or something like that it won't

105
00:04:38,190 --> 00:04:40,350
be able to pull our payloads and

106
00:04:40,350 --> 00:04:42,419
actually run their sandbox and against

107
00:04:42,419 --> 00:04:43,530
it and so on

108
00:04:43,530 --> 00:04:47,030
I'm looking for those single-factor

109
00:04:48,650 --> 00:04:50,330
authentic

110
00:04:50,330 --> 00:04:52,889
unique to your environment so we can key

111
00:04:52,889 --> 00:04:54,660
in on that and and craft our payloads

112
00:04:54,660 --> 00:05:00,000
further so the left image hopefully you

113
00:05:00,000 --> 00:05:02,610
can see it but that's bouncing an email

114
00:05:02,610 --> 00:05:06,419
off of some random company might be a

115
00:05:06,419 --> 00:05:08,370
real company I don't know but they

116
00:05:08,370 --> 00:05:11,060
actually have the internal domain name

117
00:05:11,060 --> 00:05:13,979
readily available this is more for if

118
00:05:13,979 --> 00:05:17,310
you have SMTP servers like on Prem cloud

119
00:05:17,310 --> 00:05:20,580
services prevent a lot of this and then

120
00:05:20,580 --> 00:05:22,590
you can also see at the bottom it says

121
00:05:22,590 --> 00:05:25,320
PP host comm so that also gives me the

122
00:05:25,320 --> 00:05:27,780
knowledge that your corporation or your

123
00:05:27,780 --> 00:05:30,630
business is using Proofpoint so that'll

124
00:05:30,630 --> 00:05:33,539
help me craft how I'm going to attack

125
00:05:33,539 --> 00:05:35,910
you through through attachments or

126
00:05:35,910 --> 00:05:38,250
whatever it is then the other one is a

127
00:05:38,250 --> 00:05:40,650
pretty old technique but it's still

128
00:05:40,650 --> 00:05:42,570
viable I've used it a ton of times when

129
00:05:42,570 --> 00:05:45,690
I was consulting looking for MS link or

130
00:05:45,690 --> 00:05:47,580
if you're still using a link for some

131
00:05:47,580 --> 00:05:49,199
reason or Skype for business

132
00:05:49,199 --> 00:05:51,180
you can basically send an ntlm

133
00:05:51,180 --> 00:05:54,750
authentication request to that server

134
00:05:54,750 --> 00:06:00,419
and pull back base64 encoded blob that

135
00:06:00,419 --> 00:06:01,889
basically has all of your internal

136
00:06:01,889 --> 00:06:04,949
domain information and also the internal

137
00:06:04,949 --> 00:06:08,580
server name I have a some references

138
00:06:08,580 --> 00:06:10,470
hopefully this the slides will get out

139
00:06:10,470 --> 00:06:12,539
sometime soon that you guys can click

140
00:06:12,539 --> 00:06:16,199
that and look through it more so some

141
00:06:16,199 --> 00:06:19,070
potential areas of detection for this

142
00:06:19,070 --> 00:06:21,630
anyone that's you know mass downloading

143
00:06:21,630 --> 00:06:23,430
externally hosted files to pull metadata

144
00:06:23,430 --> 00:06:25,370
to see what versions your software is

145
00:06:25,370 --> 00:06:29,220
within office or Adobe or anything like

146
00:06:29,220 --> 00:06:31,010
that so we can craft things against that

147
00:06:31,010 --> 00:06:34,440
emails potentially being bounced against

148
00:06:34,440 --> 00:06:36,539
non-existent email accounts that's what

149
00:06:36,539 --> 00:06:38,479
I've showed in that one

150
00:06:38,479 --> 00:06:42,650
this is a lot harder if you if your

151
00:06:42,650 --> 00:06:45,139
business has a lot of clients but if you

152
00:06:45,139 --> 00:06:47,029
know you can potentially whitelist

153
00:06:47,029 --> 00:06:50,180
specific domains and you can crack down

154
00:06:50,180 --> 00:06:51,680
on that a little bit more for maybe a

155
00:06:51,680 --> 00:06:53,809
smaller business and then you know just

156
00:06:53,809 --> 00:06:55,400
brute forcing against single factor off

157
00:06:55,400 --> 00:06:58,099
that that's pretty easily detected a lot

158
00:06:58,099 --> 00:06:59,479
of people still don't detect on that

159
00:06:59,479 --> 00:07:02,449
though I put in a couple points that

160
00:07:02,449 --> 00:07:05,270
I've I've struggled with when I was

161
00:07:05,270 --> 00:07:08,749
doing these assessments you know it

162
00:07:08,749 --> 00:07:11,809
costs more time to the attacker overall

163
00:07:11,809 --> 00:07:14,270
if I can't figure out what your egress

164
00:07:14,270 --> 00:07:16,009
points are from your network from the

165
00:07:16,009 --> 00:07:19,999
publicly available stuff anything that's

166
00:07:19,999 --> 00:07:21,710
registered under your company's name if

167
00:07:21,710 --> 00:07:23,509
if you have a third party or like you're

168
00:07:23,509 --> 00:07:25,729
in a service provider is what's pulled

169
00:07:25,729 --> 00:07:28,189
from from that recon then I'm not going

170
00:07:28,189 --> 00:07:29,960
to be able to change the firewall rules

171
00:07:29,960 --> 00:07:32,960
to narrow down on what can access my

172
00:07:32,960 --> 00:07:37,819
payloads if your environment has

173
00:07:37,819 --> 00:07:39,379
multi-factor all over the place it's

174
00:07:39,379 --> 00:07:41,959
going to be much harder for me to spray

175
00:07:41,959 --> 00:07:44,330
anything I usually try not to do that

176
00:07:44,330 --> 00:07:46,249
anyway because it's too noisy but you

177
00:07:46,249 --> 00:07:48,649
know some people do if employees only

178
00:07:48,649 --> 00:07:51,889
have general job descriptions basically

179
00:07:51,889 --> 00:07:54,709
anything that's not related to your text

180
00:07:54,709 --> 00:07:55,969
sect and that's gonna make it harder for

181
00:07:55,969 --> 00:07:58,009
me to figure out what's in your

182
00:07:58,009 --> 00:08:02,120
environment so I can further do some

183
00:08:02,120 --> 00:08:04,610
tests and against those tools and

184
00:08:04,610 --> 00:08:07,370
potentially get by them and then the

185
00:08:07,370 --> 00:08:10,069
last one wild card emails aren't allowed

186
00:08:10,069 --> 00:08:13,009
so I can't bounce off or you have like a

187
00:08:13,009 --> 00:08:16,219
cloud service for your email you you

188
00:08:16,219 --> 00:08:17,389
won't be able to pull that internal

189
00:08:17,389 --> 00:08:20,149
domain information from those I made a

190
00:08:20,149 --> 00:08:24,529
toolkit for looking up some basic recon

191
00:08:24,529 --> 00:08:27,259
for networking you can follow that if if

192
00:08:27,259 --> 00:08:31,430
you like so the next one I'm running

193
00:08:31,430 --> 00:08:35,149
into adversarial OPSEC testing dropper

194
00:08:35,149 --> 00:08:37,610
malware this is a topic on its own I'm

195
00:08:37,610 --> 00:08:39,529
not going to cover it too much today but

196
00:08:39,529 --> 00:08:42,349
just know that an adversary with that's

197
00:08:42,349 --> 00:08:44,420
dedicated enough will download free

198
00:08:44,420 --> 00:08:47,060
trials of Av get trials of your edr

199
00:08:47,060 --> 00:08:49,220
products and figure out ways around it

200
00:08:49,220 --> 00:08:51,050
you just have to kind of

201
00:08:51,050 --> 00:08:53,330
that in your environment and look for

202
00:08:53,330 --> 00:08:55,670
anomalies but that's just something that

203
00:08:55,670 --> 00:08:57,290
you need to keep in mind and if you want

204
00:08:57,290 --> 00:08:59,000
to talk about this afterwards I'm happy

205
00:08:59,000 --> 00:09:00,470
to I'm just not going to cover it with

206
00:09:00,470 --> 00:09:04,160
this talk so this is a one technique

207
00:09:04,160 --> 00:09:06,440
that I've done and I've figured out was

208
00:09:06,440 --> 00:09:09,610
worked pretty well to figure out if

209
00:09:09,610 --> 00:09:11,990
incident response or the blue team was

210
00:09:11,990 --> 00:09:16,029
on to my campaign I would set up

211
00:09:16,029 --> 00:09:18,320
basically a web server that is not

212
00:09:18,320 --> 00:09:20,630
related to any of my other other c2

213
00:09:20,630 --> 00:09:23,810
infrastructure and whatever payload I'm

214
00:09:23,810 --> 00:09:26,329
sending will basically send a benign web

215
00:09:26,329 --> 00:09:27,800
request to like an image or something

216
00:09:27,800 --> 00:09:28,730
like that

217
00:09:28,730 --> 00:09:34,850
once that image gets pulled or gets

218
00:09:34,850 --> 00:09:37,240
requested then I'll get a text message

219
00:09:37,240 --> 00:09:38,600
this works

220
00:09:38,600 --> 00:09:40,579
twofold because basically I'll get a

221
00:09:40,579 --> 00:09:43,339
text message one if the actual victim

222
00:09:43,339 --> 00:09:45,290
has clicked my link and I know that I'm

223
00:09:45,290 --> 00:09:47,779
about to get a shell or two if there's

224
00:09:47,779 --> 00:09:49,459
multiple requests happening I'm getting

225
00:09:49,459 --> 00:09:51,050
a ton of text messages I'm like oh

226
00:09:51,050 --> 00:09:53,690
the the blue team's probably on me let

227
00:09:53,690 --> 00:09:55,100
me burn down that infrastructure and

228
00:09:55,100 --> 00:09:58,550
start somewhere else I've also seen some

229
00:09:58,550 --> 00:10:00,380
people do unc path injection and pull

230
00:10:00,380 --> 00:10:02,779
and tell MV to hashes over the internet

231
00:10:02,779 --> 00:10:04,910
if you have an SMB outbound I'm gonna

232
00:10:04,910 --> 00:10:08,839
you've probably shouldn't but you I've

233
00:10:08,839 --> 00:10:11,089
seen it like 50 percent of the clients

234
00:10:11,089 --> 00:10:13,640
I've worked at so I just have some

235
00:10:13,640 --> 00:10:15,529
sample code for the text messages for

236
00:10:15,529 --> 00:10:17,120
the red teamers in the room and then

237
00:10:17,120 --> 00:10:18,980
under that for the blue teamers in the

238
00:10:18,980 --> 00:10:20,630
room I actually have the user agents

239
00:10:20,630 --> 00:10:23,329
that office products use it might be

240
00:10:23,329 --> 00:10:26,140
helpful for people that are sandboxing

241
00:10:26,140 --> 00:10:28,880
the payloads or any any of the documents

242
00:10:28,880 --> 00:10:30,680
that they're receiving or if they think

243
00:10:30,680 --> 00:10:32,329
something is malicious you could

244
00:10:32,329 --> 00:10:34,430
potentially use this in in tune your

245
00:10:34,430 --> 00:10:38,660
sandbox a little bit more this is

246
00:10:38,660 --> 00:10:40,570
another technique that I came up with

247
00:10:40,570 --> 00:10:43,820
basically using one-time use tokens so

248
00:10:43,820 --> 00:10:46,610
whenever your payloads if your staging

249
00:10:46,610 --> 00:10:49,610
request out to a server that you know I

250
00:10:49,610 --> 00:10:54,140
own there's a database set up that will

251
00:10:54,140 --> 00:10:57,740
have all the usages of that token if the

252
00:10:57,740 --> 00:11:00,709
token gets requested one time from my

253
00:11:00,709 --> 00:11:03,920
payload then it'll actually serve up the

254
00:11:03,920 --> 00:11:05,210
legit pay

255
00:11:05,210 --> 00:11:07,610
and start the process of downloading and

256
00:11:07,610 --> 00:11:08,960
executing whatever

257
00:11:08,960 --> 00:11:12,440
the flow is if there is more than once

258
00:11:12,440 --> 00:11:14,540
you can set however many times you want

259
00:11:14,540 --> 00:11:16,970
it so to work but if it the token gets

260
00:11:16,970 --> 00:11:18,490
requested more than once then

261
00:11:18,490 --> 00:11:23,480
potentially that it is probably a blue

262
00:11:23,480 --> 00:11:26,390
team so that will redirect to something

263
00:11:26,390 --> 00:11:30,260
benign and then you won't be able the

264
00:11:30,260 --> 00:11:32,120
incident response teams won't be able to

265
00:11:32,120 --> 00:11:36,080
actually pull that down also don't

266
00:11:36,080 --> 00:11:38,510
request my payloads with W get that's

267
00:11:38,510 --> 00:11:40,460
just going to get redirected I've seen

268
00:11:40,460 --> 00:11:42,920
it a lot it's just things that I need to

269
00:11:42,920 --> 00:11:46,400
point out so some areas of potential

270
00:11:46,400 --> 00:11:50,600
detection their office any document

271
00:11:50,600 --> 00:11:53,120
reading process that has outbound

272
00:11:53,120 --> 00:11:55,010
connectivity you know this is kind of a

273
00:11:55,010 --> 00:11:57,020
no-brainer but if some people are knew

274
00:11:57,020 --> 00:11:59,360
that it might be good information any

275
00:11:59,360 --> 00:12:00,680
type of outbound can network

276
00:12:00,680 --> 00:12:02,810
connectivity should be looked at further

277
00:12:02,810 --> 00:12:04,940
there's a chance it's not malicious a

278
00:12:04,940 --> 00:12:07,760
better chance it probably is any

279
00:12:07,760 --> 00:12:10,220
malicious links from non trusted domains

280
00:12:10,220 --> 00:12:13,160
obviously that's a much harder one to

281
00:12:13,160 --> 00:12:14,900
crack down on if you have a big

282
00:12:14,900 --> 00:12:17,630
environment those user agents that I

283
00:12:17,630 --> 00:12:21,110
called out earlier and then this one is

284
00:12:21,110 --> 00:12:22,790
kind of counterintuitive to the first

285
00:12:22,790 --> 00:12:24,410
bullet for my incident response and

286
00:12:24,410 --> 00:12:26,630
defense tips but if there's one of those

287
00:12:26,630 --> 00:12:29,570
campaigns that's more mass phishing that

288
00:12:29,570 --> 00:12:33,170
is has the tokens that are being used

289
00:12:33,170 --> 00:12:35,720
and you want to pull that payload you

290
00:12:35,720 --> 00:12:37,400
could potentially look for those unread

291
00:12:37,400 --> 00:12:39,140
emails click that link download the

292
00:12:39,140 --> 00:12:41,720
payload and analyze it that way and that

293
00:12:41,720 --> 00:12:43,250
kind of goes into the next tip which is

294
00:12:43,250 --> 00:12:46,490
don't do that you're better off just

295
00:12:46,490 --> 00:12:49,070
pulling the payload from one of the

296
00:12:49,070 --> 00:12:50,650
users that already clicked it and

297
00:12:50,650 --> 00:12:54,110
analyzing it that way and that kind of

298
00:12:54,110 --> 00:12:56,089
goes and coincides with that W get

299
00:12:56,089 --> 00:12:58,839
request that I was talking about earlier

300
00:12:58,839 --> 00:13:01,400
this one is just kind of an overarching

301
00:13:01,400 --> 00:13:02,990
one you guys probably hate hearing it

302
00:13:02,990 --> 00:13:04,640
but just assume that adversary knows how

303
00:13:04,640 --> 00:13:07,100
to get around your tools look for things

304
00:13:07,100 --> 00:13:08,960
after you know you're gonna get

305
00:13:08,960 --> 00:13:10,610
low-hanging fruit and unexperienced

306
00:13:10,610 --> 00:13:13,220
attackers but look for things like you

307
00:13:13,220 --> 00:13:15,410
know that guy in finance opening up

308
00:13:15,410 --> 00:13:17,270
PowerShell and executing commands

309
00:13:17,270 --> 00:13:17,730
because

310
00:13:17,730 --> 00:13:19,459
obviously gonna be something that

311
00:13:19,459 --> 00:13:21,690
shouldn't happen or wouldn't happen

312
00:13:21,690 --> 00:13:23,850
normally and then the last one I kind of

313
00:13:23,850 --> 00:13:25,649
touched on it disable your SMB outbound

314
00:13:25,649 --> 00:13:28,880
traffic that's ridiculous

315
00:13:29,420 --> 00:13:34,320
so uh some malicious attachments you

316
00:13:34,320 --> 00:13:36,000
know there's email security and

317
00:13:36,000 --> 00:13:38,790
sandboxing services out there that you

318
00:13:38,790 --> 00:13:40,980
can rely on you can hold on it as a

319
00:13:40,980 --> 00:13:44,040
crutch but I wouldn't make that you know

320
00:13:44,040 --> 00:13:46,310
it's not a silver bullet by any means

321
00:13:46,310 --> 00:13:50,610
you can modify some publicly known

322
00:13:50,610 --> 00:13:53,130
payloads pretty easily and get by them

323
00:13:53,130 --> 00:13:55,500
and I'm gonna run through a couple

324
00:13:55,500 --> 00:13:59,370
things that we do as red teamers so one

325
00:13:59,370 --> 00:14:02,310
this is kind of an older tactic but it

326
00:14:02,310 --> 00:14:04,350
still works wonderfully so I want to

327
00:14:04,350 --> 00:14:06,510
make sure that everyone is aware of it

328
00:14:06,510 --> 00:14:08,670
it's called remote template injection so

329
00:14:08,670 --> 00:14:12,540
the idea behind it is you have a normal

330
00:14:12,540 --> 00:14:15,480
non malicious document and it actually

331
00:14:15,480 --> 00:14:19,199
calls out to an office template that is

332
00:14:19,199 --> 00:14:22,829
hosted on a staging server elsewhere so

333
00:14:22,829 --> 00:14:25,860
basically that template has the

334
00:14:25,860 --> 00:14:28,199
malicious code in it so once the

335
00:14:28,199 --> 00:14:30,269
document is opened it pulls the template

336
00:14:30,269 --> 00:14:32,519
down and then there's a macro in the

337
00:14:32,519 --> 00:14:35,880
document I kind of wrote the steps for

338
00:14:35,880 --> 00:14:37,680
the red teamers if they curious about

339
00:14:37,680 --> 00:14:40,949
doing it you just edit an XML file but

340
00:14:40,949 --> 00:14:42,660
for the blue teamers in the room this

341
00:14:42,660 --> 00:14:47,459
basically it allows docx files which

342
00:14:47,459 --> 00:14:49,860
typically don't have macros in them to

343
00:14:49,860 --> 00:14:52,860
be used as a malicious document so

344
00:14:52,860 --> 00:14:55,860
that'll get by you know quite a few

345
00:14:55,860 --> 00:14:59,510
email filters the other side of this is

346
00:14:59,510 --> 00:15:06,240
when this actually occurs you can take

347
00:15:06,240 --> 00:15:09,930
the template down it depends if you have

348
00:15:09,930 --> 00:15:11,850
the the firewall rules in place but if

349
00:15:11,850 --> 00:15:13,440
you don't you can take the template down

350
00:15:13,440 --> 00:15:15,990
while the email sandbox is doing its

351
00:15:15,990 --> 00:15:20,180
thing against the document and basically

352
00:15:20,180 --> 00:15:23,550
want it once it's making those requests

353
00:15:23,550 --> 00:15:24,930
out you'll see that there's like

354
00:15:24,930 --> 00:15:27,449
third-party sandboxes in like a juror or

355
00:15:27,449 --> 00:15:28,470
AWS

356
00:15:28,470 --> 00:15:30,120
requesting a ton

357
00:15:30,120 --> 00:15:32,579
of times to your server looking for the

358
00:15:32,579 --> 00:15:34,680
template once that dies down it's

359
00:15:34,680 --> 00:15:35,970
usually between five and twenty minutes

360
00:15:35,970 --> 00:15:38,069
you can just Rijos the template because

361
00:15:38,069 --> 00:15:41,129
the sandbox will send that document to

362
00:15:41,129 --> 00:15:42,870
the user the victim whoever you're

363
00:15:42,870 --> 00:15:45,329
targeting and they'll open it and

364
00:15:45,329 --> 00:15:47,639
hopefully by that time you have the

365
00:15:47,639 --> 00:15:50,220
template backup and it'll just pull the

366
00:15:50,220 --> 00:15:51,629
template down and you get that malicious

367
00:15:51,629 --> 00:15:54,269
code execution there's some actually

368
00:15:54,269 --> 00:15:57,870
pretty unique indicators for this for

369
00:15:57,870 --> 00:15:59,670
the the templates being requested by

370
00:15:59,670 --> 00:16:03,809
office products and I just put those

371
00:16:03,809 --> 00:16:05,069
there for the blue teamers as a

372
00:16:05,069 --> 00:16:06,689
reference these slides will be up later

373
00:16:06,689 --> 00:16:10,379
but it's a pretty unique set of requests

374
00:16:10,379 --> 00:16:11,970
that gets sent out once it's pulling

375
00:16:11,970 --> 00:16:17,069
those templates this is you know the

376
00:16:17,069 --> 00:16:18,300
tried and true method everyone knows

377
00:16:18,300 --> 00:16:20,459
about VBA macros it's gone through a

378
00:16:20,459 --> 00:16:23,610
million iterations it's gotten to the

379
00:16:23,610 --> 00:16:24,990
point where you kind of have to hide in

380
00:16:24,990 --> 00:16:25,559
plain sight

381
00:16:25,559 --> 00:16:27,720
Windows Defender is catching on to

382
00:16:27,720 --> 00:16:29,850
basically everything and I assume that

383
00:16:29,850 --> 00:16:32,189
the other AV vendors are going to catch

384
00:16:32,189 --> 00:16:35,670
up eventually but things like WMI

385
00:16:35,670 --> 00:16:37,649
execution is old-school PowerShell

386
00:16:37,649 --> 00:16:41,279
cradles that will get caught most likely

387
00:16:41,279 --> 00:16:43,290
hiding variables and document properties

388
00:16:43,290 --> 00:16:46,889
XML data and then I've just came up with

389
00:16:46,889 --> 00:16:50,990
a method of actually hiding code in

390
00:16:50,990 --> 00:16:53,879
alternative text of images and then the

391
00:16:53,879 --> 00:16:56,970
week I was about to execute Microsoft

392
00:16:56,970 --> 00:16:59,129
put in a new alert that actually says

393
00:16:59,129 --> 00:17:02,999
that it's an off you skated macro so you

394
00:17:02,999 --> 00:17:05,250
can't do that anymore but there's a

395
00:17:05,250 --> 00:17:08,010
really good talk on this at Derby con I

396
00:17:08,010 --> 00:17:11,189
think last year 2018 where they they

397
00:17:11,189 --> 00:17:13,230
talk a lot more about this and it's

398
00:17:13,230 --> 00:17:14,730
definitely a good one to view for for

399
00:17:14,730 --> 00:17:16,949
blue teamers but basically we're doing

400
00:17:16,949 --> 00:17:19,199
things like we're reversing strings just

401
00:17:19,199 --> 00:17:21,059
replacing characters hiding it just

402
00:17:21,059 --> 00:17:23,549
straight in the the normal macro instead

403
00:17:23,549 --> 00:17:26,189
of pulling different properties of the

404
00:17:26,189 --> 00:17:29,399
documents staging the payloads you know

405
00:17:29,399 --> 00:17:30,840
you don't want to put all of your

406
00:17:30,840 --> 00:17:32,520
malicious code in the payload because if

407
00:17:32,520 --> 00:17:35,399
that gets caught then your c2

408
00:17:35,399 --> 00:17:39,750
infrastructure is burned so having that

409
00:17:39,750 --> 00:17:42,750
outside that next step is a good way to

410
00:17:42,750 --> 00:17:43,590
kind of

411
00:17:43,590 --> 00:17:46,140
or some of burning the infrastructure

412
00:17:46,140 --> 00:17:48,419
you set up and took so long to do and

413
00:17:48,419 --> 00:17:50,400
then just executing outside of office

414
00:17:50,400 --> 00:17:51,419
ancestry

415
00:17:51,419 --> 00:17:55,320
this is really it's a pretty well known

416
00:17:55,320 --> 00:17:59,039
way to do things in EDR tools nowadays

417
00:17:59,039 --> 00:18:01,799
all detect on if you're executing as a

418
00:18:01,799 --> 00:18:04,110
child process of like an office product

419
00:18:04,110 --> 00:18:07,230
but as an attacker we always have to

420
00:18:07,230 --> 00:18:09,600
execute outside of office and I put an

421
00:18:09,600 --> 00:18:11,970
example up of just that hiding in plain

422
00:18:11,970 --> 00:18:13,980
sight macro for the blue teamers so you

423
00:18:13,980 --> 00:18:15,929
if you're analyzing something you can

424
00:18:15,929 --> 00:18:18,600
see what is actually occurring here I

425
00:18:18,600 --> 00:18:20,159
cut out the execution side because

426
00:18:20,159 --> 00:18:25,590
that's all public knowledge so this one

427
00:18:25,590 --> 00:18:28,890
is actually something that I came up

428
00:18:28,890 --> 00:18:31,740
with as well but it was based off of a

429
00:18:31,740 --> 00:18:34,799
talk by Stan Hecht at Derby con 2018

430
00:18:34,799 --> 00:18:37,919
this is Excel 4.0 macros for those of

431
00:18:37,919 --> 00:18:39,809
you that don't know is an old language

432
00:18:39,809 --> 00:18:44,070
within Excel that it basically allows

433
00:18:44,070 --> 00:18:48,539
you to hook windows api's and just call

434
00:18:48,539 --> 00:18:52,950
dll's directly through Excel so it's

435
00:18:52,950 --> 00:18:55,320
pretty awesome the method that he showed

436
00:18:55,320 --> 00:18:57,750
off was really more around doing direct

437
00:18:57,750 --> 00:18:59,700
shell code injection but I didn't like

438
00:18:59,700 --> 00:19:02,789
that that much because unless you change

439
00:19:02,789 --> 00:19:04,350
your shell code to execute outside of

440
00:19:04,350 --> 00:19:06,059
the office product it'll execute as a

441
00:19:06,059 --> 00:19:08,580
child process of Excel which will get

442
00:19:08,580 --> 00:19:11,700
caught by an e dr product so I wanted to

443
00:19:11,700 --> 00:19:14,669
do something different and also you know

444
00:19:14,669 --> 00:19:17,159
everything there will give away your C

445
00:19:17,159 --> 00:19:20,429
to infrastructure if that's the case so

446
00:19:20,429 --> 00:19:22,950
I came up with my own attack flow I use

447
00:19:22,950 --> 00:19:25,320
Excel 4.0 as a downloader basically just

448
00:19:25,320 --> 00:19:28,940
calling the Windows DLL URL Mon to

449
00:19:28,940 --> 00:19:33,539
download a file and then you can hybrid

450
00:19:33,539 --> 00:19:36,600
it and actually call a VBA function as

451
00:19:36,600 --> 00:19:39,210
well through Excel 4.0 so you can do

452
00:19:39,210 --> 00:19:43,559
that for execution since in the VBA it

453
00:19:43,559 --> 00:19:46,799
doesn't say auto open it'll get by a lot

454
00:19:46,799 --> 00:19:48,750
of email filters there email filters

455
00:19:48,750 --> 00:19:50,010
aren't really looking for these Excel

456
00:19:50,010 --> 00:19:53,399
4.0 macros yet I also included some of

457
00:19:53,399 --> 00:19:56,420
the the user agents that

458
00:19:56,420 --> 00:19:59,929
get requested when this occurs just so

459
00:19:59,929 --> 00:20:02,809
you guys also know what's going on and

460
00:20:02,809 --> 00:20:04,880
have something to write off of if you if

461
00:20:04,880 --> 00:20:09,740
you can tune your sandboxes so some

462
00:20:09,740 --> 00:20:11,480
points of discovery the first ones

463
00:20:11,480 --> 00:20:13,460
obvious hopefully everyone knows that if

464
00:20:13,460 --> 00:20:15,740
a document has making outbound network

465
00:20:15,740 --> 00:20:18,530
connectivity then there's probably an

466
00:20:18,530 --> 00:20:21,290
issue that probably doesn't happen but

467
00:20:21,290 --> 00:20:23,179
sometimes it does but it's something to

468
00:20:23,179 --> 00:20:26,059
look into at least vba scripts run from

469
00:20:26,059 --> 00:20:28,429
documents you know EER tools nowadays

470
00:20:28,429 --> 00:20:31,730
they they look into these at least you

471
00:20:31,730 --> 00:20:34,640
can flag on them with with a basic set

472
00:20:34,640 --> 00:20:38,360
up but again if it's not like your

473
00:20:38,360 --> 00:20:40,640
accounting guy that is running macros

474
00:20:40,640 --> 00:20:42,830
all day then there's probably some issue

475
00:20:42,830 --> 00:20:45,850
going on some so malicious activity

476
00:20:45,850 --> 00:20:48,919
executing as a child process of office

477
00:20:48,919 --> 00:20:50,809
products if that ever occurs and you

478
00:20:50,809 --> 00:20:52,700
don't have an EDR solution then look

479
00:20:52,700 --> 00:20:54,830
into that that probably shouldn't be

480
00:20:54,830 --> 00:20:58,490
happening either any old format versions

481
00:20:58,490 --> 00:21:03,160
of office documents so dot doc dot XLS

482
00:21:03,160 --> 00:21:06,080
you can actually prevent those from even

483
00:21:06,080 --> 00:21:07,700
being opened in your environment through

484
00:21:07,700 --> 00:21:10,520
GPO so that's an approach you could take

485
00:21:10,520 --> 00:21:12,530
if you don't have like legacy documents

486
00:21:12,530 --> 00:21:15,080
which you know let's let's get to the

487
00:21:15,080 --> 00:21:19,070
21st century now and then the last one I

488
00:21:19,070 --> 00:21:21,820
think is probably the the biggest one

489
00:21:21,820 --> 00:21:24,790
looking for these functions specifically

490
00:21:24,790 --> 00:21:28,070
within the macros the first ones is

491
00:21:28,070 --> 00:21:30,530
shell calm so you can call that seal Sid

492
00:21:30,530 --> 00:21:33,230
and basically execute as a child process

493
00:21:33,230 --> 00:21:37,130
of Explorer instead of instead of the

494
00:21:37,130 --> 00:21:39,350
the office document itself the rest of

495
00:21:39,350 --> 00:21:41,870
them are basically used as downloaders

496
00:21:41,870 --> 00:21:45,200
or other ways of execution the one that

497
00:21:45,200 --> 00:21:46,940
I really wanted to point out was the

498
00:21:46,940 --> 00:21:50,660
active sheet visible equals false I use

499
00:21:50,660 --> 00:21:52,309
this all the time in phishing campaigns

500
00:21:52,309 --> 00:21:55,010
because it's how I sway users to click

501
00:21:55,010 --> 00:21:58,100
something basically what that is doing

502
00:21:58,100 --> 00:22:00,440
is making an image invisible so I'll

503
00:22:00,440 --> 00:22:03,020
just overlay an image on a document that

504
00:22:03,020 --> 00:22:05,330
says hey this is in privacy mode this

505
00:22:05,330 --> 00:22:07,970
isn't protected mode enable content to

506
00:22:07,970 --> 00:22:08,909
view the

507
00:22:08,909 --> 00:22:11,279
document so that'll make somebody that's

508
00:22:11,279 --> 00:22:13,169
not too experienced just click enable

509
00:22:13,169 --> 00:22:15,389
content the image disappears it looks

510
00:22:15,389 --> 00:22:16,919
legit they don't really know what's

511
00:22:16,919 --> 00:22:19,080
going on so that's definitely a bigger

512
00:22:19,080 --> 00:22:20,639
one that I haven't seen too many people

513
00:22:20,639 --> 00:22:23,940
call out and then the others who are

514
00:22:23,940 --> 00:22:26,159
just really around the the hiding in

515
00:22:26,159 --> 00:22:30,690
plain sight aspect of things so for the

516
00:22:30,690 --> 00:22:33,720
incident response tip here sandboxing a

517
00:22:33,720 --> 00:22:35,700
payload on a system that is actually

518
00:22:35,700 --> 00:22:38,129
representative of your domain because we

519
00:22:38,129 --> 00:22:40,909
did all that recon in the first place so

520
00:22:40,909 --> 00:22:44,220
we potentially know your internal domain

521
00:22:44,220 --> 00:22:47,129
name if it's just a third party sandbox

522
00:22:47,129 --> 00:22:49,649
service there's a chance that it's not

523
00:22:49,649 --> 00:22:53,340
connected to your domain and if it's not

524
00:22:53,340 --> 00:22:55,139
then we'll just cut execution right

525
00:22:55,139 --> 00:22:57,210
there and not do anything malicious so

526
00:22:57,210 --> 00:22:59,519
that's a pretty important step I see a

527
00:22:59,519 --> 00:23:02,460
lot of people fail doing that but it's

528
00:23:02,460 --> 00:23:04,039
something that you can you can at least

529
00:23:04,039 --> 00:23:08,220
be cognizant of moving forward and then

530
00:23:08,220 --> 00:23:10,200
the last one this is a really well-known

531
00:23:10,200 --> 00:23:12,409
tool Oh le dump if you don't know that

532
00:23:12,409 --> 00:23:14,789
you should probably look into it it's a

533
00:23:14,789 --> 00:23:17,009
really good blue teaming tool that you

534
00:23:17,009 --> 00:23:19,769
can scrape VBA macros and they also just

535
00:23:19,769 --> 00:23:21,960
made a plugin for Excel 4.0 macros to

536
00:23:21,960 --> 00:23:25,019
see what's actually being executed and

537
00:23:25,019 --> 00:23:26,669
you can scrape that content and actually

538
00:23:26,669 --> 00:23:29,580
do an analysis against it to see if it's

539
00:23:29,580 --> 00:23:31,229
malicious and I just link to did your

540
00:23:31,229 --> 00:23:33,239
Stephens tool that Lu dumped at the

541
00:23:33,239 --> 00:23:40,009
bottom so this last one is pretty new

542
00:23:40,220 --> 00:23:42,450
there's a there's a talk on this

543
00:23:42,450 --> 00:23:44,099
tomorrow so hopefully he goes in more

544
00:23:44,099 --> 00:23:45,690
detail I'm gonna be brief about it

545
00:23:45,690 --> 00:23:49,289
though the the overall concept here is

546
00:23:49,289 --> 00:23:53,070
you can send a meeting event to somebody

547
00:23:53,070 --> 00:23:55,440
and it'll just pop up on their calendar

548
00:23:55,440 --> 00:23:58,679
this was pretty there's there's some big

549
00:23:58,679 --> 00:24:00,299
news about it recently with with

550
00:24:00,299 --> 00:24:03,029
scammers doing it I took it kind of a

551
00:24:03,029 --> 00:24:05,519
next level and did it more as an

552
00:24:05,519 --> 00:24:10,109
adversary where I would just attach like

553
00:24:10,109 --> 00:24:12,419
a WebEx meeting and then say hey you

554
00:24:12,419 --> 00:24:15,960
need a an automated update didn't get

555
00:24:15,960 --> 00:24:17,970
pushed to your box and we need to do a

556
00:24:17,970 --> 00:24:20,009
manual update on your system they've

557
00:24:20,009 --> 00:24:21,690
joined the WebEx and

558
00:24:21,690 --> 00:24:23,009
you just talk them through giving you

559
00:24:23,009 --> 00:24:24,690
mouse and keyboard control download the

560
00:24:24,690 --> 00:24:27,360
payload say hey you're updated

561
00:24:27,360 --> 00:24:30,029
open up the office product or whatever

562
00:24:30,029 --> 00:24:32,309
and say oh yeah the version looks like

563
00:24:32,309 --> 00:24:33,690
it's up-to-date you're good to go if you

564
00:24:33,690 --> 00:24:35,129
have any questions go to your local IT

565
00:24:35,129 --> 00:24:39,870
desk so that works really well and it's

566
00:24:39,870 --> 00:24:42,870
it's kind of a something that hasn't

567
00:24:42,870 --> 00:24:44,940
really been done or I've seen talked

568
00:24:44,940 --> 00:24:48,240
about too much but I've pop shells that

569
00:24:48,240 --> 00:24:51,240
way there's a lot more scammers doing it

570
00:24:51,240 --> 00:24:53,759
with just like random links to something

571
00:24:53,759 --> 00:24:55,559
malicious that say you want a free

572
00:24:55,559 --> 00:24:58,080
iPhone but just ignore that

573
00:24:58,080 --> 00:25:02,269
so some points of discovery for that are

574
00:25:02,269 --> 00:25:03,480
again

575
00:25:03,480 --> 00:25:05,850
meeting meetings originating from non

576
00:25:05,850 --> 00:25:07,379
trusted domains this is going to be much

577
00:25:07,379 --> 00:25:09,659
harder for bigger organizations but if

578
00:25:09,659 --> 00:25:11,220
you know your client base you could

579
00:25:11,220 --> 00:25:14,490
potentially flag on that the other one

580
00:25:14,490 --> 00:25:18,090
is any meetings that appear without an

581
00:25:18,090 --> 00:25:21,919
actual email invite that's an indicator

582
00:25:21,919 --> 00:25:26,460
honestly I don't know a way to go in and

583
00:25:26,460 --> 00:25:28,889
look at that as a red teamer but it's

584
00:25:28,889 --> 00:25:30,990
something to think about and potentially

585
00:25:30,990 --> 00:25:34,769
look at as blue teamers and then as a

586
00:25:34,769 --> 00:25:38,039
tip just get the business to disable

587
00:25:38,039 --> 00:25:39,899
automatic adding of invitations to

588
00:25:39,899 --> 00:25:43,409
calendars because that'll make sure that

589
00:25:43,409 --> 00:25:45,659
they don't get that notification pop-up

590
00:25:45,659 --> 00:25:47,850
that oh I have a meeting in 10 minutes I

591
00:25:47,850 --> 00:25:50,519
have to make sure I join this that

592
00:25:50,519 --> 00:25:52,649
that's really the only tip I have right

593
00:25:52,649 --> 00:25:56,399
now hopefully tomorrow at the coalition

594
00:25:56,399 --> 00:25:58,259
talk he talks a little bit more about it

595
00:25:58,259 --> 00:26:03,450
but yeah so that's it for me this is

596
00:26:03,450 --> 00:26:05,789
actually my first con talk so thank you

597
00:26:05,789 --> 00:26:07,590
so much for your time I appreciate it

598
00:26:07,590 --> 00:26:10,379
and we if if you want to talk a little

599
00:26:10,379 --> 00:26:11,730
bit more afterwards and meet me at the

600
00:26:11,730 --> 00:26:13,879
bar

601
00:26:19,670 --> 00:26:21,799
sorry if I spoiled your OPSEC by saying

602
00:26:21,799 --> 00:26:22,580
where you were working for the past

603
00:26:22,580 --> 00:26:32,000
seven years Space Station thanks very

604
00:26:32,000 --> 00:26:34,309
much and we're gonna be outside for some

605
00:26:34,309 --> 00:26:36,320
Q&A and I think we have a break now as

606
00:26:36,320 --> 00:26:40,100
some Red Team people check in so thank

607
00:26:40,100 --> 00:26:42,189
you

608
00:26:44,420 --> 00:26:47,819
[Music]

