1
00:00:15,700 --> 00:00:18,700
thank you I'll

2
00:00:19,480 --> 00:00:24,939
- this room and thanks for attending my
presentation

3
00:00:26,080 --> 00:00:34,210
as you see i work for it XO XO is a
finnish company decided to set up shop

4
00:00:34,210 --> 00:00:39,100
right in the Netherlands as well so we
really we recently opened a branch in

5
00:00:39,100 --> 00:00:41,739
Amsterdam

6
00:00:41,739 --> 00:00:51,250
well my talk asst about a series of
unfortunate events which is very first

7
00:00:51,250 --> 00:01:00,640
obviously to book series offered by a
guy with a deus lemony snicket's and/or

8
00:01:00,640 --> 00:01:04,030
you probably know the movie with Jim
Carrey

9
00:01:04,030 --> 00:01:15,970
that's the bad guy Count Olaf so I I
sort of have a few barrels in the case

10
00:01:15,970 --> 00:01:20,080
of a ransom for instance so i thought
this needs to wear

11
00:01:20,080 --> 00:01:24,940
yeah to steal the few pictures from the
movie

12
00:01:26,410 --> 00:01:36,220
I'm ransomware it's not exactly a new
phenomenon phenomena about a decade ago

13
00:01:36,220 --> 00:01:44,259
and criminals realized that there is a a
nice business model and not just

14
00:01:44,259 --> 00:01:52,720
destroying files but be able to reverse
the process of course after paying up

15
00:01:52,720 --> 00:01:54,130
rental fee

16
00:01:54,130 --> 00:02:05,348
so apparently they be to test it for a
few years in Russia and since 2012 it

17
00:02:05,349 --> 00:02:12,459
spread across Europe and the US so it
obviously is mature enough for for us to

18
00:02:12,459 --> 00:02:15,459
consume this service

19
00:02:16,209 --> 00:02:20,530
well the thing about this service is
even if you pay the ransom

20
00:02:21,190 --> 00:02:24,910
there's no guarantee that you actually
get your files back in the end

21
00:02:26,830 --> 00:02:37,030
well in this case I hope that their that
they got their files back because it

22
00:02:37,030 --> 00:02:45,069
paid 70 thousand dollars so this is the
hollywood presbyterian hospital where

23
00:02:45,069 --> 00:02:54,608
was who was hit by a case of ransomware
yeah that was a pretty bad case i think

24
00:02:54,609 --> 00:02:57,939
it's a thesis of case is publicly known

25
00:02:59,049 --> 00:03:05,590
well it usually starts with something
like this

26
00:03:05,590 --> 00:03:08,920
unfortunately the hell desk gets a phone
call

27
00:03:09,430 --> 00:03:13,269
well we have some strange-looking files
here on this file share

28
00:03:13,269 --> 00:03:20,439
I am unable to open it in word or excel
or whatever as you can

29
00:03:20,439 --> 00:03:26,138
now it's highly readable i think but the
files here have a strange extension

30
00:03:26,139 --> 00:03:33,700
which is alluding to the email address
that you should contact the kidnapper

31
00:03:33,700 --> 00:03:37,719
and hopefully after paying you get your
files back

32
00:03:38,709 --> 00:03:40,060
I

33
00:03:40,060 --> 00:03:47,440
that happens I heard in a talk yesterday
and well three percent if i'm correct of

34
00:03:47,440 --> 00:03:55,450
the successful ransomware infection so
this business model obviously works well

35
00:03:55,450 --> 00:04:06,459
in this particular case this was a use
file share more at least six hundred

36
00:04:06,459 --> 00:04:12,880
gigabytes of files were encrypted at
least partially and created and this

37
00:04:12,880 --> 00:04:20,290
case the first 15 k of file were were
encrypted so that's just enough to make

38
00:04:20,290 --> 00:04:37,150
it useless and sometimes ue m you get
notified debt and sometimes you just get

39
00:04:37,150 --> 00:04:44,169
notified by a an end user and which is
pretty bad so that's means that say your

40
00:04:44,169 --> 00:04:46,900
first line of defense already has failed

41
00:04:46,900 --> 00:04:53,289
so you're hav solution has failed your
intrusion detection prevention

42
00:04:54,130 --> 00:05:00,760
whatever has filled already and the
kidnapper and health issues your files

43
00:05:01,419 --> 00:05:10,030
sometimes the kidnap for ransom and
leaves a ransom note on the desktop

44
00:05:10,600 --> 00:05:17,830
that's not always the case and even if
an end user sees a ransom note

45
00:05:18,729 --> 00:05:22,419
it's often reluctant and reporting a so

46
00:05:23,090 --> 00:05:30,859
let's take one step back and see let's
take a look at the incident healing

47
00:05:30,860 --> 00:05:36,139
process which is also useful when having
a case of farewell somewhere

48
00:05:37,160 --> 00:05:45,139
so as far as the preparation phase goes
you should not confused confused with

49
00:05:45,139 --> 00:05:49,940
the prevention part because obviously
already has filled your abs field etc

50
00:05:49,940 --> 00:05:58,639
it's his right but incidence response
process and the preparation is all about

51
00:05:58,639 --> 00:06:04,550
thinking of everything what could go
wrong and how to respond on that

52
00:06:04,550 --> 00:06:14,060
so think about for example an arsenal of
tools you're familiar with that are

53
00:06:14,060 --> 00:06:19,010
useful in handling the process and the
level of access you probably has instant

54
00:06:19,010 --> 00:06:23,389
responder need to talk to the business

55
00:06:24,530 --> 00:06:31,700
- I t to elevate your privilege is in
order to investigate the issue probably

56
00:06:31,700 --> 00:06:35,000
needs admin level access to servers

57
00:06:36,080 --> 00:06:42,889
it's a good idea to be trained as
professional so you know what to do when

58
00:06:42,889 --> 00:06:47,960
the rent from where is in the process of
encrypting your entire file share

59
00:06:49,250 --> 00:06:56,240
sometimes you you have seen here to deal
with with a real regular regulatory

60
00:06:56,240 --> 00:07:03,560
bodies like for instance here in
evidence we have a breach notification

61
00:07:03,560 --> 00:07:06,560
law that was introduced

62
00:07:07,190 --> 00:07:13,670
earlier this year and that states that
you should report any incidents we had

63
00:07:13,670 --> 00:07:24,260
constant potentially concerns data or
information about persons and because

64
00:07:24,260 --> 00:07:30,800
you cannot remove that in out in advance
as probably the best best to report that

65
00:07:30,800 --> 00:07:37,430
because you make a day you trying if you
made that step and the shit hits the fan

66
00:07:37,970 --> 00:07:51,860
laser um well the preparation phase of
from some companies is just as much as

67
00:07:51,860 --> 00:07:56,450
having a sticky note on the screen with
the phone number who to call when there

68
00:07:56,450 --> 00:08:04,849
are problems so that's good for our
business of course but the flip side is

69
00:08:04,850 --> 00:08:13,220
that and the responder and first case in
adalat very late stage so recently most

70
00:08:13,220 --> 00:08:21,800
evidences is is already gone and you get
stuck with a huge pile of files that are

71
00:08:21,800 --> 00:08:29,300
encrypted sometimes if you're lucky
there exist three two three first that

72
00:08:29,300 --> 00:08:32,299
process but that's not always the case

73
00:08:34,370 --> 00:08:43,370
what is important is if you refers to
respond to that you make sure that you

74
00:08:43,370 --> 00:08:52,250
collected as much information as
possible so it's very useful to locate a

75
00:08:52,250 --> 00:08:53,450
patient zero

76
00:08:53,450 --> 00:08:57,920
the original effects of the original
effects if you have a sample of the

77
00:08:57,920 --> 00:08:59,610
malware

78
00:08:59,610 --> 00:09:07,019
you can analyze that and see if it
communicates to command command control

79
00:09:07,019 --> 00:09:13,860
infrastructure and you can take some
measures probably at the network level

80
00:09:13,860 --> 00:09:22,140
to block the shirts and Rachel IP
addresses or whatever so lets you what

81
00:09:22,140 --> 00:09:27,870
you can look at if you happen to have
access to the file server

82
00:09:28,560 --> 00:09:33,510
remember that you need to arrange yet as
part of your preparation

83
00:09:34,110 --> 00:09:38,910
you could take a look at next set open
connections

84
00:09:38,910 --> 00:09:47,160
obviously when encryption is in process
as a crimp encrypting files on your file

85
00:09:47,160 --> 00:09:51,810
server and have a lot of open
connections from the single host that is

86
00:09:51,810 --> 00:09:54,810
infected so that point you in the right
direction

87
00:09:55,589 --> 00:10:05,370
also the open files command is very
useful that even points you to the user

88
00:10:05,370 --> 00:10:10,500
name that has been infected

89
00:10:12,510 --> 00:10:15,660
if the encryption already has stopped

90
00:10:15,660 --> 00:10:19,420
you can return to less volatile in

91
00:10:19,420 --> 00:10:24,219
the data and take a look at the firewall
connection locks if these are available

92
00:10:24,220 --> 00:10:33,820
which is also not always the case or
NetFlow data so there's no guarantee

93
00:10:33,820 --> 00:10:40,000
that you can locate patient zero or get
a sample of the river and malware

94
00:10:40,000 --> 00:10:45,790
because it often destroys itself after
having done the dirty deed

95
00:10:47,290 --> 00:10:54,219
so I is a process is still in going you
want obviously to prevent it from

96
00:10:54,220 --> 00:10:56,140
getting worse

97
00:10:56,140 --> 00:11:04,900
so you might be tempted to unblock the
network cable from the file server which

98
00:11:04,900 --> 00:11:14,020
might seem a good idea but you destroy
some formatting information so i

99
00:11:14,020 --> 00:11:26,470
recommend that you take a look at the
net steps data for the first so and

100
00:11:26,470 --> 00:11:37,900
there are some other things that you
could do after after the end if the

101
00:11:37,900 --> 00:11:43,300
encryption as stop but that might be a
problem that it reappear sway if you're

102
00:11:43,300 --> 00:11:48,550
not able to fully eradicate the
ransomware and you have

103
00:11:49,200 --> 00:11:52,200
you have to be as early as possible

104
00:11:53,100 --> 00:11:59,280
you ask me need to be notified of a
newer and encryption around

105
00:11:59,280 --> 00:12:07,470
so what you could do is use for example
file service we resource resource

106
00:12:07,470 --> 00:12:13,230
manager file screen feature which is
actually really need you can figure

107
00:12:13,230 --> 00:12:20,610
configurate to alert you when new files
pop up with a certain extension or a

108
00:12:20,610 --> 00:12:24,810
certain pattern are you

109
00:12:24,810 --> 00:12:29,010
alternatively you could configure a file
system objects auditing

110
00:12:30,000 --> 00:12:39,930
here's a link which has a pretty neat
idea of that actually creating a sibling

111
00:12:39,930 --> 00:12:50,189
like falles on your systems that look
back to itself so if the ransomware

112
00:12:50,190 --> 00:12:58,830
descends into a certain folder it hits
the same link to the same folder and

113
00:12:58,830 --> 00:13:05,430
obviously we'll start from resources or
die and effectively

114
00:13:05,430 --> 00:13:13,020
he stopped at the process other ideas
blocking this he did a command and

115
00:13:13,020 --> 00:13:16,020
control traffic

116
00:13:16,970 --> 00:13:26,660
one thing you have to you and to remind
here if you use descending approach and

117
00:13:26,660 --> 00:13:32,750
you might run into trouble because some
software for example

118
00:13:32,750 --> 00:13:40,550
ap Skinner when you perform a full file
scan will follow into the same trap so

119
00:13:40,550 --> 00:13:43,550
may die as well so be careful

120
00:13:45,680 --> 00:13:51,079
unless you have been able to follow him
shadow copies so you probably need to

121
00:13:51,079 --> 00:13:54,079
rely on traditional back up

122
00:13:54,769 --> 00:14:10,970
we share often means it's a day old or
best case so that the what what is the

123
00:14:10,970 --> 00:14:19,670
same and so is it important that if you
have a set of known good files

124
00:14:19,670 --> 00:14:24,410
you don't want to override the files
that have not been affected by the

125
00:14:24,410 --> 00:14:29,209
ransomware so you must do is selectively
restore and that might pose some

126
00:14:29,209 --> 00:14:30,018
challenges

127
00:14:30,019 --> 00:14:41,449
so first thing you can do is identify
the files that were actually affected in

128
00:14:41,449 --> 00:14:42,529
the first place

129
00:14:42,529 --> 00:14:48,439
so in this particular case the it was
pretty obvious because the files were

130
00:14:48,439 --> 00:14:50,529
renamed

131
00:14:50,529 --> 00:14:55,120
and don't know if you can read it up
there it is the email address

132
00:14:56,350 --> 00:14:59,889
decoded india.com of the kidnapper

133
00:15:00,699 --> 00:15:06,790
so a first step at this is just running
duress commands to be sent to

134
00:15:06,790 --> 00:15:08,769
recursively list all files

135
00:15:08,769 --> 00:15:20,110
well that in this example we have nine
on a 24 files but in the real case is

136
00:15:20,110 --> 00:15:30,459
what's more than 50,000 there is a
something weird going on here because if

137
00:15:30,459 --> 00:15:36,279
you use the file explorer to feel thrown
their on this file this file type you

138
00:15:36,279 --> 00:15:37,449
end up with

139
00:15:37,449 --> 00:15:42,579
30 more files so that's interesting that
we have to see a discrepancy

140
00:15:43,269 --> 00:15:50,800
so perhaps dog has seen his best best
time so let's write powershell word

141
00:15:50,800 --> 00:15:59,258
so this is actually the same listing and
again nine or 24 files are still 30

142
00:15:59,259 --> 00:16:00,399
files missing

143
00:16:00,399 --> 00:16:09,339
powershell is actually very helpful here
because it's as readable I know but

144
00:16:09,339 --> 00:16:15,879
trust me it says something along the
lines of a file path must be less than

145
00:16:15,879 --> 00:16:21,490
the ordinate 260 characters so in order
to display

146
00:16:21,490 --> 00:16:25,930
so are right that's obviously a problem

147
00:16:26,439 --> 00:16:33,069
the ransomware was able to descend into
a folder structure which caused the file

148
00:16:33,069 --> 00:16:40,479
path to exceed that limit and if you
browse the Microsoft website you find

149
00:16:40,480 --> 00:16:45,490
this limitation which is pretty
disappointing from modern operating

150
00:16:45,490 --> 00:16:55,179
system because the NTFS file system for
example supports file path up to 32768

151
00:16:55,179 --> 00:16:56,970
or something

152
00:16:56,970 --> 00:17:03,509
characters and bath links so it appears
to be the problem in the underlying api

153
00:17:03,509 --> 00:17:09,630
for basic care file i/o which dates back
to good ol those times

154
00:17:10,409 --> 00:17:16,980
at least when some the room where it
sets a spirited person when microsoft

155
00:17:16,980 --> 00:17:20,579
said 640 kilobytes is enough for anyone

156
00:17:21,449 --> 00:17:28,559
so you would say they're probably be
able to live that problem

157
00:17:28,559 --> 00:17:34,770
yes you could do that in the API and but
well applications

158
00:17:34,770 --> 00:17:41,520
not so much as a reserve only 260
characters and the filename exceeds that

159
00:17:41,520 --> 00:17:42,270
size

160
00:17:42,270 --> 00:17:45,690
I don't have to explain you what about
for overflow can do

161
00:17:45,690 --> 00:17:51,720
so that's probably the reason Microsoft
didn't touch that part of the a windows

162
00:17:51,720 --> 00:17:56,850
api so i will how can you answer
complain that problem

163
00:17:56,850 --> 00:18:01,590
yes well boss is actually useful here

164
00:18:02,100 --> 00:18:07,889
I don't know if you and you see some
people with gray hair will probably

165
00:18:07,890 --> 00:18:16,110
remember the subsequent Matt's actually
you can

166
00:18:16,110 --> 00:18:20,039
alias full name with a drive letter

167
00:18:20,549 --> 00:18:23,549
so if you have a really long

168
00:18:24,100 --> 00:18:31,809
directory name you can just call it a
free available drive letter and refer to

169
00:18:31,809 --> 00:18:34,809
that as well and well there are your
files

170
00:18:35,919 --> 00:18:45,070
um another problem you can run into is a
while you try to identify the files yet

171
00:18:45,070 --> 00:18:48,010
even if you have administrative
privileges

172
00:18:48,010 --> 00:18:55,179
you cannot access these files and that
probably has to do something that

173
00:18:55,179 --> 00:19:03,970
administrators sometimes should not be a
able to read all files for example human

174
00:19:03,970 --> 00:19:07,270
resource information and sets right
whatever

175
00:19:07,270 --> 00:19:15,639
so you could easily resolve that use
high cackles command line to that has a

176
00:19:15,640 --> 00:19:22,539
take own option which will take
ownership so you have access in the end

177
00:19:22,539 --> 00:19:27,970
but the problem again is that to order
to 60 character bath limitation

178
00:19:30,490 --> 00:19:37,510
so yeah you can use this substrate to
circumvent it but it's very cumbersome

179
00:19:37,510 --> 00:19:45,490
so we have actually a to that is
built-in since windows 2008

180
00:19:45,490 --> 00:19:51,490
it's called robocopy very convenience
for copying entire folder structures and

181
00:19:51,490 --> 00:19:53,590
doing all kinds of cool stuff

182
00:19:53,590 --> 00:20:02,350
and with this simple trick you can list
all files and it has no bath limitation

183
00:20:02,350 --> 00:20:08,740
you actually solve another problem that
the ownership problem

184
00:20:08,740 --> 00:20:12,610
you don't have to take ownership because
it uses the windows back a privilege

185
00:20:12,610 --> 00:20:16,600
which allows you to bypass the

186
00:20:16,600 --> 00:20:20,139
JC else that are set on the files though

187
00:20:20,140 --> 00:20:31,690
yeah very cool actually so cool thing
would be to combine both powershell

188
00:20:31,690 --> 00:20:34,810
powers and robocopy powers

189
00:20:34,810 --> 00:20:38,169
there's a nice blog on this

190
00:20:39,610 --> 00:20:46,750
you can take a look at yourself it was a
blog post by both products which got

191
00:20:46,750 --> 00:20:55,900
with some power shell grow and why i
thought well i like a head to expand on

192
00:20:55,900 --> 00:21:04,150
that idea and build a full power shell
lie module with tools to identify this

193
00:21:04,150 --> 00:21:10,480
type of files when you ever ran a ransom
or in their case

194
00:21:10,480 --> 00:21:19,390
so what you typically want to do is to
to restore your files but once you do

195
00:21:19,390 --> 00:21:27,730
that says selectively and there are not
many backup solutions that allow you to

196
00:21:27,730 --> 00:21:34,360
feed a text file with a listing of file
paths to actually do the selection and

197
00:21:34,360 --> 00:21:37,540
to selectively restore those files

198
00:21:37,540 --> 00:21:43,389
what well maybe we can abused robocopy
to do that

199
00:21:43,390 --> 00:21:53,500
it takes file paths and single files but
you have to combine that and powershell

200
00:21:53,500 --> 00:21:56,500
convenient is very convenient to do that

201
00:21:57,270 --> 00:22:11,879
this actually was the good news in this
from a case of a one day old backup but

202
00:22:11,880 --> 00:22:15,570
the volume mr. pretty large and the one
link is pretty limited

203
00:22:16,260 --> 00:22:25,260
so it will take a little over 35 hours
to restore over the network

204
00:22:26,970 --> 00:22:36,930
not good so you can actually save some
time by performing a full restore to to

205
00:22:36,930 --> 00:22:44,730
a local drive and obviously obviously
you need to select a fast drive so not

206
00:22:44,730 --> 00:22:55,980
just something that's probably an old
USB to crappy drive but anyway

207
00:22:56,670 --> 00:23:04,620
and in this case they restore through
food was between 25 and 30 mega buys and

208
00:23:04,620 --> 00:23:08,010
24 hours which is acceptable

209
00:23:08,010 --> 00:23:14,070
considering that the expedition to one
and a half two hours

210
00:23:14,640 --> 00:23:19,680
so this is a famous quote i don't know
if you can read it

211
00:23:19,680 --> 00:23:25,530
by Andrew Tannenbaum never underestimate
the bandwidth of a station wagon full of

212
00:23:25,530 --> 00:23:27,480
tapes hurling down the highway

213
00:23:27,480 --> 00:23:32,970
well obviously we're using a portable
hard hard drive nowadays but is still

214
00:23:32,970 --> 00:23:36,100
applicable

215
00:23:36,100 --> 00:23:39,428
so we don't write

216
00:23:39,429 --> 00:23:47,860
well apparently a few days later and use
the calls

217
00:23:47,860 --> 00:23:55,330
well at this strange file it looks
alright it's our word document but i'm

218
00:23:55,330 --> 00:23:57,280
still unable to open it

219
00:23:57,280 --> 00:24:04,840
it's garbage and it appeared that the
ransomware actually was successful and

220
00:24:04,840 --> 00:24:10,570
encrypting the file but I'm successfully
renaming the file because it hit the

221
00:24:10,570 --> 00:24:15,668
same 260 character file path limitation

222
00:24:15,669 --> 00:24:24,789
so back to the drawing board or actually
back to the powershell module and and

223
00:24:24,789 --> 00:24:29,919
try to come up with methods to identify
by these new files

224
00:24:31,750 --> 00:24:40,840
well powershell is as great in imparting
stuff and especially day so I was

225
00:24:40,840 --> 00:24:45,428
convenience to select make a sub
selection of files that have been

226
00:24:45,429 --> 00:24:51,789
modified during the period that is
random somewhere is active but it still

227
00:24:51,789 --> 00:24:58,150
contains a mix of file set we're
actually edited by users and the rent

228
00:24:58,150 --> 00:25:05,409
somewhere so it's a little bit better
but still not satisfy

229
00:25:05,409 --> 00:25:12,760
so next thing I did was well try to
identify encrypted blocks

230
00:25:12,760 --> 00:25:18,370
you know that first 60 k was was
encrypted so we expect

231
00:25:18,370 --> 00:25:25,840
I entropy there as single block and
after 60 k or so

232
00:25:25,840 --> 00:25:32,260
enter people as want fluctuating
depending on the contents of the file so

233
00:25:32,260 --> 00:25:39,879
i had that into the powershell module
and was successful in restoring all

234
00:25:39,880 --> 00:25:40,600
files

235
00:25:40,600 --> 00:25:50,649
the end so your recovery from a
ransomware instant can be quite complex

236
00:25:50,650 --> 00:25:55,210
actually and it really pays off to be
well prepared

237
00:25:56,020 --> 00:26:04,690
so you you should consider this scenario
where you will never find the original

238
00:26:04,690 --> 00:26:10,240
effector you should consider the fact
that there is no description to

239
00:26:10,240 --> 00:26:20,260
available so you have to rely on on your
backup procedure so i suggest to do

240
00:26:20,260 --> 00:26:26,860
exercise to see if you can still meet
your recovery time objective when

241
00:26:26,860 --> 00:26:34,780
needing to prefer our form a selective
restore you might consider some

242
00:26:34,780 --> 00:26:41,740
prevention or at least a well in
addition to the preventive measures to

243
00:26:41,740 --> 00:26:47,559
improve your detection capabilities by
using the file share canneries we saw

244
00:26:47,559 --> 00:26:58,600
earlier in the slides and well that's
about it so take questions now

245
00:26:59,169 --> 00:27:03,280
no questions

246
00:27:04,440 --> 00:27:13,380
okay thank you

