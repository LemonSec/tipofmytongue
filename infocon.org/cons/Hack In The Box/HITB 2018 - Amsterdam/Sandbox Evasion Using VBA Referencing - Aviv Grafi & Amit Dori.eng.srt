1
00:00:12,480 --> 00:00:15,849
thank you very<font color="#E5E5E5"> much</font><font color="#CCCCCC"> for having</font><font color="#E5E5E5"> me thank</font>

2
00:00:14,650 --> 00:00:18,400
you<font color="#E5E5E5"> very much for</font><font color="#CCCCCC"> coming</font>

3
00:00:15,849 --> 00:00:20,470
my name is Amit<font color="#CCCCCC"> and we're</font><font color="#E5E5E5"> gonna talk</font>

4
00:00:18,400 --> 00:00:23,709
about sandbox<font color="#E5E5E5"> evasion and</font><font color="#CCCCCC"> sin book says</font>

5
00:00:20,470 --> 00:00:28,270
in<font color="#CCCCCC"> general and we're gonna get to VBA</font>

6
00:00:23,710 --> 00:00:31,570
referencing in a sec<font color="#E5E5E5"> the key principle</font>

7
00:00:28,270 --> 00:00:33,460
<font color="#E5E5E5">I'd like you to live from this talk is a</font>

8
00:00:31,570 --> 00:00:36,700
new<font color="#E5E5E5"> approach to sandbox evasion</font><font color="#CCCCCC"> and</font>

9
00:00:33,460 --> 00:00:39,640
we'll<font color="#E5E5E5"> get to it so as I said my</font><font color="#CCCCCC"> name is</font>

10
00:00:36,700 --> 00:00:44,469
<font color="#E5E5E5">Amit I'm a security researcher at</font><font color="#CCCCCC"> 40</font><font color="#E5E5E5"> row</font>

11
00:00:39,640 --> 00:00:46,809
I'm from Tel<font color="#CCCCCC"> Aviv Israel 28 years</font><font color="#E5E5E5"> old</font>

12
00:00:44,469 --> 00:00:48,940
<font color="#E5E5E5">working</font><font color="#CCCCCC"> for vertigo for the last year</font>

13
00:00:46,809 --> 00:00:51,879
<font color="#E5E5E5">and before</font><font color="#CCCCCC"> that I</font><font color="#E5E5E5"> was working</font><font color="#CCCCCC"> at</font>

14
00:00:48,940 --> 00:00:53,530
checkpoint<font color="#E5E5E5"> researching studying exploit</font>

15
00:00:51,879 --> 00:00:57,579
kit as part of the threat intelligence

16
00:00:53,530 --> 00:01:01,949
group my<font color="#CCCCCC"> leg skate skateboarding</font>

17
00:00:57,579 --> 00:01:05,530
swimming and I played<font color="#E5E5E5"> the guitar and my</font>

18
00:01:01,949 --> 00:01:07,240
<font color="#E5E5E5">core researcher in this presentation is</font>

19
00:01:05,530 --> 00:01:11,500
Aviv who couldn't be<font color="#CCCCCC"> here today he's the</font>

20
00:01:07,240 --> 00:01:17,429
<font color="#E5E5E5">CEO of Vittorio unfortunately he</font>

21
00:01:11,500 --> 00:01:21,670
couldn't come<font color="#E5E5E5"> so that's it let's begin</font>

22
00:01:17,430 --> 00:01:24,070
<font color="#E5E5E5">okay so</font><font color="#CCCCCC"> Steinbach says have</font><font color="#E5E5E5"> become very</font>

23
00:01:21,670 --> 00:01:27,040
big in<font color="#E5E5E5"> the</font><font color="#CCCCCC"> industry right most</font>

24
00:01:24,070 --> 00:01:30,000
<font color="#E5E5E5">organization</font><font color="#CCCCCC"> use</font><font color="#E5E5E5"> them nowadays and it's</font>

25
00:01:27,040 --> 00:01:33,280
<font color="#E5E5E5">heavily trusted I mean once a file is</font>

26
00:01:30,000 --> 00:01:35,320
has passed the sandbox<font color="#CCCCCC"> you can pretty</font>

27
00:01:33,280 --> 00:01:38,470
much trust you can pretty much trust

28
00:01:35,320 --> 00:01:40,149
that it's safe<font color="#CCCCCC"> and</font><font color="#E5E5E5"> you</font><font color="#CCCCCC"> can execute it in</font>

29
00:01:38,470 --> 00:01:44,350
your<font color="#CCCCCC"> environment in your organization</font>

30
00:01:40,150 --> 00:01:46,870
and<font color="#E5E5E5"> everything and then ever since</font><font color="#CCCCCC"> sand</font>

31
00:01:44,350 --> 00:01:48,309
<font color="#E5E5E5">boxes have began to appear Marvel</font>

32
00:01:46,870 --> 00:01:50,200
<font color="#E5E5E5">authors have began to use sandbox</font>

33
00:01:48,310 --> 00:01:53,050
<font color="#E5E5E5">evasion techniques to bypass</font><font color="#CCCCCC"> that</font>

34
00:01:50,200 --> 00:01:54,640
<font color="#E5E5E5">sandbox</font><font color="#CCCCCC"> and so it's a never-ending</font>

35
00:01:53,050 --> 00:01:56,880
<font color="#E5E5E5">process and we're going to talk</font><font color="#CCCCCC"> about a</font>

36
00:01:54,640 --> 00:02:00,100
new way to perform sandbox<font color="#E5E5E5"> evasion</font>

37
00:01:56,880 --> 00:02:02,140
unlike most of those techniques those

38
00:02:00,100 --> 00:02:04,600
<font color="#E5E5E5">ten box evasion techniques we don't</font>

39
00:02:02,140 --> 00:02:06,910
require code execution<font color="#E5E5E5"> and I'm</font><font color="#CCCCCC"> gonna</font>

40
00:02:04,600 --> 00:02:08,859
<font color="#E5E5E5">show how we do it and detect and evade</font>

41
00:02:06,910 --> 00:02:11,709
the sandbox<font color="#E5E5E5"> without code execution on</font>

42
00:02:08,860 --> 00:02:17,560
the sandbox<font color="#E5E5E5"> actually the detection part</font>

43
00:02:11,709 --> 00:02:18,940
<font color="#E5E5E5">is server-side at the attacker side just</font>

44
00:02:17,560 --> 00:02:21,130
a few<font color="#E5E5E5"> notes I'm</font><font color="#CCCCCC"> going to jump between</font>

45
00:02:18,940 --> 00:02:22,630
<font color="#E5E5E5">topics I'm gonna start it sandbox</font>

46
00:02:21,130 --> 00:02:24,579
evading techniques and then talk about

47
00:02:22,630 --> 00:02:25,090
<font color="#CCCCCC">three-way referencing so in order not to</font>

48
00:02:24,580 --> 00:02:27,760
get

49
00:02:25,090 --> 00:02:30,220
<font color="#E5E5E5">fused we've added these two icons</font><font color="#CCCCCC"> just</font>

50
00:02:27,760 --> 00:02:32,739
<font color="#CCCCCC">to clarify</font><font color="#E5E5E5"> where we had so if we're</font>

51
00:02:30,220 --> 00:02:35,680
gonna talk evasion<font color="#CCCCCC"> I don't know do you</font>

52
00:02:32,739 --> 00:02:39,300
<font color="#CCCCCC">see</font><font color="#E5E5E5"> this little marker so this little</font>

53
00:02:35,680 --> 00:02:41,290
guy gonna show evasion<font color="#E5E5E5"> part and this</font>

54
00:02:39,300 --> 00:02:48,790
magnifying glass we're<font color="#E5E5E5"> gonna show the</font>

55
00:02:41,290 --> 00:02:52,090
detection<font color="#CCCCCC"> scheme usually when talking</font>

56
00:02:48,790 --> 00:02:55,200
about sandbox<font color="#E5E5E5"> evasion in relation to</font>

57
00:02:52,090 --> 00:02:58,209
office and<font color="#E5E5E5"> office documents and stuff</font>

58
00:02:55,200 --> 00:03:01,959
<font color="#E5E5E5">the following topics might come to mind</font>

59
00:02:58,209 --> 00:03:07,720
<font color="#CCCCCC">but we won't go into them</font><font color="#E5E5E5"> extensively</font>

60
00:03:01,959 --> 00:03:09,579
<font color="#E5E5E5">just a bit so if you have any questions</font>

61
00:03:07,720 --> 00:03:11,109
just<font color="#CCCCCC"> feel free to come and</font><font color="#E5E5E5"> ask me after</font>

62
00:03:09,579 --> 00:03:13,720
the presentation<font color="#E5E5E5"> or email me and</font>

63
00:03:11,110 --> 00:03:16,030
everything so we won't go<font color="#E5E5E5"> into a VBA</font>

64
00:03:13,720 --> 00:03:17,859
macros will be a visual<font color="#CCCCCC"> basic for</font>

65
00:03:16,030 --> 00:03:20,470
applications macros and office protected

66
00:03:17,860 --> 00:03:23,110
<font color="#E5E5E5">view sandbox solutions in general and</font>

67
00:03:20,470 --> 00:03:24,609
tracking pixels but<font color="#E5E5E5"> as I said feel</font><font color="#CCCCCC"> free</font>

68
00:03:23,110 --> 00:03:29,639
to approach me and<font color="#E5E5E5"> we</font><font color="#CCCCCC"> can</font><font color="#E5E5E5"> discuss those</font>

69
00:03:24,610 --> 00:03:35,880
later<font color="#CCCCCC"> on okay then</font>

70
00:03:29,639 --> 00:03:38,980
so<font color="#E5E5E5"> evasion notice there little guy so</font>

71
00:03:35,880 --> 00:03:41,109
with the introduction<font color="#CCCCCC"> of</font><font color="#E5E5E5"> sandboxes in</font>

72
00:03:38,980 --> 00:03:43,540
<font color="#E5E5E5">organization</font><font color="#CCCCCC"> Marvel authors have</font>

73
00:03:41,109 --> 00:03:45,130
introduced<font color="#E5E5E5"> sandbox evasion and that's</font>

74
00:03:43,540 --> 00:03:50,230
pretty<font color="#CCCCCC"> much</font><font color="#E5E5E5"> a term used to describe</font>

75
00:03:45,130 --> 00:03:54,358
every way to detect and evade and

76
00:03:50,230 --> 00:03:58,660
manipulate<font color="#CCCCCC"> and trick a sandbox</font><font color="#E5E5E5"> literally</font>

77
00:03:54,359 --> 00:04:00,190
any way<font color="#E5E5E5"> you</font><font color="#CCCCCC"> can do to bypass the sandbox</font>

78
00:03:58,660 --> 00:04:01,989
and there are a<font color="#E5E5E5"> lot of techniques and</font>

79
00:04:00,190 --> 00:04:03,489
<font color="#CCCCCC">they have been used and updated along</font>

80
00:04:01,989 --> 00:04:06,970
the years we're going to go through some

81
00:04:03,489 --> 00:04:09,819
<font color="#CCCCCC">of them quickly</font><font color="#E5E5E5"> just as a reference and</font>

82
00:04:06,970 --> 00:04:12,040
I'm actually this information came from

83
00:04:09,819 --> 00:04:13,899
<font color="#E5E5E5">a very good presentation countering</font>

84
00:04:12,040 --> 00:04:16,810
innovative sandbox evasion<font color="#E5E5E5"> techniques</font>

85
00:04:13,900 --> 00:04:20,889
used by<font color="#CCCCCC"> malware from first conference</font>

86
00:04:16,810 --> 00:04:22,870
last<font color="#E5E5E5"> year in Amsterdam so in order to</font>

87
00:04:20,889 --> 00:04:25,030
detect<font color="#E5E5E5"> the sandbox</font><font color="#CCCCCC"> I can look</font><font color="#E5E5E5"> for</font>

88
00:04:22,870 --> 00:04:28,479
<font color="#E5E5E5">virtualization products I mean usually</font><font color="#CCCCCC"> a</font>

89
00:04:25,030 --> 00:04:30,580
sandbox is a virtualized machine that

90
00:04:28,479 --> 00:04:33,789
<font color="#E5E5E5">executing the file analyzes it and then</font>

91
00:04:30,580 --> 00:04:35,710
shuts down<font color="#E5E5E5"> results so I can look at the</font>

92
00:04:33,789 --> 00:04:37,840
hypervisor<font color="#E5E5E5"> and I can try to understand</font>

93
00:04:35,710 --> 00:04:38,770
which hypervisor<font color="#E5E5E5"> is it is it the</font>

94
00:04:37,840 --> 00:04:41,099
physical<font color="#E5E5E5"> machine</font>

95
00:04:38,770 --> 00:04:44,289
is it a virtualized machine for example

96
00:04:41,099 --> 00:04:46,210
<font color="#CCCCCC">VMware or VirtualBox I can</font><font color="#E5E5E5"> look for</font>

97
00:04:44,289 --> 00:04:49,479
relevant<font color="#CCCCCC"> virtualization dll's</font>

98
00:04:46,210 --> 00:04:51,219
exactly the same<font color="#CCCCCC"> I can look at side</font>

99
00:04:49,479 --> 00:04:52,810
channels attack and try<font color="#CCCCCC"> to compare</font>

100
00:04:51,220 --> 00:04:55,389
<font color="#CCCCCC">between a</font><font color="#E5E5E5"> physical hardware and a</font>

101
00:04:52,810 --> 00:04:57,879
virtualized<font color="#E5E5E5"> hardware I can</font><font color="#CCCCCC"> look for</font>

102
00:04:55,389 --> 00:05:02,139
unusual<font color="#CCCCCC"> hardware in the machine</font><font color="#E5E5E5"> for</font>

103
00:04:57,879 --> 00:05:03,909
<font color="#E5E5E5">example</font><font color="#CCCCCC"> low</font><font color="#E5E5E5"> ram memory or low disk size</font>

104
00:05:02,139 --> 00:05:08,470
<font color="#E5E5E5">I mean something that's not usual</font><font color="#CCCCCC"> for a</font>

105
00:05:03,909 --> 00:05:10,330
user to<font color="#CCCCCC"> be</font><font color="#E5E5E5"> using another thing I could</font>

106
00:05:08,470 --> 00:05:15,669
do<font color="#CCCCCC"> to detect the sandbox is look at the</font>

107
00:05:10,330 --> 00:05:19,030
environment<font color="#E5E5E5"> pass the the hardware or the</font>

108
00:05:15,669 --> 00:05:21,400
<font color="#E5E5E5">virtualization I can look and try to</font>

109
00:05:19,030 --> 00:05:23,469
detect<font color="#E5E5E5"> whether this is an genuine user</font>

110
00:05:21,400 --> 00:05:26,710
actually<font color="#E5E5E5"> running this environment what's</font>

111
00:05:23,470 --> 00:05:28,990
the<font color="#E5E5E5"> user name does it have cookies or</font>

112
00:05:26,710 --> 00:05:31,568
browser history recent file count what's

113
00:05:28,990 --> 00:05:34,180
the screen resolution<font color="#CCCCCC"> I can</font><font color="#E5E5E5"> look for</font>

114
00:05:31,569 --> 00:05:35,560
running processes and try to understand

115
00:05:34,180 --> 00:05:39,840
if it's actually a security<font color="#E5E5E5"> researcher</font>

116
00:05:35,560 --> 00:05:42,280
<font color="#E5E5E5">that's executing my malware I mean does</font>

117
00:05:39,840 --> 00:05:44,258
does it have Wireshark running or

118
00:05:42,280 --> 00:05:46,809
process<font color="#E5E5E5"> Explorer or process monitor I</font>

119
00:05:44,259 --> 00:05:49,599
mean if I see<font color="#E5E5E5"> these processes</font><font color="#CCCCCC"> I might</font>

120
00:05:46,810 --> 00:05:51,639
not want<font color="#E5E5E5"> to in fact and the final</font>

121
00:05:49,599 --> 00:05:53,860
<font color="#CCCCCC">technique to detect the sandbox</font><font color="#E5E5E5"> is</font>

122
00:05:51,639 --> 00:05:56,650
actually look for all vulnerabilities I

123
00:05:53,860 --> 00:05:59,139
mean if I scan the<font color="#CCCCCC"> environment for</font><font color="#E5E5E5"> a</font>

124
00:05:56,650 --> 00:06:01,659
very old vulnerability and I find it it

125
00:05:59,139 --> 00:06:03,120
exists in the machine it means that this

126
00:06:01,659 --> 00:06:06,039
machine<font color="#E5E5E5"> hasn't been</font><font color="#CCCCCC"> updated in</font><font color="#E5E5E5"> a while</font>

127
00:06:03,120 --> 00:06:09,279
<font color="#E5E5E5">so it's not a likely scenario for a user</font>

128
00:06:06,039 --> 00:06:10,960
<font color="#E5E5E5">and I say if it has this vulnerability</font><font color="#CCCCCC"> I</font>

129
00:06:09,279 --> 00:06:14,860
might not want to infect this machine

130
00:06:10,960 --> 00:06:16,599
because<font color="#CCCCCC"> it might be a sandbox this tool</font>

131
00:06:14,860 --> 00:06:18,430
is<font color="#E5E5E5"> called paranoid fish I'm guessing</font>

132
00:06:16,599 --> 00:06:23,710
most<font color="#E5E5E5"> of security researchers know it</font>

133
00:06:18,430 --> 00:06:25,389
it's used to its<font color="#E5E5E5"> aim to</font><font color="#CCCCCC"> use by security</font>

134
00:06:23,710 --> 00:06:28,210
researchers<font color="#CCCCCC"> to test their sandbox</font>

135
00:06:25,389 --> 00:06:29,770
<font color="#E5E5E5">environment you execute it within your</font>

136
00:06:28,210 --> 00:06:31,840
machine and<font color="#E5E5E5"> it tries to detect the</font>

137
00:06:29,770 --> 00:06:33,758
environment all sorts of stuff that<font color="#E5E5E5"> we</font>

138
00:06:31,840 --> 00:06:36,638
talked about<font color="#E5E5E5"> it looks at the hypervisor</font>

139
00:06:33,759 --> 00:06:41,229
<font color="#E5E5E5">it looks at the</font><font color="#CCCCCC"> username Mouse activity</font>

140
00:06:36,639 --> 00:06:46,330
<font color="#E5E5E5">disk size</font><font color="#CCCCCC"> RAM size side-channel attacks</font>

141
00:06:41,229 --> 00:06:48,250
and so on so that's for detecting<font color="#E5E5E5"> the</font>

142
00:06:46,330 --> 00:06:52,409
sandbox and<font color="#E5E5E5"> now if I want</font><font color="#CCCCCC"> to evade the</font>

143
00:06:48,250 --> 00:06:52,409
sandbox<font color="#CCCCCC"> most used techniques</font>

144
00:06:52,460 --> 00:06:57,289
dividing<font color="#E5E5E5"> to maybe defeating the monitor</font>

145
00:06:54,770 --> 00:06:59,060
<font color="#CCCCCC">I mean if I have a sandbox solution and</font>

146
00:06:57,289 --> 00:07:01,909
I know it<font color="#CCCCCC"> and I</font><font color="#E5E5E5"> know how it</font><font color="#CCCCCC"> works I know</font>

147
00:06:59,060 --> 00:07:04,460
that it hooks<font color="#CCCCCC"> a and</font><font color="#E5E5E5"> B and C I can</font><font color="#CCCCCC"> either</font>

148
00:07:01,910 --> 00:07:06,919
remove<font color="#E5E5E5"> these hooks or I can go around</font>

149
00:07:04,460 --> 00:07:09,530
them<font color="#E5E5E5"> or I can delay execution using</font>

150
00:07:06,919 --> 00:07:12,490
sleep or<font color="#E5E5E5"> counting Fibonacci numbers</font>

151
00:07:09,530 --> 00:07:15,380
until<font color="#CCCCCC"> the</font><font color="#E5E5E5"> five thousand number whatever</font>

152
00:07:12,490 --> 00:07:17,840
so that's<font color="#E5E5E5"> one way and</font><font color="#CCCCCC"> another way is to</font>

153
00:07:15,380 --> 00:07:19,669
<font color="#E5E5E5">be context aware for example</font><font color="#CCCCCC"> the sandbox</font>

154
00:07:17,840 --> 00:07:22,039
is usually virtualized machine<font color="#CCCCCC"> an</font>

155
00:07:19,669 --> 00:07:25,430
automatic one so I can require code

156
00:07:22,039 --> 00:07:27,169
execution<font color="#E5E5E5"> there was a very cool sandbox</font>

157
00:07:25,430 --> 00:07:30,009
<font color="#E5E5E5">evasion technique that required that</font><font color="#CCCCCC"> you</font>

158
00:07:27,169 --> 00:07:32,299
<font color="#CCCCCC">have a text in a PowerPoint presentation</font>

159
00:07:30,009 --> 00:07:35,240
<font color="#E5E5E5">and as long as you didn't do it nothing</font>

160
00:07:32,300 --> 00:07:37,070
happened<font color="#E5E5E5"> and</font><font color="#CCCCCC"> same goes for check date</font>

161
00:07:35,240 --> 00:07:43,520
and time<font color="#E5E5E5"> to see that it makes</font><font color="#CCCCCC"> sense and</font>

162
00:07:37,070 --> 00:07:45,979
encrypted payloads<font color="#CCCCCC"> yeah</font><font color="#E5E5E5"> so all of these</font>

163
00:07:43,520 --> 00:07:47,150
<font color="#E5E5E5">techniques require code execution for</font>

164
00:07:45,979 --> 00:07:48,650
them to work so you<font color="#CCCCCC"> have</font><font color="#E5E5E5"> to get your</font>

165
00:07:47,150 --> 00:07:50,030
code running in<font color="#E5E5E5"> the machine</font>

166
00:07:48,650 --> 00:07:52,159
<font color="#CCCCCC">individualized environment in the</font>

167
00:07:50,030 --> 00:07:55,008
sandbox<font color="#CCCCCC"> in order</font><font color="#E5E5E5"> for you</font><font color="#CCCCCC"> to collect</font><font color="#E5E5E5"> the</font>

168
00:07:52,159 --> 00:07:58,190
information and then decide if<font color="#E5E5E5"> it's</font>

169
00:07:55,009 --> 00:08:00,770
<font color="#CCCCCC">indeed</font><font color="#E5E5E5"> sandbox or not so there</font><font color="#CCCCCC"> are two</font>

170
00:07:58,190 --> 00:08:03,620
<font color="#E5E5E5">takes from that if you did not obfuscate</font>

171
00:08:00,770 --> 00:08:05,448
<font color="#CCCCCC">your code</font><font color="#E5E5E5"> if it's just plain code then</font>

172
00:08:03,620 --> 00:08:08,120
static<font color="#E5E5E5"> analysis tool can analyze your</font>

173
00:08:05,449 --> 00:08:10,849
code and<font color="#E5E5E5"> then decide</font><font color="#CCCCCC"> okay whether this</font>

174
00:08:08,120 --> 00:08:12,740
is suspicious<font color="#CCCCCC"> coda trying to detect the</font>

175
00:08:10,849 --> 00:08:16,009
machine or not and then flag it

176
00:08:12,740 --> 00:08:18,680
accordingly<font color="#E5E5E5"> and if you did appreciate</font>

177
00:08:16,009 --> 00:08:21,169
<font color="#CCCCCC">your code eventually it will</font><font color="#E5E5E5"> be</font><font color="#CCCCCC"> executed</font>

178
00:08:18,680 --> 00:08:22,759
<font color="#E5E5E5">in the sandbox</font><font color="#CCCCCC"> which are now aware of</font>

179
00:08:21,169 --> 00:08:24,979
these techniques<font color="#E5E5E5"> the trying to bypass</font>

180
00:08:22,759 --> 00:08:26,840
<font color="#E5E5E5">the sandbox and the sandbox will block</font>

181
00:08:24,979 --> 00:08:29,090
it<font color="#E5E5E5"> flag it as</font><font color="#CCCCCC"> suspicious as trying</font><font color="#E5E5E5"> to</font>

182
00:08:26,840 --> 00:08:32,049
evade the sandbox<font color="#E5E5E5"> so we have a</font>

183
00:08:29,090 --> 00:08:34,640
never-ending process<font color="#E5E5E5"> so sandbox is began</font>

184
00:08:32,049 --> 00:08:37,880
<font color="#E5E5E5">blocking malware who detects and</font><font color="#CCCCCC"> boxers</font>

185
00:08:34,640 --> 00:08:39,500
<font color="#E5E5E5">and now it keeps on</font><font color="#CCCCCC"> going and as I said</font>

186
00:08:37,880 --> 00:08:41,958
<font color="#E5E5E5">we're going to</font><font color="#CCCCCC"> use a technique that</font>

187
00:08:39,500 --> 00:08:45,380
<font color="#E5E5E5">doesn't reveal to the sandbox that we</font>

188
00:08:41,958 --> 00:08:48,739
are trying to<font color="#CCCCCC"> identify it and in order</font>

189
00:08:45,380 --> 00:08:52,070
<font color="#CCCCCC">to</font><font color="#E5E5E5"> do so we will be discussing VBA</font>

190
00:08:48,740 --> 00:08:55,640
referencing so VBA<font color="#CCCCCC"> is</font><font color="#E5E5E5"> a set Visual Basic</font>

191
00:08:52,070 --> 00:08:57,770
for application<font color="#E5E5E5"> it's a very old</font><font color="#CCCCCC"> concept</font>

192
00:08:55,640 --> 00:09:01,189
of Microsoft it was written a<font color="#CCCCCC"> long time</font>

193
00:08:57,770 --> 00:09:03,650
<font color="#CCCCCC">ago and let's</font><font color="#E5E5E5"> just say that security was</font>

194
00:09:01,190 --> 00:09:07,570
not the main issue<font color="#E5E5E5"> when this feature was</font>

195
00:09:03,650 --> 00:09:07,569
developed<font color="#E5E5E5"> we're gonna see in a second</font>

196
00:09:08,830 --> 00:09:15,710
so in order to<font color="#CCCCCC"> truly understand what VBA</font>

197
00:09:12,370 --> 00:09:19,850
macros are capable of<font color="#E5E5E5"> you have to look</font>

198
00:09:15,710 --> 00:09:22,150
in the<font color="#CCCCCC"> MSO vba document issued by</font>

199
00:09:19,850 --> 00:09:25,070
<font color="#CCCCCC">Microsoft it's the documentation</font><font color="#E5E5E5"> for the</font>

200
00:09:22,150 --> 00:09:28,100
<font color="#E5E5E5">office</font><font color="#CCCCCC"> VBL file format it's a binary</font>

201
00:09:25,070 --> 00:09:31,160
file that hosts<font color="#E5E5E5"> all of the capabilities</font>

202
00:09:28,100 --> 00:09:35,090
of VBA projects and for example<font color="#CCCCCC"> if we</font>

203
00:09:31,160 --> 00:09:36,949
<font color="#E5E5E5">talk about office products and world and</font>

204
00:09:35,090 --> 00:09:38,780
Excel and<font color="#E5E5E5"> PowerPoint</font><font color="#CCCCCC"> they have the</font>

205
00:09:36,950 --> 00:09:41,360
<font color="#E5E5E5">capability of hosting</font><font color="#CCCCCC"> embedding these</font>

206
00:09:38,780 --> 00:09:43,790
files within<font color="#E5E5E5"> usually they called and</font>

207
00:09:41,360 --> 00:09:45,650
they<font color="#CCCCCC"> are called vbi project bin and this</font>

208
00:09:43,790 --> 00:09:48,370
is the relevant file that hosts<font color="#E5E5E5"> all the</font>

209
00:09:45,650 --> 00:09:55,459
malware<font color="#E5E5E5"> all the macros</font><font color="#CCCCCC"> I'm sorry and the</font>

210
00:09:48,370 --> 00:09:57,770
VBA capabilities and the malaria<font color="#E5E5E5"> so we</font>

211
00:09:55,460 --> 00:09:59,510
went<font color="#E5E5E5"> digging in this document and we</font>

212
00:09:57,770 --> 00:10:03,110
actually<font color="#CCCCCC"> weren't</font><font color="#E5E5E5"> the first</font><font color="#CCCCCC"> one</font><font color="#E5E5E5"> to dig in</font>

213
00:09:59,510 --> 00:10:06,130
DMSO<font color="#E5E5E5"> VBA documentation</font><font color="#CCCCCC"> a few</font><font color="#E5E5E5"> years</font><font color="#CCCCCC"> ago</font>

214
00:10:03,110 --> 00:10:08,570
<font color="#E5E5E5">mr.</font><font color="#CCCCCC"> Haly in his presentation the</font>

215
00:10:06,130 --> 00:10:10,420
analysis of a text surface of Microsoft

216
00:10:08,570 --> 00:10:18,010
Office from<font color="#E5E5E5"> a user perspective</font>

217
00:10:10,420 --> 00:10:20,630
<font color="#CCCCCC">he showed</font><font color="#E5E5E5"> that a feature of the VBA</font><font color="#CCCCCC"> file</font>

218
00:10:18,010 --> 00:10:23,500
so there<font color="#E5E5E5"> is a feature that enables you</font>

219
00:10:20,630 --> 00:10:26,990
to load<font color="#E5E5E5"> remote automation type library</font>

220
00:10:23,500 --> 00:10:30,260
<font color="#E5E5E5">and actually fetch it load it</font><font color="#CCCCCC"> and</font>

221
00:10:26,990 --> 00:10:31,910
<font color="#E5E5E5">execute it and he was</font><font color="#CCCCCC"> able in</font><font color="#E5E5E5"> here by</font>

222
00:10:30,260 --> 00:10:33,770
<font color="#E5E5E5">the way you can see this is the exact</font>

223
00:10:31,910 --> 00:10:36,500
this is the<font color="#E5E5E5"> image from his presentation</font>

224
00:10:33,770 --> 00:10:38,600
and this is the field<font color="#CCCCCC"> where</font><font color="#E5E5E5"> you can</font>

225
00:10:36,500 --> 00:10:41,600
specify the path to the automation type

226
00:10:38,600 --> 00:10:44,870
library<font color="#CCCCCC"> and which will</font><font color="#E5E5E5"> be loaded and</font>

227
00:10:41,600 --> 00:10:47,150
actually he tells the<font color="#E5E5E5"> story how this</font>

228
00:10:44,870 --> 00:10:49,040
vulnerability<font color="#E5E5E5"> was discovered in 2008 I</font>

229
00:10:47,150 --> 00:10:52,550
think<font color="#E5E5E5"> and Microsoft did in mind and</font>

230
00:10:49,040 --> 00:10:56,360
eventually he<font color="#CCCCCC"> was able to show</font><font color="#E5E5E5"> that you</font>

231
00:10:52,550 --> 00:10:58,130
can<font color="#CCCCCC"> actually hijack</font><font color="#E5E5E5"> the</font><font color="#CCCCCC"> program flow</font><font color="#E5E5E5"> and</font>

232
00:10:56,360 --> 00:10:59,690
actually achieve<font color="#CCCCCC"> code execution</font><font color="#E5E5E5"> and</font>

233
00:10:58,130 --> 00:11:01,820
<font color="#E5E5E5">eventually this was fixed</font>

234
00:10:59,690 --> 00:11:03,980
Microsoft patched this and it's no

235
00:11:01,820 --> 00:11:05,720
longer<font color="#E5E5E5"> available but we did something</font>

236
00:11:03,980 --> 00:11:09,350
<font color="#E5E5E5">similar</font><font color="#CCCCCC"> we</font><font color="#E5E5E5"> went to the</font><font color="#CCCCCC"> document and</font>

237
00:11:05,720 --> 00:11:13,610
<font color="#E5E5E5">we've read it and it's a 111 pages it's</font>

238
00:11:09,350 --> 00:11:17,770
not that nice and<font color="#CCCCCC"> we actually</font><font color="#E5E5E5"> found</font>

239
00:11:13,610 --> 00:11:19,470
something<font color="#E5E5E5"> else and what we found was</font>

240
00:11:17,770 --> 00:11:23,220
another<font color="#E5E5E5"> section</font>

241
00:11:19,470 --> 00:11:26,220
<font color="#E5E5E5">that's called project references and it</font>

242
00:11:23,220 --> 00:11:28,860
allows you<font color="#CCCCCC"> to simply fetch remote</font><font color="#E5E5E5"> VBA</font>

243
00:11:26,220 --> 00:11:30,270
project and use<font color="#E5E5E5"> it as your own use that</font>

244
00:11:28,860 --> 00:11:31,980
code as yellow<font color="#E5E5E5"> and simply a reference</font>

245
00:11:30,270 --> 00:11:33,960
<font color="#CCCCCC">you know just</font><font color="#E5E5E5"> like any other programming</font>

246
00:11:31,980 --> 00:11:36,690
<font color="#E5E5E5">language I'm guessing that was</font><font color="#CCCCCC"> the point</font>

247
00:11:33,960 --> 00:11:41,730
of<font color="#E5E5E5"> this feature and you can point to</font>

248
00:11:36,690 --> 00:11:44,820
<font color="#E5E5E5">several VBA projects as well and use all</font>

249
00:11:41,730 --> 00:11:46,800
of<font color="#E5E5E5"> their codes as</font><font color="#CCCCCC"> well so this is</font><font color="#E5E5E5"> what</font>

250
00:11:44,820 --> 00:11:48,630
it looks<font color="#E5E5E5"> like this is</font><font color="#CCCCCC"> just</font><font color="#E5E5E5"> the title</font>

251
00:11:46,800 --> 00:11:52,349
<font color="#E5E5E5">from this is just the content from the</font>

252
00:11:48,630 --> 00:11:54,000
documentation<font color="#CCCCCC"> and if we zoom in on this</font>

253
00:11:52,350 --> 00:11:55,890
this<font color="#E5E5E5"> is from the examples of the</font>

254
00:11:54,000 --> 00:11:58,110
documentation<font color="#CCCCCC"> if we zoom in on</font><font color="#E5E5E5"> this you</font>

255
00:11:55,890 --> 00:11:59,670
<font color="#E5E5E5">can see the offset and</font><font color="#CCCCCC"> the bite size and</font>

256
00:11:58,110 --> 00:12:03,540
what it says but basically what we've

257
00:11:59,670 --> 00:12:05,910
noticed<font color="#E5E5E5"> is this we saw a path and</font><font color="#CCCCCC"> we</font>

258
00:12:03,540 --> 00:12:07,439
said<font color="#CCCCCC"> okay that's that's interesting</font>

259
00:12:05,910 --> 00:12:10,230
what's<font color="#E5E5E5"> this path what can I do with</font><font color="#CCCCCC"> it</font>

260
00:12:07,440 --> 00:12:12,660
and<font color="#CCCCCC"> apparently it</font><font color="#E5E5E5"> doesn't matter if it's</font>

261
00:12:10,230 --> 00:12:15,300
<font color="#E5E5E5">relative or an absolute path if it's a</font>

262
00:12:12,660 --> 00:12:18,209
<font color="#E5E5E5">local path or remote path as long as</font>

263
00:12:15,300 --> 00:12:20,130
it's available<font color="#CCCCCC"> office we'll fetch it</font>

264
00:12:18,210 --> 00:12:21,630
once the VBA engine loads it will fetch

265
00:12:20,130 --> 00:12:25,290
it and<font color="#CCCCCC"> it will include it in your code</font>

266
00:12:21,630 --> 00:12:26,730
then<font color="#CCCCCC"> you can use</font><font color="#E5E5E5"> it as your own</font><font color="#CCCCCC"> and we</font>

267
00:12:25,290 --> 00:12:29,520
thought that<font color="#E5E5E5"> this was quite interesting</font>

268
00:12:26,730 --> 00:12:33,210
<font color="#CCCCCC">and we've decided to explore explore</font><font color="#E5E5E5"> a</font>

269
00:12:29,520 --> 00:12:38,310
little<font color="#E5E5E5"> bit and this is what it looks</font>

270
00:12:33,210 --> 00:12:42,180
like<font color="#E5E5E5"> so because</font><font color="#CCCCCC"> it's VBA and office uses</font>

271
00:12:38,310 --> 00:12:44,339
VBA<font color="#CCCCCC"> on every day I guess and most users</font>

272
00:12:42,180 --> 00:12:45,689
<font color="#E5E5E5">use office in their daily</font><font color="#CCCCCC"> activities we</font>

273
00:12:44,340 --> 00:12:48,540
thought that office would<font color="#CCCCCC"> be a good</font>

274
00:12:45,690 --> 00:12:52,280
attack vector so<font color="#E5E5E5"> we start the testing</font>

275
00:12:48,540 --> 00:12:54,959
and we've tested<font color="#E5E5E5"> this across several</font>

276
00:12:52,280 --> 00:12:59,939
<font color="#E5E5E5">products so let's see how world behaves</font>

277
00:12:54,960 --> 00:13:02,040
when we get VBA referencing active so

278
00:12:59,940 --> 00:13:04,380
you<font color="#CCCCCC"> open the document and protected view</font>

279
00:13:02,040 --> 00:13:07,530
blocks this feature<font color="#E5E5E5"> but once you enable</font>

280
00:13:04,380 --> 00:13:09,660
<font color="#E5E5E5">it you get a</font><font color="#CCCCCC"> wield</font><font color="#E5E5E5"> message and protected</font>

281
00:13:07,530 --> 00:13:13,350
view enabled again<font color="#E5E5E5"> and then you block it</font>

282
00:13:09,660 --> 00:13:14,819
<font color="#E5E5E5">and you get Noel</font><font color="#CCCCCC"> oh but what I'm</font><font color="#E5E5E5"> trying</font>

283
00:13:13,350 --> 00:13:17,040
to<font color="#E5E5E5"> say is that this</font><font color="#CCCCCC"> is not predictable</font>

284
00:13:14,820 --> 00:13:19,980
<font color="#E5E5E5">behavior as an attacker I cannot rely on</font>

285
00:13:17,040 --> 00:13:21,930
world documents to be silent<font color="#E5E5E5"> when I'm</font>

286
00:13:19,980 --> 00:13:24,930
<font color="#E5E5E5">trying to use VBA referencing and</font>

287
00:13:21,930 --> 00:13:26,790
actually if we do this again<font color="#CCCCCC"> you</font><font color="#E5E5E5"> can get</font>

288
00:13:24,930 --> 00:13:28,859
<font color="#E5E5E5">another message this is a completely</font>

289
00:13:26,790 --> 00:13:32,280
<font color="#E5E5E5">different message from the one that I</font>

290
00:13:28,860 --> 00:13:32,750
got<font color="#CCCCCC"> before</font><font color="#E5E5E5"> so well not reliable I'm not</font>

291
00:13:32,280 --> 00:13:37,069
going to use

292
00:13:32,750 --> 00:13:40,070
that moving on<font color="#E5E5E5"> to PowerPoint it looks</font>

293
00:13:37,070 --> 00:13:42,770
fine it works fine<font color="#E5E5E5"> but it gives you this</font>

294
00:13:40,070 --> 00:13:45,050
message<font color="#E5E5E5"> to the user every time he opens</font>

295
00:13:42,770 --> 00:13:47,030
the document<font color="#E5E5E5"> and it's a security notice</font>

296
00:13:45,050 --> 00:13:48,949
it's<font color="#CCCCCC"> not the pool protected view yellow</font>

297
00:13:47,030 --> 00:13:51,069
bar<font color="#E5E5E5"> it's a big message and you simply</font>

298
00:13:48,950 --> 00:13:54,580
click disable macros and<font color="#E5E5E5"> you're done so</font>

299
00:13:51,070 --> 00:13:58,840
<font color="#E5E5E5">PowerPoint out of the equation as well</font>

300
00:13:54,580 --> 00:14:01,580
<font color="#E5E5E5">and</font><font color="#CCCCCC"> eventually we got</font><font color="#E5E5E5"> to</font><font color="#CCCCCC"> Excel</font><font color="#E5E5E5"> and Excel</font>

301
00:13:58,840 --> 00:14:03,800
<font color="#E5E5E5">it's just perfectly suitable for this</font>

302
00:14:01,580 --> 00:14:06,980
<font color="#CCCCCC">attacker gasps he opened the document</font>

303
00:14:03,800 --> 00:14:10,819
you enable content<font color="#CCCCCC"> and you get code</font>

304
00:14:06,980 --> 00:14:12,680
execution<font color="#E5E5E5"> and this code was the message</font>

305
00:14:10,820 --> 00:14:15,950
box in<font color="#CCCCCC"> VBA and I'm guessing some of</font><font color="#E5E5E5"> you</font>

306
00:14:12,680 --> 00:14:19,040
know<font color="#E5E5E5"> what's the syntax</font><font color="#CCCCCC"> of message box in</font>

307
00:14:15,950 --> 00:14:22,040
VBA<font color="#CCCCCC"> and</font><font color="#E5E5E5"> in this document</font><font color="#CCCCCC"> this is the</font>

308
00:14:19,040 --> 00:14:25,400
code<font color="#E5E5E5"> so no message box HelloWorld</font>

309
00:14:22,040 --> 00:14:27,079
anything it simply says call<font color="#E5E5E5"> call me</font>

310
00:14:25,400 --> 00:14:28,790
function<font color="#CCCCCC"> and this function is not</font>

311
00:14:27,080 --> 00:14:33,230
available<font color="#CCCCCC"> in</font><font color="#E5E5E5"> this project it's actually</font>

312
00:14:28,790 --> 00:14:34,880
in this project<font color="#E5E5E5"> and the</font><font color="#CCCCCC"> funny thing</font>

313
00:14:33,230 --> 00:14:36,410
about<font color="#E5E5E5"> Microsoft products is because</font>

314
00:14:34,880 --> 00:14:37,970
there are<font color="#CCCCCC"> so</font><font color="#E5E5E5"> many divisions and teams</font>

315
00:14:36,410 --> 00:14:39,860
and they have the world division and

316
00:14:37,970 --> 00:14:42,230
<font color="#CCCCCC">PowerPoint</font><font color="#E5E5E5"> division is that we have</font>

317
00:14:39,860 --> 00:14:44,990
similar<font color="#E5E5E5"> products that behave differently</font>

318
00:14:42,230 --> 00:14:49,640
<font color="#E5E5E5">so world in PowerPoint not going to do</font>

319
00:14:44,990 --> 00:14:51,589
<font color="#E5E5E5">it but Excel will be doing it so what</font>

320
00:14:49,640 --> 00:14:53,449
we've learned<font color="#E5E5E5"> so far is that we can use</font>

321
00:14:51,589 --> 00:14:55,400
VBA referencing and Excel is probably

322
00:14:53,450 --> 00:14:59,900
the most<font color="#E5E5E5"> likely candidate</font><font color="#CCCCCC"> for us to use</font>

323
00:14:55,400 --> 00:15:01,189
as bad guys<font color="#E5E5E5"> and that most sandbox</font>

324
00:14:59,900 --> 00:15:03,980
evasion techniques rely on code

325
00:15:01,190 --> 00:15:07,400
execution which is nice but<font color="#E5E5E5"> we wanna</font>

326
00:15:03,980 --> 00:15:11,990
take it a step<font color="#CCCCCC"> further</font><font color="#E5E5E5"> so</font><font color="#CCCCCC"> let's make</font>

327
00:15:07,400 --> 00:15:14,870
<font color="#E5E5E5">something out of it now that</font><font color="#CCCCCC"> we</font><font color="#E5E5E5"> know</font>

328
00:15:11,990 --> 00:15:17,870
that<font color="#CCCCCC"> vbi projects can fetch from another</font>

329
00:15:14,870 --> 00:15:21,650
<font color="#E5E5E5">VBA project we can use it right we can</font>

330
00:15:17,870 --> 00:15:23,330
craft a document that<font color="#CCCCCC"> has</font><font color="#E5E5E5"> benign code</font>

331
00:15:21,650 --> 00:15:26,380
for<font color="#E5E5E5"> example call call me that does</font>

332
00:15:23,330 --> 00:15:29,210
<font color="#CCCCCC">nothing and</font><font color="#E5E5E5"> it tries to fetch another</font>

333
00:15:26,380 --> 00:15:31,640
<font color="#E5E5E5">VBA project and once this VBA project</font>

334
00:15:29,210 --> 00:15:34,310
has been<font color="#E5E5E5"> fetched it will execute the</font>

335
00:15:31,640 --> 00:15:36,740
code<font color="#E5E5E5"> so my document will pass static</font>

336
00:15:34,310 --> 00:15:38,920
analysis<font color="#CCCCCC"> to trying</font><font color="#E5E5E5"> to detect my VBA code</font>

337
00:15:36,740 --> 00:15:41,900
<font color="#E5E5E5">because it has nothing it has called a</font>

338
00:15:38,920 --> 00:15:44,349
function<font color="#CCCCCC"> that doesn't</font><font color="#E5E5E5"> exist but</font>

339
00:15:41,900 --> 00:15:46,550
eventually once this code gets<font color="#CCCCCC"> executed</font>

340
00:15:44,350 --> 00:15:48,530
<font color="#E5E5E5">the sandbox will block</font><font color="#CCCCCC"> it</font>

341
00:15:46,550 --> 00:15:50,479
so I'm still halfway<font color="#E5E5E5"> there</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> we</font>

342
00:15:48,530 --> 00:15:55,010
thought that<font color="#E5E5E5"> it would</font><font color="#CCCCCC"> be even cooler if</font>

343
00:15:50,480 --> 00:15:57,950
I can decide as an attacker<font color="#CCCCCC"> and</font><font color="#E5E5E5"> if I can</font>

344
00:15:55,010 --> 00:16:01,220
<font color="#E5E5E5">detect who is asking and if it's</font><font color="#CCCCCC"> sandbox</font>

345
00:15:57,950 --> 00:16:02,930
asking me for<font color="#E5E5E5"> my remote</font><font color="#CCCCCC"> VBA code I will</font>

346
00:16:01,220 --> 00:16:06,110
answer in one way<font color="#E5E5E5"> and if it's a user</font>

347
00:16:02,930 --> 00:16:09,800
asking I will<font color="#CCCCCC"> answer in another way if I</font>

348
00:16:06,110 --> 00:16:12,290
can<font color="#CCCCCC"> detect them reliably so how can</font><font color="#E5E5E5"> we</font>

349
00:16:09,800 --> 00:16:14,870
do it<font color="#CCCCCC"> without code execution and before</font>

350
00:16:12,290 --> 00:16:16,670
we<font color="#E5E5E5"> talk</font><font color="#CCCCCC"> about</font><font color="#E5E5E5"> that just the final note</font>

351
00:16:14,870 --> 00:16:21,860
<font color="#CCCCCC">on sandbox as I said we're not</font><font color="#E5E5E5"> going to</font>

352
00:16:16,670 --> 00:16:24,319
go into<font color="#CCCCCC"> it but sandbox says are heavily</font>

353
00:16:21,860 --> 00:16:25,820
deployed as I said and their purpose is

354
00:16:24,320 --> 00:16:28,580
quite simple<font color="#E5E5E5"> they take each incoming</font>

355
00:16:25,820 --> 00:16:30,770
<font color="#E5E5E5">file according</font><font color="#CCCCCC"> to</font><font color="#E5E5E5"> some policy and they</font>

356
00:16:28,580 --> 00:16:33,710
let<font color="#CCCCCC"> it execute in their safe and</font>

357
00:16:30,770 --> 00:16:36,350
virtualized environment and because each

358
00:16:33,710 --> 00:16:39,400
file is inspected<font color="#E5E5E5"> you have to give it a</font>

359
00:16:36,350 --> 00:16:42,020
certain<font color="#E5E5E5"> time limit</font><font color="#CCCCCC"> you</font><font color="#E5E5E5"> have to make some</font>

360
00:16:39,400 --> 00:16:43,490
adjustments in order<font color="#E5E5E5"> for the sandbox not</font>

361
00:16:42,020 --> 00:16:46,430
to<font color="#CCCCCC"> become a bottleneck and not to clog</font>

362
00:16:43,490 --> 00:16:49,010
your<font color="#E5E5E5"> traffic so first of all it has</font><font color="#CCCCCC"> to</font>

363
00:16:46,430 --> 00:16:51,199
be<font color="#CCCCCC"> automatic</font><font color="#E5E5E5"> I mean no user interaction</font>

364
00:16:49,010 --> 00:16:54,170
<font color="#E5E5E5">required no nothing if the user got</font><font color="#CCCCCC"> the</font>

365
00:16:51,200 --> 00:16:55,850
file at the end<font color="#CCCCCC"> of the day then that</font>

366
00:16:54,170 --> 00:16:57,829
<font color="#E5E5E5">file has passed the sandbox and it's</font>

367
00:16:55,850 --> 00:17:00,290
safe and<font color="#CCCCCC"> you can</font><font color="#E5E5E5"> open</font><font color="#CCCCCC"> it and</font><font color="#E5E5E5"> no problem</font>

368
00:16:57,830 --> 00:17:03,740
<font color="#E5E5E5">and second of all it has</font><font color="#CCCCCC"> to be fast I</font>

369
00:17:00,290 --> 00:17:05,780
mean<font color="#E5E5E5"> if you have thousands of file or</font>

370
00:17:03,740 --> 00:17:08,060
files<font color="#E5E5E5"> each day entering your</font>

371
00:17:05,780 --> 00:17:10,129
<font color="#E5E5E5">organization each files takes five</font><font color="#CCCCCC"> or</font>

372
00:17:08,060 --> 00:17:11,569
<font color="#E5E5E5">ten minutes to execute</font><font color="#CCCCCC"> you're going to</font>

373
00:17:10,130 --> 00:17:13,300
clog<font color="#CCCCCC"> your network so you have to set a</font>

374
00:17:11,569 --> 00:17:15,169
time limit<font color="#E5E5E5"> and you have to have</font>

375
00:17:13,300 --> 00:17:18,500
optimizations at the virtualization

376
00:17:15,170 --> 00:17:20,360
level and so forth<font color="#E5E5E5"> and the final point</font>

377
00:17:18,500 --> 00:17:23,450
<font color="#CCCCCC">which is I think the</font><font color="#E5E5E5"> most important one</font>

378
00:17:20,359 --> 00:17:26,510
is<font color="#CCCCCC"> the secure</font><font color="#E5E5E5"> list feature it kind of</font>

379
00:17:23,450 --> 00:17:28,730
supports the two<font color="#E5E5E5"> features above in the</font>

380
00:17:26,510 --> 00:17:31,160
sense that it's a sandbox<font color="#CCCCCC"> environment</font>

381
00:17:28,730 --> 00:17:33,890
<font color="#CCCCCC">it's virtualized</font><font color="#E5E5E5"> in</font><font color="#CCCCCC"> it's in a</font><font color="#E5E5E5"> different</font>

382
00:17:31,160 --> 00:17:35,780
segment of the network if anything

383
00:17:33,890 --> 00:17:38,630
happens to the sandbox nothing will

384
00:17:35,780 --> 00:17:41,810
happen<font color="#E5E5E5"> so the general concept of the</font>

385
00:17:38,630 --> 00:17:44,690
<font color="#E5E5E5">sandbox is to let the malware</font><font color="#CCCCCC"> execute as</font>

386
00:17:41,810 --> 00:17:47,030
freely<font color="#CCCCCC"> as possible in order</font><font color="#E5E5E5"> for it to</font>

387
00:17:44,690 --> 00:17:51,710
see what<font color="#E5E5E5"> the malware does and then make</font>

388
00:17:47,030 --> 00:17:53,750
the best decision it can make so you

389
00:17:51,710 --> 00:17:55,910
drop all security mitigations Windows

390
00:17:53,750 --> 00:17:57,740
Defender<font color="#E5E5E5"> Windows Firewall in case of</font>

391
00:17:55,910 --> 00:17:59,870
<font color="#E5E5E5">office you drop the protected view in</font>

392
00:17:57,740 --> 00:18:02,750
order<font color="#CCCCCC"> to make things faster so you</font>

393
00:17:59,870 --> 00:18:06,739
have to disable<font color="#E5E5E5"> them manually or by code</font>

394
00:18:02,750 --> 00:18:09,130
that will cost you some time<font color="#E5E5E5"> and you can</font>

395
00:18:06,740 --> 00:18:13,400
<font color="#CCCCCC">actually see what the Maru is</font><font color="#E5E5E5"> doing</font>

396
00:18:09,130 --> 00:18:15,860
completely so building<font color="#E5E5E5"> on these points</font>

397
00:18:13,400 --> 00:18:18,020
<font color="#CCCCCC">let's look</font><font color="#E5E5E5"> at the difference between</font><font color="#CCCCCC"> a</font>

398
00:18:15,860 --> 00:18:20,139
sandbox<font color="#E5E5E5"> and a user so when a user opens</font>

399
00:18:18,020 --> 00:18:23,360
<font color="#E5E5E5">the document of his document for example</font>

400
00:18:20,140 --> 00:18:25,730
<font color="#CCCCCC">usually they have</font><font color="#E5E5E5"> protected</font><font color="#CCCCCC"> view enabled</font>

401
00:18:23,360 --> 00:18:32,840
<font color="#E5E5E5">as a group policy</font><font color="#CCCCCC"> in the</font><font color="#E5E5E5"> organization or</font>

402
00:18:25,730 --> 00:18:34,880
other other policies so the user opens

403
00:18:32,840 --> 00:18:37,070
<font color="#E5E5E5">the document</font><font color="#CCCCCC"> and it has to disable</font>

404
00:18:34,880 --> 00:18:40,400
protected view in order<font color="#CCCCCC"> to load</font><font color="#E5E5E5"> the VBA</font>

405
00:18:37,070 --> 00:18:41,870
engine once the VBA<font color="#E5E5E5"> engine has</font><font color="#CCCCCC"> know</font><font color="#E5E5E5"> that</font>

406
00:18:40,400 --> 00:18:43,790
<font color="#E5E5E5">VBA referencing the course eventually</font>

407
00:18:41,870 --> 00:18:46,659
<font color="#E5E5E5">and most users click through the</font>

408
00:18:43,790 --> 00:18:49,309
protected view without<font color="#E5E5E5"> thinking about</font><font color="#CCCCCC"> it</font>

409
00:18:46,660 --> 00:18:52,070
<font color="#CCCCCC">regardless of social engineering attacks</font>

410
00:18:49,309 --> 00:18:54,260
most users<font color="#E5E5E5"> just click it anyway so this</font>

411
00:18:52,070 --> 00:18:57,020
<font color="#CCCCCC">is a user and if we look at the sandbox</font>

412
00:18:54,260 --> 00:18:59,120
<font color="#E5E5E5">having being automatic and fast and</font>

413
00:18:57,020 --> 00:19:02,780
<font color="#CCCCCC">secure less we</font><font color="#E5E5E5"> have protected view</font>

414
00:18:59,120 --> 00:19:04,250
disabled and once it's disabled the

415
00:19:02,780 --> 00:19:06,590
<font color="#CCCCCC">order is</font><font color="#E5E5E5"> different</font><font color="#CCCCCC"> so you</font><font color="#E5E5E5"> open the</font>

416
00:19:04,250 --> 00:19:08,809
document<font color="#E5E5E5"> that's the same no protected</font>

417
00:19:06,590 --> 00:19:11,689
view so once you open<font color="#E5E5E5"> the document the</font>

418
00:19:08,809 --> 00:19:14,928
VBA<font color="#E5E5E5"> engine loads immediately causing the</font>

419
00:19:11,690 --> 00:19:16,910
VBA reference to happen at the<font color="#E5E5E5"> same step</font>

420
00:19:14,929 --> 00:19:19,040
but<font color="#E5E5E5"> you didn't have protected view</font>

421
00:19:16,910 --> 00:19:20,480
enabled so we can actually<font color="#E5E5E5"> spot the</font>

422
00:19:19,040 --> 00:19:25,070
difference between<font color="#CCCCCC"> the sandbox in a user</font>

423
00:19:20,480 --> 00:19:26,540
<font color="#E5E5E5">and we're</font><font color="#CCCCCC"> gonna rely on it and I just</font>

424
00:19:25,070 --> 00:19:29,510
<font color="#CCCCCC">want</font><font color="#E5E5E5"> to make a few points about</font>

425
00:19:26,540 --> 00:19:33,710
protected view most people think<font color="#E5E5E5"> that</font>

426
00:19:29,510 --> 00:19:37,750
<font color="#E5E5E5">it's aimed to block malware again macros</font>

427
00:19:33,710 --> 00:19:41,240
sorry<font color="#E5E5E5"> and it does it actually blocks the</font>

428
00:19:37,750 --> 00:19:43,309
<font color="#E5E5E5">VBA engine completely until you allow it</font>

429
00:19:41,240 --> 00:19:45,530
<font color="#E5E5E5">but it's not just for macros and it's</font>

430
00:19:43,309 --> 00:19:48,379
not just<font color="#CCCCCC"> for the VBA engine</font><font color="#E5E5E5"> it actually</font>

431
00:19:45,530 --> 00:19:52,220
has a lot<font color="#CCCCCC"> of capabilities and</font><font color="#E5E5E5"> it blocks</font>

432
00:19:48,380 --> 00:19:54,110
other other<font color="#E5E5E5"> elements in the document</font><font color="#CCCCCC"> as</font>

433
00:19:52,220 --> 00:19:58,550
well<font color="#E5E5E5"> and I'm gonna show you this is from</font>

434
00:19:54,110 --> 00:20:00,780
<font color="#E5E5E5">the documentation and this is</font>

435
00:19:58,550 --> 00:20:02,610
one of the<font color="#E5E5E5"> sites discussing why</font>

436
00:20:00,780 --> 00:20:06,480
protected view is blocking images for

437
00:20:02,610 --> 00:20:08,070
the user and let's<font color="#CCCCCC"> enlarge that</font><font color="#E5E5E5"> they're</font>

438
00:20:06,480 --> 00:20:10,530
talking<font color="#CCCCCC"> about</font><font color="#E5E5E5"> images if you</font><font color="#CCCCCC"> have an</font>

439
00:20:08,070 --> 00:20:13,320
embedded<font color="#E5E5E5"> image in a document that you've</font>

440
00:20:10,530 --> 00:20:15,030
<font color="#CCCCCC">received</font><font color="#E5E5E5"> and it's a linked image once</font>

441
00:20:13,320 --> 00:20:16,980
you<font color="#E5E5E5"> open the document that image is</font>

442
00:20:15,030 --> 00:20:18,629
<font color="#E5E5E5">being fetched and that can sign the</font>

443
00:20:16,980 --> 00:20:21,510
attacker signal the attacker that<font color="#CCCCCC"> you</font>

444
00:20:18,630 --> 00:20:22,920
<font color="#E5E5E5">opened the document and it can send all</font>

445
00:20:21,510 --> 00:20:25,230
sorts of<font color="#CCCCCC"> information to that remote</font>

446
00:20:22,920 --> 00:20:27,630
server<font color="#CCCCCC"> so this is what</font><font color="#E5E5E5"> I protected you</font>

447
00:20:25,230 --> 00:20:30,030
blocks<font color="#E5E5E5"> all of these it images images in</font>

448
00:20:27,630 --> 00:20:36,540
Outlook the<font color="#E5E5E5"> linked media and the data</font>

449
00:20:30,030 --> 00:20:38,550
connections<font color="#E5E5E5"> and so if as a user I</font><font color="#CCCCCC"> have</font>

450
00:20:36,540 --> 00:20:40,170
protected<font color="#E5E5E5"> view enabled in order to truly</font>

451
00:20:38,550 --> 00:20:43,440
protect<font color="#E5E5E5"> me it's actually</font><font color="#CCCCCC"> using a</font>

452
00:20:40,170 --> 00:20:46,410
<font color="#CCCCCC">two-step confirmation scheme let's call</font>

453
00:20:43,440 --> 00:20:49,170
it so<font color="#E5E5E5"> I open the document as a user and</font>

454
00:20:46,410 --> 00:20:51,809
first<font color="#CCCCCC"> office protected view allows me to</font>

455
00:20:49,170 --> 00:20:54,750
enable all<font color="#CCCCCC"> of the suspicious</font><font color="#E5E5E5"> internet</font>

456
00:20:51,809 --> 00:20:57,500
files but<font color="#CCCCCC"> there are less</font><font color="#E5E5E5"> dangerous to</font><font color="#CCCCCC"> me</font>

457
00:20:54,750 --> 00:21:00,809
than active content this<font color="#CCCCCC"> is</font><font color="#E5E5E5"> the first</font>

458
00:20:57,500 --> 00:21:03,210
prompt that<font color="#E5E5E5"> you'll get files from the</font>

459
00:21:00,809 --> 00:21:05,309
<font color="#CCCCCC">Internet</font><font color="#E5E5E5"> can contain viruses do you want</font>

460
00:21:03,210 --> 00:21:07,770
to have them<font color="#E5E5E5"> do you want to</font><font color="#CCCCCC"> enable them</font>

461
00:21:05,309 --> 00:21:10,110
and<font color="#E5E5E5"> this will load the non-executable</font>

462
00:21:07,770 --> 00:21:14,040
<font color="#CCCCCC">objects the</font><font color="#E5E5E5"> images what we saw the</font>

463
00:21:10,110 --> 00:21:15,959
linked linked media and data<font color="#E5E5E5"> connections</font>

464
00:21:14,040 --> 00:21:18,720
<font color="#E5E5E5">and so forth so</font><font color="#CCCCCC"> you click enable editing</font>

465
00:21:15,960 --> 00:21:20,760
<font color="#E5E5E5">and once you do the document loads all</font>

466
00:21:18,720 --> 00:21:23,580
<font color="#CCCCCC">of these elements</font><font color="#E5E5E5"> and then it asks you</font>

467
00:21:20,760 --> 00:21:25,530
do<font color="#CCCCCC"> you want to load the active content</font>

468
00:21:23,580 --> 00:21:28,530
<font color="#CCCCCC">in this case macros but it could be</font>

469
00:21:25,530 --> 00:21:32,340
<font color="#CCCCCC">activists and</font><font color="#E5E5E5"> so forth so as I said it's</font>

470
00:21:28,530 --> 00:21:34,200
a<font color="#E5E5E5"> two-step confirmation procedure</font>

471
00:21:32,340 --> 00:21:36,059
procedure<font color="#CCCCCC"> in order</font><font color="#E5E5E5"> to protect the user</font>

472
00:21:34,200 --> 00:21:38,760
<font color="#E5E5E5">first you load the suspicious stuff and</font>

473
00:21:36,059 --> 00:21:42,629
then you load the actually potentially

474
00:21:38,760 --> 00:21:46,530
<font color="#CCCCCC">dangerous elements so this</font><font color="#E5E5E5"> is the users</font>

475
00:21:42,630 --> 00:21:48,260
point of view and if we look at the

476
00:21:46,530 --> 00:21:51,840
sandbox point of view<font color="#E5E5E5"> it's actually</font>

477
00:21:48,260 --> 00:21:54,090
<font color="#CCCCCC">completely opposite</font><font color="#E5E5E5"> because we don't</font>

478
00:21:51,840 --> 00:21:55,709
have protected view enabled<font color="#CCCCCC"> once you</font>

479
00:21:54,090 --> 00:21:58,590
<font color="#E5E5E5">open the document it will immediately</font>

480
00:21:55,710 --> 00:22:00,179
load the VBA engine and you won't be

481
00:21:58,590 --> 00:22:01,678
seeing this<font color="#CCCCCC"> message because</font><font color="#E5E5E5"> protected</font>

482
00:22:00,179 --> 00:22:05,520
<font color="#E5E5E5">view is not enabled I'm just showing it</font>

483
00:22:01,679 --> 00:22:07,950
<font color="#E5E5E5">here so we can get the</font><font color="#CCCCCC"> order</font><font color="#E5E5E5"> right</font><font color="#CCCCCC"> so no</font>

484
00:22:05,520 --> 00:22:10,740
protected<font color="#E5E5E5"> view you open the document in</font>

485
00:22:07,950 --> 00:22:11,070
<font color="#CCCCCC">the environment in</font><font color="#E5E5E5"> the sandbox and the</font>

486
00:22:10,740 --> 00:22:14,130
<font color="#CCCCCC">dock</font>

487
00:22:11,070 --> 00:22:16,860
<font color="#CCCCCC">Lodz and VBA</font><font color="#E5E5E5"> engine loads immediately</font>

488
00:22:14,130 --> 00:22:18,779
causing VBA referencing<font color="#E5E5E5"> and once the</font>

489
00:22:16,860 --> 00:22:21,029
document<font color="#E5E5E5"> has loaded VBA referencing</font>

490
00:22:18,779 --> 00:22:23,370
finished and everything<font color="#E5E5E5"> then it will</font>

491
00:22:21,029 --> 00:22:26,759
load<font color="#CCCCCC"> the rest</font><font color="#E5E5E5"> of the content</font><font color="#CCCCCC"> the images</font>

492
00:22:23,370 --> 00:22:28,799
<font color="#E5E5E5">the text effectively this</font><font color="#CCCCCC"> is what we</font>

493
00:22:26,759 --> 00:22:30,539
would have<font color="#E5E5E5"> seen</font><font color="#CCCCCC"> if the sandbox would</font>

494
00:22:28,799 --> 00:22:32,100
have shown<font color="#E5E5E5"> this prompts so we can</font>

495
00:22:30,539 --> 00:22:34,408
actually see<font color="#E5E5E5"> that this is completely the</font>

496
00:22:32,100 --> 00:22:37,439
opposite<font color="#E5E5E5"> enable content</font><font color="#CCCCCC"> and enable</font>

497
00:22:34,409 --> 00:22:41,220
editing<font color="#CCCCCC"> in the sandbox and here we have</font>

498
00:22:37,440 --> 00:22:44,330
enable editing and enable content<font color="#E5E5E5"> and we</font>

499
00:22:41,220 --> 00:22:46,980
actually<font color="#CCCCCC"> planned</font><font color="#E5E5E5"> to use this difference</font>

500
00:22:44,330 --> 00:22:48,689
<font color="#E5E5E5">and for our advantage</font><font color="#CCCCCC"> and</font><font color="#E5E5E5"> we're going to</font>

501
00:22:46,980 --> 00:22:51,090
<font color="#E5E5E5">use some sort of tracking pixel as a</font>

502
00:22:48,690 --> 00:22:55,919
baseline<font color="#CCCCCC"> I'm going to get into into</font><font color="#E5E5E5"> into</font>

503
00:22:51,090 --> 00:22:59,279
it in a sec you're<font color="#CCCCCC"> going to see</font><font color="#E5E5E5"> so once</font>

504
00:22:55,919 --> 00:23:01,440
we've<font color="#CCCCCC"> built all this scheme</font><font color="#E5E5E5"> we can</font>

505
00:22:59,279 --> 00:23:06,029
actually<font color="#E5E5E5"> detect a sandbox</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> a user</font>

506
00:23:01,440 --> 00:23:07,799
<font color="#E5E5E5">quite efficiently so this is the</font>

507
00:23:06,029 --> 00:23:09,629
detection<font color="#E5E5E5"> part and this is what it looks</font>

508
00:23:07,799 --> 00:23:12,779
<font color="#E5E5E5">like when</font><font color="#CCCCCC"> the document</font><font color="#E5E5E5"> is being opened</font>

509
00:23:09,629 --> 00:23:18,110
<font color="#E5E5E5">in the sandbox</font><font color="#CCCCCC"> this is the flow we're</font>

510
00:23:12,779 --> 00:23:21,690
gonna get so document open<font color="#E5E5E5"> in a sandbox</font>

511
00:23:18,110 --> 00:23:23,610
<font color="#CCCCCC">this is the</font><font color="#E5E5E5"> document immediately</font><font color="#CCCCCC"> know</font>

512
00:23:21,690 --> 00:23:27,289
protected view so the VBA engine is

513
00:23:23,610 --> 00:23:30,299
loaded<font color="#E5E5E5"> causing VBA referencing to occur</font>

514
00:23:27,289 --> 00:23:32,610
<font color="#E5E5E5">fetching the VBA project from the</font>

515
00:23:30,299 --> 00:23:34,139
attackers machine this<font color="#CCCCCC"> finishes the</font>

516
00:23:32,610 --> 00:23:35,758
<font color="#E5E5E5">loading of</font><font color="#CCCCCC"> the document and</font><font color="#E5E5E5"> now the</font>

517
00:23:34,139 --> 00:23:37,889
document<font color="#E5E5E5"> continues with the other</font>

518
00:23:35,759 --> 00:23:39,240
<font color="#E5E5E5">elements in this case it's the image and</font>

519
00:23:37,889 --> 00:23:42,809
it loads the<font color="#E5E5E5"> image from the attackers</font>

520
00:23:39,240 --> 00:23:44,970
machine<font color="#E5E5E5"> this is nice and when a user is</font>

521
00:23:42,809 --> 00:23:47,460
opening the<font color="#CCCCCC"> document we have protected</font>

522
00:23:44,970 --> 00:23:51,000
view which is this<font color="#E5E5E5"> what's this lock</font>

523
00:23:47,460 --> 00:23:52,980
symbolizes and the user opens<font color="#E5E5E5"> the</font>

524
00:23:51,000 --> 00:23:54,690
document<font color="#CCCCCC"> and everything is blocked this</font>

525
00:23:52,980 --> 00:23:56,669
<font color="#E5E5E5">is protected view and it asks do you</font>

526
00:23:54,690 --> 00:23:59,519
want to load the suspicious<font color="#E5E5E5"> internet</font>

527
00:23:56,669 --> 00:24:01,710
files<font color="#E5E5E5"> first if you do please enable</font>

528
00:23:59,519 --> 00:24:03,960
<font color="#E5E5E5">editing if you don't I won't be loading</font>

529
00:24:01,710 --> 00:24:06,419
anything the document is blocked<font color="#E5E5E5"> and if</font>

530
00:24:03,960 --> 00:24:07,889
it only contains for example<font color="#CCCCCC"> a load a</font>

531
00:24:06,419 --> 00:24:11,129
linked image then you<font color="#E5E5E5"> won't be seeing</font>

532
00:24:07,889 --> 00:24:14,668
<font color="#E5E5E5">anything so the user click through</font><font color="#CCCCCC"> it</font>

533
00:24:11,129 --> 00:24:16,939
and<font color="#E5E5E5"> actually the</font><font color="#CCCCCC"> image is loaded and now</font>

534
00:24:14,669 --> 00:24:20,250
the user<font color="#E5E5E5"> gets the second protected view</font>

535
00:24:16,940 --> 00:24:23,289
warning<font color="#CCCCCC"> about active content do you</font><font color="#E5E5E5"> want</font>

536
00:24:20,250 --> 00:24:26,570
to enable<font color="#E5E5E5"> active content</font><font color="#CCCCCC"> and the user</font>

537
00:24:23,289 --> 00:24:28,759
quite naively clicks it loading the<font color="#E5E5E5"> VBA</font>

538
00:24:26,570 --> 00:24:31,218
engine<font color="#E5E5E5"> causing the VBA referencing and</font>

539
00:24:28,759 --> 00:24:32,899
fetching the code<font color="#E5E5E5"> so we can actually see</font>

540
00:24:31,219 --> 00:24:34,339
a<font color="#E5E5E5"> difference</font><font color="#CCCCCC"> between</font><font color="#E5E5E5"> a user and the</font>

541
00:24:32,899 --> 00:24:36,830
sandbox activity and this is our

542
00:24:34,339 --> 00:24:39,200
detection scheme I'm<font color="#E5E5E5"> going to show it on</font>

543
00:24:36,830 --> 00:24:42,978
<font color="#E5E5E5">the attacker side in a sec but note this</font>

544
00:24:39,200 --> 00:24:45,859
<font color="#E5E5E5">we have fallen the sandbox code requests</font>

545
00:24:42,979 --> 00:24:48,739
and then image requests and on the user

546
00:24:45,859 --> 00:24:51,349
side<font color="#CCCCCC"> we have image requests and then</font>

547
00:24:48,739 --> 00:24:54,559
code requests and I'm going<font color="#CCCCCC"> to build on</font>

548
00:24:51,349 --> 00:24:57,439
top<font color="#CCCCCC"> of</font><font color="#E5E5E5"> that so as an attacker</font><font color="#CCCCCC"> I am</font>

549
00:24:54,559 --> 00:24:59,690
hosting both the remote<font color="#E5E5E5"> VBA project and</font>

550
00:24:57,440 --> 00:25:02,479
both the image and the image as well<font color="#CCCCCC"> and</font>

551
00:24:59,690 --> 00:25:05,059
I've created a document<font color="#CCCCCC"> that contains</font>

552
00:25:02,479 --> 00:25:07,629
<font color="#E5E5E5">this two elements and tries</font><font color="#CCCCCC"> to load them</font>

553
00:25:05,059 --> 00:25:11,599
and<font color="#CCCCCC"> now I'm sitting</font><font color="#E5E5E5"> on the attacker side</font>

554
00:25:07,629 --> 00:25:13,279
intercepting the requests and<font color="#CCCCCC"> I'm trying</font>

555
00:25:11,599 --> 00:25:15,589
to<font color="#E5E5E5"> decide</font><font color="#CCCCCC"> whether it's a sandbox</font><font color="#E5E5E5"> or a</font>

556
00:25:13,279 --> 00:25:17,570
user and I'm looking at the<font color="#E5E5E5"> request and</font>

557
00:25:15,589 --> 00:25:20,690
I'm saying okay if I'm singing requests

558
00:25:17,570 --> 00:25:23,330
for the VBA code<font color="#E5E5E5"> before I'm getting in</font>

559
00:25:20,690 --> 00:25:25,849
quests<font color="#E5E5E5"> for the image then this must be a</font>

560
00:25:23,330 --> 00:25:29,359
sandbox<font color="#E5E5E5"> because the sandbox is asking</font>

561
00:25:25,849 --> 00:25:31,218
for the code and then for the image<font color="#E5E5E5"> and</font>

562
00:25:29,359 --> 00:25:33,228
if I look at it<font color="#E5E5E5"> in the other way and I'm</font>

563
00:25:31,219 --> 00:25:35,059
<font color="#E5E5E5">seeing requests for the image and only</font>

564
00:25:33,229 --> 00:25:38,479
then<font color="#E5E5E5"> request for the video for the VBA</font>

565
00:25:35,059 --> 00:25:48,168
code then I can<font color="#E5E5E5"> decide that this is</font><font color="#CCCCCC"> a</font>

566
00:25:38,479 --> 00:25:50,960
user so far detection now moving on to

567
00:25:48,169 --> 00:25:54,349
actually evading the sandbox so I have a

568
00:25:50,960 --> 00:25:57,440
verdict<font color="#CCCCCC"> write</font><font color="#E5E5E5"> this piece of code decides</font>

569
00:25:54,349 --> 00:25:59,418
whether it's<font color="#CCCCCC"> a sandbox or a user and now</font>

570
00:25:57,440 --> 00:26:02,960
I'm<font color="#CCCCCC"> gonna</font><font color="#E5E5E5"> build on</font><font color="#CCCCCC"> top of</font><font color="#E5E5E5"> that and say</font>

571
00:25:59,419 --> 00:26:06,440
okay<font color="#E5E5E5"> I</font><font color="#CCCCCC"> have a verdict</font><font color="#E5E5E5"> if the verdict</font>

572
00:26:02,960 --> 00:26:08,719
says sandbox<font color="#E5E5E5"> I'm gonna reply with a</font>

573
00:26:06,440 --> 00:26:10,729
benign VBA project<font color="#E5E5E5"> and if it's a user</font>

574
00:26:08,719 --> 00:26:12,369
I'm gonna reply with a malicious<font color="#E5E5E5"> VBA</font>

575
00:26:10,729 --> 00:26:14,839
project so the attacker simply

576
00:26:12,369 --> 00:26:18,408
intercepts the<font color="#E5E5E5"> request and now he has to</font>

577
00:26:14,839 --> 00:26:20,749
respond and<font color="#E5E5E5"> he has two versions</font><font color="#CCCCCC"> of the</font>

578
00:26:18,409 --> 00:26:23,179
requested VBA<font color="#E5E5E5"> projects and according</font><font color="#CCCCCC"> to</font>

579
00:26:20,749 --> 00:26:27,609
the verdict he decides is it gonna be

580
00:26:23,179 --> 00:26:33,529
<font color="#E5E5E5">benign or malicious depending on the</font>

581
00:26:27,609 --> 00:26:35,480
verdict<font color="#E5E5E5"> so if we look closer</font><font color="#CCCCCC"> this is</font>

582
00:26:33,529 --> 00:26:38,180
<font color="#CCCCCC">what this attack looks like</font>

583
00:26:35,480 --> 00:26:38,780
the<font color="#E5E5E5"> sandbox</font><font color="#CCCCCC"> ID he opens</font><font color="#E5E5E5"> the document is</font>

584
00:26:38,180 --> 00:26:41,150
open

585
00:26:38,780 --> 00:26:43,149
<font color="#CCCCCC">no protected view VI</font><font color="#E5E5E5"> engine loads</font>

586
00:26:41,150 --> 00:26:46,010
causing<font color="#CCCCCC"> VBA referencing</font><font color="#E5E5E5"> the attacker</font>

587
00:26:43,150 --> 00:26:49,430
looks at this request and<font color="#E5E5E5"> says</font><font color="#CCCCCC"> okay I'm</font>

588
00:26:46,010 --> 00:26:51,800
<font color="#E5E5E5">seeing requests for VBA referencing no</font>

589
00:26:49,430 --> 00:26:54,260
previous requests<font color="#E5E5E5"> for images I'm going</font>

590
00:26:51,800 --> 00:26:56,560
to reply with<font color="#CCCCCC"> the benign</font><font color="#E5E5E5"> piece of code</font>

591
00:26:54,260 --> 00:27:00,290
the happy face<font color="#CCCCCC"> it's happy because nobody</font>

592
00:26:56,560 --> 00:27:02,659
will be<font color="#E5E5E5"> upset</font><font color="#CCCCCC"> if he</font><font color="#E5E5E5"> got it so that's the</font>

593
00:27:00,290 --> 00:27:07,280
attackers response the document is now

594
00:27:02,660 --> 00:27:08,660
loaded<font color="#E5E5E5"> and it continues fetching the</font>

595
00:27:07,280 --> 00:27:10,430
other elements<font color="#E5E5E5"> in this case the image</font>

596
00:27:08,660 --> 00:27:14,960
<font color="#E5E5E5">from the attackers machine the attacker</font>

597
00:27:10,430 --> 00:27:18,800
simply replies with the image and we're

598
00:27:14,960 --> 00:27:21,590
done<font color="#E5E5E5"> so this is</font><font color="#CCCCCC"> the sandbox</font><font color="#E5E5E5"> and the</font>

599
00:27:18,800 --> 00:27:23,690
sandbox got the benign piece of code he

600
00:27:21,590 --> 00:27:27,800
suspects nothing the original document

601
00:27:23,690 --> 00:27:29,890
<font color="#E5E5E5">has nothing bad in it the fetched VBA</font>

602
00:27:27,800 --> 00:27:33,440
project has nothing bad in it as well

603
00:27:29,890 --> 00:27:36,740
<font color="#E5E5E5">nothing to suspect to suspect so he</font>

604
00:27:33,440 --> 00:27:38,120
passes<font color="#CCCCCC"> this document to the user</font><font color="#E5E5E5"> and</font>

605
00:27:36,740 --> 00:27:40,910
this<font color="#E5E5E5"> is what it looks like from the</font>

606
00:27:38,120 --> 00:27:42,830
<font color="#E5E5E5">users point of view</font><font color="#CCCCCC"> so the user opens</font>

607
00:27:40,910 --> 00:27:45,200
the<font color="#E5E5E5"> document and once again protected</font>

608
00:27:42,830 --> 00:27:48,399
<font color="#CCCCCC">view he enables editing causing the</font>

609
00:27:45,200 --> 00:27:51,500
image to be fetched<font color="#E5E5E5"> and now the attacker</font>

610
00:27:48,400 --> 00:27:53,300
<font color="#E5E5E5">marks the image and says</font><font color="#CCCCCC"> ok I saw</font>

611
00:27:51,500 --> 00:27:55,310
requests for the image<font color="#E5E5E5"> I'm</font><font color="#CCCCCC"> gonna</font>

612
00:27:53,300 --> 00:27:58,909
<font color="#E5E5E5">remember that and responds with the</font>

613
00:27:55,310 --> 00:28:01,580
<font color="#E5E5E5">image once the user clicks enable</font>

614
00:27:58,910 --> 00:28:05,810
content<font color="#E5E5E5"> causing the VBA engine to load</font>

615
00:28:01,580 --> 00:28:07,669
and VBA referencing sorry<font color="#E5E5E5"> about that</font><font color="#CCCCCC"> the</font>

616
00:28:05,810 --> 00:28:10,399
attacker gets requests for the VBA code

617
00:28:07,670 --> 00:28:13,040
<font color="#E5E5E5">and now he has to decide have I seen</font>

618
00:28:10,400 --> 00:28:15,410
requests for the image before<font color="#CCCCCC"> all after</font>

619
00:28:13,040 --> 00:28:17,870
and he says<font color="#E5E5E5"> before</font><font color="#CCCCCC"> meaning that this is</font>

620
00:28:15,410 --> 00:28:21,800
a user and his he will reply<font color="#CCCCCC"> with the</font>

621
00:28:17,870 --> 00:28:27,860
<font color="#E5E5E5">malicious benign project the</font><font color="#CCCCCC"> birds</font><font color="#E5E5E5"> the</font>

622
00:28:21,800 --> 00:28:34,510
sad face so this is the<font color="#E5E5E5"> detection</font><font color="#CCCCCC"> an</font>

623
00:28:27,860 --> 00:28:34,510
evasion scheme and demo right hopefully

624
00:28:34,600 --> 00:28:37,600
<font color="#E5E5E5">ok</font>

625
00:28:48,790 --> 00:28:55,340
so this is the attackers machine<font color="#CCCCCC"> and I'm</font>

626
00:28:52,790 --> 00:28:59,690
<font color="#E5E5E5">gonna run the intercepting code as well</font>

627
00:28:55,340 --> 00:29:01,550
and one final<font color="#CCCCCC"> thing</font><font color="#E5E5E5"> I don't have</font><font color="#CCCCCC"> a</font>

628
00:28:59,690 --> 00:29:03,770
<font color="#E5E5E5">sandbox in this machine so I'm gonna run</font>

629
00:29:01,550 --> 00:29:05,960
<font color="#E5E5E5">this document two times the same</font>

630
00:29:03,770 --> 00:29:11,080
document<font color="#CCCCCC"> try the</font><font color="#E5E5E5"> same document trying to</font>

631
00:29:05,960 --> 00:29:13,910
access<font color="#E5E5E5"> the attackers machine and so and</font>

632
00:29:11,080 --> 00:29:15,439
this document<font color="#CCCCCC"> is already trusted</font><font color="#E5E5E5"> the</font>

633
00:29:13,910 --> 00:29:17,720
thing to understand about protected<font color="#E5E5E5"> view</font>

634
00:29:15,440 --> 00:29:20,870
is once you trust the document<font color="#E5E5E5"> its</font>

635
00:29:17,720 --> 00:29:22,610
trusted until something happens and

636
00:29:20,870 --> 00:29:24,320
usually what<font color="#CCCCCC"> happens</font><font color="#E5E5E5"> is if you change</font>

637
00:29:22,610 --> 00:29:26,899
<font color="#E5E5E5">the name</font><font color="#CCCCCC"> of</font><font color="#E5E5E5"> it it's no longer trusted</font>

638
00:29:24,320 --> 00:29:29,389
<font color="#E5E5E5">this means that the path is considered</font>

639
00:29:26,900 --> 00:29:31,250
trusted for the<font color="#CCCCCC"> document</font><font color="#E5E5E5"> so I've been</font>

640
00:29:29,390 --> 00:29:33,050
playing<font color="#CCCCCC"> with this document as you</font><font color="#E5E5E5"> can</font>

641
00:29:31,250 --> 00:29:35,300
see I'm always adding<font color="#E5E5E5"> a digit after I've</font>

642
00:29:33,050 --> 00:29:39,740
tested it<font color="#CCCCCC"> so after</font><font color="#E5E5E5"> I've tested it a few</font>

643
00:29:35,300 --> 00:29:44,930
<font color="#E5E5E5">times</font><font color="#CCCCCC"> and this should open</font><font color="#E5E5E5"> in protected</font>

644
00:29:39,740 --> 00:29:46,460
view<font color="#CCCCCC"> okay fortunately it opens on my</font>

645
00:29:44,930 --> 00:29:48,830
screen<font color="#E5E5E5"> so</font><font color="#CCCCCC"> I have to show</font><font color="#E5E5E5"> it to you like</font>

646
00:29:46,460 --> 00:29:51,170
<font color="#CCCCCC">that so it opened on protected view</font>

647
00:29:48,830 --> 00:29:53,300
without<font color="#E5E5E5"> protective view nothing</font>

648
00:29:51,170 --> 00:29:55,790
interesting happen and if I<font color="#E5E5E5"> open the VBA</font>

649
00:29:53,300 --> 00:29:58,100
project you can see<font color="#CCCCCC"> that the call me</font>

650
00:29:55,790 --> 00:30:02,300
function<font color="#CCCCCC"> is actually</font><font color="#E5E5E5"> empty</font><font color="#CCCCCC"> and it's in</font>

651
00:29:58,100 --> 00:30:08,360
this<font color="#E5E5E5"> module in the ref</font><font color="#CCCCCC"> my project so</font>

652
00:30:02,300 --> 00:30:11,590
empty<font color="#CCCCCC"> function and empty project and now</font>

653
00:30:08,360 --> 00:30:11,590
let's change that

654
00:30:19,799 --> 00:30:26,950
<font color="#E5E5E5">okay and as you can see the attacker has</font>

655
00:30:24,429 --> 00:30:28,650
identified<font color="#E5E5E5"> this is the sandbox</font><font color="#CCCCCC"> and he</font>

656
00:30:26,950 --> 00:30:32,559
<font color="#E5E5E5">replied with</font><font color="#CCCCCC"> the benign</font><font color="#E5E5E5"> piece of code</font>

657
00:30:28,650 --> 00:30:41,200
and now that's right again just to be

658
00:30:32,559 --> 00:30:43,870
<font color="#CCCCCC">sure okay and now I</font><font color="#E5E5E5"> have this document</font>

659
00:30:41,200 --> 00:30:46,390
here<font color="#CCCCCC"> which is in protected</font><font color="#E5E5E5"> View mode so</font>

660
00:30:43,870 --> 00:30:48,850
the image is not<font color="#E5E5E5"> low that I can see</font>

661
00:30:46,390 --> 00:30:53,799
<font color="#E5E5E5">anything that the user would simply</font>

662
00:30:48,850 --> 00:30:55,570
click this enable editing<font color="#E5E5E5"> causing the</font>

663
00:30:53,799 --> 00:30:58,049
image to<font color="#E5E5E5"> load so nice the image has</font>

664
00:30:55,570 --> 00:31:01,770
loaded with this image<font color="#E5E5E5"> I could have used</font>

665
00:30:58,049 --> 00:31:04,990
the<font color="#E5E5E5"> usual social engineering scheme of</font>

666
00:31:01,770 --> 00:31:06,730
this document is out<font color="#CCCCCC"> of version</font><font color="#E5E5E5"> and</font>

667
00:31:04,990 --> 00:31:10,500
please click enable content<font color="#E5E5E5"> to truly</font>

668
00:31:06,730 --> 00:31:15,880
view the document<font color="#E5E5E5"> and so forth so now</font>

669
00:31:10,500 --> 00:31:22,720
let's try<font color="#E5E5E5"> to</font><font color="#CCCCCC"> enable content</font><font color="#E5E5E5"> and we get</font>

670
00:31:15,880 --> 00:31:32,799
this<font color="#E5E5E5"> you've been hacked sandbox evasion</font>

671
00:31:22,720 --> 00:31:35,860
<font color="#E5E5E5">right</font><font color="#CCCCCC"> okay then thank</font><font color="#E5E5E5"> you</font><font color="#CCCCCC"> if we look at</font>

672
00:31:32,799 --> 00:31:38,530
the code<font color="#CCCCCC"> the previous referee project</font>

673
00:31:35,860 --> 00:31:41,770
was empty<font color="#CCCCCC"> now it contains a user form</font>

674
00:31:38,530 --> 00:31:45,250
which is<font color="#CCCCCC"> the you've been hacked</font><font color="#E5E5E5"> for and</font>

675
00:31:41,770 --> 00:31:47,889
if we look at the code module we can see

676
00:31:45,250 --> 00:31:49,630
that<font color="#E5E5E5"> it</font><font color="#CCCCCC"> shows</font><font color="#E5E5E5"> the user form it could be</font>

677
00:31:47,890 --> 00:31:51,580
anything right this is code execution

678
00:31:49,630 --> 00:32:01,059
you could access the file system you can

679
00:31:51,580 --> 00:32:03,809
<font color="#CCCCCC">use Windows</font><font color="#E5E5E5"> API and so forth so let's</font>

680
00:32:01,059 --> 00:32:03,809
get back to this

681
00:32:06,280 --> 00:32:12,639
I've actually prepared a<font color="#CCCCCC"> video in</font><font color="#E5E5E5"> case</font>

682
00:32:08,560 --> 00:32:16,620
the demo<font color="#E5E5E5"> didn't work but lucky for us</font><font color="#CCCCCC"> it</font>

683
00:32:12,640 --> 00:32:20,980
did so and this would have shown<font color="#CCCCCC"> the</font>

684
00:32:16,620 --> 00:32:22,689
attack<font color="#E5E5E5"> using the</font><font color="#CCCCCC"> cuckoos sandbox and</font><font color="#E5E5E5"> how</font>

685
00:32:20,980 --> 00:32:25,410
it bypasses and what's the verdict but

686
00:32:22,690 --> 00:32:28,330
<font color="#E5E5E5">yeah moving on</font>

687
00:32:25,410 --> 00:32:31,210
so we've tested this attack against

688
00:32:28,330 --> 00:32:34,389
seven leading<font color="#E5E5E5"> sandboxes solution</font>

689
00:32:31,210 --> 00:32:37,450
commercials<font color="#E5E5E5"> and open source we won't be</font>

690
00:32:34,390 --> 00:32:40,960
naming<font color="#E5E5E5"> anyone but all of them will evade</font>

691
00:32:37,450 --> 00:32:43,330
<font color="#E5E5E5">it so none</font><font color="#CCCCCC"> of them has flagged this file</font>

692
00:32:40,960 --> 00:32:45,550
as malicious<font color="#E5E5E5"> or sandbox evading</font>

693
00:32:43,330 --> 00:32:49,000
suspicious or whatever the file ended<font color="#E5E5E5"> up</font>

694
00:32:45,550 --> 00:32:51,040
at the user which is<font color="#E5E5E5"> something</font><font color="#CCCCCC"> to</font>

695
00:32:49,000 --> 00:32:52,720
consider<font color="#E5E5E5"> in regard</font><font color="#CCCCCC"> to sandbox</font><font color="#E5E5E5"> because</font>

696
00:32:51,040 --> 00:32:54,970
most users<font color="#E5E5E5"> consider sandbox as a</font>

697
00:32:52,720 --> 00:32:58,300
bulletproof environment whatever<font color="#E5E5E5"> comes</font>

698
00:32:54,970 --> 00:33:03,490
through<font color="#E5E5E5"> it is safe and</font><font color="#CCCCCC"> eventually we</font><font color="#E5E5E5"> can</font>

699
00:32:58,300 --> 00:33:06,129
see that it's not<font color="#E5E5E5"> the case one we've</font>

700
00:33:03,490 --> 00:33:09,610
noticed some some key points<font color="#E5E5E5"> when we</font>

701
00:33:06,130 --> 00:33:11,560
investigated<font color="#E5E5E5"> this technique some sand</font>

702
00:33:09,610 --> 00:33:15,070
<font color="#E5E5E5">boxes whether they are deployed</font><font color="#CCCCCC"> in</font>

703
00:33:11,560 --> 00:33:17,530
<font color="#CCCCCC">organisations or just their deployment</font>

704
00:33:15,070 --> 00:33:21,040
<font color="#E5E5E5">as a product over</font><font color="#CCCCCC"> the Internet</font>

705
00:33:17,530 --> 00:33:22,629
block SMB<font color="#CCCCCC"> and that makes</font><font color="#E5E5E5"> no sense</font><font color="#CCCCCC"> right</font>

706
00:33:21,040 --> 00:33:24,850
it's<font color="#E5E5E5"> even better for me as an attacker</font>

707
00:33:22,630 --> 00:33:27,610
<font color="#E5E5E5">for example if I rely on SMB in this</font>

708
00:33:24,850 --> 00:33:29,260
attack and<font color="#E5E5E5"> you block SMB the document</font>

709
00:33:27,610 --> 00:33:31,840
would<font color="#CCCCCC"> be even more benign because</font><font color="#E5E5E5"> it</font>

710
00:33:29,260 --> 00:33:34,780
doesn't fetch<font color="#CCCCCC"> anything we have a benign</font>

711
00:33:31,840 --> 00:33:36,459
document<font color="#E5E5E5"> that's doing nothing and the</font>

712
00:33:34,780 --> 00:33:38,500
sandbox will pass it on to the user<font color="#CCCCCC"> and</font>

713
00:33:36,460 --> 00:33:41,170
<font color="#E5E5E5">now I get</font><font color="#CCCCCC"> my chance</font><font color="#E5E5E5"> if the user hasn't</font>

714
00:33:38,500 --> 00:33:45,040
<font color="#E5E5E5">blocked us and B in this case then by</font>

715
00:33:41,170 --> 00:33:47,110
<font color="#CCCCCC">all means I can infect it one other</font>

716
00:33:45,040 --> 00:33:50,860
thing is that some sandbox says don't

717
00:33:47,110 --> 00:33:52,689
inspect<font color="#E5E5E5"> they don't block SMB but they</font>

718
00:33:50,860 --> 00:33:57,159
don't bother<font color="#E5E5E5"> to inspect what's coming on</font>

719
00:33:52,690 --> 00:34:00,850
SMB<font color="#E5E5E5"> and</font><font color="#CCCCCC"> as we've seen we had VB a</font>

720
00:33:57,160 --> 00:34:02,590
project going<font color="#E5E5E5"> inbound for SMB and you</font>

721
00:34:00,850 --> 00:34:04,480
can inject<font color="#E5E5E5"> whatever you want into a</font><font color="#CCCCCC"> vbi</font>

722
00:34:02,590 --> 00:34:06,429
project I mean you saw the user<font color="#CCCCCC"> file I</font>

723
00:34:04,480 --> 00:34:11,530
can<font color="#E5E5E5"> put images inside I can put text</font>

724
00:34:06,430 --> 00:34:13,389
<font color="#E5E5E5">inside I can</font><font color="#CCCCCC"> here</font><font color="#E5E5E5"> base64 encode a piece</font>

725
00:34:11,530 --> 00:34:15,370
of code<font color="#E5E5E5"> and then execute it by passing</font>

726
00:34:13,389 --> 00:34:17,980
<font color="#CCCCCC">all sorts of static</font><font color="#E5E5E5"> analysis tools if</font>

727
00:34:15,370 --> 00:34:20,270
<font color="#E5E5E5">they do bother to inspect so I can</font>

728
00:34:17,980 --> 00:34:23,120
inject a<font color="#E5E5E5"> lot of stuff</font><font color="#CCCCCC"> too</font>

729
00:34:20,270 --> 00:34:26,150
<font color="#CCCCCC">vbi project and if you don't bother to</font>

730
00:34:23,120 --> 00:34:29,659
inspect them then you you you will be

731
00:34:26,150 --> 00:34:31,280
<font color="#E5E5E5">missing out and some other thing things</font>

732
00:34:29,659 --> 00:34:33,678
to consider is that<font color="#CCCCCC"> this is not the only</font>

733
00:34:31,280 --> 00:34:38,030
<font color="#CCCCCC">scenario yeah we use</font><font color="#E5E5E5"> protected view and</font>

734
00:34:33,679 --> 00:34:39,380
we relied on<font color="#CCCCCC"> VBA referencing but PDF has</font>

735
00:34:38,030 --> 00:34:42,200
its own protected view and it has

736
00:34:39,380 --> 00:34:45,190
<font color="#E5E5E5">JavaScript within so I haven't</font><font color="#CCCCCC"> tested it</font>

737
00:34:42,199 --> 00:34:52,639
but I<font color="#CCCCCC"> think this sounds like a solid</font>

738
00:34:45,190 --> 00:34:59,900
research<font color="#E5E5E5"> to go to and</font><font color="#CCCCCC"> okay so let's</font><font color="#E5E5E5"> talk</font>

739
00:34:52,639 --> 00:35:01,549
<font color="#E5E5E5">about mitigations so first of all and</font>

740
00:34:59,900 --> 00:35:04,790
<font color="#CCCCCC">the</font><font color="#E5E5E5"> most obvious one if it hasn't been</font>

741
00:35:01,550 --> 00:35:07,010
clear so far<font color="#CCCCCC"> you have</font><font color="#E5E5E5"> to block SMB and</font>

742
00:35:04,790 --> 00:35:10,000
FTP which<font color="#E5E5E5"> should work on this attack as</font>

743
00:35:07,010 --> 00:35:12,830
well on the user<font color="#E5E5E5"> inbound and outbound</font>

744
00:35:10,000 --> 00:35:15,530
<font color="#E5E5E5">you can't have the user communicating</font>

745
00:35:12,830 --> 00:35:16,970
<font color="#E5E5E5">with somewhere remote on SMB and you</font>

746
00:35:15,530 --> 00:35:19,070
have the pass the<font color="#E5E5E5"> hash attacks and stuff</font>

747
00:35:16,970 --> 00:35:22,549
like that<font color="#CCCCCC"> you</font><font color="#E5E5E5"> don't want that</font><font color="#CCCCCC"> but you do</font>

748
00:35:19,070 --> 00:35:24,680
want<font color="#E5E5E5"> to inspect SMB on the sandbox I</font>

749
00:35:22,550 --> 00:35:28,400
cannot<font color="#E5E5E5"> stress this enough</font><font color="#CCCCCC"> you want your</font>

750
00:35:24,680 --> 00:35:31,430
sandbox to be as loose in security<font color="#E5E5E5"> and</font>

751
00:35:28,400 --> 00:35:38,990
as enabling as it can to allow the

752
00:35:31,430 --> 00:35:41,210
<font color="#CCCCCC">mallet to truly execute what you might</font>

753
00:35:38,990 --> 00:35:43,640
want to do is look at your environment

754
00:35:41,210 --> 00:35:46,640
<font color="#E5E5E5">your sandbox environment and see what</font>

755
00:35:43,640 --> 00:35:48,650
you can fix in that<font color="#CCCCCC"> environment to not</font>

756
00:35:46,640 --> 00:35:52,609
allow this attack and<font color="#E5E5E5"> it's usually at</font>

757
00:35:48,650 --> 00:35:54,230
the vendor<font color="#E5E5E5"> that's usually something</font><font color="#CCCCCC"> that</font>

758
00:35:52,610 --> 00:35:56,090
the vendor should<font color="#E5E5E5"> do they look they</font>

759
00:35:54,230 --> 00:35:57,890
should look at the environment and their

760
00:35:56,090 --> 00:36:00,470
analysis<font color="#E5E5E5"> machine and see how they</font><font color="#CCCCCC"> can</font>

761
00:35:57,890 --> 00:36:03,200
fix their environment to prevent<font color="#CCCCCC"> this</font>

762
00:36:00,470 --> 00:36:05,299
<font color="#E5E5E5">detection schemes and it will cost you I</font>

763
00:36:03,200 --> 00:36:07,939
mean there is<font color="#CCCCCC"> a trade-off if you enable</font>

764
00:36:05,300 --> 00:36:10,370
protected<font color="#E5E5E5"> view back it will cost you in</font>

765
00:36:07,940 --> 00:36:14,360
time and you have to<font color="#CCCCCC"> develop</font><font color="#E5E5E5"> a specific</font>

766
00:36:10,370 --> 00:36:16,759
<font color="#E5E5E5">module for that but I mean as we've just</font>

767
00:36:14,360 --> 00:36:22,070
<font color="#E5E5E5">seen this is bypassed a sandbox this</font>

768
00:36:16,760 --> 00:36:24,830
attack<font color="#E5E5E5"> you might think</font><font color="#CCCCCC"> that I'm too hard</font>

769
00:36:22,070 --> 00:36:27,140
<font color="#E5E5E5">but I say simply restrict internet of</font>

770
00:36:24,830 --> 00:36:30,590
<font color="#CCCCCC">Internet access</font><font color="#E5E5E5"> from office</font><font color="#CCCCCC"> altogether</font>

771
00:36:27,140 --> 00:36:32,660
I don't see a<font color="#E5E5E5"> point for a world document</font>

772
00:36:30,590 --> 00:36:33,380
<font color="#E5E5E5">to access the</font><font color="#CCCCCC"> Internet and fetch</font>

773
00:36:32,660 --> 00:36:35,359
something<font color="#E5E5E5"> I</font>

774
00:36:33,380 --> 00:36:38,090
no it can't do that<font color="#E5E5E5"> and it was it made</font>

775
00:36:35,360 --> 00:36:41,090
<font color="#CCCCCC">sense in the 90s I guess but it doesn't</font>

776
00:36:38,090 --> 00:36:42,800
make<font color="#CCCCCC"> sense anymore</font><font color="#E5E5E5"> and in</font><font color="#CCCCCC"> 2070 last year</font>

777
00:36:41,090 --> 00:36:45,770
we<font color="#CCCCCC"> heard I think fall</font><font color="#E5E5E5"> zero days</font>

778
00:36:42,800 --> 00:36:48,410
regarding<font color="#CCCCCC"> Ward</font><font color="#E5E5E5"> accessing the Internet</font>

779
00:36:45,770 --> 00:36:52,460
<font color="#E5E5E5">fetching something bad that gets it</font><font color="#CCCCCC"> gets</font>

780
00:36:48,410 --> 00:36:56,029
<font color="#E5E5E5">code execution so there's no point in my</font>

781
00:36:52,460 --> 00:36:58,430
book and the final<font color="#E5E5E5"> thing to be which you</font>

782
00:36:56,030 --> 00:37:00,350
can use is Cydia<font color="#CCCCCC"> which is content</font><font color="#E5E5E5"> the</font>

783
00:36:58,430 --> 00:37:03,169
<font color="#CCCCCC">Summoner construction and you</font><font color="#E5E5E5"> simply</font>

784
00:37:00,350 --> 00:37:06,049
switch from detecting the threat<font color="#CCCCCC"> to</font>

785
00:37:03,170 --> 00:37:08,270
disarming it<font color="#E5E5E5"> you have a file it gets</font>

786
00:37:06,050 --> 00:37:10,640
into the disarmer it sanitizes<font color="#E5E5E5"> it and</font>

787
00:37:08,270 --> 00:37:12,320
the end user gets<font color="#E5E5E5"> a clean file without</font>

788
00:37:10,640 --> 00:37:15,230
the<font color="#E5E5E5"> detection scheme</font><font color="#CCCCCC"> without the time</font>

789
00:37:12,320 --> 00:37:22,250
<font color="#E5E5E5">less time less effort and eventually a</font>

790
00:37:15,230 --> 00:37:26,150
clean file<font color="#E5E5E5"> so let's</font><font color="#CCCCCC"> sum up we've</font>

791
00:37:22,250 --> 00:37:28,760
discussed<font color="#CCCCCC"> sign boxes and how they</font>

792
00:37:26,150 --> 00:37:32,390
dismiss security mitigations and in this

793
00:37:28,760 --> 00:37:35,480
case how they dismiss protected view<font color="#CCCCCC"> in</font>

794
00:37:32,390 --> 00:37:38,990
order<font color="#CCCCCC"> to not become</font><font color="#E5E5E5"> a</font><font color="#CCCCCC"> bottleneck</font><font color="#E5E5E5"> which</font>

795
00:37:35,480 --> 00:37:41,060
is cool<font color="#E5E5E5"> but we</font><font color="#CCCCCC"> build on top of that</font>

796
00:37:38,990 --> 00:37:42,859
alongside<font color="#CCCCCC"> VBA referencing which allowed</font>

797
00:37:41,060 --> 00:37:45,410
us to fetch code from something else<font color="#E5E5E5"> and</font>

798
00:37:42,860 --> 00:37:48,620
these two combined allowed us to

799
00:37:45,410 --> 00:37:50,690
actually<font color="#E5E5E5"> bypass the sandbox because we</font>

800
00:37:48,620 --> 00:37:55,640
could spot a difference between<font color="#CCCCCC"> the user</font>

801
00:37:50,690 --> 00:37:57,860
and the<font color="#CCCCCC"> sandbox</font><font color="#E5E5E5"> and I think it's</font>

802
00:37:55,640 --> 00:37:59,750
important<font color="#E5E5E5"> to stress out that we didn't</font>

803
00:37:57,860 --> 00:38:02,120
<font color="#E5E5E5">break anything we didn't look for a</font>

804
00:37:59,750 --> 00:38:04,880
vulnerability<font color="#E5E5E5"> in VBA referencing or in</font>

805
00:38:02,120 --> 00:38:07,670
VBA<font color="#CCCCCC"> as a general we</font><font color="#E5E5E5"> didn't target</font><font color="#CCCCCC"> a</font>

806
00:38:04,880 --> 00:38:10,130
specific sandbox a specific event<font color="#CCCCCC"> or a</font>

807
00:38:07,670 --> 00:38:14,210
specific<font color="#CCCCCC"> product within a sandbox</font><font color="#E5E5E5"> this</font>

808
00:38:10,130 --> 00:38:16,430
<font color="#E5E5E5">is more of a logical abuse I mean I know</font>

809
00:38:14,210 --> 00:38:18,230
<font color="#E5E5E5">that the sandbox doesn't want don't want</font>

810
00:38:16,430 --> 00:38:20,600
<font color="#CCCCCC">to</font><font color="#E5E5E5"> become a</font><font color="#CCCCCC"> bottleneck so they</font><font color="#E5E5E5"> take</font>

811
00:38:18,230 --> 00:38:23,810
these steps in<font color="#CCCCCC"> order not to do so the</font>

812
00:38:20,600 --> 00:38:28,790
user takes<font color="#E5E5E5"> different steps and so I can</font>

813
00:38:23,810 --> 00:38:30,529
<font color="#E5E5E5">detect between them and the main points</font>

814
00:38:28,790 --> 00:38:33,259
<font color="#CCCCCC">to take from</font><font color="#E5E5E5"> this talk as I believe is</font>

815
00:38:30,530 --> 00:38:35,750
if you can identify key differences

816
00:38:33,260 --> 00:38:38,330
between<font color="#E5E5E5"> a sandbox execution and a user</font>

817
00:38:35,750 --> 00:38:41,180
execution you can achieve<font color="#E5E5E5"> sandbox</font>

818
00:38:38,330 --> 00:38:42,710
<font color="#E5E5E5">detection you can detect quite reliably</font>

819
00:38:41,180 --> 00:38:45,470
what's the sandbox and<font color="#E5E5E5"> what's the user</font>

820
00:38:42,710 --> 00:38:47,280
<font color="#CCCCCC">according these differences and in this</font>

821
00:38:45,470 --> 00:38:49,830
case we've combined it with

822
00:38:47,280 --> 00:38:52,590
referencing or fetching<font color="#E5E5E5"> remote</font>

823
00:38:49,830 --> 00:38:56,340
references or<font color="#E5E5E5"> text it could be</font><font color="#CCCCCC"> even to</font>

824
00:38:52,590 --> 00:38:58,920
achieve sandbox<font color="#E5E5E5"> evasion and because</font>

825
00:38:56,340 --> 00:39:01,010
sandbox evasion is so heavily relied on

826
00:38:58,920 --> 00:39:03,600
these days and<font color="#CCCCCC"> so trusted</font>

827
00:39:01,010 --> 00:39:06,330
once you have bypassed the sandbox and

828
00:39:03,600 --> 00:39:10,200
<font color="#CCCCCC">invaded it</font><font color="#E5E5E5"> it will most</font><font color="#CCCCCC"> likely end</font><font color="#E5E5E5"> with</font>

829
00:39:06,330 --> 00:39:15,720
the infection of<font color="#E5E5E5"> the user because it</font>

830
00:39:10,200 --> 00:39:28,020
trusts the sandbox so much and that's it

831
00:39:15,720 --> 00:39:30,419
do we<font color="#E5E5E5"> have questions anyone did</font><font color="#CCCCCC"> you ever</font>

832
00:39:28,020 --> 00:39:34,520
see any<font color="#E5E5E5"> kind of benign usage of</font>

833
00:39:30,420 --> 00:39:38,820
referencing in any document whatsoever<font color="#E5E5E5"> I</font>

834
00:39:34,520 --> 00:39:41,130
mean I guess I'm always<font color="#E5E5E5"> going to the 90s</font>

835
00:39:38,820 --> 00:39:43,860
<font color="#CCCCCC">because for some reason vba was very</font>

836
00:39:41,130 --> 00:39:47,820
popular<font color="#CCCCCC"> in</font><font color="#E5E5E5"> the 90s and it</font><font color="#CCCCCC"> was</font><font color="#E5E5E5"> being</font><font color="#CCCCCC"> used</font>

837
00:39:43,860 --> 00:39:51,360
<font color="#E5E5E5">to fetch information</font><font color="#CCCCCC"> from sites and all</font>

838
00:39:47,820 --> 00:39:53,280
sorts of stuff<font color="#CCCCCC"> I haven't</font><font color="#E5E5E5"> seen legitimate</font>

839
00:39:51,360 --> 00:39:56,910
<font color="#E5E5E5">uses I'm guessing what they were aiming</font>

840
00:39:53,280 --> 00:39:59,310
<font color="#CCCCCC">for is just like okay programming</font>

841
00:39:56,910 --> 00:40:02,279
<font color="#E5E5E5">languages can fetch in reference code</font>

842
00:39:59,310 --> 00:40:04,020
this<font color="#CCCCCC"> vba is a programming language</font><font color="#E5E5E5"> it</font>

843
00:40:02,280 --> 00:40:06,150
<font color="#CCCCCC">should be able</font><font color="#E5E5E5"> to reference code I think</font>

844
00:40:04,020 --> 00:40:08,910
this is the whatever<font color="#CCCCCC"> I</font><font color="#E5E5E5"> mean basically</font>

845
00:40:06,150 --> 00:40:11,370
<font color="#E5E5E5">any use of</font><font color="#CCCCCC"> this feature</font><font color="#E5E5E5"> should</font><font color="#CCCCCC"> be</font>

846
00:40:08,910 --> 00:40:14,640
flagged malicious with pretty<font color="#E5E5E5"> much low</font>

847
00:40:11,370 --> 00:40:16,950
false positive<font color="#CCCCCC"> rate</font><font color="#E5E5E5"> solely so you could</font>

848
00:40:14,640 --> 00:40:19,220
just<font color="#CCCCCC"> flag</font><font color="#E5E5E5"> anything which have you</font>

849
00:40:16,950 --> 00:40:23,310
statically detect has this reference

850
00:40:19,220 --> 00:40:25,640
field not empty as malicious<font color="#E5E5E5"> yes with a</font>

851
00:40:23,310 --> 00:40:28,890
pretty low false<font color="#CCCCCC"> positive rate because</font>

852
00:40:25,640 --> 00:40:31,620
what I go the<font color="#E5E5E5"> extra mile and I say block</font>

853
00:40:28,890 --> 00:40:32,910
<font color="#E5E5E5">office Internet access all</font><font color="#CCCCCC"> together</font><font color="#E5E5E5"> if</font>

854
00:40:31,620 --> 00:40:35,600
you want to do that yeah you can

855
00:40:32,910 --> 00:40:38,399
<font color="#CCCCCC">actually flag in my mind you can</font><font color="#E5E5E5"> flag</font>

856
00:40:35,600 --> 00:40:40,170
<font color="#E5E5E5">documents or VBA projects that trying</font><font color="#CCCCCC"> to</font>

857
00:40:38,400 --> 00:40:41,760
fetch something<font color="#E5E5E5"> from the</font><font color="#CCCCCC"> internet and</font>

858
00:40:40,170 --> 00:40:43,770
say yeah this is suspicious by my book

859
00:40:41,760 --> 00:40:45,630
<font color="#E5E5E5">and I think</font><font color="#CCCCCC"> you'll</font><font color="#E5E5E5"> be</font><font color="#CCCCCC"> fine because</font><font color="#E5E5E5"> I</font>

860
00:40:43,770 --> 00:40:46,950
<font color="#E5E5E5">haven't seen and I'm guessing people</font><font color="#CCCCCC"> in</font>

861
00:40:45,630 --> 00:40:50,190
the audience haven't seen legitimate

862
00:40:46,950 --> 00:40:55,109
cases<font color="#E5E5E5"> of VBA referencing something that</font>

863
00:40:50,190 --> 00:40:58,290
you try<font color="#E5E5E5"> to collect like big data set</font><font color="#CCCCCC"> of</font>

864
00:40:55,110 --> 00:41:00,530
documents<font color="#CCCCCC"> in C of any document uses</font><font color="#E5E5E5"> this</font>

865
00:40:58,290 --> 00:41:02,420
in the<font color="#CCCCCC"> wild maybe</font><font color="#E5E5E5"> I haven't I</font>

866
00:41:00,530 --> 00:41:04,490
looked online to see<font color="#CCCCCC"> if there</font><font color="#E5E5E5"> are</font>

867
00:41:02,420 --> 00:41:06,470
references in<font color="#E5E5E5"> regards to malicious</font>

868
00:41:04,490 --> 00:41:09,740
behavior<font color="#E5E5E5"> or just general</font><font color="#CCCCCC"> behavior and</font>

869
00:41:06,470 --> 00:41:14,359
the last things that<font color="#E5E5E5"> I saw was from 2005</font>

870
00:41:09,740 --> 00:41:17,870
2006<font color="#E5E5E5"> people asking in forums how to how</font>

871
00:41:14,360 --> 00:41:19,850
to<font color="#CCCCCC"> use VBA referencing</font><font color="#E5E5E5"> but no no solid</font>

872
00:41:17,870 --> 00:41:22,630
evidence<font color="#CCCCCC"> to malicious activity for</font>

873
00:41:19,850 --> 00:41:22,630
example<font color="#CCCCCC"> thank you</font>

874
00:41:25,630 --> 00:41:30,230
<font color="#CCCCCC">and so</font><font color="#E5E5E5"> very interesting</font><font color="#CCCCCC"> research</font><font color="#E5E5E5"> you</font>

875
00:41:29,030 --> 00:41:32,150
mentioned you have tested seven

876
00:41:30,230 --> 00:41:34,280
different sandbox products did you reach

877
00:41:32,150 --> 00:41:36,650
out<font color="#E5E5E5"> to</font><font color="#CCCCCC"> the vendors and explain your</font>

878
00:41:34,280 --> 00:41:39,470
research to them by any<font color="#E5E5E5"> chance</font><font color="#CCCCCC"> no</font>

879
00:41:36,650 --> 00:41:41,630
actually some<font color="#E5E5E5"> of them contacted us and</font>

880
00:41:39,470 --> 00:41:44,529
we've shared what we could share with

881
00:41:41,630 --> 00:41:48,920
them but this<font color="#E5E5E5"> is not a</font><font color="#CCCCCC"> specific vendor</font>

882
00:41:44,530 --> 00:41:51,470
<font color="#E5E5E5">related issue it's a general it's a</font>

883
00:41:48,920 --> 00:41:53,270
general issue with the sandbox<font color="#CCCCCC"> with</font><font color="#E5E5E5"> this</font>

884
00:41:51,470 --> 00:41:55,609
with the concept of the<font color="#E5E5E5"> sandbox and how</font>

885
00:41:53,270 --> 00:41:57,530
it's being implemented<font color="#E5E5E5"> so there's no</font>

886
00:41:55,610 --> 00:41:59,570
point<font color="#CCCCCC"> Ritchie gone to anyone I'm</font><font color="#E5E5E5"> hoping</font>

887
00:41:57,530 --> 00:42:09,280
that this presentation will do the work

888
00:41:59,570 --> 00:42:13,610
<font color="#E5E5E5">instead of reaching out to</font><font color="#CCCCCC"> anyone ok</font>

889
00:42:09,280 --> 00:42:15,570
normal questions so that's<font color="#E5E5E5"> it</font><font color="#CCCCCC"> guys</font>

890
00:42:13,610 --> 00:42:16,690
thank you<font color="#E5E5E5"> very much for</font><font color="#CCCCCC"> listening</font>

891
00:42:15,570 --> 00:42:18,250
[Applause]

892
00:42:16,690 --> 00:42:21,840
[Music]

893
00:42:18,250 --> 00:42:21,840
[Applause]

